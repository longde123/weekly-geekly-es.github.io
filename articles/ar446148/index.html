<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐๐ป ๐ง๐ฟ ๐ Linux Kernel 5.0 - ูุชุงุจุฉ Simple Block Device ุชุญุช blk-mq ๐๏ธ ๐จ ๐ง</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุฃุฎุจุงุฑ ุฌูุฏุฉ ุ ุงูุฌููุน! 

 ููุฌุฏ Linux kernel 5.0 ุจุงููุนู ููุธูุฑ ูู ุชูุฒูุนุงุช ุชุฌุฑูุจูุฉ ูุซู Arch ู openSUSE Tumbleweed ู Fedora. 



 ูุฅุฐุง ูุธุฑุช ุฅูู ุชูุฒูุนุงุช RC ู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Linux Kernel 5.0 - ูุชุงุจุฉ Simple Block Device ุชุญุช blk-mq</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/veeam/blog/446148/" style=";text-align:right;direction:rtl">  ุฃุฎุจุงุฑ ุฌูุฏุฉ ุ ุงูุฌููุน! <br><br>  ููุฌุฏ Linux kernel 5.0 ุจุงููุนู ููุธูุฑ ูู ุชูุฒูุนุงุช ุชุฌุฑูุจูุฉ ูุซู Arch ู openSUSE Tumbleweed ู Fedora. <br><br><img src="https://habrastorage.org/webt/me/zn/aq/meznaq4kak63su90hds63zvj1tq.png"><br><br>  ูุฅุฐุง ูุธุฑุช ุฅูู ุชูุฒูุนุงุช RC ูู Ubuntu Disko Dingo ู Red Hat 8 ุ ูุตุจุญ ุงูุฃูุฑ ูุงุถุญูุง: ูุฑูุจูุง ุณุชููู kernel 5.0 ุฃูุถูุง ูู ุฃุณุทุญ ููุชุจ ุงููุนุฌุจูู ุฅูู ุฎูุงุฏู ุฎุทูุฑุฉ. <br>  ุณูููู ุดุฎุต ูุง - ูุงุฐุง ูู ุฐูู.  ุงูุฅุตุฏุงุฑ ุงูุชุงูู ุ ูุง ุดูุก ุฎุงุต.  ูุฐูู ูุงู ููููุณ ุชูุฑูุงูุฏุณ ููุณู: <blockquote style=";text-align:right;direction:rtl">  ุฃูุฏ ุฃู ุฃูุถุญ (ูุฑุฉ ุฃุฎุฑู) ุฃููุง ูุง ูููู ุจุงูุฅุตุฏุงุฑุงุช ุงููุงุฆูุฉ ุนูู ุงูููุฒุงุช ุ ูุฃู ุงูุฑูู "5.0" ูุง ูุนูู ุฃู ุดูุก ุฃูุซุฑ ูู ุฃู ุฃุฑูุงู 4.x ุจุฏุฃุช ุชุตุจุญ ูุจูุฑุฉ ุจูุง ูููู ูุฏุฑุฌุฉ ุฃููู ููุฏุช ุฃุตุงุจุนูุง ูุฃุตุงุจุน ุงููุฏู. <br><br>  ( <i>ุฃูุฑุฑ ูุฑุฉ ุฃุฎุฑู - ุฅุตุฏุงุฑุงุชูุง ููุณุช ูุฑุชุจุทุฉ ุจุฃู ููุฒุงุช ูุญุฏุฏุฉ ุ ูุจุงูุชุงูู ูุฅู ุฑูู ุงูุฅุตุฏุงุฑ ุงูุฌุฏูุฏ 5.0 ูุนูู ููุท ุฃูู ุจุงููุณุจุฉ ุฅูู ุชุฑููู ุงูุฅุตุฏุงุฑุงุช 4.x ููุณ ูุฏู ุฃุตุงุจุน ูุฃุตุงุจุน ูุฏู ูุงููุฉ</i> ) <br></blockquote><br>  ููุน ุฐูู ุ ุชู ุชุตุญูุญ ุงููุญุฏุฉ ุงูููุทูุฉ ููุฃูุฑุงุต ุงููุฑูุฉ (ุงูุชู ูุง ุชุนุฑู - ูุฐู ูู ุงูุฃูุฑุงุต ุจุญุฌู ูููุต ุฌูุจ ุงูุตุฏุฑ ุ ุจุณุนุฉ 1.44 ููุบุงุจุงูุช) - ... <br>  ูููุง ุงูุณุจุจ: <br><a name="habracut"></a><br>  ุงูุฃูุฑ ููู ูุชุนูู ุจุทุจูุฉ ุจููู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุงููุชุนุฏุฏุฉ (blk-mq).  ููุงู ุงููุซูุฑ ูู ุงูููุงูุงุช ุงูุชูููุฏูุฉ ุญููู ุนูู ุงูุฅูุชุฑูุช ุ ูุฐูู ุฏุนููุง ูุตู ุฅูู ูุฐู ุงูููุทุฉ.  ุจุฏุฃ ุงูุงูุชูุงู ุฅูู blk-mq ููุฐ ูุชุฑุฉ ุทูููุฉ ููุงู ูุชูุฏู ุจุจุทุก ุฅูู ุงูุฃูุงู.  ุธูุฑุช SCSI ูุชุนุฏุฏ ุงูุทูุงุจ (ูุนููุฉ kernel scsi_mod.use_blk_mq) ุ ูุธูุฑุช ุฌุฏููุฉ ุฌุฏูุฏุฉ mq-ุงูููุนุฏ ุงูููุงุฆู ุ bfq ูููู ุฌุฑุง ... <br><br><pre style=";text-align:right;direction:rtl"><code class="dos hljs">[root@fedora-<span class="hljs-number"><span class="hljs-number">29</span></span> sblkdev]# cat /sys/block/sda/queue/scheduler [mq-deadline] none</code> </pre> <br>  ุจุงูููุงุณุจุฉ ุ ูุง ูู ููุ <br><br>  ุชู ุชุฎููุถ ุนุฏุฏ ุจุฑุงูุฌ ุชุดุบูู ุงูุฃุฌูุฒุฉ ุงูุชู ุชุนูู ุจุงูุทุฑููุฉ ุงููุฏููุฉ.  ููู 5.0 ุ ุชูุช ุฅุฒุงูุฉ ุงูุฏุงูุฉ blk_init_queue () ุบูุฑ ุถุฑูุฑูุฉ.  ูุงูุขู ุงูููุฏ ุงููุฌูุฏ ุงููุฏูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">lwn.net/Articles/58720</a> ูู ุนุงู 2003 ููุณ ููุท ูู ุ ูููู ุฃูุถุง ููุฏุช ุฃูููุชูุง.  ุนูุงูุฉ ุนูู ุฐูู ุ ูุฅู ุงูุชูุฒูุนุงุช ุงูุฌุฏูุฏุฉ ุ ุงูุชู ูุชู ุฅุนุฏุงุฏูุง ููุฅุตุฏุงุฑ ูุฐุง ุงูุนุงู ุ ุชุณุชุฎุฏู ุทุจูุฉ ูุชูุฉ ูุงุฆูุฉ ุงูุชุธุงุฑ ูุชุนุฏุฏุฉ ูู ุงูุชูููู ุงูุงูุชุฑุงุถู.  ุนูู ุณุจูู ุงููุซุงู ุ ูู 18 Manjaro ุ ุงูููุงุฉ ุ ุนูู ุงูุฑุบู ูู ุฃู ุงูุฅุตุฏุงุฑ 4.19 ุ ูู blk-mq ุจุดูู ุงูุชุฑุงุถู. <br><br>  ูุฐูู ุ ูููููุง ุฃู ููุชุฑุถ ุฃู ุงูุงูุชูุงู ุฅูู blk-mq ูู kernel 5.0 ูุฏ ุงูุชูู.  ููุฐุง ุจุงููุณุจุฉ ูู ุญุฏุซ ููู ูุชุทูุจ ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุฑูุฒ ูุงุฎุชุจุงุฑ ุฅุถุงูู.  ููู ูู ุญุฏ ุฐุงุชู ูุนุฏ ุธููุฑ ุงูุฎูู ูุจูุฑูุง ูุตุบูุฑูุง ุ ุจุงูุฅุถุงูุฉ ุฅูู ุงูุนุฏูุฏ ูู ุงูุฎูุงุฏู ุงููุชุนุทูุฉ (ูู ุงูุถุฑูุฑู ุ Fedya ุ ุฅูู ุถุฑูุฑู! (C)). <br><br>  ุจุงูููุงุณุจุฉ ุ ุฅุฐุง ุงุนุชูุฏ ุดุฎุต ูุง ุฃูู ุจุงููุณุจุฉ ูู rhel8 ุ ูุฅู ููุทุฉ ุงูุชุญูู ูุฐู ูู ุชุฃุช ุ ูุธุฑูุง ูุฃู ุงูููุงุฉ "ุชู ูููุถูุง" ุจุงูุฅุตุฏุงุฑ 4.18 ููุงู ุ ูุฃูุช ูุฎุทุฆ.  ูู ุชุทุจูู RC ุงูุฌุฏูุฏ ุนูู rhel8 ุ ุชู ุจุงููุนู ุชุฑุญูู ููุชุฌุงุช ุฌุฏูุฏุฉ ูู ุงูุฅุตุฏุงุฑ 5.0 ุ ูุชู ุฃูุถูุง ุญุฐู ูุธููุฉ blk_init_queue () (ุฑุจูุง ุนูุฏ ุณุญุจ ุชุณุฌูู ูุตูู ุขุฎุฑ ูู github.com/torvalds/linux ุฅูู ูุตุงุฏุฑูุง). <br>  ุจุดูู ุนุงู ุ ูุทุงููุง ูุงู ุงูุฅุตุฏุงุฑ "ุงูุชุฌููุฏ" ูู kernel ูููุฒุนู Linux ูุซู SUSE ู Red Hat ููููููุง ููุชุณููู.  ูุจูุบ ุงููุธุงู ุฃู ุงูุฅุตุฏุงุฑ ุ ุนูู ุณุจูู ุงููุซุงู ุ ูู 4.4 ุ ูุงููุงูุน ุฃู ุงููุธููุฉ ูู ูู 4.8 ูุงููููุง ุฌุฏูุฏุฉ.  ูู ุงูููุช ููุณู ุ ูุชูุจุฑ ููุด ุนูู ุงููููุน ุงูุฑุณูู ูุซู: "ูู ุงูุชูุฒูุน ุงูุฌุฏูุฏ ุ ุญุงูุธูุง ุนูู ููุงุฉ ูุณุชูุฑุฉ 4.4". <br><br>  ูููู ููุง ูุดุชุชุง ... <br><br>  ูุฐูู ููุง.  ูุญุชุงุฌ ุฅูู ุจุฑูุงูุฌ ุชุดุบูู ุฌูุงุฒ ูุชูุฉ ุจุณูุท ุฌุฏูุฏ ูุฌุนูู ุฃูุซุฑ ูุถูุญุง ููู ูุนูู ูุฐุง. <br>  ูุฐูู ุ ุงููุตุฏุฑ ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">github.com/CodeImp/sblkdev</a> .  ุฃูุชุฑุญ ููุงูุดุฉ ุ ูุฌุนู ุทูุจุงุช ุงูุณุญุจ ุ ูุจุฏุก ุงููุดููุฉ - ุฃูุง ุณูู ุฅุตูุงุญู.  ุถูุงู ุงูุฌูุฏุฉ ูู ุชุฎุชุจุฑ ุจุนุฏ. <br><br>  ูู ููุช ูุงุญู ูู ุงูููุงูุฉ ุณุฃุญุงูู ูุตู ูุง ูู ุงูุณุจุจ.  ูุฐูู ุ ููุงู ุงููุซูุฑ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ. <br>  ุฃุนุชุฐุฑ ุนูู ุงูููุฑ ุนู ุนุฏู ุงุญุชุฑุงู ุฃุณููุจ ุชุฑููุฒ Linux kernel ุจุดูู ูุงูู ุ ููุนู - ูุง ุฃุญุจ goto. <br><br>  ูุฐูู ุ ููุจุฏุฃ ูู ููุงุท ุงูุฏุฎูู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SUCCESS; _sblkdev_major = register_blkdev(_sblkdev_major, _sblkdev_name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_sblkdev_major &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: unable to get major number\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EBUSY; } ret = sblkdev_add_device(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) unregister_blkdev(_sblkdev_major, _sblkdev_name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_exit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ sblkdev_remove_device(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_sblkdev_major &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) unregister_blkdev(_sblkdev_major, _sblkdev_name); } module_init(sblkdev_init); module_exit(sblkdev_exit);</code> </pre><br>  ูู ุงููุงุถุญ ุ ุนูุฏ ุชุญููู ุงููุญุฏุฉ ุงูููุทูุฉ ุ ูุชู ุชุดุบูู ูุธููุฉ sblkdev_init () ุ ุนูุฏ ุฅูุบุงุก ุชุญููู sblkdev_exit (). <br>  ุชุณุฌู ุงูุฏุงูุฉ register_blkdev () ุฌูุงุฒ ูุชูุฉ.  ุชู ุชุฎุตูุต ุฑูู ูุจูุฑ ูู.  unregister_blkdev () - ูุญุฑุฑ ูุฐุง ุงูุฑูู. <br><br>  ุงููููู ุงูุฑุฆูุณู ููุญุฏุชูุง ูู sblkdev_device_t. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// The internal representation of our device typedef struct sblkdev_device_s { sector_t capacity; // Device size in bytes u8* data; // The data aray. u8 - 8 bytes atomic_t open_counter; // How many openers struct blk_mq_tag_set tag_set; struct request_queue *queue; // For mutual exclusion struct gendisk *disk; // The gendisk structure } sblkdev_device_t;</span></span></code> </pre><br>  ุฃูู ูุญุชูู ุนูู ุฌููุน ุงููุนูููุงุช ุญูู ุงูุฌูุงุฒ ุงููุงุฒูุฉ ููุญุฏุฉ kernel ุ ุนูู ูุฌู ุงูุฎุตูุต: ุณุนุฉ ุฌูุงุฒ ุงููุชูุฉ ุ ูุงูุจูุงูุงุช ููุณูุง (ููุฐุง ุจุณูุท) ุ ููุคุดุฑุงุช ุนูู ุงููุฑุต ููุงุฆูุฉ ุงูุงูุชุธุงุฑ. <br><br>  ูุชู ุฅุฌุฑุงุก ูู ุชููุฆุฉ ุฌูุงุฒ ุงููุชูุฉ ูู ุฏุงูุฉ sblkdev_add_device (). <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_add_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SUCCESS; <span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>* dev = kzalloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>), GFP_KERNEL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: unable to allocate %ld bytes\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -ENOMEM; } _sblkdev_device = dev; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>{ ret = sblkdev_allocate_buffer(dev); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ret) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> 0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//simply variant with helper function blk_mq_init_sq_queue. It`s available from kernel 4.20 (vanilla). {//configure tag_set struct request_queue *queue; dev-&gt;tag_set.cmd_size = sizeof(sblkdev_cmd_t); dev-&gt;tag_set.driver_data = dev; queue = blk_mq_init_sq_queue(&amp;dev-&gt;tag_set, &amp;_mq_ops, 128, BLK_MQ_F_SHOULD_MERGE | BLK_MQ_F_SG_MERGE); if (IS_ERR(queue)) { ret = PTR_ERR(queue); printk(KERN_WARNING "sblkdev: unable to allocate and initialize tag set\n"); break; } dev-&gt;queue = queue; } #else // more flexible variant {//configure tag_set dev-&gt;tag_set.ops = &amp;_mq_ops; dev-&gt;tag_set.nr_hw_queues = 1; dev-&gt;tag_set.queue_depth = 128; dev-&gt;tag_set.numa_node = NUMA_NO_NODE; dev-&gt;tag_set.cmd_size = sizeof(sblkdev_cmd_t); dev-&gt;tag_set.flags = BLK_MQ_F_SHOULD_MERGE | BLK_MQ_F_SG_MERGE; dev-&gt;tag_set.driver_data = dev; ret = blk_mq_alloc_tag_set(&amp;dev-&gt;tag_set); if (ret) { printk(KERN_WARNING "sblkdev: unable to allocate tag set\n"); break; } } {//configure queue struct request_queue *queue = blk_mq_init_queue(&amp;dev-&gt;tag_set); if (IS_ERR(queue)) { ret = PTR_ERR(queue); printk(KERN_WARNING "sblkdev: Failed to allocate queue\n"); break; } dev-&gt;queue = queue; } #endif dev-&gt;queue-&gt;queuedata = dev; {// configure disk struct gendisk *disk = alloc_disk(1); //only one partition if (disk == NULL) { printk(KERN_WARNING "sblkdev: Failed to allocate disk\n"); ret = -ENOMEM; break; } disk-&gt;flags |= GENHD_FL_NO_PART_SCAN; //only one partition //disk-&gt;flags |= GENHD_FL_EXT_DEVT; disk-&gt;flags |= GENHD_FL_REMOVABLE; disk-&gt;major = _sblkdev_major; disk-&gt;first_minor = 0; disk-&gt;fops = &amp;_fops; disk-&gt;private_data = dev; disk-&gt;queue = dev-&gt;queue; sprintf(disk-&gt;disk_name, "sblkdev%d", 0); set_capacity(disk, dev-&gt;capacity); dev-&gt;disk = disk; add_disk(disk); } printk(KERN_WARNING "sblkdev: simple block device was created\n"); }while(false); if (ret){ sblkdev_remove_device(); printk(KERN_WARNING "sblkdev: Failed add block device\n"); } return ret; }</span></span></span></span></code> </pre><br>  ูุญู ูุฎุตุต ุฐุงูุฑุฉ ูููููู ุ ููุฎุตุต ูุฎุฒููุง ูุคูุชูุง ูุชุฎุฒูู ุงูุจูุงูุงุช.  ูุง ุดูุก ุฎุงุต ููุง. <br>  ุจุนุฏ ุฐูู ุ ูููู ุจุชููุฆุฉ ูุงุฆูุฉ ุงูุชุธุงุฑ ูุนุงูุฌุฉ ุงูุทูุจ ุฅูุง ุจุงุณุชุฎุฏุงู ุฏุงูุฉ blk_mq_init_sq_queue () ูุงุญุฏุฉ ุฃู ุงุซูุชูู ูู ุขู ูุงุญุฏ: blk_mq_alloc_tag_set () + blk_mq_init_queue (). <br><br>  ุจุงูููุงุณุจุฉ ุ ุฅุฐุง ูุธุฑุช ุฅูู ูุตุงุฏุฑ ุงูุฏุงูุงุช blk_mq_init_sq_queue () ุ ูุณุชุฑู ุฃู ูุฐุง ูุฌุฑุฏ ุบูุงู ุนูู ุฏุงูุงุช blk_mq_alloc_tag_set () ู blk_mq_init_queue () ุงูุชู ุธูุฑุช ูู 4.20 kernel.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุฅูู ูุฎูููุง ุงูุนุฏูุฏ ูู ูุนููุงุช ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุ ูููู ูุจุฏู ุฃุจุณุท ุจูุซูุฑ.  ูุฌุจ ุนููู ุงุฎุชูุงุฑ ุงูุฎูุงุฑ ุงูุฃูุถู ุ ููููู ุฃูุถู ุฎูุงุฑูุง ุฃูุซุฑ ูุถูุญูุง. <br><br>  ุงูููุชุงุญ ูู ูุฐุง ุงูุฑูุฒ ูู ุงููุชุบูุฑ ุงูุนูููู _mq_ops. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blk_mq_ops</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mq_ops</span></span></span><span class="hljs-class"> = {</span></span> .queue_rq = queue_rq, };</code> </pre><br>  ูุฐุง ูู ุงูููุงู ุงูุฐู ุชูุฌุฏ ููู ุงููุธููุฉ ุงูุชู ุชููุฑ ูุนุงูุฌุฉ ุงูุทูุจุงุช ุ ูููู ุงููุฒูุฏ ุนููุง ูู ููุช ูุงุญู.  ุงูุดูุก ุงูุฑุฆูุณู ูู ุฃููุง ูููุง ุจุชุนููู ููุทุฉ ุงูุฏุฎูู ุฅูู ูุนุงูุฌ ุงูุทูุจ. <br><br>  ุงูุขู ููุฏ ุฃูุดุฃูุง ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุ ูููููุง ุฅูุดุงุก ูุซูู ูููุฑุต. <br><br>  ูุง ุชูุฌุฏ ุชุบููุฑุงุช ูุจูุฑุฉ.  ูุชู ุชุฎุตูุต ุงููุฑุต ุ ููุชู ุชุนููู ุงููุนููุงุช ุ ููุถุงู ุงููุฑุต ุฅูู ุงููุธุงู.  ุฃุฑูุฏ ุฃู ุฃุดุฑุญ ุญูู ุงููุนููุฉ disk-&gt; ุงูุฃุนูุงู.  ูุณูุญ ูู ุจุฅุฎุจุงุฑ ุงููุธุงู ุฃู ุงููุฑุต ูุงุจู ููุฅุฒุงูุฉ ุ ุฃู ุนูู ุณุจูู ุงููุซุงู ุ ุฃูู ูุง ูุญุชูู ุนูู ุฃูุณุงู ููุง ุชุญุชุงุฌ ุฅูู ุงูุจุญุซ ุนููุง ููุงู. <br><br>  ููุงู ุจููุฉ _fops ูุฅุฏุงุฑุฉ ุงููุฑุต. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block_device_operations</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fops</span></span></span><span class="hljs-class"> = {</span></span> .owner = THIS_MODULE, .open = _open, .release = _release, .ioctl = _ioctl, #ifdef CONFIG_COMPAT .compat_ioctl = _compat_ioctl, #endif };</code> </pre><br>  ููุงุท ุงูุฏุฎูู _open ู _release ุจุงููุณุจุฉ ููุง ููุญุฏุฉ ุฌูุงุฒ ูุชูุฉ ุจุณูุทุฉ ููุณุช ูุซูุฑุฉ ููุงูุชูุงู ููุบุงูุฉ ุญุชู ุงูุขู.  ุจุงูุฅุถุงูุฉ ุฅูู ุงูุนุฏุงุฏ ุงูุฐุฑู ูุงูููุตุงู ุ ูุง ููุฌุฏ ุดูุก ููุงู.  ููุฏ ุชุฑูุช compat_ioctl ุฃูุถูุง ุฏูู ุชุทุจูู ุ ูุฃู ุฅุตุฏุงุฑ ุงูุฃูุธูุฉ ุงูุชู ุชุญุชูู ุนูู 64-bit kern ูุจูุฆุฉ ุงููุณุชุฎุฏู 32 ุจุช ูุง ูุจุฏู ูุงุนุฏุงู ุจุงููุณุจุฉ ูู. <br><br>  ููู _ioctl ูุณูุญ ูู ุจูุนุงูุฌุฉ ุทูุจุงุช ุงููุธุงู ููุญุฑู ุงูุฃูุฑุงุต ูุฐุง.  ุนูุฏูุง ูุธูุฑ ูุฑุต ุ ูุญุงูู ุงููุธุงู ูุนุฑูุฉ ุงููุฒูุฏ ุนูู.  ููููุง ูุชูุฏูุฑู ุงูุฎุงุต ุ ููููู ุงูุฅุฌุงุจุฉ ุนูู ุจุนุถ ุงูุงุณุชุนูุงูุงุช (ุนูู ุณุจูู ุงููุซุงู ุ ุงูุชุธุงูุฑ ุจุฃููุง ูุฑุต ูุถุบูุท ุฌุฏูุฏ) ุ ููู ุงููุงุนุฏุฉ ุงูุนุงูุฉ ูู: ุฅุฐุง ููุช ูุง ุชุฑุบุจ ูู ุงูุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑุงุช ูุง ุชููู ุ ููู ููุท ุจุฅุฑุฌุงุน ุฑูุฒ ุงูุฎุทุฃ -ENOTTY.  ุจุงูููุงุณุจุฉ ุ ุฅุฐุง ูุฒู ุงูุฃูุฑ ุ ููููู ููุง ุฅุถุงูุฉ ูุนุงูุฌุงุช ุทูุจู ูููุง ูุชุนูู ุจูุญุฑู ุงูุฃูุฑุงุต ูุฐุง. <br><br>  ูุฐูู ุ ุฃุถููุง ุงูุฌูุงุฒ - ูุญู ุจุญุงุฌุฉ ูุฑุนุงูุฉ ุงูุงูุฑุงุฌ ุนู ุงูููุงุฑุฏ.  ุงูุตุฏุฃ ููุณ <s>ููุง ูู</s> ุฃุฌูู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_remove_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>* dev = _sblkdev_device; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;disk) del_gendisk(dev-&gt;disk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>) { blk_cleanup_queue(dev-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>); dev-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;tag_set.tags) blk_mq_free_tag_set(&amp;dev-&gt;tag_set); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;disk) { put_disk(dev-&gt;disk); dev-&gt;disk = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } sblkdev_free_buffer(dev); kfree(dev); _sblkdev_device = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: simple block device was removed\n"</span></span>); } }</code> </pre><br>  ูู ุญูุซ ุงููุจุฏุฃ ุ ูู ุดูุก ูุงุถุญ: ูููู ุจุญุฐู ูุงุฆู ุงููุฑุต ูู ุงููุธุงู ูุชุญุฑูุฑ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุ ูุจุนุฏ ุฐูู ูููู ุฃูุถูุง ุจุชุญุฑูุฑ ูุฎุงุฒููุง ุงููุคูุชุฉ (ููุงุทู ุงูุจูุงูุงุช). <br><br>  ูุงูุฃูู ุงูุขู ูู ูุนุงูุฌุฉ ุงูุงุณุชุนูุงู ูู ุฏุงูุฉ queue_rq (). <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> blk_status_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queue_rq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct blk_mq_hw_ctx *hctx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct blk_mq_queue_data* bd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">blk_status_t</span></span> status = BLK_STS_OK; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rq</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bd</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rq</span></span></span><span class="hljs-class">;</span></span> blk_mq_start_request(rq); <span class="hljs-comment"><span class="hljs-comment">//we cannot use any locks that make the thread sleep { unsigned int nr_bytes = 0; if (do_simple_request(rq, &amp;nr_bytes) != SUCCESS) status = BLK_STS_IOERR; printk(KERN_WARNING "sblkdev: request process %d bytes\n", nr_bytes); #if 0 //simply and can be called from proprietary module blk_mq_end_request(rq, status); #else //can set real processed bytes count if (blk_update_request(rq, status, nr_bytes)) //GPL-only symbol BUG(); __blk_mq_end_request(rq, status); #endif } return BLK_STS_OK;//always return ok }</span></span></code> </pre><br>  ุฃููุง ุ ุงููุธุฑ ูู ุงููุนููุงุช.  ุงูุฃูู ูู ุงูุจููุฉ blk_mq_hw_ctx * hctx - ุญุงูุฉ ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุฃุฌูุฒุฉ.  ูู ุญุงูุชูุง ุ ููุญู ููุนู ุฏูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุฃุฌูุฒุฉ ุ ูุฐูู ุบูุฑ ูุณุชุฎุฏูุฉ. <br><br>  ุงููุนููุฉ ุงูุซุงููุฉ ูู const struct blk_mq_queue_data * bd - ูุนููุฉ ุฐุงุช ุจููุฉ ููุฌุฒุฉ ููุบุงูุฉ ุ ููุง ุฃุฎุดู ุฃู ุฃูุฌู ุงูุชุจุงููู ุฅูููุง ุจุงููุงูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blk_mq_queue_data</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rq</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> last; };</code> </pre><br>  ุงุชุถุญ ุฃูู ูู ุฌููุฑู ุ ูุฐุง ูู ููุณ ุงูุทูุจ ุงูุฐู ุฌุงุก ุฅูููุง ูู ุงูุฃููุงุช ุงูุชู ูู ูุนุฏ ูุชุฐูุฑูุง ุงููุคุฑุฎ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">elixir.bootlin.com</a> .  ูุฐูู ูุญู ูุฃุฎุฐ ุงูุทูุจ ููุจุฏุฃ ูู ูุนุงูุฌุชู ุ ูุงูุฐู ูุนูู ุจู kernel ุนู ุทุฑูู ุงูุงุชุตุงู ุจู blk_mq_start_request ().  ุนูุฏ ุงูุงูุชูุงุก ูู ูุนุงูุฌุฉ ุงูุทูุจ ุ ุณูุจูุบ kernel ุจูุฐุง ุนู ุทุฑูู ุงุณุชุฏุนุงุก ุฏุงูุฉ blk_mq_end_request (). <br><br>  ูููุง ููู ููุงุญุธุฉ ุตุบูุฑุฉ: ุงูุฏุงูุฉ blk_mq_end_request () ูู ุฃุณุงุณูุง ุงูุชูุงู ุนูู ุงูููุงููุงุช ุฅูู blk_update_request () + __blk_mq_end_request ().  ุนูุฏ ุงุณุชุฎุฏุงู ุฏุงูุฉ blk_mq_end_request () ุ ูุง ููููู ุชุญุฏูุฏ ุนุฏุฏ ุงูุจุงูุชุงุช ุงูุชู ุชูุช ูุนุงูุฌุชูุง ุจุงููุนู.  ูุนุชูุฏ ุฃู ูู ุดูุก ูุชู ูุนุงูุฌุชู. <br><br>  ูุญุชูู ุงูุฎูุงุฑ ุงูุจุฏูู ุนูู ููุฒุฉ ุฃุฎุฑู: ูุชู ุชุตุฏูุฑ ุงูุฏุงูุฉ blk_update_request ููุท ูููุญุฏุงุช ุงูููุทูุฉ GPL ููุท.  ููุฐุง ูู ุ ุฅุฐุง ููุช ุชุฑุบุจ ูู ุฅูุดุงุก ูุญุฏุฉ kernel ุฎุงุตุฉ (ุงุณูุญ PM ุจุญูุธู ูู ูุฐุง ุงููุณุงุฑ ุงูุดุงุฆู) ุ ูุง ููููู ุงุณุชุฎุฏุงู blk_update_request ().  ูุจุงูุชุงูู ูุฅู ุงูุฎูุงุฑ ูู. <br><br>  ุชุญููู ุงูุจุงูุช ูุจุงุดุฑุฉ ูู ุงูุทูุจ ุฅูู ุงููุฎุฒู ุงููุคูุช ูุงูุนูุณ ุจุงูุนูุณ ุฃุถุนู ูู ุงูุฏุงูุฉ do_simple_request (). <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_simple_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct request *rq, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *nr_bytes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SUCCESS; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bio_vec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bvec</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req_iterator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iter</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span> *dev = rq-&gt;q-&gt;queuedata; <span class="hljs-keyword"><span class="hljs-keyword">loff_t</span></span> pos = blk_rq_pos(rq) &lt;&lt; SECTOR_SHIFT; <span class="hljs-keyword"><span class="hljs-keyword">loff_t</span></span> dev_size = (<span class="hljs-keyword"><span class="hljs-keyword">loff_t</span></span>)(dev-&gt;capacity &lt;&lt; SECTOR_SHIFT); printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: request start from sector %ld \n"</span></span>, blk_rq_pos(rq)); rq_for_each_segment(bvec, rq, iter) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> b_len = bvec.bv_len; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* b_buf = page_address(bvec.bv_page) + bvec.bv_offset; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((pos + b_len) &gt; dev_size) b_len = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(dev_size - pos); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rq_data_dir(rq))<span class="hljs-comment"><span class="hljs-comment">//WRITE memcpy(dev-&gt;data + pos, b_buf, b_len); else//READ memcpy(b_buf, dev-&gt;data + pos, b_len); pos += b_len; *nr_bytes += b_len; } return ret; }</span></span></code> </pre><br>  ูุง ููุฌุฏ ุดูุก ุฌุฏูุฏ: ุชุชูุฑุฑ rq_for_each_segment ุนูู ูู ุดูุก ุญููู ุ ููุฏููุง ุฌููุนูุง ููุงูู bio_vec ุ ููุง ูุณูุญ ููุง ุจุงููุตูู ุฅูู ุงูุตูุญุงุช ุงูุชู ุชุญุชูู ุนูู ุจูุงูุงุช ุงูุทูุจ. <br><br>  ูุง ูู ุงูุทุจุงุนุงุชูุ  ูู ุดูุก ูุจุฏู ุจุณูุทุงุ  ูุนุงูุฌุฉ ุงูุทูุจุงุช ุจุดูู ุนุงู ูู ุจุจุณุงุทุฉ ูุณุฎ ุงูุจูุงูุงุช ุจูู ุตูุญุงุช ุงูุทูุจ ูุงููุฎุฒู ุงููุคูุช ุงูุฏุงุฎูู.  ูุณุชุญู ุชูุงูุง ูุจุฑูุงูุฌ ุชุดุบูู ุฌูุงุฒ ูุชูุฉ ุจุณูุทุฉ ุ ุฃููุณ ูุฐููุ <br><br>  ูููู ููุงู ูุดููุฉ: <b>ูุฐุง ููุณ ููุงุณุชุฎุฏุงู ุงูุญูููู!</b> <br><br>  ูุชูุซู ุฌููุฑ ุงููุดููุฉ ูู ุงุณุชุฏุนุงุก ุฏุงูุฉ ูุนุงูุฌุฉ ุทูุจ queue_rq () ูู ุญููุฉ ุชููู ุจูุนุงูุฌุฉ ุงูุทูุจุงุช ูู ุงููุงุฆูุฉ.  ูุง ุฃุนุฑู ุฃู ููู ููุฐู ุงููุงุฆูุฉ ูุชู ุงุณุชุฎุฏุงูู ููุงู ุ Spin ุฃู RCU (ูุง ุฃุฑูุฏ ุฃู ุฃูุฐุจ - ูู ูุฏุฑู ุ ูุตุญุญูู) ุ ููู ุนูุฏูุง ุชุญุงูู ุงุณุชุฎุฏุงู ุ ุนูู ุณุจูู ุงููุซุงู ุ mutex ูู ูุธููุฉ ูุนุงูุฌุฉ ุงูุทูุจ ุ ูุฅู kernel ุชุตุญูุญ ุงูุฃุฎุทุงุก ูุญุฐุฑ: doze off ููุง ูู ูุณุชุญูู.  ููุฐุง ูุนูู ุฃู ุงุณุชุฎุฏุงู ุฃุฏูุงุช ุงููุฒุงููุฉ ุงูุชูููุฏูุฉ ุฃู ุงูุฐุงูุฑุฉ ุงููุชุฌุงูุฑุฉ ุงูุงูุชุฑุงุถูุฉ - ุชูู ุงูุชู ูุชู ุชุฎุตูุตูุง ุจุงุณุชุฎุฏุงู vmalloc ููููู ุฃู ุชูุน ูู ุงููุจุงุฏูุฉ ุจูู ูุง ุชุชุถููู - ุฃูุฑ ูุณุชุญูู ุ ุญูุซ ูุง ูููู ุฃู ุชุฏุฎู ุงูุนูููุฉ ูู ุญุงูุฉ ุงูุงุณุชุนุฏุงุฏ. <br><br>  ูุฐูู ุ ุฅูุง ุชุฃููู Spin ุฃู RCU ููุท ููุฎุฒู ูุคูุช ูู ุดูู ุตููู ูู ุงูุตูุญุงุช ุ ุฃู ูุงุฆูุฉ ุ ุฃู ุดุฌุฑุฉ ุ ููุง ูู ูุทุจู ูู .. \ linux \ drivers \ block \ brd.c ุ ุฃู ุชุฃุฎุฑ ุงููุนุงูุฌุฉ ูู ูุคุดุฑ ุชุฑุงุจุท ุขุฎุฑ ุ ููุง ูู ูุทุจู ูู .. \ linux \ drivers \ block \ loop.c. <br><br>  ุฃุนุชูุฏ ุฃูู ููุณุช ููุงู ุญุงุฌุฉ ููุตู ููููุฉ ุชุฌููุน ุงููุญุฏุฉ ุ ูููููุฉ ุชุญููููุง ูู ุงููุธุงู ูููููุฉ ุงูุชูุฑูุบ.  ูุง ุชูุฌุฏ ููุชุฌุงุช ุฌุฏูุฏุฉ ูู ูุฐุง ุงููุฌุงู ุ ุดูุฑูุง ุนูู ุฐูู :) ูุฐุง ุฅุฐุง ูุงู ููุงู ูู ูุฑูุฏ ุชุฌุฑุจุชู ุ ูุณุชููู ูุชุฃูุฏูุง ูู ุฐูู.  <b>ูุง ุชูุนู ุฐูู ุนูู ุงูููุฑ ุนูู ุงูููุจููุชุฑ ุงููุญููู ุงูููุถู ูุฏูู!</b>  ุฑูุน virtualochka ุฃู ุนูู ุงูุฃูู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุนูู ุงููุฑุฉ. <br><br>  ุจุงูููุงุณุจุฉ ุ Veeam Backup for Linux 3.0.1.1046 ูุชุงุญ ุจุงููุนู.  ููุท ูุง ุชุญุงูู ุชุดุบูู VAL 3.0.1.1046 ุนูู ููุงุฉ 5.0 ุฃู ูู ููุช ูุงุญู.  ุณูู veeamsnap ูุง ุชุฌููุน.  ููุง ุฒุงูุช ุจุนุถ ุงูุงุจุชูุงุฑุงุช ูุชุนุฏุฏุฉ ุงูุตููู ูู ูุฑุญูุฉ ุงูุงุฎุชุจุงุฑ. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar446148/">https://habr.com/ru/post/ar446148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar446134/index.html">ุญูู ุงูุชุจุนูุฉ ูู ุงูุฑูุฑูุฉ</a></li>
<li><a href="../ar446136/index.html">ุจูุฏู ุงูุฑุฎุงู ุขูุฉ 3D ูุทุจูุนุฉ</a></li>
<li><a href="../ar446138/index.html">ูุง ูุฏู ุณูููุฉ ุชูุธูู ุจุฏุก ุงูุชุดุบูู ุจุดูู ูุงูููู ูู ุดูู ุดุฑุงูุฉ ุจุณูุทุฉ</a></li>
<li><a href="../ar446142/index.html">ุงูุฃุฑุถ ุงููุณุทุญุฉ: ุงูุชุฌุงุฑุจ ูุงูุฃุฏูุฉ</a></li>
<li><a href="../ar446144/index.html">ููุฎุต ุงูููุงุฏ ุงููุซูุฑุฉ ููุงูุชูุงู ููุทูุฑ ุงูุฌูุงู ุฑูู 292 (25 ูุงุฑุณ - 31 ูุงุฑุณ)</a></li>
<li><a href="../ar446150/index.html">ุชุนูู ุงูุขูุฉ ุจุฏูู ุจูุซูู ุ ุฃูุงูููุฏุง ูุบูุฑูุง ูู ุงูุฒูุงุญู</a></li>
<li><a href="../ar446152/index.html">ูููุงูุฏูุฒ VM - ูุงูู ููููุณ ุงูุจุฏูู ููุธุงู ุงูุชุดุบูู Windows</a></li>
<li><a href="../ar446162/index.html">ููู ุชุตุจุญ "ุฌููููุฑ ุฐูู". ุชุฌุฑุจุฉ ุดุฎุตูุฉ</a></li>
<li><a href="../ar446166/index.html">ุจุณูุท sprintf ASN1 ุงูุชุฑููุฒ</a></li>
<li><a href="../ar446172/index.html">ุญุฏ ุงูุฑุณุงุฆู API VK - ูุง ูุฌุจ ุงูููุงู ุจู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>