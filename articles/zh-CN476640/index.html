<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤧 👦 🙋 保护Zimbra OSE免受暴力和DoS攻击 🍵 🌈 🧀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zimbra Collaboration Suite开源版在其工具库中提供了许多用于确保信息安全的强大工具。 其中， Postscreen是一种保护邮件服务器免受僵尸网络攻击的解决方案； ClamAV是一种防病毒软件，可以扫描传入文件和信件中是否存在恶意软件感染，而SpamAssassin是迄今为止...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>保护Zimbra OSE免受暴力和DoS攻击</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/zimbra/blog/476640/">  Zimbra Collaboration Suite开源版在其工具库中提供了许多用于确保信息安全的强大工具。 其中， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Postscreen</a>是一种保护邮件服务器免受僵尸网络攻击的解决方案； ClamAV是一种防病毒软件，可以扫描传入文件和信件中是否存在恶意软件感染，而<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SpamAssassin</a>是迄今为止最好的垃圾邮件过滤器之一。 但是，这些工具无法保护Zimbra OSE免受暴力攻击。 在特殊词典中，密码并不是最优雅的方法，但仍然非常有效地枚举，不仅充满了成功破解所有后继后果的可能性，而且还带来了服务器上大量负载的创建，该负载处理了所有使用Zimbra OSE破解服务器的未成功尝试。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e98/93d/7d9/e9893d7d9f995c2a24dce02df7fa5d51.png" alt="图片"><br><a name="habracut"></a><br> 原则上，您可以使用标准Zimbra OSE工具保护自己免受暴力侵害。 密码安全策略设置允许您设置密码尝试失败的次数，此后将阻止可能受到攻击的帐户。 这种方法的主要问题是，可能会发生这样的情况：一个或多个员工的帐户可能由于暴力攻击而被封锁，而他们对此毫无关系，并且员工的简单工作可能给公司带来巨大损失。 这就是为什么最好不要采用这种防止暴力的选择。 <br><br><img src="https://habrastorage.org/webt/gz/cn/kg/gzcnkguoq2isuxplbgetg-y1ft4.png"><br><br> 为了防止暴力，Zimbra OSE内置了一个称为DoSFilter的特殊工具，它可以通过HTTP自动与Zimbra OSE断开连接。 换句话说，DoSFilter的操作原理类似于PostScreen的操作原理，仅用于其他协议。 最初旨在限制单个用户可以执行的操作数量，DoSFilter也可以提供针对暴力的保护。 它与Zimbra内置工具的主要区别在于，经过一定次数的不成功尝试后，它不会阻止用户本人，而是阻止进行多次尝试登录到一个或另一个帐户的IP地址。 因此，系统管理员不仅可以保护自己免受暴力侵害，还可以通过简单地将其公司的内部网络添加到受信任的IP地址和子网列表中来避免阻止公司员工。 <br><br>  DoSFilter的一大优点是，除了多次尝试登录一个或另一个帐户外，您还可以使用此工具自动阻止那些拥有员工身份验证数据的网络罪犯，然后成功登录其帐户并开始向服务器发送数百个请求。 <br><br> 您可以使用以下控制台命令配置DoSFilter： <br><br><ul><li>  <b>zimbraHttpDosFilterMaxRequestsPerSec-</b>使用此命令可以设置一个用户允许的最大连接数。 默认情况下，此值为30个连接。 </li><li>  <b>zimbraHttpDosFilterDelayMillis-</b>使用此命令，可以设置超出上一命令设置的限制的连接的延迟（以毫秒为单位）。 除了整数值之外，管理员还可以指定0以便根本没有延迟，还可以指定-1以便简单地中断所有超过指定限制的连接。 默认情况下，此值为-1。 </li><li> <b>zimbraHttpThrottleSafeIPs-</b>使用此命令，管理员可以指定不受上述限制影响的受信任IP地址和子网。 请注意，此命令的语法可能会根据所需结果而有所不同。 因此，例如，通过输入命令<b>zmprov mcf zimbraHttpThrottleSafeIPs 127.0.0.1</b> ，您可以完全重写整个列表，并在其中仅保留一个IP地址。 如果输入命令<b>zmprov mcf + zimbraHttpThrottleSafeIPs 127.0.0.1</b> ，则输入的IP地址将添加到白名单中。 同样，使用减号，您可以从允许的列表中删除任何IP。 </li></ul><br> 请注意，使用Zextras Suite Pro扩展程序时，DoSFilter可能会导致许多问题。 为了避免它们，我们建议使用命令<b>zmprov mcf zimbraHttpDosFilterMaxRequestsPerSec 100</b>将同时连接的数量从30 <b>增加到100</b> 。 另外，我们建议将企业的内部网络添加到允许的列表中。 可以使用命令<b>zmprov mcf + zimbraHttpThrottleSafeIPs 192.168.0.0/24</b>来完成。 对DoSFilter进行任何更改之后，请确保使用<b>zmmailboxdctl restart</b>命令重新启动邮件服务器。 <br><br>  DoSFilter的主要缺点是它可以在应用程序级别运行，因此只能限制攻击者在服务器上执行各种操作的能力，而不能限制连接到北方的能力。 因此，尽管认证请求或发送给服务器的信件显然是失败的，但它们仍将是一种很好的旧DoS攻击，无法在如此高的级别上阻止。 <br><br> 为了使用Zimbra OSE完全保护公司服务器，可以使用Fail2ban之类的解决方案，该框架可以不断监视信息系统日志中是否存在重复操作，并通过更改防火墙设置来阻止入侵者。 如此低的阻止水平可让您在与服务器的IP连接阶段立即禁用攻击者。 因此，Fail2Ban可以完美补充使用DoSFilter构建的保护。 让我们了解如何使用Zimbra OSE结识Fail2Ban朋友，从而提高企业IT基础架构的安全性。 <br><br> 像任何其他企业级应用程序一样，Zimbra Collaboration Suite开源版维护其工作的详细日志。 它们大多数以文件形式存储在<b>/ opt / zimbra / log /</b>文件夹中。 这里只是其中一些： <br><br><ul><li>  Mailbox.log-码头邮件服务日志 </li><li>  audit.log-身份验证日志 </li><li>  clamd.log-防病毒日志 </li><li>  freshclam.log-防病毒更新日志 </li><li>  convertd.log-附件转换器日志 </li><li>  zimbrastats.csv-服务器性能日志 </li></ul><br>  Zimbra日志也可以在<b>/var/log/zimbra.log</b>文件中找到，该文件中维护了Postfix和Zimbra本身的日志。 <br><br> 为了保护我们的系统免受暴力侵害，我们将监视<b>mailbox.log</b> ， <b>audit.log</b>和<b>zimbra.log</b> 。 <br><br> 为了使所有功能正常工作，必须使用Zimbra OSE在您的服务器上安装Fail2Ban和iptables。 如果使用Ubuntu，则可以使用<b>dpkg -s fail2ban命令</b>执行此<b>操作</b> ，但是如果使用CentOS，则可以使用<b>安装</b>的<b>yum list fail2ban命令进行验证</b> 。 如果您没有安装Fail2Ban，则安装它不会有问题，因为该软件包几乎在所有标准存储库中。 <br><br> 安装所有必需的软件之后，您可以继续配置Fail2Ban。 为此，创建一个配置文件<b>/etc/fail2ban/filter.d/zimbra.conf</b> ，在其中我们为Zimbra OSE日志编写正则表达式，该表达式将对应于错误的登录尝试并触发Fail2Ban机制。 这是zimbra.conf内容的示例，其中包含一组正则表达式，它们对应于身份验证尝试失败时Zimbra OSE生成的各种错误： <br><br><pre><code class="plaintext hljs"># Fail2Ban configuration file [Definition] failregex = \[ip=&lt;HOST&gt;;\] account - authentication failed for .* \(no such account\)$ \[ip=&lt;HOST&gt;;\] security - cmd=Auth; .* error=authentication failed for .*, invalid password;$ ;oip=&lt;HOST&gt;;.* security - cmd=Auth; .* protocol=soap; error=authentication failed for .* invalid password;$ ;oip=&lt;HOST&gt;;.* security - cmd=Auth; .* protocol=imap; error=authentication failed for .* invalid password;$ \[oip=&lt;HOST&gt;;.* SoapEngine - handler exception: authentication failed for .*, account not found$ WARN .*;ip=&lt;HOST&gt;;ua=ZimbraWebClient .* security - cmd=AdminAuth; .* error=authentication failed for .*;$ ignoreregex =</code> </pre> <br> 编译Zimbra OSE的正则表达式后，该开始编辑Fail2ban本身的配置了。 该实用程序的设置位于<b>/etc/fail2ban/jail.conf</b>文件中。 为了以防万一，我们将使用<b>cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.conf.bak</b>命令<b>对其进行备份</b> 。 之后，让我们将该文件转换为以下格式： <br><br><pre> <code class="plaintext hljs"># Fail2Ban configuration file [DEFAULT] ignoreip = 192.168.0.1/24 bantime = 600 findtime = 600 maxretry = 5 backend = auto [ssh-iptables] enabled = false filter = sshd action = iptables[name=SSH, port=ssh, protocol=tcp] sendmail-whois[name=SSH, dest=admin@company.ru, sender=fail2ban@company.ru] logpath = /var/log/messages maxretry = 5 [sasl-iptables] enabled = false filter = sasl backend = polling action = iptables[name=sasl, port=smtp, protocol=tcp] sendmail-whois[name=sasl, dest=support@company.ru] logpath = /var/log/zimbra.log [ssh-tcpwrapper] enabled = false filter = sshd action = hostsdeny sendmail-whois[name=SSH, dest=support@ company.ru] ignoreregex = for myuser from logpath = /var/log/messages [zimbra-account] enabled = true filter = zimbra action = iptables-allports[name=zimbra-account] sendmail[name=zimbra-account, dest=support@company.ru ] logpath = /opt/zimbra/log/mailbox.log bantime = 600 maxretry = 5 [zimbra-audit] enabled = true filter = zimbra action = iptables-allports[name=zimbra-audit] sendmail[name=Zimbra-audit, dest=support@company.ru] logpath = /opt/zimbra/log/audit.log bantime = 600 maxretry = 5 [zimbra-recipient] enabled = true filter = zimbra action = iptables-allports[name=zimbra-recipient] sendmail[name=Zimbra-recipient, dest=support@company.ru] logpath = /var/log/zimbra.log bantime = 172800 maxretry = 5 [postfix] enabled = true filter = postfix action = iptables-multiport[name=postfix, port=smtp, protocol=tcp] sendmail-buffered[name=Postfix, dest=support@company.ru] logpath = /var/log/zimbra.log bantime = -1 maxretry = 5</code> </pre> <br> 尽管此示例相当通用，但值得解释一下自己设置Fail2Ban时可能要更改的一些参数： <br><br><ul><li>  <b>Ignoreip-</b>使用此参数，您可以指定特定的IP或子网，即不应该从中检查Fail2Ban的地址。 通常，企业的内部网络和其他受信任地址将添加到忽略列表中。 </li><li>  <b>禁止</b>时间-入侵者将被禁止的时间。 以秒为单位。 值-1表示无限制。 </li><li>  <b>Maxretry-</b>一个IP地址可以尝试访问服务器的最大次数。 </li><li>  <b>Sendmail-</b>一种设置，使您可以自动发送有关Fail2Ban操作的电子邮件警报。 </li><li>  <b>Findtime-</b>一种设置，允许您设置时间间隔，在该时间间隔内，尝试失败的最大次数已用完之后，IP地址可以再次尝试访问服务器（maxretry参数） </li></ul><br> 使用Fail2Ban设置保存文件后，仅使用<b>service fail2ban restart命令</b>重新启动此实用程序。 重新启动后，将连续监视Zimbra主日志中的正则表达式匹配。 因此，管理员几乎可以消除入侵者进入Zimbra Collaboration Suite开源版邮箱的任何可能性，而且还可以保护Zimbra OSE内运行的所有服务，并知道进行未经授权访问的任何尝试。 <br><br> 有关Zextras Suite的所有问题，您可以通过电子邮件katerina@zextras.com与Zextras代表联系，Ekaterina Triandafilidi。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN476640/">https://habr.com/ru/post/zh-CN476640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN476620/index.html">SP701 + PCAM-5C + 15分钟+ VITIS = FPGA上的简易MIPI</a></li>
<li><a href="../zh-CN476624/index.html">移动开发中的质量管道，第1部分：Android</a></li>
<li><a href="../zh-CN476626/index.html">云中的PVS-Studio：GitLab CI / CD</a></li>
<li><a href="../zh-CN476628/index.html">PVS-Studio走向云端：GitLab CI / CD</a></li>
<li><a href="../zh-CN476636/index.html">调整Firebird和Linux，以容纳691 GB的数据库，可容纳1000多个用户</a></li>
<li><a href="../zh-CN476644/index.html">语言层</a></li>
<li><a href="../zh-CN476646/index.html">在werf中进行3种方式合并：在Heber上部署Kubernetes，“在类固醇上”</a></li>
<li><a href="../zh-CN476648/index.html">联想在FINOPOLIS 2019</a></li>
<li><a href="../zh-CN476650/index.html">枚举在当今瞬息万变的世界中的地位</a></li>
<li><a href="../zh-CN476656/index.html">11月26日，莫斯科-Alfa JS MeetUP＃3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>