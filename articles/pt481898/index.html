<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéâ üéÆ üõãÔ∏è Servidor web simples para SPA / PWA em 5 minutos üí∑ üñêüèæ üë®üèº‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como criar um servidor da Web simples usando apenas instru√ß√µes nodejs padr√£o 


 Geralmente, √© necess√°rio um servidor Web simples para desenvolver apl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor web simples para SPA / PWA em 5 minutos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481898/"><h1 id="kak-sozdat-prostoy-veb-server-ispolzuya-tolko-standartnye-instrukcii-nodejs">  Como criar um servidor da Web simples usando apenas instru√ß√µes nodejs padr√£o </h1><br><p> Geralmente, √© necess√°rio um servidor Web simples para desenvolver aplicativos MPA / SPA / PWA.  Uma vez, em uma grande manifesta√ß√£o em resposta √† pergunta: "O que voc√™ estava fazendo?", Eu disse que estava criando um servidor da Web para hospedar um aplicativo PWA.  Todos n√≥s rimos por um longo tempo e sim, a prop√≥sito, o PWA n√£o √© cola.  Como o SPA, n√£o √© um sal√£o de beleza.  Esses s√£o todos os tipos de aplicativos da web.  E SSR n√£o √© um pa√≠s :-).  Se voc√™ iniciar um aplicativo simplesmente abrindo a p√°gina inicial do index.html por meio de um navegador, ele n√£o funcionar√° como deveria; no melhor dos casos, obteremos uma vers√£o offline.  Adoro JavaScript e resolver√° o problema usando apenas os meios dispon√≠veis, por assim dizer, fora da caixa. </p><a name="habracut"></a><br><p>  Vamos come√ßar com o plano: </p><br><ol><li>  Se n√£o houver <a href="https://nodejs.org/dist/">NodeJS, fa√ßa o</a> download do LTS, instale, n√£o altere as configura√ß√µes, clique em Avan√ßar </li><li>  Em nosso local isolado, onde todos os projetos s√£o coletados, crie a pasta <strong>simple-web-server</strong> </li><li>  Na pasta do projeto, execute o comando npm init --yes // sem --yes, o inicializador far√° muitas perguntas </li><li>  No arquivo <strong>package.json</strong> na se√ß√£o de <strong>scripts</strong> , adicione a propriedade e seu valor - <strong>"main": "index.js"</strong> - para que possamos iniciar rapidamente nosso servidor usando o comando npm run </li><li>  Criar uma pasta <strong>lib</strong> √â recomend√°vel colocar todo o seu c√≥digo nele, o que n√£o requer montagem e etapas adicionais para sua opera√ß√£o </li><li>  Crie um arquivo <strong>index.js</strong> na pasta <strong>lib.Este</strong> √© o nosso futuro servidor. </li><li>  Criar uma pasta <strong>dist</strong> - esta ser√° a pasta na qual haver√° arquivos acess√≠veis ao p√∫blico, incluindo index.html, ou seja, a est√°tica que o servidor distribuir√° </li><li>  Abra o arquivo /index.js </li><li>  Escreva algum c√≥digo </li></ol><br><p>  Ent√£o, o que sabemos sobre o que nosso servidor deve fazer? </p><br><ol><li>  Manipular solicita√ß√µes </li><li>  Ler arquivos </li><li>  Responder √† solicita√ß√£o com o conte√∫do do arquivo </li></ol><br><p>  Primeiro, crie nosso servidor, importe-o para o arquivo <strong>idex.js</strong> </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {createServer} = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>);</code> </pre> <br><p>  Esta instru√ß√£o destr√≥i o objeto do m√≥dulo <a href="http.html"><strong>http</strong></a> e atribui uma express√£o, a fun√ß√£o <a href="http_createserver.asp"><strong>createServer</strong></a> , ao identificador de vari√°vel <a href="http_createserver.asp"><strong>createServer</strong></a> . </p><br><p>  Crie um novo servidor usando a seguinte instru√ß√£o </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = createServer();</code> </pre> <br><p>  Quando voc√™ primeiro acessa o host do servidor, o navegador envia uma solicita√ß√£o para receber o documento.  Portanto, para processar este evento, precisamos ouvir essas solicita√ß√µes.  O servidor que criamos tem um m√©todo <strong>listen</strong> , como par√¢metro, passamos o n√∫mero da porta 3000. </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eventsEmitter = server.listen(<span class="hljs-number"><span class="hljs-number">3000</span></span>);</code> </pre> <br><p>  A express√£o desse m√©todo ser√° um objeto <a href="https://nodejs.org/api/events.html"><strong>EventEmitter</strong></a> que ser√° armazenado em uma vari√°vel com o identificador <strong>eventsEmitter</strong> .  Este objeto √© observ√°vel.  Assinamos seus eventos usando a chamada do m√©todo <a href="https://nodejs.org/api/events.html"><strong>on / addEventListener</strong></a> com dois par√¢metros de <strong>fun√ß√£o de</strong> <strong>string</strong> necess√°rios.  O primeiro par√¢metro indica quais eventos nos interessam; <a href="&amp;xid=17259,15700002,15700019,15700186,15700191,15700259,15700271,15700302&amp;usg=ALkJrhgjLDIie5jxJFTPdrfNqBXjbtuz5Q#"><strong>solicitar o</strong></a> segundo √© uma fun√ß√£o que processar√° esse evento. </p><br><pre> <code class="javascript hljs"> eventsEmitter.on(<span class="hljs-string"><span class="hljs-string">'request'</span></span>, (req, res) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">debugger</span></span>; });</code> </pre> <br><p>  Abra o <a href="http://localhost:3000/">link</a> no navegador </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ad7/533/9ab/ad75339aba986a5e052325240422696c.png" alt="imagem"></p><br><p>  Ent√£o, decidimos pelas instru√ß√µes do depurador.  Vemos que, como par√¢metros, obtemos dois objetos <a href="&amp;xid=17259,15700002,15700019,15700186,15700191,15700259,15700271,15700302&amp;usg=ALkJrhgjLDIie5jxJFTPdrfNqBXjbtuz5Q#http_class_"><strong>req</strong></a> , <a href="&amp;xid=17259,15700002,15700019,15700186,15700191,15700259,15700271,15700302&amp;usg=ALkJrhgjLDIie5jxJFTPdrfNqBXjbtuz5Q#http_class_"><strong>res.Estes</strong></a> objetos s√£o inst√¢ncias de objetos do tipo <a href="https://nodejs.org/api/stream.html">fluxo,</a> portanto <a href="https://nodejs.org/api/stream.html">,</a> <a href="https://nodejs.org/api/stream.html"><strong>req</strong></a> √© o fluxo de leitura e <a href="https://nodejs.org/api/stream.html"><strong>res</strong></a> √© o fluxo de grava√ß√£o. </p><br><p>  Processamos a solicita√ß√£o e podemos dizer que "o problema est√° no chap√©u".  Tudo o que resta √© ler e devolver o arquivo.  Primeiro, voc√™ precisa entender que tipo de arquivo precisamos.  No depurador, tendo estudado todas as propriedades do par√¢metro <strong>req</strong> , vi que ele possui a propriedade <strong>url</strong> .  Mas apenas n√£o h√° nada como <strong>index.html nele</strong> . </p><br><p>  Vamos olhar novamente para o nosso navegador: vemos que n√£o indicamos isso explicitamente.  Vamos tentar novamente, mas j√° especificaremos explicitamente <a href="http://localhost:3000/index.html">index.html</a> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b98/ff2/fb4/b98ff2fb48f53fd0e89b94103a2802b7.png" alt="imagem"></p><br><p>  Agora est√° claro que o nome do arquivo vem na solicita√ß√£o na propriedade <strong>url</strong> e nada al√©m disso, n√£o precisamos ler o arquivo da solicita√ß√£o.  N√≥s a decompomos usando um par de chaves, especificamos o nome da propriedade <strong>url</strong> e, atrav√©s do operador <strong>:,</strong> definimos um nome arbitr√°rio usando um identificador de vari√°vel v√°lido, no meu caso <strong>requestUrl</strong> . </p><br><pre> <code class="javascript hljs"> eventsEmitter.addListener(<span class="hljs-string"><span class="hljs-string">'request'</span></span>, ({<span class="hljs-attr"><span class="hljs-attr">url</span></span>: requestUrl}, res) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">debugger</span></span> });</code> </pre> <br><p>  √ìtimo, o que vem a seguir?  Na verdade, eu realmente n√£o gosto do fato de que index.html sempre precisar√° ser especificado explicitamente, ent√£o vamos resolver esse problema imediatamente.  Decidi que a maneira mais f√°cil de fazer isso √© usar a fun√ß√£o <a href="https://nodejs.org/api/path.html"><strong>extname</strong></a> padr√£o <a href="https://nodejs.org/api/path.html"><strong>;</strong></a> ela est√° inclu√≠da no pacote padr√£o <br>  NodeJS do m√≥dulo <a href="https://nodejs.org/api/path.html"><strong>path</strong></a> , n√≥s o importamos usando a seguinte instru√ß√£o. </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {extname} = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>);</code> </pre> <br><p>  Agora voc√™ pode cham√°-lo passando a express√£o identificadora requestUrl como um par√¢metro e obter a express√£o para a sequ√™ncia do formato aproximado <code>'.extension'</code> .  Se a solicita√ß√£o n√£o especificar explicitamente um arquivo, uma string vazia ser√° retornada.  Usando esse princ√≠pio, adicionaremos o valor padr√£o de <strong>'index.html'</strong> .  Escrevemos a seguinte instru√ß√£o </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = extname(requestUrl) === <span class="hljs-string"><span class="hljs-string">''</span></span> ? DEFAULT_FILE_NAME : requestUrl;</code> </pre> <br><p>  Estou certo de que o usu√°rio do servidor desejar√° substituir esse nome e tamb√©m configurar uma vari√°vel de ambiente usando a seguinte instru√ß√£o </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {<span class="hljs-attr"><span class="hljs-attr">env</span></span>: {DEFAULT_FILE_NAME = <span class="hljs-string"><span class="hljs-string">'/index.html'</span></span>}} = process;<span class="hljs-string"><span class="hljs-string">`</span></span></code> </pre> <br><p>  No <a href="https://nodejs.org/api/process.html"><strong>processo de</strong></a> vari√°vel global <a href="https://nodejs.org/api/process.html"><strong>, h√°</strong></a> muitas informa√ß√µes √∫teis, apenas enterrarei parte delas, em particular, a propriedade <a href="https://nodejs.org/api/process.html"><strong>env</strong></a> que cont√©m todas as propriedades do ambiente do usu√°rio e j√° procuraremos por <strong>DEFAULT_FILE_NAME</strong> se o usu√°rio n√£o especificar - usamos index.html por padr√£o. </p><br><blockquote>  IMPORTANTE: se o valor da propriedade de ambiente DEFAULT_FILE_NAME n√£o for definido, a atribui√ß√£o de um valor padr√£o n√£o funcionar√°.  Vale lembrar, mas agora n√£o, estamos fazendo tudo ao m√≠nimo :-) </blockquote><p><img src="https://habrastorage.org/getpro/habr/post_images/0db/3cf/e97/0db3cfe97b528ef15c02994bad3781f3.png" alt="imagem"></p><br><p>  Agora que temos um link relativo para o arquivo, precisamos obter o caminho absoluto para o arquivo no sistema de arquivos do nosso servidor.  Decidimos que todos os arquivos p√∫blicos ser√£o armazenados na pasta <strong>dist</strong> . Portanto, para obter o <strong>caminho absoluto para o arquivo</strong> , usaremos outra fun√ß√£o de <a href="https://nodejs.org/api/path.html"><strong>resolu√ß√£o</strong></a> do m√≥dulo que j√° conhecemos <br>  <a href="https://nodejs.org/api/path.html"><strong>caminho</strong></a> simplesmente indique-o na instru√ß√£o criada anteriormente na linha 5 </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {resolve, extname} = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>);</code> </pre> <br><p>  Em seguida, na linha 10, escrevemos uma instru√ß√£o que receber√° e salvar√° o <strong>caminho absoluto da</strong> vari√°vel <strong>filePath.Eu</strong> tamb√©m disse que o nome dessa pasta pode ser redefinido para maior flexibilidade.  Portanto, expanda a instru√ß√£o na linha 6, adicionando o nome <br>  vari√°vel de ambiente <strong>DIST_FOLDER</strong> ! </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/128/919/e1f/128919e1ffb4aed7911e31764414ee4b.png" alt="imagem"></p><br><p>  Agora tudo est√° pronto para ler o arquivo.  Voc√™ pode ler um arquivo de maneiras diferentes de maneira ass√≠ncrona, s√≠ncrona ou usar <a href="https://nodejs.org/api/stream.html">fluxos</a> .  Vou usar fluxos :-) √© bonito e mais eficaz, do ponto de vista dos recursos gastos.  Primeiro, crie um arquivo de teste na pasta <strong>dist</strong> para que haja algo para ler :-) </p><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Title<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> TESTING 1,2,3... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Agora precisamos de uma fun√ß√£o que crie um fluxo de leitura de arquivo, que tamb√©m esteja inclu√≠do na distribui√ß√£o padr√£o do NodeJS e que a extraia do m√≥dulo <a href="https://nodejs.org/api/fs.html"><strong>fs</strong></a> usando a seguinte instru√ß√£o </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {createReadStream} = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>);</code> </pre> <br><p>  e na linha 12 no corpo do processador de solicita√ß√µes, usamos a seguinte declara√ß√£o </p><br><pre> <code class="javascript hljs"> createReadStream(filePath)</code> </pre> <br><p>  como resultado, a inst√¢ncia do objeto de fluxo de leitura ser√° retornada usando-o <br>  podemos mudar os fluxos de leitura para o fluxo de grava√ß√£o, tamb√©m podemos transformar os fluxos e muitas outras coisas √∫teis.  Ent√£o o par√¢metro <strong>res</strong> √© um fluxo de leitura, certo? </p><br><p>  Vamos tentar mudar imediatamente o fluxo de leitura de arquivo que criamos para o fluxo de grava√ß√£o <strong>res</strong> para <br>  disso, na linha 12, continuamos a instru√ß√£o chamando o m√©todo <strong>pipe</strong> e, como par√¢metro, passamos nosso <strong>res de</strong> fluxo de grava√ß√£o </p><br><pre> <code class="javascript hljs"> createReadStream(filePath).pipe(res);</code> </pre> <br><p><img src="https://habrastorage.org/getpro/habr/post_images/412/712/851/412712851c4ce2bcc2bf4a2bcb36ef86.png" alt="imagem"></p><br><p>  Isso √© tudo?  N√£√£√£o.  E quem ir√° lidar com os erros?  Que tipo de erros?  Vamos tentar fazer upload do arquivo css para o arquivo index.html, mas n√£o o criaremos e veremos o que acontece :-) </p><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Title<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"index1.css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> TESTING 1,2,3... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p><img src="https://habrastorage.org/getpro/habr/post_images/487/052/185/487052185b1c4adc32a05f658c7dafb6.jpg" alt="imagem"></p><br><p>  Esperado, mas o servidor travou!  Este n√£o √© o caso.  O fato √© que, por padr√£o, os erros n√£o s√£o capturados nos fluxos e voc√™ precisa fazer isso voc√™ mesmo :-) <strong>createReadStream</strong> retorna o fluxo no qual o erro ocorre.  Portanto, adicionamos um manipulador de erros.  Utilizando a Chamada para o M√©todo <strong>On</strong> . Especificando o Nome do Evento de <strong>Erro</strong> e o Manipulador de uma Fun√ß√£o.  Ele encerrar√° o fluxo de leitura e leitura com um c√≥digo de resposta 404. </p><br><pre> <code class="javascript hljs"> createReadStream(filePath) .on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, error =&gt; res.writeHead(<span class="hljs-number"><span class="hljs-number">404</span></span>).end()) .pipe(res);</code> </pre> <br><p>  verifique! </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/747/29e/584/74729e584b652a032a34c5a82d754a2d.jpg" alt="imagem"></p><br><p>  Outra coisa.  A prop√≥sito, o servidor ainda n√£o est√° pronto e, se tentarmos abri-lo em outro navegador, a p√°gina n√£o funcionar√° corretamente :-) quem a adivinhou, escreva nos coment√°rios, o que esquecemos de fazer?  O fato √© que, quando um servidor responde √† solicita√ß√£o de um servidor com um arquivo, uma extens√£o n√£o √© suficiente para o navegador entender de que tipo esse arquivo e outros navegadores s√£o: nem o Chrome nem as vers√µes mais antigas funcionar√£o com arquivos baixados sem especificar o cabe√ßalho de resposta Tipo de Conte√∫do. Para processar o arquivo, entre outras coisas, nosso servidor deve especificar o <a href="https://developer.mozilla.org/ru/docs/Web/HTTP/Basics_of_HTTP/MIME_types">tipo MIME.</a> Para isso, criaremos uma vari√°vel separada com todos os tipos comuns de maio.  Tamb√©m oferecemos a oportunidade de expandi-los passando como uma vari√°vel de ambiente </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {<span class="hljs-attr"><span class="hljs-attr">env</span></span>: {DEFAULT_FILE_NAME = <span class="hljs-string"><span class="hljs-string">'/index.html'</span></span>, DIST_FOLDER = <span class="hljs-string"><span class="hljs-string">'dist'</span></span>, DEFAULT_MIME_TYPES = <span class="hljs-string"><span class="hljs-string">'{}'</span></span>}} = process; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {text} = mimeTypes = { <span class="hljs-string"><span class="hljs-string">'html'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>, <span class="hljs-string"><span class="hljs-string">'jpeg'</span></span>: <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>, <span class="hljs-string"><span class="hljs-string">'jpg'</span></span>: <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>, <span class="hljs-string"><span class="hljs-string">'png'</span></span>: <span class="hljs-string"><span class="hljs-string">'image/png'</span></span>, <span class="hljs-string"><span class="hljs-string">'js'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/javascript'</span></span>, <span class="hljs-string"><span class="hljs-string">'css'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/css'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>: <span class="hljs-string"><span class="hljs-string">'plain/text'</span></span>, <span class="hljs-string"><span class="hljs-string">'json'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, ...JSON.parse(DEFAULT_MIME_TYPES) };</code> </pre> <br><p>  Bem, agora voc√™ precisa especificar de alguma forma o tipo MIME antes de alternar o fluxo de leitura para o fluxo de grava√ß√£o.  Eu usei os nomes de extens√£o de arquivo como chaves, ent√£o obteremos a extens√£o com a familiar fun√ß√£o <strong>extname</strong> </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fileExtension = extname(url).split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>).pop();</code> </pre> <br><p>  e com a ajuda do manipulador de eventos de <strong>pipe</strong> , definimos o tipo MIME desejado </p><br><pre> <code class="plaintext hljs">res.on('pipe', () =&gt; res.setHeader(contentType, mimeTypes[fileExtension] || text));</code> </pre> <br><p>  Verifique </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b9e/bad/f34/b9ebadf34d25b2fa8991387d880bc331.jpg" alt="imagem"></p><br><p>  Isso √© tudo - o servidor est√° pronto.  √â claro que n√£o √© perfeito, mas para come√ßar rapidamente, √© isso.  Se voc√™ estiver interessado em desenvolver essa ideia, escreva nos coment√°rios :-) </p><br><p>  <a href="http-server">C√≥digo completo do projeto</a> </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/5YhIxvbMLp8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/TssbLe5I2Ec" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481898/">https://habr.com/ru/post/pt481898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481886/index.html">Como criar rapidamente um di√°rio de presen√ßa</a></li>
<li><a href="../pt481890/index.html">Importa√ß√£o de caudas de ur√¢nio alem√£o na R√∫ssia. Parte 2. Enriquecimento</a></li>
<li><a href="../pt481892/index.html">Qubits em vez de bits: que futuro os computadores qu√¢nticos t√™m para n√≥s?</a></li>
<li><a href="../pt481894/index.html">Como a start-up de biotecnologia russa ajuda a combater o c√¢ncer</a></li>
<li><a href="../pt481896/index.html">PHP Vs ASP.NET: Como escolher o caminho certo?</a></li>
<li><a href="../pt481902/index.html">Modelagem da opera√ß√£o de uma usina termel√©trica real para otimizar os modos: vapor e matem√°tica</a></li>
<li><a href="../pt481904/index.html">Vladimir Marshinin, tamb√©m conhecido como mavl: ‚ÄúA chamada‚Äú N√£o copie outros cart√µes ‚Äùpermite evitar problemas de licen√ßa do OpenStreetMap‚Äù</a></li>
<li><a href="../pt481906/index.html">C√©rebro chin√™s, ou em defesa da primavera</a></li>
<li><a href="../pt481910/index.html">Como escrever VerticalSwipeBehavior flex√≠vel</a></li>
<li><a href="../pt481912/index.html">Durante uma semana eu era estagi√°rio na SRE-engenheiro. Assista atrav√©s dos olhos de um engenheiro de software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>