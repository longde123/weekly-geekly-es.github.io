<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õÑÔ∏è ü§π üóìÔ∏è Comment pr√©voir la demande et automatiser les achats √† l'aide de l'apprentissage automatique: cas Ozon üë®‚Äçüë©‚Äçüëß‚Äçüëß ‚öîÔ∏è üìö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La boutique en ligne Ozon a √† peu pr√®s tout: r√©frig√©rateurs, aliments pour b√©b√©s, ordinateurs portables pour 100 000, etc. Cela signifie que tout cela...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment pr√©voir la demande et automatiser les achats √† l'aide de l'apprentissage automatique: cas Ozon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ozontech/blog/431950/"><img src="https://habrastorage.org/webt/rl/bh/0z/rlbh0zbeah9dcpem3uio1wdstxs.png" alt="image"><br>  La boutique en ligne Ozon a √† peu pr√®s tout: r√©frig√©rateurs, aliments pour b√©b√©s, ordinateurs portables pour 100 000, etc.  Cela signifie que tout cela se trouve √©galement dans les entrep√¥ts de l'entreprise - et plus les marchandises sont longues, plus l'entreprise co√ªte cher.  Pour savoir combien et ce que les gens voudraient commander, et Ozon devrait acheter, nous avons utilis√© l'apprentissage automatique. <br><a name="habracut"></a><br><h3>  Pr√©visions de ventes: d√©fis </h3><br>  Avant de plonger dans l'√©nonc√© du probl√®me, nous commen√ßons par un exemple.  Il s'agit d'un v√©ritable calendrier de vente Ozon pendant un certain temps.  Question: o√π ira-t-il ensuite? <br><br><img src="https://habrastorage.org/webt/jl/nk/1j/jlnk1jejwxtqka-skph4hjccxno.png" alt="image"><br><br>  Une personne ayant une formation quasi technique pour une telle formulation du probl√®me aura des questions: O√π sont les axes?  Et quel genre de produit?  Et dans quelles unit√©s?  De quel institut avez-vous obtenu votre dipl√¥me?  - et bien d'autres non inclus dans cet article pour des raisons √©thiques. <br><br>  En fait, personne ne peut r√©pondre correctement √† la question dans une telle d√©claration, et si quelqu'un le peut, il est fort probable qu'il se trompera. <br><br>  Ajoutez plus d'informations √† ce graphique: axes et changements de prix sur le site web d'Ozon (bleu) et le site du concurrent (orange). <br><br><img src="https://habrastorage.org/webt/n1/m8/ap/n1m8apunf5mos5bid2xs4qsq1ka.png" alt="image"><br><br>  Notre prix a chut√© √† un moment donn√©, mais la concurrence est rest√©e la m√™me - et les ventes d'Ozon ont augment√©.  Nous connaissons les plans tarifaires: notre prix restera au m√™me niveau, mais le concurrent, apr√®s Ozon, a baiss√© le prix √† presque le n√¥tre. <br><br>  Ces donn√©es sont suffisantes pour faire une hypoth√®se significative - par exemple, que les ventes reviendront au niveau pr√©c√©dent.  Et si vous regardez le tableau, il s'av√®re que ce sera le cas. <br><br><img src="https://habrastorage.org/webt/rk/mb/aw/rkmbawctxwb2hf4lhs7l025c9y4.png" alt="image"><br><br>  Le probl√®me est qu'en fait, la demande pour ce produit n'est pas tellement affect√©e par le prix, et la croissance des ventes a √©t√© caus√©e, entre autres, par l'absence de la plupart des concurrents de ce produit dans notre magasin.  Il y a encore de nombreux facteurs que nous n'avons pas pris en compte: les marchandises ont-elles √©t√© annonc√©es √† la t√©l√©vision?  ou peut-√™tre que ce sont des bonbons, et bient√¥t le 8 mars? <br><br>  Une chose est claire: faire des pr√©visions "√† genoux" ne fonctionnera pas.  Nous avons suivi le chemin standard d'un <s>r√¢teau et de b√©quilles pour</s> construire n'importe quel algorithme ML.  Et c'est comme √ßa. <br><br><h3>  S√©lection m√©trique </h3><br>  Le choix d'une m√©trique est par o√π commencer si au moins une autre personne que vous utilisera vos pr√©visions. <br><br>  Prenons un exemple: nous avons trois options de pr√©vision.  Quel est le meilleur? <br><img src="https://habrastorage.org/webt/ix/zg/gp/ixzggpclvbgaqpmkzaeehzhamb0.png" alt="image"><br>  Du point de vue des sp√©cialistes de l'entrep√¥t, nous avons besoin d'une pr√©vision bleue - nous ach√®terons un peu moins, et nous manquerons le pic de la mi-octobre, mais rien ne restera dans l'entrep√¥t.  Les experts dont les KPI sont li√©s aux ventes sont d'un avis contraire: m√™me la pr√©vision turquoise n'est pas tout √† fait correcte, tous les sauts de demande ne se sont pas refl√©t√©s - allez la modifier.  Mais du point de vue d'une personne, de l'ext√©rieur, quelque chose de mieux est g√©n√©ralement en ordre - pour que tout le monde se sente bien ou vice versa. <br><br>  Par cons√©quent, avant de faire une pr√©vision, il est n√©cessaire de d√©terminer qui l'utilisera et pourquoi.  Autrement dit, choisissez une m√©trique et comprenez √† quoi vous attendre d'une pr√©vision bas√©e sur une telle m√©trique.  Et attendez juste √ßa. <br><br>  Nous avons choisi MAE - l'erreur absolue moyenne.  Cette m√©trique convient √† notre √©chantillon d'entra√Ænement tr√®s d√©s√©quilibr√©.  √âtant donn√© que l'assortiment est tr√®s large (1,5 million d'articles), chaque produit individuellement dans une r√©gion particuli√®re est vendu en petites quantit√©s.  Et si au total nous vendons des centaines de robes vertes, alors une robe verte particuli√®re avec des chats est vendue 2-3 fois par jour.  En cons√©quence, l'√©chantillon se d√©place vers de petites valeurs.  D'autre part, il y a des iPhones, des filateurs, un nouveau livre d'Olga Buzova (une blague), etc.  - et ils sont vendus dans n'importe quelle ville en grandes quantit√©s.  MAE vous permet de ne pas obtenir d'√©normes amendes sur les iPhones conditionnels et fonctionne g√©n√©ralement bien sur la majeure partie des marchandises. <br><br><h3>  Premiers pas </h3><br>  Nous avons commenc√© par construire la pr√©vision la plus stupide qui pourrait √™tre: un nombre al√©atoire de 0 √† 1000 sera vendu au cours de la semaine prochaine et obtiendra la m√©trique MAE = 496. Probablement, cela peut √™tre pire, mais c'est d√©j√† tr√®s mauvais.  Nous avons donc eu une directive: si nous obtenons une telle valeur m√©trique, alors √©videmment nous faisons quelque chose de mal. <br><br>  Ensuite, nous avons commenc√© √† jouer avec des gens qui savent faire des pr√©visions sans apprentissage automatique, et avons essay√© de pr√©dire les ventes de marchandises au cours de la semaine prochaine √©gales aux ventes moyennes de toutes les derni√®res semaines, et nous avons obtenu la m√©trique MAE = 1,45 - ce qui est beaucoup mieux. <br><br>  Toujours dans la m√™me logique, nous avons d√©cid√© que les ventes de la semaine derni√®re ne seraient pas plus pertinentes pour pr√©voir les ventes de la semaine prochaine.  Pour une telle pr√©vision, le MAE √©tait de 1,26.  Lors de la prochaine s√©rie de r√©flexions pronostiques, nous avons d√©cid√© de prendre en compte les deux facteurs et de pr√©dire les ventes de la semaine prochaine comme la somme de 50% des ventes moyennes et de 50% des ventes de la semaine derni√®re - nous avons obtenu MAE = 1,23. <br><br>  Mais cela nous a paru trop simple, et nous avons d√©cid√© de compliquer les choses.  Nous avons recueilli un petit √©chantillon de formation dans lequel les signes √©taient des ventes pass√©es et moyennes, et les cibles √©taient des ventes au cours de la semaine suivante, et nous avons form√© sur lui une r√©gression lin√©aire simple.  Nous avons obtenu des poids de 0,46 et 0,55 pour la moyenne et les derni√®res semaines et le MAE sur l'√©chantillon d'essai √©gal √† 1,2. <br>  Conclusion: nos donn√©es ont un potentiel pr√©dictif. <br><br><h3>  Ing√©nierie des fonctionnalit√©s </h3><br>  Apr√®s avoir d√©cid√© que la construction d'une pr√©vision sur deux bases n'est pas notre niveau, nous nous sommes assis pour g√©n√©rer de nouvelles fonctionnalit√©s complexes.  Il s'agit d'informations sur les ventes pass√©es - il y a 1, 2, 3, 4 semaines, une semaine il y a exactement un an, etc.  Et les vues des derni√®res semaines, les ajouts au panier, la conversion des vues et les ajouts au panier en commandes - et tout cela pour diff√©rentes p√©riodes. <br><br>  Nous devions fournir un mod√®le de connaissances sur la fa√ßon dont un produit dans son ensemble est vendu, comment la dynamique de ses ventes a chang√© r√©cemment, comment son int√©r√™t √©volue, comment ses ventes d√©pendent des prix et d'autres facteurs qui, √† notre avis, peuvent √™tre utiles. <br><br>  Lorsque nos id√©es se sont √©puis√©es, nous sommes all√©s voir les experts du service commercial.  L√†, par exemple, nous avons appris que l'ann√©e suivante est l'ann√©e du porc, par cons√©quent, les produits ressemblant au moins √† des porcs √† distance seront tr√®s populaires.  Ou, par exemple, que ¬´sans gel¬ª, nos gens n'ach√®tent pas √† l'avance, mais exactement le jour des premi√®res gel√©es - veuillez donc tenir compte des pr√©visions m√©t√©orologiques.  En g√©n√©ral, tout le monde √©tait satisfait.  Nous - parce que nous avons re√ßu un tas d'id√©es nouvelles auxquelles nous n'aurions jamais pens√©, nous et les hommes d'affaires - que bient√¥t il sera possible de faire quelque chose de plus int√©ressant que les pr√©visions de ventes. <br><br>  Mais c'est encore trop simple - et nous avons ajout√© des sympt√¥mes combin√©s: <br><br><ul><li>  conversion des vues en ventes - comment c'√©tait, comment √ßa a chang√©; </li><li>  le rapport des ventes sur 4 semaines aux ventes de la semaine derni√®re (si ce chiffre est tr√®s diff√©rent de 4, la demande de ce produit est actuellement soumise √† des "turbulences"); </li><li>  le rapport des ventes de produits aux ventes dans toute la cat√©gorie - si ce chiffre est proche de un, alors le produit est un ¬´monopole¬ª. </li></ul><br>  √Ä ce stade, vous devez trouver autant que possible - jetez les panneaux non informatifs au stade de la formation. <br><br>  En cons√©quence, nous avons obtenu 170 signes.  Pour l‚Äôavenir, la plus grande importance <br><br><ul><li>  Ventes de la semaine derni√®re (pour deux, trois et quatre). </li><li>  La disponibilit√© du produit la semaine derni√®re est le pourcentage de temps pendant lequel le produit √©tait pr√©sent sur le site. </li><li>  Le coefficient angulaire du calendrier des ventes de marchandises pour les 7 derniers jours. </li><li>  Le rapport du prix pass√© √† l'avenir - avec une remise √©norme, commencez √† acheter des marchandises plus activement. </li><li>  Le nombre de concurrents directs sur notre site.  Si, par exemple, ce stylo est le seul de sa cat√©gorie, les ventes seront plut√¥t stationnaires. </li><li>  Dimensions du produit - il s'est av√©r√© que la longueur et la largeur affectent consid√©rablement la pr√©visibilit√© des ventes.  Pour une raison quelconque, pour les objets longs et √©troits - parapluies ou cannes √† p√™che, par exemple - le calendrier est beaucoup plus volatil.  Nous ne savons pas encore comment l'expliquer. </li><li>  Num√©ro de jour de l'ann√©e - il indique si la nouvelle ann√©e arrive, le 8 mars, le d√©but d'une augmentation saisonni√®re des ventes, etc. </li></ul><br><h3>  √âchantillonnage </h3><br>  L'√©chantillon d'entra√Ænement est la douleur.  Nous l'avons recueilli pendant environ 4 semaines, dont deux sont simplement all√©s √† diff√©rents d√©positaires de donn√©es et ont demand√© √† voir ce qu'ils avaient.  Cela se produit chaque fois que vous avez besoin de donn√©es pendant une longue p√©riode.  M√™me dans un syst√®me de collecte de donn√©es id√©al, pendant longtemps, quelque chose se passera dans l'esprit de ¬´nous avions l'habitude de penser cette chose comme √ßa, mais ensuite nous avons commenc√© √† penser diff√©remment et √† √©crire les donn√©es dans la m√™me colonne¬ª.  Il y a un an ou deux, le serveur est tomb√© en panne, mais personne n'a not√© exactement quand - et les z√©ros ne signifient plus qu'il n'y a eu aucune vente. <br><br>  En cons√©quence, nous avons eu des informations sur ce que les gens ont fait sur le site, quoi et en quelles quantit√©s, ils ont √©t√© ajout√©s aux favoris et √† un panier, et achet√©s.  Nous avons collect√© un √©chantillon d'environ 15 millions d'√©chantillons de 170 fonctionnalit√©s chacun, l'objectif √©tait le nombre de ventes pour la semaine prochaine. <br><br>  Nous avons √©crit 2 000 lignes de code sur Spark.  Cela a fonctionn√© lentement, mais a permis de m√¢cher d'√©normes quantit√©s de donn√©es.  Il semble simplement que le calcul de la pente d'une ligne droite soit simple.  Et pour le faire 10kk fois lorsque les ventes sont tir√©es de plusieurs bases - la t√¢che n'est pas pour les faibles de c≈ìur. <br><br>  Pendant une autre semaine, nous avons √©t√© engag√©s dans le nettoyage des donn√©es afin que le mod√®le ne soit pas distrait par les √©missions et les caract√©ristiques d'√©chantillonnage local, mais extrait uniquement les v√©ritables d√©pendances inh√©rentes aux ventes d'Ozon.  Voici 3 sigma et des m√©thodes plus astucieuses pour rechercher des anomalies.  Le cas le plus difficile est de r√©tablir les ventes pendant les p√©riodes de manque de marchandises en stock.  La solution la plus simple est de jeter les semaines o√π le produit √©tait sorti pendant la semaine ¬´cibl√©e¬ª. <br><br><img src="https://habrastorage.org/webt/kk/li/_z/kkli_zozkhocyxgrkur-eocnq3g.png" alt="image"><br><br>  En cons√©quence, sur 15 millions d'√©chantillons, il en reste 10 millions. Il importe ici de ne pas se laisser emporter et de ne pas perdre l'int√©gralit√© de l'√©chantillon (en fait, le manque de marchandises dans l'entrep√¥t est une caract√©ristique indirecte de son importance pour l'entreprise; retirer ces marchandises de l'√©chantillon n'est pas la m√™me chose que jeter des √©chantillons al√©atoires ) <br><br><h3>  Temps ML </h3><br>  Sur un √©chantillon propre et a commenc√© √† former des mod√®les.  Naturellement, nous avons commenc√© par une r√©gression lin√©aire et avons obtenu MAE = 1,15.  Il semble que ce soit une tr√®s petite augmentation, mais lorsque vous avez un √©chantillon de 10 millions dans lequel les valeurs moyennes sont de 5 √† 10, m√™me un petit changement dans la valeur m√©trique donne une augmentation incommensurable de la qualit√© visuelle de la pr√©vision.  Et comme vous devrez √©ventuellement pr√©senter la solution aux clients professionnels, augmenter leur niveau de joie est un facteur important. <br><br>  Ensuite, sklearn.ensemble.RandomForestRegressor, qui apr√®s une courte s√©lection d'hyperparam√®tres a montr√© MAE = 1,10.  Ensuite, nous avons essay√© XGBoost (o√π sans lui) - tout irait bien et MAE = 1,03 - seulement tr√®s longtemps.  Malheureusement, nous n'avions pas acc√®s au GPU pour former XGBoost, et sur les processeurs un mod√®le a √©t√© form√© pendant tr√®s longtemps.  Nous avons essay√© de trouver quelque chose de plus rapide et nous nous sommes install√©s sur LightGBM - il s'est entra√Æn√© deux fois plus vite et a montr√© MAE encore un peu moins - 1.01. <br><br>  Nous avons divis√© tous les produits en 13 cat√©gories, comme dans le catalogue sur le site: tables, ordinateurs portables, bouteilles, et pour chaque cat√©gorie, nous avons form√© des mod√®les avec diff√©rentes profondeurs de pr√©vision - de 5 √† 16 jours. <br><br>  La formation a dur√© environ cinq jours, et pour cela, nous avons cr√©√© d'√©normes grappes informatiques.  Nous avons d√©velopp√© un tel pipeline: la recherche al√©atoire fonctionne depuis longtemps, donne les 10 premiers ensembles d'hyperparam√®tres, puis le scientifique travaille avec eux manuellement - construit des m√©triques de qualit√© suppl√©mentaires (nous avons calcul√© le MAE pour diff√©rentes plages de cibles), construit des courbes d'apprentissage (par exemple, nous avons jet√© une partie de la formation √©chantillons et form√©s √† nouveau, en v√©rifiant pour voir si les nouvelles donn√©es r√©duisent la perte sur l'√©chantillon de test) et d'autres graphiques. <br><br>  Un exemple d'analyse d√©taill√©e pour l'un des ensembles d'hyperparam√®tres: <br><br><div class="spoiler">  <b class="spoiler_title">M√©trique de qualit√© d√©taill√©e</b> <div class="spoiler_text"><table><tbody><tr><td><p>  Coffret de train: </p><br></td><td><p>  Ensemble de test: </p><br></td></tr><tr><td>  Pour cible = 0, MAE = 0,142222484602 </td><td>  Pour 0 MAE = 0,141900737761 </td></tr><tr><td>  Pour la cible&gt; 0, MAPE = 45.168530676 </td><td>  Pour&gt; 0 MAPE = 45.5771812826 </td></tr><tr><td>  Erreurs sup√©rieures √† 0 - 67,931341691% </td><td>  Erreurs sup√©rieures √† 0 - 51,6405939896% </td></tr><tr><td>  Erreurs sup√©rieures √† 1 - 19,0346986379% </td><td>  Erreurs sup√©rieures √† 1 - 12,1977096603% </td></tr><tr><td>  Erreurs sup√©rieures √† 2 - 8,94313926245% </td><td>  Erreurs sup√©rieures √† 2 - 5,16977226441% </td></tr><tr><td>  Erreurs sup√©rieures √† 3 - 5,42406856507% </td><td>  Erreurs sup√©rieures √† 3 - 3,12760834969% </td></tr><tr><td>  Erreurs sup√©rieures √† 4 - 3,667938161595% <br></td><td>  Erreurs sup√©rieures √† 4 - 2,10263125679% </td></tr><tr><td>  Erreurs sup√©rieures √† 5 - 2,67322988948% <br></td><td>  Erreurs sup√©rieures √† 5 - 1,56473158807% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 6 - 2,0618556701% <br></td><td>  Erreurs sup√©rieures √† 6 - 1,19599209102% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 7 - 1,65887701209% </td><td>  Erreurs sup√©rieures √† 7 - 0,949300173983% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 8 - 1,36821095777% <br></td><td>  Erreurs sup√©rieures √† 8 - 0,78310772461% </td></tr><tr><td>  Erreurs sup√©rieures √† 9 - 1,15368611519% </td><td>  Erreurs sup√©rieures √† 9 - 0,659205318158% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 10 - 0,99199395014% </td><td>  Erreurs sup√©rieures √† 10 - 0,554593106723% </td></tr><tr><td>  Erreurs sup√©rieures √† 11 - 0,863969667827% </td><td>  Erreurs sup√©rieures √† 11 - 0,490045146476% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 12 - 0,764347266082% <br></td><td>  Erreurs sup√©rieures √† 12 - 0,428835873827% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 13 - 0,68086818247% </td><td>  Erreurs sup√©rieures √† 13 - 0,386545830907% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 14 - 0,613446089087% </td><td>  Erreurs sup√©rieures √† 14 - 0,343884822697% <br></td></tr><tr><td>  Erreurs sup√©rieures √† 15 - 0,556297016335% <br></td><td>  Erreurs sup√©rieures √† 15 - 0,316433391328% <br></td></tr><tr><td>  Pour cible = 0, MAE = 0,142222484602 <br></td><td>  Pour cible = 0, MAE = 0,141900737761 <br></td></tr><tr><td>  Pour cible = 1, MAE = 0,63978556493 <br></td><td>  Pour cible = 1, MAE = 0,660823509405 </td></tr><tr><td>  Pour cible = 2, MAE = 1,01528075312 </td><td>  Pour cible = 2, MAE = 1.01098070566 </td></tr><tr><td>  Pour cible = 3, MAE = 1,43762342295 </td><td>  Pour cible = 3, MAE = 1,44836233499 </td></tr><tr><td>  Pour cible = 4, MAE = 1,82790678437 <br></td><td>  Pour cible = 4, MAE = 1,86539223382 <br></td></tr><tr><td>  Pour cible = 5, MAE = 2,15369976552 <br></td><td>  Pour cible = 5, MAE = 2.16017884573 </td></tr><tr><td>  Pour cible = 6, MAE = 2,51629758129 <br></td><td>  Pour cible = 6, MAE = 2,51987403661 <br></td></tr><tr><td>  Pour cible = 7, MAE = 2,80225497415 <br></td><td>  Pour cible = 7, MAE = 2,97580015564 <br></td></tr><tr><td>  Pour cible = 8, MAE = 3,09405048248 <br></td><td>  Pour cible = 8, MAE = 3,21914648525 <br></td></tr><tr><td>  Pour l'objectif = 9, MAE = 3,39256765159 <br></td><td>  Pour cible = 9, MAE = 3,54572928241 <br></td></tr><tr><td>  Pour objectif = 10, MAE = 3,6640339953 </td><td>  Pour cible = 10, MAE = 3,84409605282 <br></td></tr><tr><td>  Pour cible = 11, MAE = 4,02797747118 <br></td><td>  Pour cible = 11, MAE = 4,21828735273 <br></td></tr><tr><td>  Pour cible = 12, MAE = 4,17163467899 <br></td><td>  Pour cible = 12, MAE = 3,92536509115 <br></td></tr><tr><td>  Pour cible = 14, MAE = 4,78590364522 <br></td><td>  Pour cible = 14, MAE = 5.11290428675 </td></tr><tr><td>  Pour cible = 15, MAE = 4,89409916994 <br></td><td>  Pour cible = 15, MAE = 5.20892023117 <br></td></tr></tbody></table><br>  Perte de train = 0,535842111392 <br>  Perte d'essai = 0,895529959873 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Pr√©diction de graphique (cible) pour l'ensemble d'entra√Ænement</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3m/o6/ho/3mo6hoqfklfc69z55btog7e6q_w.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Pr√©diction graphique (cible) pour l'√©chantillon de test</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hq/q6/bm/hqq6bm7aqcbngqum8mgdyhjibna.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Erreur de pr√©diction de temps en temps</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/in/mu/be/inmubedyg9b6hzyttimdneuh5-s.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Trier l'erreur ascendante sur l'√©chantillon de test</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/74/h3/kt/74h3ktebx43a9mhmie6sgp5ua_i.png" alt="image"><br></div></div><br>  Si aucune ne correspond, effectuez une nouvelle recherche al√©atoire.  C'est ainsi que nous avons form√© le mod√®le pendant 5 ou 5 jours au rythme industriel.  Nous √©tions de service, quelqu'un la nuit, quelqu'un s'est r√©veill√© le matin, a regard√© les 10 principaux param√®tres, a red√©marr√© ou enregistr√© le mod√®le et s'est couch√© plus loin.  Dans ce mode, nous avons travaill√© pendant une semaine et form√© 130 mod√®les - 13 types de marchandises et 10 profondeurs de pr√©visions, chacune comptant 170 fonctionnalit√©s.  Le MAE moyen pour la s√©rie chronologique 5 fois cv est √©gal √† 1. <br><br>  Il peut sembler que ce n'est pas tr√®s cool - et c'est le cas, sauf si vous avez une grande partie dans la s√©lection des unit√©s.  Comme le montre une analyse des r√©sultats, les unit√©s sont pr√©dites le pire de toutes - le fait qu'un produit ait √©t√© achet√© une fois par semaine ne dit rien sur la demande.  Une fois que tout peut √™tre vendu - il y a une personne qui ach√®tera une figurine en porcelaine sous la forme d'un dentiste, et cela ne dit rien des ventes futures ou des ventes pass√©es.  En g√©n√©ral, nous ne nous sommes pas √©nerv√©s √† ce sujet. <br><br><h3>  Trucs et astuces </h3><br>  Qu'est-ce qui a mal tourn√© et comment √©viter cela? <br><br>  Le premier probl√®me est la s√©lection des param√®tres.  Nous avons commenc√© √† utiliser RandomizedSearchCV - un outil bien connu de sklearn pour trier les hyperparam√®tres.  C'est l√† que la premi√®re surprise nous attendait. <br><br><div class="spoiler">  <b class="spoiler_title">Comme √ßa</b> <div class="spoiler_text"><code>from sklearn.model_selection import ParameterSampler <br> from sklearn.model_selection import RandomizedSearchCV <br> <br> estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=72) <br> param_grid = {'boosting_type': boosting_type, 'num_leaves': num_leaves, 'max_depth': max_depth, 'learning_rate':learning_rate, 'n_estimators': n_estimators, 'subsample_for_bin': subsample_for_bin, 'min_child_samples': min_child_samples, 'colsample_bytree': colsample_bytree, 'reg_alpha': reg_alpha, 'max_bin': max_bin} <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=1, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  Le calcul se bloque simplement (ce qui est important, il ne tombe pas, mais continue de fonctionner, mais sur un nombre toujours plus petit de c≈ìurs et √† un moment donn√© il s'arr√™te juste). <br><br><div class="spoiler">  <b class="spoiler_title">J'ai d√ª parall√©liser le processus en raison de RandomizedSearchCV</b> <div class="spoiler_text"> <code>estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=1) <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=72, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  Mais RandomizedSearchCV r√©cup√®re la quasi-totalit√© de l'ensemble de donn√©es pour chaque ¬´travail¬ª.  Par cons√©quent, il est n√©cessaire d'augmenter consid√©rablement la quantit√© de RAM, sacrifiant √©ventuellement le nombre de c≈ìurs. <br><br>  Qui nous parlerait alors de choses aussi merveilleuses que l'hyperopt√©!  Depuis que nous avons appris, nous l'utilisons uniquement. <br><br>  Une autre astuce qui nous est venue √† l'esprit vers la fin du projet √©tait de choisir des mod√®les qui avaient le param√®tre colsample_bytree (c'est le param√®tre LightGBM, qui dit quel pourcentage de fonctionnalit√©s donner √† chaque lerner) dans la r√©gion de 0,2-0,3, car lorsque la voiture Cela fonctionne en production, il peut ne pas y avoir de tables et les fonctionnalit√©s individuelles peuvent ne pas √™tre compt√©es correctement.  Une telle r√©gularisation vous permet de vous assurer que ces fonctionnalit√©s non comptabilis√©es affectent au moins pas tous les lerners du mod√®le. <br>  Sur le plan empirique, nous sommes arriv√©s √† la conclusion que nous devons faire plus d'estimateurs et tordre la r√©gularisation plus durement.  Ce n'est pas une r√®gle de travail avec LightGBM, mais un tel sch√©ma a fonctionn√© pour nous. <br><br>  Et bien s√ªr, Spark.  Par exemple, il y a un bogue que Spark lui-m√™me conna√Æt: si vous prenez plusieurs colonnes d'une table et en cr√©ez une nouvelle, puis en prenez d'autres de la m√™me table et en cr√©ez une nouvelle, puis accordez les tables que vous recevez, tout se cassera, m√™me si cela ne devrait pas.  Vous ne pouvez √™tre sauv√© qu'en vous d√©barrassant de tous les calculs paresseux.  Nous avons m√™me √©crit une fonction sp√©ciale - bumb_df, elle transforme le Data Frame en RDD en Data Frame.  Autrement dit, il r√©initialise tous les calculs paresseux.  Cela peut vous prot√©ger de la plupart des probl√®mes Spark. <br><br><div class="spoiler">  <b class="spoiler_title">bumb_df</b> <div class="spoiler_text"> <code>def bump_df(df): <br> # to avoid problem: AnalysisException: resolved attribute(s) <br> df_rdd = df.rdd <br> if df_rdd.isEmpty(): <br> df = df_rdd.toDF(schema=df.schema) <br> return df <br> else: <br> return df_rdd.toDF(schema=df.schema) <br></code> <br></div></div><br><h3>  Les pr√©visions sont pr√™tes: combien commanderons-nous? </h3><br>  La pr√©vision des ventes est une t√¢che purement math√©matique, et si la distribution normale d'une erreur √† moyenne nulle est une victoire pour un math√©maticien, alors pour les commer√ßants qui comptent chaque rouble, cela est inacceptable. <br><br>  Si un iPhone suppl√©mentaire ou une robe √† la mode dans l'entrep√¥t n'est pas un probl√®me, mais plut√¥t un stock d'assurance, alors l'absence du m√™me iPhone dans l'entrep√¥t est une perte d'au moins la marge, et comme un maximum d'image, et cela ne peut pas √™tre autoris√©. <br><br>  Afin d'apprendre √† l'algorithme √† acheter autant que n√©cessaire, nous avons d√ª calculer le co√ªt de r√©achat et de sous-achat de chaque produit et former un mod√®le simple afin de minimiser les √©ventuelles pertes d'argent. <br><br>  Le mod√®le re√ßoit une pr√©vision des ventes √† l'entr√©e, y ajoute du bruit al√©atoire et normalement distribu√© (nous simulons les imperfections des fournisseurs) et apprend √† ajouter exactement autant aux pr√©visions pour chaque produit particulier afin de minimiser les pertes d'argent. <br><br>  Ainsi, une commande est un stock pr√©visionnel + s√©curit√©, qui garantit la couverture de l'erreur de pr√©vision et de l'imperfection du monde ext√©rieur. <br><br><h3>  Comme dans prod </h3><br>  Ozon poss√®de son propre cluster informatique assez important, sur lequel chaque nuit un pipeline (nous utilisons le flux d'air) de plus de 15 emplois est lanc√©.  Cela ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/cc/sq/gb/ccsqgbj2p2xztr9qlllahzgr_4c.png" alt="image"><br><br>  Chaque nuit, l'algorithme est lanc√©, tire environ 20 Go de donn√©es provenant de diverses sources dans les hdfs locaux, s√©lectionne un fournisseur pour chaque produit, collecte des fonctionnalit√©s pour chaque produit, √©tablit des pr√©visions de vente et g√©n√®re des commandes en fonction du calendrier de livraison.  √Ä 6 h √† 7 h, nous remettons √† la table des personnes charg√©es de travailler avec les fournisseurs des tables pr√™tes √† l'emploi qui s'envolent d'un simple clic vers les fournisseurs. <br><br><h3>  Pas une seule pr√©vision </h3><br>  Le mod√®le entra√Æn√© conna√Æt la d√©pendance des pr√©visions √† l'√©gard de n'importe quelle entit√© et, par cons√©quent, si vous gelez les panneaux N-1 et commencez √† en changer un, vous pouvez observer comment cela affecte les pr√©visions.  Bien s√ªr, la chose la plus int√©ressante √† ce sujet est de savoir comment les ventes d√©pendent du prix. <br><br>  Il est important de noter que la demande ne d√©pend pas seulement du prix.  Par exemple, si vous faites de petites remises sur des tra√Æneaux en √©t√©, cela ne les aide toujours pas √† vendre.  Nous faisons un rabais de plus et des gens apparaissent qui "pr√©parent un tra√Æneau en √©t√©".  Mais jusqu'√† un certain niveau de remises, nous ne pouvons toujours pas atteindre la partie du cerveau qui est responsable de la planification.  En hiver, il fonctionne comme pour tout produit - vous faites une remise et il se vend plus rapidement. <br><br><img src="https://habrastorage.org/webt/zp/by/jg/zpbyjgawjuxfa0pfm3rrp0sb4f0.png" alt="image"><br><br><h3>  Plans </h3><br>  Maintenant, nous √©tudions activement le regroupement des s√©ries chronologiques afin de r√©partir les marchandises entre les grappes en fonction de la nature de la courbe qui d√©crit leurs ventes.  Par exemple, saisonni√®re, traditionnellement populaire en √©t√© ou, inversement, en hiver.  Lorsque nous apprendrons √† s√©parer les produits ayant un long historique de vente, nous pr√©voyons de mettre en √©vidence des fonctionnalit√©s bas√©es sur les articles qui vous diront quel sera le mod√®le de vente d'un nouveau produit qui vient d'appara√Ætre - pour l'instant, c'est notre t√¢che principale. <br><br>  Les r√©seaux de neurones et les mod√®les param√©triques de s√©ries chronologiques, et tout cela dans l'ensemble, iront s√ªrement plus loin. <br><br>  En particulier, gr√¢ce au nouveau syst√®me de pr√©vision, Ozon est pass√© de l'achat de marchandises en stock √† des livraisons cycliques, lorsque nous achetons d'une offre √† une autre et ne stockons pas de soldes en stock. <br><br>  Nous devons maintenant d√©cider comment enseigner l'algorithme pour pr√©dire les ventes de nouveaux produits et de cat√©gories enti√®res.  L'ann√©e prochaine, la soci√©t√© pr√©voit d'augmenter ses ventes x10 dans les cat√©gories et x2,5 dans les domaines de r√©alisation.  Et nous devons dire aux mod√®les que ces anciennes donn√©es sont pertinentes, mais pour un magasin diff√©rent et pass√©.  Et pendant que nous r√©fl√©chissons √† comment le faire. <br><br>  La deuxi√®me chose par nature irrationnelle que nous devons apprendre √† pr√©voir est la mode.  Comment pouvait-on pr√©dire qu'un spinner se vendrait comme √ßa?  Comment pr√©dire les ventes de nouveaux livres de Dan Brown si l'un de ses livres est √©puis√© et l'autre non?  Pendant que nous y travaillons. <br><br>  Si vous savez faire mieux ou si vous avez des histoires sur l'utilisation de l'apprentissage automatique dans la bataille dans les commentaires, nous en discuterons. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431950/">https://habr.com/ru/post/fr431950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431940/index.html">Les gens s'√©puisent s'ils ne sentent pas leur valeur. Que faire √† ce sujet?</a></li>
<li><a href="../fr431942/index.html">Injection de d√©pendance hi√©rarchique dans React et MobX State Tree en tant que mod√®le de domaine</a></li>
<li><a href="../fr431944/index.html">Yealink Meeting Server 2.0 - Nouvelles fonctionnalit√©s de vid√©oconf√©rence</a></li>
<li><a href="../fr431946/index.html">Semaine de la s√©curit√© 49: piratage de Dell et Marriott</a></li>
<li><a href="../fr431948/index.html">Deep Mind a appris √† son IA √† pr√©dire la structure des prot√©ines</a></li>
<li><a href="../fr431954/index.html">L'ancien vice-pr√©sident de Sun et DEC devient pr√©sident de MIPS / Wave, parle de la Russie et de RISC / V</a></li>
<li><a href="../fr431956/index.html">Logique, explicabilit√© et compr√©hension future</a></li>
<li><a href="../fr431958/index.html">La centrale √©lectrique √† batterie virtuelle de Tesla s'√©tend √† 1 000 foyers australiens</a></li>
<li><a href="../fr431960/index.html">Nvidia devient fou et ouvre PhysX sous BSD-3</a></li>
<li><a href="../fr431964/index.html">Fusionner les tris</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>