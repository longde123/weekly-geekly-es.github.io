<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘 🔪 📃 Megapack: comment les développeurs de Factorio ont réussi à résoudre le problème avec le mode multijoueur à 200 joueurs 🏂🏻 🧦 👝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En mai de cette année, j'ai participé en tant que joueur à l' événement MMO KatherineOfSky . J'ai remarqué que lorsque le nombre de joueurs atteint un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Megapack: comment les développeurs de Factorio ont réussi à résoudre le problème avec le mode multijoueur à 200 joueurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466135/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/35a/156/0b735a15617cf15740ddb733b0cff066.jpg" alt="image"></div><br>  En mai de cette année, j'ai participé en tant que joueur à l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">événement MMO KatherineOfSky</a> .  J'ai remarqué que lorsque le nombre de joueurs atteint un certain nombre, toutes les quelques minutes, certains «tombent».  Heureusement pour vous (mais pas pour moi), je faisais partie de ces joueurs qui se déconnectaient à <b>chaque fois</b> , même avec une bonne connexion.  J'ai pris cela comme un défi personnel et j'ai commencé à chercher les causes du problème.  Après trois semaines de débogage, de test et de correction, l'erreur a finalement été corrigée, mais ce voyage n'a pas été aussi simple. <br><br>  Les problèmes des jeux multijoueurs sont très difficiles à repérer.  Habituellement, ils surviennent dans des conditions très spécifiques de paramètres de réseau et dans des conditions très spécifiques du jeu (dans ce cas, la présence de plus de 200 joueurs).  Et même lorsqu'il est possible de reproduire le problème, il ne peut pas être correctement débogué, car l'insertion de points de contrôle arrête le jeu, perturbe les temporisateurs et conduit généralement à la fin de la connexion en raison du dépassement du temps d'attente.  Mais grâce à l'entêtement et au merveilleux outil appelé <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">maladroit,</a> j'ai réussi à comprendre ce qui se passait. <br><br>  En bref: en raison d'une erreur et d'une implémentation incomplète de la simulation de l'état de retard, le client se retrouve parfois dans une situation où il doit envoyer un paquet réseau en un cycle d'horloge, qui consiste en des actions du joueur pour sélectionner environ 400 entités de jeu (nous l'appelons un «mégapacket»).  Après cela, le serveur doit non seulement recevoir correctement toutes ces actions d'entrée, mais également les envoyer à tous les autres clients.  Si vous avez 200 clients, cela devient rapidement un problème.  Le canal vers le serveur est rapidement obstrué, ce qui entraîne une perte de paquets et une cascade de paquets redemandés.  Le report des actions d'entrée conduit alors au fait que de plus en plus de clients commencent à envoyer des mégapaquets, et leur avalanche devient encore plus forte.  Les clients qui réussissent parviennent à récupérer, tout le reste «tombe». <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/a49/50e/f21a4950e42bd555a91ad923e5067ea6.jpg" alt="image"></div><br>  Le problème était assez fondamental et il m'a fallu 2 semaines pour le résoudre.  C'est assez technique, donc ci-dessous j'expliquerai les détails techniques juteux.  Mais vous devez d'abord savoir que depuis la version 0.17.54, publiée le 4 juin, face à des problèmes de connexion temporaires, le multijoueur est devenu plus stable, et masquer les retards est beaucoup moins bogué (moins de freinage et de téléportation).  De plus, j'ai changé la façon de cacher les retards de combat et j'espère que grâce à cela ils seront un peu plus fluides. <br><br><h3>  Megapack multi-utilisateurs - Détails techniques </h3><br>  En termes simples, le multijoueur dans le jeu fonctionne comme suit: tous les clients simulent l'état du jeu, ne recevant et n'envoyant que les entrées du joueur (appelées «Actions d'entrée», <i>Actions d'entrée</i> ).  La tâche principale du serveur est de transmettre les <i>actions d'entrée</i> et de contrôler que tous les clients effectuent les mêmes actions en un seul cycle.  En savoir plus à ce sujet dans le post <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FFF-149</a> . <br><br>  Étant donné que le serveur doit prendre des décisions sur les actions à effectuer, les actions du joueur évoluent le long de ce chemin: action du joueur -&gt; client de jeu -&gt; réseau -&gt; serveur -&gt; réseau -&gt; client de jeu.  Cela signifie que l'action de chaque joueur n'est effectuée qu'après avoir effectué un trajet aller-retour à travers le réseau.  Pour cette raison, le jeu semble terriblement lent, donc presque immédiatement après l'apparition du multijoueur dans le jeu, un mécanisme permettant de masquer les retards a été introduit.  Masquer un retard imite l'entrée d'un joueur sans tenir compte des actions des autres joueurs et des décisions du serveur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/2f/ui/8u2fuieagsu2fokkbdny-hxi1cc.png"></div><br>  Factorio a un état de jeu appelé <i>Game State</i> - c'est l'état complet de la carte, du joueur, des entités et de tout le reste.  Il est simulé de manière déterministe dans tous les clients en fonction des actions reçues du serveur.  L'état du jeu est sacré et s'il commence à différer du serveur ou de tout autre client, la désynchronisation se produit. <br><br>  En plus de <i>Game State</i> , nous avons un <i>état de</i> latence <i>Latency State</i> .  Il contient un petit sous-ensemble de l'état fondamental.  <i>L'état de latence n'est</i> pas sacré et présente simplement une image de l'état du jeu à l'avenir sur la base des <i>actions d'entrée</i> introduites par le joueur. <br><br>  Pour ce faire, nous stockons une copie des <i>actions d'entrée</i> créées dans la file d'attente de retard. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gf/m4/bo/gfm4bo81-iluah40eus3cxjxvjm.png"></div><br>  Autrement dit, à la fin du processus côté client, l'image ressemble à ceci: <br><br><ol><li>  Appliquez les <i>actions d'entrée de</i> tous les joueurs à l' <i>état</i> du <i>jeu</i> car ces actions d'entrée ont été reçues du serveur. </li><li>  Nous supprimons de la file d'attente des retards toutes les <i>actions d'entrée</i> qui, selon le serveur, ont déjà été appliquées à <i>Game State</i> . </li><li>  Supprimez l' <i>état de latence</i> et réinitialisez-le afin qu'il ressemble exactement à l'état du <i>jeu</i> . </li><li>  Appliquez toutes les actions de la file d'attente de retard à l' <i>état de latence</i> . </li><li>  Sur la base des données de l' <i>état</i> du <i>jeu</i> et de l' <i>état de</i> <i>latence, nous</i> rendons le jeu au joueur. </li></ol><br>  Tout cela se répète dans toutes les mesures. <br><br>  Trop compliqué?  Ne vous détendez pas, ce n'est pas tout.  Pour compenser les connexions Internet peu fiables, nous avons créé deux mécanismes: <br><br><ul><li>  Tiques manquées: lorsque le serveur décide que les <i>actions d'entrée</i> seront effectuées dans le rythme du jeu, puis s'il ne reçoit pas les <i>actions d'entrée de</i> certains joueurs (par exemple, en raison de l'augmentation du délai), il n'attendra pas, mais dira à ce client: «Je n'ai pas pris en compte vos <i>actions d'entrée</i> , je vais essayer de les ajouter à la prochaine mesure. "  Ceci est fait pour que, en raison de problèmes de connexion (ou avec l'ordinateur) d'un joueur, la mise à jour de la carte ne ralentisse pas pour tout le monde.  Il convient de noter que les <i>actions d'entrée</i> ne <i>sont</i> pas ignorées, mais simplement reportées. </li><li>  Délai d'aller-retour: le serveur tente de deviner quel est le délai d'aller-retour entre le client et le serveur pour chaque client.  Toutes les 5 secondes, si nécessaire, il discute avec le client d'un nouveau délai (en fonction de la façon dont la connexion s'est comportée dans le passé), et augmente ou diminue en conséquence le délai de transfert de données dans les deux sens. </li></ul><br>  En eux-mêmes, ces mécanismes sont assez simples, mais lorsqu'ils sont utilisés ensemble (ce qui arrive souvent avec des problèmes de connexion), la logique du code devient difficile à gérer et avec un tas de cas limites.  De plus, lorsque ces mécanismes entrent en <i>jeu</i> , le serveur et la file d'attente de retard doivent implémenter correctement une <i>action d'entrée</i> spéciale appelée <i>StopMovementInTheNextTick</i> .  Pour cette raison, avec des problèmes de connexion, le personnage ne fonctionnera pas seul (par exemple, sous le train). <br><br>  Vous devez maintenant vous expliquer comment fonctionne la sélection d'entités.  L'un des types d' <i>actions d'entrée</i> réussies est le changement d'état de la sélection d'entité.  Il indique à tout le monde sur quelle entité le joueur a plané.  Comme vous pouvez le comprendre, il s'agit de l'une des actions d'entrée les plus fréquentes envoyées par les clients, donc pour économiser la bande passante, nous l'avons optimisée afin qu'elle occupe le moins d'espace possible.  Ceci est implémenté comme suit: lors du choix de chaque entité, au lieu de conserver les coordonnées absolues et de haute précision de la carte, le jeu conserve un déplacement relatif à faible courant par rapport au choix précédent.  Cela fonctionne bien car la sélection de la souris se produit généralement très près de la sélection précédente.  Pour cette raison, deux exigences importantes se posent: <i>Les actions d'entrée</i> ne doivent jamais être ignorées et doivent être exécutées dans le bon ordre.  Ces conditions sont remplies pour <i>Game State</i> .  Mais puisque la tâche de l' <i>état de latence</i> est de «paraître assez bien» pour le joueur, ils ne sont pas satisfaits de l'état des retards.  <i>L'État de latence</i> ne prend pas en compte de <a href="">nombreux cas limites</a> associés aux cycles de sauts et à la modification des délais d'aller-retour. <br><br>  Vous pouvez déjà deviner où tout se passe.  Enfin, nous commençons à voir les causes du problème du mégapaquet.  La racine du problème est qu'en décidant de passer ou non l'action du changement de sélection, la logique de sélection d'entité s'appuie sur l' <i>état de latence</i> , et cet état ne contient pas toujours les informations correctes.  Par conséquent, un mégapaquet est généré comme ceci: <br><br><ol><li>  Le lecteur a un problème de connexion. </li><li>  Les mécanismes de saut d'horloges et de régulation du délai d'aller-retour entrent en jeu. </li><li>  La mise en file d'attente des retards d'état ne tient pas compte de ces mécanismes.  Cela entraîne la suppression prématurée de certaines actions ou leur exécution dans le mauvais ordre, ce qui entraîne un <i>état de latence</i> incorrect. </li><li>  Le joueur a un problème de connexion et lui, pour rattraper le serveur, simule jusqu'à 400 cycles d'horloge. </li><li>  Dans chaque cycle d'horloge, une nouvelle action, modifiant la sélection d'une entité, est générée et préparée pour être envoyée au serveur. </li><li>  Le client envoie au serveur un mégapacket de plus de 400 changements dans le choix des entités (et avec d'autres actions: l'état de tir, de marche, etc., a également souffert de ce problème). </li><li>  Le serveur reçoit 400 actions d'entrée.  Puisqu'il n'est pas autorisé à ignorer une seule action d'entrée, il ordonne à tous les clients d'effectuer ces actions et les envoie sur le réseau. </li></ol><br>  L'ironie est qu'un mécanisme conçu pour économiser la bande passante du canal a créé d'énormes paquets réseau en conséquence. <br><br>  Nous avons résolu ce problème en corrigeant tous les cas limites de mise à jour et en prenant en charge la file d'attente des retards.  Bien que cela ait pris un certain temps, au final, cela valait la peine de tout mettre en œuvre correctement et de ne pas compter sur des hacks rapides. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr466135/">https://habr.com/ru/post/fr466135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr466113/index.html">Définir l'encodage de texte en PHP au lieu de mb_detect_encoding</a></li>
<li><a href="../fr466121/index.html">Génération de son sur des microcontrôleurs AVR utilisant une méthode de table d'onde avec prise en charge de la polyphonie</a></li>
<li><a href="../fr466123/index.html">Croissance. Poids. Trois voisins</a></li>
<li><a href="../fr466127/index.html">Centrale nucléaire de Kola ou debout au réacteur</a></li>
<li><a href="../fr466129/index.html">Efficacité du transport sur l'essence, les batteries et l'hydrogène</a></li>
<li><a href="../fr466137/index.html">Pipelines System.IO. - un outil peu connu des amateurs de hautes performances</a></li>
<li><a href="../fr466139/index.html">Technologie appliquée sur les ruines de la fièvre de la blockchain ou les avantages pratiques de l'allocation des ressources</a></li>
<li><a href="../fr466143/index.html">Comment avons-nous fait du code en carton ou la version Scratch du jeu de plateau Golem Battle</a></li>
<li><a href="../fr466147/index.html">Gestionnaire d'affichage de données réactif. Présentation</a></li>
<li><a href="../fr466149/index.html">Création d'un symbole de connecteur avec du texte «dynamique» dans OrCAD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>