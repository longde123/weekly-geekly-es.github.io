<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ò üî™ üìÉ Megapack: comment les d√©veloppeurs de Factorio ont r√©ussi √† r√©soudre le probl√®me avec le mode multijoueur √† 200 joueurs üèÇüèª üß¶ üëù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En mai de cette ann√©e, j'ai particip√© en tant que joueur √† l' √©v√©nement MMO KatherineOfSky . J'ai remarqu√© que lorsque le nombre de joueurs atteint un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Megapack: comment les d√©veloppeurs de Factorio ont r√©ussi √† r√©soudre le probl√®me avec le mode multijoueur √† 200 joueurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466135/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/35a/156/0b735a15617cf15740ddb733b0cff066.jpg" alt="image"></div><br>  En mai de cette ann√©e, j'ai particip√© en tant que joueur √† l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©v√©nement MMO KatherineOfSky</a> .  J'ai remarqu√© que lorsque le nombre de joueurs atteint un certain nombre, toutes les quelques minutes, certains ¬´tombent¬ª.  Heureusement pour vous (mais pas pour moi), je faisais partie de ces joueurs qui se d√©connectaient √† <b>chaque fois</b> , m√™me avec une bonne connexion.  J'ai pris cela comme un d√©fi personnel et j'ai commenc√© √† chercher les causes du probl√®me.  Apr√®s trois semaines de d√©bogage, de test et de correction, l'erreur a finalement √©t√© corrig√©e, mais ce voyage n'a pas √©t√© aussi simple. <br><br>  Les probl√®mes des jeux multijoueurs sont tr√®s difficiles √† rep√©rer.  Habituellement, ils surviennent dans des conditions tr√®s sp√©cifiques de param√®tres de r√©seau et dans des conditions tr√®s sp√©cifiques du jeu (dans ce cas, la pr√©sence de plus de 200 joueurs).  Et m√™me lorsqu'il est possible de reproduire le probl√®me, il ne peut pas √™tre correctement d√©bogu√©, car l'insertion de points de contr√¥le arr√™te le jeu, perturbe les temporisateurs et conduit g√©n√©ralement √† la fin de la connexion en raison du d√©passement du temps d'attente.  Mais gr√¢ce √† l'ent√™tement et au merveilleux outil appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">maladroit,</a> j'ai r√©ussi √† comprendre ce qui se passait. <br><br>  En bref: en raison d'une erreur et d'une impl√©mentation incompl√®te de la simulation de l'√©tat de retard, le client se retrouve parfois dans une situation o√π il doit envoyer un paquet r√©seau en un cycle d'horloge, qui consiste en des actions du joueur pour s√©lectionner environ 400 entit√©s de jeu (nous l'appelons un ¬´m√©gapacket¬ª).  Apr√®s cela, le serveur doit non seulement recevoir correctement toutes ces actions d'entr√©e, mais √©galement les envoyer √† tous les autres clients.  Si vous avez 200 clients, cela devient rapidement un probl√®me.  Le canal vers le serveur est rapidement obstru√©, ce qui entra√Æne une perte de paquets et une cascade de paquets redemand√©s.  Le report des actions d'entr√©e conduit alors au fait que de plus en plus de clients commencent √† envoyer des m√©gapaquets, et leur avalanche devient encore plus forte.  Les clients qui r√©ussissent parviennent √† r√©cup√©rer, tout le reste ¬´tombe¬ª. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/a49/50e/f21a4950e42bd555a91ad923e5067ea6.jpg" alt="image"></div><br>  Le probl√®me √©tait assez fondamental et il m'a fallu 2 semaines pour le r√©soudre.  C'est assez technique, donc ci-dessous j'expliquerai les d√©tails techniques juteux.  Mais vous devez d'abord savoir que depuis la version 0.17.54, publi√©e le 4 juin, face √† des probl√®mes de connexion temporaires, le multijoueur est devenu plus stable, et masquer les retards est beaucoup moins bogu√© (moins de freinage et de t√©l√©portation).  De plus, j'ai chang√© la fa√ßon de cacher les retards de combat et j'esp√®re que gr√¢ce √† cela ils seront un peu plus fluides. <br><br><h3>  Megapack multi-utilisateurs - D√©tails techniques </h3><br>  En termes simples, le multijoueur dans le jeu fonctionne comme suit: tous les clients simulent l'√©tat du jeu, ne recevant et n'envoyant que les entr√©es du joueur (appel√©es ¬´Actions d'entr√©e¬ª, <i>Actions d'entr√©e</i> ).  La t√¢che principale du serveur est de transmettre les <i>actions d'entr√©e</i> et de contr√¥ler que tous les clients effectuent les m√™mes actions en un seul cycle.  En savoir plus √† ce sujet dans le post <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FFF-149</a> . <br><br>  √âtant donn√© que le serveur doit prendre des d√©cisions sur les actions √† effectuer, les actions du joueur √©voluent le long de ce chemin: action du joueur -&gt; client de jeu -&gt; r√©seau -&gt; serveur -&gt; r√©seau -&gt; client de jeu.  Cela signifie que l'action de chaque joueur n'est effectu√©e qu'apr√®s avoir effectu√© un trajet aller-retour √† travers le r√©seau.  Pour cette raison, le jeu semble terriblement lent, donc presque imm√©diatement apr√®s l'apparition du multijoueur dans le jeu, un m√©canisme permettant de masquer les retards a √©t√© introduit.  Masquer un retard imite l'entr√©e d'un joueur sans tenir compte des actions des autres joueurs et des d√©cisions du serveur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/2f/ui/8u2fuieagsu2fokkbdny-hxi1cc.png"></div><br>  Factorio a un √©tat de jeu appel√© <i>Game State</i> - c'est l'√©tat complet de la carte, du joueur, des entit√©s et de tout le reste.  Il est simul√© de mani√®re d√©terministe dans tous les clients en fonction des actions re√ßues du serveur.  L'√©tat du jeu est sacr√© et s'il commence √† diff√©rer du serveur ou de tout autre client, la d√©synchronisation se produit. <br><br>  En plus de <i>Game State</i> , nous avons un <i>√©tat de</i> latence <i>Latency State</i> .  Il contient un petit sous-ensemble de l'√©tat fondamental.  <i>L'√©tat de latence n'est</i> pas sacr√© et pr√©sente simplement une image de l'√©tat du jeu √† l'avenir sur la base des <i>actions d'entr√©e</i> introduites par le joueur. <br><br>  Pour ce faire, nous stockons une copie des <i>actions d'entr√©e</i> cr√©√©es dans la file d'attente de retard. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gf/m4/bo/gfm4bo81-iluah40eus3cxjxvjm.png"></div><br>  Autrement dit, √† la fin du processus c√¥t√© client, l'image ressemble √† ceci: <br><br><ol><li>  Appliquez les <i>actions d'entr√©e de</i> tous les joueurs √† l' <i>√©tat</i> du <i>jeu</i> car ces actions d'entr√©e ont √©t√© re√ßues du serveur. </li><li>  Nous supprimons de la file d'attente des retards toutes les <i>actions d'entr√©e</i> qui, selon le serveur, ont d√©j√† √©t√© appliqu√©es √† <i>Game State</i> . </li><li>  Supprimez l' <i>√©tat de latence</i> et r√©initialisez-le afin qu'il ressemble exactement √† l'√©tat du <i>jeu</i> . </li><li>  Appliquez toutes les actions de la file d'attente de retard √† l' <i>√©tat de latence</i> . </li><li>  Sur la base des donn√©es de l' <i>√©tat</i> du <i>jeu</i> et de l' <i>√©tat de</i> <i>latence, nous</i> rendons le jeu au joueur. </li></ol><br>  Tout cela se r√©p√®te dans toutes les mesures. <br><br>  Trop compliqu√©?  Ne vous d√©tendez pas, ce n'est pas tout.  Pour compenser les connexions Internet peu fiables, nous avons cr√©√© deux m√©canismes: <br><br><ul><li>  Tiques manqu√©es: lorsque le serveur d√©cide que les <i>actions d'entr√©e</i> seront effectu√©es dans le rythme du jeu, puis s'il ne re√ßoit pas les <i>actions d'entr√©e de</i> certains joueurs (par exemple, en raison de l'augmentation du d√©lai), il n'attendra pas, mais dira √† ce client: ¬´Je n'ai pas pris en compte vos <i>actions d'entr√©e</i> , je vais essayer de les ajouter √† la prochaine mesure. "  Ceci est fait pour que, en raison de probl√®mes de connexion (ou avec l'ordinateur) d'un joueur, la mise √† jour de la carte ne ralentisse pas pour tout le monde.  Il convient de noter que les <i>actions d'entr√©e</i> ne <i>sont</i> pas ignor√©es, mais simplement report√©es. </li><li>  D√©lai d'aller-retour: le serveur tente de deviner quel est le d√©lai d'aller-retour entre le client et le serveur pour chaque client.  Toutes les 5 secondes, si n√©cessaire, il discute avec le client d'un nouveau d√©lai (en fonction de la fa√ßon dont la connexion s'est comport√©e dans le pass√©), et augmente ou diminue en cons√©quence le d√©lai de transfert de donn√©es dans les deux sens. </li></ul><br>  En eux-m√™mes, ces m√©canismes sont assez simples, mais lorsqu'ils sont utilis√©s ensemble (ce qui arrive souvent avec des probl√®mes de connexion), la logique du code devient difficile √† g√©rer et avec un tas de cas limites.  De plus, lorsque ces m√©canismes entrent en <i>jeu</i> , le serveur et la file d'attente de retard doivent impl√©menter correctement une <i>action d'entr√©e</i> sp√©ciale appel√©e <i>StopMovementInTheNextTick</i> .  Pour cette raison, avec des probl√®mes de connexion, le personnage ne fonctionnera pas seul (par exemple, sous le train). <br><br>  Vous devez maintenant vous expliquer comment fonctionne la s√©lection d'entit√©s.  L'un des types d' <i>actions d'entr√©e</i> r√©ussies est le changement d'√©tat de la s√©lection d'entit√©.  Il indique √† tout le monde sur quelle entit√© le joueur a plan√©.  Comme vous pouvez le comprendre, il s'agit de l'une des actions d'entr√©e les plus fr√©quentes envoy√©es par les clients, donc pour √©conomiser la bande passante, nous l'avons optimis√©e afin qu'elle occupe le moins d'espace possible.  Ceci est impl√©ment√© comme suit: lors du choix de chaque entit√©, au lieu de conserver les coordonn√©es absolues et de haute pr√©cision de la carte, le jeu conserve un d√©placement relatif √† faible courant par rapport au choix pr√©c√©dent.  Cela fonctionne bien car la s√©lection de la souris se produit g√©n√©ralement tr√®s pr√®s de la s√©lection pr√©c√©dente.  Pour cette raison, deux exigences importantes se posent: <i>Les actions d'entr√©e</i> ne doivent jamais √™tre ignor√©es et doivent √™tre ex√©cut√©es dans le bon ordre.  Ces conditions sont remplies pour <i>Game State</i> .  Mais puisque la t√¢che de l' <i>√©tat de latence</i> est de ¬´para√Ætre assez bien¬ª pour le joueur, ils ne sont pas satisfaits de l'√©tat des retards.  <i>L'√âtat de latence</i> ne prend pas en compte de <a href="">nombreux cas limites</a> associ√©s aux cycles de sauts et √† la modification des d√©lais d'aller-retour. <br><br>  Vous pouvez d√©j√† deviner o√π tout se passe.  Enfin, nous commen√ßons √† voir les causes du probl√®me du m√©gapaquet.  La racine du probl√®me est qu'en d√©cidant de passer ou non l'action du changement de s√©lection, la logique de s√©lection d'entit√© s'appuie sur l' <i>√©tat de latence</i> , et cet √©tat ne contient pas toujours les informations correctes.  Par cons√©quent, un m√©gapaquet est g√©n√©r√© comme ceci: <br><br><ol><li>  Le lecteur a un probl√®me de connexion. </li><li>  Les m√©canismes de saut d'horloges et de r√©gulation du d√©lai d'aller-retour entrent en jeu. </li><li>  La mise en file d'attente des retards d'√©tat ne tient pas compte de ces m√©canismes.  Cela entra√Æne la suppression pr√©matur√©e de certaines actions ou leur ex√©cution dans le mauvais ordre, ce qui entra√Æne un <i>√©tat de latence</i> incorrect. </li><li>  Le joueur a un probl√®me de connexion et lui, pour rattraper le serveur, simule jusqu'√† 400 cycles d'horloge. </li><li>  Dans chaque cycle d'horloge, une nouvelle action, modifiant la s√©lection d'une entit√©, est g√©n√©r√©e et pr√©par√©e pour √™tre envoy√©e au serveur. </li><li>  Le client envoie au serveur un m√©gapacket de plus de 400 changements dans le choix des entit√©s (et avec d'autres actions: l'√©tat de tir, de marche, etc., a √©galement souffert de ce probl√®me). </li><li>  Le serveur re√ßoit 400 actions d'entr√©e.  Puisqu'il n'est pas autoris√© √† ignorer une seule action d'entr√©e, il ordonne √† tous les clients d'effectuer ces actions et les envoie sur le r√©seau. </li></ol><br>  L'ironie est qu'un m√©canisme con√ßu pour √©conomiser la bande passante du canal a cr√©√© d'√©normes paquets r√©seau en cons√©quence. <br><br>  Nous avons r√©solu ce probl√®me en corrigeant tous les cas limites de mise √† jour et en prenant en charge la file d'attente des retards.  Bien que cela ait pris un certain temps, au final, cela valait la peine de tout mettre en ≈ìuvre correctement et de ne pas compter sur des hacks rapides. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr466135/">https://habr.com/ru/post/fr466135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr466113/index.html">D√©finir l'encodage de texte en PHP au lieu de mb_detect_encoding</a></li>
<li><a href="../fr466121/index.html">G√©n√©ration de son sur des microcontr√¥leurs AVR utilisant une m√©thode de table d'onde avec prise en charge de la polyphonie</a></li>
<li><a href="../fr466123/index.html">Croissance. Poids. Trois voisins</a></li>
<li><a href="../fr466127/index.html">Centrale nucl√©aire de Kola ou debout au r√©acteur</a></li>
<li><a href="../fr466129/index.html">Efficacit√© du transport sur l'essence, les batteries et l'hydrog√®ne</a></li>
<li><a href="../fr466137/index.html">Pipelines System.IO. - un outil peu connu des amateurs de hautes performances</a></li>
<li><a href="../fr466139/index.html">Technologie appliqu√©e sur les ruines de la fi√®vre de la blockchain ou les avantages pratiques de l'allocation des ressources</a></li>
<li><a href="../fr466143/index.html">Comment avons-nous fait du code en carton ou la version Scratch du jeu de plateau Golem Battle</a></li>
<li><a href="../fr466147/index.html">Gestionnaire d'affichage de donn√©es r√©actif. Pr√©sentation</a></li>
<li><a href="../fr466149/index.html">Cr√©ation d'un symbole de connecteur avec du texte ¬´dynamique¬ª dans OrCAD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>