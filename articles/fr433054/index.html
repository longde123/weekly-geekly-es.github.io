<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí† üõÑ üßñüèø Une aiguille dans une pile de sessions ou un bytecode d'expression r√©guli√®re üòé üò≤ ü§ûüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="17 milliards d'√©v√©nements, 60 millions de sessions utilisateurs et un grand nombre de dates virtuelles ont lieu quotidiennement √† Badoo. Chaque √©v√©nem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Une aiguille dans une pile de sessions ou un bytecode d'expression r√©guli√®re</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/433054/"><p><img src="https://habrastorage.org/webt/kz/rl/nu/kzrlnugblhii_j4jrsqzdk9fsgo.jpeg"></p><br><p>  17 milliards d'√©v√©nements, 60 millions de sessions utilisateurs et un grand nombre de dates virtuelles ont lieu quotidiennement √† Badoo.  Chaque √©v√©nement est soigneusement stock√© dans des bases de donn√©es relationnelles pour une analyse ult√©rieure en SQL et au-del√†. </p><br><p>  Bases de donn√©es transactionnelles distribu√©es modernes avec des dizaines de t√©raoctets de donn√©es - un v√©ritable miracle d'ing√©nierie.  Mais SQL, comme l'incarnation de l'alg√®bre relationnelle dans la plupart des impl√©mentations standard, ne nous permet pas encore de formuler des requ√™tes en termes de tuples ordonn√©s. </p><br><p>  Dans le dernier article d'une s√©rie sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">machines</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">virtuelles</a> , je parlerai d'une approche alternative pour trouver des sessions int√©ressantes - le moteur d'expression r√©guli√®re ( <a href="">Pig Match</a> ), qui est d√©fini pour les s√©quences d'√©v√©nements. </p><br><p>  La machine virtuelle, le bytecode et le compilateur sont inclus gratuitement! </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Premi√®re partie, introduction</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Deuxi√®me partie, optimisation</a> <br>  Troisi√®me partie, appliqu√©e (actuelle) </p><br><h1 id="o-sobytiyah-i-sessiyah">  √Ä propos des √©v√©nements et des sessions </h1><br><p>  Supposons que nous ayons d√©j√† un entrep√¥t de donn√©es qui vous permet de visualiser rapidement et s√©quentiellement les √©v√©nements de chacune des sessions utilisateur. </p><br><p> Nous voulons rechercher des sessions par des requ√™tes comme "compter toutes les sessions o√π il y a une sous-s√©quence d'√©v√©nements sp√©cifi√©e", "trouver les parties d'une session d√©crites par un mod√®le donn√©", "retourner la partie de la session qui s'est produite apr√®s un mod√®le donn√©" ou "compter le nombre de sessions qui ont atteint certaines parties mod√®le. "  Cela peut √™tre utile pour une vari√©t√© de types d'analyses: recherche de sessions suspectes, analyse en entonnoir, etc. </p><br><p>  Les sous-s√©quences souhait√©es doivent en quelque sorte √™tre d√©crites.  Dans sa forme la plus simple, cette t√¢che est similaire √† la recherche d'une sous-cha√Æne dans un texte;  nous voulons avoir un outil plus puissant - les expressions r√©guli√®res.  Les impl√©mentations modernes de moteurs d'expression r√©guli√®re utilisent le plus souvent (vous l'avez devin√©!) Des machines virtuelles. </p><br><p>  La cr√©ation de petites machines virtuelles pour faire correspondre des sessions avec des expressions r√©guli√®res sera discut√©e ci-dessous.  Mais d'abord, nous allons clarifier les d√©finitions. </p><br><p>  <em>Un √©v√©nement se</em> compose d'un type d'√©v√©nement, d'une heure, d'un contexte et d'un ensemble d'attributs sp√©cifiques √† chaque type. </p><br><p>  <em>Le type</em> et le <em>contexte de</em> chaque √©v√©nement sont des entiers issus de listes pr√©d√©finies.  Si tout est clair avec les types d'√©v√©nements, alors le contexte est, par exemple, le num√©ro de l'√©cran sur lequel l'√©v√©nement donn√© s'est produit. </p><br><p>  <em>Un attribut d'</em> √©v√©nement est un entier arbitraire dont la signification est d√©termin√©e par le type d'√©v√©nement.  Un √©v√©nement peut ne pas avoir d'attributs ou il peut y en avoir plusieurs. </p><br><p>  <em>Une session</em> est une s√©quence d'√©v√©nements tri√©e par le temps. </p><br><p>  Mais passons enfin aux affaires.  Le buzz, comme on dit, s'est calm√© et je suis mont√© sur sc√®ne. </p><br><h1 id="sravnivaem-po-bumazhke">  Comparer sur un morceau de papier </h1><br><p><img src="https://habrastorage.org/webt/gu/ec/dw/guecdwuc3rhjl1oc6cvuk-4ec9k.jpeg"></p><br><p>  Une caract√©ristique de cette machine virtuelle est la passivit√© vis-√†-vis des √©v√©nements d'entr√©e.  Nous ne voulons pas garder la session enti√®re en m√©moire et permettre √† la machine virtuelle de passer ind√©pendamment d'un √©v√©nement √† l'autre.  Au lieu de cela, nous alimenterons les √©v√©nements de la session dans la machine virtuelle un par un. </p><br><p>  D√©finissons les fonctions d'interface: </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">matcher *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bytecode)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">match_result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *matcher)</span></span></span></span>;</code> </pre> <br><p>  Si tout est clair avec les fonctions matcher_create et matcher_destroy, alors matcher_accept m√©rite d'√™tre comment√©.  La fonction matcher_accept re√ßoit une instance de la machine virtuelle et de l'√©v√©nement suivant (32 bits, o√π 16 bits pour le type d'√©v√©nement et 16 bits pour le contexte), et renvoie un code expliquant ce que le code utilisateur doit faire ensuite: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> match_result { <span class="hljs-comment"><span class="hljs-comment">//       MATCH_NEXT, //    ,      MATCH_OK, //       ,      MATCH_FAIL, //     MATCH_ERROR, } match_result;</span></span></code> </pre><br><p>  Opcodes de la machine virtuelle: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> matcher_opcode { <span class="hljs-comment"><span class="hljs-comment">//  ,      OP_ABORT, //      ( -  ) OP_NAME, //     ( -  ) OP_SCREEN, //    OP_NEXT, //    OP_MATCH, } matcher_opcode;</span></span></code> </pre><br><p>  La boucle principale d'une machine virtuelle: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">match_result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> next_event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_OP() \ (*m-&gt;ip++) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_ARG() \ ((void)(m-&gt;ip += 2), (m-&gt;ip[-2] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 8) + m-&gt;ip[-1]) for (;;) { uint8_t instruction = NEXT_OP(); switch (instruction) { case OP_ABORT:{ return MATCH_ERROR; } case OP_NAME:{ uint16_t name = NEXT_ARG(); if (event_name(next_event) != name) return MATCH_FAIL; break; } case OP_SCREEN:{ uint16_t screen = NEXT_ARG(); if (event_screen(next_event) != screen) return MATCH_FAIL; break; } case OP_NEXT:{ return MATCH_NEXT; } case OP_MATCH:{ return MATCH_OK; } default:{ return MATCH_ERROR; } } } #undef NEXT_OP #undef NEXT_ARG }</span></span></span></span></code> </pre> <br><p>  Dans cette version simple, notre machine virtuelle correspond s√©quentiellement au mod√®le d√©crit par bytecode avec les √©v√©nements entrants.  En tant que tel, ce n'est tout simplement pas une comparaison tr√®s concise des <em>pr√©fixes de</em> deux lignes: le mod√®le souhait√© et la ligne d'entr√©e. </p><br><p>  Les pr√©fixes sont des pr√©fixes, mais nous voulons trouver les mod√®les souhait√©s non seulement au d√©but, mais aussi √† un endroit arbitraire de la session.  La solution na√Øve consiste √† red√©marrer la correspondance √† partir de chaque √©v√©nement de session.  Mais cela implique une visualisation multiple de chacun des √©v√©nements et de manger des b√©b√©s algorithmiques. </p><br><p>  <a href="">L'exemple</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premier article de la</a> s√©rie, en effet, simule le red√©marrage d'une correspondance √† l'aide de la restauration (retour arri√®re en anglais).  Le code dans l'exemple semble, bien s√ªr, plus mince que celui donn√© ici, mais le probl√®me n'a pas disparu: chacun des √©v√©nements devra √™tre v√©rifi√© plusieurs fois. </p><br><p>  Vous ne pouvez pas vivre comme √ßa. </p><br><h1 id="ya-esche-raz-ya-i-snova-ya">  Moi encore moi et encore moi </h1><br><p><img src="https://habrastorage.org/webt/bq/ue/gt/bquegtp3mpd4rxv65f1fk-svdjk.jpeg"></p><br><p>  D√©crivons encore une fois le probl√®me: nous devons faire correspondre le mod√®le avec les √©v√©nements entrants, en commen√ßant par chacun des √©v√©nements en commen√ßant une nouvelle comparaison.  Alors pourquoi ne faisons-nous pas cela?  Laissez la machine virtuelle marcher sur les √©v√©nements entrants dans plusieurs threads! </p><br><p>  Pour ce faire, nous devons obtenir une nouvelle entit√© - un flux.  Chaque thread stocke un seul pointeur - vers l'instruction en cours: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matcher_thread</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *ip; } matcher_thread;</code> </pre><br><p>  Naturellement, maintenant dans la machine virtuelle elle-m√™me, nous ne stockerons pas le pointeur explicite.  Il sera remplac√© par deux listes de fils (en savoir plus √† leur sujet ci-dessous): </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">matcher</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *bytecode; <span class="hljs-comment"><span class="hljs-comment">/* Threads to be processed using the current event */</span></span> matcher_thread current_threads[MAX_THREAD_NUM]; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> current_thread_num; <span class="hljs-comment"><span class="hljs-comment">/* Threads to be processed using the event to follow */</span></span> matcher_thread next_threads[MAX_THREAD_NUM]; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> next_thread_num; } matcher;</code> </pre><br><p>  Et voici la boucle principale mise √† jour: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">match_result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(matcher *m, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> next_event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_OP(thread) \ (*(thread).ip++) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NEXT_ARG(thread) \ ((void)((thread).ip += 2), ((thread).ip[-2] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 8) + (thread).ip[-1]) /*         - */ add_current_thread(m, initial_thread(m)); //         for (size_t thread_i = 0; thread_i &lt; m-&gt;current_thread_num; thread_i++ ) { matcher_thread current_thread = m-&gt;current_threads[thread_i]; bool thread_done = false; while (!thread_done) { uint8_t instruction = NEXT_OP(current_thread); switch (instruction) { case OP_ABORT:{ return MATCH_ERROR; } case OP_NAME:{ uint16_t name = NEXT_ARG(current_thread); //  ,      ,    //     next_threads,    if (event_name(next_event) != name) thread_done = true; break; } case OP_SCREEN:{ uint16_t screen = NEXT_ARG(current_thread); if (event_screen(next_event) != screen) thread_done = true; break; } case OP_NEXT:{ //    , ..      // next_threads add_next_thread(m, current_thread); thread_done = true; break; } case OP_MATCH:{ return MATCH_OK; } default:{ return MATCH_ERROR; } } } } /*      ,    */ swap_current_and_next(m); return MATCH_NEXT; #undef NEXT_OP #undef NEXT_ARG }</span></span></span></span></code> </pre><br><p>  √Ä chaque √©v√©nement re√ßu, nous ajoutons d'abord un nouveau thread √† la liste current_threads, v√©rifiant le mod√®le depuis le tout d√©but, apr√®s quoi nous commen√ßons √† parcourir la liste current_threads, en suivant chaque pointeur en suivant les instructions. </p><br><p>  Si une instruction NEXT est rencontr√©e, le thread est plac√© dans la liste next_threads, c'est-√†-dire qu'il attend que l'√©v√©nement suivant soit re√ßu. </p><br><p>  Si le mod√®le de thread ne correspond pas √† l'√©v√©nement re√ßu, un tel thread n'est tout simplement pas ajout√© √† la liste next_threads. </p><br><p>  L'instruction MATCH quitte imm√©diatement la fonction, signalant un code retour que le mod√®le correspond √† la session. </p><br><p>  Une fois l'analyse de la liste des threads termin√©e, les listes actuelle et suivante sont permut√©es. </p><br><p>  En fait, c'est tout.  Nous pouvons dire que nous faisons litt√©ralement ce que nous voulions: en m√™me temps, nous v√©rifions plusieurs mod√®les, lan√ßant un nouveau processus de correspondance pour chacun des √©v√©nements de session. </p><br><h1 id="mnozhestvennye-lichnosti-i-vetvleniya-v-shablonah">  Identit√©s et branches multiples dans les mod√®les </h1><br><p><img src="https://habrastorage.org/webt/8l/gv/-e/8lgv-e5bp1xhv0ksukeacrhasaq.jpeg"></p><br><p>  La recherche d'un mod√®le qui d√©crit une s√©quence lin√©aire d'√©v√©nements est, bien s√ªr, utile, mais nous voulons obtenir des expressions r√©guli√®res compl√®tes.  Et les flux que nous avons cr√©√©s √† l'√©tape pr√©c√©dente sont √©galement utiles ici. </p><br><p>  Supposons que nous voulions trouver une s√©quence de deux ou trois √©v√©nements qui nous int√©ressent, quelque chose comme une expression r√©guli√®re sur les lignes: "a? Bc".  Dans cette s√©quence, le symbole "a" est facultatif.  Comment l'exprimer en bytecode?  C'est facile! </p><br><p>  Nous pouvons commencer <em>deux</em> threads, un pour chaque cas: avec le symbole "a" et sans lui.  Pour ce faire, nous introduisons une instruction suppl√©mentaire (de type SPLIT addr1, addr2), qui d√©marre deux threads √† partir des adresses sp√©cifi√©es.  En plus de SPLIT, JUMP nous est √©galement utile, qui continue simplement l'ex√©cution avec l'instruction sp√©cifi√©e dans l'argument direct: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> matcher_opcode { OP_ABORT, OP_NAME, OP_SCREEN, OP_NEXT, <span class="hljs-comment"><span class="hljs-comment">//     OP_JUMP, //         OP_SPLIT, OP_MATCH, //     OP_NUMBER_OF_OPS, } matcher_opcode;</span></span></code> </pre> <br><p>  La boucle elle-m√™me et le reste des instructions ne changent pas - nous introduisons simplement deux nouveaux gestionnaires: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ... case OP_JUMP:{ /*   ,      */ uint16_t offset = NEXT_ARG(current_thread); add_current_thread(m, create_thread(m, offset)); break; } case OP_SPLIT:{ /*        */ uint16_t left_offset = NEXT_ARG(current_thread); uint16_t right_offset = NEXT_ARG(current_thread); add_current_thread(m, create_thread(m, left_offset)); add_current_thread(m, create_thread(m, right_offset)); break; } // ...</span></span></code> </pre><br><p>  Notez que les instructions ajoutent des threads √† la liste actuelle, c'est-√†-dire qu'elles continuent de fonctionner dans le contexte de l'√©v√©nement en cours.  Le thread dans lequel la branche s'est produite n'entre pas dans la liste des threads suivants. </p><br><p>  La chose la plus surprenante dans cette machine virtuelle d'expression r√©guli√®re est que nos threads et cette paire d'instructions sont suffisants pour exprimer presque toutes les constructions g√©n√©ralement accept√©es lors de la correspondance de cha√Ænes. </p><br><h1 id="regulyarnye-vyrazheniya-na-sobytiyah">  Expressions r√©guli√®res sur les √©v√©nements </h1><br><p>  Maintenant que nous avons une machine virtuelle et des outils appropri√©s, nous pouvons r√©ellement g√©rer la syntaxe de nos expressions r√©guli√®res. </p><br><p>  L'enregistrement manuel des opcodes pour des programmes plus s√©rieux se fatigue rapidement.  La derni√®re fois, je n'ai pas fait de parseur √† part enti√®re, mais l'utilisateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">true-grue a</a> montr√© les capacit√©s de sa biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">raddsl en utilisant le</a> mini-langage <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PigletC</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comme</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple</a> .  J'ai √©t√© tellement impressionn√© par la bri√®vet√© du code qu'avec l'aide de raddsl j'ai √©crit un petit compilateur d'expressions r√©guli√®res de cha√Ænes en cent ou deux cents en Python.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le compilateur</a> et les instructions pour son utilisation sont sur GitHub.  Le r√©sultat du compilateur en langage assembleur est compris par un utilitaire qui lit deux fichiers (un programme pour une machine virtuelle et une liste des √©v√©nements de session pour v√©rification). </p><br><p>  Pour commencer, nous nous limitons au type et au contexte de l'√©v√©nement.  Le type d'√©v√©nement est d√©sign√© par un seul num√©ro;  si vous devez sp√©cifier un contexte, sp√©cifiez-le via deux points.  L'exemple le plus simple: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "13" # ,     13 NEXT NAME 13 MATCH</code> </pre> <br><p>  Maintenant un exemple avec contexte: </p><br><pre> <code class="plaintext hljs">python regexp/regexp.py "13:12" #  13,  12 NEXT NAME 13 SCREEN 12 MATCH</code> </pre> <br><p>  Les √©v√©nements successifs doivent √™tre s√©par√©s d'une mani√®re ou d'une autre (par exemple, par des espaces): </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "13 11 10:9" 08:40:52 NEXT NAME 13 NEXT NAME 11 NEXT NAME 10 SCREEN 9 MATCH</code> </pre> <br><p>  Mod√®le plus int√©ressant: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "12|13" SPLIT L0 L1 L0: NEXT NAME 12 JUMP L2 L1: NEXT NAME 13 L2: MATCH</code> </pre> <br><p>  Faites attention aux lignes se terminant par deux points.  Ce sont des balises.  L'instruction SPLIT cr√©e deux threads qui continuent leur ex√©cution √† partir des √©tiquettes L0 et L1, et JUMP √† la fin de la premi√®re branche d'ex√©cution passe simplement √† la fin de la branche. </p><br><p>  Vous pouvez choisir entre des cha√Ænes d'expressions plus v√©ritablement en regroupant les sous-s√©quences entre parenth√®ses: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "(1 2 3)|4" SPLIT L0 L1 L0: NEXT NAME 1 NEXT NAME 2 NEXT NAME 3 JUMP L2 L1: NEXT NAME 4 L2: MATCH</code> </pre> <br><p>  Un √©v√©nement arbitraire est indiqu√© par un point: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py ". 1" NEXT NEXT NAME 1 MATCH</code> </pre> <br><p>  Si nous voulons montrer que la sous-s√©quence est facultative, nous mettons un point d'interrogation apr√®s: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "1 2 3? 4" NEXT NAME 1 NEXT NAME 2 SPLIT L0 L1 L0: NEXT NAME 3 L1: NEXT NAME 4 MATCH</code> </pre> <br><p>  Bien s√ªr, plusieurs r√©p√©titions r√©guli√®res (plus ou ast√©risque) sont √©galement courantes dans les expressions r√©guli√®res: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "1+ 2" L0: NEXT NAME 1 SPLIT L0 L1 L1: NEXT NAME 2 MATCH</code> </pre> <br><p>  Ici, nous ex√©cutons simplement l'instruction SPLIT plusieurs fois, en d√©marrant de nouveaux threads √† chaque cycle. </p><br><p>  De m√™me avec un ast√©risque: </p><br><pre> <code class="plaintext hljs">&gt; python regexp/regexp.py "1* 2" L0: SPLIT L1 L2 L1: NEXT NAME 1 JUMP L0 L2: NEXT NAME 2 MATCH</code> </pre> <br><p><img src="https://habrastorage.org/webt/g-/ud/3s/g-ud3s00i4ccyhf4lp5huusjlyu.jpeg"></p><br><h1 id="perspektiva">  Perspective </h1><br><p>  D'autres extensions de la machine virtuelle d√©crite peuvent √™tre utiles. </p><br><p>  Par exemple, il peut facilement √™tre d√©velopp√© en v√©rifiant les attributs d'√©v√©nement.  Pour un syst√®me r√©el, je suppose d'utiliser une syntaxe comme ¬´1: 2 {3: 4, 5:&gt; 3}¬ª, ce qui signifie: √©v√©nement 1 dans le contexte 2 avec l'attribut 3 ayant la valeur 4 et la valeur d'attribut 5 sup√©rieure √† 3. Attributs ici vous pouvez simplement le passer dans un tableau √† la fonction matcher_accept. </p><br><p>  Si vous passez √©galement l'intervalle de temps entre les √©v√©nements √† matcher_accept, vous pouvez ajouter une syntaxe au langage de mod√®le qui vous permet de sauter le temps entre les √©v√©nements: "1 mindelta (120) 2", ce qui signifie: √©v√©nement 1, puis l'intervalle est d'au moins 120 secondes, √©v√©nement 2 Combin√© √† la pr√©servation d'une sous-s√©quence, cela vous permet de collecter des informations sur le comportement de l'utilisateur entre deux sous-s√©quences d'√©v√©nements. </p><br><p>  D'autres √©l√©ments utiles qui sont relativement faciles √† ajouter sont: la pr√©servation des sous-s√©quences d'expressions r√©guli√®res, la s√©paration des ast√©risques avides et ordinaires et des op√©rateurs plus, etc.  En termes de th√©orie des automates, notre machine virtuelle est un automate fini non d√©terministe, pour la mise en ≈ìuvre duquel il n'est pas difficile de faire de telles choses. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Notre syst√®me est d√©velopp√© pour des interfaces utilisateur rapides, donc le moteur de stockage de session est auto-√©crit et optimis√© sp√©cifiquement pour le passage √† travers toutes les sessions.  Tous les milliards d'√©v√©nements divis√©s en sessions sont v√©rifi√©s par rapport aux mod√®les en quelques secondes sur un seul serveur. </p><br><p>  Si la vitesse n'est pas si critique pour vous, alors un syst√®me similaire peut √™tre con√ßu comme une extension pour un syst√®me de stockage de donn√©es plus standard comme une base de donn√©es relationnelle traditionnelle ou un syst√®me de fichiers distribu√©. </p><br><p>  Soit dit en passant, dans les derni√®res versions du <a href="">standard SQL, une</a> fonctionnalit√© similaire √† celle d√©crite dans l'article est d√©j√† apparue et des bases de donn√©es individuelles ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Oracle</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vertica</a> ) l'ont d√©j√† impl√©ment√©e.  Yandex ClickHouse, √† son tour, impl√©mente son propre langage de type SQL, mais il a √©galement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des fonctions similaires</a> . </p><br><p>  En me distrayant des √©v√©nements et des expressions r√©guli√®res, je tiens √† r√©p√©ter que l'applicabilit√© des machines virtuelles est beaucoup plus large qu'il n'y para√Æt √† premi√®re vue.  Cette technique est appropri√©e et largement utilis√©e dans tous les cas o√π il est n√©cessaire de distinguer clairement entre les primitives que le moteur syst√®me comprend et le sous-syst√®me "avant", c'est-√†-dire, par exemple, certains DSL ou langage de programmation. </p><br><p>  Ceci conclut une s√©rie d'articles sur les diverses utilisations des interpr√®tes de bytecode et des machines virtuelles.  J'esp√®re que les lecteurs de Habr ont aim√© la s√©rie et, bien s√ªr, je serai heureux de r√©pondre √† toutes les questions sur le sujet. </p><br><h1 id="neformalnyy-spisok-literatury">  R√©f√©rences informelles </h1><br><p>  Les interpr√®tes de bytecode pour les langages de programmation sont un sujet sp√©cifique, et il y a relativement peu de litt√©rature √† leur sujet.  Personnellement, j‚Äôai aim√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le</a> livre de Ian Craig, Virtual Machines, bien qu‚Äôil ne d√©crive pas tant l‚Äôimpl√©mentation des interpr√®tes que des machines abstraites - des mod√®les math√©matiques qui sous-tendent divers langages de programmation. </p><br><p>  Dans un sens plus large, un autre livre est consacr√© aux machines virtuelles - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Machines virtuelles: plates-formes flexibles pour syst√®mes et processus¬ª</a> (¬´Machines virtuelles: plates-formes polyvalentes pour syst√®mes et processus¬ª).  Il s'agit d'une introduction aux diff√©rentes applications de la virtualisation, couvrant la virtualisation des langages, des processus et des architectures informatiques en g√©n√©ral. </p><br><p>  Les aspects pratiques du d√©veloppement de moteurs d'expression r√©guli√®re sont rarement discut√©s dans la litt√©rature de compilation populaire.  The Pig Match et l'exemple du premier article sont bas√©s sur les id√©es d'une √©tonnante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s√©rie d'articles de</a> Russ Cox, l'un des d√©veloppeurs du moteur Google RE2. </p><br><p>  La th√©orie des expressions r√©guli√®res est pr√©sent√©e dans tous les manuels universitaires sur les compilateurs.  Il est habituel de se r√©f√©rer au fameux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Dragon Book"</a> , mais je recommanderais de commencer par le lien ci-dessus. </p><br><p>  En travaillant sur cet article, j'ai d'abord utilis√© un syst√®me int√©ressant pour le d√©veloppement rapide de compilateurs pour Python <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">raddsl</a> , qui appartient √† la plume de l'utilisateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">true-grue</a> (merci, Peter!).  Si vous √™tes confront√© √† la t√¢che de prototyper un langage ou de d√©velopper rapidement une sorte de DSL, vous devriez y pr√™ter attention. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433054/">https://habr.com/ru/post/fr433054/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433044/index.html">Le code source d'OpenJDK contient trop de jurons</a></li>
<li><a href="../fr433046/index.html">Toute la v√©rit√© sur RTOS. Article # 25. Canaux de donn√©es: introduction et services de base</a></li>
<li><a href="../fr433048/index.html">Comment 2019 va changer les magasins russes</a></li>
<li><a href="../fr433050/index.html">D'un concepteur d'avion √† un programmeur en un an, ou comment devenir un Jedi</a></li>
<li><a href="../fr433052/index.html">snap & flatpack - trag√©die des communaut√©s</a></li>
<li><a href="../fr433056/index.html">Le minist√®re des Communications resserre les r√®gles relatives aux logiciels contenant des √©l√©ments d'origine √©trang√®re</a></li>
<li><a href="../fr433058/index.html">Quintet comme entit√© de base pour d√©crire un domaine</a></li>
<li><a href="../fr433060/index.html">Pourquoi je ne crois pas aux microbenchmarks</a></li>
<li><a href="../fr433062/index.html">AXIS P1367 vs IDIS DC-B3303X: Comparez les cam√©ras CCTV</a></li>
<li><a href="../fr433064/index.html">Gestion des incidents: ¬´vous ne pouvez pas abandonner¬ª ou l'art de placer des virgules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>