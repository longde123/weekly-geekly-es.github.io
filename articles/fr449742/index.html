<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå™Ô∏è üö± üß£ Processus de d√©veloppement et de test avec Docker et Gitlab CI üßñüèø ‚ÄºÔ∏è üì≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je vous sugg√®re de vous familiariser avec la transcription du rapport d'Alexander Sigachev d'Inventos "Le processus de d√©veloppement et de test avec D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Processus de d√©veloppement et de test avec Docker et Gitlab CI</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449742/"><p>  <strong>Je vous sugg√®re de vous familiariser avec la transcription du rapport d'Alexander Sigachev d'Inventos "Le processus de d√©veloppement et de test avec Docker + Gitlab CI"</strong> </p><br><p>  Ceux qui commencent tout juste √† mettre en ≈ìuvre le processus de d√©veloppement et de test bas√© sur Docker + Gitlab CI posent souvent des questions de base.  Par o√π commencer?  Comment s'organiser?  Comment tester? </p><br><p>  Ce rapport est utile pour vous expliquer de mani√®re structur√©e le processus de d√©veloppement et de test √† l'aide de Docker et Gitlab CI.  Rapport 2017 lui-m√™me.  Je pense que ce rapport vous permet de tirer les bases, la m√©thodologie, l'id√©e, l'exp√©rience d'utilisation. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/lJsqRwULRVA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Peu importe, s'il vous pla√Æt, sous le chat. <a name="habracut"></a></p><br><p>  Je m'appelle Alexander Sigachev.  Je travaille pour Inventos.  Je vais vous parler de mon exp√©rience d'utilisation de Docker et de la fa√ßon dont nous l'impl√©mentons progressivement sur des projets dans l'entreprise. </p><br><p>  Sujet: Processus de d√©veloppement utilisant Docker et Gitlab CI. </p><br><p><img src="https://habrastorage.org/webt/iu/r2/qt/iur2qtjwp2qa_f4vdvmetzii-no.png"></p><br><p>  Ceci est mon deuxi√®me discours sur Docker.  Au moment du premier rapport, nous utilisions Docker uniquement en d√©veloppement sur des machines de d√©veloppement.  Le nombre d'employ√©s qui ont utilis√© Docker √©tait d'environ 2-3 personnes.  Peu √† peu, l'exp√©rience a √©t√© acquise et nous sommes all√©s un peu plus loin.  Lien vers notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premier rapport</a> . </p><br><p>  Que contiendra ce rapport?  Nous partagerons notre exp√©rience sur le r√¢teau que nous avons collect√©, les probl√®mes que nous avons r√©solus.  Pas partout, c'√©tait beau, mais autoris√© √† avancer. </p><br><p>  Notre devise est: docker tout ce que nos mains atteignent. </p><br><p><img src="https://habrastorage.org/webt/rg/wx/pb/rgwxpblyvmjf0hb0ly4eecmntf0.png"></p><br><p>  Quels probl√®mes r√©solvons-nous? </p><br><p>  Lorsqu'une entreprise a plusieurs √©quipes, le programmeur est une ressource partag√©e.  Il y a des √©tapes o√π un programmeur est retir√© d'un projet et donn√© pendant un certain temps √† un autre projet. </p><br><p>  Pour que le programmeur puisse s'y plonger rapidement, il doit t√©l√©charger le code source du projet et lancer l'environnement d√®s que possible, ce qui lui permettra d'avancer davantage dans la r√©solution des probl√®mes de ce projet. </p><br><p>  Habituellement, si vous partez de z√©ro, la documentation du projet n'est pas suffisante.  Seuls les anciens ont des informations sur la configuration.  Les employ√©s installent de mani√®re ind√©pendante leur lieu de travail en un √† deux jours.  Pour acc√©l√©rer cela, nous avons utilis√© Docker. </p><br><p>  La raison suivante est la standardisation des param√®tres dans le d√©veloppement.  D'apr√®s mon exp√©rience, les d√©veloppeurs prennent toujours l'initiative.  Dans tous les cinq cas, un domaine personnalis√© est entr√©, par exemple, vasya.dev.  A proximit√© se trouve le voisin Petya, dont le domaine est petya.dev.  Ils d√©veloppent un site Web ou un composant du syst√®me en utilisant ce nom de domaine. </p><br><p>  Lorsque le syst√®me se d√©veloppe et que ces noms de domaine commencent √† tomber dans la configuration, il y a alors un conflit d'environnements de d√©veloppement et le chemin du site est r√©√©crit. </p><br><p> La m√™me chose se produit avec les param√®tres de la base de donn√©es.  Quelqu'un ne se soucie pas de la s√©curit√© et travaille avec un mot de passe root vide.  Quelqu'un au stade de l'installation MySQL a demand√© un mot de passe et le mot de passe s'est av√©r√© √™tre un 123. Il arrive souvent que la configuration de la base de donn√©es change constamment en fonction de la validation du d√©veloppeur.  Quelqu'un a corrig√©, quelqu'un n'a pas corrig√© la configuration.  Il y avait des astuces lorsque nous avons mis en place une sorte de configuration de test dans <code>.gitignore</code> et chaque d√©veloppeur a d√ª installer une base de donn√©es.  Cela a compliqu√© le processus de d√©marrage.  Entre autres choses, vous devez vous souvenir de la base de donn√©es.  La base de donn√©es doit √™tre initialis√©e, un mot de passe doit √™tre enregistr√©, un utilisateur doit √™tre enregistr√©, une plaque doit √™tre cr√©√©e, etc. </p><br><p>  Un autre probl√®me est les diff√©rentes versions des biblioth√®ques.  Il arrive souvent qu'un d√©veloppeur travaille avec diff√©rents projets.  Il y a un projet Legacy qui a commenc√© il y a cinq ans (√† partir de 2017 - note. Ed.).  Au d√©but, nous avons commenc√© avec MySQL 5.5.  Il y a aussi des projets modernes o√π nous essayons d'introduire des versions plus modernes de MySQL, par exemple 5.7 ou plus (en 2017 - note. Ed.) </p><br><p>  Quiconque travaille avec MySQL sait que ces biblioth√®ques tirent des d√©pendances.  Il est assez probl√©matique de faire fonctionner 2 bases ensemble.  √Ä tout le moins, il est difficile pour les anciens clients de se connecter √† la nouvelle base de donn√©es.  Cela entra√Æne √† son tour plusieurs probl√®mes. </p><br><p>  Le probl√®me suivant est lorsque le d√©veloppeur travaille sur la machine locale, il utilise des ressources locales, des fichiers locaux, de la RAM locale.  Toute l'interaction lors de l'√©laboration de la solution au probl√®me est r√©alis√©e dans le cadre du fait qu'elle fonctionne sur une seule machine.  Un exemple est lorsque nous avons des serveurs principaux dans Production 3, et que le d√©veloppeur enregistre les fichiers dans le r√©pertoire racine et √† partir de l√†, nginx prend les fichiers pour r√©pondre √† la demande.  Lorsqu'un tel code tombe en production, il s'av√®re que le fichier est pr√©sent sur l'un des 3 serveurs. </p><br><p>  Maintenant, la direction des microservices se d√©veloppe.  Lorsque nous divisons nos grandes applications en quelques petits composants qui interagissent les uns avec les autres.  Cela vous permet de s√©lectionner la technologie pour une pile de t√¢ches sp√©cifique.  Il vous permet √©galement de partager le travail et le domaine de responsabilit√© entre les d√©veloppeurs. </p><br><p>  Frondend-developer, d√©veloppant sur JS, n'affecte pratiquement pas Backend.  Le d√©veloppeur backend, √† son tour, d√©veloppe, dans notre cas, Ruby on Rails et n'interf√®re pas avec Frondend.  L'interaction est effectu√©e √† l'aide de l'API. </p><br><p>  En prime, avec Docker, nous avons pu utiliser les ressources de Staging.  Chaque projet, en raison de sa sp√©cificit√©, n√©cessitait certains r√©glages.  Physiquement, il √©tait n√©cessaire de s√©lectionner un serveur virtuel et de les configurer s√©par√©ment, ou de partager une sorte d'environnement variable, et les projets pouvaient s'influencer les uns les autres selon la version des biblioth√®ques. </p><br><p><img src="https://habrastorage.org/webt/ue/fu/5h/uefu5hbokfkhivcwpffwt5xi4hi.png"></p><br><p>  Des outils  Qu'utilisons-nous? </p><br><ul><li>  Directement Docker lui-m√™me.  Dockerfile d√©crit les d√©pendances d'une application. </li><li>  Docker-compose est un bundle qui regroupe quelques-unes de nos applications Docker. </li><li>  GitLab que nous utilisons pour stocker le code source. </li><li>  Nous utilisons GitLab-CI pour l'int√©gration du syst√®me. </li></ul><br><p><img src="https://habrastorage.org/webt/yq/z-/zb/yqz-zbkwsjbklpjpkxf6pzqasya.png"></p><br><p>  Le rapport comprend deux parties. </p><br><p>  La premi√®re partie expliquera comment ex√©cuter Docker sur des machines de d√©veloppement. </p><br><p>  La deuxi√®me partie expliquera comment interagir avec GitLab, comment nous ex√©cutons les tests et comment nous d√©ployons sur Staging. </p><br><p><img src="https://habrastorage.org/webt/tk/4w/lm/tk4wlm_ul847kzentzlw1ikjypq.png"></p><br><p>  Docker est une technologie qui permet (en utilisant une approche d√©clarative) de d√©crire les composants n√©cessaires.  Ceci est un exemple de Dockerfile.  Ici, nous annon√ßons que nous h√©ritons de l'image officielle de Ruby Docker: 2.3.0.  Il contient la version 2.3 de Ruby install√©e.  Nous installons les biblioth√®ques de build n√©cessaires et NodeJS.  Nous d√©crivons que nous cr√©ons le r√©pertoire <code>/app</code> .  Attribuez le r√©pertoire de l'application au r√©pertoire de travail.  Dans ce r√©pertoire, nous pla√ßons le minimum requis Gemfile et Gemfile.lock.  Ensuite, nous construisons les projets qui installent cette image de d√©pendance.  Nous indiquons que le conteneur sera pr√™t √† √©couter sur le port externe 3000. La derni√®re commande est la commande qui lance directement notre application.  Si nous ex√©cutons la commande de d√©marrage du projet, l'application essaiera d'ex√©cuter et de lancer la commande sp√©cifi√©e. </p><br><p><img src="https://habrastorage.org/webt/yc/vn/mp/ycvnmp4_o5pcl9r9hobxbchmntw.png"></p><br><p>  Il s'agit d'un exemple minimal d'un fichier de composition de docker.  Dans ce cas, nous montrons qu'il existe une connexion entre les deux conteneurs.  Il s'agit directement du service de base de donn√©es et du service Web.  Dans la plupart des cas, nos applications Web n√©cessitent une sorte de base de donn√©es comme backend pour le stockage des donn√©es.  Puisque nous utilisons MySQL, l'exemple est avec MySQL - mais rien ne nous emp√™che d'utiliser une sorte de base de donn√©es d'amis (PostgreSQL, Redis). </p><br><p>  Nous prenons l'image MySQL 5.7.14 de la source officielle avec le hub Docker inchang√©.  L'image responsable de notre application Web que nous collectons √† partir du r√©pertoire actuel.  Il, lors du premier lancement, recueille une image pour nous.  Ensuite, il lance la commande que nous ex√©cutons ici.  Si nous revenons en arri√®re, nous verrons que la commande de lancement via Puma a √©t√© d√©finie.  Puma est un service √©crit en Ruby.  Dans le deuxi√®me cas, nous red√©finissons.  Cette commande peut √™tre arbitraire selon nos besoins ou nos t√¢ches. </p><br><p>  Nous d√©crivons √©galement ce dont vous avez besoin pour transf√©rer le port sur notre machine h√¥te √† partir d'un conteneur de 3000 √† 3000 ports.  Cela se fait automatiquement en utilisant iptables et son propre m√©canisme, qui est directement int√©gr√© √† Docker. </p><br><p>  Le d√©veloppeur peut, comme pr√©c√©demment, appliquer √† toute adresse IP disponible, par exemple, 127.0.0.1 adresse IP locale ou externe de la machine. </p><br><p>  La derni√®re ligne indique que le conteneur Web d√©pend du conteneur db.  Lorsque nous appelons le lancement du conteneur Web, docker-compose d√©marre la base de donn√©es pour nous.  D√©j√† au d√©but de la base de donn√©es (en fait, apr√®s le d√©marrage du conteneur! Cela ne garantit pas la disponibilit√© de la base de donn√©es), nous lancerons une application, notre backend. </p><br><p>  Cela vous permet d'√©viter les erreurs lorsque la base de donn√©es n'est pas augment√©e et vous permet d'√©conomiser des ressources lorsque nous arr√™tons le conteneur de base de donn√©es, lib√©rant les ressources pour d'autres projets. </p><br><p><img src="https://habrastorage.org/webt/s3/r1/9g/s3r19gc5pybevceyecewxzsdyxq.png"></p><br><p>  Ce qui nous donne l'utilisation de la base de donn√©es de dockerization sur le projet.  Nous, tous les d√©veloppeurs, corrigeons la version de MySQL.  Cela vous permet d'√©viter certaines erreurs qui peuvent se produire en cas de divergence de versions, lorsque la syntaxe, la configuration et les param√®tres par d√©faut changent.  Cela vous permet de sp√©cifier un nom d'h√¥te commun pour la base de donn√©es, l'identifiant, le mot de passe.  Nous nous √©loignons des noms de zoo et des conflits dans les fichiers de configuration pr√©c√©dents. </p><br><p>  Nous pouvons utiliser une configuration plus optimale pour l'environnement de d√©veloppement, qui sera diff√©rente de la configuration par d√©faut.  MySQL est configur√© par d√©faut sur les machines faibles et ses performances pr√™tes √† l'emploi sont tr√®s faibles. </p><br><p><img src="https://habrastorage.org/webt/b2/qh/uz/b2qhuzt2zgbx5upj9etfnoilrnw.png"></p><br><p>  Docker vous permet d'utiliser l'interpr√©teur Python, Ruby, NodeJS, PHP de la version souhait√©e.  Nous nous d√©barrassons de la n√©cessit√© d'utiliser une sorte de gestionnaire de versions.  Auparavant, Ruby utilisait le package rpm, ce qui permettait de changer la version en fonction du projet.  Cela permet √©galement au conteneur Docker de migrer en douceur le code et de le versionner avec les d√©pendances.  Nous n'avons aucun probl√®me √† comprendre la version de l'interpr√©teur et du code.  Pour mettre √† niveau la version, abaissez l'ancien conteneur et soulevez le nouveau conteneur.  En cas de probl√®me, nous pouvons abaisser le nouveau conteneur, soulever l'ancien conteneur. </p><br><p>  Apr√®s avoir assembl√© l'image, les conteneurs en d√©veloppement et en production seront les m√™mes.  Cela est particuli√®rement vrai pour les grandes installations. </p><br><p><img src="https://habrastorage.org/webt/c3/vy/yx/c3vyyxestdms3fuo6vqpst5hhus.png">  Chez Frontend, nous utilisons JavaScipt et NodeJS. </p><br><p>  Nous avons maintenant le dernier projet chez ReacJS.  Le d√©veloppeur a ex√©cut√© l'int√©gralit√© du conteneur et d√©velopp√© √† l'aide du rechargement √† chaud. </p><br><p>  Ensuite, la t√¢che d'assemblage de JavaScipt est lanc√©e et le code collect√© dans la statique est fourni via les ressources d'√©conomie nginx. </p><br><p><img src="https://habrastorage.org/webt/6k/8y/ds/6k8yds401e1tmspqtvsnpv9hyq8.png"></p><br><p>  Ici, j'ai donn√© un diagramme de notre dernier projet. </p><br><p>  Quelles t√¢ches avez-vous r√©solues?  Nous avons besoin de construire un syst√®me avec lequel les appareils mobiles interagissent.  Ils obtiennent des donn√©es.  L'une des options consiste √† envoyer des notifications push √† cet appareil. </p><br><p>  Qu'avons-nous fait pour cela? </p><br><p>  Nous nous sommes divis√©s en composants d'application tels que: la partie admin dans JS, le backend, qui fonctionne via l'interface REST sous Ruby on Rails.  Le backend interagit avec la base de donn√©es.  Le r√©sultat g√©n√©r√© est donn√© au client.  L'administrateur avec le backend et la base de donn√©es interagit via l'interface REST. </p><br><p>  Nous devions √©galement envoyer des notifications push.  Avant cela, nous avions un projet dans lequel un m√©canisme a √©t√© mis en ≈ìuvre qui est charg√© de fournir des notifications aux plates-formes mobiles. </p><br><p>  Nous avons d√©velopp√© un tel sch√©ma: l'op√©rateur du navigateur interagit avec le panneau d'administration, le panneau d'administration interagit avec le backend, la t√¢che est d'envoyer des notifications Push. </p><br><p>  Les notifications push interagissent avec un autre composant impl√©ment√© sur NodeJS. </p><br><p>  Des files d'attente sont en cours de cr√©ation, puis l'envoi de notifications suit son propre m√©canisme. </p><br><p>  Deux bases de donn√©es sont dessin√©es ici.  Pour le moment, avec l'aide de Docker, nous utilisons 2 bases de donn√©es ind√©pendantes, qui ne sont en aucun cas connect√©es entre elles.  De plus, ils ont un r√©seau virtuel commun et les donn√©es physiques sont stock√©es dans diff√©rents r√©pertoires sur la machine du d√©veloppeur. </p><br><p><img src="https://habrastorage.org/webt/7l/vd/iz/7lvdizkbaiozesiqkfy6zeu0ila.png"></p><br><p>  La m√™me chose, mais en chiffres.  La r√©utilisation du code est importante ici. </p><br><p>  Si plus t√¥t nous avons parl√© de r√©utiliser du code sous forme de biblioth√®ques, dans cet exemple notre service, qui r√©pond aux notifications push, est r√©utilis√© comme un serveur complet.  Il fournit une API.  Et d√©j√† avec notre nouveau d√©veloppement interagit avec lui. </p><br><p>  √Ä cette √©poque, nous utilisions la version 4 de NodeJS.  Maintenant (en 2017 - note. Ed.) Dans les d√©veloppements r√©cents, nous utilisons la version 7 de NodeJS.  Aucun probl√®me dans les nouveaux composants pour attirer de nouvelles versions de biblioth√®ques. </p><br><p>  Si n√©cessaire, vous pouvez refactoriser et mettre √† niveau la version NodeJS du service de notification Push. </p><br><p>  Et si nous pouvons maintenir la compatibilit√© des API, nous pouvons la remplacer par d'autres projets qui ont √©t√© utilis√©s pr√©c√©demment. </p><br><p><img src="https://habrastorage.org/webt/wd/xv/4a/wdxv4acjvor1iz_4ay2iaxhwylg.png"></p><br><p>  De quoi avez-vous besoin pour ajouter Docker?  Ajoutez un Dockerfile √† notre r√©f√©rentiel qui d√©crit les d√©pendances n√©cessaires.  Dans cet exemple, les composants sont ventil√©s par logique.  Il s'agit d'un ensemble minimal de d√©veloppeurs backend. </p><br><p>  Lors de la cr√©ation d'un nouveau projet, cr√©ez un Dockerfile, d√©crivez l'√©cosyst√®me souhait√© (Python, Ruby, NodeJS).  Le docker-compose d√©crit la d√©pendance n√©cessaire - la base de donn√©es.  Nous d√©crivons que nous avons besoin d'une base de donn√©es de telle ou telle version, pour y stocker les donn√©es quelque part. </p><br><p>  Nous utilisons un troisi√®me conteneur s√©par√© avec nginx pour rendre statique.  Vous pouvez t√©l√©charger des photos.  Le backend les place dans un volume pr√©-pr√©par√©, qui est √©galement mont√© dans un conteneur avec nginx, qui donne de l'√©lectricit√© statique. </p><br><p>  Pour stocker la configuration nginx, mysql, nous avons ajout√© le dossier Docker, dans lequel nous stockons les configurations n√©cessaires.  Lorsqu'un d√©veloppeur cr√©e un r√©f√©rentiel git clone sur sa machine, il pr√©pare d√©j√† un projet pour le d√©veloppement local.  La question ne se pose pas quel port ou quels param√®tres appliquer. </p><br><p><img src="https://habrastorage.org/webt/vx/by/f2/vxbyf2i8sss85npgtavlhvgoe10.png"></p><br><p>  De plus, nous avons plusieurs composants: admin, inform-API, push-notifications. </p><br><p>  Afin de tout ex√©cuter, nous avons cr√©√© un autre r√©f√©rentiel appel√© dockerized-app.  Actuellement, nous utilisons plusieurs r√©f√©rentiels jusqu'√† chaque composant.  Ils diff√®rent simplement logiquement - dans GitLab, cela ressemble √† un dossier, et sur la machine du d√©veloppeur, un dossier pour un projet sp√©cifique.  Un niveau ci-dessous sont les composants qui seront combin√©s. </p><br><p><img src="https://habrastorage.org/webt/jd/ny/wq/jdnywqfo2xha1huuqqmnhb1bvpm.png"></p><br><p>  Ceci est un exemple du contenu de l'application dockerized.  Nous apportons √©galement le catalogue Docker ici, dans lequel nous remplissons les configurations requises pour les interactions de tous les composants.  Il y a README.md, qui d√©crit bri√®vement comment d√©marrer un projet. </p><br><p>  Ici, nous avons utilis√© deux fichiers de composition de docker.  Cela se fait afin de pouvoir s'ex√©cuter par √©tapes.  Lorsqu'un d√©veloppeur travaille avec le noyau, il n'a pas besoin de notifications Push, puis il lance simplement le fichier docker-compose et, en cons√©quence, la ressource est enregistr√©e. </p><br><p>  S'il y a un besoin d'int√©gration avec les notifications push, alors docker-compose.yaml et docker-compose-push.yaml sont lanc√©s. </p><br><p>  √âtant donn√© que docker-compose.yaml et docker-compose-push.yaml se trouvent dans le dossier, un seul r√©seau virtuel est automatiquement cr√©√©. </p><br><p><img src="https://habrastorage.org/webt/hb/sj/ua/hbsjuao3tzaozzkhtv97lzhinn8.png"></p><br><p>  Description des composants.  Il s'agit d'un fichier plus avanc√© charg√© de collecter les composants.  Qu'est-ce qui est remarquable ici?  Nous pr√©sentons ici le composant d'√©quilibrage. </p><br><p>  Il s'agit d'une image Docker pr√™te √† l'emploi dans laquelle nginx est lanc√© et d'une application qui √©coute le socket Docker.  Dynamique, lorsque les conteneurs s'allument et s'√©teignent, la configuration nginx se r√©g√©n√®re.  Nous distribuons la gestion des composants par des noms de domaine de troisi√®me niveau. </p><br><p>  Pour l'environnement de d√©veloppement, nous utilisons le domaine .dev - api.informer.dev.  Les applications avec le domaine .dev sont disponibles sur la machine du d√©veloppeur local. </p><br><p>  Ensuite, les configurations sont transf√©r√©es √† chaque projet et tous les projets sont lanc√©s ensemble en m√™me temps. </p><br><p><img src="https://habrastorage.org/webt/ew/i0/_u/ewi0_udkilodmivdjgfjoqt9try.png"></p><br><p>  S'il est repr√©sent√© graphiquement, il s'av√®re que le client est notre navigateur ou un outil avec lequel nous effectuons des demandes pour l'√©quilibreur. </p><br><p>  L'√©quilibreur de nom de domaine d√©termine le conteneur auquel acc√©der. </p><br><p>  Il peut s'agir de nginx, qui donne une zone d'administration JS.  Cela peut √™tre nginx, qui donne l'API ou les fichiers statiques qui sont donn√©s √† nginx sous forme de chargement d'images. </p><br><p>  Le diagramme montre que les conteneurs sont connect√©s par un r√©seau virtuel et sont cach√©s derri√®re le proxy. </p><br><p>  Sur la machine du d√©veloppeur, vous pouvez vous tourner vers le conteneur connaissant l'IP, mais nous ne l'utilisons essentiellement pas.  La n√©cessit√© d'un traitement direct ne se pose pratiquement pas. </p><br><p><img src="https://habrastorage.org/webt/6j/wa/af/6jwaaff9m7e_lwmgvxi88fxxkbi.png"></p><br><p>  Quel exemple chercher pour docker l'application?  √Ä mon avis, un bon exemple est l'image de docker officielle pour MySQL. </p><br><p>  C'est assez compliqu√©.  Il existe de nombreuses versions.  Mais sa fonctionnalit√© vous permet de couvrir de nombreux besoins qui peuvent survenir au cours du d√©veloppement ult√©rieur.  Si vous passez du temps et d√©couvrez comment tout cela interagit, je pense que vous n'aurez aucun probl√®me d'auto-impl√©mentation. </p><br><p>  Dans hub.docker.com, il existe g√©n√©ralement des liens vers github.com, qui fournissent des donn√©es brutes directement √† partir desquelles vous pouvez assembler l'image vous-m√™me. </p><br><p>  Plus loin dans ce r√©f√©rentiel se trouve le script docker-endpoint.sh, qui est responsable de l'initialisation initiale et du traitement ult√©rieur du lancement de l'application. </p><br><p>  Dans cet exemple, il est √©galement possible de configurer √† l'aide de variables d'environnement.  En d√©finissant la variable d'environnement lors du d√©marrage d'un seul conteneur ou via docker-compose, nous pouvons dire que nous devons d√©finir un mot de passe vide pour docker sur pour root dans MySQL ou tout ce que nous voulons. </p><br><p>  Il existe une option pour cr√©er un mot de passe al√©atoire.  Nous disons que nous avons besoin d'un utilisateur, nous devons d√©finir un mot de passe pour l'utilisateur et nous devons cr√©er une base de donn√©es. </p><br><p>  Dans nos projets, nous avons l√©g√®rement unifi√© le Dockerfile, qui est responsable de l'initialisation.  L√†, nous avons corrig√© nos besoins pour ne faire qu'une extension des droits d'utilisateur que l'application utilise.  Cela a permis √† l'avenir de simplement cr√©er une base de donn√©es √† partir de la console d'application.  Les applications Ruby ont une commande pour cr√©er, modifier et supprimer des bases de donn√©es. </p><br><p><img src="https://habrastorage.org/webt/sj/cn/jy/sjcnjytvgchv17vawenbd66upls.png"></p><br><p>  Ceci est un exemple de ce √† quoi ressemble une version particuli√®re de MySQL sur github.com.  Vous pouvez ouvrir le dockerfile et voir comment l'installation se d√©roule l√†-bas. </p><br><p>  Docker-endpoint.sh Script responsable du point d'entr√©e.  Lors de l'initialisation initiale, certaines √©tapes de pr√©paration sont n√©cessaires et toutes ces actions sont effectu√©es uniquement dans le script d'initialisation. </p><br><p><img src="https://habrastorage.org/webt/7h/z4/hy/7hz4hyunbt1ftm38hf9lnmesv3q.png"></p><br><p>  Nous passons √† la deuxi√®me partie. </p><br><p>  Pour stocker le code source, nous sommes pass√©s √† gitlab.  Il s'agit d'un syst√®me assez puissant dot√© d'une interface visuelle. </p><br><p>  L'un des composants de Gitlab est Gitlab CI.  Il vous permet de d√©crire les commandes de suivi qui seront ensuite utilis√©es pour organiser un syst√®me de livraison de code ou ex√©cuter des tests automatiques. </p><br><p>  Rapport sur Gitlab CI 2 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://goo.gl/uohKjI</a> - un rapport du club Ruby Russia - assez d√©taill√© et peut-√™tre qu'il vous int√©ressera. </p><br><p><img src="https://habrastorage.org/webt/9f/s8/pk/9fs8pkzbqq4uozrmd2bu4tq0-dg.png"></p><br><p>  Nous allons maintenant examiner ce qui est n√©cessaire pour activer Gitlab CI.  Pour d√©marrer Gitlab CI, il nous suffit de placer le fichier .gitlab-ci.yml √† la racine du projet. </p><br><p>  Nous d√©crivons ici que nous voulons effectuer une s√©quence d'√©tats tels que tester, d√©ployer. </p><br><p>  Nous ex√©cutons des scripts qui appellent directement docker-compose l'assembly de notre application.  Ceci est un exemple de backend. </p><br><p>  Ensuite, nous disons qu'il est n√©cessaire de conduire des migrations pour changer la base de donn√©es et ex√©cuter des tests. </p><br><p>  Si les scripts sont ex√©cut√©s correctement et ne renvoient pas de code d'erreur, le syst√®me passe en cons√©quence √† la deuxi√®me √©tape du d√©ploiement. </p><br><p>  La phase de d√©ploiement est actuellement mise en ≈ìuvre pour la mise en sc√®ne.  Nous n'avons pas organis√© de red√©marrage en douceur. </p><br><p>  Nous √©teignons de force tous les conteneurs, puis nous soulevons √† nouveau tous les conteneurs, collect√©s au premier stade pendant les tests. </p><br><p>  Nous l'ex√©cutons pour l'environnement variable actuel de migration de base de donn√©es, qui a √©t√© √©crit par les d√©veloppeurs. </p><br><p>  Il y a une note qui s'applique uniquement √† la branche principale. </p><br><p>  Lors du changement d'autres branches n'est pas ex√©cut√©. </p><br><p>  Il est possible d'organiser des d√©ploiements sur les succursales. </p><br><p><img src="https://habrastorage.org/webt/2x/vc/6t/2xvc6tp0zrtrewnpnekatolnipm.png"></p><br><p>  Pour mieux organiser cela, nous devons installer Gitlab Runner. </p><br><p>  Cet utilitaire est √©crit en Golang.  Il s'agit d'un fichier unique, comme c'est la coutume dans le monde de Golang, qui ne n√©cessite aucune d√©pendance. </p><br><p>  Au d√©marrage, nous enregistrons le Gitlab Runner. </p><br><p>  Nous obtenons la cl√© dans l'interface web de Gitlab. </p><br><p>  Ensuite, nous appelons la commande init sur la ligne de commande. </p><br><p>  Configurer Gitlab Runner en mode dialogue (Shell, Docker, VirtualBox, SSH) </p><br><p>  Le code sur Gitlab Runner s'ex√©cutera √† chaque validation, en fonction du param√®tre .gitlab-ci.yml. </p><br><p><img src="https://habrastorage.org/webt/jj/nx/c-/jjnxc-msfkvaey7qs-t6n3kbzww.png"></p><br><p>  √Ä quoi cela ressemble visuellement dans Gitlab dans une interface Web.  Apr√®s avoir connect√© GItlab CI, un indicateur appara√Æt qui indique l'√©tat actuel de la construction. </p><br><p>  Nous voyons qu'un commit a √©t√© fait il y a 4 minutes, qui a pass√© tous les tests et n'a caus√© aucun probl√®me. </p><br><p><img src="https://habrastorage.org/webt/da/vg/3h/davg3h0aqnoewa2xlu3eebuz5jg.png"></p><br><p>  Nous pouvons examiner les versions plus en d√©tail.  Nous voyons ici que deux √âtats sont d√©j√† pass√©s.  Test de l'√©tat et de l'√©tat du d√©ploiement lors de la mise en attente. </p><br><p>  Si nous cliquons sur une construction sp√©cifique, alors il y aura une sortie console des commandes qui ont √©t√© lanc√©es dans le processus selon .gitlab-ci.yml. </p><br><p><img src="https://habrastorage.org/webt/dg/zq/a5/dgzqa5difiuz1yw0e4i99jzgfik.png"></p><br><p>  Voil√† √† quoi ressemble l'histoire de notre produit.  On voit qu'il y a eu des tentatives r√©ussies.  Lorsque des tests sont soumis, il ne passe pas √† l'√©tape suivante et le code de transfert n'est pas mis √† jour. </p><br><p><img src="https://habrastorage.org/webt/cp/g9/rv/cpg9rvvjttpmkvdmi-ve-ugtoh0.png"></p><br><p>  Quelles t√¢ches avons-nous r√©solues lors de la mise en sc√®ne lorsque nous avons introduit Docker?           ,   ,     ,     . </p><br><p>         . </p><br><p>              Docker-compose           . </p><br><p>    ,     Docker .  Docker-compose        . </p><br><p>    ,           . </p><br><p>   ‚Äî   staging   . </p><br><p>            production   80  443 ,     WEB. </p><br><p><img src="https://habrastorage.org/webt/7w/4n/_d/7w4n_dfgts6p7pxijvb6eznq0m0.png"></p><br><p>    ?    Gitlab Runner   . </p><br><p> Gitlab     Gitlab Runner,    -      ,  . </p><br><p>             Gitlab Runner,       . </p><br><p>   nginx-proxy           . </p><br><p>      ,        .       . </p><br><p>        80      ,    . </p><br><p><img src="https://habrastorage.org/webt/az/ke/y8/azkey8kpxp3ruww8fbdc1bnfowk.png"></p><br><p>    ?           root.  root  root  . </p><br><p>     ,    root  ,         root. </p><br><p>         - ,   ,    ,        ,     . </p><br><p>    ?   ,    . </p><br><p>   ,    ? </p><br><p>        ID  (UID)  ID  (GID). </p><br><p>           ID 1000. </p><br><p>               Ubuntu.    Ubuntu    ID 1000. </p><br><p><img src="https://habrastorage.org/webt/wx/th/35/wxth352n7tza8gkpdfcmtaern3m.png"></p><br><p>    ? </p><br><p>    Docker.   ,  . ,    -  ,   . </p><br><p>  ,         . </p><br><p>         . </p><br><p>       Docker    Docker Swarm,    .   -     Docker Swarm. </p><br><p>       .   .    .          web-. </p><br><p><img src="https://habrastorage.org/webt/k8/uh/lw/k8uhlwuir8yffyugvdrupropoba.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr449742/">https://habr.com/ru/post/fr449742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr449722/index.html">Effets de coin</a></li>
<li><a href="../fr449724/index.html">Liquidateurs en acier</a></li>
<li><a href="../fr449728/index.html">Trafic ou cryptage du trafic dans Direct Connect, partie 3</a></li>
<li><a href="../fr449730/index.html">Crypto-monnaie: vit ou meurt? Partie 2. Tendances politiques et √©conomiques</a></li>
<li><a href="../fr449740/index.html">Nous regardons ¬´Window on the city¬ª en haute qualit√©</a></li>
<li><a href="../fr449744/index.html">Mise en cache des r√©sultats de requ√™te globale dans ASP.NET CORE</a></li>
<li><a href="../fr449746/index.html">DockerHub pirat√©</a></li>
<li><a href="../fr449748/index.html">Qui est qui en open source - Partie 2: biographies de geek</a></li>
<li><a href="../fr449750/index.html">Un outil de surveillance de r√©seau ouvert avec des appareils IoT</a></li>
<li><a href="../fr449752/index.html">Cartes magn√©tiques maison pour calculatrice Casio PRO fx-1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>