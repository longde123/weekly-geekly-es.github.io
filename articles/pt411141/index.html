<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíº ü§≠ üï∑Ô∏è "Casa inteligente" no Arduino para uma mudan√ßa de casa üéâ ü•ä üéõÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nada fora do comum, apenas outro controlador Arduino. Com sensores, bobinas e uma p√°gina da web. Mas com caracter√≠sticas pr√≥prias e aplica√ß√£o pr√°tica ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"Casa inteligente" no Arduino para uma mudan√ßa de casa</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411141/"><img src="https://habrastorage.org/webt/7o/3k/or/7o3kora9koagtgemf_xxr71mlkk.jpeg"><br><br>  Nada fora do comum, apenas outro controlador Arduino.  Com sensores, bobinas e uma p√°gina da web.  Mas com caracter√≠sticas pr√≥prias e aplica√ß√£o pr√°tica muito espec√≠fica, ainda que bastante banal - a inclus√£o remota de aquecimento el√©trico no pa√≠s.  As aspas no cabe√ßalho n√£o s√£o aleat√≥rias, o controlador n√£o √© uma casa inteligente na vers√£o atual, mas serve como uma boa base para isso.  <i>(nota - esta frase foi adicionada em 12/04/18 com base nos coment√°rios).</i> <br><br>  Principais recursos: <br><br><ul><li>  Sensor de par√¢metros de rede el√©trica - medidor el√©trico ‚ÄúNeva‚Äù conforme RS-485; </li><li>  Modifica√ß√£o remota da p√°gina da web de controle no cart√£o SD; </li><li>  Inclus√£o confi√°vel de um grupo de sensores de temperatura de Dallas em longas filas; </li><li>  Gr√°ficos de altera√ß√µes de par√¢metros sem envolver servi√ßos em nuvem; </li><li>  Solu√ß√µes √† prova de falhas (watchdog externo, UPS, reinicializa√ß√£o autom√°tica do roteador); </li><li>  Prote√ß√£o da blindagem da Internet contra congelamento durante a interfer√™ncia de rel√©s de pot√™ncia; </li><li>  Projeto completo em um gabinete de trilho DIN. </li></ul><a name="habracut"></a><br>  Eu fazia esse sistema lentamente, como entretenimento, de tempos em tempos lan√ßando o projeto por meses ... Demorou cerca de um ano e meio da ideia √† implementa√ß√£o :) <br><br>  Como antes eu n√£o tinha neg√≥cios com microcontroladores, comecei com o kit inicial com aliexpress, brinquei com LEDs, bot√µes e sensores, entendi alguma coisa e comecei a construir um controlador para controle e monitoramento remotos.  Bem, a ‚Äúcasa inteligente‚Äù n√£o √© direta, √© claro, mas algo assim. <br><br>  O objetivo pr√°tico foi definido primeiro - ligar remotamente o aquecimento no pa√≠s.  Ainda n√£o consegui construir uma casa (minhas m√£os n√£o chegaram, hein), mas tenho uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">casa de ver√£o</a> maravilhosa e confort√°vel, com carne picada e aquecida por convectores el√©tricos.  Aque√ßa uma casa de mudan√ßa que esfriou durante a semana at√© a noite de sexta-feira - uma oportunidade muito tentadora na esta√ß√£o fria. <br><br>  No entanto, a tarefa de controle remoto de carga acabou sendo bastante trivial.  O Arduino mais o escudo da Internet, um esbo√ßo pronto da Internet e os rolos j√° clicam nas marcas de sele√ß√£o na p√°gina da web.  De alguma forma, o objetivo pr√°tico foi alcan√ßado de maneira muito r√°pida e simples.  E foi chato.  Eu queria algo mais interessante. <br><br>  Estabeleci um segundo objetivo pr√°tico - monitorar o consumo atual na rede de chal√©s de ver√£o.  Eu tenho sensores de corrente despretensiosos para testes, brinquei.  Tudo funcionou bem, mas essa op√ß√£o n√£o era adequada para o trabalho de combate.  N√£o consegui encontrar sensores mais potentes do que no 5A, mas precisava de pelo menos 25A. <br><br>  E tive a ideia de usar um medidor de eletricidade como sensor de pot√™ncia.  E foi um √≥timo pensamento!  E eu criei esse dispositivo e vi que era bom!  N√£o sem dificuldades, mas conclu√≠ esta tarefa perfeitamente, com um sentimento de profunda satisfa√ß√£o, e vou contar abaixo :). <br><br>  <b>Funcional</b> <br><br>  A primeira (e at√© agora a √∫ltima) vers√£o de combate do controlador "smart home" possui esta funcionalidade: <br><br><ul><li>  Controle manual remoto da ativa√ß√£o do rel√© de pot√™ncia atrav√©s de um navegador e monitoramento de seu status atual; </li><li>  Monitoramento remoto dos par√¢metros de uma rede de alimenta√ß√£o trif√°sica (tens√£o, corrente, frequ√™ncia e muito mais lixo desnecess√°rio, que depois desliguei); </li><li>  Monitoramento remoto das leituras de um medidor de eletricidade de duas tarifas; </li><li>  Monitoramento remoto de um grupo de sensores de temperatura; </li><li>  Registro de dados e grava√ß√£o de eventos em um cart√£o de mem√≥ria; </li><li>  Exibir no navegador de dados de todos os sensores para o dia selecionado na forma de gr√°ficos. </li></ul><br>  <b>Ideologia</b> <br><br>  O princ√≠pio de construir todo o sistema - sem usar servi√ßos em nuvem de terceiros e servidores de coleta e exibi√ß√£o de dados.  Isso n√£o √© bom nem ruim.  No est√°gio inicial da "constru√ß√£o inteligente", esse esquema √© suficiente e simples.  Embora imponha certas restri√ß√µes ao uso. <br><br>  O Arduino com um escudo da Internet √© o √∫nico servidor da Web no sistema.  A p√°gina da web com a interface de gerenciamento √© armazenada no cart√£o de mem√≥ria da Internet e transmitida ao navegador quando acessada pelo endere√ßo IP especificado.  A intera√ß√£o adicional da interface do usu√°rio com o Arduino √© realizada por meio de scripts java, cujos corpos n√£o est√£o incorporados na p√°gina da web, mas s√£o armazenados no meu armazenamento de arquivos dom√©sticos com acesso √† Internet.  Essa abordagem reduz o peso da p√°gina da web, o que acelera a leitura do cart√£o SD e permite modificar mais r√°pida e facilmente o c√≥digo do script. <br><br>  A leitura do registro de dados para exibi√ß√£o de gr√°ficos √© realizada a partir do cart√£o de mem√≥ria mediante solicita√ß√£o (pressionando um bot√£o no navegador).  Os dados s√£o exibidos apenas na sess√£o atual da p√°gina do navegador, n√£o s√£o salvos em nenhum lugar e, quando voc√™ recarrega a p√°gina, deve l√™-la novamente.  Isso √© um pouco de ideologia, j√° que a leitura de um cart√£o de mem√≥ria √© bastante lenta e a obten√ß√£o de uma quantidade di√°ria de dados pode levar um ou dois minutos (houve uma id√©ia de refazer o formato de armazenamento de dados para reduzir seu tamanho e acelerar a leitura). <br><br>  Os valores atuais dos sensores s√£o exibidos na p√°gina e atualizados em tempo real com a frequ√™ncia do ciclo de loop, que eu tenho √© de aproximadamente 1 Hz. <br><br>  N√£o h√° "intelig√™ncia" no algoritmo agora.  Se vou admoestar o algoritmo no futuro - n√£o sei, por enquanto a vers√£o atual √© completamente satisfat√≥ria para mim. <br><br>  <b>Topologia de rede</b> <br><br>  Na casa de campo, Internet m√≥vel Yota (modem usb + roteador wifi).  N√£o h√° um endere√ßo IP fixo e tamb√©m n√£o h√° como obt√™-lo, nem por dinheiro.  E mesmo que n√£o haja um endere√ßo IP branco din√¢mico, o DynDNS n√£o √© aplic√°vel.  Somente o endere√ßo IP cinza da rede interna do Yota.  O IPota Yota n√£o suporta (pelo menos para 2017, este √© o caso).  Portanto, encontrei apenas uma maneira de acessar o roteador do pa√≠s de fora - VPN. <br><br>  Em casa (na cidade), internet com fio com um endere√ßo IP fixo branco.  Roteador, seguido pelo armazenamento em rede.  Um servidor VPN foi criado neste roteador dom√©stico.  O roteador do pa√≠s est√° configurado para aumentar o t√∫nel PPTP VPN para o roteador dom√©stico. <br><br>  O controlador no Arduino est√° conectado √† porta LAN do roteador do pa√≠s e fica atr√°s do NAT, a 80¬™ porta √© encaminhada para ele.  Assim, eu posso acessar o Arduino apenas da minha VPN.  Assim, a LAN dom√©stica e a VPN que eu tenho s√£o dois segmentos da mesma sub-rede, o acesso √© direto l√°.  No computador do escrit√≥rio e no smartphone, ele configurou uma conex√£o VPN e tamb√©m obteve acesso ao Arduino.  N√£o √© muito conveniente de usar, mas funciona.  Sim, e seguran√ßa relativa √© fornecida - sem autoriza√ß√£o na minha VPN, ningu√©m mais pode acessar a p√°gina de gerenciamento do controlador. <br><br>  O gargalo √© o t√∫nel da VPN para o roteador do pa√≠s.  Cai periodicamente.  Al√©m disso, √© a conex√£o PPTP que est√° sendo desativada, o acesso √† Internet permanece.  E o mais desagrad√°vel √© que, quando a conex√£o PPTP √© interrompida, ela n√£o aumenta mais por si s√≥.  Mesmo reiniciar o roteador n√£o salva.  Apenas uma reinicializa√ß√£o completa de sua fonte de alimenta√ß√£o com um modem USB e n√£o imediatamente.  Voc√™ precisa deslig√°-lo, aguarde 10 minutos, ligue-o novamente.  Sorte - bom, n√£o - a pr√≥xima itera√ß√£o.  O motivo, de acordo com o suporte t√©cnico da Zyxel, √© que o operador celular bloqueia pacotes PPTP, pois um lado envia corretamente, o outro escuta corretamente, mas os dados n√£o chegam (eu tenho roteadores Zyxel nas duas extremidades do t√∫nel da VPN).  A culpa √© de Yota, mas conseguir algo intelig√≠vel a partir deles √© imposs√≠vel.  Ou talvez n√£o Yota. <br><br>  <b>C√£o de guarda</b> <br><br>  Para garantir uma opera√ß√£o relativamente suave da VPN, eu uso um c√£o de guarda do programa de <strike>muletas</strike> - o roteador do pa√≠s √© alimentado por um rel√© de energia controlado pela Arduina e, assim que o servidor VPN para de executar o ping (tamb√©m envia um ping para a Arduina), depois de 10 minutos a energia √© removida do roteador por 10 minutos e depois o roteador novamente. Ele √© ativado e espera-se estabelecer uma conex√£o PPTP dentro de 5 minutos.  Se n√£o houver conex√£o, a pr√≥xima itera√ß√£o.  √Äs vezes, esse composto funciona de maneira est√°vel por semanas e at√© meses, e √†s vezes come√ßa a quebrar quase diariamente.  Nenhuma outra maneira de resolver o problema ainda foi vista.  Como eu j√° disse, o Yota n√£o suporta IPv6, n√£o d√° ou vende IP branco a f√≠sicos, n√£o h√° outro provedor com tarifas normais e certamente n√£o h√° tr√°fego ilimitado.  No entanto, esta decis√£o, apesar de uma muleta, mas executa sua tarefa muito bem.  Agora eu sempre tenho uma conex√£o, com muito poucas exce√ß√µes, quando chego ao momento da reinicializa√ß√£o. <br><br>  Al√©m do software, tamb√©m implementei um watchdog de hardware.  Apenas no caso.  O controlador deve funcionar por semanas e at√© algumas vezes por meses na aus√™ncia de mim, e n√£o travar.  Como toda essa economia se comportaria em grandes desvantagens, n√£o me era conhecido, ent√£o eu estava seguro.  O c√£o de guarda do Atmega n√£o funcionou para mim porque eu n√£o trabalhei no Arduino Mega "pronto para uso" e, para faz√™-lo funcionar, tive que me divertir muito.  Este problema est√° bem descrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Al√©m disso, ele tem um intervalo m√°ximo de 8 segundos, o que me pareceu insuficiente.  Portanto, apliquei um chip de vigil√¢ncia especializado TPL5000DGST, cujo intervalo √© definido por uma combina√ß√£o de tr√™s pinos e pode chegar a 64 segundos, o que me conv√©m perfeitamente.  Para esse chip, comprei uma pequena placa de ensaio, soldou e fixou no conector com portas IO da Arduina (a foto ser√° mais baixa na se√ß√£o de montagem).  Os testes mostraram o funcionamento confi√°vel desse c√£o de guarda, e eu queria saber com que frequ√™ncia ele funcionar√° na realidade.  Para fazer isso, adicionei uma vari√°vel ao c√≥digo do programa em que a hora e a data em que o programa foi iniciado est√£o armazenadas e essas informa√ß√µes s√£o exibidas na p√°gina da web de controle.  A pr√°tica demonstrou que, ao contr√°rio de uma VPN, o controlador funciona sem problemas por um longo tempo e o timer do watchdog nunca foi √∫til (enquanto escrevia o artigo, funcionava pela primeira vez, n√£o era em v√£o).  O tempo de opera√ß√£o cont√≠nua alcan√ßou mais de 3 meses e poderia ter sido maior se eu n√£o precisasse corrigir algo no c√≥digo de tempos em tempos e atualizar o controlador. <br><br>  <b>O sensor dos par√¢metros da rede de fornecimento de energia - o medidor el√©trico Neva</b> <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/845/f35/bd5/845f35bd5d12bc60384f1aa0bb1506aa.jpg" width="200"></a> <br><br>  Como mencionei acima, na minha opini√£o, nada melhor e mais preciso do que um medidor de eletricidade digital moderno com uma interface externa de acesso a dados pode ser encontrado como um sensor dos par√¢metros da fonte de alimenta√ß√£o.  Eu escolhi o contador Neva da empresa Taypit em S√£o Petersburgo com a interface RS-485. <br><br>  Enfatizo que um medidor el√©trico com fios da 485¬™ interface permanentemente conectada a ele n√£o pode ser oficialmente utilizado como medidor ( <b>atualiza√ß√£o</b> : nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coment√°rios, eles</a> sugeriram que isso era permitido).  Portanto, na rede el√©trica da cabana, coloquei dois contadores em s√©rie.  O primeiro √© um medidor oficial de eletricidade, lacrado e registrado, localizado na placa de rua.  O segundo √© o meu sensor de fonte de alimenta√ß√£o, n√£o selado e n√£o contabilizado, do qual a empresa de vendas de energia n√£o se importa, porque n√£o se importa com tudo o que √© instalado ap√≥s o dispositivo de medi√ß√£o.  Esse medidor el√©trico j√° est√° localizado no painel dentro da casa de troca, e no mesmo painel tamb√©m h√° um controlador no Arduino, mas mais sobre isso mais tarde. <br><br>  Na casa de campo, tenho uma rede de alimenta√ß√£o trif√°sica.  Na cidade, s√≥ posso depurar em uma fase √∫nica.  Portanto, adquiri dois metros, um Neva MT-324 trif√°sico e um Neva MT-124 monof√°sico.  A depura√ß√£o inicial do controlador foi realizada sobre a mesa em um contador trif√°sico com uma fase monof√°sica conectada e, em seguida, o instalava regularmente no escudo dacha no modo de opera√ß√£o de combate.  A depura√ß√£o das modifica√ß√µes subseq√ºentes do software j√° foi feita em um contador monof√°sico mais barato na tabela: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/a5a/5cb/6fb/a5a5cb6fb932dea11badc7f06376e22d.jpg" width="640"></a> <br><br>  Para conectar o medidor ao Arduino, √© necess√°rio um conversor de n√≠vel RS-485 para TTL: <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/258/07f/e5a/25807fe5acb55ec27d079d024a24b1f0.jpg" width="200"></a> <br><br>  Al√©m disso, para trabalhar com o contador, voc√™ precisa de uma porta serial gratuita no Arduino.  Infelizmente, o Arduino Uno possui apenas uma porta serial; se voc√™ a colocar debaixo do balc√£o, ter√° que perder a sa√≠da de depura√ß√£o das informa√ß√µes de texto (monitor de porta) e, sem isso, seria imposs√≠vel escrever um esbo√ßo.  Portanto, eu uso o Arduino Mega, que possui v√°rias portas seriais.  Seria poss√≠vel implementar a segunda porta serial softovo atrav√©s das portas digitais do Arduino, mas n√£o encontrei uma biblioteca adequada com a capacidade de alterar outras configura√ß√µes de porta, exceto a velocidade.  E as configura√ß√µes da porta do contador s√£o diferentes das configura√ß√µes padr√£o: taxa de 9600 bits, 7 bits de dados, 1 bit de parada, controle de paridade - par.  Felizmente, o objeto Serial padr√£o no Arduino permite que voc√™ fa√ßa essas configura√ß√µes. <br><br>  Era relativamente f√°cil obter o protocolo de troca com o contador - o fabricante do contador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em dom√≠nio p√∫blico</a> possui um programa para ler par√¢metros no Windows, que tamb√©m possui um monitor de porta.  Para conectar o medidor a um computador, usei o conversor de interface MOXA 232/432 / 485USB.  Algum tempo para an√°lise visual dos pacotes - e eu selecionei os principais comandos. <br><br>  No entanto, isso n√£o me pareceu suficiente e entrei em contato com o fabricante por e-mail.  Ap√≥s um m√™s de correspond√™ncia com Typit, finalmente consegui obter uma lista completa de comandos com interpreta√ß√£o: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Par√¢metro de codifica√ß√£o MT3XX E4S</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Par√¢metro de codifica√ß√£o NEVA MT124 AS OP (E4P)</a> <br><br>  <b>atualiza√ß√£o 10.28.2019</b> : Explica√ß√µes dos comandos.  Os comandos na tabela s√£o representados como caracteres de texto.  Ou seja, onde custa 0 (zero), voc√™ precisa enviar 0x30.  Pontos e asteriscos s√£o separadores de beleza, n√£o significam nada e voc√™ n√£o precisa envi√°-los.  No final do comando, √© adicionado um byte de soma de verifica√ß√£o, calculado levando em considera√ß√£o o prefixo e o postfix do comando, que n√£o s√£o indicados na tabela.  O prefixo para todos os comandos de leitura √© 0x01 0x52 0x31 0x02.  Esse postfix √© 0x28 0x29 0x03.  No entanto, o envio de um prefixo n√£o √© necess√°rio e um postfix parece obrigat√≥rio.  Exemplo: comando de leitura de data 09.09.02 * FF.  Na verdade, voc√™ precisa passar os c√≥digos de caracteres de texto 000902FF.  Ou seja, 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46.  Adicione o prefixo e o postfix, obtemos o conjunto 0x01 0x52 0x31 0x02 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03.  Lemos a soma de verifica√ß√£o como xor de todos os bytes menos 1 e adicionamos o byte recebido no final.  O prefixo √© descartado como opcional.  Como resultado, enviamos isso para o contador - 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03 0x68.  O in√≠cio do ciclo de troca deve ser precedido pelos comandos de inicializa√ß√£o da troca, no esbo√ßo abaixo, esses comandos s√£o marcados como // In√≠cio 1, 2, 3. Depois que a troca √© inicializada, voc√™ pode ler os dados do contador no ciclo por um tempo arbitrariamente longo, mas depois de perder a comunica√ß√£o e talvez ap√≥s uma falta prolongada de troca por outros motivos, seja necess√°ria a reinicializa√ß√£o. <br><br>  Al√©m disso, o problema t√©cnico √© escrever um ciclo de pesquisa de par√¢metros no Arduino e exibi-los para iniciantes no monitor de portas.  O tempo de um ciclo foi de cerca de um segundo.  No entanto, na vers√£o final do projeto, com registro de dados em uma unidade flash e sensores de temperatura de polling, esse tempo aumentou para 4 segundos.  Isso n√£o me agradou e teve que mergulhar na otimiza√ß√£o.  Como resultado, consegui novamente um segundo intervalo sem perder a funcionalidade.  A prop√≥sito, reescrevi o esbo√ßo duas ou tr√™s vezes at√© encontrar a arquitetura correta e os algoritmos econ√¥micos. <br><br>  <b>Implementa√ß√£o de software de troca com um contador</b> <br><br>  O c√≥digo √© extra√≠do do contexto do meu grande esbo√ßo de trabalho.  Compilado, mas desta forma, nunca o executei.  Dou apenas como exemplo, e n√£o como um programa de trabalho conclu√≠do.  Embora, em teoria, tudo deva funcionar dessa forma. <br><br>  O c√≥digo foi escrito para dois tipos de contadores simultaneamente, o MT-124 monof√°sico e o MT-324 trif√°sico.  O tipo de contador √© selecionado no programa automaticamente pela palavra de resposta do comando de inicializa√ß√£o. <br><br>  Cito o c√≥digo como est√°, sem beleza e sem coment√°rios adicionais, exceto aqueles que escrevi para mim.  E sim, eu n√£o sou programador e nem estudo para isso, ent√£o voc√™ n√£o deve me criticar pela qualidade do c√≥digo, mas pode aprender a codificar: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">EnergyMeterNeva.ino</a> <br><br>  Uma enorme vantagem adicional do medidor de eletricidade √© um rel√≥gio em tempo real confi√°vel e preciso.  Eu n√£o precisava fornecer ao sistema um m√≥dulo adicional, que ainda precisa ser encontrado n√£o apenas de qualquer forma, mas de alta qualidade.  O tempo atual exato at√© o segundo que recebo do contador, entre outros dados.  Sim, no que diz respeito ao tempo at√¥mico, o tempo do contador √© ligeiramente alterado (alguns segundos), n√£o sei com o que ele est√° conectado, uma configura√ß√£o de f√°brica de baixa qualidade ou qualquer outra coisa, mas a precis√£o √© excelente, apenas com um leve vi√©s. <br><br>  Em raros momentos, quando a energia da cabana √© desligada e o medidor fica indispon√≠vel, recebo a hora atual do temporizador interno da Arduina.  Quando o medidor el√©trico est√° funcionando e seus dados est√£o dispon√≠veis, reescrevo o temporizador interno da Arduina com o valor do medidor em cada loop do loop.  Quando o contador cai - a hora atual continua a marcar no temporizador Arduina. <br><br>  Al√©m de ler os par√¢metros, o contador, √© claro, pode ser programado.  Ou seja, a interface funciona tanto para leitura quanto para escrita.  No entanto, com tais dificuldades, eu estava tentando obter um protocolo para ler comandos que nem sequer indiquei ao fabricante sobre a solicita√ß√£o de um protocolo de grava√ß√£o.  Primeiro, eu n√£o precisava, exceto talvez um pouco de tempo para mov√™-lo.  Em segundo lugar, suspeito que esses dados n√£o sejam mais p√∫blicos, pois podem ser usados ‚Äã‚Äãpara fins fraudulentos. <br><br>  <b>Sensores de temperatura</b> <br><br>  Eu j√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">realizei um</a> teste de sensores de temperatura com um exemplo de esbo√ßo separadamente anteriormente.         .     .              1-Wire.       0.5 ,          0.0625 .             .             .        . <br><br>           .    ,         ,     ,          delay(750).       ‚Äî       ,     (  750  ),     .    ,        ‚Äî     ,     .        LOOP ,          .             ‚Äî  LOOP   1-1.5 ,     . <br><br>        ¬´85¬ª  ¬´0¬ª.    ,     ,            .        ‚Äî       .      ,    .      ,      (   )    . <br><br>        -, -     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DS18x20_Temperature.ino</a> <br><br>                    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TempSensors_DS18B20.ino</a> <br><br>       1-Wire     4.7      .         SMD-,          5.1 ,    (           ).   . <br><br>            (+5, gnd  data),  9 ,  .            .        .   ‚Äî   .   ‚Äî   ,                .         ,       ,      .           ,          .    : <br><br> <a href=""><img height="300" src="https://habrastorage.org/getpro/habr/post_images/84e/1a3/b3d/84e1a3b3d64983af4236a6dad5458a52.jpg" width="640"></a> <br><br>         ,    ,   . <br><br>      ,  ‚Äî   ,    ,       .         ,             (.  -   ). -       , -       . <br><br>    ,  ..   (      )      ‚Ä¶  ?        ,       .       .               ,    . <br><br>         25 .     ‚Äî 5  10 ,         .    .       .  ,        .      (    ),     . <br><br> <b> </b> <br><br>        Ethernet shield.       ,       ,   . <br><br>      .    -,       ()  -   .       ,    . <br><br>         ,    ‚Äî  ,    ‚Äî   . <br><br>   -   ,              ,    html  : <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/1e0/2fa/c9e/1e02fac9e6e1e8c5a16d0a7c07667f94.png" width="475"></a> <br><br>  html-     ,          .                 JSON. <br><br>                .                . ,          .      html-,  ,   java-     - ,       .    ,     ,   .  S√≥ isso.  . <br><br>       . <br>  html-  : <br><br><pre><code class="plaintext hljs">&lt;script type="text/javascript" src="http://domain/send_HTM.js"&gt;&lt;/script&gt;&lt;/pre&gt; &lt;pre style="font-size: 14px;"&gt;&lt;form&gt; &lt;br&gt;&lt;br&gt; CONTROL.HTM:&lt;br&gt; &lt;textarea cols="100" rows="20" wrap="off" id="htm"&gt;&lt;/textarea&gt;&lt;br&gt; &lt;input type="button" value="" onclick="send_HTM();"&gt;&lt;br&gt; &lt;div id="progress" style="display:none"&gt; &lt;div id="label"&gt;  :&lt;/div&gt; &lt;div style="width:800px;border:1px solid #000"&gt; &lt;div id="bar" style="background:#00f;height:10px;width:0px"&gt;&lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/form&gt;</code> </pre> <br>  O bot√£o "Enviar" inicia o seguinte script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Java</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">send_HTM.js</a> <br><br>  No esbo√ßo da fun√ß√£o para processar solicita√ß√µes de servidor da Web por prefixos na solicita√ß√£o 'CONTROL.HTM' (iniciar o envio do arquivo), 'htmlineN' (n√∫mero da linha de envio) e 'END_CONTROL.HTM' (final do envio do arquivo), determinamos as seguintes a√ß√µes: <br><br><pre> <code class="plaintext hljs">File acceptHtmFile; ................ if (fl_accept_htm) //  'CONTROL.HTM' { SD.remove(CTRL_HTM); acceptHtmFile = SD.open(CTRL_HTM, FILE_WRITE); //     if (!acceptHtmFile) //      -    { #ifdef DEBUG_SD Serial.println("SD-card not found"); #endif client.print("FAIL"); client.stop(); } else client.print("OK_OPEN_FILE"); acceptHtmMode = true; break; } if (fl_htmline) //  'htmlineN' { int b = acceptHtmFile.println(tag); if (b == 0) { client.print("FAIL"); acceptHtmMode = false; cntHtmModeIteration = 0; } else { client.print("OK"); } cntHtmModeIteration = 0; break; } if (fl_endhtm) //  'END_CONTROL.HTM' { SD.remove(CONTROL_HTM); acceptHtmFile.close(); File htmlFile = SD.open(CONTROL_HTM, FILE_WRITE); //    acceptHtmFile = SD.open(CTRL_HTM); //    for (int i = 0; i &lt; acceptHtmFile.size(); i++) { digitalWrite(PIN_WATCHDOG_DONE, 1); htmlFile.write(acceptHtmFile.read()); digitalWrite(PIN_WATCHDOG_DONE, 0); } acceptHtmFile.close(); htmlFile.close(); client.print("OK_CLOSE_FILE"); acceptHtmMode = false; cntHtmModeIteration = 0; break; }</code> </pre> <br>  O CONTROL_HTM e CTRL_HTM define aqui os nomes dos arquivos html.  O primeiro √© o arquivo principal, o segundo √© o arquivo de buffer.  Na matriz de tag char, encontra-se o texto da string recebida, selecionada na solicita√ß√£o.  A l√≥gica √© a seguinte: ao receber dados, eles s√£o gravados no arquivo em spool; no final da recep√ß√£o, o arquivo em spool √© substitu√≠do pelo principal.  Eu ainda n√£o conseguia entender como simplesmente renomear os arquivos, a biblioteca padr√£o do SD n√£o tem essa fun√ß√£o, uma c√≥pia est√∫pida de caractere por caractere, que leva muito tempo. <br><br>  Seria conveniente armazenar o c√≥digo da p√°gina da web de controle n√£o no cart√£o de mem√≥ria do controlador, mas na m√°quina do cliente, ou fazer o download de algum recurso externo.  Mas a proibi√ß√£o de solicita√ß√µes entre dom√≠nios n√£o permite isso.  Javascripts podem enviar seus pedidos apenas para o norte a partir do qual eles foram carregados.  Nesse caso, os corpos dos javascripts podem ser carregados de qualquer lugar; √© importante apenas de onde a p√°gina com a chamada foi carregada. <br><br>  <b>Registro de dados</b> <br><br>  A blindagem Ethernet possui um slot para cart√£o micro-SD a bordo.  Foi por causa de sua presen√ßa que decidi gravar dados nos arquivos de log.  Para trabalhar com um cart√£o de mem√≥ria, h√° tamb√©m uma biblioteca embutida, e gerenciar a leitura e grava√ß√£o de arquivos com ele geralmente √© elementar. <br><br>  Para economizar a quantidade de dados, criei o algoritmo de log para que o registro s√≥ ocorra quando os dados forem alterados em mais de um limite predeterminado.  Para temperatura √© 0,1 ¬∞, para tens√£o √© 0,2V.  Os dados de um dia s√£o gravados em um arquivo.  Em zero horas, um novo arquivo √© criado.  Eu escolhi o formato de texto sem formata√ß√£o, com delimitadores, para que voc√™ possa controlar rapidamente o conte√∫do dos arquivos durante a depura√ß√£o, e haveria uma capacidade simples de carregar no Excel. <br><br>  As restri√ß√µes de design n√£o permitem inserir / remover convenientemente um cart√£o de mem√≥ria; portanto, usei um cart√£o grande.  De acordo com meus c√°lculos, ele ser√° preenchido por v√°rios anos, ap√≥s os quais ser√° necess√°rio desmontar o gabinete, remover o cart√£o de mem√≥ria e limp√°-lo. <br><br>  N√£o vejo o ponto de registrar o c√≥digo, tudo √© completamente trivial - um registro banal de texto em um arquivo.  E esse c√≥digo est√° espalhado por todo o esbo√ßo (n√£o apenas os par√¢metros dos sensores s√£o registrados, mas tamb√©m uma variedade de eventos √∫nicos), √© dif√≠cil isolar. <br><br>  <b>Gr√°ficos</b> <br><br>  Como um mecanismo de gr√°ficos, eu uso a biblioteca de visualiza√ß√£o javascript <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">amavart</a> altamente flex√≠vel.  A biblioteca √© gratuita e dispon√≠vel para download e uso offline.  Tamb√©m localizei esta biblioteca no meu NAS com acesso permanente √† Internet.  Conect√°-lo e us√°-lo com as configura√ß√µes padr√£o n√£o √© dif√≠cil, no entanto, para obter a visualiza√ß√£o de que eu precisava, tive que mexer muito.  Um grande n√∫mero de exemplos no site e a disponibilidade de documenta√ß√£o detalhada ajudaram. <br><br>  Por exemplo, darei o javascript do desenho de hor√°rios.  Por si s√≥, √© in√∫til, pois s√≥ funciona em conjunto com um servidor Web e uma p√°gina html e pode estar vinculado a outros scripts (faz muito tempo, n√£o me lembro de todos os detalhes).  Mas as configura√ß√µes de apar√™ncia dos meus gr√°ficos est√£o contidas nele e voc√™ pode obt√™-las a partir da√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">get_log.js</a> <br><br>  A grande vantagem da biblioteca amchart √© que ela pode desenhar os gr√°ficos corretos a partir de dados rasgados.  Como mencionei acima, no log eu salvo os dados somente quando eles mudam.  Ou seja, isso acontece de forma ass√≠ncrona e aleat√≥ria.  Pode n√£o haver novos dados por v√°rios minutos e, em alguns segundos, eles ser√£o alterados v√°rias vezes.  Por conseguinte, as entradas no log acompanham intervalos de tempo arbitr√°rios.  O Amchart leva isso em considera√ß√£o por si s√≥ ao renderizar, n√£o preciso interpolar os dados antes da renderiza√ß√£o.  Acabei de enviar a matriz de dados como est√° e vejo um gr√°fico bonito que √© uniforme no tempo. <br><br>  Descobri apenas uma desvantagem desta biblioteca - ela n√£o sabe como (bem, ou ainda n√£o entendo) atualizar humanamente os gr√°ficos em tempo real.  Voc√™ pode adicionar novos dados aos j√° existentes, mas o redesenho √© feito sempre que todo o conjunto de dados, e isso torna o navegador muito mais lento.  No entanto, a pr√≥pria ideologia de ler dados do Arduina para renderizar sob demanda a partir do navegador √© falha por sua n√£o otimiza√ß√£o, portanto n√£o havia sentido em lutar por uma atualiza√ß√£o r√°pida em tempo real. <br><br>  A solu√ß√£o correta seria organizar um servidor separado para armazenar e visualizar dados, onde da Arduina, em tempo real, os dados cairiam um pouco e seriam armazenados no banco de dados, e de onde poderiam ser rapidamente enviados ao usu√°rio em um navegador para visualiza√ß√£o. <br><br>  Agora os gr√°ficos s√£o assim (no exemplo do dia em que n√£o h√° ningu√©m na casa de mudan√ßa e, consequentemente, n√£o h√° consumo de energia).  Quando dados atuais ocorrem, a escala √© definida automaticamente para que tudo se encaixe perfeitamente e os valores dos n√≠veis atuais apare√ßam no eixo vertical: <br><br> <a href=""><img height="246" src="https://habrastorage.org/getpro/habr/post_images/12e/6d5/7e5/12e6d57e563012ba95a5407a1f96a88e.png" width="640"></a> <br><br>  Os gr√°ficos s√£o exibidos na mesma p√°gina em que o controle ocorre, diretamente abaixo do bloco de controle principal. <br><br>  N√£o forne√ßo intencionalmente um conjunto completo de fontes do projeto por v√°rios motivos: <br><br><ol><li>  Ele n√£o pode ser iniciado como em qualquer outra rede que n√£o seja a minha, pois n√£o tentei tornar o projeto port√°til e est√° rigidamente vinculado aos meus endere√ßos e √† minha topologia de rede. </li><li>  Estou certo de que a ideologia geral do projeto sofre muitos problemas, pois esta √© minha primeira tentativa na √°rea em que n√£o sou bom em entender.  Portanto, n√£o proponho a ningu√©m todo o projeto para repeti√ß√£o neste formul√°rio.  Compartilhei apenas aqueles momentos em que estou menos confiante. </li><li>  O projeto j√° existe h√° muito e muito tempo, e nunca me lembrarei de todos os detalhes e n√£o poderei explicar v√°rias solu√ß√µes.  O volume do esbo√ßo √© muito grande (para meus padr√µes, cerca de 2 mil linhas), existem mais de uma d√∫zia de scripts Java em exibi√ß√£o, n√£o fiz um diagrama esquem√°tico do ferro.  Ou seja, n√£o posso ajudar no aconselhamento sobre a maioria dos problemas. </li></ol><br>  <b>Assembl√©ia</b> <br><br>  Desde o in√≠cio, estabeleci o objetivo - criar um dispositivo acabado, e n√£o apenas um layout com um monte de postagens sobre a mesa: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/721/a45/ba3/721a45ba3d536cfbf0d3b302c32cdd3b.jpg" width="640"></a> <br><br>  E imediatamente decidi que quero colocar o dispositivo dentro do painel el√©trico.  H√° comida, um balc√£o e, em geral, √© conveniente. <br><br>  Para isso, foi necess√°rio um caso dinrek.  No come√ßo, pensei em desenvolv√™-lo e imprimi-lo em uma impressora 3D.  Mas eu n√£o tenho minha pr√≥pria impressora 3D, e o que meus colegas trabalhando nas impressoras montadas automaticamente n√£o me agradaram na qualidade da apar√™ncia.  Encontrei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">caixas prontas</a> em um trilho DIN (de v√°rios tamanhos) para venda, elas parecem boas, s√£o f√°ceis de usar (dobr√°veis) e tamb√©m h√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cart√£o cego</a> pronto para elas. <br><br>  Comprei o maior gabinete, para que n√£o apenas o Arduino com o escudo da Internet pudesse caber nele, mas tamb√©m um rel√© para alternar a carga: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/674/493/325/6744933251f7abeed45267d51d2c2e59.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/aed/1dc/c27/aed1dcc279af58de00af5e68f30b8aac.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fe1/cbb/ab7/fe1cbbab760347fda7df0edf2b0a9c09.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0f9/13b/250/0f913b2504dcef41d4156e23015f5fef.jpg" width="640"></a> <br><br>  Em seguida, foi um processo longo e fascinante de instalar todas as tripas do gabinete.  Sob esse neg√≥cio, eu at√© adquiri um ferro de soldar maravilhoso com a fun√ß√£o dormir (os ferros de soldar que eu possu√≠a ainda eram da √©poca sovi√©tica): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8f7/cff/613/8f7cff613a071eb2ee93cd09c3286622.jpg" width="640"></a> <br><br>  Para instala√ß√£o, comprei v√°rios tipos de racks, parafusos, arruelas e porcas.  Primeira montagem de montagem: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c28/ff1/ac7/c28ff1ac7b46d25bf58714949091c7d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fd9/c60/001/fd9c6000193beeb0a82cf14d7ca56cda.jpg" width="640"></a> <br><br>  Para conectar os fios aos contatos superiores, era necess√°rio o uso de pinos dobrados, caso contr√°rio n√£o cabia no gabinete: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/47a/8eb/107/47a8eb107e5b12253386f61745103774.jpg" width="640"></a> <br><br>  As arruelas isolantes tiveram que ser cortadas em alguns lugares: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4da/e6f/55f/4dae6f55f161153a1d544c8aae3c883e.jpg" width="640"></a> <br><br>  E, em alguns lugares, ele se dobra mais perversamente, eleva o parafuso na luva e apara a luva de forma elaborada: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/6ec/226/736/6ec226736d2576706170487958208959.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/f98/c43/fb9/f98c43fb9ddb0da9149193dd92ef465d.jpg" width="640"></a> <br><br>  Para uma √∫nica mudan√ßa, n√£o havia pontos de articula√ß√£o suficientes, portanto, ela dependia de apenas dois pontos: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/398/f46/4b6/398f464b6f08b4372bf8792edb0018b9.jpg" width="640"></a> <br><br>  Montagem montada com blocos de terminais: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/bd8/17d/1cb/bd817d1cbc854ac47c7427c26dc0f0c8.jpg" width="640"></a> <br><br>  Ent√£o a nave come√ßou a crescer gradualmente em fios.  A placa foi usada apenas para a fia√ß√£o el√©trica e para conectar aos blocos de terminais.  Para conex√µes de sinal, usei o fio MS-16 (eu gosto mais), para poder n√£o passar pela tens√£o (at√© 100 V), ent√£o MGTF: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/cc3/5ae/01d/cc35ae01d9728523e1edbe1e3d0ae79d.jpg" width="640"></a> <br><br>  Montei LEDs no painel frontal, soldou os resistores limitadores de corrente diretamente nas pernas dos LEDs e os fechei com termorretrata√ß√£o: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4a3/299/840/4a3299840a442a416396a30c81a25e2e.jpg" width="640"></a> <br><br>  Como resultado, obtivemos um recheio t√£o barbudo: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/5c7/042/3e7/5c70423e7c3acdbe8f892054ffe010c5.jpg" width="640"></a> <br><br>  E aqui est√° um cachecol com um microcircuito de vigil√¢ncia, protegido nas entranhas da minha cria√ß√£o, logo acima do conversor de n√≠vel RS-485-TTL: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/73d/e5b/318/73de5b318ba3e6299168d634cdbaefe2.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/798/c40/61f/798c4061fa2167591312ff1d40adf5a4.jpg" width="640"></a> <br><br>  Toda a estrutura √© dobr√°vel, tudo pode ser removido, desconectado e substitu√≠do sem solda, exceto por um cachecol com um olho de cachorro, que √© soldado aos pinos do conector, revestido em v√°rias portas de E / S da Arduina. <br><br>  Na caixa: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c0b/918/cd8/c0b918cd83cbf30b11bc6b47e150b60f.jpg" width="640"></a> <br><br>  Cortei aberturas para os conectores da Arduina na parede pl√°stica do gabinete.  Primeiro, fiz os furos exatamente de acordo com o tamanho dos conectores, mas a montagem do gabinete deve ser iniciada na diagonal (caso contr√°rio, simplesmente n√£o funciona) e os conectores n√£o passaram, tive que desperdi√ßar um pouco: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7a1/5bd/21c/7a15bd21c6767e24b78a867b95952606.jpg" width="640"></a> <br><br>  Ao ligar o produto acabado sobre a mesa, tudo funcionou imediatamente: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/262/a25/4f6/262a254f611519e81f429b00b2440758.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4ff/cb6/10c/4ffcb610c648d20fe7c386f821178ad9.jpg" width="640"></a> <br><br>  No painel frontal trouxe: <br><br><ul><li>  Quatro LEDs vermelhos - indica√ß√£o de carga; </li><li>  Dois verdes - comunica√ß√£o com o contador e com o servidor VPN; </li><li>  Dois amarelos s√£o de reposi√ß√£o; </li><li>  Um amarelo - indica√ß√£o de reinicializa√ß√£o do roteador; </li><li>  Um vermelho √© nutri√ß√£o; </li><li>  E um bot√£o de reset. </li></ul><br>  Para obter 5 volts de 220, usei uma fonte de alimenta√ß√£o dinerey com ajuste do n√≠vel de sa√≠da, a energia foi fornecida diretamente ao microcontrolador, ignorando o conversor de entrada de 7 a 12 volts.  Isso foi conveniente por v√°rios motivos.  Em primeiro lugar, a pot√™ncia do conversor embutido em algum momento n√£o foi suficiente, a corrente √© limitada.  Em segundo lugar, ainda era necess√°rio fornecer 5 volts ao rel√©.  Em terceiro lugar, o painel √© um fator de forma conveniente do dinrek em termos de instala√ß√£o.  Portanto, aqui: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/801/0f7/aad/8010f7aad941e5f4619553fe7433c58e.jpg" width="640"></a> <br><br><br>  <b>Teste</b> <b><br></b> <br>  Tudo estava virado sobre a mesa, tudo funcionava como deveria, era hora de instalar o controlador no escudo e verific√°-lo no modo de combate. <br><br>  Mas primeiro, eu conectei tudo "no ranho", literalmente empurrando toda a tripa para outra blindagem, de baixa corrente, para testar os sensores de temperatura em condi√ß√µes reais em longas filas dispostas em um canal de cabo com ~ 220V: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/d3c/3a8/b45/d3c3a8b45a90075449e23e24f4ae37e7.jpg" width="640"></a> <br><br>  Como voc√™ pode ver na foto acima, at√© agora eu tentei controlar a reinicializa√ß√£o do roteador usando o soquete Senseit "inteligente".  No entanto, este dispositivo com um custo insano de 5 mil (para 2016) acabou sendo extremamente buggy e mal-humorado.  Durante o ano de uso, ele me for√ßou repetidamente a chegar inesperadamente √† cabana em momentos inoportunos, a fim de remover manualmente esse milagre da engenharia e do marketing de uma profunda desvantagem em termos de comunica√ß√µes GSM.  Com a transi√ß√£o para o meu controlador Arduino, que se mostrou mais confi√°vel do que um exemplo, fiquei aliviado em deixar esse lixo "profissional" em uma bela caixa em uma caixa e esquec√™-lo. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/efa/f91/91b/efaf9191b1dffa362e86e302d4858d34.jpg" width="640"></a> <br><br>  O teste foi bem-sucedido, n√£o houve falhas e foi poss√≠vel prosseguir para a instala√ß√£o final em um local regular: <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/887/ac8/320/887ac8320dca67597c4f979806e22b93.jpg" width="472"></a> <br><br>  Sim, este √© o escudo ABB TwinLine 800x300x225 IP55, no valor de 25 mil rublos.  sem enchimento (e enchimento por outros 15 mil aproximadamente).  E sim, ele √© instalado em uma casa de troca de 6x2.  Todo mundo tem suas pr√≥prias baratas.  Sim, eu mesmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coletei toda a eletricidade</a> .  E ele construiu uma casa de mudan√ßa tamb√©m, sim.  N√£o, eu n√£o sou eletricista.  E n√£o um construtor. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4d4/c1b/3e5/4d4c1b3e5710dfb4a87299bb1f55fbfd.jpg" width="640"></a> <br><br>  Nas profundezas da blindagem, localizei uma pequena fonte de alimenta√ß√£o ininterrupta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Powercom WOW 300</a> , l√° seu LED verde acende e, √† esquerda e acima - sua tomada de entrada: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/b6a/991/299/b6a991299668084c3ae8265d064e1910.jpg" width="640"></a> <br><br>  Dura aproximadamente 40 minutos de dura√ß√£o da bateria do dispositivo Arduino, um roteador com modem USB e Wi-Fi e c√¢meras de vigil√¢ncia IP Full HD. <br><br>  E aqui voc√™ pode ver os plugues de alimenta√ß√£o brancos de dois consumidores ininterruptos - a fonte de alimenta√ß√£o Arduino e a blindagem de baixa corrente, onde est√£o localizados o roteador e a fonte de alimenta√ß√£o da c√¢mera de vigil√¢ncia externa.  Essa linha passa por uma interrup√ß√£o no contator, controlado pelo Arduino, exatamente para o mesmo watchdog de software que reinicia o roteador na energia em caso de queda da VPN (a c√¢mera reinicia ao mesmo tempo, embora n√£o seja necess√°rio).  As principais linhas de pares tran√ßados dos sensores de temperatura est√£o conectadas ao controlador: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0b8/fd7/50b/0b8fd750b2a17afd69eb55b6d56bf709.jpg" width="640"></a> <br><br>  Devo dizer que nunca confiaria na troca de uma carga poderosa para pequenos rel√©s chineses azuis, apesar dos par√¢metros desses rel√©s, que parecem permitir que isso seja feito.  Portanto, o uso de contatores modulares normais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Legrand cat. No. 4 125 01</a> com a possibilidade de controle manual foi imediatamente estabelecido.  Ou seja, os rel√©s dentro do corpo do controlador controlam os contatores, e os contatores j√° controlam a carga.  √â confi√°vel.  Mas a energia do roteador e da c√¢mera √© realizada apenas atrav√©s deste pequeno rel√© chin√™s azul, a corrente √© pequena, por isso √© poss√≠vel. <br><br>  No primeiro lan√ßamento de combate, fiquei muito decepcionado.  Na mesa, experimentei tudo, exceto a carga.  Porque  Os contatores clicam e, portanto, fica claro que eles mudar√£o a carga.  Mas n√£o, era necess√°rio experimentar.  Eletroconvectores poderosos introduziram interfer√™ncia no sistema no momento da abertura dos contatos, o que levou a um congelamento garantido da blindagem da Internet.  E para tir√°-lo do s√©rio s√≥ era poss√≠vel removendo a energia, uma simples redefini√ß√£o n√£o ajudava.  Pesquisado no Google - sim, este chin√™s tem um problema.  E a biblioteca n√£o lida com essa situa√ß√£o.  Ou seja, o peda√ßo de ferro √© ruim e o software n√£o √© muito bom. <br><br>  Eu j√° pensei que tudo tinha sumido.  At√© encomendei rel√©s de estado s√≥lido, mas eles, esc√≥ria, s√£o maiores em altura e n√£o se encaixavam no meu design.  Mas ent√£o pensei que ainda seria poss√≠vel suprimir a interfer√™ncia.  Pesquisado novamente, encontrou capacitores especiais para supress√£o de ru√≠do (os chamados capacitores do tipo X).  Basta conect√°-los em paralelo ao enrolamento de controle dos contatores, e eis que eis!  Hangups desapareceu completamente.  No √∫ltimo ano de opera√ß√£o, nenhum caso foi registrado: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7ae/198/80c/7ae19880c09be755c8421266a4ba29df.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c25/e89/cb2/c25e89cb2e1f8ed607f736bfdfc0cd20.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/6b8/a25/f65/6b8a25f65c6f9de23a3b1ad57a91f97d.jpg" width="472"></a> <br><br>  Mas desta forma, voc√™ pode olhar dentro da caixa: <br><br> <a href=""><img height="480" src="https://habrastorage.org/getpro/habr/post_images/776/7c3/7c9/7767c37c908537a36b5bd763a39fc7bc.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/827/6fa/818/8276fa8186818314c5b4ce8516ef6f04.jpg" width="480"></a> <br><br>  Bem, a vista final da viseira com o plastron (nenhum plugue foi fornecido no kit): <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/e4c/231/5ac/e4c2315ac67af993ed83151f58896e85.jpg" width="472"></a> <br><br>  Para depura√ß√£o e intermit√™ncia, o cabo USB √© conectado ao controlador e armazenado dentro da blindagem atr√°s de uma porta fechada (ele n√£o ser√° conectado temporariamente a esta foto): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/e51/1ce/92d/e511ce92de3e8e090aa842ff540034d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8fa/202/f5a/8fa202f5abf1eeb6bbca9192dc82c719.jpg" width="640"></a> <br><br>  O sistema est√° funcionando h√° quase um ano, sobreviveu a geadas de at√© 20 graus sem problemas. <br><br>  Em geral, estou satisfeito com o resultado.  No entanto, para tarefas mais ou menos funcionais, o Arduino √© claramente fraco.  Mais de uma vez, fiquei sem mem√≥ria e tive que cortar e otimizar.  E a velocidade do trabalho, especialmente com um cart√£o de mem√≥ria, n√£o combina comigo.  Portanto, as futuras implementa√ß√µes de tais of√≠cios, se houver, gostaria de basear-me em algo mais poderoso.  Colegas me d√£o um Raspberry Pi, uma boa op√ß√£o, eu acho. <br><br>  Algu√©m pode dizer: ‚ÄúQuantas dificuldades existem para uma tarefa t√£o primitiva‚Äù e provavelmente estar√° certa.  Para mim, todo esse empreendimento √© um hobby, com pouca justificativa para o significado.  Portanto, eu estava procurando entretenimento em tudo o que podia :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt411141/">https://habr.com/ru/post/pt411141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt411131/index.html">A primeira competi√ß√£o em rob√≥tica subaqu√°tica para estudantes das s√©ries 1 a 4</a></li>
<li><a href="../pt411133/index.html">Brinquedos robotizados para crian√ßas: para aprendizagem e entretenimento</a></li>
<li><a href="../pt411135/index.html">Par√¢metros</a></li>
<li><a href="../pt411137/index.html">VTC - Centro de Comunica√ß√£o por Sat√©lite (Vladivostok)</a></li>
<li><a href="../pt411139/index.html">O mist√©rio com a vida √∫til dos n√™utrons se torna mais complicado, e a mat√©ria escura ainda n√£o √© vis√≠vel</a></li>
<li><a href="../pt411143/index.html">Programando Microcontroladores Modernos: Palestra 1</a></li>
<li><a href="../pt411145/index.html">Meus pequenos rel√©s: o computador Brainfuck √© uma realidade</a></li>
<li><a href="../pt411147/index.html">Grandes pontos de planetas gigantes</a></li>
<li><a href="../pt411149/index.html">Previs√£o TRIZ de sistemas descentralizados e da sociedade ciber-f√≠sica de 2035</a></li>
<li><a href="../pt411151/index.html">iMX6ULL. Transi√ß√£o para m√≥dulos de processador</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>