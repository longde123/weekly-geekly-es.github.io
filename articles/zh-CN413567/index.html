<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏹 🕟 👩🏻‍🎓 Spring Boot中的微服务入门 🙎🏽 📉 💂🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！ 

 在本文中，我们将演示使用Consul服务注册表，用于所有支架的Spring Boot，依赖项注入，用于组装的Maven以及Spring REST和Java RESTful Jersey / JaxRS API创建RESTful微服务的基本组件。 

 微服务的主要优势： 



- ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spring Boot中的微服务入门</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/413567/"> 大家好！ <br><br> 在本文中，我们将演示使用Consul服务注册表，用于所有支架的Spring Boot，依赖项注入，用于组装的Maven以及Spring REST和Java RESTful Jersey / JaxRS API创建RESTful微服务的基本组件。 <br><br> 微服务的主要优势： <br><br><ul><li> 微服务可帮助您放松代码 </li></ul><br><ul><li> 微服务允许不同的团队使用独立技术来处理小型组件，从而提供更安全，更频繁的部署Spring Boot支持各种实现来创建REST API </li></ul><br><ul><li> 服务的发现和调用不依赖于服务平台 </li></ul><br><ul><li>  Swagger创建健壮的API文档和调用接口 </li></ul><br> 如果您还没有使用微服务，那么您还没有成功地进入技术感知曲线上的早期追随者阶段，这可能是正确的开始时间。 <br><br><img src="https://habrastorage.org/webt/o_/ze/uu/o_zeuux9s9xpxbxjvitgdmiqox4.png"><a name="habracut"></a><br><br> 在过去的二十年中，企业在SDLC流程中变得非常灵活，但通常，我们的应用程序仍然是整体的，其巨大的jar支持市场上的所有各种API和版本。 但是目前，人们希望有更多的精益，DevOps流程，并且该功能正变得“无服务器”。 重构为微服务可以减少代码和资源的纠缠，使程序集更小，发布更安全，API更稳定。 <br><br> 在本文中，我们将创建一个简单的股票市场投资组合管理应用程序，客户可以调用该应用程序来评估他们的股票投资组合（股票行情和价格）。 投资组合微服务将检索客户的投资组合，将其发送到定价微服务以应用最新价格，然后返回经过充分估值和小计的投资组合，并通过剩余呼叫进行演示。 <br><br><img src="https://habrastorage.org/webt/qe/ea/aw/qeeaawb8mapjtsibfyw3nro_ue8.png"><br><br> 在开始创建微服务之前，让我们通过设置Consul来准备环境。 <br><br><h3> 下载领事 </h3><br> 我们将使用Hashicorp Consul来发现服务，因此请访问<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.consul.io/downloads.html</a>并下载适用于Windows，Linux，Mac等的Consul。 这将为您提供一个可执行文件，您需要将其添加到路径中。 <br><br><h3> 启动领事 </h3><br> 在命令提示符下，以开发人员模式启动Consul： <br><br><pre><code class="bash hljs">consul agent -dev</code> </pre> <br> 要验证它是否正在运行，请转到浏览器并访问Consul接口<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http：// localhost：8500</a> 。 如果一切顺利，领事必须报告他还健在。 通过单击领事服务（左侧），您将收到其他信息（右侧）。 <br><br><img src="https://habrastorage.org/webt/9p/4m/2t/9p4m2taqogtv6ahb3dnpmvvt2oc.png"><br><br> 如果目前有任何问题，请确保将Consul添加到执行路径，并且端口8500和8600可用。 <br><br><h3> 编译一个SpringBoot应用程序 </h3><br> 我们将使用集成在大多数IDE中的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Spring Initializr</a>来构架我们的SpringBoot应用程序。 下面的屏幕截图使用IntelliJ IDEA。 <br><br> 选择“文件/新项目”以打开新项目模板，然后选择“ Spring Initializr”。 <br><br><img src="https://habrastorage.org/webt/xb/j5/3t/xbj53tf_bfr5dauohwqmv9gkdmm.png"><br><br> 通常，您可以通过SpringBoot Initializr网页<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">start.spring.io</a>填写在线表单来设置不带IDE的脚手架，该表单将为您的空项目创建一个zip文件，可供下载。 <br><br> 单击“下一步”并填写项目元数据。 使用以下配置： <br><br><img src="https://habrastorage.org/webt/l0/_p/zk/l0_pzkpsppbplfrusj7suogqmyk.png"><br><br> 单击“下一步”选择依赖项，然后在搜索依赖项中输入“ Jersey”和“ Consul Discovery”。 添加以下依赖项： <br><br><img src="https://habrastorage.org/webt/jt/t8/l8/jtt8l89pauvzyu_oo_riav_na4e.png"><br><br> 单击“下一步”以指示项目的名称及其位置。 保留默认名称“ portfolio”并指定项目的首选位置，然后单击“完成”以创建并打开项目： <br><br><img src="https://habrastorage.org/webt/un/xl/gh/unxlgh-ufplppxqhuyfyfdoug5g.png"><br><br> 我们可以使用生成的application.properties，但是SpringBoot也可以识别YAML格式，该格式更易于显示，因此我们将其重命名为application.yml。 <br><br> 我们称微服务为“投资组合服务”。 我们可以指定端口或使用端口0，以便应用程序使用可用端口。 在本例中，我们将使用57116。如果您将此服务作为Docker容器托管，则可以将其映射到您选择的任何端口。 为应用程序命名并通过将以下内容添加到application.yml中来指定我们的端口： <br><br><pre> <code class="bash hljs">spring: application: name: portfolio-service server: port: 57116</code> </pre><br> 为了使我们的服务可用，请在我们的SpringBoot应用程序类中添加注释。 打开PortfolioApplication应用程序，并在类声明上方添加@EnableDiscoveryClient。 <br><br> 确认进口。 该类应如下所示： <br><br><pre> <code class="bash hljs">package com.restms.demo.portfolio; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; . . . @SpringBootApplication @EnableDiscoveryClient public class PortfolioApplication { public static void main(String[] args) { SpringApplication.run(PortfolioApplication.class, args); } }</code> </pre><br>  （为了演示微服务如何由独立的平台组成，我们将使用Jersey来提供此服务，并使用Spring REST来提供）。 <br> 要在Jersey上配置RESTful Web服务，我们需要指定ResourceConfig配置类。 添加JerseyConfig类（为演示起见，我们将其保存在与应用程序类相同的包中）。 它应该看起来像这样，加上正确的包和导入： <br><br><pre> <code class="bash hljs">@Configuration @ApplicationPath(<span class="hljs-string"><span class="hljs-string">"portfolios"</span></span>) public class JerseyConfig extends ResourceConfig { public <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JerseyConfig</span></span></span></span>() { register(PortfolioImpl.class); } }</code> </pre><br> 请注意，它继承自ResourceConfig，以将其指定为Jersey配置类。  @ApplicationPath（“ portfolios”）属性定义了调用的上下文，这意味着调用必须以“ portfolioios”路径元素开始。  （如果省略，默认上下文为“ /”）。 <br><br>  PortfolioImpl类将服务于两个请求：投资组合/客户/ {customer-id}返回所有投资组合，投资组合/客户/ {customer-id} /投资组合/ {portfolio-id}返回一个投资组合。 投资组合由一组股票和该股票持有的股票数量组成。  （为演示起见，有三个标识为0、1和2的客户，每个客户都有三个标识为0、1和2的投资组合）。 <br><br> 您的IDE将要求您创建PortfolioImpl； 现在就做。 为了演示，将其添加到同一包中。 输入以下代码并确认所有导入： <br><br><pre> <code class="bash hljs">@Component @Path(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) public class PortfolioImpl implements InitializingBean { private Object[][][][] clientPortfolios; @GET @Path(<span class="hljs-string"><span class="hljs-string">"customer/{customer-id}"</span></span>) @Produces(MediaType.APPLICATION_JSON) // a portfolio consists of an array of arrays, each containing an array of // stock ticker and associated shares public Object[][][] getPortfolios(@PathParam(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) int customerId) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> clientPortfolios[customerId]; } @GET @Path(<span class="hljs-string"><span class="hljs-string">"customer/{customer-id}/portfolio/{portfolio-id}"</span></span>) @Produces(MediaType.APPLICATION_JSON) public Object[][] getPortfolio(@PathParam(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) int customerId, @PathParam(<span class="hljs-string"><span class="hljs-string">"portfolio-id"</span></span>) int portfolioId) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> getPortfolios(customerId)[portfolioId]; } @Override public void afterPropertiesSet() throws Exception { Object[][][][] clientPortfolios = { { // 3 customers, 3 portfolios each {new Object[]{<span class="hljs-string"><span class="hljs-string">"JPM"</span></span>, 10201}, new Object[]{<span class="hljs-string"><span class="hljs-string">"GE"</span></span>, 20400}, new Object[]{<span class="hljs-string"><span class="hljs-string">"UTX"</span></span>, 38892}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"KO"</span></span>, 12449}, new Object[]{<span class="hljs-string"><span class="hljs-string">"JPM"</span></span>, 23454}, new Object[]{<span class="hljs-string"><span class="hljs-string">"MRK"</span></span>, 45344}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"WMT"</span></span>, 39583}, new Object[]{<span class="hljs-string"><span class="hljs-string">"DIS"</span></span>, 95867}, new Object[]{<span class="hljs-string"><span class="hljs-string">"TRV"</span></span>, 384756}}, }, { {new Object[]{<span class="hljs-string"><span class="hljs-string">"GE"</span></span>, 38475}, new Object[]{<span class="hljs-string"><span class="hljs-string">"MCD"</span></span>, 12395}, new Object[]{<span class="hljs-string"><span class="hljs-string">"IBM"</span></span>, 91234}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"VZ"</span></span>, 22342}, new Object[]{<span class="hljs-string"><span class="hljs-string">"AXP"</span></span>, 385432}, new Object[]{<span class="hljs-string"><span class="hljs-string">"UTX"</span></span>, 23432}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"IBM"</span></span>, 18343}, new Object[]{<span class="hljs-string"><span class="hljs-string">"DIS"</span></span>, 45673}, new Object[]{<span class="hljs-string"><span class="hljs-string">"AAPL"</span></span>, 23456}}, }, { {new Object[]{<span class="hljs-string"><span class="hljs-string">"AXP"</span></span>, 34543}, new Object[]{<span class="hljs-string"><span class="hljs-string">"TRV"</span></span>, 55322}, new Object[]{<span class="hljs-string"><span class="hljs-string">"NKE"</span></span>, 45642}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"CVX"</span></span>, 44332}, new Object[]{<span class="hljs-string"><span class="hljs-string">"JPM"</span></span>, 12453}, new Object[]{<span class="hljs-string"><span class="hljs-string">"JNJ"</span></span>, 45433}}, {new Object[]{<span class="hljs-string"><span class="hljs-string">"MRK"</span></span>, 32346}, new Object[]{<span class="hljs-string"><span class="hljs-string">"UTX"</span></span>, 46532}, new Object[]{<span class="hljs-string"><span class="hljs-string">"TRV"</span></span>, 45663}}, } }; this.clientPortfolios = clientPortfolios; } }</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Component</a>注释将其指定为Spring组件的类，并将其公开为端点。 关于类声明的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">路径</a>注释声明该类是通过路径元素“ /”访问的，并且通过投资组合/客户/ {customer-id}和投资组合/ customer / {customer-id} /投资组合/ {portfolio- id}，正如我们从方法的注释中看到的那样。 请注意，路径（“ /”）是默认路径，但我们留作参考。 通过@GETannotation将方法指定为HTTP GET。 我们的方法旨在返回一个数组，并带有注释以返回Json，因此它返回一个Json数组。 请注意，在方法签名中如何使用“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">路径</a>参数”批注从显示的查询中提取显示的参数。 <br><br>  （对于我们的演示，我们返回硬编码的值。当然，实际上，该实现将查询数据库或其他服务或数据源，而不是硬编码。） <br> 现在创建一个项目并运行它。 如果使用IntelliJ，它将创建一个默认可执行文件，因此只需单击绿色的“运行”箭头。 您也可以使用 <br><br><pre> <code class="bash hljs">mvn spring-boot:run</code> </pre> <br> 或者，您可以执行maven安装并使用java -jar指向目标目录中生成的jar来运行应用程序： <br><br><pre> <code class="bash hljs">java -jar target\portfolio-0.0.1-SNAPSHOT.jar</code> </pre> <br> 现在，我们应该在Consul中看到此服务，因此让我们回到浏览器，下载<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http：//本地主机：8500 / ui /＃/ dc1 /服务</a> （如果已经存在，则进行更新）。 <br><br><img src="https://habrastorage.org/webt/bs/ab/2v/bsab2vs-dswpzy7nmpevmtphdma.png"><br><br> 嗯，我们在那看到了我们的服务，但显示为失败。 这是因为领事期望我们的服务发出“健康”的心跳信号。 <br> 为了生成心跳信号，我们可以在应用程序的pom中添加对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Spring Actuator</a>服务的依赖。 <br><br><pre> <code class="bash hljs">&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt;</code> </pre><br> 当我们处于pom状态时，请注意Consul启动程序和Jersey启动程序之间与Jersey发生版本冲突。 为了解决这个问题，将泽西岛首发指定为第一个瘾君子。 <br><br> 您的pom现在应包含以下依赖项： <br><br><pre> <code class="bash hljs">&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jersey&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;</code> </pre><br> 通过重新启动Consul，投资组合服务将显示出令人满意的状态： <br><br><img src="https://habrastorage.org/webt/uf/oq/qr/ufoqqrtcnxnlwazqy-ozrp1lceo.png"><br><br> 现在，在组合服务中有两个传输节点：一个是我们对组合服务的实现，另一个是心跳。 <br><br> 让我们检查已分配的端口。 您可以在应用程序的输出中看到： <br><br><pre> <code class="bash hljs">INFO 19792 --- [ main] sbcetTomcatEmbeddedServletContainer : Tomcat started on port(s): 57116 (http)</code> </pre> <br> 您还可以直接在Consul用户界面中查看端口。 单击“客户服务”，然后选择“服务'客户服务'检查链接”链接，该链接显示服务端口，在这种情况下为57116。 <br><br><img src="https://habrastorage.org/webt/s_/up/ce/s_upceczzu0xupqioariurhawz8.png"><br><br> 请求<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">HTTP：// //本地主机：57116 /资产/客户/ 1 /资产/ 2</a> ，您将看到json数组[[“ IBM”，18343]，[“ DIS”，45673]，[“ AAPL”，23456]] <br><br> 我们的第一个微服务开始营业！ <br><br><h3> 定价服务 </h3><br> 接下来，我们将使用Spring RestController而不是Jersey来创建定价服务。 <br><br> 定价服务将接受客户标识符和投资组合标识符作为参数，并将使用RestTemplate请求投资组合服务，接收报价器和股票，以及返回当前价格。  （我不需要告诉您这些值是假新闻，因此不要用它们来做出交易决策！） <br><br> 使用以下信息创建一个新项目： <br><br><img src="https://habrastorage.org/webt/gz/sy/sm/gzsysm7_cgynyxucuhgrcfoxhbs.png"><br><br> 这次，选择Web，Consul Discovery和Actuator依赖项： <br><br><img src="https://habrastorage.org/webt/1l/ke/ov/1lkeovxzix2pxqwmodb2efdw-zu.png"><br><br> 将项目的默认名称保留为“ pricing”，然后在您选择的目录中创建一个项目。 <br><br> 这次，我们将使用application.properties而不是application.yml。 <br> 在application.properties中将名称和端口设置为： <br><br><pre> <code class="bash hljs">spring.application.name=pricing server.port=57216</code> </pre> <br> 用@EnableDiscoveryClient注释PricingApplication。 该类应该看起来像这样，加上包和导入。 <br><br><pre> <code class="bash hljs">@SpringBootApplication @EnableDiscoveryClient public class PricingApplication { public static void main(String[] args) { SpringApplication.run(PricingApplication.class, args); } }</code> </pre><br> 然后，我们将创建PricingEndpoint类。 在这里，我将给出一个更详细的示例，因为它演示了几个重要功能，包括服务发现（搜索组合服务）以及使用RestTemplate进行查询： <br><br><pre> <code class="bash hljs">@RestController @RequestMapping(<span class="hljs-string"><span class="hljs-string">"/pricing"</span></span>) public class PricingEndpoint implements InitializingBean { @Autowired DiscoveryClient client; Map&lt;String, Double&gt; pricingMap = new HashMap&lt;&gt;(); RestTemplate restTemplate = new RestTemplate(); @GetMapping(<span class="hljs-string"><span class="hljs-string">"/customer/{customer-id}/portfolio/{portfolio-id}"</span></span>) public List&lt;String&gt; getPricedPortfolio( @PathVariable(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) Integer customerId, @PathVariable(<span class="hljs-string"><span class="hljs-string">"portfolio-id"</span></span>) Integer portfolioId) { List&lt;ServiceInstance&gt; instances = client.getInstances(<span class="hljs-string"><span class="hljs-string">"portfolio-service"</span></span>); ServiceInstance instance = instances.stream() .findFirst() .orElseThrow(() -&gt; new RuntimeException(<span class="hljs-string"><span class="hljs-string">"not found"</span></span>)); String url = String.format(<span class="hljs-string"><span class="hljs-string">"%s/portfolios/customer/%d/portfolio/%d"</span></span>, instance.getUri(), customerId, portfolioId); // query <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the portfolios, returned as an array of List // of size 2, containing a ticker and a position (<span class="hljs-comment"><span class="hljs-comment"># of shares) Object[] portfolio = restTemplate.getForObject(url, Object[].class); // Look up the share prices, and return a list of Strings, formatted as // ticker, shares, price, total List&lt;String&gt; collect = Arrays.stream(portfolio).map(position -&gt; { String ticker = ((List&lt;String&gt;) position).get(0); int shares = ((List&lt;Integer&gt;) position).get(1); double price = getPrice(ticker); double total = shares * price; return String.format("%s %d %f %f", ticker, shares, price, total); }).collect(Collectors.toList()); return collect; } private double getPrice(String ticker) { return pricingMap.get(ticker); } @Override public void afterPropertiesSet() throws Exception { pricingMap.put("MMM",201.81); pricingMap.put("AXP",85.11); pricingMap.put("AAPL",161.04); pricingMap.put("BA",236.32); pricingMap.put("CAT",118.02); pricingMap.put("CVX",111.31); pricingMap.put("CSCO",31.7); pricingMap.put("KO",46.00); pricingMap.put("DIS",101.92); pricingMap.put("XOM",78.7); pricingMap.put("GE",24.9); pricingMap.put("GS",217.62); pricingMap.put("HD",155.82); pricingMap.put("IBM",144.29); pricingMap.put("INTC",35.66); pricingMap.put("JNJ",130.8); pricingMap.put("JPM",89.75); pricingMap.put("MCD",159.81); pricingMap.put("MRK",63.89); pricingMap.put("MSFT",73.65); pricingMap.put("NKE",52.78); pricingMap.put("PFE",33.92); pricingMap.put("PG",92.79); pricingMap.put("TRV",117.00); pricingMap.put("UTX",110.12); pricingMap.put("UNH",198.00); pricingMap.put("VZ",47.05); pricingMap.put("V",103.34); pricingMap.put("WMT", 80.05); } }</span></span></code> </pre><br> 要找到投资组合服务，我们需要有权使用DiscoveryClient。 使用Spring的@Autowired批注很容易获得。 <br><br><pre> <code class="bash hljs">@Autowired DiscoveryClient client;</code> </pre><br> 然后，此DiscoveryClient实例用于在调用中搜索服务： <br><br><pre> <code class="bash hljs">List&lt;ServiceInstance&gt; instances = client.getInstances(<span class="hljs-string"><span class="hljs-string">"portfolio-service"</span></span>); ServiceInstance instance = instances.stream().findFirst().orElseThrow(() -&gt; new RuntimeException(<span class="hljs-string"><span class="hljs-string">"not found"</span></span>));</code> </pre><br> 找到该服务后，我们可以使用它来满足我们的请求，该请求根据我们在投资组合服务中创建的api调用组成。 <br><br><pre> <code class="bash hljs">String url = String.format(<span class="hljs-string"><span class="hljs-string">"%s/portfolios/customer/%d/portfolio/%d"</span></span>, instance.getUri(), customerId, portfolioId);</code> </pre><br> 最后，我们使用RestTemplate执行GET请求。 <br><br><pre> <code class="bash hljs">Object[] portfolio = restTemplate.getForObject(url, Object[].class);</code> </pre> <br> 请注意，对于Rest控制器（以及Spring MVC请求控制器），使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Path</a> Variable注释检索<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">路径</a>变量，这与我们看到的Jersey所使用的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Path</a> Param不同。 <br><br> 这样就结束了我们与Spring RestController的定价。 <br><br><h3> 该文件 </h3><br> 为了创建我们的微服务，我们解决了所有这些问题，但是如果我们不向世界提供有关如何使用它们的知识，它们将不会带来足够的收益。 <br><br> 为此，我们使用了方便易用的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Swagger</a>工具，该工具不仅记录了我们的API调用，而且还提供了一个方便的Web客户端来调用它们。 <br><br> 首先，让我们在pom中指定Swagger： <br><br><pre> <code class="bash hljs">&lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt; &lt;version&gt;2.7.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt; &lt;version&gt;2.7.0&lt;/version&gt; &lt;/dependency&gt;</code> </pre><br> 然后，我们需要告诉Swagger我们要记录哪个类。 让我们介绍包含Swagger规范的新SwaggerConfig类。 <br><br><pre> <code class="bash hljs">@Configuration @EnableSwagger2 public class SwaggerConfig { @Bean public Docket <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new Docket(DocumentationType.SWAGGER_2) .select() .apis(RequestHandlerSelectors.any()) .paths(PathSelectors.regex(<span class="hljs-string"><span class="hljs-string">"/pricing.*"</span></span>)) .build(); } }</code> </pre><br> 让我们看看这个类做什么。 首先，我们将其指定为带有@ EnableSwagger2注释的Swagger配置。 <br><br> 然后，我们创建了一个Docket组件，该组件告诉Swagger应该显示哪些API。 在上面的示例中，我们告诉Swagger演示了以“ /定价”开头的所有路径。 另一种选择是为文档而不是路径指定类： <br><br><pre> <code class="bash hljs">.apis(RequestHandlerSelectors.basePackage(<span class="hljs-string"><span class="hljs-string">"com.restms.demo"</span></span>)) .paths(PathSelectors.any())</code> </pre><br> 重新启动价格微服务，然后从浏览器中调用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http：//本地主机：57216 / swagger-ui.html</a> <br><br><img src="https://habrastorage.org/webt/8x/0k/gk/8x0kgk8hxs_dpijzolsmxk8rdva.png"><br><br> 单击列出操作以查看详细的服务操作。 <br> 单击“扩展操作”以基于表单创建请求。 设置一些参数，单击“试用！” 然后等待答案： <br><br><img src="https://habrastorage.org/webt/rf/0_/iu/rf0_ius_kz3fljd74-aaqhzwsia.png"><br><br> 您可以通过在方法中添加Swagger注释来添加更多颜色。 <br> 例如，使用@ApiOperation批注装饰现有PricingImpl.getPricedPortfolio方法，如下所示： <br><br><pre> <code class="bash hljs">@ApiOperation(value = <span class="hljs-string"><span class="hljs-string">"Retrieves a fully priced portfolio"</span></span>, notes = <span class="hljs-string"><span class="hljs-string">"Retrieves fully priced portfolio given customer id and portfolio id"</span></span>) @GetMapping(<span class="hljs-string"><span class="hljs-string">"/customer/{customer-id}/portfolio/{portfolio-id}"</span></span>) public List&lt;String&gt; getPricedPortfolio(@PathVariable(<span class="hljs-string"><span class="hljs-string">"customer-id"</span></span>) Integer customerId, @PathVariable(<span class="hljs-string"><span class="hljs-string">"portfolio-id"</span></span>) Integer portfolioId)</code> </pre> <br> 重新加载并更新swagger-ui以查看新的更新文档： <br><br><img src="https://habrastorage.org/webt/1z/vy/bj/1zvybjvfyh6zmjxd7gahn5_tlyi.png"><br><br> 这不是您使用Swagger所能做的全部，因此请查阅文档。 <br><br> 我们课程<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“ Spring框架的开发者”</a>课程的讲师<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Yuri Dvorzhetsky</a>将向您详细介绍Spring Boot的工作： <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zgd9SfSxO0Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><i>原始文章</i></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN413567/">https://habr.com/ru/post/zh-CN413567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN413557/index.html">NewSQL：SQL到处都行不通</a></li>
<li><a href="../zh-CN413559/index.html">Web降级或如何使Web可读</a></li>
<li><a href="../zh-CN413561/index.html">编译的Linq表达式树速度</a></li>
<li><a href="../zh-CN413563/index.html">将包导入Go的4种方法</a></li>
<li><a href="../zh-CN413565/index.html">Kubernetes hack分析-通过kubelet后门</a></li>
<li><a href="../zh-CN413569/index.html">拆卸工厂18650锂离子电池</a></li>
<li><a href="../zh-CN413571/index.html">第25期：IT培训-当前问题和领先公司的挑战</a></li>
<li><a href="../zh-CN413575/index.html">BricsCAD Shape-Bricsys提供的免费3D CAD</a></li>
<li><a href="../zh-CN413577/index.html">[公告]在俄罗斯七个城市的CodinGame.com上进行比赛的枢纽</a></li>
<li><a href="../zh-CN413579/index.html">我们来谈谈代码分解：上下文编程</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>