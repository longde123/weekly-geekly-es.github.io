<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☮️ 👎🏼 🚆 Testhistorie des K-Projekts: Kotlin & Spek 😖 🛶 🔜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 

 In diesem Artikel werden wir über automatische Tests in einem der vielen QIWI-Projekte mit dem Codenamen "K" sprechen. 

 
 
 Als wir d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testhistorie des K-Projekts: Kotlin & Spek</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/419699/">  Hallo Habr! <br><br>  In diesem Artikel werden wir über automatische Tests in einem der vielen QIWI-Projekte mit dem Codenamen "K" sprechen. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/ws/qx/ge/wsqxge0381fvp6h2msyqi3bvnv0.png"><br></a> <br>  Als wir die Tests dieses Projekts organisierten, entschieden wir uns für das praktische und Hype <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kotlin</a> sowie für <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Spek</a> , das besagt: „Sie nennen sie Tests, wir nennen sie Spezifikationen“ (Sie nennen sie Tests, wir nennen sie Spezifikationen).  Vielleicht ist dieser Ansatz für Sie geeignet, wenn Sie vor ähnlichen Aufgaben stehen. <br><br>  Warum Kotlin und nicht etwas anderes?  Kotlin wurde von der Entwicklung ausgewählt, um zu experimentieren, da dieses spezielle Produkt nicht kritisch war und es möglich war, es live zu üben, ohne befürchten zu müssen, dass es Probleme geben würde. <br><br>  Aus der offiziellen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation geht hervor</a> , dass "Spek in Kotlin geschrieben ist und die von Ihnen geschriebenen Spezifikationen in Kotlin geschrieben werden" - dies beantwortet ganz klar die Frage: "Warum wird dies benötigt?" <br><br>  Also ... <br><br><h2>  Was ist das und warum wird es benötigt? </h2><a name="habracut"></a><br>  Das Projekt stellt seinem Partner Software zur Verfügung, eine Anwendung für Android.  Der Löwenanteil der Tests entfällt auf das Back-End, daher konzentrieren wir uns auf das Testen der REST-API. <br><br>  Für eine Reihe von Tests, bei denen Sie Tests schreiben und Ergebnisse erzielen können, ist alles klar: Sie benötigen eine Programmiersprache, ein Testframework, einen HTTP-Client und Berichte.  Aber was ist mit dem Einstiegspunkt in unser Testuniversum? <br><br>  Anforderungen, sie sind Spezifikationen, beschlossen die Projektentwickler, in Form von Tests zu schreiben.  Das Ergebnis war ein interessantes Bild - BDD.  So erschienen Kotlin, Spek und khttp in der Arena. <br>  Der aufmerksame Leser wird fragen - OK, aber wo sind die Tester? <br><br><h2>  Tester </h2><br>  Nachdem zwei Fliegen mit einer Klappe beendet worden waren, gab die Entwicklung dem Produkttester sowohl Anforderungen als auch Autotests.  Seitdem hat der Tester die Testabdeckung entsprechend den Anforderungen erweitert und unterstützt und erstellt gemeinsam mit den Entwicklern neue Tests. <br><br>  "Dies kann nicht ewig so weitergehen und sollte für den Testprozess nicht tragisch enden!"  - Als eine solche Idee von Kollegen besucht wurde, trat das Team der Serviceabteilung der Testabteilung ins Spiel.  Die Serviceabteilung stand vor der Aufgabe: Kotlin in kurzer Zeit zu studieren, um bei Bedarf blitzschnelle Unterstützung für Tests zu erhalten. <br><br><h2>  Erste Schritte </h2> <br>  In der Serviceabteilung ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">IntelliJ IDEA</a> in Betrieb. Da Kotlin auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JVM ausgeführt wird</a> und von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JetBrains</a> entwickelt wurde, war zum Schreiben von Code keine zusätzliche Installation erforderlich. <br><br>  Aus offensichtlichen Gründen werden wir den Prozess des Lernens der Sprache selbst überspringen. <br><br>  Als erstes wurde das Repository geklont: <br> <code>git clone https://gerrit.project.com/k/autotests</code> <br> <br>  Dann wurde das Projekt geöffnet und die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gradle-</a> Einstellungen wurden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">importiert</a> : <br><br><img src="https://habrastorage.org/webt/ac/ow/q9/acowq9lorzdzssh9toa1hbnredu.png"><br><br>  Für vollständige Zufriedenheit und Komfort (* Eigentlich ist dies ein Muss) wurde das Spek- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Plugin</a> installiert: <br><br><img src="https://habrastorage.org/webt/gv/ox/sf/gvoxsfjv1voimnquiaieykoxvxo.png"><br><br>  Er stellte den Start von Tests in der Entwicklungsumgebung sicher: <br><br><img src="https://habrastorage.org/webt/af/b-/l2/afb-l2hszwdosplzx-8d1ykuole.png"><br><br>  Die erste Phase war abgeschlossen und es war Zeit, die Tests selbst zu schreiben. <br><br><h2>  Tests </h2><br>  Gute Leute aus der Serviceabteilung gehören nicht zu diesem oder jenem Produkt.  Dies sind diejenigen Mitarbeiter, die es eilig haben, die Automatisierung des Projekts einschließlich aller Phasen des Prozesses einzurichten und dann Tests an Produkttester zur Unterstützung und zum Betrieb zu übergeben. <br><br>  Und da die Interaktion der internen Teams der Testabteilung auf ähnliche Weise organisiert ist, „fragt“ die Serviceabteilung zumindest nach den Anforderungen für die Eingabe der Funktion. <br><br>  Es scheint, dass dies im Fall von "K" eine Sackgasse ist.  Aber da war es: <br><br><ul><li>  Der Lesezugriff auf das Repository, in dem die Projektquellen gespeichert wurden, wurde angefordert. </li><li>  Das Repository geklont; </li><li>  Sie begannen, in die Funktionalität des Produkts einzutauchen, indem sie in Java geschriebene Quellcodes lasen. </li></ul><br><h2>  Was hast du gelesen </h2><br>  Entwicklung "K" hat darum gebeten, Tests für Funktionen zu schreiben, mit denen Sie zum Verkauf stehende Produkte hinzufügen, aktualisieren und löschen können.  Die Implementierung bestand aus zwei Teilen: "Web" und "Mobile". <br><br>  <b>Im Falle von Web:</b> <br><br><ul><li>  Zum Hinzufügen von Produkten wird eine POST-Anforderung verwendet, deren Hauptteil JSON mit Daten enthält. </li><li>  Zum Aktualisieren oder Bearbeiten von Produkten wird eine PUT-Anforderung verwendet, deren Hauptteil JSON mit den geänderten Daten enthält. </li><li>  Zum Löschen von Waren wird eine DELETE-Anforderung verwendet, deren Text leer ist. </li></ul><br>  <b>Im Falle von Mobilgeräten:</b> <br><br>  Zum Hinzufügen, Aktualisieren und Löschen von Produkten wird eine POST-Anforderung verwendet, deren Hauptteil JSON mit Daten für die angegebenen Vorgänge enthält. <br><br>  Das heißt,  JSON hat drei Knoten: <br><br><ul><li>  "Hinzugefügt": Liste der hinzugefügten Produkte, </li><li>  "Entfernt": eine Liste der entfernten Elemente, </li><li>  "Aktualisiert": Eine Liste der aktualisierten Produkte. </li></ul><br><h2>  Was hast du geschrieben </h2><br>  Eine Testklasse mit Testspezifikationen wurde bereits erstellt und enthielt Testmethoden (* etwas nicht in Spek), daher musste sie nur erweitert werden. <br><br>  <b>Für das Web</b> <br><br>  Test auf erfolgreiche Produktzugabe: <br><br><ul><li>  Element hinzufügen </li><li>  Überprüfen Sie, ob der Artikel hinzugefügt wurde. </li><li>  Löschen Sie das erstellte Produkt (Nachbedingung) </li></ul><br>  Code: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("get changed since when goods added") { val goodsUpdateName: String = RandomStringUtils.randomAlphabetic(<span class="hljs-number"><span class="hljs-number">8</span></span>) val <span class="hljs-type"><span class="hljs-type">date</span></span> = <span class="hljs-type"><span class="hljs-type">Date</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(Instant.now()).time - <span class="hljs-number"><span class="hljs-number">1</span></span> val goodsAdded = post(baseUrl + "goods/${user.storeId}", authHeader, <span class="hljs-type"><span class="hljs-type">json</span></span> = dataToMap(goods.<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span> = goodsUpdateName))) it("should return the status code OK") { goodsAdded.statusCode.should.be.equal(OK) } val goodId = goodsAdded.jsonObject?.optLong("id") val goodsUpdates = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(baseUrl + "updates/goods/since/" + <span class="hljs-type"><span class="hljs-type">date</span></span>, authHeader.plus("AppUID" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.AppUID)) it("should return the status code OK") { goodsUpdates.statusCode.should.be.equal(OK) } val goodsInsert = goodsUpdates.jsonObject.getJSONArray("updated").toList() .map { it <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> JSONObject } .find { it.optLong("goodId") == goodId } it("should contain goods insert") { goodsInsert.should.be.<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>.`<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>` goodsInsert?.optString("name").should.be.equal(goodsUpdateName) } <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(baseUrl + "goods/${user.storeId}/$goodId", authHeader) }</code> </pre> <br>  Test für die erfolgreiche Entfernung von Waren: <br><br><ul><li>  Produkt hinzufügen (Voraussetzung) </li><li>  Wir löschen die Ware </li><li>  Wir prüfen, ob das Produkt gelöscht wurde </li></ul><br>  Code: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("get changed since when goods deleted") { val goodsUpdateName: String = RandomStringUtils.randomAlphabetic(<span class="hljs-number"><span class="hljs-number">8</span></span>) val <span class="hljs-type"><span class="hljs-type">date</span></span> = <span class="hljs-type"><span class="hljs-type">Date</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(Instant.now()).time - <span class="hljs-number"><span class="hljs-number">1</span></span> val goodsAdded = post(baseUrl + "goods/${user.storeId}", authHeader, <span class="hljs-type"><span class="hljs-type">json</span></span> = dataToMap(goods.<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span> = goodsUpdateName))) it("should return the status code OK") { goodsAdded.statusCode.should.be.equal(OK) } val goodId = goodsAdded.jsonObject?.optLong("id") val responseDelete = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(baseUrl + "goods/${user.storeId}/$goodId", authHeader) it("should return the status code NO_CONTENT") { responseDelete.statusCode.should.be.equal(NO_CONTENT) } val goodsUpdates = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(baseUrl + "updates/goods/since/" + <span class="hljs-type"><span class="hljs-type">date</span></span>, authHeader.plus("AppUID" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.AppUID)) it("should contain goods deletes") { goodsUpdates.statusCode.should.be.equal(OK) goodsUpdates.jsonObject.getJSONArray("removed").toList() .map { it <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">Int</span></span> } .find { it == goodId.toInt() } .should.be.<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>.`<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>` } }</code> </pre> <br>  Negativer Test für die Ausführung von Abfragen durch nicht autorisierte Benutzer <br><br><ul><li>  Element hinzufügen </li><li>  Überprüfen Sie den Status der Antwort </li><li>  Eine Anforderung zum Hinzufügen eines Produkts wird ohne Autorisierungsheader gesendet.  Die Antwort lautet 401 Nicht autorisierter Status. </li></ul><br>  Code: <br><br><pre> <code class="hljs vbscript"> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">"get changed since when goods added without authorization"</span></span>) { val <span class="hljs-built_in"><span class="hljs-built_in">response</span></span> = post(baseUrl + <span class="hljs-string"><span class="hljs-string">"goods/${user.storeId}"</span></span>, json = dataToMap(goods)) it(<span class="hljs-string"><span class="hljs-string">"should contain an Unauthorized response status and an empty body"</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.statusCode.should.be.equal(UNAUTHORIZED) <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.text.should.be.equal(<span class="hljs-string"><span class="hljs-string">""</span></span>) } }</code> </pre> <br>  <b>Für Handys</b> <br><br>  Hilfsfunktionen wurden geschrieben, um die Knoten aus dem Antwortkörper und der Bildung des Anforderungskörpers zu erhalten. <br><br>  Code: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.qiwi.k.tests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.ObjectMapper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> khttp.responses.Response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json.JSONObject <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mapper = ObjectMapper() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arrayAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Array&lt;GoodsUpdate&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Array(n) { i -&gt; GoodsUpdate() } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGoodsIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(list: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">List</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">GoodsUpdate</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span>: List&lt;<span class="hljs-built_in"><span class="hljs-built_in">Long</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Array(list.size) { i -&gt; list[i].goodId }.toList() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Response</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: List&lt;GoodsUpdate&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapper.readValue( response.jsonObject.getJSONArray(<span class="hljs-string"><span class="hljs-string">"result"</span></span>).toString(), Array&lt;GoodsUpdate&gt;::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class"> ).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toList</span></span></span></span>() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCountryIdFromTheResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Response</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: List&lt;<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> listGoods = mapper.readValue( response.jsonObject.getJSONArray(<span class="hljs-string"><span class="hljs-string">"result"</span></span>).toString(), Array&lt;GoodsUpdate&gt;::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class"> ).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toList</span></span></span></span>() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Array(listGoods.size) { i -&gt; listGoods[i].countryId }.toList() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBody</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(added: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">GoodsUpdate</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; = emptyArray()</span></span></span></span>, removed: List&lt;<span class="hljs-built_in"><span class="hljs-built_in">Long</span></span>&gt; = emptyList(), updated: List&lt;GoodsUpdate&gt; = emptyList()): JSONObject { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JSONObject( mapOf( <span class="hljs-string"><span class="hljs-string">"added"</span></span> to added, <span class="hljs-string"><span class="hljs-string">"removed"</span></span> to removed, <span class="hljs-string"><span class="hljs-string">"updated"</span></span> to updated ) ) }</code> </pre><br>  Test auf erfolgreiche Produktaddition <br><br><ul><li>  Element hinzufügen </li><li>  Überprüfen Sie, ob der Artikel hinzugefügt wurde. </li><li>  Wir löschen die Ware (Nachbedingung) </li></ul><br>  Code: <br><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"adding goods"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respAdd</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlGoodsUpdate, authHeaderWithAppUID, json = getBody(added = arrayAdded(count)))</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resultOfAdding</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(respAdd)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should return the status code OK"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respAdd</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statusCode</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OK)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should be equal to the size of the variable count"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resultOfAdding</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(count)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlGoodsUpdate, authHeaderWithAppUID, json = getBody(removed = getGoodsIds(resultOfAdding)))</span></span></span><span class="hljs-function"> }</span></span></code> </pre> <br>  Test auf erfolgreiches Produktupdate <br><br><ul><li>  Produkt hinzufügen (Voraussetzung) </li><li>  Wir aktualisieren die Ware </li><li>  Überprüfen Sie, ob das hinzugefügte Element aktualisiert wurde. </li><li>  Wir löschen die Ware (Nachbedingung) </li></ul><br>  Code: <br><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"updating goods"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respAdd</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlGoodsUpdate, authHeaderWithAppUID, json = getBody(added = arrayAdded(count)))</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resultOfAdding</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(respAdd)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should return the status code respAdd OK"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respAdd</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statusCode</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OK)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should be equal to the size of the variable count (resultOfAdding)"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resultOfAdding</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(count)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respUpdate</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlGoodsUpdate, authHeaderWithAppUID, json = getBody(updated = resultOfAdding.map { it.copy(countryId = REGION_77) }) )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should return the status code respUpdate OK"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respUpdate</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statusCode</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OK)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should be equal to the size of the variable count (respUpdate)"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(respUpdate)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(count)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should be all elements are 77"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCountryIdFromTheResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(respUpdate)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">all</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(REGION_77)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlGoodsUpdate, authHeaderWithAppUID, json = getBody(removed = getGoodsIds(resultOfAdding)))</span></span></span><span class="hljs-function"> }</span></span></code> </pre> <br>  Test für die erfolgreiche Entfernung von Waren: <br><br><ul><li>  Produkt hinzufügen (Voraussetzung) </li><li>  Wir löschen die Ware </li><li>  Wir überprüfen, ob das hinzugefügte Produkt gelöscht wurde </li></ul><br>  Code: <br><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"deleting goods"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respAdd</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlGoodsUpdate, authHeaderWithAppUID, json = getBody(added = arrayAdded(count)))</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resultOfAdding</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(respAdd)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should return the status code respAdd OK"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respAdd</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statusCode</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OK)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should be equal to the size of the variable count"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resultOfAdding</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(count)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">val</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respRemoved</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlGoodsUpdate, authHeaderWithAppUID, json = getBody(removed = getGoodsIds(resultOfAdding)) )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should return the status code respRemoved OK"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">respRemoved</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statusCode</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OK)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"should be empty"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(respRemoved)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">should</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">empty</span></span></span><span class="hljs-function"> } }</span></span></code> </pre> <br>  Nach dem Schreiben der Tests war es notwendig, den Überprüfungscode durchzugehen. <br><br><h2>  Rückblick </h2><br>  Mehr als ein Dutzend Commits, viel Korrespondenz mit Entwicklern, Besuch von Foren, Kommunikation mit Google.  Und hier ist das Ergebnis. <br><br>  Code: <br><br><pre> <code class="hljs pgsql">package com.qiwi.k.tests.catalog <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> … <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> GoodsUpdatesControllerSpec : WebSpek({ given("GoodsUpdatesController") { val OK = HttpResponseStatus.OK.code() val NO_CONTENT = HttpResponseStatus.NO_CONTENT.code() val UNAUTHORIZED = HttpResponseStatus.UNAUTHORIZED.code() val REGION_77 = <span class="hljs-number"><span class="hljs-number">77</span></span> val auth = <span class="hljs-keyword"><span class="hljs-keyword">login</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) val accessToken = auth.tokenHead + auth.tokenTail val authHeader = mapOf("Authorization" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> "Bearer $accessToken") val baseUrl = "http://test.qiwi.com/catalog/" val count = <span class="hljs-number"><span class="hljs-number">2</span></span> val authHeaderWithAppUID = mapOf("Authorization" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> "Bearer $accessToken", "AppUID" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.AppUID) val urlGoodsUpdate = "http://test.qiwi.com/catalog/updates/goods/" <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("get changes since") { val goodsName: String = goodsForUpdate.name + Random().nextInt(<span class="hljs-number"><span class="hljs-number">1000</span></span>) val <span class="hljs-type"><span class="hljs-type">date</span></span> = <span class="hljs-type"><span class="hljs-type">Date</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(Instant.now()).time - <span class="hljs-number"><span class="hljs-number">1</span></span> put(baseUrl + "goods/${user.storeId}", authHeader, <span class="hljs-type"><span class="hljs-type">json</span></span> = dataToMap(goodsForUpdate.<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span> = goodsName))) val goodsUpdates = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(baseUrl + "updates/goods/since/" + <span class="hljs-type"><span class="hljs-type">date</span></span>, authHeader.plus("AppUID" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.AppUID)) it("should contain goods updates") { val updates = goodsUpdates.jsonObject.getJSONArray("updated").toList() .map { it <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> JSONObject } .find { it.optLong("goodId") == goodsForUpdate.id } updates.should.be.<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>.`<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>` updates?.optString("name").should.be.equal(goodsName) } } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("get changed since when goods added") { val goodsUpdateName: String = RandomStringUtils.randomAlphabetic(<span class="hljs-number"><span class="hljs-number">8</span></span>) val <span class="hljs-type"><span class="hljs-type">date</span></span> = <span class="hljs-type"><span class="hljs-type">Date</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(Instant.now()).time - <span class="hljs-number"><span class="hljs-number">1</span></span> val goodsAdded = post(baseUrl + "goods/${user.storeId}", authHeader, <span class="hljs-type"><span class="hljs-type">json</span></span> = dataToMap(goods.<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span> = goodsUpdateName))) it("should return the status code OK") { goodsAdded.statusCode.should.be.equal(OK) } val goodId = goodsAdded.jsonObject?.optLong("id") val goodsUpdates = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(baseUrl + "updates/goods/since/" + <span class="hljs-type"><span class="hljs-type">date</span></span>, authHeader.plus("AppUID" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.AppUID)) it("should return the status code OK") { goodsUpdates.statusCode.should.be.equal(OK) } val goodsInsert = goodsUpdates.jsonObject.getJSONArray("updated").toList() .map { it <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> JSONObject } .find { it.optLong("goodId") == goodId } it("should contain goods insert") { goodsInsert.should.be.<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>.`<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>` goodsInsert?.optString("name").should.be.equal(goodsUpdateName) } <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(baseUrl + "goods/${user.storeId}/$goodId", authHeader) } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("get changed since when goods deleted") { val goodsUpdateName: String = RandomStringUtils.randomAlphabetic(<span class="hljs-number"><span class="hljs-number">8</span></span>) val <span class="hljs-type"><span class="hljs-type">date</span></span> = <span class="hljs-type"><span class="hljs-type">Date</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(Instant.now()).time - <span class="hljs-number"><span class="hljs-number">1</span></span> val goodsAdded = post(baseUrl + "goods/${user.storeId}", authHeader, <span class="hljs-type"><span class="hljs-type">json</span></span> = dataToMap(goods.<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span> = goodsUpdateName))) it("should return the status code OK") { goodsAdded.statusCode.should.be.equal(OK) } val goodId = goodsAdded.jsonObject?.optLong("id") val responseDelete = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(baseUrl + "goods/${user.storeId}/$goodId", authHeader) it("should return the status code NO_CONTENT") { responseDelete.statusCode.should.be.equal(NO_CONTENT) } val goodsUpdates = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(baseUrl + "updates/goods/since/" + <span class="hljs-type"><span class="hljs-type">date</span></span>, authHeader.plus("AppUID" <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.AppUID)) it("should contain goods deletes") { goodsUpdates.statusCode.should.be.equal(OK) goodsUpdates.jsonObject.getJSONArray("removed").toList() .map { it <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">Int</span></span> } .find { it == goodId.toInt() } .should.be.<span class="hljs-keyword"><span class="hljs-keyword">not</span></span>.`<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>` } } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("get changed since when goods added without authorization") { val response = post(baseUrl + "goods/${user.storeId}", <span class="hljs-type"><span class="hljs-type">json</span></span> = dataToMap(goods)) it("should contain an Unauthorized response status and an empty body") { response.statusCode.should.be.equal(UNAUTHORIZED) response.text.should.be.equal("") } } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("adding goods") { val respAdd = post(urlGoodsUpdate, authHeaderWithAppUID, <span class="hljs-type"><span class="hljs-type">json</span></span> = getBody(added = arrayAdded(count))) val resultOfAdding = getResult(respAdd) it("should return the status code OK") { respAdd.statusCode.should.be.equal(OK) } it("should be equal to the size of the variable count") { resultOfAdding.should.be.size.equal(count) } post(urlGoodsUpdate, authHeaderWithAppUID, <span class="hljs-type"><span class="hljs-type">json</span></span> = getBody(removed = getGoodsIds(resultOfAdding))) } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("updating goods") { val respAdd = post(urlGoodsUpdate, authHeaderWithAppUID, <span class="hljs-type"><span class="hljs-type">json</span></span> = getBody(added = arrayAdded(count))) val resultOfAdding = getResult(respAdd) it("should return the status code respAdd OK") { respAdd.statusCode.should.be.equal(OK) } it("should be equal to the size of the variable count (resultOfAdding)") { resultOfAdding.should.be.size.equal(count) } val respUpdate = post(urlGoodsUpdate, authHeaderWithAppUID, <span class="hljs-type"><span class="hljs-type">json</span></span> = getBody(updated = resultOfAdding.map { it.<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>(countryId = REGION_77) }) ) it("should return the status code respUpdate OK") { respUpdate.statusCode.should.be.equal(OK) } it("should be equal to the size of the variable count (respUpdate)") { getResult(respUpdate).should.be.size.equal(count) } it("should be all elements are 77") { getCountryIdFromTheResult(respUpdate).should.be.<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>.elements(REGION_77) } post(urlGoodsUpdate, authHeaderWithAppUID, <span class="hljs-type"><span class="hljs-type">json</span></span> = getBody(removed = getGoodsIds(resultOfAdding))) } <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>("deleting goods") { val respAdd = post(urlGoodsUpdate, authHeaderWithAppUID, <span class="hljs-type"><span class="hljs-type">json</span></span> = getBody(added = arrayAdded(count))) val resultOfAdding = getResult(respAdd) it("should return the status code respAdd OK") { respAdd.statusCode.should.be.equal(OK) } it("should be equal to the size of the variable count") { resultOfAdding.should.be.size.equal(count) } val respRemoved = post(urlGoodsUpdate, authHeaderWithAppUID, <span class="hljs-type"><span class="hljs-type">json</span></span> = getBody(removed = getGoodsIds(resultOfAdding)) ) it("should return the status code respRemoved OK") { respRemoved.statusCode.should.be.equal(OK) } it("should be empty") { getResult(respRemoved).should.be.empty } } } })</code> </pre><br><h2>  Zusammenfassung </h2><br>  Der Code selbst, die Sprachkenntnisse und die Kenntnisse des Frameworks sind alles andere als perfekt, aber der Anfang ist im Allgemeinen nicht schlecht. <br><br>  Als ich Kotlin traf, hatte ich das Gefühl, dass er in Java syntaktischer Zucker ist.  Und während ich den Code mit allen Fasern der Seele schrieb, spürte ich die Worte: „Voll kompatibel mit Java“. <br><br>  Spek, das einfache Sprachkonstrukte zur Beschreibung von Spezifikationen verwendet, bietet einen vollständigen Pool von Testmethoden.  Das heißt,  gibt, was sie von ihm wollen, wie von einem Test-Framework. <br><br>  Insgesamt - alle Tests im Master.  Alles hat geklappt, und die Serviceabteilung weiß jetzt mit Sicherheit, dass sie Kollegen von K in schwierigen Zeiten unterstützen kann. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de419699/">https://habr.com/ru/post/de419699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de419687/index.html">Geheime Tastatur Stufe 3 oder wie man einen langen Strich druckt</a></li>
<li><a href="../de419689/index.html">I. Disadaptation. II. ADHS oder ein fauler Idiot?</a></li>
<li><a href="../de419693/index.html">Mikrotik: Reset, Backups und DualBoot</a></li>
<li><a href="../de419695/index.html">Was tun direkt nach einer Geschäftskonferenz? Tipps von ISPsystem bizdedev</a></li>
<li><a href="../de419697/index.html">Telekommunikationsstadion "Jekaterinburg Arena": 20 Kilometer dickes Kabel</a></li>
<li><a href="../de419701/index.html">Warum brauche ich bei Stromversorgung einen guten alten Kohlekessel im Auto?</a></li>
<li><a href="../de419703/index.html">Registrierung von Medizinprodukten: Wie viele Mäuse werden dabei leiden?</a></li>
<li><a href="../de419705/index.html">Wir wollen Devops durch ein Skript ersetzen (eigentlich nicht): Entwickler, Sie brauchen Ihre Meinung</a></li>
<li><a href="../de419707/index.html">Gamification von Anwendungen - 5 Dinge zu beachten</a></li>
<li><a href="../de419711/index.html">Die erste IT Bike Quest in St. Petersburg. Wie war es</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>