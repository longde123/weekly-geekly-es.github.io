<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìû üñ≤Ô∏è üë®‚Äçüíº Utilisation d'Identity Server 4 dans Net Core 3.0 ‚õëÔ∏è üôÖüèø üçá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 


 L'un de mes projets soutenus a r√©cemment √©t√© confront√© √† la t√¢che d'analyser la possibilit√© de migrer de .NET Framework 4.5 vers .Net...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation d'Identity Server 4 dans Net Core 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461433/"><h2 id="vvedenie">  Pr√©sentation </h2><br><p>  L'un de mes projets soutenus a r√©cemment √©t√© confront√© √† la t√¢che d'analyser la possibilit√© de migrer de .NET Framework 4.5 vers .Net Core en cas de besoin de refactoring et de ratissage d'une grande quantit√© de dette technique accumul√©e.  Le choix s'est port√© sur la plate-forme cible .NET Core 3.0, car, selon les d√©veloppeurs de Microsoft, avec la sortie de la version 3.0, les √©tapes n√©cessaires √† la migration du code h√©rit√© diminueront plusieurs fois.  En particulier, nous avons √©t√© attir√©s par les plans de sortie d'EntityFramework 6.3 pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">.Net Core,</a> c'est-√†-dire  la plupart du code bas√© sur EF 6.2 peut √™tre laiss√© ¬´tel quel¬ª dans un projet migr√© sur net core. </p><br><p>  Avec le niveau de donn√©es, il semble qu'il soit devenu clair, cependant, une autre grande partie du portage de code √©tait le niveau de s√©curit√©, qui, malheureusement, apr√®s un audit rapide, vous devrez le jeter presque compl√®tement et le r√©√©crire √† partir de z√©ro.  Heureusement, le projet utilisait d√©j√† une partie de ASP NET Identity, sous forme de stockage d'utilisateurs et d'autres ¬´v√©los¬ª attach√©s sur le c√¥t√©. </p><br><p>  Cela soul√®ve la question logique: si la partie s√©curit√© doit apporter beaucoup de changements, pourquoi ne pas mettre imm√©diatement en ≈ìuvre les approches recommand√©es sous la forme de normes industrielles, √† savoir: amener l'application √† utiliser Open Id connect et OAuth √† l'aide du framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">IdentityServer4</a> . </p><a name="habracut"></a><br><h2 id="problemy-i-puti-resheniya">  Probl√®mes et solutions </h2><br><p>  Donc, on nous a donn√©: il y a une application JavaScript en angulaire (client en termes IS4), elle utilise un certain sous-ensemble de WebAPI (ressources), il y a aussi une base de donn√©es d'identit√© ASP NET obsol√®te avec des connexions utilisateur qui doivent √™tre r√©utilis√©es apr√®s la mise √† jour (afin de ne pas d√©marrer tout le monde fois), et dans certains cas, il est n√©cessaire de donner la possibilit√© de se connecter au syst√®me via l'authentification Windows du c√¥t√© d'IdentityServer4.  C'est-√†-dire  Il y a des moments o√π les utilisateurs travaillent via un r√©seau local dans un domaine ActiveDirectory. </p><br><p>  La principale solution pour la migration des donn√©es utilisateur consiste √† √©crire manuellement (ou √† l'aide d'outils automatis√©s) un script de migration entre l'ancien et le nouveau sch√©ma de donn√©es d'identit√©.  √Ä notre tour, nous avons utilis√© l'application de comparaison automatique des sch√©mas de donn√©es et g√©n√©r√© un script SQL, selon la version de l'identit√©, le script de migration cible contiendra diff√©rentes instructions de mise √† jour.  L'essentiel ici est de ne pas oublier de coordonner la table EFMigrationsHistory si EF a √©t√© utilis√© auparavant et qu'il est pr√©vu √† l'avenir, par exemple, d'√©tendre l'entit√© IdentityUser √† des champs suppl√©mentaires. </p><br><p>  Mais maintenant, comment configurer correctement IdentityServer4 et le configurer avec les comptes Windows sera d√©crit ci-dessous. </p><br><h2 id="plan-realizacii">  Plan de mise en oeuvre </h2><br><p>  Pour des raisons de NDA, je ne d√©crirai pas comment nous avons r√©ussi √† impl√©menter IS4 dans notre projet, cependant, dans cet article, je vais vous montrer sur un simple site ASP.NET Core cr√©√© √† partir de z√©ro quelles √©tapes vous devez prendre pour obtenir une application enti√®rement configur√©e et fonctionnelle qui utilise IdentityServer4 √† des fins d'autorisation et d'authentification. <br>  Pour r√©aliser le comportement souhait√©, nous devons prendre les mesures suivantes: </p><br><ul><li>  Cr√©ez un projet ASP.Net Core vide et configurez pour utiliser IdentityServer4. </li><li>  Ajoutez un client en tant qu'application angulaire. </li><li>  Connectez-vous via google open-id-connect </li><li>  Ajouter une option d'authentification Windows </li></ul><br><p>  Pour des raisons de bri√®vet√©, les trois composants (IdentityServer, WebAPI, client angulaire) seront dans le m√™me projet.  Le type d'interaction s√©lectionn√© entre le client et IdentityServer (GrantType) est le flux implicite, lorsque le access_token est pass√© du c√¥t√© application dans le navigateur, puis utilis√© lors de l'interaction avec WebAPI.  <em>Plus proche de la publication, √† en juger par les modifications apport√©es au r√©f√©rentiel ASP.NET Core, le flux implicite sera remplac√© par le code d'autorisation + PKCE.)</em> </p><br><p>  Dans le processus de cr√©ation et de modification de l'application, l'interface de ligne de commande .NET Core sera largement utilis√©e, elle doit √™tre install√©e sur le syst√®me √† la place avec la derni√®re version de pr√©visualisation Core 3.0 (au moment de la r√©daction de l'article 3.0.100-preview7-012821). </p><br><h2 id="sozdanie-i-konfigurirovanie-web-proekta">  Cr√©ation et configuration d'un projet web </h2><br><p>  La sortie de la version 4 d'IdentityServer a √©t√© marqu√©e par la suppression compl√®te de l'interface utilisateur de ce cadre.  D√©sormais, les d√©veloppeurs ont le droit de d√©terminer eux-m√™mes l'interface principale du serveur d'autorisation.  Il y a plusieurs fa√ßons.  L'un des plus populaires consiste √† utiliser l'interface utilisateur du package d'interface utilisateur QuickStart, qui se trouve dans le r√©f√©rentiel officiel sur <a href="">github</a> . </p><br><p>  Une autre mani√®re, non moins pratique, est l'int√©gration avec l'interface utilisateur ASP Core Core Identity, dans ce cas, le d√©veloppeur doit configurer correctement le middleware correspondant dans le projet.  Cette m√©thode sera d√©crite plus loin. </p><br><p>  Commen√ßons par cr√©er un projet Web simple. Pour ce faire, ex√©cutez l'instruction suivante sur la ligne de commande: </p><br><pre><code class="plaintext hljs">dotnet new webapp -n IdentityServer4WebApp</code> </pre> <br><p>  Apr√®s l'ex√©cution, la sortie sera un cadre d'application Web, qui sera progressivement amen√© √† l'√©tat dont nous avons besoin.  Ici, vous devez faire une r√©servation pour que .Net Core 3.0 for Identity utilise des pages RazorPages plus l√©g√®res, contrairement au MVC lourd. <br>  Vous devez maintenant ajouter le support IdentityServer √† notre projet.  Pour ce faire, installez les packages n√©cessaires: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.ApiAuthorization.IdentityServer -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.EntityFrameworkCore.Tools -v 3.0.0-preview7.19362.6 dotnet add package Microsoft.EntityFrameworkCore.Sqlite -v 3.0.0-preview7.19362.6</code> </pre> <br><p>  En plus des liens vers les packages de serveur d'autorisation, nous avons ajout√© ici la prise en charge d'Entity Framework pour le stockage des informations utilisateur dans l'√©cosyst√®me Identity.  Pour plus de simplicit√©, nous utiliserons la base de donn√©es SQLite. </p><br><p>  Pour initialiser la base de donn√©es, cr√©ez notre mod√®le utilisateur et notre contexte de base de donn√©es, pour cela nous d√©clarons deux classes ApplicationUser, h√©rit√©es d' <em>IdentityUser</em> dans le dossier Models et <em>ApplicationDbContext</em> , h√©rit√©es de: <em>ApiAuthorizationDbContext dans le dossier Data.</em> <br></p><p>  Ensuite, vous devez configurer l'utilisation du contexte EntityFramework et cr√©er la base de donn√©es.  Pour ce faire, nous √©crivons le contexte dans la m√©thode <em>ConfigureServices</em> de la classe Startup: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;options.UseSqlite(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>))); services.AddRazorPages(); }</code> </pre> <br><p>  Et ajoutez la cha√Æne de connexion √† <em>appsettings.json</em> </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data Source=data.db"</span></span> },</code> </pre><br><p>  Vous pouvez maintenant cr√©er la migration initiale et initialiser le sch√©ma de base de donn√©es.  Il convient de noter que l'outil install√© pour ef core est requis (pour l'aper√ßu en question, la version 3.0.0-preview7.19362.6 est n√©cessaire). </p><br><pre> <code class="plaintext hljs">dotnet ef migrations add Init dotnet ef database update</code> </pre> <br><p>  Si toutes les √©tapes pr√©c√©dentes se sont d√©roul√©es sans erreur, le fichier de donn√©es SQLite data.db doit appara√Ætre dans votre projet. </p><br><p>  √Ä ce stade, nous pouvons enti√®rement configurer et tester la capacit√© √† part enti√®re d'utiliser Asp.Net Core Identity.  Pour ce faire, apportez des modifications aux m√©thodes de <em>d√©marrage.</em>  <em>Configurez</em> et <em>d√©marrez.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddDefaultIdentity&lt;ApplicationUser&gt;() .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); //Startup. Configure: app.UseAuthentication(); app.UseAuthorization(); app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); });</span></span></code> </pre> <br><p>  Avec ces lignes, nous int√©grons la possibilit√© d'authentification et d'autorisation dans le pipeline de traitement des demandes.  Et ajoutez √©galement l'interface utilisateur par d√©faut pour l'identit√©. <br>  Il ne reste plus qu'√† corriger l'interface utilisateur, ajouter √† Pages \ Shared une nouvelle vue Razor avec le nom <em>_LoginPartial.cshtml</em> et le contenu suivant: </p><br><pre> <code class="html hljs xml">@using IdentityServer4WebApp.Models @using Microsoft.AspNetCore.Identity @inject SignInManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> SignInManager @inject UserManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> UserManager <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (SignInManager.IsSignedIn(User)) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Manage/Index"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Manage"</span></span></span><span class="hljs-tag">&gt;</span></span>Hello @User.Identity.Name!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-inline"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Logout"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-route-returnUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link btn btn-link text-dark"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } else { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Register"</span></span></span><span class="hljs-tag">&gt;</span></span>Register<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Login"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Le code de pr√©sentation ci-dessus doit ajouter des liens vers la zone d'interface d'identit√© avec des contr√¥les utilisateur int√©gr√©s dans le panneau de navigation (identifiant et mot de passe, enregistrement, etc.) </p><br><p>  Pour obtenir le rendu de nouveaux √©l√©ments de menu, nous <em>modifions</em> simplement <em>le</em> fichier <em>_Layout.cshtml</em> en ajoutant le rendu de cette vue partielle. </p><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow-1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Index"</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Privacy"</span></span></span><span class="hljs-tag">&gt;</span></span>Privacy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">partial</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_LoginPartial"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!‚Äì‚Äì‚Äì‚Äì</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Et maintenant essayons d'ex√©cuter notre application et cliquez sur les liens qui apparaissent dans la t√™te <br>  menu, l'utilisateur devrait voir une page avec un accueil et une demande <br>  entrez l'identifiant et le mot de passe.  Dans ce cas, vous pouvez vous inscrire et vous connecter - tous <br>  devrait fonctionner. </p><br><p><img src="https://habrastorage.org/webt/yl/a2/yl/yla2yln6zflkftldetnacko8trm.png"></p><br><p>  Les d√©veloppeurs d'IdentityServer4 ont fait un excellent travail pour am√©liorer l'int√©gration de ASP.NET Identity et de l'infrastructure de serveur elle-m√™me.  Pour ajouter la possibilit√© d'utiliser des jetons OAuth2, vous devez compl√©ter notre projet avec de nouvelles instructions dans le code. </p><br><p>  Dans l'avant-derni√®re ligne de la m√©thode <em>Startup.ConfigureServices,</em> ajoutez la configuration des conventions IS4 sur ASP.NET Core Identity: </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;();</code> </pre> <br><p>  La m√©thode AddApiAuthorization indique au framework d'utiliser une configuration prise en charge sp√©cifique, principalement via le fichier appsettings.json.  Pour le moment, les capacit√©s de gestion IS4 int√©gr√©es ne sont pas si flexibles et doivent √™tre consid√©r√©es comme un point de d√©part pour la construction de vos applications.  Dans tous les cas, vous pouvez utiliser la version surcharg√©e de cette m√©thode et configurer les param√®tres plus en d√©tail via le rappel. </p><br><p>  Ensuite, nous appelons la m√©thode d'assistance, qui configure l'application pour v√©rifier les jetons JWT √©mis par le framework. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddIdentityServerJwt();</code> </pre> <br><p>  Enfin, dans la m√©thode <em>Startup.Configure,</em> ajoutez un middleware pour <br>  Fourniture de points de terminaison Open ID Connect </p><br><pre> <code class="cs hljs">app.UseAuthentication(); app.UseAuthorization(); app.UseIdentityServer();<span class="hljs-comment"><span class="hljs-comment">//&lt;-</span></span></code> </pre> <br><p>  Comme mentionn√© ci-dessus, les m√©thodes d'assistance utilis√©es lisent la configuration dans <br>  fichier de param√®tres d'application <em>appsettings.json</em> , dans lequel nous devons ajouter un nouveau <br>  Section <em>IdentityServer</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Clients"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"TestIdentityAngular"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Profile"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServerSPA"</span></span> } } }</code> </pre> <br><p>  Dans cette section, un client est d√©fini avec le nom TestIdentityAngular, que nous attribuerons au futur client navigateur et un profil de configuration sp√©cifique. </p><br><p>  Profils d'application est un nouvel outil de configuration d'IdentityServer qui fournit plusieurs configurations pr√©d√©finies avec la possibilit√© d'affiner certains param√®tres.  Nous utiliserons le profil <em>IdentityServerSPA</em> , con√ßu pour les cas o√π le client de navigateur et le framework sont situ√©s dans le m√™me projet et ont les param√®tres suivants: </p><br><ul><li>  La ressource redirect_uri est d√©finie sur <em>/ authentication / login-callback</em> . </li><li>  Ressource post_logout_redirect_uri, d√©finie sur <em>/ authentication / logout-callback.</em> </li><li>  L'ensemble des zones comprend openid, profile, pour chaque ressource API d'application. </li><li>  Ensemble de types de r√©ponses OIDC autoris√©s - jeton id_token </li><li>  GrantType pour le client - Implicite </li></ul><br><p>  D'autres profils possibles sont <em>SPA</em> (application sans IS4), <em>IdentityServerJwt</em> (API partag√©e avec IS4), <em>API</em> (API s√©par√©e). </p><br><p>  De plus, la configuration enregistre les ressources: </p><br><ul><li>  ApiResources: une ressource API nomm√©e &lt;&lt; appname &gt;&gt; API avec des propri√©t√©s pour tous les clients (*). </li><li>  IdentityServerResources: <em>IdentityResources.OpenId ()</em> et <em>IdentityResources.Profile ()</em> </li></ul><br><p>  Comme vous le savez, IdentityServer utilise des certificats pour signer des jetons, leurs param√®tres peuvent √©galement √™tre d√©finis dans le fichier de configuration, donc au moment du test, nous pouvons utiliser <br>  Certificat de test x509, pour cela, vous devez le sp√©cifier dans la section "Cl√©" du fichier <em>appsettings.Development.json</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Development"</span></span> } }</code> </pre> <br><p>  Nous pouvons maintenant dire que le backend qui vous permet d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">IdentityServer est pr√™t</a> et vous pouvez commencer √† impl√©menter l'application de navigateur. </p><br><h2 id="realizaciya-klienta-na-angular">  Impl√©mentation client angulaire </h2><br><p>  Notre SPA bas√© sur un navigateur sera √©crit sur la plate-forme Angular.  L'application contiendra deux pages, une pour les utilisateurs non autoris√©s et l'autre pour les utilisateurs authentifi√©s.  Les exemples utilisent la version 8.1.2 </p><br><p>  Tout d'abord, cr√©ez le futur cadre: </p><br><pre> <code class="plaintext hljs">ng new ClientApp</code> </pre> <br><p>  Dans le processus de cr√©ation, vous devez r√©pondre ¬´oui¬ª √† la proposition d'utiliser le routage.  Et stylisez un peu la page gr√¢ce √† la biblioth√®que de bootstrap: </p><br><pre> <code class="plaintext hljs">cd ClientApp ng add bootstrap</code> </pre> <br><p>  Ensuite, vous devez ajouter le support d'h√©bergement SPA √† notre application principale.  Vous devez d'abord corriger le projet csproj - ajoutez des informations sur notre application de navigateur. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp3.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span>Latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span>ClientApp\<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span>$(DefaultItemExcludes);$(SpaRoot)node_modules\**<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Exclude</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)node_modules\**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DebugEnsureNodeEnv"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BeforeTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" '$(Configuration)' == 'Debug' And !Exists('$(SpaRoot)node_modules') "</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"node --version"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContinueOnError</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExitCode"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ErrorCode"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Error</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(ErrorCode)' != '0'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Importance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"high"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Restoring dependencies using 'npm'. This may take several minutes..."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">WorkingDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"npm install"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Apr√®s cela, installez le package nuget sp√©cial pour prendre en charge les applications de navigateur. </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.SpaServices.Extensions -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  Et nous utilisons ses m√©thodes auxiliaires: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup. ConfigureServices: services.AddSpaStaticFiles(configuration =&gt; { configuration.RootPath = "ClientApp/dist"; }); //Startup. Configure: app.UseSpa(spa =&gt; { spa.Options.SourcePath = "ClientApp"; if (env.IsDevelopment()) { spa.UseAngularCliServer(npmScript: "start"); } });</span></span></code> </pre><br><p>  En plus d'appeler de nouvelles m√©thodes, vous devez supprimer les <em>pages</em> Razor <em>Index.chtml</em> et <em>_ViewStart.chtml</em> afin que les services SPA fournissent d√©sormais le contenu. </p><br><p>  Si tout a √©t√© fait conform√©ment aux instructions, au d√©marrage de l'application, la page par d√©faut appara√Ætra √† l'√©cran. </p><br><p><img src="https://habrastorage.org/webt/mv/lv/j6/mvlvj6_2aqcutz9t0_9eozhoxk8.png"></p><br><p>  Vous devez maintenant configurer le routage, pour cela nous ajoutons au projet 2 <br>  composant: </p><br><pre> <code class="plaintext hljs">ng generate component Home -t=true -s=true --skipTests=true ng generate component Data -t=true -s=true --skipTests=true</code> </pre> <br><p>  Nous les √©crivons dans la table de routage: </p><br><pre> <code class="plaintext hljs">const routes: Routes = [ { path: '', component: HomeComponent, pathMatch: 'full' }, { path: 'data', component: DataComponent } ];</code> </pre> <br><p>  Et nous modifions le fichier app.component.html pour afficher correctement les √©l√©ments de menu. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-brand"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Client App<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ngClass</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{"show": isExpanded}'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActiveOptions</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{ exact: true }'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/data"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Web api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align:center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> Welcome to {{ title }}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"router-outlet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  √Ä cette √©tape, vous pouvez terminer la pr√©paration de base du cadre d'application pour impl√©menter l'interaction via des jetons √©mis par IdentityServer. </p><br><p>  L'√©tape actuelle de pr√©paration du cadre de notre SPA peut √™tre qualifi√©e de termin√©e et nous devons maintenant commencer √† impl√©menter le module charg√© d'interagir avec la partie serveur √† l'aide des protocoles OpenID Connect et OAuth.  Heureusement, les d√©veloppeurs de Microsoft ont d√©j√† impl√©ment√© un tel code, et maintenant vous pouvez simplement leur emprunter ce module.  √âtant donn√© que mon article est √©crit sur la base de la pr√©-version 7 d'ASP.NET Core 3.0, nous prendrons tout le code en utilisant la balise de version ¬´v3.0.0-preview7.19365.7¬ª sur <a href="">github</a> . </p><br><p>  Avant d'importer le code, vous devez installer la biblioth√®que <em>client oidc</em> , qui <br>  fournit de nombreuses interfaces pour les applications de navigateur, ainsi que <br>  prend en charge la gestion des sessions utilisateur et des jetons d'acc√®s.  Pour <br>  Pour commencer √† l'utiliser, vous devez installer le package appropri√©. </p><br><pre> <code class="plaintext hljs">npm install oidc-client@1.8.0</code> </pre> <br><p>  Maintenant, dans notre SPA, il est n√©cessaire d'impl√©menter un module qui encapsule une interaction compl√®te selon les protocoles requis.  Pour ce faire, vous devez prendre l'int√©gralit√© du module ApiAuthorizationModule de l'√©tiquette de r√©f√©rentiel ASP.NET Core ci-dessus et ajouter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tous ses fichiers</a> √† l'application. </p><br><p>  De plus, vous devez l'importer dans le module principal de l'application AppModule: </p><br><pre> <code class="plaintext hljs">@NgModule({ declarations: [ AppComponent, HomeComponent, DataComponent ], imports: [ BrowserModule, HttpClientModule, ApiAuthorizationModule,//&lt;- AppRoutingModule ], providers: [], bootstrap: [AppComponent] }) export class AppModule { }</code> </pre> <br><p>  Pour afficher les nouveaux √©l√©ments de menu dans le module import√©, il existe un composant de <em>menu de connexion √† l'application</em> , <br>  il peut √™tre compl√®tement modifi√© pour r√©pondre √† vos besoins et ajouter <br>  un lien vers celui-ci dans la section de navigation de la <em>vue app.component.html</em> . </p><br><p>  Le module d'autorisation API pour configurer la connexion OpenID du client SPA doit utiliser un point de terminaison sp√©cial dans le backend de l'application, pour sa mise en ≈ìuvre nous <br>  doit suivre ces √©tapes: </p><br><ol><li>  Corrigez l'ID client conform√©ment √† ce que nous avons d√©fini dans le fichier de configuration appsettings.json dans la section IdentityServer: Clients, dans notre cas, il s'agit de TestIdentityAngular, il est √©crit dans la premi√®re ligne de l'ensemble de constantes api-autorisation.constants.ts. </li><li>  Ajouter un contr√¥leur OidcConfigurationController qui renverra directement la configuration √† l'application du navigateur </li></ol><br><p>  Le code du contr√¥leur cr√©√© est pr√©sent√© ci-dessous: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">ApiController</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OidcConfigurationController</span></span>: <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IClientRequestParametersProvider _clientRequestParametersProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OidcConfigurationController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IClientRequestParametersProvider clientRequestParametersProvider</span></span></span><span class="hljs-function">)</span></span> { _clientRequestParametersProvider = clientRequestParametersProvider; } [HttpGet(<span class="hljs-string"><span class="hljs-string">"_configuration/{clientId}"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClientRequestParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromRoute]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters = _clientRequestParametersProvider.GetClientParameters(HttpContext, clientId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(parameters); } }</code> </pre> <br><p>  Vous devez √©galement configurer la prise en charge de l'API ponctuelle pour l'application principale. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddControllers();//&lt;-  services.AddRazorPages(); //Startup. Configure: app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); endpoints.MapControllers(); });</span></span></code> </pre><br><p>  Il est maintenant temps de lancer l'application.  Deux √©l√©ments devraient appara√Ætre sur la page principale dans le menu sup√©rieur - <em>Connexion</em> et <em>Enregistrement</em> .  De plus, au d√©marrage, le module d'autorisation import√© demandera du c√¥t√© serveur la configuration client, qui sera ensuite prise en compte dans le protocole.  Un exemple de sortie de configuration est illustr√© ci-dessous: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"authority"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"client_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"TestIdentityAngular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/login-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"post_logout_redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/logout-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"response_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"id_token token"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServer4WebAppAPI openid profile"</span></span> }</code> </pre> <br><p>  Comme vous pouvez le voir, le client pendant l'interaction s'attend √† recevoir le jeton d'identification et le jeton d'acc√®s, et il est √©galement configur√© pour la zone d'acc√®s √† notre API. </p><br><p>  Maintenant, si nous s√©lectionnons l'√©l√©ment de menu <em>Login</em> , nous devrions √™tre redirig√©s vers la page de notre IdentityServer4 et ici nous pouvons entrer le login et le mot de passe, et s'ils sont corrects, nous serons imm√©diatement transf√©r√©s vers l'application de navigateur, qui √† son tour recevra <em>id_token</em> et <em>access_token</em> .  Comme vous pouvez le voir ci-dessous, le composant de menu de connexion √† l'application lui-m√™me a d√©termin√© que l'autorisation s'est termin√©e avec succ√®s et a affich√© un ¬´message d'accueil¬ª, ainsi qu'un bouton de <em>d√©connexion</em> . </p><br><p><img src="https://habrastorage.org/webt/cr/l-/aa/crl-aa3ehwgdjybwkmb7nbg92pk.png"></p><br><p>  Lorsque vous ouvrez les "outils de d√©veloppement" dans le navigateur, vous pouvez voir dans les coulisses toutes les interactions utilisant le protocole OIDC / OAuth.  Ceci obtient des informations sur le serveur d'autorisation <br>  via un point de terminaison <em>.connue / openid-configuration</em> et mise en commun des activit√©s de session via le point d'acc√®s connect / checksession.  De plus, le module d'autorisation est configur√© pour le m√©canisme de ¬´mise √† jour silencieuse des jetons¬ª, lorsque lorsque le jeton d'acc√®s expire, le syst√®me passe ind√©pendamment les √©tapes d'autorisation dans une iframe masqu√©e.  Vous pouvez d√©sactiver les mises √† jour automatiques des jetons en d√©finissant la valeur du param√®tre <em>includeIdTokenInSilentRenew</em> sur ¬´false¬ª dans le fichier <em>authorize.service.ts</em> . </p><br><p>  Vous pouvez maintenant g√©rer la restriction de l'acc√®s aux utilisateurs non autoris√©s √† partir des composants de l'application SPA, ainsi que de certains contr√¥leurs API √† l'arri√®re.  Afin de d√©montrer certaines API, nous allons cr√©er une classe <em>ExchangeRateItem</em> dans le dossier Models <em>,</em> ainsi qu'un contr√¥leur dans le dossier Controller qui renvoie des donn√©es al√©atoires. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Controller: [ApiController] public class ExchangeRateController { private static readonly string[] Currencies = new[] { "EUR", "USD", "BGN", "AUD", "CNY", "TWD", "NZD", "TND", "UAH", "UYU", "MAD" }; [HttpGet("api/rates")] public IEnumerable&lt;ExchangeRateItem&gt; Get() { var rng = new Random(); return Enumerable.Range(1, 5).Select(index =&gt; new ExchangeRateItem { FromCurrency = "RUR", ToCurrency = Currencies[rng.Next(Currencies.Length)], Value = Math.Round(1.0+ 1.0/rng.Next(1, 100),2) }) .ToArray(); } } //Models: public class ExchangeRateItem { public string FromCurrency { get; set; } public string ToCurrency { get; set; } public double Value { get; set; } }</span></span></code> </pre><br><p>  Ensuite, du c√¥t√© frontal, cr√©ez un nouveau composant qui recevra <br>  et afficher les donn√©es sur les taux de change du contr√¥leur nouvellement cr√©√©. </p><br><pre> <code class="plaintext hljs">ng generate component ExchangeRate -t=true -s=true --skipTests=true</code> </pre> <br><p>  Le contenu du composant doit ressembler √† ceci: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Component, OnInit, Input } from '@angular/core'; import { HttpClient } from '@angular/common/http'; import { Observable, of, Subject } from 'rxjs'; import { catchError } from 'rxjs/operators'; @Component({ selector: 'app-exchange-rate', template: ` &lt;div class="alert alert-danger" *ngIf="errorMessage | async as msg"&gt; {{msg}} &lt;/div&gt; &lt;table class='table table-striped'&gt; &lt;thead&gt; &lt;tr&gt; &lt;th&gt;From currency&lt;/th&gt; &lt;th&gt;To currency&lt;/th&gt; &lt;th&gt;Rate&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; &lt;tr *ngFor="let rate of rates | async"&gt; &lt;td&gt;{{ rate.fromCurrency }} &lt;/td&gt; &lt;td&gt;{{ rate.toCurrency }}&lt;/td&gt; &lt;td&gt;{{ rate.value }}&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;/table&gt; `, styles: [] }) export class ExchangeRateComponent implements OnInit { public rates: Observable&lt;ExchangeRateItem[]&gt;; public errorMessage: Subject&lt;string&gt;; @Input() public apiUrl: string; constructor(private http: HttpClient) { this.errorMessage = new Subject&lt;string&gt;(); } ngOnInit() { this.rates = this.http.get&lt;ExchangeRateItem[]&gt;("/api/"+this.apiUrl).pipe(catchError(this.handleError(this.errorMessage)) ); } private handleError(subject: Subject&lt;string&gt;): (te:any) =&gt; Observable&lt;ExchangeRateItem[]&gt; { return (error) =&gt; { let message = ''; if (error.error instanceof ErrorEvent) { message = `Error: ${error.error.message}`; } else { message = `Error Code: ${error.status}\nMessage: ${error.message}`; } subject.next(message); let emptyResult: ExchangeRateItem[] = []; return of(emptyResult); } } } interface ExchangeRateItem { fromCurrency: string; toCurrency: string; value: number; }</code> </pre> </div></div><br><p>  Il reste maintenant √† commencer √† l'utiliser sur la page des donn√©es d'application, simplement dans le mod√®le en √©crivant la ligne &lt;app-exchange-rate apiUrl = "rates"&gt; &lt;/app-exchange-rate&gt; et vous pouvez red√©marrer le projet.  Lorsque nous naviguerons le long du chemin cible, nous verrons que le composant a re√ßu les donn√©es et les a affich√©es dans un tableau. </p><br><p>  Ensuite, nous essaierons d'ajouter une demande d'autorisation d'acc√®s √† l'API du contr√¥leur. Pour ce faire, ajoutez l'attribut <em>[Authorize]</em> sur la classe <em>ExchangeRateController</em> et r√©ex√©cutez SPA, cependant, apr√®s avoir repass√© le composant qui appelle notre API, nous verrons une erreur, indiquant en-t√™tes d'autorisation. </p><br><p><img src="https://habrastorage.org/webt/fo/kv/ov/fokvovvxneeouxy0k30wuvlwj4u.png"></p><br><p>  Pour ajouter correctement un jeton d'autorisation aux demandes sortantes, vous pouvez <br>  Activez le m√©canisme d'interception des intercepteurs angulaires.  Heureusement, le module import√© contient d√©j√† le type n√©cessaire, il suffit de l'enregistrer dans le module de base de l'application. </p><br><pre> <code class="plaintext hljs">providers: [ { provide: HTTP_INTERCEPTORS, useClass: AuthorizeInterceptor, multi: true } ],</code> </pre> <br><p>  Apr√®s ces √©tapes, tout devrait fonctionner correctement.  Si vous regardez √† nouveau les outils de d√©veloppement, le navigateur verra le nouvel en-t√™te d'autorisation Bearer access_token.  Sur le backend, ce jeton sera valid√© par IdentityServer et il donnera √©galement la permission d'appeler un point API s√©curis√©. </p><br><p>  √Ä la fin de l'exemple d'int√©gration avec le serveur d'autorisation, vous pouvez mettre Activation Guard sur la route avec les donn√©es de taux de change dans le SPA, cela emp√™chera les utilisateurs de basculer vers la page s'ils ne sont pas actuellement autoris√©s.  Ce protecteur est √©galement pr√©sent√© dans le module pr√©c√©demment import√©, il vous suffit de l'accrocher sur la route cible. </p><br><pre> <code class="plaintext hljs">{ path: 'data', component: DataComponent, canActivate: [AuthorizeGuard] }</code> </pre> <br><p>  Maintenant, dans le cas o√π l'utilisateur ne s'est pas connect√© √† l'application et a s√©lectionn√© un lien vers notre composant prot√©g√©, il sera imm√©diatement redirig√© vers la page d'autorisation avec une demande pour entrer un identifiant et un mot de passe.  Le code r√©sultant est disponible sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> . </p><br><h2 id="podklyuchenie-vneshnego-vhoda-v-sistemu-cherez-postavschika-google">  Connexion d'une connexion externe via un fournisseur Google </h2><br><p>  Il existe un package Microsoft.AspNetCore.Authentication.Google Nuget distinct pour la connexion de connexion via les comptes Google pour ASP.NET core 1.1 / 2.0 +, cependant, en raison de changements dans la politique de l'entreprise elle-m√™me, Microsoft a des plans pour ASP.NET Core 3.0+ le reconna√Ætre comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">obsol√®te</a> .  Et maintenant, il est recommand√© de se connecter via la m√©thode auxiliaire <em>OpenIdConnectExtensions</em> et <em>AddOpenIdConnect</em> , que nous utiliserons dans cet article. </p><br><p>  Installez l'extension OpenIdConnect: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  Pour commencer, nous devons obtenir deux valeurs cl√©s de Google - Id Client et Client Secret, pour cela, il est propos√© d'effectuer les √©tapes suivantes: </p><br><ul><li>  Suivez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> et s√©lectionnez le bouton ¬´CONFIGURER UN PROJET¬ª. </li><li>  Dans la bo√Æte de dialogue qui appara√Æt, sp√©cifiez le serveur Web. </li><li>  Ensuite, dans la zone de texte "URI de redirection autoris√©e", sp√©cifiez le point de terminaison sur le c√¥t√© de la demande de redirection d'autorisation Google (puisque maintenant le site est situ√© √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https: // localhost: 44301 /</a> , nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sp√©cifions</a> ensuite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https: // localhost: 44301 / signin-google</a> ) </li><li>      ClientID  Client Secret. </li><li>         ,   ,   URL    . </li></ul><br><p>         <a href="">Secret Manager</a> .       ,    . </p><br><pre> <code class="plaintext hljs">dotnet user-secrets init dotnet user-secrets set "Authentication:Google:ClientId" "  ClientID" dotnet user-secrets set "Authentication:Google:ClientSecret" "  ClientSecret"</code> </pre> <br><p>           Google. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddOpenIdConnect(<span class="hljs-string"><span class="hljs-string">"Google"</span></span>, <span class="hljs-string"><span class="hljs-string">"Google"</span></span>, o =&gt; { IConfigurationSection googleAuthNSection = Configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"Authentication:Google"</span></span>); o.ClientId = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientId"</span></span>]; o.ClientSecret = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientSecret"</span></span>]; o.Authority = <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com"</span></span>; o.ResponseType = OpenIdConnectResponseType.Code; o.CallbackPath = <span class="hljs-string"><span class="hljs-string">"/signin-google"</span></span>; }) .AddIdentityServerJwt();</code> </pre> <br><p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>     ,    <br>      Google.     ,    ,       SPA          . </p><br><p><img src="https://habrastorage.org/webt/xi/rl/5h/xirl5hobkgfaukb4wzp5sibosj4.png"></p><br><p>  ,  ,     OAuth ,       .   Nuget        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . </p><br><h2 id="dorabotka-vozmozhnosti-vhoda-pod-polzovatelyami-windows">      Windows </h2><br><p>   ,  SPA           Microsoft,       ActiveDirectory.  ,       Html    ASP.NET, WebForms  ..,      Windows        WindowsIdentity, ,       .     Identity Server,         Windows,              claims <em>id_token</em>  <em>access_token</em> .  ,  IS4    ,        ,    <br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> . ,             ASP.NET Core Identity 3.0. </p><br><p>          Identity,    Razor  <em>Login</em>  <em>ExternalLogin</em>    ( CLI aspnet-codegenerator    ): </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.EntityFrameworkCore.SqlServer dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design dotnet aspnet-codegenerator identity -dc IdentityServer4WebApp.Data.ApplicationDbContext --files "Account.Login;Account.ExternalLogin"</code> </pre> <br><p>    ,     Area   <em>Identity</em>    ,          . </p><br><p>         ,       .   ,  Identity      I <em>AuthenticationSchemeProvider. GetAllSchemesAsync()</em>   DisplayName != null,    Windows   DisplayName = null.     LoginModel    <em>OnGetAsync</em>   : </p><br><pre> <code class="cs hljs">ExternalLogins = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.GetExternalAuthenticationSchemesAsync()).ToList(); <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt; &gt;&gt; ExternalLogins =(await _schemeProvider.GetAllSchemesAsync()).Where(x =&gt; x.DisplayName != null ||(x.Name.Equals(IISDefaults.AuthenticationScheme,StringComparison.OrdinalIgnoreCase))).ToList();</span></span></code> </pre> <br><p>         <em>private readonly</em> <em>AuthenticationSchemeProvider _schemeProvider</em> .    View         <em>Login.cshtml</em> : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @provider.DisplayName account"</span></span></span><span class="hljs-tag">&gt;</span></span>@provider.DisplayName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;&lt; &gt;</span></span>&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @(provider.DisplayName ??provider.Name) account"</span></span></span><span class="hljs-tag">&gt;</span></span>@(provider.DisplayName ??provider.Name)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  ,  windows      <em>launchSettings.json</em> <br> (   IIS,       <em>web.config</em> ). </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"iisSettings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"windowsAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"anonymousAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iisExpress"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"applicationUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:15479"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sslPort"</span></span>: <span class="hljs-number"><span class="hljs-number">44301</span></span> } },</code> </pre> <br><p>        ¬´Windows¬ª    . </p><br><p><img src="https://habrastorage.org/webt/e_/6s/-m/e_6s-m8ot5h52dv6dgvid8bgpky.png"></p><br><p>     SPA      IdentityServer     .    ¬´¬ª    <em>[AllowAnonymous]</em>    <em>LoginModel</em>   <em>[Authorize(AuthenticationSchemes = "Windows")]</em> ,     ,       WindowsIdentity. </p><br><p>    <em>ExternalLogin</em> ,   Identity    Windows .      <em>ProcessWindowsLoginAsync</em> . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;IActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessWindowsLoginAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnUrl</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.AuthenticateAsync(IISDefaults.AuthenticationScheme); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result?.Principal <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WindowsPrincipal wp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redirectUrl = Url.Page(<span class="hljs-string"><span class="hljs-string">"./ExternalLogin"</span></span>, pageHandler: <span class="hljs-string"><span class="hljs-string">"Callback"</span></span>, values: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { returnUrl }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = _signInManager.ConfigureExternalAuthenticationProperties(IISDefaults.AuthenticationScheme, redirectUrl); props.Items[<span class="hljs-string"><span class="hljs-string">"scheme"</span></span>] = IISDefaults.AuthenticationScheme; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsIdentity(IISDefaults.AuthenticationScheme); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Subject, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Name, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(ClaimTypes.NameIdentifier, wp.Identity.Name)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wi = wp.Identity <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> WindowsIdentity; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> groups = wi.Groups.Translate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(NTAccount)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hasUsersGroup = groups.Any(i =&gt; i.Value.Contains(<span class="hljs-string"><span class="hljs-string">@"BUILTIN\Users"</span></span>, StringComparison.OrdinalIgnoreCase)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>, hasUsersGroup.ToString())); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.SignInAsync(IdentityConstants.ExternalScheme, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsPrincipal(id), props); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect(props.RedirectUri); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Challenge(IISDefaults.AuthenticationScheme); }</code> </pre> </div></div><br><p>       ,             . </p><br><p>    <em>ExternalLoginModel.OnPost</em>          : </p><br><pre> <code class="plaintext hljs">if (IISDefaults.AuthenticationScheme == provider) { return await ProcessWindowsLoginAsync(returnUrl); }</code> </pre> <br><p>    Claim  Windows      Claim ¬´hasUsersGroup¬ª,       ID  access,    .      ASP.NET Identity     UserClaims.        <em>ExternalLoginModel</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateClaims</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExternalLoginInfo info, ApplicationUser user, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] claimTypes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (claimTypes == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimTypesHash = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(claimTypes); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetClaimsAsync(user)).Where(c =&gt; claimTypesHash.Contains(c.Type)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.RemoveClaimsAsync(user, claims); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> claimTypes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.Principal.HasClaim(c =&gt; c.Type == claimType)) { claims = info.Principal.FindAll(claimType).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddClaimsAsync(user, claims); } } }</code> </pre> <br><p>       <em>OnPostConfirmationAsync</em> (    <br>     ). </p><br><pre> <code class="cs hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddLoginAsync(user, info); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.SignInAsync(user, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); _logger.LogInformation(<span class="hljs-string"><span class="hljs-string">"User created an account using {Name} provider."</span></span>, info.LoginProvider); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">// return LocalRedirect(returnUrl); }</span></span></code> </pre> <br><p>    <em>OnGetCallbackAsync</em> ,      . </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.ExternalLoginSignInAsync(info.LoginProvider, info.ProviderKey, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, bypassTwoFactor : <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.FindByLoginAsync(info.LoginProvider, info.ProviderKey); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">//</span></span></code> </pre> <br><p>  ,        WebAPI   <br>  ¬´hasUsersGroup¬ª.      ¬´ShouldHasUsersGroup¬ª </p><br><pre> <code class="cs hljs">services.AddAuthorization(options =&gt; { options.AddPolicy(<span class="hljs-string"><span class="hljs-string">"ShouldHasUsersGroup"</span></span>, policy =&gt; { policy.RequireClaim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);}); });</code> </pre> <br><p>    <em>ExchangeRateController</em>       <br>     Policy. </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Authorize(Policy = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ShouldHasUsersGroup"</span></span></span><span class="hljs-meta">)</span></span>] [HttpGet(<span class="hljs-string"><span class="hljs-string">"api/internalrates"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;ExchangeRateItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInternalRates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get().Select(i=&gt;{i.Value=Math.Round(i.Value<span class="hljs-number"><span class="hljs-number">-0.02</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i;}); }</code> </pre> <br><p>   view    . </p><br><pre> <code class="plaintext hljs">ng generate component InternalData -t=true -s=true --skipTests=true</code> </pre> <br><p>    template          . </p><br><pre> <code class="html hljs xml">//internal-data.component.ts: template: `<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apiUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"internalrates"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag">&gt;</span></span> `, //app-routing.module.ts: { path: ' internaldata', component: InternalDataComponent, canActivate: [AuthorizeGuard] } //app.component.html: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/internaldata"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Internal api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>             <br> , ,    .   ,  accsee_token    <br>   claim   <em>hasUsersGroup</em> ,       <br>     ApiResources  .  ,    ,        <em>appsettings.json</em> ,           <em>Startup. ConfigureServices</em> . </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;(options =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiResource = options.ApiResources.First(); apiResource.UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }; });</code> </pre> <br><p> ,     ,    windows      ,         . </p><br><p>       ,   ‚Äì  Guard    claim   ¬´hasUsersGroup¬ª     ¬´  ¬ª.    Guard  : </p><br><pre> <code class="plaintext hljs">ng generate guard AuthorizeWindowsGroupGuard --skipTests=true</code> </pre> <br><p>      : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Injectable } from '@angular/core'; import { Observable } from 'rxjs'; import { map,tap} from 'rxjs/operators'; import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router, UrlTree } from '@angular/router'; import { AuthorizeService } from "./authorize.service"; import { ApplicationPaths, QueryParameterNames } from './api-authorization.constants'; @Injectable({ providedIn: 'root' }) export class AuthorizeWindowsGroupGuardGuard implements CanActivate{ constructor(private authorize: AuthorizeService, private router: Router) {} canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable&lt;boolean | UrlTree&gt; | Promise&lt;boolean | UrlTree&gt; | boolean | UrlTree { return this.authorize.getUser().pipe(map((u: any) =&gt; !!u &amp;&amp; !!u.hasUsersGroup)).pipe(tap((isAuthorized:boolean) =&gt; this.handleAuthorization(isAuthorized, state)));; } private handleAuthorization(isAuthenticated: boolean, state: RouterStateSnapshot) { if (!isAuthenticated) { window.location.href = "/Identity/Account/Login?" + QueryParameterNames.ReturnUrl + "=/"; } } }</code> </pre> </div></div><br><p> , ,         . </p><br><pre> <code class="plaintext hljs">{ path: 'internaldata', component: InternalDataComponent, canActivate: [AuthorizeWindowsGroupGuardGuard]</code> </pre> <br><p>     IdentityServer,      claims ( <em>sub</em> , <em>profile</em> ),     ¬´hasUsersGroup¬ª.      IdentityResource, -        IdentityResources          <em>Startup.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identityResource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdentityResource { Name = <span class="hljs-string"><span class="hljs-string">"customprofile"</span></span>, DisplayName = <span class="hljs-string"><span class="hljs-string">"Custom profile"</span></span>, UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }, }; identityResource.Properties.Add(ApplicationProfilesPropertyNames.Clients, <span class="hljs-string"><span class="hljs-string">"*"</span></span>); options.IdentityResources.Add(identityResource);</code> </pre> <br><p> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>   ,         windows    ¬´ ¬ª   SPA ‚Äì   ,     ,    Guard    . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p> ,  ASP.NET Core 3.0            IdentityServer4,         .      preview ,       .   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a>   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461433/">https://habr.com/ru/post/fr461433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461417/index.html">Comment j'ai refus√© DB4O dans un syst√®me industriel</a></li>
<li><a href="../fr461421/index.html">Comment vous assurer contre d'√©ventuelles pertes lors d'un investissement en bourse: produits structurels</a></li>
<li><a href="../fr461423/index.html">11 conseils: comment pr√©senter le travail UI / UX √† des ¬´non-concepteurs¬ª</a></li>
<li><a href="../fr461425/index.html">Comment devenir chef de produit et √©voluer</a></li>
<li><a href="../fr461431/index.html">¬´Aime et n'aime pas¬ª: DNS sur HTTPS</a></li>
<li><a href="../fr461435/index.html">Reconnaissance des √©motions √† l'aide d'un r√©seau neuronal convolutif</a></li>
<li><a href="../fr461437/index.html">370 ampoules</a></li>
<li><a href="../fr461439/index.html">D√©marrage de la biblioth√®que de composants React et TypeScript</a></li>
<li><a href="../fr461441/index.html">Rapports sur l'√©tat du stockage √† l'aide de R. Calcul parall√®le, graphiques, xlsx, e-mail et tout cela</a></li>
<li><a href="../fr461443/index.html">Post-analyse: ce que l'on sait de la derni√®re attaque contre le r√©seau de serveurs de cl√©s cryptographiques SKS Keyserver</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>