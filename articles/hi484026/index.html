<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯФ╝ ЁЯСиЁЯП┐тАНЁЯОд ЁЯО╡ рднрд╛рдЧ 6: рдкреЛрд░реНрдЯрд┐рдВрдЧ рдореЗрдордЯреЗрд╕реНрдЯреА + рд╕реЗ рдЖрд░рдЖрдИрдПрд╕рд╕реА-рд╡реА ЁЯУ╕ тЪкя╕П ЁЯзЮ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╢рд╛рдпрдж рдХреБрдЫ рдЖрдИрдЯреА рд▓реЛрдЧреЛрдВ рдХреЛ рдпрд╣ рд╕рдордЭрд╛рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ рдХрд┐ рдореЗрдореЗрд╕реНрдЯреЛрд░реА + рдХреНрдпрд╛ рд╣реИ - рд╢рд╛рдпрдж рдпрд╣ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдкреАрд╕реА рдкрд░ рд░реИрдо рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдо рдпрд╛ рдЬреНрдпрд╛рджрд╛ рдорд╛рдирдХ рдмрди рдЧрдпрд╛ рд╣реИред...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рднрд╛рдЧ 6: рдкреЛрд░реНрдЯрд┐рдВрдЧ рдореЗрдордЯреЗрд╕реНрдЯреА + рд╕реЗ рдЖрд░рдЖрдИрдПрд╕рд╕реА-рд╡реА</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484026/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ne/fb/ha/nefbhar5ihkfmvccfwp0jqrm78u.png"></div><br><p> рд╢рд╛рдпрдж рдХреБрдЫ рдЖрдИрдЯреА рд▓реЛрдЧреЛрдВ рдХреЛ рдпрд╣ рд╕рдордЭрд╛рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ рдХрд┐ рдореЗрдореЗрд╕реНрдЯреЛрд░реА + рдХреНрдпрд╛ рд╣реИ - рд╢рд╛рдпрдж рдпрд╣ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдкреАрд╕реА рдкрд░ рд░реИрдо рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдо рдпрд╛ рдЬреНрдпрд╛рджрд╛ рдорд╛рдирдХ рдмрди рдЧрдпрд╛ рд╣реИред  рдЬрдм <a href="https://habr.com/ru/post/459470/">рдкрд┐рдЫрд▓реЗ рд╣рд┐рд╕реНрд╕реЛрдВ</a> рдореЗрдВ рд╕реЗ рдПрдХ рдореЗрдВ рдореИрдВ рдПрдХ рдЯреВрдЯреА рд╣реБрдИ рдореЗрдореЛрд░реА рдмрд╛рд░ рдореЗрдВ рдЖрдпрд╛ рдерд╛ рдЬреЛ рдмреЛрд░реНрдб рдХреЗ рд╕рд╛рде рдмрдВрдбрд▓ рдореЗрдВ рдЖрдпрд╛ рдерд╛, рддреЛ рдпрд╣ (рдПрдХ рдбреАрдбреАрдЖрд░ 2-рд╕рдХреНрд╖рдо рдиреЗрдЯрдмреБрдХ рдХреЗ рд╕рд╛рде) рдПрдХ рд╕реНрдкрд╖реНрдЯ рд╕рдорд╛рдзрд╛рди рд▓рдЧ рд░рд╣рд╛ рдерд╛ред  рдПрдХ рдФрд░ рд╕рд╡рд╛рд▓ рдпрд╣ рд╣реИ рдХрд┐ рд╡рд╣рд╛рдБ, рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдЕрд╕реНрдерд┐рд░ рд╕рдВрдЪрд╛рд▓рди рдирдЧреНрди рдЖрдВрдЦреЛрдВ рдХреЛ рджрд┐рдЦрд╛рдИ рджреЗ рд░рд╣рд╛ рдерд╛ред  рдЕрдзрд┐рдХ рдкреЗрдЪреАрджрд╛ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдореИрдВрдиреЗ рд╕реБрдирд╛ рд╣реИ рдХрд┐ рдЗрдиреНрдлрд┐рдирд┐рдЯреА рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдХреЛрд╢рд┐рдХрд╛рдУрдВ рдХреЗ рдХреЗрд▓реЗрд▓ "рдЯреИрдкрд┐рдВрдЧ" рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдЙрдкрдХрд░рдг рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рдбреЗрдЯрд╛ рдкреИрдЯрд░реНрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕ рдкрд░ рдбреАрдбреАрдЖрд░ рдСрдкрд░реЗрд╢рди рдореЗрдВ рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреА рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдПрдХ рдЕрджреНрднреБрдд рдмрд╛рдд, рдпрд╣ рдПрдХ рджрдпрд╛ рд╣реИ рдХрд┐ рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдирд╛рдо рдореЗрдВ рдпрд╣ рднреА рдХрд╣рд╛ рдЧрдпрд╛ рд╣реИ: 86 - "рдХреЗрд╡рд▓ x86- рд╕рдВрдЧрдд рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдПред"  рдпрд╛ рдирд╣реАрдВ? </p><br><p>  рдХрдЯ рдХреЗ рддрд╣рдд рдЖрдк RISC-V рдФрд░ рдЙрдк-рдпреЛрдЧ рдореЗрдореЗрд╕реНрдЯреЛрд░реА + v5.1 рдХреЛ рдкреЛрд░реНрдЯ рдХрд░рдиреЗ рдХреЗ рдореЗрд░реЗ рдкреНрд░рдпрд╛рд╕реЛрдВ рдХреЛ рджреЗрдЦреЗрдВрдЧреЗред  <em>Spoiler: рдпрд╣ рдЪрд▓рддрд╛ рд╣реИ!</em> </p><a name="habracut"></a><br><p>  <strong>рдЕрд╕реНрд╡реАрдХрд░рдг: рдкрд░рд┐рдгрд╛рдореА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдмреЛрд░реНрдб рдкрд░ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░реЙрдХреЗрдЯ рд╡рд┐рдзрд╛рдирд╕рднрд╛ рдкрд░ рдореЗрд░реЗ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред</strong>  <strong>рд╕рдЯреАрдХрддрд╛ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ (рд╡рд┐рд╢реЗрд╖рдХрд░ рдЕрдиреНрдп рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдкрд░) рдХреА рдЧрд╛рд░рдВрдЯреА рдирд╣реАрдВ рд╣реИред</strong>  <strong>рдЕрдкрдиреЗ рдЬреЛрдЦрд┐рдо рдкрд░ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред</strong>  <strong>рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЖрд░рдХреНрд╖рд┐рдд рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЛ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдпрджрд┐ рд╡реЗ рд░реИрдо рд░реЗрдВрдЬ рдореЗрдВ рдЖрддреЗ рд╣реИрдВред</strong> </p><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдХрд╣рд╛, рдмрд╣реБрдд рдкрд╣рд▓реЗ рдирд╣реАрдВ рдореИрдВрдиреЗ рдЕрд▓реАрдПрдХреНрд╕рдкреНрд░реЗрд╕ рдкрд░ рд╕рд╛рдЗрдХреНрд▓реЛрди IV рдХреЗ рд╕рд╛рде рдПрдХ рдорджрд░рдмреЛрд░реНрдб рдЦрд░реАрджрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЗрд╕рдореЗрдВ рдореЗрдореЛрд░реА рдЫреЛрдЯреА рдереАред  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рдЗрд╕ рдмреЛрд░реНрдб рдХреА рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдкрд╛рд░рдВрдкрд░рд┐рдХ DDR2 SO-DIMM рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдерд╛ - рдореЗрд░реА рдкреБрд░рд╛рдиреА рдиреЗрдЯрдмреБрдХ рдХреА рддрд░рд╣ред  рдлрд┐рд░ рднреА, рдпрд╣ рджрд┐рд▓рдЪрд╕реНрдк рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдмреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП, рдореЗрдореЛрд░реА рдореЙрдбреНрдпреВрд▓ рдХреЗ рдкрд░реАрдХреНрд╖рдг рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрд╡-рд╣реЛрд╕реНрдЯреЗрдб рд╕рдорд╛рдзрд╛рди (рдФрд░, рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдирд┐рдпрдВрддреНрд░рдХ рднреА)ред  рдмреБрд░реА рдпрд╛рджреЛрдВ рдХреА рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдореЗрд░реА рдЧрд▓рддрд┐рдпреЛрдВ рдХреЛ рдбрд┐рдмреЗрдЯ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рдкреНрд░рд╕рдиреНрди рдирд╣реАрдВ рдереАред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдПрдХ рддреНрд╡рд░рд┐рдд рд╕рдорд╛рдзрд╛рди рдХреА рдЙрдореНрдореАрдж рдирд╣реАрдВ рд╣реИ рдФрд░ рдорд╛рдирд╕рд┐рдХ рд░реВрдк рд╕реЗ рдЕрдирд┐рд╢реНрдЪрд┐рдд рдХрд╛рд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдиреНрдп рдХреЛрдбрд╛рдВрддрд░рдХ рдореЗрдВ рдкреВрд░реНрдг рдкреБрдирд░реНрд▓реЗрдЦрди рдХреЛ рд╕реНрдердЧрд┐рдд рдХрд░рдиреЗ рдХреА рддреИрдпрд╛рд░реА рдХрд░ рд░рд╣рд╛ рд╣реИ, рдореИрдВрдиреЗ рдореЗрдордЯреЗрд╕реНрдЯреА + рдкрд░ рдПрдХ рд╡рд┐рдХрд┐рдкреАрдбрд┐рдпрд╛ рд▓реЗрдЦ рдЦреЛрд▓рд╛ рдФрд░ рдЕрдЪрд╛рдирдХ рдХрд╛рд░реНрдб рдореЗрдВ "рд▓рд┐рдЦрд┐рдд: рд╕реА рдФрд░ рд╡рд┐рдзрд╛рдирд╕рднрд╛" рд▓рд┐рдЦрд╛ред  рд╣рдореНрдо, рд╡рд╣ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╡рд╣ "... 86" рд╣реИ, рд▓реЗрдХрд┐рди рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдХреЛрдбрд╛рдВрддрд░рдХ рдореЗрдВ рдирд╣реАрдВ рд▓рд┐рдЦрд╛ рд╣реИ?  рдпрд╣ рдЙрддреНрд╕рд╛рд╣рдЬрдирдХ рд╣реИред  рдпрд╣ рдХреЗрд╡рд▓ рд░рд┐рд╢реНрддреЗ рдХреЛ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдмрдиреА рд╣реБрдИ рд╣реИред </p><br><p>  рддреЛ, <a href="http://www.memtest.org/" rel="nofollow">memtest.org</a> рдкрд░ <a href="http://www.memtest.org/" rel="nofollow">рдЬрд╛рдПрдВ</a> рдФрд░ GPL2 рдХреЗ рддрд╣рдд рд╕рдВрд╕реНрдХрд░рдг 5.01 рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВред  рд╡рд┐рдХрд╛рд╕ рдореЗрдВ рдЖрд╕рд╛рдиреА рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдЗрд╕реЗ GitHub рдкрд░ <a href="https://github.com/atrosinenko/memtest86-plus-riscv" rel="nofollow">рдкреБрдирдГ рд▓реЛрдб</a> рдХрд┐рдпрд╛ред  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рд╕реНрд░реЛрдд рд╕рдВрдЧреНрд░рд╣ рдореЗрдВ рд╣реА рд╕рд╣реА, рд╣рдореЗрдВ <a href="https://github.com/atrosinenko/memtest86-plus-riscv/blob/68b365d13cf22accd52f88af49c33f57c6643ae5/README.background" rel="nofollow">README.background</a> рдлрд╝рд╛рдЗрд▓ рджреНрд╡рд╛рд░рд╛ рдмрдзрд╛рдИ рджреА рдЬрд╛рддреА рд╣реИ, рд╣рдХрджрд╛рд░ </p><br><blockquote>  рдореЗрдореНрдиреЗрд╕реНрдЯреЛрд░реА-рдПрд╕рдПрдордкреА рдХреЗ рдПрдирд╛рдЯреЙрдореА рдФрд░ рдлрд┐рдЬрд┐рдпреЛрд▓реЙрдЬреА </blockquote><p> рдпрд╣ рдХреБрдЫ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдмрддрд╛рддрд╛ рд╣реИ (рдФрд░ рдПрдПрд╕рд╕реАрдЖрдИрдЖрдИ-рдХрд▓рд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рддреНрд░реЛрдВ рдХреЗ рд╕рд╛рде) рдХреЛрдб рдХреЗ рдЙрдЪреНрдЪ-рд╕реНрддрд░реАрдп рд╕рдВрдЪрд╛рд▓рдиред  рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ, рд╣рдореЗрдВ рдПрдХ <em>рдмрд╛рдЗрдирд░реА рд▓реЗрдЖрдЙрдЯ рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИ</em> , рдЬрд┐рд╕рдореЗрдВ <code>setup.o</code> , <code>head.o</code> , <code>head.o</code> рдФрд░ рдХреБрдЫ <code>memtest_shared</code> ред  рдпрд╣ рджреЗрдЦрдирд╛ рдЖрд╕рд╛рди рд╣реИ рдХрд┐ рдЗрди рддреАрди рдСрдмреНрдЬреЗрдХреНрдЯ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╕рдВрдмрдВрдзрд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ рд╕реНрд░реЛрддреЛрдВ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдкрд╣рд▓реА рдирдЬрд╝рд░ рдореЗрдВ, рдмрд╛рдХреА рд╕рдм рд╕реА рдореЗрдВ рд▓рд┐рдЦрд╛ рд╣реИ!  рдмреБрд░рд╛ рдирд╣реАрдВ, рдмреБрд░рд╛ рдирд╣реАрдВ ... </p><br><p>  рдирддреАрдЬрддрди, рдореИрдВрдиреЗ <code>Makefile</code> рдХреЛ <code>Makefile.arch</code> рдХреЙрдкреА рдХрд┐рдпрд╛ рдФрд░ рд╕рдм рдХреБрдЫ рдлрд┐рд░ рд╕реЗ рд▓рд┐рдЦрдирд╛ рд╢реБрд░реВ рдХрд░ рджрд┐рдпрд╛, рдФрд░ рдЬреЛ рдХреБрдЫ рднреА рдЕрдиреБрд░реВрдк рдирд╣реАрдВ рд╣реИ рдЙрд╕реЗ рдмрд╛рд╣рд░ рдлреЗрдВрдХрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХреАред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдореБрдЭреЗ RISC-V рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреВрд▓рдХрд┐рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА, рдЬреЛ рдХрд┐ рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рдкрд┐рдЫрд▓реЗ рдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рдмрд╛рдж рднреА рдореЗрд░реЗ рд╕рд╛рде рд╣реИред  рдкрд╣рд▓реЗ рддреЛ рдореИрдВрдиреЗ 32-рдмрд┐рдЯ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЛрд░реНрдЯ рдмрдирд╛рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реЛрдЪрд╛, рд▓реЗрдХрд┐рди рдлрд┐рд░ рдореБрдЭреЗ рдпрд╛рдж рдЖрдпрд╛ рдХрд┐ рдПрдХ 64-рдмрд┐рдЯ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдмреЛрд░реНрдб рдкрд░ рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдореЗрд░реЗ рдкрд╛рд╕ <code>riscv64-</code> рдЙрдкрд╕рд░реНрдЧ рдХреЗ рд╕рд╛рде <code>riscv64-</code> ред </p><br><p>  <em>рдЧреАрддрд╛рддреНрдордХ рд╡рд┐рд╖рдпрд╛рдВрддрд░:</em> рдмреЗрд╢рдХ, 32- рдФрд░ 64-рдмрд┐рдЯ рдХреЛрдб рдХреА рд╕рдВрдЧрддрддрд╛ рдХреЗ рдореБрджреНрджреЗ рдХрд╛ рдЕрдзреНрдпрдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реА рдмрд╛рдд рдереАред  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, <code>1.3 RISC-V ISA Overview</code> рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдХреЗ рдкреИрд░рд╛ <code>1.3 RISC-V ISA Overview</code> рдореЗрдВ ISA (рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рд╕реЗрдЯ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░) рдХреЗ рдЕрдирдкреЗрдХреНрд╖рд┐рдд рднрд╛рдЧ рдХреЗ рд▓рд┐рдП рд╡рд┐рдирд┐рд░реНрджреЗрд╢рди: </p><br><blockquote>  рдЖрдзрд╛рд░ рдЖрдИрдПрд╕рдП рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЕрд▓рдЧ рдХрд░рдиреЗ рдХрд╛ рдореБрдЦреНрдп рд▓рд╛рдн рдпрд╣ рд╣реИ рдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдЖрдзрд╛рд░ рдЖрдИрдПрд╕рдП рдХреЛ рдЕрдиреНрдп рдЖрдзрд╛рд░ рдЖрдИрдПрд╕рдП рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рдмрд┐рдирд╛ рдЕрдкрдиреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, RV64I рдирд┐рд░реНрджреЗрд╢ рдФрд░ CSR рдХреЛ рдЫреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдХреЗрд╡рд▓ RV32I рдореЗрдВ рд╕рдВрдХрд░реЗ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рд╕реЗ рдирд┐рдкрдЯрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВред  RV32I рд╡рд┐рдХрд▓реНрдк рдПрдиреНрдХреЛрдбрд┐рдВрдЧ рд╕реНрдерд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдиреНрдпрдерд╛ рдХреЗрд╡рд▓ рд╡реНрдпрд╛рдкрдХ рдкрддреЗ-рд╕реНрдерд╛рди рд╡реЗрд░рд┐рдПрдВрдЯ рджреНрд╡рд╛рд░рд╛ рдЖрд╡рд╢реНрдпрдХ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рд▓рд┐рдП рдЖрд░рдХреНрд╖рд┐рдд рд╣реИрдВред </blockquote><p>  рдореИрдВ рдпрд╣ рднреА рдиреЛрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ рдХрд┐ <code>riscv64-</code> рдЙрдкрд╕рд░реНрдЧ рдХреЗ рд╕рд╛рде <code>riscv64-</code> 32-рдмрд┐рдЯ рдХреЛрдб рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдЗрдХрдЯреНрдард╛ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдЕрдЧрд░ рд▓рдХреНрд╖реНрдп рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдЪреБрдирд╛ рдЧрдпрд╛ рд╣реИ - рдмрд╛рдж рдореЗрдВ рдЙрд╕ рдкрд░ рдФрд░ рдЕрдзрд┐рдХред </p><br><p>  рдкреЛрд░реНрдЯ рдХрд░рддреЗ рд╕рдордп, рдЗрди рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЛ рдХрд╛рдо рдореЗрдВ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рд╕рдордЭ рдореЗрдВ рдЖрддрд╛ рд╣реИ: </p><br><ul><li>  <a href="https://riscv.org/specifications/" rel="nofollow">RISC-V рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рд╕реЗрдЯ рдореИрдиреБрдЕрд▓ рд╡реЙрд▓реНрдпреВрдо I: рдЕрдирдкреНрд░реАрд╡рд┐рд▓рд╛рдЗрдЬреНрдб ISA</a> </li><li>  <a href="https://riscv.org/specifications/privileged-isa/" rel="nofollow">RISC-V рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рд╕реЗрдЯ рдореИрдиреБрдЕрд▓ рд╡реЙрд▓реНрдпреВрдо II: рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░</a> </li><li>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдХреБрдЫ <a href="https://sifive.cdn.prismic.io/sifive%252F834354f0-08e6-423c-bf1f-0cb58ef14061_fu540-c000-v1.0.pdf" rel="nofollow">SiFive FU540-C000 рдореИрдиреБрдЕрд▓</a> - рдЪрд┐рдк рдХреЗ рд▓рд┐рдП рдПрдХ рдореИрдиреБрдЕрд▓, рд╕реЙрдлреНрдЯ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд╕рдорд╛рди рд╡реНрдпрд╡рд╣рд╛рд░, рдЬреЛ рдХрд┐ FPGAs рдореЗрдВ рдбреАрдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрдЧрд╣ рд╕реЗ рдмрд╛рд╣рд░ рдирд╣реАрдВ рд╣реЛрдЧрд╛ </li></ul><br><h2 id="nastroyka-sborki">  рд╕реЗрдЯрдЕрдк рдмрдирд╛рдПрдБ </h2><br><p>  рдЖрдЗрдП рд╕рд╣рдордд рд╣реЛрдХрд░ рд╢реБрд░реВ рдХрд░реЗрдВ: рдореИрдВ x86 рдФрд░ RISC-V рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдЕрдиреНрдп рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд▓рд┐рдП рдЖрдЧреЗ рдХреЗ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВред  рдореИрдВ рдмреВрдЯ рдлрд╝реНрд▓реЙрдкреАрдЬрд╝ рдФрд░ рдЕрдиреНрдп x86 рдмрд╛рд░реАрдХрд┐рдпреЛрдВ рдХреЛ рдХреНрд░реЙрд╕-рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдмрд┐рд▓реНрдб рд╕реЗ рдмрд╛рд╣рд░ рдлреЗрдВрдХрдиреЗ рдХрд╛ рдкреНрд░рд╕реНрддрд╛рд╡ рдХрд░рддрд╛ рд╣реВрдВред </p><br><p>  рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЖрдЦрд┐рд░рдХрд╛рд░ рдХреНрдпрд╛ рд╣реИ: рддреАрди <code>setup.S</code> рдлрд╛рдЗрд▓реЗрдВ рд╣реИрдВ: <code>setup.S</code> , <code>setup.S</code> рдФрд░ <code>head.S</code>  рдкрд╣рд▓реЗ рджреЛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗрд╡рд▓ рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдкрд░ рд╣реЛрддреА рд╣реИ, рдФрд░ рддреАрд╕рд░реЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рддрдм рд╣реЛрддреА рд╣реИ рдЬрдм рдХрд┐рд╕реА рдЕрдиреНрдп рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдореЗрдореЛрд░реА рдХреЛ "рд╕реНрд╡рдпрдВ рдХреЗ рдиреАрдЪреЗ" рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдкрд░реАрдХреНрд╖рдг рдХреЛрдб рдХреЛ рдкрд╣рд▓реЗ рдПрдХ рдирдП рд╕реНрдерд╛рди рдкрд░ рд▓реЗ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  ELF рдореЗрдВ Sich рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдПрдХрддреНрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рд╕реЗ рдХреЛрдб, рдбреЗрдЯрд╛ рдЖрджрд┐ рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓рд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЗрд╕реЗ PIC (рд╕реНрдерд┐рддрд┐ рд╕реНрд╡рддрдВрддреНрд░ рдХреЛрдб) рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХрддреНрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ - рдкрд╣рд▓реЗ рддреЛ рдореБрдЭреЗ рдФрд░ рднреА рдЖрд╢реНрдЪрд░реНрдп рд╣реБрдЖ: рд╣рд╛рд▓рд╛рдБрдХрд┐ рдпрд╣ рдХреЛрдб рдлреНрд░реАрд╕реНрдЯреИрдВрдбрд┐рдВрдЧ рд╣реИ (рдЬреЛ рдХрд┐ рдХрд░реНрдиреЗрд▓, libc рдЗрддреНрдпрд╛рджрд┐ рдХреЗ рдмрд┐рдирд╛), рдпрд╣ рдРрд╕реА рдЙрдиреНрдирдд рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдкреИрд░рд╛рдореАрдЯрд░ рдЬреЛ рд╕рдордп-рд╕рдордп рдкрд░ рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, <code>-m32</code> рдореЗрдВ рдЖрддреЗ рд╣реИрдВ: <code>-march=i486</code> , <code>-m32</code> рдФрд░ рдЗрд╕реА рддрд░рд╣ред  рдореБрдЭреЗ рдРрд╕рд╛ рдХреБрдЫ рд▓рд┐рдЦрдиреЗ рдХреА рдЬрд╝рд░реВрд░рдд рд╣реИ, <del>  рдФрд░ рдлрд┐рд░ рдПрдХ рдЪреВрд╕рдиреЗ рд╡рд╛рд▓реЗ рдХреА рддрд░рд╣ </del>  ред  RISC-V рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд╕рд╛рде рд╕реНрдерд┐рддрд┐ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рд╣реИ: <code>rv32</code> рдФрд░ <code>rv64</code> (рдЬреИрд╕реЗ, рдЕрднреА рднреА рд╕рдмрд╕реЗ рдЯреНрд░рдВрдХреЗрдЯреЗрдб рдПрдореНрдмреЗрдбреЗрдб рдФрд░ rv128 рднрд╡рд┐рд╖реНрдп рдХреЗ рд▓рд┐рдП рдЖрд░рдХреНрд╖рд┐рдд рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╣рдо рдЙрдирдореЗрдВ рдмрд╣реБрдд рд░реБрдЪрд┐ рдирд╣реАрдВ рд░рдЦрддреЗ рд╣реИрдВ), рдФрд░ рдЗрд╕ рдЙрдкрд╕рд░реНрдЧ рдХреЛ рдЕрдХреНрд╖рд░ рдЕрд╕рд╛рдЗрди рдХрд░рдХреЗ ISA рдирд╛рдо рдмрдирддрд╛ рд╣реИ рдПрдХреНрд╕рдЯреЗрдВрд╢рди: <code>i</code> - рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдореВрд▓ рдкреВрд░реНрдгрд╛рдВрдХ рд╕реЗрдЯ, <code>m</code> - рдкреВрд░реНрдгрд╛рдВрдХ рдЧреБрдгрди рдФрд░ рд╡рд┐рднрд╛рдЬрди, ... рдмреЗрд╢рдХ, рдореИрдВ <code>rv64i</code> рдХрд░рдирд╛ <code>rv64i</code> , рд▓реЗрдХрд┐рди Memtest86 рд╢рд╛рдпрдж рд╣реА рдЖрд╕рд╛рдиреА рд╕реЗ рдЧреБрдгрди рдХреЗ рдмрд┐рдирд╛ рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдореЗрдВ <code>rv64i</code> рдЬрд╛рдПрдЧрд╛ред  рд╕рдЪ рд╣реИ, рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдХрдВрдкрд╛рдЗрд▓рд░ "рд╕рдорд╕реНрдпрд╛рдЧреНрд░рд╕реНрдд" рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рдмрдЬрд╛рдп рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛, рд▓реЗрдХрд┐рди рдмрд╣реБрдд рдХрдо рдкреНрд░рджрд░реНрд╢рди рдХреЗ рд╕рд╛рде рд╢реЗрд╖ рд░рд╣рдиреЗ рдХрд╛ рдЬреЛрдЦрд┐рдо рд╣реИ (рдпрд╣ рдЙрд▓реНрд▓реЗрдЦ рдирд╣реАрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдЗрди рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдпрд╛ рдХрд╣реАрдВ рд▓реЗ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА)ред </p><br><p>  рдЖрдкрдХреЛ рд▓рд╛рдЗрди рдПрдмреАрдЖрдИ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред  рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рдХреЙрд▓рд┐рдВрдЧ рдХрдиреНрд╡реЗрдВрд╢рди рдХреА рдореВрд▓ рдмрд╛рддреЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ <code>Volume I</code> рдореЗрдВ "RISC-V рдЕрд╕реЗрдВрдмрд▓реА рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдХреА рд╣реИрдВрдбрдмреБрдХ" рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдРрд╕рд╛ рдХреБрдЫ рдХрд░реВрдВрдЧрд╛ </p><br><pre> <code class="plaintext hljs">$ riscv64-linux-gnu-gcc-9 -mabi=help riscv64-linux-gnu-gcc-9: error: unrecognized argument in option '-mabi=help' riscv64-linux-gnu-gcc-9: note: valid arguments to '-mabi=' are: ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f riscv64-linux-gnu-gcc-9: fatal error: no input files compilation terminated.</code> </pre> <br><p>  рдФрд░ <code>lp64</code> рд╕реЛрдЪрдиреЗ рдХреЗ рдмрд┐рдирд╛, рдореИрдВ <code>lp64</code> ред  <em>рдЖрдЧреЗ рджреЗрдЦрддреЗ рд╣реБрдП, рдореИрдВ рдХрд╣реВрдВрдЧрд╛ рдХрд┐ рдЗрд╕ ABI рдХреЗ рд╕рд╛рде, рдорд╛рдирдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕реЗ рд╣реЗрдбрд░ рдлрд╛рдЗрд▓реЗрдВ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддреА <code>lp64f</code> , рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ <code>lp64f</code> рдФрд░ ARCH рдХреЛ "рдЕрдкрдЧреНрд░реЗрдб" рдХрд┐рдпрд╛ред</em>  <em>рдШрдмрд░рд╛рд╣рдЯ рдХреЗ рдмрд┐рдирд╛, рдореИрдВ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЕрдкрдиреЗ рдкреЛрд░реНрдЯ рдореЗрдВ рдлреНрд▓реЛрдЯрд┐рдВрдЧ рдкреЙрдЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдпреЛрдЬрдирд╛ рдирд╣реАрдВ рдмрдирд╛рддрд╛ рд╣реВрдВред</em> </p><br><p>  рдЪреВрдБрдХрд┐ рдореИрдВ рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдХреНрд░реЙрд╕-рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рд▓рд┐рдВрдХрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд▓рд┐рдЦрдиреЗ рдореЗрдВ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдирд╣реАрдВ рдЬрд╛рдирд╛ рдЪрд╛рд╣рддрд╛ - рдФрд░ рдЗрд╕рд▓рд┐рдП рдореБрдЭреЗ рддреБрд░рдВрдд <em>ld рдХреА рдЪрд╛рдмреА</em> рдирд╣реАрдВ <em>рдорд┐рд▓ рд░рд╣реА рдереА</em> , рдореИрдВрдиреЗ рдХреЛрдбрд╛рдВрддрд░рдХ <code>head.S</code> рд╕рд╛рде рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ред рдлрд╝рд╛рдЗрд▓, <code>memtest_shared.arch.lds</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ <code>memtest_shared.arch.lds</code> рдлрд╝рдВрдХреНрд╢рди рд╕реЗ <code>memtest_shared.arch.lds</code> ред  рдореИрдВрдиреЗ рдЗрд╕рд╕реЗ рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рд╛рд░реВрдк рдФрд░ рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдХрд╛ рдПрдХ рд╕рдВрдХреЗрдд рдмрд╛рд╣рд░ рдлреЗрдВрдХ рджрд┐рдпрд╛ (рдЖрдЦрд┐рд░рдХрд╛рд░, рдЗрд╕реЗ <code>DISCARD</code> рдореЗрдВ рдПрдХ рдЪрд░ рд╕реЗ рдмрджрд▓рдирд╛ рдЖрд╕рд╛рди рд╣реИ), рдФрд░ рдЕрдВрдд рдореЗрдВ <code>DISCARD</code> рдХреА рдЕрд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдЯрд┐рдкреНрдкрдгреА рднреА рдХреА, рдореБрдЭреЗ рдбреАрдмрдЧрд┐рдВрдЧ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЦрдВрдбреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред  <em>(рдЖрдЧреЗ рджреЗрдЦрддреЗ рд╣реБрдП: рдареАрдХ рдбрд┐рдмрдЧрд┐рдВрдЧ рдЬрд╛рдирдХрд╛рд░реА, рд▓реЗрдХрд┐рди <code>.rela</code> рдХреЛ <code>.rela</code> рдкрдбрд╝рд╛)</em> рдЖрдо рддреМрд░ рдкрд░ рдмреЛрд▓рддреЗ рд╣реБрдП, x86 рд╕рдВрд╕реНрдХрд░рдг рдиреЗ 64k рдореЗрдВ рдлрд┐рдЯ рд╣реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдкрд░ рдЬреЛрд░ рджрд┐рдпрд╛ - рдореБрдЭреЗ рдЖрд╢рд╛ рд╣реИ рдХрд┐ рдпрд╣ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдореЛрдб рдХреА рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ рдФрд░ RISC-V рд╕реЗ рд╣рдореЗрдВ рдЪрд┐рдВрддрд┐рдд рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред ред  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, PIC рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рдХреА рдЧрдИ рд╡рд╕реНрддреБ рдХреЛ рдПрдХрддреНрд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬреИрд╕рд╛ рдХрд┐ рдореВрд▓ рдореЗрдВ рд╣реИ, рдХреЛрдб рдФрд░ рдбреЗрдЯрд╛ рдЬрд┐рд╕реЗ рдореЗрдореЛрд░реА рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдЙрд╕реЗ рдХрд╛рдЯ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред </p><br><p>  рд╣рдо рдПрдХрддреНрд░ рдХрд░рддреЗ рд╣реИрдВ ... рдФрд░ рд╕рдВрдХрд▓рди рдкрд╣рд▓реА <code>reloc.c</code> рдлрд╝рд╛рдЗрд▓ рдкрд░ рдЖрддрд╛ рд╣реИ - рдпрд╣, рдЬрд╛рд╣рд┐рд░рд╛ рддреМрд░ рдкрд░, рдХреБрдЫ <code>ld-linux.so</code> рд╕реЗ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЧреНрд▓реЛрдмрд▓ рдСрдлрд╝рд╕реЗрдЯ рдЯреЗрдмрд▓ рдЖрджрд┐ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИред  x86 рдХреЗ рд▓рд┐рдП рдХреЙрд▓рд┐рдВрдЧ рд╕рдореНрдореЗрд▓рдиреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ред  рдпрд╣ рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ рдХрд┐ рдпрд╣ рдХреЛрдбрд╛рдВрддрд░рдХ рдЖрд╡реЗрд╖рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЗ рд╕рд╛рде рд╕реАрдзреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рд╣рдо RISC-V рдкрд░ рд╣реИрдВ - рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ PIC рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП <code>reloc.c</code> рдХреЛ рдлреЗрдВрдХрдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрд╡рддрдВрддреНрд░ рдорд╣рд╕реВрд╕ рдХрд░реЗрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЕрднреА рднреА рдЖрд╡реЗрд╖рдг рдереЗ, рдХрднреА-рдХрднреА рдХрд╛рдлреА рд▓рдВрдмреЗред  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рд╡реЗ рдпрд╛ рддреЛ рдкрд░реАрдХреНрд╖рдг рдХреЛрдб рдореЗрдВ рд╕реА рдХреЛрдб рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдереЗ, рдЬрд┐рд╕реЗ рд╡реЗ рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ (рдЙрдирд╕реЗ рдореИрдВрдиреЗ рдлрд┐рд░ рд╕реЗ рдкреНрд░реАрдкреНрд░реЛрд╕реЗрд╕рд░ рдирд┐рд░реНрджреЗрд╢ рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд┐рдЪ рдХрд┐рдП рдЧрдП рдХреЛрдб рдХреЗ рдкреВрд░реНрдг рдЯреБрдХрдбрд╝реЗ рдХрд┐рдП) рдпрд╛ рдХреБрдЫ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо-рдирд┐рд░реНрднрд░, рдЬрд┐рд╕рдХреЗ рдмрд┐рдирд╛, рдЪрд░рдо рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдореИрдВ (рд╢рд╛рдпрдж) рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВ рдХрд░рдирд╛ (рдЬреИрд╕реЗ рдХреИрд╢ рдХреЛ рдЪрд╛рд▓реВ / рдмрдВрдж рдХрд░рдирд╛, рд╕реАрдкреАрдпреВрдЖрдИрдбреА рдХреЛ рдШрдЯрд╛рдирд╛, рдЖрджрд┐)ред  рдЕрдВрдд рдореЗрдВ, <code>rdtsc</code> рдХреЙрд▓ рдЬреИрд╕реА рдХреБрдЫ рдЪреАрдЬреЗрдВ рдереАрдВ, рдЬрд┐рдиреНрд╣реЗрдВ рдореИрдВрдиреЗ <code>rdtsc</code> , рдмрд┐рдирд╛ рдХрд┐рд╕реА рдмрдбрд╝реА рд╕рдорд╕реНрдпрд╛ рдХреЗ рдПрдХ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо-рдирд┐рд░реНрднрд░ рд╣реЗрдбрд░ рдореЗрдВ рдбрд╛рд▓ рджрд┐рдпрд╛ рдФрд░ рдЗрд╕реЗ RISC-V рдкрд░ рдкреНрд░рд▓реЗрдЦрди рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ред </p><br><p>  рдирддреАрдЬрддрди, рд╣рдореЗрдВ <code>arch/i386</code> рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдорд┐рд▓реА, рдЬрд╣рд╛рдВ рдкреАрд╕реАрдЖрдИ рд╕рдорд░реНрдерди рдХреЛрдб рдХреА рдПрдХ рдмрдбрд╝реА рдорд╛рддреНрд░рд╛ рдЪрд▓реА рдЧрдИ, рдЪрд┐рдкрд╕реЗрдЯ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА, рдореЗрдореЛрд░реА-рдореИрдк рдХрд┐рдП рдЧрдП рдкрддреЗ рдХреА рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкрд░рд┐рднрд╛рд╖рд╛рдПрдВ, рдЖрджрд┐ рдкрдврд╝реЗрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, <code>test_start</code> рдлрд╝рдВрдХреНрд╢рди рдХреА рд╢реБрд░реБрдЖрдд <code>test_start</code> , рдЬреЛ <code>setup.S</code> рд╕реЗ C рдХреЛрдб рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рд╣реИред рдХрд┐рддрдиреА рд▓рдВрдмреА, рдЫреЛрдЯреА, рд▓реЗрдХрд┐рди рд╣рд░ рдЙрд╕ рдЪреАрдЬрд╝ рдкрд░ рдЯрд┐рдкреНрдкрдгреА рдХрд░рдирд╛ рдЬреЛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдЙрд╕ рдЪреАрдЬрд╝ рдХреЛ рд╕рд╛рдХрд╛рд░ рдХрд░рдирд╛ рдЬреЛ RISC-V (рдЬреИрд╕реЗ <code>setup.S</code> рдФрд░ рдХреЛрдб рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдб рдХреЗ рддрд╣рдд рдЯрд┐рдкреНрдкрдгреА рдирд╣реАрдВ рдХреА рдЬрд╛ рд╕рдХрддреАред SiFive рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ), рдореБрдЭреЗ <code>arch/riscv</code> , рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╕рдм рдХреБрдЫ рдХрдо рдпрд╛ рдЬреНрдпрд╛рджрд╛ рд╕рдВрдХрд▓рд┐рдд рдерд╛ред </p><br><p>  рдпрд╣рд╛рдВ рдореБрдЭреЗ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рд▓реЗрдЦ рдХреЗ рд▓реЗрдЦрди рд╕реЗ рдкрд╣рд▓реЗ рдкреНрд░рдпреЛрдЧ рдЦреБрдж рдЖрдВрд╢рд┐рдХ рд░реВрдк рд╕реЗ рдХрд┐рдП рдЧрдП рдереЗ, рдЗрд╕рд▓рд┐рдП рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ <em>рдЕрдиреБрдХреНрд░рдо</em> рдореЗрдВ "рдХрд▓рд╛рддреНрдордХ рдХрдерд╛" рдХреА рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рдорд╛рддреНрд░рд╛ рд╣реЛ рд╕рдХрддреА рд╣реИред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдореИрдВ рдХрдо рд╕реЗ рдХрдо рдкреНрд░рд╕реНрддреБрддрд┐ рдХреЛ рдЗрд╕ рддрд░рд╣ рд╕реЗ рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реВрдВ рдХрд┐ рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдпрд╣ рд╕рдВрднрд╛рд╡рд┐рдд рд░рд╛рд╕реНрддреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддрд╛ рд╣реИ <em>(рдореИрдВ рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рд╣реВрдВ, рдореБрдЭреЗ рд╡рд╣ рдпрд╛рдж рд╣реИ)</em> ред  рддреЛ рдЖрдЗрдП рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рд╕рдм рдХреИрд╕реЗ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЬрд╛рдПред </p><br><h2 id="zapusk-na-zheleze">  рд▓реЛрд╣реЗ рдкрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИ </h2><br><p>  рдкрд┐рдЫрд▓реЗ рдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рдмрд╛рдж рд╕реЗ, рдореЗрд░реЗ рдкрд╛рд╕ рдЕрднреА рднреА рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рд╕реЗ рдзреВрд▓ рднрд░рд╛ "рд╕реНрдЯреИрдВрдб" рд╣реИ, рдЬрд┐рд╕реЗ рдбрд┐рдмрдЧ рдмреЛрд░реНрдб рдкрд░ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реИред  рддрд╛рд░реЛрдВ UART, JTAG рдФрд░ рдПрдХ рдПрд╕рдбреА рдХрд╛рд░реНрдб рдХреЗ рд╕рд╛рде рдПрдХ рдПрдбрд╛рдкреНрдЯрд░ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред  DDR2 рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ рд╕рд╛рде рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд RV64 рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдореЛрд░реА рдореЗрдВ рд╕реАрд╡рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЬреИрд╕рд╛ рдХрд┐ рдкрд┐рдЫрд▓реЗ рд╕рдордп рдореЗрдВ, рдореИрдВ "рд░рд╛рд╕реНрдкрдмреЗрд░реА" рдЪрд╛рд▓реВ рдХрд░рддрд╛ рд╣реВрдВ, рдЗрд╕рдХреЗ рдкрд╣рд▓реЗ рджреЛ рдПрд╕рдПрд╕рдПрдЪ рд╕рддреНрд░ рдЦреЛрд▓реЗрдВ, рдЬрд┐рдирдореЗрдВ рд╕реЗ рдПрдХ рдХреЛ рдУрдкрдирдУрд╕реАрдбреА рдореЗрдВ рдЬреАрдбреАрдмреА рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП 3333 рдЯреАрд╕реАрдкреА рдкреЛрд░реНрдЯ рдХреЗ рдЖрдЧреЗред  рдПрдХ рд╕рддреНрд░ рдореЗрдВ, рдореИрдВ UART рдХреЗ рд▓рд┐рдП рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдорд┐рдирд┐рдХреЙрдо рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реВрдВ, рджреВрд╕рд░реЗ рдореЗрдВ - JTAG рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдореЗрдЬрдмрд╛рди рд╕реЗ рдбрд┐рдмрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдУрдкрдирдХрд╛рдбред  рдореИрдВ рдмреЛрд░реНрдб рдХреА рд╢рдХреНрддрд┐ рдХреЛ рдЪрд╛рд▓реВ рдХрд░рддрд╛ рд╣реВрдВ - рдФрд░ рдХрдВрд╕реЛрд▓ рдореЗрдВ рд╕рдВрджреЗрд╢ рджреЗрддрд╛ рд╣реВрдВ рдХрд┐ рдпрд╣ рдПрд╕рдбреА рд╕реЗ рдбреЗрдЯрд╛ рдХреИрд╕реЗ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдЕрдм рдЖрдк рдХрдорд╛рдВрдб рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:3333' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80010000' \ -ex 'add-symbol-file /path/to/memtest_shared 0x80010000' -ex 'set $pc=0x80010000'</code> </pre> <br><p>  <code>-ex</code> рд╡рд┐рдХрд▓реНрдк gdb рдХреЛ рдпрд╣ рдвреЛрдВрдЧ рдХрд░рдиреЗ рдХрд╛ <code>-ex</code> рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗ рдХрдВрд╕реЛрд▓ рд╕реЗ рдЗрди рдХрдорд╛рдВрдбреЛрдВ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд┐рдпрд╛ рд╣реИ: </p><br><ul><li>  рдкрд╣рд▓реЗ OpenOCD рдХреЗ рд╕рд╛рде рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ </li><li>  рджреВрд╕рд░реА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реЛрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрддреЗ рдкрд░ рдХреЙрдкреА рдХрд░рддрд╛ рд╣реИ </li><li>  рддреАрд╕рд░реЗ рдиреЗ gdb рдХреЛ рд╕рдордЭрд╛рдпрд╛ рдХрд┐ рд╕реНрд░реЛрдд рдХреЛрдб рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА <em>рдЗрд╕</em> рдлрд╝рд╛рдЗрд▓ рд╕реЗ рд▓реА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдП, рдЗрд╕ рддрдереНрдп рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрддреЗ рд╣реБрдП рдХрд┐ рдЗрд╕реЗ <em>рдЗрд╕</em> рдкрддреЗ рдкрд░ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (рдФрд░ рдЗрд╕рдореЗрдВ рдЬреЛ рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рд╡рд╣реА рдирд╣реАрдВ) <br><ul><li>  рдиреЛрдЯ: рд╣рдо ELF рдлрд╝рд╛рдЗрд▓ рд╕реЗ рд╡рд░реНрдг рд▓реЗрддреЗ рд╣реИрдВ, рдФрд░ "рдХрдЪреНрдЪреЗ" рдмрд╛рдЗрдирд░реА рд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ </li></ul></li><li>  рдЕрдВрдд рдореЗрдВ, рдЪреМрдерд╛ рд╡рд░реНрддрдорд╛рди рдХрдорд╛рдВрдб рдкреЙрдЗрдВрдЯрд░ рдХреЛ рд╣рдорд╛рд░реЗ рдХреЛрдб рдореЗрдВ рдЬрдмрд░рди рдЯреНрд░рд╛рдВрд╕рд▓реЗрдЯ рдХрд░рддрд╛ рд╣реИ </li></ul><br><p>  рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рд╕рдм рдХреБрдЫ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕реБрдЪрд╛рд░реВ рд░реВрдк рд╕реЗ рдирд╣реАрдВ рдЪрд▓рддрд╛ рд╣реИ, рдФрд░ рдпрджреНрдпрдкрд┐ рдбрд┐рдмрдЧрд░ рдореЗрдВ рдХреЛрдб рдХреА рд░реЗрдЦрд╛рдПрдВ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реЛрддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╕рднреА рд╡реИрд╢реНрд╡рд┐рдХ рдЪрд░ - рд╢реВрдиреНрдп рдореЗрдВред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрджрд┐ рд╣рдо gdb рдореЗрдВ рдлреЙрд░реНрдо <code>p &amp;global_var</code> рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ, рд╣рдо, рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдбрд╛рдЙрдирд▓реЛрдб рдкрддреЗ (рдореЗрд░реЗ рдкрд╛рд╕ <code>0x0</code> ) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдкрддрд╛ рджреЗрдЦрддреЗ рд╣реИрдВ, рдЬреЛ <code>add-symbol-file</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИред  рдПрдХ рдмреИрд╕рд╛рдЦреА рдХреЗ рд░реВрдк рдореЗрдВ, рд▓реЗрдХрд┐рди рдПрдХ рдмрд╣реБрдд рд╣реА рд╕рд░рд▓ рд╕рдорд╛рдзрд╛рди, рдореИрдВрдиреЗ рдмрд╕ <code>0x80010000</code> рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрддреЗ рдкрд░ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдЬреЛрдбрд╝рд╛ рдФрд░ рдореЗрдореЛрд░реА рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ <code>x/x 0xADDR</code> рдорд╛рдзреНрдпрдо рд╕реЗ <code>x/x 0xADDR</code> ред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд▓рд┐рдВрдХрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рд╕рд╣реА рд╢реБрд░реБрдЖрддреА рдкрддреЗ рдХреЛ рдЕрд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдЗрдВрдЧрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛, рдЬреЛ <em>рдЗрд╕ рдкрд░реАрдХреНрд╖рдг рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди</em> рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдкрддреЗ рдХреЗ рд╕рд╛рде рдореЗрд▓ <em>рдЦрд╛рдПрдЧрд╛</em> ред </p><br><h2 id="osobennosti-relokacii-na-sovremennyh-arhitekturah">  рдЖрдзреБрдирд┐рдХ рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдкрд░ рдкреБрдирд░реНрд╡рд╛рд╕ рдХреА рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ </h2><br><p>  рдЦреИрд░, рдХреЛрдб рдХреЛ рдХрд┐рд╕реА рддрд░рд╣ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдордиреЗ рдЗрд╕реЗ рдХреИрд╕реЗ рдирд┐рдХрд╛рд▓рд╛ - рд╣рдо рдЗрд╕реЗ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред  рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред  рдЪрд░рдг-рджрд░-рдЪрд░рдг рдбрд┐рдмрдЧрд┐рдВрдЧ рд╕реЗ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рд╣рдо <code>switch_to_main_stack</code> рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рджреМрд░рд╛рди рдЖрддреЗ рд╣реИрдВ - рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдЕрднреА рднреА рдХрд╛рд░реНрдп рд╕реНрдЯреИрдХ рдХреЗ рдЕрдиреБрд░реВрдк рдкреНрд░рддреАрдХ рдХреЗ рдкрддреЗ рдХреЗ рдЕрд╕рдВрдмрдВрдзрд┐рдд рдореВрд▓реНрдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣рд╛ рд╣реИред </p><br><p>  рд╕рднреА рд╕рдорд╛рди, рдкреНрд░рд▓реЗрдЦрди рдХреА рдкрд╣рд▓реА рдорд╛рддреНрд░рд╛ рд╣рдореЗрдВ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЫрджреНрдо рдирд┐рд░реНрджреЗрд╢реЛрдВ рдФрд░ рдкреАрдЖрдИрд╕реА рдХреЗ рд╕рд╛рде рдЙрдирдХреЗ рдХрд╛рдо рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рддреА рд╣реИ: </p><br><p><img src="https://habrastorage.org/webt/vj/7-/_u/vj7-_uqmqyqjloo1webrgpqsdc8.png" alt="рдХреБрдЫ рдЖрд░рдЖрдИрдПрд╕рдПрд╕рд╕реА-рд╡реА рдЫрджреНрдо рдирд┐рд░реНрджреЗрд╢"></p><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рд╕рд╛рдорд╛рдиреНрдп рд╕рд┐рджреНрдзрд╛рдВрдд рдпрд╣ рд╣реИ рдХрд┐ рд╕реНрдореГрддрд┐ рдореЗрдВ рдкрддреЗ рд╡рд░реНрддрдорд╛рди рдирд┐рд░реНрджреЗрд╢ рд╕реЗ рдЧрд┐рдиреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдкрд╣рд▓реЗ рдСрдлрд╕реЗрдЯ рдХреЗ рд╢реАрд░реНрд╖ рдХреЛ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ, рдФрд░ рдЕрдЧрд▓рд╛ <code>add</code> рдХрдо-рдСрд░реНрдбрд░ рдмрд┐рдЯреНрд╕ рдХреЛ рдкреЙрд▓рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВред  рдпрд╣ рд╢рд╛рдпрдж рд╣реА рдХрд┐рд╕реА рд╡реИрд╢реНрд╡рд┐рдХ рд╡реИрд░рд┐рдПрдмрд▓ рдХреЛ рдШреЛрд╖рд┐рдд рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vars</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">;</span></span></code> </pre> <br><p>  рдЗрд╕рд▓рд┐рдП, рд╣рдо RISC-V ELF psABI рдкреНрд░рд▓реЗрдЦрди <a href="" rel="nofollow">рдХреЛ рд░рд┐рд▓реЛрдХреЗрд╢рди рдХреЗ рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЗ</a> рд╕рд╛рде рд▓реЗрддреЗ рд╣реИрдВ рдФрд░ <code>reloc.c</code> рд▓рд┐рдП рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо-рд╡рд┐рд╢рд┐рд╖реНрдЯ рднрд╛рдЧ <code>reloc.c</code> ред  рдпрд╣рд╛рдВ рдпрд╣ рдзреНрдпрд╛рди рджрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдореВрд▓ рдлрд╝рд╛рдЗрд▓, рдЬрд╛рд╣рд┐рд░рд╛ рддреМрд░ рдкрд░, рдХреНрд░реЙрд╕-рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХреЛрдб рд╕реЗ рд▓реА рдЧрдИ рдереАред  рд╡рд╣рд╛рдВ рднреА, рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдмрд┐рдЯ рдЧрд╣рд░рд╛рдИ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, <code>ElfW(Addr)</code> рдореИрдХреНрд░реЛрдЬрд╝ рдХрд╛ <code>ElfW(Addr)</code> , рдЬреЛ <code>Elf32_Addr</code> рдпрд╛ <code>Elf64_Addr</code> рдореЗрдВ <code>Elf32_Addr</code> <code>Elf64_Addr</code> ред  рд╣рд░ рдЬрдЧрд╣ рдирд╣реАрдВ, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЙрдиреНрд╣реЗрдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ рдЬрд╣рд╛рдВ рд╡реЗ рд╕рд╛рдорд╛рдиреНрдп рдХреЛрдб рдореЗрдВ рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ (рд╕рд╛рде рд╣реА рд╕рд╛рде <a href="" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a> - рдЖрдЦрд┐рд░рдХрд╛рд░, RISC-V рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдмрд┐рдЯ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдмрдВрдзрд╛ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╡рд┐рд╢реЗрд╖ рдЕрд░реНрде рдирд╣реАрдВ рд╣реИ, рдЬрд╣рд╛рдВ рдпрд╣ рдирд╣реАрдВ рд╣реИ рдЖрд╡рд╢реНрдпрдХ)ред </p><br><p>  рдирддреАрдЬрддрди, <code>switch_to_main_stack</code> (рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо-рдирд┐рд░реНрднрд░ <code>switch_to_main_stack</code> рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рдмрд┐рдирд╛ рдирд╣реАрдВ) рдкрд╛рд╕ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рджрд┐рдпрд╛ред  рдбрд┐рдмрдЧрд░ рдЕрднреА рднреА рдХреБрдЯрд┐рд▓ рд░реВрдк рд╕реЗ рд╡реИрд╢реНрд╡рд┐рдХ рдЪрд░ рджрд┐рдЦрд╛рддрд╛ рд╣реИред  рдареАрдХ рд╣реИ, рдареАрдХ рд╣реИ :( </p><br><h2 id="opredelenie-oborudovaniya">  рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдкрд░рд┐рднрд╛рд╖рд╛ </h2><br><p>  рдмреЗрд╢рдХ, рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЗ рд▓рд┐рдП, рдлреЗрдВрдХреЗ рдЧрдП рдЙрдкрдХрд░рдг рдкрд░рд┐рднрд╛рд╖рд╛ рдХреЛрдб рдХреЗ рдмрдЬрд╛рдп рд╣рд╛рд░реНрдб-рдХреЛрдбреЗрдб рд╕реНрдерд┐рд░рд╛рдВрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдкреНрд░рддреНрдпреЗрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░реЛрд╕реЗрд╕рд░ рдЕрд╕реЗрдВрдмрд▓реА рдХреЗ рд▓рд┐рдП, рдореЗрд░реЗ рдЖрд╡реЗрджрди рдХреЗ рдорд╛рдирдХреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдореЗрдорд╕реНрдЯреЗрд╕реНрдЯ рдХрд╛ рдкреБрдирд░реНрдирд┐рд░реНрдорд╛рдг рднреА рдорд╣рдВрдЧрд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП, рд╣рдо "рдЧрдВрднреАрд░ рд╡рдпрд╕реНрдХреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ" рдХрд╛рд░реНрдп рдХрд░реЗрдВрдЧреЗред  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, RISC-V (рдФрд░ рд╢рд╛рдпрдж рдЕрдзрд┐рдХрд╛рдВрд╢ рдЖрдзреБрдирд┐рдХ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдкрд░), рдпрд╣ рдмреВрдЯрд▓реЛрдбрд░ рдХреЗ рд▓рд┐рдП <a href="https://en.wikipedia.org/wiki/Device_tree" rel="nofollow">рдбрд┐рд╡рд╛рдЗрд╕ рдЯреНрд░реА рдмреНрд▓реЙрдм рдкрд░</a> рдПрдХ рдХреЛрдб рдкрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдерд╛рдЧрдд рд╣реИ, рдЬреЛ рдЗрд╕ рддрд░рд╣ рдбреАрдЯреАрдПрд╕ рд╡рд┐рд╡рд░рдг рдХрд╛ рд╕рдВрдХрд▓рд┐рдд рд╕рдВрд╕реНрдХрд░рдг рд╣реИ: </p><br><div class="spoiler">  <b class="spoiler_title">zeowaa-1gb.dts</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/dts-v1/; / { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-dev"; model = "freechips,rocketchip-unknown"; chosen { bootargs = "console=ttySIF0,125200 debug loglevel=7"; }; firmware { sifive,uboot = "YYYY-MM-DD"; }; L16: aliases { serial0 = &amp;L8; }; L15: cpus { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; timebase-frequency = ^_^ltє┤ЙАgt^_^; L5: cpu@0 { device_type = "cpu"; clock-frequency = ^_^lt&amp;#0;gt^_^; compatible = "sifive,rocket0", "riscv"; d-cache-block-size = ^_^lt gt^_^; d-cache-sets = ^_^lt@gt^_^; d-cache-size = ^_^ltсААgt^_^; d-tlb-sets = ^_^lt gt^_^; d-tlb-size = ^_^lt gt^_^; i-cache-block-size = ^_^lt gt^_^; i-cache-sets = ^_^lt@gt^_^; i-cache-size = ^_^ltсААgt^_^; i-tlb-sets = ^_^lt gt^_^; i-tlb-size = ^_^lt gt^_^; mmu-type = "riscv,sv39"; next-level-cache = &lt;&amp;L10&gt;; reg = &lt;0x0&gt;; riscv,isa = "rv64imafdc"; status = "okay"; timebase-frequency = ^_^ltє┤ЙАgt^_^; tlb-split; L3: interrupt-controller { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,cpu-intc"; interrupt-controller; }; }; }; L10: ram@80000000 { device_type = "memory"; reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;; reg-names = "mem"; }; L14: soc { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-soc", "simple-bus"; ranges; L1: clint@2000000 { compatible = "riscv,clint0"; interrupts-extended = &lt;&amp;L3 3 &amp;L3 7&gt;; reg = &lt;0x2000000 0x10000&gt;; reg-names = "control"; }; L2: debug-controller@0 { compatible = "sifive,debug-013", "riscv,debug-013"; interrupts-extended = &lt;&amp;L3 65535&gt;; reg = &lt;0x0 0x1000&gt;; reg-names = "control"; }; L9: gpio@64002000 { #gpio-cells = ^_^lt gt^_^; #interrupt-cells = ^_^lt gt^_^; compatible = "sifive,gpio0"; gpio-controller; interrupt-controller; interrupt-parent = &lt;&amp;L0&gt;; interrupts = &lt;3 4 5 6 7 8&gt;; reg = &lt;0x64002000 0x1000&gt;; reg-names = "control"; }; L0: interrupt-controller@c000000 { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,plic0"; interrupt-controller; interrupts-extended = &lt;&amp;L3 11 &amp;L3 9&gt;; reg = &lt;0xc000000 0x4000000&gt;; reg-names = "control"; riscv,max-priority = ^_^lt gt^_^; riscv,ndev = ^_^lt gt^_^; }; L6: rom@10000 { compatible = "sifive,maskrom0"; reg = &lt;0x10000 0x2000&gt;; reg-names = "mem"; }; L8: serial@64000000 { compatible = "sifive,uart0"; interrupt-parent = &lt;&amp;L0&gt;; clocks = &lt;&amp;tlclk&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64000000 0x1000&gt;; reg-names = "control"; }; L7: spi@64001000 { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; compatible = "sifive,spi0"; interrupt-parent = &lt;&amp;L0&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64001000 0x1000&gt;; clocks = &lt;&amp;tlclk&gt;; reg-names = "control"; L12: mmc@0 { compatible = "mmc-spi-slot"; disable-wp; reg = &lt;0x0&gt;; spi-max-frequency = ^_^lt gt^_^; voltage-ranges = &lt;3300 3300&gt;; }; }; tlclk: tlclk { #clock-cells = ^_^lt&amp;#0;gt^_^; clock-frequency = ^_^lt gt^_^; clock-output-names = "tlclk"; compatible = "fixed-clock"; }; }; };</code> </pre> </div></div><br><p>  рдореИрдВ рдИрдПрд▓рдПрдл рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЕрдм рдореИрдВ рдлрд┐рд░ рд╕реЗ рдПрдлрдбреАрдЯреА (рдлреНрд▓реИрдЯ рдбрд┐рд╡рд╛рдЗрд╕ рдЯреНрд░реА) рдХреЗ рд╕рд╛рде рдЖрд╢реНрд╡рд╕реНрдд рд╣реВрдВ: рдЗрди <em>рдкреНрд░рдХрд╛рд░ рдХреЗ</em> <a href="https://github.com/devicetree-org/devicetree-specification/releases/download/v0.2/devicetree-specification-v0.2.pdf" rel="nofollow">рд╡рд┐рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ</a> <em>рдЕрдЪреНрдЫреА рджреЗрдЦрднрд╛рд▓ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд▓реЛрдЧ рд▓рд┐рдЦрддреЗ рд╣реИрдВ</em> <del>  (рдлрд┐рд░ рднреА, рд╡реЗ рдЦреБрдж рддреЛ рдЗрд╕реЗ рдкрд╛рд░реНрд╕ рдХрд░рддреЗ рд╣реИрдВ!) </del>  рдФрд░ рдРрд╕реА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдирд╛ (рдХрдо рд╕реЗ рдХрдо рдЬрдм рддрдХ рдЖрдкрдХреЛ рдЕрд╡рд┐рд╢реНрд╡рд╛рд╕рд┐рдд рдЗрдирдкреБрдЯ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ) рдХреЛрдИ рд╡рд┐рд╢реЗрд╖ рд╕рдорд╕реНрдпрд╛ рдирд╣реАрдВ рд╣реИред  рддреЛ рдпрд╣рд╛рдБ: рдлрд╝рд╛рдЗрд▓ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдПрдХ рд╕рд╛рдзрд╛рд░рдг рд╣реЗрдбрд░ рд╕рдВрд░рдЪрдирд╛ рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдореИрдЬрд┐рдХ рдирдВрдмрд░ <code>0xd00dfeed</code> рдФрд░ рдХреБрдЫ рдФрд░ рдлрд╝реАрд▓реНрдб рд╣реЛрддреЗ рд╣реИрдВред  рд╣рдо "рдлреНрд▓реИрдЯ рдЯреНрд░реА" <code>off_dt_struct</code> рдФрд░ рдкрдВрдХреНрддрд┐ рддрд╛рд▓рд┐рдХрд╛ <code>off_dt_strings</code> рдХреА рдСрдлрд╝рд╕реЗрдЯ рдореЗрдВ рд░реБрдЪрд┐ рд░рдЦрддреЗ рд╣реИрдВред  рджрд░рдЕрд╕рд▓, рдЖрдкрдХреЛ <code>off_mem_rsvmap</code> рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рдиреЗ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ <code>off_mem_rsvmap</code> , рдЬреЛ рдХрд┐ рд╕реНрдореГрддрд┐ рд╕реЗ рдмрдЪрдиреЗ рд╡рд╛рд▓реЗ рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреА рдЧрдгрдирд╛ рдХрд░рддрд╛ рд╣реИред  рдореИрдВ рдЕрднреА рднреА рдЙрдиреНрд╣реЗрдВ рдЕрдирджреЗрдЦрд╛ рдХрд░рддрд╛ рд╣реВрдВ (рд╡реЗ рдореЗрд░реЗ рдмреЛрд░реНрдб рдкрд░ рдирд╣реАрдВ рд╣реИрдВ), рд▓реЗрдХрд┐рди <strong>рдШрд░ рдкрд░ рдЗрд╕реЗ рджреЛрд╣рд░рд╛рдПрдВ рдирд╣реАрдВ</strong> ред </p><br><p>  рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдореБрд╢реНрдХрд┐рд▓ рдирд╣реАрдВ рд╣реИ: рдЖрдкрдХреЛ рдмрд╕ рдЯреЛрдХрди рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдПрдХ рд╕рдкрд╛рдЯ рдкреЗрдбрд╝ рдкрд░ рдЪрд▓рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рддреАрди <em>рдкреНрд░рдореБрдЦ</em> рдЯреЛрдХрди рд╣реИрдВ: </p><br><ul><li>  <code>FDT_BEGIN_NODE</code> - рдЗрд╕рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд рдбреЗрдЯрд╛ рдореЗрдВ, рд╢реВрдиреНрдп-рд╕рдорд╛рдкреНрдд рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдмрдЯреНрд░реА рддрддреНрд╡ рдХрд╛ рдирд╛рдо рдЖрддрд╛ рд╣реИред  рдмрд╕ рд╕реНрдЯреИрдХ рдореЗрдВ рдирд╛рдо рдЬреЛрдбрд╝реЗрдВ </li><li>  <code>FDT_END_NODE</code> - рд╕рдмрдЯреНрд░реА рдЦрддреНрдо рд╣реЛ рдЧрдИ рд╣реИ, рд╕реНрдЯреИрдХ рд╕реЗ рддрддреНрд╡ рдХреЛ рд╣рдЯрд╛ рджреЗрдВ </li><li>  <code>FDT_PROP</code> - рдпрд╣рд╛рдБ рдереЛрдбрд╝рд╛ рдкреЗрдЪреАрджрд╛ рдорд╛рдорд▓рд╛ рд╣реИ: рдпрд╣ рдПрдХ рд╕рдВрд░рдЪрдирд╛ рджреНрд╡рд╛рд░рд╛ рдкреАрдЫрд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рдХреЗ рдмрд╛рдж рдЕрддрд┐рд░рд┐рдХреНрдд рдбреЗрдЯрд╛ рдХреЗ рд▓реЗрди рдмрд╛рдЗрдЯреНрд╕ рд╣реЛрддреЗ рд╣реИрдВред  "рд╡реИрд░рд┐рдПрдмрд▓" рдХрд╛ рдирд╛рдо рд╕реНрдЯреНрд░рд┐рдВрдЧ рдЯреЗрдмрд▓ рдореЗрдВ рдСрдлрд╕реЗрдЯ <code>nameoff</code> рд╣реИ <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> nameoff; }</code> </pre> </li></ul><br><p>  рдареАрдХ рд╣реИ, рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдпрд╣ рд╕рдм: рд╣рдо рдЗрд╕ рдЕрдиреБрднрд╛рдЧ рд╕реЗ рдЧреБрдЬрд░рддреЗ рд╣реИрдВ, 4 рдмрд╛рдЗрдЯреНрд╕ рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░реЗрдЦрдг рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░рдирд╛ рдирд╣реАрдВ рднреВрд▓рддреЗ рд╣реИрдВред  рдЕрд░реЗ рд╣рд╛рдВ, рдорд░рд╣рдо рдореЗрдВ рдПрдХ рдордХреНрдЦреА: рдПрдлрдбреАрдЯреА рдореЗрдВ рд╕рдВрдЦреНрдпрд╛рдПрдВ рдмрдбрд╝реЗ рдПрдВрдбрд┐рдпрди рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдПрдХ рд╕рд░рд▓ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВ </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | (x &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff0000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff00</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); }</code> </pre> <br><p>  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, <code>riscv_entry</code> рдкрд╣рд▓реА рдмрд╛рдд FDT рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдирд╛ рд╣реИ, рдФрд░ <code>head.S</code> рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИред рдЬреЛ рдирд┐рдпрдВрддреНрд░рдг рдХреЛ <code>riscv_entry</code> рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИ, <code>riscv_entry</code> рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ </p><br><pre> <code class="plaintext hljs"> .globl startup_32 #  --    ... startup_32: lla sp, boot_stack_top mv s0, a0 # s0, s1 -- callee-saved mv s1, a1 # ...  .bss #   jal _dl_start #      mv a0, s0 mv a1, s1 j riscv_entry</code> </pre> <br><p>  рд░рдЬрд┐рд╕реНрдЯрд░ <code>a0</code> hart id рд╣рдореЗрдВ рджреА рдЧрдИ рд╣реИ (hart RISC-V рд╢рдмреНрджрд╛рд╡рд▓реА рдореЗрдВ рдПрдХ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕реНрдЯреНрд░реАрдо рдХреА рддрд░рд╣ рд╣реИ) - рдореИрдВ рдЕрднреА рддрдХ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддрд╛, рдореБрдЭреЗ рдЗрд╕реЗ рдПрдХрд▓-рдереНрд░реЗрдбреЗрдб рдорд╛рдорд▓реЗ рдореЗрдВ рд╕рдордЭрд╛рдирд╛ рд╣реЛрдЧрд╛ред  <code>a1</code> рдмреВрдЯрд▓реЛрдбрд░ FDT рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЙрдЗрдВрдЯрд░ рд░рдЦрддрд╛ рд╣реИред  рд╣рдо рдЗрд╕реЗ рдлрдВрдХреНрд╢рди <code>void riscv_entry(ulong hartid, uint8_t *fdt_address)</code> ред </p><br><p>  рдЕрдм, рдореЗрд░реЗ рдХреЛрдб рдореЗрдВ FDT рдкрд╛рд░реНрд╕рд┐рд▓реНрдХрд╛ рдХреЗ рдЖрдЧрдорди рдХреЗ рд╕рд╛рде, рдмреЛрд░реНрдб рдХрд╛ рд▓реЛрдбрд┐рдВрдЧ рдХреНрд░рдо рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реЛ рдЧрдпрд╛: </p><br><ul><li>  рд╕рддреНрддрд╛ рдЪрд╛рд▓реВ рдХрд░реЛ </li><li>  U- рдмреВрдЯ рдХрдВрд╕реЛрд▓ рдХреЗ рд▓рд┐рдП рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ </li><li>  рд╕рд╣реА FDT рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдореЗрдВ рдХрдорд╛рдВрдб рджрд░реНрдЬ рдХрд░реЗрдВред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, <code>/chosen/bootargs</code> рдХрдорд╛рдВрдб <code>/chosen/bootargs</code> рдХрд░реНрдиреЗрд▓ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИред  рдмрд╛рдХреА рд╕рдм рдХреБрдЫ рдЬреЛ рдореИрдВ рдПрдлрдбреАрдЯреА рд╕реЗ рд▓реЗрддрд╛ рд╣реВрдВ - рд░реИрдо рд░реЗрдВрдЬ, рдпреВрдПрдЖрд░рдЯреА рдкрддрд╛, ... - рдХреЗ рд░реВрдк рдореЗрдВ рдЫреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП <br><pre> <code class="plaintext hljs">run fdtsetup fdt set /chosen bootargs "console=ttyS0 btrace"</code> </pre> </li><li>  <code>fdt addr</code> рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдпрджрд┐ рдЖрдкрдиреЗ рдирд╣реАрдВ рджреЗрдЦрд╛ рд╣реИ, рддреЛ FDT рдбрд╛рдЙрдирд▓реЛрдб рдкрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ </li></ul><br><p>  рдФрд░ gdb рдХреА рддрд░рдл рд╕реЗ рдХрдорд╛рдВрдб рдХреЛ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ </p><br><ul><li> <code>-ex 'set $a1=0xfdtaddr'</code> </li> </ul><br><h2 id="vyvod-informacii-na-ekran">  рд╕реНрдХреНрд░реАрди рдкрд░ рд╕реВрдЪрдирд╛ рдЙрддреНрдкрд╛рджрди </h2><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдпрд╣ рдирд┐рдХрд▓рд╛, рдХреЛрдбрд╛рдВрддрд░рдХ рдЖрд╡реЗрд╖рдг рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╕реНрдореГрддрд┐ рдкрддреЗ рднреА рд╣реИрдВред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП <code>SCREEN_ADR</code> (рдареАрдХ рдЙрд╕реА рддрд░рд╣, рдЬреИрд╕реЗ рдХрд┐ рдПрдХ <code>D</code> рд╕рд╛рде), рдЬреЛ рд╕реНрдХреНрд░реАрди рдкрд░ рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реЛрдиреЗ рдХреЗ рдЕрдиреБрд░реВрдк рдХреНрд╖реЗрддреНрд░ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИред  рдЬрдм рдореИрдВ рдЗрд╕ рдкрд╛рд░ рдЖрдпрд╛, рддреЛ рдореИрдВрдиреЗ рдмрд╕ рдПрдХ рд╡рд┐рд╕реНрддреГрдд рдЗрд╢рд╛рд░реЗ рдХреЗ рд╕рд╛рде рд╕рдм рдХреБрдЫ рд░рдЦрд╛ рдЬреЛ рдЗрд╕реЗ <code>#if HAS_SCREEN</code> рддрд╣рдд рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рд▓рдВрдмреЗ рд╕рдордп рддрдХ <code>#if HAS_SCREEN</code> рдбрд┐рдмрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ред  рдореИрдВрдиреЗ рд╕реЛрдЪрд╛ рдХрд┐ рдХреБрдЫ рд╕рдордп рдореЗрдВ рдПрдХ рдмрд╛рд░ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдпрд╣ рд╕рдм рд╕рд╛рдВрддреНрд╡рдирд╛ рдХреЗ рд▓рд┐рдП рдбрдВрдк рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рдП, рд▓реЗрдХрд┐рди рдлрд┐рд░ рдореИрдВрдиреЗ рджреЗрдЦрд╛ рдХрд┐ рдПрдХ рд╣реА рдХреЛрдб рджрд░реНрджрдирд╛рдХ рд░реВрдк рд╕реЗ рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдХрдИ рдПрд╕реНрдХреЗрдк рд╕реАрдХреНрд╡реЗрдВрд╕ рдЖрдЙрдЯрдкреБрдЯ рджреЗрддрд╛ рд╣реИред  рдпрд╣ рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ рдХрд┐ рд╕рдм рдХреБрдЫ рд╣рдорд╛рд░реЗ рд╕рд╛рдордиреЗ рдкрд╣рд▓реЗ рд╣реА рд▓рд┐рдЦрд╛ рдЬрд╛ рдЪреБрдХрд╛ рдерд╛, рдЖрдкрдХреЛ рдмрд╕ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХреЛ рдЕрдзрд┐рдХ рд╕рдЯреАрдХ рд░реВрдк рд╕реЗ рд░рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ - рдФрд░ рдпрд╣рд╛рдВ рдпрд╣ рд╣реИ, рдорд┐рдиреАрдХреИрдо рд╡рд┐рдВрдбреЛ рдореЗрдВ рдкрд░рд┐рдЪрд┐рдд рдЗрдВрдЯрд░рдлрд╝реЗрд╕ (рдХрд╛рд▓реЗ рдФрд░ рд╕рдлреЗрдж)!  (рдлрд┐рд▓рд╣рд╛рд▓, HAS_SCREEN рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрд┐рд▓реНрдХреБрд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ - рдореИрдВрдиреЗ рдореВрд▓ рдХреЛрдб рдХреЛ рдиреНрдпреВрдирддрдо рдкрд░ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП <code>dummy_con</code> рд╕рд░рдгреА рд╢реБрд░реВ рдХреА рд╣реИред) </p><br><h2 id="otladka-na-qemu">  QEMU рдкрд░ рдбрд┐рдмрдЧрд┐рдВрдЧ </h2><br><p>  рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ рдПрдХ рдЕрд╕рд▓реА рдмреЛрд░реНрдб рдкрд░ рд╕рдм рдХреБрдЫ рдбрд┐рдмреЗрдЯ рдХрд┐рдпрд╛, рдФрд░ рдХреБрдЫ рд╕рдордп рдХреЗ рд▓рд┐рдП - рдЖрдБрдЦ рдмрдВрдж рдХрд░рдХреЗ рднреА рдирд╣реАрдВред  рд▓реЗрдХрд┐рди JTAG рдкрд░ рд╕рдм рдХреБрдЫ рдзреАрдорд╛ рд╣реЛ рдЧрдпрд╛ - рдЖрддрдВрдХ!  рдЦреИрд░, рдЕрдВрдд рдореЗрдВ, рд╕рдм рдХреБрдЫ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдкрд░ рдХрд╛рдо рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рд▓реЗрдХрд┐рди QEMU рдкрд░ рдбрд┐рдмрдЧ рдХрд░рдирд╛ рдЕрдЪреНрдЫрд╛ рд╣реЛрдЧрд╛ред  рдкреНрд░рдпреЛрдЧреЛрдВ рдХреА рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рд╕рдВрдЦреНрдпрд╛ рдХреЗ рдмрд╛рдж, рдХреБрдЫ рдПрдХ рдмреИрд╕рд╛рдЦреА рдирд┐рдХрд▓рд╛, рд▓реЗрдХрд┐рди рдмреЛрд░реНрдб рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд╕рдорд╛рди: </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M help Supported machines are: none empty machine sifive_e RISC-V Board compatible with SiFive E SDK sifive_u RISC-V Board compatible with SiFive U SDK spike_v1.10 RISC-V Spike Board (Privileged ISA v1.10) (default) spike_v1.9.1 RISC-V Spike Board (Privileged ISA v1.9.1) virt RISC-V VirtIO Board (Privileged ISA v1.10)</code> </pre> <br><p>  рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реЗ рдмреЛрд░реНрдб QEMU рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИрдВред  рдореБрдЭреЗ <code>sifive_u</code> рд╕рдВрдЧрдд рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдкреА рд╣реИред </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M sifive_u,dumpdtb -m 1g # - QEMU      on --  strace   $ ls -l on -rw-rw-r-- 1 trosinenko trosinenko 1923  19 20:14 on $ dtc -I dtb &lt; on &gt; on.dts #   $ vim on.dts #  bootargs $ dtc &lt; on.dts &gt; on.dtb &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 1 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 2 is not a phandle reference</code> </pre> <br><p>  рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ "рдлрд┐рдХреНрд╕реНрдб" рдбрд┐рд╡рд╛рдЗрд╕ рдЯреНрд░реА рдмреНрд▓реЙрдм рд╣реИред  <strong>VM</strong> (рдмреИрд╕рд╛рдЦреА!) <strong>рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдмрджрд▓реЗ рдмрд┐рдирд╛</strong> , рдЪрд▓рд╛рдПрдВ: </p><br><pre> <code class="plaintext hljs">qemu-system-riscv64 \ -M sifive_u -m 1g \ -serial stdio \ -s -S</code> </pre> <br><p>  <code>-serial stdio</code> рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рдХреЛ рдХрдВрд╕реЛрд▓ рдкрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдПрд╕реНрдХреЗрдк рдЕрдиреБрдХреНрд░рдо рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред  <code>-s -S</code> рд╡рд┐рдХрд▓реНрдк рдХреНрд░рдорд╢рдГ gdbserver рдмрдврд╝рд╛рддреЗ рд╣реИрдВ рдФрд░ рдПрдХ VM рдХреЛ рд╡рд┐рд░рд╛рдо рджреЗрддреЗ рд╣реИрдВред  рдЖрдк <code>loader</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреЛрдб рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдлрд┐рд░ рдЖрдкрдХреЛ рд╣рд░ рдмрд╛рд░ QEMU рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред </p><br><p>  рдЖрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рдХрдиреЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:1234' \ -ex 'restore /path/to/on.dtb binary 0x80100000' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80020000' \ -ex 'add-symbol-file memtest_shared 0x80100000' \ -ex 'set $a1=0x80020000' \ -ex 'set $pc=0x80100000'</code> </pre> <br><p>  рдирддреАрдЬрддрди, рд╕рдм рдХреБрдЫ рдЪрд╛рд▓рд╛рдХреА рд╕реЗ рдЕрдзрд┐рдХ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ! </p><br><h2 id="obschiy-princip-raboty">  рдХрд╛рдо рдХрд╛ рд╕рд╛рдорд╛рдиреНрдп рд╕рд┐рджреНрдзрд╛рдВрдд </h2><br><p> , ,  ,   Memtest86+   <code>btrace</code> ,        ,      (  ,     QEMU): </p><br><p><img src="https://habrastorage.org/webt/su/lr/qh/sulrqhzmiona327osxqzaikijf0.png" alt="btrace рдореЛрдб"></p><br><p>  ,      , memtest          .     ,      (, trap):  ,   ,   QEMU - !  ┬л┬╗   <code>Illegal instruction</code>  ,    .      <code>mcause</code> (?),   тАФ <code>mepc</code> (?),   тАФ <code>mtval</code> (    ?),    . </p><br><p><img src="https://habrastorage.org/webt/lc/is/ho/lcishowkkjngpnorx_gkyav-svg.png" alt="рдЕрд╡реИрдз рдирд┐рд░реНрджреЗрд╢"></p><br><p>   ,      : </p><br><p> <strong>head.S:</strong> </p><br><pre> <code class="plaintext hljs">#       #   = 0 ---   ,   #  ,    ,     ... lla t1, _trap_entry csrw mtvec, t1 # ... _trap_entry: csrr a0, mcause csrr a1, mepc csrr a2, mtval jal riscv_trap_entry</code> </pre> <br><p>  ,        calling convention,  .        memtest,    HiFive_U-Boot,      <code>Volume II</code> : </p><br><p> <strong>arch.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *errors[] = { <span class="hljs-string"><span class="hljs-string">"Instruction address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Instruction access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Illegal instruction"</span></span>, <span class="hljs-string"><span class="hljs-string">"Breakpoint"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO access fault"</span></span>, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Instruction page fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load page fault"</span></span>, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Store/AMO page fault"</span></span>, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">riscv_trap_entry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ulong cause, ulong epc, ulong tval)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">32</span></span>]; cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"EXCP: "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cause &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, errors[cause]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { itoa(buf, cause); cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, buf); } cprint(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"PC: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, epc, <span class="hljs-number"><span class="hljs-number">8</span></span>); cprint(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Addr: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, tval, <span class="hljs-number"><span class="hljs-number">8</span></span>); HALT(); }</code> </pre> <br><p>        тАФ    ┬л ┬╗   .   ,   ┬л┬╗    ,  ,      ,  . </p><br><p>         :     .       ,  memtest  :    : ┬л       ,   ,    .        ┬╗.    :  <code>do_test</code>   <code>main.c</code>    2,   (    ),       тАФ    ┬л┬╗ ,    memtest.       ,    <code>run_at</code> ,    memtest  <code>_start</code>  <code>_end</code>    (   ┬л┬╗  ),  -     spinlock'        <code>goto *addr;</code>        . ,  ,      ┬л┬╗    ,    ┬л┬╗. </p><br><p>      ,    <strong> </strong>  <code>bss</code>    тАФ    <code>_dl_start</code>  ,   <code>riscv_entry</code>  ,   trap entry. ,   :     L1I-,   .    ,     <code>fence.i</code> . </p><br><p>   ,  Memtest86+ тАФ ,         <code>barrier_s</code>    .       ,          . ,   ,       . </p><br><h2 id="podvodnye-kamni">   </h2><br><p>    ,   :   .   :           .    <em></em> : ,  -       (Own Address,     )   .     ,     ,   .       . -    .   ,   x86 , ,    <code>uint64_t</code>   <code>0x80000002</code>       . ,     : <a href="https://stackoverflow.com/questions/12491578/whats-the-actual-effect-of-successful-unaligned-accesses-on-x86" rel="nofollow"> </a> ,   load/store  x86   ,     тАФ .    ,    QEMU    ,  ┬л  ,      ┬╗. </p><br><p> ,     ,  <em>  </em> тАФ   unaligned access  .. </p><br><p> ,   ,     RocketChip,   тАФ QEMU,   ,  ,   RocketChip тАФ unaligned access trap,  QEMU  ┬л  ┬╗. <br>   ┬лmisaligned┬╗            ,   </p><br><blockquote> Changed description of misaligned load and store behavior. The specification now allows visible misaligned address traps in execution environment interfaces, rather than just mandating invisible handling of misaligned loads and stores in user mode. Also, now allows access exceptions to be reported for misaligned accesses (including atomics) that should not be emulated. </blockquote><p>  , ,  тАФ   ,  user-mode code   ,             .     .   , ,   .   ,       тАФ -   machine mode    . ,     <code>rdtsc</code> (x86)  <code>rdtime</code> (rv64),   trap,     . , ,                memory-mapped . </p><br><p>    :      ,  <em> </em>   <code>low_test_addr</code> (       ),  ,   fdt   .   ,  ,  <code>low_test_addr</code>   ,  ,      2   <code>high_test_adr</code>    тАж ,     тАФ   : <code>head.S</code>       <code>initial_load_addr</code> ,    <code>riscv_entry</code>    <code>move_to_correct_addr</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">move_to_correct_addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_start = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_start; <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_end = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_end; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_start == low_test_addr || cur_start == high_test_adr) { <span class="hljs-comment"><span class="hljs-comment">//  ,     return; } if (cur_start == initial_load_addr &amp;&amp; (cur_start - low_test_addr) &lt; (cur_end - cur_start) ) { //   " ":   , //           //     ,    ,   //     ... serial_echo_print("FIRST STARTUP RELOCATION...\n"); void *temp_addr = (((uintptr_t)&amp;_end &gt;&gt; 12) + 1) &lt;&lt; 12; run_at(temp_addr, 0); } else { // ,    --- ,  . serial_echo_print("FINAL STARTUP RELOCATION...\n"); run_at(low_test_addr, 0); } }</span></span></code> </pre> <br><p> ,     тАФ   ,  memtest ,  RAM  -   .  RISC-V    ,        <code>v-&gt;plim_lower</code> . </p><br><p>     ,   ┬л┬╗ ,    -,   тАФ  <code>test.c</code>    <code>ulong</code> (  <code>unsigneg long</code> ),   32- x86   <code>uint32_t</code> ,    ┬л 64 ┬╗   <code>uint64_t</code> .       ┬л!!! Good: ffffffff Real: ffffffff Bad bits: 00000000┬╗.   ?       - -1,  32    1.   ,         ,        0тАж  ,     : ,  <code>ulong</code>      ( <code>uint32_t</code> ),          ( <code>uintptr_t</code> ). ,       . ,     <code>uint64_t</code>   4. RISC-V  <em></em>  ,       C, ,    тАФ    UB. <del>     memtest  UBSan. </del>  ,  ,  UBSan   trap-on-error        JTAG. </p><br><h2 id="upakovyvaem-dlya-zagruzchika">    </h2><br><p> ,  memtest -  ,    ,          U-Boot. </p><br><p>       :    <code>mkimage</code>   U-Boot   <em>  Linux</em> : </p><br><pre> <code class="plaintext hljs">mkimage -A riscv -O linux -T kernel -C none \ -a 0x80000000 -e 0x80000000 \ -n memtest -d memtest.bin memtest.uboot</code> </pre> <br><p>      SD-      </p><br><pre> <code class="plaintext hljs">run mmcsetup; run fdtsetup; fdt set /chosen bootargs "console=ttyS0"; fatload mmc 0:1 82000000 memtest.uboot; bootm fdt; bootm 82000000 - ${fdtaddr}</code> </pre> <br><p> (   ,   <code>run</code>     тАФ        ). </p><br><p>      :       FDT: <code>0xbffb7c80</code> . ,  :    <code>ffffffff</code> ,     .     ,         (     ),    :   HiFive_U-Boot      : </p><br><pre> <code class="cpp hljs"> theKernel(machid, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)images-&gt;ft_addr);</code> </pre> <br><p>    ,     </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*theKernel)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arch, uint params);</code> </pre> <br><p>  ,     , ,  ,  32        ,     <code>head.S</code> : </p><br><pre> <code class="plaintext hljs"> li t0, 0xffffffffL and a1, a1, t0</code> </pre> <br><h2 id="promezhutochnyy-itog">   </h2><br><p> ,  , - ,  ,     ,  : </p><br><ul><li>     x86.       тАФ       review         <strong>   </strong> </li><li>   SMP   RISC-V </li><li>        <code>arch/</code> -  </li><li>     <code>test.c</code>  RISC-V (      <code>-O0</code> !) </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi484026/">https://habr.com/ru/post/hi484026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi484012/index.html">рдПрдХ рдмреНрд▓реЙрдХ рдиреЛрдЯрдмреБрдХ рдореЗрдВ рд▓реЗрдЦрди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░реЗрдВ</a></li>
<li><a href="../hi484014/index.html">2020 рдореЗрдВ 10 рдПрд╕рдИрдУ рдорд┐рдердХ рдкреАрдЫреЗ рдЫреВрдЯ рдЧрдП</a></li>
<li><a href="../hi484016/index.html">рдбрд┐рдмрдЧ рдСрдЯреЛрдПрдиреНрдХреЛрдбрд░ рдХреЗ рдЙрджрд╛рд╣рд░рдг рдкрд░ рдЧрд╣рд░реА рд╕реАрдЦрдиреЗ рдХреА рдореВрд▓ рдмрд╛рддреЗрдВ, рднрд╛рдЧ рд╕рдВрдЦреНрдпрд╛ 1</a></li>
<li><a href="../hi484018/index.html">рдиреМрдХрд╛рдпрди рдХрд╛ рдЖрдИрдЯреА рддрдХрдиреАрдХреА рдкрдХреНрд╖</a></li>
<li><a href="../hi484020/index.html">рдЖрдк рдЕрдкрдиреА рдбреЗрдбрд▓рд╛рдЗрди рдХреЗ рд╕рд╛рде рдХрд┐рд╕реЗ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ?</a></li>
<li><a href="../hi484028/index.html">рдШреЛрдбрд╝реЗ рдХреА рдирд╛рд▓ рдореЛрдбрд╝ - рддрд╣ рдкреНрд░рджрд░реНрд╢рди рдХреЗ рд╕рд╛рде рдкрд░рд┐рд╡рд░реНрддрдиреАрдп рдЧреЛрд▓реА</a></li>
<li><a href="../hi484034/index.html">рдЧреЛрджрд╛рдо рд▓реЗрдЦрд╛ рдЗрдХрд╛рдИ 1C рдПрдХреАрдХреГрдд рд╕реНрд╡рдЪрд╛рд▓рди 2 рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдорд╛рд▓ рдХреЗ рд▓рдХреНрд╖рд┐рдд рднрдВрдбрд╛рд░рдг рдХреА рдХрд╛рд░реНрдп рдпреЛрдЬрдирд╛ рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди</a></li>
<li><a href="../hi484036/index.html">рдирдпрд╛ рдЙрджреНрдпреЛрдЧ рд╕рдореВрд╣ рд╕реНрдорд╛рд░реНрдЯ рдШрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рдорд╛рдирдХ рдмрдирд╛рддрд╛ рд╣реИ</a></li>
<li><a href="../hi484046/index.html">рдкреАрд╡реАрдПрд╕-рд╕реНрдЯреВрдбрд┐рдпреЛ рдХреЗ рд╕рд╛рде рдПрдореНрдмреА рдХреА рдЬрд╛рдБрдЪ</a></li>
<li><a href="../hi484048/index.html">PHP рдФрд░ рдирд┐рдпрдорд┐рдд рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐: рд╢реБрд░реБрдЖрддреА рдХреЗ рд▓рд┐рдП рдореВрд▓ рдмрд╛рддреЗрдВ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>