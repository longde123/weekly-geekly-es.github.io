<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍❤️‍👨 🔫 🍻 Agones, créez un serveur de jeu multi-utilisateurs. Architecture et installation 💡 🤷 👏🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Agones (d'un autre agon grec - «compétition») vous permet de déployer un cluster de serveurs de jeux à l'aide de Kubernetes avec Auto-Scaling. Ce proj...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Agones, créez un serveur de jeu multi-utilisateurs. Architecture et installation</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469381/"><p>  Agones (d'un autre agon grec - «compétition») vous permet de déployer un cluster de serveurs de jeux à l'aide de Kubernetes avec Auto-Scaling.  Ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet</a> open source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">a</a> été créé en 2018, a déjà marqué 2500 étoiles, était sur Google I / O 2019, et sur Habré, à notre grande surprise, n'était pas encore mentionné.  La rubrique décrit une brève excursion dans l'architecture et des instructions pour démarrer un serveur de test sur une machine locale.  Si vous êtes intéressé, bienvenue à Kat, allez-y! </p><br><img src="https://habrastorage.org/getpro/habr/post_images/af7/fce/4ea/af7fce4ea1dbb86b3bac94479a1b1f15.png" alt="Logo Agones"><a name="habracut"></a><br><h3>  Description du projet </h3><br><p>  Agones est une ressource personnalisée ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">extension API Kubernetes</a> ). </p><br><p>  Le projet nécessite en fait plus d'attention, car il vous permet d'exécuter un seul serveur de jeu (GameServer) ou toute une "flotte" de serveurs (Flottes) via des fichiers de configuration yaml, via l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API Agones</a> .  À son tour, chaque serveur donne des alertes sur son cycle de vie (cycles de vie GameServer), décrivant l'état actuel (vérification de l'état, informations de connexion).  Les serveurs du cluster peuvent évoluer automatiquement (Fleet Autoscaling), qui sont intégrés aux capacités de base de Kubernetes.  De plus, il y a une sortie de statistiques sur le tableau de bord utilisant Prometheus, Grafana ou Stackdriver, les métriques sont exportées via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenCensus</a> , ce qui vous permet d'ajouter votre propre exportateur.  Exemple de tableau de bord dans Stackdriver: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/991/03b/929/99103b9292365163e2b77ae292e4eba2.png" alt="image"></p><br><h3>  Architecture, éléments de base </h3><br><p>  Agones se charge de lancer, d'étendre et d'héberger automatiquement des serveurs de jeux en utilisant Kubernetes comme base.  Cela vous permet de vous concentrer sur le développement du serveur de jeu multijoueur lui-même, au lieu de développer son infrastructure et son support supplémentaire.  Vous pouvez utiliser n'importe quel serveur de jeux qui peut être exécuté sur Linux et il peut être écrit dans n'importe quel langage de programmation. </p><br><p>  L'API Agones Kubernetes est divisée en trois packages principaux, chacun contenant des ressources: agones.dev (GameServer, GameServerSet, Fleet), allocation.agones.dev (GameServerAllocation), autoscaling.agones.dev (FleetAutoscaler).  Comme les autres ressources Kubernetes, les fichiers yaml sont utilisés pour les exécuter. </p><br><p>  Une brève description de chaque ressource: </p><br><ul><li>  GameServer - crée un certain modèle qui vous permet d'utiliser les paramètres de pod habituels, avec quelques ajouts, tels que hostPort et containerPort pour le serveur de jeu.  Le SDK Agones fournit un conteneur de sidecar en option avec lequel le GameServer communiquera en permanence </li><li>  GameServerSet - structure de données pour plusieurs GameServer, très similaire à la relation entre Depoyment et ReplicaSet </li><li>  Flotte - crée plusieurs GameServer prêts à l'emploi, utilise GameServerAllocation pour distribuer les ressources </li><li>  GameServerAllocation - demande au GameServer de Fleet de l'utiliser et indique qu'il est prêt à être utilisé par les joueurs, donc GameServer ne sera pas automatiquement supprimé </li><li>  FleetAutoscaler - étend automatiquement ou, inversement, réduit le nombre de serveurs dans Fleet </li></ul><br><p>  Le diagramme (à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partir d'ici</a> ) montre le cycle de vie de la ressource GameServer: </p><br><p><img src="https://habrastorage.org/webt/_2/2x/gc/_22xgcnfs_6ercdwmte8hktzynw.png"></p><br><p>  Les flèches violettes indiquent le SDK Agones, rouge - l'API utilisateur, bleu - le contrôleur du serveur de jeu, jaune - le contrôleur d'application. </p><br><h3>  L'installation </h3><br><p>  Dans cette section et les suivantes, des équipes avec des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions</a> sur le site officiel sont utilisées, avec quelques ajouts.  Nous vous recommandons d'utiliser Kubernetes version 1.12 (testé par les développeurs).  Pour le test sur l'ordinateur local, vous pouvez utiliser un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">minikube</a> , qui nécessitera <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kubectl</a> et un hyperviseur ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hyper-V</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">VirtualBox</a> ) pris en charge par le système d'exploitation. </p><br><p>  Pour installer le cluster et Agones, vous devez exécuter les commandes suivantes: </p><br><pre><code class="bash hljs">minikube profile agones <span class="hljs-comment"><span class="hljs-comment">#    agones minikube start --kubernetes-version v1.12.10 --vm-driver hyperv #virtualbox minikube status #     kubectl create namespace agones-system #    agones kubectl apply -f https://raw.githubusercontent.com/googleforgames/agones/release-1.0.0/install/yaml/install.yaml</span></span></code> </pre> <br><p>  La dernière commande télécharge le fichier de configuration Agones qui crée des définitions de ressources personnalisées (CRD) via l'API Kubernetes. </p><br><h3>  Lancement de GameServer </h3><br><p>  Vous pouvez maintenant démarrer le serveur UDP dans le cluster à l'aide du serveur de test prêt à l'emploi des exemples, qui répondra simplement à la demande qui lui est envoyée: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># GameServer  kubectl create -f https://raw.githubusercontent.com/googleforgames/agones/release-1.0.0/examples/simple-udp/gameserver.yaml kubectl get gameservers #  GameServer minikube ip #     kubectl describe gameserver #    GameServer kubectl get gs #  ,   GameServer</span></span></code> </pre> <br><p>  Pour confirmer que le serveur fonctionne, vous pouvez utiliser NetCat, pour Linux, le programme est généralement livré avec le système, pour Windows, vous devez le télécharger, par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  NetCat doit être démarré avec le paramètre <code>-u</code> (demande UDP), en spécifiant l'adresse du mini-cube (il est préférable de copier l'adresse à partir de la commande <code>minikube ip</code> du <code>minikube ip</code> - <code>minikube ip</code> ) et le port GameServer actif: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"hello"</span></span> | nc -u $(minikube ip) 7331</code> </pre> <br><p>  Si après avoir exécuté la commande dans la console la réponse "ACK: bonjour" apparaît, alors le serveur fonctionne, vous pouvez le désactiver par la commande suivante, qui s'initialise: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"EXIT"</span></span> | nc -u $(minikube ip) 7331</code> </pre> <br><p>  L'état du serveur est vérifié par l'équipe <code>kubectl describe gameserver</code> le <code>kubectl describe gameserver</code> , il devrait passer à Shutdown. </p><br><h3>  Apporter des modifications à GameServer </h3><br><p>  En utilisant l'exemple précédent, nous allons changer la réponse du serveur.  Tout d'abord, copiez le référentiel du projet: </p><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:googleforgames/agones.git</code> </pre> <br><p>  Dans le fichier <a href="">agones / examples / simple-udp / main.go,</a> changez la ligne 159 en </p><br><pre> <code class="go hljs">respond(conn, sender, <span class="hljs-string"><span class="hljs-string">"ACKNOWLEDGED: "</span></span>+txt+<span class="hljs-string"><span class="hljs-string">"\n"</span></span>)</code> </pre> <br><p>  À partir du dossier racine du projet, exécutez ce qui suit pour créer une image d'ancrage et l'enregistrer dans le mini-cube.  Pour Windows, vous devez d'abord exécuter <code>minikube docker-env | Invoke-Expression</code>  <code>minikube docker-env | Invoke-Expression</code> , pour linux <code>eval $(minikube docker-env)</code> .  Cela vous permettra de créer des images Docker directement dans le minikube. <br>  Créez une image docker: </p><br><pre> <code class="bash hljs">docker build -t agones-go:modified -f .\examples\simple-udp\Dockerfile .</code> </pre> <br><p>  Cette commande peut prendre un certain temps, car l'intégralité du référentiel de projet sera copié dans l'image.  Cela peut être évité en ne laissant que le dossier sdks, main.go et Dockerfile dans le répertoire. </p><br><p>  Ensuite, dans <a href="">examples \ simple-udp \ gameserver.yaml,</a> changez la ligne 28 en <code>image: agones-go:modified</code> et créez un nouveau GameServer: </p><br><pre> <code class="bash hljs">kubectl create -f .\examples\simple-udp\gameserver.yaml</code> </pre> <br><p>  Vérifiez les modifications et éteignez le serveur: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"hello"</span></span> | nc -u 172.17.113.72 7331 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"EXIT"</span></span> | nc -u 172.17.113.72 7331</code> </pre> <br><p>  Si, après avoir exécuté des commandes dans la console, la réponse "ACKNOWLEDGED: hello" apparaît, les modifications ont réussi. </p><br><h3>  Nous démarrons le serveur localement </h3><br><p>  Vous pouvez itérer les modifications pour un développement pratique sans Kubernetes, en utilisant uniquement le SDK Agones.  Pendant que le serveur de jeu est en cours d'exécution, le SDK communique via TCP avec un petit serveur gRPC qu'Agones exécute dans un conteneur sous le même espace de noms.  Un tel conteneur dans Kubernetes est appelé sidecar.  Par conséquent, pour le développement local, vous devez démarrer le processus SDK.  Pour ce faire, vous devez exécuter son fichier source avec le paramètre <code>-local</code> , qui active le mode «mode local».  Ce mode indique au processus d'être en mode passif et de ne se connecter nulle part, affichez simplement les journaux dans la console afin que vous puissiez voir ce que fait le SDK pendant que le serveur de jeu est en cours d'exécution. </p><br><p>  Vous pouvez télécharger le dernier serveur agonessdk dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">versions du</a> référentiel de projet officiel.  Par défaut, après le démarrage du serveur SDK, un espace vide de configuration GameServer est créé, qui est utilisé pour les requêtes SDK GameServer () et WatchGameServer ().  Au démarrage, vous pouvez spécifier votre propre fichier de configuration au format yaml ou json, pour cela vous avez besoin du paramètre <code>-file</code> ou de sa version raccourcie <code>-f</code> avec le paramètre <code>-local</code> . </p><br><pre> <code class="plaintext hljs">.\sdk-server --local -f .\examples\simple-udp\gameserver.yaml sdk-server : {"ctlConf":{"Address":"localhost","IsLocal":true,"LocalFile":".\\examples\\simple-udp\\gameserver.yaml","Timeout":0,"Test":""},"grpcPor t":59357,"httpPort":59358,"message":"Starting sdk sidecar","severity":"info","source":"main","time":"2019-09-29T12:45:59.8379817+02:00","version":"1.0.0"} {"filePath":"C:\\agones-release-1.0.0\\examples\\simple-udp\\gameserver.yaml","message":"Reading GameServer configuration","severity":"info","time":"2019-09-29T12:45:59.8479789+02:00"} {"message":"Starting SDKServer grpc service...","severity":"info","source":"main","time":"2019-09-29T12:45:59.8529791+02:00"} {"message":"Starting SDKServer grpc-gateway...","severity":"info","source":"main","time":"2019-09-29T12:46:00.1555756+02:00"}</code> </pre> <br><p>  À suivre ... </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469381/">https://habr.com/ru/post/fr469381/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469369/index.html">Événements numériques à Moscou du 30 septembre au 06 octobre</a></li>
<li><a href="../fr469371/index.html">Description de l'approche pour organiser et tester le code à l'aide de Redux Thunk</a></li>
<li><a href="../fr469373/index.html">Les résultats du projet de création d'une interface neuronale pour des patients complètement paralysés remettent en cause</a></li>
<li><a href="../fr469375/index.html">Pourquoi Mozilla, Coil et Creative Commons allouent 100 millions de dollars pour des projets open source?</a></li>
<li><a href="../fr469379/index.html">Application des méthodes formelles de validation des modèles pour l'interface utilisateur</a></li>
<li><a href="../fr469383/index.html">Solution hyperconvergée AERODISK vAIR. Base - Système de fichiers ARDFS</a></li>
<li><a href="../fr469387/index.html">L'histoire d'un "développeur" ou comment un nouveau venu pour écrire une application pour iOS</a></li>
<li><a href="../fr469389/index.html">Paramétrage par un réseau neuronal d'un modèle physique pour résoudre un problème d'optimisation topologique</a></li>
<li><a href="../fr469391/index.html">Interfaces audio: le son comme source d'information sur la route, au bureau et dans le ciel</a></li>
<li><a href="../fr469393/index.html">Rédaction sur Flare-On 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>