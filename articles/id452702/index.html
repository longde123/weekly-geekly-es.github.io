<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💇 ❇️ 👨🏼‍🎨 Tes untuk kode dan kode untuk tes 👨🏾‍⚕️ 👤 👴🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam bahasa dinamis, seperti python dan javascript, dimungkinkan untuk mengganti metode dan kelas dalam modul secara langsung selama operasi. Ini san...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tes untuk kode dan kode untuk tes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452702/"><p>  Dalam bahasa dinamis, seperti python dan javascript, dimungkinkan untuk mengganti metode dan kelas dalam modul secara langsung selama operasi.  Ini sangat nyaman untuk pengujian - Anda cukup meletakkan "tambalan" yang akan mengecualikan logika yang berat atau tidak perlu dalam konteks tes ini. </p><br><p>  Tapi apa yang harus dilakukan di C ++?  Pergi  Jawa?  Dalam bahasa-bahasa ini, kode tidak dapat dimodifikasi untuk pengujian dengan cepat, dan membuat tambalan membutuhkan alat terpisah. </p><br><p>  Dalam kasus seperti itu, Anda harus secara khusus menulis kode sehingga diuji.  Ini bukan hanya keinginan besar untuk melihat cakupan 100% dalam proyek Anda.  Ini adalah langkah menuju penulisan kode yang didukung dan berkualitas. </p><br><p>  Pada artikel ini saya akan mencoba untuk berbicara tentang ide-ide utama di balik penulisan kode yang dapat diuji dan menunjukkan bagaimana mereka dapat digunakan dengan contoh program go sederhana. </p><a name="habracut"></a><br><h2 id="beshitrostnaya-programma">  Program tidak rumit </h2><br><p>  Kami akan menulis program sederhana untuk membuat permintaan ke VK API.  Ini adalah program yang cukup sederhana yang menghasilkan permintaan, membuatnya, membaca respons, menerjemahkan jawaban dari JSON ke dalam struktur dan menampilkan hasilnya kepada pengguna. </p><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"io/ioutil"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"net/url"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> token = <span class="hljs-string"><span class="hljs-string">"token here"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//     var requestURL = fmt.Sprintf( "https://api.vk.com/method/%s?&amp;access_token=%s&amp;v=5.95", "users.get", token, ) //   resp, err := http.PostForm(requestURL, nil) //   if err != nil { fmt.Println(err) return } //       defer resp.Body.Close() //     body, err := ioutil.ReadAll(resp.Body) //   if err != nil { fmt.Println(err) return } //      var result struct { Response []struct { ID int `json:"id"` FirstName string `json:"first_name"` LastName string `json:"last_name"` } `json:"response"` } //        err = json.Unmarshal(body, &amp;result) //   if err != nil { fmt.Println(err) return } // ,    if len(result.Response) &lt; 1 { fmt.Println("No values in response array") return } //    fmt.Printf( "Your id: %d\nYour full name: %s %s\n", result.Response[0].ID, result.Response[0].FirstName, result.Response[0].LastName, ) }</span></span></code> </pre> <br><p>  Sebagai profesional di bidang kami, kami memutuskan bahwa perlu untuk menulis tes untuk aplikasi kami.  Buat file uji ... </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"testing"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_Main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { main() }</code> </pre> <br><p>  Itu tidak terlihat sangat menarik.  Pemeriksaan ini adalah peluncuran sederhana aplikasi yang tidak dapat kami pengaruhi.  Kami tidak dapat mengecualikan pekerjaan dengan jaringan, memeriksa operabilitas untuk berbagai kesalahan, dan bahkan mengganti token untuk verifikasi akan gagal.  Mari kita coba mencari cara untuk meningkatkan program ini. </p><br><h2 id="pattern-vnedrenie-zavisimosti">  Pola Injeksi Ketergantungan </h2><br><p>  Pertama, Anda perlu menerapkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pola "injeksi ketergantungan"</a> . </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> VKClient <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Token <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client VKClient)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestURL = fmt.Sprintf( <span class="hljs-string"><span class="hljs-string">"https://api.vk.com/method/%s?&amp;access_token=%s&amp;v=5.95"</span></span>, <span class="hljs-string"><span class="hljs-string">"users.get"</span></span>, client.Token, ) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Dengan menambahkan struktur, kami membuat dependensi (kunci akses) untuk aplikasi, yang dapat ditransfer dari sumber yang berbeda, yang menghindari nilai "kabel" dan menyederhanakan pengujian. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> example <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"testing"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> workingToken = <span class="hljs-string"><span class="hljs-string">"workingToken"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ShowUserInfo_Successful</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := VKClient{workingToken} client.ShowUserInfo() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ShowUserInfo_EmptyToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := VKClient{<span class="hljs-string"><span class="hljs-string">""</span></span>} client.ShowUserInfo() }</code> </pre> <br><h2 id="razdelenie-polucheniya-informacii-i-eyo-vyvoda">  Pemisahan menerima informasi dan hasilnya </h2><br><p>  Sekarang hanya seseorang yang bisa membuat kesalahan, dan kemudian hanya jika dia tahu apa kesimpulannya.  Untuk mengatasi masalah ini, perlu untuk tidak menampilkan informasi secara langsung ke aliran output, tetapi untuk menambahkan metode terpisah untuk mendapatkan informasi dan hasilnya.  Dua bagian independen ini akan lebih mudah untuk diverifikasi dan dirawat. </p><br><p>  Mari kita membuat metode <code>GetUserInfo()</code> , yang akan mengembalikan struktur dengan informasi pengguna dan kesalahan (jika itu terjadi).  Karena metode ini tidak menghasilkan apa-apa, kesalahan yang terjadi akan ditransmisikan lebih lanjut tanpa keluaran, sehingga kode yang membutuhkan data akan mengetahui situasinya. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> UserInfo <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> FirstName <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"first_name"`</span></span> LastName <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"last_name"`</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client VKClient)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserInfo, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestURL = fmt.Sprintf( <span class="hljs-string"><span class="hljs-string">"https://api.vk.com/method/%s?&amp;access_token=%s&amp;v=5.95"</span></span>, <span class="hljs-string"><span class="hljs-string">"users.get"</span></span>, client.Token, ) resp, err := http.PostForm(requestURL, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UserInfo{}, err } <span class="hljs-comment"><span class="hljs-comment">// ... var result struct { Response []UserInfo `json:"response"` } // ... return result.Response[0], nil }</span></span></code> </pre> <br><p>  Ubah <code>ShowUserInfo()</code> sehingga menggunakan <code>GetUserInfo()</code> dan menangani kesalahan. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client VKClient)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { userInfo, err := client.GetUserInfo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Println(err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } fmt.Printf( <span class="hljs-string"><span class="hljs-string">"Your id: %d\nYour full name: %s %s\n"</span></span>, userInfo.ID, userInfo.FirstName, userInfo.LastName, ) }</code> </pre> <br><p>  Sekarang dalam tes Anda dapat memverifikasi bahwa jawaban yang benar diterima dari server, dan jika token salah, kesalahan dikembalikan. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_GetUserInfo_Successful</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := VKClient{workingToken} userInfo, err := client.GetUserInfo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { t.Fatal(err) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> userInfo.ID == <span class="hljs-number"><span class="hljs-number">0</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"ID is empty"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> userInfo.FirstName == <span class="hljs-string"><span class="hljs-string">""</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"FirstName is empty"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> userInfo.LastName == <span class="hljs-string"><span class="hljs-string">""</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"LastName is empty"</span></span>) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ShowUserInfo_EmptyToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := VKClient{<span class="hljs-string"><span class="hljs-string">""</span></span>} _, err := client.GetUserInfo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"Expected error but found &lt;nil&gt;"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err.Error() != <span class="hljs-string"><span class="hljs-string">"No values in response array"</span></span> { t.Fatalf(<span class="hljs-string"><span class="hljs-string">`Expected "No values in response array", but found "%s"`</span></span>, err) } }</code> </pre> <br><p>  Selain memperbarui tes yang ada, Anda perlu menambahkan tes baru untuk metode <code>ShowUserInfo()</code> . </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ShowUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := VKClient{workingToken} client.ShowUserInfo() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ShowUserInfo_WithError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := VKClient{<span class="hljs-string"><span class="hljs-string">""</span></span>} client.ShowUserInfo() }</code> </pre> <br><h2 id="nastraivaemye-alternativy">  Alternatif khusus </h2><br><p>  Tes untuk <code>ShowUserInfo()</code> menyerupai apa yang kami coba hindari pada awalnya.  Dalam hal ini, satu-satunya titik metode ini adalah untuk menampilkan informasi ke aliran keluaran standar.  Di satu sisi, Anda dapat mencoba mendefinisikan ulang os.Stdout dan memeriksa output, sepertinya solusi yang terlalu berlebihan ketika Anda dapat bertindak lebih elegan. </p><br><p>  Alih-alih menggunakan <code>fmt.Printf</code> , Anda dapat menggunakan <code>fmt.Fprintf</code> , yang memungkinkan Anda untuk output ke <code>io.Writer</code> .  <code>os.Stdout</code> mengimplementasikan antarmuka ini, yang memungkinkan kita untuk mengganti <code>fmt.Printf(text)</code> dengan <code>fmt.Fprintf(os.Stdout, text)</code> .  Setelah itu, kita bisa meletakkan <code>os.Stdout</code> di bidang terpisah, yang dapat diatur ke nilai yang diinginkan (untuk tes - string, untuk pekerjaan - aliran output standar). </p><br><p>  Karena kemampuan untuk mengubah Writer untuk output akan jarang digunakan, terutama untuk tes, masuk akal untuk menetapkan nilai default.  Pada <code>VKClient</code> , untuk ini kita akan melakukan ini - membuat tipe <code>VKClient</code> diekspor dan membuat fungsi konstruktor untuknya. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> vkClient <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Token <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OutputWriter io.Writer } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVKClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vkClient</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vkClient{ token, os.Stdout, } }</code> </pre> <br><p>  Dalam fungsi <code>ShowUserInfo()</code> , kami mengganti Panggilan <code>Print</code> dengan <code>Fprintf</code> . </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client vkClient)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { userInfo, err := client.GetUserInfo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Fprintf(client.OutputWriter, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } fmt.Fprintf( client.OutputWriter, <span class="hljs-string"><span class="hljs-string">"Your id: %d\nYour full name: %s %s\n"</span></span>, userInfo.ID, userInfo.FirstName, userInfo.LastName, ) }</code> </pre> <br><p>  Sekarang Anda perlu memperbarui tes sehingga mereka membuat klien menggunakan konstruktor dan menginstal Writer lain jika diperlukan. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ShowUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := CreateVKClient(workingToken) buffer := bytes.NewBufferString(<span class="hljs-string"><span class="hljs-string">""</span></span>) client.OutputWriter = buffer client.ShowUserInfo() result, _ := ioutil.ReadAll(buffer) matched, err := regexp.Match( <span class="hljs-string"><span class="hljs-string">`Your id: \d+\nYour full name: [^\n]+\n`</span></span>, result, ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { t.Fatal(err) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !matched { t.Fatalf(<span class="hljs-string"><span class="hljs-string">`Expected match but failed with "%s"`</span></span>, result) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ShowUserInfo_WithError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := CreateVKClient(<span class="hljs-string"><span class="hljs-string">""</span></span>) buffer := bytes.NewBufferString(<span class="hljs-string"><span class="hljs-string">""</span></span>) client.OutputWriter = buffer client.ShowUserInfo() result, _ := ioutil.ReadAll(buffer) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(result) != <span class="hljs-string"><span class="hljs-string">"No values in response array"</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"Wrong error"</span></span>) } }</code> </pre> <br><p>  Untuk setiap pengujian tempat kami mengeluarkan sesuatu, kami membuat buffer yang akan memainkan peran aliran keluaran standar.  Setelah fungsi dieksekusi, diperiksa bahwa hasilnya sesuai dengan harapan kami - dengan bantuan ekspresi reguler atau perbandingan sederhana. </p><br><p>  Mengapa saya menggunakan ekspresi reguler?  Agar tes dapat bekerja dengan token apa pun yang valid yang akan saya berikan ke program, terlepas dari nama pengguna dan ID pengguna. </p><br><h2 id="pattern-vnedrenie-zavisimosti---2">  Pola Injeksi Ketergantungan - 2 </h2><br><p>  Saat ini, program ini memiliki cakupan 86,4%.  Kenapa tidak 100%?  Kami tidak dapat memprovokasi kesalahan dari <code>http.PostForm()</code> , <code>ioutil.ReadAll()</code> dan <code>json.Unmarshal()</code> , yang berarti bahwa kami tidak dapat memeriksa setiap " <code>return UserInfo, err</code> ". </p><br><p>  Untuk memberi Anda kontrol lebih besar terhadap situasi ini, Anda harus membuat antarmuka di mana <code>http.Client</code> akan cocok, implementasinya akan di vkClient, dan digunakan untuk operasi jaringan.  Bagi kami, dalam antarmuka, hanya satu metode yang <code>PostForm</code> - <code>PostForm</code> . </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Networker <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { PostForm(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, url.Values) (*http.Response, error) } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> vkClient <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Token <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OutputWriter io.Writer Networker Networker } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVKClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vkClient</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vkClient{ token, os.Stdout, &amp;http.Client{}, } }</code> </pre> <br><p>  Langkah seperti itu menghilangkan kebutuhan untuk melakukan operasi jaringan secara umum.  Sekarang kita cukup mengembalikan data yang diharapkan dari VKontakte menggunakan <code>Networker</code> palsu.  Tentu saja, jangan singkirkan tes yang akan memeriksa permintaan ke server, tetapi tidak perlu membuat permintaan di setiap tes. </p><br><p>  Kami akan membuat implementasi untuk <code>Networker</code> dan <code>Reader</code> palsu, sehingga kami dapat menguji kesalahan dalam setiap kasus - berdasarkan permintaan, saat membaca isi dan selama deserialisasi.  Jika kita menginginkan kesalahan saat memanggil PostForm, maka kita cukup mengembalikannya dalam metode ini.  Jika kita menginginkan kesalahan <br>  saat membaca badan tanggapan - perlu mengembalikan <code>Reader</code> palsu, yang akan menimbulkan kesalahan.  Dan jika kita membutuhkan kesalahan untuk memanifestasikan dirinya selama deserialisasi, maka kita mengembalikan jawabannya dengan string kosong di tubuh.  Jika kami tidak ingin kesalahan, kami hanya mengembalikan isi dengan isi yang ditentukan. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> fakeReader <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fakeReader)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, err error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"Error on read"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> fakeNetworker <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ErrorOnPostForm <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ErrorOnBodyRead <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ErrorOnUnmarchal <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> RawBody <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fn *fakeNetworker)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostForm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, url.Values)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*http.Response, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fn.ErrorOnPostForm { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"Error on PostForm"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fn.ErrorOnBodyRead { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;http.Response{Body: ioutil.NopCloser(fakeReader{})}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fn.ErrorOnUnmarchal { fakeBody := ioutil.NopCloser(bytes.NewBufferString(<span class="hljs-string"><span class="hljs-string">""</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;http.Response{Body: fakeBody}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } fakeBody := ioutil.NopCloser(bytes.NewBufferString(fn.RawBody)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;http.Response{Body: fakeBody}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  Untuk setiap situasi masalah, kami menambahkan tes.  Mereka akan membuat <code>Networker</code> palsu dengan pengaturan yang diperlukan, yang menurutnya ia akan melakukan kesalahan pada titik tertentu.  Setelah itu, kami memanggil fungsi untuk diperiksa dan memastikan bahwa terjadi kesalahan, dan kami mengharapkan kesalahan ini. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_GetUserInfo_ErrorOnPostForm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := CreateVKClient(workingToken) client.Networker = &amp;fakeNetworker{ErrorOnPostForm: <span class="hljs-literal"><span class="hljs-literal">true</span></span>} _, err := client.GetUserInfo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"Expected error but none found"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err.Error() != <span class="hljs-string"><span class="hljs-string">"Error on PostForm"</span></span> { t.Fatalf(<span class="hljs-string"><span class="hljs-string">`Expected "Error on PostForm" but got "%s"`</span></span>, err.Error()) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_GetUserInfo_ErrorOnBodyRead</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := CreateVKClient(workingToken) client.Networker = &amp;fakeNetworker{ErrorOnBodyRead: <span class="hljs-literal"><span class="hljs-literal">true</span></span>} _, err := client.GetUserInfo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"Expected error but none found"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err.Error() != <span class="hljs-string"><span class="hljs-string">"Error on read"</span></span> { t.Fatalf(<span class="hljs-string"><span class="hljs-string">`Expected "Error on read" but got "%s"`</span></span>, err.Error()) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_GetUserInfo_ErrorOnUnmarchal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { client := CreateVKClient(workingToken) client.Networker = &amp;fakeNetworker{ErrorOnUnmarchal: <span class="hljs-literal"><span class="hljs-literal">true</span></span>} _, err := client.GetUserInfo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { t.Fatal(<span class="hljs-string"><span class="hljs-string">"Expected error but none found"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> expectedError = <span class="hljs-string"><span class="hljs-string">"unexpected end of JSON input"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err.Error() != expectedError { t.Fatalf(<span class="hljs-string"><span class="hljs-string">`Expected "%s" but got "%s"`</span></span>, expectedError, err.Error()) } }</code> </pre> <br><p>  Menggunakan bidang <code>RawBody</code> , <code>RawBody</code> dapat menyingkirkan permintaan jaringan (cukup kembalikan yang kami harapkan akan diterima dari VKontakte).  Ini mungkin perlu untuk menghindari melampaui batas permintaan selama pengujian atau untuk mempercepat pengujian. </p><br><h2 id="itogi">  Ringkasan </h2><br><p>  Setelah semua operasi pada proyek, kami menerima paket dengan panjang 91 baris (+170 garis tes), yang mendukung output ke <code>io.Writer</code> , memungkinkan Anda untuk menggunakan metode alternatif bekerja dengan jaringan (menggunakan adaptor ke antarmuka kami), di mana ada metode seperti untuk menghasilkan data, dan untuk mendapatkannya.  Proyek ini memiliki cakupan 100%.  Tes sepenuhnya memeriksa setiap baris dan respons aplikasi untuk setiap kemungkinan kesalahan. </p><br><p>  Setiap langkah di jalan menuju cakupan 100% meningkatkan modularitas, rawatan dan keandalan aplikasi, sehingga tidak ada yang salah dengan fakta bahwa tes menentukan struktur paket. </p><br><p>  Testabilitas kode apa pun adalah kualitas yang tidak muncul dari udara.  Testabilitas muncul ketika pengembang cukup menggunakan pola dalam situasi yang sesuai dan menulis kode kustom dan modular.  Tugas utama adalah menunjukkan proses berpikir saat melakukan program refactoring.  Pemikiran serupa dapat diperluas ke aplikasi dan perpustakaan apa saja, serta bahasa lain. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id452702/">https://habr.com/ru/post/id452702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id452690/index.html">Apa yang begitu menarik tentang Kereta Api Trans-Siberia?</a></li>
<li><a href="../id452692/index.html">Penulis proyek rePalm menulis ulang Palm OS dari awal dan berencana mengubahnya menjadi platform jam tangan pintar</a></li>
<li><a href="../id452696/index.html">Cara memulai pembayaran mikro di aplikasi Anda</a></li>
<li><a href="../id452698/index.html">Dua dalam satu: data turis dan tiket untuk acara budaya tersedia untuk umum</a></li>
<li><a href="../id452700/index.html">Berita dari dunia OpenStreetMap No. 460 (05/07/2019 - 05/05/2019)</a></li>
<li><a href="../id452704/index.html">Debugging post-mortem pada Cortex-M</a></li>
<li><a href="../id452706/index.html">Pada tahun 1983, komputer ini dari Bella Labs menjadi grandmaster pertama.</a></li>
<li><a href="../id452712/index.html">Bagaimana kami mencoba bekerja dalam tim, dan apa yang terjadi</a></li>
<li><a href="../id452714/index.html">Bayar Perhatian # 5: Intisari Artikel tentang Pemikiran Produk, Psikologi Perilaku dan Produktivitas</a></li>
<li><a href="../id452716/index.html">Mencari titik optimal penerapan sumber daya manusia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>