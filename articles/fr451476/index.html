<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóúÔ∏è üïß üß£ LLVM en termes de Go üîÑ ü¶ï ü§Ωüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le d√©veloppement du compilateur est une t√¢che tr√®s difficile. Mais, heureusement, avec le d√©veloppement de projets comme LLVM, la solution √† ce probl√®...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>LLVM en termes de Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/451476/">  Le d√©veloppement du compilateur est une t√¢che tr√®s difficile.  Mais, heureusement, avec le d√©veloppement de projets comme LLVM, la solution √† ce probl√®me est grandement simplifi√©e, ce qui permet m√™me √† un seul programmeur de cr√©er un nouveau langage proche des performances en C. Travailler avec LLVM est compliqu√© par le fait que ce syst√®me est repr√©sent√© par une √©norme quantit√© de code, √©quip√© d'une petite documentation.  Afin d'essayer de corriger cette faille, l'auteur du mat√©riel que nous publions aujourd'hui va montrer des exemples de code √©crit en Go et montrer comment ils sont transmis d'abord √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Go SSA</a> puis √† LLVM IR en utilisant le compilateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TinyGO</a> .  Le code Go SSA et LLVM IR a √©t√© l√©g√®rement modifi√©, quelque chose qui n'appartient pas aux explications donn√©es ici a √©t√© supprim√© afin de rendre ces explications plus compr√©hensibles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f4a/50e/d6d/f4a50ed6d13e445eaf3d9c55293e7999.jpg" alt="image"></div><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Premier exemple</font> </h2><br>  La premi√®re fonction que je vais analyser ici est un m√©canisme simple pour ajouter des nombres: <br><br><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b }</code> </pre> <br>  Cette fonction est tr√®s simple, et, peut-√™tre, rien n'est plus facile √† ne pas proposer.  Il se traduit par le code Go SSA suivant: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">                                                    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span></span></code> </pre> <br>  Avec cette repr√©sentation de la fonction, des conseils sur les types de donn√©es sont plac√©s √† droite, dans la plupart des cas, vous pouvez les ignorer. <br><br>  Ce petit exemple vous permet d√©j√† de voir l'essentiel d'un aspect de SSA.  √Ä savoir, lors de la conversion de code sous forme SSA, chaque expression est divis√©e en parties les plus √©l√©mentaires dont elle se compose.  Dans notre cas, la commande <code>return a + b</code> , en fait, repr√©sente deux op√©rations: ajouter deux nombres et retourner le r√©sultat. <br><br>  De plus, ici vous pouvez voir les blocs de base du programme, dans ce code, il n'y a qu'un seul bloc - l'entr√©e (bloc d'entr√©e).  Nous parlerons plus en d√©tail des blocs ci-dessous. <br><br>  Le code Go SSA peut √™tre facilement converti en LLVM IR: <br><br><pre> <code class="go hljs">define i64 @myAdd(i64 %a, i64 %b) { entry: %<span class="hljs-number"><span class="hljs-number">0</span></span> = add i64 %a, %b ret i64 %<span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br>  Vous pouvez remarquer que bien que d'autres constructions syntaxiques soient utilis√©es ici, la structure de la fonction n'a fondamentalement pas chang√©.  Le code IR LLVM est l√©g√®rement plus fort que le code Go SSA, similaire √† C. Ici, dans la d√©claration de fonction, vient d'abord une description du type de donn√©es qui lui est retourn√©, le type de l'argument est indiqu√© avant le nom de l'argument.  De plus, pour simplifier l'analyse infrarouge, les noms des entit√©s globales sont pr√©c√©d√©s du symbole <code>@</code> , et avant les noms des entit√©s locales par le caract√®re <code>%</code> (la fonction est √©galement consid√©r√©e comme une entit√© globale). <br><br>  L'une des caract√©ristiques de ce code √† laquelle vous devez faire attention est que la d√©cision de repr√©senter le type Go <code>int</code> , qui peut √™tre repr√©sent√© par une valeur 32 bits ou 64 bits, selon le compilateur et le but de la compilation, est prise lors de la cr√©ation de LLVM Code IR.  C'est l'une des nombreuses raisons pour lesquelles le code IR LLVM n'est pas ind√©pendant de la plate-forme.  Un tel code cr√©√© pour une plate-forme ne peut pas √™tre simplement pris et compil√© pour une autre plate-forme (sauf si vous abordez cette t√¢che <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avec une extr√™me prudence</a> ). <br><br>  Un autre point int√©ressant √† noter est que le type <code>i64</code> n'est pas un entier sign√©: il est neutre en termes de repr√©sentation du signe du nombre.  Selon l'instruction, il peut repr√©senter √† la fois des num√©ros sign√©s et des num√©ros non sign√©s.  Dans le cas de la repr√©sentation de l'op√©ration d'addition, cela ne joue aucun r√¥le, il n'y a donc pas de diff√©rence dans le travail avec des nombres avec ou sans signe.  Ici, je voudrais noter qu'en C, le d√©bordement d'une variable enti√®re sign√©e conduit √† un comportement ind√©fini, par cons√©quent, le frontend Clang ajoute le drapeau <code>nsw</code> (pas de retour √† la ligne sign√©) √† l'op√©ration, ce qui indique √† LLVM qu'il peut partir de l'hypoth√®se qu'avec il n'y a jamais de d√©bordement. <br><br>  Cela peut √™tre important pour certaines optimisations.  Par exemple, l'ajout de deux valeurs <code>i16</code> sur une plate-forme 32 bits (avec registres 32 bits) n√©cessite, une fois l'ajout termin√©, que l'op√©ration d'extension de signe reste dans la plage <code>i16</code> .  Pour cette raison, il est souvent plus efficace d'effectuer des op√©rations enti√®res en tenant compte de la taille de la machine du registre. <br><br>  Ce qui se passe √† l'avenir avec ce code IR n'est pas particuli√®rement int√©ressant pour nous maintenant.  Le code est optimis√© (mais dans le cas d'un exemple aussi simple que le n√¥tre, rien n'est d√©j√† optimis√©), puis il est converti en code machine. <br><br><h2>  <font color="#3AC1EF">Deuxi√®me exemple</font> </h2><br>  L'exemple suivant, que nous allons examiner, sera un peu plus compliqu√©.  √Ä savoir, nous parlons d'une fonction qui r√©sume la tranche d'entiers: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> {   n := <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(numbers); i++ {       n += numbers[i]   }   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n }</code> </pre> <br>  Ce code est converti en le code Go SSA suivant: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">: 0:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t6</span></span></span><span class="hljs-function">] #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">n</span></span></span><span class="hljs-function">                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">: 0:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t7</span></span></span><span class="hljs-function">] #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t2</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers)</span></span></span><span class="hljs-function">                                              </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t3</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> &lt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t2</span></span></span><span class="hljs-function">                                                  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t3</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t4</span></span></span><span class="hljs-function"> = &amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numbers</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function">]                                             *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t5</span></span></span><span class="hljs-function"> = *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t4</span></span></span><span class="hljs-function">                                                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t6</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t5</span></span></span><span class="hljs-function">                                                   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t7</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> + 1:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">                                                </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span></span></code> </pre> <br>  Ici, vous pouvez d√©j√† voir plus de constructions sp√©cifiques √† la pr√©sentation de code sous forme de SSA.  La caract√©ristique la plus √©vidente de ce code est probablement le fait qu'il n'y a pas de commandes de contr√¥le de flux structur√©es.  Pour contr√¥ler le flux des calculs, il n'y a que des sauts conditionnels et inconditionnels, et si nous consid√©rons cette commande comme une commande pour contr√¥ler le flux, une commande de retour. <br><br>  En fait, ici, vous pouvez faire attention au fait que le programme n'est pas divis√© en blocs utilisant des accolades (comme dans les langages de la famille C).  Il est divis√© par des √©tiquettes, qui ressemble aux langages d'assemblage, et est pr√©sent√© sous la forme de blocs de base.  Dans SSA, les blocs de base sont des s√©quences contigu√´s de code commen√ßant par une √©tiquette et se terminant par des instructions pour terminer le bloc de base, par exemple, <code>return</code> et <code>jump</code> . <br><br>  Un autre d√©tail int√©ressant de ce code est l'instruction <code>phi</code> .  L'instruction est assez inhabituelle, cela peut prendre un certain temps pour la comprendre.  N'oubliez pas que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SSA</a> est l'abr√©viation de Static Single Assignment.  Il s'agit d'une repr√©sentation interm√©diaire du code utilis√© par les compilateurs, dans laquelle chaque variable n'est affect√©e qu'une seule fois.  Ceci est id√©al pour exprimer des fonctions simples comme notre fonction <code>myAdd</code> illustr√©e ci-dessus, mais pas pour des fonctions plus complexes comme la fonction <code>sum</code> discut√©e dans cette section.  En particulier, lors de l'ex√©cution de la boucle, les variables <code>i</code> et <code>n</code> changent. <br><br>  SSA contourne la restriction sur une seule affectation de valeurs variables en utilisant la soi-disant instruction <code>phi</code> (son nom est tir√© de l'alphabet grec).  Le fait est que pour que la repr√©sentation SSA du code puisse √™tre form√©e pour des langages comme C, vous devez recourir √† quelques astuces.  Le r√©sultat de l'appel de cette instruction est la valeur actuelle de la variable ( <code>i</code> ou <code>n</code> ), et une liste de blocs de base est utilis√©e comme param√®tre.  Par exemple, consid√©rez cette instruction: <br><br><pre> <code class="go hljs">t0 = phi [entry: <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body: t6] #n</code> </pre> <br>  Sa signification est la suivante: si le bloc de base pr√©c√©dent √©tait un bloc d' <code>entry</code> (entr√©e), alors <code>t0</code> est constant <code>0</code> , et si le bloc de base pr√©c√©dent √©tait <code>for.body</code> , alors vous devez prendre la valeur <code>t6</code> de ce bloc.  Tout cela peut sembler assez myst√©rieux, mais gr√¢ce √† ce m√©canisme, la SSA est assur√©e.  D'un point de vue humain, tout cela complique la compr√©hension du code, mais le fait que chaque valeur ne soit attribu√©e qu'une seule fois simplifie grandement de nombreuses optimisations. <br><br>  Notez que si vous √©crivez votre propre compilateur, vous n'avez g√©n√©ralement pas √† faire face √† de telles choses.  M√™me Clang ne g√©n√®re pas toutes ces instructions <code>phi</code> , il utilise le m√©canisme <code>alloca</code> (il ressemble √† travailler avec des variables locales ordinaires).  Ensuite, lors de l'ex√©cution d'une passe d'optimisation LLVM, appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mem2reg</a> , les instructions <code>alloca</code> sont converties au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">format</a> SSA.  TinyGo, cependant, re√ßoit des donn√©es de Go SSA, qui, commod√©ment, a d√©j√† √©t√© converti sous forme SSA. <br><br>  Une autre innovation de ce morceau de code interm√©diaire est que l'acc√®s aux √©l√©ments de tranche par index se pr√©sente sous la forme de l'op√©ration de calcul de l'adresse et de l'op√©ration de d√©r√©f√©rencement du pointeur obtenu.  Ici, vous pouvez voir l'ajout direct de constantes au code IR (par exemple - <code>1:int</code> ).  Dans l'exemple avec la fonction <code>myAdd</code> cela n'a pas √©t√© utilis√©.  Maintenant que nous avons compris ces fonctionnalit√©s, nous allons voir ce que ce code transformera en le convertissant en forme IR LLVM: <br><br><pre> <code class="go hljs">define i64 @sum(i64* %ptr, i64 %<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>, i64 %<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>) { entry: br label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body, %entry %<span class="hljs-number"><span class="hljs-number">0</span></span> = phi i64 [ <span class="hljs-number"><span class="hljs-number">0</span></span>, %entry ], [ %<span class="hljs-number"><span class="hljs-number">5</span></span>, %deref.next ] %<span class="hljs-number"><span class="hljs-number">1</span></span> = phi i64 [ <span class="hljs-number"><span class="hljs-number">0</span></span>, %entry ], [ %<span class="hljs-number"><span class="hljs-number">6</span></span>, %deref.next ] %<span class="hljs-number"><span class="hljs-number">2</span></span> = icmp slt i64 %<span class="hljs-number"><span class="hljs-number">1</span></span>, %<span class="hljs-built_in"><span class="hljs-built_in">len</span></span> br i1 %<span class="hljs-number"><span class="hljs-number">2</span></span>, label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body, label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.done <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop %<span class="hljs-number"><span class="hljs-number">3</span></span> = getelementptr i64, i64* %ptr, i64 %<span class="hljs-number"><span class="hljs-number">1</span></span> %<span class="hljs-number"><span class="hljs-number">4</span></span> = load i64, i64* %<span class="hljs-number"><span class="hljs-number">3</span></span> %<span class="hljs-number"><span class="hljs-number">5</span></span> = add i64 %<span class="hljs-number"><span class="hljs-number">0</span></span>, %<span class="hljs-number"><span class="hljs-number">4</span></span> %<span class="hljs-number"><span class="hljs-number">6</span></span> = add i64 %<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> br label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.done:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop ret i64 %<span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br>  Ici, comme pr√©c√©demment, nous pouvons voir la m√™me structure, qui comprend d'autres constructions syntaxiques.  Par exemple, dans les appels <code>phi</code> , les valeurs et les √©tiquettes sont √©chang√©es.  Cependant, il y a aussi quelque chose qui m√©rite une attention particuli√®re. <br><br>  Pour commencer, vous pouvez voir ici une signature compl√®tement diff√©rente de la fonction.  LLVM ne prend pas en charge les tranches, par cons√©quent, sous forme d'optimisation, le compilateur TinyGo, qui a g√©n√©r√© ce code interm√©diaire, a divis√© la description de cette structure de donn√©es en parties.  Il pourrait repr√©senter trois √©l√©ments de tranche ( <code>ptr</code> , <code>len</code> et <code>cap</code> ) en tant que structure (struct), mais les pr√©senter comme trois entit√©s distinctes permet certaines optimisations.  D'autres compilateurs peuvent pr√©senter la tranche d'une autre mani√®re, cela d√©pend des conventions d'appel des fonctions de la plate-forme cible. <br><br>  Une autre caract√©ristique int√©ressante de ce code est l'utilisation de l' <code>getelementptr</code> (souvent appel√©e GEP pour faire court). <br><br>  Cette instruction fonctionne avec des pointeurs et est utilis√©e pour obtenir un pointeur sur un √©l√©ment de tranche.  Par exemple, comparons-le avec le code suivant √©crit en C: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* sliceptr(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *ptr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;ptr[index]; }</code> </pre> <br>  Ou avec l'√©quivalent suivant: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* sliceptr(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *ptr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr + index; }</code> </pre> <br>  La chose la plus importante ici est que l'instruction <code>getelementptr</code> pas d'op√©rations de d√©r√©f√©rencement.  Il calcule uniquement un nouveau pointeur sur la base de celui existant.  Il peut √™tre interpr√©t√© comme <code>mul</code> et <code>add</code> au niveau mat√©riel.  Les d√©tails sur les instructions GEP peuvent √™tre trouv√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Une autre caract√©ristique int√©ressante de ce code interm√©diaire est l'utilisation de l'instruction <code>icmp</code> .  Il s'agit d'une instruction g√©n√©rale utilis√©e pour impl√©menter des comparaisons enti√®res.  Le r√©sultat de cette instruction est toujours une valeur de type <code>i1</code> - une valeur logique.  Dans ce cas, une comparaison est effectu√©e √† l'aide du mot cl√© <code>slt</code> (sign√© moins que), car nous comparons deux nombres pr√©c√©demment repr√©sent√©s par le type <code>int</code> .  Si nous comparions deux entiers non sign√©s, nous utiliserions <code>icmp</code> comme instruction et le mot-cl√© utilis√© dans la comparaison serait <code>ult</code> .  Pour comparer les nombres √† virgule flottante, une autre instruction est utilis√©e, <code>fcmp</code> , qui fonctionne de mani√®re similaire. <br><br><h2>  <font color="#3AC1EF">R√©sum√©</font> </h2><br>  Je crois que dans cet article, j'ai examin√© les caract√©ristiques les plus importantes de LLVM IR.  Bien s√ªr, il y a encore beaucoup de choses.  En particulier, dans la repr√©sentation interm√©diaire du code, il peut y avoir de nombreuses annotations qui permettent de prendre en compte certaines fonctionnalit√©s du code connues du compilateur lors des passes d'optimisation qui ne peuvent pas √™tre exprim√©es d'une autre mani√®re en IR.  Par exemple, ce sont l'indicateur <code>inbounds</code> de l'instruction <code>inbounds</code> , ou les <code>nuw</code> <code>nsw</code> et <code>nuw</code> , qui peuvent √™tre ajout√©s √† l'instruction <code>add</code> .  Il en va de m√™me pour le mot-cl√© <code>private</code> , qui indique √† l'optimiseur que la fonction marqu√©e par lui ne sera pas r√©f√©renc√©e de l'ext√©rieur de l'unit√© de compilation actuelle.  Cela vous permet d'effectuer de nombreuses optimisations interproc√©durales int√©ressantes, telles que l'√©limination des arguments inutilis√©s. <br><br>  Vous pouvez en savoir plus sur LLVM dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> , √† laquelle vous vous r√©f√©rerez souvent lors du d√©veloppement de votre propre compilateur bas√© sur LLVM.  Voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guide</a> qui discute du d√©veloppement du compilateur pour un langage tr√®s simple.  Ces deux sources d'informations vous seront utiles lors de la cr√©ation de votre propre compilateur. <br><br>  <b>Chers lecteurs!</b>  Utilisez-vous LLVM? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451476/">https://habr.com/ru/post/fr451476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451460/index.html">Julia dans le labyrinthe</a></li>
<li><a href="../fr451462/index.html">√âcrivez moins de code en double √† l'aide de classeurs dans Laravel</a></li>
<li><a href="../fr451464/index.html">Frontend Weekly Digest (6 - 12 mai 2019)</a></li>
<li><a href="../fr451466/index.html">graphql - pi√®ges</a></li>
<li><a href="../fr451468/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 364 (6-12 mai 2019)</a></li>
<li><a href="../fr451478/index.html">Acc√©l√©rer l'exploration des donn√©es √† l'aide de la biblioth√®que de profilage pandas</a></li>
<li><a href="../fr451480/index.html">Pourquoi le minist√®re de l'Industrie et du Commerce interdit-il le stockage de donn√©es sur des √©quipements √©trangers</a></li>
<li><a href="../fr451482/index.html">Comp√©tences d'un programmeur moderne sous un angle diff√©rent</a></li>
<li><a href="../fr451488/index.html">Calcul de cannibalisation bas√© sur le test A / B classique et la m√©thode bootstrap</a></li>
<li><a href="../fr451492/index.html">Sept variables Bash inattendues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>