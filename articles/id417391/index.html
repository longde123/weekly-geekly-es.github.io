<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘‚ğŸ¿ ğŸ˜” ğŸ¼ Ekstensi web lintas browser untuk skrip khusus Bagian 4 ğŸ”† ğŸ™†ğŸ¿ ğŸ™†ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini, saya menyelesaikan serangkaian publikasi di mana saya ingin berbicara tentang pengalaman saya menulis ekstensi web untuk browser. Sa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ekstensi web lintas browser untuk skrip khusus Bagian 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417391/"> Pada artikel ini, saya menyelesaikan serangkaian publikasi di mana saya ingin berbicara tentang pengalaman saya menulis ekstensi web untuk browser.  Saya sudah memiliki pengalaman membuat ekstensi web, yang dipasang oleh sekitar 100.000 pengguna Chrome, yang bekerja secara otonom, tetapi dalam seri artikel ini saya memutuskan untuk mempelajari proses pengembangan ekstensi web dengan mengintegrasikannya secara erat dengan sisi server. <br><br><img width="65" src="https://habrastorage.org/getpro/habr/post_images/188/09a/2d6/18809a2d60126c22c85f0dbb38c188dc.png" alt="gambar"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/474/b37/7c9/474b377c9fd5df452ee6b2ae849c2891.png" alt="gambar"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/804/cc0/c91/804cc0c91bd30f83537540bd6aca22df.png" alt="gambar"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/94e/097/462/94e097462cb7f3af3b482312f6fd2ee9.png" alt="gambar"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/4bf/d73/6f6/4bfd736f6830e4396071afedad261bfd.png" alt="gambar"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 3</a> <br><br><h1>  Tugas Terjadwal </h1><br>  Ekstensi web memungkinkan Anda mengonfigurasi skrip khusus untuk secara otomatis menjalankan kode setelah halaman selesai memuat.  Ini nyaman, misalnya, ketika Anda memiliki daftar halaman dengan tipe yang sama untuk merangkak dan menerima data dari eksekusi skrip.  Atau jika Anda perlu menghapus iklan yang mengganggu di halaman mana pun di Internet, kode untuk melacak tindakan Anda di sumber daya web, ubah latar belakang halaman menjadi gelap, dll. <br><br>  Dalam hal ini, seringkali perlu untuk menerima data dari halaman dalam mode jadwal harian.  Misalnya, jika situs memiliki nilai tukar mata uang dan permintaan langsung oleh URL melindungi argumen hash.  Sebagai salinan seperti itu, Anda dapat mempertimbangkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">situs web Bank Sentral Eropa</a> .  Dalam hal ini, untuk mendapatkan nilai tukar saat ini, Anda harus mengetahui URL hash untuk mendapatkan data yang benar dalam format XML. <br><br>  Menggunakan ekstensi web, Anda dapat mengatur frekuensi yang diperlukan untuk menerima data melalui skrip untuk meminta nilai tukar.  Ekstensi web menerima string dalam format mahkota sebagai input, oleh karena itu, untuk mendapatkan nilai tukar dalam mode harian, Anda harus menentukan * * / 1 * * *. <br><br>  Dari sudut pandang teknis, bagian server memulai Puppeteer dengan penambahan skrip pengguna ke halaman browser Chromium.  Dalam kasus ini, kita dihadapkan dengan masalah shutdown yang disengaja dari proses Chromium dari waktu ke waktu, karena peningkatan jumlah proses akan mempengaruhi kinerja keseluruhan sisi server.  Jika Anda berencana untuk menjalankan skrip pengguna dalam mode berkala untuk menyelesaikan masalah di atas, Anda harus mengirim permintaan dari skrip pengguna ke Puppeteer untuk menyelesaikan proses Chromium. <br><br>  Setelah tes panjang dari proses implementasi penjadwal tugas, diputuskan untuk melacak output dari konsol skrip.  Jadi, untuk menghentikan proses Chromium, skrip pengguna harus memiliki perintah untuk menghentikan proses di bagian kode yang diperlukan: <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'script is ended'</span></span>);</code> </pre> <br>  Dengan menggunakan perintah ini, skrip pengguna dapat menutup proses server Chromium yang dihasilkan oleh Puppeteer.  Ini diterapkan dengan melacak peristiwa "konsol" Puppeteer: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//initialize browser and page page.on('console', async msg =&gt; { for (let i = 0; i &lt; msg.args().length; ++i) { if(await msg.args()[i].jsonValue() == 'script is ended') { await browser.close(); } } });</span></span></code> </pre><br>  Jika skrip pengguna tidak memiliki perintah seperti itu, untuk menyelesaikan proses eksekusi dalam mode penjadwal tugas, Anda harus menghentikan penghitung waktu secara paksa.  Ini diimplementasikan dengan cara sederhana menggunakan setTimeout: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeLimitCron = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(browser) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close(); } clearTimeout(timeout); }, timeLimitCron * <span class="hljs-number"><span class="hljs-number">1000</span></span> ); <span class="hljs-comment"><span class="hljs-comment">//time limit for cron, then forced closing, default 30 seconds</span></span></code> </pre><br>  Karena penjadwal tugas berjalan di sisi server, dan pengguna sering perlu menggunakan alamat IP tertentu, opsi untuk menggunakan server proxy telah ditambahkan. <br><br><img src="https://habrastorage.org/webt/s2/sb/ko/s2sbko8uyscf31aksmaulyn7hus.png"><br><br>  Pengguna juga dapat mengunduh log pesan terbaru dari konsol Puppeteer.  Misalnya, akan lebih mudah untuk memeriksa operasi yang benar dari server proxy. <br><br><h1>  Pintasan keyboard </h1><br>  Selama pengujian dan pengujian lapangan, ternyata untuk beberapa jenis skrip, penting untuk memiliki hot key untuk dieksekusi pada sumber daya web.  Contoh skrip tersebut adalah Redability.js.  Skrip ini menciptakan "tampilan bersih" untuk membaca konten situs.  Yaitu, perpustakaan js menganalisis struktur halaman dengan konten dan memungkinkan Anda untuk mendapatkan dengan kemungkinan besar judul, penulis, dan konten halaman.  Setelah itu, skrip pengguna dapat menimpa html sumber daya web dan memungkinkan pengguna untuk membaca dalam "bentuk murni", tanpa markup yang tidak perlu, iklan, dll. <br><br>  Awalnya, menjalankan skrip pengguna hanya dimungkinkan dari ekstensi web pop-up dengan mengklik tombol "Jalankan".  Logika interaksi dengan antarmuka ini sering dibenarkan dengan pertimbangan keamanan.  Tetapi dalam contoh di atas, itu tidak memungkinkan Anda untuk dengan mudah membawa konten sumber daya web ke "bentuk murni." <br><br>  Seperti dijelaskan di atas, ekstensi web memungkinkan Anda untuk bekerja dengan DOM melalui content.js, tetapi objek jendela tidak dapat digunakan, misalnya, untuk menyimpan parameter, karena itu bukan objek jendela dari tab terbuka.  Kondisi ini membatasi pengoperasian ekstensi web sebagai objek untuk melacak penekanan tombol. <br><br>  Dalam masalah yang harus dipecahkan, perlu untuk mentransfer "hot keys" dari antarmuka ekstensi web ke sisi server untuk penyimpanan.  Selanjutnya, setiap kali Anda memuat halaman sumber daya web, dapatkan daftar "kunci cepat" dan muat skrip pengguna setelah mengklik kombinasi yang benar.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hotkeys.js</a> digunakan sebagai perpustakaan untuk bekerja dengan tombol pintas. <br><br>  Setelah menerima daftar tombol pintas dari sisi server, kode berikut dijalankan: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hotKeysMap = {<span class="hljs-attr"><span class="hljs-attr">keys</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">id</span></span>: []}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data.response.data) { hotKeysMap.keys.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">'hotkeys'</span></span>]); hotKeysMap.id.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">"_id"</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hotKeysMap.keys) { getScript(<span class="hljs-string"><span class="hljs-string">"hotkeys.js"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> script = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"script"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"gCore-hotKeys"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-endpoint"</span></span>, event.data.endPoint); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-token"</span></span>, event.data.token); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-userid"</span></span>, event.data.userId); script.innerHTML = <span class="hljs-string"><span class="hljs-string">"GChotKeys = JSON.parse(\""</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(hotKeysMap).replace(<span class="hljs-regexp"><span class="hljs-regexp">/"/g</span></span>, <span class="hljs-string"><span class="hljs-string">"\\\""</span></span>) + <span class="hljs-string"><span class="hljs-string">"\");\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"hotkeys(GChotKeys.keys.join(','), function(event, handler) {"</span></span> + <span class="hljs-string"><span class="hljs-string">" event.preventDefault();"</span></span> + <span class="hljs-string"><span class="hljs-string">" localStorage.setItem('runHotKeysScript', GChotKeys.id[GChotKeys.keys.indexOf(handler.key)]);"</span></span> + <span class="hljs-string"><span class="hljs-string">"});"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.appendChild(script); }); }</code> </pre> <br>  Fungsi getScript menghasilkan kode html untuk tag skrip dan menulisnya ke halaman sumber daya web.  Jadi, pada setiap halaman kami memiliki kemampuan untuk melacak penekanan tombol.  Kita juga harus melewatkan array hotkey yang cocok dengan id skrip yang akan dieksekusi.  Ini diimplementasikan dengan menambahkan kode html untuk tag skrip, yang isinya memulai variabel global untuk menyimpan array yang cocok dalam format JSON. <br><br>  Telah disebutkan di atas bahwa ada masalah komunikasi antara halaman terbuka sumber daya web dan skrip ekstensi ekstensi konten. Js dari ekstensi web, yang digunakan untuk memanipulasi DOM.  Dalam hal ini, Anda dapat menggunakan teknik sederhana untuk memeriksa nilai di localStorage, yang merupakan objek umum untuk dua titik interaksi yang disebutkan di atas. <br><br>  Di content.js, Anda cukup memeriksa nilai localStorage sekali per detik dan melakukan manipulasi DOM yang sama seperti ketika mengklik tombol "Jalankan" di ekstensi web pop-up. <br><br><pre> <code class="javascript hljs">setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'runHotKeysScript'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// run user script localStorage.removeItem('runHotKeysScript'); } }, 1000);</span></span></code> </pre><br>  Dengan demikian, teknik "kunci cepat" diimplementasikan, yang memungkinkan Anda untuk dengan cepat meluncurkan skrip pengguna menggunakan kekuatan pustaka internal untuk memecahkan masalah praktis. <br><br><h1>  Kesimpulan </h1><br>  Selama implementasi proyek ini, tugas-tugas praktis menulis integrasi antara bagian server berdasarkan meteor.js dan ekstensi web lintas-browser diselesaikan.  Blok sandungan utama adalah SCP dan proses interaksi antara tiga komponen bagian klien - halaman terbuka di browser, script content.js dan background.js. <br><br>  Saya berharap pengalaman saya akan membuatnya lebih mudah untuk menulis ekstensi web lintas-browser yang lebih khusus. <br><br>  Di masa depan, direncanakan untuk melokalisasi ekstensi web dan menulis skrip yang bermanfaat bagi komunitas.  Jika pembaca memiliki ide atau keinginan untuk membantu menulis skrip pengguna tersebut, silakan tulis dalam pesan pribadi. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id417391/">https://habr.com/ru/post/id417391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id417377/index.html">Mengapa Anda tidak harus menggunakan Google Cloud</a></li>
<li><a href="../id417379/index.html">Motor roket propelan solid baru untuk Vega-C dan Ariane 6</a></li>
<li><a href="../id417383/index.html">JavaScript ES6: Kelemahan</a></li>
<li><a href="../id417385/index.html">Bagaimana saya pindah ... rumah, atau jawaban saya kepada penulis artikel tentang "tepung tanpa ampun"</a></li>
<li><a href="../id417389/index.html">Efek Lensa Tilt Shift</a></li>
<li><a href="../id417393/index.html">Bagaimana kami membuat sistem yang memberikan diskon kepada pelanggan berdasarkan karakteristik individu</a></li>
<li><a href="../id417395/index.html">Pengujian end-to-end: apa, mengapa, mengapa</a></li>
<li><a href="../id417397/index.html">Bahasa pemrograman apa yang harus dipelajari pada tahun 2018 dan mengapa?</a></li>
<li><a href="../id417399/index.html">Selamat datang: memperkenalkan pengembang baru ke tim</a></li>
<li><a href="../id417401/index.html">Akhirnya, kami memilih multimeter anggaran dengan fungsionalitas yang baik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>