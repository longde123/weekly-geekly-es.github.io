<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöê ü¶ó ü§° Astuces de traitement m√©trique dans Kapacitor ü§µüèª üàöÔ∏è üÜö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tr√®s probablement, personne ne se demande aujourd'hui pourquoi il doit collecter des mesures de service. L'√©tape logique suivante consiste √† configure...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Astuces de traitement m√©trique dans Kapacitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/478702/">  Tr√®s probablement, personne ne se demande aujourd'hui pourquoi il doit collecter des mesures de service.  L'√©tape logique suivante consiste √† configurer l'alerte pour les mesures collect√©es, qui vous avertira de tout √©cart dans les donn√©es dans les canaux qui vous conviennent (courrier, Slack, T√©l√©gramme).  Dans le service de r√©servation en ligne des h√¥tels <a href="https://www.habr.com/%3Futm_source%3Dhabr%26utm_medium%3Dpr%26utm_campaign%3DErmolaev_dec19%26utm_content%3Darticle">Ostrovok.ru</a> , toutes les mesures de nos services sont vers√©es dans InfluxDB et affich√©es dans Grafana, une alerte de base y est √©galement d√©finie.  Pour des t√¢ches telles que "vous devez calculer quelque chose et le comparer", nous utilisons Kapacitor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oe/cl/5h/oecl5hgip8nkmeau21l2qaem8ek.png"></div><br>  Kapacitor fait partie de la pile TICK qui peut g√©rer les m√©triques d'InfluxDB.  Il peut connecter plusieurs dimensions entre elles (joindre), calculer quelque chose d'utile √† partir des donn√©es re√ßues, r√©√©crire le r√©sultat dans InfluxDB, envoyer une alerte √† Slack / Telegram / mail. <br><br>  La pile enti√®re a une <a href="">documentation</a> cool et d√©taill√©e, mais il y a toujours des choses utiles qui ne sont pas explicitement sp√©cifi√©es dans les manuels.  Dans cet article, j'ai d√©cid√© de rassembler un certain nombre de conseils utiles non √©vidents (la syntaxe de base TICKscipt est d√©crite <a href="https://docs.influxdata.com/kapacitor/v1.5/tick/syntax/">ici</a> ) et de montrer comment ils peuvent √™tre appliqu√©s, en utilisant un exemple de r√©solution de l'un de nos probl√®mes. <br><br>  C'est parti! <br><a name="habracut"></a><br><h4>  float &amp; int, erreurs de calcul </h4><br>  Probl√®me absolument standard, il est r√©solu par les castes: <br><br><pre><code class="python hljs">var alert_float = <span class="hljs-number"><span class="hljs-number">5.0</span></span> var alert_int = <span class="hljs-number"><span class="hljs-number">10</span></span> data|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &gt; alert_float OR float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &lt; float(<span class="hljs-string"><span class="hljs-string">"alert_int"</span></span>))</code> </pre> <br><h4>  Utilisation de default () </h4><br>  Si la balise / le champ n'est pas rempli, des erreurs se produiront dans les calculs: <br><br><pre> <code class="python hljs">|default() .tag(<span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'empty'</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><h4>  remplir la jointure (int√©rieure vs ext√©rieure) </h4><br>  Par d√©faut, la jointure supprimera des points o√π il n'y a pas de donn√©es (internes). <br>  Avec fill ('null'), la jointure externe sera ex√©cut√©e, apr√®s quoi vous devrez faire default () et remplir les valeurs vides: <br><br><pre> <code class="python hljs">var data = res1 |join(res2) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'res1'</span></span>, <span class="hljs-string"><span class="hljs-string">'res2) .fill('</span></span>null<span class="hljs-string"><span class="hljs-string">') |default() .field('</span></span>res1.value<span class="hljs-string"><span class="hljs-string">', 0.0) .field('</span></span>res2.value<span class="hljs-string"><span class="hljs-string">', 100.0)</span></span></code> </pre><br>  Il y a encore une nuance.  Si dans l'exemple ci-dessus l'une des s√©ries (res1 ou res2) est vide, la s√©rie finale (donn√©es) sera √©galement vide.  Il y a plusieurs tickets sur ce sujet sur le github ( <a href="https://github.com/influxdata/kapacitor/issues/1633">1633</a> , <a href="https://github.com/influxdata/kapacitor/issues/1871">1871</a> , <a href="https://github.com/influxdata/influxdb/issues/6967">6967</a> ) - nous attendons des correctifs et souffrons un peu. <br><br><h4>  Utilisation de conditions dans les calculs (si dans lambda) </h4><br><pre> <code class="python hljs">|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, true, false)</code> </pre><br><h4>  Les cinq derni√®res minutes du pipeline sur la p√©riode </h4><br>  Par exemple, vous devez comparer les valeurs des cinq derni√®res minutes avec la semaine pr√©c√©dente.  Vous pouvez prendre deux paquets de donn√©es avec deux batch'ami distincts ou extraire une partie des donn√©es d'une p√©riode plus longue: <br><br><pre> <code class="python hljs"> |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>))/<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br>  Une alternative pour les cinq derni√®res minutes pourrait √™tre d'utiliser le n≈ìud BarrierNode, qui coupe les donn√©es avant l'heure sp√©cifi√©e: <br><br><pre> <code class="python hljs">|barrier() .period(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br><h2>  Exemples d'utilisation de mod√®les Go'sh dans un message </h2><br>  Les mod√®les correspondent au format du package <a href="https://golang.org/pkg/text/template/">text.template</a> , <a href="https://golang.org/pkg/text/template/">voici</a> quelques t√¢ches courantes. <br><br><h4>  if-else </h4><br>  Nous mettons les choses en ordre, nous ne d√©clenchons pas les gens avec le texte encore une fois: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'{{ if eq .Level "OK" }}It is ok now{{ else }}Chief, everything is broken{{end}}'</span></span> )</code> </pre><br><h4>  Deux d√©cimales dans le message </h4><br>  Am√©lioration de la lisibilit√© du message: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'now value is {{ index .Fields "value" | printf "%0.2f" }}'</span></span> )</code> </pre><br><h4>  D√©veloppement de variables dans le message </h4><br>  Nous affichons plus d'informations dans le message pour r√©pondre √† la question ¬´Pourquoi crie-t-il?¬ª <br><br><pre> <code class="python hljs">var warnAlert = <span class="hljs-number"><span class="hljs-number">10</span></span> |alert() ... .message( <span class="hljs-string"><span class="hljs-string">'Today value less then '</span></span>+string(warnAlert)+<span class="hljs-string"><span class="hljs-string">'%'</span></span> )</code> </pre><br><h4>  Identifiant d'alerte unique </h4><br>  La bonne chose quand il y a plus d'un groupe dans les donn√©es, sinon une seule alerte sera g√©n√©r√©e: <br><br><pre> <code class="python hljs">|alert() ... .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "myname" }}/{{ index .Tags "myfield" }}'</span></span>)</code> </pre><br><h4>  Gestionnaire personnalis√© </h4><br>  La grande liste de gestionnaires contient exec, qui vous permet d'ex√©cuter votre script avec les param√®tres pass√©s (stdin) - cr√©ativit√© et plus encore! <br><br>  L'un de nos outils personnalis√©s est un petit script python pour envoyer des notifications √† Slack. <br>  Tout d'abord, nous voulions envoyer une photo d'une grafana prot√©g√©e par autorisation dans le message.  Apr√®s - √©crivez OK dans le fil de l'alerte pr√©c√©dente du m√™me groupe, et non sous forme de message distinct.  Un peu plus tard - pour ajouter l'erreur la plus courante au cours des X derni√®res minutes au message. <br><br>  Un sujet distinct est la communication avec d'autres services et toutes les actions lanc√©es par une alerte (uniquement si votre surveillance fonctionne suffisamment bien). <br>  Un exemple de description d'un gestionnaire, o√π slack_handler.py est notre script auto-√©crit: <br><br><pre> <code class="python hljs">topic: slack_graph id: slack_graph.alert match: level() != INFO AND changed() == TRUE kind: <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> options: prog: /sbin/slack_handler.py args: [<span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"CHANNELID"</span></span>, <span class="hljs-string"><span class="hljs-string">"--graph"</span></span>, <span class="hljs-string"><span class="hljs-string">"--search"</span></span>]</code> </pre><br><h2>  Comment d√©buter? </h2><br><h4>  Option de sortie de journal </h4><br><pre> <code class="python hljs">|log() .level(<span class="hljs-string"><span class="hljs-string">"error"</span></span>) .prefix(<span class="hljs-string"><span class="hljs-string">"something"</span></span>)</code> </pre><br>  Watch (cli): kapacitor -url <a href="http://host-or-ip/">host-or-ip</a> : 9092 logs lvl = error <br><br><h4>  Variante avec httpOut </h4><br>  Affiche les donn√©es dans le pipeline actuel: <br><br><pre> <code class="python hljs">|httpOut(<span class="hljs-string"><span class="hljs-string">'something'</span></span>)</code> </pre><br>  Regardez (obtenez): <a href="http://host-or-ip/">host-or-ip</a> : 9092 / kapacitor / v1 / tasks / task_name / quelque chose <br><br><h4>  Sch√©ma d'ex√©cution </h4><br><ul><li>  Chaque t√¢che renvoie un arbre d'ex√©cution avec des nombres utiles au format <a href="https://www.graphviz.org/">graphviz</a> . </li><li>  Prenez le bloc de <a href="http://host-or-ip:9092/kapacitor/v1/tasks/task_name%3Fdot-view%3Dlabels">points</a> . </li><li>  Nous ins√©rons dans le spectateur, <a href="https://dreampuf.github.io/GraphvizOnline">profitez-en</a> . <br></li></ul><br><br><h2>  O√π puis-je trouver un r√¢teau </h2><br><h4>  horodatage influxdb en √©criture diff√©r√©e </h4><br>  Par exemple, nous configurons une alerte pour la somme des demandes par heure (groupBy (1h)) et voulons enregistrer l'incident dans influxdb (pour montrer magnifiquement le fait d'un probl√®me sur le graphique dans grafana). <br><br>  influxDBOut () √©crira la valeur de temps de l'alerte √† l'horodatage, respectivement, le point sur le graphique sera enregistr√© plus t√¥t / plus tard que l'alerte est arriv√©e. <br><br>  Lorsque la pr√©cision est requise: nous contournons ce probl√®me en appelant un gestionnaire personnalis√©, qui √©crira les donn√©es dans influxdb avec l'horodatage actuel. <br><br><h4>  docker, construire et d√©ployer </h4><br>  Au d√©marrage, kapacitor peut charger des t√¢ches, des mod√®les et des gestionnaires √† partir du r√©pertoire sp√©cifi√© dans la configuration dans le bloc [load]. <br><br>  Pour cr√©er correctement une t√¢che, les √©l√©ments suivants sont n√©cessaires: <br><br><ol><li>  Nom de fichier - se d√©veloppe en nom id / script </li><li>  Type - flux / lot </li><li>  dbrp - mot cl√© pour indiquer dans quelle base de donn√©es + politique le script fonctionne (dbrp "fournisseur". "autog√®ne") </li></ol><br>  S'il n'y a pas de ligne avec dbrp dans certaines t√¢ches par lots, l'ensemble du service refusera de d√©marrer et d'√©crire honn√™tement √† ce sujet dans le journal. <br><br>  Dans chronograf, au contraire, cette ligne ne devrait pas l'√™tre, elle n'est pas accept√©e via l'interface et lance une erreur. <br><br>  Hack lors de la construction d'un conteneur: Dockerfile se ferme avec -1 s'il existe des lignes avec //.+dbrp, qui comprendra imm√©diatement la raison du fichier lors de la construction de la construction. <br><br><h4>  rejoindre un √† plusieurs </h4><br>  Exemple de t√¢che: vous devez prendre le 95e centile du temps de fonctionnement du service par semaine, comparer chaque minute des 10 derniers avec cette valeur. <br><br>  Vous ne pouvez pas joindre un √† plusieurs, le dernier / moyen / m√©dian par un groupe de points transforme le n≈ìud en flux, l'erreur "ne peut pas ajouter de bords enfants non appari√©s: batch -&gt; flux" sera de retour. <br><br>  Le r√©sultat du lot, en tant que variable dans une expression lambda, n'est pas non plus substitu√©. <br><br>  Il existe une option pour enregistrer les num√©ros n√©cessaires du premier lot dans un fichier via udf et charger ce fichier via sideload. <br><br><h2>  Qu'avons-nous d√©cid√©? </h2><br>  Nous avons environ 100 fournisseurs d'h√¥tels, chacun d'entre eux peut avoir plusieurs connexions, appelons cela un canal.  Il y a environ 300 de ces canaux; chacun des canaux peut tomber.  De toutes les mesures enregistr√©es, nous surveillerons le taux d'erreur (demandes et erreurs). <br><br><h4>  Pourquoi pas grafana? </h4><br>  Les alertes d'erreur configur√©es dans grafan pr√©sentent plusieurs inconv√©nients.  Certains critiques, certains peuvent fermer les yeux, selon la situation. <br><br>  Grafana ne sait pas calculer entre dimensions + alerte, mais nous avons besoin d'un taux (requ√™tes-erreurs) / requ√™tes. <br><br>  Les erreurs semblent vicieuses: <br><br><img src="https://habrastorage.org/webt/iq/0h/nq/iq0hnqauk_l0nm4akwynyeb0hbc.png"><br><br>  Et moins vicieux lorsqu'il est vu avec des demandes r√©ussies: <br><br><img src="https://habrastorage.org/webt/mw/vs/ok/mwvsok9hb7qfa3lifpna4_rrno4.png"><br><br>  D'accord, nous pouvons pr√©-calculer le taux du service avant grafana, et dans certains cas, il le fera.  Mais pas le n√¥tre, car  pour chaque canal, son ratio est consid√©r√© comme ¬´normal¬ª, et les alertes fonctionnent selon des valeurs statiques (on regarde avec nos yeux, on change, si souvent alerte). <br><br>  Ce sont des exemples de ¬´normal¬ª pour diff√©rents canaux: <br><br><img src="https://habrastorage.org/webt/3f/d5/fg/3fd5fg6los9dg7pjlkuanfuv_mk.png"><br><br><img src="https://habrastorage.org/webt/hp/n-/q6/hpn-q6cnqtaugwlsmch1jvapnuc.png"><br><br>  Nous n√©gligeons le paragraphe pr√©c√©dent et supposons que tous les fournisseurs ont une image "normale".  Maintenant, tout va bien, et pouvons-nous nous en sortir avec des alertes dans Grafana? <br>  Nous pouvons, mais ne le voulons vraiment pas, car nous devons choisir l'une des options: <br>  a) faire de nombreux graphiques pour chaque canal s√©par√©ment (et les accompagner douloureusement) <br>  b) laisser un graphique avec tous les canaux (et se perdre dans les lignes color√©es et les alertes r√©gl√©es) <br><br><img src="https://habrastorage.org/webt/sk/8c/-b/sk8c-bayyodb08xuchmfbfjhe8q.png"><br><br><h4>  Comment as-tu fait √ßa? </h4><br>  Encore une fois, la documentation a un bon exemple de d√©part ( <a href="https://docs.influxdata.com/kapacitor/v1.5/guides/join_backfill/">Calcul des taux sur des s√©ries jointes</a> ), vous pouvez jeter un ≈ìil ou prendre comme base des t√¢ches similaires. <br><br>  Qu'avez-vous fait en cons√©quence: <br><br><ul><li>  rejoindre deux √©pisodes en quelques heures, regroup√©s par cha√Æne; </li><li>  remplir la s√©rie par groupes, s'il n'y avait pas de donn√©es; </li><li>  comparer la m√©diane des 10 derni√®res minutes avec les donn√©es pr√©c√©dentes; </li><li>  nous hurlons si nous trouvons quelque chose; </li><li>  √©crire les taux calcul√©s et les alertes survenues dans influxdb; </li><li>  envoyez un message utile √† slack. </li></ul><br>  √Ä mon avis, nous avons r√©ussi aussi magnifiquement que possible tout ce que nous aimerions obtenir √† la sortie (et m√™me un peu plus avec des gestionnaires personnalis√©s). <br><br>  Sur github.com, vous pouvez voir l' <a href="">exemple de code</a> et le <a href="">diagramme minimal (graphviz) du</a> script r√©sultant. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple du code r√©sultant:</b> <div class="spoiler_text"><pre> <code class="python hljs">dbrp <span class="hljs-string"><span class="hljs-string">"supplier"</span></span>.<span class="hljs-string"><span class="hljs-string">"autogen"</span></span> var name = <span class="hljs-string"><span class="hljs-string">'requests.rate'</span></span> var grafana_dash = <span class="hljs-string"><span class="hljs-string">'pczpmYZWU/mydashboard'</span></span> var grafana_panel = <span class="hljs-string"><span class="hljs-string">'26'</span></span> var period = <span class="hljs-number"><span class="hljs-number">8</span></span>h var todayPeriod = <span class="hljs-number"><span class="hljs-number">10</span></span>m var every = <span class="hljs-number"><span class="hljs-number">1</span></span>m var warnAlert = <span class="hljs-number"><span class="hljs-number">15</span></span> var warnReset = <span class="hljs-number"><span class="hljs-number">5</span></span> var reqQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."requests"'</span></span> var errQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."errors"'</span></span> var prevErr = batch |query(errQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var prevReq = batch |query(reqQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var rates = prevReq |join(prevErr) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'req'</span></span>, <span class="hljs-string"><span class="hljs-string">'err'</span></span>) .tolerance(<span class="hljs-number"><span class="hljs-number">1</span></span>m) .fill(<span class="hljs-string"><span class="hljs-string">'null'</span></span>) //   ,     |default() .field(<span class="hljs-string"><span class="hljs-string">'err.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'req.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:  ,     |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100.0</span></span> * (float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>) - float(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span>)) / float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>), <span class="hljs-number"><span class="hljs-number">100.0</span></span>)) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) //      rates |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'rates'</span></span>) //     <span class="hljs-number"><span class="hljs-number">10</span></span> ,   var todayRate = rates |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>)) / <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; todayPeriod) |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var prevRate = rates |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var joined = todayRate |join(prevRate) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'today'</span></span>, <span class="hljs-string"><span class="hljs-string">'prev'</span></span>) |httpOut(<span class="hljs-string"><span class="hljs-string">'join'</span></span>) var trigger = joined |alert() .warn(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &gt; warnAlert) .warnReset(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &lt; warnReset) .flapping(<span class="hljs-number"><span class="hljs-number">0.25</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .stateChangesOnly() //   message      .message( <span class="hljs-string"><span class="hljs-string">'{{ .Level }}: {{ index .Tags "channel" }} err/req ratio ({{ index .Tags "supplier" }}) {{ if eq .Level "OK" }}It is ok now{{ else }} '</span></span>+string(todayPeriod)+<span class="hljs-string"><span class="hljs-string">' median is {{ index .Fields "today.median" | printf "%0.2f" }}%, by previous '</span></span>+string(period)+<span class="hljs-string"><span class="hljs-string">' is {{ index .Fields "prev.median" | printf "%0.2f" }}%{{ end }} http://grafana.ostrovok.in/d/'</span></span>+string(grafana_dash)+ <span class="hljs-string"><span class="hljs-string">'?var-supplier={{ index .Tags "supplier" }}&amp;var-channel={{ index .Tags "channel" }}&amp;panelId='</span></span>+string(grafana_panel)+<span class="hljs-string"><span class="hljs-string">'&amp;fullscreen&amp;tz=UTC%2B03%3A00'</span></span> ) .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "name" }}/{{ index .Tags "channel" }}'</span></span>) .levelTag(<span class="hljs-string"><span class="hljs-string">'level'</span></span>) .messageField(<span class="hljs-string"><span class="hljs-string">'message'</span></span>) .durationField(<span class="hljs-string"><span class="hljs-string">'duration'</span></span>) .topic(<span class="hljs-string"><span class="hljs-string">'slack_graph'</span></span>) // <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>   <span class="hljs-string"><span class="hljs-string">"value"</span></span>,        (keep) trigger |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>) .keep() |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'alerts'</span></span>) .tag(<span class="hljs-string"><span class="hljs-string">'alertName'</span></span>, name)</code> </pre><br></div></div><br><h2>  Quelle conclusion? </h2><br>  Kapacitor est tr√®s bon pour surveiller les alertes avec un groupe de groupes, effectuer des calculs suppl√©mentaires sur des mesures d√©j√† enregistr√©es, effectuer des actions personnalis√©es et ex√©cuter des scripts (udf). <br><br>  Le seuil d'entr√©e n'est pas tr√®s √©lev√© - essayez-le si grafana ou d'autres outils ne satisfont pas pleinement votre liste de souhaits. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr478702/">https://habr.com/ru/post/fr478702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr478690/index.html">Assemblage et d√©ploiement dynamiques d'images Docker avec werf en utilisant l'exemple de site de documentation versionn√©e</a></li>
<li><a href="../fr478692/index.html">Prise en charge de Java 8 sur Android</a></li>
<li><a href="../fr478694/index.html">Comme nous vous recommandons les derniers catalogues du cin√©ma en ligne ivi (+ code Python)</a></li>
<li><a href="../fr478696/index.html">Comment j'ai visit√© Urban Tech 2019. Rapport d'√©v√©nement</a></li>
<li><a href="../fr478698/index.html">Nous r√©alisons un plan de terrain interactif en 15 minutes</a></li>
<li><a href="../fr478704/index.html">Que faire si les envois ont d√©j√† atteint le spam: 5 √©tapes pratiques</a></li>
<li><a href="../fr478706/index.html">Architecte √† forte charge. Nouveau cours d'OTUS</a></li>
<li><a href="../fr478708/index.html">Comment les randomiseurs vous permettent de donner un nouveau souffle aux anciens jeux</a></li>
<li><a href="../fr478710/index.html">D√©ploiement simple et organis√© des applications sur la cartouche Tarantool (partie 1)</a></li>
<li><a href="../fr478712/index.html">Comment ne pas payer pour l'h√©bergement Java ou un d√©marrage rapide avec Google App Engine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>