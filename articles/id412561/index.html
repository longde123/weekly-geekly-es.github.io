<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💅🏻 ♠️ 🤶🏻 Membalikkan rekayasa firmware perangkat menggunakan contoh "badak" yang berkedip. Bagian 2 ⛹🏻 👨‍🏭 🔥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kami hadir untuk perhatian Anda bagian kedua dari artikel tentang rekayasa balik firmware perangkat Badak Berkedip berdasarkan kelas master di konfere...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membalikkan rekayasa firmware perangkat menggunakan contoh "badak" yang berkedip. Bagian 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inforion/blog/412561/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ny/yo/jz/nyyojzktr_-hcfv4j7ygq_eaiuu.png"></div><br>  Kami hadir untuk perhatian Anda bagian kedua dari artikel tentang rekayasa balik firmware perangkat Badak Berkedip berdasarkan kelas master di konferensi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SMARTRHINO-2018</a> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pada bagian pertama</a> artikel, firmware perangkat dimuat ke disassembler IDA dan analisis awal dari perintah protokol perangkat dilakukan.  Perintah individual diuji pada perangkat yang berfungsi. <br><br>  Pada bagian kedua, analisis tugas firmware yang tersisa akan dilakukan. <br><br>  Biarkan saya mengingatkan Anda, setelah menganalisis tugas Bluetooth dalam hal mengendalikan LED, diputuskan untuk beralih ke tugas LED, karena tugas awalnya adalah membuat aplikasi untuk mengendalikan LED, dan untuk ini diperlukan pemahaman terperinci tentang operasi firmware. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">File firmware</a> tersedia untuk studi independen. <br><br>  <i>Semua informasi disediakan hanya untuk tujuan pendidikan.</i> <br><br>  Di bawah kucing ada banyak badak yang berkedip. <br><a name="habracut"></a><br><h2>  Tugas LED </h2><br>  <i>Secara singkat: analisis lengkap tugas yang bertanggung jawab untuk mengganti LED.</i>  <i>Analisis tipe data dan variabel global.</i> <br><br>  Tugas LED diwakili oleh fungsi <b>x_leds_task</b> , yang terletak di <code>0x08005A08</code> . <br><br>  Selain garis aneh "Aku punya kekuatan super ..." di fungsi utama tugas LED, Anda dapat memperhatikan baris <b>"hue&gt; max: ubah bersinar \ r \ n"</b> . <br><br><img src="https://habrastorage.org/webt/6j/7u/qv/6j7uqvcupizmfsbqca81as5dwlw.png"><br><br>  Pada saat yang sama, kita melihat situasi yang akrab - (WORD *) (v26 + 4).  Di menu konteks variabel v26, pilih item "Konversikan ke struct *", lalu tunjukkan struktur yang dibuat sebelumnya: <br><br><img src="https://habrastorage.org/webt/6a/2i/jv/6a2ijvqm631yl3ce5z6uom02znw.png"><br><br>  Mengingat <code>v5 = v26</code> , kami mengulangi operasi <i>"Konversikan ke struct *"</i> untuk variabel v5. <br><br>  Kami terus menyusun kode dan data.  Atur representasi hex di mana-mana.  Ganti nama: <br><br><ul><li>  v5 - <b>dipimpin</b> ; </li><li>  v6 - <b>idx</b> ; </li><li>  v8 - <b>hue_1</b> ; </li><li>  v9 - <b>hue_2</b> ; </li><li>  v26 - <b>_led</b> ; </li></ul><br>  Kode membaik.  Tetapi beberapa variabel masih melukai mata, misalnya, variabel v23: <br><br><img src="https://habrastorage.org/webt/pz/cp/ch/pzcpchfjgrlwgwwtbun85x6weve.png"><br><br><img src="https://habrastorage.org/webt/k1/4k/fi/k14kfil99uzjgtwdpimtjcrl-ye.png"><br><br><div class="spoiler">  <b class="spoiler_title">Rupanya, v23 adalah array 4 byte.</b> <div class="spoiler_text">  idx adalah indeks LED;  indeks ini ditambahkan ke alamat basis;  dengan cara ini, akses dilakukan ke elemen-elemen pada perpindahan yang sama - ini adalah bagaimana array berperilaku. <br></div></div><br>  Kami menetapkan tipe <code>char v23[4]</code> dan <b>menamainya</b> menjadi <b>leds_smth</b> , kode menjadi lebih cantik: <br><br><img src="https://habrastorage.org/webt/3a/zp/vv/3azpvvasy-8oabd8be6tshcy6z8.png"><br><br>  Anda juga dapat mencatat bahwa hasil dari fungsi x_queue_recv dikembalikan ke variabel v25: <br><br><pre> <code class="cpp hljs">x_queue_recv(&amp;v25, leds_queue, <span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre> <br>  Tetapi mungkin tidak jelas bagaimana data yang Anda butuhkan dalam struktur <i>_led</i> .  Faktanya adalah bahwa variabel v25 dan _led <b><i>terletak di dekatnya pada stack</i></b> - ini dapat dipahami oleh fakta bahwa dalam dekompilasi mereka ditulis pada baris yang berdekatan.  Lokasi variabel pada tumpukan dapat dilihat di jendela terpisah jika Anda mengklik dua kali pada variabel: <br><br><img src="https://habrastorage.org/webt/gm/1z/qs/gm1zqsoxvvppvneguj76arsppdu.png"><br><br>  Mereka mungkin struktur, atau kompiler telah melakukan optimasi.  Dengan demikian, dapat dikatakan bahwa data dari tugas Bluetooth ditransmisikan ke tugas LED.  Untuk mengetahui lebih tepat, saya akan memeriksa perangkat - untuk nol LED melalui Bluetooth saya akan mengirimkan nilai <b>0x208</b> , <b>0x2D0</b> , <b>0x398</b> , <b>0x3E9</b> , yang dapat dilihat pada kode: <br><br><img src="https://habrastorage.org/webt/f-/1k/ds/f-1kdsphlzdbhuc4q6dwtfk6zge.png"><br><br>  Hasil pemeriksaan nilai rona pada perangkat: <br><br><ul><li>  0x208 - LED berhenti beralih dengan lancar dan diatur dalam warna: merah, hijau, biru, ungu; </li><li>  0x2D0 - LED mulai beralih lagi; </li><li>  0x398 - tidak ada yang berubah; </li><li>  0x3E9 - tidak ada yang berubah. </li></ul><br>  Jika Anda melihat kode lagi, Anda dapat melihat bahwa nilai 0x398 dapat dikaitkan secara logis dengan nilai kurang dari 0x167 (nilai yang berbeda ditetapkan untuk elemen array <i>leds_smth</i> ).  Oleh karena itu, saya akan melakukan pemeriksaan ini: pertama, saya akan mengatur LED pertama menjadi hijau (rona = 0x78, <code>LED 010078FF20</code> ), sementara tiga LED lainnya terus mengubah warnanya. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5h/mp/dc/5hmpdckwscpkhlgvth05w1xvmuy.gif"></div><br>  Sekarang saya akan <code>LED 010398FFFF</code> protokol Bluetooth <code>LED 010398FFFF</code> - setelah ini LED pertama telah beralih ke mode switching warna umum. <br><br>  Dengan demikian, nilai rona 0x398 me-reset nilai warna statis, yang berarti bahwa array leds_smth berisi flag (0 atau 1) untuk LED yang ditempati: <br><br><ul><li>  0 - LED tidak sibuk, berpartisipasi dalam perpindahan warna yang halus ( <b>hue = 0x398</b> ); </li><li>  1 - LED sibuk, pengguna mengatur warna statis ( <b>rona &lt;= 0x167</b> ). </li></ul><br>  Ganti nama leds_smth menjadi <b>leds_busy</b> . <br><br>  Sekarang tujuan dari blok kode berikut harus menjadi jelas: <br><br><img src="https://habrastorage.org/webt/sb/x8/mf/sbx8mfnnah6gziclrsqmgdcmpu0.png"><br><br>  Siklus dalam baris 83-101 melakukan mosaik warna yang halus dengan langkah peralihan warna 5: <code>v12 += 5</code> .  Jika LED memiliki warna statis menyala, maka LED ini tidak berpartisipasi dalam mosaik.  Setelah siklus ada garis pencantuman jangka pendek semua LED. <br><br>  Ganti nama: <br><br><ul><li>  sub_800678A - <b>x_led_set_hsv</b> ; </li><li>  v12 - <b>hue_step</b> ; </li><li>  v13, v17, v18, v19 - <b>led0_busy</b> , <b>led1_busy</b> , <b>led2_busy</b> , <b>led3_busy</b> ; </li><li>  v11, v20, v21, v22 - <b>hue0</b> , <b>hue1</b> , <b>hue2</b> , <b>hue3</b> ; </li><li>  dword_200004C4 - <b>led_control</b> . </li></ul><br>  Fungsi sub_80039FE mungkin melakukan timeout (jika tidak LED tidak beralih dengan lancar, tetapi langsung), sebut saja <b>x_sleep</b> , dan variabel v16 adalah <b>led_timeout</b> . <br><br>  Tujuan dari fungsi sub_8006934 belum jelas, tetapi digunakan di mana-mana setelah mengatur warna pada LED - Anda dapat menyebutnya <b>x_led_fix_color</b> . <br><br>  Setelah penggantian nama ini, mudah untuk memahami fungsi <b>sub_8006944</b> (dipanggil dalam rona &lt;= 0x167 cabang): <br><br><img src="https://habrastorage.org/webt/nf/8a/j-/nf8aj-jzfsk9livqh_zxpwtojgq.png"><br><br>  Ini hanya melakukan pemeriksaan tambahan untuk menentukan warna LED.  Ganti nama fungsi sub_8006944 menjadi <b>x_led_set_hsv_wrap</b> (suffix <i>_wrap</i> - penjelasan bahwa ini adalah "pembungkus" di atas fungsi lain) dan tetapkan prototipe berikut untuknya: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x_led_set_hsv_wrap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> led_control, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">signed</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sat, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val)</span></span></span></span></code> </pre> <br>  Mari kita kembali satu tingkat ke fungsi x_leds_task.  Sekali lagi melihat kode, Anda dapat menemukan bahwa cabang "hue&gt; 0x3E8" mulai terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/sh/tm/5j/shtm5jrmecd3quimykrcgognngs.png"><br><br>  Artinya, nilai rona lebih besar dari 0x3E8 harus mengubah batas waktu mosaik berwarna.  Saya akan memeriksa dengan mengirimkan beberapa nilai ke perangkat: <br><br><ul><li>  hue = 0x3E9 - LED mulai beralih dengan cepat: <br><br><img src="https://habrastorage.org/webt/1z/an/to/1zantozqcbgf0ho69jmgbvdd8v8.gif"><br></li><li>  hue = 0xFFFF - LED mulai beralih dengan sangat lambat: <br><br><img src="https://habrastorage.org/webt/jr/ty/sn/jrtysngekw8_1ise6uwd0kikrhc.gif"><br></li></ul><br>  Saat keluar dari siklus utama tugas LED, fungsi <b>sub_8003C44 digunakan</b> , yang juga digunakan dalam fungsi sub_8005070: <br><br><img src="https://habrastorage.org/webt/ow/ws/ql/owwsqly9wu0bhmwzhu3r7buky5s.png"><br><br>  Ganti nama: <br><br><ul><li>  sub_8005070 - <b>x_freeMsg</b> ; </li><li>  sub_8003C44 - <b>x_free_queue</b> . </li></ul><br>  Lebih jauh dalam tugas LED, cabang berikut tidak bisa tidak menarik perhatian: <br><br><img src="https://habrastorage.org/webt/iu/q6/rr/iuq6rrf54hzoupmpslmnp0r8pcu.png"><br><br>  Anda dapat mencoba menjalankan perintah <code>LED B816D8D90000FFFF</code> .  Tetapi jika Anda ingat bahwa hanya 2 karakter yang diambil sebagai indeks LED, upaya untuk mencapai kode ini jelas tidak berhasil.  Biarkan utas ini untuk nanti.  Ganti nama fungsi sub_8004AE8 menjadi <b>x_mad_blinking</b> , dan sekarang saatnya untuk memperbaiki tanda tangan dari fungsi <b>x_printf</b> (terakhir kali saya menulis tanda tangan yang salah): <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x_printf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *format, ...)</span></span></span></span></code> </pre> <br>  Siklus utama tugas LED dibongkar, tetapi masih ada kode di awal tugas. <br><br>  Mari kita lihat kodenya: <br><br><img src="https://habrastorage.org/webt/kt/xx/wn/ktxxwnzjvx9eqkkuiydzlro3vz4.png"><br><br>  Pada baris 49, kemungkinan besar LED diperiksa untuk ketersediaan dan, jika terjadi kesalahan, panggilan dilakukan ke fungsi sub_8004BBC, yang mematikan interupsi dan memulai loop tak terbatas di mana baris "../Drivers/STM32F0xx_HAL_Driver/Src/stm32f0xx_hal_gpio.cog digunakan".  Kemungkinan besar, itu adalah fungsi <b>tegas</b> atau serupa. <br><br>  Ganti nama: <br><br><ul><li>  sub_8004BBC - <b>x_gpio_assert</b> ; </li><li>  sub_800698C - <b>x_check_gpio</b> . </li></ul><br>  Tujuan fungsi <b>sub_8006968</b> akan menjadi jelas jika Anda melihat perangkat dengan hati-hati saat dihidupkan: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i8/ap/t4/i8apt4kjg6rrbu73wzya5noyx6m.gif"></div><br>  Keempat LED bersamaan menyala merah, pertama, hijau, lalu biru.  Setelah itu, mereka diatur oleh warna: 0-merah, 1-hijau, 2-biru, 3-ungu.  Dan baru kemudian mereka mulai beralih mosaik. <br><br>  Karena mosaik dimulai pada siklus tugas utama, adalah logis bahwa garis 58-61 sebelum siklus utama bertanggung jawab atas penyertaan jangka pendek dari berbagai warna pada LED, dan garis 52-56 bertanggung jawab untuk mengatur merah-hijau-biru pada semua LED sekaligus.  Ganti nama fungsi sub_8006968 menjadi <b>x_led_all_set_rgb</b> (RGB - murni berdasarkan dugaan, sesuai dengan argumen yang diteruskan). <br><br><h2>  Keanehan dalam tugas LED </h2><br>  <i>Secara singkat: mendefinisikan fungsi kode yang berisi garis-garis aneh.</i>  <i>Menghasilkan kata sandi untuk perangkat.</i> <br><br>  Sekarang mari kita beralih ke bagian paling awal dari fungsi x_leds_task: <br><br><img src="https://habrastorage.org/webt/k1/64/2j/k1642jmvbxu5d0a7vs5lrtd3pru.png"><br><br>  <b>"Eraze"</b> , <b>"gen"</b> , <b>"flash"</b> , <b>"reset"</b> - mengapa ini semua ??? <br><br>  Mari kita coba mencari tahu. <br><br>  Biarkan sub_80066BC menjadi <b>x_leds_task_init</b> . <br><br>  Mari kita lihat sub_8006B38: <br><br><img src="https://habrastorage.org/webt/qa/80/ez/qa80ezojcnsyo_vz_q1hru7whz8.png"><br><br>  Memset air murni, setuju? <br><br><img src="https://habrastorage.org/webt/pf/oa/tf/pfoatfwwwasjk338b3lphqiiya4.png"><br><br>  Kembali ke x_leds_task.  Ada yang salah dengan tipe variabel v24: <br><br><img src="https://habrastorage.org/webt/vg/ag/8u/vgag8ujkoylag2iryzujjvjldfu.png"><br><br>  IDA membuat sedikit kesalahan dengan jenisnya, tetapi komentar dengan tanda tumpukan membantu kami.  Antara variabel v24 dan v25 sebanyak 12 byte (0x44 - 0x38).  Oleh karena itu, kami mengganti nama v24 menjadi <b>buf</b> dan menetapkan tipe <code>unsigned __int8 buf[12]</code> (Ida akan memperingatkan bahwa tipe data baru lebih besar daripada yang lama - kami setuju). <br><br>  Selanjutnya  Fungsi sub_8004CE4: <br><br><img src="https://habrastorage.org/webt/sc/qg/tw/scqgtwrqr1vzlaubtsqstydsqmu.png"><br><br>  Ganti nama <i>a1</i> menjadi <b>buf</b> , <i>v1</i> ke <b>_buf</b> . <br><br>  Fungsi sub_8006B26: <br><br><img src="https://habrastorage.org/webt/gs/du/ff/gsduffmdls272wqpmmv6_klqxdm.png"><br><br>  Apakah Anda mengenalinya? <br><br><div class="spoiler">  <b class="spoiler_title">Dan jika tanpa makeup?</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8k/1d/p9/8k1dp9nmxkl0xjktjtsk_cp2vem.png"><br>  Tentu saja <b>memcpy</b> .  Ganti nama. <br></div></div><br>  Maka tujuan dari fungsi sub_8004CE4 adalah untuk mendapatkan beberapa data di alamat <b>0x08007C00</b> .  Omong-omong, alamat ini berada dalam kisaran alamat memori flash mikrokontroler (dan firmware, khususnya).  Ganti nama sub_8004CE4 menjadi <b>x_read_data_0x08007C00</b> . <br><br>  Garis Fungsi X_leds_task 36: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-number"><span class="hljs-number">65</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0x19</span></span> )</code> </pre> <br>  Ubah tampilan data (tombol R pada angka 65, tombol H pada angka 0x19): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-string"><span class="hljs-string">'A'</span></span> &gt; <span class="hljs-number"><span class="hljs-number">25</span></span> )</code> </pre> <br>  Setelah sedikit refleksi, Anda dapat memahami bahwa ini adalah semacam tes kisaran alfabet Latin AZ. <br><br>  Selanjutnya, menggunakan prompt dalam bentuk format string, ganti nama: <br><br><ul><li>  sub_8004C10 - <b>x_erase</b> ; </li><li>  sub_80059C8 - <b>x_gen</b> ; </li><li>  sub_8004C84 - <b>x_flash</b> . </li></ul><br>  Fungsi sub_8003C66 tidak melakukan apa pun yang luar biasa - hanya meningkatkan beberapa variabel global - mengubah nama sub_8003C66 menjadi <b>x_smth_inc</b> . <br><br>  Fungsi <b>x_erase</b> sebenarnya tidak menerima argumen apa pun - ini dapat diverifikasi di disassembler: <br><br><img src="https://habrastorage.org/webt/rv/p3/_i/rvp3_iqmhzsegjqyi3mugvpxnis.png"><br><br>  Di dalam x_erase, alamat akrab 0x08007C00 digunakan dan tiga fungsi yang tidak diketahui diakses: <br><br><img src="https://habrastorage.org/webt/ys/nb/_b/ysnb_bfgd19htkrnmbyo5hudr0m.png"><br><br>  <b>Sekilas</b> pada ketiga fungsi ini, kita melihat bahwa mereka mengakses alamat dalam kisaran <b>0x40022000 - 0x400223FF</b> .  Dokumentasi untuk mikrokontroler dengan jelas menyatakan bahwa ini adalah kisaran <b>"FLASH Interface"</b> .  Artinya, fungsi x_erase menghapus sepotong memori flash - hebat! <br><br>  Rupanya, fungsi x_flash menulis ke memori flash, setelah memeriksa panjang baris untuk menulis (omong-omong, argumen a2 dan a3 berlebihan di sini - kami akan membantu Ide): <br><br><img src="https://habrastorage.org/webt/ki/di/zi/kidizigfv5lb6bwg24aspkgvxmw.png"><br><br>  Dan semua ini terjadi di "perangkat penerangan" ??? <br><br>  Nah, bagaimana dengan fungsi <b>x_gen</b> ?  Setelah melihat cepat dan mengganti nama variabel, itu akan terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/v3/js/nb/v3jsnb8jb36wstn3obcln2c3pvk.png"><br><br>  Fungsi <b>sub_8006CB4</b> terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/ub/h1/rk/ubh1rki0ikjrygsiqcx9vuwylxc.png"><br><br>  Dan <b>sub_8006D10</b> - seperti ini: <br><br><img src="https://habrastorage.org/webt/gp/qy/oc/gpqyocts_ubcd4u3ep9koyrcb0o.png"><br><br>  Jangan menahan keinginan untuk mencari di internet untuk konstanta tidak senonoh yang indah ini: <b>0xABCD</b> , <b>0x1234</b> , <b>0xE66D</b> , <b>0xDEEC</b> , <b>0x4C957F2D</b> dan <b>0x5851F42D</b> .  Jika Internet belum sepenuhnya dilarang, Anda mungkin akan menemukan konstanta ini di sumber untuk <b>fungsi acak</b> .  Tidak heran fungsi induknya disebut x_gen. <br><br>  Ini juga situasi yang sangat khas: panggil srand () sebelum loop, dan panggil acak () di loop, jadi beri nama: <br><br><ul><li>  sub_8006D10 - x_rand; </li><li>  sub_8006CB4 - x_srand. </li></ul><br>  Pembaca yang ingin tahu, dengan melihat ke fungsi <b>sub_8005098</b> , dapat mengetahui dari <i>mana asal benih</i> untuk fungsi srand. <br><br>  Dengan demikian, fungsi x_gen menghasilkan <b>string acak dengan ukuran yang ditentukan</b> . <br><br>  Setelah baris yang dihasilkan ditulis ke memori flash, perangkat reboot: <br><br><img src="https://habrastorage.org/webt/a9/ta/rr/a9tarrhqqc-jj7g-e-dplvr67py.png"><br><br>  Sepertinya semacam reboot aneh.  Tetapi jika kita melihat daftar tugas perangkat ini, kita akan menemukan "watchdogTask" di antara mereka.  Jelas, jika ada "tugas macet", pengawas reboot. <br><br>  Tugas LED kecuali mode MadBlinking dapat dianggap dianalisis. <br><br>  Mari kita lihat garis-garis apa tugas-tugas lain dalam sistem: <br><br><img src="https://habrastorage.org/webt/fz/yj/yk/fzyjykt6djuq8v20hjpuw5l0xow.png"><br><br>  Setelah memulihkan tautan ke string dalam kode, Anda dapat melihat gambar ini: <br><br><img src="https://habrastorage.org/webt/ha/bl/ks/hablksetvyb0rskx6veqrxbt_z0.png"><br><br>  Pertama, ada tautan ke string dengan nama tugas, lalu tautan ke fungsi tugas utama.  Dan mereka digunakan dalam fungsi <b>utama</b> , di mana tugas-tugas ini diluncurkan: <br><br><img src="https://habrastorage.org/webt/oc/ah/qd/ocahqdn8usagpkr-isbabunuwms.png"><br><br>  Mari kita jalankan nama yang hilang: <br><br><ul><li>  sub_80050FC - <b>x_sensor_task</b> ; </li><li>  sub_8004AAC - <b>x_watchdogTask</b> ; </li><li>  sub_8005440 - <b>x_uartRxTask</b> . </li></ul><br><h2>  Tugas pengawas </h2><br>  Pengawas tugas tidak melakukan sesuatu yang sangat menarik: <br><br><img src="https://habrastorage.org/webt/m-/65/5w/m-655wpo6oboqmrob1tonwaoska.png"><br><br>  Ganti nama: <br><br><ul><li>  dword_200003F8 - <b>wd_variable</b> ; </li><li>  sub_8001050 - <b>x_update_wd_var</b> . </li></ul><br><h2>  Tugas UART </h2><br>  <i>Secara singkat: cari data dan fungsi yang memiliki tautan dari berbagai fungsi.</i>  <i>Penentuan tujuan mereka.</i> <br><br>  Melihat tugas UART dengan cepat memungkinkan Anda mendeteksi pengiriman data ke antrian tidak dikenal yang ditentukan oleh variabel <b>unk_200003EC</b> : <br><br><img src="https://habrastorage.org/webt/8j/ei/zz/8jeizzxpvgu5opijgopamebser0.png"><br><br>  Setelah memulihkan tautan ke variabel ini melalui pencarian biner, kita akan melihat bahwa selain x_uartRxTask, ia digunakan di utama (di sana, antrian dibuat, tampaknya) dan dalam fungsi yang tidak diketahui sejauh ini <b>sub_80051EC</b> : <br><br><img src="https://habrastorage.org/webt/g2/md/sg/g2mdsgx9wwhzpklgcacelye8rb8.png"><br><br>  Ganti nama: <br><br><ul><li>  sub_80051EC - <b>x_recvMsg_uart_queue</b> ; </li><li>  unk_200003EC - <b>uart_queue</b> . </li></ul><br>  Lihat referensi silang ke x_recvMsg_uart_queue: <br><br><ul><li>  sub_8005250; </li><li>  x_bluetooth_task. </li></ul><br>  Pertama, lihat fungsi <b>sub_8005250</b> : <br><br><img src="https://habrastorage.org/webt/z1/8z/yj/z18zyj09grly6nwhuycpftjbrcu.png"><br><br>  Setelah berpikir, ganti nama: <br><br><ul><li>  unk_2000034C - <b>cmd_count</b> ; </li><li>  a1 - <b>cmd</b> ; </li><li>  v4 - <b>_cmd</b> ; </li><li>  v6 adalah <b>rsp</b> ; </li><li>  sub_8005250 - <b>x_bluetooth_cmd</b> . </li></ul><br>  Mari kita lihat sekarang di mana x_bluetooth_cmd masih digunakan.  Semua tautan tambahan hanya dari tugas Bluetooth, saatnya kembali ke sana. <br><br><h2>  Kembali ke tugas bluetooth </h2><br>  <i>Secara singkat: analisis akhir tugas Bluetooth.</i>  <i>Cari otorisasi tanpa kata sandi.</i> <br><br><img src="https://habrastorage.org/webt/mb/2b/-e/mb2b-eatekfev7dil5vfk3_s-es.png"><br><br>  Jika Anda melihat tempat-tempat di mana fungsi <b>sub_8006A84 digunakan</b> , dan Anda tidak terlalu malas dan memeriksa isi perutnya, tidak akan ada keraguan - ini adalah <b>calloc</b> .  Ini logis - untuk menerima data ke dalam buffer, Anda harus terlebih dahulu membuat buffer ini. <br><br>  Sekarang <b>sub_8006DBC</b> .  Mari kita lihat (variabel sudah diubah namanya): <br><br><img src="https://habrastorage.org/webt/kt/hw/31/kthw31aeqzwyae4jvnoqf5u6yl4.png"><br><br>  Mengingat fungsi pustaka C standar untuk bekerja dengan string, kita akan melihat <b>strstr</b> (mencari substring) di sini dan dengan berani mengubah nama itu. <br><br>  Mari kita melihat kode fungsi x_bluetooth_task - <i>mungkin ada sesuatu yang berubah di sini sejak kunjungan terakhir</i> .  Dalam prosesnya, kami beri nama variabel: <br><br><ul><li>  v2 - <b>_state</b> ; </li><li>  v3 - <b>data_len</b> . </li></ul><br>  Ada fungsi <b>sub_80052E2 tepat di</b> sebelahnya.  Dengan analogi dengan fungsi-fungsi yang menarik angka dari perintah Bluetooth, itu menarik string dengan panjang yang ditentukan - sebut saja <b>x_get_str</b> . <br><br>  Kami melanjutkan: <br><br><ul><li>  v26 - <b>isEcho</b> ; </li><li>  v6 - <b>meow_str</b> ; </li><li>  v10 - <b>uart_cmd_byte</b> ; </li><li>  v11 - <b>uart_cmd_str</b> ; </li><li>  v12 - <b>str_0</b> ; </li><li>  v13 - <b>str_1</b> ; </li><li>  v14 - <b>format_str</b> ; </li><li>  sub_8000F5C - <b>x_blink_small_led</b> . </li></ul><br>  Selesai dengan ganti nama cepat: <br><br><ul><li>  v19 - <b>kata sandi</b> ;  (karena ada baris tentang otorisasi dan kata sandi di sebelahnya) </li><li>  sub_8004CC0 - <b>x_check_password</b> ; </li><li>  sub_8006AF4 - <b>x_free</b> (karena kata sandi, cmd dan bt_args adalah pointer ke objek dinamis (centang ini!), memori harus dibebaskan setelah menggunakannya); </li><li>  sub_8006DAC - <b>x_strcpy</b> (periksa!) </li></ul><br>  Sekarang jelajahi cabang-cabang <b>BACA</b> , <b>MENULIS</b> , <b>AUTP</b> , <b>SETP</b> . <br><br>  Seperti yang ditunjukkan oleh pengujian pada perangkat yang sedang berjalan, diperlukan otorisasi untuk perintah BACA, WRIT, SETP.  Upaya otorisasi dengan perintah AUTP membawa kita ke fungsi <b>x_check_password</b> untuk memverifikasi kata sandi: <br><br><img src="https://habrastorage.org/webt/vt/pw/6b/vtpw6b3h64bivcvzdlalldoo45k.png"><br><br>  Ternyata panjang kata sandi harus 8 karakter dan kata sandi dibandingkan (dalam fungsi sub_8006B08) dengan byte pada alamat <b>0x08007C00</b> - tempat string yang dihasilkan dari karakter acak AZ disimpan. <br><br>  Ternyata, tanpa mengetahui kata sandi, kita tidak bisa masuk ke perangkat.  Yah, atau hampir tidak bisa ... <br><br>  Perhatikan di mana variabel <b>auth_flag digunakan</b> : <br><br><img src="https://habrastorage.org/webt/8h/ng/l0/8hngl0dqritcx8yzk1jbvkqpq34.png"><br><br>  Ternyata itu digunakan tidak hanya dalam tugas Bluetooth.  Dan di sini kita belum melihat tugas Sensor.  Kami pergi ke sana. <br><br><h2>  Tugas sensor </h2><br>  <i>Secara singkat: apa yang dilakukan tombol sentuh?</i> <br><br>  Sesuai dengan praktik pemrograman terbaik, seluruh tugas Sensor cocok dalam satu layar IDA.  Dan ini tidak bisa lain kecuali bersukacita: <br><br><img src="https://habrastorage.org/webt/mq/13/3v/mq133vs_uxqmyldfhmicajpxiak.png"><br><br>  Baris ke baris ... <br><br><ul><li>  "TSC% d \ r \ n" - baris ini akan membuat Anda berpikir tentang pengontrol sentuh Sensing untuk mikrokontroler STM32; </li><li>  "AUTH BTN \ r \ n" - tombol otorisasi ??? </li><li>  “SET AUTH% d \ r \ n” - setel tanda otorisasi? </li></ul><br>  Mari kita lihat bagaimana perangkat akan berperilaku jika Anda menekan tombol sentuh (apakah Anda menyadari bahwa badak di kaki memiliki tombol sentuh?): <br><br><img src="https://habrastorage.org/webt/0p/ig/bp/0pigbpj4pj5gdrn1onololc_zfk.gif"><br><br>  Saat ditekan sebentar, LED merah kecil menyala.  Dengan lama tekan, LED ini menyala untuk waktu yang lama. <br><br>  Jika kita menghubungkan ini dengan kode, kita dapat mengasumsikan bahwa fungsi <b>sub_8000708</b> adalah fungsi untuk mendapatkan waktu saat ini.  Kemudian, jika perbedaan antara waktu saat ini dan mulai menyentuh sensor lebih dari 1000 (1 detik), maka LED menyala selama <b>0xEA60</b> milidetik (1 menit).  Tetapi variabel auth_flag sangat menarik, yang diatur ke 1 dengan menekan agak lama pada tombol sentuh, memberikan <s>penyerang</s> akses ke administrator akses "fixture pencahayaan" ke fungsi istimewa. <br><br>  Dengan demikian, setelah otorisasi "dengan tombol", Anda dapat membaca kata sandi yang tersimpan di perangkat (perintah BACA), menulis ke RAM (fungsi WRIT) atau mengatur kata sandi baru (SETP). <br><br><h2>  Gila berkedip </h2><br>  <i>Secara singkat: dapatkah cabang kode Mad Blinking yang aneh dijalankan?</i> <br><br>  Mari kita kembali ke tugas Bluetooth dan melakukan penggantian nama lagi. <br><br><ul><li>  v21 - <b>vip_smth</b> (belum jelas apa yang ada di sana); </li><li>  v22 - <b>vip_str</b> (string dengan ukuran yang tidak diketahui, diekstraksi dari argumen); </li><li>  v23 - <b>mad_led</b> - menetapkan "Konversi ke struct *" dan tentukan <i>struct_LED</i> . </li></ul><br>  Dan di sini kita melihat angka <b>0xB816D8D9</b> (ditemukan di bagian pertama artikel dalam tugas Bluetooth) sebagai indeks LED.  Kode ini akan dieksekusi jika verifikasi dilakukan: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( sub_8005520(vip_str, vip_smth) == <span class="hljs-number"><span class="hljs-number">0x46F70674</span></span> )</code> </pre> <br>  Ganti nama sub_8005520 menjadi <b>x_vip_check</b> dan lihatlah: <br><br><img src="https://habrastorage.org/webt/dl/h9/tx/dlh9txqyu5n1t4orgprpptbk8oc.png"><br><br>  Karena argumen pertama adalah string (setidaknya string dilewatkan ke fungsi ini), kode ini menunjukkan bahwa argumen kedua adalah panjang string ini (atau panjang yang harus diproses).  Ganti nama: <br><br><ul><li>  a1 - <b>str</b> ; </li><li>  a2 - <b>len</b> . </li></ul><br>  Mari kita lihat fungsi <b>sub_8000254</b> : <br><br><img src="https://habrastorage.org/webt/y-/ql/js/y-qljsey4clq4lowsdbrblnkyf8.png"><br><br>  Sekarang lihat <b>sub_8000148</b> .  Inilah awalnya: <br><br><img src="https://habrastorage.org/webt/l7/xz/cr/l7xzcrdgjq0n5a82enkalsukqse.png"><br><br>  Ini hanya sepertiga dari fungsi ... Mmmm ... Enak!  Penggali yang berpengalaman akan dengan mudah melihat di sini ... <br><br><div class="spoiler">  <b class="spoiler_title">Apa?</b> <div class="spoiler_text">  operasi divisi integer. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Bagaimana bisa digali?</b> <div class="spoiler_text">  Jika Anda melakukan upaya, maka dari fungsi <b>sub_8000254</b> Anda dapat <b>membuka x_printf</b> (melalui beberapa fungsi lainnya).  Poin penting untuk dibuat pada titik ini adalah bahwa biasanya semua <i>fungsi standar cukup standar</i> .  Ini berarti Anda dapat mencoba mencari di domain publik setidaknya beberapa kode sumber fungsi yang sedang diselidiki, sehingga penelitian ini lebih produktif. <br><br>  Jadi, kita mengambil sumber printf, lalu kita melihat <b>vfprintf</b> , membandingkannya dengan kode dari firmware yang dipelajari.  <b>Menggunakan</b> kode sumber, kita keluar ke fungsi <b>itoa</b> dan menyimpulkan bahwa fungsi <b>sub_8000254</b> adalah <b>%</b> operator <b>operator</b> (mengambil sisa divisi), dan fungsi panjang yang mengerikan ini tidak lebih dari mengambil bagian integer divisi (operasi div). <br></div></div><br>  Sebuah pertanyaan yang sah mungkin muncul - mengapa demikian?  Faktanya adalah bahwa tidak ada DIV, operasi MOD dalam mikrokontroler tertentu, oleh karena itu, kompiler menggantikan panggilan fungsi individu, bukan operator ini.  Ngomong-ngomong, berikut adalah beberapa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">fungsi matematika</a> lainnya. <br><br>  Jangan lupa ganti nama saat menggali. <br><br>  Dengan demikian, fungsi <b>x_vip_check</b> , menghitung ... Dan ini akan menjadi <b><i>pekerjaan rumah</i></b> Anda. <br><br>  Omong-omong, jika Anda menjalankan perintah <b>VIP yang</b> benar, kami mendapatkan "badak di disko": <br><br><img src="https://habrastorage.org/webt/ah/ty/sc/ahtyscents-3j77aqcxfa0_hrtq.gif"><br><br><h2>  Laporan singkat tentang firmware </h2><br>  Firmware perangkat ini didasarkan pada sistem operasi real-time FreeRTOS.  Sistem memiliki tugas-tugas berikut: <br><br><ol><li>  <b>Tugas Bluetooth</b> .  Memproses perintah yang datang dalam bentuk teks melalui Bluetooth. </li><li>  <b>Tugas LED</b> .  Mengontrol LED warna sesuai dengan perintah Bluetooth. </li><li>  <b>Tugas sensor</b> .  Menyalakan LED merah, memungkinkan otorisasi jangka pendek tanpa kata sandi pada perangkat. </li><li>  <b>Tugas UART</b> .  Memungkinkan Anda berinteraksi dengan modul Bluetooth melalui port UART internal (digunakan untuk menginisialisasi Bluetooth). </li><li>  <b>Tugas Watchdog</b> .  Melacak pembekuan. </li></ol><br>  Studi ini tidak memperhitungkan kemampuan untuk membaca data dari port UART (kontak Tx / GND). <br><br><h2>  Ringkasan </h2><br>  Selama kelas master di konferensi, hanya fungsi kontrol LED utama yang dibongkar.  Peserta paling aktif disajikan dengan "badak" eksperimental mereka. <br><br>  Menurut pendapat saya, “badak” menghasilkan tata letak yang layak untuk kursus pelatihan tentang rekayasa balik dan pencarian kerentanan.  Fitur tata letak mungkin kemampuan untuk mengubah firmware sebanyak yang Anda suka, setiap kursus memiliki firmware sendiri.  Tidak seperti mem-parsing file yang dapat dieksekusi, membalikkan firmware memungkinkan Anda untuk lebih memahami: <br><br><ul><li>  cara bekerja dengan IDA; </li><li>  prinsip interaksi antara firmware dan perangkat; </li><li>  Prinsip operasi RTOS. </li></ul><br>  Terima kasih banyak untuk semua yang membaca sampai akhir! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id412561/">https://habr.com/ru/post/id412561/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id412551/index.html">Salin teks dari clipboard ke perangkat Android melalui ADB</a></li>
<li><a href="../id412553/index.html">Intisari acara untuk profesional SDM di bidang TI untuk Juni 2018</a></li>
<li><a href="../id412555/index.html">Perlengkapan magnetik untuk motor tanpa sikat</a></li>
<li><a href="../id412557/index.html">Cara membuat bot Anda sendiri tanpa keterampilan pemrograman dan menghubungkannya ke Yandex.Alice</a></li>
<li><a href="../id412559/index.html">Kontrak pintar sebagai ancaman keamanan untuk memblokir startup</a></li>
<li><a href="../id412565/index.html">Komik tentang sysadmin: semua kehidupan melintas di depan mataku</a></li>
<li><a href="../id412571/index.html">Kisah sukses Kubernetes dalam produksi. Bagian 9: Cluster CERN dan 210 K8</a></li>
<li><a href="../id412573/index.html">Apa yang salah dengan Geektimes kembali ke Habr</a></li>
<li><a href="../id412575/index.html">Setiap tahun, musik pop menjadi semakin monoton, karena orang yang sama mengarangnya</a></li>
<li><a href="../id412579/index.html">Marvel: Infinity War atau Cara mengumpulkan data untuk proyek Anda dalam beberapa menit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>