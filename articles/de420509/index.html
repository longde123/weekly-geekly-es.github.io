<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨ ğŸ¶ ğŸ†‘ Ein offensichtliches Problem bei der Verwendung von assert ğŸ‘ğŸ¾ ğŸ¤¶ğŸ¾ ğŸ‘ŠğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unit-Tests sind ein wichtiger Bestandteil jedes ausreichend groÃŸen Projekts. Ich mÃ¶chte Ihnen eine kleine Detektivgeschichte erzÃ¤hlen, die sich auf ih...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ein offensichtliches Problem bei der Verwendung von assert</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420509/">  Unit-Tests sind ein wichtiger Bestandteil jedes ausreichend groÃŸen Projekts.  Ich mÃ¶chte Ihnen eine kleine Detektivgeschichte erzÃ¤hlen, die sich auf ihren nicht offensichtlichen Massensturz bezieht. <br><br>  Es beginnt mit der Tatsache, dass infolge eines bestimmten harmlosen Commits etwa 150 Tests in das Projekt fielen, wÃ¤hrend die Anzahl der fallenden Tests nicht stabil war.  Die Tests waren nicht miteinander verbunden, die Tests wurden nacheinander durchgefÃ¼hrt.  Die speicherinterne h2-Datenbank wird als Datenquelle fÃ¼r Tests verwendet.  Der Sturz der Ã¼berwiegenden Mehrheit dieser 150 Tests ging mit einem Fehler im Protokoll einher: â€Verbindung kann nicht hergestellt werden, Poolfehler Timeout wartet auf inaktives Objektâ€œ.  Es sollte gesagt werden, dass die GrÃ¶ÃŸe des Verbindungspools bei der DurchfÃ¼hrung von Tests im Projekt 1 betrÃ¤gt. <br><a name="habracut"></a><br>  Ein kleiner lyrischer Exkurs: Im Projektcode wird die Transaktion regelmÃ¤ÃŸig vom Ablauf getrennt, dann wird der Code in einer separaten Transaktion ausgefÃ¼hrt und schlieÃŸlich wird die Transaktion rÃ¼ckverknÃ¼pft.  FÃ¼r solche FÃ¤lle wurde eine Hilfsklasse geschrieben, deren Verwendung ungefÃ¤hr so â€‹â€‹aussieht: <br><br><pre><code class="java hljs">TransactionRunner.run(dbDataManager(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodTransaction() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runInTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,       return result; } );</span></span></code> </pre> <br>  Als Ergebnis der Analyse wurde festgestellt, dass der Fehler nach einem fehlgeschlagenen Test auftritt, der einen Codeaufruf in einer Transaktion enthÃ¤lt: <br><br><pre> <code class="java hljs">TransactionRunner.run(dbDataManager(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodTransaction() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runInTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ...   // assert   assert( 1, result.getSomeNotEqualOneIntValue() ); return result; } );</span></span></code> </pre> <br>  Werfen Sie einen Blick in die TransactionRunner-Klasse. Ein Methodenaufruf fÃ¼hrt zu folgendem Code: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CommonException </span></span>{ Transaction outerTr = getThreadTransaction(); bindThreadTransaction(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { setResult(transactionCode.runInTransaction()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { dbDataManager().rollbackTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transaction.onException(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, e)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> e; } dbDataManager().commitTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getResult(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ExceptionUtil.createCommonException(e); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { bindThreadTransaction(outerTr); } }</code> </pre> <br>  Was ist hier das Problem?  Das Problem besteht darin, dass der AssertionError, der als Ergebnis der TestcodeausfÃ¼hrung auftritt, nicht von Exception geerbt wird. Dies bedeutet, dass die verschachtelte Transaktion weder zurÃ¼ckgesetzt noch festgeschrieben wird.  Da die GrÃ¶ÃŸe des Verbindungspools gleich eins ist, wird der gleiche Fehler "Verbindung kann nicht hergestellt werden, Poolfehler Timeout wartet auf inaktives Objekt" angezeigt, wenn versucht wird, das Verbindungsobjekt durch nachfolgende Tests abzurufen. <br><br>  Moral: Es ist notwendig, Assertions mit Vorsicht in Tests zu platzieren. Bei nicht offensichtlichen und insbesondere MassenabstÃ¼rzen besteht eine LÃ¶sung darin, zu Ã¼berprÃ¼fen, ob bei der Ausnahmebehandlung Objekte berÃ¼cksichtigt werden, die nicht von Exception geerbt wurden. <br><br>  Der Fall schien mir der Fixierung wert zu sein, vielleicht ist diese Erfahrung fÃ¼r jemanden nÃ¼tzlich. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de420509/">https://habr.com/ru/post/de420509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de420499/index.html">Anatomie von Empfehlungssystemen. Teil eins</a></li>
<li><a href="../de420501/index.html">Linux im RAM: Debirf Way 2018</a></li>
<li><a href="../de420503/index.html">JS Developer Day, verschiedene StÃ¤dte und Gemeinden - ein Feiertag</a></li>
<li><a href="../de420505/index.html">Wird OpenAI Five das professionelle Team von The International gewinnen?</a></li>
<li><a href="../de420507/index.html">Hintergrund: Das globale Internet fÃ¼r alle und seine SchÃ¶pfer</a></li>
<li><a href="../de420511/index.html">Arbeiten Sie als IT-Spezialist in der Region Fernost - Amur</a></li>
<li><a href="../de420513/index.html">Eine Raubkopie eines kostenpflichtigen Dienstes in 39 Zeilen Python-Code</a></li>
<li><a href="../de420515/index.html">Diarisierung basierend auf dem GMM-UBM-Modell und dem MAP-Anpassungsalgorithmus</a></li>
<li><a href="../de420517/index.html">FPGA Integer FFT-Implementierung</a></li>
<li><a href="../de420519/index.html">Popularisierung der Wissenschaft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>