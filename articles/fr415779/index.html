<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèª üïµüèæ ü§† Mise en place d'une plateforme logicielle NAS s√©curis√©e ü•å üÜí üìó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans un article pr√©c√©dent , la conception de la plate-forme logicielle NAS a √©t√© d√©crite. 
 Il est temps de le mettre en ≈ìuvre. 
 V√©rifier 


 Assurez...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mise en place d'une plateforme logicielle NAS s√©curis√©e</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415779/"><p><img src="https://habrastorage.org/getpro/habr/post_images/b93/ed1/af9/b93ed1af987a1fda471d1080d6b804e5.jpg"></p><br><p>  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent</a> , la conception de la plate-forme logicielle NAS a √©t√© d√©crite. <br>  Il est temps de le mettre en ≈ìuvre. </p><a name="habracut"></a><br><h2 id="proverka">  V√©rifier </h2><br><p>  Assurez-vous de v√©rifier la sant√© de la piscine avant de commencer: </p><br><pre><code class="hljs lua">zpool <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> -v</code> </pre> <br><p>  Le pool et tous les disques qu'il contient doivent √™tre EN LIGNE. </p><br><p>  De plus, je suppose qu'√† l'√©tape pr√©c√©dente, tout a √©t√© fait selon les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions</a> , et cela fonctionne, ou vous-m√™me comprenez bien ce que vous faites. </p><br><h2 id="udobstva">  Commodit√©s </h2><br><p>  Tout d'abord, cela vaut la peine de prendre soin d'une gestion pratique si vous ne l'avez pas fait d√®s le d√©but. <br>  Il faudra: </p><br><ul><li>  Serveur SSH: <code>apt-get install openssh-server</code> .  Si vous ne savez pas comment configurer SSH, <del>  faire NAS sur Linux est trop t√¥t </del>  Vous pouvez lire les caract√©ristiques de son utilisation dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> , puis utiliser l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un des manuels</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tmux</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©cran</a> : <code>apt-get install tmux</code> .  Pour enregistrer la session lors de la connexion via SSH et utiliser plusieurs fen√™tres. </li></ul><br><p>  Apr√®s avoir install√© SSH, vous devez ajouter un utilisateur afin de ne pas vous connecter via SSH en tant que root (l'entr√©e est d√©sactiv√©e par d√©faut et vous n'avez pas besoin de l'activer): </p><br><pre> <code class="bash hljs">zfs create rpool/home/user adduser user cp -a /etc/skel/.[!.]* /home/user chown -R user:user /home/user</code> </pre> <br><p>  Pour l'administration √† distance, c'est un minimum suffisant. </p><br><p>  N√©anmoins, alors que vous devez garder le clavier et le moniteur connect√©s, comme  vous devrez √©galement red√©marrer lors de la mise √† jour du noyau et afin de vous assurer que tout fonctionne imm√©diatement apr√®s le chargement. </p><br><p>  Une alternative consiste √† utiliser Virtual KVM, qui fournit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">IME</a> .  Il y a une console l√†-bas, bien que dans mon cas, elle soit impl√©ment√©e comme une applet Java, ce qui n'est pas tr√®s pratique. </p><br><h2 id="nastroyka">  Personnalisation </h2><br><h3 id="podgotovka-kesha">  Pr√©paration du cache </h3><br><p>  Pour autant que vous vous en souvenez, dans la configuration d√©crite par moi, il y a un SSD s√©par√© sous L2ARC, qui n'est pas encore utilis√©, mais pris "pour la croissance". </p><br><p>  Facultatif, mais il est conseill√© de remplir ce SSD avec des donn√©es al√©atoires (dans le cas de Samsung EVO, il sera toujours rempli de z√©ros apr√®s l'ex√©cution de blkdiscard, mais pas sur tous les SSD comme celui-ci): </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/dev/disk/by-id/ata-Samsung_SSD_850_EVO bs=4M &amp;&amp; blkdiscard /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><h3 id="otklyuchenie-szhatiya-logov">  D√©sactiver la compression des journaux </h3><br><p>  Sur ZFS, la compression est d√©j√† utilis√©e, car la compression des journaux via gzip sera clairement superflue. <br>  D√©sactiver: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/logrotate.d/* ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> grep -Eq <span class="hljs-string"><span class="hljs-string">"(^|[^#y])compress"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> sed -i -r <span class="hljs-string"><span class="hljs-string">"s/(^|[^#y])(compress)/\1#\2/"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><h3 id="obnovlenie-sistemy">  Mise √† jour du syst√®me </h3><br><p>  Ici, tout est simple: </p><br><pre> <code class="bash hljs">apt-get dist-upgrade --yes reboot</code> </pre> <br><h3 id="sozdanie-snepshota-dlya-novogo-sostoyaniya">  Cr√©ation d'un instantan√© pour un nouvel √©tat </h3><br><p>  Apr√®s le red√©marrage, afin de corriger le nouvel √©tat de fonctionnement, vous devez r√©√©crire le premier instantan√©: </p><br><pre> <code class="bash hljs">zfs destroy rpool/ROOT/debian@install zfs snapshot rpool/ROOT/debian@install</code> </pre> <br><h2>  Organisation du syst√®me de fichiers </h2><br><h3 id="podgotovka-razdelov-dlya-slog">  Partitionnement pour SLOG </h3><br><p>  La premi√®re chose √† faire pour obtenir des performances ZFS normales est de mettre SLOG sur le SSD. <br>  Permettez-moi de vous rappeler que SLOG dans la configuration utilis√©e est dupliqu√© sur deux SSD: pour cela, les p√©riph√©riques sur LUKS-XTS seront cr√©√©s en haut de la 4√®me section de chaque SSD: </p><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/urandom of=/etc/keys/slog.key bs=1 count=4096 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 cryptsetup --verbose --cipher <span class="hljs-string"><span class="hljs-string">"aes-xts-plain64:sha512"</span></span> --key-size 512 --key-file /etc/keys/slog.key luksFormat /dev/disk/by-id/ata-Micron_1100-part4 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt1 /dev/disk/by-id/ata-Samsung_SSD_850_PRO-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"slog0_crypt2 /dev/disk/by-id/ata-Micron_1100-part4 /etc/keys/slog.key luks,discard"</span></span> &gt;&gt; /etc/crypttab</code> </pre> <br><h3 id="podgotovka-razdelov-dlya-l2arc-i-podkachki">  Partitionnement pour L2ARC et Swap </h3><br><p>  Vous devez d'abord cr√©er des partitions sous swap et l2arc: </p><br><pre> <code class="bash hljs">sgdisk -n1:0:48G -t1:8200 -c1:part_swap -n2::196G -t2:8200 -c2:part_l2arc /dev/disk/by-id/ata-Samsung_SSD_850_EVO</code> </pre> <br><p>  La partition de swap et L2ARC seront chiffr√©s sur une cl√© al√©atoire, comme  apr√®s un red√©marrage, ils ne sont pas n√©cessaires et il est toujours possible de les recr√©er. <br>  Par cons√©quent, dans crypttab, une ligne est √©crite pour chiffrer / d√©chiffrer les partitions en mode clair: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> swap_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part1 /dev/urandom swap,cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> l2arc_crypt /dev/disk/by-id/ata-Samsung_SSD_850_EVO-part2 /dev/urandom cipher=aes-xts-plain64:sha512,size=512 &gt;&gt; /etc/crypttab</code> </pre> <br><p>  Ensuite, vous devez red√©marrer les d√©mons et activer l'√©change: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'vm.swappiness = 10'</span></span> &gt;&gt; /etc/sysctl.conf sysctl vm.swappiness=10 systemctl daemon-reload systemctl start systemd-cryptsetup@swap_crypt.service <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /dev/mapper/swap_crypt none swap sw,discard 0 0 &gt;&gt; /etc/fstab swapon -av</code> </pre> <br><p>  Parce que  <code>swapiness</code> n'est pas activement utilis√© sur le SSD; le param√®tre <code>swapiness</code> , qui est 60 par d√©faut, doit √™tre d√©fini sur 10. </p><br><p>  L2ARC n'est pas encore utilis√© √† ce stade, mais la section correspondante est d√©j√† pr√™te: </p><br><pre> <code class="bash hljs">$ ls /dev/mapper/ control l2arc_crypt root_crypt1 root_crypt2 slog0_crypt1 slog0_crypt2 swap_crypt tank0_crypt0 tank0_crypt1 tank0_crypt2 tank0_crypt3</code> </pre> <br><h3 id="puly-tankn">  R√©servoir de piscinesN </h3><br><p>  La cr√©ation du pool <code>tank0</code> sera d√©crite, <code>tank1</code> est cr√©√© par analogie. </p><br><p>  Afin de ne pas cr√©er manuellement les m√™mes partitions et d'√©viter les erreurs, j'ai √©crit un <a href="">script</a> pour cr√©er des partitions chiffr√©es pour les pools: </p><br><div class="spoiler">  <b class="spoiler_title">create_crypt_pool.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash KEY_SIZE=512 POOL_NAME="$1" KEY_FILE="/etc/keys/${POOL_NAME}.key" LUKS_PARAMS="--verbose --cipher aes-xts-plain64:sha${KEY_SIZE} --key-size $KEY_SIZE" [ -z "$1" ] &amp;&amp; { echo "Error: pool name empty!" ; exit 1; } shift [ -z "$*" ] &amp;&amp; { echo "Error: devices list empty!" ; exit 1; } echo "Devices: $*" read -p "Is it ok? " a [ "$a" != "y" ] &amp;&amp; { echo "Bye"; exit 1; } dd if=/dev/urandom of=$KEY_FILE bs=1 count=4096 phrase="?" read -s -p "Password: " phrase echo read -s -p "Repeat password: " phrase1 echo [ "$phrase" != "$phrase1" ] &amp;&amp; { echo "Error: passwords is not equal!" ; exit 1; } echo "### $POOL_NAME" &gt;&gt; /etc/crypttab index=0 for i in $*; do echo "$phrase"|cryptsetup $LUKS_PARAMS luksFormat "$i" || exit 1 echo "$phrase"|cryptsetup luksAddKey "$i" $KEY_FILE || exit 1 dev_name="${POOL_NAME}_crypt${index}" echo "${dev_name} $i $KEY_FILE luks" &gt;&gt; /etc/crypttab cryptsetup luksOpen --key-file $KEY_FILE "$i" "$dev_name" || exit 1 index=$((index + 1)) done echo "###" &gt;&gt; /etc/crypttab phrase="=====================================================" phrase1="=================================================" unset phrase unset phrase1</span></span></code> </pre> </div></div><br><p>  Maintenant, en utilisant ce script, vous devez cr√©er un pool pour stocker des donn√©es: </p><br><pre> <code class="bash hljs">./create_crypt_pool.sh zpool create -o ashift=12 -O atime=off -O compression=lz4 -O normalization=formD tank0 raidz1 /dev/disk/by-id/dm-name-tank0_crypt*</code> </pre> <br><p>  Pour des notes sur le param√®tre <code>ashift=12</code> , voir mes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">articles</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©c√©dents</a> et commentaires √† leur sujet. </p><br><p>  Apr√®s avoir cr√©√© le pool, j'ai mis son journal sur le SSD: </p><br><pre> <code class="bash hljs">zpool add tank0 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> mirror /dev/disk/by-id/dm-name-slog0_crypt1 /dev/disk/by-id/dm-name-slog0_crypt2</code> </pre> <br><p>  √Ä l'avenir, avec OMV install√© et configur√©, il sera possible de cr√©er des pools via l'interface graphique: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bu/bc/qj/bubcqjn_frfc3plifb9ehgzxco0.png" alt="La cr√©ation de ZFS est tomb√©e dans l'interface graphique Web OMV"></a> </p><br><h3 id="vklyuchenie-importa-pulov-i-avtomontirovaniya-tomov-pri-zagruzke">  Activation de l'importation de pool et des volumes de montage automatique au d√©marrage </h3><br><p>  Afin de garantir l'activation des pools de montage automatique, ex√©cutez les commandes suivantes: </p><br><pre> <code class="bash hljs">rm /etc/zfs/zpool.cache systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-scan.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-mount.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zfs-import-cache.service</code> </pre> <br><p>  √Ä ce stade, la configuration du sous-syst√®me de disque est termin√©e. </p><br><h2>  Syst√®me d'exploitation </h2><br><p>  La premi√®re √©tape consiste √† installer et configurer OMV afin d'obtenir enfin une sorte de fondation pour le NAS. </p><br><h3 id="ustanovka-omv">  Installer OMV </h3><br><p>  OMV sera install√© en tant que package deb.  Pour ce faire, il est possible d'utiliser les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions officielles</a> . </p><br><p>  Le script <code>add_repo.sh</code> ajoute le r√©f√©rentiel OMV Arrakis √† <code>/etc/apt/ sources.list.d</code> afin que le syst√®me de traitement par lots voit le r√©f√©rentiel. </p><br><div class="spoiler">  <b class="spoiler_title">add_repo.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">cat &lt;&lt;EOF &gt;&gt; /etc/apt/sources.list.d/openmediavault.list deb http://packages.openmediavault.org/public arrakis main <span class="hljs-comment"><span class="hljs-comment"># deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis main ## Uncomment the following line to add software from the proposed repository. # deb http://packages.openmediavault.org/public arrakis-proposed main # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis-proposed main ## This software is not part of OpenMediaVault, but is offered by third-party ## developers as a service to OpenMediaVault users. deb http://packages.openmediavault.org/public arrakis partner # deb http://downloads.sourceforge.net/project/openmediavault/packages arrakis partner EOF</span></span></code> </pre> </div></div><br><p>  Veuillez noter que par rapport √† l'original, le r√©f√©rentiel partenaire est inclus. </p><br><p>  Pour installer et initialiser, vous devez ex√©cuter les commandes ci-dessous. </p><br><div class="spoiler">  <b class="spoiler_title">Commandes d'installation d'OMV.</b> <div class="spoiler_text"><pre> <code class="bash hljs">./add_repo.sh <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LANG=C <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DEBIAN_FRONTEND=noninteractive <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> APT_LISTCHANGES_FRONTEND=none apt-get update apt-get --allow-unauthenticated install openmediavault-keyring apt-get update apt-get --yes --auto-remove --show-upgraded \ --allow-downgrades --allow-change-held-packages \ --no-install-recommends \ --option Dpkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confdef"</span></span> \ --option DPkg::Options::=<span class="hljs-string"><span class="hljs-string">"--force-confold"</span></span> \ install postfix openmediavault <span class="hljs-comment"><span class="hljs-comment"># Initialize the system and database. omv-initsystem</span></span></code> </pre> </div></div><br><p>  OMV install√©.  Il utilise son propre noyau, et apr√®s l'installation, un red√©marrage peut √™tre n√©cessaire. </p><br><p>  Apr√®s le red√©marrage, l'interface OpenMediaVault sera disponible sur le port 80 (acc√©dez au navigateur du NAS par adresse IP): </p><br><p> <a href=""><img src="https://habrastorage.org/webt/eo/sf/ra/eosfraeilpg2dn770ef5bvr-ple.png"></a> </p><br><p>  Le nom d'utilisateur / mot de passe par d√©faut est <code>admin/openmediavault</code> . </p><br><h3 id="nastroyka-omv">  Configurer OMV </h3><br><p>  De plus, la majeure partie de la configuration passera par l'interface Web. </p><br><h4 id="ustanovka-bezopasnogo-soedineniya">  √âtablir une connexion s√©curis√©e </h4><br><p>  Vous devez maintenant changer le mot de passe de l'administrateur WEB et g√©n√©rer un certificat pour le NAS afin de travailler sur HTTPS √† l'avenir. </p><br><p>  Le mot de passe est modifi√© dans l'onglet <em>"Syst√®me-&gt; Param√®tres g√©n√©raux-&gt; Mot de passe administrateur Web"</em> . <br>  Pour g√©n√©rer un certificat sur l'onglet <em>"Syst√®me-&gt; Certificats-&gt; SSL",</em> s√©lectionnez <em>"Ajouter-&gt; Cr√©er"</em> . </p><br><p>  Le certificat cr√©√© sera visible sur le m√™me onglet: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ld/6j/_m/ld6j_mgp4tx6auirzlkfnwium2c.png" alt="Attestation"></a> </p><br><p>  Apr√®s avoir cr√©√© le certificat, dans l' <em>onglet "Syst√®me-&gt; Param√®tres g√©n√©raux",</em> cochez la <em>case "Activer SSL / TLS"</em> . </p><br><p>  Un certificat sera requis avant la fin de la configuration.  La version finale utilisera un certificat sign√© pour contacter OMV. </p><br><p>  Vous devez maintenant vous connecter √† OMV, au port 443, ou simplement attribuer le pr√©fixe <code>https://</code> √† IP dans le navigateur. </p><br><p>  Si vous avez r√©ussi √† vous connecter, dans l'onglet <em>"Syst√®me-&gt; Param√®tres g√©n√©raux",</em> vous devez activer la case √† cocher "Forcer SSL / TLS". </p><br><p>  <strong>Modifiez les ports 80 et 443 en 10080 et 10443</strong> . <br>  Et essayez de vous connecter √† l'adresse suivante: <code>https://IP_NAS:10443</code> . <br>  La modification des ports est importante car les ports 80 et 443 utiliseront le conteneur Docker avec nginx-reverse-proxy. </p><br><h3 id="pervichnye-nastroyki">  Param√®tres principaux </h3><br><p>  Les param√®tres minimum qui doivent √™tre effectu√©s en premier: </p><br><ul><li>  Dans l'onglet <em>"Syst√®me-&gt; Date et heure",</em> v√©rifiez la valeur du fuseau horaire et d√©finissez le serveur NTP. </li><li>  Dans l'onglet <em>"Syst√®me-&gt; Surveillance",</em> activez la collecte des statistiques de performances. </li><li>  Sur l'onglet <em>"Syst√®me-&gt; Gestion de l'√©nergie", il</em> vaut probablement la peine de d√©sactiver la "Surveillance" pour qu'OMV n'essaye pas de contr√¥ler les ventilateurs. </li></ul><br><h3 id="set">  R√©seau </h3><br><p>  Si la deuxi√®me interface r√©seau NAS n'est pas encore connect√©e, connectez-la au routeur. </p><br><p>  Ensuite: </p><br><ul><li>  Dans l' <em>onglet "Syst√®me-&gt; R√©seau",</em> d√©finissez le nom d'h√¥te sur "nas" (ou ce que vous voulez). </li><li>  Configurez la liaison pour les interfaces comme indiqu√© dans la figure ci-dessous: <em>"Syst√®me-&gt; R√©seau-&gt; Interfaces-&gt; Ajouter-&gt; Lien"</em> . </li><li>  Ajoutez les r√®gles de pare-feu n√©cessaires sur l'onglet <em>"Syst√®me-&gt; R√©seau-&gt; Pare-feu"</em> .  Tout d'abord, l'acc√®s aux ports 10443, 10080, 443, 80, 22 pour SSH et l'autorisation de recevoir / envoyer ICMP sont suffisants. </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/rb/fi/ab/rbfiabiimceoohildwosfu_egju.png" alt="Configuration de liaison"></a> </p><br><p>  En cons√©quence, les interfaces de liaison devraient appara√Ætre, que le routeur verra comme une interface et lui attribuera une adresse IP: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ag/wr/y8/agwry8ynozq7dhgov16pzzwmrs0.png" alt="Interfaces de liaison"></a> </p><br><p>  Si vous le souhaitez, il est possible de configurer en plus SSH √† partir de l'interface graphique Web: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yk/oa/i4/ykoai4l9risd46whpuutbnyi1um.png" alt="Configuration ssh"></a> </p><br><h3 id="repozitorii-i-moduli">  R√©f√©rentiels et modules </h3><br><p>  Dans l'onglet <em>"Syst√®me-&gt; Gestion des mises √† jour-&gt; Param√®tres",</em> activez <em>"Mises √† jour prises en charge par la communaut√©"</em> . </p><br><p>  Tout d'abord, ajoutez des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiels OMV extras</a> . <br>  Cela peut √™tre fait simplement en installant le plugin ou le package, comme indiqu√© sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forum</a> . </p><br><p>  Sur la page <em>"Syst√®me-&gt; Plugins"</em> vous devez trouver le plugin "openmediavault-omvextrasorg" et l'installer. </p><br><p>  En cons√©quence, l'ic√¥ne "OMV-Extras" appara√Ætra dans le menu syst√®me (elle peut √™tre vue dans les captures d'√©cran). </p><br><p>  Allez-y et activez les r√©f√©rentiels suivants: </p><br><ul><li>  OMV-Extras.org.  Un r√©f√©rentiel stable contenant de nombreux plugins. </li><li>  Tests OMV-Extras.org.  Certains plugins de ce r√©f√©rentiel ne sont pas dans le r√©f√©rentiel stable. </li><li>  Docker CE.  En fait, Docker. </li></ul><br><p>  Dans l'onglet <em>"System-&gt; OMV Extras-&gt; Kernel",</em> vous pouvez s√©lectionner le noyau dont vous avez besoin, y compris le noyau de Proxmox (je ne l'ai pas install√© moi-m√™me, car je n'en ai pas encore besoin, donc je ne le recommande pas): </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dq/se/jq/dqsejqlsyn0x6wdbyfeb2kvlwmc.png"></a> </p><br><p>  Installez les plugins n√©cessaires ( <strong>gras</strong> absolument n√©cessaire, <em>en italique</em> - facultatif, que je n'ai pas install√©): </p><br><div class="spoiler">  <b class="spoiler_title">Liste des plugins.</b> <div class="spoiler_text"><ul><li>  openmediavault-apttool.  GUI minimum pour travailler avec un syst√®me batch.  Ajoute <em>"Services-&gt; Apttool"</em> . </li><li>  openmediavault-anacron.  Ajoute la possibilit√© de travailler √† partir de l'interface graphique avec un planificateur asynchrone.  Ajoute <em>"Syst√®me-&gt; Anacron"</em> . </li><li>  openmediavault-backup.  Fournit un syst√®me de sauvegarde dans le stockage.  Ajoute une page <em>"Syst√®me-&gt; Sauvegarde"</em> . </li><li>  openmediavault-diskstats.  N√©cessaire pour collecter des statistiques sur les performances du disque. </li><li>  <em>openmediavault-dnsmasq</em> .  Vous permet d'augmenter le serveur DNS et DHCP sur le NAS.  Parce que je le fais sur un routeur, je n'en ai pas besoin. </li><li>  <strong>openmediavault-docker-gui</strong> .  Interface de gestion des conteneurs Docker.  Ajoute <em>"Services-&gt; Docker"</em> . </li><li>  <strong>openmediavault-ldap</strong> .  Prise en charge de l'authentification via LDAP.  Ajoute <em>"Gestion des droits -&gt; Service d'annuaire"</em> . </li><li>  <em>openmediavault-letsencrypt</em> .  Prise en charge de Let's Encrypt √† partir de l'interface graphique.  Il n'est pas n√©cessaire, car il utilise l'incorporation dans le conteneur nginx-reverse-proxy. </li><li>  <strong>openmediavault-luksencryption</strong> .  Prise en charge du cryptage LUKS.  Il est n√©cessaire que les disques chiffr√©s soient visibles dans l'interface OMV.  Ajoute <em>"Stockage-&gt; Cryptage"</em> . </li><li>  <strong>√©crou openmediavault</strong> .  Prise en charge UPS.  Ajoute <em>"Services-&gt; UPS"</em> . </li><li>  <strong>openmediavault-omvextrasorg</strong> .  OMV Extras doit d√©j√† √™tre install√©. </li><li>  openmediavault-resetperms.  Vous permet de r√©initialiser les autorisations et de r√©initialiser les listes de contr√¥le d'acc√®s sur les r√©pertoires partag√©s.  Ajoute <em>"Contr√¥le d'acc√®s -&gt; R√©pertoires g√©n√©raux -&gt; R√©initialiser les autorisations"</em> . </li><li>  openmediavault-route.  Plugin utile pour la gestion du routage.  Ajoute <em>"Syst√®me-&gt; R√©seau-&gt; Route statique"</em> . </li><li>  openmediavault-symlinks.  Offre la possibilit√© de cr√©er des liens symboliques.  Ajoute la page <em>"Services-&gt; Liens symboliques"</em> . </li><li>  openmediavault-unionfilesystems.  Prise en charge d'UnionFS.  Cela peut √™tre utile √† l'avenir, bien que le docker utilise ZFS comme backend.  Ajoute <em>"Storage-&gt; Union Filesystems"</em> . </li><li>  <em>openmediavault-virtualbox</em> .  Il peut √™tre utilis√© pour int√©grer des capacit√©s de gestion de machine virtuelle dans l'interface graphique. </li><li>  <strong>openmediavault-zfs</strong> .  Le plugin ajoute le support ZFS √† OpenMediaVault.  Apr√®s l'installation, la page <em>"Stockage-&gt; ZFS"</em> appara√Ætra. </li></ul></div></div><br><h3 id="diski">  Disques </h3><br><p>  Tous les disques qui sont dans le syst√®me doivent √™tre visibles OMV.  Assurez-vous de cela en regardant l' <em>onglet "Stockage-&gt; Disques"</em> .  Si tous les disques ne sont pas visibles, lancez une analyse. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ju/i3/rs/jui3rsmgmatghluwuk0rknsqfrq.png" alt="Disques dans le syst√®me"></a> </p><br><p>  L√†, sur tous les disques durs, la mise en cache d'√©criture doit √™tre activ√©e (en cliquant sur un disque dans la liste et en cliquant sur le bouton "Modifier"). </p><br><p>  Assurez-vous que toutes les sections chiffr√©es sont visibles sur l' <em>onglet "Stockage-&gt; Chiffrement"</em> : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dy/nw/kv/dynwkvuhbnglzeqe3sin_vqda7i.png" alt="Cloisons chiffr√©es"></a> </p><br><p>  Il est maintenant temps de configurer SMART, indiqu√© comme un moyen d'augmenter la fiabilit√©: </p><br><ul><li>  Acc√©dez √† l' <em>onglet "Stockage-&gt; SMART-&gt; Param√®tres"</em> .  Allumez SMART. </li><li>  Au m√™me endroit, s√©lectionnez les valeurs des niveaux de temp√©rature des disques (critiques, g√©n√©ralement 60 C, et le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©gime de temp√©rature optimal du disque</a> 15-45 C). </li><li>  Acc√©dez √† l' <em>onglet "Stockage-&gt; SMART-&gt; Appareils"</em> .  Activez la surveillance pour chaque lecteur. <br> <a href=""><img src="https://habrastorage.org/webt/83/r-/dc/83r-dcwtrhth5icaketuw1zlis8.png"></a> </li><li>  Acc√©dez √† l' <em>onglet "Stockage-&gt; SMART-&gt; Tests planifi√©s"</em> .  Ajoutez un court auto-test une fois par jour pour chaque disque et un long auto-test une fois par mois.  De plus, afin que les p√©riodes d'auto-test ne se chevauchent pas. <br> <a href=""><img src="https://habrastorage.org/webt/lh/u8/qf/lhu8qffcenb8utgcekfoy_j0oee.png"></a> </li></ul><br><p>  Sur ce point, la configuration du disque peut √™tre consid√©r√©e comme termin√©e. </p><br><h3 id="faylovye-sistemy-i-obschie-katalogi">  Syst√®mes de fichiers et r√©pertoires partag√©s </h3><br><p>  Vous devez cr√©er des syst√®mes de fichiers pour des r√©pertoires pr√©d√©finis. <br>  Cela peut √™tre fait depuis la console ou depuis l'interface WEB OMV ( <em>Stockage-&gt; ZFS-&gt; S√©lectionner le r√©servoir de la piscine0-&gt; Bouton Ajouter -&gt; Syst√®me de fichiers</em> ). </p><br><div class="spoiler">  <b class="spoiler_title">Commandes de cr√©ation de FS.</b> <div class="spoiler_text"><pre> <code class="hljs sql">zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/books zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/music zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/pictures zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/downloads zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -o compression=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> -o utf8only=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -o normalization=formD -p tank0/<span class="hljs-keyword"><span class="hljs-keyword">user_data</span></span>/videos</code> </pre> </div></div><br><p>  Le r√©sultat doit √™tre la structure de r√©pertoires suivante: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ua/uy/yk/uauyykwki2nmmmpj6pe3-lqxrie.png"></a> </p><br><p>  Apr√®s cela, ajoutez les FS cr√©√©s en tant que r√©pertoires partag√©s sur la page <em>"Gestion des droits d'acc√®s-&gt; R√©pertoires g√©n√©raux-&gt; Ajouter"</em> . <br>  Veuillez noter que le param√®tre <em>"Device"</em> est √©gal au chemin d'acc√®s au syst√®me de fichiers cr√©√© dans ZFS, et le param√®tre <em>"Path"</em> pour tous les r√©pertoires est "/". </p><br><p> <a href=""><img src="https://habrastorage.org/webt/xc/9v/da/xc9vdaubqewzyhqfm80k_751fo8.png"></a> </p><br><h3 id="rezervnoe-kopirovanie">  Sauvegarde </h3><br><p>  La sauvegarde se fait par deux outils: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Plugin de sauvegarde OMV</a> .  Plugin OMV pour la sauvegarde du syst√®me. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">zfs-auto-snapshot</a> .  Un script pour cr√©er automatiquement des instantan√©s ZFS selon un calendrier et supprimer les anciens. </li></ul><br><p>  Si vous utilisez le plugin, vous obtenez tr√®s probablement une erreur: </p><br><pre> <code class="hljs vhdl">lsblk: /dev/<span class="hljs-keyword"><span class="hljs-keyword">block</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> device</code> </pre> <br><p>  Pour y rem√©dier, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comme l'ont not√© les d√©veloppeurs OMV</a> dans cette "configuration tr√®s non standard", il serait possible de refuser le plugin et d'utiliser les outils ZFS sous forme d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>zfs send/receive</code></a> . <br>  Ou, sp√©cifiez explicitement le param√®tre ¬´p√©riph√©rique racine¬ª sous la forme d'un p√©riph√©rique physique √† partir duquel le t√©l√©chargement est effectu√©. <br>  Il est plus pratique pour moi d'utiliser le plugin et de sauvegarder le syst√®me d'exploitation √† partir de l'interface, au lieu de cadrer quelque chose de moi-m√™me avec zfs send, donc je pr√©f√®re la deuxi√®me option. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/q8/hm/k9/q8hmk9guerk2it7d1xe4tuzvtak.png" alt="Configuration de sauvegarde"></a> </p><br><p>  Pour que la sauvegarde fonctionne, cr√©ez d'abord le syst√®me de fichiers <code>tank0/apps/backup</code> via ZFS, puis dans le <em>menu "Syst√®me-&gt; Sauvegarde",</em> cliquez sur "+" dans le champ de param√®tre <em>"Dossier public"</em> et ajoutez le p√©riph√©rique cr√©√© comme cible et le champ <em>"Chemin"</em> r√©gl√© sur "/". </p><br><p>  Il y a aussi des probl√®mes avec zfs-auto-snapshot.  Si elle n'est pas configur√©e, elle prendra des photos toutes les heures, tous les jours, toutes les semaines, tous les mois pendant un an. <br>  Le r√©sultat est ce qui est dans la capture d'√©cran: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/af/_j/gw/af_jgw_evodbuhm07iqwpjh-he8.png" alt="Beaucoup de spam provenant de zfs-auto-snapshot"></a> </p><br><p>  Si vous l'avez d√©j√† rencontr√©, ex√©cutez le code suivant pour supprimer les instantan√©s automatiques: </p><br><pre> <code class="hljs powershell">zfs list <span class="hljs-literal"><span class="hljs-literal">-t</span></span> snapshot <span class="hljs-literal"><span class="hljs-literal">-o</span></span> name <span class="hljs-literal"><span class="hljs-literal">-S</span></span> creation | grep <span class="hljs-string"><span class="hljs-string">"@zfs-auto-snap"</span></span> | tail <span class="hljs-literal"><span class="hljs-literal">-n</span></span> +<span class="hljs-number"><span class="hljs-number">1500</span></span> | xargs <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> zfs destroy <span class="hljs-literal"><span class="hljs-literal">-vr</span></span></code> </pre> <br><p>  Configurez ensuite zfs-auto-snapshot pour qu'il s'ex√©cute dans cron. <br>  Pour commencer, supprimez simplement <code>/etc/cron.hourly/zfs-auto-snapshot</code> si vous n'avez pas besoin de prendre des photos toutes les heures. </p><br><h3 id="e-mail-uvedomleniya">  Notifications par e-mail </h3><br><p>  La notification par e-mail a √©t√© indiqu√©e comme l'un des moyens d'assurer la fiabilit√©. <br>  Par cons√©quent, vous devez maintenant configurer la notification par e-mail. <br>  Pour ce faire, enregistrez une bo√Æte sur l'un des serveurs publics (enfin, ou configurez le serveur SMTP vous-m√™me, si vous avez vraiment des raisons de le faire). </p><br><p>  Ensuite, vous devez vous rendre sur la page <em>"Syst√®me-&gt; Notification"</em> et saisir: </p><br><ul><li>  Adresse du serveur SMTP. </li><li>  Port du serveur SMTP. </li><li>  Identifiant </li><li>  Adresse de l'exp√©diteur (g√©n√©ralement, le premier composant de l'adresse correspond au nom). </li><li>  Mot de passe utilisateur </li><li>  Dans le champ "Destinataire", votre adresse habituelle √† laquelle le NAS enverra des notifications. </li></ul><br><p>  Il est fortement conseill√© d'activer SSL / TLS. </p><br><p>  Un exemple de configuration pour Yandex est illustr√© dans la capture d'√©cran: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/4j/pb/2m/4jpb2mwgystnu_3yc9vf9l16soo.png" alt="Notifications par e-mail"></a> </p><br><h2 id="nastroyka-seti-vne-nas">  Configuration du r√©seau en dehors du NAS </h2><br><h3 id="ip-adres">  Adresse IP </h3><br><p>  J'utilise une adresse IP statique blanche, qui co√ªte plus 100 roubles par mois.  Si vous ne souhaitez pas payer et que votre adresse est dynamique, mais pas pour NAT, il est possible d'ajuster les enregistrements DNS externes via l'API du service s√©lectionn√©. <br>  N√©anmoins, il convient de garder √† l'esprit qu'une adresse non NAT peut soudainement devenir une adresse NAT: en r√®gle g√©n√©rale, les fournisseurs ne donnent aucune garantie. </p><br><h3 id="router">  Routeur </h3><br><p>  En tant que routeur, j'ai un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mikrotik RouterBoard</a> , similaire √† celui de l'image ci-dessous. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ni/mv/a8/nimva8ju1vg2doqcnwd7s0_xcmw.jpeg" alt="Carte m√®re Mikrotik"></a> </p><br><p>  Trois choses sont requises sur le routeur: </p><br><ul><li>  Configurez des adresses statiques pour le NAS.  Dans mon cas, les adresses sont √©mises via DHCP, et je dois m'assurer que les adaptateurs avec une adresse MAC sp√©cifique obtiennent toujours la m√™me adresse IP.  Dans RouterOS, cela se fait sur l' <em>onglet "IP-&gt; Serveur DHCP"</em> avec le bouton <em>"Rendre statique"</em> . </li><li>  Configurez le serveur DNS afin que pour le nom "nas", ainsi que les noms se terminant par ".nas" et ".NAS.cloudns.cc" (o√π "NAS" est la zone sur ClouDNS ou un service similaire), il donne le syst√®me IP.  O√π faire cela dans RouterOS est indiqu√© dans la capture d'√©cran ci-dessous.  Dans mon cas, cela est impl√©ment√© en faisant correspondre le nom avec une expression r√©guli√®re: " <code>^.*\.nas$|^nas$|^.*\.NAS.cloudns.cc$</code> " </li><li>  Configurez la redirection de port.  Dans RouterOS, cela se fait sur l' <em>onglet "IP-&gt; Pare-feu"</em> , je ne m'attarderai pas l√†-dessus. </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/wu/2d/3n/wu2d3ng2xlqaleslb__9a72vtpo.png" alt="Configurateur DNS dans RouterOS"></a> </p><br><h3 id="cloudns">  ClouDNS </h3><br><p>  CLouDNS est simple.  Cr√©ez un compte, confirmez.  Les enregistrements NS seront d√©j√† enregistr√©s aupr√®s de vous.  Ensuite, une configuration minimale est requise. </p><br><p>  Tout d'abord, vous devez cr√©er les zones n√©cessaires (la zone portant le nom NAS surlign√©e en rouge dans la capture d'√©cran est ce que vous devez cr√©er avec un nom diff√©rent, bien s√ªr). </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/3k/0u/wj3k0ueaouj9tdslhubqtdz49os.png" alt="Cr√©ation d'une zone dans ClouDNS"></a> </p><br><p>  Deuxi√®mement, dans cette zone, vous devez enregistrer les enregistrements <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">A</a> suivants: </p><br><ul><li>  <strong>nas</strong> , <strong>www</strong> , <strong>omv</strong> , <strong>control</strong> et un <strong>nom vide</strong> .  Pour acc√©der √† l'interface OMV. </li><li>  <strong>ldap</strong> .  Interface PhpLdapAdmin </li><li>  <strong>ssp</strong> .  Interface pour changer les mots de passe des utilisateurs. </li><li>  <strong>test</strong> .  Serveur de test. </li></ul><br><p>  Les noms de domaine restants seront ajout√©s √† mesure que les services seront ajout√©s. <br>  Cliquez sur la zone, puis sur <em>"Ajouter un nouvel enregistrement"</em> , s√©lectionnez le type A, entrez le nom de la zone et l'adresse IP du routeur derri√®re lequel se trouve le NAS. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ym/9o/s2/ym9os2upazemboftovtmasp3h1u.png" alt="Ajout des enregistrements a"></a> </p><br><p>  Deuxi√®mement, vous devez acc√©der √† l'API.  Dans ClouDNS, il est pay√©, vous devez donc d'abord le payer.  Dans d'autres services, c'est gratuit.  Si vous savez ce qui est le mieux et que cela est pris en charge par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lexicon</a> , veuillez √©crire dans les commentaires. </p><br><p>  Apr√®s avoir acc√©d√© √† l'API, vous devez y ajouter un nouvel utilisateur d'API. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ah/tc/rp/ahtcrpidjt3gvlnuc-udwjj0no8.png" alt="Ajout d'un utilisateur API ClouDNS"></a> </p><br><p>   <em>"IP address"</em>   IP :  ,     API.  ,    ,    API,   <strong>auth-id</strong>  <strong>auth-password</strong> .      Lexicon,  . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/z_/6k/yv/z_6kyvkyj9gqlbi_s-dudfoirzs.png"></a> </p><br><p>    ClouDNS . </p><br><h2>   </h2><br><h3 id="nastroyka-docker">  Docker </h3><br><p>     openmediavault-docker-gui,  docker-ce      . </p><br><p> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docker-compose</a> ,         : </p><br><pre> <code class="bash hljs">apt-get install docker-compose</code> </pre> <br><p>       : </p><br><pre> <code class="bash hljs">zfs create -p /tank0/docker/services</code> </pre> <br><p>  ,       <code>/var/lib/docker</code> .     ( ,   SSD),  ,  ,         . </p><br><p> ..,              <br>   .   . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wn/by/ec/wnbyecyxrlrsf0cssx78zqmoxdu.png"></a> </p><br><p>   ,         . <br>       ,      GUI ,    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    </a> , ..       ,     . </p><br><p>        <code>/var/lib</code>   : </p><br><pre> <code class="bash hljs">service docker stop zfs create -o com.sun:auto-snapshot=<span class="hljs-literal"><span class="hljs-literal">false</span></span> -p /tank0/docker/lib rm -rf /var/lib/docker ln -s /tank0/docker/lib /var/lib/docker service docker start</code> </pre> <br><p>  : </p><br><pre> <code class="bash hljs">$ ls -l /var/lib/docker lrwxrwxrwx 1 root root 17 Apr 7 12:35 /var/lib/docker -&gt; /tank0/docker/lib</code> </pre> <br><p>     : </p><br><pre> <code class="bash hljs">docker network create docker0</code> </pre> <br><p>     Docker       . </p><br><h3 id="nastroyka-konteynera-s-nginx-reverse-proxy">    nginx-reverse-proxy </h3><br><p>    Docker ,     . </p><br><p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ,   . </p><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nginx-proxy</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">letsencrypt-dns</a> . </p><br><p> ,    OMV    10080  10443,        80  443. </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs javascript">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-proxy: networks: - docker0 restart: always image: jwilder/nginx-proxy ports: - <span class="hljs-string"><span class="hljs-string">"80:80"</span></span> - <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> volumes: - ./certs:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/certs:ro - ./vhost.d:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/vhost.d - ./html:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>share/nginx/html - <span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>run/docker.sock:<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>docker.sock:ro - ./local-config:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/conf.d - ./nginx.tmpl:<span class="hljs-regexp"><span class="hljs-regexp">/app/</span></span>nginx.tmpl labels: - <span class="hljs-string"><span class="hljs-string">"com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"</span></span> letsencrypt-dns: image: adferrand/letsencrypt-dns volumes: - ./certs/letsencrypt:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>letsencrypt environment: - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER=cloudns"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_OPTIONS=--delegated NAS.cloudns.cc"</span></span> - <span class="hljs-string"><span class="hljs-string">"LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD"</span></span></code> </pre> </div></div><br><p>      : </p><br><ul><li> nginx-reverse-proxy ‚Äî c  . </li><li> letsencrypt-dns ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ACME </a> Let's Encrypt. </li></ul><br><p>       nginx-reverse-proxy   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jwilder/nginx-proxy</a> . </p><br><p> <code>docker0</code> ‚Äî  ,    ,    docker-compose. <br> <code>nginx-proxy</code> ‚Äî   ,  .     docker0.  ,  80  443   ports      (,       ,           docker0,   ). <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>restart: always</code></a> ,       . </p><br><p> : </p><br><ul><li>   <strong><code>certs</code></strong>   <strong><code>/etc/nginx/certs</code></strong> ‚Äî   ,  ,   Let's Encrypt.           ACME . </li><li> <code>./vhost.d:/etc/nginx/vhost.d</code> ‚Äî    .   . </li><li> <code>./html:/usr/share/nginx/html</code> ‚Äî  .     . </li><li> <strong><code>/var/run/docker.sock</code></strong> ,   <strong><code>/tmp/docker.sock</code></strong> ‚Äî      Docker  .    docker-gen   . </li><li> <strong><code>./local-config</code></strong> ,   <strong><code>/etc/nginx/conf.d</code></strong> ‚Äî    nginx.    ,   . </li><li> <strong><code>./nginx.tmpl</code></strong> ,   <strong><code>/app/nginx.tmpl</code></strong> ‚Äî     nginx,   docker-gen  . </li></ul><br><p>  letsencrypt-dns    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">adferrand/letsencrypt-dns</a> .     ACME   Lexicon,     DNS . </p><br><p>   <code>certs/letsencrypt</code>   <code>/etc/letsencrypt</code>  . </p><br><p>   ,        : </p><br><ul><li> <strong><code>LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM</code></strong> ‚Äî   Let's Encrypt.     ,      . </li><li> <strong><code>LEXICON_PROVIDER=cloudns</code></strong> ‚Äî   Lexicon.    ‚Äî <code>cloudns</code> . </li><li> <strong><code>LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD --delegated=NAS.cloudns.cc</code></strong> ‚Äî CLOUDNS_ID        ClouDNS  . CLOUDNS_PASSWORD ‚Äî  ,      API. NAS.cloudns.cc,  NAS ‚Äî   DNS .  cloudns  ,          (cloudns.cc),  ClouDNS API     . </li></ul><br><p>        :      . <br>  ,      ,   ,     ,    Let's encrypt: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ls ./certs/letsencrypt/ accounts archive csr domains.conf keys live renewal renewal<span class="hljs-literal"><span class="hljs-literal">-hooks</span></span></code> </pre> <br><p>  ,      ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/nginx.tmpl</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">{{ <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer := where <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"ID"</span></span> .<span class="hljs-type"><span class="hljs-type">Docker</span></span>.<span class="hljs-type"><span class="hljs-type">CurrentContainerID</span></span> | first }} {{ define <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Address</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> we got the containers from swarm and this container<span class="hljs-string"><span class="hljs-string">'s port is published to host, use host IP:PORT */}} {{ if and .Container.Node.ID .Address.HostPort }} # {{ .Container.Node.Name }}/{{ .Container.Name }} server {{ .Container.Node.Address.IP }}:{{ .Address.HostPort }}; {{/* If there is no swarm node or the port is not published on host, use container'</span></span>s <span class="hljs-type"><span class="hljs-type">IP</span></span>:<span class="hljs-type"><span class="hljs-type">PORT</span></span> */}} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }}:{{ .<span class="hljs-type"><span class="hljs-type">Address</span></span>.<span class="hljs-type"><span class="hljs-type">Port</span></span> }}; {{ end }} {{ else if .<span class="hljs-type"><span class="hljs-type">Network</span></span> }} # {{ .<span class="hljs-type"><span class="hljs-type">Container</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> }} {{ if .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} server {{ .<span class="hljs-type"><span class="hljs-type">Network</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span> }} down; {{ else }} server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span>, pass it through; otherwise, pass along the # scheme used to connect to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span>, pass it through; otherwise, pass along the # server port the client connected to map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port { default <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>erver_port; } # <span class="hljs-type"><span class="hljs-type">If</span></span> we receive <span class="hljs-type"><span class="hljs-type">Upgrade</span></span>, set <span class="hljs-type"><span class="hljs-type">Connection</span></span> to <span class="hljs-comment"><span class="hljs-comment">"upgrade"</span></span>; otherwise, delete any # <span class="hljs-type"><span class="hljs-type">Connection</span></span> header that may have been passed to this server map <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection { default upgrade; <span class="hljs-string"><span class="hljs-string">''</span></span> close; } # <span class="hljs-type"><span class="hljs-type">Apply</span></span> fix for very long server names server_names_hash_bucket_size <span class="hljs-number"><span class="hljs-number">128</span></span>; # <span class="hljs-type"><span class="hljs-type">Default</span></span> dhparam {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/dhparam/dhparam.pem"</span></span>) }} ssl_dhparam /etc/nginx/dhparam/dhparam.pem; {{ end }} # <span class="hljs-type"><span class="hljs-type">Set</span></span> appropriate <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> header map <span class="hljs-string"><span class="hljs-string">$s</span></span>cheme <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl { default off; https on; } gzip_types text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript; log_format vhost <span class="hljs-string"><span class="hljs-string">'$host $remote_addr - $remote_user [$time_local] '</span></span> <span class="hljs-string"><span class="hljs-string">'"$request" $status $body_bytes_sent '</span></span> <span class="hljs-string"><span class="hljs-string">'"$http_referer" "$http_user_agent"'</span></span>; access_log off; {{ if <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }} resolver {{ <span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">RESOLVERS</span></span> }}; {{ end }} {{ if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/proxy.conf"</span></span>) }} include /etc/nginx/proxy.conf; {{ else }} # <span class="hljs-type"><span class="hljs-type">HTTP</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header <span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_host; proxy_set_header <span class="hljs-type"><span class="hljs-type">Upgrade</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ttp_upgrade; proxy_set_header <span class="hljs-type"><span class="hljs-type">Connection</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_connection; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Real</span></span>-<span class="hljs-type"><span class="hljs-type">IP</span></span> <span class="hljs-string"><span class="hljs-string">$r</span></span>emote_addr; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">For</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_add_x_forwarded_for; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Proto</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_proto; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Ssl</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_ssl; proxy_set_header <span class="hljs-type"><span class="hljs-type">X</span></span>-<span class="hljs-type"><span class="hljs-type">Forwarded</span></span>-<span class="hljs-type"><span class="hljs-type">Port</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>roxy_x_forwarded_port; # <span class="hljs-type"><span class="hljs-type">Mitigate</span></span> httpoxy attack (see <span class="hljs-type"><span class="hljs-type">README</span></span> for details) proxy_set_header <span class="hljs-type"><span class="hljs-type">Proxy</span></span> <span class="hljs-comment"><span class="hljs-comment">""</span></span>; {{ end }} {{ <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 := eq (or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">ENABLE_IPV6</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span>) <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span>; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; } {{ if (and (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name _; # <span class="hljs-type"><span class="hljs-type">This</span></span> is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">503</span></span>; ssl_session_tickets off; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ range <span class="hljs-string"><span class="hljs-string">$h</span></span>ost, <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers := groupByMulti <span class="hljs-string"><span class="hljs-string">$ </span></span><span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_HOST"</span></span> <span class="hljs-comment"><span class="hljs-comment">","</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost := trim <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp := hasPrefix <span class="hljs-comment"><span class="hljs-comment">"~"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name := when <span class="hljs-string"><span class="hljs-string">$i</span></span>s_regexp (sha1 <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} # {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} upstream {{ <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }} { {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen := len <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork := <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentContainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ range <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork := <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Networks</span></span> }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"ingress"</span></span>) (or (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span>) (eq <span class="hljs-string"><span class="hljs-string">$k</span></span>nownNetwork.<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-comment"><span class="hljs-comment">"host"</span></span>))) }} ## <span class="hljs-type"><span class="hljs-type">Can</span></span> be connected with <span class="hljs-comment"><span class="hljs-comment">"{{ $containerNetwork.Name }}"</span></span> network {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> only <span class="hljs-number"><span class="hljs-number">1</span></span> port exposed, use that */}} {{ if eq <span class="hljs-string"><span class="hljs-string">$a</span></span>ddrLen <span class="hljs-number"><span class="hljs-number">1</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := index <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{/* <span class="hljs-type"><span class="hljs-type">If</span></span> more than one port exposed, use the one matching <span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> env var, falling back to standard web port <span class="hljs-number"><span class="hljs-number">80</span></span> */}} {{ else }} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>ort := coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">VIRTUAL_PORT</span></span> <span class="hljs-comment"><span class="hljs-comment">"80"</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress := where <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer.<span class="hljs-type"><span class="hljs-type">Addresses</span></span> <span class="hljs-comment"><span class="hljs-comment">"Port"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>ort | first }} {{ template <span class="hljs-comment"><span class="hljs-comment">"upstream"</span></span> (dict <span class="hljs-comment"><span class="hljs-comment">"Container"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainer <span class="hljs-comment"><span class="hljs-comment">"Address"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ddress <span class="hljs-comment"><span class="hljs-comment">"Network"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainerNetwork) }} {{ end }} {{ else }} # <span class="hljs-type"><span class="hljs-type">Cannot</span></span> connect to network of this container server <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> down; {{ end }} {{ end }} {{ end }} {{ end }} } {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host := or (<span class="hljs-string"><span class="hljs-string">$.</span></span><span class="hljs-type"><span class="hljs-type">Env</span></span>.<span class="hljs-type"><span class="hljs-type">DEFAULT_HOST</span></span>) <span class="hljs-comment"><span class="hljs-comment">""</span></span> }} {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server := index (dict <span class="hljs-string"><span class="hljs-string">$h</span></span>ost <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_host <span class="hljs-comment"><span class="hljs-comment">"default_server"</span></span>) <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_PROTO</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"http"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$p</span></span>roto := trim (or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_PROTO"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"http"</span></span>) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">NETWORK_ACCESS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.NETWORK_ACCESS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"external"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HTTPS_METHOD</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HTTPS_METHOD"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">SSL_POLICY</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.SSL_POLICY"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">HSTS</span></span> defined by containers w/ the same vhost, falling back to <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> */}} {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>sts := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.HSTS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"max-age=31536000"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the <span class="hljs-type"><span class="hljs-type">VIRTUAL_ROOT</span></span> <span class="hljs-type"><span class="hljs-type">By</span></span> containers w/ use fastcgi root */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root := or (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.VIRTUAL_ROOT"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">"/var/www/public"</span></span> }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the first cert name defined by containers w/ the same vhost */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName := (first (groupByKeys <span class="hljs-string"><span class="hljs-string">$c</span></span>ontainers <span class="hljs-comment"><span class="hljs-comment">"Env.CERT_NAME"</span></span>)) }} {{/* <span class="hljs-type"><span class="hljs-type">Get</span></span> the best matching cert by name for the vhost. */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := (closest (dir <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs"</span></span>) (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost))}} {{/* vhostCert is actually a filename so remove any suffixes since they are added later */}} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".crt"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{ <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert := trimSuffix <span class="hljs-comment"><span class="hljs-comment">".key"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert }} {{/* <span class="hljs-type"><span class="hljs-type">Use</span></span> the cert specified on the container or fallback to the best vhost match */}} {{ <span class="hljs-string"><span class="hljs-string">$c</span></span>ert := (coalesce <span class="hljs-string"><span class="hljs-string">$c</span></span>ertName <span class="hljs-string"><span class="hljs-string">$v</span></span>hostCert) }} {{ <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https := (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"nohttps"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$c</span></span>ert <span class="hljs-comment"><span class="hljs-comment">""</span></span>) (or (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)))) ) }} {{ if <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https }} {{ if eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"redirect"</span></span> }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">301</span></span> https://<span class="hljs-string"><span class="hljs-string">$h</span></span>ost<span class="hljs-string"><span class="hljs-string">$r</span></span>equest_uri; } {{ end }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Modern"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Intermediate"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"Mozilla-Old"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">SSLv3</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:DES-CBC3-SHA:HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-2-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:AES128-GCM-SHA256:AES128-SHA256:AES256-GCM-SHA384:AES256-SHA256'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-TLS-1-1-2017-01"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2016-08"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-05"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-03"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA:DES-CBC3-SHA'</span></span>; {{ else if eq <span class="hljs-string"><span class="hljs-string">$s</span></span>sl_policy <span class="hljs-comment"><span class="hljs-comment">"AWS-2015-02"</span></span> }} ssl_protocols <span class="hljs-type"><span class="hljs-type">TLSv1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-type"><span class="hljs-type">TLSv1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA'</span></span>; {{ end }} ssl_prefer_server_ciphers on; ssl_session_timeout <span class="hljs-number"><span class="hljs-number">5</span></span>m; ssl_session_cache shared:<span class="hljs-type"><span class="hljs-type">SSL</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>m; ssl_session_tickets off; {{ if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/fullchain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/letsencrypt/live/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s/privkey.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ else if (and (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert))) }} ssl_certificate /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.crt"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; ssl_certificate_key /etc/nginx/certs/{{ (printf <span class="hljs-comment"><span class="hljs-comment">"%s.key"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_dhparam {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.dhparam.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert)) }} ssl_stapling on; ssl_stapling_verify on; ssl_trusted_certificate {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/%s.chain.pem"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>ert }}; {{ end }} {{ if (and (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) (ne <span class="hljs-string"><span class="hljs-string">$h</span></span>sts <span class="hljs-comment"><span class="hljs-comment">"off"</span></span>)) }} add_header <span class="hljs-type"><span class="hljs-type">Strict</span></span>-<span class="hljs-type"><span class="hljs-type">Transport</span></span>-<span class="hljs-type"><span class="hljs-type">Security</span></span> <span class="hljs-comment"><span class="hljs-comment">"{{ trim $hsts }}"</span></span> always; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ end }} {{ if or (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (eq <span class="hljs-string"><span class="hljs-string">$h</span></span>ttps_method <span class="hljs-comment"><span class="hljs-comment">"noredirect"</span></span>) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; {{ if eq <span class="hljs-string"><span class="hljs-string">$n</span></span>etwork_tag <span class="hljs-comment"><span class="hljs-comment">"internal"</span></span> }} # <span class="hljs-type"><span class="hljs-type">Only</span></span> allow traffic from internal clients include /etc/nginx/network_internal.conf; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default"</span></span>) }} include /etc/nginx/vhost.d/default; {{ end }} location / { {{ if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"uwsgi"</span></span> }} include uwsgi_params; uwsgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else if eq <span class="hljs-string"><span class="hljs-string">$p</span></span>roto <span class="hljs-comment"><span class="hljs-comment">"fastcgi"</span></span> }} root {{ trim <span class="hljs-string"><span class="hljs-string">$v</span></span>host_root }}; include fastcgi.conf; fastcgi_pass {{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ else }} proxy_pass {{ trim <span class="hljs-string"><span class="hljs-string">$p</span></span>roto }}://{{ trim <span class="hljs-string"><span class="hljs-string">$u</span></span>pstream_name }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} auth_basic <span class="hljs-comment"><span class="hljs-comment">"Restricted {{ $host }}"</span></span>; auth_basic_user_file {{ (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htpasswd/%s"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost) }}; {{ end }} {{ if (exists (printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost)) }} include {{ printf <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/%s_location"</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>ost}}; {{ else if (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/vhost.d/default_location"</span></span>) }} include /etc/nginx/vhost.d/default_location; {{ end }} } } {{ if (and (not <span class="hljs-string"><span class="hljs-string">$i</span></span>s_https) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.crt"</span></span>) (exists <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/certs/default.key"</span></span>)) }} server { server_name {{ <span class="hljs-string"><span class="hljs-string">$h</span></span>ost }}; listen <span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ if <span class="hljs-string"><span class="hljs-string">$e</span></span>nable_ipv6 }} listen [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl http2 {{ <span class="hljs-string"><span class="hljs-string">$d</span></span>efault_server }}; {{ end }} access_log /var/log/nginx/access.log vhost; return <span class="hljs-number"><span class="hljs-number">500</span></span>; ssl_certificate /etc/nginx/certs/default.crt; ssl_certificate_key /etc/nginx/certs/default.key; } {{ end }} {{ end }} {{ end }}</code> </pre> </div></div><br><p> ,    nginx     <code>/etc/nginx/certs/%s.crt</code>  <code>/etc/nginx/certs/%s.pem</code> ,  %s ‚Äî   (  ‚Äî  ,      ). </p><br><p>        <code>/etc/nginx/certs/letsencrypt/live/%s/{fullchain.pem, privkey.pem}</code> ,            : </p><br><pre> <code class="hljs perl">{{ $is_https := (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $https_method <span class="hljs-string"><span class="hljs-string">"nohttps"</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $cert <span class="hljs-string"><span class="hljs-string">""</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span></span> $cert)) ) (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.crt"</span></span> $cert)) (<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> <span class="hljs-string"><span class="hljs-string">"/etc/nginx/certs/%s.key"</span></span> $cert)) ) ) ) }}</code> </pre> <br><p>    ,        <code>domains.conf</code> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/certs/letsencrypt/domains.conf</b> <div class="spoiler_text"><pre> <code class="hljs css">*<span class="hljs-selector-class"><span class="hljs-selector-class">.NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NAS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cloudns</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cc</span></span></code> </pre> </div></div><br><p>     .  ,           ,     ,     <code>client_max_body_size</code>     20,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-proxy/local-config/max_upload_size.conf</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">20G</span></span>;</code> </pre> </div></div><br><p>  ,   : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up</code> </pre> <br><p>   (   ),  Ctrl+C        : </p><br><pre> <code class="hljs powershell">docker<span class="hljs-literal"><span class="hljs-literal">-compose</span></span> up <span class="hljs-literal"><span class="hljs-literal">-d</span></span></code> </pre> <br><h3 id="nastroyka-konteynera-s-testovym-serverom">      </h3><br><p>   ‚Äî   nginx,     . ,       ,     . <br>       ,      NAS. </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . </p><br><p>   docker-compose : </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/test_nginx/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: nginx-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> image: nginx:alpine expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> - <span class="hljs-number"><span class="hljs-number">443</span></span> environment: - "VIRTUAL_HOST=test.NAS.cloudns.cc" - "VIRTUAL_PROTO=http" - "VIRTUAL_PORT=80" - CERT_NAME=NAS.cloudns.cc networks: - docker0</code> </pre> </div></div><br><p>        : </p><br><ul><li> <code>docker0</code> ‚Äî  .    . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>expose</code></a> ‚Äî    ,   .  ,  80   HTTP  443   HTTPS. </li><li> <code>VIRTUAL_HOST=test.NAS.cloudns.cc</code> ‚Äî      ,   nginx-reverse-proxy      . </li><li> <code>VIRTUAL_PROTO=http</code> ‚Äî    nginx-reverse-proxy     .   ,  HTTP. </li><li> <code>VIRTUAL_PORT=80</code> ‚Äî      nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> ‚Äî   .   ,     ,    . NAS ‚Äî  DNS . </li><li> <code>networks</code> ‚Äî      ,    nginx-reverse-proxy     <code>docker0</code> . </li></ul><br><p>  ,    .  <code>docker-compose up</code> ,    <code>test.NAS.cloudns.cc</code> . </p><br><p>       : </p><br><pre> <code class="bash hljs">$ docker-compose up Creating testnginx_nginx-local_1 Attaching to testnginx_nginx-local_1 nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 612 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537"</span></span> <span class="hljs-string"><span class="hljs-string">"192.168.2.3"</span></span> nginx-local_1 | 2018/07/29 15:32:02 [error] 8<span class="hljs-comment"><span class="hljs-comment">#8: *2 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.22.0.5, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "test.NAS.cloudns.cc", referrer: "https://test.NAS.cloudns.cc/" nginx-local_1 | 172.22.0.5 - - [29/Jul/2018:15:32:02 +0000] "GET /favicon.ico HTTP/1.1" 404 572 "https://test.NAS.cloudns.cc/" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537 (KHTML, like Gecko) Chrome/67.0 Safari/537" "192.168.2.3"</span></span></code> </pre> <br><p>     : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wj/-v/q3/wj-vq3xwns34rsn_tr8zvycwiei.png" alt="Lanc√© Nginx"></a> </p><br><p> ,  ,    ,    ,   :     . </p><br><p>      ,   Ctrl+C,   <code>docker-compose down</code> . </p><br><h3 id="nastroyka-konteynera-s-local-rpoxy">    local-rpoxy </h3><br><p>   ,      nginx-default  ,     nas, omv        10080  10443   . </p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="bash hljs">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> networks: docker0: external: name: docker0 services: nginx-local: restart: always image: nginx:alpine expose: - 80 - 443 environment: - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_HOST=NAS.cloudns.cc,nas,nas.*,www.*,omv.*,nas-controller.nas"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PROTO=http"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PORT=80"</span></span> - CERT_NAME=NAS.cloudns.cc volumes: - ./<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-config:/etc/nginx/conf.d networks: - docker0</code> </pre> </div></div><br><p>   docker-compose    ,        . <br> ,   ,  ,     <code>NAS.cloudns.cc</code> .    ,     NAS    DNS ,    . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/nginx-local/local-config/default.conf</b> <div class="spoiler_text"><pre> <code class="hljs mel"># If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the # scheme used to connect to this server map $http_x_forwarded_proto $proxy_x_forwarded_proto { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_proto; <span class="hljs-string"><span class="hljs-string">''</span></span> $scheme; } # If we receive X-Forwarded-Port, pass it through; otherwise, pass along the # server port the client connected to map $http_x_forwarded_port $proxy_x_forwarded_port { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> $http_x_forwarded_port; <span class="hljs-string"><span class="hljs-string">''</span></span> $server_port; } # Set appropriate X-Forwarded-Ssl header map $scheme $proxy_x_forwarded_ssl { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> off; https on; } access_log on; error_log on; # HTTP <span class="hljs-number"><span class="hljs-number">1.1</span></span> support proxy_http_version <span class="hljs-number"><span class="hljs-number">1.1</span></span>; proxy_buffering off; proxy_set_header Host $http_host; proxy_set_header Upgrade $http_upgrade; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto; proxy_set_header X-Forwarded-Ssl $proxy_x_forwarded_ssl; proxy_set_header X-Forwarded-Port $proxy_x_forwarded_port; # Mitigate httpoxy attack (see README <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details) proxy_set_header Proxy <span class="hljs-string"><span class="hljs-string">""</span></span>; server { server_name _; # This is just an invalid value which will never trigger on a real hostname. listen <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">503</span></span>; } server { server_name www.* nas.* omv.* <span class="hljs-string"><span class="hljs-string">""</span></span>; listen <span class="hljs-number"><span class="hljs-number">80</span></span>; location / { proxy_pass https:<span class="hljs-comment"><span class="hljs-comment">//172.21.0.1:10443/; } } # nas-controller server { server_name nas-controller.nas; listen 80 ; location / { proxy_pass https://nas-controller/; } }</span></span></code> </pre> </div></div><br><ul><li> <code>172.21.0.1</code> ‚Äî  .       443,        OMV   HTTPS.        . </li><li> <code>https://nas-controller/</code> ‚Äî -,      IPMI,     nas,   nas-controller.nas,       nas-controller.   . </li></ul><br><h2>    LDAP </h2><br><h3 id="nastroyka-ldap-servera">  LDAP- </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LDAP-</a> ‚Äî      . <br>     Docker .  ,  ,       . </p><br><p>    LDIF-  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . </p><br><div class="spoiler"> <b class="spoiler_title">/tank0/docker/services/ldap/docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: "2" networks: ldap: docker0: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: docker0 services: <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap: image: "osixia/openldap:1.2.0" hostname: "open-ldap" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> environment: - "LDAP_ORGANISATION=NAS" - "LDAP_DOMAIN=nas.nas" - "LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD" - "LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD" - "LDAP_TLS=true" - "LDAP_TLS_ENFORCE=false" - "LDAP_TLS_CRT_FILENAME=ldap_server.crt" - "LDAP_TLS_KEY_FILENAME=ldap_server.key" - "LDAP_TLS_CA_CRT_FILENAME=ldap_server.crt" volumes: - ./certs:/container/service/slapd/assets/certs - ./ldap_data/var/lib:/var/lib/ldap - ./ldap_data/etc/ldap/slapd.d:/etc/ldap/slapd.d networks: - ldap ports: - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span> - <span class="hljs-number"><span class="hljs-number">172.21</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>::<span class="hljs-number"><span class="hljs-number">636</span></span>:<span class="hljs-number"><span class="hljs-number">636</span></span> phpldapadmin: image: "osixia/phpldapadmin:0.7.1" hostname: "nas.nas" <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">443</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> volumes: - ./certs:/container/service/phpldapadmin/assets/apache2/certs environment: - VIRTUAL_HOST=ldap.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">443</span></span> - VIRTUAL_PROTO=https - CERT_NAME=NAS.cloudns.cc - "PHPLDAPADMIN_LDAP_HOSTS=open-ldap-server" #- "PHPLDAPADMIN_HTTPS=false" - "PHPLDAPADMIN_HTTPS_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_HTTPS_KEY_FILENAME=private/ldap_server.key" - "PHPLDAPADMIN_HTTPS_CA_CRT_FILENAME=certs/ldap_server.crt" - "PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT=allow" ldap-ssp: image: openfrontier/ldap-ssp:https volumes: #- ./ssp/mods-enabled/ssl.conf:/etc/apache2/mods-enabled/ssl.conf - /etc/ssl/certs/ssl-cert-snakeoil.pem:/etc/ssl/certs/ssl-cert-snakeoil.pem - /etc/ssl/private/ssl-cert-snakeoil.key:/etc/ssl/private/ssl-cert-snakeoil.key <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> networks: - ldap - docker0 expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> links: - <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap:<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-ldap-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> environment: - VIRTUAL_HOST=ssp.* - VIRTUAL_PORT=<span class="hljs-number"><span class="hljs-number">80</span></span> - VIRTUAL_PROTO=http - CERT_NAME=NAS.cloudns.cc - "LDAP_URL=ldap://open-ldap-server:389" - "LDAP_BINDDN=cn=admin,dc=nas,dc=nas" - "LDAP_BINDPW=ADMIN_PASSWORD" - "LDAP_BASE=ou=users,dc=nas,dc=nas" - "MAIL_FROM=admin@nas.nas" - "PWD_MIN_LENGTH=8" - "PWD_MIN_LOWER=3" - "PWD_MIN_DIGIT=2" - "SMTP_HOST=" - "SMTP_USER=" - "SMTP_PASS="</code> </pre> </div></div><br><p>     : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>open-ldap</code></a> ‚Äî LDAP-. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>phpldapadmin</code></a> ‚Äî WEB-   .       ,   ... </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>ldap-ssp</code></a> ‚Äî WEB-    . </li></ul><br><p> LDAP-    ,     : </p><br><ul><li> <code>LDAP_ORGANISATION=NAS</code> ‚Äî  .   . </li><li> <code>LDAP_DOMAIN=nas.nas</code> ‚Äî .  .    ,    . </li><li> <code>LDAP_ADMIN_PASSWORD=ADMIN_PASSWORD</code> ‚Äî  . </li><li> <code>LDAP_CONFIG_PASSWORD=CONFIG_PASSWORD</code> ‚Äî   . </li></ul><br><p> -,       "  ",  . </p><br><p> : </p><br><ul><li> <code>/container/service/slapd/assets/certs</code>     <code>certs</code> ‚Äî .   . </li><li> <code>./ldap_data/</code> ‚Äî  ,        .  LDAP   . </li></ul><br><p>      <code>ldap</code> ,    389 ( LDAP)  636 (LDAP  SSL,   )    . </p><br><p> PhpLdapAdmin    :     LDAP   <code>ldap</code>    443   <code>docker0</code> ,  ,      nginx-reverse-proxy. </p><br><p> : </p><br><ul><li> <code>VIRTUAL_HOST=ldap.*</code> ‚Äî ,  nginx-reverse-proxy   . </li><li> <code>VIRTUAL_PORT=443</code> ‚Äî   nginx-reverse-proxy. </li><li> <code>VIRTUAL_PROTO=https</code> ‚Äî   nginx-reverse-proxy. </li><li> <code>CERT_NAME=NAS.cloudns.cc</code> ‚Äî  ,   . </li></ul><br><p>        SSL    . </p><br><p> SSP   HTTP      . <br> ,     ,       . </p><br><p>    ‚Äî             LDAP. </p><br><ul><li> <code>LDAP_URL=ldap://open-ldap-server:389</code> ‚Äî    LDAP  (.  <code>links</code> ). </li><li> <code>LDAP_BINDDN=cn=admin,dc=nas,dc=nas</code> ‚Äî      . </li><li> <code>LDAP_BINDPW=ADMIN_PASSWORD</code> ‚Äî  ,     ,    open-ldap. </li><li> <code>LDAP_BASE=ou=users,dc=nas,dc=nas</code> ‚Äî   ,      . </li></ul><br><p>         LDAP   LDAP : </p><br><pre> <code class="bash hljs">apt-get install ldap-utils ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/inititialize_ldap.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W -f ldifs/base.ldif ldapadd -x -H ldap://172.21.0.1 -D <span class="hljs-string"><span class="hljs-string">"cn=admin,cn=config"</span></span> -W -f ldifs/gitlab_attr.ldif</code> </pre> <br><p>  <code>gitlab_attr.ldif</code>  ,   Gitlab (  )   . <br>         . </p><br><div class="spoiler"> <b class="spoiler_title">  LDAP </b> <div class="spoiler_text"><pre> <code class="bash hljs">$ ldapsearch -x -H ldap://172.21.0.1 -b dc=nas,dc=nas -D <span class="hljs-string"><span class="hljs-string">"cn=admin,dc=nas,dc=nas"</span></span> -W Enter LDAP Password: <span class="hljs-comment"><span class="hljs-comment"># extended LDIF # # LDAPv3 # base &lt;dc=nas,dc=nas&gt; with scope subtree # filter: (objectclass=*) # requesting: ALL # # nas.nas dn: dc=nas,dc=nas objectClass: top objectClass: dcObject objectClass: organization o: NAS dc: nas # admin, nas.nas dn: cn=admin,dc=nas,dc=nas objectClass: simpleSecurityObject objectClass: organizationalRole cn: admin description: LDAP administrator ... # ldap_users, groups, nas.nas dn: cn=ldap_users,ou=groups,dc=nas,dc=nas cn: ldap_users gidNumber: 500 objectClass: posixGroup objectClass: top # search result search: 2 result: 0 Success # numResponses: 12 # numEntries: 11</span></span></code> </pre> </div></div><br><p>    LDAP  .      WEB-. </p><br><h3 id="nastroyka-omv-dlya-vhoda-po-ldap">  OMV    LDAP </h3><br><p>  LDAP    , OMV       :  , ,   ,          ,    ‚Äî  . </p><br><p> LDAP      . </p><br><p>    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0e/fq/yp/0efqypb4eevkfvm1dx5hccpxcae.png" alt="Configurer OMV pour travailler avec LDAP"></a> </p><br><h2>     </h2><br><p>     ,     ,     NAS  USB. <br>          . <br>     NUT  GUI OMV. <br>    <em>"-&gt;"</em> ,  ,      ,  ,  "eaton". </p><br><p>   <em>"  "</em>  : </p><br><pre> <code class="hljs pgsql">driver = usbhid-ups port = auto <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> = "Eaton 9130 700 VA" vendorid = <span class="hljs-number"><span class="hljs-number">0463</span></span> pollinterval = <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><ul><li> <code>driver = usbhid-ups</code> ‚Äî    USB,    USB HID. </li><li> <code>vendorid</code> ‚Äî    ,      <code>lsusb</code> . </li><li> <code>pollinterval</code> ‚Äî     c. </li></ul><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . </p><br><p>  <code>lsusb</code> ,     : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lsusb Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub --&gt; Bus 001 Device 003: ID 0463:ffff MGE UPS Systems UPS Bus 001 Device 004: ID 046b:ff10 American Megatrends, Inc. Virtual Keyboard and Mouse Bus 001 Device 002: ID 046b:ff01 American Megatrends, Inc. Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span></span></code> </pre> <br><p> <em>" "</em>    "  ". <br>    ,    : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/0v/1e/5c/0v1e5ceg5axff7qac7gnqqlv5dc.png" alt="Configuration de l'onduleur"></a> </p><br><p>     .    ,        . <br>     . </p><br><h2>  Conclusion </h2><br><p>       .   ,       ,     ,   ,   . <br>      ‚Äî  . </p><br><p>    -, OMV   . </p><br><p>     WEB-,       ,   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/tb/p3/ja/tbp3jabundd-ifinj76eimw-me0.png"></a> </p><br><p>  Docker     WEB-: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ol/1o/h_/ol1oh_koe2adncdkhh9qozsufkm.png"></a> </p><br><p>  , OMV    . </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fq/n7/v2/fqn7v20f3vq1ekj7ygcg1jbv2cu.png" alt="Calendrier d'utilisation du r√©seau"></a> </p><br><p>   : </p><br><p> <a href=""><img src="https://habrastorage.org/webt/52/k4/3e/52k43eckcekf7bxfxqmsbnv4hlm.png" alt="Graphique d'utilisation de la m√©moire"></a> </p><br><p>   CPU: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/qn/e8/ir/qne8ir6ndfbl17zyvzzl5vyexs0.png" alt="Graphique d'utilisation du processeur"></a> </p><br><h2 id="nerealizovannoe">  </h2><br><ul><li>    ‚Äî   . ,     -  .   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>docker-compose exec</code></a> ,       . </li><li> LDAP      ,     ( SSL ,      ..). </li><li>          ,    ,    . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ValdikSS</a>      DropbearSSH,   initramfs     .     . </li></ul><br><p>   . <br>  ! </p><br><p><img src="https://habrastorage.org/webt/n0/dy/xy/n0dyxyaz2tzyp5q1vvdskj1fr9c.jpeg"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415779/">https://habr.com/ru/post/fr415779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415769/index.html">Configurer le lancement automatique des tests d'interface utilisateur des applications Android via TeamCity</a></li>
<li><a href="../fr415771/index.html">Compilateur Go: langage de description des r√®gles d'optimisation SSA</a></li>
<li><a href="../fr415773/index.html">Exigences non fonctionnelles: √©volutivit√©</a></li>
<li><a href="../fr415775/index.html">Conseils simples, mais pas √©vidents, pour pr√©parer un rapport pour une conf√©rence sympa</a></li>
<li><a href="../fr415777/index.html">Le premier championnat de machine learning en d√©veloppement</a></li>
<li><a href="../fr415781/index.html">Pourquoi les physiciens pensent-ils que la th√©orie des cordes peut devenir "la th√©orie de tout"</a></li>
<li><a href="../fr415783/index.html">Les disques stellaires nous r√©v√®lent les secrets de l'apparition des plan√®tes</a></li>
<li><a href="../fr415785/index.html">SpaceX envoie un robot d'intelligence artificielle √† l'ISS</a></li>
<li><a href="../fr415789/index.html">Algorithmes de brevetage pour les programmes informatiques</a></li>
<li><a href="../fr415791/index.html">Optimisation des contrats intelligents. Comment les types de solidit√© affectent les co√ªts de transaction</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>