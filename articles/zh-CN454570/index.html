<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👧🏼 👨🏼‍⚕️ 🧓🏽 在C ++ 17中重新创建旧的DOS游戏 🏙️ 👨🏿‍🤝‍👨🏾 ⛺️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2016年，我开始从事一项业余项目，用于对游戏Duke Nukem II进行反向工程并从头开始重建其引擎。 该项目称为Rigel Engine，可在开源中使用（ 其页面在GitHub上 ）。 两年半以后的今天，在我的引擎上，您已经可以浏览原始游戏的整个共享软件集，并且具有与原始游戏几乎相同的游戏玩法...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在C ++ 17中重新创建旧的DOS游戏</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454570/">  2016年，我开始从事一项业余项目，用于对游戏<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">Duke Nukem II</a>进行反向工程并从头开始重建其引擎。 该项目称为Rigel Engine，可在开源中使用（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">其页面在GitHub上</a> ）。 两年半以后的今天，在我的引擎上，您已经可以浏览原始游戏的整个共享软件集，并且具有与原始游戏几乎相同的游戏玩法。 这是第一级通过的视频： <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Z3gCS5LvC2s" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br> 他能做什么？  Rigel Engine可以完全替代原始DOS二进制文件（ <code>NUKEM2.EXE</code> ）。 您可以将其复制到游戏目录，并考虑其中的所有数据，也可以将游戏数据的路径指定为命令行的参数。 该引擎是在Windows，Mac OS X和Linux下构建和执行的。 它基于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">SDL</a>和OpenGL 3 / OpenGL ES 2，并使用C ++ 17编写。 <br><br> 它实现了Shareware情节中所有敌人和游戏机制的游戏逻辑，以及大多数菜单系统。 另外，您可以将保存的游戏和高分表从原始游戏导入到其中。 <br><a name="habracut"></a><br> 而且，该引擎比原始引擎具有优势： <br><br><ul><li> 无需模拟器或旧硬件，无需设置 </li><li> 没有加载屏幕-在菜单中选择“新游戏”，按Enter，然后立即开始游戏 </li><li> 可以同时播放几种音效，这在原版中是不可能的 </li><li> 对粒子，爆炸等同时作用的数量没有限制。 </li><li> 保存每个播放器的文件和高分列表 </li><li> 响应式菜单更多 </li></ul><br> 到目前为止，我认为Rigel Engine并非完全“开箱即用”。 但这是发展的重要阶段，也是再次撰写有关引擎的好机会（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">此处</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">此处</a>发布的旧文章）。 让我们开始看一下代码的当前状态，并找出我如何去实现它。 <br><br><h2> 引擎中有多少代码？ </h2><br> 在撰写本文时，RigelEngine由270个源文件组成，包含超过25,000行代码（无注释/空行）。 其中，有10个文件和2.5千行是单元测试。 空行和注释的详细分类可<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">在此处获得</a> 。 <br><br> 这些代码到底是什么？ 一些通用的基础结构和支持功能，例如渲染之类的基本内容，以及一堆小逻辑块。 除了所有这些，最大的部分是： <br><br><ul><li> 原始游戏中使用的14种不同文件格式的解析器/下载器-2000行代码（LOC） </li><li>  24个敌人/敌对对象的行为逻辑/游戏逻辑-3.8k LOC </li><li>  14种互动元素和游戏机制的游戏逻辑-2k LOC </li><li> 播放器控制逻辑-1.2k LOC </li><li>  154个配置条目（每个敌人的健康值，所收集物品的得分等）-1k LOC </li><li>  31种破坏效果的规范（破坏敌人或其他可破坏物体而触发的效果）-254 LOC </li><li> 相机控制代码-159 LOC </li><li> 游戏菜单描述语言译员/过场动画-643 LOC </li><li>  HUD和其他UI代码为818 LOC </li><li> 菜单外有5个屏幕/模式，例如初始动画，奖金屏幕等。  -789个 </li></ul><br> 当然，所有这些代码都需要编写，这将导致我们进入下一个问题。 <br><br><h2> 它做了多少工作？ </h2><br> 尽管自项目开始以来已经过去了两年半，但我一直都没有为此工作。 几个月以来，我根本没有做任何项目，在另一些项目中，我只花了几个小时。 但是有时候我会非常积极地使用Rigel Engine。 查看Github上的提交时间表，您可以大致了解我的工作如何随时间分配： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c55/7f6/ee0/c557f6ee023574c46aea645b0001824d.png"></div><br> 根据时间表，我们看到对master分支进行了1081次提交。 但是，即使在创建存储库之前，我仍在进行一个封闭的工作，其中有247个以上的提交，总共给了我们1328个提交。 另外，我有几个原型分支用于研究和实验，但从未与主要分支结合使用。 另外，在合并之前，我有时将大型提交故事压缩为较短的提交故事。 <br><br> 我还必须说代码编写不是项目的唯一部分-逆向工程是另一个重要部分。 我花了好几个小时研究<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">Ida Pro</a> （免费版）中原始可执行文件的反汇编代码，做笔记，编写伪代码，并计划实现该版本的元素。 此外，我还积极测试了原始游戏，并在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">DOSBox</a>和原始设备（在eBay上购买了其他机器386和486）上运行了该游戏。 我收集了用于分别观察特定敌人和研究游戏机制的测试级别，使用DOSBox录制了视频剪辑，并逐帧浏览以确认我在研究汇编代码时所得出的结论。 在意识到敌人或游戏机制之后，我通常会记录我的版本的视频剪辑，并将其与原始视频进行逐帧比较，以确认实现的准确性。 <br><br> 这是我的笔记的一些照片： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/884/da3/b64/884da3b64a95ce531a3d5dbb456265bc.jpg"></div><br>  <i>反向工程摄像机控制代码。</i>  <i>较大的矩形表示屏幕。</i>  <i>虚线表示玩家无需移动相机即可移动的区域。</i>  <i>如果您有兴趣，可以在<a href="" rel="noopener">此处</a>找到相机控制代码本身。</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ec4/2d3/5c6/ec42d35c6ee85e375b8ed6d94d37e24d.jpg"></div><br>  <i>一般说明可帮助您理解汇编代码。</i>  <i>左侧是高级更新原始游戏的过程。</i>  <i>右边是指示某些游戏对象状态的位字段上的注释。</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/839/677/f8f/839677f8f3f9854d8e8ce6d349da396c.jpg"></div><br>  <i>将汇编程序代码转录为伪代码。</i>  <i>通常，我会足够机械地进行操作，在不考虑代码在做什么的情况下进行转录，然后使用伪代码中的版本来理解底层的逻辑。</i>  <i>在此基础上，我已经提出了实现方案。</i>  <i>在<a href="" rel="noopener">此处</a>查看完成的代码。</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8da/fd3/848/8dafd384867291ec44dc8bb9d9ff15b2.jpg"></div><br>  <i>清除后的敌人逻辑版本的伪代码</i>  <i>标头指示状态机的状态，下面的代码说明在各个状态下应发生的情况。</i>  <i>它是根据通过转录汇编代码获得的原始伪代码创建的。</i>  <i>准备好的代码可以在<a href="" rel="noopener">这里</a>找到。</i> <br><br> 最后，该项目的工作非常令人兴奋，我从中学到了很多东西：逆向工程，16位x86汇编器，低级VGA编程，90年代初期PC游戏开发人员必须面对的严格限制； 此外，我还发现了有关原始游戏的内部功能以及其中某些功能的实现是多么奇怪和怪异的许多发现-这个主题本身值得一连串发表。 <br><br><h2> 接下来是什么 </h2><br> 除了添加最后剩下的功能并最终完成对注册版本的支持外，我还有几个想法可以改进和扩展Rigel Engine的功能，更不用说清理和重构代码了-通常，创建软件体系结构的最佳方法只有在完成此软件的创建后才能显现。 <br><br> 至于将来的改进，以下是我考虑实现的一些要点： <br><br><ul><li> 插补平滑运动。 游戏每秒大约更新15次逻辑，在原始游戏中，它也是渲染的帧速率。 另一方面，Rigel引擎可以轻松以60 FPS或更高的频率工作。 目前，这些附加框架没有任何优势，但我认为可以将它们用于中间框架，以实现对象的平滑滚动和移动。 游戏的逻辑仍将以相同的速度运行，但是对象将平滑移动，并且不会像现在那样以8像素的增量“跳跃”。 早些时候，我创建了这样一个系统的原型，尽管需要改进，但它看起来很棒。 </li><li> 游戏手柄支持。 在原始游戏中，有对操纵杆的支持，DosBox可以在现代游戏手柄上模拟操纵杆，但是它们的设置可能很困难-需要准备游戏中的配置和校准。 更不用说并非所有控制器按钮都受支持，但是要使用菜单，您仍然必须带键盘。 因此，我相信对本机控制器的支持将大大改善游戏玩法。 </li><li> 声音增强。 当前，所有声音效果具有相同的音量。 产生声音的物体（例如，力场）在撞击屏幕时变得清晰可闻，并突然破裂。 我很好奇，如果远处的效果逐渐减弱，它们的声音会如何。 例如，当力场尚未出现在屏幕上时，我们几乎听不到，而接近时力场会变大。 </li><li> 远程摄像头/查看大部分关卡。 游戏不是为此设计的，因此这种可能性可能会破坏游戏玩法-玩家将开始看到在屏幕外未处于活动状态的敌人，等等。 但是我仍然想知道它的外观和播放方式。 最后，玩家经常抱怨这款游戏无法看到关卡的足够部分。 添加选项以关闭HUD或使用透明度最小的HUD替换将是很有趣的。 </li><li> 增加图形分辨率。 经常在许多游戏端口/休闲游戏中找到此功能，在此添加它会很棒。 该引擎已经可以让您用自己的图像替换精灵图形，但是到目前为止，它们不能具有更高的分辨率，因为所有内容都会渲染到较小的缓冲区中，并且随后会扩大比例。 首先，您需要替换此方法，以便可以对单个对象执行缩放。 </li></ul><br> 我没有未来的路线图，因此我可以按任何顺序实施这些要点。 但是在此之前，下一步将是整合Dear ImGui，以进一步组装选项菜单，而这在游戏中还没有。 此外，它将启用或禁用上述改进。 最后，我要说的是，感谢您<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="noopener">在GitHub上的工作</a> ！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN454570/">https://habr.com/ru/post/zh-CN454570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN454552/index.html">Docker组成 如何等待直到容器准备好</a></li>
<li><a href="../zh-CN454556/index.html">OpenStreetMap第462号世界新闻（05.21.2019-27.05.2019）</a></li>
<li><a href="../zh-CN454558/index.html">PHP摘要157号（2019年5月20日至6月3日）</a></li>
<li><a href="../zh-CN454562/index.html">为什么字节码的概念没有以前那么重要</a></li>
<li><a href="../zh-CN454568/index.html">Mozilla称Google的数字签名Web软件包分发“不好”</a></li>
<li><a href="../zh-CN454574/index.html">小额信贷中的机器学习：为信用记录为空的客户建立评分模型</a></li>
<li><a href="../zh-CN454576/index.html">GandCrab作者停止工作：他们声称已经偷了足够多的东西</a></li>
<li><a href="../zh-CN454578/index.html">如何在Android WebView中连接PhotoSwipe画廊</a></li>
<li><a href="../zh-CN454582/index.html">是否应该将数组长度存储到C＃中的局部变量中？</a></li>
<li><a href="../zh-CN454584/index.html">界面开发学校：明斯克的任务分析和莫斯科的一套新任务</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>