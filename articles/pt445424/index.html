<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶É ü§∏üèΩ üöØ Experi√™ncia no desenvolvimento do servi√ßo Refund Tool com uma API ass√≠ncrona no Kafka üöÖ üç∞ üëΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que pode fazer uma grande empresa como a Lamoda com um processo simplificado e dezenas de servi√ßos interconectados mudarem significativamente a abor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experi√™ncia no desenvolvimento do servi√ßo Refund Tool com uma API ass√≠ncrona no Kafka</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/445424/"> O que pode fazer uma grande empresa como a Lamoda com um processo simplificado e dezenas de servi√ßos interconectados mudarem significativamente a abordagem?  A motiva√ß√£o pode ser completamente diferente: do legislativo ao desejo inerente a todos os programadores de experimentar. <br><br>  Mas isso n√£o significa que n√£o se possa contar com benef√≠cios adicionais.  O que exatamente pode ser ganho se voc√™ implementar a API orientada a eventos no Kafka, Sergey Zaika ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">fewald</a> ) dir√°.  Sobre incha√ßos empalhados e descobertas interessantes, certamente haver√° - um experimento n√£o pode ficar sem eles. <br><br><img src="https://habrastorage.org/webt/kq/o2/ye/kqo2yemmmu-wiqi9vtpcrbolroq.png"><br><br>  <em>Isen√ß√£o de responsabilidade: este artigo √© baseado nos materiais da mitap realizada por Sergey em novembro de 2018 no HighLoad ++.</em>  <em>A experi√™ncia ao vivo de Lamoda com Kafka atraiu ouvintes n√£o menos que outros relat√≥rios de programa√ß√£o.</em>  <em>Parece-nos que este √© um √≥timo exemplo do fato de que √© sempre poss√≠vel e necess√°rio encontrar pessoas com id√©ias semelhantes, e os organizadores do HighLoad ++ continuar√£o tentando criar uma atmosfera prop√≠cia a isso.</em> <br><a name="habracut"></a><br><h2>  Sobre o processo </h2><br>  A Lamoda √© uma grande plataforma de com√©rcio eletr√¥nico que possui seu pr√≥prio contact center, servi√ßo de entrega (e muitos afiliados), um est√∫dio de fotografia, um enorme armaz√©m e tudo isso funciona em seu software.  Existem dezenas de m√©todos de pagamento, parceiros B2B que podem usar parte ou todos esses servi√ßos e desejam conhecer as informa√ß√µes mais recentes sobre seus produtos.  Al√©m disso, a Lamoda opera em tr√™s pa√≠ses al√©m da Federa√ß√£o Russa e l√° tudo √© um pouco diferente.  No total, provavelmente existem mais de cem maneiras de configurar um novo pedido, que deve ser processado √† sua maneira.  Tudo isso funciona com a ajuda de dezenas de servi√ßos que √†s vezes se comunicam de maneira n√£o √≥bvia.  Existe tamb√©m um sistema central cuja principal responsabilidade √© o status dos pedidos.  N√≥s a chamamos de BOB, eu trabalho com ela. <br><br><h2>  Ferramenta de reembolso com API orientada a eventos </h2><br>  A palavra orientada a eventos √© bastante falsa, um pouco mais adiante definiremos com mais detalhes o que isso significa.  Come√ßarei com o contexto em que decidimos experimentar a abordagem da API orientada a eventos Kafka. <br><br><img src="https://habrastorage.org/webt/8y/0i/kp/8y0ikp8ebxzglwhw1s-dhrubivw.png"><br><br>  Em qualquer loja, al√©m dos pedidos pelos quais os clientes pagam, h√° momentos em que a loja precisa devolver dinheiro, porque o produto n√£o se encaixa no cliente.  Este processo relativamente curto: esclarecemos as informa√ß√µes, se houver, e transferimos o dinheiro. <br><br>  Mas o retorno foi complicado devido a mudan√ßas na legisla√ß√£o e tivemos que implementar um microsservi√ßo separado para isso. <br><br><img src="https://habrastorage.org/webt/nn/_x/xr/nn_xxr2xlqfpn-kmgc5y4rzj9a8.png"><br><br>  Nossa motiva√ß√£o: <br><br><ol><li>  <strong>Lei FZ-54</strong> - brevemente, a lei exige que voc√™ informe √† administra√ß√£o fiscal sobre cada transa√ß√£o monet√°ria, seja um reembolso ou um recebimento, em um SLA bastante curto em alguns minutos.  N√≥s, como com√©rcio eletr√¥nico, realizamos algumas opera√ß√µes.  Tecnicamente, isso significa uma nova responsabilidade (e, portanto, um novo servi√ßo) e melhorias em todos os sistemas envolvidos. </li><li>  <strong>Divis√£o do BOB</strong> - o projeto interno da empresa para livrar o BOB de um grande n√∫mero de responsabilidades n√£o essenciais e reduzir sua complexidade geral. </li></ol><br><img src="https://habrastorage.org/webt/u7/k8/7x/u7k87xo4jzxcjmoeanxdzhy_yag.png"><br><br>  Este diagrama mostra os principais sistemas Lamoda.  Agora, a maioria deles √© mais como uma <strong>constela√ß√£o de 5 a 10 microsservi√ßos em torno de um mon√≥lito decrescente</strong> .  Eles est√£o crescendo lentamente, mas estamos tentando diminu√≠-los, porque √© assustador implantar o fragmento destacado no meio - n√£o pode cair.  Todas as trocas (setas) somos for√ßadas a reservar e apostamos no fato de que alguma delas pode estar indispon√≠vel. <br><br>  Tamb√©m existem muitas trocas no BOB: pagamento, entrega, sistemas de notifica√ß√£o etc. <br><br>  Tecnicamente, o BOB √©: <br><br><ul><li>  ~ 150k linhas de c√≥digo + ~ 100k linhas de testes; </li><li>  php7.2 + Zend 1 e componentes Symfony 3; </li><li>  &gt; 100 API e ~ 50 integra√ß√µes de sa√≠da; </li><li>  4 pa√≠ses com sua pr√≥pria l√≥gica de neg√≥cios. </li></ul><br>  A implanta√ß√£o do BOB √© cara e penosa, a quantidade de c√≥digo e as tarefas que ele resolve s√£o tais que ningu√©m pode colocar na cabe√ßa deles.  Em geral, existem muitas raz√µes para simplific√°-lo. <br><br><h2>  Processo de devolu√ß√£o </h2><br>  Inicialmente, dois sistemas est√£o envolvidos no processo: BOB e Pagamento.  Agora, mais dois aparecem: <br><br><ul><li>  Servi√ßo de Fiscaliza√ß√£o, que resolver√° problemas com fiscaliza√ß√£o e comunica√ß√£o com servi√ßos externos. </li><li>  Ferramenta de reembolso, na qual novas trocas s√£o simplesmente realizadas para n√£o inflar o BOB. </li></ul><br>  Agora, o processo √© assim: <br><br><img src="https://habrastorage.org/webt/pe/e6/0q/pee60qj1tdefewqgdaw22bww-ag.png"><br><br><ol><li>  O BOB recebe uma solicita√ß√£o de reembolso. </li><li>  BOB fala sobre essa ferramenta de reembolso. </li><li>  A Ferramenta de reembolso diz Pagamento: "Receba o dinheiro de volta". </li><li>  O pagamento retorna o dinheiro. </li><li>  A Ferramenta de reembolso e o BOB sincronizam os status entre si, porque, por enquanto, os dois precisam.  Ainda n√£o estamos prontos para mudar totalmente para a Ferramenta de reembolso, pois o BOB possui interface do usu√°rio, relat√≥rios para contabilidade e geralmente muitos dados que voc√™ n√£o pode transferir facilmente.  Temos que sentar em duas cadeiras. </li><li>  A solicita√ß√£o de fiscaliza√ß√£o sai. </li></ol><br>  Como resultado, fizemos um tipo de barramento de evento em Kafka - um barramento de evento, no qual tudo come√ßou.  Viva, agora temos um √∫nico ponto de falha (sarcasmo). <br><br><img src="https://habrastorage.org/webt/8k/zg/qc/8kzgqcfju7ybv8imzajjjykpz10.png"><br><br>  Os pr√≥s e contras s√£o bastante √≥bvios.  Fizemos um √¥nibus, agora todos os servi√ßos dependem dele.  Isso simplifica o design, mas introduz um √∫nico ponto de falha no sistema.  Kafka cair√°, o processo aumentar√°. <br><br><h2>  O que √© uma API orientada a eventos </h2><br>  Uma boa resposta para essa pergunta est√° no relat√≥rio de Martin Fowler (GOTO 2017) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Os muitos significados da arquitetura orientada a eventos"</a> . <br><br>  Resumidamente, o que fizemos: <br><br><ol><li>  Quebra de todas as trocas ass√≠ncronas atrav√©s do <strong>armazenamento de eventos</strong> .  Em vez de informar a cada consumidor interessado sobre a altera√ß√£o de status pela rede, escrevemos um evento de altera√ß√£o de status no reposit√≥rio centralizado, e os consumidores interessados ‚Äã‚Äãno t√≥pico l√™em tudo o que aparece a partir da√≠. </li><li>  Um evento neste caso √© uma notifica√ß√£o ( <strong>notifica√ß√µes</strong> ) de que algo mudou em algum lugar.  Por exemplo, o status do pedido foi alterado.  Um consumidor interessado em algum tipo de dado que acompanha a altera√ß√£o de status e que n√£o consta da notifica√ß√£o pode descobrir o status dele. </li><li>  A op√ß√£o m√°xima √© uma fonte de eventos completa, <strong>transfer√™ncia de estado</strong> , na qual o evento cont√©m todas as informa√ß√µes necess√°rias para o processamento: de onde e para qual status voc√™ alternou, como exatamente os dados foram alterados etc. A √∫nica quest√£o √© se vale a pena e quanta informa√ß√£o voc√™ pode armazenar. </li></ol><br>  Como parte do lan√ßamento da Ferramenta de reembolso, usamos a terceira op√ß√£o.  Isso simplificou o processamento de eventos, uma vez que n√£o era necess√°rio obter informa√ß√µes detalhadas, al√©m de excluir o cen√°rio em que cada novo evento gera uma onda de esclarecimentos de solicita√ß√µes de recebimento dos consumidores. <br><br>  O servi√ßo da Ferramenta de reembolso <strong>n√£o</strong> √© <strong>carregado</strong> , portanto, Kafka √© mais um teste de caneta do que uma necessidade.  Eu n√£o acho que se o servi√ßo de reembolso se tornar um projeto de alta carga, os neg√≥cios ficar√£o felizes. <br><br><h4>  Troca ass√≠ncrona COMO EST√Å </h4><br>  Para trocas ass√≠ncronas, o departamento PHP normalmente usa o RabbitMQ.  Coletamos os dados para a solicita√ß√£o, os colocamos na fila e o consumidor do mesmo servi√ßo os leu e os enviou (ou n√£o os enviou).  Para a pr√≥pria API, Lamoda usa ativamente o Swagger.  N√≥s projetamos a API, descrevemos no Swagger, geramos c√≥digo de cliente e servidor.  Tamb√©m usamos um JSON RPC 2.0 um pouco avan√ßado. <br><br>  Aqui e ali, os barramentos esb s√£o usados, algu√©m mora no activeMQ, mas, em geral, o <strong>RabbitMQ √© o padr√£o</strong> . <br><br><h4>  Troca ass√≠ncrona PARA SER </h4><br>  Ao projetar uma troca atrav√©s do barramento de eventos, √© feita uma analogia.  Da mesma forma, descrevemos a troca futura de dados por meio de descri√ß√µes da estrutura de eventos.  O formato yaml, a gera√ß√£o do c√≥digo teve que ser feita por n√≥s mesmos, o gerador cria o DTO de acordo com a especifica√ß√£o e ensina clientes e servidores a trabalhar com eles.  A gera√ß√£o entra em dois idiomas - <strong>golang e php</strong> .  Isso mant√©m as bibliotecas consistentes.  O gerador √© escrito em golang, para o qual recebeu o nome gogi. <br><br>  O fornecimento de eventos em Kafka √© uma coisa t√≠pica.  Existe uma solu√ß√£o da vers√£o corporativa principal do Kafka Confluent, existe um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nakadi</a> , uma solu√ß√£o de nossos "irm√£os" na √°rea de dom√≠nio de Zalando.  Nossa <strong>motiva√ß√£o para come√ßar com o Kafka de baunilha</strong> √© deixar a solu√ß√£o livre at√© que finalmente decidamos us√°-la em qualquer lugar e tamb√©m deixar espa√ßo para manobras e melhorias: queremos suporte para o <strong>JSON RPC 2.0</strong> , geradores para dois idiomas e ver o que mais. <br><br>  √â ir√¥nico que, mesmo em um caso t√£o feliz, quando h√° um neg√≥cio semelhante ao de Zalando, que tomou uma decis√£o semelhante, n√£o podemos us√°-lo efetivamente. <br><br>  Em termos de arquitetura, na inicializa√ß√£o, o padr√£o √© o seguinte: leia diretamente do Kafka, mas escreva apenas atrav√©s do barramento de eventos.  H√° muito pronto para leitura em Kafka: corretores, balanceadores e est√° mais ou menos pronto para o dimensionamento horizontal, eu queria mant√™-lo.  O registro, quer√≠amos encerrar um Gateway, chamado Events-bus, e √© por isso. <br><br><h3>  √înibus de eventos </h3><br>  Ou um √¥nibus de eventos.  Este √© apenas um gateway http sem estado que assume v√°rias fun√ß√µes importantes: <br><br><ul><li>  <strong>Valida√ß√£o da produ√ß√£o</strong> - verificamos se os eventos atendem √†s nossas especifica√ß√µes. </li><li>  <strong>Um sistema mestre de eventos</strong> , ou seja, √© o principal e √∫nico sistema da empresa que responde √† pergunta de quais eventos com quais estruturas s√£o consideradas v√°lidas.  A valida√ß√£o simplesmente inclui tipos de dados e enumera√ß√µes para uma especifica√ß√£o estrita do conte√∫do. </li><li>  <strong>A fun√ß√£o</strong> hash para sharding - a estrutura de mensagens do Kafka √© o valor-chave e aqui √© calculada pelo hash da chave onde coloc√°-lo. </li></ul><br><h3>  Porque </h3><br>  Trabalhamos em uma grande empresa com um processo simplificado.  Por que mudar alguma coisa?  <strong>Este √© um experimento</strong> e esperamos obter v√°rios benef√≠cios. <br><br><h4>  1: n + 1 trocas (uma para muitas) </h4><br>  Com o Kafka, √© muito f√°cil conectar novos consumidores √† API. <br><br>  Suponha que voc√™ tenha um diret√≥rio que precise ser atualizado em v√°rios sistemas ao mesmo tempo (e em alguns novos).  Anteriormente, inventamos um pacote que implementava uma API de conjunto e os endere√ßos dos consumidores eram relatados ao sistema mestre.  Agora, o sistema mestre envia atualiza√ß√µes para o t√≥pico e para todos os interessados ‚Äã‚Äãem ler.  Um novo sistema apareceu - eles o assinaram no t√≥pico.  Sim, tamb√©m pacote, mas mais simples. <br><br>  No caso da ferramenta de reembolso, que √© uma parte do BOB, √© conveniente mant√™-los sincronizados por meio do Kafka.  O pagamento diz que eles devolveram o dinheiro: BOB, RT descobriu, mudou seu status, o Servi√ßo de Fiscaliza√ß√£o descobriu e cancelou um cheque. <br><br><img src="https://habrastorage.org/webt/x1/rs/gx/x1rsgx9mbceqzstdmcsg_hapnbs.png"><br><br>  Temos planos de criar um √∫nico Servi√ßo de Notifica√ß√µes, que notificar√° o cliente sobre as not√≠cias em seu pedido / devolu√ß√£o.  Agora essa responsabilidade est√° espalhada entre os sistemas.  √â o suficiente para ensinarmos o Servi√ßo de Notifica√ß√µes a capturar e responder √†s informa√ß√µes relevantes da Kafka (e desativar essas notifica√ß√µes em outros sistemas).  N√£o ser√£o necess√°rias novas trocas diretas. <br><br><h4>  Orientado por dados </h4><br>  As informa√ß√µes entre os sistemas tornam-se transparentes - n√£o importa o qu√£o sangrenta seja sua empresa e qu√£o inc√¥moda seja sua carteira de pedidos.  A Lamoda possui um departamento de An√°lise de dados que coleta dados nos sistemas e os coloca em uma forma reutiliz√°vel, tanto para empresas quanto para sistemas inteligentes.  O Kafka permite que voc√™ rapidamente forne√ßa muitos dados e mantenha essas informa√ß√µes atualizadas. <br><br><h4>  Log de replica√ß√£o </h4><br>  As mensagens n√£o desaparecem ap√≥s a leitura, como no RabbitMQ.  Quando o evento cont√©m informa√ß√µes suficientes para processamento, temos um hist√≥rico de altera√ß√µes recentes no objeto e, se desejado, a capacidade de aplicar essas altera√ß√µes. <br><br>  O per√≠odo de armazenamento do log de replica√ß√£o depende da intensidade da grava√ß√£o neste t√≥pico.O Kafka permite que voc√™ defina com flexibilidade limites para o tempo de armazenamento e o volume de dados.  Para t√≥picos intensivos, √© importante que todos os consumidores tenham tempo para ler as informa√ß√µes antes que elas desapare√ßam, mesmo no caso de inoperabilidade a curto prazo.  Normalmente, eles armazenam dados por <strong>unidades de dias</strong> , o que √© suficiente para suporte. <br><br><img src="https://habrastorage.org/webt/xz/6-/59/xz6-59a1z7vrszrmoowvswxauqc.png"><br><br>  Em seguida, um pouco de recontagem da documenta√ß√£o, para aqueles que n√£o est√£o familiarizados com Kafka (a imagem tamb√©m √© da documenta√ß√£o) <br><br>  Existem filas no AMQP: escrevemos mensagens na fila para o consumidor.  Como regra, uma fila √© processada por um sistema com a mesma l√≥gica de neg√≥cios.  Se voc√™ precisar notificar v√°rios sistemas, poder√° ensinar o aplicativo a gravar em v√°rias filas ou configurar o interc√¢mbio com o mecanismo de fanout, que por sua vez os clona. <br><br>  Kafka tem uma abstra√ß√£o de <em>t√≥pico</em> semelhante na qual voc√™ escreve mensagens, mas elas n√£o desaparecem ap√≥s a leitura.  Por padr√£o, quando voc√™ se conecta ao Kafka, recebe todas as mensagens e, ao mesmo tempo, h√° a oportunidade de salvar o local de onde parou.  Ou seja, voc√™ l√™ sequencialmente, n√£o pode marcar a mensagem como lida, mas salva o ID, a partir do qual continua lendo.  O ID no qual voc√™ est√° parando √© chamado de deslocamento, e o mecanismo √© o deslocamento de confirma√ß√£o. <br><br>  Assim, diferentes l√≥gicas podem ser implementadas.  Por exemplo, temos o BOB em 4 inst√¢ncias para diferentes pa√≠ses - Lamoda est√° na R√∫ssia, Cazaquist√£o, Ucr√¢nia, Bielorr√∫ssia.  Como s√£o implantados separadamente, eles t√™m um pouco de suas pr√≥prias configura√ß√µes e l√≥gica de neg√≥cios.  Na mensagem, indicamos a que pa√≠s se refere.  Cada consumidor de BOB em cada pa√≠s l√™ com groupId diferente e, se a mensagem n√£o se aplicar a ele, pule-a, ou seja,  confirme imediatamente o deslocamento +1.  Se o mesmo t√≥pico for lido pelo nosso Servi√ßo de pagamento, ele far√° isso com um grupo separado e, portanto, o deslocamento n√£o se sobrep√µe. <br><br>  <b>Requisitos do evento:</b> <br><br><ul><li>  <strong>Completude dos dados.</strong>  Eu gostaria que houvesse dados suficientes no evento para que pudessem ser processados. </li></ul><br><ul><li>  <strong>Integridade</strong>  Delegamos o barramento de eventos para verificar se o evento √© consistente e que ele pode lidar com isso. </li><li>  <strong>A ordem √© importante.</strong>  No caso de um retorno, somos for√ßados a trabalhar com a hist√≥ria.  Com as notifica√ß√µes, o pedido n√£o √© importante; se forem notifica√ß√µes homog√™neas, o e-mail ser√° o mesmo, independentemente do pedido recebido primeiro.  No caso de uma devolu√ß√£o, existe um processo claro; se voc√™ alterar o pedido, haver√° exce√ß√µes, o reembolso n√£o ser√° criado ou processado - acabaremos com um status diferente. </li><li>  <strong>Coer√™ncia.</strong>  Temos um reposit√≥rio e agora, em vez da API, criamos eventos.  Precisamos de uma maneira r√°pida e barata de transferir informa√ß√µes sobre novos eventos e altera√ß√µes nos existentes para nossos servi√ßos.  Isso √© alcan√ßado usando uma especifica√ß√£o comum em um reposit√≥rio git e geradores de c√≥digo separados.  Portanto, clientes e servidores em diferentes servi√ßos s√£o coordenados conosco. </li></ul><br><h2>  Kafka em Lamoda </h2><br>  Temos tr√™s instala√ß√µes Kafka: <br><br><ol><li>  Logs </li><li>  P&amp;D; </li><li>  √înibus de eventos. </li></ol><br>  Hoje estamos apenas falando sobre o √∫ltimo ponto.  No barramento de eventos, n√£o temos instala√ß√µes muito grandes - 3 corretores (servidores) e um total de 27 t√≥picos.  Como regra, um t√≥pico √© um processo.  Mas este √© um momento delicado, e agora vamos toc√°-lo. <br><br><img src="https://habrastorage.org/webt/1v/5s/nj/1v5snjoqmrg2sb1grok5snkzowu.png"><br><br>  Acima est√° o gr√°fico rps.  O processo de reembolso √© marcado com uma linha turquesa (sim, a que est√° no eixo X) e rosa √© o processo de atualiza√ß√£o de conte√∫do. <br><br>  O cat√°logo da Lamoda cont√©m milh√µes de produtos, com dados sendo atualizados o tempo todo.  Algumas cole√ß√µes saem de moda, novas s√£o lan√ßadas em vez delas, novos modelos aparecem constantemente no cat√°logo.  Tentamos prever o que ser√° interessante para nossos clientes amanh√£, para comprar constantemente coisas novas, fotograf√°-las e atualizar a janela. <br><br>  Os picos rosa s√£o uma atualiza√ß√£o do produto, ou seja, altera√ß√µes nos produtos.  Pode-se ver que os caras tiraram fotos, tiraram fotos e depois novamente!  - baixou um pacote de eventos. <br><br><h2>  Casos de uso de Eventos Lamoda </h2><br>  Usamos a arquitetura constru√≠da para tais opera√ß√µes: <br><br><ul><li>  <strong>Rastreamento de status de retorno</strong> : call to action e rastreamento de status de todos os sistemas envolvidos.  Pagamento, status, fiscaliza√ß√£o, notifica√ß√µes.  Aqui, testamos a abordagem, criamos as ferramentas, coletamos todos os bugs, escrevemos a documenta√ß√£o e dissemos aos colegas como us√°-la. </li><li>  <strong>Atualizando cart√µes do produto:</strong> configura√ß√£o, metadados, caracter√≠sticas.  Um sistema l√™ (que √© exibido) e v√°rios escrevem. </li><li>  <strong>E-mail, push e sms</strong> : o pedido √© coletado, o pedido chegou, a devolu√ß√£o foi aceita, etc., muitos deles. </li><li>  <strong>Atualiza√ß√£o de estoque, dep√≥sito</strong> - uma atualiza√ß√£o quantitativa dos itens, apenas n√∫meros: recebimento no dep√≥sito, devolu√ß√£o.  √â necess√°rio que todos os sistemas relacionados √† reserva de mercadorias operem com os dados mais relevantes.  Agora o sistema de atualiza√ß√£o de drenos √© bastante complicado, o Kafka o simplificar√°. </li><li>  <strong>An√°lise de dados</strong> (departamento de P&amp;D), ferramentas ML, an√°lises, estat√≠sticas.  Queremos que as informa√ß√µes sejam transparentes - pois esse Kafka √© adequado. </li></ul><br>  Agora, a parte mais interessante √© sobre cones empalhados e descobertas interessantes que ocorreram ao longo de seis meses. <br><br><h2>  Problemas de design </h2><br>  Suponha que desejemos fazer algo novo - por exemplo, transfira todo o processo de entrega para Kafka.  Parte do processo agora est√° sendo implementada no Processamento de pedidos no BOB.  Por tr√°s da transfer√™ncia do pedido para o servi√ßo de entrega, transfer√™ncia para um dep√≥sito intermedi√°rio, etc., existe um modelo de status.  H√° um mon√≥lito inteiro, at√© dois, al√©m de v√°rias APIs de entrega.  Eles sabem muito mais sobre entrega. <br><br>  Essas √°reas parecem ser semelhantes, mas para o Processamento de pedidos no BOB e para o sistema de entrega, os status s√£o diferentes.  Por exemplo, alguns servi√ßos de correio n√£o enviam status intermedi√°rios, mas apenas finais: "entregues" ou "perdidos".  Outros, pelo contr√°rio, relatam detalhadamente a circula√ß√£o de mercadorias.  Todo mundo tem suas pr√≥prias regras de valida√ß√£o: para algu√©m, o email √© v√°lido, portanto ser√° processado;  para outros, n√£o √© v√°lido, mas o pedido ainda ser√° processado, porque existe um telefone para comunica√ß√£o e algu√©m dir√° que esse pedido n√£o ser√° processado. <br><br><h3>  Fluxo de dados </h3><br>  No caso de Kafka, surge a quest√£o de organizar o fluxo de dados.  Esta tarefa est√° relacionada com a escolha da estrat√©gia para v√°rios pontos, vamos passar por todos eles. <br><br><h4>  Em um t√≥pico ou em diferente? </h4><br>  Temos uma especifica√ß√£o de evento.  No BOB, escrevemos que esse pedido deve ser entregue e indicamos: o n√∫mero do pedido, sua composi√ß√£o, alguns c√≥digos de barra e SKU, etc.  Quando as mercadorias chegarem ao dep√≥sito, a entrega poder√° receber status, registros de data e hora e tudo o que for necess√°rio.  Al√©m disso, queremos receber atualiza√ß√µes sobre esses dados no BOB.  Estamos diante do processo inverso de obter dados da entrega.  √â o mesmo evento?  Ou √© uma troca separada que merece um t√≥pico separado? <br><br>  Provavelmente, eles ser√£o muito parecidos, e a tenta√ß√£o de criar um t√≥pico n√£o √© irracional, porque um t√≥pico separado √© consumidores separados, configura√ß√µes separadas, uma gera√ß√£o separada de tudo isso.  Mas n√£o √© um fato. <br><br><h4>  Novo campo ou novo evento? </h4><br>  Mas se voc√™ usar os mesmos eventos, surgir√° outro problema.  Por exemplo, nem todos os sistemas de entrega podem gerar um DTO que pode gerar BOBs.  Enviamos a eles um ID, mas eles n√£o os salvam, porque n√£o precisam deles e, do ponto de vista de iniciar o processo de barramento de eventos, esse campo √© obrigat√≥rio. <br><br>  Se introduzirmos uma regra para o barramento de eventos em que esse campo √© obrigat√≥rio, seremos for√ßados a definir regras de valida√ß√£o adicionais no BOB ou no manipulador de eventos de in√≠cio.  A valida√ß√£o come√ßa a aparecer no servi√ßo - n√£o √© muito conveniente. <br><br>    ‚Äî    .  ,   -   , ,  ,   ,      .       ‚Äî   .   ‚Äî    ,    .        JSON      . <br><br>   refunds        .     -,   refund update,     type, ,     update .      ¬´¬ª   ,  ,        type. <br><br><h4>   </h4><br>     Kafka   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Avro</a> ,          Confluent.        .        replication log,    ¬´¬ª.  ,    ,     : ,    .    ,     ,   ,    . <br><br><h4>    partitions </h4><br>   Kafka   partitions.          ,  ,  ,     . <br><br>       Kafka  .     partition,        .       . , ,    ,      .  , ,  ,    Kafka   partition,  Kafka       ‚Äî  ,  . <br><br>  Kafka  ?      (    JSON)   key.      -,   ,   partition  . <br><br>     refunds  ,     partition,   ,           . - ,            partition. <br><br><h4> Events vs commands </h4><br>    ,    . Event ‚Äî   :  ,  - -  (something_happened), , item    refund.    - ,   ¬´item ¬ª  refund  ,  ¬´ refund¬ª  -  . <br><br>  ,    ,        ‚Äî    ,   -  .     something_happened (item_canceled, refund_refunded),  something_should_be_done. , item   . <br><br>   ,  ,    .   ,        .   ,      do_something.     ,    - ;   ,   ;    ,   -,   -  .   ,    do_something,    ,   . <br><br><img src="https://habrastorage.org/webt/gy/xo/vm/gyxovmgvxv3wbwkv_k7mzluobls.png"><br><br>     RabbitMQ,    ,   http,    response ‚Äî  ,    .     Kafka,  ,     Kafka,   ,   ,    . <br><br>             ,    - ,  -       .    ,  , -   . ,     ¬´item_ready_to_refund¬ª,  ,  refund ,   ,    ¬´money_refunded¬ª.    ,   . <br><br><h3>  Nuances </h3><br>    :      ,    -  ,  ,     .   <strong>  </strong> ,  offset ,   . <br><br>    ,   ,     .    ,        events-bus,        ,         PostgreSQL,        MySQL  UNSIGNED INT,      PostgreSQL   INT.     ,  Id  . Symfony   . , ,  ,     ,     offset,       ,     .        ,  Symfony     ,          offset. <br><br> -    ‚Äî  ,  Kafka    ,    .       .  . <br><br>  Kafka    tooling   offset.    ,     ‚Äî      ,     , redeployments.   Kafka  tooling   offset,   . <br><br>   ‚Äî <strong>replication log vs rdkafka.so</strong> ‚Äî     .   PHP,   PHP,  ,  ,   Kafka   rdkafka.so,    - .  ,    ,  ,        - .  ,   . <br><br>      partitions,     <strong>consumers &gt;= topic partitions</strong> .       ,   .        ,      partitions.  ,      partition,    20  ,    ,     . ,     ,    partitions. <br><br><h2>  Monitoramento </h2><br> ,  ,   ,   ,      . <br><br> , ,       , , ,       ,        .   Kafka    ,       . ,         . <br><br><img src="https://habrastorage.org/webt/il/on/va/ilonvaqqf3tkfcv9reuyezxpgoq.png"><br><br>  ,  ,    ,   events-bus ,     . ,     Refund Tool  ,   BOB  -  ( ). <br><br><img src="https://habrastorage.org/webt/i4/9b/jf/i49bjfsr_lrypwz0_1qfkhhmcjq.png"><br><br>    consumer-group lag.  ,    .       ,     0,      . Kafka    ,     . <br><br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Burrow</a> ,       Kafka.    API  consumer-group  ,     .    Failed   warning,    ,         ‚Äî    ,  .   ,   . <br><br><img src="https://habrastorage.org/webt/4j/ht/go/4jhtgoqjn_0kdgvagxkg3flceng.png"><br><br>     API.   bob-live-fifa, partition refund.update.v1,  , lag 0 ‚Äî   offset -. <br><br><img src="https://habrastorage.org/webt/mh/gn/aq/mhgnaq2qcxamaejf1fkdkkkqnwu.png"><br><br>  <strong>updated_at SLA (stuck)</strong>   . ,    ,     .   Cron,  ,    5       refund (       ),  -    ,      .    Cron,    ,     0,   . <br><br> <b> ,   , </b> : <br><br><ul><li>    ; </li><li>    ; </li><li>     . </li></ul><blockquote>  ,      ‚Äî  API  Kafka,          . <br> -,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HighLoad++</a>     ,       ,         . <br> -,               <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">KnowledgeConf</a> .  ,  26 ,      . <br>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">++</a> ( DevOpsConf  ) ‚Äî      ,          . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445424/">https://habr.com/ru/post/pt445424/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445414/index.html">Como os livros de ci√™ncia sovi√©ticos se tornaram um artefato entre f√≠sicos e engenheiros na √çndia</a></li>
<li><a href="../pt445416/index.html">Por que os discos de vinil sobrevivem √† era digital</a></li>
<li><a href="../pt445418/index.html">Homo sapiens? J√° n√£o</a></li>
<li><a href="../pt445420/index.html">Existem 17 bilh√µes de computadores no c√≥rtex do seu c√©rebro</a></li>
<li><a href="../pt445422/index.html">Quais linguagens de programa√ß√£o s√£o as menos seguras?</a></li>
<li><a href="../pt445426/index.html">Otimiza√ß√£o para PostgreSQL servindo aplica√ß√£o Rails</a></li>
<li><a href="../pt445428/index.html">Wi-Fi de alta qualidade - a base da hospitalidade moderna e o motor dos neg√≥cios</a></li>
<li><a href="../pt445432/index.html">Gerenciador de Pacotes Unity</a></li>
<li><a href="../pt445434/index.html">Melhor Pior Emprego do Mundo: Procurando um Habraautor</a></li>
<li><a href="../pt445436/index.html">Reciclagem no DevOps - para o que se preparar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>