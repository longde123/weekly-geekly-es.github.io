<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äç‚úàÔ∏è üôãüèΩ üë©‚Äç‚öñÔ∏è Y de nuevo, captcha o nginx tambi√©n sabe bordar üôÖüèø üñ•Ô∏è üêè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 


 Fui a Habr y encontr√© en los borradores un art√≠culo in√©dito sobre captcha, quer√≠a formalizarlo y publicarlo, pero decid√≠ escribir un ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Y de nuevo, captcha o nginx tambi√©n sabe bordar</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485804/"><h2>  Introduccion </h2><br><p>  Fui a Habr y encontr√© en los borradores un <a href="https://postgres.men/web/nginx/nginx-fast-captcha/">art√≠culo</a> in√©dito sobre captcha, quer√≠a formalizarlo y publicarlo, pero decid√≠ escribir un nuevo art√≠culo cambiando ligeramente el mecanismo y las herramientas utilizadas.  En mi opini√≥n, ser√° √∫til leer un art√≠culo antiguo, no ser√° peor. </p><br><p>  El objetivo principal de escribir un nuevo art√≠culo es ni siquiera mostrar otro mecanismo de trabajo, cu√°nto mostrar las capacidades de nginx de las que a veces se olvidan por completo, consider√°ndolo un servidor proxy banal. </p><a name="habracut"></a><br><h2>  Condiciones </h2><br><p>  Para evitar que los bots descarguen archivos, se utiliza una prueba "captcha". </p><br><p>  Al formar un formulario para un salto de archivo, se crea una imagen con un c√≥digo y ciertas distorsiones para complicar su reconocimiento autom√°tico.  Tambi√©n hay almacenamiento para arreglar un par clave + c√≥digo para verificaci√≥n. </p><br><p>  Tras la confirmaci√≥n del formulario para descargar el archivo y verificar el c√≥digo captcha para que coincida con la clave, el usuario recibe un archivo o se genera un enlace √∫nico al archivo.  La unicidad del enlace est√° controlada por el backend.  El par clave + c√≥digo tambi√©n se elimina para evitar su reutilizaci√≥n. </p><br><p>  Hay un proxy que redirige todas las solicitudes al backend. </p><br><h2>  Los problemas </h2><br><p> La generaci√≥n de im√°genes complejas es una operaci√≥n bastante intensiva en recursos, y dado que no se utilizan todos los c√≥digos mostrados.  Es necesario crear alg√∫n tipo de mecanismo de almacenamiento en cach√© para las im√°genes no utilizadas para poder mostrarlas a otros usuarios. </p><br><p>  El c√≥digo y la clave son verificados por el backend, pero existen dificultades para transferir archivos grandes a trav√©s del backend, los enlaces √∫nicos tambi√©n requieren verificaci√≥n a nivel de backend, quiero deshacerme de la carga adicional en ellos. </p><br><h2>  Soluci√≥n </h2><br><h3>  Seleccionar funcionalidad </h3><br><p>  En realidad, el captcha en s√≠ consiste en una imagen y una clave determinada que corresponde al c√≥digo en la imagen que se almacena en el backend.  La imagen no es muy grande, la traducimos a Base64 y le damos una forma: </p><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"data:image/png;base64,{{ IMAGE CODE BASE64 }}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"key"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ KEY }}"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  O JSON: </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"data:image/png;base64,{{ IMAGE CODE BASE64 }}"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"{{ KEY }}"</span></span> } }</code> </pre> <br><p>  Si tenemos una parte del formulario que se est√° formando, entonces podemos usar <a href="http_ssi_module.html">SSI</a> para insertarlo en el cuerpo de la p√°gina, para esto habilitamos el modo correspondiente en la configuraci√≥n de nginx en el proxy: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">ssi</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br><p>  Y en el c√≥digo de la p√°gina del formulario insertamos: </p><br><pre> <code class="xml hljs">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"download"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"get"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-comment"><span class="hljs-comment">&lt;!--#include virtual="/x/captcha/generate"--&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br><p>  Por lo tanto, hemos asignado la funcionalidad de mapear captcha en <i>ubicaciones</i> o m√©todos separados.  Ahora puedes hacer el almacenamiento en cach√©. </p><br><blockquote>  S√≠, el mecanismo de <i>inclusi√≥n del lado</i> del <i>servidor (SSI)</i> est√° casi olvidado, pero el m√≥dulo nginx es m√°s vivo que todos los vivos y funciona muy r√°pidamente.  Y, por cierto, si proxy_pass_cache <i>almacena en cach√©</i> toda la p√°gina, el resultado de <i>incluir virtual</i> no se almacenar√° en cach√©, sino que se ejecutar√° cada vez que se solicite.  Esto le permite hacer que la inserci√≥n sea din√°mica. </blockquote><br><h3>  CAPTCHA CAPTCHA </h3><br><p>  Para implementar el almacenamiento en cach√©, necesitamos algo bastante aleatorio y controlado por el n√∫mero de opciones, la variable <i>$ request_id</i> es adecuada para este rol: es bastante aleatorio y hexadecimal, es decir, al elegir una cierta parte de esta variable, puede limitar el n√∫mero de elementos de cach√© a 16 ^ n, donde n - el n√∫mero de caracteres que necesitamos tomar de la variable.  Entonces </p><br><p>  Determine la zona de cach√©: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_path</span></span> /cache/nginx/captcha levels=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> keys_zone=captcha:<span class="hljs-number"><span class="hljs-number">10m</span></span> max_size=<span class="hljs-number"><span class="hljs-number">128m</span></span>;</code> </pre> <br><p>  Es importante determinar qu√© valor de n elegimos, respectivamente, los par√°metros dependen de esto: </p><br><ul><li>  niveles = 1: 2 </li><li>  max_size = 128m </li><li>  key_zone = captcha: 10m </li></ul><br><p>  Eso fue suficiente para todo, pero no hab√≠a nada superfluo.  A continuaci√≥n, determinamos la clave de cach√©: </p><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { ... <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$captcha_salt</span></span> <span class="hljs-string"><span class="hljs-string">'salt'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$request_id</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* "(\w</span></span>{4})$" ) { <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span>; } ...</code> </pre> <br><p>  La <i>variable $ captcha_salt</i> sigue siendo √∫til para nosotros, pero ahora protege contra posibles intersecciones de teclas.  Eleg√≠ el valor n como 4, lo que significa 16 ^ 4 ranuras de cach√©, y en promedio se <i>asignan 2kb</i> del tama√±o total de cach√© ( <i>max_size = 128m</i> ) para cada ranura, de lo contrario ser√° necesario aumentar el tama√±o m√°ximo. </p><br><p>  Hacer la <i>ubicaci√≥n</i> adecuada </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/generate { <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache</span></span> captcha; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_key</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">365d</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> any <span class="hljs-number"><span class="hljs-number">0s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-string"><span class="hljs-string">"captcha.service.domain.my"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://captcha_upstream/?cache_key=<span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span>; }</code> </pre> <br><p>  Las respuestas "buenas" del backend se almacenar√°n en cach√© casi para siempre, el resto no se almacenar√° en cach√©.  Y s√≠, puede resaltar de inmediato la funcionalidad de trabajar con captcha en un servicio separado. </p><br><blockquote>  Por cierto, se puede usar un mecanismo similar para generar pseudodin√°mica cuando el usuario presiona F5 y cada vez que se le muestra una nueva "imagen" aleatoria.  En este caso, el backend pr√°cticamente no est√° cargado. </blockquote><br><p>  Tambi√©n debemos restablecer el cach√© correspondiente al verificar el formulario, por lo que el backend, entre otras cosas, debe dar el valor de <i>cache_key</i> para pasarlo de nuevo al formulario como un campo <i>oculto</i> .  Desafortunadamente, la directiva <i>proxy_cache_purge</i> solo est√° disponible en la versi√≥n comercial.  No importa, hay un m√≥dulo <a href="https://github.com/FRiCKLE/ngx_cache_purge">cache_purge de</a> terceros, que puede ser un poco m√°s simple, pero suficiente para nosotros.  Entonces, <i>ubicaci√≥n</i> para vaciar el cach√©: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/cache/purge { internal; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_purge</span></span> captcha <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$arg_cache_key</span></span></span><span class="hljs-string">"</span></span>; }</code> </pre> <br><p>  Tiene la directiva <i>interna</i> , ya que no la vamos a usar p√∫blicamente.  Y para llamar a esta <i>ubicaci√≥n,</i> usaremos la directiva <i>espejo</i> del m√≥dulo <a href="http_mirror_module.html">http_mirror_module</a> : </p><br><p>  Es decir, hacemos una solicitud paralela para restablecer el cach√© mediante la clave de la variable <i>$ arg_cache_key</i> , que se transmite en el formulario.  Luego, simplemente enviamos la solicitud a nuestro backend donde se realiza el resto del procesamiento. </p><br><h3>  La forma espinosa de optimizaci√≥n </h3><br><p>  Aqu√≠, de hecho, quer√≠a desarrollar un tema: c√≥mo separar la verificaci√≥n del c√≥digo captcha y la devoluci√≥n del archivo.  C√≥mo evitar que el cach√© se elimine con solicitudes incorrectas.  Luego, para optimizar cada vez m√°s, pero todo se reduce al hecho de que, en general, ya no necesitamos el backend ... en absoluto ... porque ya lo tenemos todo. </p><br><p>  La tarea que qued√≥ con el servidor en t√©rminos de verificaci√≥n de captcha es verificar la clave + c√≥digo y eliminar este par del repositorio.  Verificar la clave + c√≥digo puede ser una simple comparaci√≥n de la cantidad md5 con la clave.  Para esto, un m√≥dulo es suficiente para nosotros: <a href="http_secure_link_module.html">http_secure_link_module</a> .  Es decir, la clave se puede representar como una f√≥rmula: </p><br> <code>key = md5_baseurl( salt + code )</code> <br> <p>  Al mismo tiempo, el enlace a la ranura de cach√© (clave de cach√©) no nos har√° da√±o, lo agregamos: </p><br> <code>key = md5_baseurl( salt + code + cache_key )</code> <br> <p>  Tenemos sal: esta es la variable <i>$ captcha_salt</i> (por lo que fue √∫til), pero mantener la sal en dos lugares del backend y el proxy es malo, as√≠ que hagamos esto: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/salt { <span class="hljs-section"><span class="hljs-section">allow</span></span> {{ <span class="hljs-attribute"><span class="hljs-attribute">captcha</span></span> backend IPs }}; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">"</span></span>; }</code> </pre> <br><p>  Y deja que el backend vaya al proxy de la sal. </p><br><p>  La pregunta permanece con el repositorio, donde almacenamos un par clave + c√≥digo que necesita ser limpiado.  Para hacer esto, el mecanismo de almacenamiento en cach√© que ya hemos implementado es adecuado para nosotros.  Lo √∫nico es que no procesamos el resultado <i>cache_purge</i> de <i>ninguna manera</i> , sino que simplemente <i>reflejamos</i> la solicitud, pero esto se puede solucionar.  Y s√≠, eso justifica el uso de una clave de cach√© al crear una clave captcha. </p><br><h3>  Verificaci√≥n de c√≥digo </h3><br><p>  Reescribir descargas de archivos de <i>ubicaci√≥n</i> : </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Context download; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-File-Name <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Key <span class="hljs-variable"><span class="hljs-variable">$arg_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Code <span class="hljs-variable"><span class="hljs-variable">$arg_code</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Cache-Key <span class="hljs-variable"><span class="hljs-variable">$arg_cache_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/check; <span class="hljs-attribute"><span class="hljs-attribute">proxy_intercept_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> = /download/fail; }</code> </pre> <br><p>  Paso los par√°metros requeridos con encabezados.  Esto es opcional, pero es m√°s conveniente para m√≠.  Proxy el procesamiento a la ubicaci√≥n local de la verificaci√≥n captcha.  Adem√°s, se pasa <i>context = download</i> , de modo que en el controlador podr√≠amos producir uno u otro resultado dependiendo de ello.  En este caso, el controlador puede volver a nosotros: </p><br><ul><li>  403: error de verificaci√≥n del c√≥digo.  En realidad, por lo tanto, <i>se</i> incluye <i>proxy_intercept_errors</i> y se declara una ubicaci√≥n para la redirecci√≥n en caso de error; </li><li>  404: error de limpieza de cach√©.  El m√≥dulo <i>cache_purge</i> si no hay nada en el cach√© con dicha clave devuelve 404; </li><li>  200 + <i>Accel-Redirect</i> : en la <i>ubicaci√≥n de la</i> carga <i>del</i> archivo, en caso de que el chequeo de captcha haya salido bien.  En nuestro caso, ser√° <i>X-Accel-Redirect: / store / file</i> </li></ul><br><blockquote>  Si <i>error_page</i> pudiera manejar c√≥digos <i>2XX</i> , entonces uno podr√≠a hacerlo solo.  De lo contrario, debe utilizar el mecanismo <i>Accel-Redirect</i> .  Si realmente lo desea, puede separar los controladores de errores 403 y 404; </blockquote><br><p>  Hacer un error de <i>ubicaci√≥n</i> simple: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download/fail { internal; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL DOWNLOAD"</span></span>; }</code> </pre> <br><p>  Puede devolver cualquier cosa en esta ubicaci√≥n, seg√∫n sus necesidades. </p><br><p>  Hacemos que la ubicaci√≥n del archivo se cargue: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /store/file { internal; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Disposition <span class="hljs-string"><span class="hljs-string">"attachment; filename=\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$arg_filename</span></span></span><span class="hljs-string">\""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">alias</span></span> /spool/tmp/; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; }</code> </pre> <br><p>  En primer lugar, es importante que sea <i>interno</i> ; esto significa que no podr√° descargar el archivo directamente a trav√©s de √©l, solo a trav√©s de la redirecci√≥n.  Tambi√©n se puede modificar en funci√≥n de las necesidades y no regalar el archivo local, sino que representa la solicitud del servicio de almacenamiento de archivos. </p><br><p>  La siguiente <i>ubicaci√≥n</i> que tenemos para la verificaci√≥n de captcha: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">secure_link_md5</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_code</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">secure_link</span></span> <span class="hljs-variable"><span class="hljs-variable">$http_x_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$secure_link</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL CHECK CODE"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/purge; }</code> </pre> <br><p>  Tiene 2 bloques: verificaci√≥n de c√≥digo y proxy para borrar el cach√©.  Al mismo tiempo, si no se aprob√≥ la verificaci√≥n del c√≥digo, devuelva inmediatamente 403 (el texto no es importante, ya que no se usa m√°s). </p><br><p>  Proxying a <i>/ x / captcha / purge</i> devolver√° 2 opciones de respuesta: </p><br><ul><li>  200 + <i>Accel-Redirect</i> - tras el lavado exitoso de cach√©.  La redirecci√≥n ser√° a <i>X-Accel-Redirect: / x / captcha / check / ok</i> ; </li><li>  404 - si no hubiera nada que limpiar.  Este resultado se pasar√° arriba a <i>/ download</i> y se procesar√° en √©l <i>error_page</i> ; </li></ul><br><p>  Se realiza un controlador separado para la respuesta positiva de <i>/ x / captcha / purge</i> debido al hecho de que, en primer lugar, necesitamos alcanzar un mayor nivel de representaci√≥n, y no entre <i>/ download</i> y <i>/ x / captcha / check</i> .  En segundo lugar, ser√≠a bueno dar una respuesta positiva con respecto al contexto. </p><br><p>  Comencemos con un controlador de respuesta positiva: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check/ok { internal; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$http_x_context</span></span> = <span class="hljs-string"><span class="hljs-string">'download'</span></span> ) { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/store/file?filename=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_file_name</span></span></span><span class="hljs-string">"</span></span>; } ... <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; }</code> </pre> <br><p>  En realidad, dependiendo del valor de la variable <i>$ http_x_context</i> ( <i>encabezado</i> <i>X-Context</i> ), podemos determinar qu√© <i>Accel-Redirect</i> responder√° con <i>/ x / captcha / check</i> .  Esto significa que puede usar este mecanismo en otros lugares adem√°s de descargar el archivo. </p><br><p>  Borrar el cach√© es bastante simple: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/purge { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_purge</span></span> captcha <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/x/captcha/check/ok"</span></span>; }</code> </pre> <br><p>  En general, eso es todo, al final obtuvimos la siguiente configuraci√≥n de nginx: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_path</span></span> /cache/nginx/captcha levels=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> keys_zone=captcha:<span class="hljs-number"><span class="hljs-number">10m</span></span> max_size=<span class="hljs-number"><span class="hljs-number">128m</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { ... <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Context download; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-File-Name <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Key <span class="hljs-variable"><span class="hljs-variable">$arg_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Code <span class="hljs-variable"><span class="hljs-variable">$arg_code</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Cache-Key <span class="hljs-variable"><span class="hljs-variable">$arg_cache_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/check; <span class="hljs-attribute"><span class="hljs-attribute">proxy_intercept_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> = /download/fail; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download/fail { internal; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL DOWNLOAD"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /store/file { internal; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Disposition <span class="hljs-string"><span class="hljs-string">"attachment; filename=\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$arg_filename</span></span></span><span class="hljs-string">\""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">alias</span></span> /spool/tmp/; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; } ... <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$captcha_salt</span></span> <span class="hljs-string"><span class="hljs-string">'salt'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$request_id</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* "(\w</span></span>{4})$" ) { <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/generate { <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache</span></span> captcha; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_key</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">365d</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> any <span class="hljs-number"><span class="hljs-number">0s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-string"><span class="hljs-string">"captcha.service.domain.my"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://captcha_upstream/?cache_key=<span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/salt { <span class="hljs-section"><span class="hljs-section">allow</span></span> {{ <span class="hljs-attribute"><span class="hljs-attribute">captcha</span></span> backend IPs }}; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">secure_link_md5</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_code</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">secure_link</span></span> <span class="hljs-variable"><span class="hljs-variable">$http_x_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$secure_link</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL CHECK CODE"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/purge; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check/ok { internal; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$http_x_context</span></span> = <span class="hljs-string"><span class="hljs-string">'download'</span></span> ) { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/store/file?filename=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_file_name</span></span></span><span class="hljs-string">"</span></span>; } ... <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/purge { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_purge</span></span> captcha <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/x/captcha/check/ok"</span></span>; } }</code> </pre> <br><p>  A qu√© debe prestar atenci√≥n: <br></p><ul><li>  Accel-Redirect solo funciona cuando el estado de respuesta es 2XX.  Es cierto, por desgracia, no se ha escrito nada sobre esto en ninguna parte, y los adherentes de nginx no est√°n de acuerdo; </li><li>  Las <i>ubicaciones</i> privadas cercanas <i>permiten 127.0.0.1;</i>  <i>negar todo;</i>  ya sea <i>interno;</i>  , dependiendo de si llegamos a esta <i>ubicaci√≥n a</i> trav√©s de <i>proxy_pass</i> o a trav√©s de <i>Accel-Redirect</i> ; </li><li>  Todas las <i>ubicaciones</i> asociadas con captcha se resaltan en <i>/ x / capcha / ...</i> para que sea posible formar un microservicio; </li></ul><br><p>  Para mayor claridad, tambi√©n dibuj√© un diagrama del trabajo: </p><br><img src="https://habrastorage.org/getpro/habr/post_images/245/8bc/6c8/2458bc6c8defdbbf6f6f0bcfccb0f05a.png" alt="imagen"><br><h2>  Resumen </h2><br><p>  Como resultado, desde el backend solo necesitamos generar directamente la imagen y el c√≥digo para ello.  Nginx puede manejar f√°cilmente el resto.  Por supuesto, estas son operaciones l√≥gicas relativamente simples, pero sin embargo, esto acelerar√° significativamente el trabajo y reducir√° la carga en el backend.  Y, de hecho, no utilizamos ning√∫n mecanismo inusual, sino solo: </p><br><ul><li>  proxy_cache; </li><li>  Accel-Redirect </li><li>  error_page; </li><li>  enlace_seguro </li><li>  cache_purge; </li></ul><br><p>  El resto es la construcci√≥n correcta de cadenas l√≥gicas. </p><br><p>  Tambi√©n eliminamos el repositorio temporal de backend para c√≥digos y enlaces √∫nicos.  Sin embargo, hicieron un elemento obligatorio del sistema nginx, aumentando su peso funcional. </p></div></div><p>Source: <a href="https://habr.com/ru/post/485804/">https://habr.com/ru/post/485804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485790/index.html">Entrevistas: expectativas vs realidad</a></li>
<li><a href="../485792/index.html">Ivan Lilekvist y Kim Dotkom, una gran entrevista: la historia de Megaupload, extradici√≥n a los Estados Unidos, libertad, bitcoin. Parte 2</a></li>
<li><a href="../485794/index.html">¬øEst√°s desarrollando en .NET Core? Vamos a Ubuntu, he preparado todo</a></li>
<li><a href="../485796/index.html">Resuelve lo insoluble</a></li>
<li><a href="../485800/index.html">Digitalizaci√≥n vs. Automatizaci√≥n</a></li>
<li><a href="../485806/index.html">Coronavirus: del SARS a 2019-nCoV</a></li>
<li><a href="../485810/index.html">Ganchos de tiempo de compilaci√≥n de elixir</a></li>
<li><a href="../485812/index.html">7 etapas de prueba de evoluci√≥n en una empresa</a></li>
<li><a href="../485820/index.html">Persona muy atacada: descubra qui√©n es el objetivo principal de los cibercriminales en su empresa.</a></li>
<li><a href="../485824/index.html">C√≥mo hacer un bot que convierta una foto en un c√≥mic. Tercera parte Modelo de alojamiento gratuito sin servidor + GPU</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>