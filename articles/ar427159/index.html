<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ก ๐ญ ูููู ุจุฌูุน ุณุฌูุงุช ุฌุฏุงุฑ ุงูุญูุงูุฉ Mikrotik ูู ูุงุนุฏุฉ ุจูุงูุงุช ๐๐ป ๐๐ผ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุณุงุก ุงูุฎูุฑ 

 ุฃุฑูุฏ ุฃู ุฃุฎุจุฑู ูุฏู ุณูููุฉ ูุทุจูุนูุฉ ุชูููู ุฎุงุฏู ุฌูุน ุจูุงูุงุช ุชุนุฑูู ุญุฑูุฉ ูุฑูุฑ ุงูุดุจูุฉ ูุฃุฌูุฒุฉ ุชูุฌูู Mikrotik. 

 ุงูุบุฑุถ: ุณูููู ุงููุฏู ุชุฎุฒูู ุณุฌูุงุช ุฌุฏ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ูููู ุจุฌูุน ุณุฌูุงุช ุฌุฏุงุฑ ุงูุญูุงูุฉ Mikrotik ูู ูุงุนุฏุฉ ุจูุงูุงุช</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427159/" style=";text-align:right;direction:rtl">  ูุณุงุก ุงูุฎูุฑ <br><br>  ุฃุฑูุฏ ุฃู ุฃุฎุจุฑู ูุฏู ุณูููุฉ ูุทุจูุนูุฉ ุชูููู ุฎุงุฏู ุฌูุน ุจูุงูุงุช ุชุนุฑูู ุญุฑูุฉ ูุฑูุฑ ุงูุดุจูุฉ ูุฃุฌูุฒุฉ ุชูุฌูู Mikrotik. <br><br>  <b>ุงูุบุฑุถ:</b> ุณูููู ุงููุฏู ุชุฎุฒูู ุณุฌูุงุช ุฌุฏุงุฑ ุงูุญูุงูุฉ "ุงููุถุบ" ูู ูุงุนุฏุฉ ุจูุงูุงุช ููุฒูุฏ ูู ุงูุชุญููู. <br><br>  <b>ุงููุณุงุฆู:</b> ุฃู ุชูุฒูุน ุฌุฏูุฏ ูู Linux ูุน rsyslogd v8 ูุงูุฅุตุฏุงุฑุงุช ุงูุฃุญุฏุซ ููุงุณุจ ููุชูููุฐ ุ ุฑุจูุง ุณุชุนูู ุงูุตูุบุฉ ุงูููุชุฑุญุฉ ุนูู ุงูุฅุตุฏุงุฑ 7 ุฃูุถูุง.  ูุญู ุจุญุงุฌุฉ ุฃูุถูุง ุฅูู ูุธุงู ุฅุฏุงุฑุฉ ููุงุนุฏ ุงูุจูุงูุงุช ุ ุงุฎุชุฑุช mariadb.  ุณูุฎุชูู ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงุนุชูุงุฏูุง ุนูู ุนุฏุฏ ุงูููุงุนุฏ ุงููุณุฌูุฉ ุ ูุฃู ุญุฌู ูุญุฑู ุงูุฃูุฑุงุต ุญุณุจ ุชูุฏูุฑู ุ ูู ุญุงูุชู ุ ูุชู ุชุณุฌูู 30-40 ูุงุนุฏุฉ ุ ููู ูุง ููุฑุจ ูู 1200 ุฃูู ุณุทุฑ ูู ุงูููู.  ุฎูุงู ุดูุฑ ุงุณุชุฎุฏุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ ุจูุง ูู ุฐูู ุงูููุงุฑุณ ุ ููุช ุฅูู 3.8 ุบูุบุงุจุงูุช. <br><br>  <b>ุงููููุงูููุง:</b> ูุฑุณู ุฌูุงุฒ ุงูุชูุฌูู ุณุฌููุง ุฅูู ุงูุฎุงุฏู ุงูุจุนูุฏ ุนุจุฑ UDP.  ุจุงุณุชุฎุฏุงู ุงูุชุนุจูุฑุงุช ุงูุนุงุฏูุฉ ุ ูููู ุฎุงุฏู rsyslog ุจุชูุธูู ุณูุงุณู ุงููุนูููุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ ุ ููููู ุจุฅูุดุงุก ุฅุฏุฑุงุฌ SQL ูุฅุฑุณุงูู ุฅูู ูุธุงู ุฅุฏุงุฑุฉ ููุงุนุฏ ุงูุจูุงูุงุช.  ูููู DBMS ุ ุจุงุณุชุฎุฏุงู ูุดุบู ูุจู ุงูุฅุฏุฑุงุฌ ุ ุจุฅุฌุฑุงุก ุชูุธูู ุฅุถุงูู ููุตู ููุญููู ุงูุชู ูุง ูููู ุชุญููููุง ูู rsyslog. <br><a name="habracut"></a><br><h4 style=";text-align:right;direction:rtl">  <b>ุชูููู RSYSLOG</b> </h4><br>  ุชุญุฑูุฑ ุงูููู /etc/rsyslog.conf <br>  ุฃุถู ุงูุฃุณุทุฑ ุงูุชุงููุฉ ููุงู: <br><br><pre style=";text-align:right;direction:rtl"><code class="plaintext hljs">module(load="ommysql") module(load="imudp") input(type="imudp" port="514")</code> </pre> <br>  ูุจุงูุชุงูู ุ ูููู ุจุชุญููู ุงููุญุฏุงุช ุงููุงุฒูุฉ ูููุชุญ ูููุฐ 514 UDP. <br><br>  ูุจุฏู ุฎุท ุงูุณุฌู ูู Mikrotik ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">20180927155341 BLOCKSMKNETS forward: in:ether6 - LocalTORF out:VLAN55 - RT_INET, src-mac 00:15:17:31:b8:d7, proto TCP (SYN), 192.168.0.234:2457-&gt;192.168.6.14:65535, len 60</code> </pre> <br>  ููุง ุชุฑูู ุ ุณูููู ูู ุงูุตุนุจ ุชุฎุฒูู ุงููุซูุฑ ูู ุงูุฅุถุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุฎุชูุงุฑ ูุงุถุญ. <br>  ูู ุงููุงุญูุฉ ุงููุธุฑูุฉ ุ ุฃุญุชุงุฌ ุฅูู ุฅุถุงูุฉ ูุฐู ุงูุจูุงูุงุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">20180927155341 ether6 VLAN5 192.168.0.234 2457 192.168.6.14 65535 00:15:17:31:b8:d7 TCP SYN forward BLOCKSMKNETS 60</code> </pre> <br>  ูู ุฃุณุชุทุน ุงูุญุตูู ุนูู ูุซู ูุฐุง ุงูุฎุท ุจุงุณุชุฎุฏุงู rsyslog ูุงุญุฏ ููุท.  ูุณุชุฎุฏู ูุธุงู Rsyslog ุงููุธุงูู POSIX ERE / BRE ุ ูุฐูู ูุง ุชูุฌุฏ ุทุฑููุฉ ูุชุทุจูู ููุฒุงุช ูุซู lookahead ุฃู lookbehind. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุงู</a> ุฃุฏุงุฉ ุชุณูุญ ูู ุจุชุตุญูุญ ุงููุธุงูู ุ ุฌุฑุจู ุ ุฑุจูุง ููููู ูุตู ุงููููุฐ ุนู ุงูุนููุงู ุ ููุฐูู ุงุณู ุงููุงุฌูุฉ ูู ุงูุฏุงุฎู: ูุงูุฎุฑูุฌ:.  ููุท ุถุน ูู ุงุนุชุจุงุฑู ุฃู ุจุนุถ ุจุฑูุชููููุงุช ุงูุฑูุงุถุฉ ูุงูููุงูุฆ ููููุฏุฉ. <br><br>  ุจุดูู ุนุงู ุ ูุงู ุงููุงุชุฌ ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">20180927155341 in:ether6 out:VLAN5 192.168.0.234:2457 192.168.6.14:65535 00:15:17:31:b8:d7 TCP (SYN) forward BLOCKSMKNETS 60</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุงู</a> ูุซุงุฆู ุญูู ููููุฉ ุทูู ุงููุธุงู ุงูุฃุณุงุณู rsyslog. <br><br>  ูู ุงูุดูู ุงูููุงุฆู ุ ุณูุจุฏู ููู ุงูุชูููู ูุงุณุชูุงู ุงูุณุฌู ูู Mikrotik /etc/rsyslog.d/20-remote.conf ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$template tpl_traflog,"insert into traflog.traffic (datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len) values ('%timereported:::date-mysql%', '%msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%', '%msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end%', '%msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end%', '%msg:R,ERE,0,DFLT:[ax]+--end%', '%msg:F,32:2%', '%msg:R,ERE,0,DFLT:[0-9]+$--end%' )",SQL if ($fromhost-ip == '192.168.0.230') and ($syslogtag contains "firewall") then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="rsyslogger" template="tpl_traflog") stop}</code> </pre><br>  ูู ุงูุณุทุฑ ุงูุฃูู ุ ูุตู ุงููุงูุจ (ุงููุงูุจ) ูู ุณุทุฑ ูู ููุฏ SQL ููููู ุฅูู DBMS. <br>  ุงูุณุทุฑ ุงูุซุงูู ูู ุงูุดุฑุท ุงูุฐู ุณูุญุฏุซ ููู ุงูุฅุฌุฑุงุก ุ ุฃู ุงูุณุฌู ูู DBMS. <br>  ุชุจุฏู ุงูุญุงูุฉ ููุง ููู: ุฅุฐุง ูุงู ูุตุฏุฑ ุงูุณุฌู = 192.168.0.230 ( <code>if ($fromhost-ip == '192.168.0.230')</code> ) ูุฅุฐุง ูุงู ุณุทุฑ msg ูุญุชูู ุนูู "ุฌุฏุงุฑ ุญูุงูุฉ" (ู (ูุญุชูู $ syslogtag ุนูู "ุฌุฏุงุฑ ุญูุงูุฉ")) ุ ูุงุณุชุฎุฏู ุงููุญุฏุฉ ุงูููุทูุฉ ommysql ูุน ูุนููุงุช ุงูุงุชุตุงู ( <code>then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="..."</code> ) ูุณูู ุงููููุฐุฌ tpl_traflog ( <code>template="tpl_traflog")</code> ) ุ ูุจุนุฏ ุฐูู ูุชููู ุนู ูุนุงูุฌุฉ ุงูุฎุท ( <code>stop}</code> ). <br><br>  ูู ุงููููู ุฃู ูููู ููุงู ุฎุทุฃ ูู ุญุงูุชู ุ ูุฏ ูููู ุฐูู ุจุณุจุจ ุฃุณูุงุก ุงููุงุฌูุงุช ุฃู ุจุงุฏุฆุงุช ุงูุณุฌู ุ ุฑุจูุง ุดูุก ุขุฎุฑ.  ููุชุตุญูุญ ุ ุณูููู ุจูุง ููู ุ ูุงูุชุนููู ุนูู ุงูุณุทุฑ ุงูุซุงูู ุ ูุฅุถุงูุฉ ูููุฐุฌ ุฌุฏูุฏ ูุดุฑุทูู ุฌุฏูุฏูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$template tpl_traflog_test,"%timereported:::date-mysql% %msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end% %msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end% %msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end% %msg:R,ERE,0,DFLT:[ax]+--end% %msg:F,32:2% %msg:R,ERE,0,DFLT:[0-9]+$--end%\n" if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" )} if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" template="tpl_traflog_test" ) stop}</code> </pre> <br>  ุฃุนุฏ ุชุดุบูู ุงููุณุฌู. <br><br>  ูุดุจู ุงููุงูุจ tpl_traflog_test tpl_traflog ุ ูููู ุจุฏูู SQL INSERT. <br><br>  ูุถูู ุงูุดุฑุท ุงูุฃูู ุงูุณุทุฑ ุบูุฑ ุงููุนุงูุฌูช msgูช ุฅูู ุงูููู /var/log/remote/192.168.0.230.log ุ ูุฃู ุงููุงูุจ ุบูุฑ ูุญุฏุฏ. <br><br>  ุงูุดุฑุท ุงูุซุงูู ูุถูู ุงูุณุทุฑ ุงูุฐู ุชูุช ูุนุงูุฌุชู ุฅูู ููุณ ุงูููู. <br>  ูุฐูู ุณูููู ุฃูุซุฑ ููุงุกูุฉ ููููุงุฑูุฉ. <br>  ุจุนุฏ ุฐูู ุ ูู ุจุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช. <br><br><h4 style=";text-align:right;direction:rtl">  <b>ูุณุชุนุฏ DB</b> </h4><br>  ุณูุฎูุถ ุฅุนุฏุงุฏ DBMS ุ ูู ุดูุก ููุงุณู ููุง. <br><br>  ูุจุฏุฃ ูุญุฏุฉ ุงูุชุญูู ุงูุฎููุฉ ูุชูููุฐ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุชุงููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   create database traflog character set utf8 collate utf8_bin; use traflog; --  create table traffic (id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, datetime DATETIME, inif VARCHAR(20), outif VARCHAR(20), src VARCHAR(21), sport INT(5), dst VARCHAR(21), dport INT(5), smac VARCHAR(17), proto VARCHAR(4), flags VARCHAR(11), chain VARCHAR(8), logpref VARCHAR(24), len INT(5)) ENGINE=MYISAM; --  create user rsyslogger@localhost identified by '...'; grant all privileges on traflog.* to rsyslogger@localhost;</span></span></code> </pre><br>  ุงูุฌุฏูู ุฌุงูุฒ ุ ุงููุณุชุฎุฏู. <br><br>  ุงูุขู ูู ุจุฅุถุงูุฉ ูุดุบู ุ ูุณูู ููุนู ูุง ูุดู ุงููุณุฌู ูู ูุตู ุงูุนููุงู ุนู ุงููููุฐ ุ ูุชูุธูู ุฃุณูุงุก ุงููุงุฌูุงุช ุ ูุฅุฒุงูุฉ ุงูุฃููุงุณ ูู ุงูุนูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   traffic DELIMITER // create TRIGGER delim_ip_port_flags BEFORE insert ON traffic FOR EACH ROW begin set NEW.inif = REGEXP_REPLACE ((NEW.inif), 'in:', '' ); set NEW.outif = REGEXP_REPLACE ((NEW.outif), 'out:', '' ); set NEW.sport = REGEXP_REPLACE ((NEW.src), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.src = REGEXP_REPLACE ((NEW.src), ':[0-9]+', '' ); set NEW.dport = REGEXP_REPLACE ((NEW.dst), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.dst = REGEXP_REPLACE ((NEW.dst), ':[0-9]+', '' ); set NEW.flags = REGEXP_REPLACE ((NEW.flags), '\\(|\\)', '' ); end // delimiter ;</span></span></code> </pre> <br>  ูุจุญุซ REGEXP_REPLACE ุนู ุงููุนููุฉ ุงูุซุงููุฉ ุจุนุฏ ุงูุนูุงูุฉ ุงูุนุดุฑูุฉ (ุงูููุณู ุงูุนุงุฏู) ููุณุชุจุฏููุง ุจุงููุนุงูู ุงูุซุงูุซ ุ ููู ุญุงูุชูุง ูุง ููุฌุฏ ุดูุก ุจูู ุนูุงูุชู ุงูุงูุชุจุงุณ ุ ูุจุงูุชุงูู ูุฅูู ุจุจุณุงุทุฉ ูุฒูู ูุง ูุนุซุฑ ุนููู. <br><br>  ููููู ุจุฅุฏุฑุงุฌ ุงุฎุชุจุงุฑ ุ ุนูู ุบุฑุงุฑ ุงูุทุฑููุฉ ุงูุชู ุณูููู ุจูุง ุงููุณุฌู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   insert into traffic (datetime, inif, outif, src, dst, smac, proto, chain, logpref) values (20180730075437, 'in:ether6', 'out:VLAN55', '192.168.0.234:4997', '192.168.6.18:65535', '00:15:17:31:b8:d7', 'TCP', '(SYN)', 'forward', 'BLOCKSMKNETS');</span></span></code> </pre> <br>  ุฏุนูุง ูุฑู ูุง ุญุฏุซ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tarffic;</code> </pre> <br>  ุฅุฐุง ูุงู ูู ุดูุก ุตุญูุญูุง ุ ูุงูุชูู.  ุฅุฐุง ูู ููู ูุฐูู ุ ุงุจุญุซ ุนู ุงูุฎุทุฃ. <br><br>  ุฃุถู ููุฑุณ ูุงุญุฏ ุนูู ุงูุฃูู.  ุฃูุง ูุณุช ุฎุจูุฑูุง ูู ุฅูุดุงุก ุงูููุงุฑุณ ุ ูููู ููุง ุฃููููุง ุ ูู mysql ุ ูู ุงูุฃุตุญ ุงุณุชุฎุฏุงู ุงูููุงุฑุณ ุฐุงุช ุญููู ุงูุฑุจุท ุงููุฎุชููุฉ ููุงุณุชุนูุงูุงุช ุงููุฎุชููุฉ ุ ุญูุซ ูููู ุฃู ูุณุชุฎุฏู ุงุณุชุนูุงู ูุงุญุฏ ููุฑุณ ูุงุญุฏ ููุท (ุฃู ูู ุฃูุง ุนูู ุฎุทุฃุ).  ุฅุฐุง ูููุช ุ ุงูุนู ุฐูู ุญุณุจ ุชูุฏูุฑู. <br>  ุบุงูุจูุง ูุง ูุชุนูู ุนูู ุชูุฏูู ุทูุจุงุช ุจุจุงุฏุฆุฉ ูุนููุฉ ุ ูุฐูู ุฃุถูุช ูุฐุง ุงูููุฑุณ: <br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  create index traffic_index on traffic (datetime,logpref,src);</span></span></code> </pre> <br>  ุชู. <br><br>  ุชุญุชุงุฌ ุงูุขู ุฅูู ุงูุจุฏุก ูู ุงูุฅุฑุณุงู ุนูู ุฌูุงุฒ ุงูุชูุฌูู ุ ูุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช ุฎุงุฏู ุงูุณุฌู ุนู ุจูุนุฏ ูุงูุฅุฌุฑุงุก ุฅููู ุ ูุฅุถุงูุฉ ุฎูุงุฑ ุงูุณุฌู ุฅูู ุฅุญุฏู ููุงุนุฏ ุฌุฏุงุฑ ุงูุญูุงูุฉ ุ ูุฅุถุงูุฉ ุจุงุฏุฆุฉ ูุง ุชุฒูุฏ ุนู 24 ุญุฑููุง. <br><br>  ูู ูุญุฏุฉ ุชุญูู Mikrotik ุ ูุจุฏู ุงูุฃูุฑ ูุซู ูุฐุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">/system logging action set 3 remote=192.168.0.94 src-address=192.168.0.230 add name=remote2 remote=192.168.0.19 syslog-facility=local6 target=remote /system logging add action=remote topics=error,account,critical,event,info add action=remote2 topics=firewall /ip firewall filter ... add action=drop chain=input comment="drop ssh brute forcers" dst-port=22,8291 log=yes log-prefix=DROP_SSH_BRUTE protocol=tcp src-address-list=ssh_blacklist ...</code> </pre><br>  ุญูุซ 192.168.0.230 ูู ุนููุงู ุฌูุงุฒ ุงูุชูุฌูู ุ 192.168.0.19 ูู ุนููุงู ุฎุงุฏู ุงูุณุฌู ูุณุฌูุงุช ุฌุฏุงุฑ ุงูุญูุงูุฉ ุ ู 192.168.0.94 ูู ุฎุงุฏู ุณุฌู ุขุฎุฑ ุ ูุฏู ุณุฌูุงุช ูุธุงู Mikrotik ููุงู ุ ูุญู ูุณูุง ุจุญุงุฌุฉ ุฅููู ุงูุขู.  ุฅุนุฏุงุฏูุง ุจุนูุฏ 2. <br><br>  ุจุนุฏ ุฐูู ุ ุงูุธุฑ ูุง ููุฏุฑุฌ ูู ุงูููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">tail -f /var/log/remote/192.168.0.230.log</code> </pre> <br>  ูุฌุจ ุฃู ุชูุชูู ุงูุฎุทูุท ูู ุฌูุงุฒ ุงูุชูุฌูู ุฅูู ุงูููู ุ ูุง ูู ูุชู ุชุดุบูู ุงููุงุนุฏุฉ ุงูุฎุงุตุฉ ุจู ูู ูุซูุฑ ูู ุงูุฃุญูุงู. <br><br>  ุฅุฐุง ูุงูุช ุจุนุถ ุงูุญููู ููููุฏุฉ ุ ุฃู ุฃู ููุช ุงูุชุณูุณู ู inif ู outif ู src ู dst ู smac ู proto ู flags ู chain ู logpref ู len ุบูุฑ ูุชุจูุน ุ ูููููู ูุญุงููุฉ ุชุบููุฑ ุงููุนููุฉ ูู ููุงูุจ ุชุตุญูุญ ุงูุฃุฎุทุงุก ูู ุงููุณุฌู ุ ูุงุณุชุจุฏุงู BLANK ุจู DLFT.  ุซู ุจุฏูุงู ูู ูุฑุงุบ ุฃู ุญูู ุ ุณุชุธูุฑ ุจุนุถ ุงูุญุฑูู ุ ููุง ุฃุชุฐูุฑ ุฃููุง ูููุง ุจุงููุนู.  ุฅุฐุง ุญุฏุซ ุฐูู ุ ููุฐุง ูุนูู ุฃู ููุงู ุฎุทุฃ ูุง ูู ุงูุฌุฏูู ุงูุนุงุฏู ูุชุญุชุงุฌ ุฅูู ุฅุตูุงุญู. <br><br>  ุฅุฐุง ุณุงุฑ ูู ุดูุก ููุง ููุจุบู ุ ููู ุจุฅููุงู ุดุฑูุท ุงูุงุฎุชุจุงุฑ ูุงููุงูุจ. <br><br>  ุชุญุชุงุฌ ุฃูุถูุง ุฅูู ุชุดุบูู ุงูุชููุฆุฉ ุงูุงูุชุฑุงุถูุฉ ูู /etc/rsyslog.d/ ุฃุฏูุงู ุ ูุฃุนุฏุช ุชุณููุชู ุฅูู 50-default.conf ุจุญูุซ ูุง ูุชู ุณูุจ ุงูุณุฌูุงุช ุงูุจุนูุฏุฉ ูู ุณุฌู ุงููุธุงู / var / log / message <br>  ุฃุนุฏ ุชุดุบูู ุงููุณุฌู. <br><br>  ุฏุนูุง ููุชุธุฑ ููููุงู ุญุชู ุชูุชูุฆ ูุงุนุฏุฉ ุจูุงูุงุชูุง.  ุซู ูููููุง ุฃู ูุจุฏุฃ ุงูุชุญุฏูุฏ. <br><br>  <b>ุจุนุถ ุงูุงุณุชูุณุงุฑุงุช ููุซุงู:</b> <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ููุนุฑูุฉ ุญุฌู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนุฏุฏ ุงูุตููู:</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_length + index_length)/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"size Mb"</span></span>, TABLE_ROWS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"count rows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_schema; +<span class="hljs-comment"><span class="hljs-comment">--------------------+---------+------------+ | database | size Mb | count rows | +--------------------+---------+------------+ | information_schema | 0.17 | NULL | | traflog | 3793.39 | 21839553 | +--------------------+---------+------------+ 2 rows in set (0.48 sec)</span></span></code> </pre><br>  ููุง ูุง ููุฑุจ ูู 4 ุบูุบุงุจุงูุช ูู ุงูุดูุฑ ุ ูููู ูุนุชูุฏ ุนูู ุนุฏุฏ ูุฎุตุงุฆุต ููุงุนุฏ ุฌุฏุงุฑ ุงูุญูุงูุฉ ุงููุณุฌูุฉ <br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุนุฏุฏ ุงูุจุงุฏุฆุงุช ุงููุณุฌูุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  ุนุฏุฏ ุงูุจุงุฏุฆุงุช ุงููุณุฌูุฉ ูุง ูุณุงูู ุนุฏุฏ ุงูููุงุนุฏ ุ ูุจุนุถ ุงูููุงุนุฏ ุชุนูู ูุน ุจุงุฏุฆุฉ ูุงุญุฏุฉ ุ ูููู ูุง ูุฒุงู ุนุฏุฏ ุงูุจุงุฏุฆุงุช ุงูุฅุฌูุงููุฉุ  ููู ุนุฏุฏ ุงูููุงุนุฏ ุงูุชู ุชู ูุถุนูุง ูููุ <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> logpref,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------------+----------------+ | logpref | count(logpref) | +----------------------+----------------+ | ACCEPT_TORF_INET | 14582602 | | ACCEPT_SMK_PPP | 1085791 | | DROP_FORWARD_INVALID | 982374 | | REJECT_BNK01 | 961503 | | ACCEPT_MMAX_TORF | 802455 | | ACCEPT_TORF_PPP | 736803 | | SMTP_DNAT | 689533 | | ACCEPT_SMK_INET | 451411 | | ACCEPT_INET_TORF | 389857 | | BLOCK_SMKNETS | 335424 | | DROP_SMTP_BRUTE | 285850 | | ACCEPT_ROZN_TORF | 154811 | | ACCEPT_TORF_MMAX | 148393 | | DROP_ETHALL_ETHALL | 80679 | | ACCEPT_SMTP | 48921 | | DROP_SMTP_DDOS | 32190 | | RDP_DNAT | 28757 | | ACCEPT_TORF_ROZN | 18456 | | SIP_DNAT | 15494 | | 1CWEB_DNAT | 6406 | | BLOCKSMKNETS | 5789 | | DROP_SSH_BRUTE | 3162 | | POP_DNAT | 1997 | | DROP_RDP_BRUTE | 442 | | DROP_BNK01 | 291 | | DROPALL | 138 | | ACCEPT_RTP_FORWARD | 90 | | REJECT_SMTP_BRUTE | 72 | | L2TP_INPUT_ACCEPT | 33 | +----------------------+----------------+ 29 rows in set (2 min 51.03 sec)</span></span></code> </pre> <br>  ACCEPT_TORF_INET ูู ุงูุฑุงุฆุฏ ุ ูู ุฎูุงู ูุฐู ุงูุจุงุฏุฆุฉ ุ ููููู ุงูุนุซูุฑ ุนูู ูู ุดุฎุต ุฏุฎู ุฅูู ุงูุฅูุชุฑูุช ูู ุดุจูุชูุง ุงููุญููุฉ ุ ูุชู ุชุณุฌูู ุงูุจุฑูุชููููุงุช ูุงูููุงูุฐ ุ ูุณูุฃุชู ุงูููุช ูุณูู ูุชู ุฅุบูุงู ุงููุตูู ููุจุนุถ.  ููุงู ุจูุงูุงุช ูุฑุฌุนูุฉ ููุนูู ุงููุณุชูุจูู ุนูู ุงูุจู. <br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Smtp ุงูุฑูุญ ุฒุนูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  ุฏุนููุง ูุฑู ูู ุญุงูู ุงูููู ุงููุตูู ุฅูู ุฎุงุฏู SMTP: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'SMTP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> datetime &gt; <span class="hljs-string"><span class="hljs-string">'2018101600000000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 191.96.249.92 | 12440 | | 191.96.249.24 | 4556 | | 191.96.249.61 | 4537 | | 185.255.31.122 | 3119 | | 178.57.79.250 | 226 | | 185.36.81.174 | 216 | | 185.234.219.32 | 211 | | 89.248.162.145 | 40 | | 45.125.66.157 | 32 | | 188.165.124.31 | 21 | +----------------+--------------+ 10 rows in set, 1 warning (21.36 sec)</span></span></code> </pre> <br>  ูู ุงููุงุถุญ ุฃู ุงูุนูุฏุฉ 191.96.249.92 ูู ุงููุงุฆุฒุฉ ุงูููู.  ุฏุนููุง ูุฑู ูู ุงูููุงุนุฏ ุงููุณุฌูุฉ ุงูุชู ูุง ูุฒุงู ูุธูุฑ ูููุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport),logpref <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> src=<span class="hljs-string"><span class="hljs-string">'191.96.249.92'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------+-------+--------------+-----------------+ | src | dport | count(dport) | logpref | +---------------+-------+--------------+-----------------+ | 191.96.249.92 | 25 | 226989 | SMTP_DNAT | | 191.96.249.92 | 25 | 170714 | DROP_SMTP_BRUTE | | 191.96.249.92 | 25 | 2907 | DROP_SMTP_DDOS | | 191.96.249.92 | 25 | 2061 | ACCEPT_SMTP | +---------------+-------+--------------+-----------------+ 4 rows in set (10 min 44.21 sec)</span></span></code> </pre><br>  ูุฐุง ูุชุฎุตุต ููุท ูู smtp ุ ~ 1 ูช ูู ุงูุฒูุงุฑุงุช ููุญุงููุฉ ุชุฎููู ูููุฉ ุงููุฑูุฑ ุฃู ูุญุงููุฉ ุฅุฑุณุงู ุจุนุถ ุงูููุงูุฉ ุ ุฐูุจ ุงูุจุงูู ุฅูู ุงูุญูุงู. <br><br>  ุงุณุชุบุฑู ุงูุทูุจ 10 ุฏูุงุฆู ุ ููุฐุง ูุซูุฑ ุ ุงูููุงุฑุณ ุงูุญุงููุฉ ููุณุช ููุงุณุจุฉ ูู ุ ุฃู ููููู ุฅุนุงุฏุฉ ุตูุงุบุฉ ุงูุทูุจ ุ ููููุง ูู ูุชุญุฏุซ ุนูู ุงูุขู. <br></div></div><br>  ูู ุงููุณุชูุจู ุ ูู ุงููุฎุทุท ุฃู ูุชู ุฑุจุท ูุงุฌูุฉ ุงูููุจ ุจุงูุงุณุชุนูุงูุงุช ูุงูููุงุฐุฌ ุงูููุงุณูุฉ. <br>  ูุชู ุฅุนุทุงุก ุงููุชุฌู ุ ุขูู ุฃู ุชููู ูุฐู ุงูููุงูุฉ ูููุฏุฉ. <br><br>  ุดูุฑุง ููู ุฌููุนุง! <br><br>  <b>ุงููุฑุงุฌุน:</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุซุงุฆู Rsyslog</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุซุงุฆู Mysql</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุซุงุฆู ุชุณุฌูู Mikrotik</a> <br><br>  ุจูุถู ูุฌุชูุน LOR ููุญุตูู ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุตุงุฆุญ.</a> <br><br>  <b>UPD.1</b> <br>  ุชูุช ุฅุถุงูุฉ ุญูู ุงูุนูุงูุงุช ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ ููููู ุงูุขู ุชุชุจุน ูุฏุฉ ุงูุงุชุตุงู ุนู ุทุฑูู ุงูุชูุงุท SYN ุ FIN. <br>  ุชู ุฅุตูุงุญ ุจุนุถ ุงูุฃุฎุทุงุก ูู ุงููุธุงู ุงูุฃุณุงุณู ูู rsyslog ููุฐูู ูุดุบูุงุช mysql. <br><br>  ุงูุบุฑูุจ ุฃู ุงููุงุนุฏุฉ ุงูุงูุชุฑุงุถูุฉ defconf: ุฅุณูุงุท ุบูุฑ ุตุงูุญ ูุณูุท ุฌููุน ุงูุญุฒู ุงูููุงุฆูุฉ ูุงุชุตุงูุงุช TCP ุ ููุชูุฌุฉ ูุฐูู ุ ุชูุดู ุฌููุน ุงูุนูุฏ ุงูุชู ุชุญุงูู ุฅุบูุงู ุงูุงุชุตุงู ูู ุงูุนูู ุ ูุฅุฑุณุงู ุงูุนุฏูุฏ ูู FINs.  ูู ูุฐุง ุตุญูุญุ <br><br>  ุฃุถูุช ูุงุนุฏุฉ ุชุณูุญ ุจูุฑูุฑ TCP ุนุจุฑ ุฅุดุงุฑุงุช ACK ู FIN. <br><br>  ุชุญุช ููุณุฏ SQL ุ ุฅุฌุฑุงุก ูุธูุฑ ููุช ุงุชุตุงูุงุช TCP ูู ุงูุฏูุงุฆู ุงูุฎูุณ ุงูุฃุฎูุฑุฉ <br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">links_list ()</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connections_list; DELIMITER // <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> connections_list() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> logid <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datefin DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datesyn DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conntime <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsrc <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,datetime,src,sport,dst,dport <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> flags=<span class="hljs-string"><span class="hljs-string">'SYN'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done=<span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> conn_syn_fin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> connless(datestart DATETIME,dateend DATETIME,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>,src <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),sport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,dst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),dport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> conn_syn_fin (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'TCP_FIN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%SYN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); OPEN cur; read_loop: LOOP FETCH cur INTO logid,datesyn,connsrc,connsport,conndst,conndport; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> datefin=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&gt;logid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src=connsrc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sport=connsport <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dst=conndst <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dport=conndport <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> conntime=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timediff</span></span>(datefin,datesyn)); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> connless (datestart,dateend,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>,src,sport,dst,dport) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> (datesyn,datefin,conntime,connsrc,connsport,conndst,conndport); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; CLOSE cur; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; // DELIMITER ;</code> </pre><br></div></div><br>  ูุชูุฌุฉ ููุฐุง ุงูุฅุฌุฑุงุก ุ ุณูุชู ุฅูุดุงุก ุฌุฏูููู ูุคูุชูู. <br>  ูุญุชูู ุงูุฌุฏูู <b>conn_syn_fin</b> ุนูู ุฅุฏุฎุงูุงุช ุงูุณุฌู ูุน <b>ุนูุงูุชู</b> SYN ู FIN ุ ุซู ูุชู ุฅุฌุฑุงุก ุงูุจุญุซ ุจุงุณุชุฎุฏุงู ุงููุคุดุฑ ูู ูุฐุง ุงูุฌุฏูู. <br>  ูุญุชูู ุงูุฌุฏูู ุบูุฑ <b>ุงููุญุฏูุฏ</b> ุนูู ูุงุฆูุฉ ุจุงูุงุชุตุงูุงุช ุ ุงูููุชูุญุฉ ูุงูููุชููุฉ ุ ุงูููุชููุฉ ููุง ูุฏุฉ ููุชูุญุฉ ุ ุนูู ุงูุชูุงูู ุ ูุง. <br>  ูุงุญุธ ููุช ุฃุฎุฐ ุงูุนููุงุช ูุงูุต ุฎูุณ ุฏูุงุฆู ูู ุงูููุช ุงูุญุงูู.  ุทูุจู ุจุทูุก.  ุจุจุทุก ููุฑ ุนุจุฑ ุงูุจุญุซ ุนู ุงููุคุดุฑ ุ ูุนุงูุฌ ุญูุงูู 10 ุณุฌูุงุช ูู ุงูุซุงููุฉ ุ ุญุงูู ุชุณุฑูุนูุง ูู ูู ุดูุก ุ ูููู ููุช ุงูุชูููุฐ ุฏุงุฆููุง ูู ููุณู ุชูุฑูุจูุง. <br>  ูุงุญุธ ุฃูุถูุง ุฃู ูุฐุง ุงูุฅุฌุฑุงุก ูู ูุฃุบุฑุงุถ ุงูุนุฑุถ ุงูุชูุถูุญู ููุท.  ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุฅุฌุฑุงุก ุชุญุฏูุฏ ูู src / sport / dst / dport ูุนูู ุ ููู ุงูุฃูุถู ุฅุฌุฑุงุก ุฅุฌุฑุงุก ูููุตู ูุดุงุจู ููุฐุง ุงูุฅุฌุฑุงุก.  ุฅุฐุง ููุช ุฎุจูุฑูุง ูู sql ุ ูููููู ูุชุงุจุฉ ุงุณุชุนูุงูู ุจุดูู ุฃูุถู. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงุณุชุฏุนุงุก links_list () ุ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> connections_list(); +<span class="hljs-comment"><span class="hljs-comment">---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | datestart | dateend | duration | src | sport | dst | dport | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | 2019-03-20 14:12:19 | 2019-03-20 14:13:14 | 00:00:55 | 192.168.0.81 | 41868 | 87.250.250.207 | 443 | | 2019-03-20 14:12:25 | NULL | NULL | 192.168.0.65 | 49311 | 52.5.23.125 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54433 | 217.69.139.42 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54434 | 217.69.139.42 | 443 | | 2019-03-20 14:12:32 | NULL | NULL | 192.168.0.119 | 37977 | 209.85.233.95 | 443 | ... | 2019-03-20 14:17:12 | NULL | NULL | 192.168.0.119 | 39331 | 91.213.158.131 | 443 | | 2019-03-20 14:17:13 | NULL | NULL | 192.168.0.90 | 63388 | 87.240.185.236 | 443 | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ 399 rows in set (33.17 sec) Query OK, 0 rows affected (33.18 sec)</span></span></code> </pre><br></div></div><br><br>  ุจุนุฏ ุงูุชูุงู ุงูุฅุฌุฑุงุก ุ ุชุจูู ุงูุฌุฏุงูู ุงููุคูุชุฉ <b>conn_syn_fin</b> ู <b>connless</b> ุ ููููู ุงููุธุฑ ุฅูููุง ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุฅุฐุง ูุฌุฏุช ุดูุฆูุง ูุฑูุจูุง ุฃู ุบูุฑ ููุซูู ุจู.  ุจุนุฏ ุจุฏุก ุงูุฅุฌุฑุงุก ุ ูุชู ุญุฐู ุงูุฌุฏุงูู ุงููุฏููุฉ ูุชุธูุฑ ุฌุฏุงูู ุฌุฏูุฏุฉ.  ุงูุชุจ ุฅุฐุง ูุฌุฏุช ุฎุทุฃ. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar427159/">https://habr.com/ru/post/ar427159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar427147/index.html">"ูููุฐุฌ BIAN ุงููุฑุฌุนู" ููุตูุงุนุฉ ุงููุตุฑููุฉ ุฃู ููููุฉ ุงูุชููู ุนู ุฅุนุงุฏุฉ ุงุฎุชุฑุงุน ุงูุนุฌูุฉ</a></li>
<li><a href="../ar427149/index.html">RADIOTEHNIKA S-30 ููุจุฑุงุช ุงูุตูุช ุงููุฏููุฉ ุฅูู ุงูุฌุฏูุฏุฉ</a></li>
<li><a href="../ar427151/index.html">ุงูุนูููุฉ ุงูุชุนููููุฉ ูู ุชูููููุฌูุง ุงููุนูููุงุช: ุงูุฃูููุจูุงุฏ ูุงูููุญ ุงูุฏุฑุงุณูุฉ ูุจุฑุงูุฌ ุงูุฏุนู ููุฌุชูุนุงุช ุฌุงูุนุฉ ITMO</a></li>
<li><a href="../ar427153/index.html">DNA ุขููุงุช ุชุฎุฒูู ููุนุงูุฌุฉ ุงููุนูููุงุช. ุงูุฌุฒุก ุงูุซุงูู</a></li>
<li><a href="../ar427155/index.html">ุญุงููุฉ ุชุตููุฉ ุณุงูุซุงูุจุชูู - ุงูุฎุทูุฉ ุงูุฃููู ูุชูุธูู ุงููุฏู</a></li>
<li><a href="../ar427163/index.html">ุณุชุณุงุนุฏ ุงูููุงุฏ ุงูุฌุฏูุฏุฉ ูู ุฌุนู ูุญุทุงุช ุงูุทุงูุฉ ุงูุดูุณูุฉ ุงูุญุฑุงุฑูุฉ ุฃูุซุฑ ููุงุกุฉ</a></li>
<li><a href="../ar427165/index.html">ููููุฉ ุชุทููุฑ ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู ูุฎุงุฏู Atlassian Jira Server (jira-func-test-plugin)</a></li>
<li><a href="../ar427169/index.html">ุฃุฒุงู ุชุณูุง ุจูุฏูุก ุฎูุงุฑ ุงูุทูุงุฑ ุงูุขูู ุงููุงูู</a></li>
<li><a href="../ar427171/index.html">ุงูุฃูู ูุชุฑูู</a></li>
<li><a href="../ar427173/index.html">ูู ุงูุงุชุตุงูุงุช ุงููุงุชููุฉ ุฃุฑุฎุต ูู ุงููุฌุงููุฉุ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>