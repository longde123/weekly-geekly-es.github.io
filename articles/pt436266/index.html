<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëû ü•Ñ üèà Escalada extrema no Alibaba JDK üìè üßìüèæ üëë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Muitos suspeitam da possibilidade de criar e escrever algo por conta pr√≥pria. Muitas vezes, o pre√ßo √© muito alto. √â especialmente estranho ouvir sobre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalada extrema no Alibaba JDK</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/436266/"><p>  Muitos suspeitam da possibilidade de criar e escrever algo por conta pr√≥pria.  Muitas vezes, o pre√ßo √© muito alto.  √â especialmente estranho ouvir sobre seus pr√≥prios JDKs, que supostamente est√£o em todas as empresas razoavelmente grandes.  O que diabos est√° acontecendo com a gordura?  Este artigo ser√° uma hist√≥ria detalhada sobre a empresa, que tudo isso traz benef√≠cios comerciais reais e que fez um p√©ssimo trabalho, porque eles: </p><br><ul><li>  Desenvolvi uma m√°quina Java virtual com v√°rios inquilinos; </li><li>  Eles criaram um mecanismo para a opera√ß√£o de objetos que n√£o sobrecarregam a coleta de lixo; </li><li>  Eles fizeram algo como o hom√≥logo ReadyNow da Azul Zing; </li><li>  Eles lavaram suas pr√≥prias corotinas com rendimentos e continua√ß√µes (e est√£o prontos para compartilhar sua experi√™ncia com Loom, sobre a qual <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escrevi no outono</a> ); </li><li>  Eles aparafusaram a todos esses milagres seu pr√≥prio subsistema de diagn√≥stico. </li></ul><br><p> Como sempre, v√≠deo, descriptografia de texto completo e slides est√£o esperando por voc√™.  Bem-vindo ao inferno de uma das √°reas mais dif√≠ceis de adapta√ß√£o de projetos abertos! </p><br><p><img src="https://habrastorage.org/webt/dk/gg/wt/dkggwtykndi-ewrxf_6ajxec7ts.png"></p><br><p>  <strong>Doutor, onde voc√™ tira essas fotos?</strong>  O'Reilly Covers Corner: Os antecedentes do KDPV s√£o fornecidos por Joshua Newton e retratam a Dan√ßa Sagrada de <em>Sangyang Jaran</em> em Ubud, Indon√©sia.  Esta √© uma performance cl√°ssica de Bali composta por dan√ßa de fogo e transe.  Um homem de salto nu se move em volta de uma fogueira, criado com cascas de coco, empurrando as coisas com os p√©s e dan√ßando em estado de transe, sob a influ√™ncia de um esp√≠rito de cavalo.  Ilustra√ß√£o perfeita para o seu pr√≥prio JDK, certo? </p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/94eTZsNYYBE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slides e uma descri√ß√£o do relat√≥rio</a> (voc√™ n√£o precisa deles, esse habratopike tem tudo que voc√™ precisa). </p><br><hr><br><p>  Ol√°, meu nome √© Sanhong Lee, trabalho no Alibaba e gostaria de falar sobre as mudan√ßas que fizemos no OpenJDK para as necessidades de nossos neg√≥cios.  A postagem consiste em tr√™s partes.  No primeiro, vou falar sobre como o Java √© usado no Alibaba.  A segunda parte, na minha opini√£o, √© a mais importante - discutiremos como configuramos o OpenJDK para as necessidades de nossos neg√≥cios.  A terceira parte ser√° sobre as ferramentas que criamos para o diagn√≥stico. </p><br><p>  Mas antes de passar para a primeira parte, gostaria de falar brevemente sobre a nossa empresa. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/2e2/20c/776/2e220c776112b1cf5e66b102559a39a5.jpg"></p><br><p>  O diagrama mostra a estrutura interna do Alibaba.  √â composto por v√°rias empresas cuja principal especializa√ß√£o √© a organiza√ß√£o do mercado eletr√¥nico e o fornecimento de plataformas financeiras e log√≠sticas.  Acho que a maioria das pessoas na R√∫ssia est√° familiarizada com o AliExpress.  A Alibaba possui uma equipe dedicada de programadores que desenvolvem e d√£o suporte a toda a pilha distribu√≠da, fornecendo servi√ßos aos clientes da Aliexpress em todo o mundo. </p><br><p>  Para ter uma id√©ia da escala do trabalho de Alibaba, vamos ver o que acontece na China <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no Dia do Solteiro</a> .  √â comemorado todos os anos em 11 de novembro, e neste dia as pessoas compram especialmente muitos produtos atrav√©s do Alibaba.  At√© onde eu sei, das f√©rias em todo o mundo s√£o as mais compras. <br></p><p><img src="https://habrastorage.org/getpro/habr/post_images/e31/55e/b62/e3155eb62e307c57535b1479351f41ad.jpg"></p><br><p>  Na figura acima, voc√™ v√™ um diagrama que mostra a carga em nosso sistema de suporte.  A linha vermelha mostra o trabalho do nosso servi√ßo de pedidos e mostra o n√∫mero m√°ximo de transa√ß√µes por segundo, no ano passado foi de 325 mil.  A linha azul refere-se ao servi√ßo de pagamento, e ela tem esse n√∫mero de 256 mil.  Gostaria de falar sobre como otimizar a pilha que atende a tantas transa√ß√µes. </p><br><p>  Vamos discutir as principais tecnologias que funcionam no Alibaba com Java.  Antes de tudo, devo dizer que temos v√°rios aplicativos de c√≥digo aberto como base.  Para processamento de big data, usamos o HBase Hadoop.  Como cont√™iner, usamos o Tomcat e o OSGi.  O Java √© usado em uma escala colossal - milh√µes de inst√¢ncias da JVM s√£o implementadas em nosso data center.  Devo tamb√©m dizer que nossa arquitetura √© orientada a servi√ßos, ou seja, criamos muitos servi√ßos que se comunicam usando chamadas RPC.  Finalmente, nossa arquitetura √© heterog√™nea.  Para melhorar o desempenho, muitos algoritmos s√£o escritos usando as bibliotecas C e C ++, para que eles se comuniquem com Java usando chamadas JNI. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f99/614/041/f99614041cb58edab73a43dea38fdda9.jpg"></p><br><p>  A hist√≥ria do nosso trabalho com o OpenJDK come√ßou em 2011, durante o OpenJDK 6. H√° tr√™s raz√µes importantes pelas quais escolhemos o OpenJDK.  Primeiro, podemos alterar diretamente seu c√≥digo de acordo com as necessidades da empresa.  Em segundo lugar, quando surgem problemas urgentes, podemos resolv√™-los sozinhos mais r√°pido do que esperar pelo lan√ßamento oficial.  Isso √© vital para os nossos neg√≥cios.  Em terceiro lugar, nossos desenvolvedores Java usam nossas pr√≥prias ferramentas para depura√ß√£o e diagn√≥stico r√°pidos e de alta qualidade. </p><br><p>  Antes de passar para quest√µes t√©cnicas, quero listar as principais dificuldades que temos que superar.  Primeiro, lan√ßamos um grande n√∫mero de inst√¢ncias da JVM - nessa situa√ß√£o, a quest√£o de reduzir os custos de hardware √© um problema grave.  Em segundo lugar, eu j√° disse que atendemos a um grande n√∫mero de transa√ß√µes.  Gra√ßas ao coletor de lixo, o Java nos promete "mem√≥ria infinita".  Al√©m disso, ele ganha em desempenho em um n√≠vel baixo, gra√ßas ao compilador JIT.  Mas isso tamb√©m tem um outro lado: um tempo mais longo para a coleta de lixo.  Al√©m disso, o Java precisa de ciclos adicionais de CPU para compilar os m√©todos Java.  Isso significa que os compiladores competem pelos ciclos da CPU.  Os dois problemas pioram √† medida que o aplicativo se torna mais complexo. </p><br><p>  A terceira dificuldade √© que temos muitos aplicativos em execu√ß√£o.  Acho que todos aqui est√£o familiarizados com as ferramentas que acompanham o OpenJDK, como JConsole ou VisualVM.  O problema √© que eles n√£o nos fornecem as informa√ß√µes exatas que precisamos configurar.  Al√©m disso, quando usamos essas ferramentas (por exemplo, JConsole ou VisualVM) na produ√ß√£o, uma sobrecarga baixa n√£o √© apenas um desejo, mas um requisito necess√°rio.  Eu tive que escrever minhas pr√≥prias ferramentas de diagn√≥stico. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ec5/da9/bcb/ec5da9bcb1620f073d5aed05aaba76aa.jpg"></p><br><p>  A imagem descreve as altera√ß√µes que fizemos no OpenJDK.  Vamos dar uma olhada em como superamos as dificuldades de que falei acima. </p><br><h1>  JVM com v√°rios inquilinos </h1><br><p>  Uma solu√ß√£o que chamamos de JVM com v√°rios inquilinos.  Ele permite executar com seguran√ßa v√°rios aplicativos da Web em um cont√™iner.  Outra solu√ß√£o √© chamada GCIH (GC Invisible Heap).  Este √© um mecanismo que fornece objetos Java completos, que ao mesmo tempo n√£o exigem o custo da coleta de lixo.  Al√©m disso, para reduzir os custos dos contextos de encadeamento, implementamos corotinas em nossa plataforma Java.  Al√©m disso, escrevemos um mecanismo chamado JWarmup - sua fun√ß√£o √© muito semelhante ao ReadyNow.  Douglas Hawkins parece ter mencionado ele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em seu relat√≥rio</a> .  Por fim, desenvolvemos nossa pr√≥pria ferramenta de cria√ß√£o de perfil, o ZProfiler. </p><br><p>  Vamos dar uma olhada em como implementamos a multiloca√ß√£o baseada no OpenJDK. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/133/d4b/f5f/133d4bf5f82bfa3f7a7df9abb0e59afa.jpg"></p><br><p>  D√™ uma olhada na foto acima - acho que a maioria de voc√™s conhece esse padr√£o.  Compare a abordagem tradicional com o multilocat√°rio.  Se seu aplicativo estiver em execu√ß√£o usando o Apache Tomcat, voc√™ tamb√©m poder√° executar v√°rias inst√¢ncias no mesmo cont√™iner.  Mas o Tomcat n√£o fornece consumo est√°vel de recursos para cada um deles.  Digamos, se um dos aplicativos em execu√ß√£o precisar de mais tempo de CPU que o outro, como voc√™ controlar√° a aloca√ß√£o de tempo de CPU?  Como garantir que esse aplicativo n√£o afete o trabalho de outras pessoas?  Foi principalmente essa quest√£o que nos levou a usar a tecnologia multitenant. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e7f/77e/add/e7f77eadd29a6dbe8ea8ffc0cc1ec8ae.jpg"></p><br><p>  A imagem mostra esquematicamente como a implementamos.  Criamos v√°rios cont√™ineres para inquilinos dentro da JVM.  Cada um desses cont√™ineres fornece controle confi√°vel de consumo de recursos para cada m√≥dulo Java.  V√°rios m√≥dulos podem ser implantados em um cont√™iner.  Cada m√≥dulo pode ser associado a um thread ou a um grupo de threads em tempo de execu√ß√£o. </p><br><p>  Vamos dar uma olhada na apar√™ncia da API do cont√™iner de inquilino.  Temos uma classe de configura√ß√£o de inquilino que armazena informa√ß√µes sobre o consumo de recursos.  Em seguida, h√° uma classe do pr√≥prio cont√™iner. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f3c/95e/27d/f3c95e27dbc40c2bb216b70f7521b270.jpg"></p><br><p>  No trecho de c√≥digo apresentado, criamos um inquilino e depois indicamos quanto tempo a CPU e a mem√≥ria s√£o fornecidas para ele.  O primeiro indicador √© um n√∫mero inteiro, o que significa a parcela do tempo de CPU dispon√≠vel para o inquilino, neste caso, indicamos 512. Utilizamos uma abordagem muito semelhante no caso de cgroups, abordarei isso com mais detalhes.  A segunda m√©trica √© o tamanho m√°ximo de heap que os inquilinos podem usar. </p><br><p> Considere como um inquilino interage com um encadeamento.  A classe <code>TenantContainer</code> fornece o m√©todo <code>.run()</code> e, quando um thread o insere, ele √© anexado automaticamente ao inquilino e, quando sai, o procedimento inverso ocorre.  Portanto, todo o c√≥digo √© executado dentro do m√©todo <code>.run()</code> .  Al√©m disso, qualquer encadeamento criado dentro do m√©todo <code>.run()</code> √© anexado ao inquilino do encadeamento pai. </p><br><p>  Chegamos a uma pergunta muito importante - como a CPU √© gerenciada em uma JVM com v√°rios inquilinos?  Nossa solu√ß√£o acaba de ser implementada na plataforma Linux x64.  Existe um mecanismo de grupo de controle, cgroups.  Ele permite que voc√™ selecione um processo em um grupo separado e indique seu modo de consumo de recursos para cada grupo.  Vamos tentar transferir essa abordagem para o contexto da JVM do Hotspot.  No Hotstpot, os encadeamentos Java s√£o organizados como encadeamentos nativos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbb/093/2d4/fbb0932d4d1dbc6ef982c17dcac8bebb.jpg"></p><br><p>  Isso √© mostrado no diagrama acima: cada encadeamento Java est√° em uma correspond√™ncia individual com o encadeamento nativo.  Em nosso exemplo, temos um cont√™iner <code>TenantA</code> , no qual existem dois threads nativos.  Para poder controlar a distribui√ß√£o do tempo da CPU, colocamos os dois threads nativos em um grupo de controle.  Por esse motivo, podemos regular o consumo de recursos, contando apenas com a funcionalidade de [grupos de controle] ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://en.wikipedia.org/wiki/Cgroups</a> ). </p><br><p>  Vamos dar uma olhada em um exemplo mais detalhado. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6ac/6c8/6bc/6ac6c86bc668c785c1dd92ee13547e2a.jpg"></p><br><p>  Grupos de controle no Linux s√£o mapeados para um diret√≥rio.  Em nosso exemplo, criamos o diret√≥rio <code>/t0</code> para o inquilino 0. Esse diret√≥rio cont√©m o diret√≥rio <code>/t0/tasks</code> , todos os encadeamentos para <code>t0</code> ser√£o localizados aqui.  Outro arquivo importante √© <code>/t0/cpu.shares</code> .  Indica quanto tempo a CPU ser√° dada a esse inquilino.  Toda essa estrutura √© herdada dos grupos de controle - simplesmente garantimos uma correspond√™ncia direta entre o encadeamento Java, o encadeamento nativo e o grupo de controle. </p><br><p>  Outra quest√£o importante diz respeito ao gerenciamento de v√°rios inquilinos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b3a/570/b4e/b3a570b4ece66bcabd3bfa9d5071e553.jpg"></p><br><p>  Na figura, voc√™ v√™ um diagrama de como √© implementado.  Nossa abordagem √© baseada no G1GC.  Na parte inferior da imagem, o G1GC divide a pilha em se√ß√µes do mesmo tamanho.  Com base neles, criamos TACs, Contextos de aloca√ß√£o de inquilino, com os quais o inquilino gerencia sua se√ß√£o de heap.  Por meio do TAC, limitamos o tamanho da parte da pilha dispon√≠vel para o inquilino.  Aqui, o princ√≠pio se aplica, segundo o qual cada se√ß√£o da pilha cont√©m objetos de apenas um inquilino.  Para implement√°-lo, precis√°vamos fazer altera√ß√µes no processo de copiar um objeto durante a coleta de lixo - era necess√°rio garantir que o objeto fosse copiado na se√ß√£o correta da pilha. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ae8/195/7c8/ae81957c8027d99056a66648472f9674.jpg"></p><br><p>  Esquematicamente, esse processo √© representado no diagrama acima.  Como eu disse, nossa implementa√ß√£o √© baseada no G1GC.  O G1GC √© um coletor de lixo de c√≥pia; portanto, durante a coleta de lixo, precisamos garantir que o objeto seja copiado para a se√ß√£o correta da pilha.  No slide, todos os objetos criados pelo <code>Tenant-1</code> devem ser copiados para sua parte da pilha, semelhante ao <code>Tenant-2</code> . </p><br><p>  H√° outras considera√ß√µes que surgem quando os inquilinos s√£o isolados um do outro.  Aqui devo dizer sobre o TLAB (Thread Local Allocation Buffer) - um mecanismo para a aloca√ß√£o r√°pida de mem√≥ria.  O espa√ßo TLAB depende da se√ß√£o de heap.  Como eu disse, diferentes inquilinos t√™m diferentes grupos de se√ß√µes de heap. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0c9/0b4/1e7/0c90b41e753761f3a2e294ccef6e6591.jpg"></p><br><p>  As especificidades do trabalho com o TLAB s√£o mostradas no slide - quando o encadeamento alterna entre o <code>Tenant 1</code> e o <code>Tenant 2</code> , precisamos garantir que a se√ß√£o de heap correta seja usada para o espa√ßo TLAB.  Isso pode ser alcan√ßado de duas maneiras.  A primeira maneira √© quando o <code>Thread A</code> alterna do <code>Tenant 1</code> para o <code>Tenant 2</code> , apenas nos livramos do antigo e criamos um novo no <code>Tenant 2</code> .  Esse m√©todo √© relativamente f√°cil de implementar, mas desperdi√ßa espa√ßo no TLAB, o que √© indesej√°vel.  A segunda maneira √© mais complicada - conscientizar o TLAB dos inquilinos.  Isso significa que teremos v√°rios buffers TLAB para um thread.  Quando o <code>Thread A</code> alterna do <code>Tenant 1</code> para o <code>Tenant 2</code> , precisamos alterar o buffer e usar o que foi criado no <code>Tenant 2</code> . </p><br><p>  Outro mecanismo que precisa ser dito em rela√ß√£o √† delimita√ß√£o de inquilinos √© o IHOP (Percentagem de ocupa√ß√£o de encadeamento inicial).  Inicialmente, o IHOP foi calculado com base em todo o heap, mas, no caso de um mecanismo multitenant, ele deve ser calculado com base em apenas uma se√ß√£o do heap. </p><br><p>  Vamos dar uma olhada no que √© GCIH (GC Invisible Heap).  Esse mecanismo cria uma se√ß√£o na pilha, oculta do coletor de lixo e, portanto, n√£o √© afetada pela coleta de lixo.  Este site √© gerenciado pelo locat√°rio da GCIH. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/00a/fc1/843/00afc1843cc320ee600a80892f0c4940.jpg"></p><br><p>  √â importante dizer aqui que fornecemos uma API p√∫blica para nossos desenvolvedores Java.  Um exemplo de como trabalhar com ele pode ser visto na tela.  Permite usar o m√©todo <code>moveIn()</code> para mover objetos de um heap regular para uma parte do heap GCIH.  Sua vantagem √© que voc√™ ainda pode interagir com esses objetos, pois com objetos Java regulares, eles s√£o muito semelhantes na estrutura.  Mas, ao mesmo tempo, eles n√£o exigem o custo da coleta de lixo.  A conclus√£o, na minha opini√£o, √© que, se voc√™ deseja acelerar a coleta de lixo, precisa personalizar o comportamento do coletor de lixo de acordo com as necessidades do seu aplicativo. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/af0/c7d/bb3/af0c7dbb3eca6dd45ecc10f52247e369.jpg"></p><br><p>  A imagem mostra um esquema GCIH de alto n√≠vel.  √Ä direita, h√° um heap Java comum, √† esquerda, o espa√ßo alocado para o GCIH.  Os links de um heap regular para objetos no GCIH s√£o v√°lidos, mas os links do GCIH para um heap regular n√£o s√£o.  Para entender por que isso acontece, considere um exemplo.  Temos o objeto "A" no GCIH, que cont√©m uma refer√™ncia ao objeto "B" em um heap regular.  O problema √© que o objeto B pode ser movido pelo coletor de lixo.  Como eu j√° disse, n√£o fazemos atualiza√ß√µes no GCIH, portanto, depois que o coletor de lixo funcionar, o objeto "A" poder√° conter uma refer√™ncia inv√°lida ao objeto "B".  Esse problema pode ser resolvido usando a barreira de pr√©-grava√ß√£o - eles foram discutidos em um relat√≥rio anterior.  Como exemplo, suponha que algu√©m precise salvar um link de um heap Java regular no GCIH antes que o salvamento que assumimos resultaria em uma exce√ß√£o de preditor com um sinalizador indicador de que a regra foi violada. </p><br><p>  Para um aplicativo espec√≠fico, uma JVM com v√°rios inquilinos √© usada em nossa Plataforma de Personaliza√ß√£o Taobao, TPP abreviado.  Este √© um sistema de recomenda√ß√£o para o nosso aplicativo de compras eletr√¥nicas.  O TPP pode implantar v√°rios microsservi√ßos em um cont√™iner e, com a ajuda da JVM com v√°rios inquilinos, controlamos o tempo de mem√≥ria e CPU fornecido para cada microsservi√ßo. </p><br><p>  Quanto ao GCIH, ele √© usado em nosso outro sistema, a Plataforma da UM.  Este √© um aplicativo de descontos online.  O propriet√°rio deste aplicativo usa o GCIH para pr√©-armazenar em cache os dados do GCIH na m√°quina local, para n√£o acessar objetos no servidor de cache remoto ou no banco de dados remoto.  Como resultado, reduzimos a carga na rede e executamos menos serializa√ß√£o e desserializa√ß√£o. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/36d/707/20c/36d70720cd2b4465b4b32b01467fbe51.jpg"></p><br><p>  A figura mostra um diagrama no qual a cor azul mostra a carga ao usar um JDK convencional e o vermelho - GCIH.  Como voc√™ pode ver, estamos reduzindo a utiliza√ß√£o da CPU em mais de 18%. </p><br><p>  At√© onde eu sei, um problema semelhante foi resolvido pela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BellSoft</a> e sua solu√ß√£o foi semelhante √† GCIH, mas eles usaram uma abordagem diferente para reduzir os custos de serializa√ß√£o e desserializa√ß√£o. </p><br><h1>  Corotinas em Java </h1><br><p>  Vamos voltar ao Alibaba e ver como as corotinas podem ser implementadas em Java.  Mas primeiro, vamos falar sobre as origens, sobre por que precisamos fazer isso.  Em Java, sempre foi muito f√°cil escrever aplicativos multithreading.  Mas o problema com a cria√ß√£o desses aplicativos √© que, como eu disse, no Hotspot, os threads Java j√° est√£o implementados como threads nativos.  Portanto, quando h√° muitos encadeamentos em seu aplicativo, os custos de altera√ß√£o do contexto do encadeamento tornam-se muito altos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/2c5/b79/4f1/2c5b794f12c5cfcc82fa893a82c7a92e.jpg"></p><br><p>  Considere um exemplo no qual teremos 4 threads de E / S e 200 threads com a l√≥gica do seu aplicativo.  A tabela na tela mostra os resultados do in√≠cio desta demonstra√ß√£o simples - voc√™ pode ver quanto tempo a CPU leva para mudar os contextos.  A solu√ß√£o para esse problema pode ser a implementa√ß√£o de corutin em Java. </p><br><p>  Para fornec√™-lo, precis√°vamos de duas coisas.  Primeiro, o Alibaba JDK precisava adicionar suporte de continua√ß√£o.  Este trabalho foi baseado no patch da JKU, abordaremos mais detalhadamente.  Em segundo lugar, adicionamos um sheduler no modo de usu√°rio que ser√° respons√°vel pela continua√ß√£o do encadeamento.  Em terceiro lugar, existem muitas aplica√ß√µes no Alibaba.  Portanto, nossa solu√ß√£o √© muito importante para nossos desenvolvedores Java e era necess√°rio torn√°-la absolutamente transparente para eles.  E isso significa que em nosso aplicativo de neg√≥cios n√£o deveria haver praticamente nenhuma altera√ß√£o no c√≥digo.  Chamamos nossa solu√ß√£o de Wisp.  Nossa implementa√ß√£o de corotinas em Java √© amplamente usada no Alibaba, portanto, pode-se considerar comprovado que funciona em Java.  Conhe√ßa-o em mais detalhes. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5af/7af/0c2/5af7af0c2075b299ef7152bd8cff94fe.jpg"></p><br><p>  Vamos come√ßar com o exemplo, cujo c√≥digo √© apresentado acima - este √© um aplicativo Java completamente comum.  Primeiro, um pool de threads √© criado.  Em seguida, outra tarefa execut√°vel √© criada que aceita o soquete.  Depois disso, a leitura do fluxo √© realizada.  Em seguida, criamos outra tarefa Runnable, com a qual nos conectamos ao servidor e, finalmente, escrevemos dados no fluxo.  Como voc√™ pode ver, tudo parece bastante padr√£o.  Se voc√™ executar o c√≥digo em um JDK regular, cada uma dessas tarefas Runnable ser√° executada em um encadeamento separado.  Mas em nossa decis√£o, a mec√¢nica ser√° completamente diferente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a06/f12/716/a06f12716380d6e3447ac9de3784c37c.jpg"></p><br><p>  Como voc√™ pode ver no dump do thread mostrado no slide, criamos duas corotinas em um thread, e n√£o dois.  Agora voc√™ precisa fazer esta solu√ß√£o funcionar.  O principal aqui √© fazer a gera√ß√£o de eventos yieldTo em todos os poss√≠veis pontos de bloqueio.  Em nosso exemplo, esses pontos ser√£o <code>serverSocket.accept()</code> , <code>is.read(buf)</code> , uma conex√£o de soquete e <code>os.write(buf)</code> .  Gra√ßas a produzir eventos nesses pontos, poderemos transferir o controle de uma corotina para outra dentro do mesmo encadeamento.  Para resumir, nossa abordagem √© obter desempenho ass√≠ncrono usando a corotina, mas nossos programadores podem escrever c√≥digo em um estilo s√≠ncrono, pois esse c√≥digo √© muito mais simples e f√°cil de manter e depurar. </p><br><p>  Vejamos exatamente como fornecemos suporte de continua√ß√£o no Alibaba JDK.  Como eu disse, este trabalho √© baseado em um projeto de m√°quina virtual multil√≠ngue criado pela comunidade - √© de dom√≠nio p√∫blico.  Usamos esse patch no Alibaba JDK e corrigimos alguns erros que ocorreram em nosso ambiente de produ√ß√£o. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5e3/580/3bd/5e35803bda5ad8ae70b35f3fd5fd4771.jpg"></p><br><p>  Como voc√™ pode ver no diagrama, aqui em um encadeamento podem existir v√°rias corotinas e para cada uma √© criada uma pilha separada.  Al√©m disso, o patch sobre o qual falei fornece a API mais importante aqui - yieldTo, com a ajuda de que o controle √© transferido de uma corotina para outra. </p><br><p>  Vamos seguir como implementamos o sheduler no modo de usu√°rio da corotina.  Usamos um seletor e, com ele, registramos v√°rios canais.  Quando qualquer evento de E / S (leitura, grava√ß√£o, conex√£o ou aceita√ß√£o de soquete) ocorre, ele √© gravado como uma chave para o seletor.  Portanto, no final deste evento, recebemos um alerta do seletor.  Portanto, usamos um seletor para planejar corotinas no caso de um bloqueio de E / S.  Considere um exemplo de como isso funcionar√°. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a32/45d/f81/a3245df8176dc1c23d810413ff1f1031.jpg"></p><br><p>  Na figura, vemos o soquete e a chamada s√≠ncrona <code>client.read(buffer)</code> .  Na parte inferior do slide, √© escrito um c√≥digo que ser√° executado dentro desta chamada.  Primeiro, verifica se √© poss√≠vel ler a partir do canal ou n√£o.  Nesse caso, retornamos o resultado.  A coisa mais interessante acontece se a leitura n√£o puder ser feita.  Em seguida, registramos o evento de leitura em nosso planejador com o seletor.  Isso torna poss√≠vel planejar a execu√ß√£o de qualquer outra rotina.  Veja como isso acontece.  Temos um segmento no qual um agendador √© criado.  O fio e a nossa rotina est√£o em correspond√™ncia um com o outro.  O Sheduler nos permite gerenciar as corotinas desse segmento.  O que acontece se a E / S estiver bloqueada?  Quando ocorrem eventos de E / S, o sheduler recebe um alerta e, nessa situa√ß√£o, ele depende inteiramente do seletor.  Ap√≥s esse evento, o sheduler tem a oportunidade de planejar a pr√≥xima rotina dispon√≠vel. </p><br><p>  Vamos resumir a vis√£o geral do nosso sheduler, que chamamos de WispEngine.  Para cada um de nossos threads, alocamos um WispEngine separado.  Quando ocorre um bloqueio de rotina, registramos certos eventos (leitura / grava√ß√£o de soquete e assim por diante) usando o WispEngine.  Alguns eventos est√£o relacionados ao estacionamento de threads, por exemplo, se voc√™ chamar <code>thread.sleep()</code> com um atraso de 100 milissegundos.  Nesse caso, um evento de estacionamento de threads ser√° gerado para voc√™, que ser√° registrado no seletor.  Outra quest√£o importante √© quando o cron√¥metro indica a pr√≥xima rotina dispon√≠vel.  Existem duas condi√ß√µes principais.  O primeiro √© quando determinados eventos s√£o gerados, como eventos de E / S ou eventos de tempo limite.  Tudo √© bem simples aqui: suponha que voc√™ fa√ßa uma chamada para <code>thread.sleep()</code> com um atraso de 200 milissegundos.  Quando expiram, o sheduler tem a oportunidade de executar a pr√≥xima rotina dispon√≠vel.  Ou aqui, podemos falar sobre alguns eventos de descompacta√ß√£o que s√£o gerados, digamos, chamando <code>object.notify()</code> ou <code>object.notifyAll()</code> A segunda condi√ß√£o √© quando o usu√°rio envia novas solicita√ß√µes e criamos uma corotina para atend√™-las e, em seguida, o sheduler atribui sua implementa√ß√£o. </p><br><p>  Aqui voc√™ tamb√©m precisa falar sobre o servi√ßo que criamos, WispThreadExecutor. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a5/ddc/881/5a5ddc88194e0794593506627f420915.jpg"></p><br><p>  Um c√≥digo de exemplo √© apresentado na tela e vemos que este √© um ExecutorService comum, criado da mesma maneira.  Os <code>.execute()</code> e <code>submit()</code> est√£o dispon√≠veis para tarefas execut√°veis, mas o problema √© que todas as tarefas execut√°veis ‚Äã‚Äãque passam pelo m√©todo <code>submit()</code> ser√£o executadas em corutin e n√£o no encadeamento.  Esta solu√ß√£o √© completamente transparente para quem implementar√° nossa aplica√ß√£o, eles poder√£o usar nossa API para corotinas. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/2b5/e03/041/2b5e03041077b86eb3b4438a5d286813.jpg"></p><br><p>  Chego √† √∫ltima parte dif√≠cil do post - como resolver o problema da sincroniza√ß√£o nas corotinas.  Esta √© uma pergunta complexa, ent√£o vamos ver com um exemplo simplificado.  Aqui temos a corotina A ( <code>test::foo</code> ) e a corutina <code></code> ( <code>test::bar</code> ).  Primeiro, atribu√≠mos a execu√ß√£o do <code>test:foo</code> √† corotina <code></code>  Corutin <code></code> chama <code>wait()</code> .  Se nada for feito, o encadeamento atual ser√° bloqueado pela chamada para <code>wait()</code> .  Como pode ser visto neste despejo do encadeamento, ocorrer√° um impasse e n√£o poderemos agendar a pr√≥xima rotina a ser executada. </p><br><p>  Como resolver este problema?  O ponto de acesso fornece tr√™s tipos de bloqueios.  O primeiro √© o bloqueio r√°pido.  Aqui, o propriet√°rio do bloqueio √© determinado pelo endere√ßo na pilha.  Como eu disse, cada uma das nossas rotinas possui uma pilha separada.  Portanto, no caso de bloqueio r√°pido, n√£o precisamos fazer nenhum trabalho adicional.  N√£o h√° suporte semelhante para bloqueio parcial no nosso sistema.  Tentamos fazer isso em nossa produ√ß√£o e, na aus√™ncia de um bloqueio tendencioso, o desempenho n√£o diminui.  Para n√≥s, √© bastante adequado. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1a9/051/bd1/1a9051bd163c97d904d6a4bd13afb188.jpg"></p><br><p>  Vamos falar sobre um caso mais complicado - bloqueio inflado.  Vamos olhar novamente para o exemplo que citei acima.  Temos Corutin <code></code> ( <code>.foo()</code> ) e Corutin <code>B</code> ( <code>.bar()</code> ).  Primeiro, atribu√≠mos a execu√ß√£o da corotina <code></code> e a iniciamos.  Em seguida, chama <code>Object.wait</code> , ap√≥s o qual entra na lista de espera.  Depois disso, damos um passo muito importante: geramos o evento <code>yieldTo</code> , que transfere o controle para o thread principal.  Em seguida, come√ßamos Corutin <code>B</code>  Ele chama <code>Object.notify</code> , e os eventos de <code>Object.notify</code> correspondentes s√£o <code>unpark</code> .  Eventualmente, eles acordar√£o a corotina <code></code>  Ap√≥s a execu√ß√£o da <code>bar()</code> , ser√° poss√≠vel transferir o controle para a rotina <code></code>  Assim, o impasse que mencionei anteriormente √© completamente superado. </p><br><p>  Vamos discutir o desempenho agora.  Usamos corotinas em um de nossos aplicativos online de Carrinhos.  Com base nisso, podemos comparar o trabalho de corutin com o trabalho de um JDK regular. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/022/52c/c95/02252cc950a2ad902d2feb29f4129249.jpg"></p><br><p>  Como voc√™ pode ver, eles permitem reduzir o consumo de tempo do processador em quase 10%.  Entendo que a maioria de voc√™s provavelmente n√£o tem a capacidade de fazer diretamente altera√ß√µes t√£o complexas no c√≥digo JDK.  Mas a principal conclus√£o aqui, na minha opini√£o, √© que se as perdas de produtividade custam dinheiro e o valor resultante √© grande o suficiente, voc√™ pode tentar melhorar a produtividade usando a biblioteca corutin. </p><br><h1>  Jarmarm </h1><br><p>  Vamos para a nossa outra ferramenta - JWarmup.  √â muito semelhante a outra ferramenta, ReadyNow.  Como sabemos, em Java h√° um problema de aquecimento - o compilador neste est√°gio requer ciclos adicionais de CPU.  Isso nos causou problemas - por exemplo, ocorreu um erro de tempo limite.  Ao escalar, esses problemas pioram e, no nosso caso, estamos falando de uma aplica√ß√£o muito complexa - mais de 20 mil classes e mais de 50 mil m√©todos. </p><br><p>  Antes de come√ßarmos a usar o JWarmup, os propriet√°rios do nosso aplicativo usavam dados simulados para aquecer.  Nesses dados, o compilador JIT pr√©-compilou antes que as solicita√ß√µes fossem recebidas.  Mas os dados simulados s√£o diferentes dos reais, portanto, n√£o s√£o representativos para o compilador.  Em alguns casos, ocorreu desoptimiza√ß√£o inesperada, desempenho prejudicado.  A solu√ß√£o para esse problema foi o JWarmup.  Ele tem duas etapas principais de trabalho - grava√ß√£o e compila√ß√£o.  O Alibaba possui dois tipos de ambientes, beta e produ√ß√£o.  Ambos recebem solicita√ß√µes reais dos usu√°rios, ap√≥s o qual a mesma vers√£o do aplicativo √© implantada nesses dois ambientes.  No ambiente beta, apenas os dados de cria√ß√£o de perfil s√£o coletados, com base nos quais a compila√ß√£o preliminar na produ√ß√£o √© executada. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5e4/aec/01c/5e4aec01c9cece135daff42490463627.jpg"></p><br><p>  Vamos ver com mais detalhes que tipo de informa√ß√£o coletamos.  Precisamos anotar exatamente quais classes s√£o inicializadas, quais m√©todos s√£o compilados, para que esses dados sejam liberados no log do disco r√≠gido, acess√≠vel ao compilador.  O momento mais dif√≠cil √© a inicializa√ß√£o das aulas.       .     ‚Äî   <code>Bar</code>     <code>Foo.test()</code> ,    <code>foo.count</code> .        ,      . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3f9/1fa/cfe/3f91facfe6c55e70cad3bebe147d17ff.jpg"></p><br><p>      JWarmup    (tiered compilation),     .     ,    ‚Äî  CPU.     JWarmup    ,      CPU,   JDK.  ,       ,           JDK. ,             ,     . </p><br><p>       JWarmup.     ,     , ,  groovy-,    Java-,  .     .  ,     ,  ¬´null check elimination¬ª.         . ,    JWarmup    ,       JWarmup,   . </p><br><h1>   </h1><br><p>      ,     Alibaba. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ef5/7c9/4b0/ef57c94b07c6f3335e44d9b7baa360b9.jpg"></p><br><p>    .    JVM ‚Äî  ,    ,     .       Java-, metaspace,  VM (     VM)     JIT-.        OpenJDK. -,          ,       . -,        .   HotMethodProfiling,   ,       CPU.  ,      ,    <em>Honest Profiler</em> ,     ,      ,     HotMethodProfiling.    MethodTracing.           ,    ,     .  ,       metaspace   .          Java-,        .   metaspace  ,    .       Java. </p><br><p> ,      ,   ZProfiler. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/201/324/1fc/2013241fca408ec2cea997d466327a33.jpg"></p><br><p>       .      JVMTi,     JVM (  ).  ,    ZProfiler   Apache Tomcat.      -.    ZProfiler     JVM. ,  ZProfiler  -UI,     . ZProfiler    . -,      UI        JVM. -, ZProfiler  post-mortem . ,        OutOfMemoryError,       ,         JVM   ZProfiler,       .    ,    , , Eclipse MAT. </p><br><p>  .         .   JVM, GCIH,   Alibaba JDK,   JWarmup ‚Äî ,    ReadyNow   Zing JVM. ,    ZProfiler.      ,         ,      OpenJDK.      ,  ,    JWarmup  OpenJDK.  ,      OpenJDK   Loom,     Java.     ,   . </p><br><blockquote>  . ,     ,     JPoint  2018 .    2019 ,   JPoint   , 5-6 .      ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>     Rafael Winterhalter  Sebastian Daschner.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> .        ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   YouTube</a> .   JPoint! </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt436266/">https://habr.com/ru/post/pt436266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt436254/index.html">Um bot para Starcraft em Rust, C ou qualquer outro idioma</a></li>
<li><a href="../pt436256/index.html">Conseguir um emprego na Alemanha ser√° mais f√°cil</a></li>
<li><a href="../pt436260/index.html">Erros e armadilhas das startups em patentear seu IP</a></li>
<li><a href="../pt436262/index.html">* A atualiza√ß√£o do Ethereum "Constantinopla" foi adiada devido a uma potencial vulnerabilidade encontrada no √∫ltimo momento</a></li>
<li><a href="../pt436264/index.html">Mono-reposit√≥rios: por favor n√£o (parte 2)</a></li>
<li><a href="../pt436268/index.html">Coletamos um baralho completo</a></li>
<li><a href="../pt436270/index.html">35% da audi√™ncia do Runet n√£o usa computador para a Internet.</a></li>
<li><a href="../pt436272/index.html">Programa√ß√£o Visual para Sonoff Basic</a></li>
<li><a href="../pt436276/index.html">Visualiza√ß√£o tridimensional em simuladores de material circulante com base no mecanismo OpenSceneGraph</a></li>
<li><a href="../pt436278/index.html">Verificando um projeto CDK com o IntelliJ IDEA Static Analyzer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>