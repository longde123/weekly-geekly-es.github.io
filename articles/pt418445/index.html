<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÉ üö≠ üçû Canais do Django - a resposta para a web moderna üöñ ‚úåüèª üåÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No mundo do Django, o complemento Django Channels est√° ganhando popularidade. Esta biblioteca deve trazer para o Django a programa√ß√£o de rede ass√≠ncro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Canais do Django - a resposta para a web moderna</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/418445/">  No mundo do Django, o complemento Django Channels est√° ganhando popularidade.  Esta biblioteca deve trazer para o Django a programa√ß√£o de rede ass√≠ncrona que est√°vamos esperando.  <strong>Artyom Malyshev</strong> , do Moscow Python Conf 2017, explicou como a primeira vers√£o da biblioteca faz isso (agora o autor j√° compactou os canais2), por que faz e faz. <br><br>  Antes de tudo, o Zen Zen diz que qualquer solu√ß√£o deve ser a √∫nica.  Portanto, <strong>em Python, existem pelo menos tr√™s cada</strong> .  J√° existem muitas estruturas ass√≠ncronas de rede: <br><br><ul><li>  Torcido <br></li><li>  Eventlet <br></li><li>  Gevent <br></li><li>  Tornado; <br></li><li>  Asyncio <br></li></ul><br>  Parece, por que escrever outra biblioteca e se √© necess√°rio? <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ij0PiSlYBu0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong><em>Sobre o palestrante:</em></strong> Artyom Malyshev √© um desenvolvedor independente de Python.  Ele est√° envolvido no desenvolvimento de sistemas distribu√≠dos, fala em confer√™ncias em Python.  O Artyom pode ser encontrado com o apelido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">PROOFIT404</a> no Github e nas redes sociais. <br><a name="habracut"></a><br>  <strong>O Django √© s√≠ncrono por defini√ß√£o</strong> .  Se estamos falando sobre ORM, o acesso s√≠ncrono ao banco de dados durante o acesso ao atributo, quando escrevemos, por exemplo, post.author.username, n√£o custa nada. <br><br>  Al√©m disso, o Django √© uma estrutura WSGI. <br><br><h2>  WSGI <br></h2><br>  O WSGI √© uma interface s√≠ncrona para trabalhar com servidores da web. <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(environ, callback)</span></span></span><span class="hljs-function"> :</span></span> status, headers = <span class="hljs-string"><span class="hljs-string">'200 OK'</span></span>, [] callback (status, headers) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'Hello world!\n'</span></span>]</code> </pre> <br>  Sua principal caracter√≠stica √© que temos uma fun√ß√£o que recebe um argumento e retorna imediatamente um valor.  Isso √© tudo o que o servidor da web pode esperar de n√≥s.  <strong>N√£o ass√≠ncrono e n√£o tem cheiro</strong> . <br><br>  Isso foi feito h√° muito tempo, em 2003, quando a web era simples, os usu√°rios liam todos os tipos de not√≠cias na Internet e acessavam os livros de visitas.  Foi o suficiente apenas para aceitar a solicita√ß√£o e process√°-la.  D√™ uma resposta e esque√ßa que este usu√°rio era mesmo. <br><img src="https://habrastorage.org/webt/-a/3e/ly/-a3elynsjri1d0qbc73yl256qbo.jpeg"><br><br>  Mas, por um segundo, agora n√£o √© o ano de 2003, ent√£o os usu√°rios querem muito mais de n√≥s. <br><img src="https://habrastorage.org/webt/-j/fp/nz/-jfpnzpcfn0w2hpbvmcejswxnaw.jpeg"><br>  Eles querem aplicativos da Web ricos, conte√∫do ao vivo, querem que o aplicativo funcione muito bem na √°rea de trabalho, no laptop, em outros tops, no rel√≥gio.  Mais importante, os <strong>usu√°rios n√£o querem pressionar F5</strong> , porque, por exemplo, os tablets n√£o possuem esse bot√£o. <br><br><img src="https://habrastorage.org/webt/bq/gi/ql/bqgiql6zzob87g74yngfmwvkehs.jpeg"><br><br>  Navegadores da Web naturalmente v√™m nos encontrar - eles adicionam novos protocolos e novos recursos.  Se voc√™ e eu apenas desenvolv√™ssemos o frontend, usar√≠amos o navegador como uma plataforma e usar√≠amos seus principais recursos, pois ele est√° pronto para fornec√™-los. <br><br>  <strong>Mas, para programadores de back-end, tudo mudou muito</strong> .  Soquetes da Web, HTTP2 e similares s√£o uma enorme dor em termos de arquitetura, porque s√£o conex√µes duradouras com seus estados que precisam ser manipuladas de alguma forma. <br><img src="https://habrastorage.org/webt/g1/pn/gi/g1pngi6z8op3aesfec2rtiodv4q.jpeg"><br><br>  Este √© o problema que os canais do Django para Django est√£o tentando resolver.  Esta biblioteca foi projetada para permitir a voc√™ lidar com conex√µes, deixando o Django Core a que estamos acostumados. <br><br>  Ele foi feito uma pessoa maravilhosa por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Andrew Godwin</strong></a> , o dono de um terr√≠vel sotaque ingl√™s que fala muito rapidamente.  Voc√™ deve conhec√™-lo com coisas como as h√° muito esquecidas Django South e Django Migrations, que vieram at√© n√≥s da vers√£o 1.7.  Desde que ele corrigiu as migra√ß√µes para o Django, ele come√ßou a reparar os soquetes da web e o HTTP2. <br><br>  Como ele fez isso?  Era uma vez uma imagem na Internet: quadrados vazios, setas, a inscri√ß√£o ‚ÄúBoa arquitetura‚Äù - voc√™ insere suas tecnologias favoritas nesses pequenos quadrados, obt√©m um site que se adapta bem. <br><br><img src="https://habrastorage.org/webt/r1/rz/z9/r1rzz99ck74ggy5uy8vnn7kebks.jpeg"><br><br>  Andrew Godwin inseriu um servidor nessas caixas, que fica na frente e aceita todos os pedidos, sejam ass√≠ncronos, s√≠ncronos, e-mail, qualquer que seja.  Entre eles est√° a chamada camada de canal, que armazena as mensagens recebidas em um formato acess√≠vel ao pool de trabalhadores s√≠ncronos.  Assim que a conex√£o ass√≠ncrona nos enviou algo, n√≥s a gravamos na camada de canal e, em seguida, o trabalhador s√≠ncrono pode busc√°-la e process√°-la da mesma maneira que qualquer Django View ou qualquer outra coisa, de forma s√≠ncrona.  Assim que o c√≥digo s√≠ncrono enviar uma resposta de volta √† camada de canal, o servidor ass√≠ncrono fornecer√°, transmitir√° e far√° o que for necess√°rio.  Assim, a abstra√ß√£o √© realizada. <br><br>  Isso implica v√°rias implementa√ß√µes e, na produ√ß√£o, √© proposto o uso do <strong>Twisted como um servidor ass√≠ncrono</strong> que implementa o frontend do Django, e do <strong>Redis</strong> , que ser√° o mesmo canal de comunica√ß√£o entre o Django s√≠ncrono e o Twisted ass√≠ncrono. <br><br><blockquote>  A boa not√≠cia: para usar os canais do Django, voc√™ n√£o precisa conhecer Twisted ou Redis - estes s√£o todos os detalhes da implementa√ß√£o.  Seus DevOps saber√£o disso ou voc√™ se encontrar√° quando reparar uma produ√ß√£o ca√≠da √†s tr√™s da manh√£. </blockquote><br><h2>  ASGI </h2><br>  Abstra√ß√£o √© um protocolo chamado ASGI.  Essa √© a interface padr√£o que existe entre qualquer interface de rede, servidor, seja um protocolo s√≠ncrono ou ass√≠ncrono e seu aplicativo.  Seu principal conceito √© o canal. <br><br><h3>  Canal </h3><br>  Um canal √© uma fila de mensagens primeiro a entrar, primeiro a sair.  Essas mensagens podem ser entregues zero ou uma vez e s√≥ podem ser recebidas por um consumidor. <br><br><h3>  Consumidores </h3><br>  No Consumer, voc√™ est√° apenas escrevendo seu c√≥digo. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_message</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> message.reply_channel.send ( { <span class="hljs-string"><span class="hljs-string">'text'</span></span>: message.content [<span class="hljs-string"><span class="hljs-string">'text'</span></span>], } )</code> </pre><br>  Uma fun√ß√£o que aceita uma mensagem pode enviar v√°rias respostas ou pode n√£o enviar nenhuma resposta.  Muito semelhante √† visualiza√ß√£o, a √∫nica diferen√ßa √© que n√£o h√° fun√ß√£o de retorno, para que possamos falar sobre quantas respostas retornamos da fun√ß√£o. <br><br>  N√≥s adicionamos essa fun√ß√£o ao roteamento, por exemplo, desligue-a para receber uma mensagem em um soquete da web. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.routing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> myapp.consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ws_message channel_routing = [ route (<span class="hljs-string"><span class="hljs-string">'websocket.receive'</span></span> ws_message), }</code> </pre><br>  N√≥s escrevemos isso nas configura√ß√µes do Django, assim como o banco de dados seria prescrito. <br><br><pre> <code class="python hljs">CHANNEL_LAYERS = { <span class="hljs-string"><span class="hljs-string">'default'</span></span>: { <span class="hljs-string"><span class="hljs-string">'BACKEND'</span></span>: <span class="hljs-string"><span class="hljs-string">'asgiref.inmemory'</span></span>, <span class="hljs-string"><span class="hljs-string">'ROUTING'</span></span>: <span class="hljs-string"><span class="hljs-string">'myproject.routing'</span></span>, }, }</code> </pre><br>  Um projeto pode ter v√°rias camadas de canal, assim como v√°rios bancos de dados.  Essa coisa √© muito semelhante ao roteador db, se algu√©m o usou. <br><br>  Em seguida, definimos nosso aplicativo ASGI.  Ele sincroniza como o Twisted √© iniciado e como os trabalhadores sincronizados s√£o iniciados - todos eles precisam desse aplicativo. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.asgi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_channel_layer os.environ.setdefault( <span class="hljs-string"><span class="hljs-string">'DJANGO_SETTINGS_MODULE'</span></span>, <span class="hljs-string"><span class="hljs-string">'myproject.settings'</span></span>, ) channel_layer = get_channel_layer()</code> </pre><br>  Depois disso, implemente o c√≥digo: execute gunicorn, envie uma solicita√ß√£o HTTP de forma s√≠ncrona, com visualiza√ß√£o, como voc√™ est√° acostumado.  Iniciamos o servidor ass√≠ncrono, que ser√° a frente do nosso Django s√≠ncrono, e os trabalhadores que processar√£o as mensagens. <br><br><pre> <code class="python hljs">$ gunicorn myproject.wsgi $ daphne myproject.asgi:channel_layer $ django-admin runworker</code> </pre><br><h3>  Canal de resposta </h3><br>  Como vimos, a mensagem tem um conceito como canal de resposta.  Por que isso √© necess√°rio? <br><br>  Canal unidirecional, respectivamente, recebimento de WebSocket, conex√£o de WebSocket, desconex√£o de WebSocket - este √© um canal comum ao sistema para mensagens recebidas.  Um canal de resposta √© estritamente vinculado √† conex√£o do usu√°rio.  Consequentemente, a mensagem possui um canal de entrada e sa√≠da.  Este par permite identificar de quem veio esta mensagem. <br><img src="https://habrastorage.org/webt/rp/_k/wm/rp_kwmeuccjs2bunsar-hoei9au.jpeg"><br><br><h3>  Grupos </h3><br>  Um grupo √© uma cole√ß√£o de canais.  Se enviarmos uma mensagem para um grupo, ela ser√° enviada automaticamente para todos os canais deste grupo.  Isso √© conveniente porque ningu√©m gosta de escrever para loops.  Al√©m disso, a implementa√ß√£o de grupos geralmente √© feita usando as fun√ß√µes nativas da camada Channel, por isso √© mais r√°pido do que apenas enviar mensagens uma por vez. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Group <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>).add (message.reply_channel) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_disconnect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>).discard(message.reply_channel) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_message</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>). Send ({ <span class="hljs-string"><span class="hljs-string">'text'</span></span>: message.content [<span class="hljs-string"><span class="hljs-string">'text'</span></span>], })</code> </pre><br>  Os grupos tamb√©m s√£o adicionados ao roteamento da mesma maneira. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.routing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> myapp.consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * channel_routing = [ route (<span class="hljs-string"><span class="hljs-string">'websocket.connect'</span></span> , ws_connect), route (<span class="hljs-string"><span class="hljs-string">'websocket.disconnect'</span></span> , ws_disconnect), route (<span class="hljs-string"><span class="hljs-string">'websocket.receive'</span></span> , ws_message), ]</code> </pre><br>  E assim que o canal for adicionado ao grupo, a resposta ser√° enviada para todos os usu√°rios conectados ao nosso site, e n√£o apenas a resposta de eco para n√≥s mesmos. <br><br><h3>  Consumidores gen√©ricos </h3><br>  O que eu amo o Django √© declarativo.  Da mesma forma, existem consumidores declarativos. <br><br>  O Consumidor base √© b√°sico, ele s√≥ pode mapear o canal que voc√™ definiu em algum m√©todo e cham√°-lo. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BaseConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyComsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseConsumer)</span></span></span><span class="hljs-class"> :</span></span> method_mapping = { <span class="hljs-string"><span class="hljs-string">'channel.name.here'</span></span>: <span class="hljs-string"><span class="hljs-string">'method_name'</span></span>, } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method_name</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message, **kwargs)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  H√° um grande n√∫mero de consumidores predefinidos com comportamento deliberadamente aumentado, como o WebSocket Consumer, que pr√©-determina que ele manipular√° a conex√£o com o WebSocket, o recebimento do WebSocket, a desconex√£o do WebSocket.  Voc√™ pode indicar imediatamente em quais grupos adicionar um canal de resposta e, assim que usar self.send, ele entender√° se deve envi√°-lo para um grupo ou para um usu√°rio. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketConsumer)</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connection_groups</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'chat'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text=None, bytes=None)</span></span></span><span class="hljs-function"> :</span></span> self.send (text=text, bytes=bytes)</code> </pre><br>  H√° tamb√©m uma op√ß√£o de consumidor WebSocket com JSON, ou seja, n√£o texto, n√£o bytes, mas o JSON j√° analisado chegar√° a receber, o que √© conveniente. <br><br>  No roteamento, √© adicionado da mesma maneira via route_class.  Myapp √© obtido em route_class, que √© determinado pelo consumidor, todos os canais s√£o retirados de l√° e todos os canais especificados em myapp s√£o roteados.  Escreva menos assim. <br><br><h2>  Encaminhamento </h2><br>  Vamos falar em detalhes sobre o roteamento e o que ele nos fornece. <br><br>  Em primeiro lugar, estes s√£o filtros. <br><br><pre> <code class="python hljs">// app.js S = new WebSocket (<span class="hljs-string"><span class="hljs-string">'ws://localhost:8000/chat/'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># routing.py route('websocket.connect', ws_connect, path=r'^/chat/$')</span></span></code> </pre><br>  Esse pode ser o caminho que nos chegou a partir do URI de conex√£o do soquete da web ou do m√©todo de solicita√ß√£o http.  Pode ser qualquer campo de mensagem do canal, por exemplo, para e-mail: texto, corpo, c√≥pia carbono, qualquer que seja.  O n√∫mero de argumentos de palavra-chave para a rota √© arbitr√°rio. <br><br>  O roteamento permite fazer rotas aninhadas.  Se v√°rios consumidores forem determinados por algumas caracter√≠sticas comuns, √© conveniente agrup√°-los e adicionar todos √† rota de uma s√≥ vez. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route, include blog_routes = [ route ( <span class="hljs-string"><span class="hljs-string">'websocket.connect'</span></span>, blog, path = <span class="hljs-string"><span class="hljs-string">r'^/stream/'</span></span>) , ] routing = [ include (blog_routes, path= <span class="hljs-string"><span class="hljs-string">r'^/blog'</span></span> ), ]</code> </pre><br><h2>  Multiplexa√ß√£o </h2><br>  Se abrirmos v√°rios soquetes da Web, cada um ter√° um URI diferente e poderemos travar v√°rios manipuladores.  Mas, para ser sincero, abrir v√°rias conex√µes apenas para fazer algo bonito no back-end n√£o parece uma abordagem de engenharia. <br><br>  Portanto, √© poss√≠vel chamar v√°rios manipuladores em um soquete da web.  Definimos esse WebsocketDemultiplexer que opera no conceito de fluxo em um √∫nico soquete da web.  Por esse fluxo, ele redirecionar√° sua mensagem para outro canal. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketDemultiplexer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demultiplexer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketDemultiplexer)</span></span></span><span class="hljs-class"> :</span></span> mapping = { <span class="hljs-string"><span class="hljs-string">'intval'</span></span>: <span class="hljs-string"><span class="hljs-string">'binding.intval'</span></span>, }</code> </pre><br>  No roteamento, o multiplexador √© adicionado da mesma maneira que em qualquer outro consumidor declarado route_class. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route_class, route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Demultiplexer, ws_message channel_routing = [ route_class (Demultiplexer, path=<span class="hljs-string"><span class="hljs-string">'^/binding/'</span></span>) , route (<span class="hljs-string"><span class="hljs-string">'binding.intval'</span></span>, ws_message ) , ]</code> </pre><br>  O argumento de fluxo √© adicionado √† mensagem para que o multiplexador possa descobrir onde colocar a mensagem fornecida.  O argumento de carga √∫til cont√©m tudo o que entra no canal depois que o multiplexador o processa. <br><br>  √â muito importante observar que, na camada de canal, a mensagem ser√° exibida <strong>duas vezes</strong> : antes do multiplexador e depois do multiplexador.  Assim, assim que voc√™ come√ßa a usar o multiplexador, voc√™ adiciona automaticamente lat√™ncia √†s suas solicita√ß√µes. <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"stream"</span></span> : <span class="hljs-string"><span class="hljs-string">"intval"</span></span>, <span class="hljs-string"><span class="hljs-string">"payload"</span></span> : { ‚Ä¶ } }</code> </pre><br><h2>  Sess√µes </h2><br>  Cada canal tem suas pr√≥prias sess√µes.  Isso √© muito conveniente, por exemplo, para armazenar o estado entre chamadas para manipuladores.  Voc√™ pode agrup√°-los por canal de resposta, porque este √© um identificador que pertence ao usu√°rio.  A sess√£o √© armazenada no mesmo mecanismo que a sess√£o http normal.  Por raz√µes √≥bvias, os cookies assinados n√£o s√£o suportados, eles simplesmente n√£o est√£o no soquete da web. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.sessions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> channel_session @channel_session <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> room=message.content [<span class="hljs-string"><span class="hljs-string">'path'</span></span>] message.channel_session [<span class="hljs-string"><span class="hljs-string">'room'</span></span>] = room Croup (<span class="hljs-string"><span class="hljs-string">'chat-%s'</span></span> % room).add ( message.reply_channel )</code> </pre><br>  Durante a conex√£o, voc√™ pode obter uma sess√£o http e us√°-la em seu consumidor.  Como parte do processo de negocia√ß√£o, configurando uma conex√£o de soquete da web, os cookies s√£o enviados ao usu√°rio.  Portanto, voc√™ pode obter uma sess√£o de usu√°rio, obter o objeto de usu√°rio que voc√™ costumava usar no Django antes, como se estivesse trabalhando com o view. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.sessions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> http_session_user @http_session_user <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> message.http_session [<span class="hljs-string"><span class="hljs-string">'room'</span></span>] = room <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> message.user.username : ‚Ä¶</code> </pre><br><h2>  Ordem das mensagens </h2><br>  Canais podem resolver um problema muito importante.  Se estabelecermos uma conex√£o com um soquete da Web e enviarmos imediatamente, isso levar√° ao fato de que os dois eventos - o WebSocket connect e o WebSocket receive - est√£o muito pr√≥ximos no tempo.  √â muito prov√°vel que o consumidor desses soquetes da Web seja executado em paralelo.  Depurar isso ser√° muito divertido. <br><br>  Os canais do Django permitem inserir um bloqueio de dois tipos: <br><br><ol><li>  <strong>Bloqueio</strong> <strong>f√°cil</strong> .  Usando o mecanismo de sess√£o, garantimos que, at√© que o consumidor seja processado para receber uma mensagem, n√£o processaremos nenhuma mensagem nos soquetes da web.  Depois que a conex√£o √© estabelecida, a ordem √© arbitr√°ria, a execu√ß√£o paralela √© poss√≠vel. </li><li>  <strong>Bloqueio</strong> <strong>r√≠gido</strong> - apenas um consumidor de um usu√°rio espec√≠fico est√° executando por vez.  Isso √© uma sobrecarga para sincroniza√ß√£o, porque usa um mecanismo de sess√£o lento.  No entanto, existe essa oportunidade. </li></ol><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyConsumer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketConsumer)</span></span></span><span class="hljs-class"> :</span></span> http_user = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> slight_ordering = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> strict_ordering = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connection_groups</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'chat'</span></span>]</code> </pre><br>  Para escrever isso, existem os mesmos decoradores que vimos anteriormente na sess√£o http, sess√£o de canal.  No consumidor declarativo, voc√™ pode simplesmente escrever atributos, assim que os escrever, isso ser√° aplicado automaticamente a todos os m√©todos desse consumidor. <br><br><h2>  Liga√ß√£o de dados </h2><br>  Ao mesmo tempo, o Meteor ficou famoso pela liga√ß√£o de dados. <br><br>  Abrimos dois navegadores, vamos para a mesma p√°gina e em um deles clicamos na barra de rolagem.  Ao mesmo tempo, no segundo navegador, nesta p√°gina, a barra de rolagem altera seu valor.  Isso √© legal. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntegerValueBinding</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketBinding)</span></span></span><span class="hljs-class"> :</span></span> model = IntegerValue stream = intval<span class="hljs-string"><span class="hljs-string">' fields= ['</span></span>name<span class="hljs-string"><span class="hljs-string">', '</span></span>value<span class="hljs-string"><span class="hljs-string">'] def group_names (self, instance, action ) : return ['</span></span>intval-updates<span class="hljs-string"><span class="hljs-string">'] def has_permission (self, user, action, pk) : return True</span></span></code> </pre><br>  O Django agora faz o mesmo. <br><br>  Isso √© implementado usando ganchos fornecidos pelo <strong>Django Signals</strong> .  Se a liga√ß√£o for definida para o modelo, todas as conex√µes que est√£o no grupo para esta inst√¢ncia do modelo ser√£o notificadas de cada evento.  Criamos um modelo, alteramos o modelo, o exclu√≠mos - tudo isso ser√° um aviso.  A notifica√ß√£o ocorre nos campos indicados: o valor desse campo foi alterado - uma carga √∫til est√° sendo formada, enviada pelo soquete da web.  Isso √© conveniente. <br><br>  √â importante entender que, se no nosso exemplo clicarmos constantemente na barra de rolagem, as mensagens ser√£o exibidas constantemente e o modelo ser√° salvo.  Isso funcionar√° at√© uma certa carga, e tudo ficar√° contra a base. <br><br><h2>  Camada Redis </h2><br>  Vamos falar um pouco mais sobre como √© organizada a camada de canal mais popular para produ√ß√£o - Redis. <br><br>  Est√° bem organizado: <br><br><ul><li>  trabalha com conex√µes s√≠ncronas no n√≠vel dos trabalhadores; </li><li>  muito amig√°vel ao Twisted, n√£o diminui a velocidade, onde √© especialmente necess√°rio, ou seja, no seu servidor front-end; </li><li>  O MSGPACK √© usado para serializar mensagens dentro do Redis, o que reduz o espa√ßo ocupado em cada mensagem; </li><li>  voc√™ pode distribuir a carga para v√°rias inst√¢ncias do Redis, ela ser√° embaralhada automaticamente usando o algoritmo de hash consistente.  Assim, um √∫nico ponto de falha desaparece. </li></ul><br>  Um canal √© apenas uma lista de identifica√ß√£o da Redis.  Por id √© o valor de uma mensagem espec√≠fica.  Isso √© feito para que voc√™ possa controlar a vida √∫til de cada mensagem e canal separadamente.  Em princ√≠pio, isso √© l√≥gico. <br><br><pre> <code class="python hljs">&gt;&gt; SET <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> <span class="hljs-string"><span class="hljs-string">" \x81\xa4text\xachello"</span></span> &gt;&gt; RPUSH <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> &gt;&gt; EXPIRE <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> <span class="hljs-string"><span class="hljs-string">"60"</span></span> &gt;&gt; EXPIRE <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-string"><span class="hljs-string">"61"</span></span></code> </pre><br>  Grupos s√£o implementados por conjuntos classificados.  A distribui√ß√£o para grupos √© realizada dentro do script Lua - isso √© muito r√°pido. <br><br><pre> <code class="python hljs">&gt;&gt; type group:chat zset &gt;&gt; ZRANGE group:chat <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> WITHSCORES <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"1476199781.8159261"</span></span></code> </pre><br><h2>  Problemas </h2><br>  Vamos ver quais problemas essa abordagem tem. <br><br><h3>  Inferno de retorno de chamada </h3><br>  O primeiro problema √© o inferno de retorno de chamada rec√©m-inventado.  √â muito importante entender que a maioria dos problemas com os canais que voc√™ encontrar√° ser√° em grande estilo: argumentos chegaram ao consumidor que ele n√£o esperava.  De onde eles vieram, quem os colocou no Redis - tudo isso √© uma tarefa de investiga√ß√£o duvidosa.  Depura√ß√£o de sistemas distribu√≠dos geralmente para os mais exigentes.  O AsyncIO resolve esse problema. <br><br><h3>  Aipo </h3><br>  Na Internet, eles escrevem que o Django Channels substitui o aipo. <br><img src="https://habrastorage.org/webt/x9/be/j8/x9bej8oul6vevk2r8e12q9-i_ia.jpeg"><br>  Tenho m√°s not√≠cias para voc√™ - n√£o, n√£o √© isso. <br><br>  Nos canais: <br><br><ul><li>  sem nova tentativa, voc√™ n√£o pode atrasar a execu√ß√£o de um manipulador; <br></li><li>  sem tela - apenas um retorno de chamada.  O aipo tamb√©m fornece grupos, cadeia, meu acorde favorito, que, ap√≥s executar grupos em paralelo, causa outro retorno de chamada com sincroniza√ß√£o.  Tudo isso n√£o est√° nos canais; </li><li>  n√£o h√° configura√ß√£o da hora de chegada das mensagens, alguns sistemas sem isso s√£o simplesmente imposs√≠veis de projetar. </li></ul><br><blockquote>  Eu vejo o futuro como um suporte oficial para o uso de canais e aipo juntos, com custo m√≠nimo e esfor√ßo m√≠nimo.  Mas os canais do Django n√£o substituem o aipo. <br></blockquote><br><h2>  Django para web moderna </h2><br>  Canais do Django √© o Django para a web moderna.  Este √© o mesmo Django que estamos acostumados a usar: s√≠ncrono, declarativo, com muitas baterias.  Canais Django √© apenas mais uma bateria.  Voc√™ sempre precisa entender onde us√°-lo e se vale a pena faz√™-lo.  Se o Django n√£o for necess√°rio no projeto, os canais tamb√©m n√£o ser√£o necess√°rios.  Eles s√£o √∫teis apenas nos projetos nos quais o Django √© justificado. <br><br><blockquote>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Moscow Python Conf ++</a></strong> <br><br>  Uma confer√™ncia profissional para desenvolvedores de Python chega a um novo n√≠vel - <strong>nos dias 22 e 23 de outubro de</strong> 2018, reuniremos os 600 melhores programadores de Python da R√∫ssia, apresentaremos os relat√≥rios mais interessantes e, √© claro, criaremos um ambiente de networking nas melhores tradi√ß√µes da comunidade Python de Moscou, com o apoio da equipe da Ontiko. <br><br>  Convidamos especialistas para fazer um relat√≥rio.  O comit√™ do programa j√° est√° trabalhando e aceita <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inscri√ß√µes</a> at√© 7 de setembro. <br><br>  Para os participantes, um programa de brainstorming on-line est√° sendo realizado.  Voc√™ pode adicionar t√≥picos ausentes neste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documento</a> ou palestrantes, cujos discursos s√£o do seu interesse.  O documento ser√° atualizado, de fato, o tempo todo, voc√™ poder√° acompanhar a forma√ß√£o do programa. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418445/">https://habr.com/ru/post/pt418445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418433/index.html">4 de agosto Peter. A primeira busca de bicicleta para programadores</a></li>
<li><a href="../pt418437/index.html">Oc equipe para o resgate</a></li>
<li><a href="../pt418439/index.html">No√ß√µes b√°sicas progressivas sobre aplicativos da Web</a></li>
<li><a href="../pt418441/index.html">No√ß√µes b√°sicas de escalonamento de privil√©gios do Windows</a></li>
<li><a href="../pt418443/index.html">GObject: encapsulamento, instancia√ß√£o, introspec√ß√£o</a></li>
<li><a href="../pt418447/index.html">Por que o Moscow Python Conf √© agora ++</a></li>
<li><a href="../pt418449/index.html">M√≥dulos bin√°rios para Python</a></li>
<li><a href="../pt418451/index.html">Aulas de impress√£o 3D. Suporte eficaz e altera√ß√£o da altura da camada na pr√°tica do 3Dtool</a></li>
<li><a href="../pt418453/index.html">As observa√ß√µes do GRAVITY validam ainda mais a relatividade geral</a></li>
<li><a href="../pt418455/index.html">Semin√°rio on-line aberto ‚ÄúEspecialista no comando: primeira experi√™ncia e erros‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>