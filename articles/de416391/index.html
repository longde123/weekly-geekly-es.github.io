<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî´ üò® üßùüèª Optimierung der Platzierung virtueller Maschinen auf Servern üíà üíÇ ü¶ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einiger Zeit sagte einer meiner Kollegen, dass der Platz im DC knapp wird, es keinen Platz f√ºr den Server gibt und die Last w√§chst und es nicht kl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Optimierung der Platzierung virtueller Maschinen auf Servern</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416391/">  Vor einiger Zeit sagte einer meiner Kollegen, dass der Platz im DC knapp wird, es keinen Platz f√ºr den Server gibt und die Last w√§chst und es nicht klar ist, was zu tun ist, und dass Sie wahrscheinlich alle verf√ºgbaren Server auf leistungsf√§higere Server umstellen m√ºssen. <br><br>  Zu dieser Zeit war ich mit der Erstellung optimaler Zeitpl√§ne besch√§ftigt und dachte - aber was ist, wenn wir Optimierungsalgorithmen anwenden, um die Servernutzung im DC zu erh√∂hen?  Von hier aus wurde das Projekt geboren, √ºber das ich schreiben m√∂chte. <br><br>  F√ºr fortgeschrittene Benutzer sage ich sofort, dass wir in diesem Artikel √ºber das Verpacken von Beh√§ltern sprechen werden. F√ºr den Rest, der lernen m√∂chte, wie mit relativ einfachen Berechnungen bis zu 30% der Serverressourcen eingespart werden k√∂nnen, ist cat willkommen. <br><a name="habracut"></a><br>  Wir haben also einen DC mit ungef√§hr 100 Servern, auf denen ungef√§hr 7.000 virtuelle Maschinen gehostet werden.  Was sich in den virtuellen Maschinen befindet - wir wissen es nicht und sollten es nicht wissen.  Es ist erforderlich, virtuelle Maschinen auf Servern zu platzieren, um SLA durchzuf√ºhren und gleichzeitig die Mindestanzahl von Servern zu verwenden. <br><br>  Wir wissen: <br><br><ul><li>  Serverliste </li><li>  Anzahl der Ressourcen auf jedem Server (CPU-Zeit, CPU-Kerne, RAM, Festplatte, Festplatten-Io, Netzwerk-Io). </li><li>  Liste der virtuellen Maschinen (VM) </li><li>  Die Menge der von jeder virtuellen Maschine verbrauchten Ressourcen (CPU-Zeit, CPU-Kerne, RAM, Festplatte, Festplatten-Io, Netzwerk-Io). </li><li>  Ressourcenverbrauch durch das Hostsystem auf den Servern. </li></ul><br>  Wir m√ºssen virtuelle Maschinen auf die Server verteilen, damit f√ºr jede der Ressourcen auf jedem Server die verf√ºgbare Menge der Ressource nicht √ºberschritten wird, und gleichzeitig die Mindestanzahl von Servern verwenden. <br><br>  Diese Aufgabe wird in der wissenschaftlichen Literatur als M√ºllverpackungsproblem bezeichnet (wie wird es auf Russisch sein?).  In einfachen Worten ist dies eine Aufgabe, wie kleine Kisten beliebiger Gr√∂√üe in gro√üe Kisten geschoben werden k√∂nnen und gleichzeitig die Mindestanzahl gro√üer Kisten verwendet wird.  Das in der Mathematik bekannte Problem NP-complete wird nur durch eine umfassende Suche pr√§zise gel√∂st, deren Kosten kombinatorisch steigen. <br><br>  Das folgende Bild zeigt die Essenz des Bin-Packing-Algorithmus f√ºr den eindimensionalen Fall: <br><br><img src="https://habrastorage.org/webt/ft/wo/fx/ftwofxgaz8qtbx56plkh2c1txqi.png"><br>  <i>Abb.</i>  <i>1. Darstellung des Problems der Beh√§lterverpackung, nicht optimale Platzierung</i> <br><br>  In der ersten Abbildung sind die Gegenst√§nde irgendwie auf die K√∂rbe verteilt und 3 K√∂rbe werden verwendet, um sie zu platzieren. <br><br><img src="https://habrastorage.org/webt/53/-x/cb/53-xcbdj3zvqgnlx4yov1xybnrw.png"><br>  <i>Abb.</i>  <i>2. Darstellung des Problems der Beh√§lterverpackung, optimale Platzierung</i> <br><br>  Das zweite Bild zeigt die optimale Verteilung, f√ºr die Sie nur 2 K√∂rbe ben√∂tigen. <br><br>  Die Standardformulierung des Algorithmus zum Verpacken von Beh√§ltern geht auch davon aus, dass alle K√∂rbe gleich sind.  Unsere Server sind nicht gleich, da sie zu unterschiedlichen Zeiten gekauft wurden und ihre Konfiguration unterschiedlich ist - unterschiedliche Anzahl von Prozessorkernen, Speicher, Festplatte, unterschiedliche Prozessorleistung. <br><br>  Eine suboptimale L√∂sung kann unter Verwendung von Heuristiken, genetischen Algorithmen, Monte-Carlo-Baumsuche und tiefen neuronalen Netzen erhalten werden.  Wir haben uns f√ºr den heuristischen BestFit-Algorithmus entschieden, der zu einer L√∂sung konvergiert, die nicht mehr als 1,7-mal schlechter als die optimale ist, sowie f√ºr einige Variationen des genetischen Algorithmus.  Im Folgenden werde ich die Ergebnisse ihrer Anwendung geben. <br><br>  Lassen Sie uns zun√§chst diskutieren, was mit zeitvariablen Metriken wie CPU-Auslastung, Festplatten-Io und Netzwerk-Io zu tun ist.  Am einfachsten ist es, die variable Metrik durch eine Konstante zu ersetzen.  Aber wie w√§hlt man den Wert dieser Konstante?  Wir haben den Maximalwert der Metrik f√ºr einen charakteristischen Zeitraum verwendet (zuvor Ausrei√üer der Werte gegl√§ttet).  Die Woche stellte sich in unserem Fall als charakteristischer Zeitraum heraus, da die Hauptsaisonalit√§t der Ladung mit Arbeitstagen und freien Tagen verbunden war. <br><br>  In diesem Modell wird jeder virtuellen Maschine ein Ressourcenstreifen mit der Gr√∂√üe des maximal verbrauchten Ressourcenwerts zugewiesen, und jede VM wird durch die Konstanten maximale CPU-Auslastung, RAM, Festplatte, maximale Festplatten-Io, maximale Netzwerk-Io beschrieben. <br><br>  Als N√§chstes verwenden wir den Algorithmus zur Berechnung der optimalen Packung und erhalten eine Karte des Standorts der VM auf physischen Servern. <br><br>  Die Praxis zeigt, dass der Server √ºberlastet wird, wenn Sie nicht f√ºr jede Ressource auf dem Server einen bestimmten Spielraum lassen. Wenn die VM dicht zugewiesen ist, wird sie √ºberlastet.  F√ºr die CPU-Auslastung belassen wir daher einen Spielraum von 30%, f√ºr RAM 20%, f√ºr Festplatte io - 20% und f√ºr Netzwerk io - 20%. Diese Grenzwerte werden empirisch ausgew√§hlt. <br><br>  Wir haben auch verschiedene Arten von Festplatten (schnelle SSDs und langsame billige Festplatten). F√ºr jede Art von Festplatte werden Festplatten- und Festplatten-Io-Metriken separat verwendet, sodass das endg√ºltige Modell etwas komplizierter wird und mehr Dimensionen aufweist. <br><br>  Das Ergebnis der Optimierung der VM-Platzierung ist in der folgenden Abbildung dargestellt: <br><br><img src="https://habrastorage.org/webt/-9/vj/wy/-9vjwyj2x4a__iiszz7l9clhopq.png"><br>  <i>Abb.</i>  <i>3. Das Ergebnis der Optimierung der Platzierung von VMs auf Servern</i> <br><br>  Horizontal - die Anzahl der optimierten Server, vertikal - die Anzahl der freigegebenen Server f√ºr die BestFit-Heuristik und f√ºr den genetischen Algorithmus. <br><br>  Welche Schlussfolgerungen k√∂nnen aus dem Diagramm gezogen werden? <br><br><ol><li>  F√ºr aktuelle Aufgaben k√∂nnen Sie 20 bis 30% weniger Server verwenden. </li><li>  Je mehr Server Sie gleichzeitig optimieren, desto mehr gewinnen Sie in%. Bei einer Anzahl von Servern ab 40 tritt eine S√§ttigung auf. </li><li>  Der genetische Algorithmus ist der heuristischen BestFit etwas √ºberlegen.  Wenn wir unsere Ergebnisse weiter verbessern wollen, werden wir in diese Richtung graben. </li></ol><br>  Welche anderen Probleme sind in der Praxis aufgetreten? <br><br><ol><li>  Wenn Sie etwa 100 Server mit 7.000 virtuellen Maschinen aufr√ºtteln m√∂chten, ist das Migrationsvolumen sehr hoch, sodass die gesamte Idee nicht realisierbar ist.  Wenn Sie jedoch mit Gruppen von 20 bis 40 Servern nacheinander arbeiten, ist der Effekt fast gleich, aber die Anzahl der Migrationen ist um ein Vielfaches geringer.  Und Sie k√∂nnen Ihren DC in Teilen optimieren. </li><li>  Wenn Sie Live-Migrationen durchf√ºhren m√ºssen, kann es vorkommen, dass die Migration nicht beendet werden kann.  Dies bedeutet, dass innerhalb der VM ein intensives Schreiben auf die Festplatte erfolgt und / oder sich der Status des Speichers √§ndert und der VM-Status zwischen dem alten und dem neuen Replikat keine Zeit zum Synchronisieren hat, bis sich der Status des alten Replikats √§ndert.  In diesem Fall m√ºssen Sie solche VM-Maschinen vordefinieren und als nicht beweglich markieren.  Dies erfordert wiederum eine Modifikation der Optimierungsalgorithmen.  Was gef√§llt, ist, dass der Gesamtgewinn praktisch unabh√§ngig von der Anzahl solcher Maschinen ist, wenn nicht mehr als 10-15% der Gesamtzahl der VMs vorhanden sind. </li></ol><br><h2>  Wie √§ndert sich die Serverlast nach der Optimierung der VM-Platzierung? </h2><br>  Ok, wir haben die VM-Platzierung optimiert.  Vielleicht ist der resultierende neue Zustand in Bezug auf die Zunahme der Last sehr fragil?  Vielleicht laufen die Server bis zum Limit und jede Erh√∂hung der Last wird sie t√∂ten? <br><br>  Wir haben die Auslastung der Serverressourcen vor und nach der Optimierung f√ºr einen Zeitraum von 1 Woche verglichen.  Was passiert ist, ist in Abbildung 2 dargestellt: <br><br><img src="https://habrastorage.org/webt/aj/ab/bw/ajabbwgggnspsugwgwwooscwgta.png"><br>  <i>Abb.</i>  <i>4. √Ñnderung der CPU-Auslastung nach Optimierung der VM-Zuordnung</i> <br><br>  Laut CPU-Auslastung: Die durchschnittliche CPU-Auslastung ist von 10% auf nur 18% gestiegen.  Das hei√üt,  Wir haben eine dreifache Marge der CPU-Leistung, w√§hrend die Server in der sogenannten "gr√ºnen" Zone bleiben. <br><br><h3>  Wie wurde das in Software gemacht? </h3><br>  Wir erfassen die ben√∂tigten Metriken in Yandex.ClickHouse (wir haben InfluxDB ausprobiert, aber bei unseren Datenmengen werden Abfragen mit Aggregation zu langsam ausgef√ºhrt) mit einer H√§ufigkeit von 30 Sekunden.  Von dort liest die Aufgabe der Berechnung des optimalen Zustands die Metriken, berechnet den maximalen Verbrauch daraus und generiert eine Berechnungsaufgabe, die in die Warteschlange gestellt wird.  Sobald die Berechnungsaufgabe abgeschlossen ist, werden Tests ausgef√ºhrt, um sicherzustellen, dass das Ergebnis die angegebenen Grenzwerte nicht √ºberschreitet. <br><br><h3>  Hat das schon jemand gemacht? </h3><br>  Nach den uns bekannten Algorithmen befinden sich √§hnliche Algorithmen in VMware vSphere und Nutanix und erscheinen in OpenStack (OpenStack Watcher-Projekt). <br><br><h3>  Kann man es noch besser machen? </h3><br>  Ja, das kannst du.  Im n√§chsten Artikel werde ich Ihnen erkl√§ren, wie Sie virtuelle Maschinen noch dichter packen k√∂nnen, ohne die SLA zu verletzen, und warum daf√ºr Neuronen ben√∂tigt werden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de416391/">https://habr.com/ru/post/de416391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de416377/index.html">Wir werden zu Assistenten in der Programmierung. Teil 1</a></li>
<li><a href="../de416379/index.html">Neurobugurt. Wie wir dem neuronalen Netzwerk beigebracht haben, Meme ein Jahr fr√ºher als Stanford zu erfinden</a></li>
<li><a href="../de416381/index.html">Bericht des Club of Rome 2018, Kapitel 3.13: Philanthropie, Investition, Crowdsourcing und Blockchain</a></li>
<li><a href="../de416385/index.html">Wenn die Korrelation zu 100% herauskommt, hat sich irgendwo ein Fehler eingeschlichen: die Praktikumserfahrung bei der Rambler Group</a></li>
<li><a href="../de416387/index.html">Shrimp: Skalieren und teilen Sie HTTP-Bilder in modernem C ++ mit ImageMagic ++, SObjectizer und RESTinio</a></li>
<li><a href="../de416393/index.html">IIDF-Konferenz: Unternehmen sind nicht gegen Startups</a></li>
<li><a href="../de416397/index.html">Wir automatisieren UI-Tests von Android-Anwendungen mithilfe des Seitenobjektmusters</a></li>
<li><a href="../de416399/index.html">Wie wir Bewertungen von mobilen Apps mithilfe von maschinellem Lernen analysiert haben</a></li>
<li><a href="../de416401/index.html">Blender: 3D-Modell eines Chips zur Verbindung mit der KiCad-Bibliothek</a></li>
<li><a href="../de416403/index.html">Fintech Digest: Angriff auf die PIR Bank, den Federal Tax Service und Steuern von der √úbertragung von Karte zu Karte sowie einige Blockchain- und Kryptow√§hrungen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>