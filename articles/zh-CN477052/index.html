<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¸ğŸ¾ ğŸ§šğŸ» ğŸŒ³ ä¸€ä¸ªç®€å•ç¤ºä¾‹çš„Reactorï¼ŒWebFluxï¼ŒKotlinåç¨‹æˆ–å¼‚æ­¥ â¤´ï¸ ğŸ¤¸ğŸ¿ ğŸ—’ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨ç°ä»£ä¸–ç•Œä¸­ï¼Œè®¸å¤šæœåŠ¡å¤§éƒ¨åˆ†éƒ½â€œæ— æ‰€ä½œä¸ºâ€ã€‚ ä»–ä»¬çš„ä»»åŠ¡å‡å°‘ä¸ºå¯¹å…¶ä»–æ•°æ®åº“/æœåŠ¡/ç¼“å­˜çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®å„ç§è§„åˆ™å’Œå„ç§ä¸šåŠ¡é€»è¾‘æ±‡æ€»æ‰€æœ‰è¿™äº›æ•°æ®ã€‚ å› æ­¤ï¼Œå‡ºç°è¯¸å¦‚Golangä¹‹ç±»çš„è¯­è¨€ï¼Œå¹¶å…·æœ‰æ–¹ä¾¿çš„å†…ç½®ç«äº‰ç³»ç»Ÿä½¿ç»„ç»‡éé˜»å¡ä»£ç å˜å¾—å®¹æ˜“ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚ 


 åœ¨JVMä¸–ç•Œä¸­ï¼Œäº‹æƒ…è¦å¤æ‚ä¸€äº›ã€‚ æœ‰å¤§é‡çš„æ¡†æ¶...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸€ä¸ªç®€å•ç¤ºä¾‹çš„Reactorï¼ŒWebFluxï¼ŒKotlinåç¨‹æˆ–å¼‚æ­¥</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/477052/"><img src="https://habrastorage.org/webt/oc/vm/jy/ocvmjybd42pjwnaqjaxeyz_dxlo.png"><br><br><p> åœ¨ç°ä»£ä¸–ç•Œä¸­ï¼Œè®¸å¤šæœåŠ¡å¤§éƒ¨åˆ†éƒ½â€œæ— æ‰€ä½œä¸ºâ€ã€‚ ä»–ä»¬çš„ä»»åŠ¡å‡å°‘ä¸ºå¯¹å…¶ä»–æ•°æ®åº“/æœåŠ¡/ç¼“å­˜çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®å„ç§è§„åˆ™å’Œå„ç§ä¸šåŠ¡é€»è¾‘æ±‡æ€»æ‰€æœ‰è¿™äº›æ•°æ®ã€‚ å› æ­¤ï¼Œå‡ºç°è¯¸å¦‚Golangä¹‹ç±»çš„è¯­è¨€ï¼Œå¹¶å…·æœ‰æ–¹ä¾¿çš„å†…ç½®ç«äº‰ç³»ç»Ÿä½¿ç»„ç»‡éé˜»å¡ä»£ç å˜å¾—å®¹æ˜“ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚ </p><br><p> åœ¨JVMä¸–ç•Œä¸­ï¼Œäº‹æƒ…è¦å¤æ‚ä¸€äº›ã€‚ æœ‰å¤§é‡çš„æ¡†æ¶å’Œåº“åœ¨ä½¿ç”¨æ—¶ä¼šé˜»å¡çº¿ç¨‹ã€‚ å› æ­¤ï¼Œstdlibæœ¬èº«æœ‰æ—¶å¯ä»¥åšåŒæ ·çš„äº‹æƒ…ã€‚ è€Œä¸”åœ¨Javaä¸­ï¼Œæ²¡æœ‰ç±»ä¼¼äºGolangä¸­çš„goroutinesçš„ç±»ä¼¼æœºåˆ¶ã€‚ </p><br><p> ä½†æ˜¯ï¼ŒJVMæ­£åœ¨ç§¯æå¼€å‘ï¼Œå¹¶ä¸”å‡ºç°äº†è®¸å¤šæœ‰è¶£çš„æœºä¼šã€‚ æœ‰å¸¦æœ‰åç¨‹çš„Kotlinï¼Œå®ƒä»¬çš„ç”¨æ³•ä¸Gorang goroutineséå¸¸ç›¸ä¼¼ï¼ˆå°½ç®¡å®ƒä»¬ä»¥å®Œå…¨ä¸åŒçš„æ–¹å¼å®ç°ï¼‰ã€‚ æœ‰JEP Loomï¼Œå®ƒå°†åœ¨å°†æ¥å°†çº¤ç»´å¼•å…¥JVMã€‚ æœ€å—æ¬¢è¿çš„Webæ¡†æ¶ä¹‹ä¸€-Springæœ€è¿‘å¢åŠ äº†åœ¨Webfluxä¸Šåˆ›å»ºå®Œå…¨éé˜»å¡æœåŠ¡çš„åŠŸèƒ½ã€‚ å€ŸåŠ©æœ€è¿‘å‘å¸ƒçš„Spring boot 2.2ï¼Œä¸Kotlinçš„é›†æˆç”šè‡³æ›´å¥½ã€‚ </p><br><p> æˆ‘å»ºè®®ä»¥ä¸€ä¸ªç”¨äºå°†é’±ä»ä¸€å¼ å¡è½¬ç§»åˆ°å¦ä¸€å¼ å¡çš„å°å‹æœåŠ¡çš„ç¤ºä¾‹ä¸ºä¾‹ï¼Œåœ¨Spring boot 2.2å’ŒKotlinä¸Šç¼–å†™ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä»¥ä¸å¤šä¸ªå¤–éƒ¨æœåŠ¡é›†æˆã€‚ </p><a name="habracut"></a><br><p> å¦‚æœæ‚¨å·²ç»ç†Ÿæ‚‰Javaï¼ŒKotlinï¼ŒGradleï¼ŒSpringï¼ŒSpring boot 2ï¼ŒReactorï¼Œ <s>Webfluxï¼ŒTomcatï¼ŒNettyï¼ŒKotlinoroutinesï¼ŒGradle Kotlin DSLç”šè‡³æ‹¥æœ‰åšå£«å­¦ä½ï¼Œé‚£å°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</s> ä½†æ˜¯ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£æ²¡å…³ç³»ã€‚ è¯¥ä»£ç å°†å¾—åˆ°æœ€å¤§ç¨‹åº¦çš„ç®€åŒ–ï¼Œå³ä½¿æ‚¨ä¸æ˜¯æ¥è‡ªJVMä¸–ç•Œï¼Œä¹Ÿå¸Œæœ›æ‚¨èƒ½ç†è§£æ‰€æœ‰å†…å®¹ã€‚ </p><br><p> å¦‚æœæ‚¨æ‰“ç®—è‡ªå·±ç¼–å†™æœåŠ¡ï¼Œè¯·ç¡®ä¿å·²å®‰è£…æ‰€éœ€çš„ä¸€åˆ‡ï¼š </p><br><ul><li>  Java 8+ </li><li>  Dockerå’ŒDocker Compose; </li><li>  cURLï¼Œæœ€å¥½æ˜¯<a href="https://stedolan.github.io/jq/download/">jq</a> ï¼› </li><li> å‰ç‰¹ </li><li> æœ€å¥½æ˜¯Kotlinçš„IDEï¼ˆIntellij Ideaï¼ŒEclipseï¼ŒVSï¼Œ <s>vim</s>ç­‰ï¼‰ã€‚ ä½†æ˜¯åœ¨ç¬”è®°æœ¬ç”µè„‘ä¸Šä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ </li></ul><br><p> ç¤ºä¾‹å°†åŒ…å«æœåŠ¡ä¸­å®ç°çš„ç©ºç™½å’Œå·²ç¼–å†™çš„å®ç°ã€‚ é¦–å…ˆï¼Œè¿è¡Œå®‰è£…å’Œç»„è£…ï¼Œå¹¶ä»”ç»†æŸ¥çœ‹æœåŠ¡åŠå…¶APIã€‚ </p><br><blockquote>æœåŠ¡å’ŒAPIæœ¬èº«çš„ç¤ºä¾‹ä»…ç”¨äºè¯´æ˜ç›®çš„ï¼›è¯·å‹¿å°†æ‰€æœ‰<code>AS IS</code>è½¬ç§»åˆ°æ‚¨çš„äº§å“ä¸Šï¼ </blockquote><p> é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„æœåŠ¡å…‹éš†å­˜å‚¨åº“ï¼Œå¹¶è¿›è¡Œé›†æˆï¼Œç„¶åè½¬åˆ°ç›®å½•ï¼š </p><br><pre> <code class="plaintext hljs">git clone https://github.com/evgzakharov/spring-demo-services &amp;&amp; cd spring-demo-services</code> </pre> <br><p> åœ¨å•ç‹¬çš„ç»ˆç«¯ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>gradle</code>æ”¶é›†æ‰€æœ‰åº”ç”¨ç¨‹åºï¼Œåœ¨æ„å»ºæˆåŠŸä¹‹åï¼Œæ‰€æœ‰æœåŠ¡å°†ä½¿ç”¨<code>gradle</code> <code>docker-compose</code>å¯åŠ¨ã€‚ </p><br><pre> <code class="plaintext hljs">./gradlew build &amp;&amp; docker-compose up</code> </pre> <br><p> åœ¨ä¸‹è½½å¹¶å®‰è£…æ‰€æœ‰å†…å®¹åï¼Œè¯·è€ƒè™‘ä¸€ä¸ªåŒ…å«æœåŠ¡çš„é¡¹ç›®ã€‚ </p><br><img src="https://habrastorage.org/webt/go/mp/mb/gompmbrgtjwsuz9pnpbaxbuksg8.png"><br><p> æœåŠ¡å…¥å£ï¼ˆæ¼”ç¤ºæœåŠ¡ï¼‰å°†æ”¶åˆ°å¸¦æœ‰ä»¤ç‰Œï¼Œè½¬è´¦å¡å·å’Œå¡é—´è½¬è´¦é‡‘é¢çš„è¯·æ±‚ï¼š </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"authToken"</span></span>: <span class="hljs-string"><span class="hljs-string">"auth-token1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cardFrom"</span></span>: <span class="hljs-string"><span class="hljs-string">"55593478"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cardTo"</span></span>: <span class="hljs-string"><span class="hljs-string">"55592020"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"amount"</span></span>: <span class="hljs-string"><span class="hljs-string">"10.1"</span></span> }</code> </pre> <br><p> æ ¹æ®<code>authToken</code>ä»¤ç‰Œï¼Œ <code>authToken</code>éœ€è¦è½¬åˆ°<code>AUTH</code>æœåŠ¡å¹¶è·å–<code>userId</code> ï¼Œç„¶åå¯ä»¥ä½¿ç”¨å®ƒå‘<code>USER</code>å‘å‡ºè¯·æ±‚å¹¶æå–æœ‰å…³è¯¥ç”¨æˆ·çš„æ‰€æœ‰å…¶ä»–ä¿¡æ¯ã€‚  <code>AUTH</code>è¿˜å°†è¿”å›æœ‰å…³æˆ‘ä»¬å¯ä»¥è®¿é—®è¿™ä¸‰ä¸ªæœåŠ¡ä¸­çš„å“ªä¸€ä¸ªçš„ä¿¡æ¯ã€‚ æ¥è‡ª<code>AUTH</code>ç¤ºä¾‹å“åº”ï¼š </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"userId"</span></span>: <span class="hljs-number"><span class="hljs-number">158</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cardAccess"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"paymentAccess"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"userAccess"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><p> è¦åœ¨å¡ä¹‹é—´è¿›è¡Œè½¬ç§»ï¼Œè¯·é¦–å…ˆä½¿ç”¨å¡ä¸­çš„æ¯ä¸ª<code>CARD</code> ã€‚ å“åº”è¯·æ±‚ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°<code>cardId</code> ï¼Œç„¶åä¸ä»–ä»¬ä¸€èµ·å‘<code>PAYMENT</code>å‘é€è¯·æ±‚å¹¶è¿›è¡Œè½¬å¸ã€‚ æœ€å-æˆ‘ä»¬å†æ¬¡ä½¿ç”¨<code>fromCardId</code>å‘<code>PAYMENT</code>å‘é€è¯·æ±‚ï¼Œå¹¶æ‰¾å‡ºå½“å‰ä½™é¢ã€‚ </p><br><p> ä¸ºäº†æ¨¡æ‹Ÿè¾ƒå°çš„æœåŠ¡å»¶è¿Ÿï¼Œå°†TIMEOUTç¯å¢ƒå˜é‡çš„å€¼å¼•å‘åˆ°æ‰€æœ‰å®¹å™¨ä¸­ï¼Œå…¶ä¸­å°†å“åº”å»¶è¿Ÿè®¾ç½®ä¸ºæ¯«ç§’ã€‚ ä¸ºäº†ä½¿æ¥è‡ª<code>AUTH</code>çš„å“åº”å¤šæ ·åŒ–ï¼Œå¯ä»¥æ›´æ”¹<code>SUCCESS_RATE</code>çš„å€¼ï¼Œè¯¥å€¼æ§åˆ¶å¯¹æœåŠ¡è¿›è¡Œ<code>true</code>å“åº”çš„å¯èƒ½æ€§ã€‚ </p><br><p>  Docker-compose.yamlæ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">version: '3' services: service-auth: build: service-auth image: service-auth:1.0.0 environment: - SUCCESS_RATE=1.0 - TIMEOUT=100 ports: - "8081:8080" service-card: build: service-card image: service-card:1.0.0 environment: - TIMEOUT=100 ports: - "8082:8080" service-payment: build: service-payment image: service-payment:1.0.0 environment: - TIMEOUT=100 ports: - "8083:8080" service-user: build: service-user image: service-user:1.0.0 environment: - TIMEOUT=100 ports: - "8084:8080"</code> </pre> <br><p> å¯¹äºæ‰€æœ‰æœåŠ¡ï¼Œéƒ½å®Œæˆäº†ä»8081åˆ°8084çš„ç«¯å£è½¬å‘ï¼Œå¯ä»¥è½»æ¾ç›´æ¥åˆ°è¾¾å®ƒä»¬ã€‚ </p><br><p> è®©æˆ‘ä»¬ç»§ç»­ç¼–å†™<code>Demo service</code> ã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°è¯•å°†å®ç°ç¼–å†™å¾—å°½å¯èƒ½ç¬¨æ‹™ï¼Œä¸è¦å‡ºç°å¼‚æ­¥å’Œå¹¶å‘ã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨Spring boot 2.2.1ï¼ŒKotlinå’Œä¸€ä¸ªç©ºç™½çš„æœåŠ¡ã€‚ æˆ‘ä»¬å…‹éš†å­˜å‚¨åº“ï¼Œç„¶åè½¬åˆ°<code>spring-mvc-start</code>åˆ†æ”¯ï¼š </p><br><pre> <code class="plaintext hljs">git clone https://github.com/evgzakharov/demo-service &amp;&amp; cd demo-service &amp;&amp; git checkout spring-mvc-start</code> </pre> <br><p> è½¬åˆ°<code>demo.Controller</code>æ–‡ä»¶ã€‚ å®ƒå…·æœ‰å¿…é¡»ä¸ºå…¶ç¼–å†™å®ç°çš„å”¯ä¸€ç©ºçš„<code>processRequest</code>æ–¹æ³•ã€‚ </p><br><pre> <code class="kotlin hljs"> <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Response { .. }</code> </pre> <br><p> è¯¥æ–¹æ³•çš„å…¥å£å¤„å°†æ”¶åˆ°å¡ä¹‹é—´çš„è½¬ç§»è¯·æ±‚ã€‚ </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceRequest</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authToken: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardFrom: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardTo: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> amount: BigDecimal )</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰Springçš„äºº</b> <div class="spoiler_text"><p>  Springæœ‰ä¸€ä¸ªåŸºäºæ³¨é‡Šçš„å†…ç½®DIã€‚  DemoControllerå¸¦æœ‰ç‰¹æ®Šçš„<code>RestController</code>æ³¨é‡Šï¼šé™¤äº†åœ¨DIä¸­æ³¨å†ŒBeanä¹‹å¤–ï¼Œå®ƒè¿˜æ·»åŠ äº†å…¶ä½œä¸ºæ§åˆ¶å™¨çš„å¤„ç†ã€‚  PostProcessoræŸ¥æ‰¾æ ‡è®°æœ‰<code>PostMapping</code>æ³¨é‡Šçš„æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨<code>POST</code>æ–¹æ³•å°†å®ƒä»¬æ·»åŠ ä¸ºæœåŠ¡çš„ç«¯ç‚¹ã€‚ </p><br><p> å¤„ç†ç¨‹åºè¿˜ä¸ºDemoControlleråˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œå…¶ä¸­æ‰€æœ‰å¿…éœ€çš„å‚æ•°éƒ½ä¼ é€’ç»™<code>processRequest</code>æ–¹æ³•ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå¸¦æœ‰<code>@RequestBody</code>æ‰¹æ³¨çš„å‚æ•°ã€‚ å› æ­¤ï¼Œåœ¨ä»£ç†ä¸­ï¼Œå°†ä½¿ç”¨ååºåˆ—åŒ–åˆ°<code>ServiceRequest</code>ç±»ä¸­çš„JSONå†…å®¹æ¥è°ƒç”¨æ­¤æ–¹æ³•ã€‚ </p></div></div><br><p> ä¸ºäº†ç®€åŒ–ï¼Œå·²ç»å®Œæˆäº†ä¸å…¶ä»–æœåŠ¡é›†æˆçš„æ‰€æœ‰æ–¹æ³•ï¼Œæ‚¨åªéœ€è¦æ­£ç¡®è¿æ¥å®ƒä»¬å³å¯ã€‚ åªæœ‰äº”ç§æ–¹æ³•ï¼Œæ¯ä¸ªåŠ¨ä½œä¸€ä¸ªã€‚ å¯¹å…¶ä»–æœåŠ¡æœ¬èº«çš„è°ƒç”¨æ˜¯åœ¨Spring <code>RestTemplate</code> <strong>é˜»å¡</strong>è°ƒç”¨ä¸Šå®ç°çš„ã€‚ </p><br><p> è°ƒç”¨<code>AUTH</code>ç¤ºä¾‹æ–¹æ³•ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: AuthInfo { log.info(<span class="hljs-string"><span class="hljs-string">"getAuthInfo"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> restTemplate.getForEntity(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${demoConfig.auth}</span></span></span><span class="hljs-string">/{token}"</span></span>, AuthInfo::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">token) .body ?: throw RuntimeException</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"couldn't find user by token='</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$token</span></span></span><span class="hljs-string">'"</span></span>) }</code> </pre> <br><p> è®©æˆ‘ä»¬ç»§ç»­è¯¥æ–¹æ³•çš„å®ç°ã€‚ æ³¨é‡Šè¯´æ˜äº†è¯¥è¿‡ç¨‹ä»¥åŠåœ¨è¾“å‡ºä¸­æœŸæœ›å¾—åˆ°ä»€ä¹ˆå“åº”ï¼š </p><br><pre> <code class="kotlin hljs"> <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Response { <span class="hljs-comment"><span class="hljs-comment">//1) get auth info from service by token -&gt; userId //2) find user info by userId from 1. //3) 4) find cards info for each card in serviceRequest // 5) make transaction for known cards by calling sendMoney(id1, id2, amount) // 6) after payment get payment info by fromCardId TODO("return SuccessResponse") // SuccessResponse( // amount = , // userName = , // userSurname = , // userAge = // ) }</span></span></code> </pre> <br><p> é¦–å…ˆï¼Œæˆ‘ä»¬å°½å¯èƒ½ç®€å•åœ°å®ç°è¯¥æ–¹æ³•ï¼Œè€Œä¸è€ƒè™‘<code>AUTH</code>å¯ä»¥æ‹’ç»æˆ‘ä»¬è®¿é—®å…¶ä»–æœåŠ¡ã€‚ å°è¯•è‡ªå·±åšã€‚ äº‹å®è¯æ˜ï¼ˆæˆ–åˆ‡æ¢åˆ°<code>spring-mvc</code>åˆ†æ”¯åï¼‰ï¼Œæ‚¨å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼æ£€æŸ¥æœåŠ¡çš„è¿è¡Œæƒ…å†µï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä»spring-mvcåˆ†æ”¯å®ç°</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Response { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authInfo = getAuthInfo(serviceRequest.authToken) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userInfo = findUser(authInfo.userId) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardFromInfo = findCardInfo(serviceRequest.cardFrom) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardToInfo = findCardInfo(serviceRequest.cardTo) sendMoney(cardFromInfo.cardId, cardToInfo.cardId, serviceRequest.amount) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> paymentInfo = getPaymentInfo(cardFromInfo.cardId) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SuccessResponse( amount = paymentInfo.currentAmount, userName = userInfo.name, userSurname = userInfo.surname, userAge = userInfo.age ) }</code> </pre> </div></div><br><p> å¯åŠ¨æœåŠ¡ï¼ˆä»demo-serviceæ–‡ä»¶å¤¹ä¸­ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">./gradlew bootRun</code> </pre> <br><p> æˆ‘ä»¬å‘ç«¯ç‚¹å‘é€è¯·æ±‚ï¼š </p><br><pre> <code class="plaintext hljs">./demo-request.sh</code> </pre> <br><p> ä½œä¸ºå“åº”ï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š </p><br><pre> <code class="plaintext hljs">âœ demo-service git:(spring-mvc) âœ— ./demo-request.sh + curl -XPOST http://localhost:8080/ -d @demo-payment-request.json -H 'Content-Type: application/json; charset=UTF-8' + jq . % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 182 0 85 100 97 20 23 0:00:04 0:00:04 --:--:-- 23 { "amount": 989.9, "userName": "Vasia", "userSurname": "Pupkin", "userAge": 18, "status": true }</code> </pre> <br><p> ä¸ºäº†å®æ–½è¯¥æœåŠ¡ï¼Œæ€»å…±éœ€è¦å‘å‡º6ä¸ªè¯·æ±‚ã€‚ è€ƒè™‘åˆ°æ¯ä¸ªå“åº”çš„å»¶è¿Ÿä¸º100 msï¼Œæ€»æ—¶é—´ä¸èƒ½å°‘äº600 msã€‚ å®é™…ä¸Šï¼Œè€ƒè™‘åˆ°æ‰€æœ‰å¼€é”€ï¼Œç»“æœçº¦ä¸º700æ¯«ç§’ã€‚ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»£ç éå¸¸ç®€å•ï¼Œå¦‚æœæˆ‘ä»¬ç°åœ¨æƒ³æ·»åŠ <code>AUTH</code>å“åº”æ£€æŸ¥ä»¥è®¿é—®å…¶ä»–æœåŠ¡ï¼Œè¿™å°†ä¸éš¾åšåˆ°ï¼ˆå°±åƒå…¶ä»–ä»»ä½•é‡æ„ä¸€æ ·ï¼‰ã€‚ </p><br><p> ä½†æ˜¯ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¦‚ä½•åŠ å¿«æŸ¥è¯¢æ‰§è¡Œé€Ÿåº¦ã€‚ å¦‚æœæ‚¨ä¸è€ƒè™‘å¯¹<code>AUTH</code>å“åº”çš„éªŒè¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„ä»»åŠ¡ï¼š </p><br><ul><li> è·å–<code>userId</code>å¹¶å‘<code>USER</code>è¯·æ±‚æ•°æ®ï¼› </li><li> æ¥æ”¶æ¯å¼ å¡çš„<code>cardId</code> ï¼Œè¿›è¡Œä»˜æ¬¾å¹¶æ¥æ”¶æ€»é‡‘é¢ã€‚ </li></ul><br><p> è¿™äº›ä»»åŠ¡å¯ä»¥å½¼æ­¤ç‹¬ç«‹åœ°æ‰§è¡Œã€‚ ç„¶åï¼Œæ€»çš„æ‰§è¡Œæ—¶é—´å°†å–å†³äºæœ€é•¿çš„è°ƒç”¨é“¾ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºç¬¬äºŒä¸ªï¼‰ï¼Œæ€»å…±å°†æ‰§è¡Œ300 ms + X msçš„å¼€é”€ã€‚ </p><br><p> é‰´äºè°ƒç”¨æœ¬èº«æ˜¯é˜»å¡çš„ï¼Œæ‰§è¡Œå¹¶è¡Œè¯·æ±‚çš„å”¯ä¸€æ–¹æ³•æ˜¯åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œå®ƒä»¬ã€‚ æ‚¨å¯ä»¥ä¸ºæ¯ä¸ªè°ƒç”¨åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œä½†è¿™å°†éå¸¸æ˜‚è´µã€‚ å¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨ThreadPoolä¸Šè¿è¡Œä»»åŠ¡ã€‚ ä¹ä¸€çœ‹ï¼Œè¿™æ ·çš„è§£å†³æ–¹æ¡ˆçœ‹èµ·æ¥å¾ˆåˆé€‚ï¼Œè€Œä¸”æ—¶é—´ä¼šçœŸæ­£å‡å°‘ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨CompletableFutureä¸Šæ‰§è¡ŒæŸ¥è¯¢ã€‚ å®ƒå…è®¸æ‚¨é€šè¿‡ä½¿ç”¨<code>async</code>åç¼€è°ƒç”¨æ–¹æ³•æ¥è¿è¡Œåå°ä»»åŠ¡ã€‚ å¹¶ä¸”ï¼Œå¦‚æœåœ¨è°ƒç”¨æ–¹æ³•æ—¶æœªæŒ‡å®šç‰¹å®šçš„ThreadPoolï¼Œåˆ™å°†åœ¨<code>ForkJoinPool.commonPool()</code>ä¸Šå¯åŠ¨ä»»åŠ¡ã€‚ å°è¯•è‡ªå·±ç¼–å†™ä¸€ä¸ªå®ç°ï¼Œæˆ–è€…è½¬åˆ°<code>spring-mvc-async</code>åˆ†æ”¯ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ä»spring-mvc-asyncåˆ†æ”¯å®ç°</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Response { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authInfoFuture = CompletableFuture.supplyAsync { getAuthInfo(serviceRequest.authToken) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userInfoFuture = authInfoFuture.thenApplyAsync { findUser(it.userId) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardFromInfo = CompletableFuture.supplyAsync { findCardInfo(serviceRequest.cardFrom) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardToInfo = CompletableFuture.supplyAsync { findCardInfo(serviceRequest.cardTo) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> waitAll = CompletableFuture.allOf(cardFromInfo, cardToInfo) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> paymentInfoFuture = waitAll .thenApplyAsync { sendMoney(cardFromInfo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().cardId, cardToInfo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().cardId, serviceRequest.amount) } .thenApplyAsync { getPaymentInfo(cardFromInfo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().cardId) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> paymentInfo = paymentInfoFuture.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userInfo = userInfoFuture.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() log.info(<span class="hljs-string"><span class="hljs-string">"result"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SuccessResponse( amount = paymentInfo.currentAmount, userName = userInfo.name, userSurname = userInfo.surname, userAge = userInfo.age ) }</code> </pre> </div></div><br><p> å¦‚æœç°åœ¨æµ‹é‡è¯·æ±‚æ—¶é—´ï¼Œåˆ™è¯¥æ—¶é—´å°†åœ¨360æ¯«ç§’å·¦å³ã€‚ ä¸åŸå§‹ç‰ˆæœ¬ç›¸æ¯”ï¼Œæ€»æ—¶é—´å‡å°‘äº†å°†è¿‘2å€ã€‚ ä»£ç æœ¬èº«å·²ç»å˜å¾—æœ‰äº›å¤æ‚ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå¯¹å…¶è¿›è¡Œä¿®æ”¹ä»ç„¶ä¸éš¾ã€‚ å¦‚æœåœ¨è¿™é‡Œæˆ‘ä»¬è¦æ·»åŠ æ¥è‡ª<code>AUTH</code>çš„å“åº”æ£€æŸ¥ï¼Œé‚£ä¹ˆè¿™å¹¶ä¸å›°éš¾ã€‚ </p><br><p> ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¯¹æœåŠ¡æœ¬èº«æœ‰å¤§é‡ä¼ å…¥è¯·æ±‚æ€ä¹ˆåŠï¼Ÿ è¯´å¤§çº¦1000ä¸ªå¹¶å‘è¯·æ±‚ï¼Ÿ é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå¾ˆå¿«å°±ä¼šå‘ç°æ‰€æœ‰ThreadPoolçº¿ç¨‹éƒ½åœ¨å¿™äºè¿›è¡Œé˜»å¡è°ƒç”¨ã€‚ æˆ‘ä»¬å¾—å‡ºçš„ç»“è®ºæ˜¯å½“å‰ç‰ˆæœ¬ä¹Ÿä¸é€‚åˆã€‚ </p><br><p> å‰©ä¸‹çš„äº‹æƒ…ä»…ä»…æ˜¯å¯¹æœåŠ¡æœ¬èº«è¿›è¡Œä¸€äº›å¤„ç†ã€‚ æ‚¨å¯ä»¥ä¿®æ”¹æŸ¥è¯¢å¹¶ä½¿å®ƒä»¬æˆä¸ºéé˜»å¡ã€‚ ç„¶åï¼Œè°ƒç”¨æœåŠ¡çš„æ–¹æ³•å°†è¿”å›CompletableFutureï¼ŒFluxï¼ŒObservableï¼ŒDeferredï¼ŒPromiseæˆ–åœ¨å…¶ä¸Šæ„å»ºæœŸæœ›é“¾çš„ç±»ä¼¼å¯¹è±¡ã€‚ ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨å•ç‹¬çš„æµä¸Šè¿›è¡Œè°ƒç”¨-æ‹¥æœ‰ä¸€ä¸ªæˆ‘ä»¬å·²ç»å€Ÿæ¥çš„ç”¨äºå¤„ç†è¯·æ±‚çš„ï¼ˆæˆ–è‡³å°‘ä¸€ä¸ªå°çš„å•ç‹¬çš„æµæ± ï¼‰å°±è¶³å¤Ÿäº†ã€‚ </p><br><p> æˆ‘ä»¬ç°åœ¨å¯ä»¥æ‰¿å—æœåŠ¡çš„æ²‰é‡è´Ÿæ‹…å—ï¼Ÿ è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œè¯·ä»”ç»†é˜…è¯»Tomcatï¼Œå®ƒåœ¨å¯åŠ¨ç¨‹åº<code>org.springframework.boot:spring-boot-starter-web</code>ä¸­çš„Spring boot 2.2.1ä¸­ä½¿ç”¨ã€‚ å®ƒè¢«æ„å»ºä¸ºå°†ThreadPoolä¸­çš„çº¿ç¨‹åˆ†é…ç»™æ¯ä¸ªä¼ å…¥è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚ åœ¨æ²¡æœ‰è‡ªç”±æµé€šçš„æƒ…å†µä¸‹ï¼Œæ–°çš„è¯·æ±‚å°†æˆä¸ºç­‰å¾…çš„â€œé˜Ÿåˆ—â€ã€‚ ä½†æ˜¯æˆ‘ä»¬çš„æœåŠ¡æœ¬èº«ä»…å‘å…¶ä»–æœåŠ¡å‘é€è¯·æ±‚ã€‚ åˆ†é…ä¸€ä¸ªå®Œæ•´çš„æµï¼Œå¹¶é˜»å¡å®ƒï¼Œç›´åˆ°æ¯ä¸ªäººçš„ç­”æ¡ˆéƒ½å‡ºç°ä¸ºæ­¢ï¼Œçœ‹ä¸Šå»ï¼Œè¿™æ˜¯å¤šä½™çš„ã€‚ </p><br><p> å¹¸è¿çš„æ˜¯ï¼ŒSpringæœ€è¿‘ä½¿ä½¿ç”¨åŸºäºNettyæˆ–Undertowçš„éé˜»å¡WebæœåŠ¡å™¨æˆä¸ºå¯èƒ½ã€‚ ä¸ºæ­¤ï¼Œæ‚¨åªéœ€è¦å°†<code>spring-boot-starter-web</code>æ›´æ”¹ä¸º<code>spring-boot-starter-webflux</code>å¹¶ç•¥å¾®æ›´æ”¹å¤„ç†è¯·æ±‚çš„æ–¹æ³•ï¼Œå³å¯åœ¨Monoä¸­â€œåŒ…è£…â€è¯·æ±‚å’Œå“åº”ã€‚ è¿™æ˜¯ç”±äºWebfluxæ˜¯åŸºäºReactoræ„å»ºçš„ï¼Œå› æ­¤ç°åœ¨æ‚¨éœ€è¦ä½¿ç”¨è¯¥æ–¹æ³•æ¥æ„å»ºMonoè½¬æ¢é“¾ã€‚ <br></p><p> å°è¯•ç¼–å†™è‡ªå·±çš„æ–¹æ³•çš„éé˜»å¡å®ç°ã€‚ ä¸ºæ­¤ï¼Œè¯·è½¬åˆ°<code>spring-webflux-start</code>åˆ†æ”¯ã€‚ è¯·æ³¨æ„ï¼ŒSpring Bootçš„å¯åŠ¨ç¨‹åºå·²æ›´æ”¹ï¼Œç°åœ¨ä½¿ç”¨å¸¦æœ‰Webfluxçš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯¹å·²é‡å†™ä¸ºä½¿ç”¨éé˜»å¡<code>WebClient</code>å…¶ä»–æœåŠ¡çš„è¯·æ±‚çš„å®ç°ä¹Ÿå·²æ›´æ”¹ã€‚ </p><br><p> è°ƒç”¨AUTHçš„ç¤ºä¾‹æ–¹æ³•ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Mono&lt;AuthInfo&gt; { log.info(<span class="hljs-string"><span class="hljs-string">"getAuthInfo"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WebClient.create().<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() .uri(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${demoConfig.auth}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$token</span></span></span><span class="hljs-string">"</span></span>) .retrieve() .bodyToMono(AuthInfo::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) }</span></span></code> </pre> <br><p> ç¬¬ä¸€ä¸ªç¤ºä¾‹çš„å®ç°åœ¨æ³¨é‡Šä¸­æ’å…¥åˆ°<code>processRequest</code>æ–¹æ³•çš„å†…å®¹ä¸­ã€‚ å°è¯•è‡ªå·±åœ¨Reactorä¸Šé‡å†™å®ƒã€‚ åƒä¸Šæ¬¡ä¸€æ ·ï¼Œé¦–å…ˆåˆ¶ä½œç‰ˆæœ¬è€Œä¸è€ƒè™‘<code>AUTH</code>çš„æ£€æŸ¥ï¼Œç„¶åæŸ¥çœ‹æ·»åŠ æ£€æŸ¥çš„éš¾åº¦ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Mono</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span>: Mono&lt;Response&gt; { <span class="hljs-comment"><span class="hljs-comment">// val authInfo = getAuthInfo(serviceRequest.authToken) // // val userInfo = findUser(authInfo.userId) // // val cardFromInfo = findCardInfo(serviceRequest.cardFrom) // val cardToInfo = findCardInfo(serviceRequest.cardTo) // // sendMoney(cardFromInfo.cardId, cardToInfo.cardId, serviceRequest.amount) // // val paymentInfo = getPaymentInfo(cardFromInfo.cardId) // // log.info("result") // // return SuccessResponse( // amount = paymentInfo.currentAmount, // userName = userInfo.name, // userSurname = userInfo.surname, // userAge = userInfo.age // ) TODO() }</span></span></code> </pre> <br><p> å¤„ç†<code>spring-webflux</code>ä¹‹åï¼Œæ‚¨å¯ä»¥ä»<code>spring-webflux</code>ä¸æˆ‘çš„å®ç°è¿›è¡Œæ¯”è¾ƒï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä»spring-webfluxåˆ†æ”¯å®ç°</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Mono</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span>: Mono&lt;Response&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cacheRequest = serviceRequest.cache() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userInfoMono = cacheRequest.flatMap { getAuthInfo(it.authToken) }.flatMap { findUser(it.userId) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardFromInfoMono = cacheRequest.flatMap { findCardInfo(it.cardFrom) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardToInfoMono = cacheRequest.flatMap { findCardInfo(it.cardTo) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> paymentInfoMono = cardFromInfoMono.zipWith(cardToInfoMono) .flatMap { (cardFromInfo, cardToInfo) -&gt; cacheRequest.flatMap { request -&gt; sendMoney(cardFromInfo.cardId, cardToInfo.cardId, request.amount).map { cardFromInfo } } }.flatMap { getPaymentInfo(it.cardId) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> userInfoMono.zipWith(paymentInfoMono) .map { (userInfo, paymentInfo) -&gt; log.info(<span class="hljs-string"><span class="hljs-string">"result"</span></span>) SuccessResponse( amount = paymentInfo.currentAmount, userName = userInfo.name, userSurname = userInfo.surname, userAge = userInfo.age ) } }</code> </pre> </div></div><br><p> åŒæ„ç°åœ¨ç¼–å†™å®ç°ï¼ˆä¸ä»¥å‰çš„é˜»æ­¢æ–¹æ³•ç›¸æ¯”ï¼‰å˜å¾—æ›´åŠ å›°éš¾ã€‚ è€Œä¸”ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä»<code>AUTH</code>æ·»åŠ â€œå¿˜è®°çš„â€æ”¯ç¥¨ï¼Œé‚£ä¹ˆè¿™å°†ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ã€‚ </p><br><p> è¿™æ˜¯ååº”æ€§æ–¹æ³•çš„æœ¬è´¨ã€‚ è¿™å¯¹äºæ„å»ºæ— åˆ†æ”¯çš„å¤„ç†é“¾éå¸¸æœ‰ç”¨ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå‡ºç°åˆ†æ”¯ï¼Œåˆ™ä»£ç ä¸å†é‚£ä¹ˆç®€å•ã€‚ </p><br><p>  Kotlinåç¨‹å¯¹äºä»»ä½•å¼‚æ­¥/ååº”å¼ä»£ç éƒ½éå¸¸å‹å¥½ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚ æ­¤å¤–ï¼Œ <a href="">Reactor</a> ï¼Œ <a href="https://github.com/Kotlin/kotlinx.coroutines/tree/master/integration/kotlinx-coroutines-jdk8">CompletableFuture</a>ç­‰è¿˜æœ‰å¤§é‡ä¹¦é¢åŒ…è£…ã€‚ ä½†æ˜¯ï¼Œå³ä½¿æ‰¾ä¸åˆ°åˆé€‚çš„å·¥å…·ï¼Œä¹Ÿå¯ä»¥éšæ—¶ä½¿ç”¨ç‰¹æ®Šçš„<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/suspend-cancellable-coroutine.html">æ„å»ºå™¨</a>è‡ªå·±ç¼–å†™ã€‚ </p><br><p> è®©æˆ‘ä»¬è‡ªå·±é‡å†™åç¨‹çš„å®ç°ã€‚ ä¸ºæ­¤ï¼Œè¯·è½¬åˆ°<code>spring-webflux-coroutines-start</code>åˆ†æ”¯ã€‚ å¿…éœ€çš„ä¾èµ–é¡¹å·²æ·»åŠ åˆ°build.gradle.ktsä¸­ï¼š </p><br><pre> <code class="kotlin hljs">implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$kotlinCoroutinesVersion</span></span></span><span class="hljs-string">"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-reactive:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$kotlinCoroutinesVersion</span></span></span><span class="hljs-string">"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-reactor:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$kotlinCoroutinesVersion</span></span></span><span class="hljs-string">"</span></span>)</code> </pre> <br><p> å¹¶ä¸”<code>processRequest</code>æ–¹æ³•æœ‰æ‰€å˜åŒ–ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Response = coroutineScope { <span class="hljs-comment"><span class="hljs-comment">//TODO() }</span></span></code> </pre> <br><p> å®ƒä¸å†éœ€è¦Monoå¹¶å¯ä»¥ç®€å•åœ°è½¬æ¢ä¸ºæš‚åœå‡½æ•°ï¼ˆç”±äºSpringå’ŒKotlinçš„é›†æˆï¼‰ã€‚ è€ƒè™‘åˆ°æˆ‘ä»¬å°†åœ¨è¯¥æ–¹æ³•ä¸­åˆ›å»ºå…¶ä»–åç¨‹ï¼Œæˆ‘ä»¬å°†éœ€è¦åˆ›å»ºä¸€ä¸ªå­ä¾¦å¯Ÿå‘˜<code>coroutineScope</code> ï¼ˆå‡ºäºå¯¹åˆ›å»ºé™„åŠ èŒƒå›´çš„åŸå› çš„ç†è§£ï¼Œè¯·å‚è§Roman Elizarovçš„æœ‰å…³<a href="https://medium.com/%40elizarov/structured-concurrency-722d765aa952">ç»“æ„åŒ–å¹¶å‘</a>çš„æ–‡ç« ï¼‰ã€‚ è¯·æ³¨æ„ï¼Œå…¶ä»–æœåŠ¡ç”µè¯å®Œå…¨æ²¡æœ‰æ”¹å˜ã€‚ å®ƒä»¬è¿”å›ç›¸åŒçš„Monoï¼Œå¯ä»¥åœ¨å…¶ä¸Šè°ƒç”¨awaitFirst <code>suspend</code>æ–¹æ³•ä»¥â€œç­‰å¾…â€æŸ¥è¯¢ç»“æœã€‚ </p><br><p> å¦‚æœåç¨‹å¯¹äºæ‚¨æ¥è¯´ä»ç„¶æ˜¯ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªå¾ˆå¥½çš„<a href="">æŒ‡å—</a> ï¼Œé‡Œé¢æœ‰è¯¦ç»†çš„è¯´æ˜ã€‚ å°è¯•ç¼–å†™æ‚¨è‡ªå·±çš„<code>processRequest</code>æ–¹æ³•å®ç°ï¼Œæˆ–è½¬åˆ°<code>spring-webflux-coroutines</code>åˆ†æ”¯ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä»spring-webflux-coroutinesåˆ†æ”¯å®ç°</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> serviceRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServiceRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Response = coroutineScope { log.info(<span class="hljs-string"><span class="hljs-string">"start"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userInfoDeferred = async { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authInfo = getAuthInfo(serviceRequest.authToken).awaitFirst() findUser(authInfo.userId).awaitFirst() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> paymentInfoDeferred = async { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardFromInfoDeferred = async { findCardInfo(serviceRequest.cardFrom).awaitFirst() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardToInfoDeferred = async { findCardInfo(serviceRequest.cardTo).awaitFirst() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardFromInfo = cardFromInfoDeferred.await() sendMoney(cardFromInfo.cardId, cardToInfoDeferred.await().cardId, serviceRequest.amount).awaitFirst() getPaymentInfo(cardFromInfo.cardId).awaitFirst() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userInfo = userInfoDeferred.await() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> paymentInfo = paymentInfoDeferred.await() log.info(<span class="hljs-string"><span class="hljs-string">"result"</span></span>) SuccessResponse( amount = paymentInfo.currentAmount, userName = userInfo.name, userSurname = userInfo.surname, userAge = userInfo.age ) }</code> </pre> </div></div><br><p> æ‚¨å¯ä»¥å°†ä»£ç ä¸ååº”æ€§æ–¹æ³•è¿›è¡Œæ¯”è¾ƒã€‚ ä½¿ç”¨åç¨‹ï¼Œæ‚¨ä¸å¿…äº‹å…ˆè€ƒè™‘æ‰€æœ‰åˆ†æ”¯ç‚¹ã€‚ æˆ‘ä»¬å¯ä»¥åªè°ƒç”¨<code>await</code>æ–¹æ³•ï¼Œå¹¶åœ¨æ­£ç¡®çš„ä½ç½®ä»¥<code>async</code>æ–¹å¼åˆ†æ”¯å‡ºå¼‚æ­¥ä»»åŠ¡ã€‚ è¯¥ä»£ç ä¸åŸå§‹çš„ç›´æ¥ç‰ˆæœ¬å°½å¯èƒ½ä¿æŒç›¸ä¼¼ï¼Œè¿™æ ¹æœ¬ä¸éš¾æ›´æ”¹ã€‚ ä¸€ä¸ªé‡è¦çš„å› ç´ æ˜¯åç¨‹ç®€å•åœ°åµŒå…¥åˆ°å“åº”ä»£ç ä¸­ã€‚ </p><br><p> æ‚¨ç”šè‡³å¯èƒ½æ›´å–œæ¬¢è¢«åŠ¨å¼æ–¹æ³•æ¥å®Œæˆæ­¤ä»»åŠ¡ï¼Œä½†æ˜¯è®¸å¤šæ¥å—è°ƒæŸ¥çš„äººå‘ç°å®ƒæ¯”è¾ƒå›°éš¾ã€‚ é€šå¸¸ï¼Œä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥è§£å†³å®ƒä»¬çš„é—®é¢˜ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„ä¸€ç§ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œæœ€è¿‘åœ¨Kotlinï¼Œä¹Ÿæœ‰æœºä¼šä½¿ç”¨Flowåˆ›å»ºâ€œå†·â€åç¨‹ï¼Œè¿™ä¸Reactoréå¸¸ç›¸ä¼¼ã€‚ æ²¡é”™ï¼Œå®ƒä»¬ä»å¤„äºè¯•éªŒé˜¶æ®µï¼Œä½†æ˜¯ç°åœ¨æ‚¨å¯ä»¥æŸ¥çœ‹å½“å‰çš„å®ç°å¹¶åœ¨æ‚¨çš„ä»£ç ä¸­è¿›è¡Œå°è¯•ã€‚ </p><br><p> æˆ‘æƒ³åœ¨è¿™é‡Œç»“æŸï¼Œæœ€åç•™ä¸‹æœ‰ç”¨çš„é“¾æ¥ï¼š </p><br><ul><li>  <a href="">åç¨‹æŒ‡å—</a> </li><li>  <a href="">åç¨‹ååº”å™¨</a> </li><li>  <a href="https://github.com/Kotlin/kotlinx.coroutines/tree/master/integration/kotlinx-coroutines-jdk8">åç¨‹å®Œæ•´çš„æœªæ¥</a> </li><li>  <a href="https://www.youtube.com/results%3Fsearch_query%3D%25D0%25B5%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2580%25D0%25BE%25D0%25B2%2B%25D1%2580%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%2B%25D0%25BA%25D0%25BE%25D1%2580%25D1%2583%25D1%2582%25D0%25B8%25D0%25BD%25D1%258B">ç½—é©¬Â·ä¼Šé‡Œæ‰æ´›å¤«ï¼ˆRoman Elizarovï¼‰å…³äºåç¨‹</a> </li><li>  <a href="https://medium.com/%40elizarov/kotlin-flows-and-coroutines-256260fb3bdb">Kotlinæµç¨‹å’Œåç¨‹</a> </li><li>  <a href="https://medium.com/%40elizarov/structured-concurrency-722d765aa952">ç»“æ„åŒ–å¹¶å‘</a> </li><li>  <a href="https://blog.karumi.com/spring-boot-loves-kotlin/">æ˜¥å­£é´çˆ±Kotlin</a> </li></ul><br><p> å¸Œæœ›æ‚¨æ„Ÿå…´è¶£ï¼Œå¹¶ä¸”æ‚¨è®¾æ³•è‡ªå·±ä¸ºæ‰€æœ‰æ–¹æ³•ç¼–å†™äº†è¯¥æ–¹æ³•çš„å®ç°ã€‚ è€Œä¸”ï¼Œå½“ç„¶ï¼Œæˆ‘æƒ³ç›¸ä¿¡æ‚¨å–œæ¬¢å¸¦æœ‰åç¨‹çš„é€‰é¡¹more =ï¼‰ </p><br><p> æ„Ÿè°¢æ‰€æœ‰è¯»å®Œæœ¬ä¹¦çš„äººï¼ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN477052/">https://habr.com/ru/post/zh-CN477052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN477042/index.html">è’™ç‰¹å¡ç½—äºŒåä¸€ç‚¹ç­–ç•¥ä¼˜åŒ–</a></li>
<li><a href="../zh-CN477044/index.html">é›†æˆä¿¡æ¯ç³»ç»Ÿçš„End-2-Endæµ‹è¯•è‡ªåŠ¨åŒ–ã€‚ ç¬¬2éƒ¨åˆ†ã€‚æŠ€æœ¯</a></li>
<li><a href="../zh-CN477046/index.html">.Netåœ¨Raiffeisenbankçš„èšä¼š28/11 +å¹¿æ’­</a></li>
<li><a href="../zh-CN477048/index.html">ä¸€å®¶å¸‚å€¼550äº¿ç¾å…ƒçš„å…¬å¸ä¸ºä»€ä¹ˆè€ƒè™‘ç¦»å¼€äº¤æ˜“æ‰€</a></li>
<li><a href="../zh-CN477050/index.html">é»‘è‰²æ˜ŸæœŸäº”2019ç”¨äºè§†é¢‘ç›‘æ§å’Œäº‘ã€‚</a></li>
<li><a href="../zh-CN477054/index.html">Webastoå®£å¸ƒæ¨¡å—åŒ–æ±½è½¦ç”µæ± ç³»ç»Ÿ</a></li>
<li><a href="../zh-CN477058/index.html">ä¼ä¸šæ•æ·ä¿„ç½—æ–¯åœ¨Raiffeisenbank 26/11 +å¹¿æ’­</a></li>
<li><a href="../zh-CN477060/index.html">DataArtå°†ä¸»æŒåœ£å½¼å¾—å ¡å›½ç«‹å¤§å­¦Matmekhç³»ç»Ÿç¼–ç¨‹ç³»ä¸»ä»»Andrei Terekhovçš„å…¬å¼€æ¼”è®²</a></li>
<li><a href="../zh-CN477062/index.html">ä¼˜åŒ–ç¼–è¯‘å™¨å¦‚ä½•å·¥ä½œ</a></li>
<li><a href="../zh-CN477072/index.html">å®¢æˆ·å¼€å‘æˆ–å¦‚ä½•æˆåŠŸæ¨å‡ºäº§å“ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>