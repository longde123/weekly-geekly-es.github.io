<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêâ üêü üêû Fahrrad vom Energiemonitor PZEM004T und ESP8266 mit People's Monitoring üéÖüèΩ üïäÔ∏è üë®üèº‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich fragte mich - wohin flie√üt der Strom aus den Dr√§hten? Es scheint, als ob wir das Haus mit Gas ertr√§nken, im Haus sind alle Lampen Dioden, wir scha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fahrrad vom Energiemonitor PZEM004T und ESP8266 mit People's Monitoring</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453472/">  Ich fragte mich - wohin flie√üt der Strom aus den Dr√§hten?  Es scheint, als ob wir das Haus mit Gas ertr√§nken, im Haus sind alle Lampen Dioden, wir schalten nachts den Geschirrsp√ºler ein, es gibt noch keine B√§der mit einem Elektroherd und der Strom geht die ganze Zeit aus.  Das Durcheinander.  Es w√§re notwendig, ihm zu folgen. <br>  Willkommen bei der Katze‚Ä¶ <br><a name="habracut"></a><br><br><h2>  Der erste Schritt ist die allgemeine √úberwachung des Verbrauchs </h2><br><h3>  Die Aufgaben </h3><br>  Ich beschloss, eine Hasenherde zu jagen.  Hasen wurden ausgew√§hlt: <br><br><ul><li>  Strom√ºberwachung √ºber das Internet.  Ich habe eine sofortige √úberwachung der Netzwerkparameter - im Korridor befindet sich im Panel ein Energiemonitor PZEM061, auf dem Bildschirm k√∂nnen Sie Spannung, Strom und Leistung sehen.  Aber am Ort der Anzeige der verbrauchten Energie - eine Art Abstraktion, zu wenig Entladungen.  Aber der Korridor ist nicht bequem.  Ich m√∂chte auf dem Telefonbildschirm. </li><li>  Grafik des Stromverbrauchs.  Ich m√∂chte wissen, wann √ºberm√§√üiger Konsum auftritt. </li><li>  Z√§hlerst√§nde √ºber das Internet.  Dieser Schmerz ist die √úbertragung von Z√§hlerst√§nden auf den Energieverkauf.  Es ist notwendig, sie vom 15. bis zum 25. Tag des Monats zu bezeugen.  Ich vergesse es oft und sie rufen den Roboter an und schreiben Spam.  Au√üerdem, wenn sie sich an sich selbst erinnern - ich arbeite normalerweise und habe einen Schalter auf einem Pfosten auf der Stra√üe.  Ich m√∂chte auf dem Telefonbildschirm. </li><li>  √úberwachen Sie die Stabilisatortemperatur.  In unserem Dorf gibt es im Winter nicht mehr als 200 V am Eingang des Hauses, es erreicht 140 V.  Daher habe ich keinen 12-kW-Stabilisator, aber mit solchen Parametern und einer langen Last von 2 kW und unter Ber√ºcksichtigung der Position des Stabilisators in der Wandnische, der √úberhitzung und des Ausschaltens des Stabilisators musste ich ein paar L√ºfter hinzuf√ºgen (bei ihnen bleibt die Temperatur innerhalb akzeptabler Grenzen) - sie wurden zuvor eingeschaltet st√§ndig kneten jetzt - Thermostate KSD9700 auf 65g stellen, wir warten auf den Winter.  Ich m√∂chte diesen Parameter nicht √ºberwachen, weil  Ich kann ihn nicht beeinflussen.  Aber nach dem Hinzuf√ºgen von Thermostaten m√ºssen Sie das Ergebnis kontrollieren. </li></ul><br><h3>  Eisen </h3><br>  Um die Aufgaben zu l√∂sen, wurde ausgew√§hlt: <br><br><ul><li>  PZEM004T - Energiemonitor mit UART.  Sie k√∂nnen die Parameter des Netzes abrufen - alle 0,6 Sekunden einen Parameter: Spannung, Strom, Leistung, Energieverbrauch sowie die Frequenz und den Leistungsfaktor, die ich nicht ben√∂tige.  Wird mit Messwandler 1: 1000 verwendet. </li><li>  ESP8266 NodeMCU - ein universeller Mikrocontroller mit WiFi, der gut zum PZEM004T passt - kann √ºber Racks mit den verf√ºgbaren L√∂chern auf den Platinen verbunden werden.  Es gibt auch eine n√ºtzliche Flash-Taste auf der NodeMCU-Karte (verbunden mit GPIO0) - es ist praktisch, sie zur Steuerung des Betriebsmodus zu verwenden - zum Beispiel um SoftAP zu aktivieren. </li></ul><br>  Vorausgesetzt, das Ger√§t wird im Metallgeh√§use des Stabilisators platziert - eine externe Antenne an das ESP gel√∂tet.  Ich habe versucht, das ESP √ºber das PZEM004T mit Strom zu versorgen (L√∂tdr√§hte an den runden Kondensator - es sind ungef√§hr 7 V). Es hat nicht funktioniert, als ich das ESP angeschlossen habe, f√§llt die Spannung auf 2 V ab.  Aber der Stabilisator hat bereits eine 5-V-Stromversorgung - f√ºr L√ºfter, was bedeutet, dass er verwendet wird (ich dachte, es waren 12 V, also habe ich lange gelitten, ein ESP daran anzuschlie√üen) - es hat in keinem funktioniert, ich habe eine Reihe von DC-DC-Wandlern ausprobiert, bis ich es umgedreht habe BP und las die Inschrift darauf nicht). <br><br><img src="https://habrastorage.org/webt/56/8s/yz/568syzaphx5e7gg62uqjuyjqkua.png"><br><br><h3>  Firmware </h3><br>  In einem Netzwerk verf√ºgbar angesehen.  Wie immer fand ich keinen passenden und beschloss, meinen eigenen zu schreiben. <br>  Ich habe mein eigenes Projekt f√ºr das Sonoff-Relais als Basis genommen (die einfachste Funktion, es wird √ºber HTTP ein- und ausgeschaltet und kann √ºber eine Taste nichts anderes tun; es wird in Verbindung mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MacroDroid verwendet</a> , um das Telefon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sparsam</a> mit einem st√§ndig auf dem Bildschirm befindlichen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ger√§t</a> zu versorgen - der vorherige Akku wurde durch eine konstante Ladung gesprengt und der Bildschirm herausgedr√ºckt )  Zus√§tzlich zur Relaisfunktion verf√ºgt die Baugruppe √ºber einen http-Server, WLAN, NTP-Einstellungen und arbeitet mit der GPIO0-Taste - verschiedene Aktionen von der Dauer des Dr√ºckens bis zum Blinken in einem beliebigen Licht (z. B. Z√§hlen der Sekunden des Dr√ºckens einer Taste, die den Status des Relais und des WLANs widerspiegeln) ... <br><br>  Nat√ºrlich habe ich die Einstellungen leicht ge√§ndert: <br><br><img src="https://habrastorage.org/webt/6n/oy/27/6noy274t8yivlrtxybopipepba4.png"><br><br>  Ich habe mir die vorhandene Bibliothek f√ºr die Arbeit mit PZEM004T angesehen - es hat mir nicht gefallen.  Sie sendet eine Anfrage und wartet dann in einer geschlossenen Schleife auf eine Antwort.  Das ist nicht richtig.  Ich habe meine Bibliothek asynchron geschrieben - ich sage dem Hauptprogramm, welche Parameter ich erhalten m√∂chte, und √ºberpr√ºfe dann regelm√§√üig, ob die erforderlichen Daten empfangen werden: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PZEM004Tnb::flags flags = PZEM004Tnb::flags::all; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastReadEnergyTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Pzem004t.isDataUpdated()) { setLedState(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-comment"><span class="hljs-comment">//       // ... unsigned long currentTime = millis(); if ((currentTime - lastReadEnergyTime) &gt; 6000) { //   1    flags = PZEM004Tnb::flags::all; lastReadEnergyTime = currentTime; }else{ flags = (PZEM004Tnb::flags)(PZEM004Tnb::flags::all ^ PZEM004Tnb::flags::energy); } } Pzem004t.updateData(flags);</span></span></code> </pre> <br></div></div><br>  Ich habe ber√ºcksichtigt, dass der PZEM004T maximal 9999 kW * h ber√ºcksichtigt, dann wird er zur√ºckgesetzt - ich habe die √úberlaufabrechnung implementiert.  Implementierung eines Zwei-Raten-Kontos.  Ich habe auch die Abrechnung der Durchschnittswerte der Parameter implementiert - die Messwerte werden ungef√§hr alle 2 Sekunden abgelesen, und bei der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Personen√ºberwachung ist</a> es erforderlich, alle 5 Minuten Daten zu √ºbertragen, nat√ºrlich durchschnittlich. <br><br>  Dem System hinzugef√ºgt, arbeiten mit einer Reihe von Sensoren DS18B20.  Die Daten werden nacheinander mit einer Zeitspanne von 2 Sekunden pro Sensor gelesen.  Das hei√üt,  Wir suchen nach einem Sensor, den wir gefunden haben - wir empfangen Daten, nach 2 Sekunden suchen wir nach dem n√§chsten usw.  Beendete Sensoren - von vorne beginnen.  Das hei√üt,  Wenn nur ein Sensor verwendet wird, betr√§gt die Abfragezeit 4 Sekunden.  F√ºr diese Sensoren wurden auch die Durchschnittswerte berechnet. <br><br>  Die aktuellen Energiemonitordaten k√∂nnen √ºber HTTP abgerufen werden: <br><br><img src="https://habrastorage.org/webt/l_/uc/jy/l_ucjyu_dm6b55ovjt1dw2dapqe.png"><br><br>  Alle Daten werden bei Bedarf in Ganzzahlen gespeichert (z. B. bei der √úbertragung an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">People's Monitoring</a> ). An der gew√ºnschten Position wird ein Punkt hinzugef√ºgt. <br><br>  Implementierung der Ver√∂ffentlichung von Daten mithilfe des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MQTT / UDP-Protokolls</a> .  Unterst√ºtzung f√ºr dieses Protokoll und den PZEM004T-Sensor wurde meinem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Monitor</a> hinzugef√ºgt: <br><br><img src="https://habrastorage.org/webt/88/ob/ds/88obdsb96ewvmu611ufwsxqs_ns.png"><br>  Dies ist mein fehlgeschlagenes Temperaturreglerprojekt ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fiasko. Die Geschichte eines hausgemachten IoT-Produkts</a> ), das ich als einzigen Monitor verlassen wollte. <br><br>  Implementierung der Ver√∂ffentlichung von Daten zur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Personen√ºberwachung</a> : <br><br><img src="https://habrastorage.org/webt/8_/g9/me/8_g9mews2dgsubfu31gclmdnhnq.png"><br><br>  Die Leute vom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">People's Monitoring haben</a> viel Respekt!  Das √úbertragen von Daten an den Dienst ist elementar. Es gibt eine M√∂glichkeit, die eingehenden Daten anzuzeigen, um die Interaktion zu debuggen. Sie k√∂nnen einfach die Sensordaten verwalten. <br>  Das System kann Testdiagramme erstellen (unten ist ein Durcheinander aus den Diagrammen, nur ein Beispiel): <br><img src="https://habrastorage.org/webt/co/o6/t1/coo6t1yfqzmmjlec0zo7qd2olfg.png"><br><br>  Es ist auch m√∂glich, √ºber den Status von Sensoren zu informieren (vor√ºbergehend deaktivierte Daten√ºbertragung f√ºr den Test): <br><img src="https://habrastorage.org/webt/qu/kn/b-/quknb-pfwfe1hxgtf9o_hy_ydgo.png"><br><br>  Nat√ºrlich habe ich Einstellungen f√ºr die Datenver√∂ffentlichung hinzugef√ºgt: <br><img src="https://habrastorage.org/webt/xj/5m/7f/xj5m7fdmyeolxcuxczmfoqlzmxi.png"><br><br><h3>  Zusammenfassung </h3><br>  Als Ergebnis der Echtzeit√ºberwachung schaltete er bereits einen der beiden st√§ndig eingeschalteten Minicomputer aus, konfigurierte den Ruhezustand auf dem Computer des Babys und konfigurierte den Schlafmodus im BD-Player neu (nur f√ºr Karaoke verwendet). <br><br>  Wenn Statistiken f√ºr die Diagramme gesammelt werden, werde ich weitere Schritte unternehmen. <br><br>  Wer m√∂chte einen solchen Energiemonitor bekommen - in einem pers√∂nlichen Konto f√ºr Firmware (Freebie, Sir!). <br><br><h3>  PS </h3><br>  Bei der Entwicklung des Ger√§ts stie√ü ich auf Mystik - wenn ESP von einem USB-Computer mit Strom versorgt wird, funktioniert alles.  Bei Stromversorgung √ºber ein eingebettetes Netzteil - funktioniert nicht.  Ich habe einen Logikanalysator und ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Simplescope</a> zur Untersuchung verwendet - die Leistung des blauen Blocks scheint in Ordnung zu sein, die Signale vom ESP sind korrekt und die R√ºckstille.  Noch ein Netzteil - alles funktioniert gut. <br><br>  Durch das wissenschaftliche St√∂bern wurde mir klar, dass ich das eingebaute Netzteil bei Verwendung mit dem Netzteil PZEM004T verbinde, dh in diesem Fall starten zwei Ger√§te gleichzeitig (bei anderen Netzteilen ist ein gleichzeitiges Einschalten nicht m√∂glich).  Und ich verwende Hardware-UART f√ºr die Kommunikation, auf die ESP beim Start viel M√ºll wirft.  PZEM004T kann dies beim Start nicht verdauen und friert ein.  Wenn PZEM004T bereits aktiviert ist, werden ESP und Garbage im Port ohne Probleme gestartet. <br>  Die L√∂sung war die Verwendung von SoftwareSerial, alles funktioniert gut damit. <br><br><h3>  PPS </h3><br>  F√ºr diejenigen, die sich ein solches Ger√§t machen wollen (und es gibt solche Helden!): <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beschreibung im Katalog der Ger√§te der nationalen √úberwachung</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de453472/">https://habr.com/ru/post/de453472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de453460/index.html">Wenn ich das Virtuelle satt habe</a></li>
<li><a href="../de453464/index.html">Quantum Future (Fortsetzung)</a></li>
<li><a href="../de453466/index.html">HolyJS 2019: Nachbesprechung von SEMrush (Teil 2)</a></li>
<li><a href="../de453468/index.html">Die Entwicklung von Java-Webanwendungen</a></li>
<li><a href="../de453470/index.html">Ihre verteilten Monolithen zeichnen hinter Ihnen</a></li>
<li><a href="../de453474/index.html">Computersteuerung √ºber Fernbedienung von einem Verst√§rker mit Arduino und Node.js.</a></li>
<li><a href="../de453478/index.html">Wir untersuchen die Gesundheit der Starlink-Satelliten Ilona Mask</a></li>
<li><a href="../de453482/index.html">Einf√ºhrung in das Deep Learning mit TensorFlow</a></li>
<li><a href="../de453484/index.html">4-Bit-BCD-Z√§hler</a></li>
<li><a href="../de453486/index.html">Prinzipien des US-freien Marktes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>