<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥪 👘 ✂️ 对抗软件开发中的复杂性 👨🏽‍🎤 🧤 🤶🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="这是怎么回事 


在完成了不同的项目之后，我注意到它们中的每一个都有一些共同的问题，而与域，体系结构，代码约定等无关。 这些问题并不具有挑战性，只是一个乏味的例行工作：确保您不会错过任何愚蠢而显而易见的事情。 我不再每天都执行此例程，而是沉迷于寻求解决方案：某些开发方法或代码约定或任何能够帮助我以...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>对抗软件开发中的复杂性</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458730/"><h2 id="whats-this-about"> 这是怎么回事 </h2><br><p>在完成了不同的项目之后，我注意到它们中的每一个都有一些共同的问题，而与域，体系结构，代码约定等无关。 这些问题并不具有挑战性，只是一个乏味的例行工作：确保您不会错过任何愚蠢而显而易见的事情。 我不再每天都执行此例程，而是沉迷于寻求解决方案：某些开发方法或代码约定或任何能够帮助我以防止那些问题发生的方式设计项目的事物，因此我可以专注于有趣的事情。 这就是本文的目的：描述这些问题，并向您展示我找到的解决问题的各种工具和方法。 </p><a name="habracut"></a><br><h2 id="problems-we-face"> 我们面临的问题 </h2><br><p> 在开发软件时，我们会遇到很多困难：要求不明确，沟通不畅，开发过程不佳等。 </p><br><p> 我们还面临一些技术难题：遗留代码使我们放慢速度，扩展很棘手，过去的一些错误决定使我们今天陷入困境。 </p><br><p> 所有这些问题都可以消除，甚至可以大大减少，但是有一个根本问题您无能为力：系统的复杂性。 </p><br><p> 无论您是否了解，您自己开发的系统的想法总是很复杂。 <br> 即使当您正在制作<em>另一个CRUD应用程序时</em> ，总会出现一些极端情况，一些棘手的事情，并且有时会有人问“嘿，如果在这种情况下这样做，会发生什么？” 然后您说“嗯，这是一个很好的问题。” </p><br><p> 这些棘手的情况，可疑的逻辑，验证和访问管理-所有这些加在一起就构成了您的重要构想。 <br> 通常，这个想法如此之大，以至于无法一head而就，仅这个事实就带来了沟通不畅等问题。 </p><br><p> 但是，请让我们大方一些，并假设该领域专家和业务分析人员团队进行了清晰的沟通，并提出了很好的一致要求。 </p><br><p> 现在，我们必须实现它们，以在我们的代码中表达这个复杂的想法。 现在，该代码是另一个系统，比我们想到的原始想法复杂得多。 </p><br><p> 怎么会这样 它面临现实：技术限制迫使您在实施实际业务逻辑的基础上应对高负载，数据一致性和可用性。 </p><br><p> 如您所见，任务非常艰巨，现在我们需要适当的工具来处理它。 <br> 编程语言只是另一种工具，与其他所有工具一样，它不仅与语言的质量有关，还与适合工作的工具有关。 您可能拥有最好的螺丝刀，但是如果您需要在木头上钉一些钉子，那么a头的锤子会更好，对吧？ </p><br><h2 id="technical-aspects"> 技术方面 </h2><br><p> 如今，大多数流行语言都是面向对象的。 当有人介绍OOP时，他们通常使用示例： <br> 考虑一下汽车，它是现实世界中的物体。 它具有各种属性，例如品牌，重量，颜色，最大速度，当前速度等。 </p><br><p> 为了在我们的程序中反映该对象，我们将这些属性收集在一个类中。 属性可以是永久性的也可以是可变的，它们共同构成该对象的当前状态以及可能会变化的某些边界。 但是结合这些属性是不够的，因为我们必须检查当前状态是否有意义，例如当前速度没有超过最大速度。 为了确保我们在此类上附加一些逻辑，请将属性标记为私有，以防止任何人创建非法状态。 <br> 如您所见，对象是关于其内部状态和生命周期的。 </p><br><p> 因此，在这种情况下，OOP的这三个支柱非常有意义：我们使用继承重用某些状态操作，使用封装进行状态保护以及使用多态性以相同方式处理相似对象。 默认情况下，可变性也很有意义，因为在这种情况下，不可变对象不能具有生命周期，并且始终具有一个状态，这不是最常见的情况。 </p><br><p>事情是当您看到当今的典型Web应用程序时，它不处理对象。 我们代码中的几乎所有内容都具有永生或根本没有生命。 两种最常见的“对象”是某种服务，例如<code>UserService</code> ， <code>EmployeeRepository</code>或某些模型/实体/ DTO或您所谓的它们。 服务内部没有逻辑状态，它们的死亡和重生完全相同，我们只是使用新的数据库连接来重新创建依赖关系图。 </p><br><p> 实体和模型没有任何附加的行为，它们只是数据束，其可变性无济于事，而恰恰相反。 </p><br><p> 因此，OOP的关键功能对于开发此类应用程序并不是真正有用。 </p><br><p> 在典型的Web应用程序中，发生的事情是数据流动：验证，转换，评估等。 这里有一个非常适合这种工作的范例：函数式编程。 有一个证明：当今流行语言的所有现代功能都来自那里： <code>async/await</code> ，lambda和委托，反应式编程，有区别的联合（快速枚举或rust枚举，不要与Java或.net枚举混淆） ），元组-全部来自FP。 </p><br><p> 但是这些只是碎屑，拥有它们非常好，但是还有更多，更多的方法。 </p><br><p> 在我深入之前，有一点需要指出。 切换到新的语言，尤其是新的范例是对开发人员的投资，因此也是对业务的投资。 进行愚蠢的投资只会给您带来麻烦，但是给您带来麻烦的却是合理的投资。 </p><br><h2 id="tools-we-have-and-what-they-give-us"> 我们拥有的工具以及它们给我们的东西 </h2><br><p> 我们中的许多人都喜欢使用静态类型的语言。 原因很简单：编译器处理繁琐的检查，例如将适当的参数传递给函数，正确地构造我们的实体等等。 这些支票是免费的。 现在，对于编译器无法检查的内容，我们可以选择：希望是最好的还是进行一些测试。 编写测试意味着金钱，您不必为每次测试支付一次费用，而是必须维护它们。 此外，人们变得草率，所以我们偶尔会得到假阳性和假阴性结果。 您必须编写的测试越多，这些测试的平均质量就越低。 还有另一个问题：为了测试某些东西，您必须知道并记住应该测试该东西，但是系统越大，遗失东西就越容易。 </p><br><p> 但是，编译器仅与语言的类型系统一样好。 如果不允许您以静态方式表达某些内容，则必须在运行时执行。 意思是测试，是的。 不过，这不仅与类型系统有关，语法和小糖功能​​也非常重要，因为最终我们希望编写尽可能少的代码，所以如果某种方法要求您编写多十倍的行，没有人会使用它。 这就是为什么您选择的语言具有合适的功能和窍门很重要的原因-总体而言，正确的重点。 如果不是这样，那么您将不但没有使用它的功能来应对原始挑战，例如系统的复杂性和不断变化的需求，而且还需要与语言进行抗争。 这一切都归结为金钱，因为您为开发者付出了时间。 他们必须解决的问题越多，所需的时间就越多，所需的开发人员就越多。 </p><br><p> 最后，我们将看到一些代码来证明所有这些。 我刚好是.NET开发人员，所以代码示例将使用C＃和F＃，但是在其他流行的OOP和FP语言中，总体情况大致相同。 </p><br><h2 id="let-the-coding-begin"> 让编码开始 </h2><br><p> 我们将构建一个用于管理信用卡的Web应用程序。 </p><br><p> 基本要求： </p><br><ul><li> 创建/读取用户 </li><li> 创建/读取信用卡 </li><li> 激活/停用信用卡 </li><li> 设置卡的每日限额 </li><li> 充值余额 </li><li> 处理付款（考虑余额，卡到期日期，有效/无效状态和每日限额） </li></ul><br><p> 为了简单起见，我们将每个帐户使用一张卡，并且我们将跳过授权。 但是对于其余部分，我们将构建具有验证，错误处理，数据库和Web API的功能强大的应用程序。 因此，让我们开始第一个任务：设计信用卡。 </p><br><p> 首先，让我们看看C＃的外观 </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Card</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CardNumber {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ExpirationMonth {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ExpirationYear {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsActive {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> AccountInfo AccountInfo {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AccountInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Balance {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CardNumber {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> DailyLimit {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} }</code> </pre> <br><p> 但这还不够，我们必须添加验证，并且通常是在某些<code>Validator</code>中完成的，例如<code>FluentValidation</code> <code>Validator</code> <code>FluentValidation</code> 。 </p><br><p> 规则很简单： </p><br><ul><li> 卡号为必填项，并且必须为16位数字的字符串。 </li><li> 名称是必填项，并且只能包含字母，中间可以包含空格。 </li><li> 月和年必须满足界限。 </li><li> 卡处于活动状态时，必须存在帐户信息；而停用卡时，则必须存在帐户信息。 如果您想知道为什么，这很简单：停用卡后，就不可能更改余额或每日限额。 </li></ul><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CardValidator</span></span> : <span class="hljs-title"><span class="hljs-title">IValidator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> CardNumberRegex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">"^[0-9]{16}$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NameRegex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">"^[\w]+[\w ]+[\w]+$"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CardValidator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { RuleFor(x =&gt; x.CardNumber) .Must(c =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(c) &amp;&amp; CardNumberRegex.IsMatch(c)) .WithMessage(<span class="hljs-string"><span class="hljs-string">"oh my"</span></span>); RuleFor(x =&gt; x.Name) .Must(c =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(c) &amp;&amp; NameRegex.IsMatch(c)) .WithMessage(<span class="hljs-string"><span class="hljs-string">"oh no"</span></span>); RuleFor(x =&gt; x.ExpirationMonth) .Must(x =&gt; x &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; x &lt;= <span class="hljs-number"><span class="hljs-number">12</span></span>) .WithMessage(<span class="hljs-string"><span class="hljs-string">"oh boy"</span></span>); RuleFor(x =&gt; x.ExpirationYear) .Must(x =&gt; x &gt;= <span class="hljs-number"><span class="hljs-number">2019</span></span> &amp;&amp; x &lt;= <span class="hljs-number"><span class="hljs-number">2023</span></span>) .WithMessage(<span class="hljs-string"><span class="hljs-string">"oh boy"</span></span>); RuleFor(x =&gt; x.AccountInfo) .Null() .When(x =&gt; !x.IsActive) .WithMessage(<span class="hljs-string"><span class="hljs-string">"oh boy"</span></span>); RuleFor(x =&gt; x.AccountInfo) .NotNull() .When(x =&gt; x.IsActive) .WithMessage(<span class="hljs-string"><span class="hljs-string">"oh boy"</span></span>); } }</code> </pre> <br><p> 现在，这种方法存在一些问题： </p><br><ul><li> 验证与类型声明是分开的，这意味着要查看<em>一张真正的卡</em>的完整图片，我们必须浏览代码并在脑海中重新创建此图像。 当它只发生一次时，这不是一个大问题，但是当我们必须对一个大型项目中的每个实体都这样做时，这是非常耗时的。 </li><li> 这种验证不是强制性的，我们必须牢记在任何地方都使用它。 我们可以通过测试来确保这一点，但是再次，您在编写测试时必须记住这一点。 </li><li> 当我们想在其他地方验证卡号时，我们必须再次做同样的事情。 当然，我们可以将regex放在一个普通的地方，但是仍然必须在每个验证器中调用它。 </li></ul><br><p> 在F＃中，我们可以通过其他方式来实现： </p><br><pre> <code class="haskell hljs">(*<span class="hljs-comment"><span class="hljs-comment">{- First we define a type for CardNumber with private constructor and public factory which receives string and returns `Result&lt;CardNumber, string&gt;`. Normally we would use `ValidationError` instead, but string is good enough for example -}</span></span>*) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> = private </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> of string with member this.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Value</span></span></span><span class="hljs-class"> = match this with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> s -&gt; s static member create str = match str with | (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">|"") -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Error</span></span></span><span class="hljs-class"> "card number can't be empty" | str -&gt; if cardNumberRegex.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsMatch</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">str</span></span></span><span class="hljs-class">) then </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> str |&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ok</span></span></span><span class="hljs-class"> else </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Error</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> number must be a 16 digits string" (*</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">{- Then in here we express this logic "when card is deactivated, balance and daily limit manipulations aren't available". Note that this is way easier to grasp that reading `RuleFor()` in validators. -}</span></span></span><span class="hljs-class">*) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardAccountInfo</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Active</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountInfo</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deactivated</span></span></span><span class="hljs-class"> (*</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">{- And then that's it. The whole set of rules is here, and it's described in a static way. We don't need tests for that, the compiler is our test. And we can't accidentally miss this validation. -}</span></span></span><span class="hljs-class">*) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Name</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LetterString</span></span></span><span class="hljs-class"> //</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">-- LetterString is another type with built-in validation HolderId: UserId Expiration: (Month * Year) AccountDetails: CardAccountInfo }</span></span></span></span></code> </pre> <br><p> 当然，从这里我们可以在C＃中做一些事情。 我们可以创建<code>CardNumber</code>类，该类也将在其中抛出<code>ValidationException</code> 。 但是<code>CardAccountInfo</code>这个技巧无法在C＃中轻松实现。 <br> 另一件事-C＃严重依赖异常。 有几个问题： </p><br><ul><li> 异常具有“执行”语义。 您使用此方法的一刻，另一刻-您遇到了某个全局处理程序。 </li><li> 它们不会出现在方法签名中。 诸如<code>ValidationException</code>或<code>InvalidUserOperationException</code>类的异常是合同的一部分，但是直到您阅读<em>Implementation</em>才知道。 这是一个主要的问题，因为很多时候您必须使用别人编写的代码，而不仅仅是阅读签名，而是必须一直浏览到调用堆栈的底部，这需要很多时间。 </li></ul><br><p> 这就是困扰我的地方：每当我实现一些新功能时，实现过程本身就不会花费很多时间，其中大部分用于两件事： </p><br><ul><li> 阅读其他人的代码并弄清楚业务逻辑规则。 </li><li> 确保没有损坏。 </li></ul><br><p> 这听起来像是代码设计不佳的征兆，但即使在编写得体的项目上也一样。 <br> 好的，但是我们可以尝试在C＃中使用相同的<code>Result</code> 。 最明显的实现如下所示： </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Result</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TOk</span></span>, <span class="hljs-title"><span class="hljs-title">TError</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TOk Ok {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TError Error {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} }</code> </pre> <br><p> 而且这纯粹是垃圾，它不会阻止我们同时设置<code>Ok</code>和<code>Error</code>并允许错误被完全忽略。 正确的版本应该是这样的： </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Result</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TOk</span></span>, <span class="hljs-title"><span class="hljs-title">TError</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsOk { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OkResult</span></span> : <span class="hljs-title"><span class="hljs-title">Result</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TOk</span></span>, <span class="hljs-title"><span class="hljs-title">TError</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TOk _ok; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OkResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TOk ok</span></span></span><span class="hljs-function">)</span></span> { _ok = ok; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsOk =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ErrorResult</span></span> : <span class="hljs-title"><span class="hljs-title">Result</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TOk</span></span>, <span class="hljs-title"><span class="hljs-title">TError</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TError _error; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ErrorResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TError error</span></span></span><span class="hljs-function">)</span></span> { _error = error; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsOk =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Result&lt;TOk, TError&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ok</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TOk ok</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OkResult(ok); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Result&lt;TOk, TError&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Error</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TError error</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResult(error); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Result&lt;T, TError&gt; Map&lt;T&gt;(Func&lt;TOk, T&gt; map) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsOk) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = ((OkResult)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)._ok; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Result&lt;T, TError&gt;.Ok(map(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = ((ErrorResult)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)._error; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Result&lt;T, TError&gt;.Error(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Result&lt;TOk, T&gt; MapError&lt;T&gt;(Func&lt;TError, T&gt; mapError) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsOk) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = ((OkResult)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)._ok; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Result&lt;TOk, T&gt;.Ok(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = ((ErrorResult)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)._error; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Result&lt;TOk, T&gt;.Error(mapError(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); } } }</code> </pre> <br><p> 很累吧？ 而且我什至没有实现<code>Map</code>和<code>MapError</code>的<code>void</code>版本。 用法如下所示： </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Result&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; result</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> squareResult = result.Map(x =&gt; x * x); }</code> </pre> <br><p> 还不错吧？ 好吧，现在假设您有三个结果，并且当所有结果都<code>Ok</code>时，您想对它们执行某项操作。 讨厌 因此，这几乎不是一个选择。 <br>  F＃版本： </p><br><pre> <code class="haskell hljs">//<span class="hljs-comment"><span class="hljs-comment">-- this type is in standard library, but declaration looks like this: type Result&lt;'ok, 'error&gt; = | Ok of 'ok | Error of 'error //-- and usage: let test res1 res2 res3 = match res1, res2, res3 with | Ok ok1, Ok ok2, Ok ok3 -&gt; printfn "1: %A 2: %A 3: %A" ok1 ok2 ok3 | _ -&gt; printfn "fail"</span></span></code> </pre> <br><p> 基本上，您必须选择是否编写合理数量的代码，但是代码晦涩难懂，依赖于异常，反射，表达式和其他“魔术”，或者编写更多的代码（虽然很难阅读，但更耐用）直截了当。 当这样的项目发展壮大时，您将无法抗拒它，而不是使用具有C＃类类型系统的语言。 让我们考虑一个简单的场景：在代码库中有一段时间的实体。 今天，您想添加一个新的必填字段。 自然地，您需要在创建该实体的任何地方都初始化该字段，但是编译器根本无法为您提供帮助，因为class是可变的并且<code>null</code>是有效值。 像<code>AutoMapper</code>这样的库使它变得更加困难。 这种可变性使我们可以在一个地方部分地初始化对象，然后将其推到其他位置并在那里继续初始化。 那是错误的另一个来源。 </p><br><p> 同时，语言功能比较不错，但这不是本文的目的。 如果您对此感兴趣，我会在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上一篇文章中</a>介绍了该主题。 但是语言功能本身不应该成为切换技术的理由。 </p><br><p> 因此，我们想到了以下问题： </p><br><ol><li> 为什么我们真的需要从现代OOP转换？ </li><li> 为什么要切换到FP？ </li></ol><br><p> 第一个问题的答案是将常见的OOP语言用于现代应用程序会给您带来很多麻烦，因为它们是为不同的目的而设计的。 这会导致您花费大量时间和金钱来与他们的设计抗衡，同时还与应用程序的复杂性作斗争。 </p><br><p> 第二个答案是FP语言为您提供了一种简单的方法来设计功能，使它们像时钟一样工作，并且如果新功能破坏了现有逻辑，则会破坏代码，因此您立即就知道了。 </p><br><hr><br><p> 但是，这些答案还不够。 正如我的朋友在我们的一次讨论中所指出的那样，如果您不了解最佳做法，则切换到FP毫无用处。 我们这个庞大的行业编写了有关设计OOP应用程序的大量文章，书籍和教程，并且我们具有OOP的生产经验，因此我们知道对不同方法的期望。 不幸的是，函数编程并非如此，因此，即使您切换到FP，您的第一次尝试也很可能会很尴尬，并且肯定不会为您带来预期的结果：快速而轻松地开发复杂的系统。 </p><br><p> 好吧，这正是本文的主题。 正如我所说，我们将构建类似于生产的应用程序以了解差异。 </p><br><h2 id="how-do-we-design-application"> 我们如何设计应用程序？ </h2><br><p> 我在出色的《 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">领域建模使功能》</a>一书中借鉴了许多设计过程中使用的想法，因此强烈建议您阅读。 </p><br><p> 带有注释的完整源代码<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a> 。 自然，我不会将所有内容都放在这里，因此我将仅介绍关键点。 </p><br><p> 我们将有4个主要项目：业务层，数据访问层，基础结构，当然还有公共项目。 每个解决方案都有，对吗？ </p><br><p> 我们从建模领域开始。 在这一点上，我们不知道也不在乎数据库。 这样做是有目的的，因为考虑到特定的数据库，我们倾向于根据该数据库设计域，因此我们在业务层中引入了实体表关系，随后又带来了问题。 您只需要实现映射<code>domain -&gt; DAL</code>一次，而错误的设计将不断困扰我们，直到我们修复它为止。 所以，这就是我们的工作：创建一个名为<code>CardManagement</code>的项目（我知道非常有创意），然后立即在项目文件中打开设置<code>&lt;TreatWarningsAsErrors&gt;true&lt;/TreatWarningsAsErrors&gt;</code> 。 我们为什么需要这个？ 好吧，我们将大量使用区分的并集，当您进行模式匹配时，如果我们没有涵盖所有可能的情况，则编译器会向我们发出警告： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> fail result = match result with | <span class="hljs-type"><span class="hljs-type">Ok</span></span> v -&gt; printfn <span class="hljs-string"><span class="hljs-string">"%A"</span></span> v //<span class="hljs-comment"><span class="hljs-comment">-- warning: Incomplete pattern matches on this expression. //-- For example, the value 'Error' may indicate a case not covered by the pattern(s).</span></span></code> </pre> <br><p> 启用此设置后，当我们扩展现有功能并希望在任何地方进行调整时，这些代码就不会编译，这正是我们需要的。 接下来要做的是创建模块（在静态类中编译） <code>CardDomain</code> 。 在此文件中，我们描述域类型，仅此而已。 请记住，在F＃中，代码和文件顺序很重要：默认情况下，您只能使用您之前声明的内容。 </p><br><h3 id="domain-types"> 域类型 </h3><br><p> 我们将使用之前显示的<code>CardNumber</code>开始定义类型，尽管我们将需要的不仅仅是字符串，还需要更多实际的<code>Error</code> ，所以我们将使用<code>ValidationError</code> 。 </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ValidationError</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FieldPath</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> } let validationError field message = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FieldPath</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Message</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> } (*</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">{- Actually we should use here Luhn's algorithm, but I leave it to you as an exercise, so you can see for yourself how easy is updating code to new requirements. -}</span></span></span><span class="hljs-class">*) let private cardNumberRegex = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Regex</span></span></span><span class="hljs-class">("^[0-9]{16}$", </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RegexOptions</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiled</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> = private </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> of string with member this.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Value</span></span></span><span class="hljs-class"> = match this with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> s -&gt; s static member create fieldName str = match str with | (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">|"") -&gt; validationError fieldName "card number can't be empty" | str -&gt; if cardNumberRegex.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsMatch</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">str</span></span></span><span class="hljs-class">) then </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> str |&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ok</span></span></span><span class="hljs-class"> else validationError fieldName "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> number must be a 16 digits string"</span></span></code> </pre> <br><p> 然后我们当然将<code>Card</code>定义为我们领域的核心。 我们知道卡具有一些永久属性，例如卡上的数字，有效期和名称，以及一些可更改的信息（例如余额和每日限额），因此我们将这种可更改的信息封装为其他类型： </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountInfo</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HolderId</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Balance</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Money</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DailyLimit</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DailyLimit</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Name</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LetterString</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HolderId</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Expiration</span></span></span><span class="hljs-class">: (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Month</span></span></span><span class="hljs-class"> * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Year</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountDetails</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardAccountInfo</span></span></span><span class="hljs-class"> }</span></span></code> </pre> <br><p> 现在，这里有几种类型，我们尚未声明： </p><br><ol><li><p>  <strong>钱款</strong> </p><br><p> 我们可以使用<code>decimal</code> （我们将使用，但不能直接使用），但是<code>decimal</code>的描述较少。 此外，它可以用于表示金钱以外的其他事物，我们不希望将其混淆。 因此，我们使用自定义类型<code>type [&lt;Struct&gt;] Money = Money of decimal</code> 。 </p><br></li><li><p>  <strong>每日限额</strong> </p><br><p> 每日限额可以设置为特定数量，也可以完全不设置。 如果存在，则必须为正。 我们定义这种类型而不是使用<code>decimal</code>或<code>Money</code> ： </p><br><pre> <code class="haskell hljs">[&lt;<span class="hljs-type"><span class="hljs-type">Struct</span></span>&gt;] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DailyLimit</span></span></span><span class="hljs-class"> = private //</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">-- private constructor so it can't be created directly outside of module | Limit of Money | Unlimited with static member ofDecimal dec = if dec &gt; 0m then Money dec |&gt; Limit else Unlimited member this.ToDecimalOption() = match this with | Unlimited -&gt; None | Limit limit -&gt; Some limit.Value</span></span></span></span></code> </pre> <br><p> 它具有更多的描述性，而不仅仅是暗示<code>0M</code>意味着没有限制，因为这还意味着您无法在这张卡上花钱。 唯一的问题是，由于我们隐藏了构造函数，因此无法进行模式匹配。 但是不用担心，我们可以使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Active Patterns</a> ： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> (|<span class="hljs-type"><span class="hljs-type">Limit</span></span>|<span class="hljs-type"><span class="hljs-type">Unlimited</span></span>|) limit = match limit with | <span class="hljs-type"><span class="hljs-type">Limit</span></span> dec -&gt; <span class="hljs-type"><span class="hljs-type">Limit</span></span> dec | <span class="hljs-type"><span class="hljs-type">Unlimited</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Unlimited</span></span></code> </pre> <br><p> 现在，我们可以在任何地方将常规的<code>DailyLimit</code>模式匹配为常规DU。 </p><br></li><li><p>  <strong>字母串</strong> </p><br><p> 那很简单。 我们使用与<code>CardNumber</code>相同的技术。 不过有一点要注意： <code>LetterString</code>几乎与信用卡<code>LetterString</code> ，这是一件相当的事情，我们应该将其移动到<code>CommonTypes</code>模块的<code>Common</code>项目中。 时间到了，我们也将<code>ValidationError</code>移到单独的位置。 </p><br></li><li><p>  <strong>用户名</strong> </p><br><p> 那只是别名<code>type UserId = System.Guid</code> 。 我们仅将其用于描述性目的。 </p><br></li><li><p>  <strong>月和年</strong> </p><br><p> 那些也必须去<code>Common</code> 。  <code>Month</code>将成为一个有区别的联合，其方法可将其与<code>unsigned int16</code>进行相互转换， <code>Year</code>将类似于<code>unsigned int16</code> ，但对于<code>uint16</code>而不是string。 </p><br></li></ol><br><p> 现在，让我们完成域类型声明。 我们需要给<code>User</code>提供一些用户信息和卡收集信息，我们需要余额操作来充值和付款。 </p><br><pre> <code class="haskell hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserInfo</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Name</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LetterString</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Id</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Address</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Address</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserInfo</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserInfo</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cards</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> } [&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Struct</span></span></span><span class="hljs-class">&gt;] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BalanceChange</span></span></span><span class="hljs-class"> = //</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">-- another common type with validation for positive amount | Increase of increase: MoneyTransaction | Decrease of decrease: MoneyTransaction with member this.ToDecimal() = match this with | Increase i -&gt; i.Value | Decrease d -&gt; -d.Value [&lt;Struct&gt;] type BalanceOperation = { CardNumber: CardNumber Timestamp: DateTimeOffset BalanceChange: BalanceChange NewBalance: Money }</span></span></span></span></code> </pre> <br><p> 好的，我们以一种无法表示无效状态的方式设计了类型。 现在，无论何时处理任何这些类型的实例，我们都可以确保其中的数据有效，而不必再次进行验证。 现在我们可以进行业务逻辑了！ </p><br><h3 id="business-logic"> 业务逻辑 </h3><br><p> 我们这里有一条牢不可破的规则：所有业务逻辑都将用<strong>纯函数</strong>编码。 纯函数是满足以下条件的函数： </p><br><ul><li> 它唯一要做的就是计算输出值。 它根本没有副作用。 </li><li> 对于相同的输入，它总是产生相同的输出。 </li></ul><br><p> 因此，纯函数不会引发异常，不会产生随机值，不会以任何形式与外界交互，无论是数据库还是简单的<code>DateTime.Now</code> 。 当然，与不纯函数交互会自动使调用函数不纯。 那么我们应该执行什么呢？ </p><br><p> 以下是我们的要求列表： </p><br><ul><li><p>  <strong>激活/停用卡</strong> </p><br></li><li><p>  <strong>处理付款</strong> </p><br><p> 在以下情况下，我们可以处理付款： </p><br><ol><li> 卡未过期 </li><li> 卡已激活 </li><li> 有足够的钱来付款 </li><li> 今天的支出尚未超过每日限额。 </li></ol><br></li><li><p>  <strong>充值余额</strong> </p><br><p> 我们可以为有效和未过期的卡充值。 </p><br></li><li><p>  <strong>设定每日限额</strong> </p><br><p> 如果卡未过期且处于活动状态，则用户可以设置每日限额。 </p><br></li></ul><br><p> 当操作无法完成时，我们必须返回一个错误，因此我们需要定义<code>OperationNotAllowedError</code> ： </p><br><pre> <code class="haskell hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OperationNotAllowedError</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Operation</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Reason</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> } //</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">-- and a helper function to wrap it in `Error` which is a case for `Result&lt;'ok,'error&gt; type let operationNotAllowed operation reason = { Operation = operation; Reason = reason } |&gt; Error</span></span></span></span></code> </pre> <br><p> 在具有业务逻辑的模块中，这将是我们返回<em>的唯一</em>错误类型。 我们不在这里进行验证，也不会与数据库进行交互-如果我们可以返回<code>OperationNotAllowedError</code>则只需执行操作即可。 </p><br><p> 完整的模块可以在<a href="">这里</a>找到。 我在这里列出最棘手的情况： <code>processPayment</code> 。 我们必须检查到期时间，有效/停用状态，今天花费的资金和当前余额。 由于我们无法与外部世界互动，因此我们必须传递所有必要的信息作为参数。 这样，此<em>逻辑</em>将非常易于测试，并允许您进行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">基于属性的测试</a> 。 </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> processPayment (currentDate: <span class="hljs-type"><span class="hljs-type">DateTimeOffset</span></span>) (spentToday: <span class="hljs-type"><span class="hljs-type">Money</span></span>) card (paymentAmount: <span class="hljs-type"><span class="hljs-type">MoneyTransaction</span></span>) = //<span class="hljs-comment"><span class="hljs-comment">-- first check for expiration if isCardExpired currentDate card then cardExpiredMessage card.CardNumber |&gt; processPaymentNotAllowed else //-- then active/deactivated match card.AccountDetails with | Deactivated -&gt; cardDeactivatedMessage card.CardNumber |&gt; processPaymentNotAllowed | Active accInfo -&gt; //-- if active then check balance if paymentAmount.Value &gt; accInfo.Balance.Value then sprintf "Insufficent funds on card %s" card.CardNumber.Value |&gt; processPaymentNotAllowed else //-- if balance is ok check limit and money spent today match accInfo.DailyLimit with | Limit limit when limit &lt; spentToday + paymentAmount -&gt; sprintf "Daily limit is exceeded for card %s with daily limit %M. Today was spent %M" card.CardNumber.Value limit.Value spentToday.Value |&gt; processPaymentNotAllowed (*{- We could use here the ultimate wild card case like this: | _ -&gt; but it's dangerous because if a new case appears in `DailyLimit` type, we won't get a compile error here, which would remind us to process this new case in here. So this is a safe way to do the same thing. -}*) | Limit _ | Unlimited -&gt; let newBalance = accInfo.Balance - paymentAmount let updatedCard = { card with AccountDetails = Active { accInfo with Balance = newBalance } } //-- note that we have to return balance operation, //-- so it can be stored to DB later. let balanceOperation = { Timestamp = currentDate CardNumber = card.CardNumber NewBalance = newBalance BalanceChange = Decrease paymentAmount } Ok (updatedCard, balanceOperation)</span></span></code> </pre> <br><p> 今天<code>spentToday</code> -我们必须从数据库中保存的<code>BalanceOperation</code>集合中计算出来。 因此，我们需要为此模块，该模块基本上具有1个公共功能： </p><br><pre> <code class="haskell hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> private isDecrease change = match change with | <span class="hljs-type"><span class="hljs-type">Increase</span></span> _ -&gt; false | <span class="hljs-type"><span class="hljs-type">Decrease</span></span> _ -&gt; true <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> spentAtDate (date: <span class="hljs-type"><span class="hljs-type">DateTimeOffset</span></span>) cardNumber operations = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> date = date.<span class="hljs-type"><span class="hljs-type">Date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> operationFilter { <span class="hljs-type"><span class="hljs-type">CardNumber</span></span> = number; <span class="hljs-type"><span class="hljs-type">BalanceChange</span></span> = change; <span class="hljs-type"><span class="hljs-type">Timestamp</span></span> = timestamp } = isDecrease change &amp;&amp; number = cardNumber &amp;&amp; timestamp.<span class="hljs-type"><span class="hljs-type">Date</span></span> = date <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> spendings = <span class="hljs-type"><span class="hljs-type">List</span></span>.filter operationFilter operations <span class="hljs-type"><span class="hljs-type">List</span></span>.sumBy (fun s -&gt; -s.<span class="hljs-type"><span class="hljs-type">BalanceChange</span></span>.<span class="hljs-type"><span class="hljs-type">ToDecimal</span></span>()) spendings |&gt; <span class="hljs-type"><span class="hljs-type">Money</span></span></code> </pre> <br><p> 好啊 既然我们已经完成了所有业务逻辑实现，那么该考虑一下映射了。 我们的许多类型都使用区分联合，我们的某些类型没有公共构造函数，因此我们无法将它们按原样暴露给外界。 我们需要处理（取消）序列化。 除此之外，现在我们的应用程序中只有一个有界上下文，但是在现实生活中，您将需要构建一个具有多个有界上下文的更大的系统，并且它们必须通过公共合同彼此交互，这应该是可理解的适用于所有人，包括其他编程语言。 </p><br><p> 我们必须同时进行两种方式的映射：从公共模型到域，反之亦然。 虽然从领域到模型的映射相当困难，但另一个方向有点麻烦：模型毕竟可以使用无效的数据，毕竟我们使用可以序列化为json的普通类型。 不用担心，我们将必须在该映射中建立验证。 我们对可能无效的数据和数据使用不同类型的事实，这<strong>始终是</strong>有效的，这意味着编译器不会让我们忘记执行验证。 </p><br><p> 看起来是这样的： </p><br><pre> <code class="haskell hljs">(*<span class="hljs-comment"><span class="hljs-comment">{- You can use type aliases to annotate your functions. This is just an example, but sometimes it makes code more readable -}</span></span>*) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ValidateCreateCardCommand</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCardCommandModel</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ValidationResult</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class">&gt; let validateCreateCardCommand : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ValidateCreateCardCommand</span></span></span><span class="hljs-class"> = fun cmd -&gt; (*</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">{- that's a computation expression for `Result&lt;&gt;` type. Thanks to this we don't have to chose between short code and strait forward one, like we have to do in C# -}</span></span></span><span class="hljs-class">*) result { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class">! </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LetterString</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class">! </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">number</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cardNumber</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class">! </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">month</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Month</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expirationMonth</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExpirationMonth</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class">! </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">year</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Year</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expirationYear</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExpirationYear</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">number</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Name</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HolderId</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Expiration</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">month</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">year</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountDetails</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountInfo</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Default</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class"> |&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Active</span></span></span><span class="hljs-class"> } }</span></span></code> </pre> <br><p>  <a href="">这里</a>是用于映射和验证的完整模块， <a href="">这里</a>是用于映射到模型的模块。 </p><br><p> 至此，我们已经实现了所有业务逻辑，映射，验证等的实现，到目前为止，所有这些都与现实世界完全隔离：它完全由纯函数编写。 现在您可能想知道，我们将如何利用这一点？ 因为我们必须与外界互动。 不仅如此，在执行工作流期间，我们必须根据这些实际交互的结果做出一些决策。 所以问题是我们如何组装所有这些？ 在OOP中，他们使用IoC容器来解决这个问题，但是在这里我们无法做到这一点，因为我们什至没有对象，因此拥有静态函数。 </p><br><p> 我们将为此使用<code>Interpreter pattern</code> ！ 这有点棘手，主要是因为它不熟悉，但是我会尽力解释这种模式。 首先，让我们谈谈功能组合。 例如，我们有一个函数<code>int -&gt; string</code> 。 这意味着函数期望将<code>int</code>作为参数并返回字符串。 现在，我们有另一个函数<code>string -&gt; char</code> 。 在这一点上，我们可以将它们链接起来，即执行第一个，将其输出并提供给第二个函数，甚至还有一个运算符： <code>&gt;&gt;</code> 。 运作方式如下： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> intToString (i: int) = i.<span class="hljs-type"><span class="hljs-type">ToString</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> firstCharOrSpace (s: string) = match s with | (null| <span class="hljs-string"><span class="hljs-string">""</span></span>) -&gt; ' ' | s -&gt; s.[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> firstDigitAsChar = intToString &gt;&gt; firstCharOrSpace //<span class="hljs-comment"><span class="hljs-comment">-- And you can chain as many functions as you like let alwaysTrue = intToString &gt;&gt; firstCharOrSpace &gt;&gt; Char.IsDigit</span></span></code> </pre> <br><p> 但是，在某些情况下，例如激活卡，我们不能使用简单的链接。 以下是一系列操作： </p><br><ul><li> 验证输入卡号。 如果有效的话 </li><li> 尝试通过此号码获取卡。 如果有一个 </li><li> 激活它。 </li><li> 保存结果。 如果可以的话 </li><li> 映射到模型并返回。 </li></ul><br><p> 前两个步骤具有以下条件： <code>If it's ok then...</code> 这就是直接链接不起作用的原因。 </p><br><p> 我们可以简单地将这些函数作为参数注入，如下所示： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> activateCard getCardAsync saveCardAsync cardNumber = ...</code> </pre> <br><p> 但这有一些问题。 首先，依赖项的数量可能会变大，并且函数签名将变得难看。 其次，我们在这里与特定的效果有关：我们必须选择是<code>Task</code>还是<code>Async</code>还是普通的同步调用。 第三，当您传递了许多函数时，很容易弄乱事情：例如<code>createUserAsync</code>和<code>replaceUserAsync</code>具有相同的签名但效果不同，因此当您必须传递数百次时，您可能会犯一个真正奇怪的症状的错误。 由于这些原因，我们选择了口译员。 </p><br><p> 想法是将合成代码分为两部分：执行树和该树的解释器。 该树中的每个节点都是一个函数的位置，该函数具有我们要注入的效果，例如<code>getUserFromDatabase</code> 。 这些节点由名称（例如<code>getCard</code> ，输入参数类型（例如<code>CardNumber</code>和返回类型（例如<code>Card option</code> 。 我们此处未指定<code>Task</code>或<code>Async</code> ，这不是树的一部分， <em>而是解释器的一部分</em> 。 这棵树的每一个边缘都是一系列纯转换，例如验证或业务逻辑功能执行。 边缘也有一些输入，例如原始的字符串卡号，然后是验证，这可能会给我们带来错误或有效的卡号。 如果有错误，我们将中断该边缘，如果没有，它将导致我们到达下一个节点： <code>getCard</code> 。 如果此节点将返回<code>Some card</code> ，我们可以继续到下一个边缘，即激活，依此类推。 </p><br><p> 对于像<code>topUp</code>或<code>topUp</code>或<code>topUp</code>这样的每种情况，我们将构建一个单独的树。 当那些树被构建时，它们的节点有点空白，它们中没有真正的功能， <em>它们有放置</em>这些功能的位置。 解释器的目标是填充这些节点，就这么简单。 解释器知道我们使用的效果，例如<code>Task</code> ，并且知道要在给定节点中放置哪个实函数。 当它访问节点时，它执行相应的实函数，在<code>Task</code>或<code>Async</code>情况下等待它，并将结果传递到下一个边缘。 该边缘可能会导致另一个节点，然后再次为解释器工作，直到该解释器到达停止节点（递归的底部）为止，在该节点处，我们只返回树的整个执行结果。 </p><br><p> 整个树将用有区别的联合表示，并且一个节点如下所示： </p><br><pre> <code class="haskell hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'a&gt; = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">option</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) //</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">-- &lt;- THE NODE | ... //-- ANOTHER NODE</span></span></span></span></code> </pre> <br><p> 它始终是一个元组，其中第一个元素是依赖项的输入，最后一个元素是<em>function</em> ，该<em>函数</em>接收该依赖项的结果。 元组的这些元素之间的“空格”就是您的依赖项所适合的地方，例如在那些合成示例中，您具有函数<code>'a -&gt; 'b</code> ， <code>'c -&gt; 'd</code>并且您需要放置另一个<code>'b -&gt; 'c</code>在它们之间进行连接。 </p><br><p> 由于我们位于有限的上下文中，因此我们不应该有太多的依赖关系，如果有的话，这可能是时候将上下文拆分成较小的依赖项了。 </p><br><p> 看起来是这样，完整的源代码在<a href="">这里</a> ： </p><br><pre> <code class="haskell hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'a&gt; = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">option</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> * ((</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class">*</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountInfo</span></span></span><span class="hljs-class">) option -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'a&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class"> of (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class">*</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountInfo</span></span></span><span class="hljs-class">) * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Result</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRelatedError</span></span></span><span class="hljs-class">&gt; -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Result</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRelatedError</span></span></span><span class="hljs-class">&gt; -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class"> * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">option</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserInfo</span></span></span><span class="hljs-class"> * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Result</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRelatedError</span></span></span><span class="hljs-class">&gt; -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class"> of (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class"> * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTimeOffset</span></span></span><span class="hljs-class"> * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTimeOffset</span></span></span><span class="hljs-class">) * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BalanceOperation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BalanceOperation</span></span></span><span class="hljs-class"> * (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Result</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRelatedError</span></span></span><span class="hljs-class">&gt; -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class"> of 'a (*</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">{- This bind function allows you to pass a continuation for current node of your expression tree the code is basically a boiler plate, as you can see. -}</span></span></span><span class="hljs-class">*) let rec bind f instruction = match instruction with | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">,(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">,(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">,(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">,(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class"> x -&gt; fx (*</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">{- This is a set of basic functions. Use them in your expression tree builder to represent dependency call -}</span></span></span><span class="hljs-class">*) let stop x = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class"> x let getCardByNumber number = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">number</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class">) let getCardWithAccountInfo number = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">number</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class">) let createNewCard (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">acc</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">acc</span></span></span><span class="hljs-class">), stop) let replaceCard card = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class">) let getUserById id = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class">) let createNewUser user = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class">) let getBalanceOperations (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">number</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fromDate</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toDate</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">number</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fromDate</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toDate</span></span></span><span class="hljs-class">), stop) let saveBalanceOperation op = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">op</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p> With a help of <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">computation expressions</a> , we now have a very easy way to build our workflows without having to care about implementation of real-world interactions. We do that in <a href="">CardWorkflow module</a> : </p><br><pre> <code class="haskell hljs">(*<span class="hljs-comment"><span class="hljs-comment">{- `program` is the name of our computation expression. In every `let!` binding we unwrap the result of operation, which can be either `Program&lt;'a&gt;` or `Program&lt;Result&lt;'a, Error&gt;&gt;`. What we unwrap would be of type 'a. If, however, an operation returns `Error`, we stop the execution at this very step and return it. The only thing we have to take care of is making sure that type of error is the same in every operation we call -}</span></span>*) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> processPayment (currentDate: <span class="hljs-type"><span class="hljs-type">DateTimeOffset</span></span>, payment) = program { (*<span class="hljs-comment"><span class="hljs-comment">{- You can see these `expectValidationError` and `expectDataRelatedErrors` functions here. What they do is map different errors into `Error` type, since every execution branch must return the same type, in this case `Result&lt;'a, Error&gt;`. They also help you quickly understand what's going on in every line of code: validation, logic or calling external storage. -}</span></span>*) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! cmd = validateProcessPaymentCommand payment |&gt; expectValidationError <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! card = tryGetCard cmd.<span class="hljs-type"><span class="hljs-type">CardNumber</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> today = currentDate.<span class="hljs-type"><span class="hljs-type">Date</span></span> |&gt; <span class="hljs-type"><span class="hljs-type">DateTimeOffset</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> tomorrow = currentDate.<span class="hljs-type"><span class="hljs-type">Date</span></span>.<span class="hljs-type"><span class="hljs-type">AddDays</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span> |&gt; <span class="hljs-type"><span class="hljs-type">DateTimeOffset</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! operations = getBalanceOperations (cmd.<span class="hljs-type"><span class="hljs-type">CardNumber</span></span>, today, tomorrow) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> spentToday = <span class="hljs-type"><span class="hljs-type">BalanceOperation</span></span>.spentAtDate currentDate cmd.<span class="hljs-type"><span class="hljs-type">CardNumber</span></span> operations <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! (card, op) = <span class="hljs-type"><span class="hljs-type">CardActions</span></span>.processPayment currentDate spentToday card cmd.<span class="hljs-type"><span class="hljs-type">PaymentAmount</span></span> |&gt; expectOperationNotAllowedError <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>! saveBalanceOperation op |&gt; expectDataRelatedErrorProgram <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>! replaceCard card |&gt; expectDataRelatedErrorProgram return card |&gt; toCardInfoModel |&gt; <span class="hljs-type"><span class="hljs-type">Ok</span></span> }</code> </pre> <br><p> This module is the last thing we need to implement in business layer. Also, I've done some refactoring: I moved errors and common types to <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Common project</a> . About time we moved on to implementing data access layer. </p><br><h3 id="data-access-layer"> Data access layer </h3><br><p> The design of entities in this layer may depend on our database or framework we use to interact with it. Therefore domain layer doesn't know anything about these entities, which means we have to take care of mapping to and from domain models in here. Which is quite convenient for consumers of our DAL API. For this application I've chosen MongoDB, not because it's a best choice for this kind of task, but because there're many examples of using SQL DBs already and I wanted to add something different. We are gonna use C# driver. </p><br><p> For the most part it's gonna be pretty strait forward, the only tricky moment is with <code>Card</code> . When it's active it has an <code>AccountInfo</code> inside, when it's not it doesn't. So we have to split it in two documents: <code>CardEntity</code> and <code>CardAccountInfoEntity</code> , so that deactivating card doesn't erase information about balance and daily limit. </p><br><p> Other than that we just gonna use primitive types instead of discriminated unions and types with built-in validation. </p><br><p> There're also few things we need to take care of, since we are using C# library: </p><br><ul><li> Convert <code>null</code> s to <code>Option&lt;'a&gt;</code> </li><li> Catch expected exceptions and convert them to our errors and wrap it in <code>Result&lt;_,_&gt;</code> </li></ul><br><p> We start with <a href="">CardDomainEntities module</a> , where we define our entities: </p><br><pre> <code class="haskell hljs"> [&lt;<span class="hljs-type"><span class="hljs-type">CLIMutable</span></span>&gt;] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardEntity</span></span></span><span class="hljs-class"> = { [&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BsonId</span></span></span><span class="hljs-class">&gt;] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CardNumber</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Name</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsActive</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bool</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExpirationMonth</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExpirationYear</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserId</span></span></span><span class="hljs-class"> } with //</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">-- we're gonna need this in every entity for error messages member this.EntityId = this.CardNumber.ToString() (*{- we use this Id comparer quotation (F# alternative to C# Expression) for updating entity by id, since for different entities identifier has different name and type -}*) member this.IdComparer = &lt;@ System.Func&lt;_,_&gt; (fun c -&gt; c.CardNumber = this.CardNumber) @&gt;</span></span></span></span></code> </pre> <br><p> Those fields <code>EntityId</code> and <code>IdComparer</code> we are gonna use with a help of <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SRTP</a> . We'll define functions that will retrieve them from any type that has those fields define, without forcing every entity to implement some interface: </p><br><pre> <code class="haskell hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> inline (|<span class="hljs-type"><span class="hljs-type">HasEntityId</span></span>|) x = fun () -&gt; (^a : (member <span class="hljs-type"><span class="hljs-type">EntityId</span></span>: string) x) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> inline entityId (<span class="hljs-type"><span class="hljs-type">HasEntityId</span></span> f) = f() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> inline (|<span class="hljs-type"><span class="hljs-type">HasIdComparer</span></span>|) x = fun () -&gt; (^a : (member <span class="hljs-type"><span class="hljs-type">IdComparer</span></span>: <span class="hljs-type"><span class="hljs-type">Quotations</span></span>.<span class="hljs-type"><span class="hljs-type">Expr</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Func</span></span>&lt; ^a, bool&gt;&gt;) x) //<span class="hljs-comment"><span class="hljs-comment">-- We need to convert F# quotations to C# expressions //-- which C# mongo db driver understands. let inline idComparer (HasIdComparer id) = id() |&gt; LeafExpressionConverter.QuotationToExpression |&gt; unbox&lt;Expression&lt;Func&lt;_,_&gt;&gt;&gt;</span></span></code> </pre> <br><p> As for <code>null</code> and <code>Option</code> thing, since we use record types, F# compiler doesn't allow using <code>null</code> value, neither for assigning nor for comparison. At the same time record types are just another CLR types, so technically we can and will get a <code>null</code> value, thanks to C# and design of this library. We can solve this in 2 ways: use <code>AllowNullLiteral</code> attribute, or use <code>Unchecked.defaultof&lt;'a&gt;</code> . I went for the second choice since this <code>null</code> situation should be localized as much as possible: </p><br><pre> <code class="haskell hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isNullUnsafe (arg: 'a when 'a: not struct) = arg = <span class="hljs-type"><span class="hljs-type">Unchecked</span></span>.defaultof&lt;'a&gt; //<span class="hljs-comment"><span class="hljs-comment">-- then we have this function to convert nulls to option, //-- therefore we limited this toxic null thing in here. let unsafeNullToOption a = if isNullUnsafe a then None else Some a</span></span></code> </pre> <br><p> In order to deal with expected exception for duplicate key, we use Active Patterns again: </p><br><pre> <code class="haskell hljs"> //<span class="hljs-comment"><span class="hljs-comment">-- First we define a function which checks, whether exception is about duplicate key let private isDuplicateKeyException (ex: Exception) = ex :? MongoWriteException &amp;&amp; (ex :?&gt; MongoWriteException).WriteError.Category = ServerErrorCategory.DuplicateKey //-- Then we have to check wrapping exceptions for this let rec private (|DuplicateKey|_|) (ex: Exception) = match ex with | :? MongoWriteException as ex when isDuplicateKeyException ex -&gt; Some ex | :? MongoBulkWriteException as bex when bex.InnerException |&gt; isDuplicateKeyException -&gt; Some (bex.InnerException :?&gt; MongoWriteException) | :? AggregateException as aex when aex.InnerException |&gt; isDuplicateKeyException -&gt; Some (aex.InnerException :?&gt; MongoWriteException) | _ -&gt; None //-- And here's the usage: let inline private executeInsertAsync (func: 'a -&gt; Async&lt;unit&gt;) arg = async { try do! func(arg) return Ok () with | DuplicateKey ex -&gt; return EntityAlreadyExists (arg.GetType().Name, (entityId arg)) |&gt; Error }</span></span></code> </pre> <br><p> After mapping is implemented we have everything we need to assemble <a href="">API for our data access layer</a> , which looks like this: </p><br><pre> <code class="haskell hljs"> //<span class="hljs-comment"><span class="hljs-comment">-- `MongoDb` is a type alias for `IMongoDatabase` let replaceUserAsync (mongoDb: MongoDb) : ReplaceUserAsync = fun user -&gt; user |&gt; DomainToEntityMapping.mapUserToEntity |&gt; CommandRepository.replaceUserAsync mongoDb let getUserInfoAsync (mongoDb: MongoDb) : GetUserInfoAsync = fun userId -&gt; async { let! userInfo = QueryRepository.getUserInfoAsync mongoDb userId return userInfo |&gt; Option.map EntityToDomainMapping.mapUserInfoEntity }</span></span></code> </pre> <br><p> The last moment I mention is when we do mapping <code>Entity -&gt; Domain</code> , we have to instantiate types with built-in validation, so there can be validation errors. In this case we won't use <code>Result&lt;_,_&gt;</code> because if we've got invalid data in DB, it's a bug, not something we expect. So we just throw an exception. Other than that nothing really interesting is happening in here. The full source code of data access layer you'll find <a href="">here</a> . </p><br><h3 id="composition-logging-and-all-the-rest"> Composition, logging and all the rest </h3><br><p> As you remember, we're not gonna use DI framework, we went for interpreter pattern. If you want to know why, here's some reasons: </p><br><ul><li> IoC container operates in runtime. So until you run your program you can't know that all the dependencies are satisfied. </li><li> It's a powerful tool which is very easy to abuse: you can do property injection, use lazy dependencies, and sometimes even some business logic can find it's way in dependency registering/resolving (yeah, I've witnessed it). All of that makes code maintaining extremely hard. </li></ul><br><p> That means we need a place for that functionality. We could place it on a top level in our Web Api, but in my opinion it's not a best choice: right now we are dealing with only 1 bounded context, but if there's more, this global place with all the interpreters for each context will become cumbersome. Besides, there's single responsibility rule, and web api project should be responsible for web, right? So we create <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CardManagement.Infrastructure project</a> . </p><br><p> Here we will do several things: </p><br><ul><li> Composing our functionality </li><li> App configuration </li><li> Logging </li></ul><br><p> If we had more than 1 context, app configuration and log configuration should be moved to global infrastructure project, and the only thing happening in this project would be assembling API for our bounded context, but in our case this separation is not necessary. </p><br><p> Let's get down to composition. We've built execution trees in our domain layer, now we have to interpret them. Every node in that tree represents some dependency call, in our case a call to database. If we had a need to interact with 3rd party api, that would be in here also. So our interpreter has to know how to handle every node in that tree, which is verified in compile time, thanks to <code>&lt;TreatWarningsAsErrors&gt;</code> setting. Here's what it looks like: </p><br><pre> <code class="haskell hljs">(*<span class="hljs-comment"><span class="hljs-comment">{- Those `bindAsync (next &gt;&gt; interpretCardProgram mongoDb)` work pretty simple: we execute async function to the left of this expression, await that operation and pass the result to the next node, after which we interpret that node as well, until we reach the bottom of this recursion: `Stop a` node. -}</span></span>*) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> private interpretCardProgram mongoDb prog = match prog with | <span class="hljs-type"><span class="hljs-type">GetCard</span></span> (cardNumber, next) -&gt; cardNumber |&gt; getCardAsync mongoDb |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">GetCardWithAccountInfo</span></span> (number, next) -&gt; number |&gt; getCardWithAccInfoAsync mongoDb |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">CreateCard</span></span> ((card,acc), next) -&gt; (card, acc) |&gt; createCardAsync mongoDb |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">ReplaceCard</span></span> (card, next) -&gt; card |&gt; replaceCardAsync mongoDb |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">GetUser</span></span> (id, next) -&gt; getUserAsync mongoDb id |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">CreateUser</span></span> (user, next) -&gt; user |&gt; createUserAsync mongoDb |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">GetBalanceOperations</span></span> (request, next) -&gt; getBalanceOperationsAsync mongoDb request |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">SaveBalanceOperation</span></span> (op, next) -&gt; saveBalanceOperationAsync mongoDb op |&gt; bindAsync (next &gt;&gt; interpretCardProgram mongoDb) | <span class="hljs-type"><span class="hljs-type">Stop</span></span> a -&gt; async.<span class="hljs-type"><span class="hljs-type">Return</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> interpret prog = try <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> interpret = interpretCardProgram (getMongoDb()) interpret prog with | failure -&gt; <span class="hljs-type"><span class="hljs-type">Bug</span></span> failure |&gt; <span class="hljs-type"><span class="hljs-type">Error</span></span> |&gt; async.<span class="hljs-type"><span class="hljs-type">Return</span></span></code> </pre> <br><p> Note that this interpreter is the place where we have this <code>async</code> thing. We can do another interpreter with <code>Task</code> or just a plain sync version of it. Now you're probably wondering, how we can cover this with unit-test, since familiar mock libraries ain't gonna help us. Well, it's easy: you have to make another interpreter. Here's what it can look like: </p><br><pre> <code class="haskell hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveResult</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Result</span></span></span><span class="hljs-class">&lt;unit, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataRelatedError</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TestInterpreterConfig</span></span></span><span class="hljs-class"> = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">option</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class">: (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Card</span></span></span><span class="hljs-class">*</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccountInfo</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">option</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveResult</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveResult</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">option</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveResult</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BalanceOperation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveResult</span></span></span><span class="hljs-class"> } let defaultConfig = { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accountInfo</span></span></span><span class="hljs-class">) |&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ok</span></span></span><span class="hljs-class">() </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">balanceOperations</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ok</span></span></span><span class="hljs-class">() </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ok</span></span></span><span class="hljs-class">() </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ok</span></span></span><span class="hljs-class">() } let testInject a = fun _ -&gt; a let rec interpretCardProgram config (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prog</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;) = match prog with | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cardNumber</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; cardNumber |&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCard</span></span></span><span class="hljs-class"> |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">number</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; number |&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCardWithAccountInfo</span></span></span><span class="hljs-class"> |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">acc</span></span></span><span class="hljs-class">), next) -&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">acc</span></span></span><span class="hljs-class">) |&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCard</span></span></span><span class="hljs-class"> |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; card |&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReplaceCard</span></span></span><span class="hljs-class"> |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; id |&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUser</span></span></span><span class="hljs-class"> |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; user |&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateUser</span></span></span><span class="hljs-class"> |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBalanceOperations</span></span></span><span class="hljs-class"> request |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">op</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">) -&gt; testInject config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SaveBalanceOperation</span></span></span><span class="hljs-class"> op |&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> &gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpretCardProgram</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class"> a -&gt; a</span></span></code> </pre> <br><p> We've created <code>TestInterpreterConfig</code> which holds desired results of every operation we want to inject. You can easily change that config for every given test and then just run interpreter. This interpreter is sync, since there's no reason to bother with <code>Task</code> or <code>Async</code> . </p><br><p> There's nothing really tricky about the logging, but you can find it in <a href="">this module</a> . The approach is that we wrap the function in logging: we log function name, parameters and log result. If result is ok, it's info, if error it's a warning and if it's a <code>Bug</code> then it's an error. That's pretty much it. </p><br><p> One last thing is to make a facade, since we don't want to expose raw interpreter calls. Here's the whole thing: </p><br><pre> <code class="haskell hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> createUser arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.createUser &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.createUser"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> createCard arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.createCard &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.createCard"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> activateCard arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.activateCard &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.activateCard"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> deactivateCard arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.deactivateCard &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.deactivateCard"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> processPayment arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.processPayment &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.processPayment"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> topUp arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.topUp &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.topUp"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> setDailyLimit arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.setDailyLimit &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.setDailyLimit"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> getCard arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.getCard &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpret |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.getCard"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> getUser arg = arg |&gt; (<span class="hljs-type"><span class="hljs-type">CardWorkflow</span></span>.getUser &gt;&gt; <span class="hljs-type"><span class="hljs-type">CardProgramInterpreter</span></span>.interpretSimple |&gt; logifyResultAsync <span class="hljs-string"><span class="hljs-string">"CardApi.getUser"</span></span>)</code> </pre> <br><p> All the dependencies here are injected, logging is taken care of, no exceptions is thrown — that's it. For web api I used <a href="">Giraffe</a> framework. Web project is <a href="">here</a> . </p><br><h2 id="conclusion"> 结论 </h2><br><p> We have built an application with validation, error handling, logging, business logic — all those things you usually have in your application. The difference is this code is way more durable and easy to refactor. Note that we haven't used reflection or code generation, no exceptions, but still our code isn't verbose. It's easy to read, easy to understand and hard to break. As soon as you add another field in your model, or another case in one of our union types, the code won't compile until you update every usage. Sure it doesn't mean you're totally safe or that you don't need any kind of testing at all, it just means that you're gonna have fewer problems when you develope new features or do some refactoring. The development process will be both cheaper and more interesting, because this tool allows you to focus on your domain and business tasks, instead of drugging focus on keeping an eye out that nothing is broken. </p><br><p> Another thing: I don't claim that OOP is completely useless and we don't need it, that's not true. I'm saying that we don't need it for solving <em>every single task</em> we have, and that a big portion of our tasks can be better solved with FP. And truth is, as always, in balance: we can't solve everything efficiently with only one tool, so a good programming language should have a decent support of both FP and OOP. And, unfortunately, a lot of most popular languages today have only lambdas and async programming from functional world. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN458730/">https://habr.com/ru/post/zh-CN458730/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN458718/index.html">Java JIT编译之父Cliff Click的大型访谈</a></li>
<li><a href="../zh-CN458720/index.html">hh.ru程序员学校第十次开设了一组IT专家</a></li>
<li><a href="../zh-CN458724/index.html">神经网络和深度学习，第3章，第1部分：改进神经网络的训练方式</a></li>
<li><a href="../zh-CN458726/index.html">Habr Special //与Invasion的作者一起播客。 俄罗斯黑客简史</a></li>
<li><a href="../zh-CN458728/index.html">什么是电动自行车（来自两个制造商的五种型号的团体评测），第2部分</a></li>
<li><a href="../zh-CN458732/index.html">GIS？ 还是非gIS？ 那是问题</a></li>
<li><a href="../zh-CN458734/index.html">数据中心的工作日：连续7年的运作无懈可击。 关于老鼠的延续</a></li>
<li><a href="../zh-CN458738/index.html">物质与反物质：是什么，区别是什么，中微子与它有什么关系</a></li>
<li><a href="../zh-CN458740/index.html">耶和华吩咐：“面试并接受要约”</a></li>
<li><a href="../zh-CN458742/index.html">Kirill Tolkachev和Maxim Gorelikov谈jug.msk.ru上的Spring Boot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>