<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîé üíå üí∞ Lecciones aprendidas de las pruebas M√°s de 200,000 l√≠neas de C√≥digo de Infraestructura ‚úäüèº üë® üë©üèΩ‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IaC (Infraestructura como c√≥digo) es un enfoque moderno y creo que la infraestructura es c√≥digo. Significa que debemos usar la misma filosof√≠a para la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lecciones aprendidas de las pruebas M√°s de 200,000 l√≠neas de C√≥digo de Infraestructura</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467169/"><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  <strong>IaC</strong> (Infraestructura como c√≥digo) es un enfoque moderno y creo que la infraestructura es c√≥digo.  Significa que debemos usar la misma filosof√≠a para la infraestructura que para el desarrollo de software.  Si estamos hablando de que la infraestructura es c√≥digo, entonces deber√≠amos reutilizar las pr√°cticas del desarrollo para infraestructura, es decir, pruebas unitarias, programaci√≥n de pares, revisi√≥n de c√≥digo.  Tenga en cuenta esta idea mientras lee el art√≠culo. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n rusa</a> </p><a name="habracut"></a><br><p>  Es la traducci√≥n de mi discurso ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video RU</a> ) en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DevopsConf 2019-05-28</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Diapositivas y videos</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n rusa</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n rusa</a> </li><li>  Carrera en seco 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DINS DevOps TARDE 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Diapositivas</a> </li></ul></div></div><br><h1 id="infrastructure-as-bash-history">  Infraestructura como historia bash </h1><br><p><img src="https://habrastorage.org/webt/i_/yl/fm/i_ylfms8w-9pgisnujlu-iv1u3y.png"></p><br><p>  Imaginemos que se est√° incorporando a un proyecto y escucha algo como: "Usamos <em>Infraestructura como</em> enfoque de <em>C√≥digo</em> ".  Desafortunadamente, lo que realmente significan es <em>Infraestructura como historial de bash</em> o <em>Documentaci√≥n como historial de bash</em> .  Esta es casi una situaci√≥n real.  Por ejemplo, Denis Lysenko describi√≥ esta situaci√≥n en su discurso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥mo reemplazar la infraestructura y dejar de preocuparse (RU)</a> .  Denis comparti√≥ la historia sobre c√≥mo convertir el historial de bash en una infraestructura de primer nivel. </p><br><p> Verifiquemos la definici√≥n del c√≥digo fuente: <code>a text listing of commands to be compiled or assembled into an executable computer program</code> .  Si queremos, podemos presentar <em>Infraestructura como historial de bash</em> como c√≥digo.  Este es un texto y una lista de comandos.  Describe c√≥mo se configur√≥ un servidor.  Adem√°s, es: </p><br><ol><li>  <em>Reproducible</em> : puede obtener el historial de bash, ejecutar comandos y probablemente obtener infraestructura de trabajo. </li><li>  <em>Versiones</em> : sabes qui√©n inici√≥ sesi√≥n, cu√°ndo y qu√© se hizo. <br>  Desafortunadamente, si pierde el servidor, no podr√° hacer nada porque no hay historial de bash, lo perdi√≥ con el servidor. </li></ol><br><p>  ¬øQu√© hay que hacer? </p><br><h1 id="infrastructure-as-code">  Infraestructura como c√≥digo </h1><br><p><img src="https://habrastorage.org/webt/gm/3e/wf/gm3ewf7g3w72takvuffsxhcbgoy.png"></p><br><p>  Por un lado, este caso anormal, <em>Infraestructura como historial de bash</em> , se puede presentar como <em>Infraestructura como C√≥digo</em> , pero por otro lado, si desea hacer algo m√°s complejo que el servidor LAMP, debe administrar, mantener y modificar el c√≥digo .  Hablemos sobre paralelismos entre <em>Infraestructura como</em> desarrollo de <em>C√≥digo</em> y desarrollo de software. </p><br><h2 id="dry">  SECO </h2><br><p><img src="https://habrastorage.org/webt/rx/qa/vf/rxqavfjxrtmtwkjzzq4prr72oao.png"></p><br><p>  Est√°bamos desarrollando SDS (almacenamiento definido por software).  El SDS consist√≠a en un sistema operativo personalizado, servidores exclusivos, mucha l√≥gica de negocios, como resultado, ten√≠a que usar hardware real.  Peri√≥dicamente, hab√≠a una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SDS de instalaci√≥n de</a> subtarea.  Antes de publicar un nuevo lanzamiento, tuvimos que instalarlo y revisarlo.  Al principio, parec√≠a que era una tarea muy simple: </p><br><ul><li>  SSH para alojar y ejecutar el comando. </li><li>  SCP un archivo. </li><li>  Modificar una configuraci√≥n. </li><li>  Ejecuta un servicio. </li><li>  ... </li><li>  BENEFICIOS! </li></ul><br><p>  Creo que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Make CM, not bash</a> es un buen enfoque.  Sin embargo, bash solo se usa en casos extremos y limitados, como al comienzo de un proyecto.  Entonces, bash fue una elecci√≥n bastante buena y razonable al comienzo del proyecto.  El tiempo pasaba.  Nos enfrentamos a diferentes solicitudes para crear nuevas instalaciones en una configuraci√≥n ligeramente diferente.  Est√°bamos introduciendo SSH en las instalaciones y ejecutando los comandos para instalar todo el software necesario, editando los archivos de configuraci√≥n mediante scripts y, finalmente, configurando SDS a trav√©s de la API de descanso Web HTTP.  Despu√©s de todo eso, la instalaci√≥n se configur√≥ y funcion√≥.  Esta era una pr√°ctica bastante com√∫n, pero hab√≠a muchos scripts de bash y la l√≥gica de instalaci√≥n se volv√≠a m√°s compleja cada d√≠a. </p><br><p>  Desafortunadamente, cada gui√≥n era como un peque√±o copo de nieve dependiendo de qui√©n lo copiaba.  Tambi√©n fue un verdadero dolor cuando est√°bamos creando o recreando la instalaci√≥n. </p><br><p>  Espero que tengas la idea principal, que en esta etapa tuvimos que modificar constantemente la l√≥gica de los scripts hasta que el servicio estuvo bien.  Pero, hab√≠a una soluci√≥n para eso.  Estaba seco </p><br><p><img src="https://habrastorage.org/webt/-u/ep/cv/-uepcvi1kjsnruflehy0noydk1k.png"></p><br><p>  Hay un enfoque SECO (no repetir).  La idea principal es reutilizar el c√≥digo ya existente.  Suena extremadamente simple.  En nuestro caso, DRY significaba: configuraciones y scripts divididos. </p><br><h2 id="solid-for-cfm">  S√ìLIDO para CFM </h2><br><p><img src="https://habrastorage.org/webt/kt/7f/ba/kt7fbazyy0arjwrnlwgoynqbvqg.png"></p><br><p>  El proyecto estaba creciendo, como resultado, decidimos usar Ansible.  Hab√≠a razones para eso: </p><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bash no debe contener l√≥gica compleja</a> . </li><li>  Ten√≠amos cierta experiencia en Ansible. </li></ol><br><p>  Hab√≠a una cantidad de l√≥gica de negocios dentro del c√≥digo Ansible.  Hay un enfoque para poner cosas en el c√≥digo fuente durante el proceso de desarrollo de software.  Se llama <em>S√ìLIDO</em> .  Desde mi punto de vista, podemos reutilizar <em>SOLID</em> para <em>Infraestructura como C√≥digo</em> .  D√©jame explicarte paso a paso. </p><br><h3 id="the-single-responsibility-principle">  El principio de responsabilidad √∫nica </h3><br><p><img src="https://habrastorage.org/webt/yh/h7/kg/yhh7kgr1jal27ddvpeydqxcmzog.png"></p><br><p>  <em>Una clase solo debe tener una responsabilidad √∫nica, es decir, solo los cambios en una parte de la especificaci√≥n del software deben poder afectar la especificaci√≥n de la clase.</em> </p><br><p>  No debe crear un c√≥digo de espagueti dentro de su c√≥digo de infraestructura.  Su infraestructura debe estar hecha de simples ladrillos predecibles.  En otras palabras, podr√≠a ser una buena idea dividir el inmenso libro de jugadas de Ansible en roles independientes de Ansible.  Ser√° m√°s f√°cil de mantener. </p><br><h3 id="the-open-closed-principle">  Los principios abiertos y cerrados </h3><br><p><img src="https://habrastorage.org/webt/g6/ym/qn/g6ymqn8vohwbewqx7hgixuiuuf8.png"></p><br><p>  <em>Las entidades de software ... deben estar abiertas para extensi√≥n, pero cerradas para modificaci√≥n.</em> </p><br><p>  Al principio, est√°bamos implementando el SDS en m√°quinas virtuales, un poco m√°s tarde agregamos la <em>implementaci√≥n a los servidores b√°sicos</em> .  Lo habiamos hecho.  Para nosotros fue tan f√°cil porque simplemente agregamos una implementaci√≥n para piezas espec√≠ficas de metal sin modificar la l√≥gica de instalaci√≥n de SDS. </p><br><h3 id="the-liskov-substitution-principle">  El principio de sustituci√≥n de Liskov </h3><br><p><img src="https://habrastorage.org/webt/1x/-4/am/1x-4am1tjecrhxx3jm7bfur00oy.png"></p><br><p>  <em>Los objetos en un programa deben ser reemplazables con instancias de sus subtipos sin alterar la correcci√≥n de ese programa.</em> </p><br><p>  Seamos de mente abierta.  <em>SOLID</em> es posible de usar en CFM en general, no fue un proyecto afortunado.  Me gustar√≠a describir otro proyecto.  Es una soluci√≥n empresarial lista para usar.  Admite diferentes bases de datos, servidores de aplicaciones e interfaces de integraci√≥n con sistemas de terceros.  Voy a usar este ejemplo para describir el resto de <em>SOLID</em> </p><br><p>  Por ejemplo, en nuestro caso, hay un acuerdo dentro del equipo de infraestructura: si implementa el rol ibm java o oracle java o openjdk, tendr√° un binario ejecutable de java.  Lo necesitamos porque los roles de nivel superior * Ansible dependen de eso.  Adem√°s, nos permite intercambiar la implementaci√≥n de Java sin modificar la l√≥gica de instalaci√≥n de la aplicaci√≥n. </p><br><p>  Desafortunadamente, no hay az√∫car de sintaxis para eso en los libros de jugadas de Ansible.  Significa que debe tenerlo en cuenta al desarrollar roles de Ansible. </p><br><h3 id="the-interface-segregation-principle">  El principio de segregaci√≥n de interfaz </h3><br><p><img src="https://habrastorage.org/webt/v2/9r/wa/v29rwalnqryarhrwe-_r8jvx0go.png"></p><br><p>  <em>Muchas interfaces espec√≠ficas del cliente son mejores que una interfaz de prop√≥sito general.</em> </p><br><p>  Al principio, est√°bamos poniendo la l√≥gica de instalaci√≥n de la aplicaci√≥n en el libro de jugadas √∫nico, est√°bamos tratando de cubrir todos los casos y bordes de corte.  Enfrentamos el problema que es dif√≠cil de mantener, por lo que cambiamos nuestro enfoque.  Entendimos que un cliente necesita una interfaz nuestra (es decir, https en el puerto 443) y pudimos combinar nuestros roles de Ansible para cada entorno espec√≠fico. </p><br><h3 id="the-dependency-inversion-principle">  El principio de inversi√≥n de dependencia </h3><br><p><img src="https://habrastorage.org/webt/ee/ip/e8/eeipe8nr7hbjx18yxtoxsekwlfy.png"></p><br><p>  <em>Uno deber√≠a "depender de abstracciones, [no] concreciones".</em> </p><br><ul><li>  <em>Los m√≥dulos de alto nivel no deber√≠an depender de los m√≥dulos de bajo nivel.</em>  <em>Ambos deber√≠an depender de abstracciones (por ejemplo, interfaces).</em> </li><li>  <em>Las abstracciones no deber√≠an depender de los detalles.</em>  <em>Los detalles (implementaciones concretas) deben depender de abstracciones.</em> </li></ul><br><p>  Me gustar√≠a describir este principio a trav√©s de antipatr√≥n. </p><br><ol><li>  Hab√≠a un cliente con una nube privada. </li><li>  Est√°bamos solicitando m√°quinas virtuales en la nube. </li><li>  Nuestra l√≥gica de implementaci√≥n depend√≠a de en qu√© hipervisor se ubicara una m√°quina virtual. </li></ol><br><p>  En otras palabras, no pudimos reutilizar nuestro IaC en otra nube porque la l√≥gica de implementaci√≥n de nivel superior depend√≠a de la implementaci√≥n de nivel inferior.  <strong>Por favor no lo hagas</strong> </p><br><h1 id="interaction">  Interacci√≥n </h1><br><p><img src="https://habrastorage.org/webt/rd/7_/8r/rd7_8rtprcz4xjkuhctjppbkcuu.png"></p><br><p>  La infraestructura no es solo c√≥digo, tambi√©n se trata de c√≥digo de interacci√≥n &lt;-&gt; DevOps, DevOps &lt;-&gt; DevOps, IaC &lt;-&gt; personas. </p><br><h2 id="bus-factor">  Factor de bus </h2><br><p><img src="https://habrastorage.org/webt/p5/4-/wh/p54-whkhcglorvk_dlt0b1jpajy.png"></p><br><p>  Imaginemos que hay un ingeniero de DevOps, John.  John sabe todo sobre su infraestructura.  Si John es atropellado por un autob√∫s, ¬øqu√© pasar√° con su infraestructura?  Desafortunadamente, es casi un caso real.  Algunas veces suceden cosas.  Si ha sucedido y no comparte conocimientos sobre IaC, la infraestructura entre los miembros de su equipo enfrentar√° muchas consecuencias impredecibles e inc√≥modas.  Hay algunos enfoques para lidiar con eso.  Hablemos sobre ellos. </p><br><h2 id="pair-devopsing">  Par DevOpsing </h2><br><p><img src="https://habrastorage.org/webt/6q/0l/t0/6q0lt0afzbkpivxxp4uvryxgake.png"></p><br><p>  Es como la programaci√≥n en pareja.  En otras palabras, hay dos ingenieros de DevOps y usan una sola computadora port√°til / teclado para configurar la infraestructura: configurar un servidor, crear un rol Ansible, etc.  Suena genial, sin embargo, no funcion√≥ para nosotros.  Hubo algunos casos personalizados cuando funcion√≥ parcialmente. </p><br><ul><li>  <em>Incorporaci√≥n</em> : el mentor y la nueva persona obtienen una tarea real de un trabajo atrasado y trabajan juntos: transfieren el conocimiento del mentor a la persona. </li><li>  <em>Llamada a incidentes</em> : durante la resoluci√≥n de problemas, hay un grupo de ingenieros que buscan una soluci√≥n.  El punto clave es que hay una persona que lidera este incidente.  La persona comparte pantalla e ideas.  Otras personas lo siguen cuidadosamente y se dan cuenta de trucos, errores, an√°lisis de registros, etc. </li></ul><br><h2 id="code-review">  Revisi√≥n de c√≥digo </h2><br><p><img src="https://habrastorage.org/webt/wk/u6/vn/wku6vntzzsquckgu58n1_r3tg-i.png"></p><br><p>  Desde mi punto de vista, la <em>revisi√≥n de c√≥digo</em> es una de las formas m√°s eficientes de compartir conocimientos dentro de un equipo sobre su infraestructura.  Como funciona </p><br><ul><li>  Hay un repositorio que contiene la descripci√≥n de su infraestructura. </li><li>  Todos est√°n haciendo sus cambios en una rama dedicada. </li><li>  Durante la solicitud de fusi√≥n, puede revisar delta de cambios en su infraestructura. </li></ul><br><p>  Lo m√°s interesante es que est√°bamos rotando un revisor.  Significa que cada dos d√≠as elegimos un nuevo revisor y el revisor estaba revisando todas las solicitudes de fusi√≥n.  Como resultado, te√≥ricamente, cada persona ten√≠a que tocar una nueva parte de la infraestructura y ten√≠a un conocimiento promedio sobre nuestra infraestructura en general. </p><br><h3 id="code-style">  Estilo de c√≥digo </h3><br><p><img src="https://habrastorage.org/webt/qa/fz/ju/qafzju1vc86llmvcc1m4urpfa7c.png"></p><br><p>  El tiempo pasaba, a veces discut√≠amos durante la revisi√≥n porque el revisor y el confirmador podr√≠an usar un estilo de c√≥digo diferente: 2 espacios o 4, <em>camelCase</em> o <em>snake_case</em> .  Lo implementamos, sin embargo, no fue un picnic. </p><br><ul><li>  La primera idea fue recomendar el uso de linters.  Todos ten√≠an su propio entorno de desarrollo: IDE, OS ... era complicado sincronizar y unificar todo. </li><li>  La idea se convirti√≥ en un bot flojo.  Despu√©s de cada confirmaci√≥n, el bot estaba revisando el c√≥digo fuente y presionando mensajes flojos con una lista de problemas.  Desafortunadamente, en la gran mayor√≠a de los casos, no hubo cambios en el c√≥digo fuente despu√©s de los mensajes. </li></ul><br><h3 id="green-build-master">  Maestro de construcci√≥n verde </h3><br><p><img src="https://habrastorage.org/webt/lw/ow/xi/lwowxis0izoohgthm9db7nheih4.png"></p><br><p>  Luego, el paso m√°s doloroso fue restringir el empuje a la rama maestra para todos.  Solo a trav√©s de solicitudes de fusi√≥n y pruebas verdes tienen que estar bien.  Esto se llama <em>Green Build Master</em> .  En otras palabras, est√° 100% seguro de que puede implementar su infraestructura desde la rama maestra.  Es una pr√°ctica bastante com√∫n en el desarrollo de software: </p><br><ul><li>  Hay un repositorio que contiene la descripci√≥n de su infraestructura. </li><li>  Todos est√°n haciendo sus cambios en una rama dedicada. </li><li>  Para cada rama, estamos ejecutando pruebas. </li><li>  No puede fusionarse en la rama maestra si las pruebas fallan. </li></ul><br><p>  Fue una decisi√≥n dif√≠cil.  Con suerte, como resultado durante el proceso de revisi√≥n, no hubo discusi√≥n sobre el estilo del c√≥digo y la cantidad de olor del c√≥digo estaba disminuyendo. </p><br><h1 id="iac-testing">  Prueba IaC </h1><br><p><img src="https://habrastorage.org/webt/ah/dg/sa/ahdgsaecxtevlwnv9ozcoiypkq8.png"></p><br><p>  Adem√°s de la verificaci√≥n del estilo de c√≥digo, puede verificar que puede implementar o recrear su infraestructura en un entorno limitado.  Para que sirve  Es una pregunta sofisticada y me gustar√≠a compartir una historia en lugar de una respuesta.  Were fue un escalador autom√°tico personalizado para AWS escrito en Powershell.  El escalador autom√°tico no verific√≥ los bordes de corte para los par√°metros de entrada, como resultado, cre√≥ toneladas de m√°quinas virtuales y el cliente no estaba contento.  Es una situaci√≥n inc√≥moda, con suerte, es posible detectarla en las primeras etapas. </p><br><p>  Por un lado, es posible probar el script y la infraestructura, pero por otro lado, est√° aumentando una cantidad de c√≥digo y haciendo que la infraestructura sea m√°s compleja.  Sin embargo, la verdadera raz√≥n para esto es que est√° poniendo a prueba su conocimiento sobre infraestructura.  Est√°s describiendo c√≥mo las cosas deber√≠an funcionar juntas. </p><br><h2 id="iac-testing-pyramid">  Pir√°mide de pruebas IaC </h2><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><h3 id="iac-testing-static-analysis">  Prueba IaC: an√°lisis est√°tico </h3><br><p>  Puede crear toda la infraestructura desde cero para cada confirmaci√≥n, pero, por lo general, hay algunos obst√°culos: </p><br><ul><li>  El precio es estratosf√©rico. </li><li>  Requiere mucho tiempo </li></ul><br><p>  Con suerte, hay algunos trucos.  Debe tener muchas pruebas simples, r√°pidas y primitivas en su base. </p><br><h4 id="bash-is-tricky">  Bash es complicado </h4><br><p>  Echemos un vistazo a un ejemplo extremadamente simple.  Me gustar√≠a crear un script de respaldo: </p><br><ul><li>  Obtenga todos los archivos del directorio actual. </li><li>  Copie los archivos en otro directorio con un nombre modificado. </li></ul><br><p>  La primera idea es: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp $i /some/path/$i.bak done</code> </pre> <br><p>  Bastante bien  Sin embargo, ¬øqu√© pasa si el nombre del archivo contiene <em>espacio</em> ?  Somos tipos inteligentes, usamos citas: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp "$i" "/some/path/$i.bak" done</code> </pre> <br><p>  ¬øHemos terminado?  No!  ¬øQu√© pasa si el directorio est√° vac√≠o?  Gloging falla en este caso. </p><br><pre> <code class="plaintext hljs">find . -type f -exec mv -v {} dst/{}.bak \;</code> </pre> <br><p>  Hemos terminado?  Todav√≠a no ... Olvidamos que el nombre de archivo puede contener <code>\n</code> caracteres. </p><br><pre> <code class="plaintext hljs">touch x mv x "$(printf "foo\nbar")" find . -type f -print0 | xargs -0 mv -t /path/to/target-dir</code> </pre> <br><h4 id="static-analysis-tools">  Herramientas de an√°lisis est√°tico </h4><br><p>  Puede detectar algunos problemas del ejemplo anterior a trav√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Shellcheck</a> .  Hay muchas herramientas como esa, se denominan linters y puede encontrar la m√°s adecuada para su IDE, pila y entorno. </p><br><div class="scrollable-table"><table><thead><tr><th>  Idioma </th><th>  Herramienta </th></tr></thead><tbody><tr><td>  golpe </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Shellcheck</a> </td></tr><tr><td>  Rub√≠ </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Rubocop</a> </td></tr><tr><td>  pit√≥n </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pylint</a> </td></tr><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pelusa</a> </td></tr></tbody></table></div><br><h3 id="iac-testing-unit-tests">  Prueba IaC: Pruebas unitarias </h3><br><p><img src="https://habrastorage.org/webt/pn/wx/av/pnwxavylqxfmvcc-oynjhjmsq-a.png"></p><br><p>  Como puede ver, las linters no pueden atrapar todo, solo pueden predecir.  Si continuamos pensando en los paralelismos entre el desarrollo de software y la Infraestructura como C√≥digo, deber√≠amos mencionar las pruebas unitarias.  Hay muchos sistemas de pruebas unitarias como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">shunit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JUnit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RSpec</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pytest</a> .  Pero, ¬øalguna vez has o√≠do hablar de las pruebas unitarias para Ansible, Chef, Saltstack, CFengine? </p><br><p>  Cuando hablamos de <em>SOLID</em> para CFM, mencion√© que nuestra infraestructura deber√≠a estar hecha de simples ladrillos / m√≥dulos.  Ahora ha llegado el momento: </p><br><ol><li>  Dividir la infraestructura en m√≥dulos / interrupciones simples, es decir, roles Ansible. </li><li>  Cree un entorno, es decir, Docker o VM. </li><li>  Aplique su √∫nico descanso / m√≥dulo simple al medio ambiente. </li><li>  Comprueba que todo est√° bien o no. <br>  ... </li><li>  BENEFICIOS! </li></ol><br><h4 id="iac-testing-unit-testing-tools">  Pruebas IaC: herramientas de pruebas unitarias </h4><br><p>  ¬øCu√°l es la prueba para CFM y su infraestructura?  es decir, puede ejecutar un script o puede usar una soluci√≥n lista para producci√≥n como: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Herramienta </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Testinfra</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Inspec</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Serverspec</a> </td></tr><tr><td>  pila de sal </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Goss</a> </td></tr></tbody></table></div><br><p>  Echemos un vistazo a testinfra, me gustar√≠a comprobar que los usuarios <code>test1</code> , <code>test2</code> existen y son parte del grupo <code>sshusers</code> : </p><br><pre> <code class="plaintext hljs">def test_default_users(host): users = ['test1', 'test2' ] for login in users: assert host.user(login).exists assert 'sshusers' in host.user(login).groups</code> </pre> <br><p>  ¬øCu√°l es la mejor soluci√≥n?  No hay una respuesta √∫nica para esa pregunta, sin embargo, cre√© el mapa de calor y compar√© los cambios en estos proyectos durante 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/aj/vm/0w/ajvm0wr0cno5a0kchi0z-jwyyxy.png"></p><br><h4 id="iac-testing-frameworks">  Marcos de prueba de IaC </h4><br><p>  Despu√©s de eso, puede enfrentarse a una pregunta sobre c√≥mo ejecutarlo todo junto.  Por un lado, puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hacer todo por su cuenta</a> si tiene suficientes ingenieros excelentes, pero por otro lado, puede usar soluciones listas para producci√≥n de c√≥digo abierto: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Herramienta </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mol√©cula</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cocina de prueba</a> </td></tr><tr><td>  Terraforma </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Terratest</a> </td></tr></tbody></table></div><br><p>  Cre√© el mapa de calor y compar√© los cambios en estos proyectos durante 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/bj/lb/02/bjlb02mi6tympyzdjjxef3_8bhq.png"></p><br><h4 id="molecule-vs-testkitchen">  Mol√©cula vs.  Testkitchen </h4><br><p><img src="https://habrastorage.org/webt/vx/2e/dt/vx2edtvvuquxyw-4yf81zmk6s9c.png"></p><br><p>  Al principio, intentamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">probar roles ansibles a trav√©s de testkitchen dentro de hyper-v</a> : </p><br><ol><li>  Crear m√°quinas virtuales. </li><li>  Aplicar roles de Ansible. </li><li>  Ejecute Inspec. </li></ol><br><p>  Tom√≥ 40-70 minutos para 25-35 roles de Ansible.  Fue demasiado largo para nosotros. </p><br><p><img src="https://habrastorage.org/webt/i-/9j/cl/i-9jclmr4x36ag1e8ppzk_d-_b0.png"></p><br><p>  El siguiente paso fue usar Jenkins / docker / Ansible / mol√©cula.  Es aproximadamente la misma idea: </p><br><ol><li>  Lint Ansible playbooks. </li><li>  Lint Roles de Ansible. </li><li>  Ejecute un contenedor acoplable. </li><li>  Aplicar roles de Ansible. </li><li>  Ejecute testinfra. </li><li>  Verifica la idempotencia. </li></ol><br><p><img src="https://habrastorage.org/webt/zz/je/kf/zzjekf-i8wckzdeslzlrbkmmxhg.png"></p><br><p>  La selecci√≥n de 40 roles y la evaluaci√≥n de diez de ellos tom√≥ aproximadamente 15 minutos. </p><br><p><img src="https://habrastorage.org/webt/pn/6p/qe/pn6pqelxwb7dbaapkefv80ccxra.png"></p><br><p>  ¬øCu√°l es la mejor soluci√≥n?  Por un lado, no quiero ser la autoridad final, pero por otro lado, me gustar√≠a compartir mi punto de vista.  No existe una bala de plata, sin embargo, en el caso de la mol√©cula Ansible es una soluci√≥n m√°s adecuada que testkitchen. </p><br><h3 id="iac-testing-integration-tests">  Pruebas IaC: Pruebas de integraci√≥n </h3><br><p><img src="https://habrastorage.org/webt/yt/jf/br/ytjfbruwxfanxl15sxcfyg_gz1g.png"></p><br><p>  En el siguiente nivel de la <em>pir√°mide de pruebas</em> de <em>IaC</em> , hay <em>pruebas de integraci√≥n</em> .  Las pruebas de integraci√≥n para infraestructura se parecen a las pruebas unitarias: </p><br><ol><li>  Dividir la infraestructura en m√≥dulos / interrupciones simples, es decir, roles Ansible. </li><li>  Cree un entorno, es decir, Docker o VM. </li><li>  Aplique <em>una combinaci√≥n</em> de descanso / m√≥dulo simple al entorno. </li><li>  Comprueba que todo est√° bien o no. <br>  ... </li><li>  BENEFICIOS! </li></ol><br><p>  En otras palabras, durante las pruebas unitarias, verificamos un m√≥dulo simple (es decir, rol Ansible, script de Python, m√≥dulo Ansible, etc.) de una infraestructura, pero en el caso de las pruebas de integraci√≥n, verificamos la configuraci√≥n completa del servidor. </p><br><h3 id="iac-testing-end-to-end-tests">  Pruebas IaC: pruebas de extremo a extremo </h3><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><p>  En la parte superior de la <em>pir√°mide de pruebas de IaC</em> , hay <em>pruebas de</em> <em>extremo a extremo</em> .  En este caso, no verificamos el servidor dedicado, el script, el m√≥dulo de nuestra infraestructura;  Verificamos que toda la infraestructura en conjunto funciona correctamente.  Desafortunadamente, no hay una soluci√≥n inmediata para eso o no he o√≠do hablar de ellos (por favor, m√°rqueme si los conoce).  Por lo general, las personas reinventan la rueda porque hay demanda de pruebas de infraestructura de extremo a extremo.  Entonces, me gustar√≠a compartir mi experiencia, espero que sea √∫til para alguien. </p><br><p><img src="https://habrastorage.org/webt/us/xz/rl/usxzrlzt8unudguhf9b89d83dfm.png"></p><br><p>  En primer lugar, me gustar√≠a describir el contexto.  Es una soluci√≥n empresarial lista para usar, admite diferentes bases de datos, servidores de aplicaciones e interfaces de integraci√≥n con sistemas de terceros.  Por lo general, nuestros clientes son una empresa inmensa con un entorno completamente diferente.  Tenemos conocimiento sobre diferentes combinaciones de entornos y lo almacenamos como diferentes archivos docker-compose.  Adem√°s, si hay coincidencias entre los archivos de compilaci√≥n de docker y las pruebas, lo almacenamos como trabajos de Jenkins. </p><br><p><img src="https://habrastorage.org/webt/an/l2/ev/anl2ev_lxlsnegrxpulghdw9jxw.png"></p><br><p>  Este esquema hab√≠a estado funcionando durante un per√≠odo de registro silencioso cuando durante la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">investigaci√≥n de OpenShift</a> intentamos migrarlo a OpenShift.  Utilizamos aproximadamente los mismos contenedores (otra vez SECO) y solo cambiamos el entorno. </p><br><p><img src="https://habrastorage.org/webt/sh/sg/ud/shsgudbrhuqpazrpikcacxskzrm.png"></p><br><p>  Continuamos investigando y encontramos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">APB</a> (Ansible Playbook Bundle).  La idea principal es empacar todas las cosas necesarias en un contenedor y ejecutar el contenedor dentro de Openshift.  Significa que tiene una soluci√≥n reproducible y comprobable. </p><br><p><img src="https://habrastorage.org/webt/l_/cw/ho/l_cwho8ftxhtnmuekhjlsfllctg.png"></p><br><p>  Todo estuvo bien hasta que enfrentamos un problema m√°s: tuvimos que mantener una infraestructura heterog√©nea para los entornos de prueba.  Como resultado, almacenamos nuestro conocimiento sobre c√≥mo crear infraestructura y ejecutar pruebas en los trabajos de Jenkins. </p><br><h1 id="conclusion">  Conclusi√≥n </h1><br><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"><br>  Infraestructura como C√≥digo es una combinaci√≥n de: </p><br><ul><li>  C√≥digo </li><li>  Interacci√≥n de personas. </li><li>  Pruebas de infraestructura. </li></ul><br><div class="spoiler">  <b class="spoiler_title">enlaces</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Es una publicaci√≥n cruzada del blog personal</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versi√≥n rusa</a> </li><li>  Carrera en seco 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Video (RU) de DINS DevOps TARDE 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lecciones aprendidas al escribir m√°s de 300,000 l√≠neas de c√≥digo de infraestructura</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versi√≥n de texto</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Integrando la infraestructura como c√≥digo en una tuber√≠a de entrega continua</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Probar la infraestructura como c√≥digo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo efectivo y mantenimiento de roles Ansible</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬°Ansible no es una fiesta para ti!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Idempotente ansioso</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467169/">https://habr.com/ru/post/467169/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467153/index.html">Trabajar con objeciones: el an√°lisis est√°tico tomar√° parte del tiempo de trabajo</a></li>
<li><a href="../467155/index.html">Mejores pr√°cticas para contenedores de Kubernetes: controles de salud</a></li>
<li><a href="../467161/index.html">Aplicaci√≥n web en Kotlin + Spring Boot + Vue.js</a></li>
<li><a href="../467163/index.html">C√≥mo migrar a la nube en dos horas gracias a Kubernetes y la automatizaci√≥n</a></li>
<li><a href="../467165/index.html">Siguiendo los pasos del movimiento ruso Scala. Parte 2</a></li>
<li><a href="../467171/index.html">Lo que aprend√≠ al probar 200,000 l√≠neas de c√≥digo de infraestructura</a></li>
<li><a href="../467173/index.html">Arquitecto implementaci√≥n segura de ERP</a></li>
<li><a href="../467175/index.html">Piensa dos veces antes de usar motores de juego</a></li>
<li><a href="../467177/index.html">Consejos de marketing de Tarantino: qu√© papel juegan los pies y por qu√© hacer el jab√≥n Uma Thurman</a></li>
<li><a href="../467179/index.html">Samsung Compiler Bootcamp: ense√±ar a crear "programas de programaci√≥n"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>