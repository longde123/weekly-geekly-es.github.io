<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèª üë©‚Äç‚ù§Ô∏è‚Äçüë© ‚ô£Ô∏è Comment ajouter un index sur un syst√®me charg√© 24/7 sans interruption? üëºüèæ üì± üñ•Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mes amis, fin janvier, nous commencerons un nouveau cours intitul√© ¬´MS SQL Server Developer ¬ª. En pr√©vision de son lancement, nous avons demand√© √† l'e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment ajouter un index sur un syst√®me charg√© 24/7 sans interruption?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/435582/">  <i>Mes amis, fin janvier, nous commencerons un nouveau cours intitul√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´MS SQL Server Developer</a> ¬ª.</i>  <i>En pr√©vision de son lancement, nous avons demand√© √† l'enseignante du cours, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kristina Kucherova</a> , de pr√©parer un article d'auteur.</i>  <i>Cet article vous sera utile si vous avez une table tr√®s populaire sur la prod avec un acc√®s 24h / 24 et 7j / 7 et que vous vous rendez compte que vous devez de toute urgence ajouter un index et ne rien casser dans le processus.</i> <br><br>  Alors que faire?  La m√©thode traditionnelle CREATE INDEX WITH (ONLINE = ON) ne vous convient pas, car, par exemple, elle provoque un crash syst√®me et une crise cardiaque de votre DBA, tous les sommets surveillent de pr√®s le temps de r√©ponse de votre syst√®me et, si elle augmente, ils viennent √† vous et √† votre DBA pour parler concernant les chiffres surestim√©s de votre r√©mun√©ration du travail. <br><br>  Les scripts et les techniques d√©crites ont √©t√© utilis√©s sur un syst√®me avec une charge de 400 000 requ√™tes par minute, versions de SQL Server 2012 et 2016 (Enterprise). <br><br>  Il existe deux approches tr√®s diff√©rentes pour cr√©er un index, qui sont utilis√©es en fonction de la taille de la table. <br><br><h3>  Cas n ¬∞ 1. Une petite table mais tr√®s populaire </h3><br>  Un tableau de 50 000 enregistrements (petit), mais tr√®s populaire (plusieurs milliers de hits par minute).  Vous avez besoin d'un nouvel index, d'un temps d'arr√™t minimal et de verrous sur la table. <br>  Dans l'application, tout acc√®s √† la base de donn√©es se fait uniquement par le biais de proc√©dures. <br><br>  Si une erreur se produit, l'application r√©essayera d'acc√©der √† la table. <br><br><img src="https://habrastorage.org/webt/0b/7k/oj/0b7kojuvqjl6d_ty__et9g3wgiu.png"><br><a name="habracut"></a><br>  Quel est le probl√®me de l'application de cet indice simplement, demandez-vous?  Avec la phrase WITH ONLINE = ON (oui, nous avons eu de la chance, et celle-ci √©tait Enterprise). <br><br>  Le fait est qu'avec un tel acc√®s actif, il faut un certain temps pour obtenir un verrou (m√™me le minimum requis avec l'option with Online = ON).  En cours d'attente, de nouvelles demandes sont mises en file d'attente, la file d'attente s'accumule, le processeur augmente, le DBA transpire et plisse nerveusement vers les d√©veloppeurs, tandis que sur les graphiques de surveillance des applications, votre temps de r√©ponse commence √† augmenter en douceur, mais in√©vitablement.  Votre vice-pr√©sident de l'ing√©nierie souhaite vivement savoir si, en raison de cette augmentation du temps de r√©ponse, il y aura une sorte d'arr√™t du syst√®me, qu'√† la fin de l'ann√©e, la disponibilit√© de l'application sera estim√©e non pas √† 5 neuf (99 999), mais moins?  Et puis l'entreprise a des contrats, des obligations et de lourdes amendes en cas de disponibilit√© r√©duite, et, bien s√ªr, nous n'oublierons pas les pertes de r√©putation. <br><br>  Qu'avons-nous fait pour √©viter cette situation malheureuse? <br>  Le syst√®me a toujours besoin d'un index. <br>  Ils ont pris les droits de tout le monde sauf la session en cours sur cette table. <br>  Appliquez l'index. <br><br>  Oui, la solution a un inconv√©nient: tous ceux qui se sont tourn√©s vers la table dans ces secondes recevront un acc√®s refus√©.  Si votre application g√®re normalement une telle situation et r√©p√®te la requ√™te dans la base de donn√©es, vous devez alors examiner cette option.  Dans le cas de notre projet, cette m√©thode a bien fonctionn√©.  Encore une fois, vous pouvez supprimer ONLINE = ON en toute s√©curit√©, car nous savons que seule la session aura acc√®s √† la table lors de la cr√©ation de l'index. <br><br>  Code d'application de l'index: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IX_Users_Email_Status <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] ([Email],[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2]</code> </pre> <br>  Calendrier du temps de r√©ponse et pourcentage d'erreurs lors des tests sous charge. <br><br><img src="https://habrastorage.org/webt/h_/nd/ug/h_ndugyc0hybrm5-bps5pmxinuo.png" alt="image"><br><br>  La m√©thode peut √™tre appliqu√©e si vous, comme dans le cas d√©crit, avez une petite table et que vous savez que sans charge, l'index sera cr√©√© en quelques secondes (ou dans un d√©lai acceptable pour vous).  Dans le m√™me temps, comme vous pouvez le voir sur le graphique ci-dessus, le temps de r√©ponse de l'application n'augmentera pas, bien que l'on puisse voir que le taux d'erreur en secondes sans acc√®s au tableau √©tait plus √©lev√©. <br><br><h3>  Cas n ¬∞ 2. Grande table </h3><br>  Si vous avez une grande table et que vous devez modifier les index dessus, alors le moyen le plus indolore de vendre est de cr√©er une table √† c√¥t√© avec l'index correct et de transf√©rer progressivement les donn√©es vers une nouvelle table. <br><br>  Il y a 2 fa√ßons: <br><br><ol><li>  Si vous avez une proc√©dure sp√©ciale pour modifier une table, vous changez simplement le code de la proc√©dure afin que les nouvelles donn√©es soient ins√©r√©es uniquement dans la nouvelle table, la suppression provient des deux, la mise √† jour a √©galement √©t√© appliqu√©e aux deux, et la s√©lection a √©t√© effectu√©e √† partir de deux tables avec UNION ALL. </li><li>  Si vous avez de nombreuses parties diff√©rentes du code o√π vous pouvez modifier les donn√©es dans la table, il existe deux astuces populaires: afficher avec des d√©clencheurs ou r√©√©crire toutes les parties du code pour ins√©rer des donn√©es dans une nouvelle table, supprimer des deux et mettre √† jour les deux tables.  Une vue avec des d√©clencheurs est une option lorsque vous cr√©ez une vue avec deux tables et la renommez, renommez votre table actuelle en TableOld et affichez en Table.  Ensuite, vous obtenez automatiquement tous les appels de table √† la vue, ici avec renommer, il peut √©galement y avoir un probl√®me, car SchemaLock est n√©cessaire, mais renommer passe tr√®s rapidement. </li></ol><br>  Une version l√©g√®rement plus d√©taill√©e sur la r√©√©criture des appels vers une nouvelle table: <br><br><ol><li>  Vous avez la table Orders, cr√©ez une nouvelle table OrdersNew avec le m√™me sch√©ma, mais avec l'index souhait√©.  Dans le m√™me temps, si vous utilisez Indentity, vous devez d√©finir la premi√®re valeur d'identit√© dans la nouvelle table pour qu'elle soit √©gale √† la valeur maximale dans l'ancienne table + l'√©tape de modification ou l'√©cart que vous pouvez vous permettre de d√©vier de la valeur maximale dans Orders. </li><li>  Cr√©er un OrdersView, dans lequel une s√©lection de Orders UNION ALL OrdersNew </li><li>  Modifiez toutes les proc√©dures / appels pour s√©lectionner les donn√©es de la vue, ins√©rez-les dans OrdersNew, supprimez et modifiez les deux tables. </li><li>  Migrez les donn√©es de l'ancienne table vers la nouvelle, par exemple, comme ceci: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowcount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">4999</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @batchsize; WHILE @rowcount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> TOP (@batchsize) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Orders <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> deleted.Id ,deleted.Column1 ,deleted.Column2 ,deleted.Column3 <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.OrdersNew (<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> ,Column1 ,Column2 ,Column3); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@ROWCOUNT; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ERROR_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorNumber, ERROR_MESSAGE() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorMessage; THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre><br></li><li>  Retournez toutes les proc√©dures √† la version avant la migration - avec une seule table.  Cela peut √™tre fait via alter ou par la suppression et la cr√©ation de proc√©dures (puis n'oubliez pas les droits), et vous pouvez renommer la nouvelle table en commandes, en supprimant la table et la vue vides. </li></ol><br>  √Ä l'√©tape 2, il √©tait possible, si le chargement le permet, de renommer la table principale Orders -&gt; OrdersOld et OrdersView -&gt; Orders et la vue elle-m√™me en OrdersOld UNION ALL OrdersNew, vous n'avez donc pas besoin de modifier tous les endroits o√π il y a une s√©lection dans la table. <br><br>  Lorsque vous d√©placez des blocs d'une table √† une autre, les donn√©es sont fragment√©es. <br>  Si la table en cours de modification est activement utilis√©e pour la lecture, mais que les donn√©es qu'elle contient changent rarement, vous pouvez √† nouveau utiliser des d√©clencheurs - √©crire une copie de toutes les modifications dans la 3e table - transf√©rer les donn√©es de la table via bcp out et bcp in (ou insertion en bloc) vers une nouvelle table , cr√©ez des index dessus apr√®s le transfert de donn√©es, puis appliquez les modifications de la table avec le journal des modifications - et basculez d'une table √† une autre - l'actuelle, en la renommant TableOld et la nouvelle de TableNew en Table. <br><br>  La probabilit√© d'erreurs dans cette situation est l√©g√®rement plus √©lev√©e, alors testez l'application des changements et des diff√©rents cas de commutation dans ce cas. <br><br>  Les options d√©crites ne sont pas les seules.  Ils ont √©t√© utilis√©s par moi sur une base de donn√©es SQL Server tr√®s charg√©e et n'ont pas caus√© de probl√®mes lors de l'application, ce qui a plu √† notre √©quipe DBA.  Un tel rebond n'est g√©n√©ralement pas n√©cessaire pour les bases avec un mode de charge plus calme, lorsque vous pouvez appliquer en toute s√©curit√© des changements dans les heures de moindre activit√©.  Les utilisateurs du projet qui ont utilis√© les approches d√©crites se trouvent aux √âtats-Unis et en Europe et utilisent activement l'application les jours de semaine et les week-ends, et les tableaux sur lesquels les modifications ont √©t√© appliqu√©es sont constamment utilis√©s dans le travail.  Des objets plus ¬´silencieux¬ª √©taient g√©n√©ralement modifi√©s par des scripts automatiques g√©n√©r√©s via Redgate Toolkit apr√®s que les scripts aient √©t√© examin√©s par le d√©veloppeur et l'un des administrateurs de base de donn√©es. <br><br>  <i>Bon √† tous!</i>  <i>Partagez les commentaires si vous avez utilis√© l'une de ces m√©thodes ou d√©crivez votre m√©thode!</i>  <i>Nous vous invitons √©galement √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une le√ßon ouverte</a> et une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journ√©e portes ouvertes de</a> notre nouveau cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"MS SQL Server Developer"</a></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435582/">https://habr.com/ru/post/fr435582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435572/index.html">Anycubic i3 Mega: remake de qualit√© de Prusa i3</a></li>
<li><a href="../fr435574/index.html">Comment fonctionne zig?</a></li>
<li><a href="../fr435576/index.html">1C, pas de douleur</a></li>
<li><a href="../fr435578/index.html">Sortie dans l'espace pour No√´l</a></li>
<li><a href="../fr435580/index.html">Java, Spring, Kurento et Media Services</a></li>
<li><a href="../fr435584/index.html">Slush 2018. Premier jour, deuxi√®me jour</a></li>
<li><a href="../fr435586/index.html">L'art du chamanisme ou du firmware personnalis√© pour Olinuxino. Noyau et Ubuntu Partie 3</a></li>
<li><a href="../fr435588/index.html">Promotion d'une application mobile avec une r√©elle exp√©rience des chiffres</a></li>
<li><a href="../fr435590/index.html">Pr√©vision √† nouveau, partie 1</a></li>
<li><a href="../fr435592/index.html">A√ßores: derni√®re r√©serve de flore au milieu de l'oc√©an Atlantique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>