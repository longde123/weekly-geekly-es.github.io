<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÑÔ∏è üñ§ üí™üèº Celesta 7.x: ORM, migration et test ¬´dans un seul paquet¬ª üßïüèø üÖæÔ∏è ü§öüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Peut-√™tre que vous savez d√©j√† quelque chose sur la biblioth√®que open source Celesta . Sinon, peu importe, maintenant nous allons tout vous dire. Une a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Celesta 7.x: ORM, migration et test ¬´dans un seul paquet¬ª</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455746/"><p>  Peut-√™tre que vous savez d√©j√† quelque chose sur la biblioth√®que open source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Celesta</a> .  Sinon, peu importe, maintenant nous allons tout vous dire.  Une autre ann√©e s'est √©coul√©e, la version 7.x est sortie, beaucoup de choses ont chang√©, et il est temps de r√©sumer les changements, et en m√™me temps de rappeler ce qu'est Celesta en g√©n√©ral. </p><br><div style="text-align:center;"><img width="350" src="https://habrastorage.org/webt/jj/7z/jt/jj7zjthmrh2dhdo4v0ueefqj6uq.png"></div><a name="habracut"></a><br><p> Si vous n'avez encore rien entendu parler de Celesta, et lorsque vous lisez cet article, vous voulez savoir pour quelles t√¢ches commerciales son application est la plus efficace, je peux recommander la premi√®re partie de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ancien article</a> ou cette <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o d'une demi-heure</a> (√† l'exception des mots sur l'utilisation du langage Python).  Mais mieux encore, lisez d'abord cet article.  Je vais commencer par les changements survenus dans la version 7, puis je passerai en revue un exemple technique complet d'utilisation de la version moderne de Celesta pour √©crire un petit service backend pour une application Java utilisant Spring Boot. </p><br><h2 id="chto-izmenilos-v-versii-7x">  Qu'est-ce qui a chang√© dans la version 7.x? </h2><br><ol><li>  Nous avons refus√© d'utiliser Jython comme langage int√©gr√© √† Celesta.  Si plus t√¥t nous avons commenc√© √† parler de Celesta avec le fait que la logique m√©tier est √©crite en Python, maintenant ... tout langage Java peut servir de langage de logique m√©tier: Java, Groovy, JRuby ou le m√™me Jython.  D√©sormais, Celesta n'appelle pas le code logique m√©tier, mais le code logique m√©tier utilise Celesta et ses classes d'acc√®s aux donn√©es comme biblioth√®que Java la plus courante.  Oui, la compatibilit√© descendante a √©t√© viol√©e √† cause de cela, mais c'est le prix que nous √©tions pr√™ts √† payer.  Malheureusement, notre pari sur Jython a √©t√© perdu.  Lorsque nous avons commenc√© √† utiliser Jython il y a quelques ann√©es, c'√©tait un projet vivant et prometteur, mais au fil des ans, son d√©veloppement a ralenti, le retard de la sp√©cification du langage s'est accumul√©, les probl√®mes de compatibilit√© pour la plupart des biblioth√®ques pip n'ont pas √©t√© r√©solus.  La derni√®re goutte a √©t√© les nouveaux bogues dans les derni√®res versions linguistiques, qui se sont manifest√©s lors du travail sur une charge de production.  Nous-m√™mes n'avons pas les ressources n√©cessaires pour soutenir le projet Jython, et nous avons d√©cid√© de nous en s√©parer.  Celesta ne d√©pend plus de Jython. </li><li>  Les classes d'acc√®s aux donn√©es sont d√©sormais g√©n√©r√©es en code en langage Java (et non en Python, comme auparavant) √† l'aide du plugin Maven.  Et depuis que nous sommes pass√©s de la frappe dynamique √† la frappe statique √† cause de cela, il y a eu plus d'opportunit√©s de refactoring et il est devenu plus facile d'√©crire du code subjectivement correct. </li><li>  L'extension pour JUnit5 est apparue, il est donc devenu tr√®s pratique d'√©crire des tests de logique qui fonctionnent avec la base de donn√©es dans JUnit5 (qui seront discut√©s plus tard). </li><li>  Un projet distinct est apparu - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">spring-boot-starter-celesta</a> , qui, comme son nom l'indique, est le starter de Celesta dans Spring Boot.  La possibilit√© d'int√©grer des applications Celesta dans des services Spring Boot facilement d√©ployables a compens√© la perte de la possibilit√© de mettre √† jour l'application sur le serveur en changeant simplement le dossier avec des scripts Python. </li><li>  Nous avons transf√©r√© toute la documentation du Wiki au format <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AsciiDoctor</a> , l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avons</a> plac√©e dans le contr√¥le de version avec le code, et nous avons maintenant une documentation √† jour pour chaque version de Celesta.  Pour la derni√®re version, la documentation en ligne est disponible ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://courseorchestra.github.io/celesta/</a> </li><li>  On nous a souvent demand√© s'il √©tait possible d'utiliser la migration de base de donn√©es via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DDL idempotent</a> s√©par√©ment de Celesta.  Maintenant, il existe une telle opportunit√© en utilisant l'outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2bass</a> . </li></ol><br><h2 id="chto-takoe-selesta-i-chto-ona-umeet">  Qu'est-ce que Celesta et que peut-elle faire? </h2><br><p>  En bref, Celesta est: </p><br><ul><li>  une couche interm√©diaire entre la base de donn√©es relationnelle et le code logique m√©tier, bas√©e sur l'approche de conception bas√©e sur la <em>base de donn√©es</em> , </li><li>  m√©canisme de migration de la structure de la base de donn√©es, </li><li>  cadre pour tester le code qui fonctionne avec les donn√©es. </li></ul><br><p>  Nous prenons en charge quatre types de bases de donn√©es relationnelles: PostgreSQL, MS SQL Server, Oracle et H2. </p><br><p>  Caract√©ristiques cl√©s de Celesta: </p><br><ol><li>  Un principe tr√®s similaire au principe de base de Java: "√âcrivez une fois, ex√©cutez sur tous les SGBDR pris en charge."  Le code logique m√©tier ne sait pas sur quel type de base de donn√©es il s'ex√©cutera.  Vous pouvez √©crire le code de logique m√©tier et l'ex√©cuter dans MS SQL Server, puis passer √† PostgreSQL, et cela se produira sans complications (enfin, presque :) </li><li>  Restructuration automatique sur une base de donn√©es live.  La plupart du cycle de vie des projets Celesta se produit lorsque la base de donn√©es de travail est d√©j√† l√† et qu'elle est remplie de donn√©es qui doivent √™tre enregistr√©es, mais il est √©galement n√©cessaire de changer constamment leur structure.  L'une des principales caract√©ristiques de Celesta est la possibilit√© d'adapter automatiquement la structure de la base de donn√©es √† votre mod√®le de donn√©es. </li><li>  Test.  Une grande attention est accord√©e √† la possibilit√© de tester le code de Celesta, afin que nous puissions tester automatiquement les m√©thodes qui modifient les donn√©es dans la base de donn√©es, en le faisant facilement, rapidement et avec √©l√©gance, sans utiliser d'outils externes tels que DbUnit et les conteneurs. </li></ol><br><h2 id="dlya-chego-nuzhna-nezavisimost-ot-tipa-subd">  Pourquoi avez-vous besoin d'ind√©pendance vis-√†-vis du type de SGBD? </h2><br><p>  L'ind√©pendance du code de logique m√©tier par rapport au type de SGBD n'√©tait pas le premier point que nous avons mis: le code √©crit pour Celesta ne sait pas du tout sur quel SGBD il s'ex√©cute.  Pourquoi? </p><br><p>  Tout d'abord, du fait que le choix d'un type de SGBD n'est pas un probl√®me technologique, mais politique.  En venant √† un nouveau client commercial, nous constatons souvent qu'il a d√©j√† un type de SGBD pr√©f√©r√© dans lequel les fonds sont investis, et le client veut voir d'autres solutions sur l'infrastructure existante.  Le paysage technologique est en train de changer: PostgreSQL est de plus en plus pr√©sent dans les agences gouvernementales et les entreprises priv√©es, bien que MS SQL Server ait pr√©valu dans notre pratique il y a quelques ann√©es.  Celesta prend en charge les SGBD les plus courants, et nous ne sommes pas inquiets de ces changements. </p><br><p>  Deuxi√®mement, je voudrais transf√©rer le code d√©j√† cr√©√© pour r√©soudre les probl√®mes standard d'un projet √† un autre, pour cr√©er une biblioth√®que r√©utilisable.  Des √©l√©ments comme les r√©pertoires hi√©rarchiques ou les modules de distribution de notification par courrier √©lectronique sont intrins√®quement standard, et pourquoi devons-nous prendre en charge plusieurs versions pour les clients ayant des relations diff√©rentes? </p><br><p>  Troisi√®mement, le dernier mais non le moindre, la possibilit√© d'ex√©cuter des tests unitaires sans utiliser DbUnit et les conteneurs √† l'aide d'une base de donn√©es H2 en m√©moire.  Dans ce mode, la base H2 d√©marre instantan√©ment.  Celesta y cr√©e tr√®s rapidement un sch√©ma de donn√©es, apr√®s quoi vous pouvez effectuer les tests n√©cessaires et ¬´oublier¬ª la base de donn√©es.  Puisque le code de logique m√©tier ne sait vraiment pas sur quelle base il est ex√©cut√©, alors en cons√©quence, s'il fonctionne sans erreur sur H2, alors sans erreur, il fonctionnera sur PostgreSQL.  Bien s√ªr, la t√¢che des d√©veloppeurs du syst√®me Celesta lui-m√™me est de faire tous les tests en utilisant de vrais SGBD pour s'assurer que notre plate-forme ex√©cute √©galement son API sur diff√©rentes relations.  Et nous le faisons.  Mais le d√©veloppeur de logique m√©tier n'est plus requis. </p><br><h2 id="celestasql">  CelestaSQL </h2><br><p>  Comment le cross-basementisme est-il atteint?  Bien s√ªr, au prix de travailler avec des donn√©es uniquement via une API sp√©ciale qui isole la logique des sp√©cificit√©s de la base de donn√©es.  Celesta g√©n√®re des classes Java pour acc√©der aux donn√©es, d'une part, et au code SQL et √† certains objets auxiliaires √† l'int√©rieur de la base de donn√©es, d'autre part. </p><br><p>  Celesta ne fournit pas de mappage relationnel objet dans sa forme la plus pure, car lors de la conception d'un mod√®le de donn√©es, nous ne venons pas des classes, mais de la structure de la base de donn√©es.  Autrement dit, nous cr√©ons d'abord un mod√®le ER de tables, puis, sur la base de ce mod√®le, Celesta g√©n√®re lui-m√™me des classes de curseur pour acc√©der aux donn√©es. </p><br><p>  Vous pouvez r√©aliser le m√™me travail sur tous les SGBD pris en charge uniquement pour la fonctionnalit√© qui est impl√©ment√©e de mani√®re √† peu pr√®s √©gale dans chacun d'eux.  Si nous d√©crivons conditionnellement l'ensemble des capacit√©s fonctionnelles de chacune des bases soutenues par nous sous la forme de ¬´cercles d'Euler¬ª, alors nous obtenons l'image suivante: </p><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/getpro/habr/post_images/7d9/2ad/1e1/7d92ad1e1a3bc0bb83b5c4bcc511ec66.png"></div><br><p>  Si nous fournissons une ind√©pendance totale par rapport au type de base de donn√©es, la fonctionnalit√© que nous ouvrons aux programmeurs de logique m√©tier doit se situer √† l'intersection de toutes les bases.  √Ä premi√®re vue, il semble que ce soit une limitation importante.  Oui: certaines fonctionnalit√©s sp√©cifiques, par exemple, nous ne pouvons pas utiliser SQL Server.  Mais sans exception, les bases de donn√©es relationnelles prennent en charge les tables, les cl√©s √©trang√®res, les vues, les s√©quences, les requ√™tes SQL avec JOIN et GROUP BY.  En cons√©quence, nous pouvons donner ces opportunit√©s aux d√©veloppeurs.  Nous fournissons aux d√©veloppeurs du ¬´SQL d√©personnalis√©¬ª, que nous appelons ¬´CelestaSQL¬ª, et dans le processus, nous g√©n√©rons des requ√™tes SQL pour les dialectes des bases de donn√©es correspondantes. </p><br><p>  Le langage CelestaSQL inclut DDL pour d√©finir les objets de base de donn√©es et les requ√™tes SELECT pour les vues et les filtres, mais ne contient pas de commandes DML: les curseurs sont utilis√©s pour modifier les donn√©es, qui doivent encore √™tre discut√©es. </p><br><p>  Chaque base de donn√©es poss√®de son propre ensemble de types de donn√©es.  CelestaSQL poss√®de √©galement son propre ensemble de types.  Au moment de la r√©daction, il y en avait neuf, et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce tableau les</a> compare aux types r√©els dans diverses bases de donn√©es et types de donn√©es Java. </p><br><p>  Il peut sembler que neuf types ne suffisent pas (par rapport √† ce que PostgreSQL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prend en charge</a> , par exemple), mais en r√©alit√© ce sont les types qui sont suffisants pour stocker des informations financi√®res, commerciales et logistiques: cha√Ænes, entiers, fractionnaires , les dates, les valeurs bool√©ennes et les blobs sont toujours suffisants pour repr√©senter de telles donn√©es. </p><br><p>  Le langage CelestaSQL lui-m√™me est d√©crit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> avec un grand nombre de diagrammes de syntaxe. </p><br><h2 id="modifikaciya-struktury-bazy-dannyh-idempotentnyy-ddl">  Modification de la structure de la base de donn√©es.  Idempotent DDL </h2><br><p>  Une autre caract√©ristique cl√© de Celesta est son approche de la migration de la structure de la base de donn√©es de travail au fur et √† mesure du d√©veloppement du projet.  Pour ce faire, l'approche int√©gr√©e √† Celesta √† l'aide de DDL idempotent est utilis√©e. </p><br><p>  En r√©sum√©, lorsque nous √©crivons dans CelestaSQL le texte suivant: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine( order_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, line_no <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), qty <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Idx_OrderLine PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id, line_no) );</code> </pre> <br><p>  - ce texte n'est pas interpr√©t√© par Celesta comme ¬´cr√©er un tableau, mais s'il y a d√©j√† un tableau, alors donner une erreur¬ª, mais ¬´amener le tableau √† la structure souhait√©e¬ª.  C'est-√†-dire: ¬´s'il n'y a pas de table, cr√©ez-la, s'il y a une table, voyez quels champs s'y trouvent, avec quels types, quels index, quelles cl√©s √©trang√®res, quelles valeurs par d√©faut, etc., et si quelque chose doit √™tre chang√© dans ce tableau pour l'amener √† la bonne sorte. " </p><br><p>  Avec cette approche, nous impl√©mentons la possibilit√© de refactoriser et de contr√¥ler les versions des scripts pour d√©terminer la structure de la base de donn√©es: </p><br><ul><li>  nous voyons dans le script "l'image souhait√©e" actuelle de la structure, </li><li>  ce qui, par qui et pourquoi la structure a chang√© au fil du temps, nous pouvons regarder √† travers le syst√®me de contr√¥le de version, </li><li>  quant aux commandes ALTER, Celesta les g√©n√®re et les ex√©cute automatiquement ¬´sous le capot¬ª selon les besoins. </li></ul><br><p>  Bien s√ªr, cette approche a ses limites.  Celesta met tout en ≈ìuvre pour que la migration automatique soit indolore et transparente, mais cela n'est pas possible dans tous les cas.  La motivation, les possibilit√©s et les limites de cette approche ont √©t√© d√©crites <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans cet article</a> (sa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version anglaise</a> est √©galement disponible). </p><br><p>  Afin d'acc√©l√©rer le processus de v√©rification / mise √† jour de la structure de la base de donn√©es, Celesta applique le stockage des sommes de contr√¥le de script DDL dans la base de donn√©es (jusqu'√† ce que la somme de contr√¥le soit modifi√©e, le processus de v√©rification et de mise √† jour de la structure de la base de donn√©es ne d√©marre pas).  Pour que le processus de mise √† jour se d√©roule sans probl√®mes li√©s √† l'ordre de changement des objets d√©pendants les uns des autres, un tri topologique des d√©pendances entre les sch√©mas par des cl√©s √©trang√®res est appliqu√©.  Le processus de migration automatique est d√©crit plus en d√©tail dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . </p><br><h2 id="sozdanie-proekta-celesta-i-modeli-dannyh">  Cr√©ation d'un projet et d'un mod√®le de donn√©es Celesta </h2><br><p>  Le projet de d√©monstration, que nous consid√©rerons, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est disponible sur le github</a> .  Voyons comment utiliser Celesta lors de l'√©criture d'une application Spring Boot.  Voici les d√©pendances Maven dont vous avez besoin: </p><br><ul><li>  <code>org.springframework.boot:spring-boot-starter-web</code> et <code>ru.curs:spring-boot-starter-celesta</code> (pour plus de d√©tails, <code>ru.curs:spring-boot-starter-celesta</code> documentation). </li><li>  Si vous n'utilisez pas Spring Boot, vous pouvez connecter directement la d√©pendance <code>ru.curs:celesta-system-services</code> . </li><li>  Pour la g√©n√©ration de code de classes d'acc√®s aux donn√©es bas√©es sur des scripts Celesta-SQL, <code>ru.curs:celesta-maven-plugin</code> n√©cessaire <code>ru.curs:celesta-maven-plugin</code> - le code source d'un exemple de d√©monstration ou de la documentation d√©crit comment le connecter. </li><li>  Pour profiter de la possibilit√© d'√©crire des tests unitaires JUnit5 pour les m√©thodes qui modifient les donn√©es, vous devez connecter <code>ru.curs:celesta-unit</code> dans la port√©e du test. </li></ul><br><p>  Cr√©ez maintenant un mod√®le de donn√©es et compilez des classes d'acc√®s aux donn√©es. </p><br><p>  Supposons que nous r√©alisons un projet pour une soci√©t√© de commerce √©lectronique qui a r√©cemment fusionn√© avec une autre soci√©t√©.  Chacun a sa propre base de donn√©es.  Ils collectent les commandes, mais jusqu'√† ce qu'ils fusionnent leurs bases de donn√©es, ils ont besoin d'un point d'entr√©e unique pour collecter les commandes de l'ext√©rieur. </p><br><p>  La mise en ≈ìuvre de ce ¬´point d'entr√©e¬ª devrait √™tre assez classique: un service HTTP avec des op√©rations CRUD qui stockent des donn√©es dans une base de donn√©es relationnelle. </p><br><p>  √âtant donn√© que Celesta impl√©mente l'approche de conception bas√©e sur la base de donn√©es, nous devons d'abord cr√©er une structure de table qui stocke les commandes.  Une commande, comme vous le savez, est une entit√© composite: elle se compose d'un en-t√™te o√π sont stock√©es les informations sur le client, la date de la commande et d'autres attributs de la commande, ainsi que de nombreuses lignes (articles de base). </p><br><p>  Donc, pour le travail: cr√©er </p><br><ul><li>  <code>src/main/celestasql</code> - par d√©faut, c'est le chemin d'acc√®s aux scripts de projet CelestaSQL </li><li>  il contient des sous-dossiers qui r√©p√®tent la structure des dossiers des packages java ( <code>ru/curs/demo</code> dans notre cas). </li><li>  dans le dossier du package, cr√©ez un fichier <code>.sql</code> avec le contenu suivant: </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SCHEMA</span></span> demo <span class="hljs-keyword"><span class="hljs-keyword">VERSION</span></span> <span class="hljs-string"><span class="hljs-string">'1.0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderHeader( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> DATETIME, customer_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-comment"><span class="hljs-comment">/**  */</span></span> customer_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), manager_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Pk_OrderHeader PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-comment"><span class="hljs-comment">/** */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine( order_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, line_no <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), qty <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Idx_OrderLine PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id, line_no) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> fk_OrderLine <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> OrderHeader(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> item_id;</code> </pre> <br><p>  Nous avons d√©crit ici deux tables reli√©es par une cl√© √©trang√®re et une vue qui renverra une quantit√© r√©capitulative pour les marchandises pr√©sentes dans toutes les commandes.  Comme vous pouvez le voir, ce n'est pas diff√©rent du SQL standard, √† l'exception de la commande <code>CREATE SCHEMA</code> , dans laquelle nous avons d√©clar√© la version du sch√©ma de <code>demo</code> (pour savoir comment le num√©ro de version affecte la migration automatique, consultez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> ).  Mais il y a aussi des fonctionnalit√©s.  Par exemple, tous les noms des tables et des champs que nous utilisons ne peuvent √™tre tels qu'ils peuvent √™tre transform√©s en noms de classe et de variable valides dans le langage Java.  Par cons√©quent, les espaces et les caract√®res sp√©ciaux sont exclus.  Vous pouvez √©galement remarquer que les commentaires que nous avons mis sur les noms des tables et certains champs, nous n'avons pas commenc√© avec / *, comme d'habitude, mais avec / **, comment les commentaires JavaDoc commencent - et ce n'est pas un hasard!  Un commentaire d√©fini sur une entit√© commen√ßant par / ** sera disponible √† l'ex√©cution dans la propri√©t√© <code>.getCelestaDoc()</code> de cette entit√©.  Cela est utile lorsque nous voulons fournir aux √©l√©ments de base de donn√©es des m√©ta-informations suppl√©mentaires: par exemple, des noms de champs lisibles par l'homme, des informations sur la fa√ßon de repr√©senter les champs dans l'interface utilisateur, etc. </p><br><p>  Le script CelestaSQL remplit deux t√¢ches tout aussi importantes: d'une part, pour le d√©ploiement / modification de la structure d'une base de donn√©es relationnelle, et d'autre part, pour la g√©n√©ration de code des classes d'acc√®s aux donn√©es. </p><br><p>  Nous pouvons g√©n√©rer des classes d'acc√®s aux donn√©es maintenant, il suffit d'ex√©cuter la commande <code>mvn generate-sources</code> ou, si vous travaillez dans IDEA, cliquez sur le bouton `` G√©n√©rer les sources et mettre √† jour les dossiers '' dans le panneau de configuration Maven.  Dans le second cas, IDEA ¬´ <code>target/generated-sources/celesta</code> dossier cr√©√© dans <code>target/generated-sources/celesta</code> et rend son contenu disponible pour importation dans les codes sources du projet.  Le r√©sultat de la g√©n√©ration de code se pr√©sentera comme suit - une classe pour chaque objet de la base de donn√©es: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/3q/cs/2x3qcsydsu3y5vplbyh7oz15z-s.png"></div><br><p>  La connexion √† la base de donn√©es est sp√©cifi√©e dans les param√®tres de l'application, dans notre cas, dans le fichier <code>src/main/resources/application.yml</code> .  Lors de l'utilisation de spring-boot-starter-celesta, IDEA vous indiquera les options de code disponibles dans la compl√©tion de code. </p><br><p>  Si nous ne voulons pas nous soucier du "vrai" SGBDR √† des fins de d√©monstration, nous pouvons faire fonctionner Celesta avec la base de donn√©es H2 int√©gr√©e en mode en m√©moire en utilisant la configuration suivante: </p><br><pre> <code class="plaintext hljs">celesta: h2: inMemory: true</code> </pre> <br><p>  Pour connecter une "vraie" base de donn√©es, changez la configuration en quelque chose comme </p><br><pre> <code class="plaintext hljs">celesta: jdbc: url: jdbc:postgresql://127.0.0.1:5432/celesta username: &lt;your_username&gt; password: &lt;your_password&gt;</code> </pre> <br><p>  (dans ce cas, vous devrez √©galement ajouter un pilote JDBC PostgreSQL √† votre application via la d√©pendance Maven). </p><br><p>  Lorsque vous lancez une application Celesta avec une connexion √† un serveur de base de donn√©es, vous pouvez constater que les tables, vues, index, etc. n√©cessaires sont cr√©√©s pour une base de donn√©es vide et pour une base non vide, ils sont mis √† jour selon les structures sp√©cifi√©es dans la DDL. </p><br><h2 id="sozdanie-metodov-rabotayuschih-s-dannymi">  Cr√©ation de m√©thodes de manipulation de donn√©es </h2><br><p>  Une fois que vous avez compris comment cr√©er une structure de base de donn√©es, vous pouvez commencer √† √©crire la logique m√©tier. </p><br><p>  Afin de pouvoir mettre en ≈ìuvre les exigences de distribution des droits d'acc√®s et des actions de journalisation, toute op√©ration sur les donn√©es dans Celesta est effectu√©e pour le compte d'un utilisateur, il n'y a pas d'op√©rations ¬´anonymes¬ª.  Par cons√©quent, tout code Celesta est ex√©cut√© dans le <em>contexte de l'appel</em> d√©crit dans la classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CallContext</a> . </p><br><ul><li>  Avant de d√©marrer une op√©ration pouvant modifier les donn√©es de la base de donn√©es, <code>CallContext</code> activ√©. </li><li>  Au moment de l'activation, une connexion √† la base de donn√©es est prise √† partir du pool de connexions et la transaction commence. </li><li>  Une fois l'op√©ration <code>CallContext</code> ex√©cute soit <code>commit()</code> si l'op√©ration a r√©ussi, soit <code>rollback()</code> si une exception non <code>CallContext</code> s'est produite pendant l'ex√©cution, <code>CallContext</code> ferme et la connexion √† la base de donn√©es est renvoy√©e au pool. </li></ul><br><p>  Si nous utilisons spring-boot-starter-celesta, alors ces actions sont effectu√©es automatiquement pour toutes les m√©thodes annot√©es par <code>@CelestaTransaction</code> . </p><br><p>  Supposons que nous voulons √©crire un gestionnaire qui enregistre le document dans la base de donn√©es.  Son code au niveau du contr√¥leur pourrait ressembler √† ceci: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/api"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DocumentService srv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DocumentController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DocumentService srv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.srv = srv; } <span class="hljs-meta"><span class="hljs-meta">@PutMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/save"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody OrderDto order)</span></span></span><span class="hljs-function"> </span></span>{ CallContext ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CallContext(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//new SystemCallContext(); srv.postOrder(ctx, order); }</span></span></code> </pre> <br><p>  En r√®gle g√©n√©rale, au niveau de la m√©thode du contr√¥leur (c'est-√†-dire lorsque l'authentification est d√©j√† pass√©e), nous connaissons l'ID utilisateur et pouvons l'utiliser lors de la cr√©ation du <code>CallContext</code> .  La liaison d'un utilisateur √† un contexte d√©termine les autorisations d'acc√®s aux tables et permet √©galement de consigner les modifications apport√©es en son nom.  Certes, dans ce cas, pour l'op√©rabilit√© du code interagissant avec la base de donn√©es, les droits de l'utilisateur "user1" doivent √™tre indiqu√©s dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tables syst√®me</a> .  Si vous ne souhaitez pas utiliser le syst√®me de distribution d'acc√®s Celesta et accorder au contexte de session tous les droits sur toutes les tables, vous pouvez cr√©er un objet <code>SystemCallContext</code> . </p><br><p>  La m√©thode d'enregistrement de la facture au niveau du service peut ressembler √† ceci: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@CelestaTransaction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context, OrderDto doc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); OrderLineCursor line = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderLineCursor(context)) { header.setId(doc.getId()); header.setDate(Date.from(doc.getDate().atStartOfDay(ZoneId.systemDefault()).toInstant())); header.setCustomer_id(doc.getCustomerId()); header.setCustomer_name(doc.getCustomerName()); header.insert(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lineNo = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (OrderLineDto docLine : doc.getLines()) { lineNo++; line.setLine_no(lineNo); line.setOrder_id(doc.getId()); line.setItem_id(docLine.getItemId()); line.setQty(docLine.getQty()); line.insert(); } } }</code> </pre> <br><p>  Notez l'annotation <code>@CelestaTransaction</code> .  Gr√¢ce √† lui, l'objet proxy <code>DocumentService</code> effectuera toutes ces actions de service avec le param√®tre <code>CallContext ctx</code> d√©crit ci-dessus.  Autrement dit, au d√©but de la m√©thode, il sera d√©j√† li√© √† la connexion √† la base de donn√©es et la transaction sera pr√™te √† commencer.  Nous pouvons nous concentrer sur l'√©criture de la logique m√©tier.  Dans notre cas, lire l'objet <code>OrderDto</code> et l'enregistrer dans la base de donn√©es. </p><br><p>  Pour ce faire, nous utilisons les curseurs dits - classes g√©n√©r√©es √† l'aide <code>celesta-maven-plugin</code> .  Nous avons d√©j√† vu ce qu'ils sont.  Une classe est cr√©√©e pour chacun des objets de sch√©ma - deux tables et une vue.  Et maintenant, nous pouvons utiliser ces classes pour acc√©der aux objets de base de donn√©es dans notre logique m√©tier. </p><br><p>  Pour cr√©er un curseur sur la table de commande et s√©lectionner le premier enregistrement, vous devez √©crire le code suivant: </p><br><pre> <code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); header.tryFirst();</code> </pre> <br><p>  Apr√®s avoir cr√©√© l'objet d'en-t√™te, nous pouvons acc√©der aux champs de l'entr√©e de table via des getters et setters: </p><br><div style="text-align:center;"><img width="450" src="https://habrastorage.org/webt/_8/gl/9i/_8gl9ikjbprpjano2dbvj0reme8.png"></div><br><p>  Lors de la cr√©ation d'un curseur, nous devons utiliser le contexte d'appel actif - c'est la seule fa√ßon de cr√©er un curseur.  Le contexte d'appel contient des informations sur l'utilisateur actuel et ses droits d'acc√®s. </p><br><p>  Avec l'objet curseur, nous pouvons faire diff√©rentes choses: filtrer, parcourir les enregistrements et aussi, naturellement, ins√©rer, supprimer et mettre √† jour des enregistrements.  L'API enti√®re du curseur est d√©crite en d√©tail dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . </p><br><p>  Par exemple, le code de notre exemple pourrait √™tre d√©velopp√© comme suit: </p><br><pre> <code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); header.setRange(<span class="hljs-string"><span class="hljs-string">"manager_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"manager1"</span></span>); header.tryFirst(); header.setCounter(header.getCounter() + <span class="hljs-number"><span class="hljs-number">1</span></span>); header.update();</code> </pre> <br><p>  Dans cet exemple, nous d√©finissons le filtre par le champ manager_id, puis nous trouvons le premier enregistrement √† l'aide de la m√©thode tryFirst. </p><br><div class="spoiler">  <b class="spoiler_title">(pourquoi "essayer")</b> <div class="spoiler_text"><p>  Les m√©thodes <code>get</code> , <code>first</code> , <code>insert</code> , <code>update</code> ont deux options: sans le pr√©fixe try (juste <code>get(...)</code> , etc.) et avec le pr√©fixe try ( <code>tryGet(...)</code> , <code>tryFirst()</code> , etc.) .  Les m√©thodes sans le pr√©fixe try l√®vent une exception si la base de donn√©es ne dispose pas des donn√©es appropri√©es pour effectuer l'action.  Par exemple, first () l√®vera une exception si aucun enregistrement n'entre dans le filtre d√©fini sur le curseur.  En m√™me temps, les m√©thodes avec le pr√©fixe try ne l√®vent pas d'exception, mais renvoient √† la place une valeur bool√©enne qui signale le succ√®s ou l'√©chec de l'op√©ration correspondante.  La pratique recommand√©e consiste √† utiliser des m√©thodes sans le pr√©fixe try dans la mesure du possible.  De cette fa√ßon, un code ¬´d'auto-test¬ª est cr√©√©, signalant des erreurs dans le temps dans les donn√©es de logique et / ou de base de donn√©es. </p></div></div><br><p>  Lorsque <code>tryFirst</code> d√©clench√©, les variables du <code>tryFirst</code> sont remplies avec les donn√©es d'un enregistrement, nous pouvons les lire et leur affecter des valeurs.  Et lorsque les donn√©es du curseur sont enti√®rement pr√©par√©es, nous ex√©cutons <code>update()</code> , et il stocke le contenu du curseur dans la base de donn√©es. </p><br><p>  Quel probl√®me ce code pourrait-il √™tre affect√©?  Bien s√ªr, l'√©mergence de la condition de course / mise √† jour perdue!  Parce qu'entre le moment o√π nous avons re√ßu les donn√©es dans la ligne avec "tryFirst" et le moment o√π nous essayons de mettre √† jour ces donn√©es au point "update", quelqu'un d'autre peut d√©j√† recevoir, modifier et mettre √† jour ces donn√©es dans la base de donn√©es.  Une fois les donn√©es lues, le curseur ne bloque en aucun cas leur utilisation par d'autres utilisateurs!  Pour se prot√©ger contre les mises √† jour perdues, Celesta utilise le principe de verrouillage optimiste.  Dans chaque table, par d√©faut, Celesta cr√©e un champ de <code>recversion</code> , et au niveau ON du d√©clencheur UPDATE, il incr√©mente le num√©ro de version et v√©rifie que les donn√©es mises √† jour ont la m√™me version que la table.  Si un probl√®me se produit, l√®ve une exception.  Vous pouvez en savoir plus √† ce sujet dans l'article de l'article ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Protection contre les mises √† jour perdues</a> ¬ª. </p><br><p>  Rappelons √† nouveau qu'une transaction est associ√©e √† l'objet CallContext.  Si la proc√©dure Celesta r√©ussit, un commit se produit.  Si la m√©thode Celesta se termine par une exception non g√©r√©e, une restauration se produit.  Ainsi, si une erreur se produit dans une proc√©dure compliqu√©e, la transaction enti√®re li√©e au contexte d'appel est annul√©e, comme si nous n'avions rien commenc√© √† faire avec les donn√©es, les donn√©es ne sont pas corrompues.  Si, pour une raison quelconque, vous avez besoin d'une validation au milieu, par exemple, d'une sorte de proc√©dure volumineuse, une validation explicite peut √™tre ex√©cut√©e en appelant <code>context.commit()</code> . </p><br><h2 id="testirovanie-metodov-rabotayuschih-s-dannymi">  Test des m√©thodes de donn√©es </h2><br><p>  Cr√©ons un test unitaire qui v√©rifie l'exactitude de la m√©thode de service qui stocke <code>OrderDto</code> dans la base de donn√©es. </p><br><p>  Lorsque vous utilisez JUnit5 et l'extension pour JUnit5 disponible dans le module Celesta <code>celesta-unit</code> , c'est tr√®s simple.  La structure du test est la suivante: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@CelestaTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentServiceTest</span></span></span><span class="hljs-class"> </span></span>{ DocumentService srv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DocumentService(); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">documentIsPutToDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ OrderDto doc =... srv.postOrder(context, doc); <span class="hljs-comment"><span class="hljs-comment">//Check the fact that records are in the database OrderHeaderCursor header = new OrderHeaderCursor(context); header.tryFirst(); assertEquals(doc.getId(), header.getId()); OrderLineCursor line = new OrderLineCursor(context); line.setRange("order_id", doc.getId()); assertEquals(2, line.count()); } }</span></span></code> </pre> <br><p>  Gr√¢ce √† l'annotation <code>@CelestaTest</code> , qui est une extension pour JUnit5, nous pouvons d√©clarer le param√®tre de <code>CallContext context</code> dans les m√©thodes de test.  Ce contexte est d√©j√† activ√© et li√© √† la base de donn√©es (H2 en m√©moire), et donc nous n'avons pas besoin d'envelopper la classe de service dans un proxy - nous la cr√©ons en utilisant <code>new</code> , et non en utilisant Spring.  Cependant, si n√©cessaire, injectez le service dans le test √† l'aide des outils Spring, il n'y a aucun obstacle √† cela. </p><br><p>  Nous cr√©ons des tests unitaires en supposant qu'au moment de leur ex√©cution, la base de donn√©es sera compl√®tement vide, mais avec la structure dont nous avons besoin, et apr√®s leur ex√©cution, nous ne pouvons pas nous inqui√©ter du fait que nous ayons laiss√© des ¬´ordures¬ª dans la base de donn√©es.  Ces tests sont effectu√©s √† tr√®s grande vitesse. </p><br><p>  Cr√©ons une deuxi√®me proc√©dure qui retourne JSON avec des valeurs agr√©g√©es indiquant le nombre de produits que nous avons command√©s. </p><br><p>  Le test √©crit deux commandes dans la base de donn√©es, apr√®s quoi il v√©rifie la valeur totale retourn√©e par la nouvelle m√©thode <code>getAggregateReport</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportReturnsAggregatedQuantities</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ srv.postOrder(context, . . .); srv.postOrder(context, . . .); Map&lt;String, Integer&gt; result = srv.getAggregateReport(context); assertEquals(<span class="hljs-number"><span class="hljs-number">5</span></span>, result.get(<span class="hljs-string"><span class="hljs-string">"A"</span></span>).intValue()); assertEquals(<span class="hljs-number"><span class="hljs-number">7</span></span>, result.get(<span class="hljs-string"><span class="hljs-string">"B"</span></span>).intValue()); }</code> </pre> <br><p>  Pour impl√©menter la m√©thode <code>getAggregateReport</code> nous utiliserons la vue OrderedQty, qui, je le rappelle, dans le fichier CelestaSQL ressemble √† ceci: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> item_id;</code> </pre> <br><p>  La demande est standard: nous r√©sumons les lignes de commande par quantit√© et regroupons par code produit.  Un curseur OrderedQtyCursor a d√©j√† √©t√© cr√©√© pour la vue, que nous pouvons utiliser.  Nous d√©clarons ce curseur, le parcourons et collectons la <code>Map&lt;String, Integer&gt;</code> souhait√©e: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@CelestaTransaction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map&lt;String, Integer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAggregateReport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Integer&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (OrderedQtyCursor ordered_qty = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderedQtyCursor(context)) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (OrderedQtyCursor line : ordered_qty) { result.put(ordered_qty.getItem_id(), ordered_qty.getQty()); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><h2 id="materializovannye-predstavleniya-celesta">  Vues Celesta mat√©rialis√©es </h2><br><p>  Pourquoi l'utilisation d'une vue est-elle mauvaise pour obtenir des donn√©es agr√©g√©es?  Cette approche est tout √† fait r√©alisable, mais en r√©alit√© elle met une bombe √† retardement dans tout notre syst√®me: apr√®s tout, une vue, qui est une requ√™te SQL, s'ex√©cute de plus en plus lentement √† mesure que les donn√©es s'accumulent dans le syst√®me.  Il devra r√©sumer et regrouper de plus en plus de lignes.  Comment √©viter cela? </p><br><p>  Celesta essaie de mettre en ≈ìuvre toutes les t√¢ches standard auxquelles les programmeurs de logique m√©tier sont constamment confront√©s au niveau de la plate-forme. </p><br><p>  MS SQL Server a le concept de vues mat√©rialis√©es (index√©es), qui sont stock√©es sous forme de tables et sont mises √† jour rapidement √† mesure que les donn√©es des tables source changent.  Si nous travaillions dans un serveur MS SQL ¬´propre¬ª, dans notre cas, le remplacement de la vue par une vue index√©e serait exactement ce dont nous avions besoin: la r√©cup√©ration du rapport agr√©g√© ne ralentirait pas √† mesure que les donn√©es s'accumulaient et le travail de mise √† jour du rapport agr√©g√© serait effectu√© pour le moment ins√©rer des donn√©es dans le tableau des lignes de commande et n'augmenterait pas non plus beaucoup avec une augmentation du nombre de lignes. </p><br><p>  Mais si nous travaillons avec PostgreSQL via Celesta, que pouvons-nous faire?  Red√©finissez la vue en ajoutant le mot mat√©rialis√©: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> item_id;</code> </pre> <br><p>  Commen√ßons le syst√®me et voyons ce qui est arriv√© √† la base de donn√©es. </p><br><p>  Nous remarquerons que la <code>OrderedQty</code> a disparu et que la table <code>OrderedQty</code> est apparue √† la <code>OrderedQty</code> .  De plus, comme la table OrderLine est remplie de donn√©es, les informations de la table OrderedQty seront mises √† jour "comme par magie", comme si OrderedQty √©tait une vue. </p><br><p>  Il n'y a pas de magie ici si nous regardons les d√©clencheurs construits sur la table <code>OrderLine</code> .  Celesta, ayant re√ßu la t√¢che de cr√©er une ¬´vue mat√©rialis√©e¬ª, a analys√© la requ√™te et cr√©√© des d√©clencheurs sur la table <code>OrderLine</code> qui mettent √† jour <code>OrderedQty</code> .  En ins√©rant un seul mot-cl√© - <code>materialized</code> - dans le fichier CelestaSQL, nous avons r√©solu le probl√®me de d√©gradation des performances, et le code logique m√©tier n'a m√™me pas eu besoin d'√™tre chang√©! </p><br><p> ,    ,   , . ¬´¬ª  Celesta    ,    ,  JOIN-,    GROUP BY.     ,  , ,     ,      . .     . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>       Celesta.     ‚Äî    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455746/">https://habr.com/ru/post/fr455746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455736/index.html">Consensus sur les crypto-monnaies avec l'exploitation mini√®re hybride et multi-PoW</a></li>
<li><a href="../fr455738/index.html">Comment gagner un milliard en mon√©tisant vos donn√©es?</a></li>
<li><a href="../fr455740/index.html">Apprentissage automatique dans une soci√©t√© d'investissement: nous classons les appels au support technique</a></li>
<li><a href="../fr455742/index.html">Faire de la musique: quand des solutions simples surpassent le deep learning</a></li>
<li><a href="../fr455744/index.html">Syst√®me de g√©n√©ration de paysage de labyrinthe avec un r√©alisme visuel am√©lior√© [traduction de l'article par Jinmo Kim]</a></li>
<li><a href="../fr455754/index.html">Tests d'un stratostat d√©rivant. Lancement de Rogozin et LoRa dans la stratosph√®re</a></li>
<li><a href="../fr455756/index.html">Est [favor] e</a></li>
<li><a href="../fr455758/index.html">Hacking de croissance chez Retail Rocket: de la recherche d'hypoth√®ses aux techniques de test</a></li>
<li><a href="../fr455760/index.html">La magie de SwiftUI ou sur les constructeurs de fonctions</a></li>
<li><a href="../fr455762/index.html">Une br√®ve introduction aux cha√Ænes de Markov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>