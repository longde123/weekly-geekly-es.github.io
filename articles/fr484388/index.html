<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôçÔ∏è ‚úàÔ∏è üóíÔ∏è VVVVVV ??? VVVVVV !!! :) üë©üèΩ‚Äçüé§ üòã ‚û°Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous lisez ce texte, vous avez pens√© que quelque chose n'allait pas avec le titre ou vous avez vu le nom d'un jeu informatique familier. VVVVVV est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VVVVVV ??? VVVVVV !!! :)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/484388/">  Si vous lisez ce texte, vous avez pens√© que quelque chose n'allait pas avec le titre ou vous avez vu le nom d'un jeu informatique familier.  VVVVVV est un jeu de plateforme ind√©pendant qui a vol√© le c≈ìur de nombreux joueurs par sa simplicit√© externe agr√©able et sa complexit√© interne non moins agr√©able.  Il y a quelques jours, VVVVVV a eu 10 ans et l'auteur du jeu - Terry Cavanagh - a c√©l√©br√© cette f√™te en publiant son code source.  Quelles choses ahurissantes cache-t-elle?  Lisez la r√©ponse dans cet article. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0c8/fdf/72a/0c8fdf72ab45ed2077f8ea957e6b7ea5.png" alt="Figure 1"></div><a name="habracut"></a><br><h2>  Pr√©sentation </h2><br>  Oh, VVVVVV ... Je me souviens l'avoir rencontr√© peu de temps apr√®s la sortie et √™tre un grand fan de jeux r√©tro pixel, j'√©tais tellement excit√© de l'installer sur mon ordinateur.  Je me souviens de mes premi√®res impressions: "C'est tout?  Juste courir dans les pi√®ces carr√©es? ¬ªJ'ai pens√© apr√®s quelques minutes de jeu.  Je ne savais pas ce qui m'attendait √† l'√©poque.  D√®s que je suis sorti de l'emplacement de d√©part, je me suis retrouv√© dans un monde bidimensionnel petit mais d√©routant et fleuri, plein de paysages inhabituels et d'artefacts de pixels inconnus de moi. <br><br>  Je me suis laiss√© emporter par le match.  Finalement, j'ai compl√®tement battu le jeu malgr√© certains d√©fis, comme une grande complexit√© avec un contr√¥le de jeu habilement appliqu√©, par exemple - le personnage principal ne peut pas sauter, mais est capable d'inverser la direction du vecteur de gravit√© sur lui-m√™me.  Je n'ai aucune id√©e du nombre de fois o√π mon personnage est mort, mais je suis s√ªr que le nombre de morts est mesur√© par dizaines de centaines.  Apr√®s tout, chaque jeu a son propre zeste unique :) <br><br>  Quoi qu'il en soit, revenons au code source, publi√© <a href="http://distractionware.com/blog/2020/01/vvvvvv-is-now-open-source/">en l'honneur de l'anniversaire du jeu</a> . <br><br>  En ce moment, je suis un d√©veloppeur du PVS-Studio, qui est un analyseur de code statique pour C, C ++, C # et Java.  En plus de d√©velopper directement, nous sommes √©galement engag√©s dans la promotion de nos produits.  Pour nous, l'une des meilleures fa√ßons de le faire est d'√©crire des articles sur la v√©rification des projets open source.  Nos lecteurs re√ßoivent des articles int√©ressants sur des sujets de programmation et nous avons l'occasion de d√©montrer les capacit√©s de PVS-Studio.  Donc, quand j'ai entendu parler de l'ouverture du code source VVVVVV, je ne pouvais tout simplement pas le d√©passer. <br><br>  Dans cet article, nous examinerons quelques erreurs int√©ressantes trouv√©es par l'analyseur PVS-Studio dans le code VVVVVV, et examinerons ces erreurs en d√©tail.  Pointez le vecteur de gravit√© vers le bas et installez-vous confortablement - nous sommes sur le point de commencer! <br><br><h2>  Pr√©sentation des avertissements de l'analyseur </h2><br><h3>  Avertissement 1 </h3><br>  <a href="https://www.viva64.com/en/w/v512/">V512</a> Un appel de la fonction 'sprintf' entra√Ænera un d√©bordement de la m√©moire tampon 'fileSearch'.  FileSystemUtils.cpp 307 <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_PATH 260 .... void PLATFORM_migrateSaveData(char *output) { char oldLocation[MAX_PATH]; char newLocation[MAX_PATH]; char oldDirectory[MAX_PATH]; char fileSearch[MAX_PATH]; .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Same place, different layout. */</span></span></span><span class="hljs-meta"> strcpy(oldDirectory, output); sprintf(fileSearch, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s\\*.vvvvvv"</span></span></span><span class="hljs-meta">, oldDirectory); .... }</span></span></code> </pre> <br>  Comme vous pouvez le voir, les cha√Ænes <i>fileSearch</i> et <i>oldDirectory</i> sont de la m√™me taille: 260 caract√®res.  Apr√®s avoir √©crit le contenu de la cha√Æne <i>oldDirectory</i> dans la cha√Æne de format (le troisi√®me argument <i>sprintf</i> ), elle ressemblera √†: <br><pre> <code class="cpp hljs">&lt;i&gt;contents_oldDirectory\*.vvvvvv&lt;/i&gt;</code> </pre> <br>  Cette ligne compte 9 caract√®res de plus que la valeur d'origine de <i>oldDirectory</i> .  C'est cette s√©quence de caract√®res qui sera √©crite dans <i>fileSearch</i> .  Que se passe-t-il si la longueur de la cha√Æne <i>oldDirectory</i> est sup√©rieure √† 251?  La cha√Æne r√©sultante sera plus longue que <i>FileSearch</i> ne pourrait contenir, ce qui entra√Ænera une violation des limites du tableau.  Quelles donn√©es dans la RAM peuvent √™tre endommag√©es et quel r√©sultat cela conduira √† une question rh√©torique :) <br><br><h3>  Avertissement 2 </h3><br>  <a href="https://www.viva64.com/en/w/v519/">V519</a> La variable 'background' re√ßoit des valeurs successives deux fois.  C'est peut-√™tre une erreur.  V√©rifier les lignes: 1367, 1373. Map.cpp 1373 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-comment"><span class="hljs-comment">//The Warpzone tmap = warplevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); roomname = warplevel.roomname; tileset = 1; background = 3; // &lt;= dwgfx.rcol = warplevel.rcol; dwgfx.backgrounddrawn = false; warpx = warplevel.warpx; warpy = warplevel.warpy; background = 5; // &lt;= if (warpy) background = 4; if (warpx) background = 3; if (warpx &amp;&amp; warpy) background = 5; break; .... }</span></span></code> </pre> <br>  La m√™me variable se voit attribuer une valeur deux fois de suite.  Cependant, cette variable n'est utilis√©e nulle part entre les affectations.  Ce qui est bizarre ... Cette s√©quence peut ne pas violer la logique du programme, mais de telles affectations elles-m√™mes indiquent une certaine confusion lors de l'√©criture de code.  Que ce soit une erreur en fait - seul l'auteur pourra le dire avec certitude.  Bien qu'il existe des exemples plus vifs de cette erreur dans le code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"frames"</span></span>) { frames = atoi(pText); frames = <span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  Dans ce cas, il est clair qu'une erreur se cache quelque part dans la logique ou dans une affectation redondante.  Peut-√™tre, la deuxi√®me ligne a √©t√© √©crite temporairement pour le d√©bogage, puis a √©t√© simplement oubli√©e.  Au total, PVS-Studio a √©mis 8 avertissements concernant de tels cas. <br><br><h3>  Avertissement 3 </h3><br>  <a href="https://www.viva64.com/en/w/v808/">V808</a> L'objet 'pKey' de type 'basic_string' a √©t√© cr√©√© mais n'a pas √©t√© utilis√©.  editor.cpp 1866 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pElem-&gt;Value())</span></span></span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"edEntities"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (TiXmlElement *edEntityEl = pElem-&gt;FirstChildElement(); edEntityEl; edEntityEl = edEntityEl-&gt;NextSiblingElement()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(edEntityEl-&gt;Value())</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= //const char* pText = edEntityEl-&gt;GetText() ; if (edEntityEl-&gt;GetText() != NULL) { edentity[i].scriptname = std::string(edEntityEl-&gt;GetText()); } edEntityEl-&gt;QueryIntAttribute("x", &amp;edentity[i].x); edEntityEl-&gt;QueryIntAttribute("y", &amp;edentity[i].y); edEntityEl-&gt;QueryIntAttribute("t", &amp;edentity[i].t); edEntityEl-&gt;QueryIntAttribute("p1", &amp;edentity[i].p1); edEntityEl-&gt;QueryIntAttribute("p2", &amp;edentity[i].p2); edEntityEl-&gt;QueryIntAttribute("p3", &amp;edentity[i].p3); edEntityEl-&gt;QueryIntAttribute("p4", &amp;edentity[i].p4); edEntityEl-&gt;QueryIntAttribute("p5", &amp;edentity[i].p5); edEntityEl-&gt;QueryIntAttribute("p6", &amp;edentity[i].p6); i++; } EditorData::GetInstance().numedentities = i; } .... }</span></span></code> </pre> <br>  Ce code est tr√®s √©trange.  L'analyseur met en garde contre la variable <i>pKey</i> cr√©√©e mais non utilis√©e, mais en r√©alit√©, le probl√®me √©tait plus int√©ressant.  J'ai intentionnellement mis en √©vidence la ligne qui a d√©clench√© l'avertissement avec une fl√®che, car cette fonction contient plus d'une d√©finition de cha√Æne avec le nom <i>pKey</i> .  C'est vrai, une autre variable de ce type est d√©clar√©e dans la boucle <i>for</i> .  Il chevauche celui qui est d√©clar√© en dehors de la boucle. <br><br>  Ainsi, si vous vous r√©f√©rez √† la valeur de la cha√Æne <i>pKey en</i> dehors de la boucle <i>for</i> , vous obtiendrez la valeur √©gale √† <i>pElem-&gt; Value ()</i> , mais en faisant de m√™me √† l'int√©rieur de la boucle, vous obtiendrez la valeur √©gale √† <i>edEntityEl -&gt; Valeur ()</i> .  Le chevauchement des noms est une erreur assez grossi√®re, qui peut √™tre tr√®s difficile √† trouver par vous-m√™me lors de la r√©vision du code. <br><br><h3>  Avertissement 4 </h3><br>  Performances <a href="https://www.viva64.com/en/w/v805/">r√©duites du V805</a> .  Il est inefficace d'identifier une cha√Æne vide en utilisant la construction 'strlen (str)&gt; 0'.  Un moyen plus efficace consiste √† v√©rifier: str [0]! = '\ 0'.  physfs.c 1604 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *prefDir = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PHYSFS_getPrefDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *org, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *app)</span></span></span><span class="hljs-function"> </span></span>{ .... assert(<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(prefDir) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefDir; } <span class="hljs-comment"><span class="hljs-comment">/* PHYSFS_getPrefDir */</span></span></code> </pre> <br>  L'analyseur a trouv√© un fragment pour une micro-optimisation potentielle.  Il utilise la fonction <i>strlen</i> pour v√©rifier si la cha√Æne est vide.  Cette fonction traverse tous les √©l√©ments de cha√Æne et v√©rifie chacun d'eux pour un terminateur nul ('\ 0').  Si nous obtenons une longue cha√Æne, chaque caract√®re sera compar√© √† un terminateur nul. <br><br>  Mais il suffit de v√©rifier que la cha√Æne est vide!  Tout ce que vous devez faire est de savoir si le premier caract√®re de cha√Æne est un terminal nul.  Par cons√©quent, pour optimiser cette v√©rification √† l'int√©rieur de l'assertion, il vaut la peine d'√©crire: <br><br><pre> <code class="cpp hljs">str[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span></code> </pre> <br>  C'est la recommandation que l'analyseur nous donne.  Bien s√ªr, l'appel de la fonction strlen est en condition de la macro <i>assert</i> , donc elle ne sera ex√©cut√©e que dans la version de d√©bogage, o√π la vitesse n'est pas si importante.  Dans la version finale, l'appel de la fonction et du code s'ex√©cutera rapidement.  Malgr√© cela, je voulais d√©montrer ce que notre analyseur peut sugg√©rer en termes de micro-optimisations. <br><br><h3>  Avertissement 5 </h3><br>  Pour d√©montrer l'essence d'une autre erreur, je dois citer deux fragments de code ici: la d√©claration de classe <i>entclass</i> et son constructeur.  Commen√ßons par la d√©claration: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: entclass(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-comment"><span class="hljs-comment">//Fundamentals bool active, invis; int type, size, tile, rule; int state, statedelay; int behave, animate; float para; int life, colour; //Position and velocity int oldxp, oldyp; float ax, ay, vx, vy; int cx, cy, w, h; float newxp, newyp; bool isplatform; int x1, y1, x2, y2; //Collision Rules int onentity; bool harmful; int onwall, onxwall, onywall; //Platforming specific bool jumping; bool gravity; int onground, onroof; int jumpframe; //Animation int framedelay, drawframe, walkingframe, dir, actionframe; int yp; int xp; };</span></span></code> </pre> <br>  Ce constructeur de classe se pr√©sente comme suit: <br><br><pre> <code class="cpp hljs">entclass::entclass() { clear(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> entclass::clear() { <span class="hljs-comment"><span class="hljs-comment">// Set all values to a default, // required for creating a new entity active = false; invis = false; type = 0; size = 0; tile = 0; rule = 0; state = 0; statedelay = 0; life = 0; colour = 0; para = 0; behave = 0; animate = 0; xp = 0; yp = 0; ax = 0; ay = 0; vx = 0; vy = 0; w = 16; h = 16; cx = 0; cy = 0; newxp = 0; newyp = 0; x1 = 0; y1 = 0; x2 = 320; y2 = 240; jumping = false; gravity = false; onground = 0; onroof = 0; jumpframe = 0; onentity = 0; harmful = false; onwall = 0; onxwall = 0; onywall = 0; isplatform = false; framedelay = 0; drawframe = 0; walkingframe = 0; dir = 0; actionframe = 0; }</span></span></code> </pre> <br>  Beaucoup de domaines, ne diriez-vous pas?  Ce n'est pas √©tonnant, PVS-Studio a √©mis un avertissement pour un bug, se cachant ici: <br><br>  <a href="https://www.viva64.com/en/w/v730/">V730</a> Il est possible que tous les membres d'une classe ne soient pas initialis√©s √† l'int√©rieur du constructeur.  Pensez √† inspecter: oldxp, oldyp.  Ent.cpp 3 <br><br>  Comme vous pouvez le voir, deux initialisations de champs de classe ont √©t√© perdues dans une liste aussi longue.  Par cons√©quent, leurs valeurs sont rest√©es ind√©finies, de sorte qu'elles peuvent √™tre lues et utilis√©es incorrectement ailleurs dans le programme.  Il est tr√®s difficile de d√©tecter une telle erreur simplement en r√©visant. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/983/5f3/1be/9835f31be343f47654d9dd80fc159472.png" alt="Figure 4"></div><br><br><h3>  Avertissement 6 </h3><br>  Regardez ce code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; .... tmap = otherlevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); .... <span class="hljs-comment"><span class="hljs-comment">// The tmap vector gets changed again many times. }</span></span></code> </pre> <br>  Avertissement PVS-Studio: V688 La variable locale 'tmap' poss√®de le m√™me nom que l'un des membres de la classe, ce qui peut entra√Æner une confusion.  Map.cpp 1192 <br><br>  En effet, en regardant √† l'int√©rieur de la classe <i>mapclass</i> , vous pouvez trouver le m√™me vecteur avec le m√™me nom: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mapclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeaths; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeathsfinal; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; areamap; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; contents; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; explored; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; vmult; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... };</span></span></code> </pre> <br>  Malheureusement, la m√™me d√©claration de vecteur de nom √† l'int√©rieur de la fonction rend le vecteur d√©clar√© dans la classe invisible.  Il s'av√®re que le vecteur <i>tmap</i> n'est modifi√© qu'√† l'int√©rieur de la fonction de <i>niveau de</i> charge.  Le vecteur d√©clar√© dans la classe reste le m√™me! <br><br>  Fait int√©ressant, PVS-Studio a trouv√© 20 de ces fragments de code!  Pour la plupart, elles se rapportent √† des variables temporaires qui ont √©t√© d√©clar√©es "par commodit√©" en tant que membres de la classe.  L'auteur du jeu (et son seul d√©veloppeur) a √©crit sur lui-m√™me qu'il avait cette mauvaise habitude.  Vous pouvez en lire plus dans la publication - le lien est donn√© au d√©but de l'article. <br><br>  Il a √©galement not√© que de tels noms entra√Ænaient des bogues nuisibles difficiles √† d√©tecter.  Eh bien, de telles erreurs peuvent √™tre vraiment destructrices, mais les attraper devient moins difficile si vous utilisez l'analyse statique :) <br><br><h3>  Avertissement 7 </h3><br>  <a href="https://www.viva64.com/en/w/v601/">V601</a> Le type entier est implicitement <a href="https://www.viva64.com/en/w/v601/">converti en</a> type char.  Game.cpp 4997 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"totalflips"</span></span>) { totalflips = atoi(pText); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"hardestroom"</span></span>) { hardestroom = atoi(pText); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else if (pKey == "hardestroomdeaths") { hardestroomdeaths = atoi(pText); } .... }</span></span></code> </pre> <br>  Pour comprendre ce qui se passe, regardons les d√©finitions des variables de la partie donn√©e du code: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//Some stats: int totalflips; std::string hardestroom; int hardestroomdeaths;</span></span></code> </pre> <br>  <i>Les</i> variables <i>totalflips</i> et <i>hardestroomdeaths</i> sont des nombres entiers, il est donc tout √† fait normal de leur affecter le r√©sultat de la fonction <i>atoi</i> .  Mais que se passe-t-il si vous affectez une valeur enti√®re √† <i>std :: string</i> ?  Une telle affectation s'av√®re valable du point de vue linguistique.  Par cons√©quent, une valeur peu claire sera √©crite dans la variable <i>hardestroom</i> ! <br><br><h3>  Avertissement 8 </h3><br>  <a href="https://www.viva64.com/en/w/v1004/">V1004</a> Le pointeur 'pElem' a √©t√© utilis√© de mani√®re non s√©curis√©e apr√®s avoir √©t√© v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 1739, 1744. editor.cpp 1744 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hDoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;doc)</span></span></span></span>; TiXmlElement *pElem; <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; version = <span class="hljs-number"><span class="hljs-number">0</span></span>; { pElem = hDoc.FirstChildElement().Element(); <span class="hljs-comment"><span class="hljs-comment">// should always have a valid root // but handle gracefully if it does if (!pElem) { printf("No valid root! Corrupt level file?\n"); } pElem-&gt;QueryIntAttribute("version", &amp;version); // &lt;= // save this for later hRoot = TiXmlHandle(pElem); } .... }</span></span></code> </pre> <br>  L'analyseur avertit que le pointeur <i>pElem</i> n'est pas utilis√© correctement apr√®s sa v√©rification de <i>nullptr</i> .  Pour vous assurer que l'analyseur a raison, jetons un coup d'≈ìil √† la d√©finition de la fonction <i>Element ()</i> qui renvoie la valeur qui, √† son tour, initialise le <i>pointeur</i> pElem: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** @deprecated use ToElement. Return the handle as a TiXmlElement. This may return null. */</span></span> <span class="hljs-function"><span class="hljs-function">TiXmlElement *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Element</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ToElement(); }</code> </pre> <br>  Comme nous pouvons le voir dans le commentaire, cette fonction peut retourner <i>null</i> . <br><br>  Imaginez maintenant que c'est vraiment arriv√©.  Que se passera-t-il dans ce cas?  Le fait est que cette situation ne sera en aucun cas g√©r√©e.  Oui, il y aura un message indiquant que quelque chose s'est mal pass√©, mais le pointeur incorrect sera d√©r√©f√©renc√© juste une ligne en dessous.  Un tel d√©r√©f√©rencement entra√Ænera soit le plantage du programme, soit un comportement ind√©fini.  C'est une erreur assez grave. <br><br><h3>  Avertissement 9 </h3><br>  Ce fragment de code a d√©clench√© quatre avertissements de l'analyseur PVS-Studio: <br><br><ul><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: x&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: y&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: x &lt;40. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Une partie de l'expression conditionnelle est toujours vraie: y &lt;30. editor.cpp 1137 </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> editorclass::at( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">0</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">39</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&gt;=<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">29</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; y&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; x&lt;<span class="hljs-number"><span class="hljs-number">40</span></span> &amp;&amp; y&lt;<span class="hljs-number"><span class="hljs-number">30</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contents[x+(levx*<span class="hljs-number"><span class="hljs-number">40</span></span>)+vmult[y+(levy*<span class="hljs-number"><span class="hljs-number">30</span></span>)]]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Tous les avertissements concernent la derni√®re instruction <i>if</i> .  Le probl√®me est que les quatre v√©rifications qui y sont effectu√©es renverront toujours <i>true</i> .  Je ne dirais pas que c'est une grave erreur, mais c'est assez dr√¥le.  L'auteur a d√©cid√© de prendre cette fonction au s√©rieux et juste au cas o√π √† nouveau v√©rifi√© chaque variable :) <br><br>  Il aurait pu supprimer cette v√©rification, car le flux d'ex√©cution n'atteindra pas l'expression " <i>return 0;</i> " de toute fa√ßon.  Cela ne changera pas la logique du programme, mais aidera √† se d√©barrasser des contr√¥les redondants et du code mort. <br><br><h3>  Avertissement 10 </h3><br>  Dans son article sur l'anniversaire du jeu, Terry a ironiquement not√© que l'un des √©l√©ments qui contr√¥laient la logique du jeu √©tait l'√©norme commutateur de la fonction <i>Game :: updatestate ()</i> , responsable d'un grand nombre d'√©tats diff√©rents du jeu en m√™me temps. .  Et on s'attendait √† ce que je trouve l'avertissement suivant: <br><br>  <a href="https://www.viva64.com/en/w/v2008/">V2008</a> Complexit√© cyclomatique: 548. Envisagez de refactoriser la fonction 'Game :: updatestate'.  Game.cpp 612 <br><br>  Oui, vous avez bien compris: PVS-Studio a donn√© √† la fonction la cote de complexit√© suivante - 548. Cinq cent quarante-huit !!!  Voici √† quoi ressemble le "code soign√©".  Et cela malgr√© le fait que, √† l'exception de l'instruction switch, il n'y a presque rien d'autre dans la fonction.  Dans le commutateur lui-m√™me, j'ai compt√© plus de 300 expressions de cas. <br><br>  Vous savez, dans notre entreprise, nous avons un petit concours pour l'article le plus long.  J'adorerais apporter le code de fonction complet (3 450 lignes) ici, mais une telle victoire serait injuste, je vais donc me limiter au <a href="">lien</a> vers le commutateur g√©ant.  Je vous recommande de suivre le lien et de voir sa longueur par vous-m√™me!  Pour cette raison, en plus de <i>Game :: updatestate ()</i> , PVS-Studio a √©galement trouv√© 44 fonctions avec une complexit√© cyclomatique gonfl√©e, dont 10 avaient un nombre de complexit√© sup√©rieur √† 200. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddb/a63/bac/ddba63bac1b88d806adea03d73b70888.png" alt="Figure 5"></div><br><br><h2>  Conclusion </h2><br>  Je pense que les erreurs ci-dessus suffisent pour cet article.  Oui, il y avait beaucoup d'erreurs dans le projet, mais c'est une sorte de fonctionnalit√©.  En ouvrant son code, Terry Cavanagh a montr√© qu'il n'est pas n√©cessaire d'√™tre un programmeur parfait pour √©crire un grand jeu.  Maintenant, 10 ans plus tard, Terry se souvient de ces moments avec ironie.  Il est important d'apprendre de vos erreurs et la pratique est la meilleure fa√ßon de le faire.  Et si votre pratique peut donner lieu √† un jeu comme VVVVVV, c'est tout simplement magnifique!  Eh bien ... Il est grand temps de jouer encore une fois :) <br><br>  Ce ne sont pas toutes des erreurs trouv√©es dans le code du jeu.  Si vous voulez voir par vous-m√™me ce qui peut √™tre trouv√© - je vous sugg√®re de <a href="https://www.viva64.com/en/pvs-studio-download/">t√©l√©charger et d'essayer PVS-Studio</a> !  N'oubliez pas non plus que nous proposons <a href="https://www.viva64.com/en/b/0614/">des</a> projets open source avec des licences gratuites. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484388/">https://habr.com/ru/post/fr484388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484376/index.html">Samsung Moscow Center for Artificial Intelligence in stories des employ√©s</a></li>
<li><a href="../fr484378/index.html">SwayWM - UnixPorn vous-m√™me</a></li>
<li><a href="../fr484380/index.html">D√©m√©nagement - le si√®cle dernier! Alternatives √† std :: move dans ¬´C ++ of the Future¬ª</a></li>
<li><a href="../fr484382/index.html">Algorithme de Bellman-Ford</a></li>
<li><a href="../fr484386/index.html">Meetup AWS_Ru √† Raiffeisenbank</a></li>
<li><a href="../fr484390/index.html">Glean Insights sur les 18 meilleurs cadres Java √† utiliser en 2020</a></li>
<li><a href="../fr484392/index.html">Saisies</a></li>
<li><a href="../fr484394/index.html">Sept missions spatiales les plus excitantes de l'ann√©e √† venir</a></li>
<li><a href="../fr484396/index.html">Rendre Windows Server plus s√ªr</a></li>
<li><a href="../fr484402/index.html">Code propre pour TypeScript - Partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>