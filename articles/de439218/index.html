<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👆🏽 🥅 🍍 VK Bot auf seinem Knie oder wie man Menschen am 14. Februar gefällt 💇🏽 🔗 😿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Natürlich liebt jeder von uns Geschenke, aber am allermeisten lieben wir die Wünsche, die sie begleiten. Und bis vor kurzem hatten wir nicht die Geleg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VK Bot auf seinem Knie oder wie man Menschen am 14. Februar gefällt</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439218/">  Natürlich liebt jeder von uns Geschenke, aber am allermeisten lieben wir die Wünsche, die sie begleiten.  Und bis vor kurzem hatten wir nicht die Gelegenheit, eine Person mit warmen Worten angenehm zu überraschen, bis uns die Idee einfiel: Was ist, wenn wir den Menschen die Möglichkeit geben, Valentinsgrüße auszutauschen (trotzdem am 14. Februar auf der Nase), ohne den Rahmen des üblichen Weges zu verlassen Kommunikation - Chatroom für soziale Netzwerke? <br><br>  Wort für Wort, und hier ist es - ein vorgefertigter Geschäftsplan, um die Atmosphäre des Valentinstags zu schaffen!  Werden wir Menschen glücklich machen? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dl/mp/13/dlmp134rko91zu7m-evwm5mlhem.jpeg" width="70%"></div><br><a name="habracut"></a><h2>  Für die Idee des Mondes! </h2><br>  Zunächst war es natürlich notwendig, einen Aktionsplan zu erstellen und die Idee zu beschreiben.  Aufgrund der Tatsache, dass die Leute schüchterner geworden sind und nicht immer bereit sind, irgendjemandem zu vertrauen, fiel die Wahl darauf, einen modischen und praktischen Bot für VK zu schreiben, der eine vertraute Oberfläche hat, immer zur Hand ist und die Anonymität der Nachrichten im Programmcode fest codiert wird. <br>  Zusätzlich zu all den oben genannten Vorteilen haben Communitys leider zwei Nachteile: geringe Bandbreite (Anzahl der Nachrichten pro Sekunde) und Verbot, einen Dialog mit einem zufälligen Benutzer zu beginnen (der Benutzer muss <b>zuerst</b> und <b>ausdrücklich</b> zustimmen, Nachrichten im Namen der Community zu empfangen). <br><br>  Wir haben also einen Benutzer, der bereit ist, seinem Seelenverwandten, einem Empfänger und einem Vermittler eine Valentinskarte in Form eines Chat-Bots zu senden.  Das Interaktionsschema ist einfach, der Bot sollte: Senden anbieten → Empfänger erkennen → bis 14. Februar speichern → liefern → wiederholen. <br><br>  Aber dies war natürlich nicht genug für die unersättliche Vorstellungskraft des Geistes, und um die Aktivität und Beteiligung des Publikums zu erhöhen, wurde ein Schema einer anderen Interaktion ausgearbeitet, das es den Menschen ermöglichte, sich mit dem System vertraut zu machen und Nachrichten an zufällige Menschen zu senden.  Diese „zufälligen Valentinsgrüße“ können geschätzt werden, und wenn sich Valentinsgrüße von zwei Personen mögen, geben wir ihnen die Möglichkeit, sich zu unterhalten. <br><br><h4>  Haftungsausschluss </h4><br>  <i>Dieses Projekt wurde ausschließlich aus Begeisterung von zwei Personen erstellt, einem <s>halbgebildeten</s> Programmierer (mir) und einem ideologischen Inspirator (Stepan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">sadfun</a> Popov). Es hat nicht das Ziel, Ihnen etwas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">beizubringen</a> (obwohl es Ihnen helfen kann, die Essenz des Universums zu verstehen). Erzählen Sie einfach eine interessante Schöpfungsgeschichte und folgen Sie dem Weg von einer Idee zu einer naiven Umsetzung.</i> <br><br><hr><br><h2>  Mit VK sprechen lernen </h2><br>  Nachdem <b>ich</b> auf Anfrage der <b>„NodeJS VK API“</b> 3-4 verschiedene Bibliotheken <b>durchgesehen hatte</b> , stellte ich fest, dass es keine einfachen und funktionalen Bibliotheken gibt, mit denen wir Versprechen verwenden und die Ausführung durcharbeiten können.  Erinnern Sie sich an eines der oben beschriebenen Probleme?  Ja, die Ausführung von Anforderungen an VKontakte erfolgt nicht direkt, aber in Chargen von 25 können Sie <b>den</b> Durchsatz <b>erheblich</b> steigern. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v3/fl/bp/v3flbpnqymqn0wy51ohjddwenmo.png" width="70%"></div><br>  <i>Vergleichende Fähigkeit verschiedener Methoden von Anfragen an VKontakte</i> <br><br>  Daher wurde beschlossen, etwas Eigenes zu schreiben, eine zuverlässige und nicht sehr krückenhafte Lösung, die auf der <b>Node-Fetch-</b> Bibliothek basiert. <br><br>  Um hier nicht den gesamten Code anzugeben, beschreibe ich einfach die Logik der Arbeit. <br><br>  Da Anforderungen aus dem Programm in eine Ausführung gepackt werden müssen, werden sie in der LIFO-Warteschlange gesammelt und dann gesendet, wenn: <br><br><ul><li>  Ruft 25 oder mehr auf (maximal ausführen) </li><li>  Seit dem letzten Versand ist genug Zeit vergangen, mindestens 50 Millisekunden, aber nicht mehr als 150 (so dass sich die Warteschlange trotz der geringen Größe bewegt) </li></ul><br>  Anforderungen aus der Warteschlange werden in VK-Skriptcode kompiliert, der (in dieser Implementierung) folgendermaßen aussieht: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> returnables = []; returnables[<span class="hljs-number"><span class="hljs-number">0</span></span>] = API.messages.send({<span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">", !"</span></span>, <span class="hljs-string"><span class="hljs-string">"peer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"random_id"</span></span>: <span class="hljs-number"><span class="hljs-number">561427</span></span>}); returnables[<span class="hljs-number"><span class="hljs-number">1</span></span>] = API.users.get({<span class="hljs-string"><span class="hljs-string">"user_ids"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"fields"</span></span>: <span class="hljs-string"><span class="hljs-string">"sex"</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnables;</code> </pre> <br>  Nachdem der Code durch eine Anforderung an VK ausgeführt wurde, kehrt das Ergebnis jeder Anforderung (durch die Index-Rückgabewerte) zu ihrem Rückruf zurück, der wunderschön in Promise verpackt ist.  Die Effizienz des Ansatzes ist überwältigend - je <b>mehr</b> Benutzer (und daher je mehr Anfragen an VKontakte zum Senden), desto <b>geringer ist die</b> Verzögerung der Antwort.  Um das Limit unter Kontrolle zu halten, verfügt das Sendesystem über einen Zähler, der die Anzahl der verbleibenden Anfragen für diese Sekunde anzeigt, sodass Sie schnell einen Besucheranstieg verarbeiten können. <br><br><h2>  VK lernen zu hören </h2><br>  Es gibt zwei Möglichkeiten, Benachrichtigungen über Ereignisse von VKontakte zu erhalten: <b>Longpoll-Anfragen</b> und <b>Callback-Server</b> .  Ihr Server ist praktisch, da keine speziellen Gesten erforderlich sind und Sie auch verpasste Benachrichtigungen erhalten können (z. B. wenn Sie den Server neu starten).  Ein solcher Server kann mit der nativen <b>http.Server-</b> Klasse in mehreren Zeilen geschrieben werden. <br><br>  All dies schafft ein ideales Ökosystem für die Programmlogik, das bequem zu verwenden ist. <br><br><h2>  Es endet alles </h2><br>  Da der Benutzer im Chat frei ist, etwas zu tun, und wir ihn nicht aufhalten können, müssen wir ihn auf einen angemessenen Betrag beschränken.  Die Zustandsmaschine leistet hervorragende Arbeit, indem sie jeden möglichen Übergang innerhalb des Systems festlegt und die Verwendung der Schaltflächen ( <b>Tastaturparameter</b> in messages.send) die Verwendung des Bots so einfach wie eine einzelne Berührung des Bildschirms macht. <br><br>  Hier ist die Benutzerinteraktion mit dem Bot: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/1o/fw/sz1ofwuethupwaiet4syf6ahl4u.png"></div><br>  All dies führt zu einer Reihe von Zuständen ("Hauptmenü", "Valentinstagseingabe" usw.), deren Übergänge in Schaltflächen festgelegt und übertragen werden oder die anfangs bekannt sind und sich nicht ändern. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/dz/ml/cqdzmlalb1t2o-xpdet5mvfnnek.png"></div><br>  Übrigens über die Knöpfe.  Ihr Farbumfang ist nicht unveränderlich ( <b>4 Farben</b> für alle Gelegenheiten), aber es sind die Schaltflächen, die es ermöglichen, die Anzahl der Benutzerfehler zu minimieren.  Auf ihrer Basis können Sie absolut jedes nichtlineare System erstellen, weshalb sie überall verwendet werden.  Und auch in diesem Projekt. <br><br>  Aber Sie müssen verstehen: Wenn Sie ein großes Publikum ansprechen möchten, sollten Sie eine andere Art der Interaktion in Betracht ziehen, da jemand möglicherweise eine alte Anwendung hat ( <b>VK für iPad</b> wurde zum Beispiel schon sehr lange nicht mehr aktualisiert, ich werde nicht lügen, aber es scheint mehr als ein Jahr zu dauern). und Tastaturunterstützung gibt es nicht).  Und es kommt vor (ja, es passiert, ich habe es überprüft), dass Leute, die nicht wissen, dass Schaltflächen angeklickt werden können, einfach ihren Inhalt neu schreiben (und dann wird der Parameter der Nutzlastschaltfläche natürlich nicht übertragen und alles kann kaputt gehen). <br><br>  Es ist zu beachten, dass nicht alles so reibungslos wie im Diagramm beschrieben abläuft und manchmal merkwürdige Fälle auftreten.  Beispielsweise hat das System zum Ermitteln des VKontakte-Links Benutzer falsch verarbeitet, deren kurze Links mit <b>id begonnen</b> und abgeschnitten wurden.  Die Überraschung der Leute, die auf diesen Fehler gestoßen sind, kann nicht beschrieben werden, weil sie Valentine Valentine geschrieben haben, aber es stellte sich heraus, dass Olezhka. <br><blockquote>  <b>Was olezhka ????</b> </blockquote><h2>  Unfälle sind nicht zufällig </h2><br>  Wenn also mit gewöhnlichen Valentinsgrüßen alles klar ist, gibt es einen Empfänger und einen Absender. Wie kann man dann zwei Fremde reduzieren?  Sie müssen ihre Valentinsgrüße austauschen, und wenn die Leute die Valentinsgrüße des anderen mögen, sollten sie vorgestellt werden!  Hier ist es, die Formel der Liebe! <br><br>  Obwohl dies erbärmlich klingt, funktioniert es und es wird für Menschen interessanter, mit dem Bot zu arbeiten - sie erhalten eine positive Antwort, wenn es mindestens eine Person gibt (um die sich der Bot natürlich kümmert). <br><br>  Daraus ergibt sich ein großes Plus: Je mehr Menschen diese Gelegenheit nutzen, desto mehr Chancen haben sie, sich kennenzulernen, und daher hält dies wie ein Spiel eine Person in einem Chat.  Es lohnt sich zuzugeben, dass die durchschnittliche Benutzersitzung ~ 7 Minuten dauert, aber es besteht die Möglichkeit, eine Person nur wegen dieser Funktion um <b>10-15</b> zu straffen. <br><br>  Die Verteilung von Nachrichten erzwang ein separates Schema, da es mehrere Optionen für die Verwendung dieses Bots gibt, der Benutzer etwas aus den Augen verlieren kann und der Bot ihn sorgfältig daran erinnert. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pj/8a/bw/pj8abwsu2zjmkhotgiffi0jldse.jpeg"></div><br>  Es ist interessant, wie das zweite Problem gelöst wurde, mit der Unfähigkeit der Community, zuerst einen Dialog mit dem Benutzer zu initiieren: Jetzt wird dieses Problem durch eine solche Nachricht gelöst. <br><blockquote>  Aber ich habe eine Bedingung!  Damit der Empfänger Ihren Valentinstag erhält, muss er mir auch schreiben.  Ihre Aufgabe ist es jetzt, ihn zu überreden, mir etwas zu schreiben.  Dies geschieht, damit Sie keine Angst haben, mit ihm zu sprechen! </blockquote>  Im Allgemeinen ist das traditionelle "Kein Fehler, aber eine Funktion!" <br><br><h2>  Feuerwerk am Ende </h2><br>  Das ist alles!  Wenn Sie einige Schwierigkeiten beim Verständnis der Logik der VK-API sowie bei der Bestätigung des Kontos bei einem der Anbieter nicht berücksichtigen, verlief alles noch zu reibungslos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/gb/yt/-7gbythuuwaf87k6c-v4k5-shok.png"></div><br>  <i>Beispiel Chat mit einem Bot</i> <br><br>  Der Bot funktioniert und wird Menschen mit Valentinsgrüßen begeistern und sie glücklich machen.  Dies geschieht, um den Menschen zu helfen, freundlicher miteinander umzugehen.  Sie können dies alles selbst in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Valentinych-</a> Community <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">bewerten - vk.com/verylovebot</a> , wenn Sie dies wünschen.  Vielen Dank für Ihre Aufmerksamkeit! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de439218/">https://habr.com/ru/post/de439218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de439204/index.html">Verbesserung der Effizienz der Photosynthese durch genetische Veränderung von Pflanzen</a></li>
<li><a href="../de439206/index.html">Wie haben wir das Problem der Fortsetzung der Wiedergabelisten bei RecSys Challenge gelöst und den 3. Platz belegt?</a></li>
<li><a href="../de439208/index.html">Oh, mein Code: Wie MAPS.ME funktioniert</a></li>
<li><a href="../de439210/index.html">Java nach Vulkanausbruch</a></li>
<li><a href="../de439216/index.html">Pudge 500 Zeilen einbettbare Datenbank auf Golang</a></li>
<li><a href="../de439220/index.html">Großstadt für mobile Geräte auf Unity. Erfahrung in Entwicklung und Optimierung</a></li>
<li><a href="../de439222/index.html">Was ist API-Verwaltung?</a></li>
<li><a href="../de439224/index.html">Nochmals zu Voronoi-Diagrammen</a></li>
<li><a href="../de439226/index.html">Scala + MXNet = Microservice mit Neuron in Prod</a></li>
<li><a href="../de439232/index.html">JAMstack: So erstellen Sie Ihr eigenes Blog mit Gatsby + Contentful + Netlify</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>