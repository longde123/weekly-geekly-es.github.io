<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè£ üèà ü§¥üèª 7 conseils utiles pour utiliser la pi√®ce üîØ üë©üèº‚Äçü§ù‚Äçüë®üèø üèí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Room est une couche d'abstraction au-dessus de SQLite qui simplifie le stockage. Si vous √™tes nouveau dans Room, consultez cet article d'introduction:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>7 conseils utiles pour utiliser la pi√®ce</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442786/"><p><img src="https://habrastorage.org/getpro/habr/post_images/67f/9e9/00f/67f9e900f75e27bf3453979d40ea4ef1.jpg" alt="7 conseils utiles pour utiliser la pi√®ce"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Room</a> est une couche d'abstraction au-dessus de SQLite qui simplifie le stockage.  Si vous √™tes nouveau dans Room, consultez cet article d'introduction: </p><br><blockquote>  <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">7 √©tapes pour utiliser Room.</a></em>  <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Proc√©dure pas √† pas pour la migration de votre application vers Room</a></em> </blockquote><p>  Et dans cet article, je voudrais partager quelques conseils sur la fa√ßon d'utiliser Room aussi efficacement que possible. </p><a name="habracut"></a><br><h2 id="1-predvaritelnoe-zapolnenie-bazy-dannyh">  1. Pr√©remplir la base de donn√©es </h2><br><p> Devez-vous ajouter des donn√©es par d√©faut √† votre base de donn√©es imm√©diatement apr√®s sa cr√©ation ou au moment du premier acc√®s?  Utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RoomDatabase # Callback</a> .  Appelez la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">addCallback</a> lors de la cr√©ation de votre base de donn√©es et remplacez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">onCreate</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">onOpen</a> . </p><br><p> <code>onCreate</code> sera appel√© lors de la premi√®re cr√©ation de la base de donn√©es, imm√©diatement apr√®s la cr√©ation des tables.  <code>onOpen</code> est appel√© lorsque la base de donn√©es est ouverte.  Puisque l'acc√®s au DAO n'est possible qu'apr√®s l'ach√®vement de ces m√©thodes, nous cr√©ons un nouveau flux dans lequel nous obtenons un lien vers la base de donn√©es, puis nous obtenons le DAO et ins√©rons les donn√©es n√©cessaires. </p><br><pre> <code class="kotlin hljs">Room.databaseBuilder(context.applicationContext, DataDatabase::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">"Sample.db") // prepopulate the database after onCreate was called .addCallback</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : Callback() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">SupportSQLiteDatabase</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(db) <span class="hljs-comment"><span class="hljs-comment">// moving to a new thread ioThread { getInstance(context).dataDao() .insert(PREPOPULATE_DATA) } } }) .build()</span></span></code> </pre> <br><p>  Voir l'exemple complet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  <strong>Remarque:</strong> si vous utilisez l'approche <code>ioThread</code> et que l'application se bloque au premier d√©marrage, entre la cr√©ation de la base de donn√©es et l'insertion, les donn√©es ne seront jamais ins√©r√©es. </p><br><h2 id="2-ispolzovanie-vozmozhnostey-nasledovaniya-dao">  2. Utilisation des capacit√©s d'h√©ritage DAO </h2><br><p>  Avez-vous plusieurs tables dans votre base de donn√©es et copiez-vous les m√™mes m√©thodes d' <strong>insertion</strong> , de <strong>mise √† jour</strong> et de <strong>suppression</strong> ?  Les DAO prennent en charge l'h√©ritage, alors cr√©ez une <code>BaseDao&lt;T&gt;</code> et d√©finissez-y vos m√©thodes courantes <code>@Insert</code> , <code>@Update</code> et <code>@Delete</code> .  Laissez chaque DAO √©tendre <code>BaseDao</code> et ajoutez des m√©thodes sp√©cifiques √† chacun d'eux. </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Insert</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">vararg</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> } <span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataDao</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Query(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SELECT * FROM Data"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: List&lt;Data&gt; }</code> </pre> <br><p>  Voir les d√©tails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Les DAO doivent √™tre des interfaces ou des classes abstraites car Room g√©n√®re leur impl√©mentation au moment de la compilation, y compris les m√©thodes de <code>BaseDao</code> . </p><br><h2 id="3-vypolnenie-zaprosov-v-tranzakciyah-bez-shablonnogo-koda">  3. Ex√©cution de requ√™tes dans les transactions sans code passe-partout </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'annotation d'une</a> m√©thode √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@Transaction</a> garantit que toutes les op√©rations de base de donn√©es que vous effectuez dans cette m√©thode sont ex√©cut√©es dans la m√™me transaction.  Une transaction ne sera pas ex√©cut√©e si une exception se produit dans le corps de la m√©thode. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(users: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">List</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { deleteAllUsers() insertAll(users) } <span class="hljs-meta"><span class="hljs-meta">@Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(users: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">List</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> <span class="hljs-meta"><span class="hljs-meta">@Query(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DELETE FROM Users"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteAllUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> }</code> </pre> <br><p>  Vous souhaiterez peut-√™tre utiliser l'annotation <code>@Transaction</code> pour les m√©thodes <code>@Transaction</code> qui utilisent l'instruction <code>select</code> dans les cas: </p><br><ul><li>  Lorsque le r√©sultat de la requ√™te est assez volumineux.  En effectuant une demande en une seule transaction, vous garantissez que si le r√©sultat de la demande ne tient pas dans une "partie" du curseur, il ne sera pas endommag√© en raison des changements dans la base de donn√©es entre les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">permutations du curseur</a> . </li><li>  Lorsque le r√©sultat de la requ√™te est un POJO avec des champs <code>@Relation</code> .  Chaque champ est une demande en soi, donc les ex√©cuter en une seule transaction garantit des r√©sultats coh√©rents entre les demandes. </li></ul><br><p>  Les <code>@Delete</code> , <code>@Update</code> et <code>@Insert</code> , qui ont plusieurs param√®tres, sont automatiquement lanc√©es dans la transaction. </p><br><h2 id="4-chtenie-tolko-togo-chto-vam-nuzhno">  4. Lire uniquement ce dont vous avez besoin </h2><br><p>  Lorsque vous faites une demande √† la base de donn√©es, utilisez-vous tous les champs que vous obtenez dans la r√©ponse?  Prenez soin de la quantit√© de m√©moire utilis√©e par votre application et t√©l√©chargez uniquement les champs que vous utiliserez finalement.  Cela augmentera √©galement la vitesse de vos demandes en r√©duisant le co√ªt des E / S.  Room fera le mapping entre les colonnes et l'objet pour vous. </p><br><p>  Consid√©rez cet objet <code>User</code> complexe: </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity(tableName = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"users"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span></span>(<span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> id: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> firstName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lastName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> email: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dateOfBirth: Date, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> registrationDate: Date)</code> </pre> <br><p>  Sur certains √©crans, nous n'avons pas besoin d'afficher toutes ces informations.  Ainsi, √† la place, nous pouvons cr√©er un objet <code>UserMinimal</code> qui contient uniquement les donn√©es n√©cessaires. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserMinimal</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userId: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> firstName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lastName: String)</code> </pre> <br><p>  Dans la classe DAO, nous d√©finissons la requ√™te et s√©lectionnons les colonnes correctes dans la table des <code>users</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Query(‚ÄúSELECT userId, firstName, lastName FROM Users)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsersMinimal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: List&lt;UserMinimal&gt; }</code> </pre> <br><h2 id="5-kontrol-zavisimostey-mezhdu-suschnostyami-s-vneshnimi-klyuchami">  5. Contr√¥le des d√©pendances entre les entit√©s avec des cl√©s √©trang√®res </h2><br><p>  M√™me si Room <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne prend pas directement en charge les</a> relations entre les entit√©s, il vous permet de d√©finir des d√©pendances entre des objets √† l'aide de cl√©s √©trang√®res. </p><br><p>  Room a l'annotation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@ForeignKey</a> , qui fait partie de l'annotation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@Entity</a> .  En termes de fonctionnalit√©, il est similaire aux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cl√©s √©trang√®res dans SQLite</a> .  Il garantit la pr√©servation des relations entre les entit√©s lorsque des modifications sont apport√©es √† la base de donn√©es.  Pour l'ajouter, d√©finissez l'objet √† r√©f√©rencer, ainsi que les colonnes de l'objet courant et le volume auquel vous faites r√©f√©rence. </p><br><p>  Consid√©rez la classe <code>User</code> et <code>Pet</code> .  <code>Pet</code> a un propri√©taire - l'ID utilisateur r√©f√©renc√© par la cl√© √©trang√®re. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity(tableName = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pets"</span></span></span><span class="hljs-meta">, foreignKeys = arrayOf( ForeignKey(entity = User::class, parentColumns = arrayOf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"userId"</span></span></span><span class="hljs-meta">)</span></span>, childColumns = arrayOf(<span class="hljs-string"><span class="hljs-string">"owner"</span></span>)))) <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pet</span></span></span></span>(<span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> petId: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> name: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> owner: String)</code> </pre> <br><p>  Si vous le souhaitez, vous pouvez d√©terminer l'action √† entreprendre lorsque le parent est supprim√© ou mis √† jour dans la base de donn√©es.  Vous pouvez choisir l'une des options suivantes: <code>NO_ACTION</code> , <code>RESTRICT</code> , <code>SET_NULL</code> , <code>SET_DEFAULT</code> ou <code>CASCADE</code> , qui se comportent de la m√™me mani√®re que dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SQLite</a> . </p><br><p>  <strong>Remarque:</strong> dans Room, <code>SET_DEFAULT</code> fonctionne comme <code>SET_NULL</code> , car  Room ne vous permet pas encore de d√©finir des valeurs par d√©faut pour les colonnes. </p><br><h2 id="6-uproschenie-zaprosov-odin-ko-mnogim-s-pomoschyu-relation">  6. Simplifiez les requ√™tes un-√†-plusieurs avec @Relation </h2><br><p>  Dans l'exemple pr√©c√©dent <code>User</code> - <code>Pet</code> , nous pouvons dire qu'il existe une relation <strong>un-√†-plusieurs</strong> : l'utilisateur peut avoir plusieurs animaux.  Supposons que nous voulons obtenir une liste d'utilisateurs avec leurs animaux de compagnie: <code>List&lt;UserAndAllPets&gt;</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserAndAllPets</span></span></span><span class="hljs-class"> </span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> pets: List&lt;Pet&gt; = ArrayList())</code> </pre> <br><p>  Pour ce faire manuellement, nous avons besoin de 2 requ√™tes: l'une pour obtenir une liste de tous les utilisateurs et l'autre pour obtenir une liste d'animaux de compagnie en fonction de l'ID utilisateur. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Query(‚ÄúSELECT * FROM Users‚Äù)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;User&gt; getUsers(); <span class="hljs-meta"><span class="hljs-meta">@Query(‚ÄúSELECT * FROM Pets where owner = :userId‚Äù)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Pet&gt; getPetsForUser(String userId);</code> </pre> <br><p>  Ensuite, nous allons parcourir la liste des utilisateurs et acc√©der √† la table <code>Pets</code> chaque fois. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'</a> annotation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@Relation nous</a> facilitera la vie: elle demandera automatiquement les objets associ√©s.  <code>@Relation</code> ne peut √™tre appliqu√© qu'√† <code>List</code> ou <code>Set</code> .  Mettez √† jour la classe UserAndAllPets: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserAndAllPets</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Embedded</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user: User? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@Relation(parentColumn = ‚ÄúuserId‚Äù, entityColumn = ‚Äúowner‚Äù)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pets: List&lt;Pet&gt; = ArrayList() }</code> </pre> <br><p>  Dans le DAO, nous d√©finissons une requ√™te, et Room interrogera les tables <code>Users</code> and <code>Pets</code> et mappera les objets de mani√®re autonome. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Transaction</span></span> <span class="hljs-meta"><span class="hljs-meta">@Query(‚ÄúSELECT * FROM Users‚Äù)</span></span> List&lt;UserAndAllPets&gt; getUsers();</code> </pre> <br><h2 id="7-izbezhanie-lozhnyh-uvedomleniy-observable-zaprosov">  7. √âviter les fausses notifications pour les demandes observables </h2><br><p>  Supposons que vous souhaitiez obtenir un utilisateur par son identifiant √† l'aide d'une requ√™te observable: </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Query(‚ÄúSELECT * FROM Users WHERE userId = :id)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: LiveData&lt;User&gt; <span class="hljs-comment"><span class="hljs-comment">// or @Query(‚ÄúSELECT * FROM Users WHERE userId = :id) fun getUserById(id: String): Flowable&lt;User&gt;</span></span></code> </pre> <br><p>  Vous recevrez un nouvel objet <code>User</code> chaque mise √† jour.  Mais vous recevrez √©galement cet objet lorsque d'autres modifications se produisent dans la table <code>Users</code> (suppressions, mises √† jour ou insertions) qui n'ont rien √† voir avec l'utilisateur qui vous int√©resse, ce qui entra√Ænera de fausses notifications.  De plus, si votre requ√™te comprend plusieurs tableaux, vous recevrez de nouveaux messages chaque fois que quelque chose change dans l'un d'eux. </p><br><p>  Voici ce qui se passe dans les coulisses: </p><br><ol><li>  SQLite a des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©clencheurs</a> qui se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©clenchent</a> chaque fois que <code>DELETE</code> , <code>UPDATE</code> ou <code>INSERT</code> se produit dans une table. </li><li>  Room cr√©e un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InvalidationTracker</a> qui utilise des <code>Observers</code> qui suivent toutes les modifications dans les tables observ√©es. </li><li>  Les demandes <code>LiveData</code> et <code>LiveData</code> reposent toutes deux sur la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notification InvalidationTracker.Observer # onInvalidated</a> .  Lorsqu'il est re√ßu, une demande r√©p√©t√©e se produit. </li></ol><br><p>  La chambre sait seulement que la table a √©t√© chang√©e, mais ne sait pas pourquoi ni ce qui a chang√©.  Par cons√©quent, apr√®s une deuxi√®me demande, le r√©sultat de la demande est transmis √† l'aide de <code>LiveData</code> ou <code>LiveData</code> .  Parce que  La pi√®ce ne stocke aucune donn√©e en m√©moire; elle ne peut pas d√©terminer s'il s'agit des m√™mes donn√©es ou non. </p><br><p>  Vous devez vous assurer que votre DAO <strong>filtre les demandes</strong> et ne r√©pond qu'aux objets n√©cessaires. </p><br><p>  Si la requ√™te observable est impl√©ment√©e √† l'aide de <code>Flowables</code> , utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Flowable # diverUntilChanged</a> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-comment"><span class="hljs-comment">/** * Get a user by id. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> the user from the table with a specific id. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Query(‚ÄúSELECT * FROM Users WHERE userid = :id‚Äù)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Flowable&lt;User&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistinctUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Flowable&lt;User&gt; = getUserById(id) .distinctUntilChanged() }</code> </pre> <br><p>  Si votre requ√™te renvoie <code>LiveData</code> , vous pouvez utiliser <code>MediatorLiveData</code> , qui ne recevra que les objets souhait√©s de la source. </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> LiveData</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistinct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: LiveData&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> distinctLiveData = MediatorLiveData&lt;T&gt;() distinctLiveData.addSource(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : Observer&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> initialized = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObj: T? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!initialized) { initialized = <span class="hljs-literal"><span class="hljs-literal">true</span></span> lastObj = obj distinctLiveData.postValue(lastObj) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((obj == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; lastObj != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) || obj != lastObj) { lastObj = obj distinctLiveData.postValue(lastObj) } } }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> distinctLiveData }</code> </pre> <br><p>  Dans vos DAO, la m√©thode qui retourne <code>LiveData</code> est <code>public</code> et la m√©thode qui interroge la base de donn√©es est <code>protected</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Query(‚ÄúSELECT * FROM Users WHERE userid = :id‚Äù)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: LiveData&lt;User&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistinctUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: LiveData&lt;User&gt; = getUserById(id).getDistinct() }</code> </pre> <br><p>  Voir l'exemple de code complet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  <strong>Remarque:</strong> si vous demandez une liste √† afficher, faites attention √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que de pagination</a> , qui renverra un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LivePagedListBuilder</a> .  La biblioth√®que vous aidera √† calculer automatiquement la diff√©rence entre les √©l√©ments de la liste et √† mettre √† jour votre interface utilisateur. </p><br><blockquote>  <em>Voir aussi: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">7 √©tapes pour utiliser Room.</a></em>  <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Proc√©dure pas √† pas pour la migration de votre application vers Room</a></em> </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442786/">https://habr.com/ru/post/fr442786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442776/index.html">Index dans PostgreSQL - 3 (Hash)</a></li>
<li><a href="../fr442778/index.html">Learning Go: une s√©lection de reportages vid√©o</a></li>
<li><a href="../fr442780/index.html">Id√©es fausses les plus courantes en physique populaire</a></li>
<li><a href="../fr442782/index.html">VShard - mise √† l'√©chelle horizontale dans Tarantool</a></li>
<li><a href="../fr442784/index.html">D√©tournement BGP en ajoutant AS victime √† AS-SET de l'attaquant</a></li>
<li><a href="../fr442788/index.html">Pourquoi avons-nous besoin d'un syst√®me de surveillance sur une puce</a></li>
<li><a href="../fr442790/index.html">L'inscription est ouverte pour Allure Server Meetup √† Saint-P√©tersbourg</a></li>
<li><a href="../fr442794/index.html">Nous vous invitons √† la conf√©rence ¬´Architecte (IT) dans les projets et organisations IT¬ª</a></li>
<li><a href="../fr442796/index.html">Enqu√™te: technologies cloud dans les services SIG et de g√©odonn√©es</a></li>
<li><a href="../fr442798/index.html">La surveillance des pings entre les h√¥tes Kubernetes est notre recette</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>