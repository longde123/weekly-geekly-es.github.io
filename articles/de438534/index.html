<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üß§ üò∑ üëâüèæ Modbus auf dem russischen Mikrocontroller K1986BE92QI üßëüèæ‚Äçü§ù‚ÄçüßëüèΩ üë©‚Äçüî¨ üôã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich bin in die H√§nde des russischen Mikrocontrollers K1986BE92QI gefallen , der von PKK Milander JSC mit 32-Bit-RISC-Kern ARM Cortex-M3 128 kB Flash u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modbus auf dem russischen Mikrocontroller K1986BE92QI</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438534/"><p>  Ich bin in die H√§nde des russischen Mikrocontrollers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">K1986BE92QI gefallen</a> , der von PKK Milander JSC mit 32-Bit-RISC-Kern ARM Cortex-M3 128 kB Flash und 32 kB RAM hergestellt wurde. Ich wollte ihn sofort in Aktion studieren und testen. </p><br><p>  Der Mikrocontroller wird in einem Paket geliefert, um das die Chinesen mit AliExpress beneiden.  Der Chip liegt in einer Kassette aus dicker Aluminiumfolie, die in Folienpapier eingewickelt ist, mit Schaumgummi ausgelegt ist, und dieses ganze ‚ÄûSandwich‚Äú in einem Karton mit mit Folie bedeckten Innenw√§nden.  Im Allgemeinen Schutz vor statischer Elektrizit√§t in der H√∂he. </p><br><p><img src="https://habrastorage.org/webt/0q/uf/jp/0qufjpcjdcgtbhvw-0fnxyrmass.jpeg"></p><a name="habracut"></a><br><p><img src="https://habrastorage.org/webt/ef/yp/2b/efyp2bwavnh5hqejpdqiatxogz8.jpeg"></p><br><p>  Zum Mikrocontroller geh√∂rt ein Etikett und ein Produktauswahlprotokoll, was sehr sch√∂n ist. </p><br><p><img src="https://habrastorage.org/webt/xi/_f/ui/xi_fui1ln8ovx9k0laosvk76pdm.jpeg"></p><br><p>  Zun√§chst war es notwendig, einen Schaltplan der Debug-Karte zu entwickeln und die Komponenten zu bestimmen.  Er stoppte bei einem Minimum an Komponenten: einem 3,3-V-Stabilisator f√ºr die Stromversorgung √ºber einen USB-Anschluss, einem 8-MHz-Quarzresonator, einem Mini-USB-Anschluss, einem Reset-Knopf, Pull-up-Widerst√§nden und Schluck-Anschl√ºssen.  Ich denke f√ºr die ersten Experimente mit dem Mikrocontroller ist genug.  Stellen Sie auch den smd-Schalter ein, um den Modus des eingebauten Bootloaders auszuw√§hlen.  Mit dem Mikrocontroller k√∂nnen Sie die Methode zum Herunterladen des Programms √ºber eine von zwei seriellen Schnittstellen UART oder JTAG / SWD ausw√§hlen, w√§hrend Sie mit JTAG das Programm im Mikrocontroller debuggen k√∂nnen.  Die Wahl der Programmlademethode wird durch die Logikpegel an den Ausg√§ngen PF4, PF5, PF6 bestimmt.  Alle m√∂glichen Optionen sind in der Tabelle dargestellt: </p><br><p><img src="https://habrastorage.org/webt/ky/my/en/kymyenw4iasc8nygqi79xliwgby.png"></p><br><p>  Der Mikrocontroller ist ein Chip aus einem Kunststoffgeh√§use LQFP64 mit 0,3 mm breiten und 0,2 mm dazwischen liegenden Stiften, was darauf hindeutet, dass mit der LUT-Technologie keine Leiterplatte von akzeptabler Qualit√§t hergestellt werden kann. Die Erfahrung hat jedoch das Gegenteil best√§tigt.  In wenigen Stunden wurde eine PCB-Zeichnung im Sprint-Layout erstellt, auf Lamond-Papier mit hoher Dichte gedruckt und auf Glasfaser √ºbertragen.  Das √Ñtzen erfolgte in einer L√∂sung von Peroxid und Zitronens√§ure mit dem Auge und dauerte etwa eine Stunde, √ºberraschenderweise war die Qualit√§t der Leiter beim ersten Mal akzeptabel, was erfreute. </p><br><p><img src="https://habrastorage.org/webt/hy/zb/vt/hyzbvtnawxs-d5kfdff0swzqx_w.jpeg"></p><br><p>  Und so wird die Platine erstellt, alle Komponenten werden verl√∂tet, es bleibt zu programmieren.  Wir werden die Entwicklungsumgebung von Keil - MDK ARM uVision 5.0 verwenden, das <a href="">Softwarepaket</a> <a href="">Standard Peripherals Library</a> + <a href="">wird</a> vom Hersteller des Mikrocontrollers an Keil verteilt.  Ich wollte nicht in UART programmieren, deshalb habe ich mich f√ºr den ST-Link v2 In-Circuit-Programmierer / Debugger oder dessen Klon eines unbekannten chinesischen Herstellers entschieden.  Keil unterst√ºtzt es sofort, aber der Mikrocontroller hat vergessen, wie und wo er angeschlossen werden soll, obwohl in der Dokumentation angegeben ist, dass er die SWD-Schnittstelle unterst√ºtzt.  Nach der Suche im Internet nach: "JTAG - SWD-Adapter" wurde festgestellt, dass die SWDIO-Leitung eine Verbindung zu JTAG-TMS und SWCLK zu JTAG-TCK und "Oh Wunder!"  Alles hat funktioniert, ein Testprogramm wurde in den Mikrocontroller geflasht. </p><br><p><img src="https://habrastorage.org/webt/3p/ca/qm/3pcaqm5rotui8hxuc8gi1svzrdi.jpeg"></p><br><p>  Dies war das Ende der Freude, denn nach der Firmware scheint der Mikrocontroller, obwohl er funktioniert hat, nicht mehr mit dem Debugger zu arbeiten.  Anscheinend werden nach dem Flashen die JTAG-A-Portleitungen f√ºr einen anderen funktionalen Zweck neu definiert, obwohl in dem Programmport B, auf dem sich JTAG-A befindet, nicht einmal initialisiert wurde.  Ich wollte das nicht verstehen, da es auch einen JTAG-B gibt.  Bei Anschluss an eine alternative JTAG-Schnittstelle funktionierte alles wie eine Uhr.  In Zukunft werden wir es zum Programmieren und Debuggen verwenden. </p><br><p>  Die erste Aufgabe f√ºr mich bestand darin, den Controller √ºber das Modbus-Protokoll mit dem SCADA-System zu verbinden.  Um das Rad nicht neu zu erfinden, nehmen wir die plattform√ºbergreifende <a href="">Freemodbus-Freemodbus-</a> Bibliothek und <a href="">portieren</a> sie f√ºr unseren Mikrocontroller. </p><br><p>  Um Projekte in Keil auf einem Mikrocontroller von Milander zu erstellen, m√ºssen Sie zuerst das Softwarepaket installieren.  Dies erfolgt durch einen einfachen Doppelklick auf die Datei.  Als n√§chstes wird Keil alles selbst machen. </p><br><p>  Und so erstellen wir ein neues Projekt.  Wir w√§hlen unsere Mikrocontroller- und Bibliothekskomponenten aus, die wir ben√∂tigen: </p><br><p><img src="https://habrastorage.org/webt/gj/vj/5h/gjvj5hrhozennt2gtoebvuexdlw.jpeg"></p><br><p>  Erstellen Sie im Projektbaum die Modbus-Slave-Gruppe und f√ºgen Sie dort die folgenden Dateien aus der Freemodbus-Bibliothek hinzu: </p><br><p><img src="https://habrastorage.org/webt/nl/rt/v4/nlrtv4psj1ta43rupd9t_hco590.jpeg"></p><br><p>  Vergessen Sie in den Projektoptionen nicht, dem Compiler die folgenden Pfade zu den Bibliotheksverzeichnissen anzugeben. </p><br><p><img src="https://habrastorage.org/webt/im/xu/bx/imxubxvmei8hr9zsqbpneut0bzk.jpeg"></p><br><p>  Jetzt k√∂nnen Sie beginnen, die Freemodbus-Bibliothek mithilfe der Standard-Peripheriebibliothek gezielt auf unseren Mikrocontroller zu portieren.  Dazu m√ºssen Sie die Initialisierungsfunktion des UART-Ports xMBPortSerialInit in der Datei portserial.c angeben </p><br><pre><code class="plaintext hljs">BOOL xMBPortSerialInit( UCHAR ucPORT, ULONG ulBaudRate, UCHAR ucDataBits, eMBParity eParity ) { //    F RST_CLK_PCLKcmd(RST_CLK_PCLK_PORTF, ENABLE); //      PORT_InitTypeDef uart2_port_set; //   F   UART //     PORT_StructInit(&amp;uart2_port_set); //    uart2_port_set.PORT_FUNC = PORT_FUNC_OVERRID; //    uart2_port_set.PORT_SPEED = PORT_SPEED_MAXFAST; //     uart2_port_set.PORT_MODE = PORT_MODE_DIGITAL; //   PF1  UART_TX () uart2_port_set.PORT_Pin = PORT_Pin_1; uart2_port_set.PORT_OE = PORT_OE_OUT; PORT_Init(MDR_PORTF, &amp;uart2_port_set); //   PF0  UART_RX () uart2_port_set.PORT_Pin = PORT_Pin_0; uart2_port_set.PORT_OE = PORT_OE_IN; //    UART //   UART2 RST_CLK_PCLKcmd(RST_CLK_PCLK_UART2, ENABLE); //      UART UART_InitTypeDef UART_InitStructure; //    UART = 1 UART_BRGInit(MDR_UART2,UART_HCLKdiv1); //  UART //    ‚Äì 115200  UART_InitStructure.UART_BaudRate = ulBaudRate; //     ‚Äì 8 UART_InitStructure.UART_WordLength = UART_WordLength8b; //  - UART_InitStructure.UART_StopBits = UART_StopBits1; //    UART_InitStructure.UART_Parity = UART_Parity_No; //    FIFO   , // ..      UART_InitStructure.UART_FIFOMode = UART_FIFO_OFF; //      UART_InitStructure.UART_HardwareFlowControl = UART_HardwareFlowControl_RXE | UART_HardwareFlowControl_TXE; //  UART2    UART_Init(MDR_UART2, &amp;UART_InitStructure); //   UART UART_Cmd(MDR_UART2, ENABLE); return TRUE; }</code> </pre> <br><p>  Schreib- und Lesefunktion: </p><br><pre> <code class="plaintext hljs">BOOL xMBPortSerialPutByte( CHAR ucByte ) { //  UART_SendData(MDR_UART2,ucByte); return TRUE; } BOOL xMBPortSerialGetByte( CHAR * pucByte ) { //  *pucByte = (uint8_t) UART_ReceiveData(MDR_UART2); return TRUE; }</code> </pre><br><p>  UART Interrupt Handler </p><br><pre> <code class="plaintext hljs"> void USART2_IRQHandler(void) { /*     ---------------------------------------------------*/ if((UART_GetITStatus(MDR_UART2,UART_IT_RX)) != RESET) { prvvUARTRxISR( ); } /*     ------------------------------------------------*/ if((UART_GetITStatus(MDR_UART2,UART_IT_TX)) !=RESET) { prvvUARTTxReadyISR( ); } }</code> </pre><br><p>  Anschlie√üend bearbeiten wir die Datei portimer.c, in der ein Timer konfiguriert ist, der tempor√§re Berichte generiert, um das Ende des Modbus-Protokollpakets zu verfolgen. </p><br><pre> <code class="plaintext hljs">BOOL xMBPortTimersInit( USHORT usTim1Timerout50us ) { MDR_RST_CLK-&gt;PER_CLOCK |= (1&lt;&lt;14); //   TIM1 MDR_RST_CLK-&gt;TIM_CLOCK = 0x0; MDR_RST_CLK-&gt;TIM_CLOCK |= (1&lt;&lt;24); // TIM1_CLK_EN MDR_RST_CLK-&gt;TIM_CLOCK |= 0x07; // HCLK/8   MDR_TIMER1-&gt;CNTRL = 0x00000002; //   MDR_TIMER1-&gt;CNT = 0x00000000; //  MDR_TIMER1-&gt;PSG = 0x2; //f/1   while((MDR_TIMER1-&gt;CNTRL &amp; 0x004) != 0) {__NOP();} //    MDR_TIMER1-&gt;ARR = usTim1Timerout50us; //     while((MDR_TIMER1-&gt;CNTRL &amp; 0x004) != 0) {__NOP();} //     MDR_TIMER1-&gt;IE = 0x00000002; //(CNT==ARR)-&gt;IE      NVIC-&gt;ISER[0] = (1&lt;&lt;14); // Global EN for IRQ14   MDR_TIMER1-&gt;CNTRL |= (1&lt;&lt;0); //Timer1 ON   return TRUE; } inline void vMBPortTimersEnable( ) { /*    */ MDR_TIMER1-&gt;CNTRL |= (1&lt;&lt;0); //Timer1 ON } inline void vMBPortTimersDisable( ) { /*    */ MDR_TIMER1-&gt;CNTRL &amp;= ~(1&lt;&lt;0); //Timer1 OFF } static void prvvTIMERExpiredISR( void ) { ( void )pxMBPortCBTimerExpired( ); } void Timer1_IRQHandler(void) { //   MDR_TIMER1-&gt;STATUS &amp;= ~0x002; //IE FLAG=0 prvvTIMERExpiredISR( ); }</code> </pre> <br><p>  In main.c werden wir Modbus-Registerverarbeitungsfunktionen hinzuf√ºgen und nicht verwendete Register mit Stubs d√§mpfen </p><br><pre> <code class="plaintext hljs">/* ----------------------- Defines ------------------------------------------*/ #define REG_INPUT_START 1000 #define REG_INPUT_NREGS 4 /* ----------------------- Static variables ---------------------------------*/ static USHORT usRegInputStart = REG_INPUT_START; static USHORT usRegInputBuf[REG_INPUT_NREGS]; eMBErrorCode eMBRegInputCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNRegs ) { eMBErrorCode eStatus = MB_ENOERR; int iRegIndex; if( ( usAddress &gt;= REG_INPUT_START ) &amp;&amp; ( usAddress + usNRegs &lt;= REG_INPUT_START + REG_INPUT_NREGS ) ) { iRegIndex = ( int )( usAddress - usRegInputStart ); while( usNRegs &gt; 0 ) { *pucRegBuffer++ = ( unsigned char )( usRegInputBuf[iRegIndex] &gt;&gt; 8 ); *pucRegBuffer++ = ( unsigned char )( usRegInputBuf[iRegIndex] &amp; 0xFF ); iRegIndex++; usNRegs--; } } else { eStatus = MB_ENOREG; } return eStatus; } eMBErrorCode eMBRegHoldingCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNRegs, eMBRegisterMode eMode ) { return MB_ENOREG; } eMBErrorCode eMBRegCoilsCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNCoils, eMBRegisterMode eMode ) { return MB_ENOREG; } eMBErrorCode eMBRegDiscreteCB( UCHAR * pucRegBuffer, USHORT usAddress, USHORT usNDiscrete ) { return MB_ENOREG; }</code> </pre> <br><p>  Dies ist das Ende der Portierung. Es verbleibt nur in der Funktion int main (void), um die Bibliothek zu initialisieren und eMBPoll () in einer Schleife aufzurufen. </p><br><pre> <code class="plaintext hljs">int main (void) { eMBErrorCode eStatus; // UART    ,   portserial.c  xMBPortSerialInit    eStatus = eMBInit( MB_RTU, 0x0A, 0, 19200, MB_PAR_NONE ); /* Enable the Modbus Protocol Stack. */ eStatus = eMBEnable( ); while(1) { eStatus = eMBPoll( ); //  if (eStatus!= MB_ENOREG){}; /* Here we simply count the number of poll cycles. */ usRegInputBuf[0]++; } }</code> </pre><br><p>  Wir kompilieren alles fehlerfrei, aber nichts funktioniert.  Im Debug-Modus stellen wir fest, dass Pakete verarbeitet werden und das Programm an der √úbertragungsinitialisierung h√§ngt.  Wenn ein Interrupt vom UART-Sender eingeschaltet wird, wird der Interrupt nicht aufgerufen und das Programm geht in eine Endlosschleife.  Nach dem Studium des Abschnitts ‚ÄûBeschreibung des UART‚Äú wurden die Spezifikationen des Mikrocontrollers auf einen Hinweis gesto√üen: </p><br><blockquote>  Die Senderunterbrechung funktioniert an der Flanke, nicht auf dem Signalpegel.  Wenn das Modul und seine Interrupts zul√§ssig sind, bevor die Daten in den Sender-FIFO-Puffer geschrieben werden, wird kein Interrupt generiert.  Ein Interrupt tritt nur auf, wenn der FIFO-Puffer leer ist. </blockquote><p>  Nun, es spielt keine Rolle, wir suchen, wo die √úbertragung beginnt. In der Datei mbrtu.c finden wir die Codezeilen </p><br><pre> <code class="plaintext hljs">/* Activate the transmitter. */ eSndState = STATE_TX_XMIT; vMBPortSerialEnable( FALSE, TRUE );</code> </pre> <br><p>  und senden Sie das Byte zwangsweise an den UART-Sender. Dazu f√ºgen wir die Zeile hinzu: "xMBRTUTransmitFSM ();"  und alles beginnt gut zu funktionieren, Pakete laufen, Register werden gelesen und dann ist es eine Frage der Technologie. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de438534/">https://habr.com/ru/post/de438534/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de438518/index.html">Erstellen Sie Ihre jsfiddle, Teil 2</a></li>
<li><a href="../de438522/index.html">Strategischer Equalizer</a></li>
<li><a href="../de438524/index.html">Flatter App Architektur 101: Vanille, Scoped Model, BLoC</a></li>
<li><a href="../de438526/index.html">K√ºnstliche neuronale Netze wachsen Navigationszellen wie im Gehirn</a></li>
<li><a href="../de438530/index.html">Hipster Podcasts # 1</a></li>
<li><a href="../de438536/index.html">Unter der Haube des Chatbots: Was RocketBot kann und wie es funktioniert</a></li>
<li><a href="../de438538/index.html">Teamlead Conf 2019 Msk: √ºber ein anderes Kommunikationsformat</a></li>
<li><a href="../de438540/index.html">Trends in der Dokumentenverwaltung und Datenspeicherung f√ºr 2019</a></li>
<li><a href="../de438542/index.html">Wie wir einen Empfehlungsdienst f√ºr die Auswahl von Kleidung in neuronalen Netzen erstellt haben</a></li>
<li><a href="../de438544/index.html">Wir schauen zu Hause Filme: 10 Materialien √ºber den Bau eines Heimkinos und die Auswahl der Ausr√ºstung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>