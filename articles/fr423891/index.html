<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚ù§Ô∏è‚Äçüë® üë©‚Äçüíº ‚ò†Ô∏è Arbres d'expression de d√©veloppement d'entreprise üó≥Ô∏è üë®‚Äçüî¨ üõÄüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour la plupart des d√©veloppeurs, l'utilisation de l'arborescence d'expression est limit√©e aux expressions lambda dans LINQ. Souvent, nous n'accordons...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arbres d'expression de d√©veloppement d'entreprise</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/423891/">  Pour la plupart des d√©veloppeurs, l'utilisation de l'arborescence d'expression est limit√©e aux expressions lambda dans LINQ.  Souvent, nous n'accordons aucune importance au fonctionnement de la technologie ¬´sous le capot¬ª. <br><br>  Dans cet article, je vais vous montrer des techniques avanc√©es pour travailler avec des arborescences d'expression: √©liminer la duplication de code dans LINQ, g√©n√©ration de code, m√©taprogrammation, transpilation, automatisation des tests. <br><br>  Vous apprendrez comment utiliser directement l'arbre d'expression, quels pi√®ges la technologie a pr√©par√©s et comment les contourner. <br><br><img src="https://habrastorage.org/webt/e5/qh/tt/e5qhttxqyi5a27s-4dtlt2jq1mo.png"><br><br>  Sous la coupe - transcription vid√©o et texte de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon rapport</a> avec DotNext 2018 Piter. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J2XzsCoJM4o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Je m'appelle Maxim Arshinov, je suis co-fondateur de la soci√©t√© d'externalisation du groupe Hi-Tech.  Nous d√©veloppons des logiciels pour les entreprises, et aujourd'hui je vais parler de la fa√ßon dont la technologie de l'arbre d'expression a √©t√© utilis√©e dans le travail quotidien et comment elle a commenc√© √† nous aider. <br><br>  Je n'ai jamais sp√©cifiquement voulu √©tudier la structure interne des arbres d'expression, il semblait que c'√©tait une sorte de technologie interne pour que l'√©quipe .NET pour LINQ fonctionne, et les programmeurs d'applications n'avaient pas besoin de conna√Ætre son API.  Il s'est av√©r√© qu'il y avait des probl√®mes appliqu√©s qui devaient √™tre r√©solus.  Pour que la solution me plaise, j'ai d√ª monter dans l'intestin. <br><br>  Toute cette histoire est √©tir√©e dans le temps, il y avait diff√©rents projets, diff√©rents cas.  Quelque chose est sorti et je l'ai termin√©, mais je vais me permettre de sacrifier la v√©racit√© historique au profit d'une pr√©sentation plus artistique, donc tous les exemples seront sur le m√™me mod√®le de sujet - une boutique en ligne. <br><br><img src="https://habrastorage.org/webt/g5/yf/cr/g5yfcrf13ptoovmcheym1x15fdk.png"><br><br>  Imaginez que nous √©crivons tous une boutique en ligne.  Il a des produits et une coche "√Ä vendre" dans le panneau d'administration.  Nous afficherons uniquement les produits qui ont cette coche marqu√©e sur la partie publique. <br><br><img src="https://habrastorage.org/webt/cg/_e/jt/cg_ejtgmxn1u0hq12ezlonenue8.png"><br><br>  Nous prenons du DbContext ou du NHibernate, nous √©crivons Where (), nous produisons IsForSale. <br><br>  Tout va bien, mais les r√®gles m√©tier ne sont pas les m√™mes pour que nous les √©crivions une fois pour toutes.  Ils √©voluent avec le temps.  Un gestionnaire vient et dit que nous devons toujours surveiller le solde et afficher uniquement les marchandises qui ont des soldes sur la partie publique, sans oublier la coche. <br><br><img src="https://habrastorage.org/webt/8e/b1/mz/8eb1mzde7casnjrrilroqxpp8ku.png"><br><br>  Nous ajoutons facilement une telle propri√©t√©.  Maintenant que nos r√®gles m√©tier sont encapsul√©es, nous pouvons les r√©utiliser. <br><br><img src="https://habrastorage.org/webt/6s/yj/09/6syj09lcwmeiktufuwl4a4wzvyq.png"><br><br>  Essayons d'√©diter LINQ.  Tout va bien ici? <br>  Non, cela ne fonctionnera pas, car IsAvailable ne correspond pas √† la base de donn√©es, il s'agit de notre code et le fournisseur de requ√™tes ne sait pas comment l'analyser. <br><br><img src="https://habrastorage.org/webt/qb/yt/dp/qbytdpgh5ybdiua4kjpc-rouxbs.png"><br><br>  Nous pouvons lui dire que notre propri√©t√© a une telle histoire.  Mais maintenant, ce lambda est dupliqu√© √† la fois dans l'expression linq et dans la propri√©t√©. <br><br><pre><code class="cs hljs">Where(x =&gt; x.IsForSale &amp;&amp; x.InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) IsAvailable =&gt; IsForSale &amp;&amp; InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  Donc, la prochaine fois que ce lambda changera, nous devrons faire Ctrl + Shift + F sur le projet.  Naturellement, nous ne trouverons pas tous - des bogues et du temps.  Je veux √©viter √ßa. <br><br><img src="https://habrastorage.org/webt/8b/8b/j8/8b8bj8voopaagucck7rcl1j9tcg.png"><br><br>  Nous pouvons aller de ce c√¥t√© et mettre une autre ToList () devant Where ().  C'est une mauvaise d√©cision, car s'il y a un million de marchandises dans la base de donn√©es, tout le monde monte en RAM et y filtre. <br><br><img src="https://habrastorage.org/webt/ca/2t/2g/ca2t2gbdetsmcijcefubnokpfeu.png"><br><br>  Si vous avez trois produits dans un magasin, la solution est bonne, mais dans le commerce √©lectronique, il y en a g√©n√©ralement plus.  Cela n'a fonctionn√© que parce que, malgr√© la similitude des lambdas entre eux, ils ont un type compl√®tement diff√©rent.  Dans le premier cas, il s'agit d'un d√©l√©gu√© Func et dans le second, d'une arborescence d'expression.  Il a la m√™me apparence, les types sont diff√©rents, le bytecode est compl√®tement diff√©rent. <br><br><img src="https://habrastorage.org/webt/2l/qi/ya/2lqiya8v9axdrfchqrdqtrxbe4o.png"><br><br>  Pour passer d'une expression √† un d√©l√©gu√©, il vous suffit d'appeler la m√©thode Compile ().  Cette API fournit .NET: il y a une expression - compil√©e, a re√ßu un d√©l√©gu√©. <br><br>  Mais comment y retourner?  Existe-t-il quelque chose dans .NET pour passer d'un d√©l√©gu√© √† des arborescences d'expressions?  Si vous √™tes familier avec LISP, par exemple, il existe un m√©canisme de citation qui permet au code d'√™tre interpr√©t√© comme une structure de donn√©es, mais dans .NET, il ne l'est pas. <br><br><h1>  Express ou d√©l√©gu√©s? </h1><br>  √âtant donn√© que nous avons deux types de lambdas, nous pouvons philosopher ce qui est primaire: l'arbre d'expression ou les d√©l√©gu√©s. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// so slo-oooooo-ow var delegateLambda = expressionLambda.Compile();</span></span></code> </pre> <br>  √Ä premi√®re vue, la r√©ponse est √©vidente: puisqu'il existe une merveilleuse m√©thode Compile (), l'arborescence d'expression est principale.  Et nous devrions recevoir le d√©l√©gu√© en compilant l'expression.  Mais la compilation est un processus lent, et si nous commen√ßons √† le faire partout, nous obtenons une d√©gradation des performances.  De plus, nous le recevrons dans des endroits al√©atoires, o√π l'expression devait √™tre compil√©e dans un d√©l√©gu√©, il y aura une baisse des performances.  Vous pouvez trouver ces endroits, mais ils affecteront le temps de r√©ponse du serveur, et de mani√®re al√©atoire. <br><br><img src="https://habrastorage.org/webt/ur/jw/y_/urjwy_veoqpl7udanxvc3-ddsl8.png"><br><br>  Par cons√©quent, ils doivent √™tre mis en cache d'une mani√®re ou d'une autre.  Si vous avez √©cout√© un expos√© sur les structures de donn√©es simultan√©es, vous connaissez ConcurrentDictionary (ou vous en √™tes tout simplement inform√©).  Je vais omettre les d√©tails sur les m√©thodes de mise en cache (avec des verrous, pas des verrous).  C'est juste que ConcurrentDictionary a une m√©thode simple GetOrAdd (), et l'impl√©mentation la plus simple est de la placer dans ConcurrentDictionary et de la mettre en cache.  La premi√®re fois que nous obtenons la compilation, mais alors tout sera rapide, car le d√©l√©gu√© a d√©j√† √©t√© compil√©. <br><br><img src="https://habrastorage.org/webt/h1/wp/gb/h1wpgbo_5pi3xhnfaivvvjsz4ks.png"><br><br>  Ensuite, vous pouvez utiliser une telle m√©thode d'extension, vous pouvez utiliser et refactoriser notre code avec IsAvailable (), d√©crire l'expression, compiler les propri√©t√©s IsAvailable () et l'appeler par rapport √† l'objet actuel. <br><br>  Il existe au moins deux packages qui impl√©mentent cela: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Microsoft.Linq.Translations</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Signum Framework</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">framework</a> open source √©crit par une soci√©t√© commerciale).  L√† et il y a √† peu pr√®s la m√™me histoire avec la compilation des d√©l√©gu√©s.  API un peu diff√©rente, mais tout comme je l'ai montr√© sur la diapositive pr√©c√©dente. <br><br>  Cependant, ce n'est pas la seule approche, et vous pouvez passer des d√©l√©gu√©s aux expressions.  Depuis longtemps, il y a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article</a> sur le Habre √† propos du Decompiler D√©l√©gu√©, o√π l'auteur affirme que toute compilation est mauvaise, car depuis longtemps. <br><br>  En g√©n√©ral, les d√©l√©gu√©s √©taient avant les expressions, et vous pouvez y passer depuis les d√©l√©gu√©s.  Pour ce faire, l'auteur utilise la m√©thodeBody.GetILAsByteArray ();  de Reflection, qui renvoie vraiment tout le code IL de la m√©thode sous la forme d'un tableau d'octets.  Si vous le mettez plus loin dans Reflection, vous pouvez obtenir une repr√©sentation objet de ce cas, le parcourir avec une boucle et construire un arbre d'expression.  Ainsi, une transition inverse est √©galement possible, mais elle doit √™tre effectu√©e √† la main. <br><br><img src="https://habrastorage.org/webt/_r/pp/d5/_rppd5sfv3tmy9mfacmg6wydi3k.png"><br><br>  Afin de ne pas parcourir toutes les propri√©t√©s, l'auteur sugg√®re de suspendre l'attribut Calcul√© pour indiquer que cette propri√©t√© doit √™tre ins√©r√©e.  Avant la demande, nous montons dans IsAvailable (), retirons son code IL, le convertissons en arborescence d'expression et rempla√ßons l'appel IsAvailable () par ce qui est √©crit dans ce getter.  Il s'av√®re un tel manuel en ligne. <br><br><img src="https://habrastorage.org/webt/nt/jx/g1/ntjxg17v2olokmu7ebckzs7v_uq.png"><br><br>  Pour que cela fonctionne, avant de tout passer √† ToList (), nous appelons la m√©thode sp√©ciale Decompile ().  Il fournit un d√©corateur pour l'original interrogeable et en ligne.  Ce n'est qu'apr√®s cela que nous passons tout au fournisseur de requ√™tes, et tout va bien pour nous. <br><br><img src="https://habrastorage.org/webt/ze/cz/qw/zeczqw8mzr-k72ivpyfzqrpuhrm.png"><br><br>  Le seul probl√®me avec cette approche est que Delegate Decompiler 0.23.0 ne va pas avancer, il n'y a pas de support Core, et l'auteur lui-m√™me dit que c'est un alpha profond, il y en a beaucoup qui sont inachev√©s, donc vous ne pouvez pas l'utiliser en production.  Bien que nous reviendrons sur ce sujet. <br><br><h1>  Op√©rations bool√©ennes </h1><br>  Il s'av√®re que nous avons r√©solu le probl√®me de la duplication de conditions sp√©cifiques. <br><br><img src="https://habrastorage.org/webt/gc/-u/5n/gc-u5nh7vip9kn5cq1d5gn3ivxm.png"><br><br>  Mais les conditions doivent souvent √™tre combin√©es en utilisant la logique bool√©enne.  Nous avions IsForSale (), InStock ()&gt; 0, et entre eux la condition "ET".  S'il y a une autre condition, ou une condition ¬´OU¬ª est requise. <br><br><img src="https://habrastorage.org/webt/9f/xu/hy/9fxuhyfzinahcrlertade-zam2s.png"><br><br>  Dans le cas de ¬´And¬ª, vous pouvez tricher et vider tout le travail sur le fournisseur de requ√™tes, c'est-√†-dire √©crire beaucoup de Where () d'affil√©e, il sait comment le faire. <br><br><img src="https://habrastorage.org/webt/dd/hp/c9/ddhpc9tfdvmeiadkmyfmswnr4h8.png"><br><br>  Si ¬´OU¬ª est requis, cela ne fonctionnera pas, car WhereOr () n'est pas dans LINQ et l'op√©rateur | | n'est pas surcharg√© d'expressions. <br><br><h1>  Sp√©cifications techniques </h1><br>  Si vous connaissez le livre DDD d'Evans ou si vous connaissez simplement le mod√®le de sp√©cification, c'est-√†-dire un mod√®le de conception con√ßu sp√©cifiquement pour cela.  Il existe plusieurs r√®gles m√©tier et vous souhaitez combiner des op√©rations en logique bool√©enne - impl√©mentez la sp√©cification. <br><br><img src="https://habrastorage.org/webt/nj/cb/4n/njcb4n2xt0g8dk3joumhmsgmuyg.png"><br><br>  Une sp√©cification est un tel terme, un ancien mod√®le de Java.  Et en Java, en particulier dans l'ancien, il n'y avait pas de LINQ, donc il n'y a √©t√© impl√©ment√© que sous la forme de la m√©thode isSatisfiedBy (), c'est-√†-dire uniquement des d√©l√©gu√©s, mais il n'a pas √©t√© question d'expressions.  Il existe une impl√©mentation sur Internet appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LinqSpecs</a> , sur la diapositive vous la verrez.  Je l'ai class√© un peu pour moi, mais l'id√©e appartient √† la biblioth√®que. <br><br>  Ici, tous les op√©rateurs bool√©ens sont surcharg√©s, les op√©rateurs vrai et faux sont surcharg√©s de sorte que les deux op√©rateurs ¬´&amp;&amp;¬ª et ¬´||¬ª fonctionnent, sans eux une seule esperluette fonctionnera. <br><br><img src="https://habrastorage.org/webt/nh/8b/16/nh8b16hfmjec4t6yotlcmu5nbzi.png"><br><br>  Ensuite, nous ajoutons des instructions implicites qui font que le compilateur suppose que la sp√©cification est √† la fois des expressions et des d√©l√©gu√©s.  √Ä tout endroit o√π Expression &lt;&gt; ou Func &lt;&gt; doit entrer dans la fonction, vous pouvez passer la sp√©cification.  √âtant donn√© que l'op√©rateur implicite est surcharg√©, le compilateur analysera et remplacera les propri√©t√©s Expression ou IsSatisfiedBy. <br><br><img src="https://habrastorage.org/webt/pd/-t/jk/pd-tjkx5uxieorm3go74act-2gc.png"><br><br>  IsSatisfiedBy () peut √™tre impl√©ment√© en mettant en cache l'expression qui est venue.  En tout cas, il s'av√®re que nous venons d'Expression, le d√©l√©gu√© lui correspond, nous avons ajout√© le support des op√©rateurs bool√©ens.  Maintenant, tout cela peut √™tre arrang√©.  Les r√®gles m√©tier peuvent √™tre mises dans des sp√©cifications statiques, d√©clar√©es et combin√©es. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Spec&lt;Product&gt; IsForSaleSpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spec&lt;Product&gt;(x =&gt; x.IsForSale); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Spec&lt;Product&gt; IsInStockSpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spec&lt;Product&gt;(x =&gt; x.InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><img src="https://habrastorage.org/webt/ru/ju/ya/rujuyaoj1ogssqq_resyqjmkutm.png"><br><br>  Chaque r√®gle m√©tier n'est √©crite qu'une seule fois, elle ne sera perdue nulle part, elle ne sera pas dupliqu√©e, elles pourront √™tre combin√©es.  Les personnes venant au projet peuvent voir ce que vous avez, quelles conditions, comprendre le mod√®le sujet. <br><br><img src="https://habrastorage.org/webt/td/5l/zi/td5lzi5sx9bcq522numfdrylehg.png"><br><br>  Il y a un petit probl√®me: l'expression n'a pas les m√©thodes And (), Or () et Not ().  Ce sont des m√©thodes d'extension, elles doivent √™tre impl√©ment√©es ind√©pendamment. <br><br><img src="https://habrastorage.org/webt/l9/go/tj/l9gotjytui3drpptkcdtbyeymcc.png"><br><br>  Voici la premi√®re tentative de mise en ≈ìuvre.  √Ä propos de l'arborescence des expressions, il y a pas mal de documentation sur Internet, et tout n'est pas d√©taill√©.  Par cons√©quent, j'ai essay√© de prendre Expression, j'ai appuy√© sur Ctrl + Espace, j'ai vu OrElse (), lu √† ce sujet.  Pass√© deux expressions pour compiler et obtenir lambda.  Cela ne fonctionnera pas. <br><br><img src="https://habrastorage.org/webt/v4/p3/8u/v4p38uvzgxubb2y8olt38ivbipq.png"><br><br>  Le fait est que cette expression se compose de deux parties: param√®tre et corps.  Le second est √©galement constitu√© d'un param√®tre et d'un corps.  Dans OrElse (), vous devez passer les corps d'expressions, c'est-√†-dire qu'il est inutile de comparer les lambdas avec "AND" et "OR", cela ne fonctionnera pas.  Nous corrigeons, mais cela ne fonctionnera plus. <br><br>  Mais si la derni√®re fois il y avait une exception NotSupportedException que le lambda n'√©tait pas pris en charge, maintenant il y a une histoire √©trange √† propos du param√®tre 1, param√®tre 2, "quelque chose ne va pas, je ne travaillerai pas". <br><br><h1>  C # 7.0 en bref </h1><br>  Ensuite, j'ai pens√© que la m√©thode de poke scientifique ne fonctionnerait pas, je dois le comprendre.  Il a commenc√© √† google et a trouv√© le site du livre d'Albahari " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C # 7.0 en bref</a> ". <br><br><img src="https://habrastorage.org/webt/m6/0b/ag/m60bagpqsrrcakt5wz-p05lcfyq.png"><br><br>  Joseph Albahari, qui est √©galement le d√©veloppeur de la biblioth√®que populaire LINQKit et LINQPad, vient de d√©crire ce probl√®me.  que vous ne pouvez pas simplement prendre et combiner l'expression, et si vous prenez l'expression magique.Invoke (), cela fonctionnera. <br><br>  Question: qu'est-ce que Expression.Invoke ()?  Acc√©dez √† nouveau √† Google.  Il cr√©e une InvocationExpression qui applique une expression d√©l√©gu√©e ou lambda √† la liste d'arguments. <br><br><img src="https://habrastorage.org/webt/br/du/mh/brdumhygufxqwgu5hfly1nlac0a.png"><br><br>  Si je vous lis ce code maintenant que nous prenons Expression.Invoke (), nous passons les param√®tres, alors la m√™me chose est √©crite en anglais.  √áa ne devient pas plus clair.  Il y a de la magie Expression.Invoke () qui pour une raison quelconque r√©sout ce probl√®me avec les param√®tres.  Il faut croire, il n'est pas n√©cessaire de comprendre. <br><br><img src="https://habrastorage.org/webt/ja/88/po/ja88po-nxrjqtzdya6f8xxnfwre.png"><br><br>  Dans le m√™me temps, si vous essayez de nourrir les EF d'une telle expression combin√©e, il tombera √† nouveau et dira que Expression.Invoke () n'est pas pris en charge.  Soit dit en passant, EF Core a commenc√© √† prendre en charge, mais EF 6 ne tient pas.  Mais Albahari propose juste d'√©crire AsExpandable (), et tout fonctionne. <br><br><img src="https://habrastorage.org/webt/z5/4s/lq/z54slqaaitigetkidixpw-0a408.png"><br><br>  Et vous pouvez remplacer dans les sous-requ√™tes d'expression o√π nous avons besoin d'un d√©l√©gu√©.  Pour les faire correspondre, nous √©crivons Compile (), mais en m√™me temps, si nous √©crivons AsExpandable (), comme le sugg√®re Albahari, cette Compile () ne se produira pas r√©ellement, mais tout sera en quelque sorte magiquement fait correctement. <br><br><img src="https://habrastorage.org/webt/u_/bd/wo/u_bdwop-dd-1gf_xvq3e_d9hbj8.png"><br><br>  Je n'en ai pas cru un mot et suis mont√© dans la source.  Qu'est-ce que la m√©thode AsExpandable ()?  Il a une requ√™te et QueryOptimizer.  Nous laisserons le second hors des crochets, car il n'est pas int√©ressant, mais colle simplement Expression: s'il y a 3 + 5, il mettra 8. <br><br><img src="https://habrastorage.org/webt/l6/8j/tw/l68jtwqse6njinyczxh7xs3ilmw.png"><br><br>  Il est int√©ressant de noter que la m√©thode Expand () est appel√©e plus tard, apr√®s elle le queryOptimizer, puis tout est pass√© au fournisseur de requ√™te en quelque sorte refait apr√®s la m√©thode Expand (). <br><br><img src="https://habrastorage.org/webt/pr/dv/oc/prdvockxs8plz7f2lyciiyu0s5y.png"><br><br>  Nous l'ouvrons, c'est Visitor, √† l'int√©rieur, nous voyons le Compile () non original, qui compile autre chose.  Je ne vous dirai pas quoi exactement, m√™me si cela a une certaine signification, mais nous supprimons une compilation et la rempla√ßons par une autre.  G√©nial, mais √ßa sent le marketing de niveau 80 parce que l'impact sur les performances ne va nulle part. <br><br><h1>  A la recherche d'une alternative </h1><br>  J'ai pens√© que cela ne fonctionnerait pas et j'ai commenc√© √† chercher une autre solution.  Et je l'ai trouv√©.  Il y a un tel Pete Montgomery qui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit</a> √©galement sur ce probl√®me et pr√©tend qu'Albahari a truqu√©. <br><img src="https://habrastorage.org/webt/k9/pu/hy/k9puhyrru6xqi3hyozftlav_lvk.png"><br>  Pete a parl√© avec les d√©veloppeurs d'EF, et ils lui ont appris √† tout combiner sans Expression.Evoke ().  L'id√©e est tr√®s simple: l'embuscade √©tait avec les param√®tres.  Le fait est qu'avec la combinaison Expression il y a un param√®tre de la premi√®re expression et un param√®tre de la seconde.  Ils ne correspondent pas.  Les corps √©taient coll√©s ensemble, mais les param√®tres restaient suspendus dans l'air.  Ils doivent √™tre band√©s de la bonne mani√®re. <br><br>  Pour ce faire, vous devez compiler un dictionnaire en examinant les param√®tres des expressions, si le lambda ne provient pas d'un param√®tre.  Nous composons un dictionnaire, et nous lions √† nouveau tous les param√®tres du second aux param√®tres du premier, de sorte que les param√®tres initiaux entrent dans Expression, parcourent tout le corps que nous avons coll√© ensemble. <br><img src="https://habrastorage.org/webt/yn/ct/37/ynct37iynt07424au-grgvhhz1o.png"><br>  Une telle m√©thode simple vous permet de vous d√©barrasser de toutes les embuscades avec Expression.Invoke ().  De plus, dans la mise en ≈ìuvre de Pete Montgomery, cela est encore plus frais.  Il a une m√©thode Compose () qui vous permet de combiner n'importe quelle expression. <br><br><img src="https://habrastorage.org/webt/wc/of/fv/wcoffvtu4s62gggy_qqykowjtns.png"><br><br>  Nous prenons l'expression et √† travers AndAlso nous nous connectons, fonctionne sans Expandable ().  C'est cette impl√©mentation qui est utilis√©e dans les op√©rations bool√©ennes. <br><br><h1>  Sp√©cifications et unit√©s </h1><br>  Tout allait bien jusqu'√† ce qu'il devienne clair que les agr√©gats existent dans la nature.  Pour ceux qui ne sont pas familiers, je vais expliquer: si vous avez un mod√®le de domaine et que vous repr√©sentez toutes les entit√©s qui sont li√©es les unes aux autres sous forme d'arbres, alors un arbre suspendu s√©par√©ment est un agr√©gat.  La commande ainsi que les articles de la commande seront appel√©s agr√©gats, et l'essence de la commande est la racine d'agr√©gation. <br><br><img src="https://habrastorage.org/webt/zr/vr/6a/zrvr6af-865n3tluhcoivfjn68g.png"><br><br>  Si, en plus des produits, il existe encore des cat√©gories avec une r√®gle commerciale annonc√©e pour eux sous la forme d'une sp√©cification, qu'il existe une certaine note qui devrait √™tre sup√©rieure √† 50, comme l'ont dit les sp√©cialistes du marketing et que nous voulons l'utiliser de cette fa√ßon, alors c'est bien. <br><br><img src="https://habrastorage.org/webt/tp/vh/u-/tpvhu-12wisjnbsdhnmddkqpkw4.png"><br><br>  Mais si nous voulons sortir les marchandises d'une bonne cat√©gorie, c'est encore une fois mauvais, car nos types ne correspondent pas.  Sp√©cification pour la cat√©gorie, mais des produits sont n√©cessaires. <br><br><img src="https://habrastorage.org/webt/yz/cj/wp/yzcjwpjtf0jvuwff1dae8jef7ha.png"><br><br>  Encore une fois, nous devons en quelque sorte r√©soudre le probl√®me.  La premi√®re option: remplacez Select () par SelectMany ().  Je n'aime pas deux choses ici.  Premi√®rement, je ne sais pas comment le support SelectMany () est impl√©ment√© dans tous les fournisseurs de requ√™tes populaires.  Deuxi√®mement, si quelqu'un √©crit un fournisseur de requ√™tes, la premi√®re chose qu'il fera sera d'√©crire exception exception throw non impl√©ment√©e et SelectMany ().  Et le troisi√®me point: les gens pensent que SelectMany () est soit une fonctionnalit√©, soit des jointures, g√©n√©ralement non associ√©es √† une requ√™te SELECT. <br><br><h1>  La composition </h1><br>  Je voudrais utiliser Select (), pas SelectMany (). <br><br><img src="https://habrastorage.org/webt/-_/bv/qm/-_bvqmi8jssf1sva8boyiuh1vsg.png"><br><br>  Vers la m√™me √©poque, j'ai lu sur la th√©orie des cat√©gories, sur la composition fonctionnelle et j'ai pens√© que s'il y a des sp√©cifications du produit dans le bool ci-dessous, il y a une fonction qui peut aller du produit √† la cat√©gorie, il y a une sp√©cification concernant la cat√©gorie, puis en substituant la premi√®re fonctionner comme un argument de la seconde, nous obtenons ce dont nous avons besoin, une sp√©cification concernant le produit.  Absolument la m√™me chose que les compositions fonctionnelles, mais pour les arbres d'expression. <br><br><img src="https://habrastorage.org/webt/hg/wp/7h/hgwp7h8a0nrpv2xsfphtltel160.png"><br><br>  Il serait alors possible d'√©crire une telle m√©thode Where () qu'il est n√©cessaire de passer des produits aux cat√©gories et d'appliquer la sp√©cification √† cette entit√© associ√©e.  Une telle syntaxe √† mon go√ªt subjectif semble assez compr√©hensible. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; Where&lt;T, TParam&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; queryable, Expression&lt;Func&lt;T, TParam&gt;&gt; prop, Expression&lt;Func&lt;TParam, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryable.Where(prop.Compose(<span class="hljs-keyword"><span class="hljs-keyword">where</span></span>)); }</code> </pre> <br>  Avec la m√©thode Compose (), cela peut √©galement √™tre fait facilement.  Nous prenons l'expression d'entr√©e des produits et la combinons avec les sp√©cifications du produit et c'est tout. <br><br><img src="https://habrastorage.org/webt/5p/5k/re/5p5krejfyvexk6c-hf50hymykss.png"><br><br>  Vous pouvez maintenant √©crire un tel Where ().  Cela fonctionnera si vous avez une machine de n'importe quelle longueur.  La cat√©gorie a une SuperCat√©gorie et un nombre illimit√© de propri√©t√©s suppl√©mentaires qui peuvent √™tre substitu√©es. <br><br>  ¬´Puisque nous avons un outil de composition fonctionnelle, et puisque nous pouvons le compiler, et puisque nous pouvons l'assembler dynamiquement, cela signifie qu'il y a une odeur de m√©ta-programmation!¬ª Ai-je pens√©. <br><br><h1>  Projections </h1><br>  O√π pouvons-nous appliquer la m√©ta-programmation pour que nous devions √©crire moins de code. <br><br><img src="https://habrastorage.org/webt/z6/dw/gi/z6dwgivuday4edqii5me2z0yuw0.png"><br><br>  La premi√®re option est la projection.  Retirer une entit√© enti√®re co√ªte souvent trop cher.  Le plus souvent, nous le passons au premier plan, s√©rialisons JSON.  Mais il n'a pas besoin de toute l'essence avec l'agr√©gat.  Vous pouvez le faire avec LINQ aussi efficacement que possible en √©crivant manuellement Select ().  Pas difficile, mais ennuyeux. <br><br><img src="https://habrastorage.org/webt/1r/co/xd/1rcoxdmbzmuplg1vyuvkz5hrrqg.png"><br><br>  Au lieu de cela, je sugg√®re √† tout le monde d'utiliser ProjectToType ().  Au moins, deux biblioth√®ques peuvent le faire: Automapper et Mapster.  Pour une raison quelconque, de nombreuses personnes savent qu'AutoMapper peut effectuer un mappage en m√©moire, mais tout le monde ne sait pas qu'il poss√®de des extensions interrogables, il a √©galement une expression et il peut cr√©er une expression SQL.  Si vous √©crivez toujours des requ√™tes manuelles et que vous utilisez LINQ, puisque vous n'avez pas de contraintes de performance tr√®s s√©rieuses, alors il n'y a aucun int√©r√™t √† le faire avec vos mains, c'est le travail de la machine, pas de la personne. <br><br><h1>  Filtrage </h1><br>  Si nous pouvons le faire avec des projections, pourquoi ne pas le faire pour le filtrage. <br><br><img src="https://habrastorage.org/webt/wg/ei/pd/wgeipdnvwwusix--gk7_zch9nhs.png"><br><br>  Voici aussi le code.  Un filtre entre.  De nombreuses applications d'entreprise ressemblent √† ceci: un filtre est venu, ajoutez Where (), un autre filtre est venu, ajoutez Where ().  Combien de filtres sont l√†, autant et r√©p√©tez.  Rien de compliqu√©, mais beaucoup de copier-coller. <br><br><img src="https://habrastorage.org/webt/fd/7r/wl/fd7rwlnpkuiluiadq0zppn7_t-y.png"><br><br>  Si nous, en tant qu'AutoMapper, le faisons, √©crivons AutoFilter, Project and Filter pour qu'il fasse tout lui-m√™me, ce serait du code cool-less. <br><br><img src="https://habrastorage.org/webt/9g/es/tg/9gestgfo-ouzbolexklhu78gv8q.png"><br><br>  Ce n'est rien de compliqu√©.  Prenez Expression.Property, parcourez le DTO et essentiellement.  Nous trouvons des propri√©t√©s communes appel√©es de mani√®re identique.  S'ils sont appel√©s de la m√™me fa√ßon, cela ressemble √† un filtre. <br><br>  Ensuite, vous devez v√©rifier null, utiliser une constante pour obtenir la valeur de DTO, la remplacer dans l'expression et ajouter une conversion au cas o√π vous auriez Int et NullableInt ou un autre Nullable pour que les types correspondent.  Et mettez, par exemple, Equals (), un filtre qui v√©rifie l'√©galit√©. <br><br><img src="https://habrastorage.org/webt/09/x6/me/09x6mep3p-rrvwo0vodcnke_8eo.png"><br><br>  Ensuite, r√©cup√©rez lambda et passez en revue pour chaque propri√©t√©: s'il y en a beaucoup, collectez-les via ¬´ET¬ª ou ¬´OU¬ª, selon la fa√ßon dont le filtre fonctionne pour vous. <br><br><img src="https://habrastorage.org/webt/ha/vw/en/havwen3xvrbraul6plgdadjjusy.png"><br><br>  La m√™me chose peut √™tre faite pour le tri, mais c'est un peu plus compliqu√©, car la m√©thode OrderBy () a deux g√©n√©riques, vous devez donc les remplir avec vos mains, utilisez Reflections pour cr√©er la m√©thode OrderBy () √† partir de deux g√©n√©riques, ins√©rez le type d'entit√© que nous prenons, le type de triable Propri√©t√©.  En g√©n√©ral, vous pouvez √©galement le faire, ce n'est pas difficile. <br><br>  La question se pose: o√π mettre O√π () - au niveau de l'entit√©, comme les sp√©cifications ont √©t√© annonc√©es ou apr√®s la projection, et √ßa et l√† √ßa marchera. <br><br><img src="https://habrastorage.org/webt/e1/4g/4g/e14g4gelsidqhaeq7avs0wgp51i.png"><br><br>  C'est vrai √† la fois, et donc, parce que les sp√©cifications sont, par d√©finition, des r√®gles commerciales, et nous devons les ch√©rir et les ch√©rir et ne pas nous y tromper.  Il s'agit d'une couche unidimensionnelle.  Et les filtres sont plus sur l'interface utilisateur, ce qui signifie qu'ils filtrent par DTO.  Par cons√©quent, vous pouvez mettre deux Where ().  Il y a des questions plus probables quant √† la fa√ßon dont le fournisseur de requ√™tes va g√©rer cela correctement, mais je pense que les solutions ORM √©crivent de mauvais SQL de toute fa√ßon, et ce ne sera pas bien pire.  Si c'est tr√®s important pour vous, alors cette histoire ne vous concerne pas du tout. <br><br><img src="https://habrastorage.org/webt/46/wn/kc/46wnkcjkjayv9boma0pot5of0rs.png"><br><br>  Comme on dit, il vaut mieux voir une fois qu'entendre cent fois. <br>  Maintenant, le magasin propose trois produits: Snickers, Subaru Impreza et Mars.  Magasin √©trange.  Essayons de trouver Snickers.  Il y en a.  Voyons ce que cent roubles.  Aussi Snickers.  Et pour 500?  Zoomez, il n'y a rien.  Et pour la Subaru Impreza 100500.  G√©nial, il en va de m√™me pour le tri. <br><br>  Trier par ordre alphab√©tique et par prix.  Le code y est √©crit exactement comme il l'√©tait.  Ces filtres fonctionnent pour toutes les classes, peu importe.  Si vous essayez de rechercher par nom, Subaru existe √©galement.  Et dans ma pr√©sentation √©tait Equals ().  Comment √ßa?  Le fait est que le code ici et dans la pr√©sentation est un peu diff√©rent.  J'ai comment√© la ligne sur Equals () et ajout√© de la magie de la rue sp√©ciale.  Si nous avons le type String, nous n'avons pas besoin de Equals (), mais appelons StartWith (), que j'ai √©galement re√ßu.  Par cons√©quent, un filtre diff√©rent est cr√©√© pour les lignes. <br><br><img src="https://habrastorage.org/webt/t7/fa/kp/t7fakpf7peg_v2swpq2xwksiecu.png"><br><br>  Cela signifie qu'ici, vous pouvez appuyer sur Ctrl + Maj + R, s√©lectionner la m√©thode et √©crire non pas si, mais basculer, ou vous pouvez m√™me impl√©menter le mod√®le de ¬´strat√©gie¬ª, puis devenir fou.  Vous pouvez r√©aliser tous les d√©sirs concernant le fonctionnement des filtres.  Tout d√©pend des types avec lesquels vous travaillez.  Plus important encore, les filtres fonctionneront de la m√™me mani√®re. <br><br>  Vous pouvez convenir que les filtres dans tous les √©l√©ments de l'interface utilisateur devraient fonctionner comme ceci: les cha√Ænes sont recherch√©es d'une mani√®re, l'argent est recherch√© d'une autre.  Coordonnez tout cela, √©crivez une fois, tout se fera correctement dans diff√©rentes interfaces, et aucun autre d√©veloppeur ne le cassera, car ce code n'est pas au niveau de l'application, mais quelque part dans une biblioth√®que externe ou dans votre noyau. <br><br><h1>  Validation </h1><br>  En plus du filtrage et de la projection, vous pouvez effectuer une validation.  La biblioth√®que JS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TComb.validation a</a> eu cette id√©e.  TComb est une abr√©viation de Type Combinators et il est bas√© sur un syst√®me de type et ainsi de suite. refinement', . <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// null and undefined validate('a', t.Nil).isValid(); // =&gt; false validate(null, t.Nil).isValid(); // =&gt; true validate(undefined, t.Nil).isValid(); // =&gt; true // strings validate(1, t.String).isValid(); // =&gt; false validate('a', t.String).isValid(); // =&gt; true // numbers validate('a', t.Number).isValid(); // =&gt; false validate(1, t.Number).isValid(); // =&gt; true</span></span></code> </pre> <br>   ,    JS,    nill,   undefined,  . <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// a predicate is a function with signature: (x) -&gt; boolean var predicate = function (x) { return x &gt;= 0; }; // a positive number var Positive = t.refinement(t.Number, predicate); validate(-1, Positive).isValid(); // =&gt; false validate(1, Positive).isValid(); // =&gt; true</span></span></code> </pre> <br>   .       .      ,    x &gt;= 0   ,   Positive.         . , ,   -. <br><br><img src="https://habrastorage.org/webt/ha/wx/lj/hawxljvmttn1bc0rhh5k4fvtywe.png"><br><br>  .    refinement,    C#,   IsValid(),   Expression , .       . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RefinementAttribute</span></span>: <span class="hljs-title"><span class="hljs-title">ValidationAttribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IValidator&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; Refinement { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RefinementAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type refinmentType</span></span></span><span class="hljs-function">)</span></span> { Refinement = (IValidator&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;) Activator.CreateInstance(refinmentType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> =&gt; Refinement.Validate(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).IsValid(); }</code> </pre> <br>     DataAnnotations  ASP.NET MVC,      .  RefinementAttribute(),    .   ,  RefinementAttribute ,      ,        .NET,  . <br><br><img src="https://habrastorage.org/webt/ml/e7/j9/mle7j92pbchiswi1ni7zfvizgou.png"><br><br>     . AdultRefinement,    18. <br><br><img src="https://habrastorage.org/webt/cp/2o/yt/cp2oytz1rrhql042hddkb3va8ug.png"><br><br>    ,        .  NoJS   JS   ,  . ,   C#     ,        JS.       JSX, ES6     JavaScript.   ?  Visitor, ,      JavaScript. <br><br><img src="https://habrastorage.org/webt/lg/qe/9y/lgqe9yl63oz8p8wmlkrmyfmkkky.png"><br><br>     ‚Äî   ,    .    regexp,  StringBuilder,  regexp.      ,   JS ‚Äî    ,      bool ,      .  ,   . <br><br><pre> <code class="cs hljs">{ predicate: ‚Äúx=&gt; (x &gt;= <span class="hljs-number"><span class="hljs-number">18</span></span>)‚Äù, errorMessage: ‚ÄúFor adults only¬ª }</code> </pre> <br>   ,    ,    ,    JS    errorMessage ¬´For adults only¬ª.   .  . ,   . <br><br>  React,       UserRefinment() Expression  errorMessage,  refinment  number,  eval,   .        ,    number,    JS.  , .  ,   ,  false . <br><br><img src="https://habrastorage.org/webt/km/vw/ls/kmvwlsxxw5csttfvkh_rxrpbwpe.png"><br><br>    alert.   onSubmit, alert ,    .      . <br><br><img src="https://habrastorage.org/webt/xj/hm/mz/xjhmmznmn7xgzlcxedk_tgvdzcu.png"><br><br>    Ok(ModelState.IsValid),  User,       JavaScript.    Refinement. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DemoApp.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span>: <span class="hljs-title"><span class="hljs-title">HasNameBase</span></span> { [Refinement(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(AdultRefinement))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Age { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br>       ,     .      JavaScript. ,  -  C#,     ,  .   NoJS,    . <br><br><h1>  Test </h1><br><img src="https://habrastorage.org/webt/jz/fm/y0/jzfmy0ngjejazfvdrf5ld9y8cc4.png"><br><br>         .,   -,   Moq.    mock  -   ‚Äî  moq,    fluent-.  ,             . <br><br>    moq ‚Äî   Expression,  .     ,        Castle.DynamicProxy.       .      . <br><br><img src="https://habrastorage.org/webt/tc/xo/fk/tcxofk6igzdettbtprnfewltn_q.png"><br><br>     ,     Core -  WCF.  ,   WebAPI.     WebAPI,   WCF  WSDL  .  WebAPI   swagger.  swagger ‚Äî   ,       ,  API    .   WCF,   WSDL,     API,  . <br><br>     ,    ,    .    moq    GetResponse&lt;&gt;()    ProductController,  ,    ,  .   ,   ,  Ctrl+Space    ,     ,  ,   , dll  .  Intellisense,   ,    . <br><br> ,  Moq,     ,     ,   ,    API    .   ,  -   ,     ,      ,   POST-  GET-,   ,        ,    Intellisense  expression tree      . ,    ,      Web-. <br><br>  Reflection <br><br>    -,    Reflection. <br><br><img src="https://habrastorage.org/webt/gr/bq/r_/grbqr_q2oqe0rulsblvpejylomk.png"><br><br>  ,  Reflection ,    .        Expression.  ‚Äî   CreateInstance.      ,    Expression.New(),      ,      . <br><br><img src="https://habrastorage.org/webt/8u/me/lv/8umelvrhhu0ctn0gaunjp1ldmxg.png"><br><br>          .     - .  Activator,     ,     . Constructor_Invoke,    .   ‚Äî New  compiled-.       ,   ,   ,   ,     . <br><br><img src="https://habrastorage.org/webt/yr/sv/7k/yrsv7kspmbbmnfjxc1slzkemvx4.png"><br><br>         . <br><br><img src="https://habrastorage.org/webt/gf/2d/4e/gf2d4ebwaltmazxfjicoupxwrbk.png"><br><br>   .    -    Fast Memember    Fast Reflect,     ,    .  ,       , -    .  ,   ,       . <br><br><img src="https://habrastorage.org/webt/hi/x1/e7/hix1e7peelljkkm6kewh4blyhgq.png"><br><br>   ,   ,   , .       ,       ,     .   ,    , -     ,     ,  ,       ,   DSL, Little Languages  -,  . <br><br>       ,   -           ,   .  ,       ,  ,    .       DLR,   ,     IronPython, IronRuby. Expression tree        CLR.      -,            . <br><br><h1>  R√©sum√© </h1><br>      ,         .   ,     .    ,    ,  -  ,   . <br><br>   ‚Äî    .    100    ,    .    ,     ,       ,      .    Expression Trees,  -      . <br><br>    ,   ,     ,     ,     ,    . <br><br>      ,       ,             .        ,     . <br><br>   ,        ,         Expression, Reflection,  ,  ,      .    ,  ,    API,    ,  Expression    .    . <br><br>      Expression.Compile()    .        ,  Expression' ,    Dictionary  .  -  ,    ,    ,    ,    ,     Compile()   .  ,   . <br><br>    ‚Äî     C#-,    ,   ,    Where(), - implicit- .     MSDN,  .    , ,    ,        ,          ,        ,  StackOverflow   ,     - . <br><br>  ,  ,      .   ,    ,  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  .     ,        ‚Äî   . <br><blockquote> 22-23     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DotNext 2018 Moscow</a> .       , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>     ( <b>  </b>   ). </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423891/">https://habr.com/ru/post/fr423891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423877/index.html">29-31 octobre: ‚Äã‚Äãcr√©ation d'un cluster Kubernetes pr√™t pour la production</a></li>
<li><a href="../fr423879/index.html">Est-il facile d'ajouter de nouvelles fonctionnalit√©s √† l'ancien framework? Farine de choix sur l'exemple du d√©veloppement de SObjectizer</a></li>
<li><a href="../fr423881/index.html">Quels √©taient les soudeurs pour l'optique (deuxi√®me partie)</a></li>
<li><a href="../fr423885/index.html">Une invitation √† un spectacle de lumi√®re et un petit initi√© de la future plateforme Circle of Light √† Moscou</a></li>
<li><a href="../fr423889/index.html">Ma d√©ception dans le logiciel</a></li>
<li><a href="../fr423893/index.html">Hello World pour recevoir des donn√©es d'un appareil Bluetooth (BLE) via C #</a></li>
<li><a href="../fr423895/index.html">Vous n'avez pas besoin d'un avocat. Mais ce n'est pas s√ªr</a></li>
<li><a href="../fr423897/index.html">Conseils utiles pour l'utilisation de l'assistant DDR HyperLynx pour l'analyse QDR4</a></li>
<li><a href="../fr423901/index.html">Lorsque la vitesse et la mise √† l'√©chelle sont n√©cessaires: serveur d'appareils iOS distribu√©s</a></li>
<li><a href="../fr423903/index.html">Immersion dans AD: nous analysons les attaques avanc√©es sur Microsoft Active Directory et comment les d√©tecter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>