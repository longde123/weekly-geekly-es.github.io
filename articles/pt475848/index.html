<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≠ üëåüèø üë®üèΩ Como a pesquisa Yandex.Market funciona e o que acontecer√° se um dos servidores travar üéÖüèø üë©üèæ‚Äçüé® üêÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, meu nome √© Eugene. Trabalho na infraestrutura de pesquisa Yandex.Market. Quero contar √† comunidade Habr sobre a cozinha interna do mercado - mas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como a pesquisa Yandex.Market funciona e o que acontecer√° se um dos servidores travar</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/475848/">  Ol√°, meu nome √© Eugene.  Trabalho na infraestrutura de pesquisa Yandex.Market.  Quero contar √† comunidade Habr sobre a cozinha interna do mercado - mas h√° algo a dizer.  Primeiro de tudo, como a Pesquisa de mercado, os processos e a arquitetura funcionam.  Como lidamos com situa√ß√µes de emerg√™ncia: o que acontece se um servidor falhar?  E se houver 100 desses servidores? <br><br>  Voc√™ tamb√©m aprender√° como implementamos novas funcionalidades em v√°rios servidores imediatamente.  E como testar servi√ßos complexos diretamente na produ√ß√£o, sem causar transtornos aos usu√°rios.  Em geral, como funciona a busca pelo mercado, para que todos estejam bem. <br><br><img src="https://habrastorage.org/webt/-x/ye/eb/-xyeebvixa2pxxh3ad-peaoukyo.png"><br><a name="habracut"></a><br><h2>  Um pouco sobre n√≥s: que problema resolvemos </h2><br>  Ao inserir texto, procurar produtos por par√¢metros ou comparar pre√ßos em lojas diferentes, todas as solicita√ß√µes chegam ao servi√ßo de pesquisa.  A pesquisa √© o maior servi√ßo do mercado. <br><br>  Processamos todas as consultas de pesquisa: nos sites market.yandex.ru, beru.ru, servi√ßo Supercheck, Yandex.Advisor e aplicativos m√≥veis.  Tamb√©m inclu√≠mos ofertas de produtos nos resultados de pesquisa no yandex.ru. <br><br><img width="500" src="https://habrastorage.org/webt/yt/_h/5d/yt_h5de7hmx0zmkv8gdk7glq-kc.png"><br><br>  Por servi√ßo de pesquisa, quero dizer n√£o apenas pesquisar diretamente, mas tamb√©m um banco de dados com todas as ofertas do mercado.  A escala √© a seguinte: mais de um bilh√£o de consultas de pesquisa s√£o processadas por dia.  E tudo deve funcionar rapidamente, sem interrup√ß√µes e sempre produzir o resultado desejado. <br><br><h2>  O que √© o que: arquitetura de mercado </h2><br>  Descreva brevemente a arquitetura atual do mercado.  Convencionalmente, pode ser descrito pelo esquema abaixo: <br><img src="https://habrastorage.org/webt/ra/yq/jv/rayqjvvmbjvxhsc8lokpysg_rvw.jpeg"><br>  Digamos que uma loja parceira chegue at√© n√≥s.  Ele diz que eu quero vender um brinquedo: esse gato malvado com um squeaker.  E um gato malvado sem um tweeter.  E apenas um gato.  Em seguida, a loja precisa preparar ofertas nas quais o mercado procura.  A loja forma um xml especial com ofertas e comunica o caminho para esse xml por meio de uma interface de parceiro.  Em seguida, o indexador baixa periodicamente esse xml, verifica erros e armazena todas as informa√ß√µes em um enorme banco de dados. <br><br>  Existem muitos desses xml salvos.  Um √≠ndice de pesquisa √© criado a partir deste banco de dados.  O √≠ndice √© armazenado em formato interno.  Ap√≥s criar o √≠ndice, o servi√ßo Layouts faz o upload para os mecanismos de pesquisa. <br><br>  Como resultado, um gato malvado com um squeaker aparece no banco de dados e um √≠ndice de gato aparece no servidor. <br><br>  Falarei sobre como procuramos um gato na parte sobre a arquitetura de pesquisa. <br><br><h2>  Arquitetura de pesquisa de mercado </h2><br>  Vivemos no mundo dos microsservi√ßos: cada solicita√ß√£o recebida para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">market.yandex.ru</a> causa muitas subconsultas e dezenas de servi√ßos participam de seu processamento.  O diagrama mostra apenas alguns: <br><br><img src="https://habrastorage.org/webt/92/n9/iu/92n9iutvet9ls6k7djh29brfdq0.jpeg"><br>  <i>Esquema de processamento de solicita√ß√£o simplificado</i> <br><br>  Cada servi√ßo tem uma coisa maravilhosa - seu pr√≥prio balanceador com um nome exclusivo: <br><br><img src="https://habrastorage.org/webt/qb/_c/t4/qb_ct4mdpio2xprdlos2pi1oym8.jpeg"><br><br>  O balanceador nos oferece uma grande flexibilidade no gerenciamento do servi√ßo: por exemplo, voc√™ pode desligar os servidores, o que geralmente √© necess√°rio para atualiza√ß√µes.  O balanceador v√™ que o servidor est√° indispon√≠vel e redireciona automaticamente solicita√ß√µes para outros servidores ou data centers.  Quando voc√™ adiciona ou remove um servidor, a carga √© redistribu√≠da automaticamente entre os servidores. <br><br>  O nome exclusivo do balanceador n√£o depende do datacenter.  Quando o servi√ßo A faz uma solicita√ß√£o para B, por padr√£o, o balanceador B redireciona a solicita√ß√£o para o data center atual.  Se o servi√ßo estiver indispon√≠vel ou ausente no data center atual, a solicita√ß√£o ser√° redirecionada para outros data centers. <br><br>  Um √∫nico FQDN para todos os datacenters permite que o servi√ßo A geralmente se desconecte dos locais.  Sua solicita√ß√£o para o servi√ßo B ser√° sempre processada.  Uma exce√ß√£o √© o caso quando o servi√ßo est√° em todos os datacenters. <br><br>  Mas nem tudo √© t√£o f√°cil com este balanceador: temos um componente intermedi√°rio adicional.  O balanceador pode estar inst√°vel e esse problema √© resolvido por servidores redundantes.  Tamb√©m h√° um atraso adicional entre os servi√ßos A e B. Mas, na pr√°tica, √© inferior a 1 ms e, para a maioria dos servi√ßos, isso n√£o √© cr√≠tico. <br><br><h3>  Combatendo o inesperado: servi√ßos de pesquisa equilibrados e resilientes </h3><br>  Imagine que ocorreu um colapso: voc√™ precisa encontrar um gato com um squeaker, mas o servidor trava.  Ou 100 servidores.  Como sair?  Vamos realmente deixar o usu√°rio sem um gato? <br><br>  A situa√ß√£o √© terr√≠vel, mas estamos prontos para isso.  Eu vou te dizer em ordem. <br><br>  A infraestrutura de pesquisa est√° localizada em v√°rios datacenters: <br><br><img src="https://habrastorage.org/webt/_i/wa/f9/_iwaf97__hrhmaspgxcl-euqqnq.jpeg"><br><br>  Ao projetar, criamos a possibilidade de desativar um data center.  A vida √© cheia de surpresas - por exemplo, uma escavadeira pode cortar um cabo subterr√¢neo (sim, era assim).  As capacidades nos demais data centers devem ser suficientes para suportar o pico de carga. <br><br>  Considere um √∫nico data center.  Em cada data center, o mesmo esquema de balanceadores: <br><br><img src="https://habrastorage.org/webt/x6/rp/hx/x6rphx-hrlcb1gciennukyjeudi.jpeg"><br>  Um balanceador √© pelo menos tr√™s servidores f√≠sicos.  Essa redund√¢ncia √© feita para garantir a confiabilidade.  Os balanceadores trabalham no HAProx. <br><br>  Escolhemos o HAProx devido ao seu alto desempenho, pequenos requisitos de recursos e ampla funcionalidade.  Dentro de cada servidor, nosso software de pesquisa funciona. <br><br>  A probabilidade de falha de um servidor √© pequena.  Mas se voc√™ tiver muitos servidores, a probabilidade de pelo menos uma queda aumentar. <br><br>  √â o que acontece na realidade: os servidores est√£o travando.  Portanto, voc√™ deve monitorar constantemente o status de todos os servidores.  Se o servidor parar de responder, ele ser√° desconectado automaticamente do tr√°fego.  Para isso, o HAProxy possui uma verifica√ß√£o de integridade interna.  Ele vai para todos os servidores com solicita√ß√£o HTTP ‚Äú/ ping‚Äù uma vez por segundo. <br><br>  Outro recurso do HAProxy: agent-check permite carregar todos os servidores uniformemente.  Para fazer isso, o HAProxy se conecta a todos os servidores e eles retornam seu peso, dependendo da carga atual de 1 a 100. O peso √© calculado com base no n√∫mero de solicita√ß√µes na fila de processamento e na carga do processador. <br><br>  Agora, sobre encontrar um gato.  As consultas do formul√°rio <b>/ pesquisa? Texto = zangado + gato</b> chegam para <b>pesquisar</b> .  Para que a pesquisa seja r√°pida, o √≠ndice de gatos inteiro deve ser colocado na RAM.  Mesmo a leitura de um SSD n√£o √© r√°pida o suficiente. <br><br>  Era uma vez, a base da oferta era pequena e havia RAM suficiente para um servidor.  √Ä medida que o banco de dados da proposta cresceu, tudo deixou de se encaixar nessa RAM e os dados foram divididos em duas partes: shard 1 e shard 2. <br><br><img src="https://habrastorage.org/webt/kz/od/j5/kzodj5ghrqccc_necth6gmylzgy.jpeg"><br>  Mas sempre acontece: qualquer solu√ß√£o, mesmo uma boa, gera outros problemas. <br><br>  O balanceador ainda foi para qualquer servidor.  Mas na m√°quina em que a solicita√ß√£o veio, havia apenas metade do √≠ndice.  O resto estava em outros servidores.  Portanto, o servidor teve que ir para alguma m√°quina vizinha.  Ap√≥s o recebimento dos dados dos dois servidores, os resultados foram combinados e reorganizados. <br><br>  Como o balanceador distribui solicita√ß√µes de maneira uniforme, todos os servidores estavam envolvidos na reorganiza√ß√£o, e n√£o apenas na transmiss√£o de dados. <br><br>  O problema ocorreu se o servidor vizinho n√£o estivesse dispon√≠vel.  A solu√ß√£o foi especificar v√°rios servidores com prioridades diferentes como o servidor "vizinho".  Primeiro, a solicita√ß√£o foi enviada aos servidores no rack atual.  Se nenhuma resposta foi recebida, a solicita√ß√£o foi enviada a todos os servidores neste data center.  E por √∫ltimo, mas n√£o menos importante, a solicita√ß√£o foi para outros data centers. <br>  √Ä medida que o n√∫mero de propostas aumentou, os dados foram divididos em quatro partes.  Mas esse n√£o era o limite. <br><br>  Agora, uma configura√ß√£o de oito shards √© usada.  Al√©m disso, para economizar ainda mais mem√≥ria, o √≠ndice foi dividido na parte da pesquisa (pela qual a pesquisa ocorre) e na parte do trecho (que n√£o est√° envolvida na pesquisa). <br><br>  Um servidor cont√©m informa√ß√µes sobre apenas um shard.  Portanto, para executar uma pesquisa no √≠ndice completo, √© necess√°rio pesquisar em oito servidores que cont√™m shards diferentes. <br><br>  Os servidores est√£o agrupados em clusters.  Cada cluster cont√©m oito mecanismos de pesquisa e um trecho. <br><br><img src="https://habrastorage.org/webt/1b/om/dl/1bomdlbzui-uxhswoq1kfq9h7os.jpeg"><br>  O banco de dados de valores-chave com dados est√°ticos est√° em execu√ß√£o no servidor de snippet.  Eles s√£o necess√°rios para a emiss√£o de documentos, por exemplo, uma descri√ß√£o de um gato com um squeaker.  Os dados s√£o retirados especialmente em um servidor separado, para n√£o carregar a mem√≥ria dos mecanismos de pesquisa. <br><br>  Como os IDs de documento s√£o exclusivos apenas na estrutura de um √≠ndice, pode surgir uma situa√ß√£o em que n√£o h√° documentos nos trechos.  Bem, ou em um ID, haver√° outro conte√∫do.  Portanto, para que a pesquisa funcione e a pesquisa ocorra, surgiu a necessidade da consist√™ncia de todo o cluster.  Falarei sobre como monitoramos a consist√™ncia um pouco mais tarde. <br><br>  A pr√≥pria pesquisa est√° organizada da seguinte forma: uma consulta de pesquisa pode chegar a qualquer um dos oito servidores.  Digamos que ele veio ao servidor 1. Este servidor processa todos os argumentos e entende o que e como procurar.  Dependendo da solicita√ß√£o recebida, o servidor pode fazer solicita√ß√µes adicionais a servi√ßos externos para obter as informa√ß√µes necess√°rias.  Uma solicita√ß√£o pode ser seguida por at√© dez solicita√ß√µes para servi√ßos externos. <br><br>  Ap√≥s coletar as informa√ß√µes necess√°rias, uma pesquisa come√ßa no banco de dados de ofertas.  Para fazer isso, s√£o feitas subconsultas para todos os oito servidores no cluster. <br><br>  Depois de receber as respostas, os resultados s√£o combinados.  No final, para gerar o problema, voc√™ pode precisar de v√°rias outras subconsultas no servidor de snippet. <br><br>  As consultas de pesquisa no cluster s√£o: <b>/ shard1? Text = angry + cat</b> .  Al√©m disso, subconsultas no formato: <b>/ status</b> s√£o feitas constantemente entre todos os servidores no cluster uma vez por segundo. <br><br>  A solicita√ß√£o <b>/ status</b> detecta uma situa√ß√£o quando o servidor n√£o est√° dispon√≠vel. <br><br>  Ele tamb√©m controla que em todos os servidores a vers√£o do mecanismo de pesquisa e a vers√£o do √≠ndice s√£o as mesmas, caso contr√°rio, haver√° dados inconsistentes dentro do cluster. <br><br>  Apesar de um servidor de trechos processar solicita√ß√µes de oito mecanismos de pesquisa, seu processador √© muito pouco carregado.  Portanto, agora transferimos dados do snippet para um servi√ßo separado. <br><br><img src="https://habrastorage.org/webt/3u/q5/ng/3uq5ngicgxwxg60diggqot7iiky.jpeg"><br><br>  Para transferir dados, introduzimos chaves universais para documentos.  Agora a situa√ß√£o √© imposs√≠vel quando uma chave retorna o conte√∫do de outro documento. <br><br>  Mas a transi√ß√£o para outra arquitetura ainda n√£o est√° completa.  Agora queremos nos livrar do servidor de trechos dedicados.  E, geralmente, afaste-se da estrutura do cluster.  Isso nos permitir√° continuar a escalar facilmente.  Um b√¥nus adicional √© uma economia significativa de ferro. <br><br>  E agora para as hist√≥rias de terror com um final feliz.  Considere v√°rios casos de indisponibilidade do servidor. <br><br><h4>  Terr√≠vel aconteceu: um servidor n√£o est√° dispon√≠vel </h4><br>  Digamos que um servidor n√£o esteja dispon√≠vel.  Os outros servidores do cluster podem continuar respondendo, mas os resultados da pesquisa estar√£o incompletos. <br><br>  Por meio de uma verifica√ß√£o de status, os servidores vizinhos entendem que um est√° indispon√≠vel.  Portanto, para manter a integridade, todos os servidores no cluster come√ßam a responder √† solicita√ß√£o <b>/ ping</b> para o balanceador de que tamb√©m est√£o indispon√≠veis.  Acontece que todos os servidores do cluster morreram (o que n√£o √© o caso).  Essa √© a principal desvantagem do nosso esquema de cluster - portanto, queremos nos afastar dele. <br><br><img src="https://habrastorage.org/webt/hr/ko/2o/hrko2ovb9b5q2hjb8xqgnubynec.jpeg"><br><br>  Solicita√ß√µes que terminaram com um erro, o balanceador pergunta novamente em outros servidores. <br>  Al√©m disso, o balanceador para de enviar tr√°fego do usu√°rio para servidores mortos, mas continua a verificar seu status. <br><br>  Quando o servidor fica dispon√≠vel, ele come√ßa a responder ao <b>/ ping</b> .  Assim que as respostas normais aos pings dos servidores mortos come√ßam a chegar, os balanceadores come√ßam a enviar o tr√°fego do usu√°rio para l√°.  O cluster √© restaurado, aplausos. <br><br><h4>  Pior ainda: muitos servidores indispon√≠veis </h4><br>  Uma parte significativa dos servidores no data center √© reduzida.  O que fazer, para onde correr?  O balanceador vem em socorro novamente.  Cada balanceador mant√©m constantemente na mem√≥ria o n√∫mero atual de servidores ativos.  Ele sempre considera a quantidade m√°xima de tr√°fego que o data center atual pode suportar. <br><br>  Quando muitos servidores no datacenter caem, o balanceador entende que esse datacenter n√£o pode processar todo o tr√°fego. <br><br>  Em seguida, o excesso de tr√°fego come√ßa distribu√≠do aleatoriamente para outros data centers.  Tudo funciona, todo mundo est√° feliz. <br><br><img src="https://habrastorage.org/webt/cp/g-/if/cpg-ifevj3dzyvmedn1v-g5lzpg.jpeg"><br><h2>  Como fazemos: lan√ßamentos </h2><br>  Agora, sobre como publicamos as altera√ß√µes feitas no servi√ßo.  Aqui seguimos o caminho da racionaliza√ß√£o de processos: a implanta√ß√£o de uma nova vers√£o √© quase completamente automatizada. <br>  Quando um certo n√∫mero de altera√ß√µes √© acumulado no projeto, uma nova vers√£o √© criada automaticamente e sua montagem √© iniciada. <br><br><img src="https://habrastorage.org/webt/cy/to/0f/cyto0f3qhsuxs7bgd2momnccebe.jpeg"><br><br>  Em seguida, o servi√ßo √© implementado para teste, onde a estabilidade √© verificada. <br><br>  Ao mesmo tempo, o teste de desempenho autom√°tico √© iniciado.  Ele est√° envolvido em um servi√ßo especial.  N√£o vou falar sobre ele agora - sua descri√ß√£o √© digna de um artigo separado. <br><br>  Se a publica√ß√£o em teste for bem-sucedida, a publica√ß√£o da vers√£o no prestable ser√° iniciada automaticamente.  Prestable √© um cluster especial para o qual o tr√°fego normal do usu√°rio √© direcionado.  Se ele retornar um erro, o balanceador far√° uma solicita√ß√£o novamente na produ√ß√£o. <br><br>  Em prest√°veis, os tempos de resposta s√£o medidos e comparados com a libera√ß√£o anterior na produ√ß√£o.  Se tudo estiver bem, a pessoa se conectar√°: verifica os gr√°ficos e os resultados dos testes de carga e come√ßa a lan√ßar a produ√ß√£o. <br><br><h2>  Tudo de bom para o usu√°rio: teste A / B </h2><br>  Nem sempre √© √≥bvio se as altera√ß√µes no servi√ßo trar√£o benef√≠cios reais.  Para medir a utilidade da mudan√ßa, as pessoas criaram testes A / B.  Falarei um pouco sobre como isso funciona na pesquisa Yandex.Market. <br><br>  Tudo come√ßa com a adi√ß√£o de um novo par√¢metro CGI que inclui novas funcionalidades.  Seja nosso par√¢metro: <i>market_new_functionality = 1</i> .  Em seguida, no c√≥digo, ative esta funcionalidade com o sinalizador: <br><br><pre><code class="cpp hljs">If (cgi.experiments.market_new_functionality) { <span class="hljs-comment"><span class="hljs-comment">// enable new functionality }</span></span></code> </pre> <br>  Nova funcionalidade √© lan√ßada na produ√ß√£o. <br><br>  Existe um servi√ßo dedicado para automatizar o teste A / B, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descrito aqui</a> em detalhes.  Uma experi√™ncia √© criada no servi√ßo.  A parcela de tr√°fego √© definida, por exemplo, 15%.  O interesse √© definido n√£o para solicita√ß√µes, mas para usu√°rios.  O hor√°rio do experimento, por exemplo, uma semana, tamb√©m √© indicado. <br><br>  V√°rios experimentos podem ser iniciados ao mesmo tempo.  Nas configura√ß√µes, voc√™ pode especificar se a interse√ß√£o com outras experi√™ncias √© poss√≠vel. <br><br>  Como resultado, o servi√ßo adiciona automaticamente o argumento <i>market_new_functionality = 1</i> a 15% dos usu√°rios.  Ele tamb√©m calcula automaticamente as m√©tricas selecionadas.  Ap√≥s o experimento, os analistas analisam os resultados e tiram conclus√µes.  Com base nas descobertas, √© tomada a decis√£o de lan√ßar em produ√ß√£o ou refinamento. <br><br><h2>  M√£o √°gil do mercado: testes de produ√ß√£o </h2><br>  Muitas vezes acontece que √© necess√°rio verificar a opera√ß√£o de novas funcionalidades na produ√ß√£o, mas n√£o h√° certeza de como ela se comportar√° em condi√ß√µes de "combate" sob carga pesada. <br><br>  Existe uma solu√ß√£o: os sinalizadores nos par√¢metros CGI podem ser usados ‚Äã‚Äãn√£o apenas para testes A / B, mas tamb√©m para testar novas funcionalidades. <br><br>  Criamos uma ferramenta que permite alterar instantaneamente a configura√ß√£o em milhares de servidores sem expor o servi√ßo a riscos.  √â chamado "Stop Crane".  A ideia original era a capacidade de desativar rapidamente algumas funcionalidades sem layout.  Ent√£o a ferramenta se expandiu e se tornou mais complexa. <br><br>  O esquema do servi√ßo √© apresentado abaixo: <br><br><img src="https://habrastorage.org/webt/va/la/n8/valan8guj5dkld2j788pw7ytbwy.jpeg"><br><br>  A API define valores de sinalizador.  O servi√ßo de gerenciamento armazena esses valores em um banco de dados.  Todos os servidores acessam o banco de dados uma vez a cada dez segundos, distribuem os valores dos sinalizadores e aplicam esses valores a cada solicita√ß√£o. <br><br>  No Stop Crane, voc√™ pode definir dois tipos de valores: <br><br>  1) Express√µes condicionais.  Aplique quando um dos valores for executado.  Por exemplo: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>:<span class="hljs-string"><span class="hljs-string">"IS_DC1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: <span class="hljs-string"><span class="hljs-string">"CLUSTER==2 and IS_BERU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"4!"</span></span> }</code> </pre> <br>  O valor "3" ser√° aplicado quando a solicita√ß√£o for processada no local DC1.  E o valor √© "4" quando a solicita√ß√£o √© processada no segundo cluster para o site beru.ru. <br><br>  2) valores incondicionais.  Eles s√£o usados ‚Äã‚Äãpor padr√£o se nenhuma das condi√ß√µes for atendida.  Por exemplo: <br><br>  <i>valor, valor!</i> <br><br>  Se o valor terminar com um ponto de exclama√ß√£o, ele recebe uma prioridade mais alta. <br><br>  O analisador dos par√¢metros CGI analisa a URL.  Em seguida, aplica os valores do toque de parada. <br><br>  Aplicam-se valores com as seguintes prioridades: <br><br><ol><li>  Maior prioridade do toque de parada (ponto de exclama√ß√£o). </li><li>  O valor da consulta. </li><li>  O valor padr√£o √© do toque de parada. </li><li>  O valor padr√£o no c√≥digo. </li></ol><br>  Existem muitos sinalizadores indicados em valores condicionais - eles s√£o suficientes para todos os cen√°rios conhecidos por n√≥s: <br><br><ul><li>  Data center. </li><li>  Ambiente: produ√ß√£o, teste, sombra. </li><li>  Local: mercado, beru. </li><li>  N√∫mero do cluster. </li></ul><br>  Com essa ferramenta, voc√™ pode ativar a nova funcionalidade em um grupo de servidores (por exemplo, apenas em um datacenter) e testar a funcionalidade dessa funcionalidade sem nenhum risco espec√≠fico para todo o servi√ßo.  Mesmo se voc√™ cometeu um erro s√©rio em algum lugar, tudo come√ßou a cair e o data center inteiro caiu, os balanceadores redirecionar√£o as solicita√ß√µes para outro data center.  Os usu√°rios finais n√£o notar√£o nada. <br><br>  Se voc√™ perceber um problema, poder√° retornar imediatamente o valor anterior do sinalizador e as altera√ß√µes ser√£o revertidas. <br><br>  Este servi√ßo tem suas desvantagens: os desenvolvedores adoram muito e muitas vezes tentam incluir todas as altera√ß√µes no Stop Crane.  Estamos tentando combater o uso indevido. <br><br>  A abordagem Stop Crane funciona bem quando voc√™ j√° possui um c√≥digo est√°vel, pronto para ser lan√ßado na produ√ß√£o.  Ao mesmo tempo, voc√™ ainda tem d√∫vidas e deseja verificar o c√≥digo em condi√ß√µes de "combate". <br><br>  No entanto, a torneira n√£o √© adequada para testes durante o desenvolvimento.  Para os desenvolvedores, existe um cluster separado chamado "cluster de sombra". <br><br><h2>  Teste Encoberto: Cluster de Sombra </h2><br>  As solicita√ß√µes de um dos clusters s√£o duplicadas no cluster de sombra.  Mas o balanceador ignora completamente as respostas desse cluster.  O esquema de seu trabalho √© apresentado abaixo. <br><br><img src="https://habrastorage.org/webt/ie/xt/dp/iextdpgmvcam7ehqatcbwdjyjxe.jpeg"><br><br>  Temos um cluster de teste que est√° em condi√ß√µes reais de "combate".  O tr√°fego normal de usu√°rios voa para l√°.  O hardware nos dois clusters √© o mesmo, para que voc√™ possa comparar desempenho e erros. <br><br>  E como o balanceador ignora completamente as respostas, os usu√°rios finais n√£o ver√£o as respostas do cluster de sombra.  Portanto, n√£o √© assustador cometer um erro. <br><br><h2>  Conclus√µes </h2><br>  Ent√£o, como criamos uma pesquisa de mercado? <br><br>  Para que tudo corra bem, separamos a funcionalidade em servi√ßos separados.  Portanto, voc√™ pode dimensionar apenas os componentes que precisamos e simplific√°-los.  √â f√°cil fornecer um componente separado para outra equipe e compartilhar responsabilidades por trabalhar nele.  E uma economia significativa de ferro com essa abordagem √© uma vantagem √≥bvia. <br><br>  O cluster de sombra tamb√©m nos ajuda: voc√™ pode desenvolver servi√ßos, test√°-los no processo e, ao mesmo tempo, n√£o incomodar o usu√°rio. <br><br>  Bem, e verifique a produ√ß√£o, √© claro.  Precisa alterar a configura√ß√£o em mil servidores?  F√°cil, use um guindaste de parada.  Assim, voc√™ pode implantar imediatamente uma solu√ß√£o complexa pronta e reverter para uma vers√£o est√°vel, se surgirem problemas. <br><br>  Espero ter conseguido mostrar como tornamos o mercado r√°pido e est√°vel com uma base cada vez maior de ofertas.  Como resolver problemas do servidor, lidar com um grande n√∫mero de solicita√ß√µes, melhorar a flexibilidade do servi√ßo e fazer isso sem interromper os processos de trabalho. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt475848/">https://habr.com/ru/post/pt475848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt475834/index.html">Scrum n√£o ir√° ajud√°-lo. Entendemos porque</a></li>
<li><a href="../pt475836/index.html">Entrevista com Arthur Khachuyan: como calcular um bilion√°rio nas redes sociais?</a></li>
<li><a href="../pt475838/index.html">MUDAR pessoas. Ou ... mudar pessoas. Sobre como "decolar" o projeto de transforma√ß√£o</a></li>
<li><a href="../pt475840/index.html">Cliente da API do Badoo Jira: magia no Jira em PHP</a></li>
<li><a href="../pt475842/index.html">Substituindo URL de a√ß√£o e URI em telefones SIP ou gerenciando via websockets?</a></li>
<li><a href="../pt475850/index.html">Como come√ßar a construir uma carreira em TI, se voc√™ ainda n√£o tem experi√™ncia</a></li>
<li><a href="../pt475856/index.html">O Google App Script, Mikrotik, Telegram e VPNBook come√ßaram a tocar um quarteto</a></li>
<li><a href="../pt475858/index.html">Divertido cripto-energia: o calor da minera√ß√£o para humanos e o calor dos humanos para minera√ß√£o</a></li>
<li><a href="../pt475860/index.html">Apache NiFi. 28 de novembro, na sala de confer√™ncias Deworkacy</a></li>
<li><a href="../pt475862/index.html">Maus conselhos sobre a introdu√ß√£o do Machine Learning nos neg√≥cios</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>