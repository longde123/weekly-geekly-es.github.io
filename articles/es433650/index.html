<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¨ üë©üèø‚Äçüíª ‚ÑπÔ∏è Istio y Kubernetes en producci√≥n. Parte 2. Rastreo üòß ‚ôéÔ∏è üê≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En el √∫ltimo art√≠culo, examinamos los componentes b√°sicos de Service Mesh Istio, nos familiarizamos con el sistema y respondimos las preguntas b√°sicas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Istio y Kubernetes en producci√≥n. Parte 2. Rastreo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/433650/">  En el √∫ltimo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo,</a> examinamos los componentes b√°sicos de Service Mesh Istio, nos familiarizamos con el sistema y respondimos las preguntas b√°sicas que generalmente surgen al comienzo del trabajo con Istio.  En esta parte veremos c√≥mo organizar la recopilaci√≥n de informaci√≥n de rastreo a trav√©s de la red. <br><br><img src="https://habrastorage.org/webt/dz/-l/6j/dz-l6j3yddyja_gjqgvw-3_da2m.png"><br><a name="habracut"></a><br>  Lo primero que encuentran muchos desarrolladores y administradores de sistemas cuando escuchan las palabras que rastrea Service Mesh.  De hecho, agregamos un servidor proxy especial a cada nodo de red a trav√©s del cual pasa todo el tr√°fico TCP.  Parece que ahora puede enviar f√°cilmente informaci√≥n sobre todas las interacciones de red en la red.  Desafortunadamente, en realidad hay muchos matices que deben tenerse en cuenta.  Miremos a ellos. <br><br><h3>  Concepto err√≥neo n√∫mero uno: podemos obtener datos sobre viajes a trav√©s de la red de forma gratuita </h3><br>  De hecho, relativamente gratis, solo podemos conectar los nodos de nuestro sistema mediante flechas y la velocidad de datos que pasa entre los servicios (de hecho, solo el n√∫mero de bytes por unidad de tiempo).  Sin embargo, en la mayor√≠a de los casos, nuestros servicios se comunican mediante alg√∫n tipo de protocolo de nivel de aplicaci√≥n, como HTTP, gRPC, Redis, etc.  Y, por supuesto, queremos ver la informaci√≥n de rastreo precisamente de acuerdo con estos protocolos, queremos ver la tasa de solicitudes, no la tasa de datos.  Queremos entender la latencia de las solicitudes de nuestro protocolo.  Finalmente, queremos ver la ruta completa por la que pasa la solicitud desde que ingresa a nuestro sistema hasta que recibe una respuesta del usuario.  Este problema no se resuelve tan f√°cilmente. <br><br>  Para comenzar, veamos c√≥mo se ve el env√≠o de trazos de rastreo desde el punto de vista de la arquitectura en Istio.  Como recordamos de la primera parte, Istio tiene un componente separado para recolectar telemetr√≠a, que se llama Mixer.  Sin embargo, en la versi√≥n actual 1.0. * El env√≠o se realiza directamente desde servidores proxy, es decir, con proxy enviado.  El proxy de Envoy admite el env√≠o de tramos de rastreo a trav√©s del protocolo zipkin fuera de la caja.  Se pueden conectar otros protocolos, pero solo a trav√©s del complemento.  Con Istio, obtenemos inmediatamente el proxy enviado enviado y configurado, que solo admite el protocolo zipkin.  Si queremos utilizar, por ejemplo, el protocolo Jaeger y enviar tramos de rastreo a trav√©s de UDP, entonces necesitaremos ensamblar nuestra imagen de istio-proxy.  Hay soporte para complementos personalizados para istio-proxy, sin embargo, todav√≠a est√° en la versi√≥n alfa.  Por lo tanto, si queremos prescindir de una gran cantidad de configuraciones personalizadas, la gama de tecnolog√≠as utilizadas para almacenar y recibir tramos de rastreo se reduce.  De hecho, de los sistemas principales, ahora puede usar Zipkin, o Jaeger, pero enviar todo all√≠ usando un protocolo compatible con Zipkin (que es mucho menos eficiente).  El protocolo zipkin implica enviar toda la informaci√≥n de rastreo a los recolectores que utilizan el protocolo HTTP, que es bastante costoso. <br><br>  Como dije, queremos rastrear protocolos a nivel de aplicaci√≥n.  Y esto significa que los servidores proxy que est√°n al lado de cada servicio deben comprender qu√© tipo de interacci√≥n est√° ocurriendo ahora.  De manera predeterminada, Istio establece el tipo para todos los puertos TCP simples, lo que significa que no se enviar√°n seguimientos.  Para poder enviar rastreos, primero debe habilitar esta opci√≥n en la configuraci√≥n de malla principal y, lo que es m√°s importante, cambiar el nombre de todos los puertos de las entidades de servicio kubernetes de acuerdo con el protocolo utilizado en el servicio.  Es decir, por ejemplo, as√≠: <br><br><pre><code class="python hljs">apiVersion: v1 kind: Service metadata: name: nginx spec: ports: - port: <span class="hljs-number"><span class="hljs-number">80</span></span> targetPort: <span class="hljs-number"><span class="hljs-number">80</span></span> name: http selector: app: nginx</code> </pre> <br>  Tambi√©n puede usar nombres compuestos, como http-magic (Istio ve http y reconoce este puerto como punto final http).  El formato es: proto-extra. <br><br>  Para no parchear una gran cantidad de configuraciones para definir un protocolo, puede usar una soluci√≥n alternativa sucia: parchear un componente Pilot en un momento en que solo <a href="">ejecuta la l√≥gica de definici√≥n de protocolo</a> .  Al final, por supuesto, necesitar√° cambiar esta l√≥gica a est√°ndar e ir a la convenci√≥n de nomenclatura para todos los puertos. <br><br>  Para entender si el protocolo est√° realmente definido correctamente, debe ingresar a cualquiera de los contenedores de sidecar con proxy enviado y realizar una solicitud al puerto de administraci√≥n de la interfaz de enviado con location / config_dump.  En la configuraci√≥n resultante, debe mirar la operaci√≥n de campo de servicio deseada.  Se usa en Istio como un identificador de a d√≥nde va la solicitud.  Para personalizar el valor de este par√°metro en Istio (luego lo veremos en nuestro sistema de rastreo), es necesario especificar el indicador serviceCluster en la etapa de lanzamiento del contenedor del sidecar.  Por ejemplo, se puede calcular as√≠ a partir de variables obtenidas de los kubernetes API hacia abajo: <br><br> <code>--serviceCluster ${POD_NAMESPACE}.$(echo ${POD_NAME} | sed -e 's/-[a-z0-9]*-[a-z0-9]*$//g')</code> <br> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠</a> hay un buen ejemplo para comprender c√≥mo funciona el rastreo en el enviado. <br><br>  El punto final en s√≠ mismo para enviar tramos de rastreo tambi√©n debe especificarse en los indicadores de inicio del proxy del enviado, por ejemplo: <code>--zipkinAddress tracing-collector.tracing:9411</code> <br><br><h3>  Concepto err√≥neo n√∫mero dos: podemos obtener de forma econ√≥mica los rastros completos de la aprobaci√≥n de solicitudes para el sistema </h3><br>  Lamentablemente, esto no es as√≠.  La complejidad de la implementaci√≥n depende de c√≥mo ya haya implementado la interacci√≥n de los servicios.  Por qu√© <br><br>  El hecho es que para que istio-proxy comprenda la correspondencia de las solicitudes entrantes a un servicio con las que provienen del mismo servicio, no es suficiente solo interceptar todo el tr√°fico.  Necesita tener alg√∫n tipo de identificador de enlace.  El proxy HTTP de Envoy utiliza encabezados especiales, seg√∫n los cuales el enviado comprende qu√© solicitud de servicio en particular genera solicitudes espec√≠ficas para otros servicios.  Lista de tales encabezados: <br><br><ul><li>  x-request-id, </li><li>  x-b3-traceid, </li><li>  x-b3-spanid, </li><li>  x-b3-parentspanid, </li><li>  x-b3-muestreado, </li><li>  x-b3-flags, </li><li>  x-ot-span-context. </li></ul><br>  Si tiene un solo punto, por ejemplo, un cliente base donde puede agregar dicha l√≥gica, entonces todo est√° bien, solo necesita esperar a que todos los clientes actualicen esta biblioteca.  Pero si tiene un sistema muy heterog√©neo y no hay unificaci√≥n en la campa√±a de los servicios a los servicios a trav√©s de la red, lo m√°s probable es que este sea un gran problema.  Sin la adici√≥n de dicha l√≥gica, toda la informaci√≥n de rastreo ser√° solo "hermana".  Es decir, obtenemos todas las interacciones entre servicios, pero no se unir√°n en una sola cadena de paso a trav√©s de la red. <br><br><h3>  Conclusi√≥n </h3><br>  Istio proporciona una herramienta conveniente para recopilar informaci√≥n de rastreo a trav√©s de la red, sin embargo, debe comprender que para la implementaci√≥n deber√° adaptar su sistema y tener en cuenta las caracter√≠sticas de la implementaci√≥n de Istio.  Como resultado, debe resolver dos puntos principales: determinar el protocolo de la capa de aplicaci√≥n (que debe ser compatible con el proxy enviado) y configurar el reenv√≠o de informaci√≥n sobre la conectividad de las solicitudes al servicio a partir de las solicitudes del servicio (utilizando encabezados, en el caso del protocolo HTTP).  Cuando se resuelven estos problemas, obtenemos una herramienta poderosa que le permite recopilar informaci√≥n de la red de forma transparente, incluso en sistemas muy heterog√©neos escritos en muchos idiomas y marcos diferentes. <br><br>  En el pr√≥ximo art√≠culo sobre Service Mesh, consideraremos uno de los mayores problemas de Istio: el alto consumo de memoria de cada contenedor proxy de sidecar y discutiremos c√≥mo lidiar con √©l. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433650/">https://habr.com/ru/post/es433650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433638/index.html">Descomposici√≥n del proyecto para frontend</a></li>
<li><a href="../es433642/index.html">¬øNo te gustan los sistemas CRM? Simplemente no sabes c√≥mo cocinarlos</a></li>
<li><a href="../es433644/index.html">"Programaci√≥n en vivo": ¬øC√≥mo funcion√≥ la Semifinal Regional de ICPC en la Universidad ITMO?</a></li>
<li><a href="../es433646/index.html">Staffcop: vista lateral</a></li>
<li><a href="../es433648/index.html">El primer beneficio en la historia de los servicios de streaming occidentales: por qu√© estas no son tan buenas noticias</a></li>
<li><a href="../es433652/index.html">5G a trav√©s de los ojos de los usuarios. Expectativas y preocupaciones</a></li>
<li><a href="../es433658/index.html">TI en Alemania: c√≥mo buscar trabajo en las grandes ciudades de Alemania</a></li>
<li><a href="../es433660/index.html">C√≥mo habl√© en DefCamp por quinta vez</a></li>
<li><a href="../es433664/index.html">SATA SSD Enterprise en Infortrend 2-Storage Storage - Medici√≥n del rendimiento</a></li>
<li><a href="../es433666/index.html">Diccionario Funcorp</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>