<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐎 🤜🏽 🈶 Menulis driver laptop untuk bersenang-senang dan untung, atau Cara berkomitmen untuk kernel bahkan jika Anda tidak sepintar itu 🖕🏼 🧑🏽‍🤝‍🧑🏽 🌕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di mana semuanya dimulai 
 Mari kita mulai dengan pernyataan masalah kita. Kami memiliki 1 (satu) laptop. Laptop gamer baru. Dengan beberapa RGB-backl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menulis driver laptop untuk bersenang-senang dan untung, atau Cara berkomitmen untuk kernel bahkan jika Anda tidak sepintar itu</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484752/"><h2>  Di mana semuanya dimulai </h2><br>  Mari kita mulai dengan pernyataan masalah kita.  Kami memiliki 1 (satu) laptop.  Laptop gamer baru.  Dengan beberapa RGB-backlight pada keyboard-nya.  Ini terlihat seperti ini: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6d/ef2/d0f/f6def2d0ff5bcc3fe56d7805f257fd7c.jpg" alt="gambar"><br>  <i>Gambar diambil dari lenovo.com</i> <br><br>  Ada juga program yang diinstal di laptop ini.  Itulah hal yang mengontrol cahaya latar kami. <br><br>  Satu masalah - program berjalan di bawah Windows, dan kami ingin semuanya berjalan di Linux favorit kami.  Ingin LED berkedip dan warna-warna cantik itu berkedip dan mati dan semacamnya.  Sebuah pertanyaan alami muncul, dapatkah kita melakukan semua itu tanpa rekayasa balik dan menulis driver kita sendiri? <br><br>  Jawaban alami muncul, tidak.  Mari buka IDA dan dapatkan cracking. <br><br><a name="habracut"></a><br><br><h3>  Langkah 1 - Menggali kode </h3><br>  Ada tiga pemicu yang membuat lampu latar menyala.  Dalam urutan kesulitan naik: <br><br>  1. Program penggemar gim besar bernama Lenovo Nerve Center, yang memiliki menu penyiapan penggemar besar hanya untuk lampu latar ini. <br><br>  2. Kombinasi tombol pintas Fn + Spasi - mungkin dikelola oleh program tersebut juga. <br><br>  3. BIOS.  Saat laptop sedang memuat, lampu latar berkedip merah untuk sesaat.  Mungkin kita bisa menggunakannya? <br><br>  Saya harus mencoba semua 3. Tapi ada beberapa keberhasilan hanya di sepanjang yang pertama, jadi mari kita bicara tentang yang pertama di sini. <br><br>  Kami membuka folder dengan program kami: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/105/aaa/774/105aaa77430d926b8df36807cb177f77.png" alt="folder"><br><br>  Perhatikan di sini!  Ada DLL dengan nama yang sangat menarik - LedSettingsPlugin.dll.  Mungkinkah ...?  Mari kita buka di IDA Pro dan lihat sendiri. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39c/994/5ae/39c9945aec86778f668c0f14ec97fe00.png" alt="setengah benar"><br><br>  Lihatlah bagian kanan layar di sini - begitu, begitu banyak informasi debug!  Mari kita gunakan.  Beberapa string terlihat seperti nama fungsi di sini.  Saya bertanya-tanya mengapa ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8e8/cd8/77d/8e8cd877d3551b32d680a2ce399f34d6.png" alt="nama-fungsi"><br><br>  Oh, ini <i>adalah</i> nama-nama fungsi.  Nyaman!  Mari kita memanggil beberapa hal dengan nama mereka sendiri dan kemudian melihat daftar fungsi lagi.  Untuk memberi nama hal-hal di IDA Anda dapat menggunakan hotkey N, atau klik kanan hal yang ingin Anda beri nama. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc1/0a0/fd7/dc10a0fd790c45cfe0ace4303a971c64.png" alt="setledstatusex"><br><br>  Melihat fungsi, kita melihat sesuatu yang disebut Y720LedSetHelper :: SetLEDStatusEx.  Sepertinya yang kita butuhkan!  Ini membentuk semacam string, dan kemudian memberikannya ke sesuatu yang disebut CHidDevHelper :: HidRequestsByPath.  Bagian yang menarik yang harus kita lihat adalah var_38, disorot dengan penuh kasih sayang oleh IDA. <br><br>  Var_34 juga menarik.  Ini berjalan tepat setelah var_38 - dalam tradisi assembler, variabel disimpan dalam urutan terbalik di bawah RSP.  Var_34 di IDA hanyalah nama dari konstanta - -34h. <br><br>  Mulai dari var_38, program kami menempatkan nol, kemudian gaya, warna, nomor tiga dan blok - bagian keyboard yang akan mendapatkan warna ini.  (Kemudian, percobaan akan menunjukkan bahwa nomor tiga sebenarnya kecerahan. Menambahkan kontrol yang akan membuat pengemudi kami lebih baik daripada yang resmi!) <br><br>  Sekarang, mari kita menyelam ke dalam HidRequestsByPath dan mencoba mencari tahu apa yang perlu kita kirim dan ke mana. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd3/368/4ea/bd33684ea9ec9a7253bb2902c91c1e04.png" alt="penyembah"><br><br>  Lihat, dua fungsi.  HidD_GetFeature dan HidD_SetFeature. <br><br>  Mereka tidak dilacak dalam file ... tetapi dilacak dengan sangat baik dalam dokumentasi resmi Microsoft - di <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/hidsdi/nf-hidsdi-hidd_setfeature" rel="nofollow">sini</a> dan di <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/hidsdi/nf-hidsdi-hidd_getfeature" rel="nofollow">sini</a> . <br><br>  Kita bisa menepuk punggung kita sendiri sekarang.  Ini adalah dasar batu, tidak ada tempat untuk menggali lebih dalam.  Linux memiliki dua fungsi tersebut - kami baru saja kembali, dan memanggil mereka dengan argumen yang sama.  ... benar? <br><br><h3>  Langkah 2 - meluncurkan prototipe ...? </h3><br><br>  Tidak juga.  Ayo kembali ke Linux dan buka lsusb.  Kami akan menemukan keyboard kami di sana, dan kami akan mengirim sesuatu ke sana. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/461/304/5cd/4613045cd623936511a7edbb734b365a.png" alt="lsusb"><br><br>  Integrated Technology Express, Inc.  adalah yang paling menarik di sini.  Mari kita gunakan alat / dev / hidraw yang populer.  Kita dapat menemukan yang tepat hanya dengan melihat / sys / class / hidraw / hidraw * / device / uevent yang sesuai. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0fd/aa4/39a/0fdaa439a9fb9b995fbf543e08858a57.png" alt="hidraw"><br><br>  Yang ini  Semua digit cocok - itu artinya / dev / hidraw0 adalah perangkat kami.  Tapi mari kita coba mengirim sesuatu ... dan tidak ada yang terjadi!  Mengapa  Pada titik ini, burnout terjadi.  Mungkin ini bukan hanya untuk manusia biasa, teknik reverse engineering ini? <br><br>  Tapi mari kita terus berusaha.  Jika pengarangnya lebih ahli dalam hal ini, dia akan membalikkan Nerve Center lagi dan menghasilkan solusi ... Tapi kita tidak punya otak.  Mari kita reboot ke Windows, ada ide. <br><br>  Ada hal ini di Windows - Device Manager, mereka menyebutnya.  Memiliki banyak fungsi - tetapi kami tertarik pada satu.  Ini memungkinkan Anda untuk menonaktifkan perangkat.  Sederhana dan berwibawa. <br><br>  Jadi mari kita nonaktifkan semua perangkat sampai LED kita berhenti berkedip! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/96f/778/0f1/96f7780f1987136f81aa5cbf842ac7b9.jpg" alt="nonaktifkan perangkat"><br><br>  Ini berhasil.  Jika kita mengintip ID Hardware-nya - kita akan lihat apa itu, perangkat LED yang misterius itu. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c5/a44/265/7c5a4426568f1c71e0c7426b3f9e20e4.jpg" alt="perangkat kami"><br><br>  Lihat - ini dia. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f8/99d/a6a/7f899da6af09b1d0eb9159f6ffd6a151.png" alt="dmesg"><br><br>  Perangkat yang telah mengganggu dmesg saya selama beberapa tahun. <br><br>  <i>[Kenapa itu tidak ditampilkan di lsusb?</i>  <i>Ini bukan USB sama sekali, tentu saja!</i>  <i>Lampu latar menggunakan protokol yang disebut I2C HID - memungkinkan produsen untuk <s>menyembunyikan perangkat dari tangan orang jahat DIY</s> memasang gadget HID ke bus sistem komputer itu sendiri.]</i> <br><br><h3>  Sidestep 2.5 - mari kita membuat komit </h3><br>  Pencarian untuk perangkat yang benar ini telah banyak diringkas.  Dalam penceritaan asli, saya harus membuka pengaturan saya hampir sampai ke kernel sebelum saya menyadari mengapa tidak ada yang berhasil.  Juga, saya tidak menikmati log dmesg ini yang muncul sendiri setiap kali saya membuka kunci komputer saya.  Karena kita di sini - mengapa tidak pergi dan menulis komit singkat? <br><br>  Kita perlu menemukan dua hal - tempat di mana perangkat H2C I2C ditangani, dan tempat di mana kebiasaan mereka disimpan.  <a href="" rel="nofollow">Di sini</a>  Jangan berpikir terlalu keras dan lihat kesalahannya: laporan tidak lengkap.  Mari kita selesaikan. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eda/5da/50d/eda5da50dce50157f772a8a227702323.png" alt="ukuran input buruk"><br><br>  Tambahkan kekhasan baru, sebut saja I2C_HID_QUIRK_BAD_INPUT_SIZE atau sesuatu seperti itu.  Untuk menjaga tema. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/932/33e/296/93233e296f0d07184be67ca04cfb7539.png" alt="kekhasan"><br><br>  Juga mari kita tambahkan perangkat kita ke daftar quirked.  Apa yang telah kami lakukan sejauh ini: <br><br>  1. Mencari “i2c hid linux kernel” di mesin pencari.  Mengklik hasil ke-4 di DuckDuckGo. <br><br>  2. Tulis tiga (!) Kata dalam Bahasa Inggris - BAD_INPUT_SIZE <br><br>  3. Menambahkan satu ke BIT (4).  Hasil - BIT (5). <br><br>  4. Menambahkan nomor ke hid-id.h - ID perangkat kami (tidak diilustrasikan, tetapi kesulitannya serupa) <br><br>  Kami programmer, mari kita lakukan pemrograman sekarang. <br><br>  Lihat garis: <br> <code>ret_size = ihid-&gt;inbuf[0] | ihid-&gt;inbuf[1] &lt;&lt; 8;</code> <br> <br>  Dan kemudian mengeluh bahwa ret_size bukan yang itu. <br><br>  Setiap kali kekhasan kita aktif, mari kita lakukan ini tetapi mundur. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfe/693/f6c/dfe693f6c3d4bd88162f3902c6dd79af.png" alt="jika-kondisi"><br><br>  Kirim tambalan ke milis ... (ujilah sebelumnya!).  Sejujurnya, masuk ke milis itu lebih sulit daripada tambalan yang sebenarnya.  Itu tidak sederhana dengan cara apa pun. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/33b/dc0/148/33bdc0148925600e067f37a385d5f09f.png" alt="diterapkan"><br><br>  Itu dia! <br><br><h3>  Langkah 3 - driver! </h3><br>  Pada titik ini saya ingat - saya mencoba untuk menulis driver.  Memutuskan saya belum akan melakukan itu ke kernel - pertanyaan mulai muncul, pada titik ini Anda benar-benar harus memikirkan beberapa.  Jika ada yang membaca ini pandai kernel dan dapat berkonsultasi dengan saya, saya akan senang untuk berbicara. <br><br>  Mari kita buka python.  (Dulu bash, tetapi Anda berubah pikiran dengan sangat cepat dengan bahasa semacam itu).  Mari kita gunakan alat / dev / hidraw yang populer. <br><br>  / dev / hidraw0, / dev / hidraw1 - bagaimana cara kerja file-file itu?  Untuk I / O sederhana, Anda dapat menggunakannya seperti yang lain, dan sepertinya itu hanya akan berfungsi.  Dan GetFeature dan SetFeature - yah, itu cerita yang sama sekali berbeda. <br><br>  StackOverflow (atau orang lain, saya tidak ingat) mengatakan kepada saya bahwa saya harus melihat sesuatu yang disebut ioctl.  Ini adalah cara khusus untuk bekerja dengan file yang tidak biasa seperti perangkat HID, terminal dan hal-hal menjijikkan serupa. <br><br>  Tampaknya sederhana di permukaan - Anda memberinya pegangan file terbuka (bukan tingkat Python, tingkat OS! Baca lebih lanjut tentang pegangan OS di <a href="https://en.wikipedia.org/wiki/File_descriptor" rel="nofollow">sini</a> jika Anda ingin tahu.), Beberapa nomor dan buffer - dan kemudian melakukannya sesuatu dengan buffer itu dan mengembalikannya kepada Anda.  Saya tidak mencoba untuk menjadi cerdas di sini, hanya saja itu hampir sepenuhnya tergantung pada implementasi.  Berikut ini contohnya: 0xC0114806.  Apa itu  Itu SetFeature.  Itu juga <br><br> <code>(6 &lt;&lt; 29) | (ord('H') &lt;&lt; 8) | (0x06 &lt;&lt; 0) | (0x11 &lt;&lt; 16).</code> <br> <br>  6 pertama berarti file akan terbuka baik untuk membaca maupun untuk menulis.  Kami hanya menulis, tetapi dokumen mengatakan 6 yang berarti kami menempatkan 6. Ord ('H') adalah singkatan dari HID.  Terkadang singkatan dari hal-hal lain, tergantung pada file.  Tapi sekarang HID. <br><br>  0x06 adalah perintah itu sendiri.  Perintah keenam dari HID adalah SetFeature, yang kita butuhkan.  Dan bagian terakhir?  Ukuran buffer. <br><br>  Yang tersisa hanyalah menyatukannya menjadi panggilan ioctl, dan Anda mendapatkan driver.  <a href="https://gitlab.com/kryma/lenovo-y720-backlight-driver" rel="nofollow">Itu bekerja.</a>  . <br><br><h3>  Kata penutup dari penulis </h3><br>  Semoga artikel itu menarik dibaca.  Bahkan bacaan yang bermanfaat, mungkin.  Beberapa bagian dihilangkan atau disingkat menjadi singkat - pembaca yang lebih jeli mungkin memperhatikan bahwa pengemudi dapat membaca keadaan keyboard saat ini, dan fungsi set_status memiliki panggilan ioctl kedua yang bahkan tidak disebutkan dalam teks.  Pengembangan perangkat keras dan kernel Linux adalah hal-hal besar, dan satu kisah tidak akan mencakup semuanya.  Dan pada akhirnya, mungkin artikelnya bukan tentang ini.  Mungkin itu hanya tentang bagaimana melakukan sesuatu yang kecil dan baik, untuk open-source atau untuk diri sendiri, tidak sulit sama sekali.  Anda hanya perlu menemukan malam gratis senilai satu minggu, teh dan keinginan untuk menggali kode. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484752/">https://habr.com/ru/post/id484752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484736/index.html">Linux: menghapus kumpulan kunci / dev / acak</a></li>
<li><a href="../id484738/index.html">Panduan integrasi berkelanjutan untuk Laravel 6 di Google Cloud Run</a></li>
<li><a href="../id484740/index.html">Minggu Keamanan 04: masalah crypto di Windows 10</a></li>
<li><a href="../id484744/index.html">Bagaimana saya melakukan bayangan 2D di Unity</a></li>
<li><a href="../id484750/index.html">Skizofrenia: merawat</a></li>
<li><a href="../id484754/index.html">Intel tidak dapat memutuskan siapa yang lebih cepat: Danau Komet atau Danau Es</a></li>
<li><a href="../id484756/index.html">Teori Informasi Visual (Bagian 2)</a></li>
<li><a href="../id484758/index.html">Apa yang umum antara pemrograman dan memulai bisnis</a></li>
<li><a href="../id484760/index.html">Acara digital di Moskow dari 21 hingga 26 Januari</a></li>
<li><a href="../id484762/index.html">6 Cara untuk Berhenti Berlangganan dari Observables di Angular</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>