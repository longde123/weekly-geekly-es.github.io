<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ ğŸš® ğŸ‘©ğŸ¿â€ğŸ« Protokol untuk komunikasi antara iframe dan jendela browser utama ğŸ”  ğŸ¤°ğŸ» ğŸš¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Banyak pengembang secara berkala perlu menjalin komunikasi antara beberapa tab browser: kemampuan untuk mengirim pesan dari satu ke yang lain dan mene...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Protokol untuk komunikasi antara iframe dan jendela browser utama</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/waves/blog/455942/"><p>  Banyak pengembang secara berkala perlu menjalin komunikasi antara beberapa tab browser: kemampuan untuk mengirim pesan dari satu ke yang lain dan menerima respons.  Tugas semacam itu muncul di hadapan kita. </p><br><p>  Ada solusi standar seperti BroadcastChannel, tetapi dukungan browser sekarang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">banyak yang diinginkan</a> , jadi kami memutuskan untuk mengimplementasikan perpustakaan kami.  Ketika perpustakaan siap, ternyata fungsi tersebut tidak lagi diperlukan, tetapi tugas lain muncul: perlu untuk berkomunikasi antara iframe dan jendela utama. </p><br><p>  Setelah diperiksa lebih dekat, ternyata dua pertiga perpustakaan tidak dapat diubah secara bersamaan, Anda hanya perlu sedikit memperbaiki kode.  Perpustakaan lebih merupakan PROTOCOL komunikasi yang dapat bekerja dengan data teks.  Ini dapat digunakan dalam semua kasus jika dimungkinkan untuk mentransfer teks (iframe, window.open, pekerja, tab browser, WebSocket). </p><br><h2 id="kak-eto-rabotaet">  Bagaimana cara kerjanya </h2><br><p>  Saat ini, protokol memiliki dua fungsi: mengirim pesan dan berlangganan acara.  Pesan apa pun dalam protokol adalah objek dengan data.  Bidang utama objek ini adalah bidang <strong>jenis</strong> , yang memberi tahu kita seperti apa pesannya.  Bidang <strong>jenis</strong> adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">enum</a> dengan nilai: </p><a name="habracut"></a><br><ul><li>  0 - kirim pesan </li><li>  1 - mengirim permintaan </li><li>  2 - menerima respons. </li></ul><br><h3 id="otpravka-soobscheniya">  Pengiriman pesan </h3><br><p>  Mengirim pesan <strong>tidak</strong> menyiratkan respons.  Untuk mengirim acara, kami membuat objek dengan bidang: </p><br><ul><li>  <strong>tipe</strong> - <strong>tipe</strong> acara 0 </li><li>  <strong>nama</strong> - nama acara pengguna </li><li>  <strong>data</strong> - <strong>data</strong> pengguna (seperti JSON). </li></ul><br><p>  Ketika kami menerima pesan di sisi lain dengan bidang <strong>tipe</strong> = 0, kami tahu bahwa ini adalah acara dan ada nama acara dan data.  Yang tersisa hanyalah menjalankan event (pola <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">EventEmitter yang</a> hampir teratur). </p><br><p>  Skema bekerja dengan acara: </p><br><p><img src="https://habrastorage.org/webt/rs/ca/py/rscapy4jhbddmpzbztk4crk9sd0.png"></p><br><h3 id="otpravka-zaprosa">  Permintaan Pengajuan </h3><br><p>  Mengirim permintaan menyiratkan bahwa ID permintaan dihasilkan di dalam perpustakaan, perpustakaan akan menunggu respons dengan ID ini, dan setelah bidang layanan respons yang berhasil akan dihapus darinya, dan respons akan dikembalikan kepada pengguna.  Selain itu, Anda dapat mengatur waktu respons maksimum. </p><br><p><img src="https://habrastorage.org/webt/cb/0a/sa/cb0asaefngtcodhbgz0uwacrakm.png"></p><br><p>  Dengan permintaan itu, semuanya agak lebih rumit.  Untuk menanggapi permintaan, Anda harus mendeklarasikan metode yang tersedia dalam protokol kami.  Ini dilakukan dengan menggunakan metode <strong>registerRequestHandler</strong> .  Ia menerima nama permintaan yang akan ditanggapi, dan fungsi yang mengembalikan respons.  Untuk membuat permintaan, kami memerlukan <strong>id</strong> , dan secara umum, Anda dapat menggunakan <strong>stempel waktu</strong> , tetapi sangat tidak nyaman untuk melakukan debug.  Oleh karena itu, ini adalah <strong>id dari</strong> kelas yang mengirimkan permintaan + nomor seri dari permintaan + string konstan.  Selanjutnya, kita membangun objek dengan <strong>id</strong> bidang, <strong>ketik</strong> - dengan nilai 1, <strong>nama</strong> - nama permintaan, <strong>data</strong> - data pengguna (seperti JSON). </p><br><p>  Setelah menerima permintaan, kami memeriksa apakah kami memiliki API untuk menanggapi permintaan ini, jika tidak ada API, kami mengembalikan kesalahan.  Jika ada API, kami mengembalikan hasil fungsi dari <strong>registerRequestHandler</strong> , dengan nama permintaan yang sesuai. </p><br><p>  Objek dibentuk untuk respons dengan bidang <strong>tipe</strong> - dengan nilai 2, <strong>id</strong> - <strong>id</strong> pesan yang kami tanggapi, <strong>status</strong> - bidang yang mengatakan apakah respons ini adalah kesalahan (jika tidak ada API, atau kesalahan yang terjadi di pintu keluar pengguna, atau pengguna yang dikembalikan Janji yang Ditolak, kesalahan lain (cerita bersambung)), <strong>konten</strong> - data respons. </p><br><p>  Jadi, kami menggambarkan operasi protokol itu sendiri, yang mengimplementasikan kelas <strong>Bus</strong> , tetapi tidak menjelaskan bagaimana sebenarnya mengirim dan menerima pesan.  Untuk ini kita membutuhkan adaptor - kelas dengan 3 metode: </p><br><ul><li>  <strong>send</strong> - metode yang sebenarnya bertanggung jawab untuk mengirim pesan </li><li>  <strong>addListener</strong> - metode untuk berlangganan acara </li><li>  <strong>menghancurkan</strong> - untuk menghancurkan langganan ketika menghancurkan Bus. </li></ul><br>
<h3 id="adaptery-realizaciya-protokola">  Adaptor  Implementasi protokol. </h3><br><p>  Untuk memulai semua ini, saat ini hanya adaptor untuk bekerja dengan iframe / jendela yang siap.  Ini berfungsi pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">postMessage</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">addEventListener</a> .  Semuanya cukup sederhana di sini: Anda perlu mengirim pesan ke <strong>postMessage</strong> dengan <strong>asal yang</strong> benar dan mendengarkan pesan melalui <strong>addEventListener</strong> pada acara "message". </p><br><p>  Kehalusan kecil yang kami temui: </p><br><ul><li>  Anda harus selalu mendengarkan jawaban di jendela ANDA, dan mengirimkannya ke orang lain (iframe, pembuka, orang tua, pekerja, ...). <br>  Faktanya adalah ketika Anda mencoba mendengarkan pesan di jendela orang lain, jika asal berbeda dari yang sekarang, kesalahan akan terjadi. </li><li>  Ketika Anda menerima pesan, pastikan itu dikirim kepada Anda (banyak pesan dari analytics dipicu pada jendela, <br>  WebStrom (jika Anda menggunakannya), iframe asing, jadi Anda harus memastikan bahwa acara tersebut ada dalam protokol kami dan untuk kami). </li><li>  Anda tidak dapat mengembalikan <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Janji</a></strong> dengan turunan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Window</a> , karena <strong>Janji,</strong> saat mengembalikan hasil, mencoba memeriksa apakah hasilnya memiliki metode, dan jika Anda tidak memiliki akses ke jendela (misalnya, jendela dengan asal yang berbeda), kesalahan akan terjadi (walaupun tidak di semua browser )  Untuk menghindari masalah ini, cukup bungkus jendela di suatu objek dan masukkan objek <strong>Janji</strong> di mana ada tautan ke jendela yang diinginkan. </li></ul><br><h3 id="primery-ispolzovaniya">  Contoh penggunaan: </h3><br><p>  Perpustakaan dapat diinstal menggunakan manajer paket favorit Anda - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">@ Wave / Wave-browser-bus</a> </p><br><p>  Untuk membangun komunikasi dua arah dengan iframe, cukup tulis kode: </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Bus, WindowAdapter } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@waves/waves-browser-bus'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-string"><span class="hljs-string">'https://some-iframe-content-url.com'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> iframe = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'iframe'</span></span>); WindowAdapter.createSimpleWindowAdapter(iframe).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bus(adapter); bus.once(<span class="hljs-string"><span class="hljs-string">'ready'</span></span>, () =&gt; { <span class="hljs-comment"><span class="hljs-comment">//    iframe }); }); iframe.src = url; //   url   WindowAdapter.createSimpleWindowAdapter document.body.appendChild(iframe);</span></span></code> </pre> <br><p>  Dan di dalam iframe: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Bus, WindowAdapter } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@waves/waves-browser-bus'</span></span>; WindowAdapter.createSimpleWindowAdapter().then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bus(adapter); bus.dispatchEvent(<span class="hljs-string"><span class="hljs-string">'ready'</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      });</span></span></code> </pre> <br><h2 id="chto-dalshe">  Apa selanjutnya </h2><br><p>  Ternyata protokol yang fleksibel dan universal yang dapat digunakan dalam situasi apa pun. <br>  Sekarang saya berencana untuk memisahkan adapter dari protokol dan menempatkannya dalam paket npm terpisah, menambahkan adapter untuk bekerja dengan tab pekerja dan browser.  Saya ingin menulis adaptor yang mengimplementasikan protokol untuk kebutuhan lain, sesederhana mungkin. </p><br><p>  Jika Anda memiliki keinginan untuk bergabung dengan pengembangan atau ide-ide tentang fungsi perpustakaan - Anda dipersilakan ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id455942/">https://habr.com/ru/post/id455942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id455932/index.html">Bagaimana Kami Menemukan Cara Keren untuk Menghubungkan Bisnis dan DevOps</a></li>
<li><a href="../id455934/index.html">Transfer data cadangan dari versi baru MS SQL Server ke versi yang lebih lama</a></li>
<li><a href="../id455936/index.html">Bapak Perangkat Lunak Bebas, Richard Stallman, datang ke Rusia. Kami mencari seseorang yang siap untuk melindunginya selama beberapa hari</a></li>
<li><a href="../id455938/index.html">Apakah perangkat lunak berkualitas tinggi sepadan dengan biaya pengembangannya?</a></li>
<li><a href="../id455940/index.html">File QVD - apa yang ada di dalamnya, bagian 2</a></li>
<li><a href="../id455944/index.html">Mulai bekerja dengan freelancer. Belajar berkeliling</a></li>
<li><a href="../id455946/index.html">Konten yang dilarang di Google Play - pencarian survival</a></li>
<li><a href="../id455948/index.html">RAMBleed: mengambil kunci RSA dalam 34 jam</a></li>
<li><a href="../id455950/index.html">Bahasa pemrograman yang paling langka dan paling mahal. Bagian II</a></li>
<li><a href="../id455952/index.html">Pembuatan Kode dengan Roslyn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>