<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöì ‚ÜóÔ∏è üòÄ Sensores de janela sem fio caseiros: STM32L051 + RFM69 + Android üë©üèº‚ÄçüöÄ üë®üèæ‚ÄçüöÄ üñ≤Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Boa tarde, queridos Khabrovites! Alguns anos atr√°s, comprei um an√∫ncio zWave colorido e instalei sensores de janela com base nesse protocolo. Um zWave...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sensores de janela sem fio caseiros: STM32L051 + RFM69 + Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482858/"> Boa tarde, queridos Khabrovites!  Alguns anos atr√°s, comprei um an√∫ncio zWave colorido e instalei sensores de janela com base nesse protocolo.  Um zWave-Stick USB foi conectado ao servidor dom√©stico, que desempenhou o papel de um controlador, um pequeno m√≥dulo Java foi gravado que recebeu dados desse controlador e um pequeno aplicativo para Android foi gravado, exibindo lindamente o status de todos os sensores.  Baterias s√£o inseridas, sensores s√£o registrados no controlador, tudo funcionou.  Mas depois de alguns meses, houve uma terr√≠vel decep√ß√£o.  Em primeiro lugar, esses sensores zWave trabalham com o princ√≠pio de "enviar uma mensagem e adormecer sem aguardar confirma√ß√£o".  No meu caso, isso levou ao fato de que o sinal dos sensores mais distantes do controlador simplesmente n√£o chegou ao controlador.  Mesmo a instala√ß√£o de um repetidor zWave adicional n√£o ajudou.  Em segundo lugar, eles descarregaram a bateria t√£o rapidamente que, ap√≥s cerca de seis meses, todos os sensores pararam de funcionar.  O motivo √© que eles acordavam a cada hora para informar o controlador sobre sua condi√ß√£o.  Desabilitar ou alterar esta op√ß√£o n√£o funcionou, pois o software padr√£o categoricamente n√£o permitiu isso.  Ap√≥s dois anos de tormento com essa tecnologia bruta, n√£o confi√°vel e hostil, decidi que tinha o suficiente.  Mas, em vez de guardar tudo e jog√°-lo fora, tive a ideia de deixar os estojos, mas alterei os eletr√¥nicos neles.  A escolha recaiu sobre um transceptor RFM69 bastante simples (433 MHz), com base no qual foi poss√≠vel criar uma placa para o sensor e um controlador conectado via USB ao servidor.  O novo sistema j√° est√° em opera√ß√£o h√° 5 meses, a confiabilidade √© pr√≥xima de 100% (mas ainda existem algumas falhas), as baterias ainda n√£o parecem vazias.  Ou seja, j√° √© vis√≠vel que todas as defici√™ncias do sistema antigo baseado no zWave foram eliminadas e quero compartilhar os detalhes t√©cnicos deste artigo, veja a figura. <br><br><img src="https://habrastorage.org/webt/n-/gz/rd/n-gzrd4pxnz2h38utebhqhtakjg.png"><br><br>  Quem se importa, por favor, debaixo do gato. <br><a name="habracut"></a><br>  Parece-me que o zWave, no meu caso, se mostrou inoperante por dois motivos: a casa tem dois andares com piso de concreto armado e uma grande √°rea (isto √©, uma remo√ß√£o significativa de alguns sensores do controlador).  Bem, falhas no software propriet√°rio, que n√£o permitiam desativar a ativa√ß√£o peri√≥dica dos sensores, o que levava a uma r√°pida descarga da bateria.  Quando ficou claro que n√£o estava a caminho do zWave, comecei a procurar outras op√ß√µes que pudessem ser empurradas para as mesmas caixas de sensores. <br><br>  Meu primeiro prot√≥tipo de sensores foi baseado no ESP8266.  O controlador - com base no meu pagamento sobre o qual eu j√° <a href="https://habr.com/en/post/413101">escrevi no Habr√©</a> .  O sistema at√© funcionou como um prot√≥tipo, mas tive que abandon√°-lo por dois motivos.  A primeira raz√£o √© a mesma: na casa havia cantos com um n√≠vel muito baixo de sinal WiFi, o que levou a um tempo de ativa√ß√£o muito longo do ESP8266 ao acordar e, como resultado, a uma forte descarga de bateria.  Embora eu admita que simplesmente n√£o sei cozinhar isso muito ESP8266 (artigos <a href="https://habr.com/ru/post/480316">como este</a> confirmam esta tese).  Mas o segundo motivo foi mais s√©rio.  Como decidi deixar n√£o apenas o estojo, mas tamb√©m o compartimento da bateria, fiquei limitado a uma bateria CR123A, que √© de 3,0 volts.  Ou seja, o pre√ßo e a complexidade do sensor aumentaram devido ao aumento do conversor DC / DC.  Embora <a href="https://habr.com/ru/post/304936">exista um artigo maravilhoso</a> sobre este t√≥pico em Habr√©.  Mas, enfim, esses dois motivos superaram e eu rejeitei o ESP8266. <br><br>  O segundo prot√≥tipo foi conectado.  Fiz um prot√≥tipo do sensor e do controlador USB, adicionei um m√≥dulo de servidor para que ele entendesse esse controlador al√©m do zWave-Stick.  Havia uma ideia de puxar gradualmente os fios e o sensor ap√≥s o sensor para mudar a placa zWave para uma com fio.  Mas no final, ele n√£o escolheu paredes e esse prot√≥tipo tamb√©m foi descartado. <br><br>  Ent√£o ele decidiu olhar para os m√≥dulos de r√°dio em 433 e 868 MHz e encomendou v√°rios m√≥dulos para experimentos: <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> , <a href="https://www.mouser.de/datasheet/2/21/A110LR09A_ProductBrief-1511797.pdf" rel="nofollow">A110LR09A</a> e <a href="https://www.mouser.de/datasheet/2/268/70651A-60467.pdf" rel="nofollow">MRF89XAM8A</a> .  Em termos de tamanho, pre√ßo e tamb√©m devido √† disponibilidade de bibliotecas e <a href="https://learn.sparkfun.com/tutorials/rfm69hcw-hookup-guide" rel="nofollow">bons exemplos,</a> optei pelo RFM69HCW, que formava a base do sistema. <br><br>  O sistema possui apenas quatro componentes: <br><br><ul><li>  sensores sem fio (433 MHz, bateria CR123A 3.0V), </li><li>  controlador de rede (433 MHz, alimentado via USB a partir do servidor) </li><li>  o servidor (sobre o qual eu j√° escrevi no Habr√© <a href="https://habr.com/en/post/268197">neste artigo</a> ) e o m√≥dulo do programa do servidor </li><li>  cliente m√≥vel (aplicativo Android) </li></ul><br>  Abaixo, descreverei cada m√≥dulo em detalhes e, no final, darei estat√≠sticas sobre a opera√ß√£o do sistema nos √∫ltimos meses de opera√ß√£o. <br><br><h3>  Sensores </h3><br>  Os sensores usam o <a href="https://www.sparkfun.com/products/13910" rel="nofollow">m√≥dulo de</a> r√°dio <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> .  Possui uma ampla faixa de tens√£o operacional (1,8V-2,4V 17dBm, 2,4V-3,6V 20dBm) e √© controlada via SPI.  Ou seja, voc√™ precisa de um microcontrolador.  Algum tempo atr√°s, eu me familiarizei com a s√©rie STM32L e pedi o STM32L051 para experimentos.  Ele me subornou como uma pequena corrente no modo de suspens√£o (0,27 ŒºA) e a tens√£o de opera√ß√£o, quase id√™ntica √† tens√£o do m√≥dulo de r√°dio (1,65V-3,6V).  Mais baixo pre√ßo. <br><br>  O resultado foi o seguinte: <br><br><img src="https://habrastorage.org/webt/0b/xx/kb/0bxxkbtvavy113lz23izewdi4yk.png" alt="imagem"><br><br>  A tens√£o de alimenta√ß√£o do microcontrolador e do m√≥dulo de r√°dio √© tal que eles podem ser alimentados diretamente a partir do elemento CR123A.  O STM32L051 possui uma refer√™ncia de tens√£o interna conectada ao canal ADC 17, bem como o valor de calibra√ß√£o dessa fonte, que permite medir o valor atual da tens√£o de alimenta√ß√£o VDD.  O m√≥dulo de r√°dio est√° conectado √† energia atrav√©s do dispositivo de campo Q1, que permite controlar a energia do microcontrolador. <br><br>  O modo de suspens√£o √© implementado transferindo o microcontrolador para "Em espera".  Nesse modo, o STM32L051 possui um n√∫cleo desativado, quase todos os perif√©ricos e um regulador de tens√£o interno, o que garante um consumo no n√≠vel de 0,29 ŒºA (com o rel√≥gio em tempo real desativado).  Mas neste modo h√° uma caracter√≠stica - o microcontrolador acorda apenas ao longo da borda ascendente do sinal no pino WKUP (A0).  Como um interruptor magn√©tico √© usado, que est√° ligado / desligado (fechado ou aberto), voc√™ precisa de um pequeno bloco que gere um pulso de curta dura√ß√£o, ao fechar e ao abrir um contato magn√©tico.  Esse pulso √© alimentado na entrada A0 do microcontrolador e o desperta.  Esse conversor √© implementado no chip OR-IC3 exclusivo da s√©rie 74AUP de baixo consumo de energia (74AUP1G86), que opera na faixa de tens√£o de 0,8V-3,6V e consome 0,2 ŒºA.  Assim, o consumo total no modo de suspens√£o deve ficar em torno de 0,5 ŒºA, o que √© confirmado por medi√ß√µes em um sensor totalmente montado. <br><br>  Quando o microcontrolador acorda, ele primeiro mede a tens√£o de alimenta√ß√£o e, se for menor que 1,8 volts, n√£o √© o destino - o transmissor n√£o pode ser iniciado e o microcontrolador adormece. <br><br>  Se a tens√£o da bateria for superior a 1,8 volts, o microcontrolador liga e inicializa o m√≥dulo de r√°dio, transfere o estado para o controlador de rede e aguarda confirma√ß√£o.  O pacote de dados inclui um n√∫mero exclusivo de pacote de 32 bits (evento), tens√£o da bateria, temperatura, status do contato magn√©tico, byte de controle (CRC7).  Em caso de confirma√ß√£o bem-sucedida, o microcontrolador adormece.  Caso contr√°rio, envia o status novamente, mas no m√°ximo 10 vezes.  Defino esse limite para que o sensor n√£o tente esperar indefinidamente por uma resposta em uma situa√ß√£o em que o controlador de rede √© simplesmente desligado.  O √∫ltimo n√∫mero de evento exclusivo transmitido √© armazenado na EEPROM interna do microcontrolador. <br><br>  Durante a transfer√™ncia de dados, o microcontrolador pisca um LED (onde sem ele).  O LED √© ligado usando PWM, onde o ciclo de servi√ßo depende do valor da tens√£o atual, o que permite que voc√™ tenha quase o mesmo brilho em quase toda a faixa de tens√£o operacional. <br><br>  As placas s√£o projetadas no EagleCAD, o design da placa <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">est√° dispon√≠vel aqui</a> .  As placas s√£o de dupla face: o microcontrolador e seu chicote est√£o localizados no lado superior voltado para a moldura da janela, e o m√≥dulo de r√°dio e o LED est√£o no lado inferior voltado para a sala.  Eu pedi na China, me soldado em um forno de cozinha convencional (camada superior) e um secador de cabelo (camada inferior). <br><br><img src="https://habrastorage.org/webt/rj/io/9l/rjio9lhfs3psrwyw8_xefn1lcmi.jpeg" alt="imagem"><br><br>  O m√≥dulo de r√°dio precisa de uma antena.  Este √© apenas um peda√ßo de fio com 164 mm de comprimento. <br><br>  Ap√≥s a instala√ß√£o, cada sensor deve ser programado, para o qual √© fornecido um conector SWD.  Deixei os contatos restantes no quadro para poss√≠veis experi√™ncias no futuro. <br>  O firmware √© escrito em C ++, parte do c√≥digo √© realizada em classes b√°sicas bastante universais que encapsulam chamadas para a biblioteca ST HAL.  O c√≥digo fonte <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">est√° aqui</a> .  Para o desenvolvimento, foi utilizado o System Workbench for STM32.  O tamanho do arquivo final do firmware bin√°rio √© 22 kB. <br><br>  E aqui est√° o sensor no caso: <br><br><img src="https://habrastorage.org/webt/91/fx/ap/91fxapzu7uwnpr0wp2cjydbpwaa.jpeg" alt="imagem"><br><br>  Dependendo da posi√ß√£o do sensor, para alguns sensores deixei a antena do lado de fora (contra o fundo da moldura branca, no entanto, ela n√£o √© vis√≠vel) e, para alguns sensores, dobrei o fio na moldura e o enfiei completamente dentro do gabinete. <br><br>  Por uma quest√£o de interesse, calculei o custo dos componentes para um sensor (aos pre√ßos do cat√°logo da Mouser, pre√ßo e pre√ßo total em euros) <br><table cellspacing="0" border="0"><tbody><tr><td align="left">  <b><font>Item</font></b> </td><td align="left">  <b><font>Descri√ß√£o do produto</font></b> </td><td align="left">  <b><font>Valor</font></b> </td><td align="left">  <b><font>N√∫mero MOUSER</font></b> </td><td align="left">  <b><font>Qtde</font></b> </td><td align="left">  <b><font>Custo</font></b> </td></tr><tr><td align="left">  <font>IC3</font> </td><td align="left">  <font>OU exclusivo</font> </td><td align="left">  <font>1G86</font> </td><td align="left">  <font>771-74AUP1G86GW-G</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,254</font> </td></tr><tr><td align="left">  <font>IC1</font> </td><td align="left">  <font>Microcontrolador</font> </td><td align="left">  <font>STM32L051</font> </td><td align="left">  <font>511-STM32L051K6T6</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>2,14</font> </td></tr><tr><td align="left">  <font>SV1</font> </td><td align="left">  <font>Conector</font> </td><td align="left">  <font>Swd</font> </td><td align="left">  <font>68602-406HLF</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,157</font> </td></tr><tr><td align="left">  <font>LED1</font> </td><td align="left">  <font>LED 3 mm</font> </td><td align="left">  <font>3mm</font> </td><td align="left">  <font>630-HLMP-K155</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,351</font> </td></tr><tr><td align="left">  <font>Q1</font> </td><td align="left">  <font>P-mosfet</font> </td><td align="left">  <font>BSH205</font> </td><td align="left">  <font>771-BSH205G2R</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,276</font> </td></tr><tr><td align="left">  <font>S1</font> </td><td align="left">  <font>Contato magn√©tico</font> </td><td align="left">  <font>ORD211-0810</font> </td><td align="left">  <font>876-ORD211-0810</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,625</font> </td></tr><tr><td align="left">  <font>IC2</font> </td><td align="left">  <font>M√≥dulo de r√°dio RFM69HCW</font> </td><td align="left">  <font>RFM69HCW</font> </td><td align="left">  <font>474-COM-13910</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>5,36</font> </td></tr><tr><td align="left">  <font>C1, C2, C3, C6</font> </td><td align="left">  <font>Capacitor SMD</font> </td><td align="left">  <font>0.1uF</font> </td><td align="left">  <font>80-C0805C104J5RAC</font> </td><td align="left">  <font>4</font> </td><td align="left">  <font>0,1</font> </td></tr><tr><td align="left">  <font>C5</font> </td><td align="left">  <font>Capacitor SMD</font> </td><td align="left">  <font>0.4nF</font> </td><td align="left">  <font>C0805C471K8HACTU</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,021</font> </td></tr><tr><td align="left">  <font>C4</font> </td><td align="left">  <font>Capacitor SMD (t√¢ntalo)</font> </td><td align="left">  <font>47uF</font> </td><td align="left">  <font>581-TAJR225K016RNJ</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,334</font> </td></tr><tr><td align="left">  <font>R1</font> </td><td align="left">  <font>Resistor SMD</font> </td><td align="left">  <font>10K</font> </td><td align="left">  <font>660-RK73H2ATTDD1002F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R10</font> </td><td align="left">  <font>Resistor SMD</font> </td><td align="left">  <font>330</font> </td><td align="left">  <font>660-RK73H2ATTDD3300F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R3, R4, R6, R7, R8, R11</font> </td><td align="left">  <font>Resistor SMD</font> </td><td align="left">  <font>47K</font> </td><td align="left">  <font>660-RK73H2ATTDD4702F</font> </td><td align="left">  <font>6</font> </td><td align="left">  <font>0,06</font> </td></tr><tr><td align="left">  <font>R5</font> </td><td align="left">  <font>Resistor SMD</font> </td><td align="left">  <font>56.</font> </td><td align="left">  <font>660-RK73H2ATTD56R0F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,013</font> </td></tr><tr><td align="left">  <font>R9</font> </td><td align="left">  <font>Resistor SMD</font> </td><td align="left">  <font>56M</font> </td><td align="left">  <font>603-RC0805JR-0756ML</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,037</font> </td></tr><tr><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left">  <b><font>9,748</font></b> </td></tr></tbody></table><br>  A prop√≥sito, ficou exatamente tr√™s vezes mais barato que o sensor zWave original.  Embora este seja apenas o custo de pe√ßas, excluindo o caso.  Mas, na minha opini√£o, no varejo, os sensores zWave s√£o indecentemente caros. <br><br><h3>  Controlador de rede </h3><br>  Para o controlador, o mesmo m√≥dulo de r√°dio e o mesmo microcontrolador foram utilizados nos sensores.  Isso permitiu reutilizar a maior parte do c√≥digo do firmware.  Para o controlador, escolhi esse formato da placa para usar o gabinete pronto do Raspberry Pi.  Comparado ao sensor, foram adicionados um conector de antena externa e um loop USB baseado no isolador FT232RL e SI-8621.  Obviamente, em vez disso, pode-se levar algum STM32 com USB a bordo.  Mas ent√£o, primeiro, seria necess√°rio separar o c√≥digo do firmware e, segundo, fazer a implementa√ß√£o do software do pr√≥prio USB.  A op√ß√£o com um FT232RL externo, embora seja mais cara, √© mais confi√°vel e mais r√°pida de implementar.  O resultado √© o <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">seguinte esquema</a> : <br><br><img src="https://habrastorage.org/webt/wh/ij/_k/whij_k04j8jqetojnlz0hblpnom.png" alt="imagem"><br><br>  E na forma montada ficou assim: <br><br><img src="https://habrastorage.org/webt/f2/-4/io/f2-4iog6apig6hfmq-6zhhxmzno.jpeg" alt="imagem"><br><br><img src="https://habrastorage.org/webt/dp/gg/cu/dpggcuqsrdegbwobtujrbf1rlck.jpeg" alt="imagem"><br><br>  O microcontrolador n√£o dorme aqui, o m√≥dulo de r√°dio funciona para recep√ß√£o, mas ap√≥s receber com √™xito um pacote de qualquer um dos sensores, o m√≥dulo entra no modo de transmiss√£o e envia uma confirma√ß√£o.  Al√©m disso, qualquer pacote recebido com sucesso √© transmitido via USB para o servidor.  O formato do pacote √© uma sequ√™ncia de valores separados pelo s√≠mbolo ";": <br>  GW; 3; 12; -57; 0; 146; 30; 18 <br>  onde: <br><br><ul><li>  primeira posi√ß√£o √© a etiqueta do pacote (sempre ‚ÄúGW‚Äù) </li><li>  segunda posi√ß√£o - tipo de dados (status do sensor ou c√≥digo de erro) </li><li>  terceira posi√ß√£o - n√∫mero do sensor </li><li>  quarta posi√ß√£o - qualidade do sinal na lateral do controlador de rede (o RFM69HCW preserva a qualidade do sinal durante a recep√ß√£o e permite que voc√™ a interrogue quando a recep√ß√£o termina) </li><li>  quinta posi√ß√£o - estado da janela (0 aberto, 1 fechado) </li><li>  sexta posi√ß√£o - um n√∫mero exclusivo do pacote (evento) do sensor.  Esse n√∫mero permite controlar no lado do servidor se todos os eventos foram recebidos pelo servidor ou se um ou mais eventos foram perdidos. </li><li>  s√©tima posi√ß√£o - tens√£o atual da bateria (30 corresponde a 3.0V) </li><li>  a √∫ltima, oitava posi√ß√£o √© a temperatura do sensor interno do microcontrolador.  Ainda n√£o descobri como us√°-lo </li></ul><br>  O c√≥digo fonte do firmware est√° <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">no mesmo local que o sensor</a> .  Eles t√™m um arquivo principal comum e uma biblioteca comum de classes base.  A op√ß√£o de firmware (sensor ou controlador) √© selecionada usando a diretiva define no arquivo main.cpp. <br><br>  O custo do controlador de rede √© maior devido ao circuito USB, antena e conectores adicionais.  Mas esse aditivo pode ser negligenciado, pois existe apenas um controlador.  Mas, mesmo com este suplemento, ele tamb√©m se mostrou tr√™s vezes mais barato que o zWave-Stick, que estava antes em seu lugar. <br><br><h3>  M√≥dulo servidor </h3><br>  O controlador de rede est√° conectado a um servidor executando o CentOS 7. O servidor executa um programa escrito em Java.  E em sua estrutura, implementa√ß√£o e tarefas, o programa √© bastante simples: <br><br><ul><li>  Usando uma biblioteca <a href="http://rxtx.qbang.org/wiki/index.php/Main_Page" rel="nofollow">RxTx</a> muito antiga e aparentemente sem suporte, a porta USB especificada na configura√ß√£o √© monitorada (no meu caso / dev / ttyUSB0).  No momento, essa √© a parte menos otimizada de todo o sistema, pois a biblioteca carrega muito o processador do servidor. </li><li>  Se os dados s√£o recebidos da porta USB, eles s√£o gravados em um arquivo de log e armazenados na classe de status do sensor.  Quando voc√™ reinicia o servidor, o estado √© perdido.  Para restaur√°-lo, voc√™ precisa percorrer a casa e abrir e fechar manualmente todas as janelas.  Essa √© provavelmente a maior desvantagem do meu sistema, mas eu me recusei conscientemente a pesquisar periodicamente os sensores com o objetivo de economizar suas baterias. </li><li>  O aplicativo tamb√©m √© um pequeno servidor TCP / IP e escuta na porta TCP / IP especificada na configura√ß√£o.  Nesta porta, ele pode aceitar conex√µes de um cliente m√≥vel. </li><li>  Se o cliente m√≥vel se conectar ao servidor, ele envia o status atual de todos os sensores.  Usando mensagens peri√≥dicas de heartbit, o servidor tamb√©m monitora a atividade da conex√£o. </li><li>  O servidor e o cliente m√≥vel trocam mensagens no formato XML.  Essas mensagens s√£o implementadas na forma de uma pequena <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/common" rel="nofollow">biblioteca Java</a> , que √© compartilhada no lado do servidor e no lado do aplicativo m√≥vel Android. </li><li>  Embora isso n√£o fa√ßa muito sentido, por uma quest√£o de interesse, adicionei a fun√ß√£o de autorizar um cliente m√≥vel via IMEI, bem como a criptografia AES de mensagens entre o servidor e o cliente usando uma chave costurada no c√≥digo-fonte (pacote Java javax.crypto).  Mas isso √© apenas para o experimento, j√° que a porta TCP / IP deste m√≥dulo de servidor √© acess√≠vel apenas a partir da rede interna e n√£o √© vis√≠vel a partir do exterior.  Embora, se eu quiser abrir essa porta para o grande mundo, agora n√£o ser√° t√£o assustador faz√™-lo. </li></ul><br>  Quem se importa, o c√≥digo fonte do m√≥dulo do servidor est√° <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/server" rel="nofollow">aqui</a> . <br><br><h3>  Cliente m√≥vel (aplicativo Android) </h3><br>  Voc√™ n√£o escreve muito aqui, apesar de esse aplicativo ser o resultado final de todo o projeto.  Este √© um aplicativo Java padr√£o e muito simples, com tr√™s guias: o estado das janelas do primeiro andar, o estado do segundo andar e uma pequena telemetria do servidor (consulte o <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/app" rel="nofollow">c√≥digo-fonte aqui</a> ): <br><br><img src="https://habrastorage.org/webt/j5/hz/hd/j5hzhduedoxedwhuuhrpe0e4s8e.png" alt="imagem"><br><br>  Os gr√°ficos s√£o baseados em um conjunto de arquivos SVG, que s√£o empilhados uns sobre os outros, dependendo do estado dos sensores.  Uma press√£o longa √© suportada na √°rea de cada janela, segundo a qual uma dica √© exibida com o hor√°rio em que esta janela foi aberta: <br><br><img src="https://habrastorage.org/webt/4e/_z/42/4e_z42j_o2j11j7tl9lzzefeffi.png" alt="imagem"><br><br>  Em princ√≠pio, nada impede que voc√™ adicione um √≠cone de bateria a essa dica de ferramenta, mas suas m√£os ainda n√£o o alcan√ßaram. <br><br><h3>  Experi√™ncia operacional </h3><br>  "Todo espirro" √© registrado em um arquivo de log no lado do servidor.  A an√°lise desses arquivos nos √∫ltimos 5 meses nos permite entender um pouco mais detalhadamente como esse sistema se sente. <br><br>  A an√°lise √© muito simples - apenas grep na pasta de arquivos de log no servidor. <br><br>  Quantos erros houve na transmiss√£o de dados no canal de r√°dio?  Durante 5 meses, 8 erros foram registrados quando a mensagem foi recebida no tamanho errado e 25 erros no CRC errado.  Nos dois casos, voc√™ n√£o pode dizer diretamente qual sensor teve problemas, pois o pacote de dados neste caso est√° completamente danificado.  Como o controlador de rede n√£o confirma a recep√ß√£o de dados em todos esses casos, o sensor deve enviar os dados de uma nova maneira, o que na maioria dos casos corrige esses erros. <br><br>  E aqui est√° uma tabela de resumo sobre a opera√ß√£o dos sensores por 5 meses. <br><table cellspacing="0" border="0"><tbody><tr><td align="center">  <b><font>Pavimento</font></b> </td><td align="center">  <b><font>Sensor</font></b> </td><td align="center">  <b><font>Quantidade</font></b> <b><font><br></font></b>  <b><font>De eventos</font></b> </td><td align="center">  <b><font>Dos perdidos</font></b> <b><font><br></font></b>  <b><font>De eventos</font></b> </td><td align="center">  <b><font>Tens√£o</font></b> <b><font><br></font></b>  <b><font>Baterias</font></b> </td><td align="center">  <b><font>Mediana</font></b> <b><font><br></font></b>  <b><font>Poder</font></b> <b><font><br></font></b>  <b><font>Signal</font></b> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>10</font> </td><td align="center">  <font>105</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font color="#800000">3.1.</font> </td><td align="center">  <font>-66</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>11</font> </td><td align="center">  <font>52</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>12</font> </td><td align="center">  <font>122</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-61</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>13</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>14</font> </td><td align="center">  <font>2573</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>15</font> </td><td align="center">  <font>261</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>16</font> </td><td align="center">  <font>543</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>17</font> </td><td align="center">  <font>156</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>18</font> </td><td align="center">  <font>177</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.2.</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>19</font> </td><td align="center">  <font>384</font> </td><td align="center">  <font color="#800000">3</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-56</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>3</font> </td><td align="center">  <font>368</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>4</font> </td><td align="center">  <font>86</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-71</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>5</font> </td><td align="center">  <font>521</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-59</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>6</font> </td><td align="center">  <font>115</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>7</font> </td><td align="center">  <font>316</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-63</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>8</font> </td><td align="center">  <font>419</font> </td><td align="center">  <font color="#800000">1</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>9</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0 0</font> </td><td align="center">  <font>3.3.</font> </td><td align="center">  <font>-68</font> </td></tr></tbody></table><br>  O sensor n ¬∞ 10 congela uma vez.  Aparentemente, isso levou a uma diminui√ß√£o significativa na tens√£o da bateria.  A raz√£o do congelamento ainda n√£o est√° clara.  Ele trava novamente, voc√™ precisa descobrir. <br><br>  O sensor n ¬∞ 14 est√° instalado na porta da frente, e √© por isso que ele tem um n√∫mero t√£o grande de respostas.  Mas um n√∫mero t√£o grande de viagens ainda n√£o afetou a tens√£o da bateria. <br><br>  Um evento perdido √© quando o sensor tenta enviar um estado, mas o servidor n√£o o confirma.  Todos os eventos perdidos se devem ao fato de eu desligar o servidor por cerca de meio dia para a limpeza. <br><br>  A coluna Mediana da for√ßa do sinal mediana mostra o valor mediano do RSSI (em dBm), onde cada valor individual √© obtido ap√≥s o recebimento de cada pacote.  O sensor com o melhor sinal (n¬∫ 19, -56 dBm) est√° localizado a 2 metros do controlador de rede, mas a antena desse sensor est√° enrolada dentro do gabinete.  O pr√≥prio controlador de rede est√° localizado no t√©rreo.  No entanto, o sinal dos sensores do segundo andar √© muito bom.  Isso se deve ao fato de que em todos os sensores do segundo andar a antena √© removida da carca√ßa do sensor. <br><br><h3>  Em vez de um posf√°cio </h3><br>  Por um lado, fico feliz que, por conta pr√≥pria, como hobby, tenha sa√≠do do zero para projetar, montar e executar um sistema desse n√≠vel.  E ainda mais feliz por funcionar melhor que o sistema "propriet√°rio", baseado na tecnologia hype da zWave.  Tamb√©m h√° espa√ßo para desenvolver e melhorar esse sistema.  Eu sou apenas ro√≠do por pequenas d√∫vidas.  Ou seja, que uma pessoa sem educa√ß√£o el√©trica especializada colete de joelhos algo que funcione de maneira mais confi√°vel do que produtos de marca conhecidos em c√≠rculos estreitos de marcas IOT.  Provavelmente, o progresso virou em algum lugar na dire√ß√£o errada. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt482858/">https://habr.com/ru/post/pt482858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt482848/index.html">Bot ao vivo, parte 2</a></li>
<li><a href="../pt482850/index.html">Perspectivas para os biocombust√≠veis na avia√ß√£o</a></li>
<li><a href="../pt482852/index.html">A era do √°udio compacto: como as fitas entraram nos carros</a></li>
<li><a href="../pt482854/index.html">Sobre a estimativa</a></li>
<li><a href="../pt482856/index.html">Estranho Divino</a></li>
<li><a href="../pt482860/index.html">Eu era o chefe de rela√ß√µes internacionais no Google. Por isso sa√≠</a></li>
<li><a href="../pt482862/index.html">Existe um GameDev em Sakhalin? 1.V</a></li>
<li><a href="../pt482864/index.html">Vigil√¢ncia por v√≠deo em casa. Esquema de manter um arquivo de v√≠deo sem um registrador dom√©stico</a></li>
<li><a href="../pt482866/index.html">Vale a pena comprar Bitcoin no pr√≥ximo ano e quanto vai custar</a></li>
<li><a href="../pt482870/index.html">Como comprei um laptop bloqueado no eBay e tentei fazer o meu AntiTheft baseado no IntelAMT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>