<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥üèø ‚ù§Ô∏è üë¥üèΩ Automatice el reemplazo del disco con Ansible üèúÔ∏è üçò üòø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos Trabajo como administrador l√≠der del sistema en OK y soy responsable del funcionamiento estable del portal. Quiero hablar sobre c√≥mo cons...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automatice el reemplazo del disco con Ansible</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/452110/"><img src="https://habrastorage.org/webt/s9/ga/q9/s9gaq9eke8gooeu1-nnsr5ocv7o.jpeg"><br><br>  Hola a todos  Trabajo como administrador l√≠der del sistema en OK y soy responsable del funcionamiento estable del portal.  Quiero hablar sobre c√≥mo construimos el proceso de reemplazo autom√°tico de discos, y luego, como administrador, fue excluido de este proceso y lo reemplaz√≥ con un bot. <br><br>  Este art√≠culo es una especie de transcripci√≥n del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rendimiento</a> en HighLoad + 2018 <br><a name="habracut"></a><br><h2>  Construyendo un proceso de reemplazo de disco </h2><br><h3>  Primero unos pocos n√∫meros </h3><br>  OK es un servicio gigantesco utilizado por millones de personas.  Cuenta con aproximadamente 7 mil servidores, ubicados en 4 centros de datos diferentes.  Los servidores cuestan m√°s de 70 mil unidades.  Si los apilas uno encima del otro, obtienes una torre con una altura de m√°s de 1 km. <br><br>  Los discos duros son un componente del servidor que se bloquea con mayor frecuencia.  Con tales vol√∫menes, tenemos que cambiar unos 30 discos por semana, y este procedimiento se ha convertido en una rutina no muy agradable. <br><br><img src="https://habrastorage.org/webt/i8/92/cg/i892cglklhooat_z_qrsexsmzfu.png"><br><br><h3>  Incidentes </h3><br>  Hemos introducido una gesti√≥n completa de incidentes en nuestra empresa.  Cada incidente que registramos en Jira, y luego lo resolvemos y lo desmontamos.  Si el incidente tuvo un efecto para los usuarios, entonces definitivamente vamos a pensar en c√≥mo responder m√°s r√°pido en tales casos, c√≥mo reducir el efecto y, por supuesto, c√≥mo prevenir una recurrencia. <br><br>  Las unidades no son la excepci√≥n.  Su estado es monitoreado por Zabbix.  Monitoreamos los mensajes en Syslog para errores de escritura / lectura, analizamos el estado de las redadas de HW / SW, monitoreamos SMART y calculamos el desgaste de los SSD. <br><br><h3>  C√≥mo cambiaron los discos antes </h3><br>  Cuando se enciende un disparador en Zabbix, se crea un incidente en Jira y se env√≠a autom√°ticamente a los ingenieros apropiados en los centros de datos.  Hacemos esto con todos los incidentes HW, es decir, aquellos que requieren alg√∫n tipo de trabajo f√≠sico con el equipo en el centro de datos. <br>  Un ingeniero de un centro de datos es una persona que resuelve problemas relacionados con el hardware, es responsable de la instalaci√≥n, mantenimiento y desmantelamiento de los servidores.  Habiendo recibido un boleto, el ingeniero comienza a trabajar.  En los estantes de discos, cambia los discos por su cuenta.  Pero si no tiene acceso al dispositivo deseado, el ingeniero recurre a los administradores del sistema para que lo ayuden.  En primer lugar, debe eliminar el disco de la rotaci√≥n.  Para hacer esto, debe realizar los cambios necesarios en el servidor, detener la aplicaci√≥n y desmontar el disco. <br><br>  El administrador del sistema de turno durante el turno es responsable de la operaci√≥n de todo el portal.  Investiga incidentes, reparaciones, ayuda a los desarrolladores a realizar peque√±as tareas.  No solo trata con discos duros. <br><br>  Anteriormente, los ingenieros del centro de datos conversaban con el administrador del sistema.  Los ingenieros enviaron enlaces a los boletos de Jira, el administrador los revis√≥ y mantuvo un registro de trabajo en un bloc de notas.  Pero los chats son inconvenientes para tales tareas: la informaci√≥n all√≠ no est√° estructurada y se pierde r√°pidamente.  Y el administrador pod√≠a simplemente alejarse de la computadora y por alg√∫n tiempo no responder a las solicitudes, y el ingeniero se par√≥ en el servidor con un mont√≥n de discos y esper√≥. <br><br>  Pero lo peor fue que los administradores no vieron la imagen completa: qu√© incidentes de disco existen, d√≥nde podr√≠a surgir el problema.  Esto se debe al hecho de que damos todos los incidentes HW a los ingenieros.  S√≠, fue posible mostrar todos los incidentes en el panel de administraci√≥n.  Pero hay muchos, y el administrador solo estuvo involucrado en algunos de ellos. <br><br>  Adem√°s, el ingeniero no pudo priorizar correctamente, porque no sabe nada sobre el prop√≥sito de servidores espec√≠ficos, sobre la distribuci√≥n de informaci√≥n entre unidades. <br><br><h3>  Nuevo procedimiento de reemplazo </h3><br>  Lo primero que hicimos fue tomar todos los incidentes de disco en un tipo separado de "disco HW" y agregarle los campos "bloquear nombre de dispositivo", "tama√±o" y "tipo de disco" para que esta informaci√≥n se guarde en el ticket y no tenga que chateando constantemente. <br><br><div style="text-align:center;"><img width="300" height="400" src="https://habrastorage.org/webt/0y/uz/jm/0yuzjmgoz4hgulcpf5o5vhwde18.png"></div><br>  Tambi√©n acordamos que, en el marco de un incidente, cambiaremos un solo disco.  Esto simplific√≥ enormemente el proceso de automatizaci√≥n, la recopilaci√≥n de estad√≠sticas y el trabajo. <br><br>  Adem√°s, se agreg√≥ el campo "administrador responsable".  El administrador del sistema se sustituye autom√°ticamente all√≠.  Esto es muy conveniente, porque ahora el ingeniero siempre ve qui√©n es responsable.  No es necesario ir al calendario y buscar.  Fue este campo el que permiti√≥ colocar tickets en el tablero del administrador, en el cual, tal vez, su ayuda ser√≠a necesaria. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9x/b1/ue/9xb1ueokh0450wgkhq0ije1lfqa.png"></div><br>  Para garantizar que todos los participantes reciban el m√°ximo beneficio de las innovaciones, creamos filtros y paneles, les contamos a los muchachos sobre ellos.  Cuando las personas entienden los cambios, no se distancian de ellos como de algo innecesario.  Es importante que un ingeniero sepa el n√∫mero de rack donde se encuentra el servidor, el tama√±o y el tipo de disco.  El administrador necesita, en primer lugar, comprender qu√© tipo de grupo de servidores es este, qu√© tipo de efecto puede tener al reemplazar un disco. <br><br>  La presencia de campos y su visualizaci√≥n es conveniente, pero esto no nos salv√≥ de la necesidad de usar chats.  Para hacer esto, tuve que cambiar el flujo de trabajo. <br><br>  Sol√≠a ‚Äã‚Äãser as√≠: <br><br><div style="text-align:center;"><img width="300" height="400" src="https://habrastorage.org/webt/we/wc/du/wewcdu4q8fqy-gd9wkbutorbabi.png"></div><br>  Hoy, los ingenieros contin√∫an trabajando as√≠ cuando no necesitan ayuda del administrador. <br><br>  Lo primero que hicimos fue introducir un nuevo estado <b>Investigar</b> .  El ticket est√° en este estado cuando el ingeniero a√∫n no ha decidido si necesitar√° un administrador o no.  A trav√©s de este estado, el ingeniero puede pasar el ticket al administrador.  Adem√°s, marcamos los tickets con este estado cuando se requiere un reemplazo del disco, pero no hay ning√∫n disco en el sitio.  Esto sucede con CDN y sitios remotos. <br><br>  Tambi√©n agregamos el estado <b>Listo</b> .  El ticket se transfiere a √©l despu√©s de reemplazar el disco.  Es decir, todo ya se ha hecho, pero RAID HW / SW est√° sincronizado en el servidor.  Esto puede llevar bastante tiempo. <br><br>  Si hay un administrador involucrado, el esquema es un poco m√°s complicado. <br><br><div style="text-align:center;"><img width="400" src="https://habrastorage.org/webt/ev/5a/58/ev5a58jyosbyuc8cfrhr7sru5zo.png"></div><br>  Desde el estado <b>Abierto</b> , un ticket puede ser transferido tanto por un administrador del sistema como por un ingeniero.  En el estado <b>En progreso</b> , el administrador elimina el disco de la rotaci√≥n para que el ingeniero pueda simplemente eliminarlo: enciende la luz de fondo, desmonta el disco y detiene las aplicaciones, seg√∫n el grupo de servidores espec√≠fico. <br><br>  Luego, el boleto se convierte en <b>Listo para cambiar</b> : esta es una se√±al para el ingeniero de que el disco puede extraerse.  Todos los campos en Jira ya est√°n llenos, el ingeniero sabe qu√© tipo y tama√±o del disco.  Estos datos se colocan en el estado anterior autom√°ticamente o por el administrador. <br><br>  Despu√©s de reemplazar el disco, el ticket se transfiere al estado <b>Modificado</b> .  Se verifica que se ha insertado el disco correcto, se realiza el marcado, se inicia la aplicaci√≥n y se realizan algunas tareas de recuperaci√≥n de datos.  Adem√°s, el ticket se puede transferir al estado <b>Listo</b> , en cuyo caso el administrador seguir√° siendo responsable, porque inici√≥ el disco en rotaci√≥n.  El esquema completo se ve as√≠. <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/xg/x7/_z/xgx7_zk2mlyubhzepgfw0oogbt4.png"></div><br>  Agregar nuevos campos hizo nuestra vida mucho m√°s f√°cil.  Los chicos comenzaron a trabajar con informaci√≥n estructurada, qued√≥ claro qu√© y en qu√© etapa hacer.  Las prioridades se han vuelto mucho m√°s relevantes ya que ahora las establece el administrador. <br><br>  La necesidad de chats ha desaparecido.  Por supuesto, el administrador puede escribirle al ingeniero "necesita reemplazar m√°s r√°pido aqu√≠" o "ya por la noche, ¬øtendr√° tiempo de reemplazar?".  Pero ya no chateamos diariamente sobre estos temas. <br><br>  Los discos comenzaron a cambiar en paquetes.  Si el administrador vino a trabajar un poco antes, tiene tiempo libre y no ha pasado nada, puede preparar una serie de servidores para su reemplazo: colocar campos, eliminar discos de la rotaci√≥n y transferir la tarea al ingeniero.  M√°s tarde, un ingeniero llega al centro de datos, ve la tarea, toma las unidades necesarias del almac√©n y la cambia de inmediato.  Como resultado, la velocidad de reemplazo ha aumentado. <br><br><h3>  Lecciones aprendidas en el flujo de trabajo del edificio </h3><br><ul><li>  <b>Al crear un procedimiento, debe recopilar informaci√≥n de diferentes fuentes.</b> <br>  Algunos de nuestros administradores no sab√≠an que el ingeniero cambi√≥ los discos por su cuenta.  Algunos pensaban que los ingenieros supervisaban la sincronizaci√≥n RAID de MD, aunque algunos de ellos ni siquiera ten√≠an acceso a esto.  Algunos ingenieros l√≠deres hicieron esto, pero no siempre, porque el proceso no se describi√≥ en ninguna parte. </li><li>  <b>El procedimiento debe ser simple y directo.</b> <br>  Es dif√≠cil para una persona mantener muchos pasos en su cabeza.  Los estados vecinos m√°s importantes en Jira deben mostrarse en la pantalla principal.  Puede cambiarles el nombre, por ejemplo, en progreso llamamos Listo para cambiar.  Y los estados restantes se pueden ocultar en el men√∫ desplegable para que no tengan ojos callosos.  Pero es mejor no limitar a las personas, dar la oportunidad de hacer la transici√≥n. <br>  Explicar el valor de la innovaci√≥n.  Cuando las personas entienden, mejor aceptan el nuevo procedimiento.  Para nosotros era muy importante que la gente no llamara todo el proceso, sino que lo siguiera.  Luego construimos sobre esta automatizaci√≥n. </li><li>  <b>Espera, analiza, comprende.</b> <br>  Nos llev√≥ alrededor de un mes construir el procedimiento, la implementaci√≥n t√©cnica, las reuniones y las discusiones.  Y para la implementaci√≥n: m√°s de tres meses.  Vi c√≥mo la gente lentamente comienza a usar la innovaci√≥n.  En las primeras etapas, hab√≠a mucha negatividad.  Pero √©l era completamente independiente del procedimiento en s√≠, su implementaci√≥n t√©cnica.  Por ejemplo, un administrador no us√≥ Jira, sino el complemento Jira en Confluence, y algunas cosas no estaban disponibles para √©l.  Le mostr√≥ a Jira, el administrador ha aumentado la productividad y las tareas generales, y para reemplazar discos. </li></ul><br><h2>  Automatizaci√≥n de reemplazo de unidades </h2><br>  Pasamos a la automatizaci√≥n de reemplazar discos varias veces.  Ya ten√≠amos tiempo de operaci√≥n, scripts, pero todos funcionaban de forma interactiva o en modo manual, requer√≠an lanzamiento.  Y solo despu√©s de la introducci√≥n del nuevo procedimiento, nos dimos cuenta de que solo faltaba. <br><br>  Como ahora el proceso de reemplazo se divide en etapas, cada una de las cuales tiene un ejecutor y una lista de acciones, podemos activar la automatizaci√≥n en etapas, y no todas a la vez.  Por ejemplo, el paso m√°s simple: Listo (comprobaci√≥n de RAID / sincronizaci√≥n de datos) se puede delegar f√°cilmente en el bot.  Cuando el bot aprende un poco, puede asignarle una tarea m√°s responsable: poner el disco en rotaci√≥n, etc. <br><br><h3>  Configuraciones de zool√≥gico </h3><br>  Antes de hablar sobre el bot, haremos una peque√±a excursi√≥n a nuestro zool√≥gico de instalaci√≥n.  En primer lugar, se debe al tama√±o gigantesco de nuestra infraestructura.  En segundo lugar, para cada servicio intentamos elegir la configuraci√≥n √≥ptima del hierro.  Tenemos alrededor de 20 modelos RAID de hardware, principalmente LSI y Adaptec, pero hay HP y DELL de diferentes versiones.  Cada controlador RAID tiene su propia utilidad de administraci√≥n.  El conjunto de comandos y su emisi√≥n pueden diferir de una versi√≥n a otra de cada controlador RAID.  Donde no se utiliza HW-RAID, puede ser mdraid. <br><br>  Casi todas las instalaciones nuevas que hacemos sin copia de seguridad de disco.  Intentamos dejar de usar RAID de hardware y software, ya que reservamos nuestros sistemas a nivel de centros de datos, no de servidores.  Pero, por supuesto, hay muchos servidores heredados que deben ser compatibles. <br><br>  En alg√∫n lugar, los discos en los controladores RAID lanzan dispositivos sin formato; en alg√∫n lugar, usan JBOD.  Hay configuraciones con una unidad de sistema en el servidor, y si necesita reemplazarlo, debe volver a formatear el servidor con la instalaci√≥n del sistema operativo y las aplicaciones, con las mismas versiones, luego agregar archivos de configuraci√≥n, iniciar aplicaciones.  Tambi√©n hay muchos grupos de servidores donde la redundancia se lleva a cabo no a nivel del subsistema de disco, sino directamente en las propias aplicaciones. <br><br>  En total, tenemos m√°s de 400 grupos √∫nicos de servidores que ejecutan alrededor de 100 aplicaciones diferentes.  Para cubrir tantas opciones, necesit√°bamos una herramienta de automatizaci√≥n multifuncional.  Es aconsejable con un DSL simple, de modo que no solo la persona que escribi√≥ esto pueda soportarlo. <br><br>  Elegimos Ansible porque no tiene agentes: no hab√≠a necesidad de preparar la infraestructura, inicio r√°pido.  Adem√°s, est√° escrito en Python, que es aceptado como est√°ndar en el equipo. <br><br><h3>  Esquema general </h3><br>  Veamos un esquema de automatizaci√≥n general usando un incidente como ejemplo.  Zabbix detecta que la unidad sdb est√° fuera de servicio, el gatillo se enciende y se crea un ticket en Jira.  El administrador lo mir√≥, se dio cuenta de que esto no es un duplicado ni un falso positivo, es decir, que necesita cambiar el disco y traduce el ticket en curso. <br><br><img src="https://habrastorage.org/webt/9s/fy/q5/9sfyq5cucem0dbbhahfd3_w7tac.png"><br>  La aplicaci√≥n DiskoBot escrita en Python sondea peri√≥dicamente Jira en busca de nuevos boletos.  Se da cuenta de que ha aparecido un nuevo ticket En progreso, se activa el hilo correspondiente, que inicia el libro de jugadas en Ansible (esto se hace para cada estado en Jira).  En este caso, se inicia Prepare2change. <br><br>  Ansible va al host, elimina el disco de la rotaci√≥n e informa el estado a la aplicaci√≥n a trav√©s de Callbacks. <br><br><img src="https://habrastorage.org/webt/i2/bk/nq/i2bknqits8exw9dtr7sj4zydl58.png"><br>  Seg√∫n los resultados, el bot transfiere autom√°ticamente el ticket a Listo para cambiar.  El ingeniero recibe una notificaci√≥n y va a cambiar el disco, luego de lo cual transfiere el ticket a Cambiado. <br><br><img src="https://habrastorage.org/webt/h9/m8/zw/h9m8zwfrzltmu0q1tz8opctrccu.png"><br>  De acuerdo con el esquema anterior, el ticket vuelve al bot, lanza otro libro de jugadas, va al host y entra al disco en rotaci√≥n.  El bot cierra el boleto.  ¬°Hurra! <br><br><img src="https://habrastorage.org/webt/cv/js/w1/cvjsw1y9qrpkra2twsx-sy4jokc.png"><br>  Ahora hablemos sobre algunos de los componentes del sistema. <br><br><h3>  Diskobot </h3><br>  Esta aplicaci√≥n est√° escrita en Python.  Selecciona entradas de Jira de acuerdo con <abbr title="Lenguaje de consulta JIRA">JQL</abbr> .  Dependiendo del estado del ticket, este √∫ltimo llega al controlador correspondiente, que a su vez inicia el estado del libro de jugadas Ansible correspondiente. <br><br>  JQL y los intervalos de sondeo se definen en el archivo de configuraci√≥n de la aplicaci√≥n. <br><br><pre><code class="plaintext hljs">jira_states: investigate: jql: '‚Ä¶ status = Open and "Disk Size" is EMPTY' interval: 180 inprogress: jql: '‚Ä¶ and "Disk Size" is not EMPTY and "Device Name" is not EMPTY' ready: jql: '‚Ä¶ and (labels not in ("dbot_ignore") or labels is EMPTY)' interval: 7200</code> </pre> <br>  Por ejemplo, entre los tickets en estado En progreso, solo se completan aquellos con los campos Tama√±o del disco y Nombre del dispositivo.  Nombre del dispositivo es el nombre del dispositivo de bloque necesario para ejecutar el libro de jugadas.  Se necesita el tama√±o del disco para que el ingeniero sepa qu√© tama√±o de disco se necesita. <br><br>  Y entre los tickets con el estado Listo, los tickets con la etiqueta dbot_ignore se filtran.  Por cierto, utilizamos etiquetas de Jira tanto para dicho filtrado, como para marcar tickets duplicados y para recopilar estad√≠sticas. <br><br>  Si el libro de jugadas falla, Jira asigna la etiqueta dbot_failed para que puedas resolverlo m√°s tarde. <br><br><h3>  Interacci√≥n con Ansible </h3><br>  La aplicaci√≥n interact√∫a con Ansible a trav√©s de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API Ansible Python</a> .  En playbook_executor, pasamos el nombre del archivo y el conjunto de variables.  Esto le permite mantener el proyecto Ansible en forma de archivos yml regulares, en lugar de describirlo en c√≥digo Python. <br><br>  Tambi√©n en Ansible a trav√©s de * extra_vars * se usa el nombre del dispositivo de bloqueo, el estado del ticket, as√≠ como callback_url, en el que se conecta la clave de emisi√≥n, se usa para la devoluci√≥n de llamada en HTTP. <br><br>  Para cada lanzamiento, se genera un inventario temporal, que consta de un host y el grupo al que pertenece este host para que se aplique group_vars. <br><br>  Aqu√≠ hay un ejemplo de una tarea en la que se implementa la devoluci√≥n de llamada HTTP. <br><br>  El resultado de los libros de jugadas que obtenemos usando callaback (s).  Son de dos tipos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Complemento de devoluci√≥n de llamada</a> , proporciona datos sobre los resultados de un libro de jugadas.  Describe las tareas que se iniciaron, que se realizaron con √©xito o sin √©xito.  Esta devoluci√≥n de llamada se llama al final del libro de jugadas. </li><li>  Devoluci√≥n de llamada HTTP para obtener informaci√≥n mientras juega un libro de jugadas.  En Ansible, realizamos una solicitud POST / GET al lado de nuestra aplicaci√≥n. </li></ul><br>  Mediante las devoluciones de llamada HTTP, se transmiten las variables que se definieron durante la ejecuci√≥n del libro de jugadas y que queremos guardar y usar en ejecuciones posteriores.  Escribimos estos datos en sqlite. <br><br>  Tambi√©n a trav√©s de la devoluci√≥n de llamada HTTP dejamos comentarios y cambiamos el estado del ticket. <br><br><div class="spoiler">  <b class="spoiler_title">Devoluci√≥n de llamada HTTP</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># Make callback to Diskobot App # Variables: # callback_post_body: # A dict with follow keys. All keys are optional # msg: If exist it would be posted to Jira as comment # data: If exist it would be saved in Incident.variables # desire_state: Set desire_state for incident # status: If exist Proceed issue to that status - name: Callback to Diskobot app (jira comment/status) uri: url: "{{ callback_url }}/{{ devname }}" user: "{{ diskobot_user }}" password: "{{ diskobot_pass }}" force_basic_auth: True method: POST body: "{{ callback_post_body | to_json }}" body_format: json delegate_to: 127.0.0.1</code> </pre><br></div></div><br>  Al igual que muchas de las mismas tareas, lo colocamos en un archivo com√∫n separado y lo incluimos si es necesario, para que no se repita constantemente en los libros de jugadas.  Callback_ url aparece aqu√≠, en el que la clave de problema y el nombre de host est√°n protegidos.  Cuando Ansible ejecuta esta solicitud POST, el bot se da cuenta de que vino como parte de dicho incidente. <br><br>  Y aqu√≠ hay un ejemplo de un libro de jugadas, en el que mostramos un disco de un dispositivo MD: <br><br><pre> <code class="plaintext hljs"> # Save mdadm configuration - include: common/callback.yml vars: callback_post_body: status: 'Ready to change' msg: "Removed disk from mdraid {{ mdadm_remove_disk.msg | comment_jira }}" data: mdadm_data: "{{ mdadm_remove_disk.removed }}" parted_info: "{{ parted_info | default() }}" when: - mdadm_remove_disk | changed - mdadm_remove_disk.removed</code> </pre><br>  Esta tarea coloca el ticket Jira en el estado "Listo para cambiar" y agrega un comentario.  Adem√°s, la variable mdam_data almacena la lista de dispositivos md de los que se elimin√≥ el disco, y el volcado dividido de parted en parted_info. <br><br>  Cuando el ingeniero inserta un nuevo disco, podremos utilizar estas variables para restaurar el volcado de la partici√≥n, as√≠ como insertar el disco en los dispositivos md de los que se elimin√≥. <br><br><h3>  Modo de verificaci√≥n ansible </h3><br>  Encender la automatizaci√≥n daba miedo.  Por lo tanto, decidimos ejecutar todos los libros de jugadas en modo <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejecuci√≥n</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">seco</a> , en la que Ansible no realiza ninguna acci√≥n en los servidores, sino que solo los emula. <br><br>  Tal lanzamiento se ejecuta a trav√©s de un m√≥dulo de devoluci√≥n de llamada separado, y el resultado del libro de jugadas se guarda en Jira como un comentario. <br><br><img src="https://habrastorage.org/webt/aa/rz/0s/aarz0srsrqqxbru88guob9spjqm.png"><br><br>  En primer lugar, permiti√≥ validar el trabajo del bot y los libros de jugadas.  En segundo lugar, aument√≥ la confianza de los administradores en el bot. <br><br>  Cuando realizamos la validaci√≥n y nos dimos cuenta de que puede ejecutar Ansible no solo en modo de ejecuci√≥n en seco, creamos el bot√≥n Ejecutar Diskobot en Jira para iniciar el mismo libro de jugadas con las mismas variables en el mismo host, pero en modo normal. <br><br>  Adem√°s, el bot√≥n se usa para reiniciar el libro de jugadas en caso de falla. <br><br><h3>  Estructura de Playbooks </h3><br>  Ya mencion√© que, dependiendo del estado del boleto de Jira, el bot lanza diferentes libros de jugadas. <br><br>  En primer lugar, es mucho m√°s f√°cil organizar la entrada. <br>  En segundo lugar, en algunos casos es simplemente necesario. <br><br>  Por ejemplo, cuando reemplace un disco del sistema, primero debe ir al sistema de implementaci√≥n, crear una tarea y, despu√©s de la implementaci√≥n correcta, se podr√° acceder al servidor a trav√©s de ssh, y puede colocar la aplicaci√≥n en √©l.  Si hici√©ramos todo esto en un libro de jugadas, Ansible no podr√≠a ejecutarlo debido a la inaccesibilidad del host. <br><br>  Utilizamos roles Ansible para cada grupo de servidores.  Aqu√≠ puede ver c√≥mo se organizan los libros de jugadas en uno de ellos. <br><br><img src="https://habrastorage.org/webt/ef/0o/hu/ef0ohuo0obwa1htij7o4at6dvus.png"><br><br>  Esto es conveniente, porque est√° claro de inmediato d√≥nde se ubican las tareas.  En main.yml, que es la entrada para el rol Ansible, podemos incluir por estado del ticket o tareas generales necesarias para todos, por ejemplo, pasar la identificaci√≥n o recibir un token. <br><br><h4>  Investigation.yml </h4><br>  Corre por entradas en el estado de Investigaci√≥n y Abierto.  Lo m√°s importante para este libro de jugadas es el nombre del dispositivo de bloque.  Esta informaci√≥n no siempre est√° disponible. <br><br>  Para obtenerlo, analizamos el resumen de Jira, el √∫ltimo valor del activador de Zabbix.  Puede contener el nombre del dispositivo de bloqueo, por suerte.  O puede contener un punto de montaje, entonces debe ir al servidor, analizar y calcular la unidad deseada.  Adem√°s, un disparador puede transmitir una direcci√≥n scsi o alguna otra informaci√≥n.  Pero tambi√©n sucede que no hay pistas, y hay que analizar. <br><br>  Despu√©s de descubrir el nombre del dispositivo de bloque, recopilamos informaci√≥n sobre el tipo y el tama√±o del disco para completar los campos en Jira.  Tambi√©n eliminamos informaci√≥n sobre el proveedor, modelo, firmware, ID, SMART e insertamos todo esto en un comentario en el ticket de Jira.  El administrador y el ingeniero ya no necesitan buscar estos datos.  :) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m6/64/kr/m664krcgyi4vkc-rq0almmqv6uy.png"></div><br><br><h4>  prepare2change.yml </h4><br>  La salida del disco de rotaci√≥n, preparaci√≥n para el reemplazo.  La etapa m√°s dif√≠cil y crucial.  Aqu√≠ es donde puede detener la aplicaci√≥n cuando no se puede detener.  O extraiga un disco que no ten√≠a suficientes r√©plicas y, por lo tanto, tiene un efecto en los usuarios, pierde algunos datos.  Aqu√≠ tenemos la mayor√≠a de los controles y notificaciones en el chat. <br><br>  En el caso m√°s simple, estamos hablando de quitar una unidad de RAID HW / MD. <br><br>  En situaciones m√°s complejas (en nuestros sistemas de almacenamiento), cuando la copia de seguridad se realiza a nivel de aplicaci√≥n, debe ir a la aplicaci√≥n utilizando la API, informar la salida del disco, desactivarla e iniciar la recuperaci√≥n. <br><br>  Ahora estamos migrando masivamente a la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nube</a> , y si el servidor est√° nublado, entonces Diskobot accede a la API de la nube, dice que funcionar√° con este minion, el servidor en el que se ejecutan los contenedores, y pregunta "migrar todos los contenedores de este minion".  Y al mismo tiempo enciende la luz de fondo para que el ingeniero vea de inmediato cu√°l sacar. <br><br><h4>  cambian.yml </h4><br>  Despu√©s de reemplazar un disco, primero verificamos su disponibilidad. <br><br>  Los ingenieros no siempre colocan discos nuevos, por lo que agregamos una verificaci√≥n de los valores SMART que nos satisfacen. <br><br><div class="spoiler">  <b class="spoiler_title">¬øQu√© atributos estamos viendo?</b> <div class="spoiler_text">  Recuento de sectores reasignados (5) &lt;100 <br>  Recuento actual del sector pendiente (107) == 0 <br></div></div><br>  Si la unidad falla la prueba, el ingeniero es notificado de un reemplazo.  Si todo est√° en orden, la luz de fondo se apaga, se aplica el marcado y el disco se inserta en rotaci√≥n. <br><br><h4>  ready.yml </h4><br>  El caso m√°s simple: verificar la sincronizaci√≥n de banda HW / SW o finalizar la sincronizaci√≥n de datos en la aplicaci√≥n. <br><br><h3>  API de aplicaci√≥n </h3><br>  Mencion√© varias veces que el bot a menudo accede a las API de la aplicaci√≥n.  Por supuesto, no todas las aplicaciones ten√≠an los m√©todos necesarios, as√≠ que tuve que refinarlas.  Estos son los m√©todos m√°s importantes que utilizamos: <br><ul><li>  Estado  El estado de un cl√∫ster o disco para comprender si es posible trabajar con √©l; <br></li><li>  Iniciar / detener  Activaci√≥n-desactivaci√≥n del disco; <br></li><li>  Migrar / restaurar.  Migraci√≥n y recuperaci√≥n de datos durante y despu√©s del reemplazo. <br></li></ul><br><h3>  Lecciones aprendidas por Ansible </h3><br>  Realmente amo a Ansible.  Pero a menudo, cuando miro diferentes proyectos de c√≥digo abierto y veo c√≥mo la gente escribe libros de jugadas, me asusto un poco.  Tejido l√≥gico complejo de when / loop, falta de flexibilidad e idempotencia debido al uso frecuente de shell / command. <br><br>  Decidimos simplificar todo lo m√°s posible, aprovechando Ansible: modularidad.  En el nivel m√°s alto est√°n los libros de jugadas, pueden ser escritos por cualquier administrador, un desarrollador externo que conozca un poco a Ansible. <br><br><pre> <code class="plaintext hljs">- name: Blink disk become: True register: locate_action disk_locate: locate: '{{ locate }}' devname: '{{ devname }}' ids: '{{ locate_ids | default(pd_id) | default(omit) }}'</code> </pre><br><br>  Si alguna l√≥gica es dif√≠cil de implementar en libros de jugadas, la colocamos en un m√≥dulo o filtro Ansible.  Las secuencias de comandos se pueden escribir tanto en Python como en cualquier otro idioma. <br><br>  Son f√°ciles y r√°pidos de escribir.  Por ejemplo, el m√≥dulo de resaltado de disco, un ejemplo del uso que se da arriba, consta de 265 l√≠neas. <br><br><img width="400" height="400" src="https://habrastorage.org/webt/c4/ma/bp/c4mabpsyezbjbfp2likixvta24k.png"><br><br>  En el nivel m√°s bajo est√° la biblioteca.  Para este proyecto, escribimos una aplicaci√≥n separada, una especie de abstracci√≥n sobre los RAID de hardware y software que realizan las solicitudes correspondientes. <br><br><img width="400" height="400" src="https://habrastorage.org/webt/qf/vt/pr/qfvtprdi9jw2vxserynmxbrmdg8.png"><br><br>  Las mayores fortalezas de Ansible son su simplicidad y sus comprensibles libros de jugadas.  Creo que debe usar esto y no generar archivos yaml de miedo y una gran cantidad de condiciones, c√≥digo de shell y bucles. <br><br>  Si desea repetir nuestra experiencia con la API de Ansible, tenga en cuenta dos cosas: <br><br><ul><li>  Playbook_executor y, en general, el libro de jugadas no se puede agotar.  Hay un tiempo de espera en la sesi√≥n ssh, pero no hay tiempo de espera en el libro de jugadas.  Si tratamos de desmontar una unidad que a√∫n no existe en el sistema, el libro de jugadas se ejecutar√° indefinidamente, por lo que tuvimos que envolverlo en un contenedor separado y matarlo por tiempo de espera. <br></li><li>  Ansible est√° bifurcado, por lo que su API no es segura para subprocesos.  Lanzamos todos nuestros libros de jugadas y de un solo hilo. <br></li></ul><br>  Como resultado, pudimos automatizar el reemplazo de aproximadamente el 80% de las unidades.  En general, la tasa de reemplazo se ha duplicado.  Hoy, el administrador solo mira el incidente y decide si cambia el disco o no, y luego hace un clic. <br><br>  Pero ahora estamos comenzando a enfrentar otro problema: algunos administradores nuevos no saben c√≥mo cambiar las unidades.  :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452110/">https://habr.com/ru/post/452110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452094/index.html">.NET: Herramientas para trabajar con subprocesos m√∫ltiples y asincron√≠a. Parte 1</a></li>
<li><a href="../452098/index.html">Registros del desarrollador front-end Habr: refactor y reflex</a></li>
<li><a href="../452102/index.html">Juego de fotos para quienes gustan de los drones: brevemente sobre AirSelfie 2</a></li>
<li><a href="../452106/index.html">Invitamos a los oradores a la reuni√≥n de verano de bricolaje el 16 de junio de 2019</a></li>
<li><a href="../452108/index.html">Docker: consejos inofensivos</a></li>
<li><a href="../452112/index.html">CRM ++</a></li>
<li><a href="../452114/index.html">HolyJS 2019: Informe de SEMrush (Parte 1)</a></li>
<li><a href="../452116/index.html">√çndices en PostgreSQL - 8 (RUM)</a></li>
<li><a href="../452118/index.html">Cient√≠fico rompe el c√≥digo del misterioso manuscrito de Voynich</a></li>
<li><a href="../452122/index.html">"P√≠ldora del demonio" en movimiento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>