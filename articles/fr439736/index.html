<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úã ü•© üëåüèæ Connexion VPN IPSec entre MikroTik et Kerio Control #‚É£ üóìÔ∏è üîê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Param√®tres initiaux: 



1. Si√®ge social de l'entreprise avec deux proxys frontaliers Kerio Control v.9.2.9 build 3171 (derri√®re Kerio se trouve un co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Connexion VPN IPSec entre MikroTik et Kerio Control</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439736/"><img src="https://habrastorage.org/webt/zg/b9/cd/zgb9cd1ivkh83waulyxllysswwe.png"><br><br>  Param√®tres initiaux: <br><br><ol><li>  Si√®ge social de l'entreprise avec deux proxys frontaliers Kerio Control v.9.2.9 build 3171 (derri√®re Kerio se trouve un commutateur Cisco 3550 qui d√©termine la configuration du r√©seau local du bureau). </li><li>  Chaque Kerio a deux canaux avec √©quilibrage de charge jusqu'√† ISP (dans le diagramme - ISP # 1 et ISP # 2) avec des adresses IP blanches statiques. </li><li>  Du c√¥t√© du bureau distant, MikroTik 951G-2HnD (OS v.6.43.11) a √©t√© install√©. </li><li>  Deux FAI viennent √† MikroTik (dans le diagramme sont FAI # 3 et FAI # 4). </li></ol><br>  Au moment de la r√©daction du pr√©sent rapport, tant au si√®ge social que dans le bureau distant, la connexion avec les prestataires √©tait √† paire torsad√©e. <br><br><h3>  La liste des t√¢ches: </h3><br><ol><li>  √âtablissez une connexion VPN IPSec entre MikroTik et Kerio Control, o√π MikroTik sera l'initiateur. </li><li> Assurez la tol√©rance aux pannes de la connexion VPN, c.-√†-d.  en plus du fait que MikroTik doit surveiller les performances de ses FAI (article <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a></b> ), il doit √©galement surveiller la disponibilit√© de chaque serveur Kerio et d√©terminer l'acc√®s par quel canal (par quel FAI de Kerio) la connexion sera √©tablie. </li><li>  Permet de modifier l'adresse r√©seau avec laquelle MikroTik se connecte √† Kerio.  Cela est d√ª au fait que Kerio, et non un routeur, se trouve au si√®ge ¬´fronti√®re¬ª. </li></ol><a name="habracut"></a><br><br><h3>  Qu'obtenons-nous √† la sortie? </h3><br><ol><li>  Lorsque MikroTik d√©marre (ScheduleStartup), un canal vers le r√©seau d'entreprise sera cr√©√© (le canal sera lanc√© par MikroTik), ce qui permet √† un utilisateur distant de travailler avec les ressources de l'entreprise sans d√©marrer Kerio Client et sans configurer de connexion VPN suppl√©mentaire √† l'aide du syst√®me d'exploitation; </li><li>  MikroTik impl√©mentera le basculement, qui bascule automatiquement vers un FAI en direct; </li><li>  Vous pouvez d√©finir des priorit√©s pour les points de connexion au r√©seau d'entreprise en modifiant l'affiliation des homologues configur√©s pour se connecter √† Kerio Control √† l'un ou l'autre groupe de mod√®les de strat√©gie dans MikroTik; </li><li>  MikroTik pourra surveiller automatiquement les performances des serveurs Kerio Control et, si la connexion avec le point prioritaire est rompue, basculez sur le canal en direct de mani√®re ind√©pendante; </li><li>  Si vos serveurs Kerio Control sont publi√©s sur des serveurs DNS externes, MikroTik pourra suivre les modifications de leurs adresses IP (par exemple, si votre fournisseur change) et apporter des modifications √† sa configuration (scriptSetIPSecSADstAddrFromDNS). </li></ol><br><br>  Je dirai tout de suite que cet article n'est pas un tutoriel (en principe, je me suis familiaris√© avec les routeurs et en particulier avec MikroTik seulement deux mois (fin 2017) avant la cr√©ation de la configuration) et il ne r√©pond pas aux questions ¬´pourquoi?¬ª, Il sera ici La description de la configuration de travail de MikroTik, qui est utilis√©e dans une entreprise r√©elle, est donn√©e. <br><br>  <b>Remarque:</b> <br><ol><li>  Pour conserver les commentaires en russe lors du transfert du code de script vers MikroTik, avant de copier du texte dans le tampon et avant de coller √† partir du tampon, assurez-vous que la disposition du clavier russe est activ√©e; </li><li>  Si vous trouvez que les scripts de journalisation sont superflus, vous pouvez commenter ou supprimer des lignes avec ¬´avertissement de journal¬ª et ¬´erreur de journal¬ª; </li><li>  Vous pouvez √©galement remarquer comment√© ¬´avertissement de journal¬ª et ¬´erreur de journal¬ª dans le code, c'est une tentative d'ajouter la possibilit√© d'utiliser la journalisation en anglais ... </li></ol><br><br>  Commen√ßons donc: <br><br>  <b>Param√®tres de base:</b> <br><br><ol><li>  Le r√©seau de l'organisation m√®re (derri√®re Kerio) est 192.168.77.0/24 (ici, nous utilisons l'adresse du r√©seau o√π Kerio est situ√© dans le r√©seau d'entreprise) </li><li>  R√©seau d'agences (derri√®re MikroTik) - 192.168.11.0/24 </li><li>  Le r√©seau auquel le r√©seau de succursales mappera lors de la connexion √† Kerio Control # 1 - 192.168.22.0/24 </li><li>  Le r√©seau auquel le r√©seau de succursales mappera lors de la connexion √† Kerio Control # 2 - 192.168.33.0/24 </li><li>  Adresse IP du pool ISP # 1 (Kerio # 1) - 11.11.11.111 </li><li>  Adresse IP du pool ISP # 2 (Kerio # 1) - 22.22.22.111 </li><li>  Adresse IP du pool ISP # 1 (Kerio # 2) - 11.11.11.222 </li><li>  L'adresse IP du pool ISP # 2 (Kerio # 2) est 22.22.22.222 </li><li>  Adresse IP du pool ISP # 3 (MikroTik) - 33.33.33.111 </li><li>  Adresse IP du pool ISP # 4 (MikroTik) - 44.44.44.111 </li></ol><br>  La premi√®re chose √† faire est d'activer le DDNS sur MikroTik: <br><br><pre><code class="plaintext hljs">/ip cloud set ddns-enabled=yes</code> </pre> <br>  √âtant donn√© que MikroTik n'aura pas d'adresse IP blanche statique, les travaux de configuration et de script ult√©rieurs sont bas√©s sur l'utilisation de DDNS. <br><br>  IP ---&gt; Cloud est √©galement utilis√© pour d√©terminer l'adresse IP externe de MikroTik, √† partir de laquelle il regarde sur Internet. <br><br>  Maintenant, configurons Kerio Control # 1, pour que plus tard nous n'y revenions pas: <br>  Nous allons dans la section ¬´Interfaces¬ª et ajoutons la nouvelle interface ¬´tunnel VPN¬ª ... <br><br><div class="spoiler">  <b class="spoiler_title">Configuration du tunnel dans Kerio Control</b> <div class="spoiler_text">  1. Dans le champ du nom, attribuez un nom √† l'interface; <br>  2. Mettez l'interrupteur en position "Passif - accepte uniquement les connexions entrantes"; <br>  3. Tapez cong√© "IPSec"; <br>  4. L'onglet "Authentification": <br><br><ul><li>  4.1 Dans le champ "Cl√© pr√©d√©finie:" entrez la phrase cl√© qui sera utilis√©e pour se connecter; </li><li>  <b>Remarque:</b> <br><br>  Je recommande cat√©goriquement de d√©finir toutes les phrases cl√©s sur tous les tunnels VPN cr√©√©s sur un serveur Kerio sp√©cifique! <br><br>  Cela est d√ª au fait que Kerio a un bug flottant, qui est exprim√© dans ce qui suit. <br><br>  Imaginez que dans la configuration Kerio, comme dans mon cas, il existe plusieurs interfaces ¬´tunnel VPN¬ª configur√©es pour se connecter √† MikroTik, qui ne diff√®rent les unes des autres que dans les param√®tres du champ ¬´Local ID:¬ª (sera discut√© ci-dessous). <br><br>  Ainsi, lors de la cr√©ation (je l'appellerai ainsi) d'un tunnel entrant, quelle que soit l'adresse IP externe que Kerio contactera MikroTik, Kerio (pour une raison quelconque) activera la premi√®re interface qui appara√Ætra, et si l'adresse IP sp√©cifi√©e dans les param√®tres le tunnel du c√¥t√© de Kerio est diff√©rent de celui auquel MikroTik fait r√©f√©rence, le tunnel n'est pas organis√©. <br><br>  Et dans le cas o√π diff√©rentes phrases cl√©s sont indiqu√©es pour tous les tunnels, ce probl√®me s'arr√™te. </li><li>  4.2 Dans le champ "Local ID:", entrez l'adresse IP du pool d'adresses ISP # 1 (dans l'exemple 11.11.11.111) affect√©e √† l'interface WAN Kerio Control # 1, √† laquelle MikroTik aura acc√®s; </li><li>  4.3 Dans le champ ¬´Remote ID:¬ª, entrez le FQDN, qui a √©t√© obtenu par notre MikroTik √† partir du DDNS (IP ---&gt; Cloud ---&gt; DNS Name).  Ce param√®tre nous permet de ne pas se soucier de la fa√ßon dont le FAI MikroTik acc√®de √† Kerio; </li><li>  4.4 Dans le champ "Chiffre de phase 1 (IKE):" s√©lectionnez aes128-sha1-modp2048 dans la liste; </li><li>  4.5 Dans le champ "Chiffre Phase 2 (ESP):" s√©lectionnez 3des-sha1-modp2048 dans la liste; </li><li>  <b>Remarque:</b> <br>  Modification des param√®tres par d√©faut utilis√©s via le bouton "Modifier ..."; <br>  Les deux chiffres sont s√©lectionn√©s en utilisant la ¬´m√©thode scientifique de piquer¬ª. </li></ul><br>  5. L'onglet "R√©seaux distants": <br><br>  Ici, nous entrons l'adresse IP du r√©seau local que MikroTik utilisera lors de la connexion √† ce serveur Kerio Control sp√©cifique (dans l'exemple - 192.168.22.0/24). <br>  Important!  Dans tous les autres (dans mon cas, c'est d√©termin√© par le nombre de FAI de Kerio) tunnels sur MikroTik, sur ce serveur Kerio, la m√™me adresse IP doit √™tre indiqu√©e! <br><br>  Permettez-moi de vous rappeler que cela est d√ª √† la n√©cessit√© de configurer l'itin√©raire vers ce r√©seau √† partir du r√©seau du si√®ge social. <br><br>  6. L'onglet "R√©seaux locaux": <br><br><ul><li>  6.1 D√©cochez la case ¬´Utiliser les r√©seaux locaux d√©tect√©s automatiquement¬ª; </li><li>  6.2 Cochez la case ¬´Utiliser des r√©seaux personnalis√©s:¬ª et ajoutez √† la liste des r√©seaux l'adresse r√©seau ¬´couvrant¬ª toute la plage d'adresses utilis√©e dans le r√©seau local derri√®re Kerio Control (dans l'exemple - 192.168.0.0/16). </li></ul><br>  Nous r√©p√©tons toutes les √©tapes ci-dessus pour le deuxi√®me tunnel sur le m√™me serveur Kerio. <br><br>  Le deuxi√®me param√®tre de tunnel ne diff√©rera qu'en utilisant une phrase de passe diff√©rente (clause 4.1) et une adresse IP externe diff√©rente, du pool d'adresses ISP # 2 (clause 4.2) (dans l'exemple, 22.22.22.111). <br><br>  Les param√®tres Kerio Control # 2 sont identiques √† ceux d√©crits ci-dessus, √† l'exception de l'adresse r√©seau indiqu√©e dans l'onglet R√©seaux distants (p. 5) (dans l'exemple, 192.168.33.0/24) et, par cons√©quent, des adresses IP dans le champ ID local: ( Section 4.2), qui doit √™tre s√©lectionn√©e parmi les adresses IP attribu√©es aux interfaces WAN Kerio Control # 2 (dans l'exemple, 11.11.11.222 et 22.22.22.222). <br></div></div><br>  Ensuite, nous cr√©ons une r√®gle d'autorisation pour envoyer un ping √† notre Kerio depuis MikroTik ... <br><br><div class="spoiler">  <b class="spoiler_title">R√®gle Ping dans Kerio Control</b> <div class="spoiler_text">  Nous allons dans la section ¬´R√®gles de circulation¬ª et cr√©ons une nouvelle r√®gle avec les param√®tres suivants: <br><br><ul><li>  source - indiquez le FQDN qui a √©t√© re√ßu par notre MikroTik du DDNS; </li><li>  Destination - Pare-feu </li><li>  service - Ping; </li><li>  Vous pouvez √©galement sp√©cifier la version IP (IPv4), mais ce n'est pas n√©cessaire. </li></ul><br>  Nous enregistrons la r√®gle avec un nom qui vous est compr√©hensible et la faisons glisser tout en haut de la liste des r√®gles. <br><br>  Nous r√©p√©tons la m√™me proc√©dure sur le deuxi√®me serveur Kerio. <br></div></div><br>  N'oubliez pas d'enregistrer les routes sur le r√©seau derri√®re MikroTik dans des commutateurs ou des routeurs sur le c√¥t√© du si√®ge social afin que le r√©seau du si√®ge social sache o√π diriger le trafic (dans mon cas, ce sont deux routes statiques sur les r√©seaux 192.168.22.0/24 et 192.168.33.0/24). <br><br>  Du si√®ge social, nous avons tout fait, maintenant nous passons √† MikroTik. <br><br>  Commen√ßons par cr√©er les objets de configuration de base pour organiser et tester le tunnel VPN. <br><br>  La premi√®re √©tape consiste √† cr√©er une liste d'adresses de sous-r√©seau local.  Nous l'utiliserons dans les r√®gles du pare-feu. <br><br><pre> <code class="plaintext hljs">/ip firewall address-list #      MikroTik, # IP-      DHCP add address=192.168.11.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #1 # (     VPN-  Kerio Control #1, #   " ") add address=192.168.22.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #2 # (     VPN-  Kerio Control #2, #   " ") add address=192.168.33.0/24 list="Local subnet"</code> </pre> <br>  Ensuite, cr√©ez une r√®gle d'autorisation pour le trafic IKE et placez-la tout en haut de la liste des r√®gles. <br><br><pre> <code class="plaintext hljs">add action=accept chain=input comment="VPN Allow IKE" dst-port=500 protocol=udp</code> </pre> <br>  Ajoutez ensuite deux r√®gles au filtre de pare-feu pour travailler avec le trafic VPN ... <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=accept chain=forward comment="VPN In IpSec" dst-address-list=\ "Local subnet" ipsec-policy=in,ipsec src-address=192.168.0.0/16 \ src-address-list="!Local subnet" add action=accept chain=forward comment="VPN Out" dst-address=192.168.0.0/16 \ dst-address-list="!Local subnet" src-address-list="Local subnet"</code> </pre> <br>  ... et d√©placez-les √† une position imm√©diatement <b>au-dessus de la r√®gle de suppression</b> , ce qui interdit le trafic entrant de l'ext√©rieur du LAN.  Dans ma configuration par d√©faut, c'√©tait avec le commentaire "defconf: drop all ne venant pas du LAN" <br><br>  Acc√©dez √† Firewall Mangle et cr√©ez les r√®gles suivantes: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle #      , #  ... add action=mark-connection chain=prerouting comment="VPN In" \ new-connection-mark=VPN_conn_in passthrough=no src-address=192.168.0.0/16 \ src-address-list="!Local subnet" # ...   add action=mark-routing chain=output comment="VPN In" connection-mark=\ VPN_conn_in new-routing-mark=VPN_route_in passthrough=yes #     MikroTik      . #     NAT. add action=mark-connection chain=postrouting comment="VPN Out" dst-address=\ 192.168.0.0/16 dst-address-list="!Local subnet" new-connection-mark=\ VPN_conn_out passthrough=no</code> </pre> <br>  Ensuite, nous notons dans Firewall NAT: <br><br><pre> <code class="plaintext hljs">/ip firewall nat #     MikroTik     #      , #    Kerio- (:  Kerio Control #1 - 192.168.22.0/24,  Kerio Control #2 - 192.168.33.0/24) # ! # comment=KerioVpnNatOut   ! add action=netmap chain=srcnat comment=KerioVpnNatOut connection-mark=\ VPN_conn_out to-addresses=192.168.22.0/24 #     MikroTik     #          MikroTik add action=netmap chain=dstnat comment=KerioVpnNatIn connection-mark=\ VPN_conn_in to-addresses=192.168.11.0/24 #  MikroTik  Kerio- add action=accept chain=srcnat comment=KerioVpnNatPing out-interface-list=WAN protocol=icmp</code> </pre> <br>  <b>Important!</b>  Ces r√®gles doivent √™tre plac√©es au-dessus des r√®gles de masquage. <br><br>  Maintenant, nous allons √† la section IP ---&gt; IPSec, o√π nous devons cr√©er une politique, un homologue, des groupes de mod√®les de politique (je discuterai de leur objectif plus tard) et une proposition pour la configuration du chiffrement de phase 2. <br><br><div class="spoiler">  <b class="spoiler_title">proposition ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des name=KerioVPNProposal#01 pfs-group=modp2048</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">groupe de strat√©gies ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy group add name=1 add name=2 add name=3 add name=4</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ip ipsec peer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec peer add address=11.11.11.111/32 comment=vs01-i01-01.domain.ru exchange-mode=\ main-l2tp local-address=33.33.33.111 my-id=\ fqdn:mikrotik.sn.mynetname.net policy-template-group=1 profile=\ profile_4 secret=pass1111</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">politique ip ipsec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy add comment=KerioVPNPolicy dst-address=192.168.77.0/24 proposal=KerioVPNProposal#01 \ sa-dst-address=11.11.11.111 sa-src-address=33.33.33.111 src-address=\ 192.168.22.0/24 tunnel=yes</code> </pre> <br></div></div><br>  Commentaire: <br><br>  1. / ip ipsec proposition - entrez les m√™mes param√®tres de cryptage que nous avons sp√©cifi√©s lors de la configuration de Kerio Control dans le champ "Phase 2 Encryption (ESP):". <br><br>  <b>Remarque:</b> <br><br>  Faites attention au param√®tre "nom = KerioVPNProposal # 01". <br><br>  Il n'est pas n√©cessaire d'utiliser ce nom sp√©cifiquement, mais si vous d√©cidez d'en utiliser un autre, apr√®s l'avoir chang√©, vous devez v√©rifier et, si n√©cessaire, modifier le param√®tre de la strat√©gie IPSec associ√©e, et √©galement modifier la valeur affect√©e de la variable DefKerioPropName dans le script scriptCheckActiveVpnServer, qui sera discut√© discours plus loin. <br><br>  (En fait, la plupart des noms et commentaires des objets dans la configuration d√©crite sont utilis√©s dans les scripts, donc les renommer peut vous causer des inconv√©nients en raison de la n√©cessit√© d'apporter des modifications au code du script. J'essaierai de prendre les notes appropri√©es dans le texte pour faciliter la recherche de ces objets.) <br><br>  2. / groupe de strat√©gies ip ipsec <br><br>  La cr√©ation de groupes est due au fait qu'√† l'avenir, nous traiterons leurs noms (1, 2, ... n) dans des scripts et les utiliserons pour hi√©rarchiser les adresses IP des serveurs Kerio auxquels nous acc√©derons. <br><br>  Je cr√©e quatre groupes √† la fois parce que  J'ai deux FAI, avec deux IP externes sur chacun de Kerio.  √Ä ce stade, nous utilisons jusqu'√† pr√©sent un seul groupe. <br><br>  3. / ip ipsec peer <br><br>  En pair, sp√©cifiez: <br><br><ul><li>  Adresse - Adresse IP de Kerio, qui sera contact√©e avec MikroTik.  La m√™me adresse que nous avons entr√©e dans / ip ipsec policy sa-dst-address doit √™tre sp√©cifi√©e, uniquement avec le masque "/ 32"; </li><li>  Adresse locale - Adresse IP de MikroTik, √† partir de laquelle Kerio sera accessible.  La m√™me adresse que nous avons entr√©e dans / ip ipsec policy sa-src-address doit √™tre sp√©cifi√©e; </li><li>  Auth.  M√©thode - s√©lectionnez ¬´cl√© pr√©-partag√©e¬ª dans la liste; </li><li>  Mode Exchange - s√©lectionnez main-l2tp dans la liste; </li><li>  Si elle est d√©finie, d√©cochez la case ¬´Passif¬ª; </li><li>  Secret - entrez la phrase secr√®te que nous avons saisie lors de la configuration de l'interface VPN sur Kerio, dans l'onglet "Authentification", dans le champ "Cl√© pr√©d√©finie:"; </li><li>  Groupe de mod√®les de strat√©gie - s√©lectionnez dans la liste le groupe que nous avons cr√©√© pr√©c√©demment avec le nom ¬´1¬ª; </li><li>  D√©cochez NAT Traversal; </li><li>  My ID Type - s√©lectionnez la valeur ¬´fqdn¬ª dans la liste; </li><li>  Mon ID - entrez le FQDN attribu√© par MikroTik dans DDNS; </li><li>  Sur l'onglet ¬´Cryptage¬ª, s√©lectionnez les param√®tres de cryptage que nous avons entr√©s lors de la configuration de l'interface VPN sur Kerio, sur l'onglet ¬´Authentification¬ª, dans le champ ¬´Phase 1 (IKE) Cipher:¬ª; </li><li>  Commentaire ( <b>Attention! Utilis√© dans les scripts!</b> ). </li></ul><br>  Dans le commentaire, j'indique le FQDN technique complet de mes serveurs, qui sont publi√©s sur les serveurs DNS desservant ma zone externe. <br><br>  En plus d'utiliser cette configuration, cela me permet de garder des informations √† jour sur les adresses IP externes des serveurs Kerio utilis√©s (j'ai juste besoin de changer l'adresse IP sur le serveur DNS externe et elle sera automatiquement chang√©e en MikroTik (article <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a></b> )). <br><br>  Pour ceux qui sont trop paresseux pour comprendre, je cite le code de travail: <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptSetIPSecSADstAddrFromDNS owner=\ admin policy=read,write</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Liste des scripts scriptSetIPSecSADstAddrFromDNS</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=SetIPSecSADstAddrFromDNS]]&gt;1) do={ :error } :local DnsNameFromComment :local ResolvedIpFromComment :local ResolvedIpWithMaskFromComment :local IpPeerAddr :foreach IpSecPeerCount in=[/ip ipsec peer find] do={ :set DnsNameFromComment [/ip ipsec peer get $IpSecPeerCount comment] :if ($DnsNameFromComment!="") do={ :do { :set ResolvedIpFromComment [:resolve $DnsNameFromComment] :set ResolvedIpWithMaskFromComment ($ResolvedIpFromComment . "/32") :set IpPeerAddr [/ip ipsec peer get $IpSecPeerCount address] :if ($ResolvedIpWithMaskFromComment!=$IpPeerAddr) do={ :log warning ("[SetIPSecSADstAddrFromDNS]     " . DnsNameFromComment . "  IP-  " . $IpPeerAddr . "  " . $ResolvedIpFromComment) #:log warning ("[SetIPSecSADstAddrFromDNS] In the peer to the server " . DnsNameFromComment . " changed IP address from " . $IpPeerAddr . " on " . $ResolvedIpFromComment) /ip ipsec peer set $IpSecPeerCount address=$ResolvedIpWithMaskFromComment } } on-error={ :set ResolvedIpFromComment "unknown" :log error ("[SetIPSecSADstAddrFromDNS]     " . $DnsNameFromComment) #:log error ("[SetIPSecSADstAddrFromDNS] Cant resolve name " . $DnsNameFromComment) } } } :log warning ("[SetIPSecSADstAddrFromDNS]  IP- VPN- ") #:log warning ("[SetIPSecSADstAddrFromDNS] The IP-addresses of the VPN-servers are checked")</code> </pre><br></div></div><br>  <b>La r√®gle de base qui s'applique au commentaire entre pairs</b> est que le nom doit commencer par des lettres et / ou des chiffres, sans espaces, suivis d'un <b>trait d'union OBLIGATOIRE</b> ("-"), suivi d'un nombre quelconque de caract√®res arbitraires. <br><br>  J'utilise le format suivant: <br><br>  vsNN-pNN-NN.domain.ru <br><br>  O√π: <br><br>  vsNN - vpn-server #NN (Cette partie du commentaire est trait√©e dans des scripts et utilis√©e dans IP ---&gt; Pare-feu ---&gt; Listes d'adresses (voir ci-dessous)); <br>  pNN - FAI #NN; <br>  NN - num√©ro de s√©rie de l'adresse IP externe dans le pool d'adresses qui m'a √©t√© d√©livr√© par le fournisseur sur Kerio; <br><br>  4. / Politique ipsec ip <br><br>  En politique, nous d√©finissons: <br><br><ul><li>  Dst.  Adresse - adresse r√©seau derri√®re Kerio (adresse dst); </li><li>  Src.  Adresse - l'adresse r√©seau √† laquelle MikroTik masquera (voir les param√®tres IP ---&gt; Pare-feu ---&gt; NAT ci-dessous) son r√©seau local (adresse src).  Cette adresse r√©seau sera visible du c√¥t√© Kerio (nous l'avons sp√©cifi√©e lors de la configuration de l'interface VPN sur Kerio, dans l'onglet R√©seaux distants); </li><li>  Protocole - 255 (tous); </li><li>  Action - crypter; </li><li>  Niveau - requis; </li><li>  Protocoles IPSec - esp; </li><li>  d√©finissez le param√®tre tunnel = yes; </li><li>  SA Src.  Adresse - L'adresse IP externe de MikroTik, √† partir de laquelle Kerio sera accessible (sa-src-address); </li><li>  SA Dst.  Adresse - Adresse IP de Kerio, √† laquelle MikroTik sera contact√© (adresse sa-dst); </li><li>  Proposition - Entrez la valeur attribu√©e au param√®tre de nom dans la section de proposition / ip ipsec (dans cette configuration - KerioVPNProposal # 01); </li><li>  Commentaire ( <b>Attention! Utilis√© dans les scripts!</b> ) - KerioVPNPolicy. </li></ul><br>  Si tout est fait correctement, apr√®s avoir enregistr√© la politique, la valeur ¬´√©tablie¬ª devrait appara√Ætre dans le champ ¬´√âtat PH2¬ª, qui indique l'installation d'un canal VPN entre MikroTik et Kerio. <br>  Vous pouvez le v√©rifier en v√©rifiant l'√©tat de l'interface VPN dans Kerio Control.  L√†, dans le champ "Informations", en face de l'interface vers laquelle la connexion est √©tablie, l'inscription "La connexion √† IP_votre_MikroTik est √©tablie" doit appara√Ætre. <br><br>  Nous continuons ... <br><br>  Nous allons maintenant cr√©er des homologues pour toutes les adresses IP restantes des serveurs Kerio (dans ma configuration, je dois cr√©er trois autres homologues). <br><br>  Pour ce faire, nous devons r√©p√©ter toutes les √©tapes indiqu√©es au paragraphe 3 (/ ip ipsec peer), mais faites attention aux modifications suivantes: <br><br><ul><li>  Adresse - modifiez l'adresse IP de Kerio; </li><li>  Secret - entrez la phrase secr√®te relative √† la connexion en cours de cr√©ation (pass2222, pass3333, ... passNNNN); </li><li>  Groupe de mod√®les de strat√©gie - s√©lectionnez le groupe suivant dans la liste dans la liste (2, 3, ... n). </li></ul><br>  <b>Remarque:</b> <br><br>  Ensuite, vous pouvez modifier la priorit√© de vos serveurs √† tout moment en modifiant le groupe dans les param√®tres des homologues. <br><br><ul><li>  Commentaire - dans mon cas, il passe √† un autre nom de domaine complet du serveur Kerio. </li></ul><br>  Tous les autres param√®tres sont entr√©s de la m√™me mani√®re que lors de la premi√®re f√™te.  Ceux qui devront √™tre modifi√©s sont trait√©s par des scripts et vous pouvez les copier tels quels pour l'instant. <br><br>  La derni√®re √©tape de la configuration avant de connecter les scripts au travail consiste √† faire fonctionner MikroTik comme un r√©f√©rentiel de constantes, que nous utiliserons dans les scripts ... <br>  Ajoutez deux listes aux listes d'adresses du pare-feu ( <b>Attention! Utilis√© dans les scripts!</b> ): <br><br><pre> <code class="plaintext hljs">/ip firewall address-list add address=192.168.22.0/24 list=vs01 add address=192.168.33.0/24 list=vs02</code> </pre> <br>  nous y indiquons les adresses des r√©seaux en r√©f√©rence aux pr√©fixes de nom Kerio-server, dans lesquels nous allons cartographier le trafic VPN sortant. <br><br>  Eh bien, afin d'automatiser le travail de toute cette honte, nous ajoutons deux scripts et trois planifications <b>(si vous d√©cidez de renommer les scripts, n'oubliez pas d'apporter les modifications appropri√©es au code)</b> . <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptFunctionsList owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Liste des scripts scriptFunctionsList</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#   IP --&gt; Cloud   DNS- #  : # # $start (true/false); # #  ""  "updated" :global subUpdateCloudDns do={ put ($start); :if ($start=false) do={ set $CloudDnsStatus; #     set $m 1; log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt;  "); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; CHECK STARTED"); do { log warning ("[subUpdateCloudDns] ---&gt; DDNS ,  ---&gt; " . $m); [/ip cloud force-update]; delay 30000ms; set $CloudDnsStatus ([/ip cloud get status]); set $m ($m+1); :if ($CloudDnsStatus="updated") do={ log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } else={ log error ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log error ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } } while=(($CloudDnsStatus!="updated") and ($m&lt;10)); return ($CloudDnsStatus); } } #    IP --&gt; Cloud #   : # # 0 - ; # 1 - ,   ; # 2 -    :global subCheckCloudDDNS do={ set $CloudDnsActive ([/ip cloud get ddns-enabled]); #  - ( $m=0 ) set $m 0; :if ($CloudDnsActive=yes) do { #  IP---&gt;Cloud  ( $m=1 ) set $m ($m+1); set $CloudDnsStatus ([/ip cloud get status]); #    IP- (  IP---&gt;Cloud    DNS) set $CloudDnsIP ([/ip cloud get public-address]); set $CheckIpAddr ([resolve [/ip cloud get dns-name]]); :if ($CloudDnsIP!=$CheckIpAddr) do={ #  IP  (  MikroTik  )... set $CloudDnsStatus "updating..."; } :if ($CloudDnsStatus="updated") do { #  IP---&gt;Cloud    ( $m=2 ) set $m ($m+1); } } return ($m); } #       #  : # # $ScriptName ( ) :global subRepeatScript do={ put ($ScriptName); :if ($ScriptName!="") do { [/system script run $ScriptName]; } } #     VPN-   # #   IP- VPN-     :global subGetVpnServers do={ #    IP- VPN-        :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ set $MaskPos [find $CheckIpAddr "/"]; set $GroupFromPeer ([/ip ipsec peer get $IpSecPeerId policy-template-group]); set $IpFromPeer ([pick $CheckIpAddr 0 $MaskPos]); set $VpnServersList ($VpnServersList, {{$GroupFromPeer; $IpFromPeer}}); } } return ($VpnServersList); } #        # #    ID   :global subDisableIpSecPeers do={ # ...  ,  (passive=false) ... :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ log warning ("[IP IPSec Peer] ---&gt;    ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #log warning ("[IP IPSec Peer] ---&gt; processed peer on ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #  address   ... set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ #  address  ,  IP-  ... set $MaskPos ([find $CheckIpAddr "/"]); set $CheckIpAddr ([pick $CheckIpAddr 0 $MaskPos]); # ...   IPSec- :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$CheckIpAddr] do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId disabled]!=yes) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  " . [/ip ipsec policy get $IpSecPolicyId comment] . " "); #log warning ("[IP IPSec Policy] ---&gt; policy " . [/ip ipsec policy get $IpSecPolicyId comment] . " deactivated"); } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } } # :     ,      :if ([/ip ipsec peer get $IpSecPeerId disabled]!=yes) do={ [/ip ipsec peer disable $IpSecPeerId]; log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; "); #log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; deactivated"); } } return ($IdList); } #        #  : # # $PeerID (ID   VPN-); # $PolIdList ( ID  $subDisableIpSecPeers); # $CloudIP (IP MikroTik  DDNS); # $SrcIP (src-address    VPN-) :global subEnableIpSecPeers do={ put ($PeerID); put ($PolIdList); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($PolIdList!="")&amp;&amp;($PolIdList!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   VPN- set $ActiveVPN [/ip ipsec peer get $PeerID address]; :if ($ActiveVPN!="") do={ #  ,  IP-   set $MaskPos [find $ActiveVPN "/"]; set $ActiveVPN ([pick $ActiveVPN 0 $MaskPos]); } #   ,      :if ([/ip ipsec peer get $PeerID disabled]=yes) do={ delay 5000ms; [/ip ipsec peer enable $PeerID]; log warning ("[IP IPSec Peer] ---&gt;  peer  ---&gt; " . [/ip ipsec peer get $PeerID address]); #log warning ("[IP IPSec Peer] ---&gt; activated peer on ---&gt; " . [/ip ipsec peer get $PeerID address]); } #    ID   PolIdList, ,    Src. Address, SA Src. Address  SA Dst. Address,   :foreach IpSecPolicyId in=$PolIdList do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId src-address]!=$SrcIP) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$SrcIP]; log warning ("[IP IPSec Policy] ---&gt;  src-address"); #log warning ("[IP IPSec Policy] ---&gt; src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP) do={ [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;  sa-src-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-dst-address]!=$ActiveVPN) do={ [/ip ipsec policy set $IpSecPolicyId sa-dst-address=$ActiveVPN]; log warning ("[IP IPSec Policy] ---&gt;  sa-dst-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-dst-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId disabled]=yes) do={ delay 3000ms; [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } } } } } #      ID  #  : # # $PeerIP (IP    ); # $CloudIP (IP MikroTik  DDNS); # $action (enable/disable/skip) # #    ID,   ,  :global subGetPoliciesByPeer do={ put ($PeerIP); put ($CloudIP); put ($action); :if (($action="")||($action=nil)) do={ set $action "skip"; } :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$PeerIP] do={ :if ($IpSecPolicyId!="") do={ #     $action=disable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]!=yes)&amp;&amp;($action="disable")) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated"); } #     $CloudIP  sa-src-address!=$CloudIP ( ISP),     sa-src-address :if (($CloudIP!="")&amp;&amp;($CloudIP!=nil)&amp;&amp;([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP)) do={ [/ip ipsec policy disable $IpSecPolicyId]; [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;   ---&gt;  sa-src-address ---&gt; " . $CloudIP); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated ---&gt; new sa-src-address ---&gt; " . $CloudIP); #   ,  Kerio   delay 30000ms; } #     $action=enable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]=yes)&amp;&amp;($action="enable")) do={ [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } return ($IdList); } #   local-address  #  : # # $PeerID (ID   VPN-); # $CloudIP (IP MikroTik  DDNS) :global subCheckPeerLocalIp do={ put ($PeerID); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   DDNS-IP :if ([/ip ipsec peer get $PeerID local-address]!=$CloudIP) do={ [/ip ipsec peer set $PeerID local-address=$CloudIP]; log warning ("[IP IPSec Peer] ---&gt;  local-address"); #log warning ("[IP IPSec Peer] ---&gt; local-address changed"); } } }</code> </pre> <br></div></div><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptCheckActiveVpnServer owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liste des scripts scriptCheckActiveVpnServer</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=scriptCheckActiveVpnServer]]&gt;1) do={ :error } #      scheduleStartup #   ,       :global subCheckCloudDDNS :global subCheckPeerLocalIp :global subDisableIpSecPeers :global subEnableIpSecPeers :global subGetPoliciesByPeer :global subGetVpnServers :global subUpdateCloudDns :local CheckIP :local CheckPeer #     DDNS ( ) :local CloudDnsStatus ([:put [$subCheckCloudDDNS]]) :local Exit false :local DefMikroTikSrcNet 192.168.11.0/24 :local DefKerioDstNet 192.168.77.0/24 :local DefKerioPropName KerioVPNProposal#01 :local DefKerioPolName KerioVPNPolicy :local IpSecPolicyId :local KerioName :local KerioVpnNatRuleName KerioVpnNatOut :local m :local n 1 :local PeerCount 0 :local PeerDisabled :local PingCount 3 :local PingResult :local PoliciesList :local PublicIp :local VpnServersList #   DDNS ,  ,    IP- MikroTik :if ($CloudDnsStatus=0) do={ #  Cloud DDNS  ,         :log error ("[schedule CheckActiveVpnServer] ---&gt;    VPN-   Cloud DDNS! (IP -&gt; Cloud)") # :log error ("[schedule CheckActiveVpnServer] ---&gt; to connect to the VPN server, you need to activate Cloud DDNS! (IP -&gt; Cloud)") :error } :if ($CloudDnsStatus=1) do={ #  Cloud DDNS ,   ,   ( ) :set CloudDnsStatus [:put [$subUpdateCloudDns start=false]] :if ($CloudDnsStatus="updated") do={ :set CloudDnsStatus 2 } } :if ($CloudDnsStatus=2) do { #  Cloud DDNS    ... #  IP  DDNS :set PublicIp [/ip cloud get public-address] #   VPN-  ,    ( ) :set VpnServersList ([:put [$subGetVpnServers]]) #     :foreach VpnIpId in=$VpnServersList do={ :set PeerCount ($PeerCount+1) } #   VPN-    DDNS-IP ( ,   VPN-    ) :while (($Exit!=true)&amp;&amp;$n&lt;=$PeerCount) do={ :foreach VpnIpId in=$VpnServersList do={ #  IP- VPN-    :if (($VpnIpId-&gt;0)=$n) do={ :set CheckIP ($VpnIpId-&gt;1) :if ($CheckIP!="") do={ #    IP :set PingResult ([:put [/ping address=$CheckIP count=$PingCount src-address=$PublicIp]]) :if ($PingResult=$PingCount) do={ :log warning ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) #  IP ,     IP- :set CheckPeer (:put [/ip ipsec peer find address=($CheckIP . "/32")]) :if ($CheckPeer!="") do={ #   ,     src- (IP ---&gt; Firewall ---&gt; Address Lists),     Kerio #    Kerio    :set KerioName [/ip ipsec peer get $CheckPeer comment] #    (  ,  FQDN  Kerio   KerioName-Parameter1-...-Parameter_n :if ($KerioName!="") do={ #    :set m ([find $KerioName "-"]) #  KerioName    :set KerioName ([pick $KerioName 0 $m]) #    Firewall -&gt; Address List (       : # Name ---&gt; KerioName (eg srv1) # Address ---&gt; DefMikroTikSrcNet (eg 192.168.99.0/24)) :set m [/ip firewall address-list find list=$KerioName] :set DefMikroTikSrcNet ([/ip firewall address-list get $m address]) } # ...          Kerio :set IpSecPolicyId (:put [/ip ipsec policy find comment="$DefKerioPolName"]) #      ,       # (    )         :if ($IpSecPolicyId="") do={ [/ip ipsec policy add disabled=yes dst-address=$DefKerioDstNet proposal=$DefKerioPropName sa-dst-address=$CheckIP sa-src-address=$PublicIp src-address=$DefMikroTikSrcNet tunnel=yes comment=$DefKerioPolName place-before=0] :log warning ("[schedule CheckActiveVpnServer] ---&gt;   " . $DefKerioPolName . " ---&gt;    ") #:log warning ("[schedule CheckActiveVpnServer] ---&gt; created policy " . $DefKerioPolName . " ---&gt; default parameters used") } else={ #   ,     src-address,   . :if ($DefMikroTikSrcNet!=[/ip ipsec policy get $IpSecPolicyId src-address]) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$DefMikroTikSrcNet]; :log warning ("[schedule CheckActiveVpnServer] ---&gt;  " . $DefKerioPolName . "  ---&gt; src-address   ---&gt; " . $DefMikroTikSrcNet) #:log warning ("[schedule CheckActiveVpnServer] ---&gt; policy " . $DefKerioPolName . " changed ---&gt; src-address changed to ---&gt; " . $DefMikroTikSrcNet) } } #   :set m #  NAT-      Kerio  :set m [/ip firewall nat find comment=$KerioVpnNatRuleName] :if ($m!="") do={ #   src-address   ipsec,       Kerio  :if ([/ip firewall nat get $m to-addresses]!=$DefMikroTikSrcNet) do={ [/ip firewall nat set $m to-addresses $DefMikroTikSrcNet] :log warning ("[IP Firewall NAT] ---&gt;    ---&gt; " . $KerioVpnNatRuleName) #:log warning ("[IP Firewall NAT] ---&gt; netmap rule changed ---&gt; " . $KerioVpnNatRuleName) } } # ... local-address      IP MikroTik,    ( ) :put [$subCheckPeerLocalIp PeerID=$CheckPeer CloudIP=$PublicIp] # ...    :set PeerDisabled ([/ip ipsec peer get $CheckPeer disabled]) :if ($PeerDisabled=true) do={ #   ... #       ( ) :set PoliciesList ([:put [$subDisableIpSecPeers]]) #     VPN-   ( ) :put [$subEnableIpSecPeers PeerID=$CheckPeer PolIdList=$PoliciesList CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet] } else={ #   ... #      ,    ( ) :set PoliciesList ([:put [$subGetPoliciesByPeer PeerIP=$CheckIP CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet action="enable"]]) } :set Exit true } } else={ :log error ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) } } } } :set n ($n+1) } }</code> </pre><br></div></div><br><pre> <code class="plaintext hljs">/system scheduler add interval=1h name=scheduleCheckIPSecSADstAddrFromDNS on-event=\ "/system script run scriptSetIPSecSADstAddrFromDNS" policy=read,write \ start-date=oct/30/2017 start-time=00:10:00 add name=scheduleStartup on-event=":global StartupScript true :global RepeatRun false /system script run scriptFunctionsList" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-time=startup add interval=5m name=scheduleCheckActiveVpnServer on-event=\ "/system script run scriptCheckActiveVpnServer" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-date=nov/29/2017 start-time=00:00:00</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planifier la liste des horaires</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:global StartupScript true :global RepeatRun false /system script run scriptFunctionsList</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planification de la liste de calendrierCheckIPSecSADstAddrFromDNS</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptSetIPSecSADstAddrFromDNS</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planification de la liste ScheduleCheckActiveVpnServer</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptCheckActiveVpnServer</code> </pre><br></div></div><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La touche finale:</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour que MikroTik contacte correctement les serveurs DNS d'entreprise situ√©s derri√®re Kerio Control, vous devez ajouter des enregistrements statiques avec leurs adresses dans MikroTik, dans la section IP ---&gt; DNS ---&gt; Statique ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, quelque part comme √ßa! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'esp√®re que je n'ai jamais fait d'erreur et que je n'ai rien oubli√© ...</font></font><br><br>  Merci de votre attention! <br><br>  ps <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Historique des modifications et changements:</font></font></b> <br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ajout de la section ¬´Qu'obtenons-nous √† la sortie?:¬ª; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un commentaire a √©t√© ajout√© √† l'adresse r√©seau de la soci√©t√© m√®re; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modification des adresses IP des r√©seaux des pools ISP utilis√©s dans la description de la configuration; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ajout de l'√©l√©ment "Touche finale:"; </font></font></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439736/">https://habr.com/ru/post/fr439736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439726/index.html">Lock-in: vrai ou fiction?</a></li>
<li><a href="../fr439728/index.html">Configurer la sauvegarde et la restauration Zimbra OSE compl√®tes et s√©par√©es sans utiliser Zextras</a></li>
<li><a href="../fr439730/index.html">Organisation du r√©ducteur √† travers une classe standard</a></li>
<li><a href="../fr439732/index.html">Lazarus - animation simple utilisant le composant TImageFragment</a></li>
<li><a href="../fr439734/index.html">D√©ployer Kubernetes sur le bureau en quelques minutes avec MicroK8s</a></li>
<li><a href="../fr439738/index.html">A la recherche du bouton "Bien faire". Zyxel dans le r√©seau des petites et moyennes entreprises</a></li>
<li><a href="../fr439742/index.html">Admission au programme Master JetBrains √† l'Universit√© ITMO</a></li>
<li><a href="../fr439744/index.html">Des chercheurs du MIT ont con√ßu une ¬´rectenne¬ª qui convertit les signaux Wi-Fi en √©lectricit√©</a></li>
<li><a href="../fr439746/index.html">Comprendre les promesses JavaScript</a></li>
<li><a href="../fr439748/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 285 (du 4 au 10 f√©vrier)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>