<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåπ üßñüèº üèüÔ∏è Bagaimana kami menembak diri sendiri dan mencoba mencari tahu apa tepatnya üíè üßñüèª üåÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Posting sebelumnya di blog perusahaan tidak mengandung tim konsol tunggal, dan kami memutuskan untuk mengejar ketinggalan. 


 Perusahaan kami memilik...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana kami menembak diri sendiri dan mencoba mencari tahu apa tepatnya</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/timeweb/blog/428954/"><p>  Posting sebelumnya di blog perusahaan tidak mengandung tim konsol tunggal, dan kami memutuskan untuk mengejar ketinggalan. </p><br><p>  Perusahaan kami memiliki metrik yang dirancang untuk mencegah fakaps besar di hosting bersama.  Di setiap server hosting bersama ada situs pengujian di WordPress, yang diakses secara berkala. </p><br><p><img src="https://habrastorage.org/webt/g_/va/ot/g_vaotdagl43wnkctciq39tewes.png" alt="gambar"><br>  <em>Ini adalah bagaimana situs pengujian terlihat pada setiap server hosting bersama</em> </p><br><p><a name="habracut"></a>  Kecepatan dan keberhasilan respons situs diukur.  Setiap karyawan perusahaan dapat melihat statistik umum dan melihat seberapa baik kinerja perusahaan.  Dapat melihat persentase respons yang berhasil dari situs uji untuk keseluruhan hosting atau untuk server tertentu.  Tidak perlu menjadi karyawan perusahaan - di panel kontrol, pelanggan juga melihat statistik di server tempat akun mereka berada. </p><br><p>  Kami menyebut metrik <strong>waktu aktif</strong> ini (persentase respons yang berhasil dari situs uji untuk semua permintaan ke situs uji).  Bukan nama yang sangat bagus, mudah untuk membingungkan dengan <em>uptime-yang-total-waktu-setelah-reboot-server terakhir</em> . </p><br><p>  Musim panas berlalu, dan jadwal uptime perlahan turun. </p><br><p><img src="https://habrastorage.org/webt/h5/-h/n6/h5-hn6fmxnjepsbj8i7j1azozeu.png" alt="gambar"></p><br><p>  Administrator segera mengidentifikasi alasan - kurangnya RAM.  Mudah untuk melihat kasus OOM di log ketika server kehabisan memori dan kernel membunuh nginx. </p><br><p>  Kepala departemen, Andrey, membagi satu tugas menjadi beberapa dengan tangan seorang penyihir dan memparalelkannya dengan administrator yang berbeda.  Satu akan menganalisis pengaturan Apache - mungkin pengaturan tidak optimal dan dengan banyak lalu lintas Apache menggunakan semua memori?  Analisis lain konsumsi memori mysqld - tiba-tiba ada pengaturan yang ketinggalan zaman sejak shared hosting menggunakan Gentoo OS?  Yang ketiga melihat perubahan terbaru ke pengaturan nginx. </p><br><p>  Satu per satu, administrator kembali dengan hasil.  Masing-masing berhasil mengurangi konsumsi memori di area yang dialokasikan kepadanya.  Dalam kasus nginx, misalnya, mod_security yang disertakan tetapi tidak digunakan terdeteksi.  Sementara itu, OOM juga sering terjadi. </p><br><p>  Akhirnya, dimungkinkan untuk memperhatikan bahwa konsumsi memori inti (khususnya, SUnreclaim) sangat besar pada beberapa server.  Baik dalam output ps maupun di htop adalah parameter ini tidak terlihat, jadi kami tidak langsung menyadarinya!  Contoh server dengan infern SUnreclaim: </p><br><pre><code class="hljs perl">root@vh28.timeweb.ru:~<span class="hljs-comment"><span class="hljs-comment"># grep SU /proc/meminfo SUnreclaim: 25842956 kB</span></span></code> </pre> <br><p>  RAM 24 gigabytes diberikan ke kernel, dan kernel menghabiskannya tanpa ada yang tahu! </p><br><p>  Administrator (sebut saja dia Gabriel) bergegas ke pertempuran.  Merakit kembali kernel dengan opsi KMEMLEAK untuk deteksi kebocoran. </p><br><div class="spoiler">  <b class="spoiler_title">Opsi untuk membangun kembali</b> <div class="spoiler_text"><p>  Untuk mengaktifkan KMEMLEAK, cukup tentukan opsi yang tercantum di bawah ini dan muat kernel dengan kmemleak = pada parameter. </p><br><pre> <code class="hljs">CONFIG_HAVE_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK_DEFAULT_OFF=y CONFIG_DEBUG_KMEMLEAK_EARLY_LOG_SIZE=10000</code> </pre> </div></div><br><p>  KMEMLEAK menulis (dalam <code>/sys/kernel/debug/kmemleak</code> ) baris-baris ini: </p><br><pre> <code class="hljs powershell">unreferenced object <span class="hljs-number"><span class="hljs-number">0</span></span>xffff88013a028228 (size <span class="hljs-number"><span class="hljs-number">8</span></span>): comm <span class="hljs-string"><span class="hljs-string">"apache2"</span></span>, pid <span class="hljs-number"><span class="hljs-number">23254</span></span>, jiffies <span class="hljs-number"><span class="hljs-number">4346187846</span></span> (age <span class="hljs-number"><span class="hljs-number">1436.284</span></span>s) hex dump (first <span class="hljs-number"><span class="hljs-number">8</span></span> bytes): <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ........ backtrace: [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818570c8</span></span>&gt;] kmemleak_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x28/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811d450a</span></span>&gt;] kmem_cache_alloc_trace+<span class="hljs-number"><span class="hljs-number">0</span></span>xca/<span class="hljs-number"><span class="hljs-number">0</span></span>x1d0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8136dcc3</span></span>&gt;] apparmor_file_alloc_security+<span class="hljs-number"><span class="hljs-number">0</span></span>x23/<span class="hljs-number"><span class="hljs-number">0</span></span>x40 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81332d63</span></span>&gt;] security_file_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x33/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811f8013</span></span>&gt;] get_empty_filp+<span class="hljs-number"><span class="hljs-number">0</span></span>x93/<span class="hljs-number"><span class="hljs-number">0</span></span>x1c0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811f815b</span></span>&gt;] alloc_file+<span class="hljs-number"><span class="hljs-number">0</span></span>x1b/<span class="hljs-number"><span class="hljs-number">0</span></span>xa0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81728361</span></span>&gt;] sock_alloc_file+<span class="hljs-number"><span class="hljs-number">0</span></span>x91/<span class="hljs-number"><span class="hljs-number">0</span></span>x120 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172b52e</span></span>&gt;] SyS_socket+<span class="hljs-number"><span class="hljs-number">0</span></span>x7e/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81003854</span></span>&gt;] do_syscall_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x54/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818618ab</span></span>&gt;] return_from_SYSCALL_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x0/<span class="hljs-number"><span class="hljs-number">0</span></span>x6a [&lt;<span class="hljs-type"><span class="hljs-type">ffffffffffffffff</span></span>&gt;] <span class="hljs-number"><span class="hljs-number">0</span></span>xffffffffffffffff unreferenced object <span class="hljs-number"><span class="hljs-number">0</span></span>xffff880d67030280 (size <span class="hljs-number"><span class="hljs-number">624</span></span>): comm <span class="hljs-string"><span class="hljs-string">"hrrb"</span></span>, pid <span class="hljs-number"><span class="hljs-number">23713</span></span>, jiffies <span class="hljs-number"><span class="hljs-number">4346190262</span></span> (age <span class="hljs-number"><span class="hljs-number">1426.620</span></span>s) hex dump (first <span class="hljs-number"><span class="hljs-number">32</span></span> bytes): <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ff ff <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ................ <span class="hljs-number"><span class="hljs-number">00</span></span> e7 <span class="hljs-number"><span class="hljs-number">1</span></span>a <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> ff ff <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> ff ff ..........vn.... backtrace: [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818570c8</span></span>&gt;] kmemleak_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x28/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811d4337</span></span>&gt;] kmem_cache_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>xc7/<span class="hljs-number"><span class="hljs-number">0</span></span>x1d0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172a25d</span></span>&gt;] sock_alloc_inode+<span class="hljs-number"><span class="hljs-number">0</span></span>x1d/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8121082d</span></span>&gt;] alloc_inode+<span class="hljs-number"><span class="hljs-number">0</span></span>x1d/<span class="hljs-number"><span class="hljs-number">0</span></span>x90 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81212b01</span></span>&gt;] new_inode_pseudo+<span class="hljs-number"><span class="hljs-number">0</span></span>x11/<span class="hljs-number"><span class="hljs-number">0</span></span>x60 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172952a</span></span>&gt;] sock_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x1a/<span class="hljs-number"><span class="hljs-number">0</span></span>x80 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81729aef</span></span>&gt;] __sock_create+<span class="hljs-number"><span class="hljs-number">0</span></span>x7f/<span class="hljs-number"><span class="hljs-number">0</span></span>x220 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172b502</span></span>&gt;] SyS_socket+<span class="hljs-number"><span class="hljs-number">0</span></span>x52/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81003854</span></span>&gt;] do_syscall_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x54/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818618ab</span></span>&gt;] return_from_SYSCALL_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x0/<span class="hljs-number"><span class="hljs-number">0</span></span>x6a [&lt;<span class="hljs-type"><span class="hljs-type">ffffffffffffffff</span></span>&gt;] <span class="hljs-number"><span class="hljs-number">0</span></span>xffffffffffffffff</code> </pre> <br><p>  Gabriel tidak mengungkapkan semua rahasianya kepada kami dan tidak memberi tahu bagaimana ia dari baris di atas mengetahui penyebab pasti dari kebocoran memori.  Kemungkinan besar, ia menggunakan perintah <code>addr2line /usr/lib/debug/lib/modules/`uname -r`/vmlinux ffffffff81722361</code> untuk menemukan baris yang tepat.  Atau hanya membuka file <code>net/socket.c</code> dan melihatnya sampai file menjadi tidak nyaman. </p><br><p>  Masalahnya ternyata adalah tambalan pada file <code>net/socket.c</code> , yang telah ditambahkan ke repositori kami beberapa tahun yang lalu.  Tujuannya adalah untuk melarang klien menggunakan panggilan sistem bind (), ini adalah perlindungan sederhana terhadap server proxy yang dimulai oleh klien.  Patch memenuhi tujuannya, tetapi tidak menghapus memori setelahnya. <br>  Mungkin ada malware modis baru di PHP yang mencoba menjalankan server proxy dalam satu lingkaran - yang menyebabkan ratusan ribu panggilan bind () yang diblokir dan kehilangan RAM gigabytes. </p><br><p>  Maka itu sederhana - Gabriel memperbaiki patch dan membangun kembali kernel.  Penambahan pemantauan nilai SUnreclaim pada semua server yang menjalankan Linux.  Insinyur memperingatkan pelanggan dan memulai kembali hosting di inti baru. <br>  OOM menghilang. </p><br><h3 id="no-problema-s-dostupnostyu-saytov-ostalas">  Tetapi masalah dengan ketersediaan situs tetap </h3><br><p>  Di semua server, situs pengujian berhenti merespons beberapa kali sehari. </p><br><p>  Di sini, penulis akan mulai merobek rambut di berbagai bagian tubuh.  Tetapi Gabriel tetap tenang dan menyalakan rekaman lalu lintas ke bagian-bagian dari server hosting. </p><br><p>  Dalam dump lalu lintas, terlihat bahwa paling sering permintaan ke situs uji jatuh setelah penerimaan tiba-tiba paket <code>TCP RST</code> .  Dengan kata lain, permintaan mencapai server, tetapi koneksi akhirnya terputus oleh nginx. <br>  Lebih jauh lebih menarik!  Utilitas strace yang diluncurkan oleh Gabriel menunjukkan bahwa daemon nginx <strong>tidak</strong> mengirim paket ini.  Bagaimana ini bisa terjadi, karena hanya nginx yang mendengarkan pada port 80? <br>  Alasannya adalah kombinasi dari beberapa faktor: </p><br><ul><li>  dalam pengaturan nginx, opsi <code>reuseport</code> (termasuk <code>SO_REUSEPORT</code> soket <code>SO_REUSEPORT</code> ), yang memungkinkan berbagai proses menerima koneksi pada alamat dan port yang sama </li><li>  di (pada saat itu, versi terbaru) dari nginx 1.13.0 terdapat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bug</a> yang ketika memulai tes konfigurasi <code>nginx -t</code> melalui <code>nginx -t</code> dan menggunakan <code>SO_REUSEPORT</code> proses pengujian nginx ini benar-benar mulai mendengarkan port 80 dan mencegat permintaan dari klien nyata .  Dan pada akhir proses pengujian konfigurasi, klien menerima <code>Connection reset by peer</code> </li><li>  akhirnya, dalam memantau zabbix, pemantauan kebenaran konfigurasi nginx dikonfigurasikan pada semua server dengan nginx terinstal: perintah <code>nginx -t</code> dipanggil pada mereka sekali dalam satu menit. </li></ul><br><p>  Hanya setelah memperbarui nginx Anda dapat bernapas dengan tenang.  Grafik uptime situs telah naik. </p><br><p>  Apa moral dari keseluruhan cerita ini?  Jadilah optimis dan hindari menggunakan kernel rakitan. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id428954/">https://habr.com/ru/post/id428954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id428940/index.html">GitLab 11.4 dirilis dengan ulasan permintaan penggabungan dan fitur plug-in</a></li>
<li><a href="../id428942/index.html">Posting kedua dari belakang</a></li>
<li><a href="../id428944/index.html">Tempat Bekerja di TI, Edisi 3: Badoo</a></li>
<li><a href="../id428946/index.html">Minggu Keamanan 45: Sesuatu Tentang Kerentanan Bluetooth</a></li>
<li><a href="../id428950/index.html">Memecahkan Masalah "Short Left Shift"</a></li>
<li><a href="../id428956/index.html">Drone di ISS</a></li>
<li><a href="../id428960/index.html">Laporan Club of Rome 2018, Bab 1.5: Tantangan Iklim</a></li>
<li><a href="../id428962/index.html">Relokasi di Luxoft: bagaimana kehidupan tersisa</a></li>
<li><a href="../id428964/index.html">Kerentanan SSD Terenkripsi Perangkat Keras Memungkinkan Penyerang dengan Mudah Memotong Tindakan Pelindung</a></li>
<li><a href="../id428972/index.html">Integrasi berkelanjutan di Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>