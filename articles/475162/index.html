<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíò üßë üç• Usando X-Macro en el c√≥digo moderno de C ++ üë®üèº‚Äçüöí ‚õ∞Ô∏è ‚ú≥Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las tendencias modernas de desarrollo de C ++ sugieren el m√°ximo rechazo posible de macros en el c√≥digo. Pero a veces sin macros, y en su manifestaci√≥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando X-Macro en el c√≥digo moderno de C ++</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475162/">  Las tendencias modernas de desarrollo de C ++ sugieren el m√°ximo rechazo posible de macros en el c√≥digo.  Pero a veces sin macros, y en su manifestaci√≥n especialmente fea, uno no puede hacerlo, ya que sin ellos es a√∫n peor.  Sobre esto y la historia. <br><br>  Como sabe, el primer paso para compilar C y C ++ es el preprocesador, que reemplaza las macros y las directivas del preprocesador con texto sin formato. <br><br>  Esto nos permite hacer cosas extra√±as, por ejemplo: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// xmacro.h "look, I'm a string!" // xmacro.cpp std::string str = #include "xmacro.h" ;</span></span></code> </pre> <a name="habracut"></a><br>  Despu√©s de que el preprocesador funciona, este malentendido se convertir√° en el c√≥digo correcto: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> str = <span class="hljs-string"><span class="hljs-string">"look, I'm a string!"</span></span> ;</code> </pre> <br>  Por supuesto, este terrible encabezado no se puede incluir en ning√∫n otro lado.  Y s√≠, debido al hecho de que agregaremos este encabezado varias veces al mismo archivo, no #pragma una vez o incluiremos guardias. <br><br>  En realidad, escribamos un ejemplo m√°s complejo que haga diferentes cosas con la ayuda de macros y al mismo tiempo defienda contra #include aleatorio: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// xmacro.h #ifndef XMACRO #error "Never include me directly" #endif XMACRO(first) XMACRO(second) #undef XMACRO // xmacro.cpp enum class xenum { #define XMACRO(x) x, #include "xmacro.h" }; std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, xenum enm) { switch (enm) { #define XMACRO(x) case xenum::x: os &lt;&lt; "xenum::" #x; break; #include "xmacro.h" } return os; }</span></span></code> </pre> <br>  Esto todav√≠a es feo, pero ya aparece un cierto encanto: cuando agrega un nuevo elemento a la clase enum, se agregar√° autom√°ticamente a la declaraci√≥n de salida sobrecargada. <br><br>  Aqu√≠ puede formalizar el √°rea de aplicaci√≥n de este m√©todo: la necesidad de generar c√≥digo en diferentes lugares en funci√≥n de una fuente. <br><br>  Y ahora la triste historia de X-Macro y Windows.  Existe un sistema como Contadores de rendimiento de Windows, que le permite enviar ciertos contadores al sistema operativo para que otras aplicaciones puedan recogerlos.  Por ejemplo, Zabbix se puede configurar para recopilar y monitorear cualquier contador de rendimiento.  Esto es bastante conveniente, y no necesita reinventar la rueda con la devoluci√≥n / consulta de datos. <br><br>  Sinceramente pens√© que agregar un nuevo contador se parece a la HANDLE counter = AddCounter ("name").  Ah, qu√© equivocado estaba. <br><br>  Primero debe escribir un manifiesto XML especial ( <a href="">ejemplo</a> ), o generarlo usando el programa ecmangen.exe del SDK de Windows, pero por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">alguna raz√≥n</a> este ecmangen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se ha eliminado</a> de las nuevas versiones del SDK de Windows 10.  A continuaci√≥n, debe generar el c√≥digo y el archivo .rc utilizando la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ctrpp</a> basada en nuestro manifiesto XML.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Agregar nuevos contadores al sistema en s√≠</a> solo se realiza con la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lodctr</a> con nuestro manifiesto XML en el argumento. <br><br><div class="spoiler">  <b class="spoiler_title">¬øQue es un archivo .rc?</b> <div class="spoiler_text">  Esta es una invenci√≥n de Microsoft, no relacionada con el est√°ndar C ++.  Con estos archivos, puede incrustar recursos en exe \ dll, como cadenas \ iconos \ im√°genes, etc., y luego recogerlos utilizando la API especial de Windows. <br><br>  Los perfcounters usan estos archivos .rc para localizar los nombres de los contadores, y no est√° muy claro por qu√© estos nombres deben localizarse. <br></div></div><br>  Resumiendo lo anterior: para agregar 1 contador necesitas: <br><br><ol><li>  Cambiar manifiesto XML </li><li>  Genere nuevos archivos de proyecto .c y .rc basados ‚Äã‚Äãen manifiesto </li><li>  Escriba una nueva funci√≥n que incremente un nuevo contador </li><li>  Escribe una nueva funci√≥n que tomar√° el valor del contador </li></ol><br>  Total: 4-5 archivos modificados en diff-e en aras de un solo contador y sufriendo constantemente el trabajo con el manifiesto XML, que es la fuente de informaci√≥n en el c√≥digo plus.  Esto es lo que nos ofrece Microsoft. <br><br>  En realidad, la soluci√≥n inventada parece aterradora, pero agregar un nuevo contador se realiza exactamente 1 l√≠nea en un archivo.  Adem√°s, todo se genera autom√°ticamente usando macros y, desafortunadamente, un script precompilado, ya que el manifiesto XML todav√≠a es necesario, aunque ahora no es el principal. <br><br>  Nuestro perfcounters_ctr.h se ve casi id√©ntico al ejemplo anterior: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> NV_PERFCOUNTER #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"You cannot do this!"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> ... NV_PERFCOUNTER(copied_bytes) NV_PERFCOUNTER(copied_files) ... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> NV_PERFCOUNTER</span></span></code> </pre><br>  Como escrib√≠ anteriormente, la adici√≥n de contadores se realiza cargando el manifiesto XML utilizando lodctr.exe.  Desde nuestro programa, solo podemos inicializarlos y modificarlos. <br><br>  Los fragmentos de inicializaci√≥n que nos interesan en el abridor generado se ven as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> COPIED_BYTES 0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     0 #define COPIED_FILES 1 //      const PERF_COUNTERSET_INFO counterset_info{ ... 2, //    XML-  ... }; struct { PERF_COUNTERSET_INFO set; PERF_COUNTER_INFO counters[2]; //     } counterset { counterset_info, { //     { COPIED_BYTES, ... }, { COPIED_FILES, ... } } }</span></span></span></span></code> </pre> <br>  Total: necesitamos una correspondencia de la forma "nombre de contador - √≠ndice creciente", y en la etapa de compilaci√≥n, necesitamos saber el n√∫mero de contadores y recopilar una matriz de inicializaci√≥n de los √≠ndices de contador.  Aqu√≠ es donde la X-macro viene al rescate. <br><br>  Hacer coincidir un nombre de contador con su √≠ndice ascendente es bastante simple. <br><br>  El siguiente c√≥digo se convertir√° en una clase enum, cuyos √≠ndices internos comienzan en 0 y se incrementan en uno.  Agregando el √∫ltimo elemento con nuestras manos, inmediatamente descubrimos cu√°ntos contadores totales tenemos: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter_enum</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NV_PERFCOUNTER(ctr) ctr, #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"perfcounters_ctr.h"</span></span></span><span class="hljs-meta"> total_counters };</span></span></code> </pre> <br>  Y adem√°s, seg√∫n nuestra enumeraci√≥n, necesitamos inicializar los contadores: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> counter_count = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(counter_enum::total_counters); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PERF_COUNTERSET_INFO counterset_info{ ... counter_count, ... }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> PERF_COUNTERSET_INFO <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; PERF_COUNTER_INFO counters[counter_count]; } counterset { counterset_info, { <span class="hljs-comment"><span class="hljs-comment">//     #define NV_PERFCOUNTER(ctr) \ { static_cast&lt;int&gt;(counter_enum::ctr), ... }, #include "perfcounters_ctr.h" } }</span></span></code> </pre> <br>  El resultado fue que la inicializaci√≥n del nuevo contador ahora toma 1 l√≠nea y no requiere cambios adicionales en otros archivos (anteriormente, cada regeneraci√≥n cambiaba 3 piezas de c√≥digo solo en la inicializaci√≥n). <br><br>  Y agreguemos una API conveniente para incrementar los contadores.  Algo en el esp√≠ritu: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NV_PERFCOUNTER(ctr) \ inline void ctr##_tick(size_t diff = 1) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*   counter_enum::ctr */</span></span></span><span class="hljs-meta"> } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"perfcounters_ctr.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NV_PERFCOUNTER(ctr) \ inline size_t ctr##_get() { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*    counter_enum::ctr */</span></span></span><span class="hljs-meta"> } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"perfcounter_ctr.h"</span></span></span></span></code> </pre><br>  El preprocesador generar√° hermosos captadores / setters para nosotros, que podemos usar inmediatamente en el c√≥digo, por ejemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copied_bytes_tick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> diff = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copied_bytes_get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br>  Pero todav√≠a tenemos 2 cosas tristes: el manifiesto XML y el archivo .rc (por desgracia, es necesario). <br><br>  Lo hicimos lo suficientemente simple: un script previo a la compilaci√≥n que lee el archivo original con macros que definen contadores, analiza lo que est√° entre "NV_COUNTER (" y ")", y en base a esto genera ambos archivos que est√°n en .gitignore para que No tire basura. <br><br>  <u>Era</u> : Software especial basado en el c√≥digo de codificaci√≥n generado por manifiesto XML.  Muchos cambios en el proyecto para cada adici√≥n / eliminaci√≥n del contador. <br><br>  Ahora: el preprocesador y el script de pregeneraci√≥n generan todos los contadores, el manifiesto XML y el archivo .rc.  Exactamente una l√≠nea en diff-e para agregar / eliminar un contador.  Gracias al preprocesador que ayud√≥ a resolver este problema, mostrando en este caso particular m√°s bien que mal. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475162/">https://habr.com/ru/post/475162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475144/index.html">Divida a Laravel en componentes</a></li>
<li><a href="../475146/index.html">La agon√≠a o la larga historia de un intento de recuperaci√≥n de datos</a></li>
<li><a href="../475152/index.html">Hipocres√≠a google. PageSpeed ‚Äã‚ÄãInsights</a></li>
<li><a href="../475154/index.html">Timelapse interno con el servicio de vigilancia en la nube IPEYE</a></li>
<li><a href="../475158/index.html">Playme P570 Mono Review: breve y al grano</a></li>
<li><a href="../475164/index.html">Discusi√≥n: Internet depende del c√≥digo abierto: ¬øqu√© argumentos tienen los cr√≠ticos?</a></li>
<li><a href="../475166/index.html">Desarrollo de electr√≥nica. Auditor√≠a de proyectos en ejemplos. Salvamos los pisos c√°lidos con todo el habr</a></li>
<li><a href="../475168/index.html">Inversiones cambiarias de bajo riesgo: c√≥mo usar las cuentas y bonos del IIA como alternativa a los dep√≥sitos bancarios</a></li>
<li><a href="../475170/index.html">Problemas de los patrones b√°sicos para crear aplicaciones basadas en datos en React.JS</a></li>
<li><a href="../475172/index.html">5 maneras de usar la Raspberry Pi de manera beneficiosa Parte tres</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>