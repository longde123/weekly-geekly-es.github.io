<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äç‚öïÔ∏è ‚ÅâÔ∏è üå∂Ô∏è Serverless PHP üßîüèª üë≤ üìπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Am Vorabend des Starts des Backend PHP Developer Kurses hatten wir eine traditionelle offene Stunde . Dieses Mal haben wir uns mit dem Serverless-Konz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serverless PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/477370/"><p>  Am Vorabend des Starts des <a href="https://otus.pw/PjYz/">Backend PHP Developer</a> Kurses <a href="https://otus.pw/PjYz/">hatten</a> wir eine <a href="https://www.youtube.com/watch%3Fv%3DcGBggTdDmKI">traditionelle offene Stunde</a> .  Dieses Mal haben wir uns mit dem Serverless-Konzept vertraut gemacht, √ºber die Implementierung in AWS gesprochen, die Funktionsweise, den Zusammenbau und den Start besprochen und einen einfachen PHP-TG-Bot auf der Basis von AWS Lambda erstellt. </p><br><p>  Dozent - <a href="https://otus.ru/teacher/491/">Alexander Pryakhin</a> , CTO von Westwing Russland. </p><br><hr><br><p><img src="https://habrastorage.org/webt/fm/-y/de/fm-yde0vvpixphwgwoqfsumq-n4.jpeg"></p><a name="habracut"></a><br><h2 id="kratkiy-ekskurs-v-istoriyu">  Ein kurzer Ausflug in die Geschichte </h2><br><p><img src="https://habrastorage.org/webt/w7/jh/mk/w7jhmkufvziqczxd8ppmbgjylpy.png"></p><br><p>  Wie sind wir zu einem solchen Leben gekommen, dass Serverless Computing auftauchte?  Nat√ºrlich sahen sie nicht nur so aus, sondern wurden zu einer logischen Fortsetzung bestehender Virtualisierungstechnologien. </p><br><p><img src="https://habrastorage.org/webt/am/jv/dt/amjvdt02rv2bv7_-yhbexlhejm0.png"></p><br><p>  Was virtualisieren wir normalerweise?  Zum Beispiel ein Prozessor.  Sie k√∂nnen den Speicher auch virtualisieren, indem Sie bestimmte Speicherbereiche markieren und f√ºr einige Benutzer zug√§nglich und f√ºr andere nicht zug√§nglich machen.  Sie k√∂nnen ein VPN-Netzwerk virtualisieren.  Usw. </p><br><p><img src="https://habrastorage.org/webt/il/2o/p_/il2op_dxfloq7om6r_czugnhebq.png"></p><br><p>  Virtualisierung ist gut, weil wir Ressourcen besser nutzen und die Produktivit√§t steigern.  Es gibt aber auch Nachteile, zum Beispiel gab es einmal Kompatibilit√§tsprobleme.  Es gibt jedoch praktisch keine Architekturen, die mit modernen virtuellen Maschinen nicht kompatibel w√§ren. </p><br><p>  Das n√§chste Minus ist, dass wir eine zus√§tzliche Abstraktionsebene hinzuf√ºgen, einen Hypervisor hinzuf√ºgen, eine virtuelle Maschine selbst hinzuf√ºgen und nat√ºrlich etwas an Geschwindigkeit verlieren k√∂nnen.  Etwas kompliziert und die Nutzung des Servers. </p><br><p><img src="https://habrastorage.org/webt/yh/on/4j/yhon4j0ial2rlrdfq_grqgx6yjw.png"></p><br><p>  Wenn wir eine standardm√§√üige virtuelle Maschine mitnehmen, sieht diese ungef√§hr so ‚Äã‚Äãaus: </p><br><p><img src="https://habrastorage.org/webt/rq/ii/at/rqiiat114asa0rziaowjsjp1amg.png"></p><br><p> Erstens haben wir einen Eisenserver und zweitens das Betriebssystem, auf dem sich unser Hypervisor drehen wird.  Dar√ºber hinaus drehen sich unsere virtuellen Maschinen, in denen sich ein Gastbetriebssystem, Bibliotheken und Anwendungen befinden.  Wenn Sie logisch denken, sehen wir bei Vorhandensein des Gastbetriebssystems einen gewissen Overhead, da wir in der Tat zus√§tzliche Ressourcen ausgeben. </p><br><p>  Wie kann ich das Overhead-Problem l√∂sen?  Ablehnen von virtuellen Maschinen und Hinzuf√ºgen eines Containerverwaltungssystems zum Hauptbetriebssystem.  Das derzeit beliebteste System ist nat√ºrlich die Docker Engine.  Dann verwenden die Bibliotheken im Container den Host-Kernel des Betriebssystems. </p><br><p><img src="https://habrastorage.org/webt/rb/wv/ce/rbwvceyh5h8mrsgsst9bu8acadk.png"></p><br><p>  Auf diese Weise entfernen wir den Overhead, aber Docker ist auch nicht ideal und es hat seine eigenen Probleme und Arbeitsfunktionen, die nicht jedem gefallen. </p><br><p>  Das Wichtigste ist, dass Docker und virtuelle Maschine unterschiedliche Ans√§tze sind und nicht gleichgesetzt werden m√ºssen.  Docker ist keine Mikrovirtualit√§t, mit der Sie wie mit einer virtuellen Maschine arbeiten k√∂nnen, denn der Container ist daf√ºr und der Container.  Der Container erm√∂glicht uns jedoch Flexibilit√§t und einen v√∂llig anderen Ansatz f√ºr die kontinuierliche Lieferung, wenn wir Dinge an die Produktion liefern und verstehen, dass sie bereits getestet wurden und funktionieren. </p><br><h2 id="oblachnye-tehnologii">  Cloud-Technologie </h2><br><p>  Mit der Weiterentwicklung der Virtualisierung begannen sich auch Cloud-Technologien zu entwickeln.  Dies ist eine gute L√∂sung, aber es ist erw√§hnenswert, dass Wolken kein Wundermittel und kein Allheilmittel f√ºr alle √úbel sind.  Hier kann man sich nur an ein ber√ºhmtes Zitat erinnern: </p><br><blockquote>  ‚ÄûWenn ich jemanden h√∂re, der die Cloud als Wundermittel f√ºr alle Computerprobleme ank√ºndigt, ersetze ich‚Äû Cloud ‚Äústillschweigend durch‚Äû Clown ‚Äúund mache mit einem zenartigen L√§cheln weiter.‚Äú <br>  Amy reich </blockquote><p>  F√ºr mittelst√§ndische Unternehmen, die ein gewisses Ma√ü an Service und Fehlertoleranz ohne gro√üe finanzielle Mittel erhalten m√∂chten, sind die Clouds jedoch eine gute Option.  Und f√ºr viele Unternehmen ist es viel teurer, ihr Rechenzentrum mit demselben SLA zu betreiben, als in der Cloud bedient zu werden.  Dar√ºber hinaus k√∂nnen wir die Clouds f√ºr unsere Bed√ºrfnisse verwenden, da sie einige Dinge mit nur wenigen Mausklicks bereitstellen, was sehr praktisch ist.  Zum Beispiel die M√∂glichkeit, eine virtuelle Maschine oder ein Netzwerk mit wenigen Klicks zu heben. <br>  Ja, es gibt Einschr√§nkungen, zum Beispiel das 152. Bundesgesetz, das die Speicherung personenbezogener Daten im Ausland verbietet, so dass derselbe Amazon f√ºr uns w√§hrend eines Audits nicht geeignet sein wird.  Vendor-lock nicht vergessen.  Viele Cloud-L√∂sungen lassen sich nicht miteinander portieren, obwohl die meisten Anbieter denselben S3-kompatiblen Speicher unterst√ºtzen. </p><br><p>  Clouds bieten uns die M√∂glichkeit, ohne eng fokussiertes Wissen unterschiedliche Servicelevels zu erhalten.  Je weniger Wissen Sie ben√∂tigen, desto mehr werden wir bezahlen.  In der folgenden Abbildung sehen Sie die Pyramide, in der von unten nach oben der R√ºckgang des technischen Wissensbedarfs bei Verwendung der Cloud angezeigt wird: </p><br><p><img src="https://habrastorage.org/webt/ro/hi/aj/rohiajoeei87pirilzujxcaelqs.png"></p><br><h2 id="serverless-i-faas-function-as-a-service">  Serverless und FaaS (Funktion als Service) </h2><br><p>  Serverless ist eine relativ junge Methode zum Ausf√ºhren von Skripten in den Clouds, z. B. AWS (in Bezug auf AWS ist der Server in Lambda implementiert).  * Die in der obigen Pyramide aufgelisteten AaS-Ans√§tze sind bereits bekannt: IaaS (EC2, VDS), PaaS (Shared Hosting), SaaS (Office 365, Tilda).  Serverless ist also eine Implementierung des FaaS-Ansatzes.  Und dieser Ansatz besteht darin, dem Benutzer eine vorgefertigte Plattform f√ºr die Entwicklung, den Start und die Verwaltung bestimmter Funktionen zur Verf√ºgung zu stellen, ohne sich selbst vorbereiten und konfigurieren zu m√ºssen. </p><br><p>  Stellen Sie sich vor, Sie haben ein Ger√§t, das nachts Dokumente verarbeitet, von 00:00 bis 6:00 Uhr Aufgaben ausf√ºhrt und in den restlichen Stunden nicht verwendet wird.  Die Frage ist: Warum tags√ºber bezahlen?  Und warum nicht kostenlose Ressourcen f√ºr etwas anderes nutzen?  Dieser Wunsch nach Optimierung und der Wunsch, Geld nur f√ºr das auszugeben, was Sie wirklich nutzen, f√ºhrten zur Entstehung von FaaS. </p><br><p>  Serverless ist eine Ressource zum Ausf√ºhren von Code und sonst nichts.  Dies bedeutet nicht, dass sich hinter unserem Skript kein Server befindet - dies ist der Fall, aber wir haben tats√§chlich keine speziell zugewiesene Ressource, auf der unser Lambda gestartet wird.  Wenn wir unser Skript ausf√ºhren, entfaltet sich die Mikroinfrastruktur sofort darunter, und dies ist im Prinzip nicht Ihr Problem - Sie denken nur, dass Sie den Code ausgef√ºhrt haben, und Sie brauchen sich um nichts anderes zu k√ºmmern. <br>  Dies erfordert nat√ºrlich eine bestimmte Herangehensweise an die Entwicklung Ihres Codes.  Beispielsweise k√∂nnen Sie in dieser Umgebung nichts speichern, sondern m√ºssen alles herausnehmen.  Handelt es sich um Daten, wird eine externe Datenbank ben√∂tigt. Handelt es sich um ein Protokoll, handelt es sich um einen externen Protokolldienst, handelt es sich um eine Datei, handelt es sich um einen externen Dateispeicher.  Gl√ºcklicherweise bietet jeder Serverless-Anbieter die M√∂glichkeit, eine Verbindung zu externen Systemen herzustellen. </p><br><p>  Sie haben nur Code, Sie arbeiten im zustandslosen Paradigma, Sie haben keinen Zustand.  F√ºr die gleiche Welt von PHP bedeutet dies beispielsweise, dass Sie den Standard-Sitzungsmechanismus vergessen k√∂nnen.  Im Prinzip k√∂nnen Sie sogar Ihre Serverless bauen, und k√ºrzlich gab es auf Habr√© <a href="https://habr.com/ru/company/southbridge/blog/475044/">einen Artikel zu diesem Thema</a> . </p><br><p>  Die Grundidee von Serverless ist, dass die Infrastruktur keine Unterst√ºtzung durch das Team erfordert.  Alles f√§llt auf die Schultern der Plattform, f√ºr die Sie tats√§chlich Geld bezahlen.  Von den Minuspunkten - Sie haben keine Kontrolle √ºber die Ausf√ºhrungsumgebung und wissen nicht, wo was ausgef√ºhrt wird. </p><br><p>  So serverlos: </p><br><ul><li>  bedeutet nicht die physische Abwesenheit des Servers; </li><li>  kein Killer von Virtualoks und Docker; </li><li>  kein Hype hier und jetzt. <br>  Serverless sollte bewusst und bewusst vorangetrieben werden.  Zum Beispiel, wenn Sie schnell eine Hypothese testen m√ºssen, ohne die H√§lfte des Teams einzubeziehen.  So erhalten Sie Function As A Service.  Die Funktion reagiert auf einige Ereignisse, und da es eine Reaktion auf Ereignisse gibt, m√ºssen diese Ereignisse von etwas aufgerufen werden - daf√ºr gibt es in derselben AWS viele Trigger. </li></ul><br><p>  FaaS-Funktionen: </p><br><ul><li>  Infrastruktur erfordert keine Konfiguration; </li><li>  "Out of the Box" -Ereignismodell; </li><li>  Staatenlos; </li><li>  Die Skalierung ist sehr einfach und wird automatisch entsprechend den Benutzeranforderungen durchgef√ºhrt. </li></ul><br><h2 id="aws-lambda">  AWS Lambda </h2><br><p>  Die erste und √∂ffentlich verf√ºgbare Implementierung von FaaS ist AWS Lambda.  Wenn es sich um eine Diplomarbeit handelt, hat sie folgende Eigenschaften: <br>  - verf√ºgbar seit 2014; <br>  - unterst√ºtzt standardm√§√üig Java, Node.js, Python, Go und benutzerdefinierte Laufzeiten; <br>  - wir bezahlen f√ºr: <br>  Anzahl der Anrufe; <br>  Vorlaufzeit. <br>  AWS Lambda: Warum wird es ben√∂tigt: <br>  Entsorgung  Sie zahlen nur f√ºr die Zeit, in der der Dienst ausgef√ºhrt wird. <br>  Geschwindigkeit.  Lambda selbst steigt auf und arbeitet sehr schnell. <br>  Funktional.  Lambda bietet viele Funktionen f√ºr die Integration in AWS-Services. <br>  Leistung.  Ein Lambda zu setzen ist ziemlich schwer.  Parallel dazu k√∂nnen je nach Region maximal 1000 bis 3000 Exemplare erstellt werden.  Falls gew√ºnscht, kann dieses Limit durch Schreiben in den Support erh√∂ht werden. </p><br><p>  Wir haben den K√∂rper eines Lambda, einen Online-Editor, VPC als virtuelles Rechengitter, die Protokollierung, den Code selbst, Umgebungsvariablen und Trigger, die ein Lambda verursachen (die Versionierung funktioniert √ºbrigens sehr gut).  In <a href="https://habr.com/ru/post/457100/">diesem Artikel</a> wird die ausgezeichnete Lambda-Anatomie <a href="https://habr.com/ru/post/457100/">beschrieben</a> . </p><br><p>  Der Code wird entweder im Hauptteil (sofern diese Sprachen standardm√§√üig unterst√ºtzt werden) oder in Ebenen gespeichert.  Wir haben einen Trigger, der das Lambda aufruft, das Lambda liest die tempor√§ren Umgebungen, zieht sie zu sich selbst und f√ºhrt unseren Code aus: </p><br><p><img src="https://habrastorage.org/webt/sr/py/zu/srpyzu9gzq6gfkekd-tbo5zkmyq.png"></p><br><p>  Wenn wir eine benutzerdefinierte Laufzeit haben, m√ºssen wir den Code in einer Ebene platzieren.  Wenn Sie mit Docker gearbeitet haben, ist die Docker-Ebene der Lambda-Ebene sehr √§hnlich - eine Art Quasi-Speicher, in dem sich unsere erforderliche Bindung befindet.  Dort haben wir die ausf√ºhrbare Datei der Umgebung (wenn es sich um PHP handelt, sollten Sie die kompilierte PHP-Bin√§rdatei im Voraus platzieren), die Lambda-Bootstrap-Datei (standardm√§√üig gespeichert) und die direkt aufgerufenen Skripte, die ausgef√ºhrt werden. </p><br><p><img src="https://habrastorage.org/webt/pj/es/fp/pjesfpgl0xix6psx4tqwegms_4m.png"></p><br><p>  Bei der Lieferung ist nicht alles so rosig: </p><br><p><img src="https://habrastorage.org/webt/xg/qt/km/xgqtkmwgjqrisunlmvwtgym2nkk.png"></p><br><p>  Das hei√üt, wir k√∂nnen Dateien mit dem Code aufnehmen, in das ZIP-Archiv hochladen, in die Ebene hochladen und unseren Code ausf√ºhren.  Es ist absolut cool, dass dies in der offiziellen Dokumentation von Amazon angeboten wird. </p><br><p><img src="https://habrastorage.org/webt/w2/ls/vr/w2lsvrvdjcbta6km5boxp3ntsgw.png"></p><br><p>  Nat√ºrlich entspricht dies nicht den modernen Realit√§ten und dem Geruch von zweitausendstel in der Luft.  Gl√ºcklicherweise haben freundliche Leute versucht, verschiedene Frameworks zu erstellen. Daher verwenden wir das auf Node.js entwickelte Serverless Framework, mit dem wir Anwendungen auf Basis von AWS Lambda verwalten k√∂nnen.  Wenn wir √ºber Bereitstellung und Entwicklung sprechen, m√∂chte ich nat√ºrlich nicht wirklich manuell bereitstellen, aber es besteht der Wunsch, etwas Flexibles und Automatisiertes zu tun. </p><br><p>  Also brauchen wir: <br>  - AWS CLI - Befehlszeilenschnittstelle f√ºr die Arbeit mit AWS-Diensten; <br>  - das oben bereits erw√§hnte Serverless-Framework (die Entwicklungsversion ist kostenlos und die Funktionalit√§t ist f√ºr die Augen ausreichend); <br>  - Die Bref-Bibliothek, die zum Schreiben von Code ben√∂tigt wird.  Diese Bibliothek wird mit Composer installiert, sodass der Code mit jedem Framework kompatibel ist.  Eine gro√üartige L√∂sung, insbesondere angesichts der Tatsache, dass AWS Lambda das Aufrufen von PHP-Skripten nicht direkt unterst√ºtzt. </p><br><p><img src="https://habrastorage.org/webt/ke/de/4w/kede4wq7a7kupqj4zheld7ifkp0.png"></p><br><h2 id="nastraivaem-okruzhenie-i-aws">  Passen Sie Ihre Umgebung und AWS an </h2><br><h3 id="aws-cli">  AWS CLI </h3><br><p>  Beginnen wir mit der Erstellung eines Kontos und der Installation von AWS CLI.  Die AWS-Konsolen-Shell basiert auf Python 2.7+ oder 3.4+.  Da AWS Version 3 von Python empfiehlt, werden wir nicht streiten. <br>  Die folgenden Beispiele gelten f√ºr Ubuntu. </p><br><pre><code class="plaintext hljs">sudo apt-get -y install python3-pip</code> </pre> <br><p>  Dann installieren Sie direkt AWS CLI: </p><br><pre> <code class="plaintext hljs">pip3 install awscli --upgrade --user</code> </pre> <br><p>  √úberpr√ºfen Sie die Installation: </p><br><pre> <code class="plaintext hljs">aws --version</code> </pre> <br><p>  Jetzt m√ºssen Sie AWS CLI mit Ihrem Konto verbinden.  Sie k√∂nnen Ihren vorhandenen Benutzernamen und Ihr Kennwort verwenden. Es ist jedoch besser, wenn Sie einen separaten Benutzer √ºber AWS IAM erstellen und ihm nur die erforderlichen Zugriffsrechte zuweisen.  Das Aufrufen der Konfiguration verursacht keine Probleme: </p><br><pre> <code class="plaintext hljs">aws configure</code> </pre> <br><p>  Als N√§chstes ben√∂tigen Sie AWS Secret und AWS Access Key.  Sie k√∂nnen in ASW IAM auf der Registerkarte "Sicherheitsanmeldeinformationen" (auf der Seite des gew√ºnschten Benutzers) abgerufen werden.  Die Schaltfl√§che "Zugriffsschl√ºssel erstellen" hilft bei der Erstellung von Zugriffsschl√ºsseln.  Behalte sie bei dir. </p><br><p><img src="https://habrastorage.org/webt/yn/t3/0q/ynt30qaych_hosd73v0bl3yb51q.png"></p><br><p>  Um einen neuen Bot in Telegram zu registrieren, verwenden Sie @BotFather und den Befehl / newbot.  Infolgedessen erhalten Sie das f√ºr die Verbindung zu Ihrem Bot erforderliche Token zur√ºck.  Schlie√üe es auch ab. </p><br><p><img src="https://habrastorage.org/webt/mn/db/6_/mndb6_yarkg6ssd1cmfaykayuam.png"></p><br><h3 id="serverless-framework">  Serverloses Framework </h3><br><p>  Zur Installation von Serverless Framework ben√∂tigen Sie ein Konto unter <a href="https://serverless.com/">https://serverless.com/</a> . <br>  Nach Abschluss der Registrierung fahren wir mit der Installation auf unserer Workstation fort.  Node.js 6. und h√∂her wird ben√∂tigt. </p><br><pre> <code class="plaintext hljs">sudo apt-get -y install nodejs</code> </pre> <br><p>  Um den korrekten Start in unserer Umgebung sicherzustellen, befolgen wir die empfohlenen Schritte: </p><br><pre> <code class="plaintext hljs">mkdir ~/.npm-global export PATH=~/.npm-global/bin:$PATH source ~/.profile npm config set prefix '~/.npm-global'</code> </pre> <br><p>  F√ºgen Sie au√üerdem hinzu: </p><br><pre> <code class="plaintext hljs">~/.npm-global/bin:$PATH</code> </pre> <br><p>  in die Datei / etc / environment. <br>  Setzen Sie nun Serverless: </p><br><pre> <code class="plaintext hljs">npm install -g serverless</code> </pre> <br><h3 id="aws">  Aws </h3><br><p>  Nun, es ist Zeit, zur AWS-Oberfl√§che zu wechseln und einen Domainnamen hinzuzuf√ºgen.  Wir erstellen eine AWS Route 53-Zone, einen DNS-Eintrag und ein SSL-Zertifikat daf√ºr. <br>  Au√üerdem ben√∂tigen Sie den ELB, den wir im Service EC2 -&gt; Load Balancer erstellen.  √úbrigens m√ºssen Sie beim Erstellen einer ELB alle Schritte des Assistenten durchlaufen und das erstellte Zertifikat angeben. </p><br><p>  Der Balancer kann mit dem folgenden Befehl √ºber die AWS-CLI erstellt werden: </p><br><pre> <code class="plaintext hljs">aws elb create-load-balancer --load-balancer-name my-load-balancer --listeners "Protocol=HTTP,LoadBalancerPort=80,InstanceProtocol=HTTP,InstancePort=80" "Protocol=HTTPS,LoadBalancerPort=443,InstanceProtocol=HTTP,InstancePort=80,SSLCertificateId=arn:aws:iam::123456789012:server-certificate/my-server-cert" --subnets subnet-15aaab61 --security-groups sg-a61988c3</code> </pre> <br><p>  Nach der ersten Bereitstellung wird ein Balancer ben√∂tigt.  In diesem Fall m√ºssen Sie Anfragen an unsere Domain an diese senden.  Um dies zu implementieren, geben Sie in den Einstellungen des DNS-Eintrags (Feld ‚ÄûAlias-Ziel‚Äú) den Namen der erstellten ELB ein.  Infolgedessen wird eine Dropdown-Liste angezeigt, sodass der gew√ºnschte Eintrag ausgew√§hlt und gespeichert werden muss. </p><br><p><img src="https://habrastorage.org/webt/-i/yr/8g/-iyr8gsoknvxwk0nsjvwtiolca0.png"></p><br><p>  Gehen Sie jetzt zum Code. </p><br><h3 id="pishem-kod">  Einen Code schreiben </h3><br><p>  Wir werden Bref verwenden, um den Code zu schreiben.  Wie bereits erw√§hnt, wird diese Bibliothek mit Composer installiert, sodass der Code mit jedem Framework kompatibel ist.  √úbrigens haben die Entwickler bereits den Prozess der Verwendung von Bref mit <a href="https://bref.sh/docs/frameworks/laravel.html">Laravel</a> und <a href="https://bref.sh/docs/frameworks/symfony.html">Symfony beschrieben</a> .  Es ist jedoch ratsam, an dem "blo√üen" PHP zu arbeiten - dies hilft, das Wesentliche besser zu verstehen. <br>  Wir beginnen mit den Abh√§ngigkeiten: </p><br><pre> <code class="plaintext hljs">{ "require": { "php": "&gt;=7.2", "bref/bref": "^0.5.9", "telegram-bot/api": "*" }, "autoload": { "psr-4": { "App\": "src/" } } }</code> </pre> <br><p>  Wir werden in PHP 7.2 und h√∂her schreiben und f√ºr die Arbeit mit Telegram ist diese Shell f√ºr die API f√ºr uns geeignet - <a href="https://github.com/TelegramBot/Api">https://github.com/TelegramBot/Api</a> .  Der Code selbst wird im Verzeichnis src abgelegt. </p><br><p>  Die serverlose Umgebung durchl√§uft also einen Konsolendialog.  Eine HTTP-Anwendung ist erforderlich. Aus Sicht von Lambda bedeutet dies, dass Skriptaufrufe auf die gleiche Weise ausgef√ºhrt werden, wie dies bei Nginx der Fall ist.  Die Interpretation wird von PHP-FPM durchgef√ºhrt.  Im Allgemeinen √§hnelt dies eher einem Standard-Konsolenskriptaufruf.  Dies ist ein wichtiger Punkt, da wir ohne Ber√ºcksichtigung dieser Funktion keine Skripte √ºber HTTP aufrufen k√∂nnen. <br>  Wir f√ºhren aus: </p><br><pre> <code class="plaintext hljs">vendor/bin/bref init</code> </pre> <br><p>  W√§hlen Sie im Dialogfeld den Punkt "HTTP-Anwendung" und vergessen Sie nicht, die Region anzugeben, da die Anwendung in derselben Region arbeiten sollte, in der der Balancer arbeitet. <br>  Nach der Initialisierung erscheinen 2 neue Dateien: <br>  index.php - die aufgerufene Datei; <br>  serverless.yml - Bereitstellungskonfigurationsdatei. <br>  Der .serverless-Ordner muss sofort zum .gitignore hinzugef√ºgt werden (er wird nach dem ersten Bereitstellungsversuch angezeigt). </p><br><p>  Sobald wir eine Webanwendung haben, legen wir index.php im √∂ffentlichen Ordner ab und wechseln sofort zu serverless.yml.  So k√∂nnte es in unserer Implementierung aussehen: </p><br><pre> <code class="plaintext hljs">#  lambda- service: app #    provider: name: aws #   ! region: eu-central-1 #    runtime: provided # ,  bref  1024.         memoryLimit: 256 #   stage: dev #    environment: BOT_TOKEN: ${ssm:/app/bot-token} #  bref plugins: - ./vendor/bref/bref #  Lambda- functions: #       php-api-dev # service-function-stage api: handler: public/index.php description: '' # in seconds (API Gateway has a timeout of 29 seconds) timeout: 28 layers: - ${bref:layer.php-73-fpm} #     API Gateway events: - http: 'ANY /' - http: 'ANY /{proxy+}' #    environment: MY_VARIABLE: ${ssm:/app/my_variable}</code> </pre> <br><p>  Analysieren wir nun die nicht offensichtlichen Linien.  Wir brauchen meistens Umgebungsvariablen.  Wir m√∂chten keine Datenbankverbindungen, externen APIs usw. fest codieren. Wenn wir eine Verbindung zu Telegram herstellen, verf√ºgen wir √ºber ein eigenes Token, das von BotFather empfangen wird.  Es wird nicht empfohlen, dieses Token in serverless.yml zu speichern. Es ist daher besser, es an den AWS ssm-Speicher zu senden: </p><br><pre> <code class="plaintext hljs">aws ssm put-parameter --region eu-central-1 --name '/app/my_variable' --type String --value '___BOTFATHER'</code> </pre> <br><p>  Wir verweisen √ºbrigens in der Konfiguration darauf. <br>  Diese Variablen sind als Umgebungsvariablen verf√ºgbar, und Sie k√∂nnen mit der Funktion getenv in PHP darauf zugreifen.  Wenn wir √ºber unser Beispiel sprechen, behalten wir das Bot-Token der Einfachheit halber im globalen Rahmen.  Wir k√∂nnen das Token auch in den Bereich einer einzelnen Funktion √ºbertragen, und der Aufruf selbst wird sich dadurch nicht √§ndern. </p><br><p>  Lass uns weitermachen.  Erstellen wir nun eine einfache BotApp-Klasse, die f√ºr die Generierung einer Antwort f√ºr den Bot verantwortlich ist und auf Befehle reagiert.  Telegrammentwickler empfehlen, die Befehle / help und / start f√ºr alle Bots zu unterst√ºtzen.  F√ºgen wir zum Spa√ü einen weiteren Befehl hinzu.  Die Klasse selbst ist recht einfach und erm√∂glicht es, Front-Controller in index.php zu implementieren, ohne die Aufrufdatei selbst zu laden.  Um eine komplexere Logik zu erhalten, sollte die Architektur entwickelt und kompliziert sein. </p><br><pre> <code class="plaintext hljs">&lt;?php namespace App; use TelegramBot\Api\Client; use Telegram\Bot\Objects\Update; class BotApp { function run(): void{ $token = getenv('BOT_TOKEN'); $bot = new Client($token); //   start $bot-&gt;command('start', function ($message) use ($bot) { $answer = ' !'; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //    $bot-&gt;command('help', function ($message) use ($bot) { $answer = ': /help -  '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //   $bot-&gt;command('hello', function ($message) use ($bot) { $answer = '-,  - ,   Serverless '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); $bot-&gt;run(); } }</code> </pre> <br><p>  Und hier ist die Auflistung von index.php: </p><br><pre> <code class="plaintext hljs">&lt;?php require_once('../vendor/autoload.php'); use App\BotApp; try{ $botApp = new BotApp(); $botApp-&gt;run(); } catch (Exception $e){ echo $e-&gt;getMessage(); print_r($e-&gt;getTrace(), 1); }</code> </pre> <br><p>  Es mag seltsam erscheinen, aber alles ist bereit f√ºr uns, in die Produktion zu gehen.  F√ºhren Sie dazu den folgenden Befehl im Ordner serverless.yml aus: </p><br><pre> <code class="plaintext hljs">sls deploy</code> </pre> <br><p>  Im normalen Modus packt serverless die Dateien in ZIP-Archive, erstellt einen S3-Bucket, in dem sie abgelegt werden, erstellt oder aktualisiert die an Lambda angeh√§ngte AWS-Anwendung und legt den Code und die Laufzeit in einer separaten Ebene ab. </p><br><p>  W√§hrend des ersten Starts wird die Gateway-API erstellt (wir haben sie verlassen, um das Testen von Anrufen zu vereinfachen, aber dann ist es ratsam, sie zu l√∂schen).  Sie m√ºssen auch den Lambda-Aufruf √ºber ELB konfigurieren, f√ºr den wir im Funktionssteuerungsfenster "Trigger hinzuf√ºgen" und in der Dropdown-Liste "Application Load Balancer" ausw√§hlen.  Sie m√ºssen die zuvor erstellte ELB angeben, die Verbindung √ºber HTTPS einrichten, den Host leer lassen und unter Pfad den Pfad angeben, den Lambda aufruft (z. B. / lambda / mytgbot).  Infolgedessen ist Ihr Lambda unter der URL mit dem angegebenen Pfad verf√ºgbar. </p><br><p>  Jetzt k√∂nnen Sie den Antwortteil des Bot in Telegram registrieren, damit der Messenger versteht, wo er Nachrichten abrufen kann.  Rufen Sie dazu die folgende URL im Browser auf, aber vergessen Sie nicht, Ihre eigenen Parameter einzutragen: </p><br><pre> <code class="plaintext hljs">https://api.telegram.org/bot_/setWebhook?url=https://my-elb-host.com/lambda/mytgbot</code> </pre> <br><p>  Infolgedessen gibt die API "OK" zur√ºck, woraufhin der Bot verf√ºgbar wird. </p><br><p><img src="https://habrastorage.org/webt/g-/rd/kl/g-rdkldh57hxw-sbbcl_ci9nmyk.png"></p><br><h2 id="testiruem-bota-na-lokali">  Testen Sie den Bot auf Gebietsschemas </h2><br><p>  Der Bot kann vor dem Einsatz getestet werden.  Tatsache ist, dass das Serverless Framework das Starten in Gebietsschemas mit Docker-Containern unterst√ºtzt.  Befehl aufrufen: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction</code> </pre> <br><p>  Vergessen Sie nicht, dass wir Umgebungsvariablen verwendet haben, daher sollten diese w√§hrend des Aufrufs auch im folgenden Format festgelegt werden: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction --env VAR1=val1</code> </pre> <br><h2 id="logi">  Protokolle </h2><br><p>  Standardm√§√üig wird die Anrufausgabe in CloudWatch protokolliert. Sie ist im √úberwachungsbereich der entsprechenden Lambda-Funktion verf√ºgbar.  Hier k√∂nnen Sie die Call Traces im Falle eines Dumps auf der PHP-Seite auslesen.  Dar√ºber hinaus k√∂nnen Sie erweiterte √úberwachungsdienste anschlie√üen, die jedoch zus√§tzlich einige Cent pro Monat kosten. </p><br><h2 id="itogo">  Total </h2><br><p>  Als Ergebnis haben wir eine relativ schnelle, flexible, skalierbare und auch relativ kosteng√ºnstige L√∂sung erhalten.  Ja, Lambda gewinnt nicht immer im Vergleich zu Standard-VMs und -Containern, aber es gibt Situationen, in denen die Anwendung ohne Server dabei hilft, schnell und effizient zu ‚Äûschie√üen‚Äú.  Und das Beispiel des erstellten Bots zeigt dies nur. <br>  N√ºtzliche Materialien zum Thema: </p><br><ul><li>  <a href="http.html">Bref Dokumentation</a> </li><li>  <a href="https://habr.com/ru/post/457100/">Lambda-Theorie</a> ; </li><li>  <a href="https://dev.to/sosnowski/anatomy-of-aws-lambda-1i1e">Lambda-Anatomie</a> ; </li><li>  <a href="https://serverless.com/">Serverloses Framework</a> </li><li>  <a href="https://devenergy.ru/archives/941">Serverloser Telegramm-Bot basierend auf PHP und AWS Lambda</a> . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de477370/">https://habr.com/ru/post/de477370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de477358/index.html">Wir laden Sie am 5. Dezember zu DINS DevOps EVENING ein: Wir sprechen √ºber ein Ereignisverarbeitungssystem, das Erfahrungen mit Influx austauscht</a></li>
<li><a href="../de477360/index.html">Was ist neu in SOLIDWORKS Simulation 2020?</a></li>
<li><a href="../de477362/index.html">Mehr als nur Anti-Spam: So holen Sie das Beste aus Ihrem Security Email Gateway heraus</a></li>
<li><a href="../de477364/index.html">Wie werde ich Java-Entwickler? Oder vielleicht Python w√§hlen?</a></li>
<li><a href="../de477366/index.html">F√ºnf Fragen zum Entwerfen von Programmiersprachen</a></li>
<li><a href="../de477372/index.html">Amazon verliert den Krieg gegen F√§lschungen</a></li>
<li><a href="../de477374/index.html">Fuzzing Z-Maschinen</a></li>
<li><a href="../de477378/index.html">Mixed Agile - Waterfall-Ansatz bei der Implementierung von Gesch√§ftsanwendungen (auch bekannt als Agile-like)</a></li>
<li><a href="../de477382/index.html">Esport - Profit machen: Mercedes, Megaphon, Wetten und Branding f√ºr den Esport</a></li>
<li><a href="../de477384/index.html">Konferenz ‚ÄûInformationssicherheit. Bedrohungen der Gegenwart und Zukunft ‚Äú</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>