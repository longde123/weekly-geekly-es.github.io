<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👬 🧕🏻 👩🏻‍⚖️ Erstellen einer Backend-Anwendung für den Apollo-Online-Chat Node.js. 👹 🧗🏼 🔌</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einiger Zeit arbeitete ich an einer mobilen Anwendung, deren Funktionalität einen praktischen Online-Chat beinhaltete. Und jetzt habe ich beschlos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen einer Backend-Anwendung für den Apollo-Online-Chat Node.js.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470756/">  Vor einiger Zeit arbeitete ich an einer mobilen Anwendung, deren Funktionalität einen praktischen Online-Chat beinhaltete.  Und jetzt habe ich beschlossen, einen Artikel mit kurzen Anweisungen zum Erstellen eines Chats mit Apollo Server und node.js im Backend zu schreiben und auf der Clientseite auf native und Apollo Client zu reagieren. <br><br>  Der Artikel ist zum leichteren Lesen in zwei Teile unterteilt.  Der erste Teil enthält eine Anleitung zum Erstellen eines Anwendungs-Backends, und der zweite Teil enthält eine Anleitung zum Erstellen eines Anwendungs-Frontends. <br><br>  Wenn Sie zu faul zum Lesen sind, können Sie den Code in Github'e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> sofort sehen. <br><br>  Als Haupttechnologien für die Implementierung habe ich das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Koa-</a> Framework node.js, die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Postgresql-</a> Datenbank sowie den GraphQL-Server <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Apollo-Server-Koa ausgewählt</a> . <br><br>  Zunächst wurde ein leeres Koa2-Projekt generiert, für das ich einen einfachen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Koa-Generator verwendet habe,</a> indem ich den Befehl im Terminal ausgeführt habe: <br><br><pre><code class="javascript hljs">$ koa &lt;project name&gt;</code> </pre> <a name="habracut"></a><br>  Dann wurden die notwendigen Abhängigkeiten installiert, ich mache es mit Garn, aber Sie können npm verwenden. <br><br><pre> <code class="javascript hljs">$ yarn add apollo-server-koa knex objection pg</code> </pre> <br><h3>  Alle notwendigen Bibliotheken sind installiert, jetzt können Sie Code schreiben </h3><br>  Um eine Verbindung zur Datenbank herzustellen, müssen Sie zwei Dateien beschreiben. Die erste ist db.js, die die knex-Clientinstanz exportiert und es unseren Modellen ermöglicht, mit Daten aus der Datenbank zu arbeiten. Die zweite ist knexfile.js, die die Datenbankverbindungseinstellungen zum Erstellen und enthält rollierende Migrationen. <br><br>  <b>Der Code db.js wird unten beschrieben. Beachten Sie, dass alle Einstellungen von Umgebungsvariablen übernommen werden:</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> db = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'knex'</span></span>)({ <span class="hljs-attr"><span class="hljs-attr">client</span></span>: <span class="hljs-string"><span class="hljs-string">'pg'</span></span>, <span class="hljs-attr"><span class="hljs-attr">connection</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">host</span></span> : process.env.POSTGRES_HOST,   <span class="hljs-attr"><span class="hljs-attr">port</span></span>: process.env.POSTGRES_PORT,   <span class="hljs-attr"><span class="hljs-attr">user</span></span> : process.env.POSTGRES_USER,   <span class="hljs-attr"><span class="hljs-attr">password</span></span> : process.env.POSTGRES_PASSWORD,   <span class="hljs-attr"><span class="hljs-attr">database</span></span> : process.env.POSTGRES_DATABASE } }); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = db;</code> </pre> <br>  Der Code knexfile.js ist <a href="">hier</a> verfügbar. <br><br><h4>  Jetzt können Sie die Migrationen beschreiben, um die beiden benötigten Tabellen zu erstellen. </h4><br>  Die Tabellen selbst sind so einfach wie möglich und enthalten nur die minimal erforderlichen Felder.  Der Befehl zum Erstellen ist unten: <br><br><pre> <code class="javascript hljs">$ knex migrate:make migration_name</code> </pre> <br>  Sie können die Migrationsdateien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> anzeigen. <br><br><h4>  Erstellen Sie nun die Entitätsmodelle Nachricht und Benutzer </h4><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> get tableName() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'messages'</span></span>; } $beforeInsert() {   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.created_at = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().toISOString(); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> get relationMappings() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {     <span class="hljs-attr"><span class="hljs-attr">user</span></span>: {       <span class="hljs-attr"><span class="hljs-attr">relation</span></span>: Model.BelongsToOneRelation,       <span class="hljs-attr"><span class="hljs-attr">modelClass</span></span>: User,       <span class="hljs-attr"><span class="hljs-attr">join</span></span>: {         <span class="hljs-attr"><span class="hljs-attr">from</span></span>: <span class="hljs-string"><span class="hljs-string">'messages.user_id'</span></span>,         <span class="hljs-attr"><span class="hljs-attr">to</span></span>: <span class="hljs-string"><span class="hljs-string">'users.id'</span></span>       }     }   }; } }</code> </pre> <br>  Das Interessanteste blieb - das Verbinden und Konfigurieren von Apollo-Server-Koa, eine Beschreibung des Graphql-Schemas und der Resolver. <br><br><h4>  Um apollo-server-koa zu verbinden, fügen Sie einfach die folgenden Codezeilen hinzu </h4><br>  <b>app.js:</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { ApolloServer } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'apollo-server-koa'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> graphqlSchema = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./graphqlSchema'</span></span>); … <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> apolloServer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApolloServer(graphqlSchema); apolloServer.applyMiddleware({ app });</code> </pre> <br>  <b>www:</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> { app, apolloServer } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../app'</span></span>); ... apolloServer.installSubscriptionHandlers(server);</code> </pre> <br>  Zusätzlich zur Verbindung von apollo-server-koa haben wir die Möglichkeit integriert, mit Abonnements zu arbeiten, um Kunden zu benachrichtigen, dass eine neue Nachricht im Chat eingegangen ist. <br><br><h4>  Apollo-Server-Koa ist verbunden, der nächste Schritt ist eine Beschreibung des Graphql-Diagramms mit den für den Chat erforderlichen Typen </h4><br><pre> <code class="javascript hljs">input UserInput { <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! } input MessageInput { <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! user_id: ID! } type User { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: ID username: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> } type Message { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: ID text: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> created_at: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> user: User } type Query { <span class="hljs-attr"><span class="hljs-attr">getLast100Messages</span></span>: [Message] } type Mutation { findOrCreateUser(user: UserInput!): User createMessage(message: MessageInput!): Message } type Subscription { <span class="hljs-attr"><span class="hljs-attr">messageCreated</span></span>: Message }</code> </pre> <br><h4>  Die Schaltung ist fertig, wir beschreiben die Resolver </h4><br>  <b>Ein Beispiel für einen Resolver zum Senden einer neuen Nachricht:</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Message = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../models/message'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pubsub, MESSAGE_CREATED } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../utils'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">createMessage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (obj, { message }, context, info) =&gt; {   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> createdMessage = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Message     .query()     .insert(message);   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resultMessage = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Message     .query()     .eager(<span class="hljs-string"><span class="hljs-string">'user'</span></span>)     .findById(createdMessage.id);   pubsub.publish(MESSAGE_CREATED, { <span class="hljs-attr"><span class="hljs-attr">messageCreated</span></span>: resultMessage });   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resultMessage; }, };</code> </pre> <br>  <b>Ein interessanter Punkt</b> ist, dass hier zusätzlich zum Speichern der Nachricht in der Datenbank die Funktion Publish () aufgerufen wird, die alle Abonnenten über das Ereignis MESSAGE_CREATED benachrichtigt und ihnen ein neues Nachrichtenobjekt sendet (der aufmerksame Leser wird feststellen, dass der Absender auch über seine neue Nachricht benachrichtigt wird, und wir werden dies weiter verarbeiten Für den Client ist es in einem realen Projekt sinnvoll, dies auf der Backend-Seite zu verarbeiten, um die Logik nicht zwischen verschiedenen Clients zu duplizieren. <br><br>  Den Code der verbleibenden Resolver finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br><h4>  Die Serverseite des Chats ist bereit. Wie kann ich überprüfen, ob alles funktioniert? </h4><br>  Öffnen Sie den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Host</a> in Ihrem Browser und Sie sehen darin den graphql-Spielplatz. <br><br><img src="https://habrastorage.org/webt/vy/av/36/vyav362j7gtmyqiqt6qa6-5zy-q.png" alt="Bild"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Im nächsten Teil werden</a> wir eine mobile Anwendung erstellen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de470756/">https://habr.com/ru/post/de470756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de470744/index.html">Mathematik enthüllt Geheimnisse des Feedbacks lebender Zellen</a></li>
<li><a href="../de470746/index.html">Facebook macht Konversation zur nächsten beliebten Oberfläche</a></li>
<li><a href="../de470750/index.html">Amazon fing an, Spitzenprodukte zu fangen</a></li>
<li><a href="../de470752/index.html">Parsen von Wechat-Zahlungen</a></li>
<li><a href="../de470754/index.html">RASA Chatbot: Parallelen Erfahrung</a></li>
<li><a href="../de470758/index.html">Überblick über die Virusaktivität im September 2019</a></li>
<li><a href="../de470772/index.html">TON: Empfehlungen und Best Practices</a></li>
<li><a href="../de470774/index.html">Neue Typanmerkungen in Python 3.8 (Protokoll, Final, TypedDict, Literal)</a></li>
<li><a href="../de470778/index.html">Seagate ST2000DM008 Laufwerk Bewertung: schnelle "zwei" ohne Überpreis</a></li>
<li><a href="../de470780/index.html">Die Bar ist genommen - die neue von Seagate zur Aufbewahrung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>