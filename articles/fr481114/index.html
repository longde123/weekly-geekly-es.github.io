<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèº üìò üî¨ Seccomp at Kubernetes: 7 choses que vous devez savoir depuis le d√©but üè´ üåº ‚è¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev. : Pr√©sentation d'une traduction d'un article par un ing√©nieur principal en s√©curit√© des applications de la soci√©t√© britannique ASOS.co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seccomp at Kubernetes: 7 choses que vous devez savoir depuis le d√©but</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/481114/"> <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: Pr√©sentation d'une traduction d'un article par un ing√©nieur principal en s√©curit√© des applications de la soci√©t√© britannique ASOS.com.</i>  <i>Avec elle, il commence une s√©rie de publications sur l'am√©lioration de la s√©curit√© √† Kubernetes gr√¢ce √† l'utilisation de seccomp.</i>  <i>Si les lecteurs aimeront l'introduction, nous suivrons l'auteur et continuerons avec ses futurs documents sur ce sujet.</i> <br><br><img src="https://habrastorage.org/webt/-u/nv/vk/-unvvkiylrs9ucbym-l4bsobtr8.png"><br><br>  Cet article est le premier d'une s√©rie de publications sur la fa√ßon de cr√©er des profils seccomp dans l'esprit de SecDevOps sans recourir √† la magie et √† la sorcellerie.  Dans la premi√®re partie, je parlerai des bases et des d√©tails internes de l'impl√©mentation de seccomp dans Kubernetes. <br><br>  L'√©cosyst√®me Kubernetes offre une grande vari√©t√© de fa√ßons d'assurer la s√©curit√© et l'isolement des conteneurs.  Cet article concerne le mode de calcul s√©curis√©, √©galement appel√© <b>seccomp</b> .  Son essence r√©side dans le filtrage des appels syst√®me disponibles pour les conteneurs √† ex√©cuter. <a name="habracut"></a><br><br>  Pourquoi est-ce important?  Un conteneur n'est qu'un processus ex√©cut√© sur une machine sp√©cifique.  Et il utilise le noyau sur un pied d'√©galit√© avec d'autres applications.  Si les conteneurs pouvaient effectuer des appels syst√®me, tr√®s vite les malwares en profiteraient pour contourner l'isolement du conteneur et affecter d'autres applications: intercepter des informations, modifier les param√®tres syst√®me, etc. <br><br>  Les profils seccomp d√©terminent quels appels syst√®me doivent √™tre autoris√©s ou refus√©s.  Le runtime du conteneur les active lors de son lancement, afin que le noyau puisse contr√¥ler leur ex√©cution.  L'utilisation de tels profils vous permet de limiter le vecteur d'attaque et de r√©duire les dommages si un programme √† l'int√©rieur du conteneur (c'est-√†-dire vos d√©pendances ou leurs d√©pendances) commence √† faire ce qu'il n'est pas autoris√© √† faire. <br><br><h2>  Comprendre les bases </h2><br>  Le profil de base seccomp comprend trois √©l√©ments: <code>defaultAction</code> , <code>architectures</code> (ou <code>archMap</code> ) et <code>syscalls</code> : <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"sched_yield"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span>, <span class="hljs-string"><span class="hljs-string">"mmap"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"madvise"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigprocmask"</span></span>, <span class="hljs-string"><span class="hljs-string">"getpid"</span></span>, <span class="hljs-string"><span class="hljs-string">"gettid"</span></span>, <span class="hljs-string"><span class="hljs-string">"tgkill"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"getpgrp"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/ef974f57693bb193f39e8add8a7040d7">medium-basic-seccomp.json</a> )</i> <br><br>  <code>defaultAction</code> d√©termine le sort par d√©faut de tout appel syst√®me non sp√©cifi√© dans la section <code>syscalls</code> .  Pour simplifier la t√¢che, nous nous concentrons sur deux valeurs principales qui seront utilis√©es: <br><br><ul><li>  <code>SCMP_ACT_ERRNO</code> - bloque l'ex√©cution d'un appel syst√®me, </li><li>  <code>SCMP_ACT_ALLOW</code> - autorise. </li></ul><br>  La section <code>architectures</code> r√©pertorie les architectures cibles.  Ceci est important, car le filtre lui-m√™me, appliqu√© au niveau du noyau, d√©pend des identifiants des appels syst√®me, et non de leurs noms enregistr√©s dans le profil.  Avant utilisation, le runtime du conteneur les mappe √† des identificateurs.  Le fait est que les appels syst√®me peuvent avoir des ID compl√®tement diff√©rents, selon l'architecture du syst√®me.  Par exemple, l' <code>recvfrom</code> syst√®me <code>recvfrom</code> (utilis√© pour obtenir des informations √† partir d'un socket) a ID = 64 sur les syst√®mes x64 et ID = 517 sur x86.  Vous trouverez ici une liste de tous les appels syst√®me pour les architectures x86-x64. <br><br>  La section <code>syscalls</code> r√©pertorie tous les appels syst√®me et indique que faire avec eux.  Par exemple, vous pouvez cr√©er une liste blanche en d√©finissant <code>defaultAction</code> sur <code>SCMP_ACT_ERRNO</code> et affecter des appels √† la section <code>SCMP_ACT_ALLOW</code> √† <code>SCMP_ACT_ALLOW</code> .  Ainsi, vous autorisez uniquement les appels enregistr√©s dans la section des <code>syscalls</code> et interdisez tous les autres.  Pour la liste noire, vous devez changer les valeurs et les actions <code>defaultAction</code> par le contraire. <br><br>  Maintenant, il faut dire quelques mots sur les nuances qui ne sont pas si √©videntes.  Veuillez noter que les recommandations ci-dessous proviennent du fait que vous d√©ployez une gamme d'applications m√©tier dans Kubernetes et il est important pour vous qu'elles fonctionnent avec le moins de privil√®ges. <br><br><h2>  1. AllowPrivilegeEscalation = false </h2><br>  Il existe un param√®tre <code>AllowPrivilegeEscalation</code> dans le <code>securityContext</code> conteneur.  S'il est d√©fini sur <code>false</code> , les conteneurs commenceront avec le bit <a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt"><code>no_new_priv</code></a> d√©fini sur ( <code>on</code> ).  La signification de ce param√®tre est √©vidente d'apr√®s le nom: il ne permet pas au conteneur de d√©marrer de nouveaux processus avec des privil√®ges sup√©rieurs √† ceux dont il dispose. <br><br>  Un effet secondaire de ce param√®tre d√©fini sur <code>true</code> (la valeur par d√©faut) est que le runtime du conteneur applique le profil seccomp au tout d√©but du processus de d√©marrage.  Ainsi, tous les appels syst√®me n√©cessaires pour d√©marrer les processus internes du runtime (par exemple, d√©finir des identifiants utilisateur / groupe, supprimer certaines fonctionnalit√©s) doivent √™tre autoris√©s dans le profil. <br><br>  Le conteneur qui effectue l' <code>echo hi</code> banal <code>echo hi</code> aura besoin des autorisations suivantes: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"brk"</span></span>, <span class="hljs-string"><span class="hljs-string">"capget"</span></span>, <span class="hljs-string"><span class="hljs-string">"capset"</span></span>, <span class="hljs-string"><span class="hljs-string">"chdir"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-string"><span class="hljs-string">"execve"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"fstat"</span></span>, <span class="hljs-string"><span class="hljs-string">"fstatfs"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"getdents64"</span></span>, <span class="hljs-string"><span class="hljs-string">"getppid"</span></span>, <span class="hljs-string"><span class="hljs-string">"lstat"</span></span>, <span class="hljs-string"><span class="hljs-string">"mprotect"</span></span>, <span class="hljs-string"><span class="hljs-string">"nanosleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"newfstatat"</span></span>, <span class="hljs-string"><span class="hljs-string">"openat"</span></span>, <span class="hljs-string"><span class="hljs-string">"prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"statfs"</span></span>, <span class="hljs-string"><span class="hljs-string">"setgid"</span></span>, <span class="hljs-string"><span class="hljs-string">"setgroups"</span></span>, <span class="hljs-string"><span class="hljs-string">"setuid"</span></span>, <span class="hljs-string"><span class="hljs-string">"stat"</span></span>, <span class="hljs-string"><span class="hljs-string">"uname"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/018658f1aeea1ef696b451bde8c33a8f">hi-pod-seccomp.json</a> )</i> <br><br>  ... au lieu de ceux-ci: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"brk"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-string"><span class="hljs-string">"execve"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"mprotect"</span></span>, <span class="hljs-string"><span class="hljs-string">"nanosleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"stat"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/7c860ad818e3724d65a96ffdae5da808">hi-container-seccomp.json</a> )</i> <br><br>  Mais l√† encore, pourquoi est-ce un probl√®me?  Personnellement, <code>capset</code> <code>set_tid_address</code> liste blanche les appels syst√®me suivants (s'ils ne sont pas vraiment n√©cessaires): <code>capset</code> , <code>set_tid_address</code> , <code>setgid</code> , <code>setgroups</code> et <code>setuid</code> .  Cependant, la vraie difficult√© est qu'en autorisant des processus sur lesquels vous n'avez absolument aucun contr√¥le, vous liez des profils √† l'impl√©mentation du runtime du conteneur.  En d'autres termes, un jour, vous pouvez rencontrer le fait qu'apr√®s la mise √† jour de l'environnement d'ex√©cution du conteneur (par vous ou, plus probablement, par le fournisseur de services cloud), les conteneurs cesseront soudainement de d√©marrer. <br><br>  <b>Conseil n ¬∞ 1</b> : <code>AllowPrivilegeEscaltion=false</code> conteneurs avec <code>AllowPrivilegeEscaltion=false</code> .  Cela r√©duira la taille des profils seccomp et les rendra moins sensibles aux modifications de l'ex√©cution du conteneur. <br><br><h2>  2. D√©finition des profils seccomp au niveau du conteneur </h2><br>  Le profil seccomp peut √™tre d√©fini au niveau du pod: <br><br><pre> <code class="plaintext hljs">annotations: seccomp.security.alpha.kubernetes.io/pod: "localhost/profile.json"</code> </pre> <br>  ... ou au niveau des conteneurs: <br><br><pre> <code class="plaintext hljs">annotations: container.security.alpha.kubernetes.io/&lt;container-name&gt;: "localhost/profile.json"</code> </pre> <br>  <i>Veuillez noter que la syntaxe ci-dessus changera lorsque Kubernetes seccomp <a href="https://github.com/kubernetes/enhancements/pull/1148">deviendra GA</a> (cet √©v√©nement est attendu dans la prochaine version de Kubernetes - 1.18 - approx. Transl.).</i> <br><br>  Peu de gens savent que Kubernetes a toujours eu un <a href="https://github.com/kubernetes/kubernetes/issues/84623">bogue</a> qui entra√Ænait l'application de profils seccomp au <a href="https://www.ianlewis.org/en/almighty-pause-container">conteneur de pause</a> .  Le runtime compense partiellement cet inconv√©nient, mais ce conteneur ne dispara√Æt pas des pods, car il est utilis√© pour configurer leur infrastructure. <br><br>  Le probl√®me est que ce conteneur commence toujours par <code>AllowPrivilegeEscalation=true</code> , conduisant aux probl√®mes <code>AllowPrivilegeEscalation=true</code> au paragraphe 1, et cela ne peut pas √™tre modifi√©. <br><br>  En appliquant des profils seccomp au niveau du conteneur, vous √©vitez ce pi√®ge et pouvez cr√©er un profil qui sera ¬´affin√©¬ª pour un conteneur sp√©cifique.  Cela devra √™tre fait jusqu'√† ce que les d√©veloppeurs corrigent le bogue et que la nouvelle version (peut-√™tre 1.18?) Devienne disponible pour tout le monde. <br><br>  <b>Conseil n ¬∞ 2</b> : d√©finissez les profils seccomp au niveau du conteneur. <br><br>  Dans un sens pratique, cette r√®gle sert g√©n√©ralement de r√©ponse universelle √† la question: ¬´Pourquoi mon profil seccomp fonctionne-t-il avec <code>docker run</code> , mais il ne fonctionne pas apr√®s le d√©ploiement dans un cluster Kubernetes?¬ª <br><br><h2>  3. Utilisez runtime / default en dernier recours </h2><br>  Kubernetes a deux options pour les profils int√©gr√©s: <code>runtime/default</code> et <code>docker/default</code> .  Les deux sont impl√©ment√©s par le runtime du conteneur, pas Kubernetes.  Par cons√©quent, ils peuvent diff√©rer selon le runtime utilis√© et sa version. <br><br>  En d'autres termes, en raison de la modification de l'ex√©cution, le conteneur peut acc√©der √† un autre ensemble d'appels syst√®me qu'il peut utiliser ou ne pas utiliser.  La plupart des runtimes utilisent <a href="">une impl√©mentation Docker</a> .  Si vous souhaitez utiliser ce profil, assurez-vous qu'il vous convient. <br><br>  Le profil <code>docker/default</code> est obsol√®te depuis Kubernetes 1.11, donc √©vitez de l'utiliser. <br><br>  √Ä mon avis, le profil d' <code>runtime/default</code> est parfait pour le but pour lequel il a √©t√© cr√©√©: pour prot√©ger les utilisateurs contre les risques associ√©s √† l'ex√©cution de la <code>docker run</code> sur leurs machines.  Cependant, si nous parlons d'applications commerciales s'ex√©cutant dans des clusters Kubernetes, j'oserais affirmer qu'un tel profil est trop ouvert et que les d√©veloppeurs devraient se concentrer sur la cr√©ation de profils pour leurs applications (ou types d'application). <br><br>  <b>Conseil n ¬∞ 3</b> : cr√©ez des profils seccomp pour des applications sp√©cifiques.  Si cela n'est pas possible, traitez les profils pour les types d'applications, par exemple, cr√©ez un profil avanc√© qui inclut toutes les API d'application Web Golang.  Uniquement en dernier recours, utilisez runtime / default. <br><br>  Dans de futures publications, je vous dirai comment cr√©er des profils secccomp dans l'esprit de SecDevOps, les automatiser et les tester dans des pipelines.  En d'autres termes, vous n'aurez aucune excuse pour ne pas passer aux profils pour des applications sp√©cifiques. <br><br><h2>  4. Unfini n'est PAS une option </h2><br>  D√®s le <a href="https://www.cncf.io/blog/2019/08/06/open-sourcing-the-kubernetes-security-audit/">premier audit de s√©curit√© de Kubernetes,</a> il s'est av√©r√© que <a href="https://github.com/kubernetes/kubernetes/issues/81115">seccomp √©tait d√©sactiv√©</a> par d√©faut.  Cela signifie que si vous ne sp√©cifiez pas de <code>PodSecurityPolicy</code> qui l' <code>PodSecurityPolicy</code> dans le cluster, tous les pods pour lesquels le profil seccomp n'est pas d√©fini fonctionneront en <code>seccomp=unconfined</code> . <br><br>  Travailler dans ce mode signifie qu'une couche enti√®re d'isolement est perdue, ce qui assure la protection du cluster.  Cette approche n'est pas recommand√©e par les professionnels de la s√©curit√©. <br><br>  <b>Conseil n ¬∞ 4</b> : aucun conteneur d'un cluster ne devrait fonctionner en <code>seccomp=unconfined</code> , en particulier dans les environnements de production. <br><br><h2>  5. "Mode audit" </h2><br>  Ce point n'est pas unique √† Kubernetes, mais il tombe toujours dans la cat√©gorie ¬´ce que vous devez savoir avant de commencer¬ª. <br><br>  Il se trouve que la cr√©ation de profils seccomp a toujours √©t√© une entreprise d√©licate et reposait en grande partie sur des essais et des erreurs.  Le fait est que les utilisateurs n'ont tout simplement pas la possibilit√© de les tester dans des environnements de production sans risquer de ¬´laisser tomber¬ª l'application. <br><br>  Apr√®s l'av√®nement du noyau Linux 4.14, il est devenu possible d'ex√©cuter des parties du profil en mode audit, en enregistrant des informations sur tous les appels syst√®me dans syslog, mais sans les bloquer.  Vous pouvez activer ce mode √† l'aide du param√®tre <code>SCMT_ACT_LOG</code> : <br><br>  <i><b>SCMP_ACT_LOG</b> : seccomp n'affectera pas le fonctionnement d'un thread effectuant un appel syst√®me s'il ne rel√®ve d'aucune r√®gle du filtre, mais les informations sur l'appel syst√®me seront enregistr√©es.</i> <br><br>  Voici un exemple de strat√©gie d'utilisation de cette fonctionnalit√©: <br><br><ol><li>  Autorisez les appels syst√®me n√©cessaires. </li><li>  Bloquer les syst√®mes d'appel connus pour ne pas √™tre utiles. </li><li>  Enregistrez des informations sur tous les autres appels dans le journal. </li></ol><br>  Un exemple simplifi√© est le suivant: <br><br><pre> <code class="plaintext hljs">{ "defaultAction": "SCMP_ACT_LOG", "architectures": [ "SCMP_ARCH_X86_64", "SCMP_ARCH_X86", "SCMP_ARCH_X32" ], "syscalls": [ { "names": [ "arch_prctl", "sched_yield", "futex", "write", "mmap", "exit_group", "madvise", "rt_sigprocmask", "getpid", "gettid", "tgkill", "rt_sigaction", "read", "getpgrp" ], "action": "SCMP_ACT_ALLOW" }, { "names": [ "add_key", "keyctl", "ptrace" ], "action": "SCMP_ACT_ERRNO" } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/fa4f7a89937c486d940ac8ccf48379c9">medium-mixed-seccomp.json</a> )</i> <br><br>  Mais n'oubliez pas que vous devez bloquer tous les appels connus pour √™tre inutilis√©s et qui pourraient potentiellement endommager le cluster.  Une bonne base de cotation est la <a href="https://docs.docker.com/engine/security/seccomp/">documentation</a> officielle de <a href="https://docs.docker.com/engine/security/seccomp/">Docker</a> .  Il explique en d√©tail quels appels syst√®me sont bloqu√©s dans le profil par d√©faut et pourquoi. <br><br>  Cependant, il y a une prise.  Bien que <code>SCMT_ACT_LOG</code> pris en charge par le noyau Linux depuis la fin de 2017, il n'est entr√© que r√©cemment dans l'√©cosyst√®me Kubernetes.  Par cons√©quent, pour utiliser cette m√©thode, vous aurez besoin du noyau Linux 4.14 et de la version runC non inf√©rieure √† <a href="https://github.com/opencontainers/runc/releases/tag/v1.0.0-rc9">v1.0.0-rc9</a> . <br><br>  <b>Conseil n ¬∞ 5</b> : vous pouvez cr√©er un profil de mode d'audit pour les tests en production en combinant des listes noires et blanches et enregistrer toutes les exceptions. <br><br><h2>  6. Utilisez des listes blanches </h2><br>  La cr√©ation de listes blanches n√©cessite des efforts suppl√©mentaires, car vous devez identifier chaque appel dont l'application peut avoir besoin, mais cette approche am√©liore consid√©rablement la s√©curit√©: <br><br><blockquote>  <i>Il est fortement recommand√© d'utiliser l'approche de liste blanche car elle est plus simple et plus fiable.</i>  <i>La liste noire devra √™tre mise √† jour chaque fois qu'un appel syst√®me potentiellement dangereux (ou un indicateur / option dangereux s'ils figurent dans la liste noire) est ajout√©.</i>  <i>De plus, vous pouvez souvent changer la pr√©sentation d'un param√®tre sans changer son essence et ainsi contourner les limites de la liste noire.</i> </blockquote><br>  Pour les applications Go, j'ai d√©velopp√© un outil sp√©cial qui accompagne l'application et collecte tous les appels effectu√©s lors de l'ex√©cution.  Par exemple, pour l'application suivante: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) }</code> </pre> <br>  ... ex√©cutez <code>gosystract</code> comme ceci: <br><br><pre> <code class="bash hljs">go install https://github.com/pjbgf/gosystract gosystract --template=<span class="hljs-string"><span class="hljs-string">'{{- range . }}{{printf "\"%s\",\n" .Name}}{{- end}}'</span></span> application-path</code> </pre> <br>  ... et obtenez le r√©sultat suivant: <br><br><pre> <code class="plaintext hljs">"sched_yield", "futex", "write", "mmap", "exit_group", "madvise", "rt_sigprocmask", "getpid", "gettid", "tgkill", "rt_sigaction", "read", "getpgrp", "arch_prctl",</code> </pre> <br>  Jusqu'√† pr√©sent, ce n'est qu'un exemple - les d√©tails sur les outils seront plus loin. <br><br>  <b>Conseil n ¬∞ 6</b> : autorisez uniquement les appels dont vous avez vraiment besoin et bloquez tous les autres. <br><br><h2>  7. Poser les bases (ou se pr√©parer √† un comportement inattendu) </h2><br>  Le noyau surveillera la conformit√© avec le profil, peu importe ce que vous y avez enregistr√©.  M√™me si ce n'est pas tout √† fait ce que je voulais.  Par exemple, si vous bloquez l'acc√®s √† des appels comme <code>exit</code> ou <code>exit_group</code> , le conteneur ne pourra pas terminer le travail correctement et m√™me une simple commande comme <code>echo hi</code> <a href="https://github.com/kubernetes/kubernetes/issues/85191">suspendra</a> pour une p√©riode ind√©finie.  En cons√©quence, vous obtiendrez une utilisation √©lev√©e du processeur dans le cluster: <br><br><img src="https://habrastorage.org/webt/32/no/rt/32nortxic_d8czgqc5jnbzrb-ps.png"><br><br>  Dans de tels cas, l'utilitaire <code>strace</code> peut venir √† la rescousse - il montrera quel est le probl√®me: <br><br><img src="https://habrastorage.org/webt/hg/l3/eh/hgl3ehuqz8a6eprrsycubq_n6hu.png"><br> <i><code>sudo strace -c -p 9331</code></i> <br> <br>  Assurez-vous que les profils contiennent tous les appels syst√®me dont l'application a besoin lorsqu'elle est en cours d'ex√©cution. <br><br>  <b>Astuce # 7</b> : Faites attention aux petites choses et assurez-vous que tous les appels syst√®me n√©cessaires sont inclus dans la liste blanche. <br><br>  Avec cela, la premi√®re partie d'une s√©rie d'articles sur l'utilisation de seccomp dans Kubernetes dans l'esprit de SecDevOps prend fin.  Dans les parties suivantes, nous expliquerons pourquoi cela est important et comment automatiser le processus. <br><br><h2>  PS du traducteur </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  " <a href="https://habr.com/ru/company/flant/blog/474012/">S√©curit√© pour les conteneurs Docker</a> "; </li><li>  ¬´ <a href="https://habr.com/ru/company/flant/blog/465141/">33+ outils de s√©curit√© Kubernetes</a> ¬ª; </li><li>  ¬´ <a href="https://habr.com/ru/company/flant/blog/440504/">Docker et Kubernetes dans des environnements exigeants en mati√®re de s√©curit√©</a> ¬ª; </li><li>  ¬´ <a href="https://habr.com/ru/company/flant/blog/436300/">9 Kubernetes Security Best Practices</a> ¬ª. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481114/">https://habr.com/ru/post/fr481114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481102/index.html">Bo√Æte √† outils multiplateforme .NET UI version AvaloniaUI 0.9</a></li>
<li><a href="../fr481104/index.html">M√©lange d'OpenJDK et de NodeJS: interactions inter-langages et architecture verticale</a></li>
<li><a href="../fr481106/index.html">Comment LANIT a tourn√© une sitcom DIY dans son bureau</a></li>
<li><a href="../fr481110/index.html">Playme VEGA Review: Enregistreur combin√© avec √©cran tactile et support miroir</a></li>
<li><a href="../fr481112/index.html">Que dira le ¬´chewing-gum¬ª √¢g√© de 5700 ans de la personne qui l'a m√¢ch√©?</a></li>
<li><a href="../fr481116/index.html">Publier automatiquement des messages de la communaut√© VKontakte sur Discord</a></li>
<li><a href="../fr481118/index.html">P√®re No√´l anonyme 2019-2020: poste offrant des cadeaux du Nouvel An</a></li>
<li><a href="../fr481120/index.html">O√π et comment les serveurs Edge sont-ils appliqu√©s?</a></li>
<li><a href="../fr481122/index.html">PostgreSQL Antipatterns: passage d'ensembles et de s√©lections √† SQL</a></li>
<li><a href="../fr481124/index.html">Conseils pour √©crire du code auto-document√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>