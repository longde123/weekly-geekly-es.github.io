<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☁️ 🙎🏽 👨🏻‍🎓 Sauvegarde incrémentale en une douzaine de lignes 👩🏼‍🚒 🤘🏾 🔃</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qu'est-ce qui est le plus important pour les sauvegardes? C'est vrai, la reproductibilité. --link-dest donc un vélo sur le genou et sur l'option --lin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sauvegarde incrémentale en une douzaine de lignes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475510/"><p> Qu'est-ce qui est le plus important pour les sauvegardes?  C'est vrai, la reproductibilité.  <code>--link-dest</code> donc un vélo sur le genou et sur l'option <code>--link-dest</code> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rsync</a> .  Notre vélo n'aura pas de structure de données restituée comme un git, ni un tas de backends comme la duplicité.  Mais nous pouvons restaurer son travail de mémoire, même sous stress. </p><br><p>  L'option <code>--link-dest</code> vous permet de spécifier la version de sauvegarde précédente sur laquelle rsync mettra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des liens durs</a> si les fichiers n'ont pas changé depuis la dernière fois. </p><a name="habracut"></a><br><p>  Autrement dit, <code>rsync --link-dest=/var/backups/www.1 remote:/var/www /var/backups/www.0</code> copie uniquement ces fichiers du serveur distant dans le dossier /var/backups/www.0 qui ont changé, mais pour le reste, il mettra un lien dur dans /var/backups/www.1 </p><br><p>  Maintenant, l'astuce est petite: encapsulez l'appel <code>rsync</code> dans du code qui décale les sauvegardes d'une <code>/var/backups/www.0</code> et libère de l'espace pour une nouvelle sauvegarde dans <code>/var/backups/www.0</code> , et supprime également la dernière copie de / <code>/var/backups/www.9</code> . </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  find /var/www/backups/ -maxdepth 1 -type d -name '*.[0-9]'| sort -rn| while read dir do #     this=`expr match "$dir" '.*\([0-9]\)'`; #   1,  ,      10  let next=($this+1)%$10; basedirname=${dir%.[0-9]} if [ $next -eq 0 ] ; then rm -rf $dir else mv $dir $basedirname.$next fi done</span></span></code> </pre> <br><p>  Ce code renommera <code>/var/backups/www.1</code> en <code>/var/backups/www.2</code> et <code>/var/backups/www.0</code> renommera <code>/var/backups/www.1</code> . </p><br><p>  Il ne reste plus qu'à exécuter <code>rsync --link-dest=/var/backups/www.1 remote:/var/www /var/backups/www.0</code> , en ajoutant des options à votre goût.  Ainsi, l'option <code>--delete</code> supprime les fichiers de la dernière copie ( <code>rsync</code> ne le fait pas par défaut), l'option <code>-C</code> ignore les dossiers <code>.svn</code> , <code>.git</code> , les artefacts de <code>patch</code> et certains autres types courants de fichiers temporaires. </p><br><p>  Tous ensemble: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash FROM=$1 #  TO=$2 #  LINKTO=--link-dest=$TO/`basename $FROM`.1 #   OPTS="-Ca --delete" #    rsync NUMBER_OF_BACKUPS=10 #     #    ,       # dir.1, dir.2, dir.3     dir.9 find $TO -maxdepth 1 -type d -name '*.[0-9]'| sort -rn| while read dir do this=`expr match "$dir" '.*\([0-9]\)'`; let next=($this+1)%$NUMBER_OF_BACKUPS; basedirname=${dir%.[0-9]} if [ $next -eq 0 ] ; then rm -rf $dir else mv $dir $basedirname.$next fi done #  ,  rsync rsync $OPTS $LINKTO $FROM/ $TO/`basename $FROM.0`</span></span></code> </pre> <br><p>  En dehors des crochets se trouvait la gestion des erreurs (voir <code>set -e</code> ) et les notifications, et le nombre de copies peut être personnalisé. </p><br><p>  Mais ça marche! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr475510/">https://habr.com/ru/post/fr475510/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr475488/index.html">Présentation de PyTorch: Deep Learning in Natural Language Processing</a></li>
<li><a href="../fr475490/index.html">Travailler sous pression</a></li>
<li><a href="../fr475494/index.html">«Y a-t-il une vie après Signor?» Ou de quoi parlerons-nous au SECR-2019</a></li>
<li><a href="../fr475496/index.html">Comment déterminer l'adresse d'un contrat intelligent avant le déploiement: utiliser CREATE2 pour l'échange cryptographique</a></li>
<li><a href="../fr475498/index.html">Windows Server Core vs GUI et compatibilité logicielle</a></li>
<li><a href="../fr475512/index.html">MIRO est une plate-forme de robot intérieure ouverte. Partie 4 - Composant logiciel: ARDUINO (AVR)</a></li>
<li><a href="../fr475514/index.html">IOS killer: jailbreak utilisant checkra1n dans les questions et réponses</a></li>
<li><a href="../fr475518/index.html">Une entreprise canadienne a développé un matériau qui vous rend invisible</a></li>
<li><a href="../fr475520/index.html">Transition CSS de la propriété height de 0px à auto</a></li>
<li><a href="../fr475522/index.html">HP: votre disque d'origine n'est pas du tout d'origine. Qui est à blâmer et que faire?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>