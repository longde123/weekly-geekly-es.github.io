<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëåüèº üåõ üõÄüèø L'histoire d'un probl√®me avec le compteur de vitesse ou comment Chromium g√®re la m√©moire üé† ‚úåüèº üê∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un navigateur moderne est un projet extr√™mement complexe dans lequel m√™me des changements d'apparence inoffensive peuvent entra√Æner des surprises inat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'histoire d'un probl√®me avec le compteur de vitesse ou comment Chromium g√®re la m√©moire</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/436154/"> Un navigateur moderne est un projet extr√™mement complexe dans lequel m√™me des changements d'apparence inoffensive peuvent entra√Æner des surprises inattendues.  Par cons√©quent, il existe de nombreux tests internes qui devraient d√©tecter ces modifications avant la publication.  Il n'y a jamais trop de tests, il est donc utile d'utiliser √©galement des benchmarks publics tiers. <br><br>  Je m'appelle Andrey Logvinov, je travaille dans le groupe de d√©veloppement du moteur de rendu Yandex.Browser √† Nizhny Novgorod.  Aujourd'hui, je vais expliquer aux lecteurs de Habr comment fonctionne la gestion de la m√©moire dans le projet Chromium en donnant l'exemple d'un probl√®me myst√©rieux qui a entra√Æn√© une d√©gradation des performances lors du test du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compteur de vitesse</a> .  Ce message est bas√© sur mon rapport de l'√©v√©nement Yandex.Inside. <br><br><img src="https://habrastorage.org/webt/rf/uv/u2/rfuvu23derqjtojmwivg2t-dhpm.png"><br><br><a name="habracut"></a><br>  Une fois sur notre tableau de bord de performance, nous avons constat√© une d√©t√©rioration du test du compteur de vitesse.  Ce test mesure les performances globales du navigateur sur une application proche de la r√©alit√© - une liste de t√¢ches, o√π le test ajoute des √©l√©ments √† la liste, puis les raye.  Les r√©sultats des tests sont affect√©s √† la fois par les performances du moteur V8 JS et par la vitesse de rendu des pages dans le moteur Blink.  Le test du compteur de vitesse se compose de plusieurs sous-tests, o√π l'application de test est √©crite en utilisant l'un des cadres JS populaires, par exemple jQuery ou ReactJS.  Le r√©sultat global du test est d√©fini comme la moyenne des r√©sultats pour tous les frameworks, mais le test vous permet de voir les performances de chaque framework individuellement.  Il est √† noter que le test n'a pas pour but d'√©valuer les performances des frameworks, ils ne sont utilis√©s que pour rendre le test moins synth√©tique et plus proche des applications web r√©elles.  Le d√©tail par sous-test a montr√© qu'une d√©t√©rioration n'est observ√©e que pour la version de l'application de test cr√©√©e √† l'aide de jQuery.  Et c'est d√©j√† int√©ressant, d'accord. <br><br>  L'enqu√™te sur de telles situations commence de mani√®re assez standard - nous d√©terminons quel engagement particulier envers le code a provoqu√© le probl√®me.  Pour ce faire, nous stockons les assemblages Yandex.Browser pour chaque (!) Commit au cours des derni√®res ann√©es (il serait difficile de le r√©assembler, car l'assemblage prend plusieurs heures).  Cela prend beaucoup d'espace sur les serveurs, mais cela aide g√©n√©ralement √† trouver rapidement la source du probl√®me.  Mais cette fois n'a pas fonctionn√© rapidement.  Il s'est av√©r√© que la d√©t√©rioration des r√©sultats des tests a co√Øncid√© avec un commit int√©grant la prochaine version de Chromium.  Le r√©sultat n'est pas encourageant, car la nouvelle version de Chromium apporte un grand nombre de changements √† la fois. <br><br>  Comme nous n'avons re√ßu aucune information indiquant un changement sp√©cifique, j'ai d√ª faire une √©tude de fond du probl√®me.  Pour ce faire, nous avons utilis√© les outils de d√©veloppement pour supprimer les traces de test.  Nous avons remarqu√© une caract√©ristique √©trange - des intervalles ¬´d√©chir√©s¬ª pour l'ex√©cution des fonctions de test Javascript. <br><br><img src="https://habrastorage.org/webt/fx/28/ua/fx28ua2nvcjcjxa6vrkf6xtzfye.png" alt="image"><br><br>  Nous supprimons une trace plus technique avec about: tracing et voyons qu'il s'agit de <b>garbage collection (GC)</b> dans Blink. <br><br><img src="https://habrastorage.org/webt/11/hr/h9/11hrh9f2kyuwkbmmpgtpi8ibm5y.png" alt="image"><br><br>  La piste m√©moire ci-dessous montre que ces pauses GC prennent non seulement beaucoup de temps, mais ne contribuent pas non plus √† arr√™ter la croissance de la consommation de m√©moire. <br><br><img src="https://habrastorage.org/webt/u9/bw/qz/u9bwqzatofige39dtlpb7qabwjk.png" alt="image"><br><br>  Mais si vous ins√©rez un appel GC explicite dans le test, nous voyons une image compl√®tement diff√©rente - la m√©moire est conserv√©e dans la r√©gion z√©ro et ne fuit pas.  Ainsi, nous n'avons aucune fuite de m√©moire et le probl√®me est li√© aux fonctionnalit√©s du collecteur.  Nous continuons √† creuser.  Nous d√©marrons le d√©bogueur et voyons que le garbage collector a contourn√© environ 500 mille objets!  Un tel nombre d'objets n'a pas pu affecter les performances.  Mais d'o√π venaient-ils? <br><br>  Et ici, nous avons besoin d'un petit flashback sur le dispositif de collecte des ordures dans Blink.  Il supprime les objets morts, mais ne d√©place pas les objets vivants, ce qui permet de fonctionner avec des pointeurs nus dans des variables locales en code C ++.  Ce mod√®le est activement utilis√© dans Blink.  Mais il a son propre prix - lors de la collecte des ordures, vous devez <b>analyser la pile de</b> flux et si quelque chose de similaire √† un pointeur vers un objet d'un tas (tas) y est trouv√©, alors consid√©rez l'objet et tout ce qu'il fait r√©f√©rence directement ou indirectement comme vivant.  Cela conduit au fait que certains objets pratiquement inaccessibles et donc ¬´morts¬ª sont identifi√©s comme vivants.  Par cons√©quent, cette forme de collecte des ordures est √©galement appel√©e conservatrice. <br><br>  Nous v√©rifions la connexion avec l'analyse de la pile et la sautons.  Le probl√®me a disparu. <br><br>  Qu'est-ce qui peut √™tre tel dans une pile qui contient 500 000 objets?  Nous mettons un point d'arr√™t dans la fonction d'ajout d'objets - entre autres choses, nous voyons qu'il y a suspect: <br><br>  blink :: TraceTrait &lt;blink :: HeapHashTableBacking &lt;WTF :: HashTable &lt;blink :: WeakMember ... <br><br>  <b>Une r√©f√©rence de table de hachage</b> est probablement suspecte!  Nous testons l'hypoth√®se en sautant l'ajout de ce lien.  Le probl√®me a disparu.  Eh bien, nous sommes un pas de plus vers la r√©ponse. <br><br>  Nous rappelons une autre caract√©ristique du garbage collector dans Blink: s'il voit un pointeur vers l'int√©rieur de la table de hachage, il consid√®re cela comme un signe d'it√©ration continue sur la table, ce qui signifie qu'il consid√®re tous les liens de cette table utiles et continue de les contourner.  Dans notre cas, inactif.  Mais quelle fonction est √† l'origine de ce lien? <br><br>  Nous avan√ßons quelques images de la pile plus haut, prenons la position actuelle du scanner, regardons le cadre de la pile dans lequel il tombe.  Il s'agit d'une fonction appel√©e <b>ScheduleGCIfNeeded</b> .  Il semblerait qu'ici il soit le coupable, mais ... nous regardons le code source de la fonction et voyons qu'il n'y a pas du tout de tables de hachage.  De plus, cela fait d√©j√† partie du garbage collector lui-m√™me, et il n'a tout simplement pas besoin de faire r√©f√©rence aux objets du tas Blink.  D'o√π vient ce "mauvais" lien? <br><br>  Nous avons d√©fini un point d'arr√™t sur la modification de la cellule m√©moire, dans laquelle nous avons trouv√© un lien vers la table de hachage.  Nous voyons que l'une des fonctions internes appel√©es V8PerIsolateData :: AddActiveScriptWrappable y √©crit.  L√†, ils ajoutent des √©l√©ments HTML cr√©√©s de certains types, y compris des entr√©es, √† une seule table de hachage active_script_wrappables_.  Ce tableau est n√©cessaire pour emp√™cher la suppression d'√©l√©ments qui ne sont plus r√©f√©renc√©s depuis Javascript ou l'arborescence DOM, mais qui sont associ√©s √† toute activit√© externe qui, par exemple, peut g√©n√©rer des √©v√©nements. <br><br>  Le garbage collector pendant la travers√©e normale de la table prend en compte l'√©tat des √©l√©ments qu'il contient et les marque comme vivants ou ne les marque pas, puis ils sont supprim√©s √† l'√©tape suivante de l'assemblage.  Cependant, dans notre cas, un pointeur vers le stockage interne de cette table appara√Æt lorsque la pile est analys√©e et tous les √©l√©ments de la table sont marqu√©s comme actifs. <br><br>  Mais comment la valeur de la pile d'une fonction a-t-elle touch√© la pile d'une autre?! <br><br>  Pensez √† ScheduleGCIfNeeded.  Rappelons que rien d'utile n'a √©t√© trouv√© dans le code source de cette fonction, mais cela signifie seulement qu'il est temps de descendre √† un niveau inf√©rieur et de v√©rifier le <b>compilateur</b> .  Le prologue d√©mont√© de la fonction ScheduleGCIfNeeded ressemble √† ceci: <br><br><pre><code class="plaintext hljs">0FCDD13A push ebp 0FCDD13B mov ebp,esp 0FCDD13D push edi 0FCDD13E push esi 0FCDD13F and esp,0FFFFFFF8h 0FCDD142 sub esp,0B8h 0FCDD148 mov eax,dword ptr [__security_cookie (13DD3888h)] 0FCDD14D mov esi,ecx 0FCDD14F xor eax,ebp 0FCDD151 mov dword ptr [esp+0B4h],eax</code> </pre> <br>  On peut voir que la fonction <b>descend en particulier vers 0B8h</b> , et cet endroit n'est plus utilis√©.  Mais √† cause de cela, le scanner de pile voit ce qui √©tait pr√©c√©demment enregistr√© par d'autres fonctions.  Et par hasard, un pointeur vers l'int√©rieur de la table de hachage laiss√©e par la fonction AddActiveScriptWrappable p√©n√®tre dans ce ¬´trou¬ª.  Il s'est av√©r√© que la raison de l'apparition d'un ¬´trou¬ª dans ce cas √©tait la <b>macro de</b> d√©bogage <b>VLOG</b> √† l'int√©rieur de la fonction, qui affiche des informations suppl√©mentaires dans le journal. <br><br>  Mais pourquoi la table active_script_wrappable_ avait-elle des centaines de milliers d'√©l√©ments?  Pourquoi la d√©gradation des performances est-elle observ√©e uniquement sur le test jQuery?  La r√©ponse aux deux questions est la m√™me - dans ce test particulier, pour chaque modification (comme une coche dans la case √† cocher), l'interface utilisateur enti√®re est compl√®tement recr√©√©e.  Le test produit des √©l√©ments qui se transforment presque imm√©diatement en ordures.  Les autres tests du compteur de vitesse sont plus prudents et ne cr√©ent pas d'√©l√©ments inutiles, par cons√©quent, aucune d√©gradation des performances n'est observ√©e pour eux.  Si vous d√©veloppez des services Web, vous devez en tenir compte afin de ne pas cr√©er de travail inutile pour le navigateur. <br><br>  Mais pourquoi le probl√®me ne se posait-il maintenant que si la macro VLOG √©tait ant√©rieure?  Il n'y a pas de r√©ponse exacte, mais tr√®s probablement, pendant la mise √† jour, la position relative des √©l√©ments sur la pile a chang√©, √† cause de quoi le pointeur vers la table de hachage est devenu accidentellement accessible au scanner.  En fait, nous avons gagn√© √† la loterie.  Pour fermer rapidement le ¬´trou¬ª et restaurer les performances, nous avons supprim√© la macro de d√©bogage VLOG.  Pour les utilisateurs, il est inutile, et pour nos propres besoins de diagnostic, nous pouvons toujours le r√©activer.  Nous avons √©galement partag√© nos exp√©riences avec d'autres d√©veloppeurs de Chromium.  La r√©ponse a confirm√© nos craintes: il s'agit d'un probl√®me fondamental de la collecte des ordures conservatrice dans Blink, qui n'a pas de solution syst√©mique. <br><br><h3>  Liens int√©ressants </h3><br>  1. Si vous souhaitez en savoir plus sur la vie quotidienne inhabituelle de notre groupe, rappelez-vous l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">histoire du rectangle noir</a> , qui a conduit √† l'acc√©l√©ration non seulement de Yandex.Browser, mais de l'ensemble du projet Chromium. <br><br>  2. Je vous invite √©galement √† √©couter d'autres reportages lors du prochain √©v√©nement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yandex.Inside</a> le 16 f√©vrier, les inscriptions sont ouvertes et la diffusion le sera √©galement. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr436154/">https://habr.com/ru/post/fr436154/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr436140/index.html">¬´Sous le capot¬ª du stockage Huawei: les technologies propri√©taires et ce que les autres n'ont pas</a></li>
<li><a href="../fr436144/index.html">Patrons suceurs de sang dans le contexte d'une bioc√©nose: pourquoi une √©quipe autonome se d√©sagr√®ge si elle n'est pas centralis√©e</a></li>
<li><a href="../fr436148/index.html">L'histoire d'un junior - comment commencer √† travailler et ne pas avoir peur de tout</a></li>
<li><a href="../fr436150/index.html">Configurer le transfert de donn√©es d'appareil vers AWS IoT Core</a></li>
<li><a href="../fr436152/index.html">L'erreur qui m'a appris le design orient√© business</a></li>
<li><a href="../fr436160/index.html">5 r√®gles de code faciles √† lire</a></li>
<li><a href="../fr436162/index.html">GoPro Factory d√©m√©nage pour se pr√©munir contre la menace de droits d'importation plus √©lev√©s</a></li>
<li><a href="../fr436164/index.html">L'exp√©rience des signes a montr√© que la messagerie quantique est plus rapide que la messagerie classique</a></li>
<li><a href="../fr436166/index.html">Tesla Model 3 est offert sur Pwn2Own √† toute personne qui s'introduit dans un syst√®me de protection de v√©hicule √©lectrique</a></li>
<li><a href="../fr436170/index.html">Dans le bioconteneur sur la lune, les premi√®res plantes ont germ√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>