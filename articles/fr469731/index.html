<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèæ ‚§¥Ô∏è üßï Gestion des exceptions ASP.NET √† l'aide de IRO.Mvc.MvcExceptionHandler üëµüèΩ üë©üèª‚Äç‚úàÔ∏è üë°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous √™tes un d√©veloppeur backend c #, vous devrez probablement t√¥t ou tard trouver un moyen unifi√© de g√©rer des situations exceptionnelles. Bien qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gestion des exceptions ASP.NET √† l'aide de IRO.Mvc.MvcExceptionHandler</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469731/"><img src="https://habrastorage.org/webt/qp/uf/w4/qpufw4gxcz0is2ivjqx-uncl2l0.jpeg"><br><br>  Si vous √™tes un d√©veloppeur backend c #, vous devrez probablement t√¥t ou tard trouver un moyen unifi√© de g√©rer des situations exceptionnelles.  Bien que, m√™me si vous √™tes satisfait du code 500 dans la r√©ponse, cet article vous aidera √† am√©liorer votre m√©thode, sans forcer quoi que ce soit √† r√©√©crire. <br><br>  Nous parlerons de la biblioth√®que ASP.NET, qui vous permet de r√©soudre ce probl√®me le plus √©l√©gamment possible.  Pour ceux qui sont trop paresseux pour lire un long article - le readme et la biblioth√®que elle-m√™me sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , un exemple est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Disponible sur nuget.org et je ne serai heureux que si cela profite √† quiconque.  Et donc, passons au code.  Voyons d'abord les alternatives. <br><a name="habracut"></a><br>  L'une des premi√®res choses qui peut vous venir √† l'esprit est de cr√©er un DTO (Data transfer object) pour g√©rer les exceptions, intercepter une exception dans le contr√¥leur (bien qu'il ne soit pas n√©cessaire que ce soit une exception, il est possible de v√©rifier simplement null ou quelque chose comme √ßa), Remplissez les donn√©es dans le DTO et envoyez-les au client.  Le code de cette m√©thode pourrait ressembler √† ceci: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Code with exception. } catch (Exception ex) { return new JsonResult( new ErrorDto { IsError = true, Message = ex.Message }); } }</span></span></code> </pre> <br>  Une autre option consiste √† utiliser des codes d'√©tat HTTP pour cela. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Code with exception. } catch (Exception ex) { return BadRequest(); } }</span></span></code> </pre><br>  Une pratique assez courante, mais ayant ses inconv√©nients: il peut √™tre difficile de d√©crire l'essence de votre situation avec l'un des codes standard, c'est pourquoi le m√™me code peut √™tre interpr√©t√© diff√©remment m√™me sur le m√™me syst√®me, et il fournit √©galement trop peu d'informations pour le d√©bogage au d√©veloppeur. <br><br>  Et ici, certains peuvent m√™me commencer √† combiner ces deux m√©thodes, et dans des proportions diff√©rentes.  Quelque part, ils oublieront d'envoyer le DTO, quelque part le code ne sera pas envoy√© ou le mauvais sera envoy√©, mais quelque part en g√©n√©ral, il sera s√©rialis√© avec les mauvais param√®tres json et ne retournera pas ce qui est n√©cessaire. <br><br>  Face √† ce qui pr√©c√®de, beaucoup essaient de r√©soudre ce probl√®me en utilisant <b>app.UseExceptionHandler ();</b>  en g√©rant les exceptions √† travers elle.  C'est une bonne tentative, mais elle ne vous permettra pas d'oublier facilement le probl√®me.  Tout d'abord, vous serez toujours confront√© au probl√®me du choix d'un DTO pour les exceptions.  Deuxi√®mement, un tel gestionnaire ne permettra pas de traiter les codes d'erreur http renvoy√©s par les contr√¥leurs, car  Aucune exception ne s'est produite.  Troisi√®mement, de cette fa√ßon, il n'est pas pratique de r√©soudre le probl√®me de classification des erreurs, vous devrez √©crire beaucoup de code pour joindre un message, du code http ou quelque chose √† chaque exception.  Et quatri√®mement, vous perdez la possibilit√© d'utiliser AspA DeveloperExceptionPage, ce qui est tr√®s g√™nant pour le d√©bogage.  M√™me si vous r√©solvez ce probl√®me d'une mani√®re ou d'une autre, tous les d√©veloppeurs de ce projet devront suivre strictement les sp√©cifications, cr√©er une gestion des erreurs sp√©cifiquement sur les exceptions, ne pas renvoyer leurs DTO, sinon les erreurs dans votre API peuvent diff√©rer d'une m√©thode √† l'autre. <br><br><h2>  Option de gestion des exceptions s√©lectionn√©e </h2><br>  Avant de montrer comment IRO.Mvc.MvcExceptionHandler vous permet de g√©rer les exceptions, je vais d'abord d√©crire comment je vois la gestion des exceptions id√©ale.  Pour ce faire, nous √©tablissons un certain nombre d'exigences: <br><br><ol><li>  Ce devrait √™tre un DTO, mais nous ne refusons pas non plus les codes http, car  pour de nombreuses erreurs, elles sont toujours bien adapt√©es, peuvent √™tre utilis√©es partout et dans un ancien projet que vous devez √©galement soutenir, et elles sont tout simplement universelles.  Le DTO standard inclura le champ IsError (qui permet d'√©crire universellement la gestion des erreurs sur le client), il devrait √©galement contenir le code d'erreur de la cha√Æne ErrorKey, que le d√©veloppeur ne peut reconna√Ætre imm√©diatement qu'en le regardant et qui fournit plus d'informations.  En outre, vous pouvez ajouter un lien vers une page avec une description de cette erreur, si n√©cessaire. </li><li>  Tout est dans la prod.  En mode d√©veloppement, ce DTO doit retourner une trace de pile, demander des donn√©es: cookies, en-t√™tes, param√®tres.  √Ä l'avenir, le middleware d√©crit dans l'article renvoie m√™me un lien vers la DeveloperExceptionPage g√©n√©r√©e, qui vous permet de regarder la trace d'exception sous une forme pratique, mais plus √† ce sujet plus tard. </li><li>  Le d√©veloppeur peut lier ensemble l'exception, le code d'erreur http et ErrorKey.  Cela signifie que s'il envoie du code 403 depuis le contr√¥leur, alors si le d√©veloppeur lui a attach√© une ErrorKey sp√©cifique, le DTO avec lui sera retourn√©.  Et vice versa, si une exception UnauthorizedAccessException se produit, elle sera li√©e au code http et √† ErrorKey. </li></ol><br>  Il s'agit du format par d√©faut utilis√© dans la biblioth√®que: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"__IsError"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ErrorKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"ClientException"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"InfoUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://iro.com/errors/ClientException"</span></span> }</code> </pre><br>  Je dois dire tout de suite que la forme sous laquelle les donn√©es seront transmises au client peut √™tre absolument quelconque, ce n'est l√† qu'une des options. <br><br><h2>  IRO.Mvc.MvcExceptionHandler </h2><br>  Je vais maintenant montrer comment j'ai r√©solu ce probl√®me par moi-m√™me en √©crivant la biblioth√®que IRO.Mvc.MvcExceptionHandler. <br><br>  Nous connectons un gestionnaire d'exceptions comme tout autre middleware - dans la classe Startup. <br><br><pre> <code class="cs hljs">app.UseMvcExceptionHandler((s) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//Settings... });</span></span></code> </pre><br>  √Ä l'int√©rieur du d√©l√©gu√© d√©l√©gu√©, nous devons configurer notre middleware.  Il est n√©cessaire de mapper (lier) les exceptions aux codes http et ErrorKey.  Voici l'option de configuration la plus simple. <br><br><pre> <code class="cs hljs"> s.Mapping((builder) =&gt; { builder.RegisterAllAssignable&lt;Exception&gt;( httpCode: <span class="hljs-number"><span class="hljs-number">500</span></span>, errorKeyPrefix: <span class="hljs-string"><span class="hljs-string">"Ex_"</span></span> ); });</code> </pre><br>  Comme je l'ai promis aux d√©veloppeurs hardcore les plus <s>paresseux</s> qui ne sont pas habitu√©s √† g√©rer les exceptions - rien d'autre ne doit √™tre fait.  Ce code liera toutes les exceptions du pipeline ASP.NET au DTO commun avec le code 500 et le nom de l'exception sera √©crit dans ErrorKey. <br><br>  Il convient de comprendre que la m√©thode RegisterAllAssignable enregistre non seulement une exception du type sp√©cifi√©, mais √©galement tous ses descendants.  Si vous souhaitez envoyer uniquement des informations sur des exceptions sp√©cifiques au client, il est tout √† fait raisonnable de cr√©er votre exception ClientException et de la mapper uniquement.  Dans le m√™me temps, si vous d√©finissez un code http pour ClientException et en d√©finissez un autre pour son successeur SpecialClientException, le code SpecialClientException sera utilis√© pour tous ses descendants, en ignorant le param√®tre ClientException.  Tout cela est mis en cache, il n'y aura donc aucun probl√®me de performances. <br><br>  Vous pouvez affiner et enregistrer votre code ErrorKey et http pour une exception sp√©cifique: <br><br><pre> <code class="cs hljs"> s.Mapping((builder) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//By exception, custom error key. builder.Register&lt;ArgumentNullException&gt;( httpCode: 555, errorKey: "CustomErrorKey" ); //By http code. builder.Register( httpCode: 403, errorKey: "Forbidden" ); //By exception, default ErrorKey and http code. builder.Register&lt;NullReferenceException&gt;(); //Alternative registration method. builder.Register((ErrorInfo) new ErrorInfo() { ErrorKey = "MyError", ExceptionType = typeof(NotImplementedException), HttpCode = 556 }); });</span></span></code> </pre><br>  En plus du mappage, il vaut la peine de configurer les poids moyens.  Vous pouvez sp√©cifier les param√®tres de s√©rialisation json, l'adresse de votre site, un lien vers la page de description des erreurs, le mode de fonctionnement du middleware via IsDebug, le code http standard pour les exceptions non g√©r√©es. <br><br><pre> <code class="cs hljs"> s.ErrorDescriptionUrlHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormattedErrorDescriptionUrlHandler(<span class="hljs-string"><span class="hljs-string">"https://iro.com/errors/{0}"</span></span>); s.IsDebug = isDebug; s.DefaultHttpCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; s.JsonSerializerSettings.Formatting = Formatting.Indented; s.Host=<span class="hljs-string"><span class="hljs-string">"https://iro.com"</span></span>; s.CanBindByHttpCode = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre><br>  La derni√®re propri√©t√© indique s'il est possible de lier notre DTO par le code http. <br>  Vous pouvez √©galement sp√©cifier comment g√©rer les situations avec des exceptions internes, par exemple, TaskCanceledException avec une erreur interne enregistr√©e en raison de .Wait ().  Par exemple, voici un r√©solveur standard qui supprime les exceptions internes de ces exceptions et fonctionne d√©j√† avec elles: <br><br><pre> <code class="cs hljs"> s.InnerExceptionsResolver = InnerExceptionsResolvers.InspectAggregateException;</code> </pre><br>  Si vous devez affiner la s√©rialisation, vous pouvez d√©finir la m√©thode FilterAfterDTO.  Renvoyez true pour d√©sactiver le traitement standard et s√©rialiser errorContext.ErrorDTO comme vous le souhaitez.  Il y a acc√®s au HttpContext et √† l'erreur elle-m√™me. <br><br><pre> <code class="cs hljs"> s.FilterAfterDTO = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (errorContext) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//Custom error handling. Return true if MvcExceptionHandler must ignore current error, //because it was handled. return false; };</span></span></code> </pre><br><h2>  DeveloperExceptionPage et autres avantages du mode d√©bogage </h2><br>  Nous avons d√©termin√© les param√®tres. Voyons maintenant comment d√©boguer le tout.  Dans le prod DTO, la r√©ponse dans la r√©ponse est simple et je l'ai d√©j√† montr√© ci-dessus, maintenant je vais montrer √† quoi ressemble le m√™me DTO en mode d√©bogage: <br><br><img src="https://habrastorage.org/webt/da/yo/wf/dayowfdy5xfftmrpeg0czujz8os.png"><br><br>  Comme vous pouvez le voir, il y a beaucoup plus d'informations ici, il y a stackrace et demander des donn√©es.  Mais il est encore plus pratique de simplement suivre le lien dans le champ DebugUrl et d'afficher les donn√©es d'erreur sans forcer: <br><br><img src="https://habrastorage.org/webt/td/i3/ki/tdi3ki-kc-hr7s6umrlpx3txkci.jpeg"><br><br>  Il √©tait assez difficile de mettre en ≈ìuvre cette fonction,  DeveloperExceptionPage n'est tout simplement pas destin√© √† √™tre utilis√© par des d√©veloppeurs tiers.  Initialement, il √©tait impossible d'ouvrir le lien dans un navigateur avec une session diff√©rente, le contenu a cess√© d'√™tre affich√© apr√®s un red√©marrage.  Tout cela ne pourrait √™tre r√©solu qu'en mettant en cache la r√©ponse html de ce middlever.  Vous pouvez maintenant au moins transmettre le lien d'exception √† votre co√©quipier si vous utilisez un serveur d√©di√© partag√©. <br><br><h2>  Conclusion </h2><br>  J'esp√®re que les d√©veloppeurs qui ont lu cet article ont trouv√© un outil int√©ressant et utile pour eux-m√™mes.  Pour moi, cet article est en partie un test de l'utilit√© de ses d√©veloppements et articles sur eux.  J'ai des projets plus cool et pr√™ts √† l'emploi dont je voudrais parler √† la communaut√© Habr. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469731/">https://habr.com/ru/post/fr469731/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469707/index.html">Configuration de VSCode pour fonctionner avec Scala</a></li>
<li><a href="../fr469717/index.html">Que la lumi√®re brille</a></li>
<li><a href="../fr469721/index.html">Dell OptiPlex 7070 Ultra: un ordinateur modulaire qui transforme n'importe quel moniteur en monobloc</a></li>
<li><a href="../fr469723/index.html">Cr√©ation d'une comp√©tence avec √©tat pour Alice sur les fonctions sans serveur de Yandex.Cloud et Python</a></li>
<li><a href="../fr469725/index.html">Guide du syst√®me solaire pour les auto-stoppeurs</a></li>
<li><a href="../fr469735/index.html">Algorithme de calcul de la racine du ni√®me degr√© √† partir d'un nombre positif arbitraire</a></li>
<li><a href="../fr469737/index.html">Jouets en bois, cinqui√®me partie - 1991</a></li>
<li><a href="../fr469739/index.html">Jouets en bois, sixi√®me partie - 1992</a></li>
<li><a href="../fr469741/index.html">Celestia: les aventures des insectes dans l'espace</a></li>
<li><a href="../fr469743/index.html">Celestia: les aventures de bugs dans l'espace</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>