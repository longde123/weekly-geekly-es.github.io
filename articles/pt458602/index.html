<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§õüèª üö¥üèΩ üõ∏ Como perfuramos o grande firewall chin√™s (parte 1) üç£ üï∂Ô∏è üèÇüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! 


 Em contato, Nikita √© engenheira de sistemas da SEMrush . Hoje vou falar sobre como enfrentamos a tarefa de garantir a estabilidade de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como perfuramos o grande firewall chin√™s (parte 1)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/458602/"><p>  Ol√° pessoal! </p><br><p>  Em contato, Nikita √© engenheira de sistemas da <strong>SEMrush</strong> .  Hoje vou falar sobre como enfrentamos a tarefa de garantir a estabilidade de nosso servi√ßo semrush.com na China e quais problemas encontramos durante sua implementa√ß√£o (dada a localiza√ß√£o de nosso data center na costa leste dos EUA). </p><br><p>  Esta ser√° uma √≥tima hist√≥ria, dividida em v√°rios artigos.  Vou lhe contar como tudo aconteceu conosco: desde um servi√ßo completamente inoperante da China at√© o desempenho do servi√ßo no n√≠vel de sua vers√£o americana para americanos.  Eu prometo que ser√° interessante e √∫til.  Ent√£o vamos l√°. </p><br><img src="https://habrastorage.org/webt/cv/6s/sv/cv6ssvuv-od31op6cjnadtw6xsy.png"><br><h2 id="problemy-kitayskogo-interneta">  Problemas chineses na Internet </h2><br><p>  At√© a pessoa mais distante das especificidades da administra√ß√£o de rede pelo menos uma vez ouviu falar sobre o <strong>grande firewall chin√™s</strong> .  Isso parece legal, n√£o √©?  Mas o que √©, como realmente funciona √© uma quest√£o bastante complicada.  Na Internet, voc√™ pode encontrar muitos artigos sobre isso, mas do ponto de vista t√©cnico, o dispositivo desse firewall n√£o est√° descrito em nenhum lugar.  O que, no entanto, n√£o √© surpreendente.  Confesso imediatamente que, com base nos resultados do ano de trabalho, n√£o sei dizer exatamente como isso funciona, mas posso contar sobre meus coment√°rios e conclus√µes pr√°ticas.  E come√ßaremos com rumores sobre esse firewall. </p><a name="habracut"></a><br><p>  Existem muitos rumores sobre esse mesmo firewall.  Vamos reunir os principais e mais interessantes deles em uma lista: </p><br><ul><li>  Google, Facebook, Twitter e outros servi√ßos similares est√£o bloqueados e n√£o funcionam na China. </li><li>  Qualquer tr√°fego que sai da China e para a China √© analisado e limitado pelo aprendizado de m√°quina (no caso de tr√°fego suspeito), o que diminui bastante a velocidade (tr√°fego) que passa pela fronteira. </li><li>  As ag√™ncias de intelig√™ncia chinesas decifram qualquer tr√°fego criptografado que atravessa seu firewall. </li><li>  T√∫neis VPN, t√∫neis IPSEC s√£o inst√°veis, caem e s√£o constantemente bloqueados. </li><li>  Quanto mais simples a criptografia, mais simples a frase secreta usada para a codifica√ß√£o de autentica√ß√£o / tr√°fego, mais rapidamente ela passa pelo firewall chin√™s. </li></ul><br><p>  Aqui est√° o que conseguimos descobrir sobre esses rumores: </p><br><ul><li>  Google, Facebook, Twitter e outros servi√ßos similares est√£o realmente bloqueados (seu KO), mas muitos dom√≠nios t√©cnicos do Google, por exemplo, n√£o s√£o banidos e funcionam (o mesmo gstatic.com).  Isso leva √† conclus√£o: n√£o corte de forma imprudente todo o Google e outros recursos que parecem estar bloqueados, aparentemente bloqueados. </li><li>  Qualquer tr√°fego que atravessa a fronteira realmente adiciona um atraso s√©rio ao seu tempo.  Veja os dois resultados.  Um site, uma p√°gina, simples obter <em>curl</em> .  A primeira medi√ß√£o da pr√≥pria China (a bela cidade de Shenzhen).  A segunda congelou fora de Hong Kong (tem soberania e n√£o h√° firewall entre ela e o mundo).  A dist√¢ncia entre as cidades em uma linha reta √© de cerca de 30-40 km. </li></ul><br><pre><code class="bash hljs">nikita@china-shenzhen:~<span class="hljs-comment"><span class="hljs-comment"># curl -o /dev/null -w@curl_time "https://www.semrush.com/info/ebay.com" % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 381k 0 381k 0 0 71824 0 --:--:-- 0:00:05 --:--:-- 82832 time_namelookup: 0.004500 time_connect: 0.169342 time_appconnect: 0.723189 time_pretransfer: 0.723499 time_redirect: 0.000000 time_starttransfer: 1.532912 ---------- time_total: 5.443407 ---------- size_download: 390968 Bytes speed_download: 71824.000B/s nikita@china-hongkong:~# curl -o /dev/null -w@curl_time "https://www.semrush.com/info/ebay.com" % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 319k 0 319k 0 0 2555k 0 --:--:-- --:--:-- --:--:-- 2573k time_namelookup: 0.029366 time_connect: 0.030742 time_appconnect: 0.047310 time_pretransfer: 0.047388 time_redirect: 0.000000 time_starttransfer: 0.120793 ---------- time_total: 0.124871 ---------- size_download: 326755 Bytes speed_download: 2616740.000B/s</span></span></code> </pre> <br><p>  Preste aten√ß√£o ao <strong>time_connect</strong> .  E, em geral, voc√™ v√™ o resultado: o firewall adiciona 4 segundos extras, que s√£o monstruosamente longos. </p><br><ul><li>  VPNs e t√∫neis IPSEC caem com frequ√™ncia.  Falarei sobre isso um pouco mais tarde e com mais detalhes.  Os servidores VPN usados ‚Äã‚Äãpelos usu√°rios s√£o bloqueados ao longo do tempo (geralmente dentro de um dia ap√≥s o in√≠cio do uso). </li><li>  H√° uma opini√£o recebida de pessoas que vivem na China de que quanto mais f√°cil a criptografia do tr√°fego, mais r√°pido ele passa pela fronteira, porque √© f√°cil entender que n√£o h√° nada ilegal nela.  E assim como o tr√°fego "limpo" ganha mais largura de banda e velocidade, e o tr√°fego "sujo", que n√£o produz nada, recebe um passe mais lento, pelo contr√°rio.  Por exemplo, trarei curl para <em>ifconfig.co</em> usando os protocolos HTTPS e HTTP. </li></ul><br><pre> <code class="bash hljs">curl -o /dev/null -w@curl_time <span class="hljs-string"><span class="hljs-string">"https://ifconfig.co/"</span></span> % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 13 100 13 0 0 2 0 0:00:06 0:00:05 0:00:01 3 time_namelookup: 0.004305 time_connect: 0.397465 time_appconnect: 5.149305 time_pretransfer: 5.149393 time_redirect: 0.000000 time_starttransfer: 5.568847 ---------- time_total: 5.568893 ---------- size_download: 13 Bytes speed_download: 2.000B/s curl -o /dev/null -w@curl_time <span class="hljs-string"><span class="hljs-string">"http://ifconfig.co/"</span></span> % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 13 100 13 0 0 28 0 --:--:-- --:--:-- --:--:-- 28 time_namelookup: 0.004282 time_connect: 0.212457 time_appconnect: 0.000000 time_pretransfer: 0.212484 time_redirect: 0.000000 time_starttransfer: 0.450565 ---------- time_total: 0.450620 ---------- size_download: 13 Bytes speed_download: 28.000B/s</code> </pre> <br><p>  A diferen√ßa √© de 5 segundos para um tempo total de carregamento de 13 bytes.  Ao fazer esse teste v√°rias vezes, voc√™ pode ver que o GET on HTTP √© conclu√≠do em geral no mesmo hor√°rio, sempre, enquanto o HTTPS, o site √†s vezes responde em 3, 5, 10 e at√© 17 segundos.  √Äs vezes, ocorrem erros de SSL: </p><br><p> <code>Unknown SSL protocol error in connection to ifconfig.co:443.</code> </p> <br><p>  Ent√£o, o que temos: </p><br><ul><li>  Os problemas criados pelo firewall chin√™s descrito acima. </li><li>  Pings para recursos externos e t√∫neis internos desaparecem periodicamente. </li><li>  A lat√™ncia entre dois pontos est√° mudando constantemente, e muitas vezes √© simplesmente imprevis√≠vel.  Ao conectar diferentes cidades / regi√µes, voc√™ espera que, com base na localiza√ß√£o geogr√°fica das regi√µes, o atraso seja menor e voc√™ obtenha exatamente a situa√ß√£o oposta. </li><li>  Os canais de Internet e comunica√ß√£o s√£o r√°pidos ou lentos.  Existe uma ligeira depend√™ncia da hora do dia e do dia da semana, mas nem sempre. </li><li>  As consultas de DNS para o mundo exterior da China √†s vezes excedem o tempo limite permitido. </li></ul><br><p>  A imagem aparece simplesmente "excelente". </p><br><p>  O data center, como eu disse, fica no leste dos EUA, e todo o SEMrush consiste em dezenas de produtos interconectados, back-end, front-ends, bancos de dados e tudo isso no data center e nas nuvens.  Como uma equipe de administradores de sistema, fomos incumbidos de um pequeno esfor√ßo para come√ßar a trabalhar rapidamente na China. </p><br><p>  Tivemos que responder a uma pergunta importante: podemos sobreviver com um pouco de sangue e resolver todos os problemas associados √† Internet e firewall chineses no n√≠vel de rede / nuvem / servidor? </p><br><p>  Come√ßamos obtendo uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">licen√ßa <strong>ICP</strong></a> . </p><br><h2 id="icp-licenziya">  Licen√ßa ICP </h2><br><p>  Para poder colocar seu servi√ßo na China (China Continental) e realizar testes, voc√™ deve primeiro obter uma licen√ßa de dom√≠nio ICP. </p><br><p>  Se o tr√°fego do usu√°rio do seu site for encerrado na China continental e se o seu dom√≠nio n√£o tiver uma licen√ßa ICP, o tr√°fego ser√° bloqueado no lado do provedor / hospedagem.  Curiosamente, um provedor espec√≠fico se encaixa na licen√ßa do ICP, seja Cloudflare ou Alibaba Cloud.  Portanto, se voc√™ recebeu uma licen√ßa de ICP para Cloudflare e hospedou seu site com eles, n√£o poder√° migrar "sem interrup√ß√µes" para o Alibaba Cloud.  Ser√° necess√°rio adicionar mais uma hospedagem a esta licen√ßa. </p><br><p>  Tendo recebido uma licen√ßa de dom√≠nio ICP, pudemos criar e implementar id√©ias e solu√ß√µes t√©cnicas espec√≠ficas. </p><br><h2 id="testirovanie-resheniy">  Solu√ß√µes de teste </h2><br><p>  Por√©m, antes de criar diretamente as op√ß√µes de armazenamento tempor√°rio, girar os bot√µes, otimizar o site e sua velocidade, voc√™ precisa escolher uma ferramenta para test√°-lo para ver o que nossas a√ß√µes melhoram ou pioram o trabalho do site. </p><br><p>  Nossa ferramenta de teste precisava atender a dois requisitos principais: </p><br><ul><li>  ele deve poder executar testes da China, </li><li>  Ele deve ter testes de navegador. </li></ul><br><p>  Ent√£o encontramos o ponto de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">partida</a> !  Eles t√™m excelente cobertura com pontos de teste em todo o mundo.  Na China, por meio dessa ferramenta, voc√™ tamb√©m pode executar testes em 100.500 prov√≠ncias.  Em cada um, v√°rios fornecedores diferentes + a capacidade de fazer testes de <strong>Backbone</strong> (algo como uma m√°quina <strong>virtual</strong> em um data center) e testes de <strong>Lastmile</strong> (o mais pr√≥ximo poss√≠vel das condi√ß√µes do usu√°rio, tamb√©m conhecido como esta√ß√£o de trabalho).  O √∫ltimo tipo de teste √© mais caro. </p><br><p>  Tendo conclu√≠do um contrato de um ano (voc√™ n√£o pode fazer menos), come√ßamos a estudar a ferramenta.  Francamente, ficamos agradavelmente surpreendidos com a sua funcionalidade.  Voc√™ pode executar: </p><br><ul><li>  Testes de DNS </li><li>  Testes na Web (navegador, GET / POST simples, emula√ß√£o de um cliente m√≥vel, etc.), </li><li>  Verifica√ß√µes transacionais (por exemplo, login), </li><li>  Testes de API </li><li>  Ping, traceroute, NTP, etc. </li></ul><br><p>  Voc√™ n√£o pode listar tudo.  E o mais importante, cada teste pode ser bem personalizado, adicionando v√°rios cabe√ßalhos e outros par√¢metros.  A sa√≠da √© uma enorme quantidade de informa√ß√µes que descrevem completamente seu teste.  Se falamos do mais interessante para n√≥s (testes do navegador), o resultado inclui: </p><br><ul><li>  Conectar, Aguardar, Carregar, SSL, Hora DNS, </li><li>  TTFB, TTLB, Documento conclu√≠do, Tempo de renderiza√ß√£o, Carregamento DOM, </li><li>  Resposta (algo pr√≥ximo ao Tempo at√© o primeiro byte), Resposta da p√°gina da Web (algo pr√≥ximo ao Tempo at√© o √∫ltimo byte), </li><li>  Qualquer percentil, tempo m√©dio, mediano </li><li>  Etc. </li></ul><br><p>  Consequentemente, todas essas m√©tricas ajudam voc√™ a ver as altera√ß√µes e entender se elas se tornaram melhores.  Analisamos principalmente <strong>Resposta, Resposta da p√°gina da Web, mediana, percentis 75 e 95</strong> . </p><br><p>  Uma quest√£o importante que est√° no ar desde o in√≠cio: √© <strong>poss√≠vel acreditar no Catchpoint</strong> ?  Essa ferramenta reflete a velocidade real de carregamento do site na China de diferentes cidades ou √© apenas algum tipo de teste no v√°cuo que n√£o tem nada a ver com a experi√™ncia real do usu√°rio? <br>  Esse √© um grande problema, porque estar na R√∫ssia √© quase imposs√≠vel descobrir de maneira confi√°vel como o site da China funciona.  Ao fazer o proxy socks por meio de uma m√°quina virtual, voc√™ obt√©m um carregamento do site em alguns minutos no final, o que √© simplesmente inaceit√°vel para testes; portanto, a √∫nica op√ß√£o para testes manuais √© o GETs de curl e simples do console com medi√ß√£o de tempo.  Isso ajuda, porque esse teste reflete a velocidade da solu√ß√£o de rede e, se houver testes no navegador, √© muito bom. </p><br><p>  Mais tarde, fomos √† China e nos certificamos de que o <strong>Catchpoint √© confi√°vel, reflete com bastante precis√£o os indicadores reais de velocidade.</strong> </p><br><h2 id="cloudflare-china-network">  Cloudflare china network </h2><br><p>  Como usamos com sucesso o Cloudflare para o dom√≠nio principal semrush.com, decidimos experimentar imediatamente seu recurso chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">China Network</a> .  Esta op√ß√£o √© ativada apenas para sites corporativos mediante solicita√ß√£o e por uma taxa.  Tamb√©m est√° dispon√≠vel apenas para sites que possuem a licen√ßa ICP apropriada, na qual o Cloudflare √© especificado como provedor.  Ap√≥s sua inclus√£o, o ‚ÄúCDN chin√™s‚Äù do Cloudflare fica dispon√≠vel para o site - o tr√°fego das regi√µes chinesas chega ao pr√≥ximo CF de PoP (Points of Presence) e √© entregue √† origem por meio de suas redes ou redes de fornecedores / parceiros. </p><br><p>  O esquema desta bancada de testes √© apresentado abaixo. </p><br><img src="https://habrastorage.org/webt/zk/hw/um/zkhwumkneyyxkij6gdffhzcl6qw.png"><br><p>  Esta √© uma √≥tima op√ß√£o para n√≥s.  Acontece que o segundo dom√≠nio tamb√©m ser√° para CF, que n√£o adiciona o n√∫mero de solu√ß√µes usadas na empresa e praticamente n√£o complica a infraestrutura. </p><br><p>  Fizemos os testes do navegador e foi o que aconteceu: </p><br><img src="https://habrastorage.org/webt/cs/wo/hp/cswohpvoexjj3nanyzxloxk2poo.png"><br><p>  Diamantes vermelhos s√£o arquivos de teste.  Os arquivos abaixo s√£o erros de DNS (resolvem o tempo limite).  As falhas acima s√£o tempos limite. </p><br><p>  <em>Tempo de atividade: 86,6</em> <em><br></em>  <em>Mediana: 18s</em> <em><br></em>  <em>75 Percentil: 29.3s</em> <em><br></em>  <em>95 Percentil: 60s</em> </p><br><p>  A mediana, ap√≥s <em>remover o</em> download <em>do reCaptcha</em> (um servi√ßo do <em>Google</em> bloqueado na China), caiu de 28 para 18 segundos.  Mesmo assim, esses s√£o indicadores terr√≠veis, j√° que o mesmo teste para semrush.com (dos EUA) deu menos de 10 segundos para 95% dos usu√°rios (dos EUA) na mesma p√°gina (est√°tica + din√¢mica). </p><br><p>  Em cada teste, voc√™ pode ver o <em>Waterfall</em> e outros par√¢metros mais detalhados.  Come√ßamos a investigar as causas dos erros e, se o tempo limite for menor ou menos claro: a Internet na China ‚Äúest√° diminuindo e depois se afastando‚Äù; por isso, a velocidade de conex√£o e carregamento de recursos do exterior √© inst√°vel e desigual; os erros de DNS nos surpreenderam bastante. .  Descobrimos que os PoPs da Cloudflare est√£o localizados na China, o endere√ßo do site √© resolvido para um √∫nico IP anycast, mas os servidores DNS s√£o usados ‚Äã‚Äãpelos EUA, e √© por isso que as consultas DNS s√£o for√ßadas a atravessar a fronteira e, √†s vezes, falham. </p><br><p>  Depois de esclarecer essa pergunta com a CF, verificou-se que <strong>eles n√£o t√™m seus pr√≥prios servidores DNS na China</strong> e ainda n√£o se sabe quando ser√°. </p><br><p>  Portanto, decidimos testar apenas o DNS do Cloudflare e alteramos o mecanismo do Cloudflare do nosso site para o modo " <strong>Somente DNS</strong> ".  Esse √© o modo quando o Cloudflare n√£o faz proxy do tr√°fego por si mesmo, o que significa que ele n√£o fornece prote√ß√£o DDoS, CDN e outros recursos e funciona no modo de um servidor DNS normal. </p><br><p>  Este suporte √© mostrado esquematicamente na figura a seguir.  A figura leva em considera√ß√£o o conhecimento emergente de que o servidor DNS do Cloudflare est√° atr√°s do firewall. </p><br><img src="https://habrastorage.org/webt/ac/w0/r7/acw0r7fgqahq9w2kckq6-myxjky.png"><br><p>  No Catchpoint, executamos testes GET simples (sem navegador) que mostravam muitas falhas.  A raz√£o para eles foram os mesmos erros de DNS. </p><br><img src="https://habrastorage.org/webt/_w/3c/wu/_w3cwuxv8j9tdeuvp20jblktqoi.png"><br><p>  Come√ßamos a depurar esses erros usando <em>dig</em> e descobrimos que o endere√ßo √© determinado corretamente na primeira solicita√ß√£o e, mediante solicita√ß√£o repetida, obtemos <em>SERVFAIL</em> e <em>n√£o √© encontrado a</em> cada vez.  De repente, o que √© isso? </p><br><pre> <code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"><span class="hljs-comment"># host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL) root@iZwz97n2wgbp61qucbfrjsZ:~# host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL) root@iZwz97n2wgbp61qucbfrjsZ:~# host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL) root@iZwz97n2wgbp61qucbfrjsZ:~# host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL)</span></span></code> </pre> <br><p>  Ao solicitar servidores Cloudflare NS diretamente, n√£o existem tais erros: </p><br><pre> <code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"><span class="hljs-comment"># for i in `seq 1 2`; do host semrushchina.cn ray.ns.cloudflare.com.; done Using domain server: Name: ray.ns.cloudflare.com. Address: 173.245.59.138#53 Aliases: semrushchina.cn has address 220.170.186.192 semrushchina.cn has address 220.170.186.192 Using domain server: Name: ray.ns.cloudflare.com. Address: 173.245.59.138#53 Aliases: semrushchina.cn has address 220.170.186.192 semrushchina.cn has address 220.170.186.192</span></span></code> </pre> <br><p>  Isso significa que o problema est√° do lado do servidor DNS "local" ou do servidor provedor. <br>  Investiga√ß√µes posteriores mostraram que obtemos o <em>SERVFAIL</em> na resolu√ß√£o do registro <em>AAAA</em> . </p><br><p>  Aconteceu que, quando o Cloudflare solicitou um registro <em>AAAA</em> que n√£o estava no dom√≠nio, o Cloudflare respondeu com um registro <em>A</em> , que √© um erro e incompatibilidade RFC.  Por esse <em>motivo,</em> o resolvedor local ( <em>xxxx</em> ) n√£o gostou disso e respondeu <em>SERVFAIL</em> .  No log abaixo, esse comportamento √© claramente vis√≠vel: </p><br><pre> <code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"><span class="hljs-comment"># dig -t AAAA semrushchina.cn @xxxx ; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; -t AAAA semrushchina.cn @xxxx ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 55467 ;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;semrushchina.cn. IN AAAA ;; Query time: 334 msec ;; SERVER: xxxx#53(xxxx) ;; WHEN: Tue Aug 14 23:38:50 CST 2018 ;; MSG SIZE rcvd: 44 root@iZwz97n2wgbp61qucbfrjsZ:~# dig -t AAAA semrushchina.cn @dana.ns.cloudflare.com. ; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; -t AAAA semrushchina.cn @dana.ns.cloudflare.com. ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 63944 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 512 ;; QUESTION SECTION: ;semrushchina.cn. IN AAAA ;; ANSWER SECTION: semrushchina.cn. 300 IN A 220.170.186.192 ;; Query time: 185 msec ;; SERVER: 173.245.58.105#53(173.245.58.105) ;; WHEN: Tue Aug 14 23:43:03 CST 2018 ;; MSG SIZE rcvd: 60</span></span></code> </pre><br><p>  Enviamos um relat√≥rio de bug do Cloudflare, que foi corrigido depois de um tempo.  Acabou sendo interessante: no momento, ainda n√£o h√° suporte para IPv6 na China; portanto, o Cloudflare n√£o p√¥de fornecer seu endere√ßo IPv6 em resposta a uma solicita√ß√£o de um registro <em>AAAA</em> .  No final, tudo foi decidido para que a China Cloudflare come√ßasse a responder a <em>NODATA</em> a esses pedidos. </p><br><p>  Portanto, os erros de DNS nos testes do Catchpoint diminu√≠ram drasticamente, mas n√£o at√© o fim.  Os tempos limite tamb√©m n√£o desapareceram: </p><br><img src="https://habrastorage.org/webt/u5/i7/fj/u5i7fjgo6pb9fl4mddq27uhk9lo.png"><br><p>  E come√ßamos a procurar outra solu√ß√£o. </p><br><p>  Na pr√≥xima parte, mostrarei como testamos a <strong>nuvem</strong> chinesa <strong>Alibaba</strong> , como, com a ajuda de um pouco de Nginx "m√°gico", conseguimos criar rapidamente solu√ß√µes PoC (Prova de Conceito), como criamos solu√ß√µes Multi-Cloud, uma das quais, em √∫ltima an√°lise, ajudou muito acelerar o servi√ßo da China. </p><br><p>  <strong>Fique atento!</strong> </p><br><h3 id="vse-chasti">  Todas as pe√ßas </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 3</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt458602/">https://habr.com/ru/post/pt458602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt458576/index.html">Gerenciamento e localiza√ß√£o de texto em um aplicativo Web</a></li>
<li><a href="../pt458594/index.html">N√£o se esque√ßa de aumentar a chance de uma resposta ao cliente usando uma solicita√ß√£o repetida no balanceamento L7</a></li>
<li><a href="../pt458596/index.html">Petty little joy # 6: OpenAI Gym - jogue jogos e controle de rob√¥s</a></li>
<li><a href="../pt458598/index.html">Reconhecimento de fontes de luz em mapas ambientais</a></li>
<li><a href="../pt458600/index.html">O que s√£o bicicletas el√©tricas (revis√£o em grupo em duas partes de cinco modelos de dois fabricantes), parte 1</a></li>
<li><a href="../pt458604/index.html">Por que os dois maiores fabricantes de eletr√¥nicos uniram for√ßas em um novo projeto de GPU</a></li>
<li><a href="../pt458606/index.html">Execute o OpenVPN no Docker em 2 segundos</a></li>
<li><a href="../pt458608/index.html">Ferramentas de desenvolvedor do Node.js. Fila de tarefas</a></li>
<li><a href="../pt458612/index.html">Cosmos. 7 anos</a></li>
<li><a href="../pt458614/index.html">Criando um gancho UsePosition () reativo para obter e rastrear coordenadas do navegador</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>