<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙇🏻 🤖 👯 RxJava nach Coroutines: End-to-End-Feature-Migration 👋🏻 🥀 👩🏿‍🤝‍👩🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(ursprünglich auf Medium veröffentlicht ) 

 Kotlin-Coroutinen sind viel mehr als nur leichte Fäden - sie sind ein neues Paradigma, das Entwicklern hi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RxJava nach Coroutines: End-to-End-Feature-Migration</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483832/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/jb/id/pq/jbidpqpivwqpagw9azop_fswram.png" alt="Bild"></div><br>  (ursprünglich auf <a href="https://link.medium.com/OJ7ed2RCd3" rel="nofollow">Medium veröffentlicht</a> ) <br><br>  Kotlin-Coroutinen sind viel mehr als nur leichte Fäden - sie sind ein neues Paradigma, das Entwicklern hilft, <a href="https://medium.com/%40elizarov/structured-concurrency-722d765aa952" rel="nofollow">strukturiert</a> und idiomatisch mit Parallelität umzugehen. <br><br>  Bei der Entwicklung einer Android-App sollten viele verschiedene Aspekte berücksichtigt werden: Entfernen lang laufender Vorgänge aus dem Benutzeroberflächenthread, Behandeln von Lebenszyklusereignissen, Kündigen von Abonnements und Zurückschalten zum Benutzeroberflächenthread, um die Benutzeroberfläche zu aktualisieren.  In den letzten Jahren hat sich RxJava zu einem der am häufigsten verwendeten Frameworks entwickelt, um diese Problematik zu lösen.  In diesem Artikel werde ich Sie durch die End-to-End-Feature-Migration von RxJava zu Coroutinen führen. <br><a name="habracut"></a><br><h4>  Feature </h4><br>  Die Funktion, die wir in Coroutinen konvertieren werden, ist recht einfach: Wenn der Benutzer ein Land einreicht, rufen wir eine API auf, um zu prüfen, ob das Land für die Suche nach Geschäftsdetails über einen Anbieter wie <a href="https://www.gov.uk/government/organisations/companies-house" rel="nofollow">Companies House</a> geeignet ist.  Wenn der Anruf erfolgreich war, zeigen wir die Antwort, wenn nicht - die Fehlermeldung. <br><br><h4>  Migration </h4><br><img src="https://habrastorage.org/webt/j0/0h/kg/j00hkgwjgnuwnzz4lsgdf5ry_fa.png" align="left"><br>  Wir werden unseren Code in einem Bottom-up-Ansatz migrieren, beginnend mit dem Retrofit-Service, über einen Repository-Layer bis zu einem Interactor-Layer und schließlich zu einem ViewModel. <br><br>  Funktionen, die derzeit Single zurückgeben, sollten zu Suspending-Funktionen werden, und Funktionen, die Observable zurückgeben, sollten Flow zurückgeben.  In diesem speziellen Beispiel werden wir nichts mit Flows anfangen. <br><br><h4>  Nachrüstservice </h4><br>  Lassen Sie uns direkt in den Code springen und die businessLookupEligibility-Methode in BusinessLookupService an Coroutinen anpassen.  So sieht es jetzt aus. <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: Single&lt;NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt;&gt; }</code> </pre> <br>  Refactoring-Schritte: <br><br><ol><li>  Ab <a href="" rel="nofollow">Version 2.6.0</a> unterstützt Retrofit den Suspend-Modifier.  Lassen Sie uns die businessLookupEligibility-Methode in eine Suspending-Funktion umwandeln. </li><li>  Entfernen Sie die Einzelverpackung aus dem Rückgabetyp. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt; }</code> </pre><br>  NetworkResponse ist eine versiegelte Klasse, die BusinessLookupEligibilityResponse oder ErrorResponse darstellt.  NetworkResponse wird in einem benutzerdefinierten Retrofit-Anrufadapter erstellt.  Auf diese Weise beschränken wir den Datenfluss auf nur zwei mögliche Fälle - Erfolg oder Fehler, sodass sich die Benutzer von BusinessLookupService nicht um die Ausnahmebehandlung kümmern müssen. <br><br><h4>  Repository </h4><br>  Gehen wir weiter und sehen, was wir in BusinessLookupRepository haben.  Im Methodenrumpf von businessLookupEligibility rufen wir businessLookupService.businessLookupEligibility (den gerade überarbeiteten) auf und verwenden den RxJava-Kartenoperator, um NetworkResponse in ein Ergebnis- und Kartenantwortmodell in ein Domänenmodell umzuwandeln.  Result ist eine weitere versiegelte Klasse, die Result.Success darstellt und das Objekt BusinessLookupEligibility enthält, falls der Netzwerkaufruf erfolgreich war.  Wenn beim Netzwerkaufruf ein Fehler aufgetreten ist, eine <a href="https://kotlinlang.org/docs/reference/type-aliases.html" rel="nofollow">Deserialisierungsausnahme</a> aufgetreten ist oder etwas anderes schief gelaufen ist, <a href="https://kotlinlang.org/docs/reference/type-aliases.html" rel="nofollow">erstellen</a> wir Result.Failure mit einer aussagekräftigen Fehlermeldung (ErrorMessage ist ein <a href="https://kotlinlang.org/docs/reference/type-aliases.html" rel="nofollow">typischer Alias</a> für String). <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> businessLookupService.businessLookupEligibility(countryCode) .map { response -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@map</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (response) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } }.subscribeOn(schedulerProvider.io()) } }</code> </pre><br>  Refactoring-Schritte: <br><br><ol><li>  businessLookupEligibility wird zu einer Suspend-Funktion. </li><li>  Entfernen Sie die Einzelverpackung aus dem Rückgabetyp. </li><li>  Methoden im Repository führen normalerweise lang andauernde Aufgaben wie Netzwerkaufrufe oder Datenbankabfragen aus.  Es liegt in der Verantwortung des Repository, anzugeben, auf welchem ​​Thread diese Arbeit durchgeführt werden soll.  Mit subscribeOn (schedulerProvider.io ()) teilen wir RxJava mit, dass am io-Thread gearbeitet werden soll.  Wie könnte dasselbe mit Koroutinen erreicht werden?  Wir werden withContext mit einem bestimmten Dispatcher verwenden, um die Ausführung des Blocks auf den anderen Thread und zurück zum ursprünglichen Dispatcher zu verschieben, wenn die Ausführung abgeschlossen ist.  Es wird empfohlen, mithilfe von withContext sicherzustellen, dass eine Funktion main-safe ist.  Benutzer von BusinessLookupRepository sollten nicht darüber nachdenken, welchen Thread sie zum Ausführen der businessLookupEligibility-Methode verwenden sollen. Es sollte sicher sein, ihn vom Hauptthread aus aufzurufen. </li><li>  Wir brauchen den Kartenoperator nicht mehr, da wir das Ergebnis von businessLookupService.businessLookupEligibility in einem Body einer Suspend-Funktion verwenden können. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dispatcherProvider: DispatcherProvider ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = withContext(dispatcherProvider.io) { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response = businessLookupService.businessLookupEligibility(countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } } }</code> </pre><br><h4>  Interakteur </h4><br>  In diesem speziellen Beispiel enthält BusinessLookupEligibilityInteractor keine zusätzliche Logik und dient als Proxy für BusinessLookupRepository.  Wir verwenden die <a href="https://kotlinlang.org/docs/reference/operator-overloading.html" rel="nofollow">Überladung von</a> Aufrufoperatoren <a href="https://kotlinlang.org/docs/reference/operator-overloading.html" rel="nofollow">,</a> damit der Interaktor als Funktion aufgerufen werden kann. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br>  Refactoring-Schritte: <br><br><ol><li>  Der Operator-Fun-Aufruf wird zum Suspend-Operator-Fun-Aufruf. </li><li>  Entfernen Sie die Einzelverpackung aus dem Rückgabetyp. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br><h4>  ViewModel </h4><br>  In BusinessProfileViewModel rufen wir BusinessLookupEligibilityInteractor auf, der Single zurückgibt.  Wir abonnieren den Stream und beobachten ihn im UI-Thread, indem wir den UI-Scheduler angeben.  Im Erfolgsfall weisen wir den Wert aus einem Domain-Modell einem businessViewState LiveData zu.  Im Fehlerfall weisen wir eine Fehlermeldung zu. <br><br>  Wir fügen jedes Abonnement einem CompositeDisposable hinzu und entsorgen sie in der onCleared () -Methode eines ViewModel-Lebenszyklus. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> disposables = CompositeDisposable() <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { disposables.add(businessLookupEligibilityInteractor(country.countryCode) .observeOn(schedulerProvider.ui()) .subscribe { state -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@subscribe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } }) } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void onCleared() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCleared(); disposables.clear(); } }</code> </pre><br>  Refactoring-Schritte: <br><br><ol><li>  Am Anfang des Artikels habe ich einen der Hauptvorteile von Koroutinen erwähnt - strukturierte Parallelität.  Und hier kommt es ins Spiel.  Jede Koroutine hat ein Zielfernrohr.  Der Scope hat über seinen Job die Kontrolle über eine Coroutine.  Wenn ein Auftrag abgebrochen wird, werden auch alle Coroutinen im entsprechenden Bereich abgebrochen.  Es steht Ihnen frei, Ihre eigenen Bereiche zu erstellen. In diesem Fall setzen wir jedoch den ViewModel-lebenszyklusorientierten ViewModelScope ein.  Wir werden eine neue Coroutine in einem viewModelScope mit viewModelScope.launch starten.  Die Coroutine wird im Haupt-Thread gestartet, da viewModelScope einen Standard-Dispatcher hat - Dispatchers.Main.  Auf Dispatchern wurde eine Coroutine gestartet. Main blockiert den Haupt-Thread nicht, solange er angehalten ist.  Da wir gerade eine Coroutine gestartet haben, können wir den Operator businessLookupEligibilityInteractor aufrufen, um das Ergebnis zu erhalten.  businessLookupEligibilityInteractor ruft BusinessLookupRepository.businessLookupEligibility auf, wodurch die Ausführung zu Dispatchers.IO und zurück zu Dispatchers.Main verschoben wird.  Da wir uns im UI-Thread befinden, können wir businessViewState LiveData aktualisieren, indem wir einen Wert zuweisen. </li><li>  Wir können Einwegartikel loswerden, da viewModelScope an einen ViewModel-Lebenszyklus gebunden ist.  Jede in diesem Bereich gestartete Coroutine wird automatisch abgebrochen, wenn das ViewModel gelöscht wird. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { viewModelScope.launch { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> state = businessLookupEligibilityInteractor(country.countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } } } }</code> </pre><br><h4>  Schlüssel zum Mitnehmen </h4><br>  Das Lesen und Verstehen von Code, der mit Coroutinen geschrieben wurde, ist recht einfach. Dennoch ist es ein Paradigmenwechsel, der einige Anstrengungen erfordert, um zu lernen, wie man mit Coroutinen Code schreibt. <br><br>  In diesem Artikel habe ich das Testen nicht behandelt.  Ich habe die <a href="https://mockk.io/" rel="nofollow">Mockk-</a> Bibliothek benutzt, da ich Probleme hatte, Coroutinen mit Mockito zu testen. <br><br>  Alles, was ich mit Rx Java geschrieben habe, war mit Coroutinen, <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html" rel="nofollow">Flows</a> und <a href="https://kotlinlang.org/docs/reference/coroutines/channels.html" rel="nofollow">Channels</a> ziemlich einfach zu implementieren.  Einer der Vorteile von Koroutinen ist, dass sie ein Merkmal der Kotlin-Sprache sind und sich zusammen mit der Sprache entwickeln. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483832/">https://habr.com/ru/post/de483832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de483822/index.html">5 JavaScript-Funktionen, ohne die ich keinen Code schreiben könnte</a></li>
<li><a href="../de483824/index.html">Wie Sie die Arbeit Ihrer Träume erreichen, positiv denken und vorankommen, nachdem Sie meine fünf Regeln studiert haben ...</a></li>
<li><a href="../de483826/index.html">Anschließen eines CO2-Sensors Modell MH-Z19B über den analogen Vo-Ausgang</a></li>
<li><a href="../de483828/index.html">Glanz und Armut Atomtausch</a></li>
<li><a href="../de483830/index.html">Routing für iOS: Universelle Navigation ohne Umschreiben der Anwendung</a></li>
<li><a href="../de483834/index.html">Debian: einfach i386 in amd64 verwandeln</a></li>
<li><a href="../de483842/index.html">Die Entstehungsgeschichte einer Home Cloud. Teil 5. Aktualisierung 2019 - PHP 7.2, MariaDB 10.4 und Nextcloud 17</a></li>
<li><a href="../de483844/index.html">Analyse von Regulierungsdokumenten zum Informationsschutz im russischen Kredit- und Finanzsektor</a></li>
<li><a href="../de483846/index.html">Alternative Fensterverwaltung unter Linux</a></li>
<li><a href="../de483850/index.html">Keine Götter verbrennen Töpfe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>