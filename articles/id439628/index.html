<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“’ ğŸ–ğŸ¼ ğŸ’˜ Refresh data paralel di ASP.NET Web API ğŸ° ğŸ“ ğŸ“œ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya ingin memberi tahu Anda bagaimana kami mengatur pembaruan data latar belakang selama permintaan ke layanan REST. 

 Tugasnya adalah sebagai berik...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Refresh data paralel di ASP.NET Web API</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439628/">  Saya ingin memberi tahu Anda bagaimana kami mengatur pembaruan data latar belakang selama permintaan ke layanan REST. <br><br>  Tugasnya adalah sebagai berikut: sistem menyimpan data pengguna.  Layanan ini bekerja secara terpisah dan tidak memiliki akses langsung ke database dengan data ini.  Agar layanan dapat berfungsi, perlu untuk memiliki nama dan nama keluarga pengguna di basis data internal.  Mereka dapat diperoleh dari Identitas pengguna saat ini pada saat permintaan.  Diperlukan untuk menambah atau memperbarui nama selama setiap permintaan.  Dianjurkan untuk menerapkan ini di utas terpisah sehingga pekerjaan ini tidak mempengaruhi waktu eksekusi permintaan utama. <br><a name="habracut"></a><br><h2>  Penyempurnaan tugas </h2><br>  Dalam basis data layanan, kami menyimpan nama dan nama keluarga pengguna.  Pelanggan membutuhkan mereka untuk informasi tentang siapa yang membuat atau memodifikasi sumber daya. <br><br>  Data ini tidak signifikan secara sistemik: jika tiba-tiba dalam database tidak ada catatan yang diperlukan, tidak ada hal buruk yang akan terjadi.  Oleh karena itu, kami tidak ingin mendaftarkan pekerjaan latar belakang kami di ASP menggunakan QueueBackgroundWorkItem, untuk mempersulit pemuatan berlebih dari domain aplikasi. <br>  Dianjurkan untuk memecahkan masalah sesederhana mungkin. <br><br>  Bagi mereka yang ingin mempelajari lebih lanjut tentang tugas-tugas latar belakang di ASP.NET, saya menyarankan Anda untuk membaca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel yang bagus</a> tentang hal itu. <br><br><h2>  Solusi </h2><br>  Kami memiliki kelas DbRefresher yang menambahkan atau mengubah data pengguna dalam metode RefreshAsync. <br><br>  Pengontrol kami menggunakan atribut Otorisasi.  Tambahkan keturunan kami ke kelas ini dan timpa metode OnAuthorization: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAuthorization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionContext actionContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnAuthorization(actionContext); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsAuthorized(actionContext)) DbRefresher.RefreshAsync(actionContext.RequestContext.Principal) .ContinueWith(t =&gt; { LogFactory.For&lt;AuthorizeAndRefreshUserAttribute&gt;() .ErrorException(<span class="hljs-string"><span class="hljs-string">"Error occured"</span></span>, t.Exception); }, TaskContinuationOptions.OnlyOnFaulted); }</code> </pre> <br>  DbRefresher.RefreshAsync adalah metode asinkron yang mengembalikan objek tugas yang terus dieksekusi di utas lainnya.  Metode OnAuthorize segera keluar tanpa menunggu tugas selesai.  Jika terjadi kerusakan, pesan kesalahan akan ditambahkan ke log. <br><br>  Itu saja: yang tersisa hanyalah mengganti atribut Otorisasi di controller dengan nama atribut baru kami.  Atribut baru mengembalikan kontrol segera setelah memeriksa hak-hak pengguna saat ini, setelah itu controller mulai bekerja.  Basis data akan diperbarui secara paralel dengan persiapan respons oleh pengontrol. <br><br><h2>  Pengujian </h2><br>  Tes yang menjalankan beberapa permintaan layanan simultan akan membantu mengidentifikasi kemungkinan masalah: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConcurrentTest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> threadCount = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Task[threadCount]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; threadCount; i++) { <span class="hljs-comment"><span class="hljs-comment">// DoOperations contains several CRUD operations on resources tasks[i] = Task.Factory.StartNew(DoOperations); } Task.WaitAll(tasks); }</span></span></code> </pre> <br><h2>  Masalahnya </h2><br>  Jika untuk pengoperasian beberapa metode tindakan dari pengontrol, diperlukan bahwa database jelas berisi data pengguna saat ini, pendekatan ini tidak cocok.  Anda harus menggunakan panggilan eksplisit ke DbRefresher.RefreshAsync di badan metode. <br><br>  Mungkin ada masalah saat menambahkan pengguna baru ke database dengan beberapa permintaan simultan.  Jika ada upaya untuk menambahkan pengguna ke tabel dengan kunci yang ada, Anda harus menangkap pengecualian pelanggaran kunci utama dan berhenti bekerja.  Kemudian semua pekerjaan memperbarui data pengguna akan dilakukan hanya dengan satu utas. <br><br><h2>  Kesimpulan </h2><br>  Pendekatan ini telah berhasil bekerja di salah satu layanan kami di Konfermit selama lebih dari setahun. <br>  Bagiku sederhana dan elegan.  Akan menarik untuk mengetahui pendapat masyarakat. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id439628/">https://habr.com/ru/post/id439628/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id439616/index.html">Intisari proyek-proyek TI yang menarik di Kickstarter No. 7</a></li>
<li><a href="../id439618/index.html">PHP untuk pemula. Koneksi file</a></li>
<li><a href="../id439620/index.html">Memahami Asynchrony dalam JavaScript [Terjemahan dari Sukhjinder Arora]</a></li>
<li><a href="../id439624/index.html">Mengapa menyimpan data dalam orbit</a></li>
<li><a href="../id439626/index.html">Pengalaman mengembangkan aplikasi gratis untuk kolektor OpenNumismat</a></li>
<li><a href="../id439632/index.html">Cara mengatur Penerapan Berkelanjutan untuk proyek Anda: pengalaman pribadi</a></li>
<li><a href="../id439636/index.html">Krisis konsep untuk meningkatkan keselamatan jalan dan konsep baru untuk menyelesaikannya</a></li>
<li><a href="../id439638/index.html">Mendapatkan FPGA dengan Python</a></li>
<li><a href="../id439640/index.html">Vinyl kembali dan dia berbeda</a></li>
<li><a href="../id439642/index.html">Perangkap Jawa. Bagian 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>