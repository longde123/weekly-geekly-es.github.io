<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ°Ô∏è üßïüèΩ üôåüèº PVS-Studio in den Clouds - Ausf√ºhren der Analyse auf Travis CI ü§ö üöæ üöã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Derzeit sind Cloud-CI-Systeme ein sehr gefragter Dienst. In diesem Artikel erfahren Sie, wie Sie die Analyse des Quellcodes in eine CI-Cloud-Plattform...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PVS-Studio in den Clouds - Ausf√ºhren der Analyse auf Travis CI</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/458064/">  Derzeit sind Cloud-CI-Systeme ein sehr gefragter Dienst.  In diesem Artikel erfahren Sie, wie Sie die Analyse des Quellcodes in eine CI-Cloud-Plattform mit den Tools integrieren, die bereits in PVS-Studio verf√ºgbar sind.  Als Beispiel verwenden wir den Travis CI-Dienst. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee1/252/191/ee125219104f0ff7d27f8c9dfc2db8bf.png" alt="Bild 1"></div><br><a name="habracut"></a><br>  Warum betrachten wir Clouds von Drittanbietern und erstellen keine eigenen?  Es gibt eine Reihe von Gr√ºnden, der Hauptgrund ist, dass die SaaS-Implementierung ein ziemlich teures und schwieriges Verfahren ist.  Tats√§chlich ist es eine einfache und triviale Aufgabe, die PVS-Studio-Analyse direkt in eine Cloud-Plattform eines Drittanbieters zu integrieren - unabh√§ngig davon, ob es sich um offene Plattformen wie CircleCI, Travis CI, GitLab oder eine bestimmte Unternehmensl√∂sung handelt, die nur in einem bestimmten Unternehmen verwendet wird.  Daher k√∂nnen wir sagen, dass PVS-Studio bereits "in den Clouds" verf√ºgbar ist.  Ein weiteres Problem ist die Implementierung und Sicherstellung des Zugriffs auf die Infrastruktur rund um die Uhr.  Dies ist eine kompliziertere Aufgabe.  PVS-Studio wird keine eigene Cloud-Plattform direkt f√ºr die Analyse bereitstellen. <br><br><h2>  Einige Informationen zur verwendeten Software </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Travis CI</a> ist ein Dienst zum Erstellen und Testen von Software, die GitHub als Speicher verwendet.  Travis CI erfordert keine √Ñnderung des Programmcodes f√ºr die Nutzung des Dienstes.  Alle Einstellungen werden in der Datei <i>.travis.yml vorgenommen, die</i> sich im Stammverzeichnis des Repositorys befindet. <br><br>  Wir nehmen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LXC</a> (Linux Containers) als Testprojekt f√ºr PVS-Studio.  Es ist ein Virtualisierungssystem auf Betriebssystemebene zum Starten mehrerer Instanzen des Linux-Betriebssystems auf einem Knoten. <br><br>  Das Projekt ist klein, aber mehr als genug f√ºr Demonstrationen.  Ausgabe des Befehls cloc: <br><div class="scrollable-table"><table><tbody><tr><td>  Sprache <br></td><td>  Dateien <br></td><td>  leer <br></td><td>  Kommentar <br></td><td>  Code <br></td></tr><tr><td>  C. <br></td><td>  124 <br></td><td> 11937 <br></td><td>  6758 <br></td><td>  50836 <br></td></tr><tr><td>  C / C ++ - Header <br></td><td>  65 <br></td><td>  1117 <br></td><td>  3676 <br></td><td>  3774 <br></td></tr></tbody></table></div>  <b>Hinweis:</b> LXC-Entwickler verwenden Travis CI bereits, daher nehmen wir ihre Konfigurationsdatei als Grundlage und bearbeiten sie f√ºr unsere Zwecke. <br><br><h2>  Konfiguration </h2><br>  Um mit Travis CI zu arbeiten, folgen wir dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> und melden uns mit einem GitHub-Konto an. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ba/8fc/c5a/1ba8fcc5a0caf41da255093cf4feaa8e.png" alt="Bild 17"></div><br>  Im ge√∂ffneten Fenster m√ºssen wir uns bei Travis CI anmelden. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/aec/13d/2d7aec13dec45022c952ff0498a6acae.png" alt="Bild 16"></div><br>  Nach der Autorisierung wird auf die Begr√º√üungsseite "Zum ersten Mal hier?" Weitergeleitet.  Lass uns anfangen! ‚Äú  <b>,</b> wo wir eine kurze Beschreibung finden, was danach getan werden muss, um loszulegen: <br><br><ul><li>  Aktivieren Sie die Repositorys. </li><li>  F√ºgen Sie die Datei .travis.yml im Repository hinzu. </li><li>  Starten Sie den ersten Build. </li></ul><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/29c/17f/c83/29c17fc830db9fad9d6d9dcb7fa047d7.png" alt="Bild 18"></div><br>  Beginnen wir mit diesen Aktionen. <br><br>  Um unser Repository in Travis CI hinzuzuf√ºgen, gehen wir √ºber den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> zu den Profileinstellungen und klicken auf "Aktivieren". <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab8/1f7/75e/ab81f775edc51c92b3238bf30b40527d.png" alt="Bild 19"></div><br>  Nach dem Klicken wird ein Fenster ge√∂ffnet, in dem Repositorys ausgew√§hlt werden, auf die die Travis CI-App Zugriff erh√§lt. <br><br>  <b>Hinweis:</b> Um Zugriff auf das Repository zu erhalten, muss Ihr Konto √ºber Administratorrechte verf√ºgen. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/4fe/351/1e84fe351a57fcff37b5b70ec77e9cc5.png" alt="Bild 38"></div><br>  Danach w√§hlen wir das richtige Repository aus, best√§tigen die Auswahl mit der Schaltfl√§che "Genehmigen und installieren" und wir werden zur√ºck zur Seite mit den Profileinstellungen weitergeleitet. <br><br>  F√ºgen wir einige Variablen hinzu, mit denen wir die Lizenzdatei des Analysators erstellen und seine Berichte senden.  Dazu gehen wir zur Einstellungsseite - der Schaltfl√§che "Einstellungen" rechts neben dem ben√∂tigten Repository. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d35/f44/907/d35f449074bd079c1b35140dd8336173.png" alt="Bild 39"></div><br>  Das Einstellungsfenster wird ge√∂ffnet. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cfe/c5f/1a8/cfec5f1a8ea19bf2c6e9e63c7af4c68c.png" alt="Bild 41"></div><br>  Kurze Beschreibung der Einstellungen; <br><br><ul><li>  Abschnitt "Allgemein" - Konfigurieren von Autostart-Task-Triggern; </li><li>  Im Abschnitt "Automatische Stornierung" k√∂nnen Sie die automatische Stornierung des Builds konfigurieren. </li><li>  Im Abschnitt ‚ÄûUmgebungsvariablen‚Äú k√∂nnen Umgebungsvariablen definiert werden, die sowohl offene als auch vertrauliche Informationen enthalten, z. B. Anmeldeinformationen und SSH-Schl√ºssel. </li><li>  Der Abschnitt "Cron-Jobs" ist eine Konfiguration des Zeitplans f√ºr die Ausf√ºhrung von Aufgaben. </li></ul><br>  Im Abschnitt "Umgebungsvariablen" erstellen wir Variablen <i>PVS_USERNAME</i> und <i>PVS_KEY,</i> die einen Benutzernamen und einen Lizenzschl√ºssel f√ºr den statischen Analysator enthalten.  Wenn Sie keine permanente PVS-Studio-Lizenz haben, k√∂nnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eine Testlizenz anfordern</a> . <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8aa/731/483/8aa731483fc391273980c7de338f83be.png" alt="Bild 5"></div><br>  Hier erstellen wir die Variablen <i>MAIL_USER</i> und <i>MAIL_PASSWORD</i> , die einen Benutzernamen und ein E-Mail-Passwort enthalten, die wir zum Senden von Berichten verwenden. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/37d/a42/9b4/37da429b49812239ab900e3b6fe5a90d.png" alt="Bild 4"></div><br>  Beim Ausf√ºhren von Aufgaben nimmt Travis CI Anweisungen aus der Datei .travis.yml entgegen, die sich im Stammverzeichnis des Repositorys befindet. <br><br>  Mit Travis CI k√∂nnen wir statische Analysen sowohl direkt auf der virtuellen Maschine ausf√ºhren als auch einen vorkonfigurierten Container verwenden.  Die Ergebnisse dieser Ans√§tze unterscheiden sich nicht voneinander.  Die Verwendung eines vorkonfigurierten Containers kann jedoch hilfreich sein.  Wenn wir beispielsweise bereits einen Container mit einer bestimmten Umgebung haben, in dem ein Softwareprodukt erstellt und getestet wird, und wir diese Umgebung in Travis CI nicht wiederherstellen m√∂chten. <br><br>  Erstellen Sie eine Konfiguration, um den Analysator auf einer virtuellen Maschine auszuf√ºhren. <br><br>  Zum Erstellen und Testen verwenden wir eine virtuelle Maschine unter Ubuntu Trusty. Die Beschreibung finden Sie unter dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> . <br><br>  Zun√§chst geben wir an, dass das Projekt in C geschrieben ist, und listen Compiler auf, die wir f√ºr den Build verwenden werden: <br><br><pre><code class="cpp hljs">language: c compiler: - gcc - clang</code> </pre> <br>  <b>Hinweis:</b> Wenn Sie mehr als einen Compiler angeben, werden die Aufgaben f√ºr jeden von ihnen gleichzeitig ausgef√ºhrt.  Lesen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> mehr. <br><br>  Vor dem Build m√ºssen wir das Analyzer-Repository hinzuf√ºgen, Abh√§ngigkeiten und zus√§tzliche Pakete festlegen: <br><br><pre> <code class="cpp hljs">before_install: - sudo add-apt-repository ppa:ubuntu-lxc/daily -y - wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - - sudo wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list - sudo apt-get update -qq - sudo apt-get install -qq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates</span></span></code> </pre> <br>  Bevor wir ein Projekt erstellen, m√ºssen wir Ihre Umgebung vorbereiten: <br><br><pre> <code class="cpp hljs">script: - ./coccinelle/run-coccinelle.sh -i - git diff --<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>-code - <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> CFLAGS=<span class="hljs-string"><span class="hljs-string">"-Wall -Werror"</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LDFLAGS=<span class="hljs-string"><span class="hljs-string">"-pthread -lpthread"</span></span> - ./autogen.sh - rm -Rf build - mkdir build - cd build - ../configure --enable-tests --with-distro=unknown</code> </pre> <br>  Als n√§chstes m√ºssen wir eine Lizenzdatei erstellen und mit der Analyse des Projekts beginnen. <br><br>  Dann erstellen wir mit dem ersten Befehl eine Lizenzdatei f√ºr den Analysator.  Die Daten f√ºr die Variablen <i>$ PVS_USERNAME</i> und <i>$ PVS_KEY</i> werden aus den Projekteinstellungen √ºbernommen. <br><br><pre> <code class="cpp hljs">- pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic</code> </pre> <br>  Mit dem n√§chsten Befehl beginnen wir mit der Verfolgung des Projektaufbaus. <br><br><pre> <code class="cpp hljs">- pvs-studio-analyzer trace -- make -j4</code> </pre> <br>  Danach f√ºhren wir eine statische Analyse durch. <br>  <b>Hinweis:</b> Wenn Sie eine <i>Testlizenz verwenden</i> , m√ºssen Sie den Parameter <i>--disableLicenseExpirationCheck</i> angeben. <br><pre> <code class="cpp hljs"> - pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> --disableLicenseExpirationCheck</code> </pre> <br>  Die Datei mit den Analyseergebnissen wird mit dem letzten Befehl in den HTML-Bericht konvertiert. <br><br><pre> <code class="cpp hljs">- plog-converter -t html PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> -o PVS-Studio-${CC}.html</code> </pre> <br>  Da Sie mit TravisCI das Format von E-Mail-Benachrichtigungen nicht √§ndern k√∂nnen, verwenden wir im letzten Schritt das Sendemail-Paket zum Senden von Berichten: <br><br><pre> <code class="cpp hljs">- sendemail -t mail@domain.com -u <span class="hljs-string"><span class="hljs-string">"PVS-Studio $CC report, commit:$TRAVIS_COMMIT"</span></span> -m <span class="hljs-string"><span class="hljs-string">"PVS-Studio $CC report, commit:$TRAVIS_COMMIT"</span></span> -s smtp.gmail.com:<span class="hljs-number"><span class="hljs-number">587</span></span> -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> PVS-Studio-${CC}.html</code> </pre> <br>  Hier ist der vollst√§ndige Text der Konfigurationsdatei zum Ausf√ºhren des Analysators auf der virtuellen Maschine: <br><br><pre> <code class="cpp hljs">language: c compiler: - gcc - clang before_install: - sudo add-apt-repository ppa:ubuntu-lxc/daily -y - wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - - sudo wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list - sudo apt-get update -qq - sudo apt-get install -qq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates script: - ./coccinelle/run-coccinelle.sh -i - git diff --exit-code - export CFLAGS="-Wall -Werror" - export LDFLAGS="-pthread -lpthread" - ./autogen.sh - rm -Rf build - mkdir build - cd build - ../configure --enable-tests --with-distro=unknown - pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic - pvs-studio-analyzer trace -- make -j4 - pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-${CC}.log --disableLicenseExpirationCheck - plog-converter -t html PVS-Studio-${CC}.log -o PVS-Studio-${CC}.html - sendemail -t mail@domain.com -u "PVS-Studio $CC report, commit:$TRAVIS_COMMIT" -m "PVS-Studio $CC report, commit:$TRAVIS_COMMIT" -s smtp.gmail.com:587 -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.log PVS-Studio-${CC}.html</span></span></code> </pre> <br>  Um PVS-Studio in einem Container auszuf√ºhren, erstellen wir es mit der folgenden Docker-Datei vor: <br><br><pre> <code class="cpp hljs">FROM docker.io/ubuntu:trusty ENV CFLAGS=<span class="hljs-string"><span class="hljs-string">"-Wall -Werror"</span></span> ENV LDFLAGS=<span class="hljs-string"><span class="hljs-string">"-pthread -lpthread"</span></span> RUN apt-get update &amp;&amp; apt-get install -y software-properties-common wget \ &amp;&amp; wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - \ &amp;&amp; wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list \ &amp;&amp; apt-get update \ &amp;&amp; apt-get install -yqq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio git libtool autotools-dev automake pkg-config clang make libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates \ &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span></code> </pre> <br>  In diesem Fall sieht die Konfigurationsdatei m√∂glicherweise folgenderma√üen aus: <br><br><pre> <code class="cpp hljs">before_install: - docker pull docker.io/oandreev/lxc env: - CC=gcc - CC=clang script: - docker run --rm --cap-add SYS_PTRACE -v $(pwd):/pvs -w /pvs docker.io/oandreev/lxc /bin/bash -c <span class="hljs-string"><span class="hljs-string">" ./coccinelle/run-coccinelle.sh -i &amp;&amp; git diff --exit-code &amp;&amp; ./autogen.sh &amp;&amp; mkdir build &amp;&amp; cd build &amp;&amp; ../configure CC=$CC &amp;&amp; pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic &amp;&amp; pvs-studio-analyzer trace -- make -j4 &amp;&amp; pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-$CC.log --disableLicenseExpirationCheck &amp;&amp; plog-converter -t html -o PVS-Studio-$CC.html PVS-Studio-$CC.log &amp;&amp; sendemail -t mail@domain.com -u 'PVS-Studio $CC report, commit:$TRAVIS_COMMIT' -m 'PVS-Studio $CC report, commit:$TRAVIS_COMMIT' -s smtp.gmail.com:587 -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.log PVS-Studio-${CC}.html"</span></span></code> </pre> <br>  Wie Sie sehen k√∂nnen, tun wir in diesem Fall nichts in der virtuellen Maschine, und alle Aktionen zum Erstellen und Testen des Projekts finden im Container statt. <br><br>  <b>Hinweis</b> : Wenn Sie den Container starten, m√ºssen Sie den Parameter <i>--cap-add SYS_PTRACE</i> oder <i>--security-opt seccomp: nicht begrenzt angeben</i> , da ein ptrace-Systemaufruf f√ºr die Compiler-Ablaufverfolgung verwendet wird. <br><br>  Als N√§chstes laden wir die Konfigurationsdatei in das Stammverzeichnis des Repositorys und stellen fest, dass Travis CI √ºber √Ñnderungen im Projekt informiert wurde und den Build automatisch gestartet hat. <br><br>  Details zum Build-Fortschritt und zur Analyse des Analysators finden Sie in der Konsole. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/00a/846/95d/00a84695de9e00013c89760219f5292e.png" alt="Bild 2"></div><br>  Nach Abschluss der Tests erhalten wir zwei E-Mails: die erste mit statischen Analyseergebnissen zum Erstellen eines Projekts mit gcc und die zweite mit clang. <br><br><h2>  Kurz √ºber die Pr√ºfergebnisse </h2><br>  Im Allgemeinen ist das Projekt ziemlich sauber, der Analysator gab nur 24 Warnungen mit hoher und 46 Warnungen mit mittlerer Sicherheit aus.  Schauen wir uns einige interessante Benachrichtigungen an: <br><br><h3>  Redundante Bedingungen in if </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V590</a> √úberpr√ºfen Sie den Ausdruck 'ret! = (- 1) &amp;&amp; ret == 1'.  Der Ausdruck ist √ºbertrieben oder enth√§lt einen Druckfehler.  Anhang.c 107 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EOF -1 static struct lxc_proc_context_info *lxc_proc_get_context_info(pid_t pid) { .... while (getline(&amp;</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">, &amp;line_bufsz, proc_file) != -1) { ret = sscanf(</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CapBnd: %llx"</span></span></span><span class="hljs-meta">, &amp;info-&gt;capability_mask); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ret != EOF &amp;&amp; ret == 1) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= { found = true; break; } } .... }</span></span></span></span></code> </pre> <br>  Wenn <i>ret == 1 ist</i> , ist es definitiv nicht gleich -1 (EOF).  Redundante Pr√ºfung, <i>ret! = EOF</i> kann entfernt werden. <br><br>  Es wurden zwei √§hnliche Warnungen ausgegeben: <br><br><ul><li>  V590 √úberpr√ºfen Sie den Ausdruck 'ret! = (- 1) &amp;&amp; ret == 1'.  Der Ausdruck ist √ºbertrieben oder enth√§lt einen Druckfehler.  Anhang.c 579 </li><li>  V590 √úberpr√ºfen Sie den Ausdruck 'ret! = (- 1) &amp;&amp; ret == 1'.  Der Ausdruck ist √ºbertrieben oder enth√§lt einen Druckfehler.  Anhang.c 583 </li></ul><br><h3>  Verlust von hohen Bits </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V784</a> Die Gr√∂√üe der Bitmaske ist kleiner als die Gr√∂√üe des ersten Operanden.  Dies f√ºhrt zum Verlust h√∂herer Bits.  conf.c 1879 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mount_opt</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *name; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> clear; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flag; }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_mntopt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *opt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mount_opt</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* If opt is found in mount_opt, set or clear flags. * Otherwise append it to data. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (mo = &amp;mount_opt[<span class="hljs-number"><span class="hljs-number">0</span></span>]; mo-&gt;name != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; mo++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(opt, mo-&gt;name, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(mo-&gt;name)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mo-&gt;clear) { *flags &amp;= ~mo-&gt;flag; <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else { *flags |= mo-&gt;flag; } return; } } .... }</span></span></code> </pre> <br>  Unter Linux ist <i>long</i> eine 64-Bit-Ganzzahlvariable, <i>mo-&gt; flag</i> eine 32-Bit-Ganzzahlvariable.  Die Verwendung von <i>mo-&gt; flag</i> als Bitmaske f√ºhrt zum Verlust von 32 hohen Bits.  Eine Bitmaske wird nach bitweiser Inversion implizit in eine 64-Bit-Ganzzahlvariable umgewandelt.  Hohe Bits dieser Maske k√∂nnen verloren gehen. <br><br>  Ich werde es anhand eines Beispiels zeigen: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> y; .... x &amp;= ~y;</code> </pre> <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a3/59f/a71/1a359fa7163d8a99c8632ffc17cf7eb0.png" alt="Bild 3"></div><br><br>  Hier ist die richtige Version des Codes: <br><br><pre> <code class="cpp hljs">*flags &amp;= ~(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(mo-&gt;flag);</code> </pre> <br>  Der Analysator gab eine weitere √§hnliche Warnung aus: <br><br><ul><li>  V784 Die Gr√∂√üe der Bitmaske ist kleiner als die Gr√∂√üe des ersten Operanden.  Dies f√ºhrt zum Verlust h√∂herer Bits.  conf.c 1933 </li></ul><br><h3>  Verd√§chtige Schleife </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V612</a> Eine bedingungslose 'R√ºckkehr' innerhalb einer Schleife.  conf.c 3477 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> lxc_list_for_each(__iterator, __list) \ for (__iterator = (__list)-&gt;next; __iterator != __list; \ __iterator = __iterator-&gt;next) static bool verify_start_hooks(struct lxc_conf *conf) { char path[PATH_MAX]; struct lxc_list *it; lxc_list_for_each (it, &amp;conf-&gt;hooks[LXCHOOK_START]) { int ret; char *hookname = it-&gt;elem; ret = snprintf(path, PATH_MAX, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s%s"</span></span></span><span class="hljs-meta">, conf-&gt;rootfs.path ? conf-&gt;rootfs.mount : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">, hookname); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ret </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0 || ret &gt;= PATH_MAX) return false; ret = access(path, X_OK); if (ret &lt; 0) { SYSERROR("Start hook \"%s\" not found in container", hookname); return false; } return true; // &lt;= } return true; }</span></span></span></span></code> </pre> <br>  Die Schleife wird bei der ersten Iteration gestartet und unterbrochen.  Dies k√∂nnte absichtlich gemacht worden sein, aber in diesem Fall k√∂nnte die Schleife weggelassen worden sein. <br><br><h3>  Array-Index au√üerhalb der Grenzen </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V557</a> Array-Unterlauf ist m√∂glich.  Der Wert des Index 'Bytes - 1' k√∂nnte -1 erreichen.  network.c 2570 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lxc_create_network_unpriv_exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lxcpath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lxcname, struct lxc_netdev *netdev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hooks_version)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytes; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[PATH_MAX] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; .... bytes = lxc_read_nointr(pipefd[<span class="hljs-number"><span class="hljs-number">0</span></span>], &amp;buffer, PATH_MAX); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { SYSERROR(<span class="hljs-string"><span class="hljs-string">"Failed to read from pipe file descriptor"</span></span>); close(pipefd[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { buffer[bytes - <span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } .... }</code> </pre> <br>  Bytes werden im Puffer aus der Pipe gelesen.  Im Fehlerfall gibt die Funktion <i>lxc_read_nointr</i> einen negativen Wert zur√ºck.  Wenn alles erfolgreich ist, wird vom letzten Element ein Terminal null geschrieben.  Wenn jedoch 0 Bytes gelesen werden, liegt der Index au√üerhalb der Puffergrenzen, was zu undefiniertem Verhalten f√ºhrt. <br><br>  Der Analysator gab eine weitere √§hnliche Warnung aus: <br><br><ul><li>  V557 Array-Unterlauf ist m√∂glich.  Der Wert des Index 'Bytes - 1' k√∂nnte -1 erreichen.  network.c 2725 </li></ul><br><h3>  Puffer√ºberlauf </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V576</a> Falsches Format.  √úberpr√ºfen Sie das dritte tats√§chliche Argument der Funktion 'sscanf'.  Es ist gef√§hrlich, einen String-Bezeichner ohne Breitenangabe zu verwenden.  Puffer√ºberlauf ist m√∂glich.  lxc_unshare.c 205 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookup_user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *oparg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *uid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[PATH_MAX]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(oparg, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, uid) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* not a uid -- perhaps a username */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(oparg, <span class="hljs-string"><span class="hljs-string">"%s"</span></span>, name) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { free(buf); return false; } .... } .... }</span></span></code> </pre> <br>  In diesem Fall kann die Verwendung von <i>sscanf</i> gef√§hrlich sein, da der Index beim Bilden des <i>Namenspuffers</i> au√üerhalb der Grenzen liegt, wenn der <i>oparq-</i> Puffer gr√∂√üer als der <i>Namenspuffer</i> ist. <br><br><h2>  Fazit </h2><br>  Wie wir sehen, ist es eine recht einfache Aufgabe, eine √úberpr√ºfung des statischen Code-Analysators in einer Cloud zu konfigurieren.  Dazu m√ºssen wir nur eine Datei in ein Repository einf√ºgen und wenig Zeit f√ºr die Einrichtung des CI-Systems aufwenden.  Als Ergebnis erhalten wir ein Tool, mit dem Probleme beim Schreiben von Code erkannt werden k√∂nnen.  Mit diesem Tool k√∂nnen wir verhindern, dass Fehler in die n√§chsten Testphasen gelangen, in denen ihre Behebung viel Zeit und M√ºhe erfordert. <br><br>  Nat√ºrlich ist die Nutzung von PVS-Studio mit Cloud-Plattformen nicht nur auf Travis CI beschr√§nkt.  √Ñhnlich wie bei der im Artikel beschriebenen Methode kann die PVS-Studio-Analyse mit kleinen Unterschieden in andere g√§ngige Cloud-CI-L√∂sungen wie CircleCI, GitLab usw. integriert werden. <br><br><h2>  N√ºtzliche Links </h2><br><ul><li>  Weitere Informationen zum Ausf√ºhren von PVS-Studio unter Linux und MacOS finden Sie unter dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> . </li><li>  √úber den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> k√∂nnen Sie auch Informationen zum Erstellen, Einstellen und Verwenden von Containern mit installiertem PVS-Studio Static Code Analyzer lesen. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TravisCI-Dokumentation</a> . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de458064/">https://habr.com/ru/post/de458064/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de458050/index.html">Wie war der Mobius 2019 Piter (und ein bisschen √ºber den n√§chsten Mobius)</a></li>
<li><a href="../de458052/index.html">AMA mit Habr. 10. Letzte * Ausgabe</a></li>
<li><a href="../de458056/index.html">Das gro√üe Interview mit Martin Kleppmann: ‚ÄûDie Zukunft verteilter Datensysteme herausfinden‚Äú</a></li>
<li><a href="../de458060/index.html">Erstellen eines Grasshaders in der Unity-Engine</a></li>
<li><a href="../de458062/index.html">√úbersicht √ºber die UserGate-Plattform</a></li>
<li><a href="../de458068/index.html">PVS-Studio f√ºr Visual Studio</a></li>
<li><a href="../de458070/index.html">PVS-Studio f√ºr Visual Studio</a></li>
<li><a href="../de458072/index.html">PVS-Studio geht in die Cloud - Starten Sie die Analyse auf Travis CI</a></li>
<li><a href="../de458074/index.html">Gehe zu Sprache: ORM-Auswahl</a></li>
<li><a href="../de458076/index.html">Marketing mit ML-Entscheidungsfindung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>