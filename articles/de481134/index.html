<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ö üôåüèø üçù So bewerten Sie die Kapazit√§t des Dienstes und fallen nicht unter Last ‚èèÔ∏è üï∑Ô∏è üéÖüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fr√ºher oder sp√§ter muss jeder wachsende Dienst seine technischen F√§higkeiten bewerten. Wie viele Besucher k√∂nnen wir bedienen? Was ist die Kapazit√§t d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So bewerten Sie die Kapazit√§t des Dienstes und fallen nicht unter Last</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/481134/"><img src="https://habrastorage.org/webt/-s/kl/8y/-skl8ysedkaeho-x6lw7-laelwi.png"><br><br>  Fr√ºher oder sp√§ter muss jeder wachsende Dienst seine technischen F√§higkeiten bewerten.  Wie viele Besucher k√∂nnen wir bedienen?  Was ist die Kapazit√§t des Systems?  Haben wir das Limit erreicht und werden nicht fallen, wenn wir mehrere tausend weitere Nutzer anziehen?  Wie viele zus√§tzliche Rechenressourcen sind f√ºr das n√§chste Jahr vorgesehen, um die Wachstumspl√§ne zu erf√ºllen? <br><br>  Antworten erhalten Sie analytisch, indem Sie Fragen an einen erfahrenen Entwickler / DevOps / SRE / admin richten.  Die Zuverl√§ssigkeit der Bewertung h√§ngt von einer Vielzahl von Faktoren ab: angefangen von der Geschwindigkeit der F√ºllung des Systems mit Funktionen und der grafischen Darstellung der Beziehungen zwischen den Komponenten bis hin zur Zeit, die der Experte den Morgen im Verkehr verbracht hat.  Je komplexer das System ist, desto mehr Zweifel bestehen an der Angemessenheit der analytischen Bewertung. <br><br>  Mein Name ist Maxim Kupriyanov, seit f√ºnf Jahren arbeite ich bei Yandex.Market.  Heute werde ich den Lesern von Habr erz√§hlen, wie wir gelernt haben, die Leistungsf√§higkeit unserer Dienste zu bewerten und was daraus geworden ist. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/dj/-4/ho/dj-4hoqd3ddi5lpwrokluke77ok.png"><br><br><h2>  Wir gehen zu der Position </h2><br>  Die Struktur der Market-Komponenten ist ziemlich kompliziert, daher haben wir beschlossen, die Kapazit√§t nur der gr√∂√üten und teuersten Services in Bezug auf die Skalierung zu bewerten.  Dar√ºber hinaus sollte die t√§gliche Anzahl der Anfragen eindeutig von der Gr√∂√üe des t√§glichen Marktpublikums abh√§ngen (Daily Active Users, DAU).  Warum genau von DAU?  Denn Analysten, die Prognosen f√ºr Monate und Jahre abgeben, berechnen immer die zuk√ºnftige Gr√∂√üe des Publikums, und wir werden diesen angenehmen Umstand ausnutzen. <br><br>  Lassen Sie uns nun dar√ºber sprechen, ohne die es unm√∂glich ist, objektive Bewertungen zu erstellen: √ºber die Metriken des Dienstes.  Wenn die Anzahl der Dienstanforderungen von der DAU abh√§ngt, ben√∂tigen wir definitiv die Metrik "Anforderungen pro Sekunde" (Anforderungen pro Sekunde, RPS).  Um die Qualit√§t des Dienstes beurteilen zu k√∂nnen, m√ºssen Sie au√üerdem den Prozentsatz der Fehler und die Antwortzeiten (Anforderungszeitpunkte) kennen.  Der Fehler wird als Antwort mit einem HTTP-Code von 500 oder h√∂her betrachtet.  Fehler aus dem 4xx-Bereich sind clientseitig und sagen in einem normal funktionierenden System normalerweise nichts √ºber Serviceprobleme aus.  In Bezug auf die Zeitangaben ist es f√ºr uns √ºblich, das 80., 95., 99. und 99.9. Perzentil der Antwortzeiten zu berechnen und zu speichern. Ein bestimmter Satz kann sich jedoch von Service zu Service geringf√ºgig unterscheiden. <br><br>  Wir haben also Metriken f√ºr die Anforderungsh√§ufigkeit, den Prozentsatz der Fehler und eine Reihe von Perzentilen der Antwortzeit.  Au√üerdem kennen wir den DAU-Service f√ºr jeden Tag und f√ºr zuk√ºnftige Perioden (in Form einer Prognose).  Angesichts der Tatsache, dass sich die durchschnittlichen Benutzerverhaltensmuster von Tag zu Tag nicht zu stark √§ndern, k√∂nnen wir bei Kenntnis des RPS in der aktivsten Phase des Arbeitstages (Peak-RPS) den Peak-RPS f√ºr zuk√ºnftige Perioden vorhersagen, vorausgesetzt, wir haben eine DAU-Prognose.  Und umgekehrt: Wenn wir wissen, wie viele Anfragen pro Sekunde das System bestehen kann, ohne die Vereinbarung √ºber die Antwortzeit und den Prozentsatz der Fehler zu verletzen, k√∂nnen wir absch√§tzen, wie viel Publikum wir bedienen k√∂nnen, das hei√üt, wir kennen die Kapazit√§t des Systems. <br><br>  Nun, wir haben uns f√ºr die Aufgabe entschieden: Die Antwortzeiten und den Prozentsatz der Fehler in Form von Vereinbarungen festzulegen und den maximalen RPS zu ermitteln, den das System unter diesen Bedingungen aush√§lt.  Wie werden wir uns entscheiden? <br><br><img src="https://habrastorage.org/webt/wf/zk/ea/wfzkeajjy8urgrmv0xib56c9nj8.png"><br><br><h2>  Wir schie√üen auf das Ziel </h2><br>  Hier ist ein klassischer Ansatz zur L√∂sung des Problems: Wir erfassen einen Teststandort, nehmen die Systemzugriffsprotokolle aus der Produktionsumgebung, fertigen Kassetten davon und feuern das System, wodurch die H√§ufigkeit von Anforderungen erh√∂ht wird, bis der Standort eine erhebliche Verschlechterung der Antwortzeiten und / oder Fehler aufweist.  An diesem Punkt stoppen wir und legen die H√§ufigkeit der Anfragen fest (genau das gleiche RPS).  Sieg  Egal wie.  Und hier ist warum: <br><br><ul><li>  Der Teststandort ist in der Regel nicht identisch mit der Plattform unter dem Service in der Produktionsumgebung. </li><li>  Der Service-Code √§ndert sich t√§glich oder sogar noch h√§ufiger. </li><li>  Versuche k√∂nnen die Belastung beeinflussen; </li><li>  Der Schweregrad der Benutzeranforderungen h√§ngt von der Tageszeit und anderen Bedingungen ab. </li><li>  Moderne Dienste arbeiten selten isoliert, sie stellen h√§ufiger Unterabfragen an andere Dienste, und dies muss irgendwie ber√ºcksichtigt werden. </li></ul><br>  Verbesserung: Wir werden den Dienst jeden Tag automatisch ausl√∂sen und zu Sto√üzeiten Kassetten aus Magazinen abholen.  Und um auf einem Testgel√§nde keine Ressourcen zu verschwenden, werden wir abwechselnd auf dem gleichen Stand Komponenten sch√§len, die f√ºr uns von Interesse sind.  Es klingt kompliziert und l√∂st nicht alle Probleme.  Aber welche anderen M√∂glichkeiten gibt es? <br><br><img src="https://habrastorage.org/webt/sb/ub/zp/sbubzp0dbuxhrpqtdxt6fichhqk.png"><br><br><h2>  Realit√§t simulieren </h2><br>  Die allgemeine Idee ist folgende: Wir kopieren einen Teil des Datenverkehrs von den Balancern zur Site, wo wir die vollst√§ndige Analogie der Produktionsumgebung in Miniaturform erfassen und, indem wir das Volumen des kopierten Datenverkehrs anpassen, nach dem Punkt der Verschlechterung suchen.  Die Idee ist sch√∂n, und wir auf dem Markt tun dies, um neue Funktionen zu testen und das Verhalten neuer Versionen mit alten zu vergleichen.  Mein Kollege Eugene hat <a href="https://habr.com/ru/company/yandex/blog/475848/">dar√ºber</a> ausf√ºhrlich gesprochen - siehe Abschnitt √ºber den Schattenhaufen.  Aber es gibt auch offensichtliche Schwierigkeiten: <br><br><ul><li>  Das Problem der Interaktion mit externen Komponenten ist nicht gel√∂st, da es sehr teuer ist, eine Kopie der gesamten Produktionsumgebung zu erstellen. </li><li>  Anforderungsprotokolle vom Spiegelsystem k√∂nnen sich versehentlich mit den Protokollen aus der Produktionsumgebung vermischen. Dies bedeutet, dass ein System mit einer Markierung des Spiegelverkehrs erstellt werden muss, damit es gefunden und bereinigt werden kann. </li><li>  Anfragen werden normalerweise entweder vollst√§ndig oder als Prozentsatz der Gesamtsumme gespiegelt, und eine solche Genauigkeit passt nicht zu uns (aber dies kann gel√∂st werden, wir arbeiten in diese Richtung). </li></ul><br>  Im Allgemeinen ist die Nachahmung der Produktion ein sehr guter und vielversprechender Ansatz, jedoch sehr teuer und mit erheblichen Einschr√§nkungen. <br><br><img src="https://habrastorage.org/webt/bh/pd/-8/bhpd-89lwirxbq9ywgv73803qqo.png"><br><br><h2>  Testen direkt in der Produktion </h2><br>  Und dann sind wir endlich zum leckeren gekommen.  F√ºr jede getestete Komponente wird eine separate Instanz in der Produktion ausgel√∂st, deren H√§ufigkeit von der Auswuchtmaschine mit hoher Genauigkeit geregelt wird.  Beim letzten Mal <a href="https://habr.com/ru/company/yandex/blog/475848/">fragten uns die Leser</a> : ‚ÄûIst HAProxy genug f√ºr Sie?  Gab es ein Bed√ºrfnis, etwas Eigenes zu schreiben? "  Das ist also der sehr seltene Fall, in dem es nicht genug war und ich schreiben musste. <br><br>  Gleichzeitig gibt es einen separaten Dienst, der die Metriken der geladenen Instanz genau √ºberwacht und, wenn sich die Indikatoren kritischen Werten n√§hern, das Ventil am Balancer schlie√üt, wodurch die H√§ufigkeit von Anforderungen verringert wird.  Wenn der Service innerhalb akzeptabler Grenzen arbeitet, √∂ffnet das Ventil im Gegenteil.  Nat√ºrlich sind die Schwellenwerte f√ºr Timings und Fehler beim Laden eines Live-Dienstes merklich konservativer (in der Regel um 5‚Äì10%) als auf dem Trainingsgel√§nde, da wir die Interaktion mit den Benutzern nicht verschlechtern m√∂chten.  Somit arbeitet die geladene Instanz immer bis zum Limit.  Wir korrigieren diese Indikatoren.  Und dann haben wir Arithmetik: Wir kennen die Anzahl der Servicekerne, die gerade unter Last sind, wir kennen die DAU gestern.  Daher ber√ºcksichtigen wir Recycling-, Kapazit√§tsreserve- und Systemverhaltensoptionen beim Deaktivieren des einen oder anderen Standorts.  All dies liegt in der Basis, aus der wundersch√∂ne Grafiken erstellt werden.  Basierend auf diesen Daten werden Warnungen ausgel√∂st, wenn die Kapazit√§t unter den Schwellenwert f√§llt. <br><br><h2>  Schauen wir uns die Grafiken an </h2><br><img src="https://habrastorage.org/webt/lt/nb/pa/ltnbpanor5tjwa-ljrej4darzcm.png"><br><br>  Auf diese Weise steuern wir den Verkehrsfluss zur getesteten Instanz.  Der Schritt kann ein Vielfaches von 1 RPS sein.  In der Grafik haben wir zur Veranschaulichung einen Anstieg mit einem Drei-Minuten-Intervall modelliert: Zuerst von 650 auf 1 km / h in Schritten von 50 und dann von 200 auf 1 km / h in Schritten von 100. Lassen Sie mich daran erinnern, dass dies echter Nutzerverkehr ist, auf den Kunden Antworten erhalten haben. <br><br><img src="https://habrastorage.org/webt/yl/hp/ma/ylhpma60p6keqxgzmsshgvqs1dm.png"><br><br>  Dies zeigt RPS f√ºr drei Instanzen: eine unter Last und zwei unter Kontrolle.  Dem Probanden wurde k√ºnstlich eine Obergrenze von 600 RPS gesetzt.  Der Service kann mehr sein, aber es wird zu instabil und abh√§ngig von √§u√üeren Einfl√ºssen.  Es ist deutlich zu sehen, dass in der ersten H√§lfte des Tages Serviceanfragen im Durchschnitt schwerer sind und die Instanz unter akzeptablen Bedingungen nicht ihre maximale Kapazit√§t erreichen kann, aber gegen Abend wird alles wieder normal.  Bursts und Auslassungen in der Tabelle sind Instanzneustarts zum Auslegen von Releases und anderen Updates (sie sind alle im Gleichgewicht, niemand wurde verletzt).  Und schrittweise RPS-Anpassungen am Testobjekt sind nur die Arbeit eines Algorithmus, der die Grenzen der M√∂glichkeiten auslotet. <br><br><img src="https://habrastorage.org/webt/3y/du/mw/3ydumwukuqrnergvj0li5mqxary.png"><br><br>  Die H√§ufigkeit von Serviceanfragen und die Belastung, der eine Instanz standhalten kann, sind deutlich sichtbar. <br><br><img src="https://habrastorage.org/webt/hy/jj/mt/hyjjmtgnuwgdrkla6_k42za5x_c.png"><br><br>  Und hier berechnen wir alles in Prozent der Auslastung neu.  Die Grafik zeigt, dass der Service ziemlich stark ausgelastet war und dass bei Deaktivierung eines der Standorte die Gefahr bestand, dass der Service f√ºr SLA freigegeben wurde.  Aber jetzt ist alles in Ordnung: Ressourcen wurden dem Service hinzugef√ºgt, das Recycling ist wieder in akzeptablen Grenzen. <br><br>  So k√∂nnen Sie mithilfe von Auslastungstests in der Produktion schnell die Kapazit√§t des Systems bewerten und den Ressourcenverbrauch f√ºr zuk√ºnftige Perioden vorhersagen.  Gleichzeitig verursacht das System keine nennenswerten Kosten, und Sie k√∂nnen sicher mit Stateful Services arbeiten, da wir keinen neuen Datenverkehr generieren, sondern nur den aktuellen Datenverkehr pr√§zise umverteilen.  Und schlie√ülich: Um zu funktionieren, ist es in der Regel nicht erforderlich, den Code des experimentellen Systems selbst zu √§ndern, wodurch auch √§ltere Anwendungen getestet werden k√∂nnen. <br><br><img src="https://habrastorage.org/webt/bn/fe/bd/bnfebdjggyt-wbi914qf_z9dcnu.png"><br><br><h2>  Nachdenken </h2><br>  Diese Methode funktioniert seit mehr als einem Jahr nicht mehr auf dem Markt, und wir k√∂nnen Beobachtungen und Empfehlungen austauschen: <br><br><ul><li>  Neben der geladenen Instanz muss eine gew√∂hnliche Einzelsteuerung und vorzugsweise Dampf vorhanden sein, da eine Verschlechterung h√§ufig nicht aufgrund einer √úberlastung der Instanz, sondern aufgrund allgemeiner Probleme mit dem gesamten Dienst auftritt. </li><li>  Die Technik funktioniert nur mit Komponenten, bei denen die Auslastung Hunderte von Anforderungen pro Sekunde f√ºr einen Standort √ºbersteigt.  Der Grund ist ganz einfach: Wir m√ºssen sowohl die getestete Instanz als auch eine oder zwei Kontrollinstanzen laden.  Wenn es nicht genug Verkehr gibt, werden wir nicht die S√§ttigung erreichen, oder wir werden nicht in der Lage sein, ehrlich zu vergleichen.  Und wenn die RPS-Grenze pro Instanz sehr klein ist, ist der Mindestschritt zum √Ñndern der Anforderungsfrequenz auf 1 RPS m√∂glicherweise zu grob. </li><li>  Es ist besser, Fronts und Backends an verschiedenen Orten zu testen, damit Artefakte beim Testen von Backends die Einsch√§tzung der Frontkapazit√§t nicht beeintr√§chtigen. </li><li>  Wenn wir die Reaktionszeiten analysieren und nach Anzeichen f√ºr eine Verschlechterung suchen, nehmen wir normalerweise f√ºnfmin√ºtige Aggregate und z√§hlen den Median, um nicht auf zuf√§llige Bursts zu reagieren. </li><li>  Der Hauptgrund, warum die geladene Instanz des Dienstes abst√ºrzt, ist der Speicherplatz f√ºr Protokolldateien (Protokolle).  Sie vergessen ihn immer. </li><li>  Die Protokollierung auf I / O-geladenen Datentr√§gern von Webservern ist ein sehr h√§ufiger Grund f√ºr eine Verschlechterung der Timings, selbst auf SSDs.  Aktivieren Sie immer die Pufferung, die asynchrone Aufzeichnung und alles andere, um nicht zu warten, bis die Aufzeichnung beendet ist. </li><li>  Die Nachtlast ist nicht indikativ, da die Anforderungen aufgrund des gr√∂√üeren Roboteranteils im Durchschnitt h√∂her sind.  Um die Kapazit√§t abzusch√§tzen, ist es daher besser, den Bereich von der √ºblichen hellen Tageszeit bis zur Nacht festzulegen und den Anforderungsfluss nur dann zu verringern, wenn Anzeichen einer Verschlechterung auftreten. </li><li>  Das 99,9-Perzentil der Antwortzeiten ist f√ºr die Kapazit√§tssch√§tzung unbrauchbar, da die Netzwerkverf√ºgbarkeitsgarantien selten 99% √ºberschreiten. </li><li>  Starten Sie eine Zeitleiste, und zeichnen Sie Service Releases und andere wichtige Ereignisse auf.  Es hilft herauszufinden, was zu einer Verringerung der Kapazit√§t gef√ºhrt hat. </li><li>  Bei einer detaillierten Analyse der Ursachen f√ºr die Beeintr√§chtigung ist auch die Nachverfolgung hilfreich: Jeder Serviceanforderung wird ein Markierungsheader hinzugef√ºgt, der vom vorderen bis zum letzten Backend alle Protokolle eingibt.  Auf diese Weise k√∂nnen Sie den gesamten Anforderungspfad verfolgen und die Ursachen f√ºr Verz√∂gerungen nachvollziehen. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481134/">https://habr.com/ru/post/de481134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481120/index.html">Wo und wie werden Edgeserver eingesetzt?</a></li>
<li><a href="../de481122/index.html">PostgreSQL Antipatterns: √úbergeben von Mengen und Auswahlen an SQL</a></li>
<li><a href="../de481124/index.html">Tipps zum Schreiben von selbstdokumentierendem Code</a></li>
<li><a href="../de481126/index.html">Programmierergewerkschaft? Sag es nicht meinen Hausschuhen</a></li>
<li><a href="../de481130/index.html">TOP12 Interdisziplin√§re wissenschaftliche Entdeckungen 2019</a></li>
<li><a href="../de481138/index.html">Diese Leute erschaffen k√ºnstliche Intelligenz - 4 Geschichten von KI- und ML-Spezialisten</a></li>
<li><a href="../de481140/index.html">Python-Datendateiformat-Spickzettel</a></li>
<li><a href="../de481142/index.html">Qt QJSEngine Hallo Welt</a></li>
<li><a href="../de481146/index.html">Ein anderer Registrar gab den letzten Block von IPv4-Adressen an</a></li>
<li><a href="../de481148/index.html">Ungew√∂hnliche physikalische Probleme bei der Entwicklung des wissenschaftlichen Denkens (f√ºr Sch√ºler)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>