<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📪 🌐 ⛏️ GAZ-66 mainan di panel kontrol. Bagian 2 🙅🏻 👆🏻 ✋🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada bagian ini kita akan berbicara tentang komponen perangkat lunak, bagaimana mesin itu hidup. OS apa yang digunakan, bahasa apa yang dipilih, masal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GAZ-66 mainan di panel kontrol. Bagian 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462331/"><p><img src="https://habrastorage.org/webt/ix/tf/mx/ixtfmxmnpt-9rkvbc2kqpdtol2c.jpeg" alt="gambar"></p><br><p>  Pada bagian ini kita akan berbicara tentang komponen perangkat lunak, bagaimana mesin itu hidup.  OS apa yang digunakan, bahasa apa yang dipilih, masalah apa yang dihadapi. </p><a name="habracut"></a><br><h3 id="1-kak-rabotaet-v-2-h-slovah">  1. Cara kerjanya dalam 2 kata </h3><br><p>  Sistem terdiri dari server yang diinstal pada mesin tik, dan klien yang diinstal pada konsol.  Server menaikkan titik akses <strong>wifi</strong> dan menunggu hingga klien terhubung.  Server mengeksekusi perintah klien, dan juga mentransmisikan video dari kamera ke sana. </p><br><h3 id="2-os">  2. OS </h3><br><p>  Sekarang mari kita bicara tentang sistem operasi yang digunakan. </p><br><p>  Karena keseluruhan sistem didasarkan pada <strong>Raspberry pi 3</strong> , OS resmi untuk itu digunakan.  Pada saat pembuatan, versi terbaru adalah <strong>Peregangan</strong> , itu dan dipilih untuk digunakan pada mesin tik dan remote control.  Tetapi ternyata ia memiliki bug (tersiksa selama seminggu) karena itu tidak mungkin untuk meningkatkan titik akses wifi.  Karena itu, untuk meningkatkan jalur akses, versi <strong>Jessie</strong> sebelumnya diambil yang tidak memiliki masalah seperti itu. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Artikel cara meningkatkan titik akses.</a>  Sangat detail, melakukan semua yang ada di sana. </p><br><p>  Remote control secara otomatis terhubung ke mesin ketika menaikkan titik akses. <br>  Koneksi otomatis ke titik kami, di file <strong>/ etc / network / interfaces</strong> tambahkan: </p><br><pre><code class="plaintext hljs">auto wlan0 iface wlan0 inet dhcp wpa-ssid {ssid} wpa-psk {password}</code> </pre> <br><h3 id="2-yazyk">  2. Bahasa </h3><br><p>  Saya memilih <strong>python</strong> karena mudah dan sederhana. </p><br><h3 id="3-server">  3. Server </h3><br><p>  Dengan server di bagian ini saya maksudkan perangkat lunak yang ditulis oleh saya untuk mengendalikan mesin dan bekerja dengan video. </p><br><p>  Server terdiri dari 2 bagian.  Server video dan server manajemen. </p><br><h3 id="31-video-server">  3.1 Server video </h3><br><p>  Ada 2 opsi cara bekerja dengan kamera video.  Modul penggunaan pertama <strong>kamera</strong> dan <strong>perangkat lunak</strong> penggunaan <strong>mjpg-streamer ke-2</strong> .  Tanpa berpikir dua kali, saya memutuskan untuk menggunakan keduanya, dan yang mana untuk digunakan dalam pengaturan konfigurasi. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> conf.conf.VideoServerType == <span class="hljs-string"><span class="hljs-string">'m'</span></span> : cmd = <span class="hljs-string"><span class="hljs-string">"cd /home/pi/projects/mjpg-streamer-experimental &amp;&amp; "</span></span> cmd += <span class="hljs-string"><span class="hljs-string">'./mjpg_streamer -o "./output_http.so -p {0} -w ./www" -i "./input_raspicam.so -x {1} -y {2} -fps 25 -ex auto -awb auto -vs -ISO 10"'</span></span>.format(conf.conf.videoServerPort, conf.conf.VideoWidth, conf.conf.VideoHeight) print(cmd) os.system(cmd) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> picamera.PiCamera(resolution = str(conf.conf.VideoWidth) + <span class="hljs-string"><span class="hljs-string">'x'</span></span> + str(conf.conf.VideoHeight) , framerate = conf.conf.VideoRate) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Camera: output = camera.StreamingOutput() camera.output = output Camera.start_recording(output, format = <span class="hljs-string"><span class="hljs-string">'mjpeg'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: address = (conf.conf.ServerIP, conf.conf.videoServerPort) server = camera.StreamingServer(address, camera.StreamingHandler) server.serve_forever() <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: Camera.stop_recording()</code> </pre> <br><p>  Karena mereka mengambil pengaturan yang sama, mereka bekerja di alamat yang sama.  Tidak ada masalah berkomunikasi dengan remote control ketika berpindah dari satu ke yang lain.  Satu-satunya hal yang saya pikir <strong>mjpg-streamer</strong> bekerja lebih cepat. </p><br><h3 id="32-server-upravleniya">  3.2 Server Manajemen </h3><br><h4 id="321-vzaimodeystvie-mezhdu-klientom-i-serverom">  3.2.1 Interaksi antara klien dan server </h4><br><p>  Perintah pertukaran server dan klien dalam bentuk string json: </p><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Y'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'turn'</span></span>, <span class="hljs-string"><span class="hljs-string">'x'</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-string"><span class="hljs-string">'y'</span></span>: <span class="hljs-number"><span class="hljs-number">32</span></span>}</code> </pre> <br><ul><li>  ketik - 'jarak jauh' atau 'mobil' tergantung pada siapa yang mengirim perintah (klien atau server) </li><li>  cmd - string dengan nama tombol yang sesuai dengan nama tombol pada <strong>Game HAT</strong> , misalnya: <br><ul><li>  Mulai - tombol Mulai </li><li>  Pilih - Pilih tombol </li><li>  Tombol Y - Y </li><li>  dll. </li><li>  turn - perintah untuk mengubah status joystick, bertanggung jawab untuk memutar roda </li></ul></li><li>  status - Benar atau Salah, tergantung pada apakah tombol ditekan atau tidak.  Acara status tombol dikirim setiap kali kondisinya berubah. </li><li>  val - kecepatan dan arah gerakan motor dari -1 ... 1, nilai tipe <strong>float</strong> .  Parameter signifikan hanya untuk tombol gerak. </li><li>  x - deviasi joystick sepanjang sumbu x dari -100 ... 100, nilai tipe <strong>int</strong> </li><li>  y - deviasi joystick di sepanjang sumbu y dari -100 ... 100, nilai tipe <strong>int</strong> </li></ul><br><p>  Berikutnya adalah rasa malu saya, untuk mengulangi tangan yang tidak bisa menjangkau.  Mesin menaikkan soket server dan menunggu sampai klien terhubung.  Selain itu, untuk setiap koneksi baru, itu menciptakan aliran terpisah, dan setiap klien baru yang akan terhubung ke mesin akan dapat mengendalikannya)).  Ini tidak bisa sejauh ini karena tidak ada orang lain yang memiliki kendali jarak jauh, dan saya meningkatkan jaringan wifi tertutup saya. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> TCP_IP = conf.conf.ServerIP TCP_PORT = conf.conf.controlServerPort BUFFER_SIZE = conf.conf.ServerBufferSize self.tcpServer = socket.socket(socket.AF_INET, socket.SOCK_STREAM) self.tcpServer.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number"><span class="hljs-number">1</span></span>) self.tcpServer.bind((TCP_IP, TCP_PORT)) threads = [] <span class="hljs-comment"><span class="hljs-comment">#     . self.tcpServer.listen(1) while True: print("Car server up : Waiting for connections from TCP clients...") (conn, (ip, port)) = self.tcpServer.accept() newthread = ClientThread(conn, ip, port) newthread.start() self.threads.append(newthread)</span></span></code> </pre> <br><h4 id="322-upravlenie-zhelezom">  3.2.2 Manajemen Besi </h4><br><p>  Saat bekerja dengan Raspberry, sistem penomoran pin <strong>GPIO.BCM</strong> digunakan. </p><br><p>  <strong>Lampu</strong> dikontrol melalui gpio 17, terhubung ke pin 2 pada <strong>L293</strong> .  Selanjutnya, setiap kali perintah datang untuk menyertakan: </p><br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.HIGH)</code> </pre> <br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.LOW)</code> </pre> <br><p>  perintah yang sesuai disebut. </p><br><p>  <strong>Drive servo</strong> <strong>dikendalikan</strong> melalui papan <strong>PCA9685</strong> melalui bus I2C, jadi kami membutuhkan pustaka yang sesuai untuk itu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Adafruit_PCA9685</a> .  PCA9685 terhubung ke servo melalui 7 pin.  Frekuensi PWM yang diperlukan untuk bekerja dengan servo adalah 50 Hz atau periode 20 ms. </p><br><p>  Prinsip pengoperasian servo: </p><br><p><img src="https://habrastorage.org/webt/h2/z-/ns/h2z-nsefbtnvntcwbmmt9qoikjc.jpeg" alt="gambar"></p><br><p>  Ketika sinyal 1,5 ms diterapkan, roda akan berada di tengah.  Pada 1 ms.  servo akan berubah sejauh mungkin ke kanan, 2 ms.  ke kiri sebanyak mungkin.  Buku-buku jari kemudi di jembatan untuk belokan semacam itu tidak dirancang, sehingga sudut rotasi harus dipilih secara eksperimental. </p><br><p>  Nilai yang dapat diteruskan ke rentang API Adafruit_PCA9685 mulai dari 0.,4095, 0 tanpa sinyal, 4095 penuh.  Oleh karena itu, dari kisaran ini perlu untuk memilih nilai yang cocok untuk roda saya.  Cara termudah untuk menentukan nilai untuk set roda yang tepat adalah dengan mentransfer 1,5 ms ke nilai dari kisaran ~ 307. </p><br><p>  Nilai maksimum untuk kanan adalah 245, untuk kiri 369. </p><br><p>  Nilai-nilai yang berasal dari joystick mengambil nilai dari -100 ... 100, sehingga harus diterjemahkan dalam kisaran 245 hingga 369. Sekali lagi, pusatnya adalah yang termudah, jika 0 adalah 307. Kiri dan kanan sesuai dengan rumus: </p><br><pre> <code class="python hljs">val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero))</code> </pre> <br><ul><li>  HardwareSetting._turnCenter - 307 </li><li>  turn - nilai dari joystick dari -100 ... 100 </li><li>  HardwareSetting._turnDelta - 62, perbedaan antara pusat dan deviasi maksimum ke samping (307 - 245 = 62) </li><li>  HardwareSetting.yZero - 100, nilai maksimum yang diterima dari joystick </li></ul><br><p>  Roda lurus: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnCenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Belok kiri: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Belok kanan: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  <strong>Kontrol engine</strong> juga dilakukan melalui papan <strong>PCA9685</strong> melalui bus I2C, jadi kami menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Adafruit_PCA9685</a> .  Pin 10 hingga 15 pada PCA9685 terhubung ke L298N (saya menggunakan 2 saluran untuk menyerap daya).  10 dan 11 untuk ENA dan ENB (saya mengisinya dengan PWM untuk mengontrol kecepatan).  12, 13, 14, 15 hingga IN1, IN2, IN3, IN4 - bertanggung jawab untuk arah putaran motor.  Frekuensi PWM tidak terlalu penting di sini, tetapi saya juga menggunakan 50 Hertz (nilai default saya). </p><br><p>  Mesin diam: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><p>  Bergerak maju: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">back</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH)</code> </pre> <br><p>  Gerakan mundur: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><h3 id="4-klient">  4. Pelanggan </h3><br><h3 id="41-klaviatura">  4.1 Keyboard </h3><br><p>  Ada masalah tertentu dengannya, pada awalnya saya ingin membuatnya penting (butuh ~ 2 minggu siksaan).  Tapi tombol mekanis berkontribusi, derak kontak menyebabkan kegagalan yang konstan dan tidak dapat diprediksi (algoritma kontrol yang saya temukan bekerja dengan tidak sempurna).  Lalu kolega saya memberi tahu saya cara membuat keyboard.  Dan saya memutuskan untuk melakukan hal yang sama, sekarang saya polling negara setiap 0,005 detik (kenapa begitu, dan siapa yang tahu).  Dan jika sudah berubah, kirim nilainya ke server. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.pins : p = self.pins[pin] status = p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GPIO.input(pin) == GPIO.HIGH : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] != status : p[<span class="hljs-string"><span class="hljs-string">'callback'</span></span>](pin) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: GPIO.cleanup()</code> </pre><br><h3 id="42-dzhoystik">  4.2 Joystick </h3><br><p>  <strong>Pembacaan bacaan</strong> dilakukan melalui papan <strong>ADS1115</strong> melalui bus I2C, oleh karena itu, perpustakaan yang sesuai untuk itu adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Adafruit_PCA9685</a> .  Joystick juga rentan terhadap obrolan kontak, jadi saya mengambil bacaan dengan analogi dengan keyboard. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: X = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">0</span></span>, gain=self.GAIN) / HardwareSetting.valueStep Y = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">1</span></span>, gain=self.GAIN) / HardwareSetting.valueStep <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> X &gt; HardwareSetting.xZero : X = X - HardwareSetting.xZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : X = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.xZero - X) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Y &gt; HardwareSetting.yZero : Y = Y - HardwareSetting.yZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : Y = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.yZero - Y) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(X) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : X = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(Y) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : Y = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(self.x - X) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abs(self.y - Y) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span>) : self.sendCmd(round(X), round(Y)) self.x = X self.y = Y time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>)</code> </pre> <br><p>  Saat diberdayakan dari 3,3 volt, rentang nilai yang diberikan ADS1115 dengan joystick dari 0 ... 26500.  Saya membawa ini ke kisaran -100 ... 100.  Dalam kisaran saya sekitar 0 selalu berfluktuasi, jadi jika nilainya tidak melebihi 5, maka saya menganggap bahwa itu adalah 0 (jika tidak maka akan banjir).  Segera setelah nilai berubah, kirim ke mesin tik. </p><br><h3 id="43-podklyuchenie-k-serveru-upravleniya">  4.3 Menghubungkan ke server manajemen </h3><br><p>  Menghubungkan ke server adalah hal sederhana: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> : tcpClient = socket.socket(socket.AF_INET, socket.SOCK_STREAM) tcpClient.settimeout(<span class="hljs-number"><span class="hljs-number">2.0</span></span>) tcpClient.connect((conf.conf.ServerIP, conf.conf.controlServerPort)) self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"+"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.tcpClient = tcpClient <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> socket.error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"-"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> time.sleep(conf.conf.timeRecconect) self.tcpClient = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.tcpClient : self.tcpClient.settimeout(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p>  Tapi saya ingin memperhatikan satu hal.  Jika Anda tidak menggunakan batas waktu dalam koneksi, maka itu dapat membeku dan Anda harus menunggu sekitar beberapa menit (ini terjadi ketika klien mulai sebelum server).  Saya memecahkan ini dengan cara berikut, saya mengatur batas waktu untuk koneksi.  Segera setelah koneksi terjadi, saya menghapus batas waktu. </p><br><p>  Saya juga menyimpan status koneksi, sehingga saya akan tahu jika kontrol hilang dan menampilkannya di layar. </p><br><h3 id="44-proverka-podklyucheniya-k-wifi">  4.4 Memeriksa koneksi WiFi </h3><br><p>  Saya memeriksa status wifi untuk koneksi ke server.  Dan jika, saya juga memberi tahu diri saya tentang masalah. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">1.0</span></span>) self.ps = subprocess.Popen([<span class="hljs-string"><span class="hljs-string">'iwgetid'</span></span>], stdout=subprocess.PIPE, stderr=subprocess.STDOUT) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: output = subprocess.check_output((<span class="hljs-string"><span class="hljs-string">'grep'</span></span>, <span class="hljs-string"><span class="hljs-string">'ESSID'</span></span>), stdin=self.ps.stdout) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> re.search(<span class="hljs-string"><span class="hljs-string">r'djvu-car-pi3'</span></span>, str(output)) : self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi+'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> subprocess.CalledProcessError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi-'</span></span>) self.ps.kill()</code> </pre> <br><h3 id="45-podklyuchenie-k-video-serveru">  4.5 Menghubungkan ke server video </h3><br><p>  Untuk ini, semua kekuatan <strong>Qt5 diperlukan</strong> , dengan cara distribusi <strong>Peregangan</strong> lebih baru dan menurut saya menunjukkan lebih baik.  pada <strong>jessie</strong> saya mencoba juga. </p><br><p>  Untuk tampilan saya menggunakan: </p><br><pre> <code class="python hljs">self.videoWidget = QVideoWidget()</code> </pre> <br><p>  Dan dia menyimpulkan: </p><br><pre> <code class="python hljs">self.mediaPlayer = QMediaPlayer(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, QMediaPlayer.LowLatency) self.mediaPlayer.setVideoOutput(self.videoWidget)</code> </pre> <br><p>  Koneksi ke streaming video: </p><br><pre> <code class="python hljs">self.mediaPlayer.setMedia(QMediaContent(QUrl(<span class="hljs-string"><span class="hljs-string">"http://{}:{}/?action=stream"</span></span>.format(conf.conf.ServerIP, conf.conf.videoServerPort)))) self.mediaPlayer.play()</code> </pre> <br><p>  Sekali lagi, saya minta maaf untuk tautologi).  Saya memantau status koneksi video untuk koneksi ke server video.  Dan jika, saya juga memberi tahu diri saya tentang masalah. </p><br><p>  Ini adalah tampilannya ketika semuanya tidak berfungsi: </p><br><p><img src="https://habrastorage.org/webt/ea/6a/ug/ea6augn3vrdv3ejjom8v6qrnpvu.jpeg" alt="gambar"></p><br><ul><li>  <strong>W</strong> - berarti tidak ada koneksi dengan wifi </li><li>  <strong>B</strong> - berarti tidak ada video </li><li>  <strong>Y</strong> - artinya tidak ada kontrol </li></ul><br><p>  Kalau tidak ada huruf merah, ada video dari kamera.  Saya akan memposting foto dan video dengan pekerjaan di masa depan) Saya berharap bahwa mount untuk kamera akan datang dalam waktu dekat dan akhirnya saya akan memasangnya secara normal. </p><br><h3 id="5-nastroyka-raspberry-os">  5 Mengkonfigurasi Raspberry OS </h3><br><p>  Ngomong-ngomong, bekerja dengan kamera dan hal-hal lain yang diperlukan harus dihidupkan (baik pada klien maupun pada server).  Setelah memuat OS: </p><br><p><img src="https://habrastorage.org/webt/ex/ye/gz/exyegz24x9ec0ee0cdp7qpm5kog.jpeg" alt="gambar"></p><br><p>  Dan nyalakan hampir semuanya: kamera, ssh, i2c, gpio </p><br><p><img src="https://habrastorage.org/webt/ye/fu/z4/yefuz4_ioqh5g1j_f1n1mgwf_cg.png" alt="gambar"></p><br><h3 id="demonstraciya">  Demonstrasi </h3><br><p>  Hanya ada saluran video (kamera tetap bekerja).  Saya minta maaf atas ketidakhadirannya, saya akan melampirkannya pada hari Senin. </p><br><img alt="Topi permainan" width="400" src="https://habrastorage.org/webt/5q/yt/ox/5qytoxmp0ojxi7bheduksv8qipg.jpeg"><br><p>  Pekerjaan video: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/D6ZT90L6q00" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3 id="ishodnye-kody">  Kode sumber </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Server dan kode sumber klien</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Paket startup server daemon</a> </p><br><h3 id="ssylki">  Referensi </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 1</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 3</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id462331/">https://habr.com/ru/post/id462331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id462321/index.html">SEO Internasional | Faktor peringkat SEO internasional</a></li>
<li><a href="../id462323/index.html">Obesitas - Santai dan Libatkan</a></li>
<li><a href="../id462325/index.html">Pekerja Web lebih mudah dari yang Anda kira</a></li>
<li><a href="../id462327/index.html">Mencicit tumor kanker: para ilmuwan dari NUST "MISiS" telah mengembangkan USG laser untuk diagnosis kanker</a></li>
<li><a href="../id462329/index.html">Memindahkan catu daya ke bagian depan sasis</a></li>
<li><a href="../id462333/index.html">Membuat chatbot percakapan sederhana dengan python</a></li>
<li><a href="../id462335/index.html">Jangan membaca, baca kembali</a></li>
<li><a href="../id462337/index.html">Statistik situs dan repositori kecil Anda</a></li>
<li><a href="../id462339/index.html">Bagaimana pelatihan genggam terkait dengan standar internal Amazon dan bagaimana pengaruhnya terhadap pandangan dunia perusahaan?</a></li>
<li><a href="../id462347/index.html">Sepuluh hari pertama dalam perjalanan dari burung hantu ke burung awal: tidur, diet, diet dan olahraga</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>