<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏴 🚏 👩🏿‍🔬 Python: Metaprogrammierung in der Produktion. Teil zwei 👩🏿‍🚀 💫 🔕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir sprechen weiterhin über Metaprogrammierung in Python. Bei korrekter Verwendung können Sie komplexe Entwurfsmuster schnell und elegant implementier...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python: Metaprogrammierung in der Produktion. Teil zwei</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/binarydistrict/blog/422415/"><p>  Wir sprechen weiterhin über Metaprogrammierung in Python.  Bei korrekter Verwendung können Sie komplexe Entwurfsmuster schnell und elegant implementieren.  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">letzten Teil</a> dieses Artikels haben wir gezeigt, wie Metaklassen verwendet werden können, um die Attribute von Instanzen und Klassen zu ändern. </p><br><p><img src="https://habrastorage.org/webt/ls/ty/gh/lstyghddpotgif7f6jg8cl6kcbi.jpeg"></p><br><p> Nun wollen wir sehen, wie Sie Methodenaufrufe ändern können.  Weitere Informationen zu Metaprogrammierungsoptionen finden Sie im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Advanced Python-</a> Kurs. </p><a name="habracut"></a><br><h2 id="otladka-i-treysing-vyzovov">  Debuggen und Verfolgen von Anrufen </h2><br><p>  Wie Sie bereits verstanden haben, kann mit einer Metaklasse jede Klasse bis zur Unkenntlichkeit transformiert werden.  Ersetzen Sie beispielsweise alle Klassenmethoden durch andere oder wenden Sie auf jede Methode einen beliebigen Dekorator an.  Mit dieser Idee können Sie die Anwendungsleistung debuggen. </p><br><p>  Die folgende Metaklasse misst die Ausführungszeit jeder Methode in der Klasse und ihren Instanzen sowie die Erstellungszeit der Instanz selbst: </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> contextlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> contextmanager <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wrapt @contextmanager <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timing_context</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(operation_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       """</span></span> start_time = time.time() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: logging.info(<span class="hljs-string"><span class="hljs-string">'Operation "%s" completed in %0.2f seconds'</span></span>, operation_name, time.time() - start_time) @wrapt.decorator <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(func, instance, args, kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       .     https://wrapt.readthedocs.io/en/latest/         """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> timing_context(func.__name__): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> func(*args, **kwargs) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DebugMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, method <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs.items(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> attr.startswith(<span class="hljs-string"><span class="hljs-string">'_'</span></span>): <span class="hljs-comment"><span class="hljs-comment">#     attrs[attr] = timing(method) return super().__new__(mcs, name, bases, attrs) def __call__(cls, *args, **kwargs): with timing_context(f'{cls.__name__} instance creation'): #      return super().__call__(*args, **kwargs)</span></span></code> </pre> <br><p>  Schauen wir uns das Debuggen in Aktion an: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=DebugMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name time.sleep(<span class="hljs-number"><span class="hljs-number">.7</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">.5</span></span>) user = User(<span class="hljs-string"><span class="hljs-string">'Michael'</span></span>) user.login() user.logout() user.create() <span class="hljs-comment"><span class="hljs-comment">#   INFO:__main__:Operation "User instance creation" completed in 0.70 seconds INFO:__main__:Operation "login" completed in 1.00 seconds INFO:__main__:Operation "logout" completed in 2.00 seconds INFO:__main__:Operation "create" completed in 0.50 seconds</span></span></code> </pre> <br><p>  Versuchen Sie, <code>DebugMeta</code> und die Signatur der Methoden und deren Stack-Trace zu protokollieren. </p><br><h2 id="pattern-odinochka-i-zapret-nasledovaniya">  Das Einzelgängermuster und das Erbverbot </h2><br><p>  Kommen wir nun zu exotischen Fällen der Verwendung von Metaklassen in Python-Projekten. </p><br><p>  Sicherlich verwenden viele von Ihnen das übliche Python-Modul, um ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Singleton-</a> Entwurfsmuster (auch bekannt als Singleton) zu implementieren, da es viel bequemer und schneller ist als das Schreiben der entsprechenden Metaklasse.  Lassen Sie uns jedoch eine seiner Implementierungen aus Gründen des akademischen Interesses schreiben: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> instance = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cls.instance <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: cls.instance = super().__call__(*args, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cls.instance <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=Singleton)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">f'&lt;User: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.name}</span></span></span><span class="hljs-string">&gt;'</span></span> u1 = User(<span class="hljs-string"><span class="hljs-string">'Pavel'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#         u2 = User('Stepan') &gt;&gt;&gt; id(u1) == id(u2) True &gt;&gt;&gt; u2 &lt;User: Pavel&gt; &gt;&gt;&gt; User.instance &lt;User: Pavel&gt; #   , ? &gt;&gt;&gt; u1.instance.instance.instance.instance &lt;User: Pavel&gt;</span></span></code> </pre> <br><p>  Diese Implementierung hat eine interessante Nuance: Da der Klassenkonstruktor nicht zum zweiten Mal aufgerufen wird, können Sie einen Fehler machen und den erforderlichen Parameter dort nicht übergeben. Zur Laufzeit geschieht nichts, wenn die Instanz bereits erstellt wurde.  Zum Beispiel: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>User(<span class="hljs-string"><span class="hljs-string">'Roman'</span></span>) &lt;User: Roman&gt; &gt;&gt;&gt; User(<span class="hljs-string"><span class="hljs-string">'Alexey'</span></span>, <span class="hljs-string"><span class="hljs-string">'Petrovich'</span></span>, <span class="hljs-number"><span class="hljs-number">66</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     ! &lt;User: Roman&gt; #     User       #    TypeError!</span></span></code> </pre> <br><p>  Schauen wir uns nun eine noch exotischere Option an: ein Verbot der Vererbung von einer bestimmten Klasse. </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FinalMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cls <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bases: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(cls, FinalMeta): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> TypeError(<span class="hljs-string"><span class="hljs-string">f"Can't inherit </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{name}</span></span></span><span class="hljs-string"> class from final </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{cls.__name__}</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(mcs, name, bases, attrs) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=FinalMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   !"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(A)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment"># TypeError: Can't inherit B class from final A #    !</span></span></code> </pre> <br><h2 id="parametrizaciya-metaklassov">  Metaklassenparametrierung </h2><br><p>  In den vorherigen Beispielen haben wir Metaklassen verwendet, um die Erstellung von Klassen anzupassen. Sie können jedoch noch weiter gehen und mit der Parametrisierung des Verhaltens von Metaklassen beginnen. </p><br><p>  Beispielsweise können Sie beim Deklarieren einer Klasse eine Funktion an den Metaklassenparameter übergeben und abhängig von bestimmten Bedingungen verschiedene Instanzen von Metaklassen zurückgeben, z. B.: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_meta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> SOME_SETTING: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MetaClass1(name, bases, attrs) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MetaClass2(name, bases, attrs) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=get_meta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  Ein interessanteres Beispiel ist jedoch die Verwendung von <code>extra_kwargs</code> Parametern beim Deklarieren von Klassen.  Angenommen, Sie möchten die Metaklasse verwenden, um das Verhalten bestimmter Methoden in einer Klasse zu ändern, und jede Klasse hat möglicherweise unterschiedliche Namen für diese Methoden.  Was tun?  Und hier ist was </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   `DebugMeta`     class DebugMetaParametrized(type): def __new__(mcs, name, bases, attrs, **extra_kwargs): debug_methods = extra_kwargs.get('debug_methods', ()) for attr, value in attrs.items(): #      ,   #    `debug_methods`: if attr in debug_methods: attrs[attr] = timing(value) return super().__new__(mcs, name, bases, attrs) class User(metaclass=DebugMetaParametrized, debug_methods=('login', 'create')): ... user = User('Oleg') user.login() #  "logout"   . user.logout() user.create()</span></span></code> </pre> <br><p>  Meiner Meinung nach ist es sehr elegant geworden!  Sie können sich viele Muster für die Verwendung dieser Parametrisierung einfallen lassen, aber denken Sie an die Hauptregel - alles ist in Maßen gut. </p><br><h2 id="primery-ispolzovaniya-metoda-__prepare__">  <code>__prepare__</code> Methodenbeispiele </h2><br><p>  Abschließend werde ich über die mögliche Verwendung der <code>__prepare__</code> Methode <code>__prepare__</code> .  Wie oben erwähnt, sollte diese Methode ein Wörterbuchobjekt zurückgeben, das der Interpreter zum Zeitpunkt des Parsens des Klassenkörpers ausfüllt. Wenn <code>__prepare__</code> beispielsweise das Objekt <code>d = dict()</code> zurückgibt, dann beim Lesen der folgenden Klasse: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">:</span></span> x = <span class="hljs-number"><span class="hljs-number">12</span></span> y = <span class="hljs-string"><span class="hljs-string">'abc'</span></span> z = {<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>  Der Interpreter führt die folgenden Operationen aus: </p><br><pre> <code class="python hljs">d[<span class="hljs-string"><span class="hljs-string">'x'</span></span>] = <span class="hljs-number"><span class="hljs-number">12</span></span> d[<span class="hljs-string"><span class="hljs-string">'y'</span></span>] = <span class="hljs-string"><span class="hljs-string">'abc'</span></span> d[<span class="hljs-string"><span class="hljs-string">'z'</span></span>] = {<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>  Es gibt mehrere Verwendungsmöglichkeiten für diese Funktion.  Sie sind alle von unterschiedlichem Nutzen, also: </p><br><ol><li>  Wenn wir in Versionen von Python = &lt;3.5 die Reihenfolge der Deklaration von Methoden in einer Klasse <code>__prepare__</code> , können wir <code>collections.OrderedDict</code> <code>__prepare__</code> von der <code>__prepare__</code> -Methode. In älteren Versionen <code>__prepare__</code> integrierte Wörterbücher bereits die Reihenfolge des Hinzufügens von Schlüsseln bei, sodass <code>OrderedDict</code> nicht mehr benötigt wird. </li><li>  Das <code>enum</code> Standardbibliotheksmodul verwendet ein benutzerdefiniertes diktartiges Objekt, um zu bestimmen, wann ein Klassenattribut bei der Deklaration dupliziert wird.  Den Code finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </li><li>  Überhaupt kein produktionsbereiter Code, aber ein sehr gutes Beispiel ist die Unterstützung des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">parametrischen Polymorphismus</a> . </li></ol><br><p>  Betrachten Sie beispielsweise die folgende Klasse mit drei Implementierungen einer einzelnen polymorphen Methode: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Terminator</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">terminate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x: int)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">f'Terminating INTEGER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{x}</span></span></span><span class="hljs-string">'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">terminate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x: str)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">f'Terminating STRING </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{x}</span></span></span><span class="hljs-string">'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">terminate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x: dict)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">f'Terminating DICTIONARY </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{x}</span></span></span><span class="hljs-string">'</span></span>) t1000 = Terminator() t1000.terminate(<span class="hljs-number"><span class="hljs-number">10</span></span>) t1000.terminate(<span class="hljs-string"><span class="hljs-string">'Hello, world!'</span></span>) t1000.terminate({<span class="hljs-string"><span class="hljs-string">'hello'</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span>}) <span class="hljs-comment"><span class="hljs-comment">#  Terminating DICTIONARY 10 Terminating DICTIONARY Hello, world! Terminating DICTIONARY {'hello': 'world'}</span></span></code> </pre> <br><p>  Offensichtlich überschreibt die zuletzt deklarierte <code>terminate</code> Methode die Implementierungen der ersten beiden, und wir müssen die Methode abhängig von der Art des übergebenen Arguments auswählen.  Um dies zu erreichen, programmieren wir einige zusätzliche Wrapper-Objekte: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PolyDict</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(dict)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" ,               PolyMethod. """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__setitem__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key: str, func)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> key.startswith(<span class="hljs-string"><span class="hljs-string">'_'</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self: super().__setitem__(key, PolyMethod()) self[key].add_implementation(func) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__setitem__(key, func) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PolyMethod</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    ,            .       ,       : instance method, staticmethod, classmethod. """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.implementations = {} self.instance = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.cls = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, instance, cls)</span></span></span><span class="hljs-function">:</span></span> self.instance = instance self.cls = cls <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_callable_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, impl)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ""  classmethod/staticmethod return getattr(impl, '__func__', impl) def __call__(self, arg): impl = self.implementations[type(arg)] callable_func = self._get_callable_func(impl) if isinstance(impl, staticmethod): return callable_func(arg) elif self.cls and isinstance(impl, classmethod): return callable_func(self.cls, arg) else: return callable_func(self.instance, arg) def add_implementation(self, func): callable_func = self._get_callable_func(func) #   ,     1  arg_name, arg_type = list(callable_func.__annotations__.items())[0] self.implementations[arg_type] = func</span></span></code> </pre> <br><p>  Das Interessanteste im obigen Code ist das <code>PolyMethod</code> Objekt, in dem je nach Art des an diese Methode übergebenen Arguments eine Registrierung mit Implementierungen derselben Methode <code>PolyMethod</code> wird.  Wir werden das <code>PolyDict</code> Objekt von der <code>__prepare__</code> Methode zurückgeben und dabei verschiedene Implementierungen der Methoden mit dem gleichen Namen <code>terminate</code> speichern.  Ein wichtiger Punkt: Beim Lesen des Klassenkörpers und beim Erstellen des <code>attrs</code> Objekts platziert der Interpreter die sogenannten <code>unbound</code> Funktionen dort. Diese Funktionen wissen noch nicht, auf welche Klasse oder Instanz sie aufgerufen werden.  Wir mussten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Deskriptorprotokoll</a> implementieren, um den Kontext während des Funktionsaufrufs zu definieren und entweder <code>self</code> oder <code>cls</code> als ersten Parameter zu übergeben oder nichts zu übergeben, wenn <code>staticmethod</code> aufgerufen wird. </p><br><p>  Als Ergebnis werden wir die folgende Magie sehen: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PolyMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__prepare__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PolyDict() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Terminator</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=PolyMeta)</span></span></span><span class="hljs-class">:</span></span> ... t1000 = Terminator() t1000.terminate(<span class="hljs-number"><span class="hljs-number">10</span></span>) t1000.terminate(<span class="hljs-string"><span class="hljs-string">'Hello, world!'</span></span>) t1000.terminate({<span class="hljs-string"><span class="hljs-string">'hello'</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span>}) <span class="hljs-comment"><span class="hljs-comment">#  Terminating INTEGER 10 Terminating STRING Hello, world! Terminating DICTIONARY {'hello': 'world'} &gt;&gt;&gt; t1000.terminate &lt;__main__.PolyMethod object at 0xdeadcafe&gt;</span></span></code> </pre> <br><p>  Wenn Sie andere interessante Anwendungen der <code>__prepare__</code> -Methode kennen, schreiben Sie bitte in die Kommentare. </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Metaprogrammierung ist eines von vielen Themen, über die ich in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Advanced Python gesprochen habe</a> .  Im Rahmen des Kurses werde ich Ihnen auch erklären, wie Sie die Prinzipien von SOLID und GRASP bei der Entwicklung großer Python-Projekte effektiv einsetzen, die Anwendungsarchitektur entwerfen und leistungsstarken und qualitativ hochwertigen Code schreiben können.  Ich werde mich freuen, Sie in den Mauern des Binary District zu sehen! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de422415/">https://habr.com/ru/post/de422415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de422403/index.html">20. September, Moskau - ein Treffen für Analysten</a></li>
<li><a href="../de422407/index.html">Suchen und sortieren Sie verwandte Texte</a></li>
<li><a href="../de422409/index.html">Python: Metaprogrammierung in der Produktion. Teil eins</a></li>
<li><a href="../de422411/index.html">Neue Rollen in Unternehmen im Zeitalter des Service</a></li>
<li><a href="../de422413/index.html">Anwendung von Arm Mbed OS. Feinabstimmung</a></li>
<li><a href="../de422417/index.html">Slavik und GMT + 3 oder Nutzen für Menschen</a></li>
<li><a href="../de422419/index.html">Nicht ohne Panik in Go</a></li>
<li><a href="../de422421/index.html">Microsoft wird Skype radikal verbessern</a></li>
<li><a href="../de422423/index.html">Python und DataScience: Entdecken Sie die Leistungsfähigkeit der Numpy Universal Library</a></li>
<li><a href="../de422425/index.html">Ein Überblick über Nachbearbeitungsmethoden für FDM 3D-gedruckte Modelle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>