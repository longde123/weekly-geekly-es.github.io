<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíô üßöüèø üë©üèø‚Äçüé§ Replicaci√≥n l√≥gica entre versiones de PostgreSQL üé∫ üë£ ü•Ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Existen diferentes enfoques para actualizar PostgreSQL, pero algunos conducen al tiempo de inactividad. Si desea evitar el tiempo de inactividad, use ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Replicaci√≥n l√≥gica entre versiones de PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/457512/"><p><img src="https://habrastorage.org/webt/yl/pr/hs/ylprhs3ilpoukerjhyvwdnj6kmu.png"></p><br><p>  Existen diferentes enfoques para actualizar PostgreSQL, pero algunos conducen al tiempo de inactividad.  Si desea evitar el tiempo de inactividad, use la replicaci√≥n para actualizar: l√≥gica o f√≠sica (transmisi√≥n), seg√∫n el escenario.  En este art√≠culo, veremos la diferencia entre la replicaci√≥n l√≥gica y f√≠sica en PostgreSQL.  Luego, hablaremos en detalle sobre c√≥mo actualizar la versi√≥n mediante la replicaci√≥n l√≥gica y evitar el tiempo de inactividad de la aplicaci√≥n.  El <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pr√≥ximo art√≠culo</a> discutir√° la replicaci√≥n f√≠sica. </p><br><p>  En art√≠culos anteriores, ya hablamos sobre los m√©todos para actualizar PostgreSQL ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Actualizaci√≥n de PostgreSQL usando pg_dumpall</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Actualizaci√≥n de PostgreSQL usando pg_dump / pg_restore</a> ) como parte de la serie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Actualizaci√≥n o Migraci√≥n de versiones antiguas de PostgreSQL</a> .  Pero ambos m√©todos no excluyen el tiempo de inactividad. </p><a name="habracut"></a><br><h2 id="tipy-logicheskoy-replikacii">  Tipos de replicaci√≥n l√≥gica </h2><br><p>  Aqu√≠ discutimos 2 tipos de replicaci√≥n: </p><br><ul><li>  Replicaci√≥n entre PostgreSQL 10 y 11 usando replicaci√≥n l√≥gica incorporada. </li><li>  Replicaci√≥n entre PostgreSQL 9.4 (o anterior a PG 11) y PostgreSQL 11 usando la extensi√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pglogical</a> . </li></ul><br><p>  Para minimizar el tiempo de inactividad, puede actualizar mediante la replicaci√≥n.  Cuando todos los datos relevantes se replican en otro servidor PostgreSQL m√°s reciente, simplemente transfiere la aplicaci√≥n al nuevo servidor con un tiempo de inactividad m√≠nimo, aunque, por supuesto, todo depende de la complejidad de la pila de aplicaciones. </p><br><p>  <strong>La replicaci√≥n l√≥gica</strong> en PostgreSQL permite a los usuarios replicar tablas selectivamente y abrir un servidor de respaldo para operaciones de escritura.  <strong>La replicaci√≥n f√≠sica</strong> en PostgreSQL se realiza en bloques.  En este caso, cada base de datos en el asistente se replica en el servidor de respaldo, inaccesible para escribir operaciones.  A continuaci√≥n, llamaremos <strong>transmisi√≥n de</strong> replicaci√≥n f√≠sica. </p><br><p> Al usar la replicaci√≥n l√≥gica en un servidor en espera, puede habilitar la replicaci√≥n desde m√∫ltiples maestros.  Esto es √∫til en situaciones en las que necesita replicar datos de m√∫ltiples bases de datos PostgreSQL (OLTP) en un solo servidor PostgreSQL para informes y almacenamiento de datos. </p><br><p>  La principal ventaja de la replicaci√≥n l√≥gica sobre la transmisi√≥n es que con la replicaci√≥n l√≥gica, puede replicar los cambios de la versi√≥n anterior de PostgreSQL a la nueva.  La replicaci√≥n de flujo solo funciona cuando el servidor maestro y el servidor de respaldo tienen la misma versi√≥n principal.  Idealmente, las versiones adicionales tambi√©n deber√≠an coincidir. </p><br><h3 id="replikaciya-mezhdu-versiyami-postgresql-10-i-11">  Replicaci√≥n entre PostgreSQL 10 y 11 </h3><br><p>  A partir de PostgreSQL 10, la replicaci√≥n l√≥gica est√° disponible de forma predeterminada.  Por lo tanto, puede replicar f√°cilmente la base de datos PostgreSQL 10 en PostgreSQL 11. La replicaci√≥n l√≥gica utiliza el modelo de publicaci√≥n y suscripci√≥n.  El nodo que env√≠a los cambios se convierte en el editor.  Y el nodo que se suscribe a estos cambios se convierte en suscriptor.  Puede haber varias suscripciones por publicaci√≥n. </p><br><h3 id="publikaciya">  Publicar </h3><br><p>  Una publicaci√≥n es una matriz de cambios creados por un grupo de tablas.  Se llama <strong>conjunto de</strong> <strong>cambios</strong> o <strong>conjunto de replicaci√≥n</strong> .  Las publicaciones solo pueden contener tablas, pero no otros objetos.  DML en estas tablas se puede replicar, pero DDL no. </p><br><p>  En la publicaci√≥n, puede elegir qu√© tipo de DML replicar: INSERTAR, ELIMINAR, ACTUALIZAR o TODOS.  Por defecto, TODO est√° seleccionado.  La tabla debe tener un identificador de r√©plica para replicar las operaciones UPDATE y DELETE al suscriptor.  Los identificadores de r√©plica lo ayudan a encontrar filas que se actualizan o eliminan. </p><br><p>  La clave principal de la tabla es el identificador de r√©plica predeterminado.  O puede hacer que el identificador sea un √≠ndice √∫nico con valores NOT NULL.  Si no tiene una clave principal o un √≠ndice √∫nico con valores NO NULL, establezca replica_identity en FULL.  En este caso, Postgres usa la cadena completa como clave.  Pero esto no es muy racional. </p><br><p>  Si una tabla sin una clave principal y un identificador de r√©plica se agrega a la publicaci√≥n de forma predeterminada despu√©s de una operaci√≥n ACTUALIZAR o ELIMINAR, pueden producirse errores. </p><br><h3 id="podpiska">  Suscripci√≥n </h3><br><p>  Un suscriptor puede suscribirse a una o m√°s publicaciones.  Antes de agregar una suscripci√≥n, aseg√∫rese de que las tablas replicadas se creen en el nodo del suscriptor.  Para hacer esto, volcar solo los esquemas del editor al suscriptor. </p><br><h3 id="primer-logicheskoy-replikacii">  Ejemplo de replicaci√≥n l√≥gica </h3><br><p>  <strong>El siguiente ejemplo describe la replicaci√≥n l√≥gica solo entre las versiones 10 y 11 de PostgreSQL.</strong> </p><br><p>  Cree una publicaci√≥n en el sitio del editor.  Agregue todas o solo algunas tablas a la publicaci√≥n. </p><br><pre><code class="plaintext hljs">-- For adding ALL Tables in Database CREATE PUBLICATION percpub FOR ALL TABLES; -- For adding Selected Tables in Database CREATE PUBLICATION percpub FOR TABLE scott.employee scott.departments;</code> </pre> <br><p>  En el sitio del suscriptor, cree una suscripci√≥n a esta publicaci√≥n.  Realice un volcado DDL de las tablas al suscriptor antes de crear la suscripci√≥n, como se mencion√≥ anteriormente. </p><br><pre> <code class="plaintext hljs">$ pg_dump -h publisher_server_ip -p 5432 -d percona -Fc -s -U postgres | pg_restore -d percona -h subscriber_node_ip -p 5432 -U postgres CREATE SUBSCRIPTION percsub CONNECTION 'host=publisher_server_ip dbname=percona user=postgres password=secret port=5432' PUBLICATION percpub;</code> </pre> <br><p>  Este comando tambi√©n copia datos existentes en las tablas.  Si desea deshabilitar la copia de datos existentes, use el siguiente comando y solo se copiar√°n los cambios al editor. </p><br><pre> <code class="plaintext hljs">CREATE SUBSCRIPTION percsub CONNECTION 'host=publisher_server_ip dbname=percona user=postgres password=oracle port=5432' PUBLICATION percpub WITH (copy_data = false);</code> </pre> <br><p>  Rastree la replicaci√≥n utilizando el siguiente comando en el nodo del editor: </p><br><pre> <code class="plaintext hljs">$ psql \x select * from pg_stat_replication;</code> </pre> <br><h3 id="replikaciya-mezhdu-postgresql-94-i-postgresql-11">  Replicaci√≥n entre PostgreSQL 9.4 y PostgreSQL 11 </h3><br><p>  ¬øQu√© hacer con versiones anteriores a PostgreSQL 10?  Para las versiones 9.4 a 11 hay una extensi√≥n especial: <code>pglogical</code> .  Con pglogical, puede replicar PostgreSQL 9.4 en PostgreSQL 11 de dos maneras. </p><br><p>  Las siguientes son instrucciones generales para configurar la replicaci√≥n entre PG 9.4 y PG 11 utilizando la extensi√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pglogical</a> . </p><br><p>  <strong>Paso 1.</strong> Considere pgserver_94 como el servidor de origen con la base de datos percona_94 en PostgreSQL 9.4.  Crea la siguiente extensi√≥n. <br>  codigo </p><br><pre> <code class="plaintext hljs">[pgserver_94:] $psql -d percona_94 -c "CREATE EXTENSION pglogical_origin" CREATE EXTENSION [pgserver_94:] $psql -d percona_94 -c "CREATE EXTENSION pglogical" CREATE EXTENSION</code> </pre> <br><p>  <strong>Paso 2.</strong> Ahora agregue todas o algunas de las tablas al esquema o varios esquemas para la replicaci√≥n.  En el siguiente ejemplo, ve un error porque una de las tablas no tiene una clave primaria. </p><br><pre> <code class="plaintext hljs">[pgserver_94:] $psql -d percona_94 psql (9.4.21) Type "help" for help. percona_94=# SELECT pglogical.create_node(node_name := 'provider1',dsn := 'host=192.168.0.24 port=5432 dbname=percona_94'); create_node ------------- 2976894835 (1 row) percona_94=# SELECT pglogical.replication_set_add_all_tables('default', ARRAY['public']); ERROR: table pgbench_history cannot be added to replication set default DETAIL: table does not have PRIMARY KEY and given replication set is configured to replicate UPDATEs and/or DELETEs HINT: Add a PRIMARY KEY to the table percona_94=# ALTER TABLE pgbench_history ADD PRIMARY KEY (tid,aid,delta); ALTER TABLE percona_94=# SELECT pglogical.replication_set_add_all_tables('default', ARRAY['public']); replication_set_add_all_tables -------------------------------- t (1 row)</code> </pre> <br><p>  <strong>Paso 3.</strong> En el nodo del suscriptor, es decir, en la base de datos PostgreSQL 11, ejecute los siguientes comandos. </p><br><pre> <code class="plaintext hljs">[pgserver_11:] $psql -d percona_11 psql (11.2) Type "help" for help. percona_11=# SELECT pglogical.create_node(node_name := 'subscriber1',dsn := 'host=127.0.0.1 port=5432 dbname=percona_11 password=secret'); create_node ------------- 330520249 (1 row) percona_11=# SELECT pglogical.create_subscription(subscription_name := 'subscription1',provider_dsn := 'host=192.168.0.24 port=5432 dbname=percona_94 password=secret'); create_subscription --------------------- 1763399739 (1 row)</code> </pre> <br><p>  <strong>Paso 4.</strong> Luego verifique el estado de replicaci√≥n enviando una solicitud a varias tablas, que pglogical siempre actualiza: </p><br><pre> <code class="plaintext hljs">percona_11=# select * from pglogical.local_sync_status; sync_kind | sync_subid | sync_nspname | sync_relname | sync_status | sync_statuslsn -----------+------------+--------------+------------------+-------------+---------------- f | 1763399739 | public | pgbench_accounts | r | 0/2EB7D48 f | 1763399739 | public | pgbench_history | r | 0/2EB7D48 f | 1763399739 | public | pgbench_tellers | r | 0/2EB7D48 f | 1763399739 | public | pgbench_branches | r | 0/2EB7D48 d | 1763399739 | | | r | 0/0 (5 rows) percona_11=# select * from pglogical.subscription; sub_id | sub_name | sub_origin | sub_target | sub_origin_if | sub_target_if | sub_enabled | sub_slot_name | sub_rep lication_sets | sub_forward_origins | sub_apply_delay ------------+---------------+------------+------------+---------------+---------------+-------------+----------------------------------------+---------------- -----------------------+---------------------+----------------- 1763399739 | subscription1 | 2976894835 | 330520249 | 2402836775 | 2049915666 | t | pgl_percona_11_provider1_subscription1 | {default,defaul t_insert_only,ddl_sql} | {all} | 00:00:00 (1 row)</code> </pre> <br><h3 id="vybor-pervichnogo-klyucha">  Selecci√≥n de clave primaria </h3><br><p>  En el segundo paso, vio c√≥mo todas las tablas en el esquema p√∫blico se agregaron al conjunto de replicaci√≥n al crear una clave primaria para una tabla que no ten√≠a una.  Es posible que haya elegido la clave primaria incorrecta para esta tabla, pero esto es solo para demostraci√≥n.  Al elegir una clave principal, aseg√∫rese de que sea correcta.  Debe ser √∫nico y usar columnas que no contengan valores NULL.  Si no encuentra la clave primaria correcta, esto puede provocar el tiempo de inactividad de la aplicaci√≥n.  Aqu√≠ hay un ejemplo de un error que puede ocurrir: </p><br><pre> <code class="plaintext hljs">[pgserver_94:] $pgbench -c 10 -T 300 -n percona_94 Client 7 aborted in state 12: ERROR: duplicate key value violates unique constraint "pgbench_history_pkey" DETAIL: Key (tid, aid, delta)=(7, 63268, 2491) already exists.</code> </pre> <br><p>  Aqu√≠ se explica c√≥mo usar pglogical para crear una replicaci√≥n entre las versiones antigua y nueva de PostgreSQL.  Despu√©s de configurar la replicaci√≥n, simplemente cambie las aplicaciones a la √∫ltima versi√≥n para que el tiempo de inactividad sea m√≠nimo. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/457512/">https://habr.com/ru/post/457512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457496/index.html">"Encuentra las cinco diferencias". Diferencia escalable y generacional: nuevo lote de pruebas</a></li>
<li><a href="../457500/index.html">C√≥mo hicimos el piloto autom√°tico para una estaci√≥n de servicio</a></li>
<li><a href="../457504/index.html">¬øPor qu√© escribir su cuadr√≠cula de datos de reacci√≥n en 2019?</a></li>
<li><a href="../457508/index.html">Parenting vs Machine Learning: compara una madre joven</a></li>
<li><a href="../457510/index.html">Use mcrouter para escalar memcached horizontalmente</a></li>
<li><a href="../457514/index.html">Nevanger</a></li>
<li><a href="../457516/index.html">Escribir un modelo de amenaza</a></li>
<li><a href="../457518/index.html">Plasma Cash Chain como soluci√≥n al trilema de escalabilidad de blockchain</a></li>
<li><a href="../457522/index.html">¬øAumentar el servicio de su lista de correo o usar soluciones preparadas? Lo que aprend√≠ durante 5 a√±os en UniSender</a></li>
<li><a href="../457524/index.html">C√°maras de profundidad: revoluci√≥n silenciosa (cuando los robots lo ver√°n) Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>