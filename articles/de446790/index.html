<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíò üì∏ üë®üèø Wie ich in der Sicherheit von Android ein Osterei entdeckte und keinen Job bei Google bekam ü§òüèª üöÆ üîº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Google liebt Ostereier. Es liebt sie so sehr, dass man sie in praktisch jedem ihrer Produkte finden kann. Die Tradition der Android-Ostereier begann i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie ich in der Sicherheit von Android ein Osterei entdeckte und keinen Job bei Google bekam</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446790/"><img src="https://habrastorage.org/webt/cx/0o/3t/cx0o3tqoavfz_opnsomw9-65h_i.jpeg" align="left">  Google liebt Ostereier.  Es liebt sie so sehr, dass man sie in praktisch jedem ihrer Produkte finden kann.  Die Tradition der Android-Ostereier begann in den fr√ºhesten Versionen des Betriebssystems (ich denke, jeder dort wei√ü, was passiert, wenn Sie in die allgemeinen Einstellungen gehen und einige Male auf die Versionsnummer tippen). <br><br>  Aber manchmal findet man an den unwahrscheinlichsten Orten ein Osterei.  Es gibt sogar eine urbane Legende, dass eines Tages ein Programmierer ‚ÄûMutex Lock‚Äú gegoogelt hat, aber statt Suchergebnisse auf foo.bar gelandet ist, alle Aufgaben gel√∂st und einen Job bei Google bekommen hat. <br><br><div class="spoiler">  <b class="spoiler_title">Wiederaufbau</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/157/242/ffc/157242ffcbf299f7a67641f9df1e551e.jpg" alt="Bild"><br></div></div><br>  Das gleiche (au√üer ohne Happy End) ist mir passiert.  Versteckte Nachrichten, in denen es definitiv keine geben konnte, Java-Code und seine nativen Bibliotheken, eine geheime VM, ein Google-Interview - all das finden Sie weiter unten. <br><a name="habracut"></a><br><h3>  Droidenschutz </h3><br>  In einer langweiligen Nacht habe ich mein Telefon auf die Werkseinstellungen zur√ºckgesetzt und es erneut eingerichtet.  Das Wichtigste zuerst: Bei einer neuen Android-Installation wurde ich aufgefordert, mich bei Google anzumelden.  Und ich fragte mich: Wie funktioniert die Anmeldung bei Android √ºberhaupt?  Und die Nacht wurde pl√∂tzlich weniger langweilig. <br><br>  Ich verwende die Burp Suite von PortSwigger, um den Netzwerkverkehr abzufangen und zu analysieren.  Die kostenlose Community-Version reicht f√ºr unsere Zwecke aus.  Um die https-Anforderungen anzuzeigen, m√ºssen Sie zuerst das PortSwigger-Zertifikat auf dem Ger√§t installieren.  Als Testger√§t habe ich mir ein 8 Jahre altes Samsung Galaxy S mit Android 4.4 ausgesucht.  Alles neuere als das und Sie k√∂nnten Probleme mit dem Anheften von Zertifikaten und so weiter haben. <br><br>  Ehrlich gesagt gibt es bei Google API-Anfragen nichts Besonderes.  Das Ger√§t sendet Informationen √ºber sich selbst und erh√§lt als Antwort Token ... Der einzige merkw√ºrdige Schritt ist eine POST-Anfrage an den Anti-Missbrauchs-Dienst. <br><br><img src="https://habrastorage.org/webt/nv/4c/7n/nv4c7njt_zecyvp0vquekhnoxbm.png"><br><br>  Nachdem die Anfrage gestellt wurde, erscheint unter zahlreichen sehr normalen Parametern ein interessanter Parameter namens <b>droidguard_result</b> .  Es ist eine sehr lange Base64-Zeichenfolge: <br><br><img src="https://habrastorage.org/webt/kp/h3/i-/kph3i-1n7tw9dv-ckitddw4rxdm.png"><br><br>  DroidGuard ist Googles Mechanismus zum Erkennen von Bots und Emulatoren auf realen Ger√§ten.  SafetyNet verwendet beispielsweise auch die Daten von DroidGuard.  Google hat eine √§hnliche Sache auch f√ºr Browser - Botguard. <br><br>  Aber was sind das f√ºr Daten?  Lass es uns herausfinden. <br><br><h3>  Protokollpuffer </h3><br>  Was erzeugt diesen Link ( <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI</a></i> ) und was in Android macht diese Anfrage?  Nach einer kurzen Untersuchung stellte sich heraus, dass sich der Link in genau dieser Form in einer der verschleierten Klassen von Google Play Services befindet: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context var1, bdh var2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(var1, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI"</span></span>, var2); }</code> </pre> <br>  Wie wir bereits in Burp gesehen haben, haben POST-Anforderungen auf diesem Link den <b>Inhaltstyp</b> - <b>application / x-protobuf</b> (Google Protocol Buffers, Googles Protokoll f√ºr die bin√§re Serialisierung).  Es ist jedoch kein Json - es ist schwierig herauszufinden, was genau gesendet wird. <br><br>  Protokollpuffer funktionieren folgenderma√üen: <br><br><ul><li>  Zuerst beschreiben wir die Struktur der Nachricht in einem speziellen Format und speichern sie in einer .proto-Datei. </li><li>  Dann kompilieren wir .proto-Dateien und der Protoc-Compiler generiert Quellcode in einer ausgew√§hlten Sprache (im Fall von Android ist es Java). </li><li>  Schlie√ülich verwenden wir die generierten Klassen in unserem Projekt. </li></ul><br>  Wir haben zwei M√∂glichkeiten, Protobuf-Nachrichten zu dekodieren.  Der erste besteht darin, einen Protobuf-Analysator zu verwenden und zu versuchen, die urspr√ºngliche Beschreibung der .proto-Dateien wiederherzustellen.  Die zweite besteht darin, die von Protokollen generierten Klassen aus Google Play Services herauszurei√üen, was ich beschlossen habe. <br><br>  Wir verwenden die APK-Datei von Google Play Services mit derselben Version, die auf dem Ger√§t installiert ist (oder, wenn das Ger√§t gerootet ist, nehmen Sie die Datei direkt von dort).  Mit dex2jar konvertieren wir die .dex-Datei zur√ºck in .jar und √∂ffnen sie in einem Dekompiler Ihrer Wahl.  Ich pers√∂nlich mag JetBrains 'Fernflower.  Es funktioniert als Plugin f√ºr IntelliJ IDEA (oder Android Studio), daher starten wir einfach Android Studio und √∂ffnen die Datei mit dem Link, den wir analysieren m√∂chten.  Wenn sich Proguard nicht zu sehr bem√ºht hat, kann der dekompilierte Java-Code zum Erstellen von Protobuf-Nachrichten einfach in Ihr Projekt kopiert werden. <br><br>  Wenn wir uns den dekompilierten Code ansehen, sehen wir, dass Build. * Konstanten innerhalb der Protobuf-Nachricht gesendet werden.  (Okay, das war nicht zu schwer zu erraten). <br><br><pre> <code class="java hljs">... var3.a(<span class="hljs-string"><span class="hljs-string">"4.0.33 (910055-30)"</span></span>); a(var3, <span class="hljs-string"><span class="hljs-string">"BOARD"</span></span>, Build.BOARD); a(var3, <span class="hljs-string"><span class="hljs-string">"BOOTLOADER"</span></span>, Build.BOOTLOADER); a(var3, <span class="hljs-string"><span class="hljs-string">"BRAND"</span></span>, Build.BRAND); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI"</span></span>, Build.CPU_ABI); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI2"</span></span>, Build.CPU_ABI2); a(var3, <span class="hljs-string"><span class="hljs-string">"DEVICE"</span></span>, Build.DEVICE); ...</code> </pre><br>  Leider wurden in der Antwort des Servers alle Protobuf-Felder nach der Verschleierung zu Buchstabensuppe.  Mit einem Fehlerhandler k√∂nnen wir jedoch herausfinden, was sich dort befindet.  So werden die vom Server kommenden Daten √ºberpr√ºft: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.d()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"byteCode"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.f()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmUrl"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.h()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmChecksum"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.j()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"expiryTimeSecs"</span></span>); }</code> </pre><br>  Anscheinend wurden Felder vor der Verschleierung so aufgerufen: <b>byteCode</b> , <b>vmUrl</b> , <b>vmChecksum</b> und <b>expiryTimeSecs</b> .  Dieses Namensschema gibt uns bereits einige Ideen. <br><br>  Wir kombinieren alle dekompilierten Klassen von Google Play Services zu einem Testprojekt, benennen sie um, generieren Testbuild. * Befehle und starten (imitieren jedes gew√ºnschten Ger√§ts).  Wenn jemand es selbst machen will, ist hier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der Link zu meinem GitHub</a> . <br><br>  Wenn die Anforderung korrekt ist, gibt der Server Folgendes zur√ºck: <br><blockquote>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - byteCode size: 34446 <br>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - vmChecksum: C15E93CCFD9EF178293A2334A1C9F9B08F115993 <br>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - vmUrl: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.gstatic.com/droidguard/C15E93CCFD9EF178293A2334A1C9F9B08F115993</a> <br>  00: 06: 26.761 [main] INFO daresponse.AntiabuseResponse - expiryTimeSecs: 10 </blockquote><br>  Schritt 1 abgeschlossen.  Nun wollen wir sehen, was sich hinter dem <b>vmUrl-</b> Link <b>verbirgt</b> . <br><br><h3>  Geheime APK </h3><br>  Der Link f√ºhrt uns direkt zu einer APK-Datei, die nach ihrem eigenen SHA-1-Hash benannt ist.  Es ist ziemlich klein - nur 150 KB.  Und es ist durchaus gerechtfertigt: Wenn es von jedem der 2 Milliarden Android-Ger√§te heruntergeladen wird, sind das 270 TB Verkehr auf den Google-Diensten. <br><br><img src="https://habrastorage.org/webt/-s/di/nj/-sdinjinilpprsvgslvs3e6gsdk.png"><br><br>  <code>DroidGuardService</code> Klasse, die Teil von Google Play Services ist, l√§dt die Datei auf das Ger√§t herunter, entpackt sie, extrahiert .dex und verwendet die <code>com.google.ccc.abuse.droidguard.DroidGuard</code> Klasse durch Reflektion.  Wenn ein Fehler <code>DroidGuardService</code> wechselt DroidGuardService von DroidGuard zur√ºck zu Droidguasso.  Aber das ist eine ganz andere Geschichte. <br><br>  Im Wesentlichen ist die <code>DroidGuard</code> Klasse ein einfacher JNI-Wrapper um die native .so-Bibliothek.  Der ABI der nativen Bibliothek stimmt mit dem √ºberein, was wir im Feld <code>CPU_ABI</code> in der Protobuf-Anfrage gesendet haben: Wir k√∂nnen nach Armeabi, x86 oder sogar MIPS fragen. <br><br>  Der <code>DroidGuardService</code> Dienst selbst enth√§lt keine interessante Logik f√ºr die Arbeit mit der <code>DroidGuard</code> Klasse.  Es wird einfach eine neue Instanz von <code>DroidGuard</code> , der <b>ByteCode</b> aus der Protobuf-Nachricht gesendet und eine √∂ffentliche Methode aufgerufen, die ein Byte-Array zur√ºckgibt.  Dieses Array wird dann innerhalb des Parameters <b>droidguard_result</b> an den Server <b>gesendet</b> . <br><br>  Um eine ungef√§hre Vorstellung davon zu bekommen, was in <code>DroidGuard</code> , k√∂nnen wir die Logik von <code>DroidGuardService</code> wiederholen (jedoch ohne die APK herunterzuladen, da wir bereits √ºber die native Bibliothek verf√ºgen).  Wir k√∂nnen eine .dex-Datei aus der geheimen APK nehmen, sie in .jar konvertieren und dann in unserem Projekt verwenden.  Das einzige Problem ist, wie die <code>DroidGuard</code> Klasse die native Bibliothek l√§dt.  Der statische Initialisierungsblock ruft die Methode <code>loadDroidGuardLibrary()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { loadDroidGuardLibrary(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(ex); } }</code> </pre><br>  Anschlie√üend liest die Methode <code>loadDroidGuardLibrary()</code> die Datei library.txt (im Stammverzeichnis der APK-Datei) und l√§dt die Bibliothek mit diesem Namen √ºber den <code>System.load(String filename)</code> .  F√ºr uns nicht sehr praktisch, da wir die APK auf eine ganz bestimmte Art und Weise erstellen m√ºssten, um die Datei library.txt und die Datei .so in das Stammverzeichnis zu stellen.  Es w√§re viel bequemer, die .so-Datei im lib-Ordner zu <code>System.loadLibrary(String libname)</code> und √ºber <code>System.loadLibrary(String libname)</code> . <br><br>  Es ist nicht schwer zu tun.  Wir werden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">smali / baksmali</a> - Assembler / Disassembler f√ºr .dex-Dateien verwenden.  Nach der Verwendung verwandelt sich classes.dex in eine Reihe von .smali-Dateien.  Die Klasse <code>com.google.ccc.abuse.droidguard.DroidGuard</code> sollte so ge√§ndert werden, dass der statische Initialisierungsblock die Methode <code>System.loadLibrary("droidguard")</code> anstelle von <code>loadDroidGuardLibrary()</code> .  Die Syntax von Smali ist ziemlich einfach. Der neue Initialisierungsblock sieht folgenderma√üen aus: <br><br><pre> <code class="plaintext hljs">.method static constructor &lt;clinit&gt;()V .locals 1 const-string v0, "droidguard" invoke-static {v0}, Ljava/lang/System;-&gt;loadLibrary(Ljava/lang/String;)V return-void .end method</code> </pre><br>  Dann verwenden wir backsmali, um alles wieder in .dex zu erstellen, und konvertieren es dann in .jar.  Am Ende erhalten wir eine .jar-Datei, die wir in unserem Projekt verwenden k√∂nnen - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier ist es</a> √ºbrigens. <br><br>  Der gesamte DroidGuard-bezogene Abschnitt ist ein paar Zeichenfolgen lang.  Der wichtigste Teil besteht darin, das Byte-Array, das wir im vorherigen Schritt nach dem Adressieren des Anti-Missbrauchs-Dienstes erhalten haben, herunterzuladen und an den <code>DroidGuard</code> Konstruktor <code>DroidGuard</code> : <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runDroidguard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteCode: ByteArray? = loadBytecode(<span class="hljs-string"><span class="hljs-string">"bytecode.base64"</span></span>); byteCode?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> droidguard = DroidGuard(applicationContext, <span class="hljs-string"><span class="hljs-string">"addAccount"</span></span>, it) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> params = mapOf(<span class="hljs-string"><span class="hljs-string">"dg_email"</span></span> to <span class="hljs-string"><span class="hljs-string">"test@gmail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_gmsCoreVersion"</span></span> to <span class="hljs-string"><span class="hljs-string">"910055-30"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_package"</span></span> to <span class="hljs-string"><span class="hljs-string">"com.google.android.gms"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_androidId"</span></span> to UUID.randomUUID().toString()) droidguard.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = droidguard.ss(params) droidguard.close() } }</code> </pre><br>  Jetzt k√∂nnen wir den Profiler von Android Studio verwenden und sehen, was w√§hrend der Arbeit von DroidGuard passiert: <br><br><img src="https://habrastorage.org/webt/c-/9w/pz/c-9wpzbrrpibjyflhyrunq3azu0.png"><br><br>  Die native Methode initNative () sammelt Daten √ºber das Ger√§t und ruft die Java-Methoden <code>hasSystemFeature(), getMemoryInfo(), getPackageInfo()</code> ... das ist etwas, aber ich sehe immer noch keine solide Logik.  Nun, alles was bleibt ist, die .so-Datei zu zerlegen. <br><br><h3>  libdroidguard.so </h3><br>  Gl√ºcklicherweise ist die Analyse der nativen Bibliothek nicht schwieriger als die mit .dex- und .jar-Dateien.  Wir ben√∂tigen eine App √§hnlich Hex-Rays IDA und einige Kenntnisse in x86- oder ARM-Assembler-Code.  Ich habe mich f√ºr ARM entschieden, da ich ein gerootetes Ger√§t zum Debuggen hatte.  Wenn Sie keine haben, k√∂nnen Sie eine x86-Bibliothek nehmen und mit einem Emulator debuggen. <br><br>  Eine App √§hnlich Hex-Rays IDA dekompiliert die Bin√§rdatei in etwas, das C-Code √§hnelt.  Wenn wir die Methode <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_ssNative</code> √∂ffnen, sehen wir <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_ssNative</code> : <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a3, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a4, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a5, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a6, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a7, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a8, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a9)</span></span></span><span class="hljs-function"> ... v14 </span></span>= (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">684</span></span>))(v9, a5); v15 = (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">736</span></span>))(v9, a5, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  Sieht nicht zu vielversprechend aus.  Zuerst m√ºssen wir ein paar vorbereitende Schritte machen, um dies in etwas N√ºtzlicheres umzuwandeln.  Der Dekompiler wei√ü nichts √ºber JNI, daher installieren wir Android NDK und importieren die Datei jni.h.  Wie wir wissen, sind die ersten beiden Parameter einer JNI-Methode <code>JNIEnv*</code> und <code>jobject (this)</code> .  Wir k√∂nnen die Arten anderer Parameter aus dem Java-Code von DroidGuard herausfinden.  Nach dem Zuweisen der richtigen Typen werden bedeutungslose Offsets zu JNI-Methodenaufrufen: <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_JNIEnv *env, jobject thiz, jobject context, jstring flow, jbyteArray byteCode, jobject runtimeApi, jobject extras, jint loggingFd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> runningInAppSide)</span></span></span><span class="hljs-function"> </span></span>{ ... programLength = _env-&gt;functions-&gt;GetArrayLength)(_env, byteCode); programBytes = (jbyte *)_env-&gt;functions-&gt;GetByteArrayElements)(_env, byteCode, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  Wenn wir genug Geduld haben, um das vom Anti-Missbrauchsserver empfangene Byte-Array zu verfolgen, werden wir ... entt√§uscht sein.  Leider gibt es keine einfache Antwort auf "Was passiert hier?".  Es ist reiner, destillierter Bytecode, und die native Bibliothek ist eine virtuelle Maschine.  Einige AES-Verschl√ºsselungen wurden dar√ºber gestreut, und dann liest die VM den Bytecode Byte f√ºr Byte und f√ºhrt Befehle aus.  Jedes Byte ist ein Befehl, gefolgt von Operanden.  Es gibt nicht viele Befehle, nur ungef√§hr 70: read int, read byte, read string, Java-Methode aufrufen, zwei Zahlen multiplizieren, if-goto usw. <br><br><h3>  Wach auf, neo </h3><br>  Ich beschloss, noch weiter zu gehen und die Struktur des Bytecodes f√ºr diese VM herauszufinden.  Es gibt ein weiteres Problem mit den Aufrufen: Manchmal (alle paar Wochen) gibt es eine neue Version der nativen Bibliothek, in der Byte-Befehlspaare verschl√ºsselt werden.  Es hat mich nicht aufgehalten und ich habe beschlossen, die VM mit Java neu zu erstellen. <br><br>  Der Bytecode erledigt alle Routinearbeiten zum Sammeln von Informationen √ºber das Ger√§t.  Beispielsweise l√§dt es einen String mit dem Namen einer Methode, erh√§lt seine Adresse √ºber dlsym und wird ausgef√ºhrt.  In meiner Java-Version der VM habe ich nur etwa f√ºnf Methoden neu erstellt und gelernt, die ersten 25 Befehle des Bytecodes des Anti-Missbrauchs-Dienstes zu interpretieren.  Beim 26. Befehl las die VM eine weitere verschl√ºsselte Zeichenfolge aus dem Bytecode.  Es stellte sich pl√∂tzlich heraus, dass es kein Name einer anderen Methode ist.  Weit davon entfernt. <br><blockquote>  Befehl # 26 der virtuellen Maschine <br>  Methodenaufruf vm-&gt; vm_method_table [2 * 0x77] <br>  Methode vmMethod_readString <br>  Index ist 0x9d <br>  Die Zeichenfolgenl√§nge betr√§gt 0x0066 <br>  (neuer Schl√ºssel wird generiert) <br>  codierte Zeichenfolgenbytes sind EB 4E E6 DC 34 13 35 4A DD 55 B3 91 33 05 61 04 C0 54 FD 95 2F 18 72 04 C1 55 E1 92 28 11 66 04 DD 4F B3 94 33 04 35 0A C1 4E B2 DB 12 17 79 4F 92 55 FC DB 33 05 35 45 C6 01 F7 89 29 1F 71 43 C7 40 E1 9F 6B 1E 70 48 DE 4E B8 CD 75 44 23 14 85 14 A7 C2 7F 40 26 42 84 17 A2 BB 21 19 7A 43 DE 44 BD 98 29 1B <br>  decodierte String-Bytes sind 59 6F 75 27 72 65 20 6E 6F 74 20 6A 75 73 74 20 72 75 6E 6E 69 6E 67 20 73 74 72 69 6E 67 73 20 6F 6E 20 6F 75 72 20 2E 73 6F 21 20 54 61 6C 6B 20 74 6F 20 75 73 20 61 74 20 64 72 6F 69 64 67 75 61 72 64 2D 68 65 6C 6C 6F 2B 36 33 32 36 30 37 35 34 39 39 36 33 66 36 36 31 40 67 6F 6F 67 6C 65 2E 63 6F 6D <br>  Der dekodierte Zeichenfolgenwert ist ( <b>Sie f√ºhren nicht nur Zeichenfolgen auf unserer .so aus! Sprechen Sie mit uns unter droidguard@google.com</b> ) </blockquote>  Das ist seltsam.  Eine virtuelle Maschine hat noch nie mit mir gesprochen.  Ich dachte, wenn du geheime Nachrichten siehst, die an dich gerichtet sind, wirst du verr√ºckt.  Um sicherzugehen, dass ich immer noch gesund bin, habe ich √ºber meine VM ein paar hundert verschiedene Antworten vom Anti-Missbrauchs-Dienst gesendet.  Buchst√§blich alle 25-30 Befehle war eine Nachricht im Bytecode versteckt.  Sie werden oft wiederholt, aber unten sind einige einzigartige aufgef√ºhrt.  Ich habe die E-Mail-Adressen jedoch bearbeitet: Jede Nachricht hatte eine andere Adresse, etwa "droidguard+tag@google.com", wobei das Tag f√ºr jede eindeutig ist. <br><blockquote>  droidguard@google.com: Sei kein Fremder! <br>  Du bist reingekommen!  Sprechen Sie mit uns unter droidguard@google.com <br>  Gr√º√üe von droidguard@google.com unerschrockener Reisender!  Sag hallo! <br>  War es leicht, das zu finden?  droidguard@google.com w√ºrde gerne wissen <br>  Die Leute unter droidguard@google.com w√ºrden sich freuen, von Ihnen zu h√∂ren! <br>  Was ist das alles f√ºr ein Gobbledy-Buch?  Fragen Sie droidguard@google.com ... sie w√ºrden es wissen! <br>  Hey!  Lust dich hier zu sehen.  Haben Sie schon mit droidguard@google.com gesprochen? <br>  Sie laufen nicht nur auf unserer .so!  Sprechen Sie mit uns unter droidguard@google.com <br></blockquote>  Bin ich der Auserw√§hlte?  Ich dachte, es sei an der Zeit, nicht mehr mit DroidGuard zu spielen und mit Google zu sprechen, da sie mich danach fragten. <br><br><h3>  Ihr Anruf ist uns sehr wichtig </h3><br>  Ich habe meine Ergebnisse in der E-Mail mitgeteilt, die ich gefunden habe.  Um die Ergebnisse ein wenig eindrucksvoller zu machen, habe ich den Analyseprozess ein wenig automatisiert.  Die Sache ist, Strings und Byte-Arrays werden verschl√ºsselt im Byte-Code gespeichert.  Die VM decodiert sie mit vom Compiler eingef√ºgten Konstanten.  Mit einer App √§hnlich Hex-Rays IDA k√∂nnen Sie sie ziemlich einfach extrahieren.  Aber mit jeder neuen Version √§ndern sich die Konstanten und es ist ziemlich unpraktisch, sie immer manuell zu extrahieren. <br><br>  Das Java-Parsen der nativen Bibliothek erwies sich jedoch als √ºberraschend einfach.  Mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jelf</a> (einer Bibliothek zum Parsen von ELF-Dateien) finden wir den Offset der <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</code> Methode in der Bin√§rdatei. Mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Capstone</a> (einem disassemblierenden Framework mit Bindungen f√ºr verschiedene Sprachen, einschlie√ülich Java) erhalten wir Assembler-Code und suchen ihn zum Laden von Konstanten Register. <br><br>  Am Ende habe ich eine App bekommen, die den gesamten DroidGuard-Prozess emuliert: eine Anfrage an den Anti-Missbrauchs-Dienst stellt, die APK herunterl√§dt, sie entpackt, die native Bibliothek analysiert, die erforderlichen Konstanten extrahiert, die Zuordnung von VM-Befehlen ausw√§hlt und interpretiert den Bytecode.  Ich habe alles zusammengestellt und an Google gesendet.  W√§hrend ich dabei war, bereitete ich mich auf einen Umzug vor und suchte bei Glassdoor nach einem Durchschnittsgehalt bei Google.  Ich beschloss, nicht weniger als sechs Ziffern zuzustimmen. <br><br>  Die Antwort dauerte nicht lange.  Eine E-Mail von einem Mitglied des DroidGuard-Teams lautete einfach: "Warum machst du das √ºberhaupt?" <br><br><img src="https://habrastorage.org/webt/go/ql/kf/goqlkffwq02w6daa9-e22xxgdiq.jpeg"><br><br>  "Weil ich kann" - antwortete ich.  Ein Google-Mitarbeiter erkl√§rte mir, dass DroidGuard Android vor Hackern sch√ºtzen soll (sagen Sie nicht!). Es w√§re ratsam, den Quellcode meiner DroidGuard-VM f√ºr mich zu behalten.  Dort endete unser Gespr√§ch. <br><br><h3>  Interview </h3><br>  Einen Monat sp√§ter erhielt ich eine weitere E-Mail.  Das DroidGuard-Team in Z√ºrich brauchte einen neuen Mitarbeiter.  War ich daran interessiert mitzumachen?  Nat√ºrlich! <br><br>  Es gibt keine Verkn√ºpfungen, um in Google zu gelangen.  Mein Kontakt konnte lediglich meinen Lebenslauf an die Personalabteilung weiterleiten.  Danach musste ich das √ºbliche b√ºrokratische Rigmarol und eine Reihe von Interviews durchlaufen. <br><br>  Es gibt viele Geschichten √ºber Google-Interviews.  Algorithmen, Olympiadenaufgaben und Google Docs-Programmierung sind nicht mein Ding, deshalb habe ich mit meinen Vorbereitungen begonnen.  Ich habe den Kurs ‚ÄûAlgorithmen‚Äú von Coursera Dutzende Male durchgelesen, Hunderte von Aufgaben auf Hackerrank gel√∂st und gelernt, mit geschlossenen Augen einen Graphen in beiden Dimensionen zu umgehen. <br><br>  Zwei Monate vergingen.  Zu sagen, dass ich mich vorbereitet f√ºhlte, w√§re eine Untertreibung.  Google Text &amp; Tabellen wurde meine Lieblings-IDE.  Ich hatte das Gef√ºhl, alles √ºber Algorithmen zu wissen.  Nat√ºrlich kannte ich meine Schw√§chen und erkannte, dass ich die Serie von 5 Interviews in Z√ºrich wahrscheinlich nicht bestehen w√ºrde, aber kostenlos ins Disneyland des Programmierers zu gehen, war eine Belohnung f√ºr sich.  Der erste Schritt war ein Telefoninterview, um die schw√§chsten Kandidaten auszusortieren und nicht die Zeit der Z√ºrcher Entwickler mit pers√∂nlichen Besprechungen zu verschwenden.  Der Tag war eingestellt, das Telefon klingelte ... <br><br><img src="https://habrastorage.org/webt/5c/nk/uh/5cnkuh5btyvoaz0pyz-zma3flzs.png"><br><br>  ... und ich habe meinen ersten Test sofort nicht bestanden.  Ich hatte Gl√ºck - sie stellten eine Frage, die ich zuvor im Internet gesehen und bereits gel√∂st habe.  Es ging darum, ein String-Array zu serialisieren.  Ich habe angeboten, Zeichenfolgen in Base64 zu codieren und durch einen Teiler zu speichern.  Der Interviewer bat mich, einen Base64-Algorithmus zu entwickeln.  Danach wurde das Interview zu einer Art Monolog, in dem mir das Interview erkl√§rte, wie Base64 funktioniert, und ich versuchte, mich an Bitoperationen in Java zu erinnern. <br><br><div class="spoiler">  <b class="spoiler_title">Wenn jemand bei Google dies liest</b> <div class="spoiler_text">  Leute, ihr seid verdammte Genies, wenn ihr dort ankommt!  Im Ernst.  Ich kann mir nicht vorstellen, wie man alle Hindernisse beseitigen kann, die sie vor Ihnen haben. <br></div></div><br>  3 Tage nach dem Anruf erhielt ich eine E-Mail mit dem Hinweis, dass sie mich nicht weiter interviewen m√∂chten.  Und so endete meine Kommunikation mit Google. <br><br>  Warum es in DroidGuard Nachrichten gibt, die zum Chatten auffordern, wei√ü ich immer noch nicht.  Wahrscheinlich nur f√ºr Statistiken.  Der Typ, an den ich zuerst schrieb, sagte mir, dass die Leute dort tats√§chlich schreiben, aber die H√§ufigkeit variiert: Manchmal erhalten sie 3 Antworten pro Woche, manchmal 1 pro Jahr. <br><br>  Ich glaube, es gibt einfachere M√∂glichkeiten, ein Interview bei Google zu bekommen.  Schlie√ülich k√∂nnte man einfach einen der 100.000 Mitarbeiter fragen (obwohl zugegebenerma√üen nicht alle Entwickler sind).  Aber es war trotzdem eine lustige Erfahrung. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de446790/">https://habr.com/ru/post/de446790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de446776/index.html">Arbeitsnachweis wirksam</a></li>
<li><a href="../de446780/index.html">Wie man ein dunkles Thema erstellt und nicht schadet. Yandex.Mail Team Erfahrung</a></li>
<li><a href="../de446782/index.html">Yo-ho-ho und eine Flasche Rum</a></li>
<li><a href="../de446786/index.html">Warum ich Disqus verlassen habe und du gehen musst</a></li>
<li><a href="../de446788/index.html">Tipps und Tricks von Kubernetes: Informationen zur lokalen Entwicklung und Telepr√§senz</a></li>
<li><a href="../de446794/index.html">Wir arbeiten korrekt mit Wordstat. Komplette Anleitung</a></li>
<li><a href="../de446796/index.html">Nicht standardm√§√üige Schaltung: Sieben-Segment-Anzeige bei ATtiny13</a></li>
<li><a href="../de446798/index.html">Der Abgang eines Elektronikingenieurs von Apple sorgte bei Aktienspekulanten f√ºr Aufsehen. Wie werde ich wie er?</a></li>
<li><a href="../de446802/index.html">Punktkassetten nachf√ºllen - das ist interessant</a></li>
<li><a href="../de446806/index.html">Hintergrund: "Autonomous Runet" - was ist das und wer braucht es?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>