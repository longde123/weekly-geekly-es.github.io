<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò† üìΩÔ∏è üåÖ DIY KVM IP 3.0 üïì üíº üßõüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il s'agit de la troisi√®me variation sur le th√®me IP KVM, cette fois le concept a √©t√© compl√®tement r√©vis√©, commen√ßons √† construire quelque chose de nou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY KVM IP 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/406059/"> Il s'agit de la troisi√®me variation sur le th√®me IP KVM, cette fois le concept a √©t√© compl√®tement r√©vis√©, commen√ßons √† construire quelque chose de nouveau.  Il y aura beaucoup de choses int√©ressantes, ne quittez pas l'√©cran.  Un autre appareil inhabituel appara√Ætra, nous √©liminerons presque tous les anciens composants, retournerons √† notre arduino natif et jouerons un petit pirate. <br><br>  Pour ceux qui viennent de rejoindre, un r√©sum√© des √©pisodes pr√©c√©dents: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Premier article</a> <br>  Collect√© IP KVM sur Arduino et Raspberry Pi, il s'est av√©r√© co√ªteux et avec une mauvaise qualit√© vid√©o. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Deuxi√®me article</a> <br>  OrangePI et Atmega16u2, appris √† moindre co√ªt, mais la qualit√© d'image est toujours d√©go√ªtante. </li></ul><br>  Et enfin, dans cet article, tous les inconv√©nients des pr√©c√©dents seront corrig√©s.  Un accent particulier sera mis sur la r√©duction maximale du co√ªt des composants. <br><a name="habracut"></a><br>  <b>Par tradition, nous consid√©rons les composants du dispositif assembl√©:</b> <br><br>  <b>1.</b> Notre vieil ami Atmega16u2: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d38/32f/4a0/d3832f4a098f4cf8abe96103b11496a3.jpg"></div><br>  Il s'agit du seul composant qui passera des articles pr√©c√©dents. <br><br>  <b>2. Le</b> fameux ESP8266, en l'occurrence ESP8266-12e: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/d3/d9/59d3d9e494103245224131.jpeg"></div><br>  Vous pouvez utiliser une autre version de l'ESP8266, il vous suffit de prendre en compte le nombre et l'emplacement des ports. <br><br>  <b>3.</b> Et, en fait, le h√©ros de l'occasion LKV373A <br><br><img src="https://habrastorage.org/webt/59/d3/da/59d3da94466d8417530057.jpeg"><br><br>  Gr√¢ce √† cet appareil, il est devenu possible de transmettre de la vid√©o sur un r√©seau local √† haute <br>  r√©solution jusqu'√† full-HD. <br><br><h3>  Le plan d'action est le suivant: </h3><br><ol><li>  Cache-cache: Nous recherchons LKV373A o√π il s'est cach√© sur le r√©seau sous quelle adresse ip </li><li>  Jeu de piratage: remplissez le firmware, r√©initialisez les mots de passe et configurez LKV373A </li><li>  Se faire de nouveaux amis: ESP8266, IDE Arduino et images amusantes </li><li>  La finale de la c√©l√©bration.  Nous connectons tous les composants et transmettons les touches via telnet </li></ol><br><h3>  LKV373A Background </h3><br>  Commen√ßons donc!  LKV373A ou appareil HDMI Extender pour capturer des images directement √† partir du port HDMI et les diffuser sur le r√©seau local, ces appareils sont √©galement appel√©s extensions HDMI.  Comme pr√©vu par les fabricants, un ensemble de ces appareils devrait √™tre compos√© d'un √©metteur (√©metteur) et d'un r√©cepteur (r√©cepteur), respectivement de la d√©signation TX et RX.  Ils devraient √™tre utilis√©s, probablement, afin d'apporter plus de b√©n√©fices au fabricant, uniquement par paires.  Mais il y avait un homme, sous le surnom de Danman, voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> vers son blog, qui s'int√©ressait √† son fonctionnement.  Il a ouvert Wireshark, a renifl√© le trafic transmis par l'appareil TX, qu'est-ce qui s'est av√©r√© √™tre? <br><br>  Le flux vid√©o est transmis sans aucun cryptage, et en utilisant VLC Player, vous pouvez le regarder sans trop d'effort.  Mais il ne s'est pas arr√™t√© l√†, "ressenti": il a tir√© l'interface web, TTL, telnet, et m√™me tir√© le firmware avec le programmeur.  Il en a parl√© en d√©tail sur son blog.  Le firmware qui nous int√©resse en premier lieu y a √©galement √©t√© t√©l√©charg√©: IPTV_TX_PKG_v4_0_0_0_20160427.PKG.  Dans ce firmware, l'interface Web avec des param√®tres avanc√©s, et pas comme celle standard, n'a que le bouton de mise √† jour.  De plus, ce firmware a un telnet avec de nombreuses commandes √† configurer.  C'est avec ce firmware que nous reconfigurons le HDMI Extender pour nos t√¢ches.  J'ai post√© le firmware et tout ce dont j'avais besoin sur github, voici le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> , nous en aurons besoin plus tard, mais pour l'instant nous terminons avec la th√©orie.  Passons √† la pratique. <br><br><h2>  √âmetteur </h2><br><h3>  Nous recherchons LKV373A dans le r√©seau </h3><br>  Je suis tomb√© entre les mains du m√™me r√©p√©teur que Danman (y).  Tout ce qui sera d√©crit ci-dessous convient sp√©cifiquement √† la version HDMI Extender LKV373A V3.0! <br><br>  Nous connectons le LKV373A au r√©seau local, allumez-le.  Essayons maintenant de nous assurer que le p√©riph√©rique est visible sur le r√©seau <code>ping 192.168.1.238</code> . <br><br>  192.168.1.238 est l'adresse IP par d√©faut.  Si le r√©p√©teur ne modifie pas l'ancienne adresse du micrologiciel, qu'il y ait ou non un serveur DHCP sur le r√©seau.  Les versions plus r√©centes du micrologiciel utilisent IP par d√©faut uniquement si le p√©riph√©rique n'a pas pu obtenir une adresse aupr√®s de DHCP.  Si vous avez re√ßu une r√©ponse au ping, continuez.  Sinon, ne d√©sesp√©rez pas, essayez de connecter le r√©p√©teur directement au port LAN de l'ordinateur et utilisez le renifleur. <br><br><h3>  Clignotant </h3><br>  Extender HDMI trouv√©, passez au firmware.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Allons</a> dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> et t√©l√©chargeons tout ce qui y est pr√©sent√©.  Ouvrez maintenant l'interface Web de l'extendeur via un navigateur et voyez l'image suivante: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d91fbcc37298629734.png"><br><br>  Cliquez sur "Parcourir ...", s√©lectionnez le firmware, un fichier appel√© IPTV_TX_PKG_v4_0_0_0_20160427.PKG, et cliquez sur "Mettre √† niveau".  Tadam!  Le firmware est termin√©, connectez-vous maintenant au LKV373A par telnet pour r√©initialiser le mot de passe. <br><br>  La commande de connexion ressemblera √† Telnet 192.168.1.238 9999, o√π 9999 est le port auquel se connecter.  CEP pr√©vient: l'adresse obtenue de DHCP peut √™tre trouv√©e √† l'aide d'un scanner r√©seau. <br><br><h3>  Se connecter via telnet </h3><br>  Lors de la connexion, le message suivant doit appara√Ætre: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;</code> </pre><br>  Nous √©crivons la <code>list</code> .  En r√©ponse, nous obtenons une liste de commandes: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;list set_group_id get_group_id set_dhcp get_dhcp set_uart_baudrate get_uart_baudrate set_static_ip get_static_ip set_mac_address get_mac_address get_lan_status get_hdcp get_video_lock get_ip_config set_session_key set_device_name get_device_name set_video_bitrate get_video_bitrate set_downscale_mode get_downscale_mode set_video_out_mode get_video_out_mode set_streaming_mode get_streaming_mode get_fw_version get_company_id factory_reset reboot list <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br>  Pour r√©initialiser tous les param√®tres et le mot de passe, utilisez la commande <code>factory_reset</code> .  Nous √©crivons une commande, appuyez sur Entr√©e et obtenez cette image: <br><br><pre> <code class="bash hljs">input&gt;factory_reset Processing factory reset! System will reboot after few seconds! Connection closed by foreign host.</code> </pre><br><h3>  Interface Web </h3><br>  Nous pouvons maintenant configurer l'appareil selon nos besoins.  Passons √† l'interface Web.  Nous utilisons le login standard: mot de passe administrateur: 123456 et le voici, l'interface web "convoit√©e" avec des param√®tres suppl√©mentaires: <br><br><img src="https://habrastorage.org/webt/59/d4/e7/59d4e71a2b694981418223.png"><br><br>  Bien que les opportunit√©s dans l'interface Web aient augment√©, elles ne sont toujours pas suffisantes pour nos besoins.  Il manque particuli√®rement des param√®tres plus gratuits en termes de streaming, il est cod√© en dur, loin des plus pratiques, une liste d'adresses IP vers lesquelles vous pouvez diffuser.  Il y a bien s√ªr une multidiffusion, mais il vaut mieux la laisser √† la t√©l√©vision.  Les limitations peuvent √™tre contourn√©es, plus √† ce sujet plus tard. <br><br>  Ainsi, ils ont trouv√© l'appareil sur le r√©seau, l'ont roul√©, ont r√©initialis√© les mots de passe.  L'√©metteur est presque pr√™t √† passer au r√©cepteur. <br><br><h2>  R√©cepteur </h2><br>  D√©cidons de l'appareil sous le contr√¥le de quel syst√®me d'exploitation nous transmettrons le flux.  Je ne pense pas que vous ferez l'exp√©rience des affres du choix, il n'y a que deux options: <br><br><h4>  Windows </h4><br>  Pour Windows, j'ai essay√© plusieurs lecteurs, mais les r√©sultats √©taient moyens.  Lors de la capture puis de la lecture d'un flux vid√©o, un d√©lai appara√Æt, qui d√©pend principalement du lecteur lisant le flux.  Sur divers joueurs, le retard variait d'une seconde √† cinq ou plus.  Surtout, sous Windows, VLC Player s'est av√©r√© √™tre. <br><br>  Passons aux choses s√©rieuses.  Lancez VLC Player, en haut du menu d√©roulant "Media", s√©lectionnez "Open URL ..." dans le champ d'adresse r√©seau, √©crivez <code>udp://@:5004</code> , mettez un daw dans la case "Show advanced settings" et mettez sa valeur dans le champ "Caching", ce param√®tre est d√©termin√© individuellement.  Plus la valeur dans ce champ est petite, plus le d√©lai est faible, mais une valeur trop petite peut entra√Æner des ¬´artefacts¬ª et des pertes de trames, tout d√©pendra de l'infrastructure du r√©seau local.  Les meilleurs r√©sultats que j'ai pu obtenir ont √©t√© un retard d'environ une seconde.  Sous Linux, les r√©sultats √©taient bien meilleurs autour de 200-300 millisecondes. <br><br><h4>  Linux </h4><br>  Comme le montre la pratique, les meilleurs r√©sultats sont obtenus en utilisant une combinaison de programmes socat et mplayer.  Ubuntu est install√© sur mon ordinateur, donc la commande pour installer socat ressemblera √† ceci: <br><br><pre> <code class="bash hljs">sudo apt-get install socat</code> </pre> <br>  Mplayer est install√© de la m√™me mani√®re: <br><br><pre> <code class="bash hljs">sudo apt-get install mplayer</code> </pre> <br>  Eh bien, et suivez les conseils de Danman: <br><br><pre> <code class="bash hljs">sudo iptables -t raw -A PREROUTING -p udp -m length --length 28 -j DROP</code> </pre> <br>  Cette commande est n√©cessaire pour supprimer les soi-disant ¬´paquets UDP de longueur nulle¬ª du flux - des paquets de taille nulle qui ¬´obstruent¬ª le flux. <br><br><h2>  Allez vivre! </h2><br>  Le r√©cepteur est pr√™t, vous pouvez commencer la diffusion!  Nous tapons dans la console de l'ordinateur r√©cepteur <code>ifconfig</code> ou <code>ipconfig</code> , selon le syst√®me d'exploitation, nous nous souvenons de l'adresse IP du r√©cepteur et revenons √† l'interface web de l'√©metteur.  Nous ouvrirons l'interface Web, si nous l'avons d√©j√† ferm√©e, entrez le nom d'utilisateur, le mot de passe et √©crivez directement dans la barre d'adresse du navigateur: <br><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">///dev/info.cgi?action=streaminfo&amp;udp=n&amp;rtp=y&amp;multicast=n&amp;unicast=y&amp;mcastaddr=&amp;port=5004</span></span></code> </pre> <br>  Remplacez vos adresses IP et appuyez sur Entr√©e.  Cette ligne configurera le HDMI Extender pour diffuser la vid√©o captur√©e sur votre IP choisie et d√©sactiver la multidiffusion. <br><br>  Nous d√©marrons VLC dans Windows.  Ou dans le terminal Linux, nous √©crivons: <br><br><pre> <code class="bash hljs">socat UDP-RECV:5004 - | mplayer ‚Äì</code> </pre> <br>  Abra Cadabra!  Et voici notre bureau en direct, ou pas le n√¥tre. <br><br><img src="https://habrastorage.org/webt/59/d3/f3/59d3f3c6a0c3b976110026.png"><br><br>  Donc, avec quelques m√©thodes de piratage, nous avons forc√© l'appareil √† faire ce dont nous avions besoin. <br><br>  Une fois le transfert de la vid√©o tri√©, acc√©dez √† la t√©l√©commande. <br><br><h2>  Transfert de contr√¥le </h2><br><h3>  S√©lection des composants </h3><br>  Parce que  le co√ªt de HDMI Extender est faible, environ 1800 roubles, et aussi √† cause des commentaires qui, disent-ils, un peu chers, j'ai propos√© le slogan: "Donnez IP KVM pour 2000 roubles!".  Le taux de change du rouble affectera grandement la fid√©lit√© de cette d√©claration, mais ne parlons pas de tristes choses, je veux croire en un avenir radieux.  Pour atteindre l'objectif, nous aurons besoin d'√©l√©ments tr√®s bon march√©, mon choix s'est port√© sur l'ESP8266 en tant que contr√¥leur, et tout de m√™me Atmega (8/16/32) u2 en tant qu'actionneur. <br><br>  Vous pouvez bien s√ªr envisager d'autres candidats pour le r√¥le de dispositif ex√©cutif (clavier).  Le firmware qui √©mule le clavier est √©crit dans la biblioth√®que LUFA (en quelque sorte).  Cette biblioth√®que peut √™tre utilis√©e pour toute la famille AVR avec une connectivit√© USB.  Il s'ensuit qu'en tant qu'√©mulateur de clavier, vous pouvez vous procurer un microcontr√¥leur, peut-√™tre moins cher.  Ces informations sont √† prendre en consid√©ration, mais nous continuons maintenant. <br><br>  Vous pouvez acheter l'ESP8266 pour environ 90 roubles, Atmega (8/16/32) u2 pour environ 100 roubles, et encore moins cher si vous prenez en petits lots de 5 ou plus de pi√®ces.  Bien s√ªr, des consommables pour le cerclage des microcontr√¥leurs seront n√©cessaires, mais leur co√ªt est extr√™mement faible, donc je ne les consid√©rerai pas. <br><br><h2>  ESP8266 </h2><br>  Ce miracle de l'industrie chinoise n'a pas besoin d'√™tre pr√©sent√©, donc je dirai seulement que dans ce projet, j'ai utilis√© la version d'ESP8266-12e.  Bien s√ªr, vous pouvez utiliser d'autres versions, seulement vous devez consid√©rer l'emplacement des ports, car  dans cette version, un des ports ESP8266 est utilis√© pour allumer l'Atmega (8/16/32) u2, il sera indiqu√© dans le sch√©ma ci-dessous. <br><br><h3>  Firmware </h3><br>  Le firmware pour ESP8266 est √©crit dans l'environnement ArduinoIDE, alors t√©l√©chargeons la derni√®re version sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le site du d√©veloppeur</a> .  Ensuite, vous devez ajouter le support pour ESP8266 - le moyen le plus simple peut √™tre trouv√© sur ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> .  Sur la m√™me page, vous pouvez trouver de nombreuses informations utiles, par exemple, le sch√©ma de connexion d'alimentation et TTL.  Pour ceux qui ne sont pas √† jour, l'ESP8266 utilise <b>strictement 3,3 volts!</b>  Si vous n'avez pas confiance en vos propres capacit√©s, il est pr√©f√©rable d'utiliser une option de carte adapt√©e pour USB, telle que NodeMCU: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d92043a87951368720.jpeg"><br><br>  Si tout est pr√™t, ouvrez ArduinoIDE et copiez mon croquis: <br><br><div class="spoiler">  <b class="spoiler_title">Esquisse</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;ESP8266WiFi.h&gt; #include &lt;WiFiClient.h&gt; #include &lt;ESP8266WebServer.h&gt; #include &lt;ESP8266mDNS.h&gt; #include &lt;SoftwareSerial.h&gt; #include &lt;HIDKeyboard.h&gt; #define MAX_SRV_CLIENTS <span class="hljs-number"><span class="hljs-number">3</span></span> HIDKeyboard keyboard; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* host = <span class="hljs-string"><span class="hljs-string">"esp8266"</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">""</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* pass = <span class="hljs-string"><span class="hljs-string">""</span></span>; int rebootdev = <span class="hljs-number"><span class="hljs-number">0</span></span>; int modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>; // ,    ESP8266    #define Port1 <span class="hljs-number"><span class="hljs-number">15</span></span> #define Port2 <span class="hljs-number"><span class="hljs-number">14</span></span> #define Port3 <span class="hljs-number"><span class="hljs-number">12</span></span> #define Port4 <span class="hljs-number"><span class="hljs-number">4</span></span> #define Port5 <span class="hljs-number"><span class="hljs-number">5</span></span> //  String ColorB1; String ColorB2; String ColorB3; String ColorB4; String ColorB5; ESP8266WebServer server(<span class="hljs-number"><span class="hljs-number">80</span></span>); WiFiClient serverClients[MAX_SRV_CLIENTS]; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* serverIndex = <span class="hljs-string"><span class="hljs-string">"&lt;form method='POST' action='/update' enctype='multipart/form-data'&gt;&lt;input type='file' name='update'&gt;&lt;input type='submit' value='Update'&gt;&lt;/form&gt;&lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>;//Update //    void handleRedirect(){ String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;head&gt;&lt;meta http-equiv='refresh' content='0;/'&gt;&lt;head&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } //  WI-FI void handleLogin(){ String msg = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasArg(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) &amp;&amp; server.hasArg(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) != NULL) &amp;&amp; (server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>) != NULL)){ String header = <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 301 OK\r\r\nLocation: /\r\nCache-Control: no-cache\r\n\r\n"</span></span>; server.sendContent(header); String web_ssid = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>); String web_pass = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>); ssid = web_ssid.c_str();//       C pass = web_pass.c_str(); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID "</span></span>); Serial.println(ssid); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Pass "</span></span>); Serial.println(pass); WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); ESP.reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } msg = <span class="hljs-string"><span class="hljs-string">"Wrong ssid/password! try again."</span></span>; Serial.println(<span class="hljs-string"><span class="hljs-string">"Login Failed"</span></span>); } String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;form action='/' method='POST'&gt;Enter the access point name and password &lt;br&gt;"</span></span>;//  SSID   content += <span class="hljs-string"><span class="hljs-string">"Name AP:&lt;input type='text' name='SSID' placeholder='SSID'&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Password:&lt;input type='password' name='PASSAP' placeholder='password'&gt;&lt;br&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"&lt;input type='submit' name='SUBMIT' value='Connect to WI-FI'&gt;&lt;/form&gt;&lt;b&gt;&lt;font color='red'&gt;"</span></span> + msg + <span class="hljs-string"><span class="hljs-string">"&lt;/font&gt;&lt;/b&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Firmware update &lt;a href='/upload'&gt;UPDATE&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } void handleNotFound(){ String message = <span class="hljs-string"><span class="hljs-string">"File Not Found\n\n"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"URI: "</span></span>; message += server.uri(); message += <span class="hljs-string"><span class="hljs-string">"\nMethod: "</span></span>; message += (server.method() == HTTP_GET)?<span class="hljs-string"><span class="hljs-string">"GET"</span></span>:<span class="hljs-string"><span class="hljs-string">"POST"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"\nArguments: "</span></span>; message += server.args(); message += <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;server.args(); i++){ message += <span class="hljs-string"><span class="hljs-string">" "</span></span> + server.argName(i) + <span class="hljs-string"><span class="hljs-string">": "</span></span> + server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(i) + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } server.send(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message); } //  int controlPin(int UsePin){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (UsePin &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ int StPort; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(UsePin) == <span class="hljs-number"><span class="hljs-number">1</span></span>) {//      digitalWrite(UsePin, LOW); StPort = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(UsePin, HIGH); StPort = <span class="hljs-number"><span class="hljs-number">1</span></span>; } digitalWrite(LED_BUILTIN, HIGH);//    Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Port "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(UsePin); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"="</span></span>); Serial.println(StPort); delay(<span class="hljs-number"><span class="hljs-number">500</span></span>); digitalWrite(LED_BUILTIN, LOW); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(StPort); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } //  int clientConnect(int Seconds){ Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"connection "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= Seconds; i++){ WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); digitalWrite(LED_BUILTIN, HIGH); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); Serial.println(); } void setup(void){ Serial.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); pinMode(LED_BUILTIN, OUTPUT); digitalWrite(LED_BUILTIN, HIGH); //uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">0</span></span>) WiFi.mode(WIFI_STA);//  modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>     Serial.println(); Serial.println(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>) modeswitch = <span class="hljs-number"><span class="hljs-number">1</span></span>;//            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ Serial.println(<span class="hljs-string"><span class="hljs-string">""</span></span>); Serial.println(<span class="hljs-string"><span class="hljs-string">"WiFi switch AP mode"</span></span>); //WiFi.mode(WIFI_AP_STA);    +  .     WiFi.mode(WIFI_AP); WiFi.softAP(<span class="hljs-string"><span class="hljs-string">"TD"</span></span>, <span class="hljs-string"><span class="hljs-string">"testtest"</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"AP mode ip adress "</span></span>); Serial.println(WiFi.softAPIP()); digitalWrite(LED_BUILTIN, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client mod ip address: "</span></span>); Serial.println(WiFi.localIP()); digitalWrite(LED_BUILTIN, LOW); } MDNS.begin(host); pinMode(Port1, OUTPUT); pinMode(Port2, OUTPUT); pinMode(Port3, OUTPUT); pinMode(Port4, OUTPUT); pinMode(Port5, OUTPUT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ //     server.on(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handleLogin);//  (SSID)   //  server.on(<span class="hljs-string"><span class="hljs-string">"/upload"</span></span>, HTTP_GET, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, serverIndex); }); server.on(<span class="hljs-string"><span class="hljs-string">"/update"</span></span>, HTTP_POST, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); int uperror = Update.hasError(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"UPERR %u\nRebooting...\n"</span></span>,Update.hasError()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uperror == <span class="hljs-number"><span class="hljs-number">0</span></span>) server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Firmware update successfully &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Update error &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); ESP.restart(); },[](){ HTTPUpload&amp; upload = server.upload(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_START){ Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); WiFiUDP::stopAll(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update: %s\n"</span></span>, upload.filename.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (upload.filename == NULL) { Serial.printf(<span class="hljs-string"><span class="hljs-string">"ERROR: zero file size"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;html&gt; zero file size &lt;a href='/upload'&gt;BACK&lt;/a&gt;&lt;/html&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } uint32_t maxSketchSpace = (ESP.getFreeSketchSpace() - <span class="hljs-number"><span class="hljs-number">0x1000</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFFFFF000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Update.begin(maxSketchSpace)){//start with <span class="hljs-built_in"><span class="hljs-built_in">max</span></span> available size Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_WRITE){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(upload.buf, upload.currentSize) != upload.currentSize){ Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_END){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)){ //<span class="hljs-literal"><span class="hljs-literal">true</span></span> to set the size to the current progress Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update Success: %u\nRebooting...\n"</span></span>, upload.totalSize); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Update.printError(Serial); } Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span>(); }); //  server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt1"</span></span>, [] { controlPin(Port1); handleRedirect();//    }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt2"</span></span>, [] { controlPin(Port2); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt3"</span></span>, [] { controlPin(Port3); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt4"</span></span>, [] { controlPin(Port4); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt5"</span></span>, [] { controlPin(Port5); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/reboot"</span></span>, [] { rebootdev = <span class="hljs-number"><span class="hljs-number">1</span></span>;//      handleRedirect(); }); server.onNotFound(handleNotFound);//    //server.begin(); MDNS.addService(<span class="hljs-string"><span class="hljs-string">"http"</span></span>, <span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>); Serial.println(); Serial.println(<span class="hljs-string"><span class="hljs-string">"HTTP server started"</span></span>); } server.begin(); } void loop(void){ uint8_t i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>) server.handleClient(); delay(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() != WL_CONNECTED) clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, HIGH);//  ATMEGA16U2 digitalWrite(LED_BUILTIN, LOW); } } WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); server.setNoDelay(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); server.begin(); keyboard.begin(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasClient()){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ //<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> free/disconnected spot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!serverClients[i] || !serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i]) serverClients[i].stop(); serverClients[i] = server.available(); Serial.println(<span class="hljs-string"><span class="hljs-string">"New client: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(i); continue; } } //no free/disconnected spot so reject WiFiClient serverClient = server.available(); serverClient.stop(); } //check clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i].available()){ //get data from the telnet client <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> push it to the UART String bufkey; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(serverClients[i].available()) bufkey += (serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>());//     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bufkey != <span class="hljs-number"><span class="hljs-number">0</span></span>) { bufkey = bufkey.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>);//  int key = bufkey.toInt();//   switch (key){ case <span class="hljs-number"><span class="hljs-number">277980</span></span>: keyboard.pressSpecialKey(F1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277981</span></span>: keyboard.pressSpecialKey(F2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277982</span></span>: keyboard.pressSpecialKey(F3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277983</span></span>: keyboard.pressSpecialKey(F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914953</span></span>: keyboard.pressSpecialKey(F5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914955</span></span>: keyboard.pressSpecialKey(F6); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914956</span></span>: keyboard.pressSpecialKey(F7); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914957</span></span>: keyboard.pressSpecialKey(F8); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915048</span></span>: keyboard.pressSpecialKey(F9); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915049</span></span>: keyboard.pressSpecialKey(F10); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915051</span></span>: keyboard.pressSpecialKey(F11); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915052</span></span>: keyboard.pressSpecialKey(F12); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">1310</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">130</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27</span></span>: keyboard.pressSpecialKey(ESCAPE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">8</span></span>: keyboard.pressSpecialKey(BACKSPACE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">9</span></span>: keyboard.pressSpecialKey(TAB); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">32</span></span>: keyboard.pressSpecialKey(SPACEBAR); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915012</span></span>: keyboard.pressSpecialKey(INSERT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914912</span></span>: keyboard.pressSpecialKey(HOME); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915312</span></span>: keyboard.pressSpecialKey(PAGEUP); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915212</span></span>: keyboard.pressSpecialKey(END); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915412</span></span>: keyboard.pressSpecialKey(PAGEDOWN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279167</span></span>: keyboard.pressSpecialKey(RIGHTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279168</span></span>: keyboard.pressSpecialKey(LEFTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279166</span></span>: keyboard.pressSpecialKey(DOWNARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279165</span></span>: keyboard.pressSpecialKey(UPARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">127</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915112</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">4</span></span>: keyboard.pressSpecialKey((LCTRL | ALT), DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //CTRL+ALT+DELETE  Ctrl + d case <span class="hljs-number"><span class="hljs-number">6</span></span>: keyboard.pressSpecialKey(ALT, F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //alt+f4  Ctrl + f case <span class="hljs-number"><span class="hljs-number">19</span></span>: keyboard.pressSpecialKey(ALT | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+s case <span class="hljs-number"><span class="hljs-number">2</span></span>: keyboard.pressSpecialKey(LCTRL | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+b //    case <span class="hljs-number"><span class="hljs-number">17</span></span>: controlPin(Port1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+q case <span class="hljs-number"><span class="hljs-number">23</span></span>: controlPin(Port2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+w case <span class="hljs-number"><span class="hljs-number">5</span></span>: controlPin(Port3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+e case <span class="hljs-number"><span class="hljs-number">18</span></span>: controlPin(Port4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+r case <span class="hljs-number"><span class="hljs-number">20</span></span>: controlPin(Port5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+t default: keyboard.pressKey(key); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//  } keyboard.releaseKey();//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" string: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(key);//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" KEY: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(bufkey.toInt()); bufkey = <span class="hljs-string"><span class="hljs-string">'0'</span></span>;//    } } } } //check UART <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Serial.available()){ size_t <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> = Serial.available(); uint8_t sbuf[<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>]; Serial.readBytes(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); //push UART data to all connected telnet clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } } } }</code> </pre><br></div></div><br>  Connectez la biblioth√®que souhait√©e: <br><br>  S√©lectionnez l'onglet "Esquisse" ‚Üí "Connecter la biblioth√®que" ‚Üí "Ajouter une biblioth√®que .ZIP". S√©lectionnez la biblioth√®que appel√©e "UNO-HIDKeyboard-Library-master (mod) .zip", qui a √©t√© t√©l√©charg√©e √† partir du github.  Nous compilons et remplissons le firmware.  Pour t√©l√©charger le firmware, connectez l'ESP8266 TTL, d√©finissez le port souhait√© dans ArduinoIDE.  Les param√®tres doivent ressembler √† ceci: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920b385c613386705.png"><br><br>  Pour t√©l√©charger le firmware, vous devez court-circuiter le port GPIO0 √† la terre et red√©marrer le microcontr√¥leur en court-circuitant √©galement le port de r√©initialisation √† la terre.  Je ne peindrai pas en d√©tail, afin de ne pas gonfler l'article, Google vous aidera. <br><br>  La logique de l'ESP8266 est la suivante: √† la mise sous tension, le microcontr√¥leur tente de se connecter √† un point d'acc√®s Wi-Fi pendant une trentaine de secondes: <br><br>  <b>Si la connexion r√©ussit</b> : ouvre le port 23, qui peut √™tre connect√© √† l'aide de telnet et transmettre les frappes.  En plus des touches, vous pouvez transf√©rer des combinaisons bas√©es sur "Ctrl + touche" qui appuieront sur certaines combinaisons.  Par exemple, si vous passez ¬´Ctrl + d¬ª, la combinaison CTRL + ALT + SUPPR sera enfonc√©e sur l'ordinateur g√©r√©. <br><br>  Il existe √©galement des combinaisons pour contr√¥ler les ports ESP8266, par exemple, vous pouvez connecter un relais et utiliser la combinaison ¬´Ctrl + q¬ª pour activer et d√©sactiver le relais, allumant et √©teignant ainsi l'ordinateur g√©r√© √† distance.  Vous pouvez voir ces combinaisons et d'autres dans la source. <br><br>  <b>En cas d'√©chec</b> : ESP8266 passe en mode point d'acc√®s avec le nom ¬´TD¬ª, mot de passe ¬´testtest¬ª et ouvre une petite interface Web, accessible √† 192.168.4.1, o√π vous pouvez configurer les param√®tres de connexion via WI-FI. <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920802fd033414007.png"><br><br>  Ainsi, l'appareil peut √™tre facilement connect√© √† un autre point d'acc√®s.  Oui, une mouche dans la pommade est cach√©e ici, pour le fonctionnement de notre IP KVM, nous aurons besoin √† la fois d'un c√¢ble LAN et d'une connexion Wi-Fi.  Tel sera le co√ªt du bon march√© de l'appareil. <br><br>  Nous avons trait√© ESP8266, avec Atmega16u2 tout est comme dans les articles pr√©c√©dents, nous flasherons le programme Flip, le firmware est dans l'archive t√©l√©charg√©e depuis le github. <br><br><h2>  Connexion des composants </h2><br>  Pour la bonne connexion des composants, j'attache le circuit.  Gardez √† l'esprit qu'il s'agit d'un sch√©ma conditionnel, il sert √† la clart√© et ne pr√©tend pas √™tre id√©al.  Chacun est libre de la ¬´meubler¬ª √† sa guise. <br><br><img src="https://habrastorage.org/webt/59/d6/52/59d6521903f44207012758.jpeg"><br><br>  Permettez-moi d'expliquer certains points: le transistor dans le diagramme est n√©cessaire pour activer Atmega16u2 apr√®s le chargement de l'ESP8266, car lorsque vous allumez l'ESP8266, les informations de d√©bogage sont transmises √† tous les ports TX, et si l'Atmega16u2 est allum√© et connect√© √† l'ordinateur, un flux de donn√©es dont le volume est transmis le conducteur ne peut pas faire face.  On ne sait pas avec certitude ce qui se passe en ce moment, le tampon du pilote est probablement d√©bordant, l'effet est extr√™mement d√©sagr√©able: des centaines de touches sont enfonc√©es, si un √©diteur de texte est ouvert, il d√©verse un tas de charabia, et toutes les touches de service se bloquent et, par cons√©quent, travailler avec le clavier devient impossible .  Pour √©viter cela, l'Atmega16u2 doit √™tre mis sous tension apr√®s le chargement de l'ESP8266.  Dans le firmware, ce moment est pris en compte. <br><br>  Il y a bien s√ªr une alternative au sch√©ma, mais c'est une option pour les riches ou les paresseux.  Et au fait, cette option n'annule pas ce qui pr√©c√®de: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920e7d2e067456748.jpeg"><br><br>  Dans l'image, l'Arduino UNO sans la puce Atmega328p est connect√© √† l'homologue chinois de NodeMCU.  La ligne 3,3 volts est connect√©e √† la ligne du m√™me niveau de tension sur l'Arduino, et la masse et la broche GPIO2 (ESP8266) sont √©galement connect√©es √† la broche TX sur l'Arduino. <br><br><h2>  Contr√¥le final </h2><br>  Nous nous connectons par telnet au port 23 et v√©rifions les performances.  Vous pouvez le faire: sous Windows avec la commande <code>telnet [ip- ESP8266]</code> . <br><br>  Sous Linux, ce sera un peu plus compliqu√©: <br><br>  La commande <code>telnet [ip- ESP8266]</code> puis vous devez appuyer sur le caract√®re de contr√¥le, la valeur par d√©faut est "Ctrl +]", le telnet devrait passer en mode commande, puis appuyez sur "l" et "Entr√©e".  Avec ces actions, nous basculerons le telnet en mode symbole. <br><br><pre> <code class="bash hljs">$ telnet 192.168.***.*** Trying 192.168.***.***... Connected to 192.168.***.***. Escape character is <span class="hljs-string"><span class="hljs-string">'^]'</span></span>. ^] telnet&gt; l</code> </pre><br>  Tout est pr√™t, nous pouvons v√©rifier le fonctionnement de l'appareil que nous avons cr√©√©.  Permettez-moi de vous rappeler les combinaisons possibles pour appuyer sur "Alt + Tab", "Ctrl + Alt + Suppr" et etc.  peut voir dans l'esquisse.  C'est tout, la troisi√®me incarnation IP KVM DIY est pr√™te. <br><br><h2>  Pour r√©sumer </h2><br><h3>  Avantages: </h3><br><ul><li>  Le plus probablement le plus important est le prix, il s'est av√©r√© qu'il pouvait tenir en 2000 roubles </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il ne devrait y avoir aucune plainte concernant la qualit√© de la vid√©o, vous pouvez diffuser en Full HD sans probl√®me </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La possibilit√© d'√©tendre les fonctionnalit√©s en ajoutant jusqu'√† quatre relais ou autres actionneurs. </font></font></li></ul><br><h3>  Inconv√©nients: </h3><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Besoin de se connecter via Wi-Fi et c√¢ble LAN </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lorsqu'il est utilis√© avec VGA, un adaptateur est requis, ce qui affectera naturellement le co√ªt </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En g√©n√©ral, l'appareil s'est av√©r√© digne d'attention, bien s√ªr, il n'est pas un concurrent des KVM IP s√©rie avec tous leurs ¬´goodies¬ª, mais il gagne beaucoup en prix. </font><font style="vertical-align: inherit;">Et pour un usage domestique, et peut-√™tre pas seulement, il convient parfaitement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je profite de cette occasion pour remercier l'utilisateur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DaylightIsBurning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Cet homme gentil a sugg√©r√© la bonne direction dans laquelle creuser. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Merci de votre attention.</font></font> A tr√®s bient√¥t! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr406059/">https://habr.com/ru/post/fr406059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr406047/index.html">Uberisation des d√©panneuses</a></li>
<li><a href="../fr406049/index.html">Afficher des graphiques 3D sur PSP</a></li>
<li><a href="../fr406051/index.html">En route vers les √©toiles: le danger des voyages dans l'espace</a></li>
<li><a href="../fr406055/index.html">Une personne qui a re√ßu une mise √† jour du syst√®me immunitaire pour lutter contre le cancer</a></li>
<li><a href="../fr406057/index.html">Les √©quipes du concours Google Lunar X PRIZE b√©n√©ficieront d'un d√©lai suppl√©mentaire</a></li>
<li><a href="../fr406061/index.html">Sp√©cialiste de la s√©curit√© des informations Hacked Apple Secure Enclave Cryptographic Protection</a></li>
<li><a href="../fr406063/index.html">Que se passera-t-il exactement lorsque la fourche bitcoin segwit2x sera activ√©e en novembre?</a></li>
<li><a href="../fr406065/index.html">Sp√©cialistes de la s√©curit√© de l'information: ¬´Une voiture intelligente est loin d'√™tre toujours une voiture s√ªre¬ª</a></li>
<li><a href="../fr406067/index.html">Contrats intelligents. Partie 1. Lorsque le journal sait ce que vous lui avez dit et le fait</a></li>
<li><a href="../fr406069/index.html">Contrats intelligents. Partie 2. Du battage m√©diatique √† la r√©alit√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>