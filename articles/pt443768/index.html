<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç£ üë©üèø‚ÄçüöÄ üôéüèª Mon√≥lito para centenas de vers√µes de clientes: como escrevemos e suportamos testes üëãüèø ü•¶ üòì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! 

 Sou desenvolvedor de back-end na equipe de servidores do Badoo. Na confer√™ncia HighLoad do ano passado, fiz uma apresenta√ß√£o , cuja ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mon√≥lito para centenas de vers√µes de clientes: como escrevemos e suportamos testes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/443768/"><img src="https://habrastorage.org/webt/tz/sv/jv/tzsvjvswjax_rsrd3fjcriulb-8.jpeg"><br><br>  Ol√° pessoal! <br><br>  Sou desenvolvedor de back-end na equipe de servidores do Badoo.  Na confer√™ncia HighLoad do ano passado, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fiz uma apresenta√ß√£o</a> , cuja vers√£o em texto quero compartilhar com voc√™.  Esta postagem ser√° mais √∫til para aqueles que escrevem testes para o back-end e enfrentam problemas com o teste de c√≥digo legado, bem como para quem deseja testar l√≥gica de neg√≥cios complexa. <br><br>  Sobre o que vamos falar?  Primeiro, falarei brevemente sobre nosso processo de desenvolvimento e como isso afeta nossa necessidade de testes e o desejo de escrev√™-los.  Em seguida, subiremos e desceremos a pir√¢mide de automa√ß√£o de testes, discutiremos os tipos de testes que usamos, falaremos sobre as ferramentas dentro de cada um deles e quais problemas resolveremos com a ajuda deles.  No final, considere como manter e executar todas essas coisas. <br><a name="habracut"></a><br><h2>  Nosso processo de desenvolvimento </h2><br>  Ilustramos nosso processo de desenvolvimento: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/er/hv/jr/erhvjrnkf7zncdxhlgjusogzmyk.png" width="600"></div><br>  Um jogador de golfe √© um desenvolvedor de back-end.  Em algum momento, uma tarefa de desenvolvimento chega a ele, geralmente na forma de dois documentos: requisitos do lado comercial e um documento t√©cnico que descreve as altera√ß√µes em nosso protocolo de intera√ß√£o entre o back-end e os clientes (aplicativos m√≥veis e o site). <br><br>  O desenvolvedor grava o c√≥digo e o coloca em opera√ß√£o, e antes de todos os aplicativos clientes.  Toda a funcionalidade √© protegida por alguns sinalizadores de recurso ou testes A / B, conforme prescrito em um documento t√©cnico.  Depois disso, de acordo com as prioridades atuais e o roteiro do produto, os aplicativos clientes s√£o liberados.  Para n√≥s, desenvolvedores de back-end, √© completamente imprevis√≠vel quando um recurso espec√≠fico ser√° implementado nos clientes.  O ciclo de lan√ßamento para aplicativos clientes √© um pouco mais complicado e mais longo que o nosso, portanto nossos gerentes de produto literalmente fazem malabarismos com prioridades. <br><br>  A cultura de desenvolvimento adotada pela empresa √© de grande import√¢ncia: o desenvolvedor de back-end √© respons√°vel pelo recurso desde o momento de sua implementa√ß√£o no back-end at√© a √∫ltima integra√ß√£o na √∫ltima plataforma em que foi originalmente planejado para implementar esse recurso. <br><br>  Essa situa√ß√£o √© bem poss√≠vel: seis meses atr√°s, voc√™ lan√ßou algum recurso, as equipes dos clientes n√£o o implementaram por um longo tempo, porque as prioridades da empresa mudaram, voc√™ j√° est√° ocupado trabalhando em outras tarefas, tem novos prazos, prioridades - e aqui seus colegas v√™m correndo e eles dizem: ‚ÄúVoc√™ se lembra dessa coisa que lavou seis meses atr√°s?  Ela n√£o est√° trabalhando.  E, em vez de se envolver em novas tarefas, voc√™ apaga os inc√™ndios. <br><br><img src="https://habrastorage.org/files/e22/ebe/15c/e22ebe15c2174a4d99ebf0da46fbe950.gif" width="600"><br><br>  Portanto, nossos desenvolvedores t√™m uma motiva√ß√£o incomum para programadores PHP - para garantir que haja o m√≠nimo de problemas poss√≠vel durante a fase de integra√ß√£o. <br><br>  O que voc√™ deseja fazer antes de tudo para garantir que o recurso funcione? <br><br>  Obviamente, a primeira coisa que vem √† mente √© realizar testes manuais.  Voc√™ escolhe o aplicativo, mas ele n√£o sabe como - como o recurso √© novo, os clientes cuidam dele em seis meses.  Bem, o teste manual n√£o garante que, durante o tempo decorrido entre o lan√ßamento do back-end e o in√≠cio da integra√ß√£o, ningu√©m quebrar√° nada nos clientes. <br><br>  E aqui os testes automatizados v√™m em nosso aux√≠lio. <br><br><h2>  Testes unit√°rios </h2><br>  Os testes mais simples que escrevemos s√£o testes de unidade.  Usamos PHP como idioma principal para o back-end e PHPUnit como estrutura para teste de unidade.  Olhando para o futuro, direi que todos os nossos testes de back-end foram escritos com base nessa estrutura. <br><br>  Testes de unidade na maioria das vezes cobrimos alguns pequenos peda√ßos de c√≥digo isolados, verificamos o desempenho de m√©todos ou fun√ß√µes, ou seja, estamos falando de pequenas unidades da l√≥gica de neg√≥cios.  Nossos testes de unidade n√£o devem interagir com nada, acessar bancos de dados ou servi√ßos. <br><br><h3>  Softmocks </h3><br>  A principal dificuldade que os desenvolvedores enfrentam ao escrever testes de unidade √© um c√≥digo n√£o test√°vel, e geralmente esse √© um c√≥digo legado. <br><br>  Um exemplo simples.  O Badoo tem 12 anos, uma vez que era uma startup muito pequena, desenvolvida por v√°rias pessoas.  A inicializa√ß√£o existiu com sucesso sem nenhum teste.  Ent√£o ficamos grandes o suficiente e percebemos que voc√™ n√£o pode viver sem testes.  Mas, nessa √©poca, havia sido escrito muito c√≥digo que funcionava.  N√£o o reescreva apenas para testar!  Isso n√£o seria muito razo√°vel do ponto de vista comercial. <br><br>  Portanto, desenvolvemos uma pequena <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca de software livre SoftMocks</a> , que torna nosso processo de grava√ß√£o de testes mais barato e mais r√°pido.  Ele intercepta todos incluem / requer arquivos PHP e on-the-fly substitui o arquivo de origem pelo conte√∫do modificado, ou seja, c√≥digo reescrito.  Isso nos permite criar stubs para qualquer c√≥digo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ele</a> detalha como a biblioteca funciona. <br><br>  Isto √© o que parece para um desenvolvedor: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//mock  \Badoo\SoftMocks::redefineConstant($constantName, $newValue); //mock  : , ,  \Badoo\SoftMocks::redefineMethod( $class, $method, $method_args, $fake_code ); //mock  \Badoo\SoftMocks::redefineFunction( $function, $function_args, $fake_code );</span></span></code> </pre> <br>  Com a ajuda de constru√ß√µes simples, podemos redefinir globalmente tudo o que queremos.  Em particular, eles nos permitem contornar as limita√ß√µes do criador padr√£o do PHPUnit.  Ou seja, podemos zombar de m√©todos est√°ticos e privados, redefinir constantes e fazer muito mais, o que √© imposs√≠vel no PHPUnit comum. <br><br>  No entanto, encontramos um problema: parece aos desenvolvedores que, se houver SoftMocks, n√£o h√° necessidade de escrever o c√≥digo testado - voc√™ sempre pode ‚Äúpentear‚Äù o c√≥digo com nossos mocks globais, e tudo funcionar√° bem.  Mas essa abordagem leva a um c√≥digo mais complexo e ao ac√∫mulo de "muletas".  Portanto, adotamos v√°rias regras que nos permitem manter a situa√ß√£o sob controle: <br><br><ol><li>  Todo novo c√≥digo deve ser facilmente testado com zombarias padr√£o do PHPUnit.  Se essa condi√ß√£o for atendida, o c√≥digo poder√° ser testado e voc√™ poder√° selecionar facilmente um pequeno peda√ßo e test√°-lo apenas. <br></li><li>  O SoftMocks pode ser usado com c√≥digo antigo escrito de uma maneira que n√£o √© adequada para testes de unidade, bem como nos casos em que √© muito caro / longo / dif√≠cil de fazer o contr√°rio (enfatize o necess√°rio). <br></li></ol><br>  A conformidade com essas regras √© cuidadosamente monitorada no est√°gio de revis√£o do c√≥digo. <br><br><h3>  Teste de muta√ß√£o </h3><br>  Separadamente, quero dizer sobre a qualidade dos testes de unidade.  Eu acho que muitos de voc√™s usam m√©tricas como cobertura de c√≥digo.  Mas ela, infelizmente, n√£o responde a uma pergunta: "Eu escrevi um bom teste de unidade?"  √â poss√≠vel que voc√™ tenha escrito esse teste, que na verdade n√£o verifica nada, n√£o cont√©m uma √∫nica declara√ß√£o, mas gera excelente cobertura de c√≥digo.  Obviamente, o exemplo √© exagerado, mas a situa√ß√£o n√£o est√° t√£o longe da realidade. <br><br>  Recentemente, come√ßamos a introduzir testes mutacionais.  Este √© um conceito bastante antigo, mas n√£o muito conhecido.  O algoritmo para esses testes √© bastante simples: <br><br><ul><li>  pegue o c√≥digo e a cobertura do c√≥digo; <br></li><li>  analisar e come√ßar a mudar o c√≥digo: verdadeiro para falso,&gt; para&gt; =, + para - (em geral, prejudicar de todas as formas); <br></li><li>  para cada altera√ß√£o de muta√ß√£o, execute conjuntos de testes que cubram a sequ√™ncia alterada; <br></li><li>  se os testes caem, eles s√£o bons e realmente n√£o nos permitem quebrar o c√≥digo; <br></li><li>  se os testes foram aprovados, provavelmente, eles n√£o s√£o eficazes o suficiente, apesar da cobertura, e pode valer a pena examin√°-los mais de perto, para dar alguma afirma√ß√£o (ou se houver uma √°rea n√£o coberta pelo teste). <br></li></ul><br>  Existem v√°rias estruturas prontas para PHP, como Humbug e Infection.  Infelizmente, eles n√£o nos agradaram, porque s√£o incompat√≠veis com o SoftMocks.  Portanto, criamos nosso pr√≥prio pequeno utilit√°rio de console, que faz o mesmo, mas usa nosso formato de cobertura de c√≥digo interno e √© amigo do SoftMocks.  Agora, o desenvolvedor o inicia manualmente e analisa os testes escritos por ele, mas estamos trabalhando para introduzir a ferramenta em nosso processo de desenvolvimento. <br><br><h2>  Teste de integra√ß√£o </h2><br>  Com a ajuda dos testes de integra√ß√£o, verificamos a intera√ß√£o com v√°rios servi√ßos e bancos de dados. <br><br>  Para entender melhor a hist√≥ria, vamos desenvolver uma promo√ß√£o fict√≠cia e cobri-la com testes.  Imagine que nossos gerentes de produto decidiram distribuir tickets de confer√™ncia para nossos usu√°rios mais dedicados: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/72/us/3f/72us3fyuuclhm8c1erh3qk42yra.png" width="300"></div><br>  A promo√ß√£o deve ser exibida se: <br><br><ul><li>  o usu√°rio no campo "Trabalho" indica "programador", <br></li><li>  o usu√°rio participa do teste A / B HL18_promo, <br></li><li>  O usu√°rio est√° registrado h√° mais de dois anos. <br></li></ul><br>  Ao clicar no bot√£o "Obter um ticket", precisamos salvar os dados deste usu√°rio em alguma lista para transferi-los para nossos gerentes que distribuem os tickets. <br><br>  Mesmo neste exemplo bastante simples, h√° algo que n√£o pode ser verificado usando testes de unidade - intera√ß√£o com o banco de dados.  Para fazer isso, precisamos usar testes de integra√ß√£o. <br><br>  Considere a maneira padr√£o de testar a intera√ß√£o do banco de dados oferecida pelo PHPUnit: <br><br><ol><li>  Aumente o banco de dados de teste. <br></li><li>  Preparamos DataTables e DataSets. <br></li><li>  Execute o teste. <br></li><li>  Limpamos o banco de dados de teste. <br></li></ol><br>  Que dificuldades est√£o √† espera de tal abordagem? <br><br><ul><li>  Voc√™ precisa dar suporte √†s estruturas do DataTables e DataSets.  Se alteramos o layout da tabela, √© necess√°rio refletir essas altera√ß√µes no teste, o que nem sempre √© conveniente e requer tempo adicional. <br></li><li>  Leva tempo para preparar o banco de dados.  Sempre que configuramos o teste, precisamos fazer o upload de algo l√°, criar algumas tabelas, e isso √© longo e problem√°tico se houver muitos testes. <br></li><li>  E a desvantagem mais importante: executar esses testes em paralelo os torna inst√°veis.  Come√ßamos o teste A, ele come√ßou a escrever na tabela de teste que ele criou.  Ao mesmo tempo, lan√ßamos o teste B, que deseja trabalhar com a mesma tabela de teste.  Como resultado, surgem bloqueios m√∫tuos e outras situa√ß√µes imprevistas. <br></li></ul><br>  Para evitar esses problemas, desenvolvemos nossa pr√≥pria pequena biblioteca DBMocks. <br><br><h3>  DBMocks </h3><br>  O princ√≠pio de opera√ß√£o √© o seguinte: <br><br><ol><li>  Com a ajuda do SoftMocks, interceptamos todos os wrappers pelos quais trabalhamos com bancos de dados. <br></li><li>  Quando <br>  a consulta passa por simula√ß√£o, analisa a consulta SQL e extrai DB + TableName dela e obt√©m o host da conex√£o. <br></li><li>  No mesmo host em tmpfs, criamos uma tabela tempor√°ria com a mesma estrutura que a original (copiamos a estrutura usando SHOW CREATE TABLE). <br></li><li>  Depois disso, redirecionaremos todas as solicita√ß√µes que passar√£o por simula√ß√£o para esta tabela para uma tempor√°ria rec√©m-criada. <br></li></ol><br>  O que isso nos d√°: <br><br><ul><li>  n√£o h√° necessidade de cuidar constantemente das estruturas; <br></li><li>  os testes n√£o podem mais corromper dados nas tabelas de origem, porque os redirecionamos para tabelas tempor√°rias em tempo real; <br></li><li>  ainda estamos testando a compatibilidade com a vers√£o do MySQL com a qual estamos trabalhando e, se a solicita√ß√£o deixar de ser compat√≠vel com a nova vers√£o de repente, nosso teste a ver√° e trar√°. <br></li><li>  e o mais importante, agora os testes est√£o isolados e, mesmo que voc√™ os execute paralelamente, os threads ser√£o dispersos em diferentes tabelas tempor√°rias, pois adicionamos uma chave exclusiva para cada teste nos nomes das tabelas de teste. <br></li></ul><br><h2>  Teste de API </h2><br>  A diferen√ßa entre os testes de unidade e API √© bem ilustrada por este GIF: <br><br><img src="https://habrastorage.org/webt/ho/zb/me/hozbmexeumir1wdsjsgnlobh5xs.gif"><br>  <i>A fechadura funciona bem, mas est√° presa √† porta errada.</i> <br><br>  Nossos testes simulam uma sess√£o do cliente, s√£o capazes de enviar solicita√ß√µes ao back-end, seguindo nosso protocolo, e o back-end responde a eles como um cliente real. <br><br><h3>  Pool de usu√°rios de teste </h3><br>  O que precisamos para escrever com sucesso esses testes?  Vamos voltar √†s condi√ß√µes do show da nossa promo√ß√£o: <br><br><ul><li>  o usu√°rio no campo "Trabalho" indica "programador", <br></li><li>  o usu√°rio participa do teste A / B HL18_promo, <br></li><li>  O usu√°rio est√° registrado h√° mais de dois anos. <br></li></ul><br>  Aparentemente, aqui tudo √© sobre o usu√°rio.  E, na realidade, 99% dos testes de API requerem um usu√°rio registrado autorizado, presente em todos os servi√ßos e bancos de dados. <br><br>  Onde conseguir?  Voc√™ pode tentar registr√°-lo no momento do teste, mas: <br><br><ul><li>  √© longo e consome recursos; <br></li><li>  ap√≥s a conclus√£o do teste, esse usu√°rio precisa ser removido de alguma forma, o que √© uma tarefa n√£o trivial se estivermos falando de grandes projetos; <br></li><li>  finalmente, como em muitos outros projetos altamente carregados, realizamos muitas opera√ß√µes em segundo plano (adicionando um usu√°rio a v√°rios servi√ßos, replica√ß√£o para outros data centers etc.);  os testes n√£o sabem nada sobre esses processos, mas se eles implicitamente dependem dos resultados de sua execu√ß√£o, h√° um risco de instabilidade. <br></li></ul><br><br>  Desenvolvemos uma ferramenta chamada Test Users Pool.  √â baseado em duas id√©ias: <br><br><ol><li>  N√£o registramos usu√°rios o tempo todo, mas o usamos muitas vezes. <br></li><li>  Ap√≥s o teste, redefinimos os dados do usu√°rio para seu estado original (no momento do registro).  Se isso n√£o for feito, os testes se tornar√£o inst√°veis ‚Äã‚Äãao longo do tempo, porque os usu√°rios ser√£o "polu√≠dos" com informa√ß√µes de outros testes. <br></li></ol><br><br>  Funciona mais ou menos assim: <br><br><img src="https://habrastorage.org/webt/yg/db/p5/ygdbp5rwmfrbd2ssyiejb3bp8fs.png"><br><br>  Em algum momento, quer√≠amos executar nossos testes de API em um ambiente de produ√ß√£o.  Por que queremos isso?  Porque a infraestrutura de desenvolvimento n√£o √© a mesma que produ√ß√£o. <br><br>  Embora tentemos repetir constantemente a infraestrutura de produ√ß√£o em um tamanho reduzido, o desenvolvimento nunca ser√° uma c√≥pia completa dela.  Para ter certeza absoluta de que a nova compila√ß√£o atende √†s expectativas e n√£o h√° problemas, carregamos o novo c√≥digo no cluster de pr√©-produ√ß√£o, que trabalha com dados e servi√ßos de produ√ß√£o, e executamos nossos testes de API l√°. <br><br>  Nesse caso, √© muito importante pensar em como isolar usu√°rios de teste dos reais. <br><br><div class="spoiler">  <b class="spoiler_title">O que acontecer√° se os usu√°rios de teste come√ßarem a parecer reais em nosso aplicativo.</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gk/io/wg/gkiowghhl3b4hzazgj9u5e_wf4s.gif" width="300"></div><br></div></div><br>  Como isolar?  Cada um de nossos usu√°rios tem um sinalizador <code>is_test_user</code> .  No est√°gio de registro, torna-se <code>yes</code> ou <code>no</code> e n√£o muda mais.  Com esse sinalizador, isolamos os usu√°rios em todos os servi√ßos.  Tamb√©m √© importante excluirmos os usu√°rios de teste das an√°lises de neg√≥cios e dos resultados dos testes A / B para n√£o distorcer as estat√≠sticas. <br><br>  Voc√™ pode seguir de uma maneira mais simples: come√ßamos com o fato de que todos os usu√°rios de teste foram "realocados" para a Ant√°rtica.  Se voc√™ possui um servi√ßo geogr√°fico, esta √© uma maneira completamente funcional. <br><br><h3>  API de controle de qualidade </h3><br>  N√£o precisamos apenas de um usu√°rio - precisamos dele com certos par√¢metros: trabalhar como programador, participar de um determinado teste A / B e foi registrado h√° mais de dois anos.  Para usu√°rios de teste, podemos facilmente atribuir uma profiss√£o usando nossa API de back-end, mas entrar nos testes A / B √© probabil√≠stico.  E a condi√ß√£o de registro h√° mais de dois anos atr√°s √© geralmente dif√≠cil de cumprir, porque n√£o sabemos quando o usu√°rio apareceu no pool. <br><br>  Para resolver esses problemas, temos uma API de controle de qualidade.  Na verdade, esse √© um backdoor para testes, que √© um m√©todo API bem documentado que permite gerenciar de maneira r√°pida e f√°cil os dados do usu√°rio e alterar seu estado, ignorando o protocolo principal de nossa comunica√ß√£o com os clientes.  Os m√©todos s√£o escritos por desenvolvedores de back-end para engenheiros de controle de qualidade e para uso em testes de interface do usu√°rio e API. <br><br>  A API de controle de qualidade pode ser aplicada apenas no caso de usu√°rios de teste: se n√£o houver um sinalizador correspondente, o teste cair√° imediatamente.  Aqui est√° um dos m√©todos da API de controle de qualidade que permite alterar a data de registro do usu√°rio para uma data arbitr√°ria: <br><br><img src="https://habrastorage.org/webt/gw/mf/ws/gwmfwsbej3rtmytvaxdoxbzrvaa.png"><br><br>  E assim parecer√£o tr√™s chamadas que permitir√£o alterar rapidamente os dados do usu√°rio de teste, para que eles satisfa√ßam as condi√ß√µes de exibi√ß√£o da promo√ß√£o: <br><br><ul><li>  No campo "Trabalho", o "programador" √© indicado: <br> <code>addUserWorkEducation?user_id=ID&amp;works[]=Badoo, <br> </code> <br> </li><li>  O usu√°rio participa do teste A / B HL18_promo: <br> <code>forceSplitTest?user_id=ID&amp;test=HL18_promo</code> <br> </li><li>  Registrado h√° mais de dois anos: <br> <code>userCreatedChange?user_id=ID&amp;created=2016-09-01</code> <br> </li></ul><br><br>  Como esse √© um backdoor, √© imperativo pensar em seguran√ßa.  Protegemos nosso servi√ßo de v√°rias maneiras: <br><br><ul><li>  isolado no n√≠vel da rede: os servi√ßos podem ser acessados ‚Äã‚Äãsomente a partir da rede do escrit√≥rio; <br></li><li>  com cada solicita√ß√£o, passamos um segredo, sem o qual √© imposs√≠vel acessar a API de controle de qualidade, mesmo a partir da rede do escrit√≥rio; <br></li><li>  Os m√©todos funcionam apenas com usu√°rios de teste. <br></li></ul><br><br><h3>  Remotemocks </h3><br>  Para trabalhar com o back-end remoto de testes de API, podemos precisar de zombarias.  Para que?  Por exemplo, se o teste da API no ambiente de produ√ß√£o come√ßar a acessar o banco de dados, precisamos garantir que os dados contidos nele sejam limpos dos dados de teste.  Al√©m disso, as zombarias ajudam a tornar a resposta do teste mais adequada para o teste. <br><br>  Temos tr√™s textos: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jo/66/dc/jo66dczs4sbrfuzaohyqy7izy6e.png" width="300"></div><br><br>  O Badoo √© um aplicativo multil√≠ngue, temos um componente de localiza√ß√£o complexo que permite traduzir e receber tradu√ß√µes rapidamente para a localiza√ß√£o atual do usu√°rio.  Nossos localizadores est√£o trabalhando constantemente para melhorar as tradu√ß√µes, realizar testes A / B com tokens e procurar formula√ß√µes mais bem-sucedidas.  E, durante a realiza√ß√£o do teste, n√£o podemos saber qual texto ser√° retornado pelo servidor - ele pode ser alterado a qualquer momento.  Mas podemos usar o RemoteMocks para verificar se o componente de localiza√ß√£o √© acessado corretamente. <br><br>  Como o RemoteMocks funciona?  O teste solicita que o back-end os inicialize para sua sess√£o e, ap√≥s o recebimento de todas as solicita√ß√µes subsequentes, o back-end verifica zombarias para a sess√£o atual.  Se estiverem, basta inicializ√°-los usando o SoftMocks. <br><br>  Se queremos criar uma simula√ß√£o remota, indicamos qual classe ou m√©todo precisa ser substitu√≠do e com o qu√™.  Todas as solicita√ß√µes de back-end subsequentes ser√£o executadas levando em considera√ß√£o este mock: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;remoteInterceptMethod( \Promo\HighLoadConference::class, <span class="hljs-string"><span class="hljs-string">'saveUserEmailToDb'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> );</code> </pre><br>  Bem, agora vamos coletar nosso teste de API: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//       $app_startup = [ 'supported_promo_blocks' =&gt; [\Mobile\Proto\Enum\PromoBlockType::GENERIC_PROMO] ]; $Client = $this-&gt;getLoginedConnection(BmaFunctionalConfig::USER_TYPE_NEW, $app_startup); //  $Client-&gt;getQaApiClient()-&gt;addUserWorkEducation(['Badoo, ']); $Client-&gt;getQaApiClient()-&gt;forceSplitTest('HL18_promo'); $Client-&gt;getQaApiClient()-&gt;userCreatedChange('2016-09-01'); //     $this-&gt;remoteInterceptMethod(\Promo\HighLoadConference::class, 'saveUserEmail', true); //,   ,   $Resp = $Client-&gt;ServerGetPromoBlocks([]); $this-&gt;assertTrue($Resp-&gt;hasMessageType('CLIENT_NEXT_PROMO_BLOCKS')); $PromoBlock = $Resp-&gt;CLIENT_NEXT_PROMO_BLOCKS; ‚Ä¶ //   CTA, ,   ,   $Resp = $Client-&gt;ServerPromoAccepted($PromoBlock-&gt;getPromoId()); $this-&gt;assertTrue($Resp-&gt;hasMessageType('CLIENT_ACKNOWLEDGE_COMMAND'));</span></span></code> </pre><br><br>  De uma maneira t√£o simples, podemos testar qualquer funcionalidade que venha ao desenvolvimento no back-end e exija altera√ß√µes no protocolo m√≥vel. <br><br><h3>  Regras de uso de teste da API </h3><br>  Tudo parece estar bem, mas novamente encontramos um problema: os testes da API se mostraram muito convenientes para o desenvolvimento e houve uma tenta√ß√£o de us√°-los em qualquer lugar.  Como resultado, uma vez que percebemos que est√°vamos come√ßando a resolver problemas com a ajuda de testes de API para os quais eles n√£o eram destinados. <br><br>  Por que isso √© ruim?  Porque os testes da API s√£o muito lentos.  Eles acessam a rede, recorrem ao back-end, que inicia a sess√£o, acessam o banco de dados e v√°rios servi√ßos.  Portanto, desenvolvemos um conjunto de regras para o uso de testes de API: <br><ul><li>  O objetivo dos testes de API √© verificar o protocolo de intera√ß√£o entre o cliente e o servidor, bem como a correta integra√ß√£o do novo c√≥digo; <br><br></li><li>  √© permitido cobrir processos complexos com eles, por exemplo, cadeias de a√ß√µes; <br></li><li>  eles n√£o podem ser usados ‚Äã‚Äãpara testar a pequena variabilidade da resposta do servidor - esta √© a tarefa dos testes de unidade; <br></li><li>  durante a revis√£o do c√≥digo, verificamos incluindo os testes. <br></li></ul><br><h2>  Testes de interface do usu√°rio </h2><br>  Como estamos considerando uma pir√¢mide de automa√ß√£o, vou falar um pouco sobre os testes de interface do usu√°rio. <br><br>  Os desenvolvedores de back-end do Badoo n√£o escrevem testes de interface do usu√°rio - para isso, temos uma equipe dedicada no departamento de controle de qualidade.  Cobrimos o recurso com testes de interface do usu√°rio quando ele j√° √© lembrado e estabilizado, porque acreditamos que n√£o √© razo√°vel gastar recursos em uma automa√ß√£o bastante cara do recurso, que talvez n√£o v√° al√©m do teste A / B. <br><br>  Usamos o Calabash para testes autom√°ticos para dispositivos m√≥veis e o Selenium para a web.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ele</a> fala sobre a nossa plataforma para automa√ß√£o e teste. <br><br><h2>  Execu√ß√£o de teste </h2><br>  Agora, temos 100.000 testes de unidade, 6.000 - testes de integra√ß√£o e 14.000 testes de API.  Se voc√™ tentar execut√°-los em um encadeamento, mesmo em nossa m√°quina mais poderosa, uma execu√ß√£o completa levar√°: modular - 40 minutos, integra√ß√£o - 90 minutos, testes de API - dez horas.  √â muito longo. <br><br><h3>  Paraleliza√ß√£o </h3><br>  <i>Falamos sobre nossa experi√™ncia de testes de unidade paralelos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste artigo</a> .</i> <br><br>  A primeira solu√ß√£o, que parece √≥bvia, √© executar testes em v√°rios threads.  Mas fomos al√©m e criamos uma nuvem para o lan√ßamento paralelo para poder escalar recursos de hardware.  Simplificado, seu trabalho se parece com o seguinte: <br><br><img src="https://habrastorage.org/webt/2q/s8/v7/2qs8v7eoyhw_-e3iv-igmt_xui0.png"><br><br>  A tarefa mais interessante aqui √© a distribui√ß√£o de testes entre os threads, ou seja, sua divis√£o em partes. <br><br>  Voc√™ pode dividi-los igualmente, mas todos os testes s√£o diferentes, portanto, pode haver um forte vi√©s no tempo de execu√ß√£o de um encadeamento: todos os encadeamentos j√° foram atingidos e um trava por meia hora, pois teve "sorte" com testes muito lentos. <br><br>  Voc√™ pode iniciar v√°rios threads e aliment√°-los com um teste de cada vez.  Nesse caso, a desvantagem √© menos √≥bvia: h√° custos indiretos para inicializar o ambiente que, com um grande n√∫mero de testes e essa abordagem, come√ßam a desempenhar um papel importante. <br><br>  O que fizemos?  Come√ßamos a coletar estat√≠sticas sobre o tempo necess√°rio para executar cada teste e, em seguida, come√ßamos a compor partes de maneira que, de acordo com as estat√≠sticas, um encadeamento fosse executado por n√£o mais que 30 segundos.  Ao mesmo tempo, empacotamos os testes em peda√ßos para torn√°-los menores. <br><br>  No entanto, nossa abordagem tamb√©m tem uma desvantagem.  Est√° associado a testes de API: eles s√£o muito lentos e consomem muitos recursos, impedindo a execu√ß√£o de testes r√°pidos. <br><br>  Portanto, dividimos a nuvem em duas partes: na primeira, apenas os testes r√°pidos s√£o lan√ßados; na segunda, os r√°pidos e os lentos podem ser lan√ßados.  Com essa abordagem, sempre temos um peda√ßo da nuvem que pode lidar com testes r√°pidos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6z/py/0n/6zpy0n5tqvqmqjsf7huyqiu5ogo.png" width="600"></div><br><br>  Como resultado, os testes de unidade come√ßaram a ser executados em um minuto, os testes de integra√ß√£o em cinco minutos e os testes de API em 15 minutos.  Ou seja, uma execu√ß√£o completa em vez de 12 horas n√£o leva mais que 22 minutos. <br><br><h3>  Execu√ß√£o do teste de cobertura de c√≥digo </h3><br>  Temos um grande mon√≥lito complexo e, de uma maneira boa, precisamos executar todos os testes constantemente, pois uma mudan√ßa em um lugar pode quebrar algo em outro.  Essa √© uma das principais desvantagens da arquitetura monol√≠tica. <br><br>  Em algum momento, chegamos √† conclus√£o de que voc√™ n√£o precisa executar todos os testes todas as vezes - voc√™ pode executar com base na cobertura do c√≥digo: <br><br><ol><li>  Veja o nosso diferencial. <br></li><li>  Criamos uma lista de arquivos modificados. <br></li><li>  Para cada arquivo, obtemos uma lista de testes, <br>  que cobrem isso. <br></li><li>  A partir desses testes, criamos um conjunto e o executamos em uma nuvem de teste. <br></li></ol><br>  Onde obter cobertura?  Coletamos dados uma vez por dia quando a infraestrutura do ambiente de desenvolvimento est√° ociosa.  O n√∫mero de testes executados diminuiu acentuadamente, a velocidade de receber feedback deles, pelo contr√°rio, aumentou significativamente.  Lucro! <br><br>  Um b√¥nus adicional foi a capacidade de executar testes de patches.  Apesar de o Badoo n√£o ser uma startup h√° muito tempo, ainda podemos implementar rapidamente mudan√ßas na produ√ß√£o, aplicar hot fix, distribuir recursos rapidamente e alterar a configura√ß√£o.  Como regra, a velocidade de lan√ßamento de patches √© muito importante para n√≥s.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A nova abordagem deu um grande aumento na velocidade de feedback dos testes, porque agora n√£o precisamos esperar muito tempo para uma execu√ß√£o completa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas sem as falhas, em lugar nenhum. </font><font style="vertical-align: inherit;">Lan√ßaremos o back-end duas vezes por dia, e a cobertura √© relevante apenas para o primeiro lan√ßamento, at√© o primeiro build, ap√≥s o qual ele fica para tr√°s em um build. </font><font style="vertical-align: inherit;">Portanto, para compila√ß√µes, executamos um conjunto de testes completo. </font><font style="vertical-align: inherit;">Para n√≥s, isso √© uma garantia de que a cobertura do c√≥digo n√£o est√° muito atr√°s e que todos os testes necess√°rios foram conclu√≠dos. </font><font style="vertical-align: inherit;">O pior que pode acontecer √© que pegaremos alguns testes ca√≠dos no est√°gio de cria√ß√£o do build, e n√£o nos est√°gios anteriores. </font><font style="vertical-align: inherit;">Mas isso acontece muito raramente.</font></font><br><br>         API-,      code coverage.         ,   ,    .       - ,  API-         . <br><br><h2>  Conclus√£o </h2><br><ul><li>       ,       .    - , , -    . <br></li><li>   ‚â† .    code review    ,   . <br></li><li>       , ,     .         . <br></li><li>   .              . <br></li><li> ,    !     ,         . <br></li></ul><br><br><blockquote> <b> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Badoo PHP Meetup 16 </a> .         PHP-.    ,   .   ! <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  12:00,  ‚Äî   YouTube-</a></b> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt443768/">https://habr.com/ru/post/pt443768/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt443754/index.html">Sobre a adequa√ß√£o do Selenium WebDriverWait</a></li>
<li><a href="../pt443756/index.html">Design da classe: O que √© bom?</a></li>
<li><a href="../pt443758/index.html">Reconhecimento r√°pido do Doodle de desenho: Como fazer amigos R, C ++ e redes neurais</a></li>
<li><a href="../pt443764/index.html">O que o designer fumava: uma arma de fogo incomum</a></li>
<li><a href="../pt443766/index.html">Tentando a programa√ß√£o de contratos C ++ 20 agora</a></li>
<li><a href="../pt443770/index.html">Design Orientado a Dom√≠nio: Objetos de Valor e N√∫cleo da Estrutura de Entidades na Pr√°tica</a></li>
<li><a href="../pt443772/index.html">Antiguidades: IBM ThinkPad T40, o primeiro sistema sem fio</a></li>
<li><a href="../pt443774/index.html">Como a neurobiologia interfere nas elei√ß√µes presidenciais nos EUA</a></li>
<li><a href="../pt443776/index.html">China introduz um sistema experimental de reconhecimento facial ao pagar metr√¥</a></li>
<li><a href="../pt443780/index.html">Projeto MCDM. Parte 1. Conceito</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>