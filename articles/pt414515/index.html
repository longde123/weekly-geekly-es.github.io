<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¢ üå∫ üö£üèº Li√ß√£o de otimiza√ß√£o do servidor de aplicativos da web üßîüèæ üìÖ üë®üèø‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Meu nome √© Alexey Pristavko, sou o diretor de projetos da Web no DataLine. Meu artigo de hoje √© sobre como corrigir ou impedir problemas de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Li√ß√£o de otimiza√ß√£o do servidor de aplicativos da web</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/414515/"><img src="https://habrastorage.org/getpro/habr/post_images/a96/4bf/146/a964bf1461da7bcce74ab62b242aa133.png"><br><br>  Ol√° Habr!  Meu nome √© Alexey Pristavko, sou o diretor de projetos da Web no DataLine.  Meu artigo de hoje √© sobre como corrigir ou impedir problemas de desempenho de back-end de aplicativos da web. <br><br>  Isso se concentrar√° em como otimizar aplicativos da Web que sofrem de problemas cr√¥nicos de escalabilidade, desempenho ou confiabilidade. <br>  Qualquer pessoa interessada - bem-vindo sob o corte! <br><a name="habracut"></a><br><h2>  Terminologia </h2><br>  Vamos come√ßar com uma olhada na terminologia.  Falando sobre o desempenho de projetos ou sistemas da web, quero dizer principalmente o back-end e o componente do servidor.  O que acontece ao carregar p√°ginas em um navegador √© uma hist√≥ria completamente diferente, que, provavelmente, ser√° dedicada a um artigo separado. <br><br><ul><li>  A medida <b>de desempenho do</b> aplicativo ser√° o n√∫mero de solicita√ß√µes processadas por segundo (RPS) e sua velocidade de execu√ß√£o (TTFB - Time to First Byte). <br></li><li>  Assim, por <b>escalabilidade do</b> sistema, queremos dizer um conjunto de oportunidades para aumentar o RPS. <br></li></ul><br>  Agora sobre confiabilidade.  Aqui √© necess√°rio separar dois conceitos: toler√¢ncia a falhas e toler√¢ncia a desastres. <br><br><ul><li> <b>Resili√™ncia a falhas</b> - a capacidade de um sistema <b>falhar</b> se um ou mais servidores <b>falharem</b> em continuar trabalhando dentro dos par√¢metros necess√°rios. <br></li><li>  Os sistemas com redund√¢ncia de backup completo (o chamado segundo ombro) e capazes de funcionar sem uma forte redu√ß√£o com a falha completa de um dos data centers s√£o considerados <b>resistentes a desastres</b> . <br></li></ul><br>  <b>Ao mesmo tempo, um sistema tolerante a desastres √© um sistema √† prova de falhas.</b>  Uma situa√ß√£o em que um sistema tolerante a desastres, mas n√£o tolerante a falhas, continua trabalhando em apenas um ‚Äúombro‚Äù √© bastante normal.  Mas se um dos servidores falhar, o sistema tamb√©m falhar√°. <br><br>  Agora que descobrimos os principais conceitos e atualizamos a terminologia atual, √© hora de passar diretamente para o b√°sico de otimiza√ß√£o e hacks de vida. <br><br><h2>  Por onde come√ßar a otimiza√ß√£o </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/1e9/7ed/adf/1e97edadf840f697e8a995e8a53d7269.png"><br><br>  Como entender por onde come√ßar a otimiza√ß√£o?  Antes de se apressar para otimizar, respire fundo e gaste tempo pesquisando o aplicativo. <br><br>  Certifique-se de desenhar um diagrama detalhado.  Exiba nele todos os componentes do aplicativo e seus relacionamentos.  Depois de examinar esse esquema, voc√™ pode descobrir vulnerabilidades anteriormente impercept√≠veis e poss√≠veis pontos de falha. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/996/3fb/b5a/9963fbb5a9be1336886b708fb4d071e2.png"><br><br><h3>  ‚ÄúO que?  Onde  Quando?  - otimizar consultas </h3><br>  Preste aten√ß√£o especial √†s solicita√ß√µes s√≠ncronas.  Deixe-me lembr√°-lo, essas s√£o solicita√ß√µes quando enviamos uma solicita√ß√£o no mesmo segmento e aguardamos uma resposta.  √â aqui que est√£o os motivos dos freios graves quando algo d√° errado do outro lado.  Portanto, se voc√™ puder reduzir o n√∫mero de solicita√ß√µes s√≠ncronas ou substitu√≠-las por solicita√ß√µes ass√≠ncronas, fa√ßa-o. <br><br>  Aqui est√£o alguns truques para ajud√°-lo a acompanhar suas solicita√ß√µes: <br><br><ul><li>  <b>Atribua um identificador exclusivo para cada solicita√ß√£o recebida.</b>  O Nginx possui uma vari√°vel interna $ request_id para isso.  Passe o identificador nos cabe√ßalhos no back-end e grave em todos os logs.  Assim, voc√™ pode rastrear convenientemente solicita√ß√µes. </li><li>  <b>Registre n√£o apenas o final da solicita√ß√£o no componente externo, mas tamb√©m seu in√≠cio.</b>  Ent√£o voc√™ mede a dura√ß√£o real da chamada externa.  Pode diferir significativamente do que voc√™ v√™ no sistema remoto, por exemplo, devido a problemas de rede ou freios de DNS. </li></ul><br>  Ent√£o, os dados s√£o coletados.  Agora vamos analisar os pontos problem√°ticos.  Definir: <br><br><ul><li>  Onde fica mais tempo? </li><li>  De onde vem a maioria dos pedidos? </li><li>  De onde v√™m os pedidos mais longos? </li></ul><br>  Como resultado, voc√™ obter√° uma lista das se√ß√µes mais interessantes do sistema para otimiza√ß√£o. <br><br><blockquote>  <b>Dica:</b> Se algum ponto "coletar" muitas consultas pequenas, tente combin√°-las em uma consulta grande para reduzir a sobrecarga.  Os resultados de consultas longas geralmente fazem sentido no cache. </blockquote><br><h3>  Armazenamos em cache sabiamente </h3><br>  Existem regras gerais de cache nas quais voc√™ deve confiar ao otimizar: <br><br><ul><li>  <b>Quanto mais pr√≥ximo o cache do consumidor, mais r√°pido o trabalho.</b>  Para o aplicativo, o local "mais pr√≥ximo" ser√° a RAM.  Para o usu√°rio, seu navegador. </li><li>  <b>O armazenamento em cache acelera a aquisi√ß√£o de dados e reduz a carga na fonte.</b> </li></ul><br>  Se dez servidores da Web fizerem as mesmas consultas ao banco de dados, um cache intermedi√°rio centralizado, por exemplo no Redis, fornecer√° uma porcentagem maior de ocorr√™ncias (em compara√ß√£o com o cache local) e reduzir√° a carga geral no banco de dados, o que melhorar√° significativamente a imagem geral. <br><br><blockquote>  <b>Dica 1:</b> Fa√ßa o cache de componentes da p√°gina finalizada no lado do Nginx usando o Edge Side Include.  Ele se adapta bem √† arquitetura de microsservi√ßo / SOA e descarrega o sistema como um todo, melhorando consideravelmente a velocidade de resposta. <br><br>  <b>Dica 2:</b> acompanhe o tamanho dos objetos no cache, a taxa de acertos e os volumes de grava√ß√£o / leitura.  Quanto maior o objeto, mais tempo ser√° necess√°rio para processar.  Se voc√™ escreve no cache com mais frequ√™ncia ou mais do que l√™, esse cache n√£o √© seu amigo.  Vale a pena remover ou pensar em aumentar sua efic√°cia. <br><br>  <b>Dica 3:</b> use seus pr√≥prios caches de banco de dados sempre que poss√≠vel.  A configura√ß√£o adequada pode acelerar o trabalho. </blockquote><br><h3>  Carregar perfis </h3><br>  Passamos para carregar perfis.  Como voc√™ sabe, existem dois tipos principais: OLAP e OLTP. <br><br><ul><li>  <b>Para OLAP</b> (Online Analytical Processing), a quantidade de tr√°fego gasto por segundo √© importante. <br></li><li>  <b>Para o OLTP</b> (Online Transaction Processing), o indicador principal √© a velocidade de resposta, tempos de milissegundos. <br></li></ul><br>  Na maioria das vezes, √© eficaz separar esses dois tipos de carga.  No m√≠nimo, voc√™ precisar√° de um ajuste separado do banco de dados e, possivelmente, de outros componentes do sistema. <br><br><blockquote>  <b>Dica:</b> Normalmente, as solicita√ß√µes de leitura do painel do administrador s√£o processadas usando o tipo OLAP.  Crie uma c√≥pia separada do banco de dados e um servidor web para esta tarefa descarregar o sistema principal. </blockquote><h3>  Bases de dados </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/753/b35/7df/753b357df47b173bb57ab2de92e02e58.png"><br><br>  Portanto, abordamos naturalmente um dos est√°gios mais dif√≠ceis da otimiza√ß√£o - a otimiza√ß√£o do banco de dados. <br><br>  Deixe-me lembr√°-lo da regra geral: quanto menor o banco de dados, mais r√°pido ele funciona.  A pr√≥pria organiza√ß√£o do banco de dados √© crucial quando se trata de velocidade. <br><br>  Se poss√≠vel, armazene <b>dados hist√≥ricos</b> , logs de aplicativos e dados <b>usados ‚Äã‚Äãcom freq√º√™ncia</b> em diferentes bancos de dados.  Melhor ainda, publique-os em diferentes servidores.  Isso n√£o apenas facilitar√° a vida √∫til do banco de dados principal, mas tamb√©m fornecer√° mais espa√ßo para otimiza√ß√£o adicional; por exemplo, em alguns casos, permitir√° o uso de √≠ndices diferentes para cargas diferentes.  Al√©m disso, a ‚Äúuniformidade‚Äù da carga simplifica a vida √∫til do planejador e do otimizador de consultas do servidor de banco de dados. <br><br><h3>  E novamente sobre a import√¢ncia do planejamento </h3><br>  Para n√£o confundir a otimiza√ß√£o onde ela n√£o √© realmente necess√°ria, escolha o hardware com base nas tarefas. <br><br><ul><li>  Para solicita√ß√µes pequenas, mas frequentes, √© melhor usar mais n√∫cleos de processador. </li><li>  Para solicita√ß√µes pesadas - menos n√∫cleos com maior velocidade de clock. </li></ul><br>  Tente colocar o volume de trabalho do banco de dados na RAM.  Se isso n√£o for poss√≠vel ou se houver um grande n√∫mero de solicita√ß√µes de grava√ß√£o, √© hora de transferir os bancos de dados para SSDs.  Eles fornecer√£o um aumento significativo na velocidade de trabalho com o disco. <br><br><h2>  Dimensionamento </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/54b/df1/be6/54bdf1be69c1d596c882fc2d04d5c11c.png"><br><br>  Acima, descrevi a mec√¢nica chave para melhorar o desempenho do aplicativo sem aumentar seus recursos f√≠sicos. <br><br>  Agora, falaremos sobre como escolher uma estrat√©gia de dimensionamento e aumentar a resili√™ncia. <br><br>  Existem dois tipos de dimensionamento do sistema: <br><br><ul><li>  <b>vertical</b> - o crescimento de recursos, mantendo o n√∫mero de entidades; <br></li><li>  <b>horizontal</b> - um aumento no n√∫mero de entidades. <br></li></ul><br><h3>  Cres√ßa alto </h3><br>  Vamos come√ßar escolhendo uma estrat√©gia de dimensionamento vertical. <br><br>  Primeiro, considere o <b>aumento da energia do sistema</b> .  Se o seu sistema funcionar em um servidor, voc√™ dever√° escolher entre aumentar a capacidade do servidor atual ou comprar outro. <br><br>  Pode parecer que a primeira op√ß√£o √© mais f√°cil e segura.  Mas ser√° mais ambicioso comprar mais um servidor e receber uma grande toler√¢ncia a falhas como um b√¥nus √† produtividade.  Eu falei sobre isso no come√ßo do artigo. <br><br>  Se o seu sistema possui v√°rios servidores e a op√ß√£o √© aumentar a capacidade dos existentes ou comprar um pouco mais, preste aten√ß√£o no lado financeiro.  Por exemplo, um servidor poderoso pode ser mais caro que dois 50% "mais fraco".  Portanto, ser√° razo√°vel considerar a segunda op√ß√£o de compromisso.  Ao mesmo tempo, com um grande n√∫mero de servidores, a propor√ß√£o de desempenho, consumo de energia e o custo de um rack completo √© crucial. <br><br><h3>  Crescer </h3><br>  A escala horizontal √© uma hist√≥ria sobre toler√¢ncia a falhas e cluster.  No caso geral, quanto mais inst√¢ncias de uma entidade tivermos, maior a toler√¢ncia a falhas de toda a solu√ß√£o. <br><br>  Provavelmente, a primeira coisa que voc√™ deseja escalar s√£o os <b>servidores de aplicativos</b> .  O primeiro obst√°culo para isso √© a organiza√ß√£o do trabalho com fontes de dados centralizadas.  Al√©m dos bancos de dados, tamb√©m s√£o dados da sess√£o e conte√∫do est√°tico.  Aqui est√° o que eu recomendo que voc√™ fa√ßa: <br><br><ul><li>  <b>Para armazenar sess√µes,</b> use o Couchbase, n√£o o habitual Memcached, pois ele funciona com o mesmo protocolo, mas, diferentemente do memcached, ele oferece suporte ao cluster. <br></li><li>  <b>Todas as est√°ticas</b> , especialmente grandes volumes de imagens e documentos, s√£o armazenadas separadamente e servidas usando o Nginx, e n√£o a partir do c√≥digo do aplicativo.  Isso economizar√° dinheiro em fluxos e simplificar√° o gerenciamento da infraestrutura. <br></li></ul><br><h3>  "Puxando" o banco de dados </h3><br>  Dif√≠cil de dimensionar bancos de dados.  Existem duas t√©cnicas principais para isso: fragmenta√ß√£o e replica√ß√£o.  Considere-os. <br><br>  Durante a <b>replica√ß√£o,</b> adicionamos c√≥pias completamente id√™nticas do banco de dados ao sistema, enquanto <b>sharding</b> , partes separadas logicamente, shards.  Ao mesmo tempo, √© altamente desej√°vel realizar sharding em paralelo com a replica√ß√£o (replica√ß√£o) de cada shard, para n√£o perder a toler√¢ncia a falhas. <br><br><blockquote>  <b>Lembre-se:</b> geralmente um cluster de banco de dados consiste em um n√≥ principal que assume o fluxo de grava√ß√£o e v√°rios n√≥s escravos usados ‚Äã‚Äãpara leitura.  Do ponto de vista da toler√¢ncia a falhas, isso √© um pouco melhor que um √∫nico servidor, pois a toler√¢ncia geral a falhas √© determinada pelo elemento menos est√°vel do sistema. </blockquote><br>  Esquemas com mais de dois assistentes de banco de dados (topologia em anel) sem confirmar o registro em cada servidor, muitas vezes sofrem inconsist√™ncia.  No caso de uma falha de um dos servidores, ser√° extremamente dif√≠cil restaurar a integridade l√≥gica dos dados no cluster. <br><br><blockquote>  <b>Dica:</b> Se, no seu caso, n√£o for racional ter v√°rios servidores principais, considere a possibilidade arquitet√¥nica do sistema funcionar sem um mestre por pelo menos uma hora.  Em caso de acidente, isso permitir√° que voc√™ substitua o servidor sem tempo de inatividade de todo o sistema. <br><br>  <b>Dica:</b> Se voc√™ precisar manter mais de 2 mestres de banco de dados, recomendo que considere as solu√ß√µes NoSQL, pois muitas delas possuem mecanismos internos para colocar os dados em um estado consistente. </blockquote><br>  Na busca pela toler√¢ncia a falhas, em nenhum caso, n√£o esque√ßa que a replica√ß√£o protege voc√™ <b>somente contra falhas f√≠sicas do servidor</b> .  Ele n√£o ser√° salvo da corrup√ß√£o de dados l√≥gicos devido a erro do usu√°rio. <br><br><blockquote>  <b>Lembre-se:</b> Todos os dados importantes devem ser armazenados em backup e armazenados como uma c√≥pia independente e n√£o edit√°vel. </blockquote><br><h2>  Em vez de uma conclus√£o </h2><br>  Por fim, algumas dicas de desempenho para fazer backup: <br><br><blockquote>  <b>Dica 1:</b> extraia dados de uma r√©plica de banco de dados separada para n√£o sobrecarregar o servidor ativo. <br><br>  <b>Dica 2:</b> Tenha em m√£os uma r√©plica adicional, ligeiramente "atrasada" no tempo do banco de dados.  Em caso de acidente, isso ajudar√° a reduzir a quantidade de dados perdidos. </blockquote><br>  Os m√©todos e t√©cnicas apresentados neste artigo nunca devem ser usados ‚Äã‚Äã√†s cegas, sem analisar a situa√ß√£o atual e entender o que voc√™ deseja alcan√ßar.  Voc√™ pode encontrar "super otimiza√ß√£o", e o sistema resultante ser√° apenas 10% mais r√°pido, mas 50% mais vulner√°vel a acidentes. <br><br>  Isso √© tudo.  Se voc√™ tiver alguma d√∫vida, terei prazer em respond√™-las nos coment√°rios. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt414515/">https://habr.com/ru/post/pt414515/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt414503/index.html">Intel NUC Hades Canyon com gr√°ficos AMD Vega - VR ou n√£o VR?</a></li>
<li><a href="../pt414505/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Palestra 2: ‚ÄúControle de ataques de hackers‚Äù, parte 1</a></li>
<li><a href="../pt414507/index.html">Como o teclado program√°vel mais popular para negocia√ß√£o mudou: a hist√≥ria do teclado da Bloomberg</a></li>
<li><a href="../pt414509/index.html">Conectamos qualquer (quase) rastreador GPS (usando o Sinotrack ST-901 como exemplo) √† casa inteligente HomeAssistant</a></li>
<li><a href="../pt414513/index.html">27 √≥timas ferramentas de desenvolvimento web de c√≥digo aberto</a></li>
<li><a href="../pt414517/index.html">Cientistas de Oxford: a probabilidade de estarmos sozinhos na parte previs√≠vel do universo √© muito maior que zero</a></li>
<li><a href="../pt414519/index.html">Como transformar 15 minutos de reuni√µes do Scrum em uma casa cheia?</a></li>
<li><a href="../pt414523/index.html">Compara√ß√£o de quadcopters DJI Mavic Pro e Mavic Air</a></li>
<li><a href="../pt414525/index.html">O livro ‚ÄúEffective Spark. Dimensionamento e otimiza√ß√£o "</a></li>
<li><a href="../pt414527/index.html">O que nos espera no Highload ++ Siberia, exceto os ursos pintados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>