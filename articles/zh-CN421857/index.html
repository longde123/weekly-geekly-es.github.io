<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎈 ♂️ ↘️ ToFoIn v 1.在FreeBSD中保留网关并在外部通道之间切换 🍏 💪🏻 👨🏾‍⚕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="注解 
 在上一篇文章中，考虑了LAN网关的冗余组织。 作为一种解决方案，提出了一个脚本，该脚本当时解决了该问题，但存在许多缺点。 一段时间后，事实证明是消除了这些缺点，部分重写了代码并在输出中获得了可接受的东西。 现在我们可以说脚本已经过足够的测试，可以称为稳定脚本。 为了简化对整个系统的理解，下...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ToFoIn v 1.在FreeBSD中保留网关并在外部通道之间切换</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421857/"><h3> 注解 </h3><br> 在上一篇文章中，考虑了LAN网关的冗余组织。 作为一种解决方案，提出了一个脚本，该脚本当时解决了该问题，但存在许多缺点。 一段时间后，事实证明是消除了这些缺点，部分重写了代码并在输出中获得了可接受的东西。 现在我们可以说脚本已经过足够的测试，可以称为稳定脚本。 为了简化对整个系统的理解，下面将部分复制用于设置辅助服务的要点（就本文的主题而言）。 原因很简单-在这段时间里，ipfw规则也被修改，dns使用绑定前端在Samba4上驻留在AD中，并使用kerberos安全地更新了isc-dhcpd中的记录，并在网关上绑定了辅助DNS服务器，配置的CARP ...总的来说，它变得越来越有趣，但是下面将介绍有关其功能和工作方式的更多信息。 可以参考源给出的所有内容都将以不产生实质的方式进行设计。 从其他任何地方获取的内容，但不再可用，将在此处给出相关注释。 <br><a name="habracut"></a><br><h3> 引言 </h3><br> 因此，有两种方法可以提高用户与外界的通信通道的抗干扰能力：网关的备份和连接点的保留。 换句话说，在第一种情况下，将建立第二个网关，如果第一个网关发生故障，则将激活第二个网关;在第二种情况下，如果主要网关出现任何问题，则将组织一个备用Internet通道，并且它们越远越好。 如果<abbr title="公共地址冗余协议">CARP</abbr>解决了FreeBSD的第一个任务，那么在组织了第二个外部通道之后，第二个问题可以通过多种方式再次解决。 至少，您可以组织流量平衡或在通道之间进行切换。 由于外部通道带宽的巨大差异，第一个选项不<abbr title="切换Internet故障转移">适合</abbr>我，因此该出版物的主要罪魁祸首是： <abbr title="切换Internet故障转移">ToFoIn-</abbr>一组bash脚本，旨在解决诊断问题并切换到可用的外部通道。 优化后，可以应用于n个网关和m个通道。 这种情况很弱，其中n和m大于2，但是下面的脚本应使用较大的n和m值，因为 逻辑上，未设置限制。 总的来说，我怀疑使用这些脚本可以解决相当多的任务，具体取决于连接的状态，也许仅受想象力的限制。 <br><br><img src="https://habrastorage.org/webt/2e/yw/s8/2eyws8o9hbu3cxfpo0yja6dm_ea.png" width="500" align="left"><br> 这种网络拓扑大约以最简单的形式假设使用一组ToFoIn脚本。 当然，在单个路由器的情况下，脚本应该可以解决问题，但是在这种情况下，您将必须大力更改Daemon模块，以消除操作序列对CARP状态的依赖，而该依赖关系在系统中将根本不存在。 这些和其他节点的进一步保留仅取决于相应服务的重要性。 <br><br><h3> 目的和目的 </h3><br> 与以前一样，该项目的目标是创建一个通用且易于扩展的软件包，重点在于识别外部和内部连接中的问题并自动切换到可用连接。 一般而言，逻辑如下： <br><br><ul><li> 有n个“路由器”，每个路由器有m个外部通道。 此外，所有n个“路由器”都处于严格的层次结构中，并且在所有必要的接口上使用CARP相互连接。 </li><li> 代理在每台机器上独立工作，其任务基于其机器的当前CARP状态： <br><ul><li> 如果是备份-在当前是主路由器的路由器上检测并配置计算机； </li><li> 如果是主设备，请检查当前连接状态，并在必要时在外部通道之间切换。 </li></ul></li></ul><br><h3> 解决方案 </h3><br> 内部网络具有CARP，该CARP提供备份网关，并允许您在切换频道时不更改内部网络上其他网络设备的设置。 <br><br>  dhcpd在主要模式-辅助模式下运行，通常，它的计算机还扮演什么其他角色都没有关系-dhcpd之间的连接发生在内部网络上，路由器始终会看这些内部网络。 <br><br> 主绑定在隐藏在本地网络中的AD中被删除，而辅助绑定服务器与网关路由器在同等条件下工作。 <br><br>  ipfw规则因在给定时刻哪个通道被视为主通道而有所不同，并且在更改角色时由Daemon模块重新启动。 <br><br> 最后介绍一下脚本本身。 现在，这些文件位于相应的目录中，可以从其用户那里使用，并且在rc.d中具有启动脚本。 需要根访问权限的任务由sudo解决。 有一个安装脚本，它考虑了已安装版本的可能存在以及相当详细的设置文件。 这些模块是相同的，只是做了一些小的更改，其中一些功能几乎没有更改： <br><br>  <b>守护程序</b> -顾名思义-是在计时器上运行测试和切换模块并监视CARP的主要过程。 <br>  <b>测试仪</b> -仍使用ping命令测试外部通讯。  （如果正在运行，则认为计算机的“ CARP”处于“ Master”状态） <br>  <b>判断</b> -根据测试结果，确定哪个外部通道有效以及是否需要切换，然后执行切换（如果正在运行，则认为机器处于主状态的CARP）。 <br>  <b>侦察员</b>是一个新模块。 它在CARP处于备份状态时启动。 有必要确定当前剩余的路由器中哪一个是主要的。 <br>  <b>记录器</b> -负责事件记录。 有必要确保有关事件的信息不重复并且杂志易于阅读。 <br>  <b>看门狗</b> -按计划从crontab运行。 它确定所有模块的“冻结”状态，并在可能的情况下尝试解决所出现的问题。 即 钉住每个人，简单地说。 <br><br> 除了脚本本身之外，还值得考虑一些更重要的文件： <br><br>  <b>Tofoin.conf-</b>单个设置文件。 <br>  <b>Tofoin.log-</b>单个事件日志文件。 <br>  <b>Result_</b> &lt;内部通道号&gt;是一个工作文件，测试结果添加到此处，在/ tmp中在.pid和其他工作文件旁边创建。 <br><br> 我很乐意回答有关模块操作的问题，并在评论中解释解决方案。 <br><br><h3> 技术部分 </h3><br><h4> 配套设备 </h4><br> 与上次相比，网关迁移到P4，接收了1536 Mb RAM和三个40 Gb HDD（镜像+备用）。 网卡仍然是PCI，PSU是正常的，自然而然会有UPS。 <br> 容量的增加与铁的释放以及源头上过于繁琐的更新有关，但主要是第一个。  OS FreeBSD 11.1，FS zfs。 <br><br><h4> 系统组件设置 </h4><br><div class="spoiler">  <b class="spoiler_title">更多细节</b> <div class="spoiler_text"> 内核会使用其他附加参数进行编译（也可以在加载程序中进行某些设置，但是这样做更好）： <br><br><pre><code class="bash hljs">options IPFIREWALL <span class="hljs-comment"><span class="hljs-comment"># ipfw firewall options IPFIREWALL_VERBOSE options IPFIREWALL_VERBOSE_LIMIT=50 options IPFIREWALL_NAT options LIBALIAS options DUMMYNET options HZ=1000 options ROUTETABLES=4 options KSTACK_PAGES=4 options KVA_PAGES=512 device carp</span></span></code> </pre> <br> 设置/boot/loader.conf： <br><pre> <code class="bash hljs">geom_mirror_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> zfs_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> kern.geom.label.gptid.enable=<span class="hljs-string"><span class="hljs-string">"0"</span></span> vm.kmem_size=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vm.kmem_size_max=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vfs.zfs.arc_max=<span class="hljs-string"><span class="hljs-string">"512M"</span></span> vfs.zfs.vdev.cache.size=<span class="hljs-string"><span class="hljs-string">"30M"</span></span> vfs.zfs.prefetch_disable=1 kern.vty=vt</code> </pre> <br> 在第一台计算机上设置/etc/rc.conf（主要关注CARP配置）： <br><pre> <code class="bash hljs">ifconfig_eth0=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth0=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan222"</span></span> create_args_vlan111=<span class="hljs-string"><span class="hljs-string">"vlan 111"</span></span> create_args_vlan222=<span class="hljs-string"><span class="hljs-string">"vlan 222"</span></span> ifconfig_eth1=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth1=<span class="hljs-string"><span class="hljs-string">"vlan333 vlan444 vlan555"</span></span> create_args_vlan333=<span class="hljs-string"><span class="hljs-string">"vlan 333"</span></span> create_args_vlan444=<span class="hljs-string"><span class="hljs-string">"vlan 444"</span></span> create_args_vlan555=<span class="hljs-string"><span class="hljs-string">"vlan 555"</span></span> ifconfig_eth2=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth2=<span class="hljs-string"><span class="hljs-string">"vlan666 vlan777 vlan888"</span></span> create_args_vlan666=<span class="hljs-string"><span class="hljs-string">"vlan 666"</span></span> create_args_vlan777=<span class="hljs-string"><span class="hljs-string">"vlan 777"</span></span> create_args_vlan888=<span class="hljs-string"><span class="hljs-string">"vlan 888"</span></span> ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.1/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.1/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.1/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.1/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.1/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.1/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.1/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.1/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span> zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> named_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> dhcpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_logging=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_script=<span class="hljs-string"><span class="hljs-string">"/etc/firewall.sh"</span></span> gateway_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> tofoin_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <i>图例：</i> <i><br></i>  <i>eth0，eth1，eth2-物理适配器</i> <i><br></i>  <i>vlan666，vlan777，vlan888-虚拟LAN适配器，</i> <i><br></i>  <i>vlan222和vlan555-用于外部网卡之间的冗余通信的适配器（可能不再需要它们，它们在较早之前已被积极使用）</i> <i><br></i>  <i>vlan111-主要外部通道</i> <i><br></i>  <i>vlan444-备份外部通道</i> <i><br></i>  <i>vlan333-电话</i> <br> 在第二台机器上设置/etc/rc.conf（主要关注CARP配置，删除了一些重复的行）： <br><pre> <code class="bash hljs">ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.2/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.2/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.2/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.2/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.2/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.2/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.2/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.2/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span></code> </pre> <br> 在配置ipfw（nat）时需要注意的一些规则是： <br> 要允许CARP流量： <br><pre> <code class="bash hljs">/sbin/ipfw -q add allow carp from any to any</code> </pre> <br>  “核” nat： <br><pre> <code class="bash hljs">/sbin/ipfw -q nat 1 config <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ip vlan111 reset same_ports deny_in unreg_only /sbin/ipfw -q add nat 1 ip from any to any <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre> <br> 将特定的路由表与特定的适配器一起使用： <br><pre> <code class="bash hljs">/sbin/ipfw -q add setfib 0 all from any to any via vlan666</code> </pre> <br> 通常，我可以写一篇有关我使用的ipfw设置的单独文章，但这是另一些时间了。 <br></div></div><br><h4> 第三方软件 </h4><br><div class="spoiler">  <b class="spoiler_title">更多细节</b> <div class="spoiler_text"> 由于需要同时使用两个或多个外部通道，因此方便使用多个路由表，每个路由表一个。 如果这些表是在启动时自行创建的，那就太好了。  rc.d setfib脚本会有所帮助。  ToFoIn中使用的逻辑假定文件名（setfib1，setfib2等）与单个脚本向其中添加默认路由的表的编号匹配。 该表默认为数字“ 0”。 <br> 具有Bind（主要角色）的DNS服务器在辅助模式下工作，主要角色是samba4 + bind，隐藏在本地网络中。 在Cricket Lee和Paul Albitz的“ DNS和BIND”一书中详细介绍了设置辅助绑定的方法。 我不记得有任何特殊要求要考虑到将samba4用于辅助服务器，并且在设置文件中也没有提及这些要求。 除非针对不同的Internet通道，否则您可能需要创建2个不同的文件，然后这些文件将由ToFoIn脚本复制到绑定自身读取文件的位置。 这是由于以下事实：当在同一文件中指定两个提供程序的DNS服务器的地址时，考虑到绑定仅适用于一个路由表，因此会出现在特定时刻无法访问的上游服务器的地址解析问题。 <br> 故障转移isc-dhcpd。  Dhcpd对于ToFoIn并不是必不可少的，此外，它的缺失根本不会影响脚本，但是，在我看来，将dhcp服务器放置在网关上是很合逻辑的，然后仍然会出现故障转移问题。 与上次相比，这里变得更加有趣...除了故障转移所必需的设置（我<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上次已</a>描述）（下拉菜单内“预设”部分的开头）。 <br> 您还需要一个脚本来使用samba4安全更新AD中的dns记录。  samba4服务器本身应该只安装。 不需要设置和启动，我们只对该套件随附的管理工具感兴趣。 那些人可以在的“具有动态DNS更新的DHCP”部分中找到其他信息。 <br> 它看起来很吓人，但确实有效。 <br> 至此，第三方软件的配置完成。 <br></div></div><br><h4> 关于ToFoIn </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gitlab</a>上提供了所有项目文本以及安装脚本。 <br><br><div class="spoiler">  <b class="spoiler_title">最后，考虑一个ToFoIn设置文件参数的示例：</b> <div class="spoiler_text"> 系统中使用的路由器数量： <br><pre> <code class="bash hljs">RNUMBER=2</code> </pre> <br> 使用其他子网时，必须在路由器成为主子网时设置默认路由。 在这里，您可以指定将重新启动的相应setfib文件的编号。 在此示例中，setfib2： <br><pre> <code class="bash hljs">ADDITLAN=2</code> </pre> <br> 内部适配器名称： <br><pre> <code class="bash hljs">INT_IF=vlan666</code> </pre> <br> 路由器通过CARP连接的所有其他接口。 控制和维护所有接口的相同状态所必需： <br><pre> <code class="bash hljs">ALL_IF=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan333 vlan444 vlan666 vlan777 vlan888"</span></span></code> </pre> <br> 配置CARP时使用的vhid： <br><pre> <code class="bash hljs">CARP_VHID=1</code> </pre> <br> 其他路由器内部网络中的IP地址按重要性顺序排列，如果需要，则仅使用ASERV_IP_2，ASERV_IP_3等。 <br><pre> <code class="bash hljs">ASERV_IP_1=192.168.0.2</code> </pre> <br> 外部连接通道数： <br><pre> <code class="bash hljs">CNUMBER=2</code> </pre> <br> 主要外部连接通道的设置： <br> 适配器名称： <br><pre> <code class="bash hljs">EXT_0_IF=vlan111</code> </pre> <br> 路由表编号： <br><pre> <code class="bash hljs">RTABLE_0=0</code> </pre> <br> 默认网关： <br><pre> <code class="bash hljs">DEFAULT_GATEWAY=2.2.2.1</code> </pre> <br> 备份外部连接通道的设置： <br> 适配器名称： <br><pre> <code class="bash hljs">EXT_1_IF=vlan444</code> </pre> <br> 路由表编号： <br><pre> <code class="bash hljs">RTABLE_1=1</code> </pre> <br> 不需要默认网关，因为对于除主路由表之外的所有路由表，都使用rc.d脚本setfib &lt;表号&gt;，正如逻辑假设，该表必须与表号匹配。 <br> 测试仪模块参数： <br> 要检查的地址数： <br><pre> <code class="bash hljs">TNUMBER=2</code> </pre> <br> 发送ping请求的计算机的地址。 最好在第一种情况下使用域名，然后再使用该IP地址： <br><pre> <code class="bash hljs">PTARGET_0=ya.ru PTARGET_1=8.8.8.8</code> </pre> <br> 每个目标发送的ping数据包数： <br><pre> <code class="bash hljs">PNUMBER=2</code> </pre> <br> 判断模块设置 <br> 返回主通道前成功测试的次数。 恢复操作后返回主通道的时间大约由以下公式计算：（WNUMBER +1）* JUDGEPERIOD秒。 <br><pre> <code class="bash hljs">WNUMBER=3</code> </pre> <br> 记录器模块设置 <br> 这2个参数指示Logger多久记录一次重复事件。 记录事件之后，下一次报告LOGFREQ1重试次数，则LOGFREQ2是重试次数。 仅考虑连续事件。 <br><pre> <code class="bash hljs">LOGFREQ1=5 LOGFREQ2=20</code> </pre> <br> 模块启动计时器，以秒为单位 <br> 测试器模块的启动周期。 依靠失败的时间来测试所有目标是很有意义的。 <br><pre> <code class="bash hljs">TESTERPERIOD=240</code> </pre> <br> 评审模块的启动期。 安装的数量不要少于TESTERPERIOD。 <br><pre> <code class="bash hljs">JUDGEPERIOD=300</code> </pre> <br> 侦察模块的启动时间。 <br><pre> <code class="bash hljs">SCOUTPERIOD=360</code> </pre> <br> 检查Tester和Judge模块的启动计时器之前的等待时间。 设置小于或等于TESTERPERIOD的值是合乎逻辑的。 <br><pre> <code class="bash hljs">SENSITIVITY=60</code> </pre> <br> 工作模块被挂起之后的时间。 看门狗模块使用。 <br><pre> <code class="bash hljs">TESTERLIMIT=40 JUDGELIMIT=30 LOGGERLIMIT=20 SCOUTLIMIT=120 WATCHDOGLIMIT=150</code> </pre> <br> 文件和目录的路径 <br>  ipfw脚本的路径。 <br><pre> <code class="bash hljs">FIRESCRIPT=/etc/firewall.sh</code> </pre> <br>  IPFW设置。 如果ipfw设置未移至单独的文件，则FIRESCRIPT = FIRESETDEF。 <br><pre> <code class="bash hljs">FIRESETDEF=/etc/firewall/config</code> </pre> <br> 主要外部渠道的ipfw设置路径： <br><pre> <code class="bash hljs">FIRESET_0=/etc/firewall/config_0</code> </pre> <br> 备份外部通道的ipfw设置的路径，如有必要，您可以继续执行FIRESET_2等操作： <br><pre> <code class="bash hljs">FIRESET_1=/etc/firewall/config_1</code> </pre> <br> 绑定设置的路径 <br><pre> <code class="bash hljs">BINDSETDEF=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf</code> </pre> <br> 绑定主要外部通道的设置： <br><pre> <code class="bash hljs">BINDSET_0=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.0</code> </pre> <br> 绑定备用外部频道的设置，如有必要，您可以继续进行BINDSET_2等操作： <br><pre> <code class="bash hljs">BINDSET_1=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.1</code> </pre> <br> 所有ToFoIn可执行文件的路径： <br><pre> <code class="bash hljs">DAEMON=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/daemon.sh TESTER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/tester.sh JUDGE=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/judge.sh LOGGER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/logger.sh SCOUT=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/scout.sh WATCHDOG=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/watchdog.sh</code> </pre> <br> 事件日志。 现在不会在安装时创建此文件： <br><pre> <code class="bash hljs">LOGFILE=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/tofoin.log</code> </pre> <br> 相应模块启动时会创建临时文件和目录，停止时会删除其中的一些文件和目录： <br><pre> <code class="bash hljs">DIR_TMP=/tmp/tofoin DIR_PID=/var/run/tofoin JUDGEMETER=/tmp/tofoin/judgemeter PREVSTATE=/tmp/tofoin/prevstate SCOUTGATE=/tmp/tofoin/scoutgate LOGTMP=/tmp/tofoin/logger.tmp LOGMETER=/tmp/tofoin/logmeter DAEMON_PID=/var/run/tofoin/daemon.pid TESTER_PID=/var/run/tofoin SCOUT_PID=/var/run/tofoin/scout.pid JUDGE_PID=/var/run/tofoin/judge.pid LOGGER_PID=/var/run/tofoin/logger.pid WATCHDOG_PID=/var/run/tofoin_watchdog.pid</code> </pre> <br></div></div><br><h3> 总结 </h3><br> 事实证明，这是一组功能全面且可靠的脚本，可以很好地应对在具有2个外部通信通道的2个路由器的情况下切换到工作通道的任务。 <br><br><h3> 计划 </h3><br> 我对该项目的计划可能与将bash重写为pure sh来摆脱服务器上不必要的软件有关。 另一方面，现在一切正常，而且我真的不希望干扰此过程，此外，切换到sh充满了为达到相同结果所必需的更糟糕的语言构造。 <br> 对于其余的部分，可能值得考虑最佳实现测试模块。 <br><br><h3> 参考文献： </h3><br>  ← <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上一篇文章</a> <br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gitlab上的ToFoIn项目页面</a> <br><div class="spoiler">  <b class="spoiler_title">其余的</b> <div class="spoiler_text">  DNS绑定9： <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Lee K.，Albitz P.-DNS和BIND（第5版）</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DNS服务器绑定</a> <br>  DHCP： <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">故障转移DHCP</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">具有动态DNS更新的DHCP</a> <br>  <a href="">samba-dns更新</a> <br>  SETFIB： <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FreeBSD中没有BGP或类似协议的多个默认路由</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">setfib和路由表之间的切换</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FreeBSD的两个提供者。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">setfib</a> <br>  IPFW + NAT： <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipfw nat详细手册</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FreeBSD 9 + ipfw + ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipfw nat详细手册</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">虚拟网</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">内核NAT</a> <br> 重击： <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BASH的基础知识。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第二部分</a> <br>  <a href="">高级Bash脚本编写指南</a> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN421857/">https://habr.com/ru/post/zh-CN421857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN421845/index.html">数据分析师实际上在做什么？ 35次访谈的发现</a></li>
<li><a href="../zh-CN421847/index.html">跳入云端。 在NodeMCU + Azure IoT中心上构建预算IoT解决方案</a></li>
<li><a href="../zh-CN421849/index.html">2018年9月IT人力资源大事记：My Circle Digest</a></li>
<li><a href="../zh-CN421851/index.html">猫头鹰和全球问题：连接具有相同名称空间和类名称的两个程序集</a></li>
<li><a href="../zh-CN421855/index.html">家用投影机：最佳“按版本”，超短焦距，亮度和速度冠军</a></li>
<li><a href="../zh-CN421859/index.html">物联网提供商的说明。 设备和出价</a></li>
<li><a href="../zh-CN421863/index.html">创建纳米管的新方法：现已成色</a></li>
<li><a href="../zh-CN421867/index.html">如何使代码可读</a></li>
<li><a href="../zh-CN421869/index.html">使用Firebase ML Kit创建用于实时面部检测的Android应用程序</a></li>
<li><a href="../zh-CN421871/index.html">如何在Android应用程序中从Java迁移到Kotlin惨败</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>