<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öñÔ∏è üë≠ üì¥ Nota de calibra√ß√£o do sensor de posi√ß√£o inicial üêÉ ‚õ≥Ô∏è üïú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alguns sensores de acelera√ß√£o requerem calibra√ß√£o zero adicional ap√≥s a montagem na placa. Quando vi v√°rias fontes com a calibra√ß√£o de sensores de ace...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nota de calibra√ß√£o do sensor de posi√ß√£o inicial</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384075/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alguns sensores de acelera√ß√£o requerem calibra√ß√£o zero adicional ap√≥s a montagem na placa. </font><font style="vertical-align: inherit;">Quando vi v√°rias fontes com a calibra√ß√£o de sensores de acelera√ß√£o, onde o componente G era levado em considera√ß√£o simplesmente subtraindo = 9,8 m / s2 do eixo Z, surgiu a id√©ia de escrever esta nota.</font></font><br>
<br>
<img src="https://habrastorage.org/files/b4d/dcb/c3b/b4ddcbc3ba4d4e2dbd467eeab056db2d.jpg"><br>
<a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estrutura de publica√ß√£o</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Declara√ß√£o do problema e m√©todo de solu√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como conseguir os pontos?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como calcular o centro da bola?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como acelerar a busca pelo centro da bola?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De que outra forma acelerar a busca pelo centro da bola?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre erros de medi√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qual √© o problema - os sensores MEMS ap√≥s a instala√ß√£o na placa sofrem pequenas deforma√ß√µes que afetam:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">posi√ß√£o zero;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escala de valores medidos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a perpendicularidade dos eixos entre si.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E se a escala e a perpendicularidade forem violadas de maneira n√£o t√£o percept√≠vel, a posi√ß√£o do zero ficar√° emaranhada tangivelmente. Por exemplo, se voc√™ converter o valor t√≠pico do deslocamento zero para o aceler√¥metro do sensor MPU9250 em m / s </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , isso ser√° obtido na regi√£o de 0,2 m / s </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ou seja, o sensor est√° parado, mas mostra acelera√ß√£o e, ap√≥s 5 segundos, obtemos uma velocidade de 1 m / s. Por um lado, todos os dados do sensor s√£o sempre passados ‚Äã‚Äãpor algum tipo de filtro (por exemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Mas, por outro lado, por que o filtro deve compensar constantemente esse vi√©s? Afinal, o sensor mostrar√° movimento onde n√£o est√°. Isso reduz a precis√£o do resultado. Em suma, voc√™ precisa encontrar o valor de corre√ß√£o uma vez e subtrair esse valor de suas leituras durante a opera√ß√£o do sensor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solu√ß√£o mais simples para encontrar o valor do deslocamento zero, que vem √† mente imediatamente, √© criar as condi√ß√µes sob as quais o sensor deve mostrar com precis√£o zero. O valor registrado no sensor √© o valor do deslocamento zero! Assim? Mas a gravidade n√£o est√° constantemente atuando no aceler√¥metro. Para evit√°-lo, ser√° necess√°ria a aus√™ncia de peso (o lan√ßamento n√£o funcionar√°). O campo magn√©tico da Terra atua na b√∫ssola e sua rota√ß√£o no girosc√≥pio. Portanto, se voc√™ n√£o tem uma espa√ßonave pessoal, precisar√° criar algo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda solu√ß√£o que vem √† mente imediatamente √© colocar o sensor (ou melhor, seu eixo) em uma posi√ß√£o em que saberemos exatamente o que o sensor deve mostrar. A diferen√ßa entre o que o sensor mostra e o que deve mostrar - e haver√° um deslocamento zero! Assim? Por exemplo, sabemos que se o aceler√¥metro for colocado em um n√≠vel com o horizonte, em teoria, o vetor de acelera√ß√£o gravitacional ser√° direcionado exatamente ao longo do eixo Z do sensor. A magnitude do vetor de acelera√ß√£o que conhecemos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, h√° um problema. </font><font style="vertical-align: inherit;">Consiste no fato de que n√£o podemos definir com precis√£o o eixo do sensor em um n√≠vel com o horizonte. </font><font style="vertical-align: inherit;">O fato √© que a superf√≠cie na qual confiaremos n√£o √© paralela √† placa de circuito impresso. </font><font style="vertical-align: inherit;">Isso, por sua vez, n√£o √© paralelo ao local em que o sensor est√° localizado. </font><font style="vertical-align: inherit;">O sensor em si n√£o fica exatamente no seu local e os eixos dentro do sensor n√£o s√£o paralelos ao corpo do sensor. </font><font style="vertical-align: inherit;">O erro ao definir o eixo em rela√ß√£o ao horizonte em 1 grau fornece uma proje√ß√£o compar√°vel em tamanho ao valor do deslocamento do zero, que queremos encontrar. </font><font style="vertical-align: inherit;">No caso de um magnet√¥metro, tamb√©m n√£o sabemos para onde o vetor do campo magn√©tico √© direcionado. </font><font style="vertical-align: inherit;">Em teoria, ao norte. </font><font style="vertical-align: inherit;">Mas, na pr√°tica, o pr√≥prio campo magn√©tico da Terra √© heterog√™neo em intensidade e dire√ß√£o. </font><font style="vertical-align: inherit;">Al√©m disso, objetos de metal pr√≥ximos fazem seus ajustes.</font></font><br>
<img src="https://habrastorage.org/files/62a/4e5/7e2/62a4e57e29a24a389b1fddf12a652219.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Declara√ß√£o do problema e m√©todo de solu√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa √© a seguinte: precisamos determinar o vetor de deslocamento zero usando as leituras do sensor, que sempre registram o vetor de deslocamento + vetor de influ√™ncia externa constante (acelera√ß√£o gravitacional, rota√ß√£o da Terra, campo magn√©tico da Terra), a magnitude e a dire√ß√£o que n√£o sabemos (no caso do aceler√¥metro) sabemos o valor, mas, novamente, a escala do sensor pode n√£o ser igual a 1). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maneira de resolver. </font><font style="vertical-align: inherit;">Este artigo prop√µe determinar o vetor de deslocamento da seguinte maneira. </font><font style="vertical-align: inherit;">Pegamos e giramos o sensor de todas as maneiras e registramos as leituras do sensor. </font><font style="vertical-align: inherit;">Ap√≥s N medi√ß√µes, os valores retirados do sensor e localizados no gr√°fico ser√£o uma bola, cujo raio √© a magnitude do impacto externo e o centro √© o deslocamento zero exato desejado.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como conseguir os pontos?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para facilitar o pr√≥prio procedimento de medi√ß√£o, voc√™ pode escrever um programa simples. </font><font style="vertical-align: inherit;">Ele deve registrar os sensores quando o dispositivo estiver parado. </font><font style="vertical-align: inherit;">S√≥ precisamos colocar o dispositivo na posi√ß√£o desejada. </font><font style="vertical-align: inherit;">Para determinar um estado estacion√°rio, tamb√©m √© adequado um aceler√¥metro n√£o calibrado - basta fazer a diferen√ßa entre o valor atual e o anterior. </font><font style="vertical-align: inherit;">E se houver mais barulho, ent√£o corrigimos o movimento. </font><font style="vertical-align: inherit;">Meu limite √© obtido na regi√£o de 0,07G. </font><font style="vertical-align: inherit;">Se voc√™ segurar com as m√£os, mais do que esse valor sair√°. </font><font style="vertical-align: inherit;">Usei fita adesiva para fixar a posi√ß√£o. </font><font style="vertical-align: inherit;">Se ainda n√£o der certo, verifique se h√° uma geladeira, um ventilador ou algo semelhante por perto.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como pode estar no c√≥digo</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">//       </span><font></font>
<span class="hljs-keyword">static</span> TSumSensorsData 	g_sens_data[<span class="hljs-number">2</span>];<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int32_t</span>   	g_sens_data_sum_cnt[<span class="hljs-number">2</span>];<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span>		g_sens_data_num;<font></font>
<font></font>
<span class="hljs-comment">//  - ,     </span><font></font>
<span class="hljs-function">IS_INTERRUPT <span class="hljs-keyword">void</span> <span class="hljs-title">on_dma_raw_ready_calibrate_step1</span><span class="hljs-params">()</span></span><font></font><span class="hljs-function">
</span>{<font></font>
	SensorRawBuffer *raw = sensor_get_raw_buffer();<font></font>
	g_sens_data[g_sens_data_num].acc_x += swap_i16(raw-&gt;accell_x_unswap);<font></font>
	g_sens_data[g_sens_data_num].acc_y += swap_i16(raw-&gt;accell_y_unswap);<font></font>
	g_sens_data[g_sens_data_num].acc_z += swap_i16(raw-&gt;accell_z_unswap);<font></font>
	g_sens_data[g_sens_data_num].gyro_x += swap_i16(raw-&gt;gyro_x_unswap);<font></font>
	g_sens_data[g_sens_data_num].gyro_y += swap_i16(raw-&gt;gyro_y_unswap);<font></font>
	g_sens_data[g_sens_data_num].gyro_z += swap_i16(raw-&gt;gyro_z_unswap);<font></font>
	g_sens_data[g_sens_data_num].mag_x += raw-&gt;mag_x_raw * g_mag_calibrate.kx;<font></font>
	g_sens_data[g_sens_data_num].mag_y += raw-&gt;mag_y_raw * g_mag_calibrate.ky;<font></font>
	g_sens_data[g_sens_data_num].mag_z += raw-&gt;mag_z_raw * g_mag_calibrate.kz;<font></font>
	g_sens_data_sum_cnt[g_sens_data_num]++;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   main</span><font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sensors_calibrate_program</span><span class="hljs-params">(FlashROM *flash_ptr)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
	<span class="hljs-keyword">double</span> calibrate_result_error[<span class="hljs-number">3</span>];<font></font>
	TVector16 calibrate_result[<span class="hljs-number">3</span>];<font></font>
	<span class="hljs-keyword">int32_t</span> radius[ACCEL_NO_MOTION_DETECT_COUNT];<font></font>
	<span class="hljs-keyword">uint8_t</span> raw_is_deleted[ACCEL_NO_MOTION_DETECT_COUNT];<font></font>
	TVector16 raw[<span class="hljs-number">3</span>][ACCEL_NO_MOTION_DETECT_COUNT];<font></font>
	<font></font>
        . . .<font></font>
<font></font>
	<span class="hljs-comment">//  </span><font></font>
	g_sens_data_sum_cnt[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<font></font>
	g_sens_data_num = <span class="hljs-number">0</span>;<font></font>
	<span class="hljs-keyword">int16_t</span> prev_avg_x = <span class="hljs-number">0</span>;<font></font>
	<span class="hljs-keyword">int16_t</span> prev_avg_y = <span class="hljs-number">0</span>;<font></font>
	<span class="hljs-keyword">int16_t</span> prev_avg_z = <span class="hljs-number">0</span>;<font></font>
	<span class="hljs-keyword">int8_t</span> low_motion_cnt = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span>(low_motion_cnt &lt; ACCEL_NO_MOTION_DETECT_COUNT)<font></font>
	{<font></font>
		<span class="hljs-keyword">if</span> (g_sens_data_sum_cnt[g_sens_data_num] &gt;= ACCEL_NO_MOTION_DETECT_SAMPLES)<font></font>
		{<font></font>
			<span class="hljs-keyword">uint8_t</span> new_data_num = (g_sens_data_num + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">1</span>;<font></font>
			g_sens_data[new_data_num].acc_x = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].acc_y = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].acc_z = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].gyro_x = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].gyro_y = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].gyro_z = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].mag_x = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].mag_y = <span class="hljs-number">0</span>;<font></font>
			g_sens_data[new_data_num].mag_z = <span class="hljs-number">0</span>;<font></font>
			g_sens_data_sum_cnt[new_data_num] = <span class="hljs-number">0</span>;<font></font>
<font></font>
			<span class="hljs-keyword">uint8_t</span> old_data_num = g_sens_data_num;<font></font>
			g_sens_data_num = new_data_num; <span class="hljs-comment">//           </span><font></font>
			<span class="hljs-comment">// ( -    ,   )</span><font></font>
<font></font>
			<span class="hljs-comment">//     -  </span><font></font>
			<span class="hljs-keyword">int16_t</span> avg_x = g_sens_data[old_data_num].acc_x / g_sens_data_sum_cnt[old_data_num];<font></font>
			<span class="hljs-keyword">int16_t</span> avg_y = g_sens_data[old_data_num].acc_y / g_sens_data_sum_cnt[old_data_num];<font></font>
			<span class="hljs-keyword">int16_t</span> avg_z = g_sens_data[old_data_num].acc_z / g_sens_data_sum_cnt[old_data_num];<font></font>
<font></font>
			<span class="hljs-comment">//      </span><font></font>
			<span class="hljs-keyword">int16_t</span> dx = avg_x - prev_avg_x;<font></font>
			<span class="hljs-keyword">int16_t</span> dy = avg_y - prev_avg_y;<font></font>
			<span class="hljs-keyword">int16_t</span> dz = avg_z - prev_avg_z;<font></font>
			prev_avg_x = avg_x;<font></font>
			prev_avg_y = avg_y;<font></font>
			prev_avg_z = avg_z;<font></font>
<font></font>
			<span class="hljs-comment">//     </span><font></font>
			<span class="hljs-keyword">if</span> ((abs_i16(dx) &lt;= ACCEL_NO_MOTION_DETECT_AVG_VALUE)&amp;&amp;(abs_i16(dy) &lt;= ACCEL_NO_MOTION_DETECT_AVG_VALUE)&amp;&amp;(abs_i16(dz) &lt;= ACCEL_NO_MOTION_DETECT_AVG_VALUE))<font></font>
			{<font></font>
				<span class="hljs-comment">//    </span><font></font>
				raw[RAW_ACC][low_motion_cnt].x = avg_x;<font></font>
				raw[RAW_ACC][low_motion_cnt].y = avg_y;<font></font>
				raw[RAW_ACC][low_motion_cnt].z = avg_z;<font></font>
				raw[RAW_GYRO][low_motion_cnt].x = g_sens_data[old_data_num].gyro_x / g_sens_data_sum_cnt[old_data_num];<font></font>
				raw[RAW_GYRO][low_motion_cnt].y = g_sens_data[old_data_num].gyro_y / g_sens_data_sum_cnt[old_data_num];<font></font>
				raw[RAW_GYRO][low_motion_cnt].z = g_sens_data[old_data_num].gyro_z / g_sens_data_sum_cnt[old_data_num];<font></font>
				raw[RAW_MAG][low_motion_cnt].x = g_sens_data[old_data_num].mag_x / g_sens_data_sum_cnt[old_data_num];<font></font>
				raw[RAW_MAG][low_motion_cnt].y = g_sens_data[old_data_num].mag_y / g_sens_data_sum_cnt[old_data_num];<font></font>
				raw[RAW_MAG][low_motion_cnt].z = g_sens_data[old_data_num].mag_z / g_sens_data_sum_cnt[old_data_num];<font></font>
<font></font>
				low_motion_cnt++;<font></font>
<font></font>
				<span class="hljs-comment">//   </span><font></font>
				beep();<font></font>
<font></font>
				<span class="hljs-comment">//     2   ,     -   </span><font></font>
				<span class="hljs-comment">//  -  </span><font></font>
				<span class="hljs-comment">//      </span><font></font>
				delay_ms(<span class="hljs-number">2000</span>);<font></font>
			}<font></font>
		}<font></font>
	}<font></font>
. . .<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para colocar a bola no gr√°fico, voc√™ precisa torcer o dispositivo com o sensor de acordo com um determinado esquema. </font><font style="vertical-align: inherit;">Para esses fins, o globo √© adequado, pois possui uma marca√ß√£o. </font><font style="vertical-align: inherit;">Voc√™ pode pensar que precisa esculpir em todo o mundo. </font><font style="vertical-align: inherit;">Mas isso n√£o √© verdade.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo de resultado incorreto</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/3b4/db9/bdf/3b4db9bdff434974b8616d24153755a1.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â necess√°rio esculpir o sensor n√£o em toda a superf√≠cie do globo, mas em um meridiano. </font><font style="vertical-align: inherit;">Suponha que levemos sete pontos no meridiano (o primeiro e o √∫ltimo nos polos norte e sul). </font><font style="vertical-align: inherit;">Em cada ponto do meridiano, conectamos o dispositivo ao globo e ainda giramos o dispositivo em torno de seu eixo com um certo passo, por exemplo, 30 a 35 graus. </font><font style="vertical-align: inherit;">Acontece que, se voc√™ girar 12 vezes em torno de seu eixo, ser√£o obtidos 7 pontos no total de 84 medi√ß√µes. </font></font><br>
<br>
<img src="https://habrastorage.org/files/dfb/5df/1e5/dfb5df1e5107458e8560d939b6a5cd9a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A beleza do m√©todo √© que tudo pode ser feito "no joelho". </font><font style="vertical-align: inherit;">A precis√£o do posicionamento n√£o desempenha um papel especial, basta girar de acordo com o esquema para que o vetor de influ√™ncia externa no gr√°fico atraia uma bola. </font><font style="vertical-align: inherit;">O correto se parece com isso - veja a figura (o centro est√° marcado com uma marca).</font></font><br>
<br>
<img src="https://habrastorage.org/files/2d4/8e8/3a3/2d48e83a3c784bdb8736b86e4b3f6d87.gif"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como calcular o centro da bola?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta √© uma tarefa interessante e possui v√°rias solu√ß√µes. Pode parecer que, para procurar o centro, basta tomar a m√©dia aritm√©tica das coordenadas dos pontos obtidos. No entanto, n√£o √© assim - os pontos podem ser localizados de maneira desigual na bola (veja a Fig.). </font></font><br>
<br>
<img src="https://habrastorage.org/files/eda/0cd/9d2/eda0cd9d222e401ca3898d108182fbd8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A equa√ß√£o da apar√™ncia de esferas como a seguinte: (x - a) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + (Y - B) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + (z - C) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = R </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , em que X, Y, Z s√£o as coordenadas do ponto encontra-se sobre a bola. A, B, C s√£o as coordenadas do centro nos eixos x, ye z, respectivamente. R √© o raio da bola. Voc√™ pode criar um sistema de equa√ß√µes e tentar resolv√™-lo mais simplesmente usando algum m√©todo. Ou voc√™ pode simplesmente encontrar o centro (√© como um m√©todo de aproxima√ß√µes sucessivas). O significado do m√©todo √© simples: o valor do erro (X - A) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + (Y - B) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ (Z - C) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - R </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve tender para zero. Isso significa que a soma dessas quantidades para todos os pontos da esfera tamb√©m deve tender a zero. Sabendo disso, podemos escolher os valores A, B e C para os quais o erro para todos os pontos ser√° m√≠nimo. A √°rea de pesquisa √© limitada pelo tamanho da bola (cubo condicional). Ou seja, devemos colocar sequencialmente o centro da bola em todos os pontos do cubo e calcular o erro. Onde h√° um erro m√≠nimo - existe o centro. </font></font><br>
<br>
<img src="https://habrastorage.org/files/d53/d46/4d5/d53d464d57c0411790594a6df5a45ca1.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como R, precisamos levar o valor te√≥rico do vetor de influ√™ncia externa - para o aceler√¥metro, essa √© a acelera√ß√£o da gravidade, para a b√∫ssola - essa √© a magnitude m√©dia do campo magn√©tico da Terra, para o girosc√≥pio - a velocidade de rota√ß√£o da Terra. Obviamente, na f√≥rmula deve haver valores de uma dimens√£o (unidades convencionais do sensor ou m / s </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, graus / s, etc.). </font><font style="vertical-align: inherit;">√â mais conveniente converter em unidades arbitr√°rias do sensor correspondente.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como calcular um determinado valor nas unidades padr√£o do sensor?</font></font></b><div class="spoiler_text">   =  *   / (   ‚Äî   )<br>
:      16-      ¬±2g        ?: <br>
9,8 /<sup>2</sup> * 65536 / (2g + 2g) = 9,8 /<sup>2</sup> * 65536 / (2 * 9,8 /<sup>2</sup> + 2 * 9,8 /<sup>2</sup>) = 16384 . . .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, se voc√™ conhece exatamente o raio da bola, pode calcular o centro apenas pela sua ‚Äúcunha‚Äù. </font><font style="vertical-align: inherit;">Ou seja, em pontos localizados apenas em um peda√ßo da superf√≠cie da bola. </font><font style="vertical-align: inherit;">Mas este n√£o √© o nosso caso.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como acelerar a busca pelo centro da bola?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â necess√°rio procurar o centro n√£o no cubo inteiro (as dimens√µes da bola), mas ao longo da linha, cujo in√≠cio √© arbitr√°rio, cada ponto seguinte fica mais pr√≥ximo do centro real e o final est√° no centro. </font><font style="vertical-align: inherit;">Suponha que partimos do ponto (0; 0; 0) ... Sempre nos movemos com um passo constante. </font><font style="vertical-align: inherit;">Portanto, se imaginarmos um conjunto de cubos 3x3x3, em que cada face √© igual ao tamanho da etapa e tamb√©m imaginarmos que a posi√ß√£o atual √© o cubo do meio, teremos 9 + 8 + 9 op√ß√µes para colocar o pr√≥ximo ponto. </font><font style="vertical-align: inherit;">N√≥s apenas temos que estar em cada ponto, para calcular em qual dos 26 pontos vizinhos o erro ser√° menor. </font><font style="vertical-align: inherit;">Se o erro for menor no ponto atual e n√£o em um dos vizinhos, significa que ele est√° no centro e a pesquisa terminou.</font></font><br>
<br>
<img src="https://habrastorage.org/files/ba5/4dd/8d4/ba54dd8d423e4323a643cb4653361f1a.bmp"><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como pode estar no c√≥digo</font></font></b><div class="spoiler_text"><pre><code class="vbscript hljs"><span class="hljs-keyword">Public</span> <span class="hljs-keyword">Function</span> get_err(A As Double, B As Double, C As Double, R As Double) As Double<font></font>
<span class="hljs-keyword">Dim</span> x, y, z As Double<font></font>
<span class="hljs-keyword">Dim</span> sigma As Double<font></font>
<span class="hljs-keyword">Dim</span> row_n As Long<font></font>
get_err = <span class="hljs-number">0</span><font></font>
<span class="hljs-keyword">For</span> row_n = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">15</span><font></font>
    x = Application.ActiveWorkbook.ActiveSheet.Cells(row_n, <span class="hljs-number">1</span>).Value<font></font>
    y = Application.ActiveWorkbook.ActiveSheet.Cells(row_n, <span class="hljs-number">2</span>).Value<font></font>
    z = Application.ActiveWorkbook.ActiveSheet.Cells(row_n, <span class="hljs-number">3</span>).Value<font></font>
    get_err = get_err + <span class="hljs-built_in">abs</span>( (A - x) ^ <span class="hljs-number">2</span> + (B - y) ^ <span class="hljs-number">2</span> + (C - z) ^ <span class="hljs-number">2</span> - R ^ <span class="hljs-number">2</span> )<font></font>
<span class="hljs-keyword">Next</span><font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Function</span><font></font>
<font></font>
. . .<font></font>
A = <span class="hljs-number">0</span><font></font>
B = <span class="hljs-number">0</span><font></font>
C = <span class="hljs-number">0</span><font></font>
<font></font>
<span class="hljs-keyword">Do</span> <span class="hljs-keyword">While</span> <span class="hljs-literal">True</span><font></font>
   min_sigma = <span class="hljs-number">0</span><font></font>
    <span class="hljs-keyword">For</span> ai = <span class="hljs-number">-1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">1</span><font></font>
        <span class="hljs-keyword">For</span> bi = <span class="hljs-number">-1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">1</span><font></font>
            <span class="hljs-keyword">For</span> ci = <span class="hljs-number">-1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">1</span><font></font>
                sigma = get_err(A + ai, B + bi, C + ci, <span class="hljs-number">16384</span>)<font></font>
                <span class="hljs-keyword">If</span> sigma &lt; min_sigma <span class="hljs-keyword">Or</span> min_sigma = <span class="hljs-number">0</span> <span class="hljs-keyword">Then</span><font></font>
                    ai_min = ai<font></font>
                    bi_min = bi<font></font>
                    ci_min = ci<font></font>
                    min_sigma = sigma<font></font>
                <span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><font></font>
            <span class="hljs-keyword">Next</span><font></font>
        <span class="hljs-keyword">Next</span><font></font>
    <span class="hljs-keyword">Next</span><font></font>
    <font></font>
    <span class="hljs-keyword">If</span> ai_min = <span class="hljs-number">0</span> <span class="hljs-keyword">And</span> bi_min = <span class="hljs-number">0</span> <span class="hljs-keyword">And</span> ci_min = <span class="hljs-number">0</span> <span class="hljs-keyword">Then</span><font></font>
        <span class="hljs-keyword">Exit</span> <span class="hljs-keyword">Do</span><font></font>
    <span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><font></font>
    <font></font>
    A = A + ai_min<font></font>
    B = B + bi_min<font></font>
    C = C + ci_min<font></font>
<span class="hljs-keyword">Loop</span><font></font>
. . .<font></font>
</code></pre><br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De que outra forma acelerar a busca pelo centro da bola?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisa pesquisar com passo vari√°vel. </font><font style="vertical-align: inherit;">Primeiro, procuramos o centro em grandes etapas. </font><font style="vertical-align: inherit;">Encontramos o centro, reduzimos o passo e a partir dele come√ßamos a procurar mais. </font><font style="vertical-align: inherit;">E assim por diante, at√© obter o resultado da precis√£o necess√°ria.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como pode estar no c√≥digo</font></font></b><div class="spoiler_text"><pre><code class="vbscript hljs"><span class="hljs-keyword">Public</span> <span class="hljs-keyword">Function</span> get_err(A As Double, B As Double, C As Double, R As Double) As Double<font></font>
<span class="hljs-keyword">Dim</span> x, y, z As Double<font></font>
<span class="hljs-keyword">Dim</span> sigma As Double<font></font>
<span class="hljs-keyword">Dim</span> row_n As Long<font></font>
get_err = <span class="hljs-number">0</span><font></font>
<span class="hljs-keyword">For</span> row_n = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">15</span><font></font>
    x = Application.ActiveWorkbook.ActiveSheet.Cells(row_n, <span class="hljs-number">1</span>).Value<font></font>
    y = Application.ActiveWorkbook.ActiveSheet.Cells(row_n, <span class="hljs-number">2</span>).Value<font></font>
    z = Application.ActiveWorkbook.ActiveSheet.Cells(row_n, <span class="hljs-number">3</span>).Value<font></font>
    get_err = get_err + <span class="hljs-built_in">abs</span>( (A - x) ^ <span class="hljs-number">2</span> + (B - y) ^ <span class="hljs-number">2</span> + (C - z) ^ <span class="hljs-number">2</span> - R ^ <span class="hljs-number">2</span> )<font></font>
<span class="hljs-keyword">Next</span><font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Function</span><font></font>
. . .<font></font>
A = <span class="hljs-number">0</span><font></font>
B = <span class="hljs-number">0</span><font></font>
C = <span class="hljs-number">0</span><font></font>
<span class="hljs-keyword">step</span> = <span class="hljs-number">1000</span><font></font>
<span class="hljs-keyword">Do</span> <span class="hljs-keyword">While</span> <span class="hljs-literal">True</span><font></font>
   min_sigma = <span class="hljs-number">0</span><font></font>
    <span class="hljs-keyword">For</span> ai = <span class="hljs-number">-1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">1</span><font></font>
        <span class="hljs-keyword">For</span> bi = <span class="hljs-number">-1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">1</span><font></font>
            <span class="hljs-keyword">For</span> ci = <span class="hljs-number">-1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">1</span><font></font>
                sigma = get_err(A + ai * <span class="hljs-keyword">step</span>, B + bi * <span class="hljs-keyword">step</span>, C + ci * <span class="hljs-keyword">step</span>, <span class="hljs-number">16384</span>)<font></font>
                <span class="hljs-keyword">If</span> sigma &lt; min_sigma <span class="hljs-keyword">Or</span> min_sigma = <span class="hljs-number">0</span> <span class="hljs-keyword">Then</span><font></font>
                    ai_min = ai<font></font>
                    bi_min = bi<font></font>
                    ci_min = ci<font></font>
                    min_sigma = sigma<font></font>
                <span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><font></font>
            <span class="hljs-keyword">Next</span><font></font>
        <span class="hljs-keyword">Next</span><font></font>
    <span class="hljs-keyword">Next</span><font></font>
    <span class="hljs-keyword">If</span> ai_min = <span class="hljs-number">0</span> <span class="hljs-keyword">And</span> bi_min = <span class="hljs-number">0</span> <span class="hljs-keyword">And</span> ci_min = <span class="hljs-number">0</span> <span class="hljs-keyword">Then</span>        <font></font>
        <span class="hljs-keyword">step</span> = <span class="hljs-keyword">step</span> / <span class="hljs-number">10</span><font></font>
        <span class="hljs-keyword">If</span> <span class="hljs-keyword">step</span> &lt; <span class="hljs-number">0.01</span> <span class="hljs-keyword">Then</span><font></font>
            <span class="hljs-keyword">Exit</span> <span class="hljs-keyword">Do</span><font></font>
        <span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><font></font>
    <span class="hljs-keyword">Else</span><font></font>
    A = A + ai_min * <span class="hljs-keyword">step</span><font></font>
    B = B + bi_min * <span class="hljs-keyword">step</span><font></font>
    C = C + ci_min * <span class="hljs-keyword">step</span><font></font>
    <span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><font></font>
<span class="hljs-keyword">Loop</span><font></font>
. . .<font></font>
</code></pre><br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre erros de medi√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante as medi√ß√µes, pode haver situa√ß√µes em que, por algum motivo, o resultado da medi√ß√£o possa estar muito mais distante da superf√≠cie da bola. Ou pode haver muitos pontos. Ou, em geral, o resultado das medi√ß√µes pode n√£o ser uma bola, mas um "ovo" ou um "dirig√≠vel". Nesse caso, √© claro, voc√™ precisa repetir todas as medi√ß√µes, identificando as poss√≠veis causas de erros. Por exemplo, para um magnet√¥metro, ele pode ser um parafuso ou um prego em uma mesa e voc√™ est√° fazendo medi√ß√µes diretamente acima dele. E quanto mais baixo voc√™ abaixa o sensor ao longo do meridiano, mais forte o metal afetar√° o resultado. Portanto, √© necess√°rio determinar o limite do valor de erro permitido. Para n√£o refazer as medi√ß√µes devido a v√°rios pontos claramente errados, voc√™ pode aplicar um filtro. O princ√≠pio do filtro √© muito simples - depois de calcular o centro pela primeira vez, classifique os pontos pelo n√≠vel de erro em cada um deles.Alguns dos pontos com o maior erro podem ser simplesmente descartados (por exemplo, 10%). Ent√£o voc√™ precisa repetir a busca pelo centro.</font></font><br>
<img src="https://habrastorage.org/files/e22/c6f/b13/e22c6fb1385e4d678aabf7f1d879bc02.png"> <img src="https://habrastorage.org/files/569/40f/d17/56940fd17eef42cba93f590606bbe9e7.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo tem uma precis√£o muito boa. </font><font style="vertical-align: inherit;">O m√©todo permite que voc√™ fa√ßa com meios improvisados ‚Äã‚Äãsimples (bola, banco, etc.). </font><font style="vertical-align: inherit;">Funciona r√°pido o suficiente. </font><font style="vertical-align: inherit;">C√≥digo simples. </font><font style="vertical-align: inherit;">Muitos sensores possuem registros especiais nos quais voc√™ pode escrever o valor encontrado e o sensor subtrai-o rapidamente. </font><font style="vertical-align: inherit;">Esses registradores geralmente t√™m o prefixo "TRIM", como no MPU9260, ou "OFFSET", como no LSM303. </font><font style="vertical-align: inherit;">Mas o conhecido LIS302DL n√£o possui esses registros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o se esque√ßa de colocar um sinal de mais, se voc√™ gostou. </font><font style="vertical-align: inherit;">Escreva nos coment√°rios seus m√©todos para calibrar sensores.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt384075/">https://habr.com/ru/post/pt384075/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt384063/index.html">Como n√£o gastar alguns gigabytes de tr√°fego despercebidos, se voc√™ n√£o deseja atualizar para o Windows 10</a></li>
<li><a href="../pt384067/index.html">Mozilla adia prazo de assinatura de extens√£o do Firefox para 26 de janeiro</a></li>
<li><a href="../pt384069/index.html">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –ø–æ–º–æ–≥–∞—é—Ç –ª–∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –æ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ã–≥–æ—Ä–∞–Ω–∏—è?</a></li>
<li><a href="../pt384071/index.html">Sony Pictures —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∞ –ø–æ–∫—É–ø–∫—É BitTorrent –≤ 2006 –≥–æ–¥—É</a></li>
<li><a href="../pt384073/index.html">Oceano subterr√¢neo de Magma explica atividade vulc√¢nica em Io</a></li>
<li><a href="../pt384079/index.html">–®–∏—Ä–æ–∫–∞—è –ø–∞–Ω–æ—Ä–∞–º–∞ –≥–æ—Ä—ã –®–∞—Ä–ø–∞</a></li>
<li><a href="../pt384081/index.html">Fotos do espa√ßo para a semana (07/07/13/09)</a></li>
<li><a href="../pt384083/index.html">Guerra dos Mundos, de Stephen Hawking. Quais s√£o os alien√≠genas perigosos para os terr√°queos?</a></li>
<li><a href="../pt384085/index.html">SpaceX postou uma foto do interior da nave espacial Crew Dragon</a></li>
<li><a href="../pt384087/index.html">Carro Tesla Model S P85D quebra sistema de classifica√ß√£o de relat√≥rios de consumidores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>