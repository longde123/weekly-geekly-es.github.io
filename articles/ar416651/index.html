<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ––ğŸ½ ğŸ‘ ğŸ‘¸ğŸ¿ 1M HTTP rps Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±ÙƒØ²ÙŠØ© ÙˆØ§Ø­Ø¯Ø©. DPDK Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† nginx + linux kernel TCP / IP ğŸ‘³ â¬›ï¸ ğŸ«</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ø£Ø±ÙŠØ¯ Ø£Ù† Ø£ØªØ­Ø¯Ø« Ø¹Ù† Ø´ÙŠØ¡ Ù…Ø«Ù„ DPDK - Ù‡Ø°Ø§ Ø¥Ø·Ø§Ø± Ø¹Ù…Ù„ Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø´Ø¨ÙƒØ© ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†ÙˆØ§Ø©. Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† userland \ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>1M HTTP rps Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±ÙƒØ²ÙŠØ© ÙˆØ§Ø­Ø¯Ø©. DPDK Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† nginx + linux kernel TCP / IP</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416651/" style=";text-align:right;direction:rtl">  Ø£Ø±ÙŠØ¯ Ø£Ù† Ø£ØªØ­Ø¯Ø« Ø¹Ù† Ø´ÙŠØ¡ Ù…Ø«Ù„ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">DPDK</a> - Ù‡Ø°Ø§ Ø¥Ø·Ø§Ø± Ø¹Ù…Ù„ Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø´Ø¨ÙƒØ© ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†ÙˆØ§Ø©.  Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„  ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† userland \ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø¨ÙƒØ© ØŒ Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø£ÙŠ Ù…ÙƒØ§Ù„Ù…Ø§Øª Ù†Ø¸Ø§Ù….  Ù‡Ø°Ø§ ÙŠÙˆÙØ± Ø¹Ù„ÙŠÙƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù†ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ù…Ø²ÙŠØ¯.  ÙƒÙ…Ø«Ø§Ù„ ØŒ Ø³Ø£ÙƒØªØ¨ ØªØ·Ø¨ÙŠÙ‚Ù‹Ø§ ÙŠØ¹Ø·ÙŠ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø¨Ø± http ÙˆÙŠÙ‚Ø§Ø±Ù† Ø³Ø±Ø¹ØªÙ‡ Ø¨Ù€ nginx. <br><a name="habracut"></a><br>  ÙŠÙ…ÙƒÙ† ØªÙ†Ø²ÙŠÙ„ DPDK <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ù‡Ù†Ø§</a> .  Ù„Ø§ ØªØ£Ø®Ø° Stable - Ù„Ù… ÙŠØ¹Ù…Ù„ Ù…Ø¹ÙŠ Ø¹Ù„Ù‰ EC2 ØŒ Ø®Ø° 18.05 - ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø¯Ø£ Ø¨Ù‡.  Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø­Ø¬Ø² <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">hugepages</a> ÙÙŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø§Ù„Ù†Ø¸Ø§Ù…</a> Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ù„Ø¥Ø·Ø§Ø±.  Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ù…Ø¨Ø¯Ø£ ØŒ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ© Ù…Ø¹ Ø®ÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† ØµÙØ­Ø§Øª hugepages ØŒ Ù„ÙƒÙ†Ù†ÙŠ Ù‚Ù…Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¨ØªØ¶Ù…ÙŠÙ†Ù‡Ø§.  * Ù„Ø§ ØªÙ†Ø³ ØªØ­Ø¯ÙŠØ« grub Ø¨Ø¹Ø¯ grub-mkconfig * Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ØµÙØ­Ø§Øª hugepages ØŒ Ø§Ù†ØªÙ‚Ù„ ÙÙˆØ±Ù‹Ø§ Ø¥Ù„Ù‰ ./usertools/dpdk-setup.py - Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠØ¡ Ø³ÙŠØ¬Ù…Ø¹ ÙˆÙŠÙ‡ÙŠØ¦ ÙƒÙ„ Ø´ÙŠØ¡ Ø¢Ø®Ø±.  ÙÙŠ Google ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ…Ø§Øª ØªÙˆØµÙŠ Ø¨Ø¬Ù…Ø¹ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø´ÙŠØ¡ Ù„ØªØ¬Ø§ÙˆØ² dpdk-setup.py - Ù„Ø§ ØªÙØ¹Ù„ Ø°Ù„Ùƒ.  Ø­Ø³Ù†Ù‹Ø§ ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„ Ø°Ù„Ùƒ Ù…Ø¹ÙŠ ÙÙ‚Ø· ØŒ Ø¨ÙŠÙ†Ù…Ø§ Ù„Ù… Ø£Ø³ØªØ®Ø¯Ù… dpdk-setup.py ØŒ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø´ÙŠØ¡.  Ø¨Ø§Ø®ØªØµØ§Ø± ØŒ ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¯Ø§Ø®Ù„ dpdk-setup.py: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Ø¨Ù†Ø§Ø¡ Ù„ÙŠÙ†ÙƒØ³ x86_x64 </li><li style=";text-align:right;direction:rtl">  ØªØ­Ù…ÙŠÙ„ igb uio kernel module </li><li style=";text-align:right;direction:rtl">  Ø®Ø±ÙŠØ·Ø© hugepages Ø¥Ù„Ù‰ / mnt / Ø¶Ø®Ù…Ø© </li><li style=";text-align:right;direction:rtl">  Ø±Ø¨Ø· nic Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ uio (Ù„Ø§ ØªÙ†Ø³ Ø£Ù† ØªÙØ¹Ù„ ifconfig ethX down Ù‚Ø¨Ù„) </li></ul><br>  Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«Ø§Ù„ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù…Ø± ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡.  Ù…Ù† Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ ÙÙ‚Ø· Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© RTE_SDK Ø§Ù„Ø°ÙŠ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ø¯Ù„ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… DPDK. <br><br>  <a href="">Ù‡Ù†Ø§</a> ÙŠÙƒÙ…Ù† Ø±Ù…Ø² Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„ÙƒØ§Ù…Ù„.  ÙˆÙ‡Ùˆ ÙŠØªØ£Ù„Ù Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ØŒ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¨Ø¯Ø§Ø¦ÙŠØ© Ù…Ù† TCP / IP ÙˆÙ…Ø­Ù„Ù„ http Ø§Ù„Ø¨Ø¯Ø§Ø¦ÙŠ.  Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªÙ‡ÙŠØ¦Ø©. <br><br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">** argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret; <span class="hljs-comment"><span class="hljs-comment">//  dpdk ret = rte_eal_init(argc, argv); if (ret &lt; 0) { rte_panic("Cannot init EAL\n"); } //  memory pool g_packet_mbuf_pool = rte_pktmbuf_pool_create("mbuf_pool", 131071, 32, 0, RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id()); if (g_packet_mbuf_pool == NULL) { rte_exit(EXIT_FAILURE, "Cannot init mbuf pool\n"); } g_tcp_state_pool = rte_mempool_create("tcp_state_pool", 65535, sizeof(struct tcp_state), 0, 0, NULL, NULL, NULL, NULL, rte_socket_id(), 0); if (g_tcp_state_pool == NULL) { rte_exit(EXIT_FAILURE, "Cannot init tcp_state pool\n"); } //  hash table struct rte_hash_parameters hash_params = { .entries = 64536, .key_len = sizeof(struct tcp_key), .socket_id = rte_socket_id(), .hash_func_init_val = 0, .name = "tcp clients table" }; g_clients = rte_hash_create(&amp;hash_params); if (g_clients == NULL) { rte_exit(EXIT_FAILURE, "No hash table created\n"); } //    1     uint8_t nb_ports = rte_eth_dev_count(); if (nb_ports == 0) { rte_exit(EXIT_FAILURE, "No Ethernet ports - bye\n"); } if (nb_ports &gt; 1) { rte_exit(EXIT_FAILURE, "Not implemented. Too much ports\n"); } //     struct rte_eth_conf port_conf = { .rxmode = { .split_hdr_size = 0, .header_split = 0, /**&lt; Header Split disabled */ .hw_ip_checksum = 0, /**&lt; IP checksum offload disabled */ .hw_vlan_filter = 0, /**&lt; VLAN filtering disabled */ .jumbo_frame = 0, /**&lt; Jumbo Frame Support disabled */ .hw_strip_crc = 0, /**&lt; CRC stripped by hardware */ }, .txmode = { .mq_mode = ETH_MQ_TX_NONE, }, }; //          port_conf.txmode.offloads |= DEV_TX_OFFLOAD_IPV4_CKSUM; port_conf.txmode.offloads |= DEV_TX_OFFLOAD_TCP_CKSUM; ret = rte_eth_dev_configure(0, RX_QUEUE_COUNT, TX_QUEUE_COUNT, &amp;port_conf); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "Cannot configure device: err=%d\n", ret); } //     for (uint16_t j=0; j&lt;RX_QUEUE_COUNT; ++j) { ret = rte_eth_rx_queue_setup(0, j, 1024, rte_eth_dev_socket_id(0), NULL, g_packet_mbuf_pool); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_rx_queue_setup:err=%d\n", ret); } } //    struct rte_eth_txconf txconf = { .offloads = port_conf.txmode.offloads, }; for (uint16_t j=0; j&lt;TX_QUEUE_COUNT; ++j) { ret = rte_eth_tx_queue_setup(0, j, 1024, rte_eth_dev_socket_id(0), &amp;txconf); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_tx_queue_setup:err=%d\n", ret); } } // NIC ret = rte_eth_dev_start(0); if (ret &lt; 0) { rte_exit(EXIT_FAILURE, "rte_eth_dev_start:err=%d\n", ret); } //   lcore_hello(NULL); return 0; }</span></span></code> </pre> <br>  ÙÙŠ ØªÙ„Ùƒ Ø§Ù„Ù„Ø­Ø¸Ø© ØŒ Ø¹Ù†Ø¯Ù…Ø§ Ù†Ù‚ÙˆÙ… Ù…Ù† Ø®Ù„Ø§Ù„ dpdk-setup.py Ø¨Ø±Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ´ØºÙŠÙ„ dpdk ØŒ ÙŠØªÙˆÙ‚Ù ÙˆØµÙˆÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø¨ÙƒØ© Ù‡Ø°Ù‡ Ø¥Ù„Ù‰ kernel.  Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ ØŒ Ø³ØªØ³Ø¬Ù„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø¨ÙƒØ© Ø£ÙŠ Ø­Ø²Ù… ØªØµÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ù† Ø®Ù„Ø§Ù„ DMA ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙŠ Ù‚Ø¯Ù…Ù†Ø§Ù‡Ø§ Ù„Ù‡Ø§. <br><br>  ÙˆÙ‡Ù†Ø§ Ø­Ù„Ù‚Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø²Ù…. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rte_mbuf</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packets</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAX_PACKETS</span></span></span><span class="hljs-class">];</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> rx_current_queue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//  unsigned packet_count = rte_eth_rx_burst(0, (++rx_current_queue) % RX_QUEUE_COUNT, packets, MAX_PACKETS); for (unsigned j=0; j&lt;packet_count; ++j) { struct rte_mbuf* m = packets[j]; //   ethernet  struct ether_hdr* eth_header = rte_pktmbuf_mtod(m, struct ether_hdr*); //  IP  if (RTE_ETH_IS_IPV4_HDR(m-&gt;packet_type)) { do { //   if (rte_pktmbuf_data_len(m) &lt; sizeof(struct ether_hdr) + sizeof(struct ipv4_hdr) + sizeof(struct tcp_hdr)) { TRACE; break; } struct ipv4_hdr* ip_header = (struct ipv4_hdr*)((char*)eth_header + sizeof(struct ether_hdr)); if ((ip_header-&gt;next_proto_id != 0x6) || (ip_header-&gt;version_ihl != 0x45)) { TRACE; break; } if (ip_header-&gt;dst_addr != MY_IP_ADDRESS) { TRACE; break; } if (rte_pktmbuf_data_len(m) &lt; htons(ip_header-&gt;total_length) + sizeof(struct ether_hdr)) { TRACE; break; } if (htons(ip_header-&gt;total_length) &lt; sizeof(struct ipv4_hdr) + sizeof(struct tcp_hdr)) { TRACE; break; } struct tcp_hdr* tcp_header = (struct tcp_hdr*)((char*)ip_header + sizeof(struct ipv4_hdr)); size_t tcp_header_size = (tcp_header-&gt;data_off &gt;&gt; 4) * 4; if (rte_pktmbuf_data_len(m) &lt; sizeof(struct ether_hdr) + sizeof(struct ipv4_hdr) + tcp_header_size) { TRACE; break; } if (tcp_header-&gt;dst_port != 0x5000) { TRACE; break; } size_t data_size = htons(ip_header-&gt;total_length) - sizeof(struct ipv4_hdr) - tcp_header_size; void* data = (char*)tcp_header + tcp_header_size; //     hash table struct tcp_key key = { .ip = ip_header-&gt;src_addr, .port = tcp_header-&gt;src_port }; //    tcp process_tcp(m, tcp_header, &amp;key, data, data_size); } while(0); } else if (eth_header-&gt;ether_type == 0x0608) // ARP { //     -       ARP- do { if (rte_pktmbuf_data_len(m) &lt; sizeof(struct arp) + sizeof(struct ether_hdr)) { TRACE; break; } struct arp* arp_packet = (struct arp*)((char*)eth_header + sizeof(struct ether_hdr)); if (arp_packet-&gt;opcode != 0x100) { TRACE; break; } if (arp_packet-&gt;dst_pr_add != MY_IP_ADDRESS) { TRACE; break; } send_arp_response(arp_packet); } while(0); } else { TRACE; } rte_pktmbuf_free(m); } }</span></span></code> </pre> <br>  ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© rte_eth_rx_burst Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø²Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø´ÙŠØ¡ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ØŒ ÙØ³ØªÙ‚Ø±Ø£ Ø§Ù„Ø­Ø²Ù… ÙˆØªØ¶Ø¹Ù‡Ø§ ÙÙŠ Ù…ØµÙÙˆÙØ©.  Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ø´ÙŠØ¡ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ØŒ ÙØ³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ 0 ØŒ ÙˆÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.  Ù†Ø¹Ù… ØŒ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù‡Ø¬ "ÙŠÙ‚Ø¶ÙŠ" ÙˆÙ‚Øª ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© ÙÙŠ Ù„Ø§ Ø´ÙŠØ¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ø§Ù„ÙŠÙ‹Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ© ØŒ ÙˆÙ„ÙƒÙ† Ø¥Ø°Ø§ Ø£Ø®Ø°Ù†Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ dpdk ØŒ ÙÙ…Ù† Ø§Ù„Ù…ÙØªØ±Ø¶ Ø£Ù† Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø­Ø§Ù„ØªÙ†Ø§.  * Ù‡Ø§Ù… ØŒ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø§Ù„ÙˆØ¸ÙŠÙØ© ØºÙŠØ± Ø¢Ù…Ù†Ø© Ù„Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ±Ø§Ø¨Ø·</a> ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù†ÙØ³Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© * Ø¨Ø¹Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø²Ù…Ø© ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ rte_pktmbuf_free.  Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­Ø²Ù…Ø© ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© rte_eth_tx_burst ØŒ Ø§Ù„ØªÙŠ ØªØ¶Ø¹ rte_mbuf Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† rte_pktmbuf_alloc ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø¨ÙƒØ©. <br><br>  Ø¨Ø¹Ø¯ ØªÙÙƒÙŠÙƒ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø­Ø²Ù…Ø© ØŒ Ø³ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© tcp.  Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ tcp Ù…Ù„ÙŠØ¡ Ø¨Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ© ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ø®Ø§ØµØ© ÙˆÙ…Ø®Ø§Ø·Ø± Ø§Ù„Ø­Ø±Ù…Ø§Ù† Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©.  ÙŠØ¹Ø¯ ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ tcp Ø£ÙƒØ«Ø± Ø£Ùˆ Ø£Ù‚Ù„ Ø§ÙƒØªÙ…Ø§Ù„Ù‹Ø§ ØªØ¯Ø±ÙŠØ¨Ù‹Ø§ Ù…Ù…ØªØ§Ø²Ù‹Ø§ Ù„Ù…Ø·ÙˆØ± Ù…ØªÙ…Ø±Ø³ ØŒ ÙˆÙ„ÙƒÙ† Ù…Ø¹ Ø°Ù„Ùƒ ØŒ Ù„Ø§ ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ†Ù‡ ÙÙŠ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ÙˆØµÙˆÙ Ù‡Ù†Ø§.  ÙÙŠ Ø§Ù„Ù…Ø«Ø§Ù„ ØŒ ÙŠØªÙ… ØªÙ†ÙÙŠØ° tcp ÙÙ‚Ø· Ø¨Ù…Ø§ ÙŠÙƒÙÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±.  ØªÙ… ØªÙ†ÙÙŠØ° Ø¬Ø¯ÙˆÙ„ Ø¬Ù„Ø³Ø© Ø§Ø³ØªÙ†Ø§Ø¯Ù‹Ø§ Ø¥Ù„Ù‰ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ù…ÙØ²ÙˆØ¯ Ø¨Ù€ dpdk</a> ØŒ ÙˆØ¶Ø¨Ø· ÙˆÙƒØ³Ø± Ø§ØªØµØ§Ù„ tcp ØŒ ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙˆÙ† Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø®Ø³Ø§Ø¦Ø± ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø²Ù….  ÙŠØ­ØªÙˆÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ¬Ø²Ø¦Ø© Ù…Ù† dpdk Ø¹Ù„Ù‰ Ù‚ÙŠÙˆØ¯ Ù…Ù‡Ù…Ø© ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ ÙˆÙ„ÙƒÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ù„Ù‰ Ø³Ù„Ø§Ø³Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù…ØªØ¹Ø¯Ø¯Ø©.  Ø§Ù„Ù…Ø«Ø§Ù„ Ù…ØµÙ†ÙˆØ¹ Ø¨Ø³Ù„Ø§Ø³Ù„ ÙˆØ§Ø­Ø¯Ø© ØŒ ÙˆÙ‡Ø°Ù‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù„ÙŠØ³Øª Ù…Ù‡Ù…Ø© Ù‡Ù†Ø§ ØŒ ÙˆÙÙŠ Ø­Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¯Ø© Ù†ÙˆÙ‰ ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… RSS ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¬Ø¯ÙˆÙ„ ØªØ¬Ø²Ø¦Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„Ùƒ Ø¯ÙˆÙ† Ø­Ø¸Ø±. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø§Ù„ÙÙ†ÙŠ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">tatic </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_tcp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct rte_mbuf* m, struct tcp_hdr* tcp_header, struct tcp_key* key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data_size)</span></span></span><span class="hljs-function"> </span></span>{ TRACE; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_state</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rte_hash_lookup_data(g_clients, key, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)&amp;state) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//Documentaion lies!!! { TRACE; if ((tcp_header-&gt;tcp_flags &amp; 0x2) != 0) // SYN { TRACE; struct ether_hdr* eth_header = rte_pktmbuf_mtod(m, struct ether_hdr*); if (rte_mempool_get(g_tcp_state_pool, (void**)&amp;state) &lt; 0) { ERROR("tcp state alloc fail"); return; } memcpy(&amp;state-&gt;tcp_template, &amp;g_tcp_packet_template, sizeof(g_tcp_packet_template)); memcpy(&amp;state-&gt;tcp_template.eth.d_addr, &amp;eth_header-&gt;s_addr, 6); state-&gt;tcp_template.ip.dst_addr = key-&gt;ip; state-&gt;tcp_template.tcp.dst_port = key-&gt;port; state-&gt;remote_seq = htonl(tcp_header-&gt;sent_seq); #pragma GCC diagnostic push #pragma GCC diagnostic ignored "-Wpointer-to-int-cast" state-&gt;my_seq_start = (uint32_t)state; // not very secure. #pragma GCC diagnostic pop state-&gt;fin_sent = 0; state-&gt;http.state = HTTP_START; state-&gt;http.request_url_size = 0; //not thread safe! only one core used if (rte_hash_add_key_data(g_clients, key, state) == 0) { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 12, &amp;new_tcp_header); if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_start); state-&gt;my_seq_sent = state-&gt;my_seq_start+1; ++state-&gt;remote_seq; new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); new_tcp_header-&gt;tcp_flags = 0x12; // mss = 1380, no window scaling uint8_t options[12] = {0x02, 0x04, 0x05, 0x64, 0x03, 0x03, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01}; memcpy((uint8_t*)new_tcp_header + sizeof(struct tcp_hdr), options, 12); new_tcp_header-&gt;data_off = 0x80; send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp synack"); } } else { ERROR("can't add connection to table"); rte_mempool_put(g_tcp_state_pool, state); } } else { ERROR("lost connection"); } return; } if ((tcp_header-&gt;tcp_flags &amp; 0x2) != 0) // SYN retransmit { //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); return process_tcp(m, tcp_header, key, data, data_size); } } if ((tcp_header-&gt;tcp_flags &amp; 0x10) != 0) // ACK { TRACE; uint32_t ack_delta = htonl(tcp_header-&gt;recv_ack) - state-&gt;my_seq_start; uint32_t my_max_ack_delta = state-&gt;my_seq_sent - state-&gt;my_seq_start; if (ack_delta == 0) { if ((data_size == 0) &amp;&amp; (tcp_header-&gt;tcp_flags == 0x10)) { ERROR("need to retransmit. not supported"); } } else if (ack_delta &lt;= my_max_ack_delta) { state-&gt;my_seq_start += ack_delta; } else { ERROR("ack on unsent seq"); } } if (data_size &gt; 0) { TRACE; uint32_t packet_seq = htonl(tcp_header-&gt;sent_seq); if (state-&gt;remote_seq == packet_seq) { feed_http(data, data_size, state); state-&gt;remote_seq += data_size; } else if (state-&gt;remote_seq-1 == packet_seq) // keepalive { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 0, &amp;new_tcp_header); if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp ack keepalive"); } } else { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, state-&gt;http.last_message_size, &amp;new_tcp_header); TRACE; if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent - state-&gt;http.last_message_size); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq); memcpy((char*)new_tcp_header+sizeof(struct tcp_hdr), &amp;state-&gt;http.last_message, state-&gt;http.last_message_size); send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp fin ack"); } //ERROR("my bad tcp stack implementation((("); } } if ((tcp_header-&gt;tcp_flags &amp; 0x04) != 0) // RST { TRACE; //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); } } else if ((tcp_header-&gt;tcp_flags &amp; 0x01) != 0) // FIN { struct tcp_hdr* new_tcp_header; struct rte_mbuf* packet = build_packet(state, 0, &amp;new_tcp_header); TRACE; if (packet != NULL) { new_tcp_header-&gt;rx_win = TX_WINDOW_SIZE; new_tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); new_tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq + 1); if (!state-&gt;fin_sent) { TRACE; new_tcp_header-&gt;tcp_flags = 0x11; // !@#$ the last ack } send_packet(new_tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp fin ack"); } //not thread safe! only one core used if (rte_hash_del_key(g_clients, key) &lt; 0) { ERROR("can't delete key"); } else { rte_mempool_put(g_tcp_state_pool, state); } } }</span></span></code> </pre> <br></div></div><br>  Ù„Ù† ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø­Ù„Ù„ http ÙÙ‚Ø· GET Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù†Ø§ÙˆÙŠÙ† URL Ù…Ù† Ù‡Ù†Ø§Ùƒ ÙˆØ¥Ø±Ø¬Ø§Ø¹ html Ù…Ø¹ Ø¹Ù†ÙˆØ§Ù† URL Ø§Ù„Ù…Ø·Ù„ÙˆØ¨. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Ù…Ø­Ù„Ù„ HTTP</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feed_http</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data_size, struct tcp_state* state)</span></span></span><span class="hljs-function"> </span></span>{ TRACE; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> remaining_data = data_size; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* current = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)data; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http_state</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (http-&gt;state == HTTP_BAD_STATE) { TRACE; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (remaining_data &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(http-&gt;state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_START: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'G'</span></span>) { http-&gt;state = HTTP_READ_G; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_G: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'E'</span></span>) { http-&gt;state = HTTP_READ_E; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_E: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'T'</span></span>) { http-&gt;state = HTTP_READ_T; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_T: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">' '</span></span>) { http-&gt;state = HTTP_READ_SPACE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_BAD_STATE; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_SPACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current != <span class="hljs-string"><span class="hljs-string">' '</span></span>) { http-&gt;request_url[http-&gt;request_url_size] = *current; ++http-&gt;request_url_size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (http-&gt;request_url_size &gt; MAX_URL_SIZE) { http-&gt;state = HTTP_BAD_STATE; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; http-&gt;request_url[http-&gt;request_url_size] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_URL: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R1; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_R1: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { http-&gt;state = HTTP_READ_N1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_N1: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) { http-&gt;state = HTTP_READ_R2; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { http-&gt;state = HTTP_READ_URL; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_READ_R2: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*current == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { TRACE; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> content_length[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(content_length, <span class="hljs-string"><span class="hljs-string">"%lu"</span></span>, g_http_part2_size - <span class="hljs-number"><span class="hljs-number">4</span></span> + http-&gt;request_url_size + g_http_part3_size); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> content_length_size = <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(content_length); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> total_data_size = g_http_part1_size + g_http_part2_size + g_http_part3_size + http-&gt;request_url_size + content_length_size; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_hdr</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_header</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rte_mbuf</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build_packet</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">total_data_size</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcp_header</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (packet != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { tcp_header-&gt;rx_win = TX_WINDOW_SIZE; tcp_header-&gt;sent_seq = htonl(state-&gt;my_seq_sent); tcp_header-&gt;recv_ack = htonl(state-&gt;remote_seq + data_size); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> KEEPALIVE state-&gt;my_seq_sent += total_data_size; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> state-&gt;my_seq_sent += total_data_size + 1; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//+1 for FIN tcp_header-&gt;tcp_flags = 0x11; state-&gt;fin_sent = 1; #endif char* new_data = (char*)tcp_header + sizeof(struct tcp_hdr); memcpy(new_data, g_http_part1, g_http_part1_size); new_data += g_http_part1_size; memcpy(new_data, content_length, content_length_size); new_data += content_length_size; memcpy(new_data, g_http_part2, g_http_part2_size); new_data += g_http_part2_size; memcpy(new_data, http-&gt;request_url, http-&gt;request_url_size); new_data += http-&gt;request_url_size; memcpy(new_data, g_http_part3, g_http_part3_size); memcpy(&amp;http-&gt;last_message, (char*)tcp_header+sizeof(struct tcp_hdr), total_data_size); http-&gt;last_message_size = total_data_size; send_packet(tcp_header, packet); } else { ERROR("rte_pktmbuf_alloc, tcp data"); } http-&gt;state = HTTP_START; http-&gt;request_url_size = 0; } else if (*current == '\r') { http-&gt;state = HTTP_READ_R1; } else { http-&gt;state = HTTP_READ_URL; } break; } default: { ERROR("bad http state"); return; } } if (http-&gt;state == HTTP_BAD_STATE) { return; } --remaining_data; ++current; } }</span></span></span></span></code> </pre> <br></div></div><br>  Ø¨Ø¹Ø¯ Ø£Ù† ÙŠØµØ¨Ø­ Ø§Ù„Ù…Ø«Ø§Ù„ Ø¬Ø§Ù‡Ø²Ù‹Ø§ ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ù€ nginx.  Ù„Ø£Ù†  Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø­Ø§Ù…Ù„ Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Ø§Ù„Ù…Ù†Ø²Ù„ ØŒ Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø£Ù…Ø§Ø²ÙˆÙ† EC2.  Ù‚Ø§Ù…Øª EC2 Ø¨ØªØµØ­ÙŠØ­Ø§ØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø§Ø¶Ø·Ø±Ø±Øª Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ù„ÙŠ Ø¹Ù† Connection: Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØŒ Ù„Ø£Ù†  ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ø§ Ø¨Ø³Ø±Ø¹Ø© 300 ÙƒÙŠÙ„Ùˆ Ø¨Øª ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØŒ Ø¨Ø¯Ø£Øª Ø­Ø²Ù… SYN ØªÙ†Ø®ÙØ¶ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.  Ø¹Ù„Ù‰ Ù…Ø§ ÙŠØ¨Ø¯Ùˆ ØŒ Ù‡Ù†Ø§Ùƒ Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª SYN ØŒ Ù„Ø°Ù„Ùƒ ØªÙ… Ø¬Ø¹Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù„Ù‰ Ù‚ÙŠØ¯ Ø§Ù„Ø­ÙŠØ§Ø©.  Ø¹Ù„Ù‰ EC2 ØŒ Ù„Ø§ ÙŠØ¹Ù…Ù„ dpdk Ø¹Ù„Ù‰ ÙƒØ§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø§Øª ØŒ Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ m1.medium Ù„Ù… ÙŠØ¹Ù…Ù„.  Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù…Ù„ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø­Ø¬Ù… r4.8x ØªÙƒØ¨ÙŠØ± Ù…Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆÙ…Ø«Ø§Ù„ÙŠÙ† Ø­Ø¬Ù… r4.8x ØªÙƒØ¨ÙŠØ± Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù…ÙŠÙ„.  ÙŠØªÙˆØ§ØµÙ„ÙˆÙ† Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø§Øª Ø´Ø¨ÙƒØ© Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ Ù…Ù† Ø®Ù„Ø§Ù„ Ø´Ø¨ÙƒØ© VPC ÙØ±Ø¹ÙŠØ© Ø®Ø§ØµØ©.  Ø­Ø§ÙˆÙ„Øª ØªØ­Ù…ÙŠÙ„ Ø£Ø¯ÙˆØ§Øª Ù…Ø®ØªÙ„ÙØ©: ab ØŒ wrk ØŒ h2load ØŒ Ø§Ù„Ø­ØµØ§Ø±.  Ø§Ù„Ø£ÙƒØ«Ø± Ø±Ø§Ø­Ø© ÙƒØ§Ù† wrk ØŒ Ù„Ø£Ù†Ù‡  ab Ù‡Ùˆ Ù…Ø¤Ø´Ø± ØªØ±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯ ÙˆÙŠÙ†ØªØ¬ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø´ÙˆÙ‡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©. <br><br>  Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ EC2 ØŒ ÙŠÙ…ÙƒÙ† Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ø¯Ø¯ Ù…Ø¹ÙŠÙ† Ù…Ù† Ø§Ù„Ù‚Ø·Ø±Ø§Øª ØŒ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ØŒ Ø³ÙŠÙƒÙˆÙ† Ù‡Ø°Ø§ ØºÙŠØ± Ù…Ø±Ø¦ÙŠ ØŒ ÙˆÙ„ÙƒÙ† ÙÙŠ Ø­Ø§Ù„Ø© ab ØŒ ÙØ¥Ù† Ø£ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ ØªØ³ØªÙ‡Ù„Ùƒ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒÙ„ÙŠ Ùˆ ab ØŒ ÙˆÙ†ØªÙŠØ¬Ø© Ù„Ø°Ù„Ùƒ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙˆÙ„ Ù…ØªÙˆØ³Ø· â€‹â€‹Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©.  Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù‚Ø·Ø±Ø§Øª Ù‡ÙŠ Ù„ØºØ² Ù…Ù†ÙØµÙ„ ÙŠØ¬Ø¨ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ØŒ ÙˆÙ…Ø¹ Ø°Ù„Ùƒ ØŒ Ø­Ù‚ÙŠÙ‚Ø© Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§ÙƒÙ„ Ù„ÙŠØ³ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… dpdk ØŒ ÙˆÙ„ÙƒÙ† Ø£ÙŠØ¶Ù‹Ø§ Ù…Ø¹ nginx ØŒ ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø£Ù† Ù‡Ø°Ø§ Ù„Ø§ ÙŠØ¨Ø¯Ùˆ Ù…Ø«Ø§Ù„Ù‹Ø§ Ù„Ø´ÙŠØ¡ Ø®Ø§Ø·Ø¦. <br><br>  Ù„Ù‚Ø¯ Ø£Ø¬Ø±ÙŠØª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Ù…Ø±Ø­Ù„ØªÙŠÙ† ØŒ Ø±ÙƒØ¶Øª Ø£ÙˆÙ„Ø§Ù‹ Ø­Ø·Ø§Ù…Ù‹Ø§ Ø¹Ù„Ù‰ Ù…Ø«ÙŠÙ„ ÙˆØ§Ø­Ø¯ ØŒ Ø«Ù… ÙÙŠ 2.  Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù† Ø­Ø§Ù„ØªÙŠÙ† Ù‡Ùˆ 1 ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù†Ù†ÙŠ Ù„Ù… Ø£ÙˆØ§Ø¬Ù‡ Ø£Ø¯Ø§Ø¡ wrk Ù†ÙØ³Ù‡. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø«Ø§Ù„ dpdk Ø¹Ù„Ù‰ r4.8xlarge</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  Ø¥Ø·Ù„Ø§Ù‚ wrk c 1 Ù…Ø«ÙŠÙ„ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 32.19ms 63.43ms 817.26ms 85.01% <br> Req/Sec 15.97k 4.04k 113.97k 93.47% <br> Latency Distribution <br> 50% 2.58ms <br> 75% 17.57ms <br> 90% 134.94ms <br> 99% 206.03ms <br> 10278064 requests in 10.10s, 1.70GB read <br> Socket errors: connect 0, read 17, write 0, timeout 0 <br> Requests/sec: 1017645.11 <br> Transfer/sec: 172.75MB</code> <br>  ØªØ´ØºÙŠÙ„ wrk Ù…Ù† Ø­Ø§Ù„ØªÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª <br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 67.28ms 119.20ms 1.64s 88.90% <br> Req/Sec 7.99k 4.58k 132.62k 96.67% <br> Latency Distribution <br> 50% 2.31ms <br> 75% 103.45ms <br> 90% 191.51ms <br> 99% 563.56ms <br> 5160076 requests in 10.10s, 0.86GB read <br> Socket errors: connect 0, read 2364, write 0, timeout 1 <br> Requests/sec: 510894.92 <br> Transfer/sec: 86.73MB <br> <br> root@ip-172-30-0-225:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 74.87ms 148.64ms 1.64s 93.45% <br> Req/Sec 8.22k 2.59k 42.51k 81.21% <br> Latency Distribution <br> 50% 2.41ms <br> 75% 110.42ms <br> 90% 190.66ms <br> 99% 739.67ms <br> 5298083 requests in 10.10s, 0.88GB read <br> Socket errors: connect 0, read 0, write 0, timeout 148 <br> Requests/sec: 524543.67 <br> Transfer/sec: 89.04MB</code> <br> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Ø£Ø¹Ø·Øª Nginx Ù…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  Ø¥Ø·Ù„Ø§Ù‚ wrk c 1 Ù…Ø«ÙŠÙ„ <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 14.36ms 56.41ms 1.92s 95.26% <br> Req/Sec 15.27k 3.30k 72.23k 83.53% <br> Latency Distribution <br> 50% 3.38ms <br> 75% 6.82ms <br> 90% 10.95ms <br> 99% 234.99ms <br> 9813464 requests in 10.10s, 2.12GB read <br> Socket errors: connect 0, read 1, write 0, timeout 3 <br> Requests/sec: 971665.79 <br> Transfer/sec: 214.94MB</code> <br> <br>  ØªØ´ØºÙŠÙ„ wrk Ù…Ù† Ø­Ø§Ù„ØªÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 52.91ms 82.19ms 1.04s 82.93% <br> Req/Sec 8.05k 3.09k 55.62k 89.11% <br> Latency Distribution <br> 50% 3.66ms <br> 75% 94.87ms <br> 90% 171.83ms <br> 99% 354.26ms <br> 5179253 requests in 10.10s, 1.12GB read <br> Socket errors: connect 0, read 134, write 0, timeout 0 <br> Requests/sec: 512799.10 <br> Transfer/sec: 113.43MB <br> <br> root@ip-172-30-0-225:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 64.38ms 121.56ms 1.67s 90.32% <br> Req/Sec 7.30k 2.54k 34.94k 82.10% <br> Latency Distribution <br> 50% 3.68ms <br> 75% 103.32ms <br> 90% 184.05ms <br> 99% 561.31ms <br> 4692290 requests in 10.10s, 1.01GB read <br> Socket errors: connect 0, read 2, write 0, timeout 21 <br> Requests/sec: 464566.93 <br> Transfer/sec: 102.77MB</code> <br> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ØªÙƒÙˆÙŠÙ† nginx</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  Ø¨ÙŠØ§Ù†Ø§Øª www Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø› <br>  Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ø§Ù„ <br>  pid /run/nginx.pid Ø› <br>  worker_rlimit_nofile 50000 Ø› <br>  Ø§Ù„Ø£Ø­Ø¯Ø§Ø« { <br>  Ø§Ù„Ø¹Ù…Ø§Ù„_ÙˆØµÙ„Ø§Øª 10000 Ø› <br>  }} <br>  http { <br>  Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ø› <br>  tcp_nopush Ø¹Ù„Ù‰ Ø› <br>  tcp_nodelay Ø¹Ù„Ù‰ Ø› <br>  keepalive_timeout 65 Ø› <br>  types_hash_max_size 2048 Ø› <br><br>  ØªØ´Ù…Ù„ /etc/nginx/mime.types Ø› <br>  Ù†Øµ Ø§ÙØªØ±Ø§Ø¶ÙŠ / Ù†ÙˆØ¹ Ø¹Ø§Ø¯ÙŠ Ø› <br><br>  error_log /var/log/nginx/error.log Ø› <br>  ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„. <br><br>  Ø§Ù„Ø®Ø§Ø¯Ù… { <br>  Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ 80 back_server backlog = 10000 Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø› <br>  Ø§Ù„Ù…ÙˆÙ‚Ø¹ / { <br>  Ø¥Ø±Ø¬Ø§Ø¹ 200 "answer.padding _____________________________________________________________" Ø› <br>  }} <br>  }} <br>  }} <br></div></div><br>  ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØŒ Ù†Ø±Ù‰ Ø£Ù†Ù‡ ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠÙ† Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø­ÙˆØ§Ù„ÙŠ 1 Ù…Ù„ÙŠÙˆÙ† Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØŒ Ø§Ø³ØªØ®Ø¯Ù… nginx ÙÙ‚Ø· 32 ÙˆØ­Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù‡Ø°Ø§ ØŒ Ùˆ dpdk ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.  Ø±Ø¨Ù…Ø§ ÙŠØ¶Ø¹ EC2 Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø®Ù†Ø²ÙŠØ±Ù‹Ø§ Ùˆ 1 M rps ÙŠØ¹Ø¯ ØªÙ‚ÙŠÙŠØ¯Ù‹Ø§ Ù„Ù„Ø´Ø¨ÙƒØ© ØŒ ÙˆÙ„ÙƒÙ† Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø£Ù…Ø± ÙƒØ°Ù„Ùƒ ØŒ ÙØ¥Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„ÙŠØ³Øª Ù…Ø´ÙˆÙ‡Ø© ÙƒØ«ÙŠØ±Ù‹Ø§ ØŒ Ù„Ø£Ù† Ø¥Ø¶Ø§ÙØ© Ù…Ø«Ø§Ù„ Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ <i>Ù„Ù€ (int x = 0Ø› x &lt;100Ø› ++ x) http â†’ request_url [0] = 'a' + (http-&gt; request_url [0]Ùª 10)</i> Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø²Ù…Ø© ØŒ Ù‚Ø§Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨ØªÙ‚Ù„ÙŠÙ„ rps ØŒ Ù…Ù…Ø§ ÙŠØ¹Ù†ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ù…Ø¹ Ø¹Ù…Ù„ Ù…ÙÙŠØ¯. <br><br>  ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ¬Ø§Ø±Ø¨ ØŒ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù„ØºØ² ÙˆØ§Ø­Ø¯ ØŒ Ù…Ø§ Ø²Ù„Øª Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø­Ù„Ù‡.  Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨ØªÙ…ÙƒÙŠÙ† Ø¥Ù„ØºØ§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ ØŒ Ø£ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† IP Ùˆ tcp Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø¨ÙƒØ© Ù†ÙØ³Ù‡Ø§ ØŒ ÙØ¥Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… ÙŠÙ†Ø®ÙØ¶ â€‹â€‹ØŒ ÙˆÙŠØ­Ø³Ù‘Ù† Ø²Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„. <br>  Ù‡Ù†Ø§ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø¹ ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙØ±ÙŠØº <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 5.91ms 614.33us 28.35ms 96.17% <br> Req/Sec 10.48k 1.51k 69.89k 98.78% <br> Latency Distribution <br> 50% 5.91ms <br> 75% 6.01ms <br> 90% 6.19ms <br> 99% 6.99ms <br> 6738296 requests in 10.10s, 1.12GB read <br> Requests/sec: 667140.71 <br> Transfer/sec: 113.25MB</code> <br> <br>  ÙˆÙ‡Ù†Ø§ Ù…Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© <br><br> <code>root@ip-172-30-0-127:~# wrk -t64 -d10s -c4000 --latency http://172.30.4.10/testu <br> Running 10s test @ http://172.30.4.10/testu <br> 64 threads and 4000 connections <br> Thread Stats Avg Stdev Max +/- Stdev <br> Latency 32.19ms 63.43ms 817.26ms 85.01% <br> Req/Sec 15.97k 4.04k 113.97k 93.47% <br> Latency Distribution <br> 50% 2.58ms <br> 75% 17.57ms <br> 90% 134.94ms <br> 99% 206.03ms <br> 10278064 requests in 10.10s, 1.70GB read <br> Socket errors: connect 0, read 17, write 0, timeout 0 <br> Requests/sec: 1017645.11 <br> Transfer/sec: 172.75MB</code> <br> <br>  Ø­Ø³Ù†Ù‹Ø§ ØŒ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø£Ù† Ø£Ø´Ø±Ø­ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ø­Ù‚ÙŠÙ‚Ø© Ø£Ù† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø¨ÙƒØ© ØªØ¨Ø·Ø¦ ØŒ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØºÙ… Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ ØºØ±ÙŠØ¨ ØŒ Ø¥Ù„Ø§ Ø£Ù†Ù‡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ³Ø§Ø±Ø¹.  ÙˆÙ„ÙƒÙ† Ù„Ù…Ø§Ø°Ø§ ØŒ Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒÙ…ÙˆÙ† ØŒ ÙŠØªØ¨ÙŠÙ† Ø£Ù†Ù‡ Ø«Ø§Ø¨Øª ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ÙŠØ³Ø§ÙˆÙŠ 6 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© ØŒ ÙˆØ¥Ø°Ø§ ÙƒÙ†Øª ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© ØŒ ÙØ¥Ù†Ù‡ ÙŠØ·ÙÙˆ Ù…Ù† 2.5 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© Ø¥Ù„Ù‰ 817 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©ØŸ  Ø³ÙŠØªÙ… ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ± Ù…Ù† Ø®Ù„Ø§Ù„ Ø­Ø§Ù…Ù„ ØºÙŠØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¹ Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± ØŒ Ù„ÙƒÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠ Ù‡Ø°Ø§ ØŒ Ù„Ù„Ø£Ø³Ù.  Ù„Ø§ ØªØ¹Ù…Ù„ DPDK Ù†ÙØ³Ù‡Ø§ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© ØŒ ÙˆÙ‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a> . <br><br>  ÙˆØ£Ø®ÙŠØ±Ø§ ØŒ Ù…Ø³Ø­. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar416651/">https://habr.com/ru/post/ar416651/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar416639/index.html">Ù…Ù‚Ø§Ø¨Ù„Ø© Ù…Ø¹ Ø±ÙˆØ§Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</a></li>
<li><a href="../ar416641/index.html">8 Ù…Ø±Ø§Ø­Ù„ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© ØªØ·ÙˆÙŠØ± ÙˆØ§Ø¬Ù‡Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…ØªØ­Ø±Ùƒ</a></li>
<li><a href="../ar416643/index.html">Ù†Ø´Ø± Elasticsearch Ø¹Ù„Ù‰ AWS Ù…Ø¹ Kubernetes ÙÙŠ 10 Ø®Ø·ÙˆØ§Øª</a></li>
<li><a href="../ar416645/index.html">Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©. Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¨Ø­Ø«</a></li>
<li><a href="../ar416647/index.html">Ù‡Ù„ ØªØ­Ù„Ù… Ø§Ù„ÙˆÙƒØ§Ù„Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© Ø¨Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©ØŸ</a></li>
<li><a href="../ar416653/index.html">ÙØ±Ø² Ø§Ù„Ù…ÙƒØªØ¨Ø©</a></li>
<li><a href="../ar416657/index.html">ÙŠØ­ØªÙˆÙŠ Ø«Ù„Ø«Ø§ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ© Ù„Ù„Ù…Ø§Ù„ÙƒÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†</a></li>
<li><a href="../ar416659/index.html">Ø¨Ø³Ø¨Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ø­ÙÙ„Ø© Ø³ÙŠØµÙ„ Ø¥Ù„Ù‰ 1.2 ØªØ±ÙŠÙ„ÙŠÙˆÙ† Ø¯ÙˆÙ„Ø§Ø±</a></li>
<li><a href="../ar416661/index.html">Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¹Ø§ØªÙ‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ ÙˆÙ…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØµØ±ÙÙŠØ© Ø¹Ø¨Ø± Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„</a></li>
<li><a href="../ar416665/index.html">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø§Øª Android Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Sonatype Nexus Repository OSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>