<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüöí ü•ë üñ≤Ô∏è Teste de estresse confi√°vel, levando em considera√ß√£o nuances imprevis√≠veis üçØ üßëüèæ‚Äçü§ù‚Äçüßëüèæ üë∑üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pensamos em construir a infraestrutura de grandes testes de carga h√° um ano, quando atingimos a marca de 12 mil usu√°rios online trabalhando em nosso s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teste de estresse confi√°vel, levando em considera√ß√£o nuances imprevis√≠veis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/462735/"> Pensamos em construir a infraestrutura de grandes testes de carga h√° um ano, quando atingimos a marca de 12 mil usu√°rios online trabalhando em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nosso servi√ßo</a> ao mesmo tempo.  Durante 3 meses, fizemos a primeira vers√£o do teste, que mostrou os limites do servi√ßo. <br><br>  A ironia do destino √© que, ao mesmo tempo em que o teste foi lan√ßado, atingimos os limites do produto, pelo que o servi√ßo caiu 2 horas.  Al√©m disso, isso nos incentivou a come√ßar a realizar testes de caso a caso, criando uma infraestrutura eficaz de suporte de carga.  Por infraestrutura, quero dizer todas as ferramentas para trabalhar com a carga: ferramentas para inicializa√ß√£o e inicializa√ß√£o, um cluster para carregar a carga, um cluster, um produto similar, servi√ßos para coletar m√©tricas e preparar relat√≥rios, c√≥digo para gerenciar tudo isso e servi√ßos para dimensionamento. <br><br><img src="https://habrastorage.org/webt/mw/kz/jl/mwkzjls34yw96qxg5lu9ubf-0bs.png"><br><a name="habracut"></a><br>  √â assim que o esquema do miro.com √© simplificado: existem muitos servidores diferentes que de alguma forma interagem entre si e cada um executa tarefas espec√≠ficas.  Parece que, para construir a infraestrutura de testes de carga, bastava desenhar esse esquema, levar em considera√ß√£o todos os relacionamentos e come√ßar a cobrir cada bloco sequencialmente com scripts.  Essa abordagem √© boa, mas levaria muitos meses, o que n√£o era adequado para n√≥s por causa do r√°pido crescimento - nos √∫ltimos seis meses, passamos de 12 mil para 20 mil usu√°rios on-line trabalhando no servi√ßo ao mesmo tempo.  Al√©m disso, n√£o sab√≠amos como a infraestrutura de nosso servi√ßo responderia a um aumento de carga: qual dos blocos se tornaria um gargalo e qual poder√≠amos dimensionar linearmente. <br><br>  Como resultado, decidimos testar o servi√ßo usando usu√°rios virtuais, simulando seu trabalho realista, ou seja, construindo um clone de produ√ß√£o e fazendo um grande teste, que: <br><br><ul><li>  carregar um cluster que seja id√™ntico √† produ√ß√£o em estrutura, mas √† frente em poder; </li><li>  nos d√™ todos os dados para tomar decis√µes; </li><li>  mostrar√° que toda a infraestrutura √© capaz de suportar a carga correta; </li><li>  ser√° a base para os testes de estresse que precisaremos no futuro. </li></ul><br>  O √∫nico ponto negativo desse teste √© o seu pre√ßo de custo, porque para isso precisamos de um ambiente que seja maior que o ambiente de produ√ß√£o. <br><br>  Neste artigo, falarei sobre a cria√ß√£o de um cen√°rio realista, plug-ins - WS, Stress-client, Taurus, - cluster de carga, cluster de vendas e mostrar√° exemplos de uso de testes.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O pr√≥ximo artigo</a> √© sobre como gerenciamos centenas de servidores para um teste de carga. <br><br><h2>  Crie um cen√°rio realista </h2><br>  Para criar um cen√°rio realista, precisamos: <br><br><ul><li>  analise o trabalho dos usu√°rios no produto e, para isso, determine as m√©tricas importantes para n√≥s, comece a colet√°-las regularmente e analise os saltos; </li><li>  criar blocos personalizados convenientes com os quais possamos carregar com efici√™ncia a parte necess√°ria da l√≥gica de neg√≥cios; </li><li>  Verifique o realismo do script com m√©tricas do servidor. </li></ul><br>  Agora, mais sobre cada item. <br><br>  <b>An√°lise do trabalho do usu√°rio no prod</b> <br><br>  Em nosso servi√ßo, os usu√°rios podem criar pain√©is e trabalhar neles com diferentes conte√∫dos: fotos, textos, mocapas, adesivos, diagramas etc.  A primeira m√©trica que precisamos coletar √© o n√∫mero de pain√©is e a distribui√ß√£o de conte√∫do neles. <br><br><img align="left" src="https://habrastorage.org/webt/uq/ah/cp/uqahcpsgmjnzqao48ivvrhgzuvc.png" width="400" height="500"><br>  No mesmo quadro, no mesmo momento, alguns usu√°rios podem fazer algo ativamente - criar, excluir, editar - e outros simplesmente visualizar o material criado.  Essa tamb√©m √© uma m√©trica importante - a propor√ß√£o entre o n√∫mero de usu√°rios que alteram o conte√∫do do quadro e o n√∫mero total de usu√°rios de um quadro.  Podemos obter isso com base em estat√≠sticas sobre o trabalho com o banco de dados. <br><br>  Em nosso back-end, usamos a abordagem de componentes.  Componentes que chamamos de modelos.  Dividimos nosso c√≥digo em modelos para que, para cada parte da l√≥gica de neg√≥cios, um determinado modelo seja respons√°vel.  Podemos calcular o n√∫mero de chamadas ao banco de dados que ocorrem em cada modelo e entender qual parte da l√≥gica carrega mais o banco de dados. <br><br><img src="https://habrastorage.org/webt/-d/zu/iu/-dzuiu9istykhoantxrs-po64ky.png"><br><br>  <b>Blocos personalizados convenientes</b> <br><br>  Por exemplo, precisamos adicionar um bloco ao script que carregue nosso servi√ßo de forma id√™ntica √† de como acontece quando voc√™ abre uma p√°gina do painel com uma lista de pain√©is do usu√°rio.  Durante o carregamento desta p√°gina, s√£o enviadas solicita√ß√µes de HTTP com um grande conjunto de dados: o n√∫mero de placas, as contas √†s quais o usu√°rio tem acesso, todos os usu√°rios da conta e assim por diante. <br><br><img src="https://habrastorage.org/webt/zb/j1/sx/zbj1sxyfvbkfbotawsqnegvz8zg.gif"><br><br>  Como carregar um painel de forma eficaz?  Ao analisar o comportamento da produ√ß√£o, vimos picos de carga no banco de dados durante a abertura do painel de uma conta grande.  Podemos recriar uma conta id√™ntica e alterar a intensidade do uso de seus dados no script, carregando efetivamente um painel com um pequeno n√∫mero de ocorr√™ncias.  Tamb√©m podemos criar uma carga desigual para maior realismo. <br><br>  Ao mesmo tempo, √© importante para n√≥s que o n√∫mero de usu√°rios virtuais e a carga criada por eles sejam o mais semelhante poss√≠vel aos usu√°rios e a carga na produ√ß√£o.  Para fazer isso, tamb√©m recriaremos no teste a carga em segundo plano no painel m√©dio.  Assim, a maioria dos usu√°rios virtuais trabalha em pequenos pain√©is m√©dios e apenas alguns usu√°rios criam uma carga desastrosa, como acontece na produ√ß√£o. <br><br>  Inicialmente, n√£o quer√≠amos cobrir cada fun√ß√£o de servidor e cada relacionamento com um script separado.  Isso pode ser visto no exemplo com o painel - simplesmente repetimos durante o teste o que acontece quando o painel √© aberto no produto quando o usu√°rio o abre e n√£o cobrimos o que isso afeta nos scripts sint√©ticos.  Isso permite que voc√™, por padr√£o, inclua nuances de teste que nem antecipamos.  Portanto, estamos nos aproximando da cria√ß√£o de um teste de infraestrutura do lado da l√≥gica de neg√≥cios. <br><br>  Usamos essa l√≥gica para carregar efetivamente todos os outros blocos do servi√ßo.  Ao mesmo tempo, cada bloco individual, do ponto de vista da l√≥gica do uso do funcional, pode n√£o ser realista;  √© importante fornecer uma carga m√©trica realista nos servidores.  E ent√£o podemos criar um script a partir desses blocos que imita o trabalho real dos usu√°rios. <br><br><img src="https://habrastorage.org/webt/wk/gc/po/wkgcporetjxwqqbca-qfeedkuam.png"><br><br><h3>  Os dados fazem parte do script. </h3><br>  Lembre-se de que os dados tamb√©m fazem parte do script e a l√≥gica do c√≥digo em si depende muito dos dados.  Ao criar um banco de dados grande para o teste - e obviamente deve ser grande para um grande teste de infraestrutura - precisamos aprender a criar dados que n√£o ser√£o exibidos durante a execu√ß√£o do script.  Se voc√™ acumular dados indesejados, o script poder√° n√£o ser realista e ser√° dif√≠cil corrigir um banco de dados grande.  Portanto, come√ßamos a usar a API Rest para criar dados da mesma maneira que nossos usu√°rios. <br><br>  Por exemplo, para criar placas com os dados dispon√≠veis, executamos solicita√ß√µes de API para carregar placas a partir do backup.  Como resultado, obtemos dados reais honestos - placas diferentes de tamanhos diferentes.  Ao mesmo tempo, o banco de dados est√° sendo preenchido rapidamente, devido ao fato de estarmos recebendo solicita√ß√µes no script multithreaded.  Em velocidade, isso √© compar√°vel √† gera√ß√£o de dados do lixo. <br><br><h3>  Resultados para esta parte </h3><br><ul><li>  Use cen√°rios realistas se quiser verificar tudo de uma vez; </li><li>  Analisar o comportamento real do usu√°rio para projetar a estrutura do script; </li><li>  Crie imediatamente blocos convenientes para personaliza√ß√£o; </li><li>  Configure por m√©tricas reais do servidor, n√£o por an√°lises de uso; </li><li>  Lembre-se de que os dados fazem parte do script. </li></ul><br><h2>  Carregar cluster </h2><br>  Esquema de ferramentas para aplica√ß√£o de carga: <br><br><img src="https://habrastorage.org/webt/sw/gb/wg/swgbwgmqvkv2r8uue1tkrv5oyve.png"><br><br>  No Jmeter, criamos um script que lan√ßamos usando o Taurus e carregamos v√°rios servidores: servidores web, api, board.  Realizamos testes de banco de dados separadamente usando o Postgresql, n√£o o Jmeter, portanto, o diagrama mostra uma linha tracejada. <br><br><h3>  Trabalho personalizado dentro do soquete da web </h3><br>  O trabalho na placa ocorre dentro da conex√£o WS e √© nela que √© poss√≠vel o trabalho multiusu√°rio.  Agora, na caixa Jmeter, dentro do gerenciador de plug-ins, existem v√°rios plug-ins para trabalhar com o soquete da web.  A l√≥gica √© a mesma em todos os lugares - os plug-ins simplesmente abrem uma conex√£o de soquete da Web, mas todas as a√ß√µes que ocorrem dentro, em qualquer caso, voc√™ precisa se escrever.  Porque  Como n√£o podemos trabalhar da mesma maneira que com solicita√ß√µes de http, ou seja, n√£o podemos escrever um script, extrair valores din√¢micos com extratores e ignor√°-los ainda mais. <br><br>  O trabalho dentro do soquete da web geralmente √© muito personalizado: voc√™ invoca certos m√©todos com certos dados personalizados e, portanto, precisa entender se a solicita√ß√£o foi executada corretamente e quanto tempo levou para ser executada.  O Ouvinte dentro deste plugin tamb√©m √© escrito de forma independente; n√£o encontramos uma boa solu√ß√£o pronta. <br><br><h3>  Stress-client </h3><br>  Queremos repetir o mais simples poss√≠vel o que usu√°rios reais fazem.  Mas n√£o sabemos como gravar e reproduzir o que est√° acontecendo no navegador dentro do WS.  Se escrevermos tudo dentro do WS do zero, obteremos um novo cliente, e n√£o aquele que os usu√°rios reais usam.  N√£o tenho vontade de escrever um novo cliente se j√° tivermos um trabalhando. <br><br>  Portanto, decidimos colocar nosso cliente dentro da Jmeter.  E confrontado com uma s√©rie de dificuldades.  Por exemplo, executar js dentro do Jmeter √© uma hist√≥ria separada, como  Esta √© uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o</a> absolutamente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">espec√≠fica dos</a> recursos suportados.  E se voc√™ quiser usar seu c√≥digo de cliente existente, provavelmente n√£o ter√° √™xito, porque constru√ß√µes novas e com ventosas n√£o podem ser iniciadas aqui, elas ter√£o que ser reescritas. <br><br>  A segunda dificuldade √© que n√£o queremos oferecer suporte a todo o c√≥digo do cliente para testes de carga.  Portanto, removemos tudo sup√©rfluo do cliente e deixamos apenas a intera√ß√£o cliente-servidor.  Isso nos permitiu usar m√©todos cliente-servidor e fazer tudo o que nosso cliente pode fazer.  A vantagem √© que a intera√ß√£o cliente-servidor muda extremamente raramente, o que significa que o suporte ao c√≥digo dentro do script raramente √© necess√°rio.  Por exemplo, nos √∫ltimos seis meses, nunca fiz altera√ß√µes no c√≥digo, porque funciona muito bem. <br><br>  A terceira dificuldade - a apar√™ncia de scripts grandes complica significativamente o script.  Em primeiro lugar, pode se tornar um gargalo no teste.  Em segundo lugar, provavelmente n√£o conseguiremos iniciar um grande n√∫mero de threads de uma m√°quina.  Agora s√≥ podemos lan√ßar 730 threads. <br><br>  <b>Nosso exemplo de inst√¢ncia da Amazon</b> <br><br><pre><code class="plaintext hljs"> Jmeter server  AWS: m5.large ($0.06 per Hour) vCPU: 2 Mem (GiB): 8 Dedicated EBS Bandwidth (Mbps): Up to 3,500 Network Performance (Gbps): Up to 10 ‚Üí ~730 </code> </pre> <br><h3>  Onde obter centenas de servidores e como economizar </h3><br>  Em seguida, surge a pergunta: 730 threads de uma m√°quina, mas queremos 50K.  Onde criar tantos servidores?  Como estamos criando uma solu√ß√£o em nuvem, a compra de servidores para testar uma solu√ß√£o em nuvem parece estranha.  Al√©m disso, √© sempre uma certa lentid√£o nos processos de compra de ferro novo.  Portanto, precisamos cri√°-los tamb√©m na nuvem, para finalmente escolhermos entre os provedores de nuvem e as ferramentas de carregamento em nuvem. <br><br>  N√£o usamos ferramentas de carregamento em nuvem como Blazemeter e RedLine13, porque elas t√™m restri√ß√µes de uso que n√£o nos agradam.  Como temos locais de teste diferentes, quer√≠amos encontrar uma solu√ß√£o universal que permitisse que 90% dos desenvolvimentos fossem usados, inclusive em testes locais. <br><br>  Como resultado, escolhemos entre os provedores de nuvem. <br><br><img src="https://habrastorage.org/webt/ud/35/8n/ud358nhlnnsa9uopiwpfisoipa8.png"><br><br>  Nossa produ√ß√£o √© na AWS, ent√£o estamos testando principalmente l√°, e queremos que o banco de testes seja o mais semelhante poss√≠vel √† produ√ß√£o.  A Amazon possui muitos recursos pagos, alguns dos quais usamos no produto, por exemplo, balanceadores.  Se esses recursos n√£o forem necess√°rios na AWS, voc√™ poder√° us√°-los 17 vezes mais barato no Hetzner.  Ou voc√™ pode manter o servidor no Hetzner, usar o Openstack e escrever balanceadores e outros recursos, j√° que, usando o Openstack, voc√™ pode repetir toda a infraestrutura.  N√≥s conseguimos. <br><br>  Testar 50 mil usu√°rios com 69 inst√¢ncias na AWS nos custa aproximadamente US $ 3 mil por m√™s.  Como salvar?  Por exemplo, a AWS tem inst√¢ncias tempor√°rias - inst√¢ncias spot.  A frescura deles √© que n√£o os mantemos constantemente, apenas os aumentamos durante os testes e eles custam muito menos.  A nuance √© que algu√©m pode compr√°-los a um pre√ßo mais alto no momento do teste.  Felizmente, isso nunca aconteceu antes, mas j√° economizamos pelo menos 60% do custo √†s suas custas. <br><br><h2>  Carregar cluster </h2><br>  Usamos o cluster da caixa Jmeter.  Funciona muito bem, n√£o precisa ser modificado de forma alguma.  Possui v√°rias op√ß√µes de inicializa√ß√£o.  Usamos o mais simples quando um assistente inicia N inst√¢ncias, e pode haver centenas delas. <br><br><img src="https://habrastorage.org/webt/vz/oj/di/vzojdipz783bcxk6va84kxuu1ga.png"><br><br>  O assistente executa o script nos servidores Jmeter, mantendo contato com eles, coleta estat√≠sticas gerais de todas as inst√¢ncias em tempo real e o exibe no console.  Tudo isso parece exatamente o mesmo que executar o script em um servidor, embora vejamos os resultados do lan√ßamento em uma centena de servidores. <br><br>  Para uma an√°lise detalhada dos resultados da execu√ß√£o do script em todas as inst√¢ncias, usamos o Kibana.  Parsim registra usando Filebeat. <br><br><img src="https://habrastorage.org/webt/lp/2i/es/lp2ieslbdsgadsr41ydhss4vtco.png"><br><br><h3>  Um ouvinte do Prometheus para Apache JMeter </h3><br>  O Jmeter possui um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">in para trabalhar com o Prometheus</a> , que fornece todas as estat√≠sticas sobre o uso da JVM e threads dentro do teste.  Isso permite que voc√™ veja com que frequ√™ncia os usu√°rios se conectam, saem e assim por diante.  O plug-in pode ser personalizado para enviar dados do script para o Prometheus e v√™-los em tempo real no Grafana. <br><br><img src="https://habrastorage.org/webt/mw/ig/3m/mwig3mwxuq6p7rexf1hq9nc8gek.png"><br><br><h3>  Touro </h3><br>  Queremos resolver uma s√©rie de problemas atuais com o Taurus, mas ainda n√£o o lidamos: <br><br><ul><li>  Configura em vez de clones de script.  Se voc√™ testou no Jmeter, provavelmente enfrentou a necessidade de executar scripts com diferentes conjuntos de par√¢metros de origem, para os quais foi necess√°rio criar seus clones.  No Taurus, √© poss√≠vel ter um cen√°rio, e com a ajuda de configura√ß√µes para controlar os par√¢metros de inicializa√ß√£o; </li><li>  Configura para gerenciar servidores Jmeter ao trabalhar com um cluster; </li><li>  Um analisador de resultados online que permite coletar resultados separadamente dos encadeamentos Jmeter e n√£o sobrecarregar o pr√≥prio script; </li><li>  Integra√ß√£o conveniente com o CI; </li><li>  A capacidade de testar um sistema distribu√≠do. </li></ul><br><h3>  Os resultados desta parte </h3><br><ul><li>  Se usarmos o c√≥digo dentro do Jmeter, √© melhor pensar imediatamente em seu desempenho, porque, caso contr√°rio, podemos testar o Jmeter, n√£o o nosso produto; </li><li>  O cluster Jmeter √© uma coisa maravilhosa: √© f√°cil de configurar, o monitoramento √© facilmente parafusado a ele; </li><li>  Um cluster grande pode ser mantido em inst√¢ncias spot, ser√° muito mais barato; </li><li>  Cuidado com os ouvintes dentro do Jmeter, para que o script n√£o diminua a velocidade do trabalho em um grande n√∫mero de servidores. </li></ul><br><h2>  Exemplos de uso de testes de infraestrutura </h2><br>  A hist√≥ria toda acima √© basicamente sobre como criar um cen√°rio realista para um teste de limite de servi√ßo.  Os exemplos abaixo mostram como voc√™ pode reutilizar a infraestrutura de testes de carga para resolver problemas locais.  Falarei detalhadamente sobre dois testes, mas em geral realizamos periodicamente cerca de 10 tipos de testes de carga. <br><a name="database"></a><br><h3>  Teste de banco de dados </h3><br>  O que podemos carregar teste no banco de dados?  Consultas pesadas s√£o improv√°veis, porque podemos test√°-las no modo de thread √∫nico, se apenas olharmos para os planos de consulta. <br><br>  Uma situa√ß√£o interessante √© quando executamos o teste e vemos a carga no disco.  O gr√°fico mostra como o iowait aumenta. <br><br><img src="https://habrastorage.org/webt/o9/7i/wy/o97iwyqnwc7rdo6utv-xjoe-p_c.png"><br><br>  Al√©m disso, vemos que isso afeta os usu√°rios. <br><br><img src="https://habrastorage.org/webt/3z/c_/ia/3zc_iawonyc_jwscpgs4fl8yi1a.png"><br><br>  Entendemos o motivo: o v√°cuo n√£o funcionou e n√£o excluiu os dados do lixo do banco de dados.  Se voc√™ n√£o trabalhou com o Postgresql, o Vacuum √© como o coletor de lixo em Java. <br><br><img src="https://habrastorage.org/webt/2l/ks/vr/2lksvred5j50eummkssdxyw7i1w.png"><br><br>  Al√©m disso, vemos que o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Checkpoint</a> come√ßou a funcionar fora do cronograma.  Para n√≥s, este √© um sinal de que as configura√ß√µes do Postgresql n√£o correspondem √† intensidade do trabalho com o banco de dados. <br><br><img src="https://habrastorage.org/webt/le/sx/cb/lesxcbanlw_j5iyhm0bawfrq4ic.png"><br><br>  Nossa tarefa √© configurar corretamente o banco de dados para que essas situa√ß√µes n√£o se repitam.  O mesmo Postgresql tem muitas configura√ß√µes.  Para um ajuste fino, voc√™ precisa trabalhar em itera√ß√µes curtas: corrigida a configura√ß√£o, iniciada, verificada, corrigida, iniciada, verificada.  Obviamente, para isso, voc√™ precisa aplicar uma boa carga √† base, mas para isso, voc√™ s√≥ precisa de grandes testes de infraestrutura. <br><br>  A peculiaridade √© que, para que o teste acelere normalmente e n√£o caia onde n√£o √© necess√°rio, o overclock deve ser demorado.  Demora cerca de tr√™s horas para testar, e isso n√£o se parece mais com itera√ß√µes curtas. <br><br>  Estamos √† procura de uma solu√ß√£o.  Encontramos uma das ferramentas do Postgresql - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pg_replay</a> .  Ele pode reproduzir de v√°rias maneiras exatamente o que est√° escrito nos registros e exatamente como aconteceu no momento da grava√ß√£o.  Como podemos us√°-lo efetivamente?  Recolhemos o dump base, registramos tudo o que acontece no banco de dados ap√≥s salvar nos logs e, em seguida, temos a oportunidade de implantar o dump e reproduzir tudo o que aconteceu com a base multithread. <br><br>  Onde gravar logs?  Uma solu√ß√£o popular para registrar logs √© colet√°-los no produto, pois isso fornece o script reprodut√≠vel mais realista.  Mas h√° v√°rios problemas: <br><br><ul><li>  Para o teste, voc√™ precisa usar os dados de vendas, o que nem sempre √© poss√≠vel; </li><li>  O processo usa uma opera√ß√£o cara de syslog; </li><li>  O disco est√° carregando. </li></ul><br>  Nossa abordagem para grandes testes nos ajuda aqui.  Realizamos um despejo em um ambiente de teste, executamos um grande teste e registramos os logs de tudo o que acontece no momento em que o script realista √© executado.  Em seguida, usamos nossa pr√≥pria ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">marucy</a> para testar o banco de dados: <br><ol><li>  Uma inst√¢ncia √© criada na AWS; </li><li>  O despejo de que precisamos √© implantado; </li><li>  Pg_replay √© iniciado e reproduz os logs necess√°rios; </li><li>  Utilizamos nosso monitoramento para analisar o resultado da Prometheus + Grafana.  Existem exemplos de pain√©is no reposit√≥rio. </li></ol><br>  Ao iniciar o marucy, podemos passar um pequeno n√∫mero de par√¢metros que podem ser alterados, por exemplo, a intensidade do script. <br><br>  Como resultado, usamos nosso script realista para criar um teste e, em seguida, executamos o teste sem usar um cluster grande.  √â importante considerar que, para testar qualquer banco de dados sql, o script deve ser desigual, caso contr√°rio, o pr√≥prio banco de dados se comportar√° de maneira diferente do prod. <br><br><h3>  Monitoramento de degrada√ß√£o </h3><br>  Para testes de degrada√ß√£o, usamos nosso cen√°rio realista.  A id√©ia √© que precisamos garantir que o servi√ßo n√£o funcione mais lentamente ap√≥s o pr√≥ximo lan√ßamento.  Se nossos desenvolvedores alterarem o c√≥digo, o que leva a um aumento no tempo de execu√ß√£o das solicita√ß√µes, podemos comparar os novos valores com os de refer√™ncia e sinalizar se h√° um erro na compila√ß√£o.  Para valores de refer√™ncia, tomamos os valores atuais que nos conv√™m. <br><br>  Controlar o tempo de execu√ß√£o da consulta √© √∫til, mas fomos al√©m.  Quer√≠amos ver que o tempo de resposta durante o trabalho de usu√°rios reais ap√≥s o lan√ßamento n√£o se prolongou.  Pensamos que, no momento dos testes de estresse, provavelmente poder√≠amos entrar e verificar alguma coisa, mas esses ser√£o apenas dezenas de casos.  √â mais eficiente executar testes funcionais existentes e ver mil casos ao mesmo tempo. <br><br><img src="https://habrastorage.org/webt/_-/xy/0t/_-xy0t6oavpjngkog1hwqelq5ky.png"><br><br>  Como isso funciona para n√≥s?  H√° um mestre que, ap√≥s a montagem, √© implantado em uma bancada de testes.  Em seguida, os testes funcionais s√£o executados automaticamente em paralelo com os testes de carga.  Em seguida, obtemos um relat√≥rio no Allure sobre como os testes funcionais foram sobrecarregados. <br><br>  Neste relat√≥rio, por exemplo, vemos que um teste de compara√ß√£o caiu com um valor de refer√™ncia. <br><br><img src="https://habrastorage.org/webt/t-/hh/b-/t-hhb-mrpc9zgyg0iwhvvt1yxtu.png"><br><br>  Tamb√©m em testes funcionais, podemos medir o tempo de execu√ß√£o de uma opera√ß√£o em um navegador.  Ou, um teste funcional simplesmente n√£o √© bem-sucedido devido a um aumento no tempo de execu√ß√£o da opera√ß√£o sob carga, porque o tempo limite no cliente funcionar√°. <br><br><h3>  Resultados para esta parte </h3><br><ul><li>  Um teste realista permite que voc√™ teste barato o banco de dados e configure-o facilmente; </li><li>  Teste funcional sob carga √© poss√≠vel. </li></ul><br><br>  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pr√≥ximo artigo</a> √© sobre como gerenciamos centenas de servidores para um teste de carga. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt462735/">https://habr.com/ru/post/pt462735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt462723/index.html">Pegue um gato com TLA +</a></li>
<li><a href="../pt462725/index.html">Trigonometria</a></li>
<li><a href="../pt462727/index.html">Resumo do Joomla de junho a julho de 2019</a></li>
<li><a href="../pt462729/index.html">Noite de palestras aberta sobre design de narrativas na VSBI</a></li>
<li><a href="../pt462733/index.html">Fibre Channel: a vitalidade da conex√£o com o armazenamento no data center</a></li>
<li><a href="../pt462737/index.html">Integra√ß√£o Opencart com sistemas de contabilidade</a></li>
<li><a href="../pt462739/index.html">Confer√™ncia da ind√∫stria de jogos GAMEDEV.HOUSE</a></li>
<li><a href="../pt462743/index.html">Moscow SPA Meetup # 5 - An√∫ncio da reuni√£o</a></li>
<li><a href="../pt462747/index.html">Eu escrevi este artigo sem nunca olhar para o teclado</a></li>
<li><a href="../pt462749/index.html">Gerenciamento de felicidade: como cuidar e desenvolver uma equipe de home office de mais de 30 cidades</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>