<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§üüèø üìÅ üç∂ Videovigilancia en el hogar. Esquema de mantener un archivo de video sin un registrador casero üëï üë®üèª üë®‚Äçüë©‚Äçüë¶‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Durante bastante tiempo quise escribir un art√≠culo sobre un gui√≥n para trabajar con una c√°mara a trav√©s del protocolo DVRIP, pero una discusi√≥n sobre ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Videovigilancia en el hogar. Esquema de mantener un archivo de video sin un registrador casero</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482864/">  Durante bastante tiempo quise escribir un art√≠culo sobre un gui√≥n para trabajar con una c√°mara a trav√©s del protocolo DVRIP, pero una discusi√≥n sobre las noticias recientes sobre <a href="https://habr.com/ru/news/t/482770">Xiaomi</a> me llev√≥ a hablar primero sobre c√≥mo configur√© la videovigilancia en casa, y luego pasar a los guiones y m√°s. <br><br>  <strike>Ten√≠amos 2 paquetes ...</strike> Entonces, para, esta no es la historia. <br>  Ten√≠amos 2 enrutadores TP-LINK, acceso a Internet para el proveedor NAT, c√°mara de vigilancia Partizan, no recuerdo qu√© modelo (cualquier c√°mara IP que admita RTSP sobre TCP o DVRIP saldr√°) y VPS barato por 4 euros con caracter√≠sticas: 2 n√∫cleos CPU de 2,4 GHz, 4 GB de RAM, disco duro de 300 GB, puerto de 100 Mbit / s.  Y tambi√©n la renuencia a comprar cualquier otra cosa que costar√≠a m√°s que un cable de conexi√≥n. <br><a name="habracut"></a><br><h3>  Pr√≥logo </h3><br>  Por razones obvias, no podemos simplemente reenviar los puertos de la c√°mara en el enrutador y disfrutar de la vida, adem√°s, incluso si pudi√©ramos, no deber√≠amos hacer esto. <br><br>  Fuera de mi o√≠do, escuch√© que hay algunas opciones con el t√∫nel IPv6, donde parece que puedes hacer todo para que todos los dispositivos en la red reciban una direcci√≥n IPv6 externa, y esto simplificar√≠a un poco las cosas, aunque a√∫n deja la seguridad de este evento en cuesti√≥n , y tambi√©n el soporte en el firmware est√°ndar de TP-LINK para este milagro es de alguna manera extra√±o.  Aunque es probable que en la oraci√≥n anterior no diga tonter√≠as, no le preste atenci√≥n. <br><br>  Pero, afortunadamente, casi cualquier firmware para cualquier enrutador (una declaraci√≥n bastante infundada en realidad) contiene un cliente PPTP / L2TP o la capacidad de instalar firmware personalizado con su presencia.  Y a partir de esto ya podemos construir alg√∫n tipo de estrategia de comportamiento. <br><br><h3>  Topolog√≠a </h3><br>  En un ataque de fiebre, mi cerebro dio a luz a algo como este esquema de conexi√≥n, <br><br><div class="spoiler">  <b class="spoiler_title">y durante otro ataque dibuj√≥ para poner una revista geek</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/og/sk/5j/ogsk5j5rwmyz8ocg8qk8kjod8da.png"><br></div></div><br>  <i>La direcci√≥n 169.178.59.82 se genera aleatoriamente y sirve solo como un ejemplo.</i> <br><br>  Bueno, o si en palabras, entonces: <br><br><ul><li>  Enrutador <b>TP-LINK 1 (192.168.1.1)</b> , en el que se inserta un cable, que sobresale de la pared.  Un lector curioso adivinar√° que este es un cable de proveedor a trav√©s del cual obtengo acceso a Internet.  Una variedad de dispositivos dom√©sticos est√°n conectados a este enrutador a trav√©s de un cable de conexi√≥n o Wi-Fi.  Esta es una red <b>192.168.1.0</b> </li><li>  El enrutador <b>TP-LINK 2 (192.168.0.1, 192.168.1.200)</b> , en el que se inserta el cable, que sobresale del enrutador TP-LINK 1. Gracias a este cable, el enrutador TP-LINK 2, as√≠ como los dispositivos conectados a √©l, tambi√©n tienen acceso a Internet  En este enrutador, se configura la conexi√≥n PPTP (10.0.5.100) al servidor 169.178.59.82.  La c√°mara IP 192.168.0.200 tambi√©n est√° conectada a este enrutador y se reenv√≠an los siguientes puertos <ul><li>  192.168.0.200:80 -&gt; 49151 (webmord) </li><li>  192.168.0.200 ‚àó 4567 -&gt; 49152 (DVRIP) </li><li>  192.168.0.200/1054 -&gt; 49153 (RTSP) </li></ul></li><li>  <b>El servidor (169.178.59.82, 10.0.5.1)</b> al que est√° conectado el enrutador TP-LINK 2. Pptpd, shadowsocks y 3proxy est√°n girando en el servidor, a trav√©s del cual puede acceder a los dispositivos de red 10.0.5.0 y as√≠ tener acceso al enrutador TP-LINK 2 . </li></ul><br>  Por lo tanto, todos los dispositivos dom√©sticos en la red 192.168.1.0 tienen acceso a la c√°mara a trav√©s de TP-LINK 2 en la direcci√≥n 192.168.1.200, y todos los dem√°s pueden conectarse a trav√©s de pptp, shadowsocks o socks5 y acceder a 10.0.5.100. <br><br><h3>  Personalizaci√≥n </h3><br>  El primer paso es conectar todos los dispositivos de acuerdo con el diagrama de la figura anterior. <br><br><ul><li>  Configurar el enrutador TP-LINK 1 equivale a reservar la direcci√≥n 192.168.1.200 para TP-LINK 2. Opcionalmente, si necesita una direcci√≥n fija para acceder desde la red 192.168.1.0.  Y, si lo desea, puede reservar 10-20 Mbit (10 es suficiente para una transmisi√≥n de video en 1080 con un cabezal). </li><li>  Necesita instalar y configurar pptpd en el servidor.  Tengo Ubuntu 18.04 y las acciones fueron aproximadamente las siguientes (el ejemplo fue <a href="" rel="nofollow">blog.xenot.ru/bystraya-nastrojka-vpn-servera-pptp-na-ubuntu-server-18-04-lts.fuck</a> ): <ul><li>  Instale los paquetes necesarios: <br><br><pre><code class="bash hljs">sudo apt install pptpd iptables-persistent</code> </pre> </li><li>  Traemos a la siguiente forma <br><br><div class="spoiler">  <b class="spoiler_title">/etc/pptpd.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">option /etc/ppp/pptpd-options bcrelay eth0 # ,        logwtmp localip 10.0.5.1 remoteip 10.0.5.100-200</code> </pre> <br></div></div></li><li>  Correcto <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / ppp / pptpd-options</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">novj novjccomp nologfd name pptpd refuse-pap refuse-chap refuse-mschap require-mschap-v2 #require-mppe-128 #  ,   TP-LINK c    ms-dns 8.8.8.8 ms-dns 1.1.1.1 ms-dns 77.88.8.8 ms-dns 8.8.4.4 ms-dns 1.0.0.1 ms-dns 77.88.8.1 proxyarp nodefaultroute lock nobsdcomp</code> </pre></div></div></li><li>  Agregar credenciales a <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / ppp / chap-secrets</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># Secrets for authentication using CHAP # client server secret IP addresses username pptpd password *</code> </pre> </div></div></li><li>  A√±adir a <br><br><div class="spoiler">  <b class="spoiler_title">/etc/sysctl.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">net.ipv4.ip_forward=1</code> </pre> </div></div><br>  y volver a cargar sysctl <br><br><pre> <code class="bash hljs">sudo sysctl -p</code> </pre> </li><li>  Reinicie pptpd y agr√©guelo al inicio <br><br><pre> <code class="bash hljs">sudo service pptpd restart sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> pptpd</code> </pre> </li><li>  Correcto <br><br><div class="spoiler">  <b class="spoiler_title">iptables</b> <div class="spoiler_text"><pre> <code class="bash hljs">sudo iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT sudo iptables -A INPUT -p tcp -m tcp --dport 1723 -j ACCEPT sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE sudo iptables --table nat --append POSTROUTING --out-interface ppp+ -j MASQUERADE sudo iptables -I INPUT -s 10.0.5.0/24 -i ppp+ -j ACCEPT sudo iptables --append FORWARD --<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface eth0 -j ACCEPT</code> </pre> </div></div><br>  Y guardar <br><br><pre> <code class="bash hljs">sudo netfilter-persistent save sudo netfilter-persistent reload</code> </pre></li></ul></li><li>  Configurar TP-LINK 2 <ul><li>  Reservamos la direcci√≥n 192.168.0.200 para nuestra c√°mara: <br><br><div class="spoiler">  <b class="spoiler_title">DHCP -&gt; Reserva de direcci√≥n</b> <div class="spoiler_text">  - Direcci√≥n MAC - Las c√°maras MAC, se pueden ver en DHCP -&gt; Lista de clientes DHCP <br>  - Direcci√≥n IP reservada - 192.168.0.200 </div></div></li><li>  Reenviamos puertos: <br><div class="spoiler">  <b class="spoiler_title">Reenv√≠o -&gt; Servidores virtuales</b> <div class="spoiler_text">  - Puerto de servicio: 49151, Puerto interno: 80, direcci√≥n IP: 192.168.0.200, Protocolo: TCP <br>  - Puerto de servicio: 49152, Puerto interno: 34567, Direcci√≥n IP: 192.168.0.200, Protocolo: TCP <br>  - Puerto de servicio: 49153, Puerto interno: 554, Direcci√≥n IP: 192.168.0.200, Protocolo: TCP <br></div></div></li><li>  Configurar conexi√≥n VPN: <br><br><div class="spoiler">  <b class="spoiler_title">Red -&gt; WAN</b> <div class="spoiler_text">  - Tipo de conexi√≥n WAN: PPTP <br>  - Nombre de usuario: nombre de usuario (ver / etc / ppp / chap-secrets) <br>  - Contrase√±a: contrase√±a (ver / etc / ppp / chap-secrets) <br>  - Confirmar contrase√±a: contrase√±a (ver / etc / ppp / chap-secrets) <br>  - IP din√°mica <br>  - Direcci√≥n IP / Nombre del servidor: 169.178.59.82 (obviamente, la IP externa de su servidor) <br>  - Modo de conexi√≥n: conectar autom√°ticamente <br></div></div></li><li>  Opcionalmente, permita el acceso remoto al enrutador webmord <br><div class="spoiler">  <b class="spoiler_title">Seguridad -&gt; Gesti√≥n remota</b> <div class="spoiler_text">  - Puerto de gesti√≥n web: 80 <br>  - Direcci√≥n IP de control remoto: 255.255.255.255 </div></div></li><li>  Reiniciar el enrutador TP-LINK 2 </li></ul></li></ul><br><br>  <i>En lugar de PPTP, puede usar L2TP o, si tiene un firmware personalizado, todo lo que su coraz√≥n desee.</i>  <i>Eleg√≠ PPTP, porque este esquema fue construido no por razones de seguridad, pero pptpd en mi experiencia es el servidor VPN m√°s r√°pido.</i>  <i>Adem√°s, realmente no quer√≠a instalar firmware personalizado, lo que significa que ten√≠a que elegir entre PPTP y L2TP.</i> <br><br>  Si no comet√≠ un error en la gu√≠a en ning√∫n lado, e hiciste todo bien y tuviste suerte, entonces despu√©s de todas estas manipulaciones <ul><li>  en primer lugar <br><br><pre> <code class="bash hljs">ifconfig</code> </pre> <br>  mostrar√° la interfaz <code>ppp0 inet 10.0.5.1 netmask 255.255.255.255 destination 10.0.5.100</code> , </li><li>  segundo 10.0.5.100 deber√≠a responder, </li><li>  y en tercer lugar <br><br><pre> <code class="bash hljs">ffprobe -rtsp_transport tcp <span class="hljs-string"><span class="hljs-string">"rtsp://10.0.5.100:49153/user=admin&amp;password=password&amp;channel=1&amp;stream=0.sdp"</span></span></code> </pre> <br>  Debe detectar la secuencia. <br>  <i>puerto rtsp, nombre de usuario y contrase√±a que puede encontrar en la documentaci√≥n de su c√°mara</i> <br></li></ul><br><br><h3>  Conclusi√≥n </h3><br>  En principio, ya no est√° mal, hay acceso a RTSP, si el software propietario funciona a trav√©s de DVRIP, puede usarlo.  Puede guardar la transmisi√≥n usando ffmpeg, acelerar el video 2-3-5 veces, dividirlo en partes por hora, subirlo a Google o redes sociales y mucho, mucho m√°s. <br><br>  No me gustaba RTSP sobre TCP, porque de alguna manera no funcionaba muy estable, pero sobre UDP, por la raz√≥n de que no podemos (o puedo, pero no quiero hacer esto) reenviar el rango de puertos en los que RTSP empujar√° la transmisi√≥n de video , No puedo usarlo, escrib√≠ un script que arrastra una transmisi√≥n a trav√©s de TCP a trav√©s de DVRIP.  Result√≥ ser m√°s estable. <br><br>  De las ventajas del enfoque: podemos tomar algo que admita el silbato 4G en lugar del enrutador TP-LINK 2, alimentarlo todo junto con la c√°mara desde el UPS (que sin duda se requerir√° mucho menos capacidad que cuando se usa la grabadora), adem√°s, la grabaci√≥n se transmite casi instant√°neamente al servidor, por lo que incluso si los intrusos lo penetran, no podr√°n eliminar el video.  En general, hay margen de maniobra y todo depende de su imaginaci√≥n. <br><br>  PD: S√© que muchos fabricantes ofrecen soluciones en la nube listas para usar, pero cuestan casi el doble que el precio de mi fuerza a√©rea (de la cual ya tengo 3, as√≠ que necesito poner recursos en alg√∫n lugar), proporcionan mucho menos control y tambi√©n Calidad muy satisfactoria. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482864/">https://habr.com/ru/post/482864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482852/index.html">La era del audio compacto: c√≥mo llegaron las cintas a los autom√≥viles</a></li>
<li><a href="../482856/index.html">Extra√±o Divino</a></li>
<li><a href="../482858/index.html">Sensores de ventana inal√°mbricos caseros: STM32L051 + RFM69 + Android</a></li>
<li><a href="../482860/index.html">Fui jefe de relaciones internacionales en Google. Por eso me fui</a></li>
<li><a href="../482862/index.html">¬øHay un GameDev en Sakhalin? 1.V</a></li>
<li><a href="../482866/index.html">¬øVale la pena comprar Bitcoin el pr√≥ximo a√±o y cu√°nto costar√°?</a></li>
<li><a href="../482870/index.html">C√≥mo compr√© una computadora port√°til bloqueada en eBay y trat√© de hacer mi AntiTheft basado en IntelAMT</a></li>
<li><a href="../482872/index.html">Pol√≠gonos otro mundo</a></li>
<li><a href="../482874/index.html">La muerte de Koshchei en la lista de recomendaciones (¬øpuedes hacer que YouTube sea c√≥modo y seguro?)</a></li>
<li><a href="../482876/index.html">C√°lculo del costo de producci√≥n de electricidad solar para las necesidades propias de un hogar en el centro de Europa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>