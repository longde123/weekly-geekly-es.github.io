<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ›¸ ğŸµ ğŸ¸ æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯ä»¥è¿›è¡Œæ—¥å¿—è®°å½• ğŸ•¸ï¸ ğŸ”‘ ğŸ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é€šå¸¸ï¼Œæ‚¨éœ€è¦åœ¨æ—¥å¿—ä¸­å†™å…¥å…¶ä»–ä¿¡æ¯ï¼Œä»¥æ¾„æ¸…æƒ…å†µå¹¶è¿›ä¸€æ­¥ç®€åŒ–åº”ç”¨ç¨‹åºçš„è°ƒè¯•ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœè®°å½•äº†é”™è¯¯ä¿¡æ¯ï¼Œæœ€å¥½ä¹Ÿä»¥æŸç§å½¢å¼ä¿å­˜è¾“å…¥æ•°æ®ï¼Œä»¥ä¾¿æ›´è½»æ¾åœ°é‡ç°é—®é¢˜ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³æè¿°ä¸€ç§å…è®¸æ‚¨æ”¶é›†è¿™äº›é™„åŠ ä¿¡æ¯çš„æ–¹æ³•ã€‚ 
 é—®é¢˜é™ˆè¿° 


 å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªASP.NET MVC WeæœåŠ¡ã€‚ å®ƒæ¥å—POSTè¯·æ±‚ï¼Œå…¶...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯ä»¥è¿›è¡Œæ—¥å¿—è®°å½•</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416751/"><p> é€šå¸¸ï¼Œæ‚¨éœ€è¦åœ¨æ—¥å¿—ä¸­å†™å…¥å…¶ä»–ä¿¡æ¯ï¼Œä»¥æ¾„æ¸…æƒ…å†µå¹¶è¿›ä¸€æ­¥ç®€åŒ–åº”ç”¨ç¨‹åºçš„è°ƒè¯•ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœè®°å½•äº†é”™è¯¯ä¿¡æ¯ï¼Œæœ€å¥½ä¹Ÿä»¥æŸç§å½¢å¼ä¿å­˜è¾“å…¥æ•°æ®ï¼Œä»¥ä¾¿æ›´è½»æ¾åœ°é‡ç°é—®é¢˜ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³æè¿°ä¸€ç§å…è®¸æ‚¨æ”¶é›†è¿™äº›é™„åŠ ä¿¡æ¯çš„æ–¹æ³•ã€‚ </p><a name="habracut"></a><br><h2 id="postanovka-zadachi"> é—®é¢˜é™ˆè¿° </h2><br><p> å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªASP.NET MVC WeæœåŠ¡ã€‚ å®ƒæ¥å—POSTè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«éœ€è¦ä»¥JSONæ ¼å¼è¿›è¡Œæè¿°çš„å†…å®¹ã€‚ åœ¨åˆ†æäº†è¿™æ ·çš„æè¿°ä¹‹åï¼Œè¯¥æœåŠ¡å°†åˆ›å»ºå¹¶æ‰§è¡Œå‡ ä¸ªå¯¹æ•°æ®åº“çš„SQLæŸ¥è¯¢ã€‚ ç„¶åï¼Œä»–åˆå¹¶ç»“æœå¹¶å°†å…¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚ </p><br><p>å¿…é¡»è¯´ï¼Œè¯¥æœåŠ¡é€šè¿‡<em>async / await</em>å’Œ<code>Task</code>å¹¿æ³›ä½¿ç”¨äº†å¼‚æ­¥å’Œå¤šçº¿ç¨‹ã€‚ </p><br><p> ç°åœ¨æˆ‘ä»¬äº†è§£äº†æˆ‘ä»¬è¦å¤„ç†çš„å†…å®¹ï¼Œè®©æˆ‘ä»¬ç»§ç»­è§£å†³é—®é¢˜ã€‚ </p><br><h2 id="sbor-kontekstnoy-informacii-ob-oshibkah"> æ”¶é›†ä¸Šä¸‹æ–‡é”™è¯¯ä¿¡æ¯ </h2><br><p> æœ‰æ—¶æˆ‘ä»¬çš„æœåŠ¡ä¼šå‡ºé”™ã€‚ åŸå› å¯èƒ½ä¸åŒï¼šé”™è¯¯çš„JSONè¾“å…¥ï¼Œä»£ç ä¸­çš„é”™è¯¯ï¼Œæ•°æ®åº“é—®é¢˜...åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å°†é”™è¯¯ä¿¡æ¯å†™å…¥æ—¥å¿—ã€‚ </p><br><p> è®°å½•å¼‚å¸¸æœ¬èº«æ²¡æœ‰é—®é¢˜ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å™¨çš„actionæ–¹æ³•ä¸­æ•è·å®ƒï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServiceController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">"api/service"</span></span>)] [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Logger.LogError(ex); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } }</code> </pre> <br><p> æˆ–è€…æˆ‘ä»¬å¯ä»¥ä¸ºæ­¤åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„å±æ€§ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogErrorAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionExecutedContext actionExecutedContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(actionExecutedContext); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (actionExecutedContext.Exception != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Logger.LogError(actionExecutedContext.Exception); } } }</code> </pre> <br><p> å¹¶åœ¨actionæ–¹æ³•ä¸Šä½¿ç”¨å®ƒï¼š </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"api/service"</span></span></span><span class="hljs-meta">)</span></span>] [HttpPost] [LogError] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { ... }</code> </pre> <br><p> ä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦æ›´å¤šã€‚ å¯¹äºæ¯ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬è¦å­˜å‚¨å…¶ä»–ä¿¡æ¯ï¼š </p><br><ul><li> è¯·æ±‚çš„JSONæ­£æ–‡çš„æ–‡æœ¬ã€‚ </li><li> æ‰€æœ‰ç”Ÿæˆçš„SQLæŸ¥è¯¢çš„æ–‡æœ¬ã€‚ </li></ul><br><p> è¿˜æœ‰å¦ä¸€é¡¹è¦æ±‚ã€‚ ä»…åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ‰åº”åœ¨æ—¥å¿—ä¸­è®°å½•æ­¤é™„åŠ ä¿¡æ¯ã€‚ å¦åˆ™ï¼Œæˆ‘ä»¬åœ¨æ—¥å¿—ä¸­ä¸éœ€è¦å®ƒã€‚ </p><br><p> ä¸ºè¯·æ±‚ä¸»ä½“æ‰§è¡Œæ­¤æ“ä½œå¹¶ä¸å›°éš¾ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServiceController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">"api/service"</span></span>)] [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestText = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Request.Content.ReadAsStringAsync(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Logger.LogError(ex); Logger.LogError(<span class="hljs-string"><span class="hljs-string">$"Request test is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{requestText}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } }</code> </pre> <br><p> ä½†æ˜¯å¯¹äºSQLæŸ¥è¯¢ï¼Œä¸€åˆ‡å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ã€‚ äº‹å®æ˜¯è¿™äº›è¯·æ±‚ä¸æ˜¯ç”±actionæ–¹æ³•ç”Ÿæˆçš„ã€‚ å®ƒä»¬ç”šè‡³ä¸åœ¨æ§åˆ¶å™¨ä¸­ç”Ÿæˆã€‚ åœ¨actionæ–¹æ³•å’Œç”ŸæˆSQLçš„æ–¹æ³•ä¹‹é—´ï¼Œæœ‰è®¸å¤šå¯¹å…¶ä»–ç±»çš„å…¶ä»–æ–¹æ³•çš„è°ƒç”¨ã€‚ åœ¨éœ€è¦æ—¶å¦‚ä½•æå–è¿™äº›è¯·æ±‚çš„æ–‡æœ¬ï¼Ÿ </p><br><p> ä¸€ç§é€‰æ‹©æ˜¯ä½¿ç”¨æ¶ˆæ¯åˆ—è¡¨ï¼ˆä¾‹å¦‚<code>List&lt;string&gt;</code> ï¼‰ã€‚ æˆ‘ä»¬åœ¨æ“ä½œæ–¹æ³•ï¼ˆ <code>ServiceAction</code> ï¼‰ä¸­åˆ›å»ºå®ƒï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ç”ŸæˆSQLçš„æ–¹æ³•ã€‚ åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬å°†SQLæŸ¥è¯¢æ–‡æœ¬æ·»åŠ åˆ°æ­¤åˆ—è¡¨ä¸­ã€‚ ä¸‡ä¸€å‘ç”Ÿé”™è¯¯ï¼Œè¯¥æ“ä½œæ–¹æ³•å°†å…·æœ‰éœ€è¦åœ¨æ—¥å¿—ä¸­æ”¾ç½®çš„æ¶ˆæ¯åˆ—è¡¨ã€‚ </p><br><p> åœ¨æˆ‘çœ‹æ¥ï¼Œæ­¤æ–¹æ³•æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç¼ºç‚¹ã€‚ æˆ‘ä»¬å¿…é¡»åœ¨æ•´ä¸ªæ–¹æ³•è°ƒç”¨é“¾ä¸­ä¼ é€’æ¶ˆæ¯åˆ—è¡¨ï¼Œç›´åˆ°åˆ°è¾¾ç”ŸæˆSQLçš„æ–¹æ³•ä¸ºæ­¢ã€‚ è¿™æ„å‘³ç€åœ¨è®¸å¤šåœ°æ–¹ï¼Œåªéœ€è¦ä¼ é€’æ­¤æ¶ˆæ¯åˆ—è¡¨å³å¯ã€‚ è¿™ä¼šä½¿ä»£ç å˜å¾—å¤æ‚ï¼Œå› æ­¤æˆ‘å°†å°½é‡é¿å…ä½¿ç”¨å®ƒã€‚ </p><br><p> å¦‚æœä½¿ç”¨DIå®¹å™¨å¹¶ä¸”å¯ä»¥ä»ä¸­åˆ›å»ºç±»ï¼Œåˆ™å¯ä»¥å°è¯•å°†æ¶ˆæ¯åˆ—è¡¨ä»¥â€œæ¯ä¸ªè¯·æ±‚â€ç”Ÿå­˜æœŸæ”¾å…¥å®¹å™¨ä¸­ã€‚  SQLç”Ÿæˆç±»å°†æ¥å—æ­¤æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°ã€‚ ç„¶åï¼Œæ­¤ç±»çš„å®ä¾‹å’Œæ§åˆ¶å™¨çš„å®ä¾‹éƒ½å°†èƒ½å¤Ÿè®¿é—®æ¶ˆæ¯åˆ—è¡¨çš„ç›¸åŒå®ä¾‹ã€‚ </p><br><p> ä½†æ˜¯ï¼Œå³ä½¿æ‚¨æ²¡æœ‰ä½¿ç”¨DIå®¹å™¨ï¼Œä¹Ÿæœ‰ä¸€ç§æ›´æ–¹ä¾¿çš„æ–¹æ³•æ¥æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ å¦‚æœæˆ‘ä»¬å¯ä»¥é€šè¿‡é™æ€å±æ€§è®¿é—®æ¶ˆæ¯åˆ—è¡¨ï¼Œé‚£å°±å¤ªå¥½äº†ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;SqlDataReader&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunReaderAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SqlCommand cmd</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-string"><span class="hljs-string">$"SQL Server query is: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{cmd.CommandText}</span></span></span><span class="hljs-string">"</span></span>; ErrorContext.Current.AttachMessage(message); ... }</code> </pre> <br><p> è¿™é‡Œæœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ã€‚ æˆ‘ä»¬çš„æœåŠ¡å¯ä»¥åŒæ—¶æ»¡è¶³å¤šä¸ªè¦æ±‚ã€‚ æ¯ä¸ªæ­¤ç±»è¯·æ±‚éƒ½åº”å…·æœ‰è‡ªå·±çš„æ¶ˆæ¯åˆ—è¡¨ã€‚ è€Œä¸”ï¼Œåœ¨å¤„ç†å•ä¸ªè¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥äº§ç”Ÿå¤šä¸ªçº¿ç¨‹ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨<em>async / await</em> ï¼‰ã€‚ å¹¶ä¸”æ‰€æœ‰è¿™äº›çº¿ç¨‹å¿…é¡»æœ‰æƒè®¿é—®ç›¸åŒçš„æ¶ˆæ¯åˆ—è¡¨ã€‚ å¦‚ä½•å®ç°å‘¢ï¼Ÿ </p><br><p>  <code>AsyncLocal&lt;T&gt;</code>ç±»ä¸ºæˆ‘ä»¬æä¾›äº†å¸®åŠ©ã€‚ å®ƒä¿è¯äº†ï¼Œå¦‚æœæ‚¨å°†æŸä¸ªå€¼æ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹çš„æ­¤ç±»çš„å®ä¾‹ä¸­ï¼Œåˆ™å¯ä»¥åœ¨æ­¤çº¿ç¨‹ä»¥åŠæ­¤åä»è¯¥çº¿ç¨‹å¯åŠ¨çš„æ‰€æœ‰çº¿ç¨‹ä¸­è·å–æ­¤å€¼ã€‚ åŒæ—¶ï¼Œæ‰€æœ‰å…¶ä»–çº¿ç¨‹å°†æ— æ³•è®¿é—®æ­¤å€¼ã€‚ </p><br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>ErrorContext</code>ç±»çš„å®ç°ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ErrorContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Lock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;ErrorContext&gt; CurrentErrorContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;ErrorContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Lazy&lt;ConcurrentBag&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; _attachedMessages = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;ConcurrentBag&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ErrorContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ErrorContext Current { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorContext = CurrentErrorContext.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorContext == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { CurrentErrorContext.Value = errorContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorContext(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errorContext; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ErrorContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateNewErrorContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorContext(); CurrentErrorContext.Value = errorContext; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errorContext; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttachMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(message)) { _attachedMessages.Value.Add(message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IReadOnlyList&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMessages</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _attachedMessages.Value.ToArray(); } }</code> </pre> <br><p>  <code>CreateNewErrorContext</code>æ–¹æ³•ç«‹å³åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨<code>AsyncLocal</code>ç±»å‹çš„<code>CurrentErrorContext</code>å­—æ®µä¸­ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨é™æ€å±æ€§<code>Current</code>åœ¨ä»£ç ä¸­çš„ä»»ä½•ä½ç½®è®¿é—®å½“å‰åˆ—è¡¨ã€‚  <code>AttachMessage</code>æ–¹æ³•å°†<code>AttachMessage</code>æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ å®ƒå°†æ¶ˆæ¯å­˜å‚¨åœ¨<code>ConcurrentBag</code>å®ä¾‹ä¸­ï¼Œå› ä¸ºå¯ä»¥åŒæ—¶ä»å¤šä¸ªçº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•ã€‚  <code>GetMessages</code>æ–¹æ³•è¿”å›æ‰€æœ‰å·²ä¿å­˜çš„æ¶ˆæ¯ï¼Œä»¥ä¾¿å¯ä»¥å°†å®ƒä»¬å†™å…¥æ—¥å¿—ã€‚ </p><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°åˆå§‹åŒ–å’Œä½¿ç”¨<code>LogErrorAttribute</code>å†…çš„<code>ErrorContext</code> ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogErrorAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionContext actionContext</span></span></span><span class="hljs-function">)</span></span> { ErrorContext.CreateNewErrorContext(); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuting(actionContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionExecutedContext actionExecutedContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(actionExecutedContext); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (actionExecutedContext.Exception != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ErrorContext.Current.GetMessages()) { Logger.LogError(message); } Logger.LogError(actionExecutedContext.Exception); } } }</code> </pre> <br><p> æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­çš„ä»»ä½•ä½ç½®ï¼Œå°†æ¶ˆæ¯æ·»åŠ åˆ°å½“å‰é”™è¯¯ä¸Šä¸‹æ–‡ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="cs hljs">ErrorContext.Current.AttachMessage(message);</code> </pre> <br><h2 id="logirovanie-problem-s-proizvoditelnostyu"> æ€§èƒ½è®°å½• </h2><br><p> æœ‰æ—¶æˆ‘çš„æœåŠ¡å¾ˆæ…¢ã€‚ å¹¶éæ‰€æœ‰æŸ¥è¯¢éƒ½éœ€è¦èŠ±å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆã€‚ æˆ‘æƒ³ä¿ç•™æœ‰å…³æ­¤ç±»è¯·æ±‚çš„ä¿¡æ¯ï¼Œä»¥ä¾¿ä»¥åè¿›è¡Œåˆ†æã€‚ å¦‚ä½•å®æ–½ï¼Œæˆ‘ä»¬éœ€è¦ä»€ä¹ˆä¿¡æ¯ï¼Ÿ </p><br><p> é¦–å…ˆï¼Œæˆ‘éœ€è¦ä¸€äº›è¿è¡Œæ—¶é˜ˆå€¼ã€‚ å¦‚æœå¤„ç†è¯¥è¯·æ±‚èŠ±è´¹çš„æ—¶é—´è¾ƒå°‘ï¼Œåˆ™ä¸€åˆ‡æ­£å¸¸ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä¸ä¼šåœ¨æ—¥å¿—ä¸­å†™å…¥ä»»ä½•å†…å®¹ã€‚ ä½†æ˜¯ï¼Œå¦‚æœéœ€è¦æ›´å¤šæ—¶é—´ï¼Œåˆ™å¿…é¡»åœ¨æ—¥å¿—ä¸­æ·»åŠ ä¸€äº›ä¿¡æ¯ã€‚ </p><br><p> æˆ‘éœ€è¦ä»€ä¹ˆä¿¡æ¯ï¼Ÿ æ‚¨ç»å¯¹éœ€è¦çŸ¥é“è¯·æ±‚å¤„ç†èŠ±è´¹äº†å¤šé•¿æ—¶é—´ã€‚ ä½†è¿™è¿˜ä¸å¤Ÿã€‚ æˆ‘çš„æœåŠ¡åšäº†å¾ˆå¤šäº‹æƒ…ï¼šæ£€æŸ¥æŸ¥è¯¢å‚æ•°ï¼Œä»å…¶ä»–æœåŠ¡è·å–æ•°æ®ï¼Œæ„å»ºSQLæŸ¥è¯¢å¹¶æ‰§è¡Œå®ƒä»¬â€¦â€¦æˆ‘éœ€è¦çŸ¥é“æ¯ä¸ªè¿™æ ·çš„éƒ¨åˆ†èŠ±äº†å¤šå°‘æ—¶é—´æ¥äº†è§£é—®é¢˜çš„éšè—ä½ç½®ã€‚ </p><br><p> å¦å¤–ï¼Œæˆ‘éœ€è¦ä¸é”™è¯¯ç›¸åŒçš„ä¿¡æ¯ã€‚ æˆ‘éœ€è¦ä¸€ä¸ªè¯·æ±‚æ­£æ–‡ï¼Œä»¥ä¾¿èƒ½å¤Ÿé‡ç°è¯¥é—®é¢˜ã€‚ æˆ‘éœ€è¦SQLæŸ¥è¯¢çš„æ–‡æœ¬ï¼Œä»¥é˜²å®ƒä»¬èŠ±è´¹æœ€é•¿çš„æ—¶é—´ã€‚ </p><br><p> å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ åŒæ ·ï¼Œä½¿ç”¨<code>AsyncLocal</code>ç±»ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Timer</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Lock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;Timer&gt; CurrentTimer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;Timer&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Stopwatch _stopwatch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Lazy&lt;ConcurrentQueue&lt;Timer&gt;&gt; _attachedTimers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;ConcurrentQueue&lt;Timer&gt;&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentQueue&lt;Timer&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Lazy&lt;ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; _attachedMessages = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _description; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TimeSpan? _threshold; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Timer _previousCurrent; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _isDisposed; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _suspendLogging; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Timer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Timer previousCurrent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, TimeSpan? threshold = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { _previousCurrent = previousCurrent; _description = description; _threshold = threshold; _stopwatch.Start(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Timer Current { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timer = CurrentTimer.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timer == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { CurrentTimer.Value = timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Timer(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> timer; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Timer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCurrentTimer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description, TimeSpan? threshold = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTimer = CurrentTimer.Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Timer(currentTimer, description, threshold); CurrentTimer.Value = timer; currentTimer?._attachedTimers.Value.Enqueue(timer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> timer; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttachMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(message)) { _attachedMessages.Value.Enqueue(message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_isDisposed) { _isDisposed = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _stopwatch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_attachedTimers.IsValueCreated) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attachedTimer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _attachedTimers.Value) { attachedTimer.Dispose(); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_suspendLogging &amp;&amp; _threshold.HasValue &amp;&amp; _stopwatch.Elapsed &gt; _threshold.Value) { Log(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_previousCurrent != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { CurrentTimer.Value = _previousCurrent; } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> JObject Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">$"It took </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_stopwatch.ElapsedMilliseconds}</span></span></span><span class="hljs-string"> ms to execute </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_description}</span></span></span><span class="hljs-string">."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_threshold.HasValue) { message.Append(<span class="hljs-string"><span class="hljs-string">$" Duration threshold is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_threshold.Value.TotalMilliseconds}</span></span></span><span class="hljs-string"> ms."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JObject { [<span class="hljs-string"><span class="hljs-string">"message"</span></span>] = message.ToString(), }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_attachedTimers.IsValueCreated &amp;&amp; _attachedTimers.Value.Any()) { messageObj[<span class="hljs-string"><span class="hljs-string">"attachedTimers"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JArray(_attachedTimers.Value.Select(t =&gt; t.Message)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_attachedMessages.IsValueCreated &amp;&amp; _attachedMessages.Value.Any()) { messageObj[<span class="hljs-string"><span class="hljs-string">"attachedMessages"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JArray(_attachedMessages.Value); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> messageObj; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _suspendLogging = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_stopwatch.Elapsed &lt; _threshold) { Logger.LogDebug(Message.ToString()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Logger.LogWarning(Message.ToString()); } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _suspendLogging = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> </pre> <br><p> è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚  <code>SetCurrentTimer</code>æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„è®¡æ—¶å™¨ã€‚ æ‚¨å¯ä»¥åœ¨æ­¤å¤„æŒ‡å®šå…¶æè¿°å’Œå¯é€‰çš„è¿è¡Œæ—¶é˜ˆå€¼ã€‚ </p><br><p> ä¸ºä»€ä¹ˆæ­¤é˜ˆå€¼æ˜¯å¯é€‰çš„ï¼Ÿ æœ‰æ—¶æˆ‘éœ€è¦éƒ¨åˆ†ä»£ç æ‰èƒ½è¿è¡Œä¸è¶…è¿‡ä¸€å®šæ—¶é—´ã€‚ å› æ­¤ï¼Œæˆ‘å¸Œæœ›æ•´ä¸ªæœåŠ¡è¯·æ±‚åœ¨3ç§’å†…å¾—åˆ°å¤„ç†ã€‚ åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œæˆ‘ä¸æƒ³å¯¹è¿è¡Œæ—¶æ–½åŠ é™åˆ¶ã€‚ ä¾‹å¦‚ï¼Œå¯¹æˆ‘è€Œè¨€ï¼Œæ‰§è¡Œæˆ‘çš„SQLæŸ¥è¯¢å¤šé•¿æ—¶é—´ï¼ˆä¸åˆ°3ç§’ï¼‰å³å¯å¤„ç†æ•´ä¸ªæœåŠ¡è¯·æ±‚æ— å…³ç´§è¦ã€‚ å› æ­¤ï¼Œå¯¹äºæŸäº›è®¡æ—¶å™¨ï¼Œéœ€è¦è®¾ç½®è¿è¡Œæ—¶é˜ˆå€¼ï¼Œè€Œå¯¹äºå…¶ä»–è®¡æ—¶å™¨åˆ™ä¸éœ€è¦ã€‚ </p><br><p> åœ¨<code>SetCurrentTimer</code>æ–¹æ³•å†…éƒ¨ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°è®¡æ—¶å™¨ï¼Œå¹¶å°†å…¶æ”¾å…¥<code>AsyncLocal</code>ç±»å‹çš„<code>CurrentTimer</code>å˜é‡ä¸­ã€‚ ä½†è¿™è¿˜ä¸æ˜¯å…¨éƒ¨ã€‚ æ­¤æ—¶ï¼Œå¯èƒ½å·²ç»å­˜åœ¨å¦ä¸€ä¸ªæ´»åŠ¨è®¡æ—¶å™¨ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨åˆšåˆšåˆ›å»ºçš„æ–°è®¡æ—¶å™¨å°†åŠ å…¥ç°æœ‰è®¡æ—¶å™¨ã€‚ è¿™ä½¿æ‚¨å¯ä»¥åˆ›å»ºåµŒå¥—è®¡æ—¶å™¨ï¼Œä»¥æµ‹é‡æ•´ä¸ªä»£ç å—åŠå…¶å„éƒ¨åˆ†çš„æ‰§è¡Œæ—¶é—´ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Timer.SetCurrentTimer(<span class="hljs-string"><span class="hljs-string">"The whole block"</span></span>)) { ... <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Timer.SetCurrentTimer(<span class="hljs-string"><span class="hljs-string">"Part 1"</span></span>)) { ... } ... <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Timer.SetCurrentTimer(<span class="hljs-string"><span class="hljs-string">"Part 2"</span></span>)) { ... } ... }</code> </pre> <br><p>  <code>Current</code>å±æ€§æä¾›å¯¹å½“å‰è®¡æ—¶å™¨çš„è®¿é—®ã€‚ å¦‚æœè¦å‘å…¶ä¸­æ·»åŠ ä¸€äº›æ¶ˆæ¯ï¼Œè¿™å°†å¾ˆæœ‰ç”¨ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-string"><span class="hljs-string">$"SQL Server query is: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{cmd.CommandText}</span></span></span><span class="hljs-string">"</span></span>; Timer.Current.AttachMessage(message);</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œé™„åŠ æ¶ˆæ¯å’ŒåµŒå¥—è®¡æ—¶å™¨å­˜å‚¨åœ¨<code>ConcurrentQueue</code>å®ä¾‹ä¸­ï¼Œå› ä¸ºå®ƒä»¬çš„é¡ºåºå¯èƒ½å¾ˆé‡è¦ã€‚ </p><br><p>  <code>Message</code>å±æ€§è¿”å›ä»å•ä¸ªå•å…ƒä¸­æ”¶é›†çš„å½“å‰æ¶ˆæ¯ä»¥åŠæ‰€æœ‰å †ç§¯åœ¨å…¶ä¸­çš„æ‰€æœ‰è®¡æ—¶å™¨çš„æ¶ˆæ¯ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JSON.NET</a>åº“ä¸­çš„JSONç±»æ¥æ„é€ æ‰€æœ‰æ¶ˆæ¯ã€‚ ä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ ¼å¼ã€‚ </p><br><p>  <code>Log</code>æ–¹æ³•å°†è®¡æ—¶å™¨ä¸­å­˜å‚¨çš„ä¿¡æ¯å†™å…¥æ—¥å¿—ï¼Œè€Œä¸ç®¡æ˜¯å¦å·²è®¾ç½®è¿è¡Œæ—¶é˜ˆå€¼ã€‚ åŒæ—¶ï¼Œä»…å½“è¶…è¿‡è®¾ç½®çš„è¿è¡Œæ—¶é˜ˆå€¼æ—¶ï¼Œ <code>Dispose</code>æ–¹æ³•æ‰ä¼šå°†ä¿¡æ¯å†™å…¥æ—¥å¿—ã€‚ </p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ§åˆ¶å™¨çš„æ–¹æ³•åˆ›å»ºå¦ä¸€ä¸ªå±æ€§ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TimerContextAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _timerDescription; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _durationThresholdMs; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;Timer&gt; _timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;Timer&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimerContextAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timerDescription, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> durationThresholdMs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(timerDescription)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(timerDescription)); _timerDescription = timerDescription; _durationThresholdMs = durationThresholdMs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionContext actionContext</span></span></span><span class="hljs-function">)</span></span> { _timer.Value = Timer.SetCurrentTimer(_timerDescription, TimeSpan.FromMilliseconds(_durationThresholdMs)); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuting(actionContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionExecutedContext actionExecutedContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(actionExecutedContext); _timer.Value?.Dispose(); } }</code> </pre> <br><p> å¹¶å°†å…¶ç”¨äºè¿™æ ·çš„æ“ä½œæ–¹æ³•ï¼š </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"api/service"</span></span></span><span class="hljs-meta">)</span></span>] [HttpPost] [TimerContext(<span class="hljs-string"><span class="hljs-string">"For ServiceAction method"</span></span>, <span class="hljs-number"><span class="hljs-number">3000</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { ... }</code> </pre> <br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æè¿°äº†ä»ä»£ç ä¸­çš„è®¸å¤šåœ°æ–¹æ”¶é›†ä¿¡æ¯å¹¶åœ¨ä»¥åè®¿é—®å®ƒæ˜¯å¤šä¹ˆç®€å•ã€‚ å¯ä»¥ä½¿ç”¨æ“çºµ<code>AsyncLocal</code>ç±»çš„å®ä¾‹çš„é™æ€å±æ€§å’Œæ–¹æ³•æ¥å®ç°è¿™ç§åŠŸèƒ½ã€‚ </p><br><p> æˆ‘å¸Œæœ›æœ¬æ–‡å¯¹æ”¹è¿›åº”ç”¨ç¨‹åºä¸­çš„æ—¥å¿—è®°å½•ç³»ç»Ÿæœ‰ç”¨ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN416751/">https://habr.com/ru/post/zh-CN416751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN416737/index.html">Voxel 3d Unityæ¸¸æˆä¸­çš„*è·¯å¾„æŸ¥æ‰¾ç®—æ³•</a></li>
<li><a href="../zh-CN416739/index.html">å…¨æ–°ASUSåœ¨Computex 2018ä¸Š</a></li>
<li><a href="../zh-CN416741/index.html">æ”»å‡»è€…åœ¨å…¶å¯†ç ç›—çªƒè½¯ä»¶ä¸­ä½¿ç”¨äº†è¢«ç›—çš„D-Linkè¯ä¹¦</a></li>
<li><a href="../zh-CN416743/index.html">Bot for Rustï¼ŒCå’Œä»»ä½•å…¶ä»–è¯­è¨€çš„ã€Šæ˜Ÿé™…äº‰éœ¸ã€‹</a></li>
<li><a href="../zh-CN416745/index.html">2018å¹´Computexä¸Šçš„æ–°ASUS ROG</a></li>
<li><a href="../zh-CN416753/index.html">æµè¡Œçš„Hola VPNæ’ä»¶é­åˆ°å…¥ä¾µ</a></li>
<li><a href="../zh-CN416755/index.html">æç«¯å–œæ¬¢-åå¯¹è°ƒæŸ¥å§”å‘˜ä¼š</a></li>
<li><a href="../zh-CN416757/index.html">ç‰‡çŠ¶æµ‹è¯•</a></li>
<li><a href="../zh-CN416759/index.html">ä¸ºä»€ä¹ˆäººå·¥æ™ºèƒ½ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜</a></li>
<li><a href="../zh-CN416761/index.html">å®‡å®™è¯­è¨€ï¼Œç¬¬1éƒ¨åˆ†ï¼šé€šç”¨è¯­æ³•æ˜¯å¦é€šç”¨ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>