<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèæ üëµüèΩ üëª Kami mempercepat OpenVPN pada router Openwrt. Versi alternatif tanpa menyolder besi dan ekstremisme keras üëΩ ü§ü üéÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo semuanya, saya baru-baru ini membaca artikel lama tentang cara mempercepat OpenVPN pada router, mentransfer enkripsi ke perangkat keras terpisah,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kami mempercepat OpenVPN pada router Openwrt. Versi alternatif tanpa menyolder besi dan ekstremisme keras</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485876/"><img src="https://habrastorage.org/webt/ua/za/wl/uazawliq9mctkaeu0sra7g-_y8y.jpeg"><br><br>  Halo semuanya, saya baru-baru ini membaca <a href="https://habr.com/ru/post/368735/">artikel lama</a> tentang cara mempercepat OpenVPN pada router, mentransfer enkripsi ke perangkat keras terpisah, yang disolder di dalam router itu sendiri.  Saya memiliki kasus serupa dengan penulis - TP-Link WDR3500 dengan 128 megabyte RAM dan prosesor yang buruk yang tidak dapat mengatasi enkripsi terowongan.  Namun, saya pasti tidak ingin naik ke router dengan besi solder.  Di bawah potongan, pengalaman saya memindahkan OpenVPN ke perangkat keras terpisah dengan redundansi pada router jika terjadi kecelakaan. <br><a name="habracut"></a><br><h3>  Tantangan </h3><br>  Ada router TP-Link WDR3500 dan Orange Pi Zero H2.  Kami ingin Orange Pi untuk menangani enkripsi terowongan dalam mode normal, dan jika terjadi sesuatu, pemrosesan VPN akan kembali ke router.  Semua pengaturan firewall pada router harus berfungsi seperti sebelumnya.  Secara umum, secara umum, penambahan perangkat keras tambahan harus transparan dan tidak terlihat untuk semua orang.  OpenVPN berfungsi melalui TCP, adaptor TAP dalam mode jembatan (server-jembatan). <br><br><h3>  Solusi </h3><br>  Alih-alih terhubung melalui USB, saya memutuskan untuk menghabiskan satu port router dan mendapatkan semua subnet yang memiliki jembatan VPN di atasnya pada Orange Pi.  Ternyata potongan besi secara fisik akan menggantung di jaringan yang sama dengan server VPN pada router.  Setelah itu, kami menaikkan server yang sama persis ke Orange Pi, dan mengonfigurasi beberapa jenis proksi di router sehingga mengirimkan semua koneksi yang masuk ke server eksternal, dan jika Orange Pi mati atau tidak tersedia, maka ke server fallback internal.  Saya mengambil HAProxy. <br><br>  Ternyata seperti ini: <br><br><ol><li>  Pelanggan datang </li><li>  Jika server eksternal tidak tersedia - seperti sebelumnya, koneksi masuk ke server internal </li><li>  Jika tersedia, klien menerima Orange Pi </li><li>  VPN pada Orange Pi mendekripsi paket dan meludahkannya kembali ke router </li><li>  Router sedang merutekannya di suatu tempat </li></ol><br><h3>  Contoh implementasi </h3><br>  Jadi, mari kita memiliki dua jaringan pada router - main (1) dan guest (2), untuk masing-masingnya ada server OpenVPN untuk menghubungkan dari luar. <br><br><h4>  Konfigurasi jaringan </h4><br>  Kami perlu meneruskan kedua jaringan melalui satu port, oleh karena itu kami membuat 2 VLAN'a. <br><br>  Pada router di bagian Network / Switch, buat VLAN (misalnya, 1 dan 2) dan aktifkan dalam mode tag pada port yang diinginkan, tambahkan eth0.1 yang baru dibuat dan eth0.2 ke jaringan yang sesuai (misalnya, tambahkan ke brigde). <br><br>  Kami membuat dua antarmuka VLAN di Orange Pi (Saya punya Archlinux ARM + netctl): <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / vlan-main</b> <div class="spoiler_text"><pre><code class="plaintext hljs">Description='Main VLAN on eth0' Interface=vlan-main Connection=vlan BindsToInterfaces=eth0 VLANID=1 IP=no</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / vlan-guest</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Description='Guest VLAN on eth0' Interface=vlan-guest Connection=vlan BindsToInterfaces=eth0 VLANID=2 IP=no</code> </pre></div></div><br>  Dan kami segera membuat dua jembatan untuk mereka: <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / br-main</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Description="Main Bridge connection" Interface=br-main Connection=bridge BindsToInterfaces=(vlan-main) IP=dhcp</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / br-guest</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Description="Guest Bridge connection" Interface=br-guest Connection=bridge BindsToInterfaces=(vlan-guest) IP=dhcp</code> </pre></div></div><br>  Kami mengaktifkan autostart pada semua 4 profil (mengaktifkan netctl).  Sekarang, setelah reboot, Orange Pi akan menggantung di dua jaringan yang diperlukan.  Alamat antarmuka pada Orange Pi dikonfigurasi dalam Sewa Statis pada router. <br><br><div class="spoiler">  <b class="spoiler_title">ip addr show</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">4: vlan-main@eth0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-main state UP group default qlen 1000 link/ether 02:42:f0:f8:23:c8 brd ff:ff:ff:ff:ff:ff inet6 fe80::42:f0ff:fef8:23c8/64 scope link valid_lft forever preferred_lft forever 5: vlan-guest@eth0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-guest state UP group default qlen 1000 link/ether 02:42:f0:f8:23:c8 brd ff:ff:ff:ff:ff:ff inet6 fe80::42:f0ff:fef8:23c8/64 scope link valid_lft forever preferred_lft forever 6: br-main: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether 52:c7:0f:89:71:6e brd ff:ff:ff:ff:ff:ff inet 192.168.1.3/24 brd 192.168.1.255 scope global dynamic noprefixroute br-main valid_lft 29379sec preferred_lft 21439sec inet6 fe80::50c7:fff:fe89:716e/64 scope link valid_lft forever preferred_lft forever 7: br-guest: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether ee:ea:19:31:34:32 brd ff:ff:ff:ff:ff:ff inet 192.168.2.3/24 brd 192.168.2.255 scope global br-guest valid_lft forever preferred_lft forever inet6 fe80::ecea:19ff:fe31:3432/64 scope link valid_lft forever preferred_lft forever</code> </pre></div></div><br><h4>  Penyiapan VPN </h4><br>  Selanjutnya, salin pengaturan untuk OpenVPN dan kunci dari router.  Pengaturan biasanya dapat ditemukan di <i>/tmp/etc/openvpn*.conf</i> <br><br>  Secara default, openvpn berjalan dalam mode TAP dan server-bridge membuat antarmuka tidak aktif.  Untuk membuatnya berfungsi, Anda perlu menambahkan skrip yang berjalan saat koneksi diaktifkan. <br><br><div class="spoiler">  <b class="spoiler_title">/etc/openvpn/main.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">dev vpn-main dev-type tap client-to-client persist-key persist-tun ca /etc/openvpn/main/ca.crt cert /etc/openvpn/main/main.crt cipher AES-256-CBC comp-lzo yes dh /etc/openvpn/main/dh2048.pem ifconfig-pool-persist /etc/openvpn/ipp_main.txt keepalive 10 60 key /etc/openvpn/main/main.key port 443 proto tcp push "redirect-gateway" push "dhcp-option DNS 192.168.1.1" server-bridge 192.168.1.3 255.255.255.0 192.168.1.200 192.168.1.229 status /tmp/openvpn.main.status verb 3 setenv profile_name main script-security 2 up /etc/openvpn/vpn-up.sh</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">/etc/openvpn/vpn-up.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ifconfig vpn-${profile_name} up brctl addif br-${profile_name} vpn-${profile_name}</span></span></code> </pre></div></div><br>  Akibatnya, segera setelah koneksi terjadi, antarmuka vpn-main akan ditambahkan ke br-main.  Untuk grid tamu, hal yang sama berlaku untuk nama antarmuka dan alamat di server-bridge. <br><br><h4>  Permintaan Routing Di Luar dan Proxy </h4><br>  Pada langkah ini, Orange Pi sudah dapat menerima koneksi dan membiarkan klien masuk ke jaringan yang diperlukan.  Masih mengkonfigurasi proxy dari koneksi yang masuk pada router. <br><br>  Kami mentransfer server VPN router ke port lain, meletakkannya di router HAProxy dan mengkonfigurasi: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/haproxy.cfg</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">global maxconn 256 uid 0 gid 0 daemon defaults retries 1 contimeout 1000 option splice-auto listen guest_vpn bind :444 mode tcp server 0-orange 192.168.2.3:444 check server 1-local 127.0.0.1:4444 check backup listen main_vpn bind :443 mode tcp server 0-orange 192.168.1.3:443 check server 1-local 127.0.0.1:4443 check backup</code> </pre></div></div><br><h4>  Selamat menikmati </h4><br>  Jika semuanya berjalan sesuai rencana, pelanggan akan pergi ke Orange Pi dan prosesor router tidak lagi memanas, dan kecepatan VPN akan meningkat secara signifikan.  Dalam hal ini, semua aturan jaringan yang terdaftar pada router akan tetap relevan.  Jika terjadi kecelakaan pada Orange Pi, itu akan jatuh dan HAProxy akan membungkus klien di server lokal. <br><br>  Terima kasih atas perhatian Anda, saran dan koreksi dipersilahkan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id485876/">https://habr.com/ru/post/id485876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id485862/index.html">DDoS dari pembuat kopi</a></li>
<li><a href="../id485866/index.html">Integrasi Zimbra Open-Source Edition dengan Enterprise Portal</a></li>
<li><a href="../id485868/index.html">Pencahayaan untuk ruang kelas dan ruang kelas</a></li>
<li><a href="../id485872/index.html">Mengunyah Regresi Logistik</a></li>
<li><a href="../id485874/index.html">Buku ‚ÄúLearning Python: pemrograman game, visualisasi data, aplikasi web. Edisi ke-3.</a></li>
<li><a href="../id485878/index.html">Urutan langkah-langkah untuk mengatur akuntansi manajemen pada platform JetCalc</a></li>
<li><a href="../id485884/index.html">Cara mengatur Imamat China</a></li>
<li><a href="../id485888/index.html">Pemalsuan permintaan server, operasi Blind SSRF</a></li>
<li><a href="../id485896/index.html">Basis data besar-besaran Greenplum - program pendidikan singkat</a></li>
<li><a href="../id485898/index.html">Ekspor Formulir Google + unduh Google Script melalui REST API (Python)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>