<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🤝‍👨🏿 🗿 🍰 Wie wir X-Ray x64 eingeführt haben 👩‍✈️ 🎅🏿 🏣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vorwort 


 Guten Tag, wir werden über die X-Ray-Game-Engine bzw. über die Gabelung von X-Ray Oxygen sprechen. Im Dezember 2016 wurde das X-Ray Oxygen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir X-Ray x64 eingeführt haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421823/"><h1 id="predislovie">  Vorwort </h1><br><p>  Guten Tag, wir werden über die X-Ray-Game-Engine bzw. über die Gabelung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">X-Ray Oxygen</a> sprechen. Im Dezember 2016 wurde das X-Ray Oxygen-Projekt veröffentlicht.  Dann habe ich es alleine entwickelt und nicht davon geträumt, was es im Moment geworden ist. </p><a name="habracut"></a><br><p>  Im März kam mir die Idee: "Warum nicht alles auf x64 übertragen?"  Wie Sie verstehen, wird diese Idee bzw. deren Umsetzung erörtert. </p><br><h1 id="sborka-proekta">  Projektmontage </h1><br><p>  Der erste Schritt bestand darin, den Code zu portieren, um das Ganze unter die x64-Plattform zu stellen.  Nach dem Einrichten von Projekten stieß ich auf das erste Problem ... Nein, nicht Ptr-Funktionen, sondern Assembler-Einfügungen ... </p><br><pre><code class="cpp hljs">__<span class="hljs-function"><span class="hljs-function">forceinline </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fsincos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> angle , </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;sine , </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;cosine )</span></span></span><span class="hljs-function"> </span></span>{ __asm { fld DWORD PTR [angle] fsincos mov eax , DWORD PTR [cosine] fstp DWORD PTR [eax] mov eax , DWORD PTR [sine] fstp DWORD PTR [eax] } }</code> </pre> <br><p>  Das Schöne an diesem Code war die Optimierung, aber MSBuilder in x64 hat ihn nicht unterstützt und unterstützt ihn immer noch nicht.  Der größte Teil dieses Codes konnte durch Standardanaloga ersetzt werden. Es gab Stellen, die leicht in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Intrinsics</a> geändert werden konnten, z. B.: </p><br><pre> <code class="cpp hljs">__asm pause;</code> </pre> <br><p>  Es könnte sicher ersetzt werden durch: </p><br><pre> <code class="cpp hljs">_mm_pause();</code> </pre> <br><p>  Auch in der Engine gab es manchmal Analoga von Funktionen im nativen Code (Lob an das CPUID-System).  Aber es gab Orte, die man einfach loswerden musste.  Zum Beispiel sind <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">MMX-Anweisungen</a> in Vergessenheit geraten.  Zum Glück wurden sie nirgendwo angerufen, sondern einfach zusammengestellt und lagen untätig herum. </p><br><h1 id="rabotosposobnost">  Bedienbarkeit </h1><br><p>  Nach all den Änderungen an der Baugruppe hat die nächste Phase begonnen: Wie fange ich mit all dem an? </p><br><p>  Der erste Verräter war <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">LuaJIT</a> .  Leider begann LuaJIT in x64 nur mit Version 2.0.5 einwandfrei zu funktionieren (na ja, fast ...).  Und das waren kleine Probleme mit der Speicherzuordnung von kleinen Ziffern.  Aber dann wusste ich nichts davon und das erste, was ich heraussah, war LuaJIT und rollte Vanille Lua 5.1.  Ja, das hat das Problem behoben, aber Geschwindigkeit ... Denken Sie daran, wir trauern.  Später im Forum wurde mir mitgeteilt, dass Sie LuaJIT 2.0.4 verwenden können.  Und ja, es hat geholfen, ich habe das Spiel gestartet und konnte zum Hauptmenü gehen! </p><br><p>  Aber ... Glück war von kurzer Dauer ... Hallo, um Offsets, Datentypen und xrCDB zu strukturieren.  Das Spiel hat das Level nicht geladen, Materialien flogen auf die Objekte und die Engine mochte es nicht sehr.  Nach ein paar Tagen war ich völlig verzweifelt und beschloss, einen erfahreneren Programmierer unter dem Spitznamen Giperion um Hilfe zu bitten.  Ich habe nicht mit seiner Teilnahme an dem Projekt gerechnet, mein Traum war nur ein Ratschlag.  Aber auf diese Weise habe ich einen erfahrenen Entwickler in das Projekt aufgenommen.  Von diesem Moment an bildete sich ein Team. </p><br><p>  Das nächste Problem war <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">OPCODE</a> und Datentypen.  Ich musste alle udwords (unsigned int) in uqwords (unsigned long long) übersetzen.  Nur um dies zu verstehen, musste ich ungefähr 4 Stunden unter dem Debugger verbringen. </p><br><p>  Das war aber nur ein Teil des Problems.  Es war an der Reihe der Materialien.  Was haben wir: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { u32 dummy; <span class="hljs-comment"><span class="hljs-comment">// 4b struct { u32 material : 14; // u32 suppress_shadows : 1; // u32 suppress_wm : 1; // u32 sector : 16; // }; };</span></span></code> </pre> <br><p>  Ein solcher Code in x32 wurde von magic <code>#pragma pack(4)</code> gespeichert, aber für x64 wurde er aus irgendeinem Grund nicht gespeichert.  Die Wende der Ausrichtung erfolgte durch ein Debugging. Wir stellten fest, dass in einigen Fällen die Daten in der Struktur gültig waren, in anderen jedoch nicht.  Wir haben die Struktur überarbeitet und den Konverter validiert.  Die Struktur hat folgende Form: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> dummy; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> material:<span class="hljs-number"><span class="hljs-number">14</span></span>; <span class="hljs-comment"><span class="hljs-comment">// size_t suppress_shadows:1; // size_t suppress_wm:1; // size_t sector:16; // size_t dumb : 32; // ,     x64. };</span></span></code> </pre> <br><p>  Und der Validator war so: </p><br><pre> <code class="cpp hljs">... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rebuildTrisRequired) { TRI_DEPRECATED* realT = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;TRI_DEPRECATED*&gt; (T); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> triIter = <span class="hljs-number"><span class="hljs-number">0</span></span>; triIter &lt; tris_count; ++triIter) { TRI_DEPRECATED&amp; oldTri = realT[triIter]; TRI&amp; newTri = tris[triIter]; newTri = oldTri; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(tris, T, tris_count * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(TRI)); } ...</code> </pre> <br><p>  Daher musste ein Teil der Aufrufe aufgrund des Flags "RebuildTrisRequired" geändert werden, aber das Spiel konnte gestartet werden. </p><br><p>  Aber im Laufe der Zeit kam das Problem mit Partikeln: </p><br><pre> <code class="cpp hljs">real_ptr = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( Particle ) * ( max_particles + <span class="hljs-number"><span class="hljs-number">1</span></span> ) ); particles = (Particle*)((DWORD)real_ptr + (<span class="hljs-number"><span class="hljs-number">64</span></span> - ((DWORD)real_ptr &amp; <span class="hljs-number"><span class="hljs-number">63</span></span>)));</code> </pre> <br><p>  Dieser Code verursachte keine Probleme mit den ursprünglichen Partikeln.  Sie waren zu einfach und passten leise in den ihnen zugewiesenen Speicher.  Aber mit komplexeren und farbenfroheren Details, die von Modmakers gemacht wurden, kam es zu Abweichungen vom Gedächtnis.  x64 und stürzt aus dem Speicher ab, wie so ?!  Der Code wurde überarbeitet, Abfahrten sind weg: </p><br><pre> <code class="cpp hljs">particles = alloc&lt;Particle&gt;(max_particles);</code> </pre> <br><h1 id="igrovye-problemy">  Spielprobleme </h1><br><p>  Das erste Problem war wieder LuaJIT </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d75/225/31a/d7522531a39becd0151a7aa7814bddb7.jpg" alt="..."></p><br><p>  Benutzerdaten für Smart Cover flogen.  Dieses Problem wurde fast zuletzt behoben.  Übertragen Sie einfach die Änderungen aus dem veröffentlichten LuaJIT 2.0.5. </p><br><p>  Nächstes Problem: Physik und Berechnung von Schwimmern.  <code>control87</code> und <code>_controlfp</code> für die Berechnung der <code>infinity</code> in x64 wurden blockiert ... Es gab ein großes Problem mit dem Ablegen von Gegenständen, einmal bis drei fielen sie korrekt.  Manchmal flogen sie in den Weltraum, manchmal unter Terranen.  Das Problem lag nur in einer Variablen, die den Wert unendlich erhielt.  Die Situation wurde von FLT_MAX behoben, für alle Plattformen gleich. </p><br><pre> <code class="cpp hljs">surface.mu = dInfinty <span class="hljs-comment"><span class="hljs-comment">// x32 surface.mu = FLT_MAX // x64</span></span></code> </pre> <br><p>  Das letzte Problem war die Geschwindigkeit der Partikel.  Beachten Sie den folgenden Code: </p><br><pre> <code class="cpp hljs">DWORD angle = <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (angle != *((DWORD*)&amp;m.rot.x)) { angle = *((DWORD*)&amp;m.rot.x); fsincos(angle, sina, cosa); }</code> </pre> <br><p>  Alles scheint in Ordnung zu sein.  0xFFFFFFFF in x64 hat jedoch eine andere Bedeutung bei der Konvertierung in einen Gleitkommatyp.  Tatsache ist, dass fsincos ein doppeltes Gegenstück hat und x64 doppelte Daten bevorzugt.  Und dieser doppelte Wert ist viel wichtiger.  Die Umstellung auf Float rettete die Situation. </p><br><pre> <code class="cpp hljs">DWORD angle = <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (angle != *((DWORD*)&amp;m.rot.x)) { angle = *((DWORD*)&amp;m.rot.x); <span class="hljs-comment"><span class="hljs-comment">// fsincos(angle, sina, cosa); fsincos(*(float*)&amp;angle, sina, cosa); }</span></span></code> </pre> <br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  Abschließend möchte ich nur eines sagen: Der Port in x64 brachte viele neue Erkenntnisse, die in Zukunft nützlich sein werden.  Ich habe Ihnen über viele Portierungsprobleme erzählt.  Und dann hängt alles von Ihnen ab, ob Sie dies in einem OpenSource-Projekt tun. </p><br><p>  Danke fürs Lesen! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de421823/">https://habr.com/ru/post/de421823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de421811/index.html">Die IETF hat einen neuen Standard für Messaging vorgeschlagen - was Sie wissen müssen</a></li>
<li><a href="../de421815/index.html">Sechs Monate später flüssiges Metall in einem Laptop</a></li>
<li><a href="../de421817/index.html">Arbeiten mit Formularen in React.js mit grundlegenden Tools</a></li>
<li><a href="../de421819/index.html">ELK-Stapel zum Speichern von Django-Anwendungsprotokollen</a></li>
<li><a href="../de421821/index.html">Wir verwenden Voronois Mosaik-, Pixel- und geometrische Masken in Shadern, um die Site zu dekorieren</a></li>
<li><a href="../de421827/index.html">Was kann man jetzt über Java lesen?</a></li>
<li><a href="../de421829/index.html">Frangos Anomalie - eine fantastische Romanze mit echten IT-Leuten</a></li>
<li><a href="../de421833/index.html">Wir schreiben unser einfachstes Programm für ARM Cortex-M3</a></li>
<li><a href="../de421835/index.html">Die Interagency Commission entwickelt neue Technologien zur Blockierung von Telegrammen</a></li>
<li><a href="../de421837/index.html">Erstellen von 1k Intro Chaos für ZX-Spectrum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>