<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì≥ üÖæÔ∏è üòÇ Chien de berger üòò üë®‚Äçüëß üõåüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sheepdog est un syst√®me √©volutif qui fournit des p√©riph√©riques de blocs distribu√©s aux machines virtuelles. Son d√©veloppement a commenc√© en 2009 par d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Chien de berger</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412739/"><p><img src="https://habrastorage.org/webt/ru/g3/9i/rug39i1kkn-c4ack--isbvvzjma.jpeg"></p><br><p> <strong>Sheepdog</strong> est un syst√®me √©volutif qui fournit des p√©riph√©riques de blocs distribu√©s aux machines virtuelles.  Son d√©veloppement a commenc√© en 2009 par des d√©veloppeurs de la soci√©t√© japonaise <em>Nippon Telegraph and Telephone Corporation</em> .  <strong>Sheepdog</strong> est une application open source sous licence GPL2.  La derni√®re version 0.9.3, sortie en novembre 2015, sera l'h√©ritage de la version 1.0, adapt√©e √† un usage commercial <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1</a></sup> <sup><a name="cite_ref-1"></a></sup>  .  <em>(est d√©j√† devenu - environ par.)</em> </p><br><blockquote>  Pour des raisons d'int√©r√™t, la premi√®re version (0.1.0) a √©t√© publi√©e par les d√©veloppeurs en ao√ªt 2010 - et en m√™me temps, le support du chien de berger a √©t√© imm√©diatement inclus dans la branche principale de d√©veloppement de QEMU. <a name="habracut"></a><br>  Les premiers tests sur un chien de berger que j'ai effectu√©s en novembre 2011 <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2</a></sup> <sup><a name="cite_ref-2"></a></sup>  et les r√©sultats √©taient bons pour les op√©rations d'E / S.  Cependant, le syst√®me <strong>Sheepdog</strong> avait <strong>encore des</strong> probl√®mes avec la restauration du n≈ìud tomb√©.  Ce probl√®me a probablement √©t√© r√©solu rapidement, car le d√©veloppement de l'application est assez dynamique, mais √† l'√©poque, j'utilisais une solution diff√©rente. </blockquote><br><h1 id="vozmozhnosti">  Les possibilit√©s </h1><br><p>  Le principe de fonctionnement de <strong>Sheepdog est</strong> tr√®s bien d√©crit dans la pr√©sentation publi√©e, je me limiterai donc √† un bref aper√ßu. </p><br><p>  <strong>Il est √©volutif</strong> <br>  Le volume de cluster peut √™tre augment√© arbitrairement √† la fois au niveau du n≈ìud, augmentant la capacit√© et l'espace pour les donn√©es pendant le fonctionnement, et en augmentant le nombre de n≈ìuds.  Plus il y a de n≈ìuds, meilleures sont les performances des E / S VDI. </p><br><p>  <strong>Il est simple</strong> <br>  Contrairement √† d'autres syst√®mes, tels que CEPH, <strong>Sheepdog</strong> ne fonctionne pas directement avec le syst√®me de fichiers mais fonctionne avec des blocs de taille fixe, par cons√©quent, il ne n√©cessite pas de d√©mons distincts pour servir les m√©tadonn√©es.  Tout le contr√¥le est effectu√© √† l'aide d'un seul outil de <strong>chien</strong> qui communique directement avec les <strong>moutons</strong> <br>  <em>(ceph utilise √©galement des objets - environ par.)</em> </p><br><p>  <strong>Calcule un n≈ìud tomb√©</strong> <br>  Chaque VDI se compose de ces blocs (objets) qui sont r√©pliqu√©s simultan√©ment sur plusieurs n≈ìuds.Par cons√©quent, si l'un d'entre eux tombe, les donn√©es restent disponibles et les objets des n≈ìuds tomb√©s commencent √† se r√©pliquer sur l'autre n≈ìud. </p><br><p>  <strong>Prend en charge les instantan√©s de p√©riph√©rique de bloc</strong> <br>  Les <strong>instantan√©s de</strong> Sheepdog fonctionnent de la m√™me mani√®re que Btrfs.  Les blocs VDI attach√©s sont enregistr√©s et les nouvelles donn√©es sont √©crites dans de nouveaux blocs. </p><br><p>  Les fonctions suivantes peuvent √™tre probl√©matiques dans certaines circonstances: </p><br><p>  <strong>Sheepdog ne prend pas en charge SPOF</strong> <br>  Si VDI est utilis√© comme p√©riph√©rique de bloc via QEMU, un probl√®me peut survenir s'il est connect√© en m√™me temps √† plusieurs endroits.  SPOF <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3</a></sup> aurait pu emp√™cher cela. <sup><a name="cite_ref-3"></a></sup>  Sheepdog n'a pas.  Cependant, dans la nouvelle version de Sheepdog, VDI peut √™tre bloqu√© afin de ne pas autoriser plus d'une connexion. </p><br><p>  <strong>Le cycle de vie des objets de donn√©es</strong> <br>  Les objets VDI ne peuvent √™tre supprim√©s que lorsque tous les clones et instantan√©s qui leur sont associ√©s sont supprim√©s.  C'est exactement la m√™me chose que pour Btrfs.  Par cons√©quent, la suppression d'instantan√©s inutilis√©s peut ne pas √™tre suffisante pour faire de la place pour le stockage. </p><br><h1 id="demon-kommunikacii">  D√©mon de communication </h1><br><p>  Sheepdog est ridiculement petit par rapport √† Ceph ou GlusterFS.  En effet, il n'essaie pas de r√©soudre lui-m√™me tous les probl√®mes, mais utilise au maximum ce qui fonctionne d√©j√†. </p><br><p>  √Ä son tour, il fournit un p√©riph√©rique de bloc qui peut √™tre utilis√© comme disque physique, ainsi qu'un raid logiciel, etc. </p><br><p>  Il ne se soucie que de la distribution des objets de donn√©es entre les n≈ìuds sur lesquels il s'ex√©cute. </p><br><p>  Cependant, il a besoin des informations fournies par le <strong>d√©mon de communication</strong> - un composant cl√© sans lequel <strong>Sheepdog</strong> ne fonctionnera pas. </p><br><p>  <strong>D√©mon de communication</strong> - n'offre pas la possibilit√© d'√©changer des donn√©es entre les n≈ìuds.  C'est ce que font <strong>les</strong> d√©mons <strong>moutons</strong> .  Gr√¢ce √† elle, les <strong>moutons</strong> d√©couvrent uniquement les n≈ìuds actuellement en vie. </p><br><h2 id="corosync">  corosync </h2><br><p>  Tout d'abord, <strong>Sheepdog</strong> suppose que les n≈ìuds communiqueront entre eux via <strong>corosync</strong> .  Il prend en charge jusqu'√† 64 n≈ìuds, bien qu'il devrait th√©oriquement √™tre en mesure de servir davantage, son utilisation est optimale pour les petits clusters jusqu'√† 16 n≈ìuds. </p><br><p>  En r√®gle g√©n√©rale, <strong>corosync</strong> utilise √©galement Pacemaker, il n'est donc pas n√©cessaire d'installer autre chose. </p><br><h3 id="ustanovka-corosync-na-debian">  Installer corosync sur Debian </h3><br><p>  Corosync est dans les r√©f√©rentiels de distribution, et son installation est simple: </p><br><pre><code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> install corosync libcoro<span class="hljs-built_in"><span class="hljs-built_in">sync-common4</span></span></code> </pre> <br><h3 id="nastroyka-corosync">  Configuration de Corosync </h3><br><h2 id="zookeeper">  gardien de zoo </h2><br><p>  <strong>Les</strong> d√©veloppeurs de <strong>Sheepdog</strong> recommandent d'utiliser <strong>zookeeper</strong> pour les clusters plus importants.  Selon les d√©veloppeurs, un stockage de test <strong>Sheepdog</strong> avec 1000 n≈ìuds a √©t√© construit et test√© <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">4</a></sup> <sup><a name="cite_ref-4"></a></sup>  . </p><br><h3 id="ustanovka-zookeeper-na-debian">  Installer zookeeper sur Debian </h3><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> install zookeeper zookeeperd</code> </pre> <br><p>  Lancement du d√©mon .. </p><br><pre> <code class="hljs pgsql">$ /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/zookeeper/bin/zkServer.sh <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> <br><p>  Le port par d√©faut sur lequel s'ex√©cute zookeeper est 2181 </p><br><p>  Ex√©cuter le chien de berger avec le support zookeeper </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> sheep <span class="hljs-literal"><span class="hljs-literal">-c</span></span> zookeeper:IP1:PORT1,IP2:PORT2,IP3:PORT3 ...other...option...</code> </pre> <br><p>  Le bonus de <strong>zookeeper</strong> est que dans son cas, <strong>Sheepdog</strong> a une configuration plus claire et plus simple des n≈ìuds, mais il y a un probl√®me que le paquet d'installation Debian n'inclut pas son support. </p><br><p>  Par cons√©quent, pour obtenir un Sheepdog avec le support de zookeeper, vous devez le compiler √† partir du code source.  Bien que je ne puisse pas exclure que la situation puisse √™tre diff√©rente √† l'heure actuelle. <br>  <em>(Le support de zookeeper n√©cessite toujours une compilation √† partir de la source - environ par.)</em> </p><br><h1 id="nastroyka-demona-sheep">  Configuration du d√©mon mouton </h1><br><p>  Le n≈ìud fait partie du Sheepdog lorsque le gestionnaire d'objets, le d√©mon <strong>mouton</strong> , d√©marre.  Il fonctionne toujours en deux exemplaires: </p><br><ol><li><p>  La premi√®re instance du processus commence comme une passerelle, qui re√ßoit les demandes d'E / S des clients (par exemple, des pilotes des p√©riph√©riques de bloc QEMU), calcule les n≈ìuds cibles et envoie des demandes de traitement ult√©rieur entre eux.  Autrement dit, il √©tablit de nombreuses connexions r√©seau. </p><br></li><li>  Un autre fonctionne comme un gestionnaire d'objets local (gestionnaire d' <strong>objets</strong> ) </li></ol><br><p>  Les param√®tres de configuration du d√©mon mouton peuvent √™tre pass√©s comme arguments de ligne de commande lors de l'ex√©cution.  S'il n'y en a pas, les valeurs par d√©faut seront utilis√©es, avec lesquelles vous devez faire attention: </p><br><p>  <strong>Num√©ro de port</strong> <br>  Sauf indication contraire, le d√©mon mouton s'ex√©cute sur le port 7000 </p><br><p>  <strong>Chemin d'acc√®s au coffre-fort</strong> <br>  Sauf indication contraire, le r√©pertoire shep utilise le r√©pertoire / var / lib / moutdog et les objets VDI sont stock√©s dans son sous-r√©pertoire <code>obj</code> . </p><br><blockquote>  Th√©oriquement, rien n'emp√™che plusieurs instances de <strong>moutons de</strong> travailler sur un n≈ìud - la condition principale est que chacun utilise son num√©ro de port et son propre stockage.  Le probl√®me de l'adresse IP du n≈ìud est presque r√©solu.  Chaque instance en cours d'ex√©cution du d√©mon <strong>mouton</strong> s'ex√©cutant sur un port diff√©rent se connectera automatiquement √† un cluster existant! <br><br>  Informations importantes: le num√©ro de port fait partie de la configuration du conteneur VDI.  Vous devez savoir si vous souhaitez reconfigurer le d√©mon <strong>mouton</strong> pour qu'il s'ex√©cute sur l'autre port du cluster existant. <br><br>  Par cons√©quent, si vous ex√©cutez une instance du d√©mon <strong>mouton</strong> avec un num√©ro de port diff√©rent, mais avec le m√™me chemin d'acc√®s au magasin d'objets, vous risquez de perdre des informations dans les conteneurs VDI existants. </blockquote><br><h1 id="demon-sheep-kak-shlyuz">  Le mouton d√©mon comme porte d'entr√©e </h1><br><p>  Sur les machines qui n'ont pas d'espace de stockage pour les objets VDI, le d√©mon <strong>mouton</strong> peut √™tre ex√©cut√© exclusivement en mode passerelle, avec l'indicateur <code>-G</code> . </p><br><p>  Dans ce cas, lors de la distribution d'objets VDI, le stockage local ne sera pas utilis√© du tout et les donn√©es seront distribu√©es directement aux autres n≈ìuds. </p><br><h1 id="demon-sheep-kak-menedzher-obektov">  D√©mon mouton en tant que gestionnaire d'objets </h1><br><p>  La deuxi√®me instance en cours d'ex√©cution, agit en tant que gestionnaire d'objets local, re√ßoit les demandes d'E / S d'une instance qui d√©marre en tant que passerelle et effectue des op√©rations de r / w dans le stockage d'objets local ( <strong>stockage d'objets</strong> ) </p><br><h2 id="hranilische-obektov">  Stockage d'objets </h2><br><p>  Par d√©faut, le stockage des objets VDI dans <strong>Sheepdog</strong> est le r√©pertoire <code>/var/lib/sheepdog/obj</code> <strong>mouton</strong> <code>/var/lib/sheepdog/obj</code> , qui est √©galement utilis√© par le d√©mon <strong>mouton</strong> dans le cadre de sa structure de r√©pertoire interne - c'est le chemin de stockage par d√©faut. </p><br><p>  Si vous souhaitez que les objets VDI soient stock√©s ailleurs, vous pouvez passer le chemin o√π un autre p√©riph√©rique de bloc est mont√© en tant que param√®tre au d√©marrage. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sheep</span></span> ... /cesta_do_p≈ô√≠pojn√©ho_bodu</code> </pre> <br><p>  Il existe encore plus de moyens de transmettre.  La nouvelle version de <strong>Sheepdog</strong> prend en charge la technologie dite multi-p√©riph√©rique, qui vous permet d'augmenter dynamiquement la capacit√© de m√©moire, si n√©cessaire, sans avoir √† red√©marrer le <strong>Sheepdog</strong> .  L'augmentation de la capacit√© de stockage fonctionne de mani√®re similaire √† Btrfs. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sheep</span></span> ... /cesta_do_A,/cesta_do_B,/cesta_do_C</code> </pre> <br><p>  <em>(le premier r√©pertoire sp√©cifi√© ne sera utilis√© que pour les m√©tadonn√©es - environ par)</em> </p><br><p>  Un stockage suppl√©mentaire peut √©galement √™tre ajout√© (ou supprim√©) via le <strong>n≈ìud de chien md</strong> </p><br><p>  ... </p><br><p>  La fonctionnalit√© offerte par le multi-p√©riph√©rique est particuli√®rement utile lorsque le syst√®me de fichiers de stockage ne prend pas en charge cette "par conception" (contrairement √† Btrfs ou ZFS).  En g√©n√©ral, le choix d'un syst√®me de fichiers pour stocker des objets, leurs propri√©t√©s, param√®tres et r√©glages peut affecter de mani√®re significative les performances du syst√®me de fichiers IO d'une machine virtuelle. </p><br><blockquote>  La technologie multi-p√©riph√©rique n√©cessite des attributs avanc√©s c√¥t√© fichier, ce qui n'est pas un probl√®me pour les syst√®mes de fichiers modernes tels que btrfs <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5</a></sup> <sup><a name="cite_ref-5"></a></sup>  ou ext4.  Mais certains syst√®mes de fichiers plus anciens comme reiserfs ou ext2 <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6</a></sup> <sup><a name="cite_ref-6"></a></sup>  Ne les soutenez pas. <br><br>  Si vous souhaitez utiliser un syst√®me de fichiers qui ne prend pas en charge les attributs √©tendus pour stocker des objets, nous devons compiler <strong>Sheepdog</strong> sans prise en charge multi-p√©riph√©rique. </blockquote><br><h2 id="tip-hranilischa---plain-versus-tree">  Type de stockage - simple contre arbre </h2><br><p>  Lors du formatage d'un cluster, entre autres options, vous pouvez sp√©cifier le type de stockage (stockage backend).  Vous pouvez d√©finir le type sur <strong>plain</strong> ou <strong>tree</strong> .  Pour un type <strong>simple</strong> , la structure du r√©pertoire ressemblera √† ceci: </p><br><pre> <code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">| |</span></span>- obj <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt;id &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|-&lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-&lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|-&lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>- ... <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt;id  &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> ... <span class="hljs-params"><span class="hljs-params">|- config [] |</span></span>- epoch <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span>- ... <span class="hljs-params"><span class="hljs-params">|- journal \- sheep.log []</span></span></code> </pre> <br><p>  Tous les objets VDI du r√©pertoire <code>obj</code> seront envoy√©s vers un sous-r√©pertoire dont le nom est bas√© sur l'identifiant de l'√®re actuelle.  Autrement dit, pour chaque √©poque, les objets VDI correspondants seront stock√©s s√©par√©ment.  Cependant, √† une √©poque, un grand nombre d'objets VDI peuvent appara√Ætre dans le r√©pertoire, ce qui ralentit par la suite l'acc√®s aux fichiers.  Par cons√©quent, vous pouvez choisir la deuxi√®me option, qui est l' <strong>arborescence</strong> : </p><br><pre> <code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">|- obj |</span></span> <span class="hljs-params"><span class="hljs-params">|- aa |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-&lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|-&lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-&lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|- ... |</span></span> <span class="hljs-params"><span class="hljs-params">|- ab |</span></span> <span class="hljs-params"><span class="hljs-params">| ... |</span></span> <span class="hljs-params"><span class="hljs-params">|- meta |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|- ... |</span></span> <span class="hljs-params"><span class="hljs-params">|- 0a |</span></span> <span class="hljs-params"><span class="hljs-params">| ... |</span></span>- config [] <span class="hljs-params"><span class="hljs-params">|- epoch |</span></span> <span class="hljs-params"><span class="hljs-params">|- &lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">|- &lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">|- ... \- sheep.log []</span></span></code> </pre> <br><p>  Dans ce type de stockage, le d√©mon <strong>mouton</strong> cr√©e un ensemble de 256 sous-r√©pertoires avec les noms <code>0a, ..., 99</code> dans le r√©pertoire <code>obj</code> , puis disperse les objets en fonction des deux derniers caract√®res de l' <strong>ID VDI</strong> , ce qui est unique non seulement pour chaque conteneur VDI mais aussi ses instantan√©s ou clones. </p><br><h2 id="imena-vdi-obektov">  Noms des objets VDI </h2><br><p>  Lorsque <strong>Sheepdog</strong> enregistre les donn√©es dans le conteneur VDI, les fichiers commencent √† appara√Ætre dans le magasin de donn√©es <code>obj</code> , chacun aura son propre nom compos√© de plusieurs √©l√©ments: </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^</code> </pre> <br><p>  Les deux premiers caract√®res indiquent le type d'objet.  Les objets de donn√©es commencent par <code>00...</code> et les m√©tadonn√©es (qui peuvent √™tre stock√©es dans un autre r√©pertoire) <code>80...</code> </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^^^^^</code> </pre> <br><p>  Vient ensuite le VDI.  Il est unique non seulement pour chaque conteneur, mais √©galement pour son instantan√© ou son clone. </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^ ^^</code> </pre> <br><p>  Les deux derniers chiffres de l'identifiant VDI indiquent - dans le cas du type de stockage d' <strong>arborescence</strong> - dans lequel se trouve le sous-r√©pertoire auquel appartient l'objet. </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^^^^^^^</code> </pre> <br><p>  Et l'identifiant du conteneur VDI en hexad√©cimal est suivi du num√©ro de s√©rie de l'objet dans le conteneur VDI </p><br><h2 id="epoha">  √âpoque </h2><br><p>  Le sous-r√©pertoire <code>epoch</code> contient des listes binaires d'objets appartenant √† l'√©poque.  Le nombre d'√©poques augmente, chaque fois que chaque cluster change - lorsqu'un n≈ìud est ajout√© ou supprim√©.  Chacun de ces changements d√©marre le processus de <strong>r√©cup√©ration</strong> , au cours duquel l'√©tat actuel des objets locaux sera v√©rifi√© sur les n≈ìuds, suivi d'une augmentation de l'√®re. </p><br><h1 id="kak-optimalno-vybrat-hranilische-vdi-obektov">  Comment choisir le stockage d'objet VDI optimal </h1><br><p>  La capacit√© de stockage disponible est calcul√©e en fonction de l'espace libre sur les n≈ìuds.  L'espace choisi par les <strong>moutons</strong> d√©pend toujours de la quantit√© d'espace disponible dans le p√©riph√©rique de bloc o√π les objets VDI sont stock√©s. </p><br><p>  La taille d'un conteneur VDI n'est qu'une forme virtuelle qui n'est aucunement li√©e √† l'espace occup√© par les objets VDI.  Il est important de savoir comment Sheepdog traite les donn√©es dans un cluster: </p><br><blockquote>  Sheepdog essaie toujours de stocker les donn√©es uniform√©ment entre toutes les machines de l'√©poque. </blockquote><p>  Cela signifie que si l'un des n≈ìuds tombe, l'√®re change et <strong>Sheepdog</strong> d√©marre imm√©diatement le processus de r√©cup√©ration, il cr√©era les objets VDI manquants sur les n≈ìuds restants pour compenser la perte. </p><br><p>  Une situation similaire se produira lors de l'ajout d'un nouveau n≈ìud.  <strong>Sheepdog</strong> commencera √† d√©placer uniform√©ment les objets VDI des nouveaux n≈ìuds vers son r√©f√©rentiel, afin que le pourcentage de remplissage de l'espace de donn√©es sur les n≈ìuds soit aussi √©quilibr√© que possible.  Utilisez la commande suivante pour obtenir un aper√ßu global de l'espace actuellement utilis√© sur vos n≈ìuds: </p><br><pre> <code class="hljs pgsql">nod1 ~ # collie node md <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> -A Id Size Used Avail Use% <span class="hljs-type"><span class="hljs-type">Path</span></span> Node <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> TB <span class="hljs-number"><span class="hljs-number">391</span></span> GB <span class="hljs-number"><span class="hljs-number">720</span></span> GB <span class="hljs-number"><span class="hljs-number">35</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">702</span></span> GB <span class="hljs-number"><span class="hljs-number">394</span></span> GB <span class="hljs-number"><span class="hljs-number">307</span></span> GB <span class="hljs-number"><span class="hljs-number">56</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">794</span></span> GB <span class="hljs-number"><span class="hljs-number">430</span></span> GB <span class="hljs-number"><span class="hljs-number">364</span></span> GB <span class="hljs-number"><span class="hljs-number">54</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.6</span></span> TB <span class="hljs-number"><span class="hljs-number">376</span></span> GB <span class="hljs-number"><span class="hljs-number">1.2</span></span> TB <span class="hljs-number"><span class="hljs-number">22</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.2</span></span> TB <span class="hljs-number"><span class="hljs-number">401</span></span> GB <span class="hljs-number"><span class="hljs-number">838</span></span> GB <span class="hljs-number"><span class="hljs-number">32</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.5</span></span> TB <span class="hljs-number"><span class="hljs-number">370</span></span> GB <span class="hljs-number"><span class="hljs-number">1.1</span></span> TB <span class="hljs-number"><span class="hljs-number">24</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.6</span></span> TB <span class="hljs-number"><span class="hljs-number">388</span></span> GB <span class="hljs-number"><span class="hljs-number">1.2</span></span> TB <span class="hljs-number"><span class="hljs-number">23</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj</code> </pre> <br><h2 id="proizvoditelnost-io">  Performances d'E / S </h2><br><p>  Il est important de dire ici que <strong>Sheepdog</strong> fonctionne diff√©remment de Ceph et a des priorit√©s diff√©rentes. </p><br><p>  Pour Ceph, le ¬´poids¬ª du p√©riph√©rique OSD est critique lors du placement d'objets de donn√©es, ainsi que les performances du p√©riph√©rique de blocage, la connectivit√© de l'h√¥te et la vitesse de r√©ponse.  <em>(en fait pas - environ par)</em> </p><br><p>  Sheepdog fait-il quelque chose comme √ßa, je ne sais pas.  C'est possible.  Les donn√©es pour lui viennent en premier.  Les performances en termes d'op√©rations d'E / S sont secondaires.  Bien s√ªr, avec des n≈ìuds plus puissants, ses performances d'E / S peuvent s'am√©liorer, mais cela d√©pend toujours de la structure sp√©cifique.  <em>(cependant, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tests</a> montrent une meilleure performance du chien de berger par rapport au c√©ph - environ par personne)</em> </p><br><blockquote>  J'ai ajout√© un nouveau n≈ìud √† Sheepdog avec des donn√©es stock√©es sur un disque SATA II rotatif de 2 To.  La vitesse d'√©criture maximale de ce disque est d'environ 80 M / s.  En fait, cela varie beaucoup car les disques SATA ne peuvent pas lire et √©crire en m√™me temps. <br><br>  Initialement, la vitesse d'√©criture moyenne sur VDI sur ce disque √©tait d'environ 20 √† 30 M / s, car en plus des donn√©es de VDI, les donn√©es du conteneur 392G y √©taient r√©pliqu√©es dans le cadre du processus de r√©cup√©ration.  Cela a dur√© 6,5 heures.  La vitesse d'√©criture variait entre 40 et 55 M / s. <br><br>  De toute √©vidence, dans ce cas, la vitesse d'√©criture √©tait limit√©e par les performances d'E / S du p√©riph√©rique de bloc local. </blockquote><p>  Pour Sheepdog, la r√®gle suivante s'applique: "Plus il y a d'objets VDI sur les n≈ìuds avec une connexion rapide, meilleures sont les performances des op√©rations d'E / S." </p><br><p>  √âtant donn√© que le d√©placement d'objets VDI en arri√®re-plan signifie que la ¬´mort rapide d'un n≈ìud¬ª ralentira la r√©plication des objets de donn√©es qui occupent le plus d'espace, cela se manifestera par une diminution des performances des op√©rations d'E / S du conteneur VDI. </p><br><h2 id="zanimaemoe-prostranstvo">  Espace occup√© </h2><br><p>  Lors du placement d'objets de donn√©es, la quantit√© d'espace libre est critique pour le d√©mon <strong>mouton</strong> .  Le m√©canisme semble simple.  Le d√©mon <strong>mouton</strong> , √† travers lequel les donn√©es sont communiqu√©es avec le conteneur VDI, d√©termine de temps en temps l'utilisation de l'espace libre et occup√© sur les n≈ìuds, ce qui le trie.  Ensuite, les donn√©es sont r√©parties entre les n≈ìuds avec le taux d'utilisation le plus bas. </p><br><p>  S'il existe un chemin d'√©criture principalement rapide, l'op√©ration d'√©criture dans le conteneur VDI sera √©galement rapide.  √âtant donn√© que plus les op√©rations d'E / S du conteneur VDI sont rapides, plus le d√©mon <strong>mouton</strong> peut passer √† l'op√©ration suivante. </p><br><p>  L'important est qu'avec Sheepdog, il n'y ait pas de situation o√π l'un des n≈ìuds est compl√®tement plein.  Si le taux d'utilisation sur le n≈ìud devient bien pire, le d√©mon mouton commence √† d√©placer ses objets de donn√©es vers un autre emplacement. </p><br><p>  Sheepdog fonctionne comme Btrfs - en utilisant uniquement de l'espace vraiment occup√©.  Ainsi, vous pouvez cr√©er un conteneur VDI virtuel d'une capacit√© de 1 To, qui prendra en fait autant d'espace que les donn√©es qui y sont stock√©es.  De ce point de vue, il est souhaitable d'utiliser de tels formats de disques virtuels et de syst√®mes de fichiers dans des conteneurs VDI qu'ils peuvent nettoyer l'un apr√®s l'autre. </p><br><h1 id="zapusk-klastera">  Lancement du cluster </h1><br><blockquote>  Alors que tous les n≈ìuds peuvent √™tre arr√™t√©s en m√™me temps, les n≈ìuds ne peuvent pas √™tre d√©marr√©s √† la fois !!!  Les n≈ìuds doivent √™tre connect√©s progressivement.  En commen√ßant par le n≈ìud qui a √©t√© sp√©cifi√© en premier dans la liste des n≈ìuds. <br>  <em>(c'est une d√©claration extr√™mement √©trange - environ par)</em> </blockquote><br><h1 id="vdi">  Vdi </h1><br><p>  Il s'agit d'une abr√©viation g√©n√©rique dans <strong>Sheepdog</strong> pour disque virtuel, et non de son format sp√©cifique. <sup><a name="cite_ref-7"></a></sup>  .  En g√©n√©ral, il s'agit d'une bo√Æte virtuelle avec des compartiments de taille fixe, dans laquelle <strong>Sheepdog</strong> place ensuite les donn√©es que le client transmet. </p><br><h1 id="sozdanie-vdi">  Cr√©ation de VDI </h1><br><p>  Avant de cr√©er ou d'importer le premier VDI, nous devons formater le cluster.  Lors du formatage d'un cluster, des param√®tres sont d√©finis qui seront ensuite utilis√©s par d√©faut lors de la cr√©ation de chaque VDI suivant. </p><br><p>  Un exemple d√©montrant la cr√©ation d'un nouveau VDI nomm√© Disk1 et 1 Go de taille </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi create disk1 1G root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@nod</span></span></span><span class="hljs-comment">1 :~# collie vdi list Name Id Size Used Shared Creation time VDI id Copies Tag Block Size Shift disk1 0 1.0 GB 0.0 MB 0.0 MB 2015-12-04 14:07 e8b18f 2 22</span></span></code> </pre> <br><p>  <strong>Id</strong> <br>  Identifiant VDI </p><br><p>  <strong>La taille</strong> <br>  La taille du VDI qui ne sera pas n√©cessairement imm√©diatement pr√©allou√©e. <br>  Si ce VDI est au format incr√©mentiel (qcow2 et similaire) cr√©√© √† l'aide de <code>qemu-img convert</code> , il ne correspondra pas √† la taille du disque virtuel, mais il augmentera constamment. </p><br><p>  <strong>Utilis√©</strong> <br>  Informations sur l'espace occup√© par les objets de donn√©es VDI. <br>  VDI, qui ne n√©cessite pas d'allocation d'objets de donn√©es lors de la cr√©ation, n'occupera rien du tout, car les objets de donn√©es n'ont pas encore √©t√© cr√©√©s pour lui. </p><br><p>  <strong>Partag√©</strong> <br>  Le volume d'objets de donn√©es partag√©s par d'autres VDI </p><br><p>  <strong>Heure de cr√©ation</strong> <br>  Heure de cr√©ation VDI </p><br><p>  <strong>Taille de bloc</strong> <br>  La taille de l'objet VDI.  Attention!  Il n'est pas sp√©cifi√© en Mo, mais comme une puissance de deux octets.  Dans les anciennes versions, seuls 4 Mo d'objets de taille fixe √©taient utilis√©s.  Actuellement, VDI peut avoir des objets plus grands.  La taille optimale pour l'objet VDI d'une machine virtuelle ordinaire ressemble √† 64 Mo (26).  La taille par d√©faut de 22 (4 Mo) est √©galement minime.  Moins ne peut pas √™tre install√©.  Plus la taille de l'objet est petite, plus le nombre de fichiers que <strong>Sheepdog</strong> devra traiter <strong>lors</strong> de l'utilisation de VDI est important, et travailler avec des fichiers n'est pas un probl√®me bon march√© du point de vue d'E / S.  Un grand nombre de fichiers, en particulier avec des contr√¥leurs SATA lents, peuvent entra√Æner une forte d√©t√©rioration des vitesses de lecture et d'√©criture.  La taille maximale des objets pouvant √™tre utilis√©s est de 31 (2 Go).  Cela peut √™tre avantageux si VDI stocke syst√©matiquement une grande quantit√© de donn√©es statiques, telles que des sauvegardes. </p><br><p>  <strong>Vdi id</strong> <br>  Identifiant VDI. </p><br><h2 id="chto-soderzhit-vdi">  Que contient VDI? </h2><br><p>  Le contenu VDI est constitu√© de donn√©es.  Ceci est un p√©riph√©rique de bloc distribu√©, donc <strong>Sheepdog</strong> ne r√©sout pas ces donn√©es ou ces ordures.  De ce point de vue, VDI ressemble √† un volume logique LVM.  Un VDI pr√©-rempli correspond √† une partition LV classique avec une plage d√©di√©e, tandis que le VDI ressemble √† une partition LV mince cr√©√©e dans un pool (voir LVM (thin_provisioning)), mais avec la diff√©rence que les √©tendues de donn√©es (objets) ne sont pas enregistr√©es sur local bloquer les p√©riph√©riques et sont dispers√©s entre les n≈ìuds. </p><br><blockquote>  Le format VDI fonctionne dans cette analogie comme un syst√®me de fichiers.  Certains occupent des √©tendues r√©serv√©es (objets) de mani√®re s√©quentielle, d'autres les mappent en tant qu'inodes, puis leur envoient directement des donn√©es.  Une combinaison incorrecte du syst√®me de fichiers de stockage de noeud, du format VDI et du syst√®me de fichiers interne peut entra√Æner une d√©gradation significative des performances d'E / S. </blockquote><br><h2 id="kak-poluchit-informaciyu-o-vdi">  Comment obtenir des informations sur VDI </h2><br><p>  Pour en savoir plus sur le format VDI, vous pouvez utiliser <strong>qemu-img info</strong> : </p><br><pre> <code class="hljs mel">root@nod1 :~# qemu-img info sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:disk1 <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:test2 <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>: qcow2 virtual <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>G (<span class="hljs-number"><span class="hljs-number">12884901888</span></span> bytes) disk <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">4.0</span></span>G cluster_size: <span class="hljs-number"><span class="hljs-number">65536</span></span> Format specific information: compat: <span class="hljs-number"><span class="hljs-number">1.1</span></span> lazy refcounts: false refcount bits: <span class="hljs-number"><span class="hljs-number">16</span></span> corrupt: false</code> </pre> <br><p>  √Ä la sortie de la commande, vous pouvez d√©couvrir que disk1 a une taille nominale de 12G.  Actuellement, il ne prend que la 4G.  Puisqu'il est au format qcow2, il est √©vident qu'il a √©t√© cr√©√© comme incr√©mental. </p><br><pre> <code class="hljs mel">root@nod1 :~# collie vdi list Name Id Size Used Shared Creation time VDI id Copies Tag Block Size Shift disk2 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">4.0</span></span> GB <span class="hljs-number"><span class="hljs-number">4.0</span></span> GB <span class="hljs-number"><span class="hljs-number">0.0</span></span> MB <span class="hljs-number"><span class="hljs-number">2015</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">825</span></span>dc1 <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> root@nod1 :~# qemu-img info sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:disk2 <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:disk2 <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>: raw virtual <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">4.0</span></span>G (<span class="hljs-number"><span class="hljs-number">4294967296</span></span> bytes) disk <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">4.0</span></span>G root@nod1 :~# find /datastore/obj/ | grep <span class="hljs-number"><span class="hljs-number">825</span></span>dc1 /datastore/obj/meta/<span class="hljs-number"><span class="hljs-number">80825</span></span>dc100000000 /datastore/obj/c1/<span class="hljs-number"><span class="hljs-number">00825</span></span>dc100000000 /datastore/obj/c1/<span class="hljs-number"><span class="hljs-number">00825</span></span>dc100000001</code> </pre> <br><p>  Dans ce cas, Disk2 a √©t√© cr√©√© en tant que VDI pr√©allou√© de 4 Go au format brut avec une taille de bloc de 2 Go, ce qui ne prend en fait que deux 2 Go </p><br><h2 id="eksport-vdi-v-fayl">  Exporter VDI dans un fichier </h2><br><p>  Le contenu VDI peut √™tre export√© de <strong>Sheepdog de</strong> plusieurs mani√®res.  Le plus rapide est peut-√™tre d'utiliser <strong>la lecture de chien</strong> .  La commande est un peu d√©routante, mais signifie simplement: "Chargez le contenu du VDI et envoyez-le √† STDOUT ..", qui peut √™tre redirig√© vers un fichier: </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi read disk1 &gt; /backups/soubor.raw</span></span></code> </pre> <br><p>  Si VDI a 10G mais seulement 2G est utilis√©, il cr√©era un fichier avec une pleine capacit√© de 10 Go. </p><br><p>  <strong>Dans cette commande, le contenu du VDI est inchang√©</strong> , donc si le contenu du VDI, par exemple, un disque virtuel au format qcow2 compress√©, peut √™tre utilis√© directement </p><br><pre> <code class="hljs mel">.. -drive <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>:/disk1_exportovany_z_vdi,..,<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=qcow2 ..</code> </pre> <br><p>  Une autre fa√ßon d'obtenir le contenu de VDI dans un fichier est d'utiliser <strong>qemu-img convert</strong> .  Ce n'est pas si rapide, mais cela vous permet de convertir VDI en un autre format en utilisant diff√©rentes options du format de disque virtuel correspondant. </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># qemu-img convert -f qcow2 -O file -o preallocation=full,nocow=on sheepdog:localhost:8000:disk1 /disk1_exportovany_z_vdi</span></span></code> </pre> <br><h2 id="inkrementnoe-rezervnoe-kopirovanie">  Sauvegarde incr√©mentielle </h2><br><p>  Cr√©er une sauvegarde incr√©mentielle </p><br><p>  Delta entre le premier et le deuxi√®me instantan√© .. </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi backup test -F snap1 -s snap2 /backups/soubor_diff</span></span></code> </pre> <br><p>  Restaurer VDI √† partir d'une sauvegarde incr√©mentielle </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi restore test -s snap1 /tmp/backup restoring /tmp/backup... done</span></span></code> </pre> <br><p>  Lors de l'importation d'une sauvegarde incr√©mentielle, le VDI doit bien s√ªr avoir l'instantan√© √† partir duquel la sauvegarde a √©t√© effectu√©e. </p><br><p>  V√©rification en lisant le contenu original du test d'image ... </p><br><pre> <code class="hljs ruby"> root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi read test 0 512 -s 3</span></span></code> </pre> <br><h1 id="import-vdi-iz-fayla">  Importer VDI √† partir d'un fichier </h1><br><p>  L'importation d'un disque virtuel existant en tant que fichier FS local peut √™tre effectu√©e de la m√™me mani√®re pour l'exportation.  Mais avec la diff√©rence que l' <strong>√©criture de chien est utilis√©e</strong> ("Lecture des donn√©es de STDIN et √©criture dans un fichier VDI ..") </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi write disk1 &lt; /backups/soubor.raw</span></span></code> </pre> <br><p></p><br><blockquote><ul><li>  Le contenu ne peut √™tre import√© que dans un VDI existant. </li><li>  Le VDI import√© occupe toujours plus d'espace que le fichier d'origine, car les blocs de donn√©es √† partir desquels le VDI est restaur√© contiennent des donn√©es sur la zone marqu√©e. </li></ul><br></blockquote><p>  Si VDI n'existe pas encore et que nous ne savons pas combien d'espace sera n√©cessaire pour le disque virtuel, nous pouvons utiliser <strong>qemu-img convert</strong> </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># qemu-img convert -f file -O qcow2 -o redundancy=2:1 ./disk_ukladany_do_vdi sheepdog:localhost:8000:disk</span></span></code> </pre> <br><blockquote>  Bien que les formats VDI tels que qcow2, qed et autres puissent √™tre utilis√©s dans VDI.  Pour l'efficacit√© des E / S, il est pr√©f√©rable de pr√©allouer les blocs de donn√©es. <br>     ,        <strong>Sheepdog</strong>     VDI. </blockquote><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.sheepdog-project.org/doc/vdi_read_and_write.html</a> </p><br><h1 id="proverka-vdi">  VDI </h1><br><p>    VDI ,      . </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi check disk1</span></span></code> </pre> <br><blockquote>    VDI,     .    Sheepdog    ,      .     ,            . </blockquote><p> :   'dog node kill'     ,         ethernet ,   sheep    .          (,    Ethernet),         sheep .               . </p><br><h2 id="io-proizvoditelnost-vdi"> IO  VDI </h2><br><p>  VDI    .          .       ,   IO   VDI. </p><br><p>   <strong>Sheepdog</strong>    SYNC,    .   -,     VFS,   ,       ,       . </p><br><p>       VDI  <strong>Sheepdog</strong>    ,            .              .  <strong>Sheepdog</strong>        VDI-. </p><br><h2 id="ispolzovanie-vfs-kesha-nody">  VFS-  </h2><br><p>      IO  VDI      <strong>sheep</strong>   <strong>-n</strong> .    SYNC         ,   ,        VFS .     ,   VFS  ,   ,      ! </p><br><p>         .            ,          ‚Äî , ,    . </p><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">sheep</span></span> -n ...</code> </pre> <br><blockquote>   <strong>Sheepdog</strong>      .      <strong>-D</strong> </blockquote><br><h1 id="obektnyy-kesh">   </h1><br><p>     -   .   <strong>sheep</strong>           -   IO ‚Äî  SSD .  ,   VDI,       SYNC   .             . </p><br><p>       ,   VDI     ,         VDI   . ,     ,     ,      VDI. </p><br><pre> <code class="hljs dos">sheep -w size=<span class="hljs-number"><span class="hljs-number">20000</span></span>,directio,<span class="hljs-built_in"><span class="hljs-built_in">dir</span></span>=/<span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> ...</code> </pre> <br><p> <strong>size</strong> <br>   </p><br><p> <strong>directio</strong> <br>     <strong>sheep</strong>      ,      .      SSD. </p><br><p> <strong>dir</strong> </p><br><pre> <code class="hljs erlang">     ,     .</code> </pre> <br><p>       ( )   <strong>dog</strong> . </p><br><blockquote>        VDI          <strong>dog vd cashe flush</strong> ,     VDI! </blockquote><br><h2 id="zhurnal">  </h2><br><p>   ‚Äî  .           VDI,     VFS   ,           (/store_dir/journal/[epoch]/[vdi_object_id]),     ,    . </p><br><p>   IO   ,        (cik, cak),   (sequence). </p><br><p>  , <strong>Sheepdog</strong>        VDI ,           ,  SSD-.     ,       VDI    ,           ,                VDI. </p><br><p>        <strong>sheep</strong>      ‚Äî         </p><br><pre> <code class="hljs matlab">$ sheep -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>=<span class="hljs-number"><span class="hljs-number">256</span></span>M ...</code> </pre> <br><p>       ,  VDI      ,    .        -,   ‚Äî   ‚Äî         -: </p><br><pre> <code class="hljs matlab">$ sheep -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> dir=/dir,<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>=<span class="hljs-number"><span class="hljs-number">256</span></span>M ...</code> </pre> <br><p>  dir =      ,          .       ,     SW RAID     SSD. </p><br><p> <strong>:</strong>    <strong>sheep</strong>     ,    .     ,      skip,   . </p><br><pre> <code class="hljs matlab">$ sheep -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> dir=/dir,<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>=<span class="hljs-number"><span class="hljs-number">256</span></span>M,skip ...</code> </pre> <br><hr><br><ol><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a> <a name="cite_note-1"></a> .       2015 . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://events.linuxfoundation.jp/sites/events/files/slides/COJ2015_Sheepdog_20150604.pdf</a></sup> </li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a> <a name="cite_note-2"></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.abclinuxu.cz/blog/kenyho_stesky/2011/11/sheepdog-hrajeme-si-v-hampejzu</a></sup> </li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a> <a name="cite_note-3"></a> SPOF ( <strong>S</strong> ingle <strong>p</strong> oint <strong>o</strong> f <strong>f</strong> ailure) ,             .  SPOF   VDI   iSCSI  <strong>tgtd</strong></sup> </li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a> <a name="cite_note-4"></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1</a></sup> </li><li><p> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a> <a name="cite_note-5"></a> Btrfs ‚Äî    COW,       ,        .   ,      -,      .      ,     ,              .      ,         ,   .  ,     :</sup> </p><br><p> <sup>autodefrag ‚Äî     ,          .</sup> </p><br><p> <sup>      </sup> </p><br><p> <sup>nocow ‚Äî           (),      ‚Äî           GlusterFS</sup> </p><br><p> <sup> Btrfs   ,     ,     FS,       <strong>Sheepdog</strong> .</sup> </p><br><ul><li> <sup>    ,   ,    ,      </sup> </li><li> <sup>  multipath,                         .</sup> </li></ul><br><p> <sup>,  ,        ,        Sheepdog.</sup> </p><br></li><li><p> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a> <a name="cite_note-6"></a> <strong>Ext2</strong> .     -  FS  Btrfs,    ext2,     inode.    ext3  ext4     .   inode , Sheepdog          . ,      -,   .           ,   <strong>Sheepdog</strong>      ,         <strong>dog vdi check</strong> . ,  ext2  ,            ‚Äî    -     <strong>dog vdi md</strong> ,       VDI     .</sup> </p><br></li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a> <a name="cite_note-7"></a>    ,   , <strong>vdi</strong>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">QEMU_Block_Disk</a></sup> </li></ol><br><h1 id="ssylki">  Les r√©f√©rences </h1><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/collie/sheepdog/wiki</a> ‚Äî ,        <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.osrg.net/sheepdog/</a> ‚Äî    Nippon Telegraph and Telephone Corporation <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.sheepdog-project.org/doc/index.html</a> ‚Äî   Sheepdog   0.8.0;  ‚Äî Valerio Pachera <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.admin-magazine.com/Archive/2014/23/Distributed-storage-with-Sheepdog</a> ‚Äî  Udo Seidela   <strong>Sheepdog</strong> ,   23-   Admin   2014  </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412739/">https://habr.com/ru/post/fr412739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412725/index.html">Comment rendre votre infrastructure informatique ennuyeuse</a></li>
<li><a href="../fr412727/index.html">Comment choisir un outil de prototypage en 2018?</a></li>
<li><a href="../fr412729/index.html">GDPR. Faut-il l'ex√©cuter en Russie?</a></li>
<li><a href="../fr412735/index.html">Laissez le concours ATM seul les PHDays 8</a></li>
<li><a href="../fr412737/index.html">Protection des donn√©es personnelles de 3 milliards de personnes - similitudes et diff√©rences de l√©gislation dans les pays BRICS</a></li>
<li><a href="../fr412741/index.html">Comment arr√™ter d'avoir peur que l'intelligence artificielle vous laisse sans travail</a></li>
<li><a href="../fr412743/index.html">Profession: Cyber ‚Äã‚Äãd√©tective</a></li>
<li><a href="../fr412747/index.html">MIS. Stockage de donn√©es m√©dicales</a></li>
<li><a href="../fr412749/index.html">L'√©lectronique en tant qu'art: le courant √©lectrique</a></li>
<li><a href="../fr412751/index.html">Calvitie: Th√©orie et pratique du traitement, partie 1 "Ma dihydrotestost√©rone, mon ennemi"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>