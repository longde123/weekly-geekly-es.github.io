<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛🏻 🕍 🍁 Pola asyncio coroutine: menunggu di luar 🦓 🏄 👨🏾‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kata pengantar penerjemah: 
 Sekali lagi menginjak menyapu sambil bekerja dengan python asyncio, saya pergi ke Internet untuk menemukan sesuatu yang l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pola asyncio coroutine: menunggu di luar</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420129/"><p>  <em>Kata pengantar penerjemah:</em> <em><br></em>  <em>Sekali lagi menginjak menyapu sambil bekerja dengan python asyncio, saya pergi ke Internet untuk menemukan sesuatu yang lebih menyenangkan daripada dokumentasi kering.</em>  <em>Saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menemukan</a> sebuah artikel oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Yeray Diaz "Asyncio Coroutine Patterns: Beyond waiting"</a> , di mana penulis dengan sangat menarik mempertimbangkan penggunaan asyncio dan berbagi beberapa trik.</em>  <em>Karena saya tidak menemukan sesuatu yang lengkap dalam bahasa Rusia, saya memutuskan untuk menerjemahkannya.</em> </p><br><p>  Asyncio adalah mimpi kompetitif programmer python: Anda menulis kode yang berbatasan dengan sinkron dan membiarkan Python melakukan sisanya.  Ini adalah impor lain dari perpustakaan anti-gravitasi: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">impor anti-gravitasi</a> </p><br><p>  Sebenarnya, ini sama sekali tidak benar, pemrograman bersamaan adalah kerja keras, dan sementara coroutine memungkinkan kita untuk menghindari panggilan balik neraka, yang dapat membawa Anda cukup jauh, Anda masih perlu berpikir tentang membuat tugas, mendapatkan hasil, dan menangkap pengecualian secara elegan.  Menyedihkan. </p><br><p>  Berita baiknya adalah semua ini dimungkinkan di asyncio.  Berita buruknya adalah tidak selalu jelas dengan segera apa yang salah dan bagaimana cara memperbaikinya.  Berikut adalah beberapa pola yang saya temukan saat bekerja dengan asyncio. </p><a name="habracut"></a><br><br><p>  Sebelum kita mulai: </p><br><p>  Saya menggunakan pustaka aiohttp favorit saya untuk mengeksekusi permintaan HTTP asinkron dan Hacker News API karena itu adalah situs sederhana dan terkenal yang mengikuti skenario penggunaan yang sudah umum.  Mengikuti respons terhadap <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sebelumnya</a> , saya juga menggunakan sintaks async / waiting yang diperkenalkan dengan Python 3.5.  Saya berasumsi bahwa pembaca sudah terbiasa dengan ide-ide yang dijelaskan di sini.  Dan pada akhirnya, semua contoh tersedia di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori GitHub dari artikel ini</a> . </p><br><p>  Ok, mari kita mulai! </p><br><h2 id="rekursivnye-korutiny">  Coroutine rekursif </h2><br><p>  Membuat dan menjalankan tugas sepele di asyncio.  Untuk tugas-tugas tersebut, API mencakup beberapa metode di kelas AbstractEventLoop, serta fungsi di pustaka.  Tetapi biasanya Anda ingin menggabungkan hasil dari tugas-tugas ini dan memprosesnya dengan beberapa cara, dan rekursi adalah contoh yang bagus dari skema ini, dan juga menunjukkan kesederhanaan coroutine dibandingkan dengan alat kompetitif lainnya. </p><br><p>  Kasus umum untuk menggunakan asyncio adalah membuat semacam perayap web.  Bayangkan kita terlalu sibuk untuk memeriksa HackerNews, atau mungkin Anda hanya menyukai holivar yang baik, jadi Anda ingin menerapkan sistem yang mengambil jumlah komentar untuk pos HN tertentu dan, jika di atas ambang batas, memberi tahu Anda.  Anda mencari di Google sedikit dan menemukan dokumentasi untuk HN API, hanya apa yang Anda butuhkan, tetapi Anda perhatikan yang berikut dalam dokumentasi: </p><br><blockquote>  Ingin tahu jumlah total komentar artikel?  Berkeliling pohon dan menghitungnya. </blockquote><p>  Panggilan diterima! </p><br><pre><code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""          ,       ,      . ,         Hacker News      """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib.parse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlparse, parse_qs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the comments of a Hacker News post.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--id'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">8863</span></span>, help=<span class="hljs-string"><span class="hljs-string">'ID of the post in HN, defaults to 8863'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--url'</span></span>, type=str, help=<span class="hljs-string"><span class="hljs-string">'URL of a post in HN'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) now = datetime.now() response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) log.debug(<span class="hljs-string"><span class="hljs-string">'{:^6} &gt; Fetching of {} took {} seconds'</span></span>.format( post_id, url, (datetime.now() - now).total_seconds())) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment">#  .   return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       log.debug('{:^6} &gt; Fetching {} child posts'.format( post_id, number_of_comments)) tasks = [post_number_of_comments(loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments def id_from_HN_url(url): """   `id` URL       None. """ parse_result = urlparse(url) try: return parse_qs(parse_result.query)['id'][0] except (KeyError, IndexError): return None if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) post_id = id_from_HN_url(args.url) if args.url else args.id loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: now = datetime.now() comments = loop.run_until_complete( post_number_of_comments(loop, session, post_id)) log.info( '&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("-- Post {} has {} comments".format(post_id, comments)) loop.close()</span></span></code> </pre> <br><p>  <em>Jangan ragu untuk menjalankan skrip dengan flag "-verbose" untuk hasil yang lebih detail.</em> </p><br><pre> <code class="hljs css"> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[14:47:32]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.23</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[14:47:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span></code> </pre> <br><p>  Mari kita lewati kode boilerplate dan langsung ke coroutine rekursif.  Perhatikan bahwa kode ini dibaca hampir sepenuhnya seperti halnya dengan kode sinkron. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) now = datetime.now() response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) log.debug(<span class="hljs-string"><span class="hljs-string">'{:^6} &gt; Fetching of {} took {} seconds'</span></span>.format( post_id, url, (datetime.now() - now).total_seconds())) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       log.debug('{:^6} &gt; Fetching {} child posts'.format( post_id, number_of_comments)) tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #          number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments</span></span></code> </pre> <br><ol><li>  Pertama kita dapatkan JSON dengan data posting. </li><li>  Secara rekursif berkeliling setiap ahli waris. </li><li>  Pada akhirnya, kita akan mencapai kasus dasar dan mengembalikan nol, <br>  ketika pos tidak memiliki umpan balik. </li><li>  Ketika kembali dari kasing, tambahkan jawaban ke pos saat ini <br>  ke jumlah ahli waris dan kembali </li></ol><br><p>  Ini adalah contoh yang bagus dari apa yang digambarkan Brett Slatkin sebagai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penggemar dan penggemar</a> , kami penggemar untuk menerima data dari ahli waris dan fan-in merangkum data untuk menghitung jumlah komentar </p><br><p>  Ada beberapa cara di API asyncio untuk melakukan operasi penggeledahan ini.  Di sini saya menggunakan fungsi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kumpulkan</a> , yang secara efektif mengharapkan semua coroutine untuk melengkapi dan mengembalikan daftar hasil mereka. </p><br><p>  Mari kita perhatikan bagaimana penggunaan coroutine juga sesuai dengan rekursi dengan satu titik di mana sejumlah coroutine hadir, menunggu jawaban atas permintaan mereka selama panggilan ke fungsi kumpul dan melanjutkan eksekusi setelah operasi I / O selesai.  Ini memungkinkan kita untuk mengekspresikan perilaku yang agak rumit dalam satu corutin yang elegan dan mudah dibaca. </p><br><p>  "Sangat sederhana," katamu?  Oke, mari kita naik satu tingkat. </p><br><h2 id="vystrelil-i-zabyl">  Ditembak dan lupa </h2><br><p>  Bayangkan Anda ingin mengirim sendiri pesan email dengan postingan yang memiliki lebih banyak komentar daripada nilai tertentu, dan Anda ingin melakukan ini dengan cara yang sama seperti ketika kita memutari pohon postingan.  Kami cukup menambahkan pernyataan if di akhir fungsi rekursif untuk mencapai ini: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""           . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment">#  .   return 0 #       . number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments(loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) #        if number_of_comments &gt; MIN_COMMENTS: await log_post(response) return number_of_comments async def log_post(post): """   . """ await asyncio.sleep(random() * 3) log.info("Post logged")</span></span></code> </pre><br><p>  <em>Ya, saya menggunakan asyncio.sleep.</em>  <em>Ini yang terakhir.</em>  <em>Aku janji.</em> </p><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:02]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:04]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 6<span class="hljs-selector-class"><span class="hljs-selector-class">.35</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:41:06]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span></code> </pre> <br><p>  Ini jauh lebih lambat dari sebelumnya! <br>  Alasannya adalah, seperti yang telah kita bahas sebelumnya, menunggu jeda eksekusi coroutine sampai masa depan selesai, tetapi karena kita tidak memerlukan hasil logging, tidak ada alasan nyata untuk melakukan ini. </p><br><p>  Kita perlu "menembak dan melupakan" dengan coroutine kita, dan karena kita tidak bisa menunggu sampai selesai menggunakan menunggu, kita perlu cara lain untuk memulai coroutine tanpa menunggu.  Melihat sekilas pada API asyncio akan menemukan fungsi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sure_future</a> yang akan menjadwalkan coroutine untuk dijalankan, membungkusnya dalam objek Task, dan mengembalikannya.  Mengingat bahwa sebelum coroutine direncanakan, siklus peristiwa akan mengendalikan hasil coroutine kita di beberapa titik di masa depan, ketika coroutine lain akan berada dalam kondisi yang diharapkan. </p><br><p>  Luar biasa, mari kita ganti menunggu log_post sebagai berikut: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""           . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #       . number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) #        if number_of_comments &gt; MIN_COMMENTS: asyncio.ensure_future(log_post(response)) return number_of_comments</span></span></code> </pre><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">1.69</span></span> seconds and <span class="hljs-number"><span class="hljs-number">73</span></span> fetches [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] -- Post <span class="hljs-number"><span class="hljs-number">8863</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x1109197f8</span></span>&gt;()]&gt;&gt; [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x110919948</span></span>&gt;()]&gt;&gt; [<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>] Task was destroyed but it is pending! task: &lt;Task pending coro=&lt;log_post() done, defined at <span class="hljs-number"><span class="hljs-number">02</span></span>_fire_and_forget.py:<span class="hljs-number"><span class="hljs-number">82</span></span>&gt; wait_for=&lt;Future pending cb=[&lt;<span class="hljs-type"><span class="hljs-type">TaskWakeupMethWrapper</span></span> <span class="hljs-type"><span class="hljs-type">object</span></span> <span class="hljs-type"><span class="hljs-type">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x110919978</span></span>&gt;()]&gt;&gt;</code> </pre> <br><p>  Ahem, <abbr title="Tugas telah dihancurkan, tetapi sedang diselesaikan!">Tugas yang</abbr> luar biasa <abbr title="Tugas telah dihancurkan, tetapi sedang diselesaikan!">telah dihancurkan tetapi sedang menunggu!</abbr>  menghantui pengguna asyncio di seluruh dunia.  Kabar baiknya adalah bahwa kita kembali ke waktu yang kita terima sebelumnya (1,69 hal.), Kabar buruknya adalah bahwa asyncio tidak suka melampaui rentang tembakan-dan-lupakan. </p><br><p>  Masalahnya adalah kita dengan paksa menutup loop acara setelah kita mendapatkan hasil dari postoutnumber_of_comments <em>coroutine</em> , tanpa meninggalkan tugas kita <em>log_post</em> waktu untuk menyelesaikan. </p><br><p>  Kami memiliki dua opsi: <br>  kami membiarkan loop acara bekerja tanpa henti menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">run_forever</a> dan menghentikan skrip secara manual, atau kami menggunakan metode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">all_tasks</a> dari kelas Tugas untuk menemukan semua tugas yang berjalan dan menunggu perhitungan jumlah komentar selesai. </p><br><p>  Mari kita coba keluar dari situasi ini dengan cepat membuat perubahan setelah panggilan kita ke <em>post_number_of_comments</em> : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: args = <span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.parse_args() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.setLevel(logging.<span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span>) post_id = id_from_HN_url(args.url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.url <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> args.id <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> = asyncio.get_event_loop() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> aiohttp.ClientSession(<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>: now = datetime.now() comments = <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.run_until_complete( post_number_of_comments(<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>, post_id)) <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_counter)) <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>("-- Post {} has {} comments".format(post_id, comments)) pending_tasks = [ task <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> asyncio.Task.all_tasks() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> task.done()] <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.run_until_complete(asyncio.gather(*pending_tasks)) <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>()</code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:29]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.72</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:29]</span></span> — <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:30]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:31]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:47:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span></code> </pre> <br><p>  Sekarang kami yakin bahwa tugas logging sudah selesai. <br>  Asumsi bahwa metode <em>all_tasks berfungsi dengan</em> baik dalam kasus-kasus yang kita hadapi adalah ide bagus ketika tugas dilakukan dengan tepat di loop acara kami, tetapi dalam kasus yang lebih kompleks ada sejumlah tugas yang dapat dilakukan, sumber yang dapat ditemukan di luar kode kita . </p><br><p>  Pendekatan lain adalah memulihkan ketertiban setelah kami secara mandiri mendaftarkan sepenuhnya semua coroutine yang kami rencanakan untuk diluncurkan dan memungkinkan untuk dieksekusi, yang ditunda sebelumnya, <br>  segera setelah penghitungan komentar selesai.  Seperti yang Anda ketahui, fungsi <em>sure_future</em> mengembalikan objek <em>Tugas</em> . Kita dapat menggunakan ini untuk mendaftarkan tugas kami dengan prioritas rendah.  Mari kita mendefinisikan daftar <em>task_registry</em> dan menyimpan futures di dalamnya: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Retrieve data for current post and recursively for all comments. """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 # calculate this post's comments as number of comments number_of_comments = len(response['kids']) # create recursive tasks for all comments tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] # schedule the tasks and retrieve results results = await asyncio.gather(*tasks) # reduce the descendents comments and add it to this post's number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) # Log if number of comments is over a threshold if number_of_comments &gt; MIN_COMMENTS: # Add the future to the registry task_registry.append(asyncio.ensure_future(log_post(response))) return number_of_comments # (... ommitted code ...) # if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) post_id = id_from_HN_url(args.url) if args.url else args.id loop = asyncio.get_event_loop() task_registry = [] # define our task registry with aiohttp.ClientSession(loop=loop) as session: now = datetime.now() comments = loop.run_until_complete( post_number_of_comments(loop, session, post_id)) log.info( '&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("-- Post {} has {} comments".format(post_id, comments)) pending_tasks = [task for task in task_registry if not task.done()] loop.run_until_complete(asyncio.gather(*pending_tasks)) loop.close()</span></span></code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Calculating</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">took</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> 73 <span class="hljs-selector-tag"><span class="hljs-selector-tag">fetches</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> — <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> 8863 <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> 72 <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:46]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:48]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[09:53:49]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logged</span></span></code> </pre> <br><p>  Kita belajar pelajaran berikut - <em>asyncio</em> tidak boleh dilihat sebagai antrian tugas terdistribusi seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><em>Celery</em></a> .  Semua tugas diluncurkan dalam satu utas dan siklus acara harus dikelola sesuai, memungkinkan Anda untuk mengalokasikan waktu untuk menyelesaikan tugas. </p><br><p>  Yang mengarah ke pola lain yang diterima secara umum: </p><br><h2 id="periodicheski-zapuskaemye-korutiny">  Coroutine yang dipicu secara berkala </h2><br><p>  Melanjutkan dengan contoh kami tentang HN (dan kami melakukan pekerjaan yang baik sebelumnya), kami memutuskan <br>  yang sangat penting untuk menghitung jumlah komentar pada publikasi HN segera setelah tersedia dan saat mereka berada dalam daftar 5 entri terbaru. </p><br><p>  Pandangan cepat pada HN API menunjukkan titik akhir yang mengembalikan 500 catatan terakhir.  Hebat, jadi kita bisa polling titik akhir ini untuk menerima publikasi baru dan menghitung jumlah komentar pada mereka, katakan setiap lima detik. </p><br><p>  Nah, karena kita sekarang pindah ke polling periodik, kita bisa menggunakan loop infinite <em>while</em> , menunggu tugas polling selesai (panggilan <em>tunggu</em> ), dan <em>tertidur</em> (call <em>sleep</em> ) untuk jumlah waktu yang diperlukan.  Saya membuat beberapa perubahan kecil untuk mendapatkan entri teratas daripada menggunakan URL posting langsung. </p><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" An example of periodically scheduling coroutines using an infinite loop of awaiting and sleeping. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> TOP_STORIES_URL = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/topstories.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the number of comments of the top stories in HN.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--period'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of seconds between poll'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--limit'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>,help=<span class="hljs-string"><span class="hljs-string">'Number of new stories to calculate comments for'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(session, url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'kids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response: <span class="hljs-comment"><span class="hljs-comment"># base case, there are no comments return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, kid_id) for kid_id in response['kids']] #      results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments async def get_comments_of_top_stories(loop, session, limit, iteration): """     HN. """ response = await fetch(session, TOP_STORIES_URL) tasks = [post_number_of_comments(loop, session, post_id) for post_id in response[:limit]] results = await asyncio.gather(*tasks) for post_id, num_comments in zip(response[:limit], results): log.info("Post {} has {} comments ({})".format(post_id, num_comments, iteration)) async def poll_top_stories_for_comments(loop, session, period, limit): """         . """ global fetch_counter iteration = 1 while True: now = datetime.now() log.info("Calculating comments for top {} stories. ({})".format(limit, iteration)) await get_comments_of_top_stories(loop, session, limit, iteration) log.info('&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info("Waiting for {} seconds...".format(period)) iteration += 1 fetch_counter = 0 await asyncio.sleep(period) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: loop.run_until_complete( poll_top_stories_for_comments( loop, session, args.period, args.limit)) loop.close()</span></span></code> </pre> <br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">31</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">37</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">15</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">128</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">27</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">2.96</span></span> seconds and <span class="hljs-number"><span class="hljs-number">244</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">31</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">37</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">15</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">128</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">27</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">3.04</span></span> seconds and <span class="hljs-number"><span class="hljs-number">244</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds…</code> </pre> <br><p>  Hebat, tapi ada masalah kecil: jika Anda memperhatikan cap waktu, <br>  maka tugas tidak dimulai secara ketat setiap 5 detik, itu dimulai 5 detik <strong><em>setelah</em></strong> <strong><em>get_comments_of_top_stories selesai</em></strong> .  Lagi-lagi konsekuensi dari penggunaan <em>menunggu</em> dan memblokir sampai kami mendapatkan hasil kami kembali. <br>  Fitur-fitur ini tidak menimbulkan masalah ketika tugas membutuhkan waktu lebih dari lima detik.  Juga, tampaknya keliru menggunakan _run_until <em>lengkap</em> ketika coroutine dirancang untuk menjadi tak terbatas. </p><br><p>  Kabar baiknya adalah bahwa kita sekarang adalah pakar di <em>sure_future</em> , dan kita bisa memasukkannya ke dalam kode alih-alih menggunakan <em>menunggu</em> ... </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> fetch_counter iteration = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: now = datetime.now() log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories. ({})"</span></span>.format( limit, iteration)) asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_counter)) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(period)</code> </pre><br><pre> <code class="hljs powershell"> [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds and <span class="hljs-number"><span class="hljs-number">0</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">32</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">48</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">16</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">129</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">29</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds and <span class="hljs-number"><span class="hljs-number">260</span></span> fetches [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">32</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">48</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">16</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13845337</span></span> has <span class="hljs-number"><span class="hljs-number">129</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">29</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><p>  Ahem ... Oke, kabar baiknya adalah bahwa stempel waktu terletak tepat lima detik kemudian, tapi apa yang ada dalam 0,00 detik dan tidak ada sampel. Kemudian iterasi berikutnya membutuhkan nol detik dan 260 sampel? </p><br><p>  Ini adalah salah satu konsekuensi dari menghindari menunggu, sekarang kita tidak lagi memblokir coroutine dan hanya pergi ke baris berikutnya, yang mencetak nol detik dan, untuk pertama kalinya, nol pesan diambil.  Ini adalah tugas yang cukup kecil, karena kita dapat hidup tanpa pesan, tetapi bagaimana jika kita membutuhkan hasil tugas? </p><br><p>  Kemudian, teman saya, kita perlu menggunakan ... panggilan balik (ngeri (()) </p><br><p>  Saya tahu, saya tahu, inti dari coroutine adalah untuk menghindari panggilan balik, tetapi itu karena subtitle dramatis dari artikel ini adalah "Di luar menunggu".  Kami tidak lagi berada di wilayah <em>menunggu</em> , kami memiliki petualangan dengan peluncuran tugas secara manual, yang mengarah ke kasus penggunaan kami.  Apa yang ini berikan padamu?  <abbr title="tidak terlalu buruk">spoiler</abbr> </p><br><p>  Seperti yang telah kita bahas sebelumnya, <em>sure_future</em> mengembalikan objek <em>Masa Depan</em> yang dapat kita tambahkan callback menggunakan _add_done <em>callback</em> . </p><br><p>  Sebelum kita melakukan ini, dan untuk mendapatkan penghitungan pengambilan yang benar, kita sampai pada titik bahwa kita perlu merangkum ekstraksi coroutine kita ke dalam kelas <em>URLFetcher</em> .  Dalam hal ini, kami membuat contoh untuk setiap tugas sehingga kami memiliki jumlah sampel yang benar.  Kami juga menghapus variabel global yang memperkenalkan bug: </p><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""               ensure_future   sleep.      future,    ensure_future,         ,    URLFetcher   . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> argparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> async_timeout LOGGER_FORMAT = <span class="hljs-string"><span class="hljs-string">'%(asctime)s %(message)s'</span></span> URL_TEMPLATE = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/item/{}.json"</span></span> TOP_STORIES_URL = <span class="hljs-string"><span class="hljs-string">"https://hacker-news.firebaseio.com/v0/topstories.json"</span></span> FETCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">10</span></span> parser = argparse.ArgumentParser(description=<span class="hljs-string"><span class="hljs-string">'Calculate the number of comments of the top stories in HN.'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--period'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of seconds between poll'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--limit'</span></span>, type=int, default=<span class="hljs-number"><span class="hljs-number">5</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Number of new stories to calculate comments for'</span></span>) parser.add_argument(<span class="hljs-string"><span class="hljs-string">'--verbose'</span></span>, action=<span class="hljs-string"><span class="hljs-string">'store_true'</span></span>, help=<span class="hljs-string"><span class="hljs-string">'Detailed output'</span></span>) logging.basicConfig(format=LOGGER_FORMAT, datefmt=<span class="hljs-string"><span class="hljs-string">'[%H:%M:%S]'</span></span>) log = logging.getLogger() log.setLevel(logging.INFO) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLFetcher</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   URL     """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): self.fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_number_of_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, fetcher, post_id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          . """</span></span> url = URL_TEMPLATE.format(post_id) response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetcher.fetch(session, url) <span class="hljs-comment"><span class="hljs-comment">#  .  . if response is None or 'kids' not in response: return 0 #     ,    (  ) number_of_comments = len(response['kids']) #       tasks = [post_number_of_comments( loop, session, fetcher, kid_id) for kid_id in response['kids']] # s     results = await asyncio.gather(*tasks) #            number_of_comments += sum(results) log.debug('{:^6} &gt; {} comments'.format(post_id, number_of_comments)) return number_of_comments async def get_comments_of_top_stories(loop, session, limit, iteration): """    HN. """ fetcher = URLFetcher() # create a new fetcher for this task response = await fetcher.fetch(session, TOP_STORIES_URL) tasks = [post_number_of_comments( loop, session, fetcher, post_id) for post_id in response[:limit]] results = await asyncio.gather(*tasks) for post_id, num_comments in zip(response[:limit], results): log.info("Post {} has {} comments ({})".format( post_id, num_comments, iteration)) return fetcher.fetch_counter # return the fetch count async def poll_top_stories_for_comments(loop, session, period, limit): """         . """ iteration = 1 while True: log.info("Calculating comments for top {} stories. ({})".format(limit, iteration)) future = asyncio.ensure_future(get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() def callback(fut): fetch_count = fut.result() log.info('&gt; Calculating comments took {:.2f} seconds and {} fetches'.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info("Waiting for {} seconds...".format(period)) iteration += 1 await asyncio.sleep(period) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: loop.run_until_complete( poll_top_stories_for_comments( loop, session, args.period, args.limit)) loop.close()</span></span></code> </pre> <br><pre> <code class="hljs powershell"> [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds... [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">38</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">19</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848283</span></span> has <span class="hljs-number"><span class="hljs-number">64</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">34</span></span> comments (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">3.17</span></span> seconds and <span class="hljs-number"><span class="hljs-number">233</span></span> fetches [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds... [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848196</span></span> has <span class="hljs-number"><span class="hljs-number">38</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849430</span></span> has <span class="hljs-number"><span class="hljs-number">72</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13849037</span></span> has <span class="hljs-number"><span class="hljs-number">19</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13848283</span></span> has <span class="hljs-number"><span class="hljs-number">64</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] Post <span class="hljs-number"><span class="hljs-number">13847465</span></span> has <span class="hljs-number"><span class="hljs-number">34</span></span> comments (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>] &gt; Calculating comments took <span class="hljs-number"><span class="hljs-number">2.47</span></span> seconds and <span class="hljs-number"><span class="hljs-number">233</span></span> fetches [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">3</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds...</code> </pre> <br><p> ,  ,      callback: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""         . """</span></span> iteration = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories. ({})"</span></span>.format( limit, iteration)) future = asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fut)</span></span></span><span class="hljs-function">:</span></span> fetch_count = fut.result() log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(period)</code> </pre><br><p>    ,  <em>callback</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">    ,      future.</a>     (fetch)   <em>URLFetcher</em>   _get_comments_of_top <em>stories</em>       future. </p><br><p>  Lihat?   ,    ,     <em>await</em> . </p><br><p>    callback-,      API asyncio       <em>AbstractBaseLoop</em>   _call <em>later</em>  _call <em>at</em> , <br>    -     .    ,   ,       <em>poll_top_stories_for_comments</em> : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_top_stories_for_comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop, session, period, limit, iteration=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     get_comments_of_top_stories. """</span></span> log.info(<span class="hljs-string"><span class="hljs-string">"Calculating comments for top {} stories ({})"</span></span>.format( limit, iteration)) future = asyncio.ensure_future( get_comments_of_top_stories(loop, session, limit, iteration)) now = datetime.now() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fut)</span></span></span><span class="hljs-function">:</span></span> fetch_count = fut.result() log.info( <span class="hljs-string"><span class="hljs-string">'&gt; Calculating comments took {:.2f} seconds and {} fetches'</span></span>.format( (datetime.now() - now).total_seconds(), fetch_count)) future.add_done_callback(callback) log.info(<span class="hljs-string"><span class="hljs-string">"Waiting for {} seconds..."</span></span>.format(period)) iteration += <span class="hljs-number"><span class="hljs-number">1</span></span> loop.call_later( period, partial( <span class="hljs-comment"><span class="hljs-comment"># or call_at(loop.time() + period) poll_top_stories_for_comments, loop, session, period, limit, iteration ) ) if __name__ == '__main__': args = parser.parse_args() if args.verbose: log.setLevel(logging.DEBUG) loop = asyncio.get_event_loop() with aiohttp.ClientSession(loop=loop) as session: poll_top_stories_for_comments( loop, session, args.period, args.limit) loop.run_forever() loop.close()</span></span></code> </pre><br><p>    .     : </p><br><ul><li>              ,     <em>ensure_future</em>     . <br> ( :   ) </li><li>  _poll_top_stories_for <em>comments</em>       ,     ,      _run <em>forever</em>  ,     . </li></ul><br><p> ,      , ,     —      ?      ?           URL: </p><br><pre> <code class="python hljs">MAXIMUM_FETCHES = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLFetcher</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   URL     """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.fetch_counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, session, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  URL   aiohttp,    JSON .     aiohttp    . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> async_timeout.timeout(FETCH_TIMEOUT): self.fetch_counter += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.fetch_counter &gt; MAXIMUM_FETCHES: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.get(url) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.json()</code> </pre><br><pre> <code class="hljs pgsql"> [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds… [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> callback poll_top_stories_for_comments.&lt;locals&gt;.callback(&lt;Task finishe…ion(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>,)&gt;) at <span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py:<span class="hljs-number"><span class="hljs-number">121</span></span> handle: &lt;Handle poll_top_stories_for_comments.&lt;locals&gt;.callback(&lt;Task finishe…ion(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>,)&gt;) at <span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py:<span class="hljs-number"><span class="hljs-number">121</span></span>&gt; Traceback (most recent <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> last): File “/Users/yeray/.pyenv/versions/<span class="hljs-number"><span class="hljs-number">3.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/lib/python3<span class="hljs-number"><span class="hljs-number">.6</span></span>/asyncio/events.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _run self._callback(*self._args) File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> callback fetch_count = fut.result() File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> get_comments_of_top_stories results = await asyncio.gather(*tasks) File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> post_number_of_comments response = await fetcher.<span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>, url) File “<span class="hljs-number"><span class="hljs-number">05</span></span>_periodic_coroutines.py”, <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'BOOM!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>: BOOM! [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>] Calculating comments <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> top <span class="hljs-number"><span class="hljs-number">5</span></span> stories. (<span class="hljs-number"><span class="hljs-number">2</span></span>) [<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> seconds…</code> </pre> <br><p>   , ? </p><br><p>  Apa yang harus dilakukan      ,    ,          : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> asyncio :   </a> </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id420129/">https://habr.com/ru/post/id420129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id420117/index.html">Panduan Antrian Sederhana di Mikrotik</a></li>
<li><a href="../id420119/index.html">10 kerangka kerja web Python layak untuk digunakan pada tahun 2018</a></li>
<li><a href="../id420121/index.html">Uji Kekuatan: Rayap LT450, LXI</a></li>
<li><a href="../id420123/index.html">Apa sebenarnya Node.js?</a></li>
<li><a href="../id420125/index.html">Otomasi dalam keuangan: karyawan bank dapat dibiarkan tanpa pekerjaan karena robot</a></li>
<li><a href="../id420131/index.html">Metode Penambangan Bitcoin Probabilistik</a></li>
<li><a href="../id420133/index.html">Pemodelan sistem dinamis: Bagaimana bulan bergerak?</a></li>
<li><a href="../id420135/index.html">Ini juga Toshiba: produk yang tidak terduga dari perusahaan Jepang</a></li>
<li><a href="../id420139/index.html">Buku “Rekayasa Keandalan Situs. Keandalan dan keandalan seperti di Google »</a></li>
<li><a href="../id420141/index.html">Dari MPMS DBMS yang dimuat - Danau Data peppy dengan alat analitis: bagikan detail pembuatannya</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>