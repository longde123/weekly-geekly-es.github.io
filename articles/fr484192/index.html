<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂üèø üö∑ üåÑ Applications faciles et faciles √† d√©ployer sur la cartouche Tarantool (partie 2) üë®üèæ‚Äçüíº üò™ üïî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Plus r√©cemment, nous avons expliqu√© comment d√©ployer des applications √©crites dans Tarantool Cartridge . Mais l'op√©ration ne se termine pas sur le d√©p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Applications faciles et faciles √† d√©ployer sur la cartouche Tarantool (partie 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/484192/"><p><img src="https://habrastorage.org/webt/yc/gm/xx/ycgmxxaqlvyslsrzoo6jnv1vmx0.jpeg"></p><br><p>  Plus r√©cemment, nous <a href="https://habr.com/ru/company/mailru/blog/478710/">avons</a> <a href="https://habr.com/ru/company/mailru/blog/465503/">expliqu√©</a> comment d√©ployer des applications √©crites dans <a href="https://habr.com/ru/company/mailru/blog/465503/">Tarantool Cartridge</a> .  Mais l'op√©ration ne se termine pas sur le d√©ploiement, nous allons donc aujourd'hui mettre √† jour notre application et comprendre comment g√©rer la topologie, le partage et l'autorisation, ainsi que changer la configuration des r√¥les. </p><br><p>  Curieux, coupez! </p><a name="habracut"></a><br><h2 id="na-chem-my-ostanovilis">  O√π nous sommes-nous arr√™t√©s </h2><br><p>  La derni√®re fois que nous avons configur√© la topologie suivante: </p><br><p><img src="https://habrastorage.org/webt/sw/0z/gm/sw0zgm53me7ft63db8lxrswcxvw.png"></p><br><p> <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">L'</a> exemple de <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">r√©f√©rentiel a</a> r√©ussi √† changer un peu, de nouveaux fichiers y sont apparus, <code>getting-started-app-2.0.0-0.rpm</code> et <code>hosts.updated.2.yml</code> .  Vous n'avez pas √† extraire la nouvelle version, vous pouvez simplement t√©l√©charger le package √† partir du <a href="">lien</a> , et <code>hosts.updated.2.yml</code> n√©cessaire uniquement pour que vous puissiez y jeter un coup d'≈ìil en cas de difficult√©s avec la modification de l'inventaire actuel. </p><br><p>  Si vous avez termin√© toutes les √©tapes de la partie pr√©c√©dente de ce tutoriel, alors maintenant dans votre <code>hosts.yml</code> hosts.yml <code>hosts.yml</code> il y a une configuration de cluster avec deux r√©pliques de <code>storage</code> (dans le r√©f√©rentiel, c'est <code>hosts.updated.yml</code> ). </p><br><p>  √âlevez nos machines virtuelles: </p><br><pre> <code class="bash hljs">$ vagrant up</code> </pre> <br><p>  Installez la nouvelle version de la cartouche Tarantool √† r√¥le Ansible (elle a r√©ussi √† changer, bien s√ªr, pour le mieux): </p><br><pre> <code class="bash hljs">$ ansible-galaxy install tarantool.cartridge,1.0.2</code> </pre> <br><p>  Ainsi, la configuration actuelle du cluster: </p><br><pre> <code class="plaintext hljs">--- all: vars: # common cluster variables cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-1.0.0-0.rpm # path to package cartridge_cluster_cookie: app-default-cookie # cluster cookie # common ssh options ansible_ssh_private_key_file: ~/.vagrant.d/insecure_private_key ansible_ssh_common_args: '-o IdentitiesOnly=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' # INSTANCES hosts: storage-1: config: advertise_uri: '172.19.0.2:3301' http_port: 8181 app-1: config: advertise_uri: '172.19.0.3:3301' http_port: 8182 storage-1-replica: config: advertise_uri: '172.19.0.3:3302' http_port: 8183 storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 children: # GROUP INSTANCES BY MACHINES host1: vars: # first machine connection options ansible_host: 172.19.0.2 ansible_user: vagrant hosts: # instances to be started on the first machine storage-1: storage-2-replica: host2: vars: # second machine connection options ansible_host: 172.19.0.3 ansible_user: vagrant hosts: # instances to be started on the second machine app-1: storage-1-replica: storage-2: # GROUP INSTANCES BY REPLICA SETS replicaset_app_1: vars: # replica set configuration replicaset_alias: app-1 failover_priority: - app-1 # leader roles: - 'api' hosts: # replica set instances app-1: replicaset_storage_1: vars: # replica set configuration replicaset_alias: storage-1 weight: 3 failover_priority: - storage-1 # leader - storage-1-replica roles: - 'storage' hosts: # replica set instances storage-1: storage-1-replica: replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 2 failover_priority: - storage-2 - storage-2-replica roles: - 'storage' hosts: # replicaset instances storage-2: storage-2-replica:</code> </pre> <br><p>  Acc√©dez √† <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> et assurez-vous que votre cluster est dans le bon √©tat. </p><br><p>  Tout est identique √† la derni√®re fois: nous allons progressivement changer ce fichier et observer comment le cluster change.  Vous pouvez toujours consulter la version finale dans <code>hosts.updated.2.yml</code> </p><br><p>  Alors c'est parti! </p><br><h2 id="obnovlyaem-prilozhenie">  Mise √† jour de l'application </h2><br><p>  Pour commencer, mettons √† jour notre application.  Assurez-vous que le fichier <code>getting-started-app-2.0.0-0.rpm</code> dans le r√©pertoire actuel (sinon, <a href="">t√©l√©chargez-</a> le depuis le r√©f√©rentiel). </p><br><p>  Sp√©cifiez le chemin d'acc√®s √† la nouvelle version du package: </p><br><pre> <code class="plaintext hljs">--- all: vars: cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-2.0.0-0.rpm # &lt;== cartridge_enable_tarantool_repo: false # &lt;==</code> </pre> <br><p>  Nous avons sp√©cifi√© <code>cartridge_enable_tarantool_repo: false</code> pour que le r√¥le ne connecte pas le r√©f√©rentiel avec le package Tarantool, que nous avons d√©j√† install√© la derni√®re fois.  Cela acc√©l√©rera l√©g√®rement le processus de d√©ploiement, mais ce n'est absolument pas n√©cessaire. </p><br><p>  Lancez le playbook avec la balise <code>cartridge-instances</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-instances</code> </pre> <br><p>  Et nous v√©rifions que le package a √©t√© mis √† jour: </p><br><pre> <code class="bash hljs">$ vagrant ssh vm1 [vagrant@svm1 ~]$ sudo yum list installed | grep getting-started-app</code> </pre> <br><p>  V√©rifiez que la version est devenue <code>2.0.0</code> : </p><br><pre> <code class="bash hljs">getting-started-app.x86_64 2.0.0-0 installed</code> </pre> <br><p>  Vous pouvez maintenant exp√©rimenter en toute s√©curit√© avec la nouvelle version de l'application. </p><br><h2 id="vklyuchaem-shardirovanie">  Activer le sharding </h2><br><p>  Activons le partage afin de pouvoir prendre le contr√¥le des r√©pliques de <code>storage</code> plus tard.  Cela se fait tr√®s simplement.  Ajoutez la variable <code>cartridge_bootstrap_vshard</code> section <code>all.vars</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Nous lan√ßons: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Veuillez noter que nous avons sp√©cifi√© la balise <code>cartridge-config</code> pour ex√©cuter uniquement les t√¢ches impliqu√©es dans la configuration du cluster. </p><br><p>  Ouvrez l'interface utilisateur Web <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> et <a href="http://localhost:8181/admin/cluster/dashboard">v√©rifiez</a> que nos compartiments sont r√©partis sur les jeux de r√©plicas de stockage dans un rapport <code>2:3</code> (nous avons sp√©cifi√© de tels poids pour nos jeux de r√©pliques, vous vous souvenez?): </p><br><p><img src="https://habrastorage.org/webt/g_/vd/78/g_vd787hpifhrlhk-jfs5sw8iu4.png"></p><br><h2 id="vklyuchaem-avtomaticheskiy-failover">  Activer le basculement automatique </h2><br><p>  Et maintenant, nous allons activer le mode de basculement automatique afin que nous puissions comprendre ce que c'est et comment cela fonctionne un peu plus tard. </p><br><p>  Ajoutez l'indicateur de <code>cartridge_failover</code> √† la configuration: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true cartridge_failover: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Nous recommen√ßons les t√¢ches de gestion du cluster: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Une fois le playbook termin√©, vous pouvez acc√©der √† l'interface utilisateur Web et vous assurer que le commutateur de <code>Failover</code> dans le coin sup√©rieur droit est activ√©.  Pour d√©sactiver le mode de basculement automatique, remplacez simplement la valeur de <code>cartridge_failover</code> par <code>false</code> et r√©ex√©cutez le playbook. </p><br><p>  Il est temps de comprendre de quel type de r√©gime il s'agit et pourquoi nous l'avons activ√©. </p><br><h2 id="razbiraemsya-s-failover-om">  Nous g√©rons le basculement </h2><br><p>  Vous avez probablement remarqu√© la variable <code>failover_priority</code> que nous avons sp√©cifi√©e pour chaque jeu de r√©plicas.  Voyons voir ce que c'est. </p><br><p>  La cartouche Tarantool fournit un mode de basculement automatique.  Chaque jeu de r√©plicas a un leader - l'instance dans laquelle il est enregistr√©.  Si quelque chose arrive au leader, une des remarques prendra son r√¥le.  Lequel?  Examinons de plus pr√®s le jeu de r√©pliques de <code>storage-2</code> : </p><br><pre> <code class="plaintext hljs">--- all: ... children: ... replicaset_storage_2: vars: ... failover_priority: - storage-2 - storage-2-replica</code> </pre> <br><p>  L'instance de <code>storage-2</code> nous avons sp√©cifi√©e en premier dans <code>failover_priority</code> .  Dans l'interface utilisateur Web, il appara√Æt en premier dans la liste des instances de jeu de r√©plicas et est marqu√© d'une couronne verte.  Ceci est le leader - la premi√®re instance sp√©cifi√©e dans <code>failover_priority</code> : </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Voyons maintenant ce qui se passe si quelque chose arrive au leader du jeu de r√©pliques.  Nous allons dans la machine virtuelle et arr√™tons l'instance de <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl stop getting-started-app@storage-2</code> </pre> <br><p>  Retour √† l'interface utilisateur Web: </p><br><p><img src="https://habrastorage.org/webt/iy/b2/ff/iyb2ff_a6dryhg0nik8p48rhqhm.png"></p><br><p>  La couronne √† l'instance de <code>storage-2</code> devenue rouge - cela signifie que le chef d√©sign√© est malsain.  Mais le <code>storage-2-replica</code> une couronne verte - cette instance a repris les responsabilit√©s de leadership jusqu'√† ce que le <code>storage-2</code> revienne en service.  Il s'agit d'un basculement automatique en action. </p><br><p>  Revivons le <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl start getting-started-app@storage-2</code> </pre> <br><p>  Tout est revenu √† la case d√©part: </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Modifions l'ordre des instances dans la priorit√© du basculement.  Nous allons faire de l'instance de <code>storage-2-replica</code> un leader et supprimer le <code>storage-2</code> de la liste en g√©n√©ral: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2-replica # &lt;== ...</code> </pre> <br><p>  Ex√©cutez les <code>cartridge-replicasets</code> pour les instances du groupe <code>replicaset_storage_2</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Nous allons sur <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> et voyons que le leader a chang√©: </p><br><p><img src="https://habrastorage.org/webt/r_/hq/bm/r_hqbmgxwbkvcycacj7pnotjhjc.png"></p><br><p>  Mais nous avons supprim√© l'instance de <code>storage-2</code> de la configuration, pourquoi est-elle toujours l√†?  Le fait est que Cartridge, recevant une nouvelle valeur de <code>failover_priority</code> organise les instances comme suit: la premi√®re instance de la liste devient le leader, les autres instances indiqu√©es suivent.  Les instances non mentionn√©es dans <code>failover_priority</code> seront ordonn√©es par UUID et ajout√©es √† la fin. </p><br><h2 id="izgnanie-instansa">  Instance d'exil </h2><br><p>  Mais que faire si nous voulons exclure l'instance de la topologie?  Tout est tr√®s simple: vous devez lui passer le drapeau <code>expelled</code> .  Excluons l'instance de <code>storage-2-replica</code> .  Il est le leader maintenant, donc Cartridge ne nous permettra pas de le faire.  Mais nous n'avons pas peur des difficult√©s et essayons toujours: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 expelled: true # &lt;== ...</code> </pre> <br><p>  Nous sp√©cifions la <code>cartridge-replicasets</code> , car l'expulsion d'une instance est un changement de topologie: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Ex√©cutez le playbook et voyez l'erreur: </p><br><p><img src="https://habrastorage.org/webt/hf/wf/tc/hfwftcua4yyueyi0qgngr2mveia.png"></p><br><p>  Comme nous venons de le voir, Cartridge ne justifie pas de retirer l'actuel leader du jeu de r√©plicas de la topologie.  Cela est assez logique, car la r√©plication est asynchrone, l'exclusion d'un leader est susceptible d'entra√Æner une perte de donn√©es.  Nous devons sp√©cifier un autre leader et seulement apr√®s cela exclure l'instance.  Le r√¥le appliquera d'abord la nouvelle configuration de jeu de r√©plicas, puis traitera l'exception.  Par cons√©quent, nous changeons <code>failover_priority</code> et r√©ex√©cutons le playbook: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2 # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Voila, l'instance de <code>storage-2-replica</code> a disparu de la topologie! </p><br><p><img src="https://habrastorage.org/webt/tl/ao/ue/tlaoue_hclprc1i6tdjuil5efyk.png"></p><br><p>  Notez que l'exil d'instance est vraiment d√©finitif et irr√©vocable.  Apr√®s avoir supprim√© l'instance de la topologie, notre r√¥le ansible arr√™tera le service systemd et supprimera tous les fichiers de cette instance. </p><br><p><img src="https://habrastorage.org/webt/_7/bp/nx/_7bpnxxuydmfmddneontw1nxexi.png"></p><br><p>  Si vous changez soudain d‚Äôavis et d√©cidez que le jeu de r√©plicas de <code>storage-2</code> toujours besoin d‚Äôune seconde instance, vous ne pourrez pas le restaurer.  La cartouche se souvient de l'UUID de toutes les instances qui ont quitt√© la topologie et ne permettra pas √† l'exil de revenir.  Vous pouvez cr√©er une nouvelle instance avec le m√™me nom et la m√™me configuration, mais elle aura √©videmment un UUID diff√©rent, donc Cartridge lui permettra de se joindre. </p><br><h2 id="udalenie-replikaseta">  Suppression de Replicaset </h2><br><p>  Nous avons d√©j√† d√©couvert que nous ne serons pas autoris√©s √† expulser le chef de la r√©plique.  Mais que faire si nous voulons supprimer d√©finitivement le r√©plica de <code>storage-2</code> ?  Il y a bien s√ªr une issue. </p><br><p>  Afin de ne pas perdre de donn√©es, nous devons d'abord transf√©rer tous les <code>storage-1</code> vers le <code>storage-1</code> , pour cela nous avons d√©fini le poids de la r√©plique du <code>storage-2</code> sur <code>0</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 0 # &lt;== ... ...</code> </pre> <br><p>  Lancer la gestion de la topologie: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Ouvrez l'interface utilisateur Web <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> et observez le flux de tous les <code>storage-1</code> dans <code>storage-1</code> : </p><br><p><img src="https://habrastorage.org/webt/nk/mo/fq/nkmofqnvvoccqfqkyz1myryu4-s.png"></p><br><p>  Nous avons plac√© le leader du <code>storage-2</code> sur le drapeau expuls√© et avons dit au revoir √† ce jeu de r√©pliques: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 expelled: true # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-replicasets</code> </pre> <br><p>  Veuillez noter que cette fois, nous n'avons pas sp√©cifi√© l'option de <code>limit</code> , car au moins une instance parmi toutes celles pour lesquelles nous avons lanc√© le playbook ne doit pas √™tre marqu√©e comme <code>expelled</code> . </p><br><p>  Nous sommes donc revenus √† la topologie d'origine: </p><br><p><img src="https://habrastorage.org/webt/70/zo/vq/70zovqqaeiph6v1bjoenzl_hn1w.png"></p><br><h2 id="avtorizaciya">  Se connecter </h2><br><p>  Je propose de me distraire de la gestion des jeux de r√©pliques et de penser √† la s√©curit√©.  D√©sormais, tout utilisateur non autoris√© peut g√©rer le cluster via l'interface utilisateur Web.  D'accord, √ßa a l'air moyen. </p><br><p>  La cartouche offre la possibilit√© de connecter votre propre module d'autorisation, tel que LDAP (ou tout ce que vous avez l√†-bas), et de l'utiliser pour g√©rer les utilisateurs et leur acc√®s √† l'application.  Mais nous utiliserons le module d'autorisation int√©gr√©, que Cartridge utilise par d√©faut.  Ce module vous permet d'effectuer des op√©rations de base avec les utilisateurs (supprimer, ajouter, modifier) ‚Äã‚Äãet impl√©mente la fonction de v√©rification du mot de passe. <br>  Veuillez noter que notre r√¥le ansible n√©cessite le backend d'autorisation pour impl√©menter toutes ces fonctions. </p><br><p>  On passe donc de la th√©orie √† la pratique.  Tout d'abord, rendez l'autorisation obligatoire, d√©finissez les param√®tres de session et ajoutez un nouvel utilisateur: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # authorization cartridge_auth: # &lt;== enabled: true # enable authorization cookie_max_age: 1000 cookie_renew_age: 100 users: # cartridge users to set up - username: dokshina password: cartridge-rullez fullname: Elizaveta Dokshina email: dokshina@example.com # deleted: true # uncomment to delete user ...</code> </pre> <br><p>  La gestion des autorisations est effectu√©e dans le cadre des t√¢ches de <code>cartridge-config</code> , nous indiquons cette balise: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Sur <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard une</a> surprise nous attend: </p><br><p><img src="https://habrastorage.org/webt/a2/t8/pq/a2t8pqil4sxnosey38i-baf3q1k.png"></p><br><p>  Vous pouvez vous connecter avec le <code>username</code> et le <code>password</code> notre nouvel utilisateur ou vous connecter en tant <code>admin</code> - l'utilisateur par d√©faut.  Son mot de passe est un cookie de cluster, nous avons sp√©cifi√© cette valeur dans la variable <code>cartridge_cluster_cookie</code> (c'est <code>app-default-cookie</code> , vous ne pouvez pas jeter un ≈ìil). </p><br><p>  Apr√®s une connexion r√©ussie, ouvrez l'onglet <code>Users</code> pour vous assurer que tout s'est bien pass√©: </p><br><p><img src="https://habrastorage.org/webt/af/h_/9o/afh_9ofcv7htwplfgomnxejosxo.png"></p><br><p>  Essayez d'ajouter de nouveaux utilisateurs et de modifier leurs param√®tres.  Pour supprimer un utilisateur, sp√©cifiez le drapeau <code>deleted: true</code> pour lui.  Les valeurs de <code>email</code> et de nom <code>fullname</code> ne sont en aucun cas utilis√©es par la cartouche, mais vous pouvez les sp√©cifier pour plus de commodit√©. </p><br><h2 id="konfiguraciya-prilozheniya">  Configuration d'application </h2><br><p>  Rappelons-nous comment tout a commenc√©. </p><br><p>  Nous avons d√©ploy√© une petite application qui stocke des donn√©es sur les clients et leurs comptes bancaires.  Comme vous vous en souvenez, cette application a 2 r√¥les: <code>api</code> et <code>storage</code> .  Le r√¥le de <code>storage</code> g√®re le stockage des donn√©es et impl√©mente le partitionnement √† l'aide du r√¥le de <code>vshard-storage</code> .  Le deuxi√®me r√¥le, <code>api</code> , impl√©mente un serveur HTTP avec une API pour la gestion des donn√©es, et √† l'int√©rieur il est connect√© un autre r√¥le standard, <code>vshard-router</code> , qui contr√¥le le partage. </p><br><p>  Donc, nous faisons la premi√®re demande √† l'API d'application.  Ajoutez un nouveau client: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"customer_id":1, "name":"Elizaveta", "accounts":[{"account_id": 1}]}'</span></span> \ http://localhost:8182/storage/customers/create</code> </pre> <br><p>  En r√©ponse, nous obtenons quelque chose comme ceci: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Successfully created"</span></span>}</code> </pre> <br><p>  Veuillez noter que dans l'URL, nous avons sp√©cifi√© le port d'instance <code>app-1</code> , <code>8082</code> , car il impl√©mente cette API. </p><br><p>  Maintenant, mettons √† jour le solde de notre nouvel utilisateur: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  Dans la r√©ponse, nous voyons le solde mis √† jour: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-string"><span class="hljs-string">"1000.00"</span></span>}</code> </pre> <br><p>  G√©nial, tout fonctionne!  L'API est impl√©ment√©e, Cartridge est engag√©e dans le partage de donn√©es, nous avons d√©j√† configur√© la priorit√© de basculement pour les cas d'urgence et m√™me activ√© l'autorisation.  Il est temps de faire la configuration de l'application. </p><br><p>  La configuration actuelle du cluster est stock√©e dans un fichier de configuration distribu√©.  Chaque instance conserve une copie de ce fichier et Cartridge assure sa synchronisation entre tous les n≈ìuds du cluster.  Nous pouvons sp√©cifier la configuration des r√¥les de notre application dans ce fichier, et Cartridge se chargera de distribuer la nouvelle configuration sur toutes les instances. </p><br><p>  Regardons le contenu actuel de ce fichier.  Acc√©dez √† l'onglet <code>Cofiguration files</code> et cliquez sur le bouton <code>Download</code> : </p><br><p><img src="https://habrastorage.org/webt/wx/xw/vc/wxxwvcdusefetrgyaxpnnrvxwya.png"></p><br><p>  Dans le <code>config.yml</code> config.yml t√©l√©charg√© <code>config.yml</code> nous trouvons une table vide.  Pas √©tonnant, car nous n'avons encore sp√©cifi√© aucun param√®tre: </p><br><pre> <code class="plaintext hljs">--- [] ...</code> </pre> <br><p>  En fait, le fichier de configuration de notre cluster n'est pas vide, il stocke la topologie actuelle, les param√®tres d'autorisation et les param√®tres de partitionnement.  Mais la cartouche ne sera pas si facile √† partager ces informations, elle est destin√©e √† un usage interne, et est donc stock√©e dans des sections syst√®me cach√©es, que nous ne pouvons pas modifier. </p><br><p>  Chaque r√¥le d'application peut utiliser une ou plusieurs sections de configuration.  Le t√©l√©chargement d'une nouvelle configuration se d√©roule en deux √©tapes: tout d'abord, tous les r√¥les v√©rifient qu'ils sont pr√™ts √† accepter de nouveaux param√®tres.  S'il n'y a pas d'objection, les modifications sont appliqu√©es, si quelqu'un s'y oppose, un retour en arri√®re se produit. </p><br><p>  Revenons √† notre application.  Le r√¥le <code>api</code> utilise la section <code>max-balance</code> , o√π le solde maximum autoris√© est stock√© sur un compte client.  Configurons cette section, mais, bien s√ªr, pas manuellement, mais en utilisant notre r√¥le Ansible. </p><br><p>  Donc, maintenant, la configuration de l'application (ou plut√¥t, une partie de celle-ci √† notre disposition) est une table vide.  Ajoutez une section <code>max-balance</code> avec une valeur de <code>100000</code> .  Nous √©crivons la variable <code>cartridge_app_config</code> dans notre fichier d'inventaire: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # cluster-wide config cartridge_app_config: # &lt;== max-balance: # section name body: 1000000 # section body # deleted: true # uncomment to delete section max-balance ...</code> </pre> <br><p>  Nous avons sp√©cifi√© le nom de la section, <code>max-balance</code> , et son contenu, <code>body</code> .  Le contenu d'une section peut √™tre non seulement un nombre, mais √©galement un tableau ou une ligne selon la fa√ßon dont le r√¥le est √©crit et le type de valeur que vous souhaitez utiliser. </p><br><p>  Nous lan√ßons: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Et nous v√©rifions que le solde maximum autoris√© a bien chang√©: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000001\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  En r√©ponse, nous obtenons une erreur, comme nous le voulions: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"Maximum is 1000000"</span></span>}</code> </pre> <br><p>  Vous pouvez t√©l√©charger √† nouveau le fichier de configuration dans l'onglet <code>Configuraion files</code> pour vous assurer qu'une nouvelle section y appara√Æt: </p><br><pre> <code class="plaintext hljs">--- max-balance: 1000000 ...</code> </pre> <br><p>  Essayez d'ajouter de nouvelles sections √† la configuration de l'application, modifiez leur contenu ou supprimez-les compl√®tement (pour cela, vous devez d√©finir l'indicateur <code>deleted: true</code> dans la section). </p><br><p>  Vous pouvez d√©couvrir comment utiliser une configuration distribu√©e dans des r√¥les dans la <a href="https://www.tarantool.io/ru/rocks/cartridge/1.0/modules/cartridge.clusterwide-config/">documentation de</a> Tarantool Cartridge. </p><br><p>  N'oubliez pas d'appeler <code>vagrant halt</code> stop pour arr√™ter les <code>vagrant halt</code> lorsque vous avez fini de travailler avec elles. </p><br><h2 id="v-zaklyuchenie">  En conclusion </h2><br><p>  La derni√®re fois, nous avons appris √† d√©ployer des applications de cartouche Tarantool distribu√©es √† l'aide d'un r√¥le Ansible sp√©cial.  Aujourd'hui, nous avons mis √† jour l'application, et ma√Ætris√© √©galement la gestion de la topologie, le d√©coupage, l'autorisation et la configuration de l'application. </p><br><p>  Ne vous arr√™tez pas l√†, apprenez <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html">diff√©rentes approches</a> pour √©crire des playbooks Ansible et utilisez vos applications avec un maximum de confort. </p><br><p>  Si quelque chose ne fonctionne pas pour vous ou si vous avez des id√©es pour am√©liorer notre r√¥le ansible, n'h√©sitez pas √† commencer un <a href="https://github.com/tarantool/ansible-cartridge/issues/new">ticket</a> .  Nous vous aiderons toujours avec la solution de votre probl√®me et nous serons heureux des offres int√©ressantes! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484192/">https://habr.com/ru/post/fr484192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484178/index.html">Commutateur Ethernet intelligent pour la plan√®te Terre</a></li>
<li><a href="../fr484180/index.html">PBX virtuel Rostelecom: quoi et comment faire via l'API</a></li>
<li><a href="../fr484182/index.html">Xenobots: des nanorobots vivants issus de cellules de grenouilles</a></li>
<li><a href="../fr484186/index.html">LDAP - "l'authentification" est un contre-mod√®le</a></li>
<li><a href="../fr484188/index.html">Normes de conception de base de donn√©es</a></li>
<li><a href="../fr484194/index.html">Kubernetes traduit en enfants</a></li>
<li><a href="../fr484196/index.html">Enregistrement du son JS √† partir d'un microphone ou des commentaires vocaux</a></li>
<li><a href="../fr484198/index.html">Revers de la m√©daille: qui a gagn√© et perdu sur la croissance des actions Tesla</a></li>
<li><a href="../fr484200/index.html">Comment fixer des objectifs pour les atteindre</a></li>
<li><a href="../fr484202/index.html">Apprentissage automatique dans l'analyse statique du code source du programme</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>