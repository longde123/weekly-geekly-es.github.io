<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèø üíº üê¨ R√©acteur N complet C d'E / S üêê üèæ üì≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 


 Le r√©acteur d'E / S ( boucle d'√©v√©nement √† thread unique) est un mod√®le d'√©criture de logiciels tr√®s charg√©s utilis√© dans de nombreus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©acteur N complet C d'E / S</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475896/"><p><img src="https://habrastorage.org/webt/2g/w7/vr/2gw7vrlwgzkro-gf3hkbj7jxqzu.png"></p><br><h1 id="vvedenie">  Pr√©sentation </h1><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Le r√©acteur d'E / S</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">boucle d'√©v√©nement √†</a> thread unique) est un mod√®le d'√©criture de logiciels tr√®s charg√©s utilis√© dans de nombreuses solutions populaires: </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Node.js</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Tor</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">La transmission</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Chrome</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Memcached</a> </li><li>  ... </li></ul><br><p>  Dans cet article, nous allons examiner les tenants et aboutissants du r√©acteur d'E / S et le principe de son fonctionnement, √©crire une impl√©mentation pour moins de 200 lignes de code et forcer un simple serveur HTTP √† traiter plus de 40 millions de requ√™tes / min. </p><a name="habracut"></a><br><h1 id="predislovie">  Pr√©face </h1><br><ul><li>  L'article a √©t√© r√©dig√© dans le but d'aider √† comprendre le fonctionnement du r√©acteur d'E / S, et donc √† r√©aliser les risques lors de son utilisation. </li><li>  Pour ma√Ætriser l'article, vous avez besoin de connaissances sur les bases <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">du langage C</a> et peu d'exp√©rience dans le d√©veloppement d'applications r√©seau. </li><li>  Tout le code est √©crit en C strictement par ( <strong>soigneusement: long PDF</strong> ) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">la norme C11</a> pour Linux et est disponible sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">GitHub</a> . </li></ul><br><h1 id="zachem-eto-nuzhno">  Pourquoi est-ce n√©cessaire? </h1><br><p>  Avec la popularit√© croissante d'Internet, les serveurs Web devaient traiter un grand nombre de connexions en m√™me temps, et donc deux approches ont √©t√© essay√©es: bloquer les E / S sur un grand nombre de threads du syst√®me d'exploitation et les E / S non bloquantes en combinaison avec un syst√®me de notification d'√©v√©nements, √©galement appel√© ¬´syst√®me s√©lecteur "( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">epoll</a> / <a href="" rel="nofollow">kqueue</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">IOCP</a> / etc). </p><br><p>  La premi√®re approche consistait √† cr√©er un nouveau thread OS pour chaque connexion entrante.  Son inconv√©nient est sa faible √©volutivit√©: le syst√®me d'exploitation devra effectuer de nombreuses <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">transitions de contexte</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">appels syst√®me</a> .  Ce sont des op√©rations co√ªteuses et peuvent entra√Æner un manque de RAM libre avec un nombre impressionnant de connexions. </p><br><p>  La version modifi√©e alloue un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">nombre fixe de threads</a> (pool de threads), emp√™chant ainsi le syst√®me d'arr√™ter anormalement l'ex√©cution, mais introduit en m√™me temps un nouveau probl√®me: si √† un moment donn√© le pool de threads est bloqu√© par de longues op√©rations de lecture, alors d'autres sockets qui sont d√©j√† capables de recevoir des donn√©es ne pourra pas le faire. </p><br><p>  La deuxi√®me approche utilise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">le syst√®me de notification d'√©v√©nements</a> (s√©lecteur de syst√®me) fourni par le syst√®me d'exploitation.  Cet article d√©crit le type de s√©lecteur de syst√®me le plus courant bas√© sur des alertes (√©v√©nements, notifications) sur l'√©tat de pr√©paration des op√©rations d'E / S, plut√¥t que des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">alertes sur leur ach√®vement</a> .  Un exemple simplifi√© de son utilisation peut √™tre repr√©sent√© par l'organigramme suivant: </p><br><p><img src="https://habrastorage.org/webt/rw/kb/yo/rwkbyokmirpu7hpd6yzc47-k4va.png"></p><br><p>  La diff√©rence entre ces approches est la suivante: </p><br><ul><li>  Le blocage des op√©rations d'E / S <strong>suspend le</strong> flux utilisateur <strong>jusqu'√† ce que le</strong> syst√®me d'exploitation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">d√©fragmente</a> correctement les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">paquets IP</a> entrants dans le flux d'octets ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">TCP</a> , r√©ception de donn√©es) ou lib√®re suffisamment d'espace dans les tampons d'√©criture internes pour un envoi ult√©rieur via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">NIC</a> (envoi de donn√©es). </li><li>  <strong>Apr√®s un certain temps, le</strong> s√©lecteur de syst√®me informe le programme que le syst√®me d'exploitation <strong>a d√©j√†</strong> d√©fragment√© les paquets IP (TCP, r√©ception de donn√©es) ou que suffisamment d'espace dans les tampons d'enregistrement internes est <strong>d√©j√†</strong> disponible (envoi de donn√©es). </li></ul><br><p>  Pour r√©sumer, r√©server un thread OS pour chaque E / S est une perte de puissance de calcul, car en r√©alit√©, les threads ne sont pas occup√©s par un travail utile (le terme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">"interruption logicielle"</a> a ses racines).  Le s√©lecteur de syst√®me r√©sout ce probl√®me en permettant au programme utilisateur de consommer les ressources CPU de mani√®re beaucoup plus √©conomique. </p><br><h1 id="model-io-reaktora">  Mod√®le d'E / S du r√©acteur </h1><br><p>  Un r√©acteur d'E / S agit comme une couche entre le s√©lecteur de syst√®me et le code utilisateur.  Le principe de son fonctionnement est d√©crit par l'organigramme suivant: </p><br><p><img src="https://habrastorage.org/webt/6j/v9/-m/6jv9-mplsvirwimvaej1zzyu2oa.png"></p><br><ul><li>  Permettez-moi de vous rappeler qu'un √©v√©nement est une notification qu'un certain socket est capable d'effectuer une op√©ration d'E / S non bloquante. </li><li>  Un gestionnaire d'√©v√©nements est une fonction appel√©e par le r√©acteur d'E / S lorsqu'un √©v√©nement est re√ßu, qui effectue ensuite une op√©ration d'E / S non bloquante. </li></ul><br><p>  Il est important de noter que le r√©acteur d'E / S est par d√©finition √† un seul thread, mais rien n'emp√™che d'utiliser le concept dans un environnement multithread par rapport √† un r√©acteur √† 1 flux: 1, utilisant ainsi tous les c≈ìurs de CPU. </p><br><h1 id="realizaciya">  Impl√©mentation </h1><br><p> Nous pla√ßons l'interface publique dans le fichier <a href="" rel="nofollow"><code>reactor.h</code></a> , et l'impl√©mentation dans <a href="" rel="nofollow"><code>reactor.c</code></a> .  <code>reactor.h</code> comprendra les d√©clarations suivantes: </p><br><div class="spoiler">  <b class="spoiler_title">Afficher les annonces dans reacteur.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reactor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reactor</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* *   ,    I/O    *    . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*Callback)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *  `NULL`   , -`NULL`   `Reactor`  *  . */</span></span> <span class="hljs-function"><span class="hljs-function">Reactor *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *   ,       *    I/O . * *    -1   , 0   . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reactor *reactor)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> interest, Callback callback, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *callback_arg)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_deregister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_reregister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> interest, Callback callback, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *callback_arg)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *     - `timeout`. * *           * /    . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">time_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> </div></div><br><p>  La structure d'E / S du r√©acteur se compose d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">descripteur de fichier de</a> s√©lection <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">epoll</a> et d'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>GHashTable</code></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">hachage</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>GHashTable</code></a> , que chaque socket mappe sur <code>CallbackData</code> (une structure d'un gestionnaire d'√©v√©nements et un argument utilisateur pour cela). </p><br><div class="spoiler">  <b class="spoiler_title">Afficher le r√©acteur et les donn√©es de rappel</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reactor</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> epoll_fd; GHashTable *table; <span class="hljs-comment"><span class="hljs-comment">// (int, CallbackData) }; typedef struct { Callback callback; void *arg; } CallbackData;</span></span></code> </pre> </div></div><br><p>  Veuillez noter que nous avons utilis√© la possibilit√© de g√©rer un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">type incomplet</a> par pointeur.  Dans <code>reactor.h</code> nous d√©clarons la structure du <code>reactor</code> , et dans <code>reactor.c</code> d√©finissons, emp√™chant ainsi l'utilisateur de changer explicitement ses champs.  C'est l'un des mod√®les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">de masquage de donn√©es</a> qui s'int√®gre organiquement dans la s√©mantique de C. </p><br><p>  Les fonctions <code>reactor_register</code> , <code>reactor_deregister</code> et <code>reactor_reregister</code> mettent √† jour la liste des sockets d'int√©r√™t et les gestionnaires d'√©v√©nements correspondants dans le s√©lecteur de syst√®me et dans la table de hachage. </p><br><div class="spoiler">  <b class="spoiler_title">Afficher les fonctionnalit√©s d'enregistrement</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> REACTOR_CTL(reactor, op, fd, interest) \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (epoll_ctl(reactor-&gt;epoll_fd, op, fd, \ &amp;(struct epoll_event){.events = interest, \ .data = {.fd = fd}}) == -1) { \ perror(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"epoll_ctl"</span></span></span><span class="hljs-meta">); \ return -1; \ } int reactor_register(const Reactor *reactor, int fd, uint32_t interest, Callback callback, void *callback_arg) { REACTOR_CTL(reactor, EPOLL_CTL_ADD, fd, interest) g_hash_table_insert(reactor-&gt;table, int_in_heap(fd), callback_data_new(callback, callback_arg)); return 0; } int reactor_deregister(const Reactor *reactor, int fd) { REACTOR_CTL(reactor, EPOLL_CTL_DEL, fd, 0) g_hash_table_remove(reactor-&gt;table, &amp;fd); return 0; } int reactor_reregister(const Reactor *reactor, int fd, uint32_t interest, Callback callback, void *callback_arg) { REACTOR_CTL(reactor, EPOLL_CTL_MOD, fd, interest) g_hash_table_insert(reactor-&gt;table, int_in_heap(fd), callback_data_new(callback, callback_arg)); return 0; }</span></span></code> </pre> </div></div><br><p>  Apr√®s que le r√©acteur d'E / S a intercept√© l'√©v√©nement avec le descripteur <code>fd</code> , il appelle le gestionnaire d'√©v√©nements correspondant, dans lequel il passe <code>fd</code> , le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">masque de bits des</a> √©v√©nements g√©n√©r√©s et le pointeur utilisateur √† <code>void</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Afficher la fonction reacteur_run ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">time_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">epoll_event</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">events</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((events = <span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(MAX_EVENTS, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*events))) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span> start = time(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span> passed = time(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) - start; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nfds = epoll_wait(reactor-&gt;epoll_fd, events, MAX_EVENTS, timeout - passed); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (nfds) { <span class="hljs-comment"><span class="hljs-comment">//  case -1: perror("epoll_wait"); result = -1; goto cleanup; //   case 0: result = 0; goto cleanup; //   default: //    for (int i = 0; i &lt; nfds; i++) { int fd = events[i].data.fd; CallbackData *callback = g_hash_table_lookup(reactor-&gt;table, &amp;fd); callback-&gt;callback(callback-&gt;arg, fd, events[i].events); } } } cleanup: free(events); return result; }</span></span></code> </pre> </div></div><br><p>  Pour r√©sumer, la cha√Æne d'appels de fonction dans le code utilisateur prendra la forme suivante: </p><br><p><img src="https://habrastorage.org/webt/5r/zj/wu/5rzjwuyiu4e3f-wfvtumltvuz3i.png"></p><br><h1 id="odnopotochnyy-server">  Serveur √† thread unique </h1><br><p>  Afin de tester le r√©acteur d'E / S sous forte charge, nous √©crirons un simple serveur Web HTTP pour r√©pondre √† toute demande avec une image. </p><br><div class="spoiler">  <b class="spoiler_title">R√©f√©rence rapide du protocole HTTP</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">HTTP</a> est un protocole de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">niveau</a> application principalement utilis√© pour l'interaction du serveur avec un navigateur. </p><br><p>  HTTP peut facilement √™tre utilis√© en plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">du</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">protocole de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">transport</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">TCP</a> , pour envoyer et recevoir des messages au format d√©fini par la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">sp√©cification</a> . </p><br><h3 id="format-zaprosa">  Format de demande </h3><br><pre> <code class="plaintext hljs">&lt;&gt; &lt;URI&gt; &lt; HTTP&gt;CRLF &lt; 1&gt;CRLF &lt; 2&gt;CRLF &lt; N&gt;CRLF CRLF &lt;&gt;</code> </pre> <br><ul><li>  <code>CRLF</code> est une s√©quence de deux caract√®res: <code>\r</code> et <code>\n</code> , s√©parant la premi√®re ligne de requ√™te, les en-t√™tes et les donn√©es. </li><li>  <code>&lt;&gt;</code> est l'un de <code>CONNECT</code> , <code>DELETE</code> , <code>GET</code> , <code>HEAD</code> , <code>OPTIONS</code> , <code>PATCH</code> , <code>POST</code> , <code>PUT</code> , <code>TRACE</code> .  Le navigateur enverra une commande <code>GET</code> √† notre serveur, ce qui signifie ¬´Envoyez-moi le contenu du fichier¬ª. </li><li>  <code>&lt;URI&gt;</code> est l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">identificateur de ressource unifi√©</a> .  Par exemple, si URI = <code>/index.html</code> , le client demande la page principale du site. </li><li>  <code>&lt; HTTP&gt;</code> - Version du protocole <code>HTTP/XY</code> format <code>HTTP/XY</code> .  La version la plus couramment utilis√©e √† ce jour est <code>HTTP/1.1</code> . </li><li>  <code>&lt; N&gt;</code> est une paire cl√©-valeur au format <code>&lt;&gt;: &lt;&gt;</code> , envoy√©e au serveur pour une analyse plus approfondie. </li><li>  <code>&lt;&gt;</code> - donn√©es requises par le serveur pour terminer l'op√©ration.  Il s'agit souvent de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">JSON</a> ou de tout autre format. </li></ul><br><h3 id="format-otveta">  Format de r√©ponse </h3><br><pre> <code class="plaintext hljs">&lt; HTTP&gt; &lt; &gt; &lt; &gt;CRLF &lt; 1&gt;CRLF &lt; 2&gt;CRLF &lt; N&gt;CRLF CRLF &lt;&gt;</code> </pre> <br><ul><li>  <code>&lt; &gt;</code> est un nombre repr√©sentant le r√©sultat d'une op√©ration.  Notre serveur retournera toujours le statut 200 (op√©ration r√©ussie). </li><li>  <code>&lt; &gt;</code> - repr√©sentation sous forme de cha√Æne du code d'√©tat.  Pour le code d'√©tat 200, c'est <code>OK</code> . </li><li>  <code>&lt; N&gt;</code> - un en-t√™te du m√™me format que dans la demande.  Nous renverrons les en <code>Content-Length</code> t√™tes <code>Content-Length</code> (taille du fichier) et <code>Content-Type: text/html</code> (return type data). </li><li>  <code>&lt;&gt;</code> - donn√©es demand√©es par l'utilisateur.  Dans notre cas, c'est le chemin d'acc√®s √† l'image en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">HTML</a> . </li></ul></div></div><br><p>  Le <a href="https://github.com/Hippolot/reactor-c/blob/master/" rel="nofollow"><code>http_server.c</code></a> (serveur √† thread unique) inclut le fichier <a href="" rel="nofollow"><code>common.h</code></a> , qui contient les prototypes de fonction suivants: </p><br><div class="spoiler">  <b class="spoiler_title">Afficher les prototypes de fonctions en commun.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* *  ,    ,    *    . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *  ,    ,    *   HTTP . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *  ,    ,    *    HTTP . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_recv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_nonblocking</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *     stderr      *  `EXIT_FAILURE`. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> noreturn </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *format, ...)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *    ,    * TCP . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reuse_port)</span></span></span></span>;</code> </pre> </div></div><br><p>  La macro de fonction <code>SAFE_CALL()</code> √©galement d√©crite et la fonction <code>fail()</code> est d√©finie.  La macro compare la valeur de l'expression avec l'erreur, et si la condition est remplie, elle appelle la fonction <code>fail()</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SAFE_CALL(call, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">) \ do { \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((call) == </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">) { \ fail(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s"</span></span></span><span class="hljs-meta">, #call); \ } \ } while (false)</span></span></code> </pre> <br><p>  La fonction <code>fail()</code> imprime les arguments pass√©s au terminal (comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>printf()</code></a> ) et termine le programme avec le code <code>EXIT_FAILURE</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> noreturn </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *format, ...)</span></span></span><span class="hljs-function"> </span></span>{ va_list args; va_start(args, format); <span class="hljs-built_in"><span class="hljs-built_in">vfprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, format, args); va_end(args); <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">": %s\n"</span></span>, strerror(errno)); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(EXIT_FAILURE); }</code> </pre> <br><p>  La fonction <code>new_server()</code> renvoie le descripteur de fichier du socket "serveur" cr√©√© par les appels syst√®me <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>socket()</code></a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>bind()</code></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>listen()</code></a> et capable d'accepter les connexions entrantes en mode non bloquant. </p><br><div class="spoiler">  <b class="spoiler_title">Afficher la fonction new_server ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reuse_port)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd; SAFE_CALL((fd = socket(AF_INET, SOCK_STREAM | SOCK_NONBLOCK, IPPROTO_TCP)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reuse_port) { SAFE_CALL( setsockopt(fd, SOL_SOCKET, SO_REUSEPORT, &amp;(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>){<span class="hljs-number"><span class="hljs-number">1</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sockaddr_in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addr</span></span></span><span class="hljs-class"> = {</span></span>.sin_family = AF_INET, .sin_port = htons(SERVER_PORT), .sin_addr = {.s_addr = inet_addr(SERVER_IPV4)}, .sin_zero = {<span class="hljs-number"><span class="hljs-number">0</span></span>}}; SAFE_CALL(bind(fd, (struct sockaddr *)&amp;addr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(addr)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); SAFE_CALL(listen(fd, SERVER_BACKLOG), <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fd; }</code> </pre> </div></div><br><ul><li>  Notez que le socket est initialement cr√©√© en mode non bloquant √† l'aide de l'indicateur <code>SOCK_NONBLOCK</code> , de sorte que dans la fonction <code>on_accept()</code> (pour en savoir plus), l'appel syst√®me <code>accept()</code> n'arr√™te pas l'ex√©cution du flux. </li><li>  Si <code>reuse_port</code> est <code>true</code> , cette fonction configurera le socket avec l'option <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>SO_REUSEPORT</code></a> utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>setsockopt()</code></a> pour utiliser le m√™me port dans un environnement multi-thread (voir la section "Serveur multi-thread"). </li></ul><br><p>  Le gestionnaire d'√©v√©nements <code>on_accept()</code> est appel√© apr√®s que le syst√®me d'exploitation a g√©n√©r√© un √©v√©nement <code>EPOLLIN</code> , dans ce cas, ce qui signifie qu'une nouvelle connexion peut √™tre accept√©e.  <code>on_accept()</code> accepte une nouvelle connexion, la met en mode non bloquant et s'enregistre aupr√®s du gestionnaire d'√©v√©nements <code>on_recv()</code> dans le r√©acteur d'E / S. </p><br><div class="spoiler">  <b class="spoiler_title">Afficher la fonction on_accept ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> incoming_conn; SAFE_CALL((incoming_conn = accept(fd, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); set_nonblocking(incoming_conn); SAFE_CALL(reactor_register(reactor, incoming_conn, EPOLLIN, on_recv, request_buffer_new()), <span class="hljs-number"><span class="hljs-number">-1</span></span>); }</code> </pre> </div></div><br><p>  Le gestionnaire d'√©v√©nements <code>on_recv()</code> est appel√© apr√®s que le syst√®me d'exploitation a g√©n√©r√© un √©v√©nement <code>EPOLLIN</code> , dans ce cas, ce qui signifie que la connexion enregistr√©e par <code>on_accept()</code> est pr√™te √† accepter des donn√©es. </p><br><p>  <code>on_recv()</code> lit les donn√©es de la connexion jusqu'√† la r√©ception de la requ√™te HTTP compl√®te, puis il enregistre le gestionnaire <code>on_send()</code> pour envoyer la r√©ponse HTTP.  Si le client se d√©connecte, le socket se d√©senregistre et se ferme avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>close()</code></a> . </p><br><div class="spoiler">  <b class="spoiler_title">Afficher la fonction on_recv ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_recv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span><span class="hljs-function"> </span></span>{ RequestBuffer *buffer = arg; <span class="hljs-comment"><span class="hljs-comment">//      ,  recv  0   ssize_t nread; while ((nread = recv(fd, buffer-&gt;data + buffer-&gt;size, REQUEST_BUFFER_CAPACITY - buffer-&gt;size, 0)) &gt; 0) buffer-&gt;size += nread; //    if (nread == 0) { SAFE_CALL(reactor_deregister(reactor, fd), -1); SAFE_CALL(close(fd), -1); request_buffer_destroy(buffer); return; } // read  ,   ,     //  if (errno != EAGAIN &amp;&amp; errno != EWOULDBLOCK) { request_buffer_destroy(buffer); fail("read"); } //   HTTP   .    //     if (request_buffer_is_complete(buffer)) { request_buffer_clear(buffer); SAFE_CALL(reactor_reregister(reactor, fd, EPOLLOUT, on_send, buffer), -1); } }</span></span></code> </pre> </div></div><br><p>  Le gestionnaire d'√©v√©nements <code>on_send()</code> est appel√© apr√®s que le syst√®me d'exploitation a g√©n√©r√© un √©v√©nement <code>EPOLLOUT</code> , ce qui signifie que la connexion enregistr√©e par <code>on_recv()</code> est pr√™te √† envoyer des donn√©es.  Cette fonction envoie une r√©ponse HTTP contenant du HTML avec l'image au client, puis change √† nouveau le gestionnaire d'√©v√©nements en <code>on_recv()</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Afficher la fonction on_send ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *content = <span class="hljs-string"><span class="hljs-string">"&lt;img "</span></span> <span class="hljs-string"><span class="hljs-string">"src=\"https://habrastorage.org/webt/oh/wl/23/"</span></span> <span class="hljs-string"><span class="hljs-string">"ohwl23va3b-dioerobq_mbx4xaw.jpeg\"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> response[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(response, <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 200 OK"</span></span> CRLF <span class="hljs-string"><span class="hljs-string">"Content-Length: %zd"</span></span> CRLF <span class="hljs-string"><span class="hljs-string">"Content-Type: "</span></span> <span class="hljs-string"><span class="hljs-string">"text/html"</span></span> DOUBLE_CRLF <span class="hljs-string"><span class="hljs-string">"%s"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(content), content); SAFE_CALL(send(fd, response, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(response), <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-number"><span class="hljs-number">-1</span></span>); SAFE_CALL(reactor_reregister(reactor, fd, EPOLLIN, on_recv, arg), <span class="hljs-number"><span class="hljs-number">-1</span></span>); }</code> </pre> </div></div><br><p>  Et enfin, dans le fichier <code>http_server.c</code> , dans la fonction <code>main()</code> , nous cr√©ons un r√©acteur d'E / S √† l'aide de <code>reactor_new()</code> , cr√©ons un socket serveur et l'enregistrons, d√©marrons le r√©acteur √† l'aide de <code>reactor_run()</code> exactement une minute, puis lib√©rons les ressources et quittez du programme. </p><br><div class="spoiler">  <b class="spoiler_title">Afficher http_server.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"reactor.h"</span></span></span><span class="hljs-meta"> static Reactor *reactor; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"common.h"</span></span></span><span class="hljs-meta"> int main(void) { SAFE_CALL((reactor = reactor_new()), NULL); SAFE_CALL( reactor_register(reactor, new_server(false), EPOLLIN, on_accept, NULL), -1); SAFE_CALL(reactor_run(reactor, SERVER_TIMEOUT_MILLIS), -1); SAFE_CALL(reactor_destroy(reactor), -1); }</span></span></code> </pre> </div></div><br><p>  V√©rifiez que tout fonctionne comme pr√©vu.  Nous compilons ( <code>chmod a+x compile.sh &amp;&amp; ./compile.sh</code> √† la racine du projet) et d√©marrons le serveur auto-√©crit, ouvrons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">http://127.0.0.1:18470</a> dans le navigateur et observons ce qui √©tait attendu: </p><br><p><img src="https://habrastorage.org/webt/i0/za/5u/i0za5um7tbcnzqt2x7sp_vey0p8.png"></p><br><h1 id="zamer-proizvoditelnosti">  Mesure du rendement </h1><br><div class="spoiler">  <b class="spoiler_title">Montrer les caract√©ristiques de ma voiture</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ screenfetch MMMMMMMMMMMMMMMMMMMMMMMMMmds+. OS: Mint 19.1 tessa MMm----::-://////////////oymNMd+` Kernel: x86_64 Linux 4.15.0-20-generic MMd /++ -sNMd: Uptime: 2h 34m MMNso/` dMM `.::-. .-::.` .hMN: Packages: 2217 ddddMMh dMM :hNMNMNhNMNMNh: `NMm Shell: bash 4.4.20 NMm dMM .NMN/-+MMM+-/NMN` dMM Resolution: 1920x1080 NMm dMM -MMm `MMM dMM. dMM DE: Cinnamon 4.0.10 NMm dMM -MMm `MMM dMM. dMM WM: Muffin NMm dMM .mmd `mmm yMM. dMM WM Theme: Mint-Y-Dark (Mint-Y) NMm dMM` ..` ... ydm. dMM GTK Theme: Mint-Y [GTK2/3] hMM- +MMd/-------...-:sdds dMM Icon Theme: Mint-Y -NMm- :hNMNNNmdddddddddy/` dMM Font: Noto Sans 9 -dMNs-``-::::-------.`` dMM CPU: Intel Core i7-6700 @ 8x 4GHz [52.0¬∞C] `/dMNmy+/:-------------:/yMMM GPU: NV136 ./ydNMMMMMMMMMMMMMMMMMMMMM RAM: 2544MiB / 7926MiB \.MMMMMMMMMMMMMMMMMMM</code> </pre> </div></div><br><p>  Nous mesurons les performances d'un serveur monothread.  Ouvrons deux terminaux: dans l'un, nous <code>./http_server</code> , dans l'autre - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">wrk</a> .  Apr√®s une minute, les statistiques suivantes seront affich√©es dans le deuxi√®me terminal: </p><br><pre> <code class="plaintext hljs">$ wrk -c100 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive" Running 1m test @ http://127.0.0.1:18470 8 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 493.52us 76.70us 17.31ms 89.57% Req/Sec 24.37k 1.81k 29.34k 68.13% 11657769 requests in 1.00m, 1.60GB read Requests/sec: 193974.70 Transfer/sec: 27.19MB</code> </pre> <br><p>  Notre serveur √† thread unique a pu traiter plus de 11 millions de requ√™tes par minute, provenant de 100 connexions.  Pas un mauvais r√©sultat, mais peut-il √™tre am√©lior√©? </p><br><h1 id="mnogopotochnyy-server">  Serveur multithread </h1><br><p>  Comme mentionn√© ci-dessus, un r√©acteur d'E / S peut √™tre cr√©√© dans des flux s√©par√©s, utilisant ainsi tous les c≈ìurs de CPU.  Appliquons cette approche dans la pratique: </p><br><div class="spoiler">  <b class="spoiler_title">Afficher http_server_multithreaded.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"reactor.h"</span></span></span><span class="hljs-meta"> static Reactor *reactor; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> omp threadprivate(reactor) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"common.h"</span></span></span><span class="hljs-meta"> int main(void) { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> omp parallel { SAFE_CALL((reactor = reactor_new()), NULL); SAFE_CALL(reactor_register(reactor, new_server(true), EPOLLIN, on_accept, NULL), -1); SAFE_CALL(reactor_run(reactor, SERVER_TIMEOUT_MILLIS), -1); SAFE_CALL(reactor_destroy(reactor), -1); } }</span></span></code> </pre> </div></div><br><p>  D√©sormais, chaque thread <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">poss√®de son propre</a> r√©acteur: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reactor *reactor; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> omp threadprivate(reactor)</span></span></code> </pre> <br><p>  Notez que l'argument de <code>new_server()</code> est <code>true</code> .  Cela signifie que nous d√©finissons le socket du serveur sur l'option <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>SO_REUSEPORT</code></a> pour l'utiliser dans un environnement multi-thread.  Vous pouvez en lire plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ici</a> . </p><br><h1 id="vtoroy-zahod">  Deuxi√®me manche </h1><br><p>  Nous allons maintenant mesurer les performances d'un serveur multithread: </p><br><pre> <code class="plaintext hljs">$ wrk -c100 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive" Running 1m test @ http://127.0.0.1:18470 8 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 1.14ms 2.53ms 40.73ms 89.98% Req/Sec 79.98k 18.07k 154.64k 78.65% 38208400 requests in 1.00m, 5.23GB read Requests/sec: 635876.41 Transfer/sec: 89.14MB</code> </pre> <br><p>  Le nombre de demandes trait√©es en 1 minute a augment√© de ~ 3,28 fois!  Mais jusqu'au chiffre rond, seulement ~ deux millions n'√©taient pas suffisants, essayons de le r√©parer. </p><br><p>  Tout d'abord, regardez les statistiques g√©n√©r√©es par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">perf</a> : </p><br><pre> <code class="plaintext hljs">$ sudo perf stat -B -e task-clock,context-switches,cpu-migrations,page-faults,cycles,instructions,branches,branch-misses,cache-misses ./http_server_multithreaded Performance counter stats for './http_server_multithreaded': 242446,314933 task-clock (msec) # 4,000 CPUs utilized 1 813 074 context-switches # 0,007 M/sec 4 689 cpu-migrations # 0,019 K/sec 254 page-faults # 0,001 K/sec 895 324 830 170 cycles # 3,693 GHz 621 378 066 808 instructions # 0,69 insn per cycle 119 926 709 370 branches # 494,653 M/sec 3 227 095 669 branch-misses # 2,69% of all branches 808 664 cache-misses 60,604330670 seconds time elapsed</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">En utilisant l'affinit√© CPU</a> , la compilation avec <code>-march=native</code> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">PGO</a> , l'augmentation du nombre de hits dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">cache</a> , l'augmentation de <code>MAX_EVENTS</code> et l'utilisation d' <code>EPOLLET</code> n'ont pas donn√© une augmentation significative des performances.  Mais que se passe-t-il si vous augmentez le nombre de connexions simultan√©es? </p><br><p>  Statistiques pour 352 connexions simultan√©es: </p><br><pre> <code class="plaintext hljs">$ wrk -c352 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive" Running 1m test @ http://127.0.0.1:18470 8 threads and 352 connections Thread Stats Avg Stdev Max +/- Stdev Latency 2.12ms 3.79ms 68.23ms 87.49% Req/Sec 83.78k 12.69k 169.81k 83.59% 40006142 requests in 1.00m, 5.48GB read Requests/sec: 665789.26 Transfer/sec: 93.34MB</code> </pre> <br><p>  Le r√©sultat souhait√© a √©t√© obtenu, et avec lui un graphique int√©ressant montrant la d√©pendance du nombre de demandes trait√©es en 1 minute sur le nombre de connexions: </p><br><p><img src="https://habrastorage.org/webt/od/8c/lv/od8clvvdlprsdcmslba9fz_rmmq.png"></p><br><p>  Nous voyons qu'apr√®s quelques centaines de connexions, le nombre de demandes trait√©es des deux serveurs diminue fortement (dans une version multithread, c'est plus visible).  Est-ce li√© √† l'impl√©mentation de la pile TCP / IP Linux?  N'h√©sitez pas √† √©crire vos hypoth√®ses sur ce comportement de graphique et les optimisations des options multithread et monothread dans les commentaires. </p><br><hr><br><p>  Comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">indiqu√©</a> dans les commentaires, ce test de performance ne montre pas le comportement du r√©acteur d'E / S √† des charges r√©elles, car presque toujours le serveur interagit avec la base de donn√©es, affiche les journaux, utilise la cryptographie avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">TLS</a> , etc., √† la suite de quoi la charge devient h√©t√©rog√®ne (dynamique).  Des tests ainsi que des composants tiers seront effectu√©s dans un article sur le proacteur d'E / S. </p><br><h1 id="nedostatki-io-reaktora">  Inconv√©nients du r√©acteur d'E / S </h1><br><p>  Vous devez comprendre que le r√©acteur d'E / S n'est pas sans inconv√©nients, √† savoir: </p><br><ul><li>  L'utilisation d'un r√©acteur d'E / S dans un environnement multithread est un peu plus difficile, car  vous devez g√©rer manuellement les flux. </li><li>  La pratique montre que dans la plupart des cas, la charge est h√©t√©rog√®ne, ce qui peut conduire au fait qu'un thread sera d√©pos√© tandis que l'autre est charg√© de travail. </li><li>  Si un gestionnaire d'√©v√©nements bloque le flux, le s√©lecteur de syst√®me lui-m√™me sera √©galement bloqu√©, ce qui peut entra√Æner des bogues difficiles √† d√©tecter. </li></ul><br><p>  Ces probl√®mes sont r√©solus par le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">processeur d'E / S</a> , souvent avec un planificateur qui distribue uniform√©ment la charge au pool de threads, et dispose √©galement d'une API plus pratique.  Il sera discut√© plus tard dans mon autre article. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Sur ce point, notre voyage de la th√©orie directement au profileur d'√©chappement a pris fin. </p><br><p>  Ne vous attardez pas l√†-dessus, car il existe de nombreuses autres approches tout aussi int√©ressantes pour √©crire des logiciels r√©seau avec diff√©rents niveaux de commodit√© et de vitesse.  √Ä mon avis, les liens sont int√©ressants ci-dessous. </p><br><p>  A tr√®s bient√¥t! </p><br><h1 id="interesnye-proekty">  Projets int√©ressants </h1><br><ul><li>  Si <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">libevent</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">libev</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">libuv</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">libevhtp</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">lib√©rant</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">DPDK</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">netmap</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Pf_ring</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Rouille</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Mio</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Tokio</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">smoltcp</a> </li></ul></li></ul><br><h1 id="chto-eschyo-pochitat">  Que lire d'autre? </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">https://linux.die.net/man/7/socket</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">https://stackoverflow.com/questions/1050222/what-is-the-difference-between-concurrency-and-parallelism</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">http://www.kegel.com/c10k.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">https://kernel.dk/io_uring.pdf</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">https://aturon.github.io/blog/2016/09/07/futures-design/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">https://tokio.rs/blog/2019-10-scheduler/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">https://www.artima.com/articles/io_design_patterns.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://habr.com/en/post/183832/</a> </li></ul><br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr475896/">https://habr.com/ru/post/fr475896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr475884/index.html">R√©solution du probl√®me des lignes irr√©guli√®res dans les gradients</a></li>
<li><a href="../fr475886/index.html">Amazon AI facilite la lutte contre le contenu obsc√®ne de l'utilisateur</a></li>
<li><a href="../fr475888/index.html">Avantages de la reconnaissance faciale du cloud</a></li>
<li><a href="../fr475892/index.html">Comment nous avons am√©lior√© l'ordre du d√©jeuner au bureau (sans acc√®s au serveur)</a></li>
<li><a href="../fr475894/index.html">Trois protocoles de passage</a></li>
<li><a href="../fr475900/index.html">Les 6 cours Azure les plus r√©cents</a></li>
<li><a href="../fr475902/index.html">Workflow Core - un moteur de processus m√©tier pour .Net Core</a></li>
<li><a href="../fr475904/index.html">5 notes pour le nouveau manager</a></li>
<li><a href="../fr475908/index.html">Les 10 cours Microsoft les plus populaires en russe</a></li>
<li><a href="../fr475912/index.html">Comment √©valuer et comparer les p√©riph√©riques de chiffrement pour les r√©seaux Ethernet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>