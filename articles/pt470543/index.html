<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçí ü§≥ üéá Como colocamos o gerenciamento de infraestrutura no Terraform - e come√ßamos a viver üì¶ üç• üçè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="T√≠nhamos 4 contas da Amazon, 9 VPCs e 30 ambientes de desenvolvimento, est√°gios, regress√µes mais poderosos - no total, mais de 1000 inst√¢ncias do EC2 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como colocamos o gerenciamento de infraestrutura no Terraform - e come√ßamos a viver</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dins/blog/470543/"><img src="https://habrastorage.org/webt/os/gu/yk/osguyk_s9ckyitafq3rayiqhxw0.png" alt="imagem"><br>  T√≠nhamos 4 contas da Amazon, 9 VPCs e 30 ambientes de desenvolvimento, est√°gios, regress√µes mais poderosos - no total, mais de 1000 inst√¢ncias do EC2 de todas as cores e tons.  Desde que comecei a coletar solu√ß√µes em nuvem para os neg√≥cios, preciso seguir meu hobby at√© o fim e pensar em como automatizar tudo isso. <br><br>  Oi  Meu nome √© Kirill Kazarin, trabalho como engenheiro no DINS.  Estamos desenvolvendo solu√ß√µes de comunica√ß√£o comercial baseadas na nuvem.  Em nosso trabalho, usamos ativamente o Terraform, com o qual gerenciamos com flexibilidade nossa infraestrutura.  Vou compartilhar minha experi√™ncia com esta solu√ß√£o. <br><br>  O artigo √© longo, portanto, <s>compre</s> ch√° de <s>pipoca</s> e pronto! <br><br>  E mais uma nuance - o artigo foi escrito com base na vers√£o 0.11, em novos 0,12 muito mudou, mas as principais pr√°ticas e dicas ainda s√£o relevantes.  A quest√£o da migra√ß√£o de 0,11 para 0,12 merece um artigo separado! <br><a name="habracut"></a><br><h3>  O que √© o Terraform </h3><br>  <b>Terraform</b> √© uma ferramenta Hashicorp popular que apareceu em 2014. <br><br>  Esse utilit√°rio permite gerenciar sua infraestrutura de nuvem na <i>infraestrutura como um</i> paradigma de <i>c√≥digo</i> em uma linguagem declarativa muito amig√°vel e de f√°cil leitura.  Seu aplicativo fornece a voc√™ um tipo unificado de recursos e aplica√ß√£o de pr√°ticas de c√≥digo para gerenciamento de infraestrutura, que h√° muito tempo s√£o desenvolvidas pela comunidade de desenvolvedores.  O Terraform suporta todas as plataformas de nuvem modernas, permite alterar a infraestrutura com seguran√ßa e previsibilidade. <br><br>  Quando lan√ßado, o Terraform l√™ o c√≥digo e, usando os plug-ins fornecidos pelos provedores de servi√ßos em nuvem, leva sua infraestrutura ao estado descrito, fazendo as chamadas de API necess√°rias. <br><br>  Nosso projeto est√° localizado inteiramente na Amazon, implantado com base nos servi√ßos da AWS e, portanto, escrevo sobre o uso do Terraform nesse sentido.  Separadamente, observo que ele pode ser usado n√£o apenas na Amazon.  Permite gerenciar tudo o que possui uma API. <br><br>  Al√©m disso, gerenciamos configura√ß√µes de VPC, pol√≠ticas do IAM e fun√ß√µes.  Gerenciamos tabelas de roteamento, certificados, ACLs de rede.  Gerenciamos as configura√ß√µes de nosso firewall de aplicativo da web, S3-bucket, SQS-filas - tudo o que nosso servi√ßo pode usar na Amazon.  Ainda n√£o vi recursos com a Amazon que a Terraform n√£o pudesse descrever em termos de infraestrutura. <br><br>  Acontece uma infraestrutura bastante grande, com as m√£os √© f√°cil de suportar.  Mas com o Terraform √© conveniente e simples. <br><br><h3>  De que √© feito o Terraform </h3><br>  <b>Provedores</b> s√£o plugins para trabalhar com a API de um servi√ßo.  Eu contei a eles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais de 100</a> .  Entre eles est√£o fornecedores para Amazon, Google, DigitalOcean, VMware Vsphere, Docker.  Eu at√© encontrei um provedor nesta lista oficial que permite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gerenciar as regras do Cisco ASA</a> ! <br><br>  Entre outras coisas, voc√™ pode controlar: <br><br><ul><li>  Pain√©is, fonte de dados e alertas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Grafana</a> . </li><li>  Projetos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitLab</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RabbitMQ</a> . </li><li>  Bancos de dados, usu√°rios e direitos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MySQL</a> . </li></ul><br>  E esses s√£o apenas provedores oficiais, existem ainda mais provedores n√£o oficiais.  Durante os experimentos, deparei-me com o GitHub de terceiros, n√£o inclu√≠do no provedor de lista oficial, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">permitia trabalhar com o DNS do GoDaddy</a> e com os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recursos do Proxmox</a> . <br><br>  Em um projeto Terraform, voc√™ pode usar provedores diferentes e, consequentemente, os recursos de diferentes provedores ou tecnologias de servi√ßo.  Por exemplo, voc√™ pode gerenciar sua infraestrutura na AWS, com DNS externo do GoDaddy.  E amanh√£, sua empresa comprou uma startup hospedada no DO ou Azure.  E enquanto voc√™ decide migrar isso para a AWS ou n√£o, tamb√©m pode oferecer suporte com a mesma ferramenta! <br><br>  <b>Recursos.</b>  Essas s√£o entidades de nuvem que voc√™ pode criar usando o Terraform.  Sua lista, sintaxe e propriedades dependem do provedor usado, de fato - da nuvem usada.  Ou n√£o apenas nuvens. <br><br>  <b>M√≥dulos</b>  Essas s√£o as entidades com as quais o Terraform permite modelar sua configura√ß√£o.  Assim, os modelos permitem diminuir o seu c√≥digo, reutiliz√°-lo.  Bem, eles ajudam a trabalhar confortavelmente com ele. <br><br><h3>  Por que escolhemos a Terraform </h3><br>  Para n√≥s mesmos, identificamos 5 raz√µes principais.  Talvez do seu ponto de vista, nem todos eles pare√ßam significativos: <br><br><ul><li>  <b>Terraform √© um utilit√°rio de suporte a m√∫ltiplas nuvens <s>agn√≥stico em</s> nuvem (obrigado pelo valioso coment√°rio nos coment√°rios)</b> .  Quando escolhemos essa ferramenta, pensamos: - E o que acontecer√° se o gerenciamento de amanh√£ ou uma semana chegar at√© n√≥s e disser: " <i>Pessoal, pensamos - n√£o vamos apenas implantar na Amazon. Temos algum tipo de projeto, onde precisamos obter a infraestrutura no Google Cloud. Ou no Azure - bem, voc√™ nunca sabe</i> ".  Decidimos que gostar√≠amos de ter uma ferramenta que n√£o esteja rigidamente vinculada a nenhum servi√ßo de nuvem. </li><li>  <b>C√≥digo aberto</b> .  Terraform √© uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">solu√ß√£o de c√≥digo aberto</a> .  O reposit√≥rio do projeto tem uma classifica√ß√£o de mais de 16 mil estrelas, esta √© uma boa confirma√ß√£o da reputa√ß√£o do projeto. <br><br>  Mais de uma ou duas vezes, descobrimos o fato de que em algumas vers√µes existem erros ou um comportamento pouco compreens√≠vel.  Ter um reposit√≥rio aberto permite garantir que isso seja realmente um bug, e podemos resolver o problema simplesmente atualizando o mecanismo ou a vers√£o do plugin.  Ou que isso seja um bug, mas "Pessoal, espere, literalmente, dois dias depois, uma nova vers√£o ser√° lan√ßada e n√≥s a corrigiremos".  Ou: "Sim, isso √© algo incompreens√≠vel, estranho, eles resolvem o problema, mas h√° uma solu√ß√£o alternativa".  √â muito conveniente </li><li>  <b>Control</b> .  Terraform como um utilit√°rio est√° completamente sob seu controle.  Ele pode ser instalado em um laptop, em um servidor, e pode ser facilmente integrado ao seu pipeline, o que pode ser feito com base em qualquer ferramenta.  Por exemplo, usamos no GitLab CI. </li><li>  <b>Verificando o status da infraestrutura</b> .  O Terraform pode e faz uma boa verifica√ß√£o do estado da sua infraestrutura. <br><br>  Suponha que voc√™ come√ßou a usar o Terraform em sua equipe.  Voc√™ cria uma descri√ß√£o de algum recurso na Amazon, por exemplo, Grupo de Seguran√ßa, aplica-o - ele √© criado para voc√™, est√° tudo bem.  E aqui - bam!  Seu colega que voltou de f√©rias ontem e ainda n√£o est√° ciente de que voc√™ organizou tudo de maneira t√£o bonita aqui, ou at√© mesmo um colega de outro departamento entra e altera as configura√ß√µes deste Grupo de Seguran√ßa por al√ßas. <br><br>  E sem se encontrar com ele, sem conversar ou sem ter enfrentado um determinado problema, voc√™ nunca saber√° sobre isso em uma situa√ß√£o normal.  Por√©m, se voc√™ usar o Terraform, mesmo executando um plano ocioso nesse recurso mostrar√° que h√° mudan√ßas no ambiente de trabalho. <br><br>  Quando o Terraform olha para o seu c√≥digo, ele chama simultaneamente a API do provedor de nuvem, recebe o estado dos objetos e compara: "E agora h√° a mesma coisa que eu fiz antes, o que eu lembro?"  Ent√£o ele compara com o c√≥digo, olha o que mais precisa ser mudado.  E, por exemplo, se tudo estiver igual em sua hist√≥ria, em sua mem√≥ria e em seu c√≥digo, mas houver mudan√ßas l√°, ele mostrar√° a voc√™ e se oferecer√° para revert√™-lo.  Na minha opini√£o, tamb√©m uma propriedade muito boa.  Portanto, esse √© outro passo, pessoalmente para n√≥s, para garantir que tenhamos uma infraestrutura imut√°vel. </li><li>  Outra caracter√≠stica muito importante s√£o <b>os m√≥dulos</b> que mencionei e que contam.  Eu vou falar sobre isso um pouco mais tarde.  Quando vou comparar com as ferramentas. </li></ul><br>  E tamb√©m uma cereja no bolo: o Terraform tem uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lista bastante grande de fun√ß√µes internas</a> .  Essas fun√ß√µes, apesar da linguagem declarativa, permitem implementar algumas, para n√£o dizer program√°ticas, mas l√≥gicas. <br><br>  Por exemplo, alguns c√°lculos autom√°ticos, linhas de divis√£o, convers√£o para mai√∫sculas e min√∫sculas, removendo caracteres dessa linha.  Estamos usando-o ativamente.  Eles tornam a vida muito mais f√°cil, especialmente quando voc√™ escreve um m√≥dulo que ser√° reutilizado posteriormente em diferentes ambientes. <br><br><h3>  Terraform vs CloudFormation </h3><br>  A rede geralmente compara o Terraform ao CloudFormation.  Tamb√©m fizemos essa pergunta ao escolher.  E aqui est√° o resultado da nossa compara√ß√£o. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Compara√ß√£o </th><th>  Terraform </th><th>  Cloudformation </th></tr><tr><td>  Suporte m√∫ltiplo √† nuvem </td><td>  Com o uso de v√°rios provedores, os plug-ins podem funcionar com qualquer grande provedor de nuvem. <br></td><td>  Firmemente ligado √† Amazon. </td></tr><tr><td>  Alterar rastreamento </td><td>  Se voc√™ tem uma mudan√ßa <br>  n√£o no c√≥digo TF, mas no recurso que ele criou, o TF poder√° detectar isso e permitir que voc√™ corrija a situa√ß√£o <br></td><td>  Apareceu uma fun√ß√£o semelhante <br>  somente em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">novembro de 2018</a> . <br></td></tr><tr><td>  Condi√ß√µes </td><td>  N√£o h√° suporte para condi√ß√µes (apenas <br>  sob a forma de operadores tern√°rios). </td><td>  As condi√ß√µes s√£o suportadas. </td></tr><tr><td>  Armazenamento <br>  estados </td><td>  Permite selecionar v√°rios tipos de back-end, por exemplo, localmente <br>  na sua m√°quina (esse √© o comportamento padr√£o), em um compartilhamento de arquivo, <br>  no S3 e em outros lugares. <br><br>  √Äs vezes, isso √© √∫til porque o tfstate Terraform √© apresentado como um arquivo de texto grande com uma estrutura semelhante a JSON.  E, √†s vezes, √†s vezes √© √∫til entrar e ler, e pelo menos poder fazer backup, porque voc√™ nunca sabe o que.  Pessoalmente, por exemplo, estou mais calmo com o fato de que isso √© em algum lugar controlado por mim. <br></td><td>  Armazenando o estado apenas em algum lugar dentro da AWS </td></tr><tr><td>  Importa√ß√£o de Recursos </td><td>  O Terraform facilita a importa√ß√£o de recursos.  Voc√™ pode assumir todos os recursos sob seu controle.  Voc√™ acabou de escrever o c√≥digo que caracterizar√° esse objeto ou usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Terraforming</a> . <br>  Ela vai para a mesma Amaz√¥nia, pega informa√ß√µes sobre o ambiente a partir da√≠ e as despeja na forma de c√≥digo. <br>  √â gerado por m√°quina, n√£o otimizado, mas este √© um bom primeiro passo para iniciar a migra√ß√£o.  E ent√£o voc√™ acabou de dar o comando de importa√ß√£o.  O Terraform se compara, traz esse ambiente ao seu estado - e agora o controla. <br></td><td>  CloudFormation n√£o sabe como.  Se <br>  voc√™ j√° fez algo com as m√£os antes, ou bate e recria com o CloudFormation ou vive.  Infelizmente, n√£o h√° op√ß√µes. </td></tr></tbody></table></div><br><h3>  Como come√ßar com o Terraform </h3><br>  De um modo geral, come√ßar √© bastante simples.  Aqui est√£o os primeiros passos brevemente: <br><br><ol><li>  Primeiro, crie um reposit√≥rio Git e comece imediatamente a armazenar todas as suas altera√ß√µes, experimentos e tudo. </li><li>  Leia o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">guia de introdu√ß√£o</a> .  √â pequeno, simples, bastante detalhado e descreve bem como come√ßar com este utilit√°rio. </li><li>  Escreva alguma demo, c√≥digo de trabalho.  Voc√™ pode at√© copiar algum tipo de exemplo para brincar com ele mais tarde. </li></ol><br><h3>  Nossa pr√°tica com a Terraform </h3><br><h4>  C√≥digo fonte </h4><br>  Voc√™ iniciou seu primeiro projeto e salvou tudo em um grande arquivo main.tf.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui est√° um exemplo t√≠pico</a> (honestamente, peguei o primeiro do GitHub). <br><br>  Nada de errado, mas o tamanho da base de c√≥digo tende a aumentar com o tempo.  As depend√™ncias entre recursos tamb√©m est√£o crescendo.  Depois de algum tempo, o arquivo se torna enorme, complexo, ileg√≠vel, com pouca manuten√ß√£o - e uma mudan√ßa descuidada em um local pode causar problemas. <br><br>  A primeira coisa que recomendo √© destacar o chamado reposit√≥rio principal, ou estado principal do seu projeto, seu ambiente.  Assim que voc√™ come√ßar a criar uma infraestrutura usando o Terraform, ou import√°-la, voc√™ encontrar√° imediatamente o fato de ter algumas entidades que, uma vez implantadas, configuradas, raramente mudam.  Por exemplo, essas s√£o configura√ß√µes de VPC ou a pr√≥pria VPC.  S√£o redes, grupos de seguran√ßa b√°sicos e gerais, como acesso SSH - voc√™ pode compilar uma lista bastante grande. <br><br>  N√£o faz sentido manter isso no mesmo reposit√≥rio dos servi√ßos que voc√™ altera com freq√º√™ncia.  Selecione-os em um reposit√≥rio separado e encaixe-os atrav√©s de um recurso Terraform, como estado remoto. <br><br><ul><li>  Voc√™ est√° reduzindo a base de c√≥digo daquela parte do projeto com a qual trabalha frequentemente diretamente. </li><li>  Em vez de um arquivo tfstate grande que cont√©m uma descri√ß√£o do estado de sua infraestrutura, dois arquivos menores e, em um determinado momento, voc√™ est√° trabalhando com um deles. </li></ul><br>  Qual √© o truque?  Quando o Terraform faz um plano, ou seja, calcula, calcula o que deve ser alterado, aplica - ele reconta completamente esse estado, verifica o c√≥digo, verifica o status na AWS.  Quanto maior o seu estado, mais tempo o plano levar√°. <br><br>  Chegamos a essa pr√°tica quando levamos 20 minutos para construir um plano para todo o ambiente em produ√ß√£o.  Devido ao fato de termos reunido em um n√∫cleo separado tudo o que n√£o estamos sujeitos a mudan√ßas frequentes, reduzimos o tempo para construir um plano pela metade.  Temos uma ideia de como isso pode ser reduzido ainda mais, dividindo-se n√£o apenas em n√∫cleo e n√£o n√∫cleo, mas tamb√©m em subsistemas, porque os temos conectados e geralmente mudam juntos.  Assim, dizemos, transformaremos 10 minutos em 3. Mas ainda estamos no processo de implementa√ß√£o dessa solu√ß√£o. <br><br><h4>  Menos c√≥digo - mais f√°cil de ler </h4><br>  O c√≥digo pequeno √© mais f√°cil de entender e mais conveniente de se trabalhar.  Se voc√™ tem uma equipe grande e ela tem pessoas com diferentes n√≠veis de experi√™ncia - fa√ßa o que raramente muda, mas globalmente, em um nabo separado, e ofere√ßa acesso mais restrito. <br><br>  Digamos que voc√™ tenha juniores em sua equipe e n√£o lhes d√™ acesso ao reposit√≥rio global que descreve as configura√ß√µes da VPC - dessa forma, voc√™ se protege contra erros.  Se um engenheiro comete um erro ao escrever a inst√¢ncia, e algo √© criado errado - isso n√£o √© assustador.  E se ele cometer um erro nas op√ß√µes que est√£o instaladas em todas as m√°quinas, interrompe ou faz algo com as configura√ß√µes das sub-redes, com o roteamento - isso √© muito mais doloroso. <br><br>  A sele√ß√£o do reposit√≥rio principal ocorre em v√°rias etapas. <br><br>  <b>Etapa 1</b> .  Crie um reposit√≥rio separado.  Armazene todo o c√≥digo nele, separadamente - e descreva as entidades que devem ser reutilizadas em um reposit√≥rio de terceiros usando essa sa√≠da.  Digamos que criamos um recurso de sub-rede da AWS no qual descrevemos onde ele est√° localizado, qual zona de disponibilidade e espa√ßo de endere√ßo. <br><br><pre><code class="go hljs">resource <span class="hljs-string"><span class="hljs-string">"aws_subnet"</span></span> <span class="hljs-string"><span class="hljs-string">"lab_pub1a"</span></span> { vpc_id = <span class="hljs-string"><span class="hljs-string">"${aws_vpc.lab.id}"</span></span> cidr_block = <span class="hljs-string"><span class="hljs-string">"10.10.10.0/24"</span></span> Availability_zone = <span class="hljs-string"><span class="hljs-string">"us-east-1a"</span></span> ... } output <span class="hljs-string"><span class="hljs-string">"sn_lab_pub1a-id"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"${aws_subnet.lab_pub1a.id}"</span></span> }</code> </pre> <br>  E ent√£o dizemos que enviamos o id deste objeto para a sa√≠da.  Voc√™ pode fazer a sa√≠da para cada par√¢metro que precisar. <br><br>  Qual √© o truque aqui?  Quando voc√™ descreve um valor, o Terraform o salva separadamente no n√∫cleo do estado.  E quando voc√™ se volta para ele, ele n√£o precisa sincronizar, recontar - ele poder√° imediatamente lhe dar esse assunto a partir deste estado.  Al√©m disso, no reposit√≥rio, que n√£o √© essencial, voc√™ descreve uma conex√£o com o estado remoto: voc√™ tem um estado remoto tal e tal, est√° no balde S3 tal e tal, tal e tal chave e regi√£o. <br><br>  <b>Etapa 2</b> .  Em um projeto n√£o b√°sico, criamos um link para o estado do projeto principal, para que possamos nos referir aos par√¢metros exportados pela sa√≠da. <br><br><pre> <code class="go hljs">data <span class="hljs-string"><span class="hljs-string">"terraform_remote_state"</span></span> <span class="hljs-string"><span class="hljs-string">"lab_core"</span></span> { backend = <span class="hljs-string"><span class="hljs-string">"s3"</span></span> config { bucket = <span class="hljs-string"><span class="hljs-string">"lab-core-terraform-state"</span></span> key = <span class="hljs-string"><span class="hljs-string">"terraform.tfstate"</span></span> region = <span class="hljs-string"><span class="hljs-string">"us-east-1"</span></span> } }</code> </pre><br>  <b>Etapa 3</b> .  Come√ßando!  Quando preciso implantar uma nova interface de rede para uma inst√¢ncia em uma sub-rede espec√≠fica, digo: aqui est√° o estado remoto dos dados, encontre o nome desse estado, encontre esse par√¢metro nele, que, de fato, corresponde a esse nome. <br><br><pre> <code class="go hljs">resource <span class="hljs-string"><span class="hljs-string">"aws_network_interface"</span></span> <span class="hljs-string"><span class="hljs-string">"fwl01"</span></span> { ... subnet_id = <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span></span> }</code> </pre><br>  E quando eu construir um plano de mudan√ßas no meu reposit√≥rio n√£o essencial, esse valor para o Terraform se tornar√° uma constante para ele.  Se voc√™ deseja alter√°-lo, √© necess√°rio faz√™-lo no reposit√≥rio deste, √© claro, n√∫cleo.  Mas como isso raramente muda, n√£o incomoda muito. <br><br><h4>  M√≥dulos </h4><br>  Deixe-me lembr√°-lo de que um m√≥dulo √© uma configura√ß√£o independente que consiste em um ou mais recursos relacionados.  √â gerenciado como um grupo: <br><br>  Um m√≥dulo √© uma coisa extremamente conveniente devido ao fato de voc√™ raramente criar um recurso assim, no v√°cuo, geralmente √© logicamente conectado a algo. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"AAA"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"..."</span></span> count = <span class="hljs-string"><span class="hljs-string">"3"</span></span> count_offset = <span class="hljs-string"><span class="hljs-string">"0"</span></span> host_name_prefix = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-AAA"</span></span> ami_id = <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.ami-base-ami_XXXX-id}"</span></span> subnet_ids = [<span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span></span>, <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1b-id}"</span></span>] instance_type = <span class="hljs-string"><span class="hljs-string">"t2.large"</span></span> sgs_ids = [ <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sg_ssh_lab-id}"</span></span>, <span class="hljs-string"><span class="hljs-string">"${aws_security_group.XXX_lab.id}"</span></span> ] boot_device = {volume_size = <span class="hljs-string"><span class="hljs-string">"50"</span></span> volume_type = <span class="hljs-string"><span class="hljs-string">"gp2"</span></span>} root_device = {device_name = <span class="hljs-string"><span class="hljs-string">"/dev/sdb"</span></span> volume_size = <span class="hljs-string"><span class="hljs-string">"50"</span></span> volume_type = <span class="hljs-string"><span class="hljs-string">"gp2"</span></span> encrypted = <span class="hljs-string"><span class="hljs-string">"true"</span></span>} tags = <span class="hljs-string"><span class="hljs-string">"${var.gas_tags}"</span></span> }</code> </pre><br>  Por exemplo: quando implantamos uma nova inst√¢ncia do EC2, criamos uma interface de rede e anexamos a ela, geralmente criamos um endere√ßo IP Elastic, gravamos o registro da rota 53 e algo mais.  Ou seja, temos pelo menos 4 entidades. <br><br>  Cada vez, descrev√™-los em quatro partes do c√≥digo √© inconveniente.  Al√©m disso, eles s√£o bastante t√≠picos.  Ele implora - crie um modelo e, em seguida, apenas consulte este modelo, passando par√¢metros para ele: algum nome, em qual grade empurrar, qual grupo de seguran√ßa pendurar nele.  √â muito conveniente <br><br>  Terraform possui um recurso Count, que permite reduzir ainda mais seu estado.  Voc√™ pode descrever um grande pacote de inst√¢ncias com um peda√ßo de c√≥digo.  Digamos que eu precise implantar 20 m√°quinas do mesmo tipo.  Eu n√£o escreverei 20 peda√ßos de c√≥digo mesmo de um modelo, escreverei 1 peda√ßo de c√≥digo, indicarei Count e o n√∫mero nele - quanto preciso fazer. <br><br>  Por exemplo, existem alguns m√≥dulos que referenciam um modelo.  Eu passo apenas par√¢metros espec√≠ficos: sub-rede de ID;  AMI para implantar;  tipo de inst√¢ncia;  configura√ß√µes de grupo de seguran√ßa;  qualquer outra coisa e indique quantas dessas a√ß√µes devem ser feitas comigo.  √ìtimo, pegou e virou! <br><br>  Amanh√£, os desenvolvedores v√™m at√© mim e dizem: "Escute, queremos experimentar a carga, por favor, d√™-nos mais duas."  O que preciso fazer: altero um d√≠gito para 5. A quantidade de c√≥digo permanece exatamente a mesma. <br><br>  Convencionalmente, os m√≥dulos podem ser divididos em dois tipos - recursos e infraestrutura.  Do ponto de vista do c√≥digo, n√£o h√° diferen√ßa, mas os conceitos de n√≠vel superior que o pr√≥prio operador introduz. <br>  Os m√≥dulos de recursos fornecem uma cole√ß√£o de recursos padronizada, parametrizada e logicamente relacionada.  O exemplo acima √© um m√≥dulo de recurso t√≠pico.  Como trabalhar com eles: <br><br><ul><li>  Indicamos o caminho para o m√≥dulo - a fonte de sua configura√ß√£o, atrav√©s da diretiva Source. </li><li>  Indicamos a vers√£o - sim, e a opera√ß√£o com o princ√≠pio de "mais recente e melhor" n√£o √© a melhor op√ß√£o aqui.  Voc√™ n√£o inclui a vers√£o mais recente da biblioteca todas as vezes em seu projeto?  Mas mais sobre isso mais tarde. </li><li>  Passamos argumentos para ele. </li></ul><br>  Estamos anexados √† vers√£o do m√≥dulo e apenas o √∫ltimo - a infraestrutura deve ser versionada (os recursos n√£o podem ser versionados, mas o c√≥digo pode).  Um recurso pode ser criado exclu√≠do ou recriado.  Isso √© tudo!  Tamb√©m devemos saber claramente qual vers√£o criamos cada parte da infraestrutura. <br><br>  Os m√≥dulos de infraestrutura s√£o bastante simples.  Eles consistem em recursos e incluem padr√µes da empresa (por exemplo, tags, listas de valores padr√£o, padr√µes aceitos etc.). <br><br>  Quanto ao nosso projeto e nossa experi√™ncia, mudamos muito e firmemente o uso de m√≥dulos de recursos para tudo o que √© poss√≠vel com um processo de vers√£o e revis√£o muito rigoroso.  E agora estamos introduzindo ativamente a pr√°tica de m√≥dulos de infraestrutura no n√≠vel do laborat√≥rio e da prepara√ß√£o. <br><br>  Recomenda√ß√µes para o uso de m√≥dulos <br><br><ol><li>  Se voc√™ n√£o pode escrever, mas usa os j√° prontos, n√£o escreva.  Especialmente se voc√™ √© novo nisso.  Confie nos m√≥dulos prontos ou pelo menos veja como eles fizeram isso com voc√™.  No entanto, se voc√™ ainda precisar escrever o seu, n√£o use a chamada para provedores internamente e tenha cuidado com os provedores de servi√ßos. </li><li>  Verifique se o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Terraform Registry</a> n√£o cont√©m um m√≥dulo de recursos pronto. </li><li>  Se voc√™ estiver escrevendo seu m√≥dulo, oculte os detalhes sob o cap√¥.  O usu√°rio final n√£o precisa se preocupar com o que e como voc√™ implementa internamente. </li><li>  Fa√ßa par√¢metros de entrada e valores de sa√≠da do seu m√≥dulo.  E √© melhor se forem arquivos separados.  T√£o conveniente. </li><li>  Se voc√™ escrever seus m√≥dulos, armazene-os no reposit√≥rio e na vers√£o.  Melhor um reposit√≥rio separado para o m√≥dulo. </li><li>  N√£o use m√≥dulos locais - eles n√£o s√£o versionados ou reutilizados. </li><li>  Evite usar descri√ß√µes de provedor no m√≥dulo, porque as credenciais de conex√£o podem ser configuradas e aplicadas de maneira diferente para pessoas diferentes.  Algu√©m usa vari√°veis ‚Äã‚Äãde ambiente para isso, e algu√©m implica armazenar suas chaves e segredos em arquivos com caminhos prescritos para eles.  Isso deve ser indicado em um n√≠vel superior. </li><li>  Use o fornecedor local com cuidado.  √â executado localmente, na m√°quina em que o Terraform est√° sendo executado, mas o ambiente de execu√ß√£o para diferentes usu√°rios pode ser diferente.  At√© voc√™ incorpor√°-lo no CI, voc√™ pode encontrar v√°rios artefatos: por exemplo, exec local e executando ansible.  E algu√©m tem uma distribui√ß√£o diferente, outro shell, uma vers√£o diferente do ansible ou mesmo do Windows. </li></ol><br>  Sinais de um bom m√≥dulo (aqui est√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pouco mais detalhado</a> ): <br><br><ul><li>  Bons m√≥dulos t√™m documenta√ß√£o e exemplos.  Se cada um foi projetado como um reposit√≥rio separado, √© mais f√°cil fazer isso. </li><li>  Eles n√£o t√™m configura√ß√µes codificadas permanentemente (por exemplo, regi√£o da AWS). </li><li>  Use padr√µes razo√°veis, projetados como padr√µes.  Por exemplo, por padr√£o, o m√≥dulo para a inst√¢ncia do EC2 n√£o criar√° uma m√°quina virtual do tipo m5d.24xlarge para voc√™, ele usa um dos tipos m√≠nimos de t2 ou t3 para isso. </li><li>  O c√≥digo √© "limpo" - estruturado, fornecido com coment√°rios, n√£o desnecessariamente confusos, projetado no mesmo estilo. </li><li>  √â altamente desej√°vel que seja equipado com testes, embora seja dif√≠cil.  Infelizmente, ainda n√£o chegamos a isso. </li></ul><br><h4>  Marca√ß√£o </h4><br>  Tags s√£o importantes. <br><br>  Etiquetar √© faturar.  A AWS possui ferramentas que permitem ver quanto dinheiro voc√™ gasta em sua infraestrutura.  E nossa ger√™ncia realmente queria ter uma ferramenta na qual eles pudessem v√™-la deterministicamente.  Por exemplo, quanto dinheiro tais e tais componentes consomem, ou tal e tal subsistema, tal e tal equipe, tal e tal ambiente <br><br><img src="https://habrastorage.org/webt/3q/mn/9e/3qmn9ej1ao0cmn8irggvgl8ztj4.png" alt="imagem"><br><br>  A marca√ß√£o √© a documenta√ß√£o do seu sistema.  Com isso, voc√™ simplifica sua pesquisa.  Mesmo apenas no console da AWS, onde essas tags s√£o exibidas perfeitamente na tela, fica mais f√°cil entender a que esse ou aquele tipo de inst√¢ncia se refere.  Se novos colegas vierem, √© mais f√°cil explicar isso, mostrando: "Olha, √© isso aqui."  Come√ßamos a criar tags da seguinte maneira - criamos uma matriz de tags para cada tipo de recurso. <br><br>  Um exemplo: <br><br><pre> <code class="go hljs">variable <span class="hljs-string"><span class="hljs-string">"XXX_tags"</span></span> { description = <span class="hljs-string"><span class="hljs-string">"The set of XXX tags."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">"map"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = { <span class="hljs-string"><span class="hljs-string">"TerminationDate"</span></span> = <span class="hljs-string"><span class="hljs-string">"03.23.2018"</span></span>, <span class="hljs-string"><span class="hljs-string">"Environment"</span></span> = <span class="hljs-string"><span class="hljs-string">"env_name_here"</span></span>, <span class="hljs-string"><span class="hljs-string">"Department"</span></span> = <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"Subsystem"</span></span> = <span class="hljs-string"><span class="hljs-string">"subsystem_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Component"</span></span> = <span class="hljs-string"><span class="hljs-string">"XXX"</span></span>, <span class="hljs-string"><span class="hljs-string">"Type"</span></span> = <span class="hljs-string"><span class="hljs-string">"application"</span></span>, <span class="hljs-string"><span class="hljs-string">"Team"</span></span> = <span class="hljs-string"><span class="hljs-string">"team_name"</span></span> } }</code> </pre><br>  Aconteceu que em nossa empresa mais de uma de nossas equipes usa a AWS, e h√° uma lista de tags necess√°rias. <br><br><ol><li>  Equipe - qual equipe usa quantos recursos. </li><li>  Departamento - semelhante a um departamento. </li><li>  Ambiente - os recursos batem em "ambientes", mas voc√™, por exemplo, pode substitu√≠-lo por um projeto ou algo assim. </li><li>  Subsistema - o subsistema ao qual o componente pertence.  Os componentes podem pertencer a um subsistema.  Por exemplo, queremos ver quanto temos este subsistema e suas entidades come√ßaram a consumir.  De repente, por exemplo, no m√™s anterior, ele cresceu significativamente.  Precisamos ir at√© os desenvolvedores e dizer: ‚ÄúPessoal, √© caro.  O or√ßamento j√° est√° pr√≥ximo, vamos otimizar a l√≥gica de alguma forma. ‚Äù </li><li>  Tipo - tipo de componente: balanceador, armazenamento, aplicativo ou banco de dados. </li><li>  Componente - o componente em si, seu nome em nota√ß√£o interna. </li><li>  Data de t√©rmino - hor√°rio em que deve ser exclu√≠do, no formato da data.  Se a remo√ß√£o n√£o for esperada, defina como "Permanente".  N√≥s o introduzimos porque em ambientes de desenvolvimento, e mesmo em alguns est√°gios, temos um est√°gio de teste de estresse que aumenta durante as sess√µes de estresse, ou seja, n√£o mantemos essas m√°quinas regularmente.  Indicamos a data em que o recurso deve ser destru√≠do.  Al√©m disso, voc√™ pode fixar a automa√ß√£o com base no lambda, alguns scripts externos que funcionam por meio da AWS Command Line Interface, que destruir√£o esses recursos automaticamente. </li></ol><br>  Agora - como marcar. <br><br>  Decidimos que far√≠amos nosso pr√≥prio mapa de tags para cada componente, no qual listar√≠amos todas as tags especificadas: quando finaliz√°-lo, a que ele se refere.  Eles rapidamente perceberam que era inconveniente.  Porque a base de c√≥digo est√° crescendo, porque temos mais de 30 componentes, e 30 desses trechos de c√≥digo s√£o inconvenientes.  Se voc√™ precisar alterar alguma coisa, execute e altere. <br><br>  Para marcar bem, usamos a entidade <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Locals</a> . <br><br><pre> <code class="go hljs">locals { common_tags = {<span class="hljs-string"><span class="hljs-string">"TerminationDate"</span></span> = <span class="hljs-string"><span class="hljs-string">"XX.XX.XXXX"</span></span>, <span class="hljs-string"><span class="hljs-string">"Environment"</span></span> = <span class="hljs-string"><span class="hljs-string">"env_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Department"</span></span> = <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"Team"</span></span> = <span class="hljs-string"><span class="hljs-string">"team_name"</span></span>} subsystem_1_tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.common_tags, map("</span></span>Subsystem<span class="hljs-string"><span class="hljs-string">", "</span></span>subsystem_1_name<span class="hljs-string"><span class="hljs-string">"))}"</span></span> subsystem_2_tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.common_tags, map("</span></span>Subsystem<span class="hljs-string"><span class="hljs-string">", "</span></span>subsystem_2_name<span class="hljs-string"><span class="hljs-string">"))}"</span></span> }</code> </pre><br>  Nele, voc√™ pode listar um subconjunto e us√°-los um com o outro. <br><br>  Por exemplo, removemos algumas tags comuns dessa estrutura e depois as espec√≠ficas dos subsistemas.  Dizemos: ‚ÄúPegue esse bloco e adicione, por exemplo, o subsistema 1. E para o subsistema 2, adicione o subsistema 2‚Äù.  Dizemos: "Tags, por favor, pegue as gerais e adicione tipo, aplicativo, nome, componente e quem √© a elas".  Acontece uma mudan√ßa muito breve, clara e centralizada, se de repente for necess√°ria. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ02"</span></span> { count = <span class="hljs-number"><span class="hljs-number">1</span></span> count_offset = <span class="hljs-number"><span class="hljs-number">1</span></span> name = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span> ... tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.core_tags, map("</span></span>Type<span class="hljs-string"><span class="hljs-string">", "</span></span>application<span class="hljs-string"><span class="hljs-string">", "</span></span>Component<span class="hljs-string"><span class="hljs-string">", "</span></span>XXX<span class="hljs-string"><span class="hljs-string">"))}"</span></span> }</code> </pre><br><img src="https://habrastorage.org/webt/ka/sq/4o/kasq4ocxxl3hht59z9p6o5bzjfs.png" alt="imagem"><br><br><h4>  Controle de vers√£o </h4><br>  Seus m√≥dulos de modelo, se voc√™ os usar, devem ser armazenados em algum lugar.  A maneira mais f√°cil que provavelmente todos iniciam √© o armazenamento local.  Apenas no mesmo diret√≥rio, apenas algum subdiret√≥rio no qual voc√™ descreve, por exemplo, um modelo para algum tipo de servi√ßo.  Este n√£o √© um bom caminho.  √â conveniente, pode ser rapidamente corrigido e testado rapidamente, mas √© dif√≠cil reutiliz√°-lo mais tarde e dif√≠cil de controlar <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ02"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"./modules/srvroles/ZZZ"</span></span> name = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span> }</code> </pre><br>  Suponha que os desenvolvedores tenham procurado voc√™ e dito: "Ent√£o, precisamos de uma entidade dessas e de uma configura√ß√£o dessas em nossa infraestrutura".  Voc√™ escreveu, fez na forma de um m√≥dulo local no reposit√≥rio do projeto deles.  Implantado - excelente.  Eles testaram, disseram: ‚ÄúVai!  Em produ√ß√£o. "  Chegamos ao palco, testes de estresse, produ√ß√£o.  Cada vez que Ctrl-C, Ctrl-V;  Ctrl-C, Ctrl-V.  Enquanto cheg√°vamos √† venda, nosso colega pegou, copiou o c√≥digo do ambiente do laborat√≥rio, transferiu para outro local e o mudou para l√°.  E temos um estado j√° inconsistente.  Com a escala horizontal, quando voc√™ tem tantos ambientes de laborat√≥rio quanto os nossos, √© apenas uma loucura. <br><br>  Portanto, uma boa maneira √© criar um reposit√≥rio Git separado para cada um dos seus m√≥dulos e depois apenas fazer refer√™ncia a ele.  Mudamos tudo em um s√≥ lugar - bom, conveniente, controlado. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"git::ssh://git@GIT_SERVER_FQDN/terraform/modules/general-vm/2-disks.git"</span></span> host_name_prefix = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span></code> </pre><br>  Antecipando a pergunta, como seu c√≥digo alcan√ßa a produ√ß√£o.  Para isso, √© criado um projeto separado que reutiliza os m√≥dulos preparados e testados. <br><br>  √ìtimo, temos uma fonte de c√≥digo que muda centralmente.  Peguei, escrevi, preparei e me preparei para amanh√£ de manh√£ que vou implantar na produ√ß√£o.  Construiu um plano, testado - √≥timo, vamos l√°.  Nesse momento, meu colega, guiado exclusivamente por boas inten√ß√µes, foi e otimizou algo, adicionado a este m√≥dulo.  E aconteceu que essas altera√ß√µes quebram a compatibilidade com vers√µes anteriores. <br><br>  Por exemplo, ele adicionou os par√¢metros necess√°rios, os quais ele deve passar, caso contr√°rio o m√≥dulo n√£o ser√° montado.  Ou ele mudou os nomes desses par√¢metros.  Eu chego de manh√£, tenho tempo estritamente limitado para mudan√ßas, come√ßo a construir um plano, e a Terraform pega m√≥dulos de estado do Git, come√ßa a construir um plano e diz: "Opa, n√£o posso.  N√£o √© o suficiente para voc√™, voc√™ renomeou. "  Estou surpreso: "Mas n√£o fiz, como lidar com isso?"  E se esse √© um recurso criado h√° muito tempo, ap√≥s essas altera√ß√µes, voc√™ ter√° que percorrer todos os ambientes, de alguma forma, mudar e levar a uma olhada.  Isso √© inconveniente. <br><br>  Isso pode ser corrigido usando tags Git.  Decidimos por n√≥s mesmos que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usar√≠amos a nota√ß√£o SemVer</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">elaboramos</a> uma regra simples: assim que a configura√ß√£o do nosso m√≥dulo atingir um certo estado est√°vel, ou seja, podemos us√°-lo, colocamos um tag nesse commit.  Se fizermos altera√ß√µes e elas n√£o quebrarem a compatibilidade com vers√µes anteriores, alteramos o n√∫mero menor na tag; se elas quebrarem, alteramos o n√∫mero principal. <br><br>  Portanto, no endere√ßo de origem, anexe-o a uma tag espec√≠fica e, se pelo menos forne√ßa algo que voc√™ tinha antes, ela sempre ser√° coletada.  Deixe a vers√£o do m√≥dulo seguir em frente, mas no momento certo chegaremos e, quando realmente precisarmos, mudaremos.  E o que estava funcionando antes disso, pelo menos, n√£o vai quebrar.  Isso √© conveniente.  √â assim que parece no nosso GitLab. <br><br><img src="https://habrastorage.org/webt/qb/vc/yh/qbvcyhrhgdblv8ewvwlr1gkxsmc.png" alt="imagem"><br><br><h4>  Ramifica√ß√£o </h4><br>  Usar ramifica√ß√£o √© outra pr√°tica importante.  N√≥s desenvolvemos uma regra para n√≥s mesmos de que voc√™ deve fazer altera√ß√µes somente do mestre.  Mas, para qualquer altera√ß√£o que voc√™ queira fazer e testar, fa√ßa um ramo separado, brinque com ele, experimente, fa√ßa planos e veja como est√° indo.  E, em seguida, fa√ßa uma solicita√ß√£o de mesclagem e deixe um colega ver o c√≥digo e ajudar. <br><br><img src="https://habrastorage.org/webt/ty/vf/je/tyvfjel4g_uhzcrf7ifnkdxd230.png" alt="imagem"><br><br><h4>  Onde armazenar tfstate </h4><br>  Voc√™ n√£o deve armazenar seu estado localmente.  Voc√™ n√£o deve armazenar seu estado no Git. <br><br>  Ficamos impressionados com isso quando algu√©m, ao lan√ßar os galhos de um n√£o-mestre, obt√©m seu estado, no qual o estado √© salvo - ent√£o ele o ativa por meio de mesclagem, algu√©m adiciona o seu, resultando em conflitos de mesclagem.  Ou acontece sem eles, mas um estado inconsistente, porque "ele j√° o possui, ainda n√£o o tenho", e consertar tudo isso √© uma pr√°tica desagrad√°vel.  Portanto, decidimos armazen√°-lo em um local seguro, com vers√£o, mas estaria fora do Git. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O S3</a> se encaixa perfeitamente com isso: est√° dispon√≠vel, possui HA, tanto quanto me lembro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exatamente quatro noves, talvez cinco</a> .  Ele fornece vers√µes prontas para uso, mesmo que voc√™ quebre seu estado, voc√™ sempre poder√° reverter.  E ele tamb√©m d√° uma coisa muito importante em combina√ß√£o com o DynamoDB, que, na minha opini√£o, aprendeu esse Terraform desde a vers√£o 0.8.  No DynamoDB, voc√™ tem uma placa de identifica√ß√£o na qual o Terraform registra que est√° bloqueando o estado. <br><br>  Ou seja, suponha que eu queira fazer algumas altera√ß√µes.  Estou come√ßando a construir um plano ou a aplic√°-lo, o Terraform acessa o DynamoDB e diz que informa nesta placa que esse estado est√° bloqueado;  usu√°rio, computador, hora.  Nesse momento, meu colega, que trabalha remotamente ou talvez em algumas mesas minhas, mas se concentrou no trabalho e n√£o v√™ o que estou fazendo, tamb√©m decidiu que algo precisa ser mudado.  Ele faz um plano, mas o lan√ßa um pouco mais tarde. <br><br>  O Terraform entra na din√¢mica, v√™ - Bloqueia, interrompe e diz ao usu√°rio: "Desculpe, o estado est√° bloqueado por alguma coisa".  Um colega v√™ que estou trabalhando agora, pode vir at√© mim e dizer: "Escute, meu trocador √© mais importante, ceda a mim, por favor".  Eu digo: ‚ÄúBom‚Äù, cancelo o plano, retiro o bloco; at√© mesmo ele √© removido automaticamente se voc√™ o fizer corretamente, sem interromper o Ctrl-C.  Um colega vai e faz.  Assim, nos seguramos contra uma situa√ß√£o em que voc√™s dois est√£o mudando alguma coisa. <br><br><h4>  Solicita√ß√£o de mesclagem </h4><br>  Usamos ramifica√ß√£o no Git.  Atribu√≠mos nossos pedidos de mesclagem aos colegas.  Al√©m disso, no Gitlab, usamos quase todas as ferramentas dispon√≠veis para trabalharmos juntas, para solicita√ß√µes de mesclagem ou at√© mesmo alguns pools: discutir seu c√≥digo, revis√°-lo, definir andamento ou quest√£o, algo assim.  √â muito √∫til, ajuda no trabalho. <br><br>  Al√©m disso, nesse caso, a revers√£o tamb√©m √© mais f√°cil, voc√™ pode retornar ao commit anterior ou, se voc√™ disser que decidiu n√£o apenas aplicar as altera√ß√µes do assistente, pode simplesmente mudar para um branch est√°vel.  Por exemplo, voc√™ fez uma ramifica√ß√£o de recurso e decidiu que faria as altera√ß√µes primeiro a partir da ramifica√ß√£o de recurso.  E ent√£o as mudan√ßas, depois que tudo funcionou bem, fazem para o mestre.  Voc√™ aplicou as altera√ß√µes em sua filial, percebeu que algo estava errado, mudou para o mestre - nenhuma altera√ß√£o, disse aplicar - ele retornou. <br><br><h4>  Tubula√ß√µes </h4><br><img src="https://habrastorage.org/webt/qx/g1/ex/qxg1exw6vesornrgdhc7ynmjg80.png" alt="imagem"><br><br>  Decidimos que precis√°vamos usar o processo de IC para aplicar nossas altera√ß√µes.  Para fazer isso, com base no Gitlab CI, estamos escrevendo um pipeline que automatiza a aplica√ß√£o de altera√ß√µes.  At√© agora, temos dois tipos deles: <br><br><ul><li>  Pipeline para a ramifica√ß√£o mestre (pipeline mestre) </li><li>  Pipeline para todas as outras filiais (pipeline da filial) </li></ul><br>  O que o pipeline de brunch faz?      (   , ).     .  ,     merge-request,           ‚Äî   ,   .         .    . <br><br><img src="https://habrastorage.org/webt/vt/0_/hq/vt0_hqcdpurvppbglcxwgwtqiyi.png" alt="imagem"><br><br>       .   ,       ,       .      Terraform-  ,       ,    . ,   merge-request   .        .       .   ,       ,        ,      . <br><br><img src="https://habrastorage.org/webt/67/9z/ub/679zubdsyvuldaiwzcpimtbvjmu.png" alt="imagem"><br><br>          ,   .         . <br><br><h3>  Terraform </h3><br> <b>.</b>      Terraform     ,      ,     . <br><br>     ,  ¬´¬ª ‚Äî              ,   . <br><br> ,   ,    count ‚Äî   ,  , ,  ,   availability-. , ,  ,  .          .    ,    AZ  .      ,  count      . <br><br> ,    4 AZ    5 ,       AZ ‚Äî   4,     , .    : ¬´    ¬ª.    !  ,      .        Terraform  . <br><br> <b> .</b>  ‚Äî  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> .     .   - -   If  Else. ,    ‚Äî , . <br><br> <b>  </b> .     ,   ,    ,     , Terraform-    ,    CI. <br><br>  CI           .       ,      , ,    ‚Äî    merge,   .  . <br><br> ,         .        .     ,   , Terraform  , ,   tfstate   Terraform   : ¬´,  ,  ¬ª.        ,   ,      . <br><br>     CI,    ,    pipeline  ‚Äî   ,         . <br><br>   ,        .         ,      .    ,       target    ,   . ,      : ¬´Terraform apply target instance¬ª,  -.        -  (,  - ),        . <br><br>          ,      .     .   CI ‚Äî      ,  Terraform    ,   .      ,     - .  ,  ,       ,     .  . <br><br><h3> Terraform ‚Äî    </h3><br>      : <br><br><ul><li> Terraform       ,      .  , ,  .    ,        ,   ,   .       ,    ,  ,         . <br><br>  ,      ‚Äî       Tfstate,       ,        .         .   ¬´   ,    ¬ª ‚Äî  . <br><br>                 , -,  ,  - ‚Äî   .      ,          .     ,               ‚Äî    . </li><li> Terraform    ,      .  Terraform    .  Porque           ,    .     . ,   ,    AZ    - -. ,   North Virginia,     6  .          .    ,   ,  : ¬´,   ¬ª.       ‚Äî .   ‚Äî      ,  , Terraform     . </li><li> Terraform        . ,    ‚Äî 200 ,    198 ,    5.    .       ,         API .  Infelizmente. </li><li>     ,      . ,    S3 bucket.     ,              ‚Äî  ,     - .         Terraform ‚Äì    ,   ,   : ¬´,  -   ¬ª.     .      -  ,      . </li></ul><br>   , Terraform ‚Äî ,   .     ,     . <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt470543/">https://habr.com/ru/post/pt470543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt470529/index.html">Como traduzimos o projeto legado para o GraphQL</a></li>
<li><a href="../pt470531/index.html">O neurofisiologista discute o projeto Neuralink e fala sobre o trabalho do c√©rebro "nos dedos"</a></li>
<li><a href="../pt470535/index.html">Maneiras de criar gr√°ficos de barras usando Python</a></li>
<li><a href="../pt470537/index.html">Novo pacote de valida√ß√£o para o React no Mobx @ quantumart / mobx-form-validation-kit</a></li>
<li><a href="../pt470541/index.html">No√ß√µes b√°sicas de trabalho com o Neo4j em um navegador</a></li>
<li><a href="../pt470547/index.html">Tarefas de aipo: novo decorador, novos recursos</a></li>
<li><a href="../pt470549/index.html">TSMC espera seguir a lei de Moore nas pr√≥ximas d√©cadas</a></li>
<li><a href="../pt470553/index.html">Integral de Euler-Poisson. Detalhes sobre m√©todos de c√°lculo</a></li>
<li><a href="../pt470555/index.html">Joker 2019 review: parada do planeta, ou o que nos espera</a></li>
<li><a href="../pt470557/index.html">Controle de luz: um novo tipo de elementos √≥pticos baseados em metamateriais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>