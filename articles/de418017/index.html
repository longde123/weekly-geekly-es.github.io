<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧙🏿 👨🏻‍🏫 🍄 Analyse des Verhaltens des Pegasus-Trojaners im Netzwerk 👩🏼‍🎨 👩‍💻 🧐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Quellcode für den Pegasus-Banking-Trojaner wurde kürzlich veröffentlicht . Trotz der Erwähnung der Carbanak-Gruppe im Namen des Archivs bestritten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse des Verhaltens des Pegasus-Trojaners im Netzwerk</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/418017/">  Der Quellcode für den Pegasus-Banking-Trojaner wurde kürzlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">veröffentlicht</a> .  Trotz der Erwähnung der Carbanak-Gruppe im Namen des Archivs bestritten Forscher von Minerva Labs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die</a> Beteiligung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">des</a> Trojaners an dieser Gruppe und bewiesen ihre Beteiligung an der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Buhtrap-</a> Gruppe (Ratopak).  Im Archiv finden Sie eine kurze Beschreibung der Arbeit des Trojaners, seiner Quellcodes, eine Beschreibung des Bankzahlungssystems und die Daten der Mitarbeiter vieler russischer Banken. <br><br>  Die Quellcode-Architektur dieser Malware ist sehr interessant.  Die Funktionalität ist in Module unterteilt, die bei der Kompilierung zu einem einzigen „Binpack“ zusammengefasst werden.  Der Kompilierungsprozess umfasst auch das Signieren ausführbarer Dateien mit einem Zertifikat aus der Datei tric.pfx, die sich nicht im Archiv befindet. <br><br>  Nicht weniger merkwürdig ist die Netzwerkaktivität von Pegasus, der nach einer Infektion versucht, sich innerhalb der Domäne zu verbreiten, und weiß, wie Daten mithilfe von Pipes und dem Mailslot-Transport zwischen Computern übertragen werden.  Wir haben uns auf die Untersuchung der Funktionen der Netzwerkaktivität des Trojaners konzentriert und dem Produkt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PT Network Attack Discovery</a> schnell Pegasus-Erkennungen hinzugefügt.  Auf diese Weise können alle Benutzer die Aktivität dieses Trojaners und seine Änderungen in ihrem Netzwerk rechtzeitig erkennen.  In diesem Artikel werde ich eine detaillierte Beschreibung der Netzwerkverteilungsmechanismen und der Interaktion zwischen Kopien von Pegasus geben. <br><br><img src="https://habrastorage.org/webt/yn/sn/-u/ynsn-udu1ai9y-xbrolf4fubrta.png"><a name="habracut"></a><br><br><h2>  Intro </h2><br>  Auf dem Computer injiziert das Hauptmodul InstallerExe den Code mithilfe der Process Hollowing-Technik in svchost.exe. Nach der Initialisierung der Hauptmodule startet Pegasus mehrere parallele Prozesse: <br><br><ol><li>  Domänenreplikation - befasst sich mit Informationen innerhalb des Netzwerks und versucht, diese auf andere Windows-Computer zu übertragen. </li><li>  Der Mailslot-Listener wartet auf Broadcast-Maillot-Nachrichten, über die Pegasus abgebaute Konten versendet.  Der Steckplatzname wird zur Kompilierungszeit generiert. </li><li>  Der Pipe Server Listener hört auf die Windows Pipe mit dem Namen, der im Namen des Computers generiert wurde.  Diese Pipes werden hauptsächlich verwendet, um andere Pegasus-Kopien im Netzwerk und deren Interaktion zu erkennen. </li><li>  Anmeldekennwörter versuchen regelmäßig alle paar Minuten, Kontodaten mit einem Modul von Mimikatz zu sichern. </li><li>  Die Netzwerkkonnektivität ist für die Kommunikation mit dem CnC-Server und das regelmäßige Messaging verantwortlich. </li></ol><br><pre><code class="bash hljs">// start transports <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> links data with our CB-manager pwInitPipeServerAsync(dcmGetServerCallback()); mwInitMailslotServer(dcmGetServerCallback()); ... // start broadcasting creds to other machines cmStartupNetworkBroadcaster();</code> </pre> <br><h2>  Domänenreplikation </h2><br>  Eines der Subsysteme in Pegasus ist für die seitliche Bewegung in einem Windows-Netzwerk verantwortlich.  Die Verteilung ist in zwei wichtige Schritte unterteilt: <br><br><ol><li>  Erkennung benachbarter Autos. </li><li>  Replikationsversuch auf einen Computer. </li></ol><br>  Die Erkennung benachbarter Computer in einer Domäne erfolgt über zwei API-Aufrufe: <br><br><img src="https://habrastorage.org/webt/-p/6f/sj/-p6fsjb6pe8v-rdjacycwncholk.png" align="left">  NetServerEnum, für das der Browserdienst erforderlich ist und WNetOpenEnum / WNetEnumResource aufgerufen wird. <br>  Alle in der Domäne gefundenen Computer müssen gescannt werden, wenn sie bereits infiziert sind.  Pegasus fragt den generierten Rohrnamen mehr als 20 Mal hintereinander alle 200 Millisekunden ab.  Wir haben dieses abnormale Verhalten als einen der Indikatoren für die Pegasus-Aktivität in der Domäne verwendet.  Nachdem keine Anzeichen einer Infektion festgestellt wurden, fährt die Malware mit dem nächsten Schritt fort - dem Replikationsversuch. <br><br><img src="https://habrastorage.org/webt/j0/nw/yl/j0nwylxgv6mvqzd8krxwf2su2x8.png" align="left">  Die Replikation ist wie folgt.  Unter Verwendung der gefundenen Konten (KM) auf dem Host versucht Pegasus, sich mit dem SMB-Protokoll für die IPC $ - und ADMIN $ -Bälle am Computer anzumelden. Wenn Zugriff auf IPC $ und kein Zugriff auf ADMIN $ besteht, kommt Pegasus zu dem Schluss, dass dies richtig ist Das Konto ist unzureichend und muss als ungültig markiert werden.  Nachdem die Malware Zugriff auf den ADMIN $ ball erhalten hat, der ein Alias ​​für den Ordner% windir% ist, versucht sie, die Architektur des Computers zu ermitteln, um in Zukunft das entsprechende Modul verwenden zu können. <br><br>  Der Architekturbestimmungsalgorithmus basiert auf PE-Dateikopfzeilen auf dem Remotecomputer.  Als solche Datei versucht Pegasus, die ersten 4 Kilobyte notepad.exe aus dem Ordner% windir% zu lesen.  Ein offensichtlicher Nachteil dieser Methode besteht darin, dass sich der Editor unter Windows Server 2012 im Pfad% windir% \ System32 befindet. <br><br>  Speicherort notepad.exe unter Windows 7: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe C:\Windows\notepad.exe</code> </pre><br>  Unter Windows Server 2012: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe</code> </pre><br>  Wenn notepad.exe nicht erkannt wird, kann Pegasus den Server nicht infizieren, selbst wenn er über Kontoinformationen mit den erforderlichen Rechten verfügt.  Das einfache Fehlen eines Notizblocks in% windir% kann die Verbreitung von Pegasus unter Windows Server 2012 stoppen. Die diesbezügliche Verwendung von regedit.exe ist zuverlässiger. <br><br>  Nach erfolgreicher Definition der Architektur des Zielservers lädt Pegasus einen kleinen RSE-Dropper (Remote Service Exe) mit einer Größe von etwa 10 Kilobyte, dessen Aufgabe es ist, das Binpack von den Pegasus-Modulen in klarer Form über die Pipe zu laden und die Steuerung auf das Shellcode-Modul zu übertragen.  Der Dropper-Name besteht pseudozufällig und besteht aus einer Folge von Hexadezimalzeichen mit einer Länge von 8 bis 15 Zeichen.  Der Pseudozufallsgenerator wird abhängig vom Namen der Zielmaschine initialisiert und ist zwischen den Starts gleich, um ein mögliches Durcheinander von% windir% mit früheren Kopien der Pipette zu vermeiden. <br><br><img src="https://habrastorage.org/webt/pu/qb/hf/puqbhf_9-i8k7civefzklrqegxk.png"><br><br>  Der Dropper wird vom Antivirus auf Integrität und mögliche Löschung überprüft. Anschließend wird er von einem der beiden implementierten Mechanismen - SCM oder WMI - gestartet. Zunächst versucht Pegasus, RSE über den WMI-Mechanismus zu starten, und verwendet dann nur den Service Control Manager (SCM).  Dies liegt daran, dass SCM mehr Spuren in Windows-Protokollen hinterlässt.  Die Entwickler von Pegasus planten auch andere Verteilungsmethoden - Wsh Remote, Powershell Remoting, Task Scheduler und ein Modul zur Ausführung von Befehlen über RDP waren in der Entwicklung. <br><br>  Wie oben erwähnt, überprüft und öffnet der Dropper nach einem erfolgreichen Start die Pipe zum Abhören und überträgt die Steuerung auf die eingehende Nutzlast. <br><br><img src="https://habrastorage.org/webt/od/zt/to/odztto9o8_yrp0galq3-9_owej4.png"><br><br>  Da Pegasus-Code von der Process Hollowing-Methode in den Prozess svchost.exe eingefügt wird, sollte weder das ursprüngliche InstallerExe-Modul im Falle einer Primärinfektion noch der RSE-Dropper im Falle einer Verteilung auf der Festplatte verbleiben.  Wenn die Pipette immer noch über einen bekannten Pfad zugänglich ist, entfernt Pegasus sie auf seine eigene Weise: <br><br><ol><li>  Überschreiben des Inhalts der Datei mit zufälligen Daten; </li><li>  Überschreiben mit leeren Daten (Nullen); </li><li>  Datei umbenennen; </li><li>  Löschen von Dateien. </li></ol><br><img src="https://habrastorage.org/webt/up/ti/uy/uptiuydt0vx1zc9lz29l2kcdy80.png"><br><br>  Nach einer erfolgreichen Infektion wird der Verteilungsprozess für die Domänenreplikation erneut gestartet. <br><br><h2>  Mailslot funktioniert </h2><br><img src="https://habrastorage.org/webt/z1/oa/hu/z1oahuoskry5bzymotu4d6n_9kk.png" align="left">  Nachdem Pegasus entweder von einer anderen Kopie von Pegasus oder vom Modul mod_LogonPasswords auf die Kontodaten zugegriffen hat, werden US-Daten nach Domänen gesendet.  Die Verteilung erfolgt über den Mailslot-basierten SMB-Mechanismus, der die unidirektionale Übertragung eines kleinen Teils der Daten über eine Domäne ermöglicht.  Die Verteilung erfolgt nach einem zufällig generierten Slotnamen. Damit alle infizierten Computer in der Domäne Daten unter einem einzigen Namen senden und empfangen können, wird der Pseudozufallsgenerator für Namen aus der in der Konfiguration während des Builds angegebenen Variablen TARGET_BUILDCHAIN_HASH initialisiert. <br><br>  Da der Mailslot-Mechanismus die maximale Paketgröße begrenzt, wird nach dem Prinzip der letzten Mailing-Zeit jeweils nur ein KM gesendet: Unter allen verfügbaren KMs wird die Domain, deren letztes Mailing-Datum das älteste ist, von der Domain gesendet. <br><br><img src="https://habrastorage.org/webt/e6/rw/wt/e6rwwt8svxdb_yzrszemgjeonlk.png" align="right">  Daten in Mailslot werden nicht im Klartext übertragen, sondern in drei Ebenen der XOR-Verschlüsselung eingeschlossen, und die Schlüssel werden zusammen mit den Daten übertragen.  Die erste Datenschicht ist der NetMessageEnvelope-Umschlag mit Datenintegritätsprüfung durch den SHA1-Algorithmus, der für alle über das lokale Netzwerk übertragenen Daten verwendet wird.  4 Datenbytes am Anfang des Pakets sind der Schlüssel, der durch Bitverschiebungen von 5 Bits nach rechts pro Zyklus geändert wird.  Innerhalb des Umschlags befindet sich eine XOR-codierte Datenstruktur mit direkten US-Feldern und dem Datum, an dem sie hinzugefügt wurden.  Der 8-Byte-Schlüssel befindet sich ebenfalls am Anfang der Struktur, wird jedoch ohne Offsets angewendet.  Nach dem Dekodieren der KM-Struktur müssen nur noch die einzelnen Felder aus den ENC_BUFFER-Strukturen wie Computername, Domänenname, Benutzername und Kennwort deserialisiert werden.  Diese Felder werden mit einem 8-Byte-Schlüssel mit Offsets verschlüsselt.  Das Skript zum Entschlüsseln des Mailslot-Pakets und ein Beispiel für ein solches Paket finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Skript</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PCAP</a> . <br><br>  Der Zeitraum für das Senden von Mailslot-Nachrichten in der Release-Version liegt zwischen 20 Sekunden und 11 Minuten. <br><br><pre> <code class="bash hljs">// some random <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> before making next step DbgPrint(<span class="hljs-string"><span class="hljs-string">"going to sleep"</span></span>); <span class="hljs-comment"><span class="hljs-comment">#ifdef _DEBUG // debug - 2-5 s Sleep(rg.rgGetRnd(&amp;rg, 2000, 5000)); #else // release - 20 - 650 s //Sleep(rg.rgGetRnd(&amp;rg, 2000, 65000) * 10); Sleep(rg.rgGetRnd(&amp;rg, 2000, 15000)); #endif</span></span></code> </pre> <br>  Neben dem Austausch von Konten wird der Mailslot-Mechanismus verwendet, um nach einem infizierten Computer mit Internetzugang zu suchen und für den Internetzugang zu werben.  Der NetMessageEnvelope-Umschlag speichert den Typ der gesendeten Nachricht.  Der Datenaustausch zwischen der Maschine ohne Zugang und der Maschine mit Internetzugang erfolgt über die Leitungen. <br><br><h2>  Rohr funktioniert </h2><br>  Für die bidirektionale Kommunikation oder die Übertragung großer Datenmengen verwenden Pegasus-Kopien Pipes als Kommunikationskanal.  Der Name der Pipe wird zwar ebenfalls von einem Pseudozufallsgenerator generiert, hängt jedoch vom Namen der Maschine und des Builds ab und ermöglicht es den Client- und Serverteilen, denselben Namen zu verwenden. <br><br>  Bei der Einwegkommunikation, beispielsweise beim Übertragen von binpack während der Replikation auf einen anderen Computer, werden die Daten nicht verschlüsselt und im Klartext übertragen.  Binpack beginnt mit einer SHELLCODE_CONTEXT-Struktur mit einer Länge von 561 Bytes. <br><br><img src="https://habrastorage.org/webt/qf/ja/89/qfja89-eipqz2lncisi7fkcuqbe.png"><br><br>  Während der bidirektionalen Übertragung, beispielsweise beim Proxying von Daten zwischen einer Pegasus-Kopie ohne Internetzugang und einem CnC-Server, wird dieselbe NetMessageEnvelope-Umschlagstruktur mit XOR-Verschlüsselung verwendet wie im Fall von Mailslot, weil  Sie können zwischen verschiedenen Nachrichtentypen im ID-Feld unterscheiden. <br><br>  Architektonisch wird das Datenproxying über eine Anforderung durchgeführt, um einen Teil der Daten zu übertragen (PMI_SEND_QUERY), die Anforderungs-ID als Antwort zu empfangen und den Status der Aufgabe anhand der ID (PMI_CHECK_STATUS_QUERY) abzufragen.  In der Regel wird eine andere Envelope-Struktur als Last übertragen, wobei verschiedene Funktionen und eine weitere Verschlüsselungsebene hinzugefügt werden. <br><br>  Darüber hinaus endet die Arbeit mit Pipes nicht mit der Interaktion zwischen infizierten Computern.  Das Modul mod_KBRI_hd fügt Code in die cmd.exe-Prozesse ein, die MoveFileExW-Aufrufe abfangen und alle kopierten Daten analysieren, da dies Teil des Zahlungsprozesses ist.  Wenn die kopierte Datei Daten enthält, die für Angreifer von Interesse sind - Daten mit Zahlungen -, wird eine Benachrichtigung darüber an den CnC-Server gesendet.  Die Kommunikation zwischen dem in cmd.exe eingefügten mod_KBRI-Modul und einer Kopie von Pegasus erfolgt innerhalb des infizierten Computers über eine Pipe, deren Name nicht generiert, sondern im Quellcode fest codiert ist: <br><br><pre> <code class="bash hljs">\.\pipe\pg0F9EC0DB75F67E1DBEFB3AFA2</code> </pre> <br><img src="https://habrastorage.org/webt/xr/eh/uj/xrehuj7ia40r-g4ka-osjtq9gjc.png" align="left">  Die Funktionalität des Moduls umfasst auch das Ersetzen von Datenkonten im laufenden Betrieb gemäß der Vorlage.  Ein Beispiel für Muster, nach denen im Screenshot gesucht werden soll. <br><br><h2>  CNC-Verkehr </h2><br>  Ein separater Stream ist für den direkten Datenaustausch mit dem CnC-Server verantwortlich, der alle paar Minuten die Warteschlange von Datenblöcken aus internen Prozessen oder anderen Kopien von Malware überprüft und an den Server sendet. <br><br>  Während der Initialisierung des Moduls mod_NetworkConnectivity wird eine mehrstufige Überprüfung der Netzwerkverbindung durchgeführt: <br><br>  1) Erkennen der Proxy-Server-Einstellungen und Versuch, eine Verbindung zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.google.com herzustellen</a> : <br><br><ul><li>  Im Registrierungszweig \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Interneteinstellungen. </li><li>  Über WPAD (rufen Sie WinHttpGetProxyForUrl auf). </li><li>  Über die Proxy-Konfiguration für den aktuellen Benutzer (rufen Sie WinHttpGetIEProxyConfigForCurrentUser auf). </li></ul><br>  2) Überprüfen der Verbindung mit Microsoft Update-Servern und zurückgegebenen Daten ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">authrootseq.txt</a> , <a href="">authrootstl.cab</a> , <a href="">rootupd.exe</a> ) <br><br>  3) Testen von HTTPS-Verbindungen mit einer von 6 Adressen: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">safebrowsing.google.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">aus3.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fhr.data.mozilla.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">versioncheck-bg.addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">services.addons.mozilla.org</a> </li></ul><br>  Erst nachdem alle Prüfungen bestanden wurden, glaubt Pegasus, über den erforderlichen Zugriff auf das externe Netzwerk zu verfügen, und kann dies über die Mailslot-Domain mit einer Nachricht ankündigen.  Darüber hinaus kann sich Pegasus nur während der Geschäftszeiten - von 9 bis 19 Uhr Ortszeit - verkleiden und mit dem CnC-Server kommunizieren. <br><br>  Pegasus sendet Datenblöcke, die in einem Umschlag verpackt sind, mit der Berechnung des Hashs des Betrags in verschlüsselter Form unter Verwendung der DES-Verschlüsselung im CRYPT_MODE_CBC / PKCS5_PADDING-Modus.  Der Verschlüsselungsschlüssel hängt nur von der Variablen während der Kompilierung ab. Daher können wir den Datenverkehr zwischen der Malware und dem Server entschlüsseln, indem wir nur dessen BUILDCHAIN_HASH kennen.  Im Quellcode im Archiv hatte diese Variable den Wert 0x7393c9a643eb4a76.  Ein Skript zum Entschlüsseln des Eincheckens in den Server und ein Beispiel für ein solches Paket finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Skript</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PCAP</a> . <br><br>  Dieser Inhalt (Struktur INNER_ENVELOPE) wird beim Einchecken oder zusammen mit beliebigen Daten an den CnC-Server übertragen.  Anfangs gibt es 28 Bytes einer Hüllkurve mit einem Längenfeld und einer SHA1-Summe. <br><br><img src="https://habrastorage.org/webt/po/zs/7s/pozs7shklsxh653kgnbxkgnmgl0.png"><br><br>  Dieselben Daten werden während des Proxys durch Pipes zwischen Computern übertragen, jedoch in den uns bekannten NetMessageEnvelope-Umschlag mit einer Hash-Summe und XOR-Verschlüsselung eingeschlossen. <br><br>  Der CnC-Operator kann Befehle zur Ausführung an Pegasus-Kopien und Nachrichten mit Befehlen oder anderen Daten senden. Beispielsweise kann EID_CREDENTIALS_LIST eigene Feldverschlüsselungsschichten enthalten, wie wir im Beispiel für Broadcast-Konten gesehen haben. <br><br><h2>  Erkennung </h2><br>  Zunächst waren wir daran interessiert, Pegasus-Aktivitäten im Netzwerk zu erkennen, und nachdem wir die Quellcodes sorgfältig untersucht und in der Testumgebung ausgeführt hatten, fanden wir die Netzwerkanomalien und -artefakte, die eindeutig auf das Vorhandensein dieser komplexen Malware im Netzwerk hinweisen.  Pegasus kann wirklich als vielseitig bezeichnet werden - es verwendet aktiv das SMB-Protokoll, um Nachrichten zu senden und die Kommunikation mit anderen Kopien herzustellen, verteilt sich auf andere Computer und kommuniziert auf seine eigene spezielle Weise mit dem CnC-Server.  Durch die Installation eines Peer-to-Peer-Netzwerks in der Domäne ebnen Kopien von Pegasus den Weg zum externen Netzwerk und kommunizieren mit dem CnC-Server, indem sie den Datenverkehr untereinander übertragen.  Die Verwendung von Zertifikaten zum Signieren ausführbarer Dateien und der Zugriff auf Microsoft- und Mozilla-Ressourcen während der Verbindungsüberprüfung erschwert die Erkennung der Aktivität und Erkennung auf dem Host. <br><br>  Das Pegasus-Quellcode-Projekt ist ziemlich gut strukturiert und beschrieben, sodass wir in naher Zukunft erwarten können, dass Teile seines Codes von anderen Schadprogrammen ausgeliehen werden und Änderungen auftreten. <br><br>  Viele der Mechanismen für die Remote-Ausführung von Befehlen und die Suche nach Kontodaten blieben unrealisiert. Die Entwickler wollten außerdem die Möglichkeit hinzufügen, den Shellcode während der Implementierung im laufenden Betrieb zu ändern.  Und das sind nicht alle ihre Ideen. <br><br>  Wir haben mehrere Signaturen für PT NAD und IDS Suricata entwickelt, mit denen wir Pegasus-spezifische Netzwerkaktivitäten in verschiedenen Stadien ab den ersten Sekunden ihrer Aktivität identifizieren können.  Sie finden offene Signaturen für Suricata IDS auf unserem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Twitter</a> . Sie werden automatisch zu Ihren Suricata weitergeleitet, wenn Sie den Suricata-Update-Update-Mechanismus verwenden. <br><br>  Wie die Signaturen für die Pegasus-Aktivität funktionieren, sehen Sie im folgenden Screenshot.  Dies ist unser neues Produkt von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PT Network Attack Discovery</a> , das Vorfälle identifiziert und bei der Untersuchung hilft: <br><br> <a href=""><img src="https://habrastorage.org/webt/cc/ok/ou/ccokou2rr1ed01valiivylk6prs.png"></a> <br><br>  Darüber hinaus können die folgenden Kompromissindikatoren (IC) zur Erkennung verwendet werden: <br><br><pre>  MAILSLOT \ 46CA075C165CBB2786 
 Pipe \ pg0F9EC0DB75F67E1DBEFB3AFA2<font></font>
<font></font>
 hxxp: //denwer/pegasus/index.php
 hxxp: //mp3.ucrazy.org/music/index.php
 hxxp: //support.zakon-auto.net/tuning/index.asp
 hxxp: //video.tnt-online.info/tnt-comedy-tv/stream.php </pre><br>  Gepostet <b>von</b> Cyril Shipulin von @attackdetection, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Twitter</a> |  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Telegramm</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de418017/">https://habr.com/ru/post/de418017/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de418005/index.html">Softwareentwickler stimmen der Definition von „Spezialhardware“ des FSB nicht zu</a></li>
<li><a href="../de418009/index.html">Node.js und Server-Rendering in Airbnb</a></li>
<li><a href="../de418011/index.html">Einzelseiten und SEO. Optimierungsgeheimnisse</a></li>
<li><a href="../de418013/index.html">Der Intel Core i7-8086K (Teil 3)</a></li>
<li><a href="../de418015/index.html">Neuer Vasyuki. Innovative Entwicklung Moskaus bis 2100</a></li>
<li><a href="../de418023/index.html">Zeiger in C sind abstrakter als Sie vielleicht denken</a></li>
<li><a href="../de418025/index.html">Das Buch „Java EE lernen. Moderne Programmierung für große Unternehmen “</a></li>
<li><a href="../de418027/index.html">Microservice Blitz</a></li>
<li><a href="../de418029/index.html">ReactOS 0.4.9: Hasser müssen nach neuen Argumenten suchen</a></li>
<li><a href="../de418031/index.html">Massenstapelung von ML-Modellen in der Produktion: echt oder nicht?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>