<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßôüèø üë®üèª‚Äçüè´ üçÑ Analyse des Verhaltens des Pegasus-Trojaners im Netzwerk üë©üèº‚Äçüé® üë©‚Äçüíª üßê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Quellcode f√ºr den Pegasus-Banking-Trojaner wurde k√ºrzlich ver√∂ffentlicht . Trotz der Erw√§hnung der Carbanak-Gruppe im Namen des Archivs bestritten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse des Verhaltens des Pegasus-Trojaners im Netzwerk</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/418017/">  Der Quellcode f√ºr den Pegasus-Banking-Trojaner wurde k√ºrzlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ver√∂ffentlicht</a> .  Trotz der Erw√§hnung der Carbanak-Gruppe im Namen des Archivs bestritten Forscher von Minerva Labs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die</a> Beteiligung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">des</a> Trojaners an dieser Gruppe und bewiesen ihre Beteiligung an der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Buhtrap-</a> Gruppe (Ratopak).  Im Archiv finden Sie eine kurze Beschreibung der Arbeit des Trojaners, seiner Quellcodes, eine Beschreibung des Bankzahlungssystems und die Daten der Mitarbeiter vieler russischer Banken. <br><br>  Die Quellcode-Architektur dieser Malware ist sehr interessant.  Die Funktionalit√§t ist in Module unterteilt, die bei der Kompilierung zu einem einzigen ‚ÄûBinpack‚Äú zusammengefasst werden.  Der Kompilierungsprozess umfasst auch das Signieren ausf√ºhrbarer Dateien mit einem Zertifikat aus der Datei tric.pfx, die sich nicht im Archiv befindet. <br><br>  Nicht weniger merkw√ºrdig ist die Netzwerkaktivit√§t von Pegasus, der nach einer Infektion versucht, sich innerhalb der Dom√§ne zu verbreiten, und wei√ü, wie Daten mithilfe von Pipes und dem Mailslot-Transport zwischen Computern √ºbertragen werden.  Wir haben uns auf die Untersuchung der Funktionen der Netzwerkaktivit√§t des Trojaners konzentriert und dem Produkt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PT Network Attack Discovery</a> schnell Pegasus-Erkennungen hinzugef√ºgt.  Auf diese Weise k√∂nnen alle Benutzer die Aktivit√§t dieses Trojaners und seine √Ñnderungen in ihrem Netzwerk rechtzeitig erkennen.  In diesem Artikel werde ich eine detaillierte Beschreibung der Netzwerkverteilungsmechanismen und der Interaktion zwischen Kopien von Pegasus geben. <br><br><img src="https://habrastorage.org/webt/yn/sn/-u/ynsn-udu1ai9y-xbrolf4fubrta.png"><a name="habracut"></a><br><br><h2>  Intro </h2><br>  Auf dem Computer injiziert das Hauptmodul InstallerExe den Code mithilfe der Process Hollowing-Technik in svchost.exe. Nach der Initialisierung der Hauptmodule startet Pegasus mehrere parallele Prozesse: <br><br><ol><li>  Dom√§nenreplikation - befasst sich mit Informationen innerhalb des Netzwerks und versucht, diese auf andere Windows-Computer zu √ºbertragen. </li><li>  Der Mailslot-Listener wartet auf Broadcast-Maillot-Nachrichten, √ºber die Pegasus abgebaute Konten versendet.  Der Steckplatzname wird zur Kompilierungszeit generiert. </li><li>  Der Pipe Server Listener h√∂rt auf die Windows Pipe mit dem Namen, der im Namen des Computers generiert wurde.  Diese Pipes werden haupts√§chlich verwendet, um andere Pegasus-Kopien im Netzwerk und deren Interaktion zu erkennen. </li><li>  Anmeldekennw√∂rter versuchen regelm√§√üig alle paar Minuten, Kontodaten mit einem Modul von Mimikatz zu sichern. </li><li>  Die Netzwerkkonnektivit√§t ist f√ºr die Kommunikation mit dem CnC-Server und das regelm√§√üige Messaging verantwortlich. </li></ol><br><pre><code class="bash hljs">// start transports <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> links data with our CB-manager pwInitPipeServerAsync(dcmGetServerCallback()); mwInitMailslotServer(dcmGetServerCallback()); ... // start broadcasting creds to other machines cmStartupNetworkBroadcaster();</code> </pre> <br><h2>  Dom√§nenreplikation </h2><br>  Eines der Subsysteme in Pegasus ist f√ºr die seitliche Bewegung in einem Windows-Netzwerk verantwortlich.  Die Verteilung ist in zwei wichtige Schritte unterteilt: <br><br><ol><li>  Erkennung benachbarter Autos. </li><li>  Replikationsversuch auf einen Computer. </li></ol><br>  Die Erkennung benachbarter Computer in einer Dom√§ne erfolgt √ºber zwei API-Aufrufe: <br><br><img src="https://habrastorage.org/webt/-p/6f/sj/-p6fsjb6pe8v-rdjacycwncholk.png" align="left">  NetServerEnum, f√ºr das der Browserdienst erforderlich ist und WNetOpenEnum / WNetEnumResource aufgerufen wird. <br>  Alle in der Dom√§ne gefundenen Computer m√ºssen gescannt werden, wenn sie bereits infiziert sind.  Pegasus fragt den generierten Rohrnamen mehr als 20 Mal hintereinander alle 200 Millisekunden ab.  Wir haben dieses abnormale Verhalten als einen der Indikatoren f√ºr die Pegasus-Aktivit√§t in der Dom√§ne verwendet.  Nachdem keine Anzeichen einer Infektion festgestellt wurden, f√§hrt die Malware mit dem n√§chsten Schritt fort - dem Replikationsversuch. <br><br><img src="https://habrastorage.org/webt/j0/nw/yl/j0nwylxgv6mvqzd8krxwf2su2x8.png" align="left">  Die Replikation ist wie folgt.  Unter Verwendung der gefundenen Konten (KM) auf dem Host versucht Pegasus, sich mit dem SMB-Protokoll f√ºr die IPC $ - und ADMIN $ -B√§lle am Computer anzumelden. Wenn Zugriff auf IPC $ und kein Zugriff auf ADMIN $ besteht, kommt Pegasus zu dem Schluss, dass dies richtig ist Das Konto ist unzureichend und muss als ung√ºltig markiert werden.  Nachdem die Malware Zugriff auf den ADMIN $ ball erhalten hat, der ein Alias ‚Äã‚Äãf√ºr den Ordner% windir% ist, versucht sie, die Architektur des Computers zu ermitteln, um in Zukunft das entsprechende Modul verwenden zu k√∂nnen. <br><br>  Der Architekturbestimmungsalgorithmus basiert auf PE-Dateikopfzeilen auf dem Remotecomputer.  Als solche Datei versucht Pegasus, die ersten 4 Kilobyte notepad.exe aus dem Ordner% windir% zu lesen.  Ein offensichtlicher Nachteil dieser Methode besteht darin, dass sich der Editor unter Windows Server 2012 im Pfad% windir% \ System32 befindet. <br><br>  Speicherort notepad.exe unter Windows 7: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe C:\Windows\notepad.exe</code> </pre><br>  Unter Windows Server 2012: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe</code> </pre><br>  Wenn notepad.exe nicht erkannt wird, kann Pegasus den Server nicht infizieren, selbst wenn er √ºber Kontoinformationen mit den erforderlichen Rechten verf√ºgt.  Das einfache Fehlen eines Notizblocks in% windir% kann die Verbreitung von Pegasus unter Windows Server 2012 stoppen. Die diesbez√ºgliche Verwendung von regedit.exe ist zuverl√§ssiger. <br><br>  Nach erfolgreicher Definition der Architektur des Zielservers l√§dt Pegasus einen kleinen RSE-Dropper (Remote Service Exe) mit einer Gr√∂√üe von etwa 10 Kilobyte, dessen Aufgabe es ist, das Binpack von den Pegasus-Modulen in klarer Form √ºber die Pipe zu laden und die Steuerung auf das Shellcode-Modul zu √ºbertragen.  Der Dropper-Name besteht pseudozuf√§llig und besteht aus einer Folge von Hexadezimalzeichen mit einer L√§nge von 8 bis 15 Zeichen.  Der Pseudozufallsgenerator wird abh√§ngig vom Namen der Zielmaschine initialisiert und ist zwischen den Starts gleich, um ein m√∂gliches Durcheinander von% windir% mit fr√ºheren Kopien der Pipette zu vermeiden. <br><br><img src="https://habrastorage.org/webt/pu/qb/hf/puqbhf_9-i8k7civefzklrqegxk.png"><br><br>  Der Dropper wird vom Antivirus auf Integrit√§t und m√∂gliche L√∂schung √ºberpr√ºft. Anschlie√üend wird er von einem der beiden implementierten Mechanismen - SCM oder WMI - gestartet. Zun√§chst versucht Pegasus, RSE √ºber den WMI-Mechanismus zu starten, und verwendet dann nur den Service Control Manager (SCM).  Dies liegt daran, dass SCM mehr Spuren in Windows-Protokollen hinterl√§sst.  Die Entwickler von Pegasus planten auch andere Verteilungsmethoden - Wsh Remote, Powershell Remoting, Task Scheduler und ein Modul zur Ausf√ºhrung von Befehlen √ºber RDP waren in der Entwicklung. <br><br>  Wie oben erw√§hnt, √ºberpr√ºft und √∂ffnet der Dropper nach einem erfolgreichen Start die Pipe zum Abh√∂ren und √ºbertr√§gt die Steuerung auf die eingehende Nutzlast. <br><br><img src="https://habrastorage.org/webt/od/zt/to/odztto9o8_yrp0galq3-9_owej4.png"><br><br>  Da Pegasus-Code von der Process Hollowing-Methode in den Prozess svchost.exe eingef√ºgt wird, sollte weder das urspr√ºngliche InstallerExe-Modul im Falle einer Prim√§rinfektion noch der RSE-Dropper im Falle einer Verteilung auf der Festplatte verbleiben.  Wenn die Pipette immer noch √ºber einen bekannten Pfad zug√§nglich ist, entfernt Pegasus sie auf seine eigene Weise: <br><br><ol><li>  √úberschreiben des Inhalts der Datei mit zuf√§lligen Daten; </li><li>  √úberschreiben mit leeren Daten (Nullen); </li><li>  Datei umbenennen; </li><li>  L√∂schen von Dateien. </li></ol><br><img src="https://habrastorage.org/webt/up/ti/uy/uptiuydt0vx1zc9lz29l2kcdy80.png"><br><br>  Nach einer erfolgreichen Infektion wird der Verteilungsprozess f√ºr die Dom√§nenreplikation erneut gestartet. <br><br><h2>  Mailslot funktioniert </h2><br><img src="https://habrastorage.org/webt/z1/oa/hu/z1oahuoskry5bzymotu4d6n_9kk.png" align="left">  Nachdem Pegasus entweder von einer anderen Kopie von Pegasus oder vom Modul mod_LogonPasswords auf die Kontodaten zugegriffen hat, werden US-Daten nach Dom√§nen gesendet.  Die Verteilung erfolgt √ºber den Mailslot-basierten SMB-Mechanismus, der die unidirektionale √úbertragung eines kleinen Teils der Daten √ºber eine Dom√§ne erm√∂glicht.  Die Verteilung erfolgt nach einem zuf√§llig generierten Slotnamen. Damit alle infizierten Computer in der Dom√§ne Daten unter einem einzigen Namen senden und empfangen k√∂nnen, wird der Pseudozufallsgenerator f√ºr Namen aus der in der Konfiguration w√§hrend des Builds angegebenen Variablen TARGET_BUILDCHAIN_HASH initialisiert. <br><br>  Da der Mailslot-Mechanismus die maximale Paketgr√∂√üe begrenzt, wird nach dem Prinzip der letzten Mailing-Zeit jeweils nur ein KM gesendet: Unter allen verf√ºgbaren KMs wird die Domain, deren letztes Mailing-Datum das √§lteste ist, von der Domain gesendet. <br><br><img src="https://habrastorage.org/webt/e6/rw/wt/e6rwwt8svxdb_yzrszemgjeonlk.png" align="right">  Daten in Mailslot werden nicht im Klartext √ºbertragen, sondern in drei Ebenen der XOR-Verschl√ºsselung eingeschlossen, und die Schl√ºssel werden zusammen mit den Daten √ºbertragen.  Die erste Datenschicht ist der NetMessageEnvelope-Umschlag mit Datenintegrit√§tspr√ºfung durch den SHA1-Algorithmus, der f√ºr alle √ºber das lokale Netzwerk √ºbertragenen Daten verwendet wird.  4 Datenbytes am Anfang des Pakets sind der Schl√ºssel, der durch Bitverschiebungen von 5 Bits nach rechts pro Zyklus ge√§ndert wird.  Innerhalb des Umschlags befindet sich eine XOR-codierte Datenstruktur mit direkten US-Feldern und dem Datum, an dem sie hinzugef√ºgt wurden.  Der 8-Byte-Schl√ºssel befindet sich ebenfalls am Anfang der Struktur, wird jedoch ohne Offsets angewendet.  Nach dem Dekodieren der KM-Struktur m√ºssen nur noch die einzelnen Felder aus den ENC_BUFFER-Strukturen wie Computername, Dom√§nenname, Benutzername und Kennwort deserialisiert werden.  Diese Felder werden mit einem 8-Byte-Schl√ºssel mit Offsets verschl√ºsselt.  Das Skript zum Entschl√ºsseln des Mailslot-Pakets und ein Beispiel f√ºr ein solches Paket finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Skript</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PCAP</a> . <br><br>  Der Zeitraum f√ºr das Senden von Mailslot-Nachrichten in der Release-Version liegt zwischen 20 Sekunden und 11 Minuten. <br><br><pre> <code class="bash hljs">// some random <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> before making next step DbgPrint(<span class="hljs-string"><span class="hljs-string">"going to sleep"</span></span>); <span class="hljs-comment"><span class="hljs-comment">#ifdef _DEBUG // debug - 2-5 s Sleep(rg.rgGetRnd(&amp;rg, 2000, 5000)); #else // release - 20 - 650 s //Sleep(rg.rgGetRnd(&amp;rg, 2000, 65000) * 10); Sleep(rg.rgGetRnd(&amp;rg, 2000, 15000)); #endif</span></span></code> </pre> <br>  Neben dem Austausch von Konten wird der Mailslot-Mechanismus verwendet, um nach einem infizierten Computer mit Internetzugang zu suchen und f√ºr den Internetzugang zu werben.  Der NetMessageEnvelope-Umschlag speichert den Typ der gesendeten Nachricht.  Der Datenaustausch zwischen der Maschine ohne Zugang und der Maschine mit Internetzugang erfolgt √ºber die Leitungen. <br><br><h2>  Rohr funktioniert </h2><br>  F√ºr die bidirektionale Kommunikation oder die √úbertragung gro√üer Datenmengen verwenden Pegasus-Kopien Pipes als Kommunikationskanal.  Der Name der Pipe wird zwar ebenfalls von einem Pseudozufallsgenerator generiert, h√§ngt jedoch vom Namen der Maschine und des Builds ab und erm√∂glicht es den Client- und Serverteilen, denselben Namen zu verwenden. <br><br>  Bei der Einwegkommunikation, beispielsweise beim √úbertragen von binpack w√§hrend der Replikation auf einen anderen Computer, werden die Daten nicht verschl√ºsselt und im Klartext √ºbertragen.  Binpack beginnt mit einer SHELLCODE_CONTEXT-Struktur mit einer L√§nge von 561 Bytes. <br><br><img src="https://habrastorage.org/webt/qf/ja/89/qfja89-eipqz2lncisi7fkcuqbe.png"><br><br>  W√§hrend der bidirektionalen √úbertragung, beispielsweise beim Proxying von Daten zwischen einer Pegasus-Kopie ohne Internetzugang und einem CnC-Server, wird dieselbe NetMessageEnvelope-Umschlagstruktur mit XOR-Verschl√ºsselung verwendet wie im Fall von Mailslot, weil  Sie k√∂nnen zwischen verschiedenen Nachrichtentypen im ID-Feld unterscheiden. <br><br>  Architektonisch wird das Datenproxying √ºber eine Anforderung durchgef√ºhrt, um einen Teil der Daten zu √ºbertragen (PMI_SEND_QUERY), die Anforderungs-ID als Antwort zu empfangen und den Status der Aufgabe anhand der ID (PMI_CHECK_STATUS_QUERY) abzufragen.  In der Regel wird eine andere Envelope-Struktur als Last √ºbertragen, wobei verschiedene Funktionen und eine weitere Verschl√ºsselungsebene hinzugef√ºgt werden. <br><br>  Dar√ºber hinaus endet die Arbeit mit Pipes nicht mit der Interaktion zwischen infizierten Computern.  Das Modul mod_KBRI_hd f√ºgt Code in die cmd.exe-Prozesse ein, die MoveFileExW-Aufrufe abfangen und alle kopierten Daten analysieren, da dies Teil des Zahlungsprozesses ist.  Wenn die kopierte Datei Daten enth√§lt, die f√ºr Angreifer von Interesse sind - Daten mit Zahlungen -, wird eine Benachrichtigung dar√ºber an den CnC-Server gesendet.  Die Kommunikation zwischen dem in cmd.exe eingef√ºgten mod_KBRI-Modul und einer Kopie von Pegasus erfolgt innerhalb des infizierten Computers √ºber eine Pipe, deren Name nicht generiert, sondern im Quellcode fest codiert ist: <br><br><pre> <code class="bash hljs">\.\pipe\pg0F9EC0DB75F67E1DBEFB3AFA2</code> </pre> <br><img src="https://habrastorage.org/webt/xr/eh/uj/xrehuj7ia40r-g4ka-osjtq9gjc.png" align="left">  Die Funktionalit√§t des Moduls umfasst auch das Ersetzen von Datenkonten im laufenden Betrieb gem√§√ü der Vorlage.  Ein Beispiel f√ºr Muster, nach denen im Screenshot gesucht werden soll. <br><br><h2>  CNC-Verkehr </h2><br>  Ein separater Stream ist f√ºr den direkten Datenaustausch mit dem CnC-Server verantwortlich, der alle paar Minuten die Warteschlange von Datenbl√∂cken aus internen Prozessen oder anderen Kopien von Malware √ºberpr√ºft und an den Server sendet. <br><br>  W√§hrend der Initialisierung des Moduls mod_NetworkConnectivity wird eine mehrstufige √úberpr√ºfung der Netzwerkverbindung durchgef√ºhrt: <br><br>  1) Erkennen der Proxy-Server-Einstellungen und Versuch, eine Verbindung zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.google.com herzustellen</a> : <br><br><ul><li>  Im Registrierungszweig \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Interneteinstellungen. </li><li>  √úber WPAD (rufen Sie WinHttpGetProxyForUrl auf). </li><li>  √úber die Proxy-Konfiguration f√ºr den aktuellen Benutzer (rufen Sie WinHttpGetIEProxyConfigForCurrentUser auf). </li></ul><br>  2) √úberpr√ºfen der Verbindung mit Microsoft Update-Servern und zur√ºckgegebenen Daten ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">authrootseq.txt</a> , <a href="">authrootstl.cab</a> , <a href="">rootupd.exe</a> ) <br><br>  3) Testen von HTTPS-Verbindungen mit einer von 6 Adressen: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">safebrowsing.google.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">aus3.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fhr.data.mozilla.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">versioncheck-bg.addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">services.addons.mozilla.org</a> </li></ul><br>  Erst nachdem alle Pr√ºfungen bestanden wurden, glaubt Pegasus, √ºber den erforderlichen Zugriff auf das externe Netzwerk zu verf√ºgen, und kann dies √ºber die Mailslot-Domain mit einer Nachricht ank√ºndigen.  Dar√ºber hinaus kann sich Pegasus nur w√§hrend der Gesch√§ftszeiten - von 9 bis 19 Uhr Ortszeit - verkleiden und mit dem CnC-Server kommunizieren. <br><br>  Pegasus sendet Datenbl√∂cke, die in einem Umschlag verpackt sind, mit der Berechnung des Hashs des Betrags in verschl√ºsselter Form unter Verwendung der DES-Verschl√ºsselung im CRYPT_MODE_CBC / PKCS5_PADDING-Modus.  Der Verschl√ºsselungsschl√ºssel h√§ngt nur von der Variablen w√§hrend der Kompilierung ab. Daher k√∂nnen wir den Datenverkehr zwischen der Malware und dem Server entschl√ºsseln, indem wir nur dessen BUILDCHAIN_HASH kennen.  Im Quellcode im Archiv hatte diese Variable den Wert 0x7393c9a643eb4a76.  Ein Skript zum Entschl√ºsseln des Eincheckens in den Server und ein Beispiel f√ºr ein solches Paket finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Skript</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PCAP</a> . <br><br>  Dieser Inhalt (Struktur INNER_ENVELOPE) wird beim Einchecken oder zusammen mit beliebigen Daten an den CnC-Server √ºbertragen.  Anfangs gibt es 28 Bytes einer H√ºllkurve mit einem L√§ngenfeld und einer SHA1-Summe. <br><br><img src="https://habrastorage.org/webt/po/zs/7s/pozs7shklsxh653kgnbxkgnmgl0.png"><br><br>  Dieselben Daten werden w√§hrend des Proxys durch Pipes zwischen Computern √ºbertragen, jedoch in den uns bekannten NetMessageEnvelope-Umschlag mit einer Hash-Summe und XOR-Verschl√ºsselung eingeschlossen. <br><br>  Der CnC-Operator kann Befehle zur Ausf√ºhrung an Pegasus-Kopien und Nachrichten mit Befehlen oder anderen Daten senden. Beispielsweise kann EID_CREDENTIALS_LIST eigene Feldverschl√ºsselungsschichten enthalten, wie wir im Beispiel f√ºr Broadcast-Konten gesehen haben. <br><br><h2>  Erkennung </h2><br>  Zun√§chst waren wir daran interessiert, Pegasus-Aktivit√§ten im Netzwerk zu erkennen, und nachdem wir die Quellcodes sorgf√§ltig untersucht und in der Testumgebung ausgef√ºhrt hatten, fanden wir die Netzwerkanomalien und -artefakte, die eindeutig auf das Vorhandensein dieser komplexen Malware im Netzwerk hinweisen.  Pegasus kann wirklich als vielseitig bezeichnet werden - es verwendet aktiv das SMB-Protokoll, um Nachrichten zu senden und die Kommunikation mit anderen Kopien herzustellen, verteilt sich auf andere Computer und kommuniziert auf seine eigene spezielle Weise mit dem CnC-Server.  Durch die Installation eines Peer-to-Peer-Netzwerks in der Dom√§ne ebnen Kopien von Pegasus den Weg zum externen Netzwerk und kommunizieren mit dem CnC-Server, indem sie den Datenverkehr untereinander √ºbertragen.  Die Verwendung von Zertifikaten zum Signieren ausf√ºhrbarer Dateien und der Zugriff auf Microsoft- und Mozilla-Ressourcen w√§hrend der Verbindungs√ºberpr√ºfung erschwert die Erkennung der Aktivit√§t und Erkennung auf dem Host. <br><br>  Das Pegasus-Quellcode-Projekt ist ziemlich gut strukturiert und beschrieben, sodass wir in naher Zukunft erwarten k√∂nnen, dass Teile seines Codes von anderen Schadprogrammen ausgeliehen werden und √Ñnderungen auftreten. <br><br>  Viele der Mechanismen f√ºr die Remote-Ausf√ºhrung von Befehlen und die Suche nach Kontodaten blieben unrealisiert. Die Entwickler wollten au√üerdem die M√∂glichkeit hinzuf√ºgen, den Shellcode w√§hrend der Implementierung im laufenden Betrieb zu √§ndern.  Und das sind nicht alle ihre Ideen. <br><br>  Wir haben mehrere Signaturen f√ºr PT NAD und IDS Suricata entwickelt, mit denen wir Pegasus-spezifische Netzwerkaktivit√§ten in verschiedenen Stadien ab den ersten Sekunden ihrer Aktivit√§t identifizieren k√∂nnen.  Sie finden offene Signaturen f√ºr Suricata IDS auf unserem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Twitter</a> . Sie werden automatisch zu Ihren Suricata weitergeleitet, wenn Sie den Suricata-Update-Update-Mechanismus verwenden. <br><br>  Wie die Signaturen f√ºr die Pegasus-Aktivit√§t funktionieren, sehen Sie im folgenden Screenshot.  Dies ist unser neues Produkt von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PT Network Attack Discovery</a> , das Vorf√§lle identifiziert und bei der Untersuchung hilft: <br><br> <a href=""><img src="https://habrastorage.org/webt/cc/ok/ou/ccokou2rr1ed01valiivylk6prs.png"></a> <br><br>  Dar√ºber hinaus k√∂nnen die folgenden Kompromissindikatoren (IC) zur Erkennung verwendet werden: <br><br><pre>  MAILSLOT \ 46CA075C165CBB2786 
 Pipe \ pg0F9EC0DB75F67E1DBEFB3AFA2<font></font>
<font></font>
 hxxp: //denwer/pegasus/index.php
 hxxp: //mp3.ucrazy.org/music/index.php
 hxxp: //support.zakon-auto.net/tuning/index.asp
 hxxp: //video.tnt-online.info/tnt-comedy-tv/stream.php </pre><br>  Gepostet <b>von</b> Cyril Shipulin von @attackdetection, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Twitter</a> |  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Telegramm</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de418017/">https://habr.com/ru/post/de418017/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de418005/index.html">Softwareentwickler stimmen der Definition von ‚ÄûSpezialhardware‚Äú des FSB nicht zu</a></li>
<li><a href="../de418009/index.html">Node.js und Server-Rendering in Airbnb</a></li>
<li><a href="../de418011/index.html">Einzelseiten und SEO. Optimierungsgeheimnisse</a></li>
<li><a href="../de418013/index.html">Der Intel Core i7-8086K (Teil 3)</a></li>
<li><a href="../de418015/index.html">Neuer Vasyuki. Innovative Entwicklung Moskaus bis 2100</a></li>
<li><a href="../de418023/index.html">Zeiger in C sind abstrakter als Sie vielleicht denken</a></li>
<li><a href="../de418025/index.html">Das Buch ‚ÄûJava EE lernen. Moderne Programmierung f√ºr gro√üe Unternehmen ‚Äú</a></li>
<li><a href="../de418027/index.html">Microservice Blitz</a></li>
<li><a href="../de418029/index.html">ReactOS 0.4.9: Hasser m√ºssen nach neuen Argumenten suchen</a></li>
<li><a href="../de418031/index.html">Massenstapelung von ML-Modellen in der Produktion: echt oder nicht?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>