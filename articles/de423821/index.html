<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòä üòÅ üçü Mafia on Go, Vanila JS und WebSocket'ah ü•Ç ü•û üò§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es geht um die Web-Implementierung des beliebten Kartenspiels " Mafia ". Es wurde f√ºr Spa√ü und Erfahrung in der Spieleentwicklung geschrieben. Die ers...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mafia on Go, Vanila JS und WebSocket'ah</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423821/"><img src="https://habrastorage.org/webt/lc/iv/d5/lcivd5kwwdn6oujpg2i2ppbgovs.png"><br><br>  Es geht um die Web-Implementierung des beliebten Kartenspiels " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mafia</a> ".  Es wurde f√ºr Spa√ü und Erfahrung in der Spieleentwicklung geschrieben.  Die erste Version wurde in zwei Wochen Freizeit von der Arbeit geschrieben und gleichzeitig in die zweite Version umgeschrieben.  Der Vorteil dieses Spiels ist das Fehlen eines Hosts. <br><a name="habracut"></a><br>  Basierend auf den Entwicklungszielen habe ich mich f√ºr die Implementierung / Nichtimplementierung von Features entschieden. <br>  Was genau getan werden musste: <br><br><ul><li>  Minimales Spiel, das die Regeln des klassischen Spiels wiederholt </li><li>  Stimme der Befehle des F√ºhrers auf Clientger√§ten </li><li>  Fortsetzung des Spiels auch nach dem Neustart der Browser-Registerkarte </li></ul><br>  Was nicht geplant war oder verschoben werden konnte: <br><br><ul><li>  Spielregistrierung </li><li>  Administrationsoberfl√§che </li><li>  Permanente Speicherung von Spieldaten in einer Datenbank </li><li> Zeitsynchronisation zwischen Ger√§ten </li></ul><br><h3>  Backend </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/mrsuh/mafia-backend</a> <br>  Geschrieben in Go.  Es speichert den Status des Spiels und ist f√ºr seine Logik verantwortlich. <br><br>  W√§hrend des Spiels k√∂nnen Sie den Server kontaktieren, um die vollst√§ndigen Informationen zu erhalten: <br><br><pre><code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">'http://127.0.0.1:8000/info?game=23'</span></span> | python -m json.tool</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Spielinformationsanzeige</b> <div class="spoiler_text"> <code>{ <br> "event": "greet_mafia", <br> "event_status": 2, <br> "id": 23, <br> "is_over": false, <br> "iter": 1, <br> "players": [ <br> { <br> "addr": "172.18.0.1:51438", <br> "createdAt": "2018-09-23T14:39:29.631475779Z", <br> "id": 33309, <br> "name": "Anton", <br> "role": 4 <br> }, <br> { <br> "addr": "172.18.0.1:51440", <br> "createdAt": "2018-09-23T14:39:32.867080927Z", <br> "id": 5457, <br> "name": "username:0", <br> "role": 2 <br> }, <br> { <br> "addr": "172.18.0.1:51442", <br> "createdAt": "2018-09-23T14:39:32.882463945Z", <br> "id": 14214, <br> "name": "username:2", <br> "role": 1 <br> }, <br> { <br> "addr": "172.18.0.1:51444", <br> "createdAt": "2018-09-23T14:39:32.895209072Z", <br> "id": 63759, <br> "name": "username:1", <br> "role": 3 <br> } <br> ], <br> "win": 0 <br> }</code> <br> </div></div><br>  Oder finden Sie den Status des Servers heraus: <br><br><pre> <code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">'http://127.0.0.1:8000/health'</span></span> | python -m json.tool</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Serverstatusinformationen anzeigen</b> <div class="spoiler_text"> <code>{ <br> "runtime.MemStats.Alloc": 764752, <br> "runtime.MemStats.NumGC": 0, <br> "runtime.MemStats.Sys": 4165632, <br> "runtime.MemStats.TotalAlloc": 764752, <br> "runtime.NumGoroutine": 14 <br> }</code> <br> </div></div><br>  Um festzustellen, ob der Player noch aktiv ist, sendet das Backend einen Herzschlag.  Wenn ein Spieler nach einem bestimmten Intervall nicht reagiert, wird er aus dem Spiel ausgeschlossen.  Wenn sich ein Spieler vor dem Ende des Intervalls erneut verbindet (das Netzwerk ist verschwunden), kann er das Spiel fortsetzen. <br><br>  F√ºr einen stabilen Betrieb wurde das Backend durch Unit-Tests mit der Standard- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Go-Bibliothek</a> abgedeckt, in denen die wichtigsten Betriebsszenarien √ºberpr√ºft werden. <br><br><pre> <code class="bash hljs">go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> mafia-backend/src -cover ok mafia-backend/src 1.315s coverage: 70.7% of statements</code> </pre><br><h3>  Frontend </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/mrsuh/mafia-frontend</a> <br>  Es ist in reinem JS geschrieben und mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Grunt erstellt</a> . <br>  Es enth√§lt keine Logik. <br><br>  Wenn ein Ereignis mit dem Backend auftritt, wird die gew√ºnschte Seite gerendert, die an es gesendeten Daten angezeigt und der Sound des neuen Ereignisses abgespielt. <br><br>  Das Frontend speichert die Spiel- und Spieler- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">IDs</a> in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LocalStorage</a> oder in der Browser- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Abfragezeichenfolge</a> (wenn Sie mehrere Registerkarten in einem Browser f√ºr verschiedene Spieler ausf√ºhren m√ºssen).  Das v√∂llige Fehlen von Logik sowie die Speicherung der Grundparameter des Spiels erm√∂glichen es, auch nach dem erneuten Laden der Seite den Status des Spiels wiederherzustellen. <br><br>  Der Browser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verhindert die</a> automatische Wiedergabe von Sounds ohne Benutzereingriff (z. B. Dr√ºcken einer Taste).  Um Sounds f√ºr jedes Ereignis abzuspielen, das mit dem Backend geliefert wird, wurde nur 1 JavaScript-Audioobjekt erstellt.  Jeder Spieler muss eine Taste dr√ºcken, um das Spiel zu starten. In diesem Moment wird das Audio-Objekt aktiv (zur Wiedergabe verf√ºgbar). Anschlie√üend kann er den src-Parameter √§ndern, um ohne Benutzereingriff verschiedene Sounds abzuspielen. <br><br>  Um das Spiel zu testen, wurde ein ‚ÄûBot‚Äú geschrieben, der mit sich selbst spielen kann. <br>  √ñffnen Sie einfach die Registerkarte Browser, auf der die Parameter angeben, dass Sie den Test ausf√ºhren m√∂chten <br><br><pre> <code class="bash hljs">http://127.0.0.1?master=1&amp;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>=1&amp;sound=0&amp;testUsersCount=5</code> </pre> <br>  und erm√∂glichen das √ñffnen neuer Registerkarten aus JavaScript f√ºr diese Domain. <br>  Nach dem Start des Spiels werden 5 weitere Registerkarten mit Spielern ge√∂ffnet und sie beginnen untereinander zu spielen. <br><br><h3>  Interaktionsprotokoll </h3><br>  Das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">WebSocket-</a> Protokoll wurde ausgew√§hlt, da ein st√§ndiger bidirektionaler Datenaustausch zwischen Backend und Frontend erforderlich ist und beide Sprachen unterst√ºtzt werden. <br><br><h3>  Spielereignisse </h3><br>  Das ganze Spiel ist in Ereignisse unterteilt: <br><br><div class="spoiler">  <b class="spoiler_title">Ereignisse</b> <div class="spoiler_text"><ul><li>  <b>Spiel</b> <br><ul><li>  erstellen </li><li>  beitreten </li><li>  starten </li><li>  vorbei </li><li>  wieder verbinden </li></ul><br></li><li>  <b>Tag</b> <br><ul><li>  starten </li></ul><br></li><li>  <b>Nacht</b> <br><ul><li>  starten </li></ul><br></li><li>  <b>B√ºrgergru√ü</b> <br><ul><li>  starten </li><li>  Rolle </li><li>  Ende </li></ul><br></li><li>  <b>Mafia-Gru√ü</b> <br><ul><li>  starten </li><li>  Spieler </li><li>  Ende </li></ul><br></li><li>  <b>Gericht</b> <br><ul><li>  starten </li><li>  Spieler </li><li>  Ende </li></ul><br></li><li>  <b>Mafia</b> <br><ul><li>  starten </li><li>  Spieler </li><li>  Ende </li></ul><br></li><li>  <b>Arzt</b> <br><ul><li>  starten </li><li>  Spieler </li><li>  Ende </li></ul><br></li><li>  <b>M√§dchen</b> <br><ul><li>  starten </li><li>  Spieler </li><li>  Ende </li></ul><br></li><li>  <b>Sherif</b> <br><ul><li>  starten </li><li>  Spieler </li><li>  Ende </li></ul><br></li></ul><br></div></div><br>  Ereignisse haben einen Anfang, ein Ende und einen Inhalt. <br>  Zu Beginn und am Ende des Events wird eine Benachrichtigung an alle aktiven Spieler gesendet, die best√§tigt werden muss.  Das Spiel wird erst nach Best√§tigung dieses Ereignisses durch alle aktiven Spieler fortgesetzt (z. B. erst nach dem Abspielen der Sounddatei). <br><br><h3>  Docker </h3><br>  Das ganze Spiel kann mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker ausgel√∂st werden</a> : <br>  <b>docker-compose.yml</b> <br><br><pre> <code class="hljs powershell">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: mafia<span class="hljs-literal"><span class="hljs-literal">-frontend</span></span>: image: mrsuh/mafia<span class="hljs-literal"><span class="hljs-literal">-frontend</span></span>:latest container_name: mafia_frontend ports: - <span class="hljs-number"><span class="hljs-number">9080</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> mafia<span class="hljs-literal"><span class="hljs-literal">-backend</span></span>: image: mrsuh/mafia<span class="hljs-literal"><span class="hljs-literal">-backend</span></span>:latest container_name: mafia_backend ports: - <span class="hljs-number"><span class="hljs-number">8000</span></span>:<span class="hljs-number"><span class="hljs-number">8000</span></span></code> </pre><br>  Es reicht aus, Docker zu installieren (falls Sie dies noch nicht getan haben), den Text <b>docker-compose.yml zu kopieren</b> und den folgenden Befehl auszuf√ºhren: <br><br><pre> <code class="bash hljs">docker-compose up</code> </pre> <br>  Danach k√∂nnen Sie die Registerkarte Spiel im Browser √∂ffnen: <br><br><pre> <code class="bash hljs">http://127.0.0.1:9080</code> </pre> <br><h3>  Fazit </h3><br>  Hier k√∂nnen Sie sehen, wie sich das Ergebnis herausstellte (Wiedergabegeschwindigkeit um das 1,5-fache erh√∂ht). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/u4B-5DpXbwA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Nach fast einem Monat Entwicklungszeit in meiner Freizeit habe ich ein ziemlich stabiles Spiel bekommen, das Sie mit Freunden spielen k√∂nnen.  Das Spiel h√§lt dem erneuten Laden von Seiten oder vor√ºbergehenden Netzwerkausf√§llen stand.  Die Sprachausgabe von Ereignissen auf Ger√§ten funktioniert, allerdings ohne Zeitsynchronisation.  Eine Weiterentwicklung des Spiels ist nicht geplant. <br><br>  PS: Danke an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lera</a> f√ºr die Sprachausgabe des Spiels. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de423821/">https://habr.com/ru/post/de423821/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de423809/index.html">Reduzieren Sie AWS-Kosten mit Kubernetes Ingress mit Classic ELB Balancer</a></li>
<li><a href="../de423811/index.html">Julia. Bekanntschaft</a></li>
<li><a href="../de423815/index.html">Ganz besonderes Ereignis: Wie wir Apples Pr√§sentation gesehen haben und was wir dar√ºber denken</a></li>
<li><a href="../de423817/index.html">Musik und Text: Wie k√∂nnen sie in Beziehung gesetzt werden?</a></li>
<li><a href="../de423819/index.html">Es scheint, dass der Ger√§tespeicher endlich wirklich f√ºr alle genug geworden ist</a></li>
<li><a href="../de423823/index.html">Importsubstitution, Stimme weint in der W√ºste</a></li>
<li><a href="../de423825/index.html">Alle Ger√§te in einer Anwendung IoT World mit Uline</a></li>
<li><a href="../de423827/index.html">So f√ºhren Sie das perfekte Webinar durch</a></li>
<li><a href="../de423829/index.html">Ein kurzer Hinweis zu PVS Studio in CI (und was fehlt)</a></li>
<li><a href="../de423831/index.html">Druckerreparatur vom IBM 1401 60s Mainframe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>