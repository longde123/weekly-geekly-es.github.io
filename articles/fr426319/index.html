<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí≤ üõ¨ üîÜ Serveur de test pour l'√©quipe de d√©veloppement üöì üè• üçí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Dans cet article, je souhaite partager l'exp√©rience du d√©ploiement d'un serveur de test pour l'√©quipe de d√©veloppement. Bri√®vement l'es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur de test pour l'√©quipe de d√©veloppement</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426319/">  Bonjour, Habr!  Dans cet article, je souhaite partager l'exp√©rience du d√©ploiement d'un serveur de test pour l'√©quipe de d√©veloppement.  Bri√®vement l'essence du probl√®me - il y a une √©quipe de d√©veloppement et plusieurs projets en php.  Alors que nous √©tions peu nombreux et que le projet en √©tait essentiellement un, nous avons utilis√© 1 serveur de test et pour montrer la t√¢che au client, le d√©veloppeur a ¬´r√©parti¬ª le serveur pendant un certain temps.  S'il n'y avait pas de ¬´fen√™tres¬ª √† temps, alors nous devions attendre.  Au fil du temps, l'√©quipe et la complexit√© des t√¢ches ont augment√©, respectivement, le temps de v√©rification et l'activit√© du serveur de test ont augment√©, ce qui a eu une incidence n√©gative sur le d√©lai d'ex√©cution et le bonus.  Par cons√©quent, j'ai d√ª chercher une solution et c'est sous la coupe. <br><a name="habracut"></a><br><h3>  Introduction </h3><br>  Quel √©tait: <br><br><ol><li>  Un serveur de test </li><li>  Gitlab et redmine sur un autre serveur </li><li>  D√©sir de r√©gler un probl√®me </li></ol><br>  Tous les serveurs sont dans notre r√©seau local, le serveur de test est inaccessible de l'ext√©rieur. <br><br>  Ce qui √©tait requis: <br><br><ol><li>  Possibilit√© de tester plusieurs projets / branches en m√™me temps </li><li>  Le d√©veloppeur peut aller sur le serveur, le configurer et ne rien casser aux autres </li><li>  Tout doit √™tre aussi pratique que possible et effectu√© sur 1 bouton, de pr√©f√©rence √† partir de gitlab (CI / CD). </li></ol><br><h3>  Options de d√©cision </h3><br><h4>  1. Un serveur, plusieurs h√¥tes </h4><br>  L'option la plus simple.  Nous utilisons le m√™me serveur de test, seul le d√©veloppeur doit cr√©er un h√¥te pour chaque branche / projet et l'ajouter √† la configuration nginx / apache2. <br><br>  Avantages: <br><br><ol><li>  Rapidement et tout le monde comprend </li><li>  Peut automatiser </li></ol><br>  Inconv√©nients: <br><br><ol><li>  La clause 2 des exigences n'est pas satisfaite - le d√©veloppeur peut commencer √† mettre √† jour la base de donn√©es et, dans certaines circonstances, tout mettre (Salut Andrey!) </li><li>  Automatisation assez complexe avec un tas de fichiers de configuration </li></ol><br><h4>  2. √Ä chaque d√©veloppeur sur le serveur! </h4><br>  Attribuer √† chaque serveur et le d√©veloppeur est responsable de son √©conomie. <br><br>  Avantages: <br><br><ol><li>  Le d√©veloppeur peut personnaliser enti√®rement le serveur pour votre projet </li></ol><br>  Inconv√©nients: <br><br><ol><li>  La clause 2 des exigences n'est pas remplie </li><li>  Cher et les ressources peuvent rester inactives pendant que le d√©veloppement est en cours, pas de test </li><li>  L'automatisation est encore plus compliqu√©e qu'au point 1 en raison de serveurs diff√©rents </li></ol><br><h4>  3. Conteneurisation - docker, kubernetes </h4><br>  Cette technologie p√©n√®tre de plus en plus nos vies.  √Ä la maison, j'utilise depuis longtemps Docker pour mes projets. <br><blockquote>  Docker - logiciel pour automatiser le d√©ploiement et la gestion des applications dans un environnement de virtualisation au niveau du syst√®me d'exploitation.  Vous permet de "compresser" l'application avec tous ses environnements et d√©pendances dans un conteneur qui peut √™tre port√© sur n'importe quel syst√®me Linux avec prise en charge de cgroups dans le noyau, et fournit √©galement un environnement de gestion de conteneur. </blockquote>  Avantages: <br><br><ol><li>  Un serveur est utilis√© </li><li>  Toutes les exigences sont remplies. </li></ol><br>  Inconv√©nients: <br><br><ol><li>  Les images et les conteneurs prennent parfois beaucoup de place, il faut nettoyer les couronnes d√©j√† d√©pass√©es pour lib√©rer de l'espace. </li></ol><br><h3>  Impl√©mentation de Docker </h3><br>  Lors de l'utilisation de gitlab, AutoDevOps, les param√®tres de kubernetes ont tr√®s souvent attir√© mon attention.  De plus, les gars barbus sur diverses rencontres disent √† quel point ils travaillent avec kubernetes.  Par cons√©quent, il a √©t√© d√©cid√© d'essayer de d√©ployer le cluster dans ses installations, le serveur a √©t√© demand√© (et vous ne pouvez pas toucher le test, les gens y testent) et cela a commenc√©! <br><br>  Depuis que j'ai de l'exp√©rience avec kubernetes 0, tout a √©t√© fait selon le manuel avec une tentative de comprendre comment fonctionnent tous ces clusters.  Apr√®s un certain temps, j'ai r√©ussi √† augmenter le cluster, mais il y a eu ensuite des probl√®mes avec les certificats, les cl√©s et en effet avec la difficult√© de d√©ploiement.  J'avais besoin d'une solution plus simple pour enseigner √† mes coll√®gues comment travailler avec cela (par exemple, je ne veux pas passer les m√™mes vacances assis sur Skype et aider √† la configuration).  Par cons√©quent, kubernetes a √©t√© laiss√© seul.  Docker lui-m√™me est rest√© et il √©tait n√©cessaire de trouver une solution pour le routage des conteneurs.  Puisqu'ils pouvaient √™tre r√©cup√©r√©s sur diff√©rents ports, le m√™me nginx pouvait √™tre utilis√© pour la redirection interne.  C'est ce qu'on appelle un serveur proxy inverse. <br><blockquote>  Un serveur proxy inverse est un type de serveur proxy qui relaie les demandes des clients d'un r√©seau externe vers un ou plusieurs serveurs logiquement situ√©s sur le r√©seau interne.  Dans le m√™me temps, il consid√®re le client comme si les ressources demand√©es se trouvaient directement sur le serveur proxy. </blockquote><h4>  Proxy inverse </h4><br>  Afin de ne pas r√©inventer la roue, j'ai commenc√© √† chercher des solutions toutes faites.  Et il a √©t√© trouv√© - c'est du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">traefik</a> . <br><br>  Tr√¶fik est un proxy inverse HTTP moderne et un √©quilibreur de charge qui simplifie le d√©ploiement des microservices.  Tr√¶fik s'int√®gre aux composants d'infrastructure existants (Docker, mode Swarm, Kubernetes, Marathon, Consul, Etcd, Rancher, Amazon ECS, ...) et est configur√© automatiquement et dynamiquement.  Pour travailler avec docker, il vous suffit de sp√©cifier son socket et c'est tout, puis Tr fik lui-m√™me trouve tous les conteneurs et les achemine vers eux (pour plus de d√©tails, voir ¬´Emballage d'applications dans docker¬ª). <br><br><div class="spoiler">  <b class="spoiler_title">Configuration du conteneur Tr√¶fik</b> <div class="spoiler_text">  Je le lance via docker-compose.yml <br><br><pre><code class="hljs delphi">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: traefik: image: traefik:latest # The official Traefik docker image command: --api --docker # Enables the web UI <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tells Tr√¶fik <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> listen <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> docker ports: - <span class="hljs-number"><span class="hljs-number">443</span></span>:<span class="hljs-number"><span class="hljs-number">443</span></span> - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> # The HTTP port - <span class="hljs-number"><span class="hljs-number">8080</span></span>:<span class="hljs-number"><span class="hljs-number">8080</span></span> # The Web UI (enabled by --api) volumes: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/docker.sock:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/docker.sock # So that Traefik can listen <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the Docker events - /opt/traefik/traefik.toml:/traefik.toml - /opt/traefik/certs/:/certs/ networks: - proxy container_name: traefik restart: always networks: proxy: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: true</code> </pre> <br></div></div><br>  Ici, nous informons le proxy que nous devons √©couter les ports 80,443 et 8080 (la face Web du proxy), monter le socket docker, le fichier de configuration et le dossier de certificat.  Pour faciliter la d√©nomination des sites de test, nous avons d√©cid√© de cr√©er une zone de domaine local * .test.  Lors de l'acc√®s √† un site sur celui-ci, l'utilisateur acc√®de √† notre serveur de test.  Par cons√©quent, les certificats du dossier traefik sont auto-sign√©s, mais il prend donc en charge Let's Encrypt. <br><br>  G√©n√©ration de certificats <br><br><pre> <code class="bash hljs">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout domain.key -out domain.crt</code> </pre> <br>  Avant de commencer, vous devez cr√©er un r√©seau proxy dans le docker (vous pouvez le nommer vous-m√™me). <br><br><pre> <code class="bash hljs">docker network create proxy</code> </pre> <br>  Ce sera le r√©seau pour connecter traefik avec des conteneurs de sites php.  Par cons√©quent, nous le sp√©cifions dans le param√®tre r√©seaux du service et dans les r√©seaux de l'ensemble du fichier en sp√©cifiant dans le param√®tre external: true. <br><br><div class="spoiler">  <b class="spoiler_title">Fichier Traefik.toml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> logLevel = "DEBUG" defaultEntryPoints = ["https","http"] #  insecureSkipVerify = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> #   [entryPoints] [entryPoints.http] address = ":80" [entryPoints.https] address = ":443" [entryPoints.https.tls] [docker] endpoint = "unix:///var/run/docker.sock" <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> = "docker.localhost" watch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> exposedbydefault = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre> <br></div></div><br>  Tout est assez simple ici - nous sp√©cifions les points d'entr√©e du trafic http et https, n'oubliez pas de mettre insecureSkipVerify = true si les certificats sont locaux.  Dans la section entryPoints.https.tls, vous ne pouvez pas sp√©cifier de certificats, alors traefik substituera son certificat. <br><br>  Vous pouvez d√©marrer le service <br><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  Si vous allez sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site.test</a> , vous obtiendrez une erreur 404, car ce domaine n'est li√© √† aucun conteneur. <br><br><h4>  Nous emballons les applications dans Docker </h4><br>  Vous devez maintenant configurer le conteneur avec l'application, √† savoir: <br><br>  1. sp√©cifier un r√©seau proxy dans les r√©seaux <br>  2. ajouter des √©tiquettes avec la configuration de traefik <br><br>  Voici la configuration de l'une des applications <br><br><div class="spoiler">  <b class="spoiler_title">applications docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: app: build: <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/docker/php #   restart: always working_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html/<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> volumes: - ./:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html #    - /home/develop/site-files/f:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html/<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/f #       links: - mailcatcher - memcached - mysql labels: - traefik.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> - traefik.frontend.rule=Host:TEST_DOMAIN,crm.TEST_DOMAIN,bonus.TEST_DOMAIN - traefik.docker.network=proxy - traefik.port=<span class="hljs-number"><span class="hljs-number">443</span></span> - traefik.protocol=https networks: - proxy - <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> mailcatcher: image: schickling/mailcatcher:latest restart: always memcached: image: memcached restart: always mysql: image: mysql:<span class="hljs-number"><span class="hljs-number">5.7</span></span> restart: always command: --max_allowed_packet=<span class="hljs-number"><span class="hljs-number">902505856</span></span> --sql-mode=<span class="hljs-string"><span class="hljs-string">""</span></span> environment: MYSQL_ROOT_PASSWORD: <span class="hljs-number"><span class="hljs-number">12345</span></span> MYSQL_DATABASE: site volumes: - ./<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/cache/mysql-db:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/mysql #      phpmyadmin: image: phpmyadmin/phpmyadmin restart: always links: - mysql environment: MYSQL_USERNAME: root MYSQL_ROOT_PASSWORD: <span class="hljs-number"><span class="hljs-number">12345</span></span> PMA_ARBITRARY: <span class="hljs-number"><span class="hljs-number">1</span></span> PMA_HOST: mysql_1 labels: - traefik.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> - traefik.frontend.rule=Host:pma.TEST_DOMAIN - traefik.docker.network=proxy - traefik.port=<span class="hljs-number"><span class="hljs-number">80</span></span> - traefik.<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.protocol=http networks: - proxy - <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> networks: proxy: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br></div></div><br>  Dans le service d'application, dans la section r√©seau, vous devez sp√©cifier le proxy et le d√©faut, cela signifie qu'il sera disponible sur deux r√©seaux, comme le montre la configuration, je ne transf√®re pas les ports √† l'ext√©rieur, tout se passe sur le r√©seau. <br><br>  Ensuite, configurez les √©tiquettes <br><br><pre> <code class="hljs 1c"> - traefik.enabled=true <span class="hljs-meta"><span class="hljs-meta"># traefik </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   - traefik.frontend.rule=Host:TEST_DOMAIN,crm.TEST_DOMAIN,bonus.TEST_DOMAIN #  </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  traefik     - traefik.docker.network=proxy # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  - traefik.port=443 #, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">    ssl   80   http - traefik.protocol=https #  #  phpmyadmin   http </span></span></code> </pre><br>  Dans la section des r√©seaux g√©n√©raux, sp√©cifiez external: true <br><br>  La constante TEST_DOMAIN doit √™tre remplac√©e par un domaine, par exemple, site.test <br><br>  Lancez l'application <br><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  Maintenant, si vous acc√©dez aux domaines site.test, crm.site.test, bonus.site.test, vous pouvez voir le site de travail.  Et sur le domaine pma.site.test, il y aura phpmyadmin pour un travail pratique avec la base de donn√©es. <br><br><h4>  Configurer GitLab </h4><br>  Nous cr√©ons un gestionnaire de t√¢ches, pour cela nous ex√©cutons <br><br><pre> <code class="bash hljs">gitlab-runner register</code> </pre> <br>  Nous sp√©cifions l'url de gitlab, le jeton et √† travers lesquels la t√¢che sera ex√©cut√©e (ex√©cuteurs).  Puisque mon test et gitlab sont sur des serveurs diff√©rents, je s√©lectionne ssh executor.  Vous devrez sp√©cifier l'adresse du serveur et le login / mot de passe pour la connexion via ssh. <br><br>  Runner peut √™tre attach√© √† un ou plusieurs projets.  Puisque ma logique de travail est la m√™me partout, un runner partag√© a √©t√© cr√©√© (commun √† tous les projets). <br>  Et la touche finale est de cr√©er un fichier de configuration CI <br><br><div class="spoiler">  <b class="spoiler_title">.gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">stages: - build - clear #  develop build_develop: stage: build #   build tags: #     - ssh-develop environment: # ,       -   name: review/<span class="hljs-string"><span class="hljs-string">$C</span></span>I_BUILD_REF_NAME #  url: https://site<span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID.test <span class="hljs-symbol"><span class="hljs-symbol">#url</span></span>     on_stop: clear when: manual script: - cd ../ &amp;&amp; cp -r <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PROJECT_NAME <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID &amp;&amp; cd <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID #     - cp -r /home/develop/site-files/.ssh data/docker/php/.ssh #  ssh - sed -i -e <span class="hljs-comment"><span class="hljs-comment">"s/TEST_DOMAIN/site$CI_PIPELINE_ID.test/g"</span></span> docker-compose.yml #   - docker-compose down #   - docker-compose up -d --build #  - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar install --prefer-dist \<span class="hljs-comment"><span class="hljs-comment">""</span></span> #   - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar first-install <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID\<span class="hljs-comment"><span class="hljs-comment">""</span></span> #     #  production build_prod: stage: build tags: - ssh-develop environment: name: review/<span class="hljs-string"><span class="hljs-string">$C</span></span>I_BUILD_REF_NAME url: https://site<span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID.test on_stop: clear when: manual script: - cd ../ &amp;&amp; cp -r <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PROJECT_NAME <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID &amp;&amp; cd <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID - cp -r /home/develop/site-files/.ssh data/docker/php/.ssh #  ssh - docker-compose down - docker-compose up -d --build - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar install --prefer-dist --no-dev\<span class="hljs-comment"><span class="hljs-comment">""</span></span> - script -q -c <span class="hljs-comment"><span class="hljs-comment">"docker exec -it ${CI_PIPELINE_ID}_app_1 bash -c \"</span></span>cd ../ &amp;&amp; php composer.phar first-install <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID\<span class="hljs-comment"><span class="hljs-comment">""</span></span> clear: stage: clear tags: - ssh-develop environment: name: review/<span class="hljs-string"><span class="hljs-string">$C</span></span>I_BUILD_REF_NAME action: stop script: - cd ../ &amp;&amp; cd <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID &amp;&amp; docker-compose down &amp;&amp; cd ../ &amp;&amp; echo password | sudo -<span class="hljs-type"><span class="hljs-type">S</span></span> rm -rf <span class="hljs-string"><span class="hljs-string">$C</span></span>I_PIPELINE_ID #       when: manual</code> </pre><br></div></div><br>  Dans cette configuration, 2 √©tapes sont d√©crites - construire et effacer.  La phase de construction a 2 options - build_develop et build_prod <br><br><img src="https://habrastorage.org/webt/yz/ut/dy/yzutdyyknwjgwbcg4-kj2ssv-f8.png"><br><br>  Gitlab construit un organigramme de processus compr√©hensible.  Dans mon exemple, tous les processus d√©marrent manuellement (quand: param√®tre manuel).  Cela est fait pour que le d√©veloppeur, apr√®s avoir d√©ploy√© le site de test, puisse ins√©rer ses modifications dans le conteneur sans reconstruire le conteneur entier.  Une autre raison est le nom de domaine - site $ CI_PIPELINE_ID.test, o√π CI_PIPELINE_ID est le num√©ro du processus qui a d√©marr√© l'assemblage.  Autrement dit, ils ont soumis le site avec le domaine site123.test pour v√©rification, et afin d'apporter des modifications √† chaud, les modifications sont imm√©diatement vers√©es dans le conteneur par le d√©veloppeur. <br><br>  Une petite fonctionnalit√© de ssh executor.  Une fois connect√© au serveur, un dossier du formulaire est cr√©√©. <br><br><pre> <code class="bash hljs">/home//builds/_runner/0/_/_</code> </pre> <br>  Par cons√©quent, une ligne a √©t√© ajout√©e <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ &amp;&amp; cp -r <span class="hljs-variable"><span class="hljs-variable">$CI_PROJECT_NAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$CI_PIPELINE_ID</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$CI_PIPELINE_ID</span></span></code> </pre> <br>  Dans celui-ci, nous montons dans le dossier ci-dessus et copions le projet dans le dossier avec le num√©ro de processus.  Vous pouvez donc d√©ployer plusieurs branches d'un m√™me projet.  Mais dans les param√®tres du gestionnaire, vous devez v√©rifier Verrouiller sur les projets en cours, afin que le gestionnaire n'essaye pas de d√©velopper plusieurs branches en m√™me temps. <br><br>  L'√©tape d'effacement arr√™te les conteneurs et supprime le dossier, vous pouvez avoir besoin des privil√®ges root, nous utilisons donc le mot de passe echo |  sudo -S rm o√π mot de passe est votre mot de passe. <br><br><h4>  Collecte des ordures </h4><br>  De temps en temps, vous devez supprimer les conteneurs inutilis√©s afin de ne pas prendre de place, pour cela un script avec un tel contenu se bloque dans la couronne <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   : docker ps --filter status=dead --filter status=exited -aq | xargs -r docker rm -v #   : yes | docker container prune #    : yes | docker image prune #    : yes | docker volume prune</span></span></code> </pre> <br>  effectu√© une fois par jour. <br><br><h3>  Conclusion </h3><br>  Cette solution nous a permis d'optimiser consid√©rablement les tests et la sortie de nouvelles fonctionnalit√©s.  Pr√™t √† r√©pondre aux questions, la critique constructive est accept√©e. <br><br><h3>  Bonus </h3><br>  Afin de ne pas collecter √† chaque fois des images du Dockerfile, vous pouvez les stocker dans le registre Docker local. <br><br><div class="spoiler">  <b class="spoiler_title">Fichier docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs powershell">registry: restart: always image: registry:<span class="hljs-number"><span class="hljs-number">2</span></span> ports: - <span class="hljs-number"><span class="hljs-number">5000</span></span>:<span class="hljs-number"><span class="hljs-number">5000</span></span> volumes: - /opt/docker<span class="hljs-literal"><span class="hljs-literal">-registry</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:/var/lib/registry <span class="hljs-comment"><span class="hljs-comment">#    </span></span></code> </pre><br></div></div><br>  Cette option n'utilise pas d'authentification, ce n'est pas un moyen s√ªr (!!!), mais il convient au stockage d'images non critiques. <br><br>  Vous pouvez configurer gitlab pour afficher <br><br><pre> <code class="bash hljs"> gitlab_rails[<span class="hljs-string"><span class="hljs-string">'registry_enabled'</span></span>] = <span class="hljs-literal"><span class="hljs-literal">true</span></span> gitlab_rails[<span class="hljs-string"><span class="hljs-string">'registry_host'</span></span>] = <span class="hljs-string"><span class="hljs-string">"registry.test"</span></span> gitlab_rails[<span class="hljs-string"><span class="hljs-string">'registry_port'</span></span>] = <span class="hljs-string"><span class="hljs-string">"5000"</span></span></code> </pre><br>  Apr√®s cela, une liste d'images appara√Æt dans gitlab <br><br><img src="https://habrastorage.org/webt/lu/hn/8i/luhn8ilow44doqm5btrtafgv-hq.png"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426319/">https://habr.com/ru/post/fr426319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426305/index.html">Travaillez avec les statuts des personnages. Exp√©riences d'unit√©</a></li>
<li><a href="../fr426311/index.html">Conf√©rence BLACK HAT USA. Botnet √† partir d'un million de navigateurs. 2e partie</a></li>
<li><a href="../fr426313/index.html">Nouveau Microsoft Learn</a></li>
<li><a href="../fr426315/index.html">Comment se faire des amis python avec Internet Invisible? Les bases du d√©veloppement d'applications I2P en Python et asyncio</a></li>
<li><a href="../fr426317/index.html">1155 vs 2011. Certaines personnes √¢g√©es se battent</a></li>
<li><a href="../fr426323/index.html">Une tentative de fabriquer un bo√Ætier de robot avec un budget limit√©. Tapis de verre et √©poxy</a></li>
<li><a href="../fr426325/index.html">Cours MIT "S√©curit√© des syst√®mes informatiques". Conf√©rence 12: S√©curit√© du r√©seau, partie 1</a></li>
<li><a href="../fr426327/index.html">Nouveaut√©s de la mise √† jour d'octobre 2018 de Windows 10</a></li>
<li><a href="../fr426331/index.html">Vuln√©rabilit√© dans PlayStation 4 - le jeu de caract√®res dans le message pour l'utilisateur transforme √† distance la console en presque une "brique"</a></li>
<li><a href="../fr426333/index.html">Microsoft a publi√© le code MS-DOS 1.25 et 2.0 sous la licence MIT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>