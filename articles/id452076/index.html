<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèº üî´ ü§£ Menghancurkan Browser UC üë∏üèø üòî üë©üèª‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendahuluan 
 Pada akhir Maret kami melaporkan potensi tersembunyi untuk mengunduh dan menjalankan kode yang tidak diverifikasi di UC Browser. Hari in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menghancurkan Browser UC</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/drweb/blog/452076/"><img src="https://habrastorage.org/webt/ke/e0/rd/kee0rdupth-kalljz9gfxpjndnk.jpeg"><br><br><h3>  Pendahuluan </h3><br>  Pada akhir Maret kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">melaporkan</a> potensi tersembunyi untuk mengunduh dan menjalankan kode yang tidak diverifikasi di UC Browser.  Hari ini kita akan memeriksa secara terperinci bagaimana itu terjadi dan bagaimana peretas dapat menggunakannya. <br><br>  Beberapa waktu yang lalu, UC Browser dipromosikan dan didistribusikan dengan cukup agresif.  Itu diinstal pada perangkat oleh malware, didistribusikan melalui situs web dengan kedok file video (mis., Pengguna berpikir mereka mengunduh pornografi atau sesuatu, tetapi sebaliknya mendapatkan file APK dengan browser ini), diiklankan menggunakan spanduk mengkhawatirkan tentang browser pengguna yang ketinggalan zaman atau rentan.  Grup UC Browser VK resmi memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">topik di</a> mana pengguna dapat mengeluh tentang iklan palsu dan banyak pengguna memberikan contoh.  Pada tahun 2016, bahkan ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">iklan</a> di Rusia (ya, iklan browser yang memblokir iklan). <br><br>  Saat kami menulis artikel ini, UC Browser diinstal 500.000.000 kali dari Google Play.  Ini mengesankan karena hanya Google Chrome yang berhasil melampaui itu.  Di antara ulasan tersebut, Anda dapat melihat banyak keluhan pengguna tentang iklan dan dialihkan ke aplikasi lain di Google Play.  Ini adalah alasan untuk penelitian kami: kami ingin melihat apakah UC Browser melakukan sesuatu yang salah.  Dan itu!  Aplikasi ini dapat mengunduh dan menjalankan kode yang dapat dieksekusi, yang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">melanggar kebijakan Google Play untuk penerbitan aplikasi</a> .  Dan UC Browser tidak hanya mengunduh kode yang dapat dieksekusi;  ini tidak aman, yang dapat digunakan untuk serangan MitM.  Mari kita lihat apakah kita bisa menggunakannya dengan cara ini. <br><a name="habracut"></a><br>  Segala sesuatu yang mengikuti berlaku untuk versi UC Browser yang didistribusikan melalui Google Play pada saat penelitian kami: <br><br><pre><code class="plaintext hljs">package: com.UCMobile.intl versionName: 12.10.8.1172 versionCode: 10598 sha1 APK-file: f5edb2243413c777172f6362876041eb0c3a928c</code> </pre> <br><h3>  Vektor serangan </h3><br>  Manifes UC Browser berisi layanan dengan nama <i>com.uc.deployment.UpgradeDeployService</i> . <br><br><pre> <code class="plaintext hljs"> &lt;service android:exported="false" android:name="com.uc.deployment.UpgradeDeployService" android:process=":deploy" /&gt;</code> </pre><br>  Ketika layanan ini diluncurkan, browser membuat permintaan POST ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a> yang dapat dilihat dalam lalu lintas untuk beberapa waktu setelah peluncuran.  Sebagai tanggapan, browser dapat menerima perintah untuk mengunduh pembaruan apa pun atau modul baru.  Selama analisis kami, kami tidak pernah menerima perintah seperti itu dari server, tetapi kami perhatikan bahwa ketika mencoba membuka file PDF di browser, itu mengulangi permintaan ke alamat di atas, kemudian mengunduh perpustakaan asli.  Untuk mensimulasikan serangan, kami memutuskan untuk menggunakan fitur UC Browser ini - kemampuan untuk membuka file PDF menggunakan pustaka asli - tidak ada dalam file APK, tetapi dapat diunduh dari Internet.  Secara teknis, UC Browser dapat mengunduh sesuatu tanpa izin pengguna ketika diberikan respons yang sesuai dengan permintaan yang dikirim saat startup.  Tetapi untuk ini kita perlu mempelajari protokol interaksi dengan server secara lebih rinci, jadi kami pikir lebih mudah untuk hanya menghubungkan dan mengedit respons dan kemudian mengganti pustaka yang diperlukan untuk membuka file PDF dengan sesuatu yang berbeda. <br><br>  Jadi, ketika pengguna ingin membuka file PDF langsung di browser, lalu lintas dapat berisi permintaan berikut: <br><br><img src="https://habrastorage.org/webt/j0/i1/c1/j0i1c1n_nwf_gnauzbudnqor5oi.png"><br><br>  Pertama, ada permintaan POST ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a> , kemudian pustaka terkompresi untuk melihat file PDF dan dokumen kantor diunduh.  Secara logis, kita dapat mengasumsikan bahwa permintaan pertama mengirim informasi tentang sistem (setidaknya arsitektur, karena server perlu memilih perpustakaan yang sesuai), dan server merespons dengan beberapa informasi tentang perpustakaan yang perlu diunduh, seperti alamatnya dan mungkin sesuatu yang lain.  Masalahnya adalah bahwa permintaan ini dienkripsi. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Minta fragmen <br><br></td><td>  Fragmen respons <br><br></td></tr><tr><td><img src="https://habrastorage.org/webt/go/tj/tz/gotjtzkpg2owfmk8jrnznox_vdg.jpeg"><br><br></td><td><img src="https://habrastorage.org/webt/g5/7k/iv/g57kivkwrysmcqvptmhclqzzipq.png"><br><br></td></tr></tbody></table></div><br>  Perpustakaan dikompresi dalam file ZIP dan tidak dienkripsi. <br><br><img src="https://habrastorage.org/webt/6r/lt/ns/6rltnsrtyd-_5ekwis68qn-vydc.png"><br><br><h3>  Mencari kode dekripsi lalu lintas </h3><br>  Mari kita coba dan dekripsi respons server.  Lihatlah kode <i>kelas com.uc.deployment.UpgradeDeployService</i> : dari <i>metode onStartCommand</i> , kami menavigasi ke <i>com.uc.deployment.bx</i> , dan kemudian ke <i>com.uc.browser.core.dcfe</i> : <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg9)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4_5; String v3_1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v3; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg9 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v3 = v1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3_1 = arg9.iGX.ipR; StringBuilder v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]product:"</span></span>); v4.append(arg9.iGX.ipR); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]version:"</span></span>); v4.append(arg9.iGX.iEn); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]upgrade_type:"</span></span>); v4.append(arg9.iGX.mMode); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]force_flag:"</span></span>); v4.append(arg9.iGX.iEo); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_mode:"</span></span>); v4.append(arg9.iGX.iDQ); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_type:"</span></span>); v4.append(arg9.iGX.iEr); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_state:"</span></span>); v4.append(arg9.iGX.iEp); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_file:"</span></span>); v4.append(arg9.iGX.iEq); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apk_md5:"</span></span>); v4.append(arg9.iGX.iEl); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_type:"</span></span>); v4.append(arg9.mDownloadType); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_group:"</span></span>); v4.append(arg9.mDownloadGroup); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_path:"</span></span>); v4.append(arg9.iGH); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_child_version:"</span></span>); v4.append(arg9.iGX.iEx); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_series:"</span></span>); v4.append(arg9.iGX.iEw); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_arch:"</span></span>); v4.append(arg9.iGX.iEt); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp3:"</span></span>); v4.append(arg9.iGX.iEv); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp:"</span></span>); v4.append(arg9.iGX.iEu); ArrayList v3_2 = arg9.iGX.iEz; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3_2 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; v3_2.size() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Iterator v3_3 = v3_2.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v3_3.hasNext()) { Object v4_1 = v3_3.next(); StringBuilder v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_name:"</span></span>); v5.append(((au)v4_1).getName()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_name:"</span></span>); v5.append(((au)v4_1).aDA()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_code:"</span></span>); v5.append(((au)v4_1).gBl); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_req_type:"</span></span>); v5.append(((au)v4_1).gBq); } } j v3_4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> j(); mb(v3_4); h v4_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> h(); mb(v4_2); ay v5_1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ay(); v3_4.hS(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.setImsi(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.hV(<span class="hljs-string"><span class="hljs-string">""</span></span>); v5_1.bPQ = v3_4; v5_1.bPP = v4_2; v5_1.yr(arg9.iGX.ipR); v5_1.gBF = arg9.iGX.mMode; v5_1.gBI = arg9.iGX.iEz; v3_2 = v5_1.gAr; c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"os_ver"</span></span>, c.getRomInfo())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"processor_arch"</span></span>, com.uc.baacgetCpuArch())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_arch"</span></span>, com.uc.baacPb())); String v4_3 = com.uc.baacPd(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_vfp"</span></span>, v4_3)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"net_type"</span></span>, String.valueOf(com.uc.base.system.a.Jo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"fromhost"</span></span>, arg9.iGX.iEm)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_ver"</span></span>, arg9.iGX.iEn)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"target_lang"</span></span>, arg9.iGX.iEs)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_cpu_arch"</span></span>, arg9.iGX.iEt)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp"</span></span>, arg9.iGX.iEu)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp3"</span></span>, arg9.iGX.iEv)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_child_ver"</span></span>, arg9.iGX.iEx)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ver_series"</span></span>, arg9.iGX.iEw)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"child_ver"</span></span>, r.aVw())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_md5"</span></span>, arg9.iGX.iEl)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_signature"</span></span>, SystemHelper.getUCMSignature())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"upgrade_log"</span></span>, i.bjt())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_install"</span></span>, String.valueOf(arg9.iGX.iDQ))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_state"</span></span>, String.valueOf(arg9.iGX.iEp))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_file"</span></span>, arg9.iGX.iEq)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_type"</span></span>, String.valueOf(arg9.iGX.iEr))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_archit"</span></span>, com.uc.baacPc())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_set"</span></span>, SystemHelper.getCpuInstruction())); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> v4_4 = v4_3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || !v4_3.contains(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>, String.valueOf(v4_4))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_cores"</span></span>, String.valueOf(com.uc.baacJl()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ram_1"</span></span>, String.valueOf(com.uc.baahPo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"totalram"</span></span>, String.valueOf(com.uc.baahOL()))); c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"rom_1"</span></span>, c.getRomInfo())); v4_5 = e.getScreenWidth(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6 = e.getScreenHeight(); StringBuilder v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); v7.append(v4_5); v7.append(<span class="hljs-string"><span class="hljs-string">"*"</span></span>); v7.append(v6); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ss"</span></span>, v7.toString())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"api_level"</span></span>, String.valueOf(Build$VERSION.SDK_INT))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"uc_apk_list"</span></span>, SystemHelper.getUCMobileApks())); Iterator v4_6 = arg9.iGX.iEA.entrySet().iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v4_6.hasNext()) { Object v6_1 = v4_6.next(); v3_2.add(g.fs(((Map$Entry)v6_1).getKey(), ((Map$Entry)v6_1).getValue())); } v3 = v5_1.toByteArray(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v4_5 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGw ? <span class="hljs-number"><span class="hljs-number">0x1F</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = gi(v4_5, v3); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v3.length + <span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v6_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">16</span></span>]; Arrays.fill(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>); v6_2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5F</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)v4_5); v6_2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = -<span class="hljs-number"><span class="hljs-number">50</span></span>; System.arraycopy(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); System.arraycopy(v3, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">16</span></span>, v3.length); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(TextUtils.isEmpty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_url"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } StringBuilder v0 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v0.append(arg9.iGX.ipR); v0.append(<span class="hljs-string"><span class="hljs-string">"]url:"</span></span>); v0.append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl); com.uc.browser.core.dci v0_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI; v3_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl; com.uc.base.net.e v0_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.base.net.e(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.browser.core.dci$a(v0_1, arg9)); v3_1 = v3_1.contains(<span class="hljs-string"><span class="hljs-string">"?"</span></span>) ? v3_1 + <span class="hljs-string"><span class="hljs-string">"&amp;dataver=pb"</span></span> : v3_1 + <span class="hljs-string"><span class="hljs-string">"?dataver=pb"</span></span>; n v3_5 = v0_2.uc(v3_1); mb(v3_5, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); v3_5.setMethod(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>); v3_5.setBodyProvider(v1); v0_2.b(v3_5); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_null"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.b(arg9); }</code> </pre> <br>  Kita bisa melihat di sinilah permintaan POST dibuat.  Lihat array 16-byte yang berisi: 0x5F, 0, 0x1F, -50 (= 0xCE).  Nilai-nilainya sama seperti dalam permintaan di atas. <br><br>  Kelas yang sama berisi kelas bersarang dengan metode lain yang menarik: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg10, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] arg11)</span></span></span><span class="hljs-function"> </span></span>{ f v0 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGQ; StringBuilder v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v1.append(arg10.iGX.ipR); v1.append(<span class="hljs-string"><span class="hljs-string">"]:UpgradeSuccess"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1_1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11.length &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x60</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">3</span></span>] != <span class="hljs-number"><span class="hljs-number">0xFFFFFFD0</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5 = arg11[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">11</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] == <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[arg11.length - <span class="hljs-number"><span class="hljs-number">16</span></span>]; System.arraycopy(arg11, <span class="hljs-number"><span class="hljs-number">16</span></span>, v7, <span class="hljs-number"><span class="hljs-number">0</span></span>, v7.length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v7 = gj(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>], v7); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v7 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v5 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v1_1 = gP(v7); goto label_57; } v1_1 = v7; } label_57: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1_1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } q v11 = gb(arg10, v1_1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGt) { v0.d(arg10); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGo != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGo.a(<span class="hljs-number"><span class="hljs-number">0</span></span>, ((o)v11)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGs) { v0.iGY.a(((o)v11)); v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); v0.iGY.iGI.a(v11); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"no"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); } }</code> </pre> <br>  Metode ini menerima input array byte dan memeriksa apakah byte nol 0x60, atau byte ketiga 0xD0 dan jika byte kedua adalah 1, 11, atau 0x1F.  Periksa respons server: nol byte adalah 0x60, byte kedua adalah 0x1F, byte ketiga adalah 0x60.  Sepertinya yang kita butuhkan.  Dilihat oleh string ("up_decrypt", misalnya), suatu metode seharusnya dipanggil di sini untuk mendekripsi respons server.  Sekarang mari kita lihat metode gj.  Perhatikan bahwa argumen pertama adalah byte pada offset 2 (yaitu, 0x1F dalam kasus kami), dan yang kedua adalah respons server tanpa 16 byte pertama. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] j(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arg1, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arg2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">1</span></span>) { arg2 = cc(arg2, c.adu); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">11</span></span>) { arg2 = m.aF(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 != <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { arg2 = EncryptHelper.decrypt(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arg2; }</code> </pre> <br>  Jelas, itu adalah memilih algoritma dekripsi, dan byte yang dalam kasus kami sama dengan 0x1F menunjukkan satu dari tiga opsi yang mungkin. <br><br>  Mari kita kembali ke analisis kode.  Setelah beberapa lompatan, kita sampai pada metode dengan nama tanda, <i>decryptBytesByKey</i> .  Sekarang, dua byte lagi dipisahkan dari respons kami dan membentuk string.  Jelas ini adalah bagaimana kunci dipilih untuk mendekripsi pesan. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decryptBytesByKey(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v0 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length &lt; EncryptHelper.PREFIX_BYTES_SIZE) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length == EncryptHelper.PREFIX_BYTES_SIZE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] prefix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[EncryptHelper.PREFIX_BYTES_SIZE]; <span class="hljs-comment"><span class="hljs-comment">// 2  System.arraycopy(bytes, 0, prefix, 0, prefix.length); String keyId = c.ayR().d(ByteBuffer.wrap(prefix).getShort()); //   if(keyId == null) { return v0; } else { a v2 = EncryptHelper.ayL(); if(v2 == null) { return v0; } else { byte[] enrypted = new byte[bytes.length - EncryptHelper.PREFIX_BYTES_SIZE]; System.arraycopy(bytes, EncryptHelper.PREFIX_BYTES_SIZE, enrypted, 0, enrypted.length); return v2.l(keyId, enrypted); } } } } catch(SecException v7_1) { EncryptHelper.handleDecryptException(((Throwable)v7_1), v7_1.getErrorCode()); return v0; } catch(Throwable v7) { EncryptHelper.handleDecryptException(v7, 2); return v0; } } return v0; }</span></span></code> </pre> <br>  Melompat sedikit ke depan, perhatikan bahwa pada tahap ini, itu hanya pengidentifikasi kunci, bukan kunci itu sendiri.  Pemilihan kunci akan menjadi sedikit lebih rumit. <br><br>  Pada metode selanjutnya, dua parameter lagi ditambahkan ke yang sudah ada, jadi kami mendapatkan total empat.  Angka ajaib 16, pengidentifikasi kunci, data terenkripsi, dan string ditambahkan di sana untuk beberapa alasan (kosong dalam kasus kami). <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] l(String keyId, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] encrypted) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> SecException { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ayJ().staticBinarySafeDecryptNoB64(<span class="hljs-number"><span class="hljs-number">16</span></span>, keyId, encrypted, <span class="hljs-string"><span class="hljs-string">""</span></span>); }</code> </pre> <br>  Setelah serangkaian lompatan, kita melihat metode <i>staticBinarySafeDecryptNoB64</i> dari <i>com.alibaba.wireless.security.open.staticdataencrypt.IStaticDataEncryptComponent</i> interface.  Kode aplikasi utama tidak memiliki kelas yang mengimplementasikan antarmuka ini.  Kelas ini terkandung dalam file <b><i>lib / armeabi-v7a / libsgmain.so</i></b> , yang sebenarnya bukan .SO, melainkan .JAR.  Metode yang kami minati diimplementasikan sebagai berikut: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.ai; <span class="hljs-comment"><span class="hljs-comment">// ... public class a implements IStaticDataEncryptComponent { private ISecurityGuardPlugin a; // ... private byte[] a(int mode, int magicInt, int xzInt, String keyId, byte[] encrypted, String magicString) { return this.a.getRouter().doCommand(10601, new Object[]{Integer.valueOf(mode), Integer.valueOf(magicInt), Integer.valueOf(xzInt), keyId, encrypted, magicString}); } // ... private byte[] b(int magicInt, String keyId, byte[] encrypted, String magicString) { return this.a(2, magicInt, 0, keyId, encrypted, magicString); } // ... public byte[] staticBinarySafeDecryptNoB64(int magicInt, String keyId, byte[] encrypted, String magicString) throws SecException { if(keyId != null &amp;&amp; keyId.length() &gt; 0 &amp;&amp; magicInt &gt;= 0 &amp;&amp; magicInt &lt; 19 &amp;&amp; encrypted != null &amp;&amp; encrypted.length &gt; 0) { return this.b(magicInt, keyId, encrypted, magicString); } throw new SecException("", 301); } //... }</span></span></code> </pre> <br>  Di sini, daftar parameter kami dilengkapi dengan dua bilangan bulat lagi: 2 dan 0. Rupanya, 2 berarti dekripsi, seperti pada <i>metode doFinal</i> dari kelas <i>sistem javax.crypto.Cipher</i> .  Kemudian, informasi ini ditransmisikan ke Router tertentu bersama dengan nomor 10601, yang tampaknya adalah nomor perintah. <br><br>  Setelah rantai lompatan berikutnya, kami menemukan kelas yang mengimplementasikan antarmuka <i>RouterComponent</i> dan metode <i>doCommand</i> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.mainplugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.alibaba.wireless.security.framework.IRouterComponent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.taobao.wireless.security.adapter.JNICLibrary; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRouterComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg2, Object[] arg3)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JNICLibrary.doCommandNative(arg2, arg3); } }</code> </pre> <br>  Ada juga kelas <i>Perpustakaan JNIC</i> , di mana metode <i>doCommandNative</i> asli dinyatakan: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.taobao.wireless.security.adapter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JNICLibrary</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg0, Object[] arg1)</span></span></span></span>; }</code> </pre> <br>  Jadi, kita perlu menemukan metode <i>doCommandNative</i> dalam kode asli.  Di situlah kesenangan dimulai. <br><br><h3>  Kebingungan kode mesin </h3><br>  Ada satu pustaka asli di file <i>libsgmain.so</i> (yang sebenarnya adalah file .JAR dan, seperti yang kami katakan di atas, mengimplementasikan beberapa antarmuka terkait enkripsi): <i><b>libsgmainso-6.4.36.so</b></i> .  Kami memuatnya di IDA dan mendapatkan banyak dialog dengan pesan kesalahan.  Masalahnya adalah bahwa tabel header bagian tidak valid.  Ini dilakukan dengan sengaja untuk mempersulit analisis. <br><br><img src="https://habrastorage.org/webt/_k/bz/5c/_kbz5cbedw6g1jnsj047rtqudli.jpeg"><br><br>  Tapi bagaimanapun juga kita tidak benar-benar membutuhkannya.  Tabel tajuk program sudah cukup untuk memuat file ELF dengan benar dan menganalisisnya.  Jadi kami cukup menghapus tabel header bagian, membatalkan bidang yang sesuai di header. <br><br><img src="https://habrastorage.org/webt/2y/xh/vk/2yxhvksp30f016gfyhrlfh0pklc.jpeg"><br><br>  Kemudian kita buka file di IDA lagi. <br><br>  Kami memiliki dua cara untuk memberi tahu mesin virtual Java persis di mana pustaka asli berisi implementasi metode yang dinyatakan sebagai asli dalam kode Java.  Yang pertama adalah untuk memberikan nama seperti ini: <i>Java_package_name_ClassName_methodName</i> .  Yang kedua adalah mendaftarkannya saat memuat perpustakaan (dalam fungsi JNI_OnLoad) dengan memanggil fungsi RegisterNatives.  Dalam kasus kami, jika Anda menggunakan metode pertama, namanya harus seperti ini: <i>Java_com_taobao_wireless_security_adapter_JNICLibrary_doCommandNative</i> .  Daftar fungsi yang diekspor tidak mengandung nama ini, yang berarti kita perlu mencari RegisterNatives.  Jadi, kita pergi ke fungsi JNI_OnLoad dan melihat yang berikut: <br><br><img src="https://habrastorage.org/webt/m6/dp/iw/m6dpiwaonfuyri-jg8thppcfgqe.jpeg"><br><br>  Apa yang terjadi di sini  Sekilas, awal dan akhir fungsi adalah tipikal arsitektur ARM.  Instruksi pertama mendorong isi register yang akan digunakan fungsi ke stack (dalam hal ini, R0, R1, dan R2), serta isi register LR dengan alamat pengembalian fungsi.  Instruksi terakhir mengembalikan register yang disimpan dan menempatkan alamat pengirim ke register PC, sehingga kembali dari fungsinya.  Tetapi jika kita melihat lebih dekat, kita mungkin memperhatikan bahwa instruksi kedua dari belakang mengubah alamat pengirim, disimpan di tumpukan.  Mari menghitung apa yang akan terjadi ketika kode dieksekusi.  Alamat 0xB130 memuat dalam R1, memiliki 5 dikurangi darinya, kemudian dipindahkan ke R0 dan menerima tambahan 0x10.  Pada akhirnya, itu sama dengan 0xB13B.  Dengan demikian, IDA berpikir bahwa instruksi terakhir melakukan pengembalian fungsi normal, sementara pada kenyataannya, ia melakukan transfer ke alamat terhitung 0xB13B. <br><br>  Sekarang mari kita ingatkan Anda bahwa prosesor ARM memiliki dua mode dan dua set instruksi - ARM dan Thumb.  Bit orde rendah dari alamat menentukan instruksi yang ditetapkan oleh prosesor yang akan digunakan. Yaitu, alamatnya sebenarnya 0xB13A, sedangkan nilai dalam bit orde rendah menunjukkan mode Jempol. <br>  "Adaptor" yang serupa dan beberapa sampah semantik ditambahkan ke awal setiap fungsi di perpustakaan ini.  Tapi kami tidak akan membahasnya secara rinci.  Ingatlah bahwa awal sebenarnya dari hampir semua fungsi sedikit lebih jauh. <br><br>  Karena tidak ada transisi eksplisit ke 0xB13A dalam kode, IDA tidak dapat mengenali bahwa ada kode di sana.  Untuk alasan yang sama, itu tidak mengenali sebagian besar kode di perpustakaan sebagai kode, yang membuat menganalisa sedikit lebih rumit.  Jadi, kami memberi tahu IDA bahwa ada kode, dan inilah yang terjadi: <br><br><img src="https://habrastorage.org/webt/eq/wp/p3/eqwpp3exmqnybi7r_tdvvan4jls.png"><br><br>  Mulai dari 0xB144, kami memiliki tabel yang jelas.  Tapi bagaimana dengan sub_494C? <br><br><img src="https://habrastorage.org/webt/bo/9b/rn/bo9brnkfvauy3ntm2dnucnsxqhs.png"><br><br>  Saat memanggil fungsi ini dalam register LR, kami mendapatkan alamat tabel yang disebutkan di atas (0xB144).  R0 berisi indeks dalam tabel ini.  Artinya, kita mengambil nilai dari tabel, menambahkannya ke LR, dan mendapatkan alamat yang harus kita tuju.  Mari kita coba hitung: 0xB144 + [0xB144 + 8 * 4] = 0xB144 + 0x120 = 0xB264.  Kami menavigasi ke alamat ini dan melihat beberapa instruksi yang berguna, kemudian pergi ke 0xB140: <br><br><img src="https://habrastorage.org/webt/nz/95/4x/nz954xqtjmky6tnpaqeejhvecus.png"><br><br>  Sekarang akan ada transisi diimbangi dengan indeks 0x20 dari tabel. <br>  Dilihat dari ukuran tabel, akan ada banyak transisi dalam kode.  Jadi kami ingin menangani ini secara otomatis dan menghindari penghitungan alamat secara manual.  Dengan demikian, skrip dan kemampuan untuk menambal kode di IDA datang untuk menyelamatkan kami: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 2 if get_wide_word(ea1) == 0xbf00: #NOP ea1 += 2 if get_operand_type(ea1, 0) == 1 and get_operand_value(ea1, 0) == 0 and get_operand_type(ea1, 1) == 2: index = get_wide_dword(get_operand_value(ea1, 1)) print "index =", hex(index) ea1 += 2 if get_operand_type(ea1, 0) == 7: table = get_operand_value(ea1, 0) + 4 elif get_operand_type(ea1, 1) == 2: table = get_operand_value(ea1, 1) + 4 else: print "Wrong operand type on", hex(ea1), "-", get_operand_type(ea1, 0), get_operand_type(ea1, 1) table = None if table is None: print "Unable to find table" else: print "table =", hex(table) offset = get_wide_dword(table + (index &lt;&lt; 2)) put_unconditional_branch(ea, table + offset) else: print "Unknown code", get_operand_type(ea1, 0), get_operand_value(ea1, 0), get_operand_type(ea1, 1) == 2 else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  Kami meletakkan kursor pada string 0xB26A, menjalankan skrip, dan melihat transisi ke 0xB4B0: <br><br><img src="https://habrastorage.org/webt/52/rf/fx/52rffxhzmtrfdhfrznsr8dovfim.png"><br><br>  Sekali lagi, IDA tidak mengenali tempat ini sebagai kode.  Kami membantu dan melihat struktur lain di sana: <br><br><img src="https://habrastorage.org/webt/ct/d9/kv/ctd9kvewm9l1blmw3pqipi8mnqm.png"><br><br>  Instruksi yang mengikuti BLX tidak tampak sangat berarti;  mereka lebih seperti semacam offset.  Kami melihat sub_4964: <br><br><img src="https://habrastorage.org/webt/o7/wi/4-/o7wi4-imrothkr6qpkbrklj40aw.png"><br><br>  Memang, dibutuhkan DWORD di alamat dari LR, menambahkannya ke alamat ini, lalu mengambil nilai di alamat yang dihasilkan dan menyimpannya di tumpukan.  Selain itu, ia menambahkan 4 ke LR untuk melompati offset yang sama ini setelah kembali dari fungsi.  Kemudian perintah POP {R1} mengambil nilai yang dihasilkan dari stack.  Melihat apa yang terletak di alamat 0xB4BA + 0xEA = 0xB5A4, kita dapat melihat sesuatu yang mirip dengan tabel alamat: <br><br><img src="https://habrastorage.org/webt/ev/hb/a8/evhba8ty8dtnv8niuxyfue0nkfk.png"><br><br>  Untuk menambal struktur ini, kita perlu mendapatkan dua parameter dari kode: offset dan nomor register tempat kita ingin mendorong hasilnya.  Kami harus menyiapkan sepotong kode terlebih dahulu untuk setiap kemungkinan pendaftaran. <br><br><pre> <code class="python hljs">patches = {} patches[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x49</span></span>, <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">2</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4a</span></span>, <span class="hljs-number"><span class="hljs-number">0x12</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">3</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4b</span></span>, <span class="hljs-number"><span class="hljs-number">0x1b</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">4</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4c</span></span>, <span class="hljs-number"><span class="hljs-number">0x24</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">5</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4d</span></span>, <span class="hljs-number"><span class="hljs-number">0x2d</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">8</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0xd8</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">9</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0xd9</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">10</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0xda</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">11</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0xdb</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb082</span></span> <span class="hljs-comment"><span class="hljs-comment">#SUB SP, SP, #8 and get_wide_word(ea + 2) == 0xb503): #PUSH {R0,R1,LR} if get_operand_type(ea + 4, 0) == 7: pop = get_bytes(ea + 12, 4, 0) if pop[1] == '\xbc': register = -1 r = get_wide_byte(ea + 12) for i in range(8): if r == (1 &lt;&lt; i): register = i break if register == -1: print "Unable to detect register" else: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 if ea % 4 != 0: ea += 2 patch_dword(ea, address) elif pop[:3] == '\x5d\xf8\x04': register = ord(pop[3]) &gt;&gt; 4 if register in patches: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 patch_dword(ea, address) else: print "POP instruction not found" else: print "Wrong operand type on +4:", get_operand_type(ea + 4, 0) else: print "Unable to detect first instructions"</span></span></code> </pre> <br>  Kami meletakkan kursor di awal struktur yang ingin kami ganti (yaitu 0xB4B2) dan menjalankan skrip: <br><br><img src="https://habrastorage.org/webt/lv/mp/oo/lvmpoow5agndjnbbl-t3imyaisq.jpeg"><br><br>  Selain struktur yang telah disebutkan, kode ini meliputi: <br><br><img src="https://habrastorage.org/webt/dk/nn/rw/dknnrwaye18zzz0xipny0_gdqfq.png"><br><br>  Seperti pada kasus sebelumnya, ada offset setelah instruksi BLX: <br><br><img src="https://habrastorage.org/webt/fn/bw/uz/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg"><br><br>  Kami mengambil offset di alamat dari LR, menambahkannya ke LR, dan menavigasi di sana.  0x72044 + 0xC = 0x72050.  Script untuk struktur ini cukup sederhana: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 6 if get_wide_word(ea + 2) == 0xbf00: #NOP ea1 += 2 offset = get_wide_dword(ea1) put_unconditional_branch(ea, (ea1 + offset) &amp; 0xffffffff) else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  Hasil menjalankan skrip: <br><br><img src="https://habrastorage.org/webt/tm/fq/yo/tmfqyogtdhbje0atjckosbrgide.jpeg"><br><br>  Setelah kita menambal semua yang ada di fungsi ini, kita bisa mengarahkan IDA ke awal sebenarnya.  Ini akan mengumpulkan seluruh kode fungsi sepotong demi sepotong dan kita akan dapat mendekompilasi menggunakan HexRays. <br><br><h3>  Mendekripsi string </h3><br>  Kami telah belajar cara menangani kebingungan kode mesin di <b><i>libsgmainso-6.4.36.so</i></b> perpustakaan dari UC Browser dan memperoleh kode fungsi <i>JNI_OnLoad</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">real_JNI_OnLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaVM *vm)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; <span class="hljs-comment"><span class="hljs-comment">// r0 jclass clazz; // r0 MAPDST int v4; // r0 JNIEnv *env; // r4 int v6; // [sp-40h] [bp-5Ch] int v7; // [sp+Ch] [bp-10h] v7 = *(_DWORD *)off_8AC00; if ( !vm ) goto LABEL_39; sub_7C4F4(); env = (JNIEnv *)sub_7C5B0(0); if ( !env ) goto LABEL_39; v4 = sub_72CCC(); sub_73634(v4); sub_73E24(&amp;unk_83EA6, &amp;v6, 49); clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)-&gt;FindClass)(env, &amp;v6); if ( clazz &amp;&amp; (sub_9EE4(), sub_71D68(env), sub_E7DC(env) &gt;= 0 &amp;&amp; sub_69D68(env) &gt;= 0 &amp;&amp; sub_197B4(env, clazz) &gt;= 0 &amp;&amp; sub_E240(env, clazz) &gt;= 0 &amp;&amp; sub_B8B0(env, clazz) &gt;= 0 &amp;&amp; sub_5F0F4(env, clazz) &gt;= 0 &amp;&amp; sub_70640(env, clazz) &gt;= 0 &amp;&amp; sub_11F3C(env) &gt;= 0 &amp;&amp; sub_21C3C(env, clazz) &gt;= 0 &amp;&amp; sub_2148C(env, clazz) &gt;= 0 &amp;&amp; sub_210E0(env, clazz) &gt;= 0 &amp;&amp; sub_41B58(env, clazz) &gt;= 0 &amp;&amp; sub_27920(env, clazz) &gt;= 0 &amp;&amp; sub_293E8(env, clazz) &gt;= 0 &amp;&amp; sub_208F4(env, clazz) &gt;= 0) ) { result = (sub_B7B0(env, clazz) &gt;&gt; 31) | 0x10004; } else { LABEL_39: result = -1; } return result; }</span></span></code> </pre> <br>  Mari kita lihat string berikut: <br><br><pre> <code class="cpp hljs"> sub_73E24(&amp;unk_83EA6, &amp;v6, <span class="hljs-number"><span class="hljs-number">49</span></span>); clazz = (jclass)((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *))(*env)-&gt;FindClass)(env, &amp;v6);</code> </pre> <br>  Cukup jelas bahwa fungsi <i>sub_73E24</i> mendekripsi nama kelas.  Parameter fungsi ini berisi pointer ke data yang terlihat mirip dengan yang dienkripsi, semacam buffer, dan angka.  Jelas, string yang didekripsi akan berada di buffer setelah panggilan ke fungsi, karena buffer pergi ke fungsi <i>FindClass</i> , yang menerima nama kelas yang sama dengan parameter kedua.  Jadi angkanya adalah ukuran buffer atau panjang string.  Mari kita coba mendekripsi nama kelas.  Itu harus menunjukkan jika kita pergi ke arah yang benar.  Mari kita lihat lebih dekat apa yang terjadi di <i>sub_73E24</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_73E56</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4; <span class="hljs-comment"><span class="hljs-comment">// r6 int v7; // r11 int v8; // r9 int v9; // r4 size_t v10; // r5 int v11; // r0 struc_1 v13; // [sp+0h] [bp-30h] int v14; // [sp+1Ch] [bp-14h] int v15; // [sp+20h] [bp-10h] v4 = 0; v15 = *(_DWORD *)off_8AC00; v14 = 0; v7 = sub_7AF78(17); v8 = sub_7AF78(size); if ( !v7 ) { v9 = 0; goto LABEL_12; } (*(void (__fastcall **)(int, const char *, int))(v7 + 12))(v7, "DcO/lcK+h?m3c*q@", 16); if ( !v8 ) { LABEL_9: v4 = 0; goto LABEL_10; } v4 = 0; if ( !in ) { LABEL_10: v9 = 0; goto LABEL_11; } v9 = 0; if ( out ) { memset(out, 0, size); v10 = size - 1; (*(void (__fastcall **)(int, unsigned __int8 *, size_t))(v8 + 12))(v8, in, v10); memset(&amp;v13, 0, 0x14u); v13.field_4 = 3; v13.field_10 = v7; v13.field_14 = v8; v11 = sub_6115C(&amp;v13, &amp;v14); v9 = v11; if ( v11 ) { if ( *(_DWORD *)(v11 + 4) == v10 ) { qmemcpy(out, *(const void **)v11, v10); v4 = *(_DWORD *)(v9 + 4); } else { v4 = 0; } goto LABEL_11; } goto LABEL_9; } LABEL_11: sub_7B148(v7); LABEL_12: if ( v8 ) sub_7B148(v8); if ( v9 ) sub_7B148(v9); return v4; }</span></span></code> </pre> <br>  Fungsi sub_7AF78 membuat instance wadah untuk array byte dengan ukuran yang ditentukan (kami tidak akan fokus pada mereka secara detail).  Dua wadah tersebut dibuat di sini: satu berisi string " <b><i>DcO / lcK + h? M3c * q @</i></b> " (mudah ditebak bahwa ini adalah kuncinya), yang lain memiliki data terenkripsi.  Kedua objek kemudian ditempatkan dalam struktur tertentu, yang mentransfer ke fungsi <i>sub_6115C</i> .  Kami juga dapat mencatat bahwa struktur ini berisi bidang dengan nilai 3. Mari kita lihat apa yang terjadi selanjutnya. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_611B4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struc_1 *a1, _DWORD *a2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3; <span class="hljs-comment"><span class="hljs-comment">// lr unsigned int v4; // r1 int v5; // r0 int v6; // r1 int result; // r0 int v8; // r0 *a2 = 820000; if ( a1 ) { v3 = a1-&gt;field_14; if ( v3 ) { v4 = a1-&gt;field_4; if ( v4 &lt; 0x19 ) { switch ( v4 ) { case 0u: v8 = sub_6419C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 3u: v8 = sub_6364C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 0x10u: case 0x11u: case 0x12u: v8 = sub_612F4( a1-&gt;field_0, v4, *(_QWORD *)&amp;a1-&gt;field_8, *(_QWORD *)&amp;a1-&gt;field_8 &gt;&gt; 32, a1-&gt;field_10, v3, a2); goto LABEL_17; case 0x14u: v8 = sub_63A28(a1-&gt;field_0, v3); goto LABEL_17; case 0x15u: sub_61A60(a1-&gt;field_0, v3, a2); return result; case 0x16u: v8 = sub_62440(a1-&gt;field_14); goto LABEL_17; case 0x17u: v8 = sub_6226C(a1-&gt;field_10, v3); goto LABEL_17; case 0x18u: v8 = sub_63530(a1-&gt;field_14); LABEL_17: v6 = 0; if ( v8 ) { *a2 = 0; v6 = v8; } return v6; default: LOWORD(v5) = 28032; goto LABEL_5; } } } } LOWORD(v5) = -27504; LABEL_5: HIWORD(v5) = 13; v6 = 0; *a2 = v5; return v6; }</span></span></code> </pre> <br>  Bidang dengan nilai yang sebelumnya ditetapkan 3 ditransisikan sebagai parameter sakelar.  Mari kita lihat kasus 3 - parameter yang ditambahkan fungsi sebelumnya ke struktur (yaitu, kunci dan data terenkripsi) ditransisikan ke fungsi sub_6364C.  Jika kita melihat lebih dekat pada sub_6364C, kita dapat mengenali algoritma RC4. <br><br>  Jadi kami memiliki algoritma dan kunci.  Mari kita coba mendekripsi nama kelas.  Inilah yang kami punya: com / taobao / nirkabel / keamanan / adaptor / JNICLibrary.  Cemerlang!  Kami berada di jalur yang benar. <br><br><h3>  Pohon perintah </h3><br>  Sekarang kita perlu menemukan panggilan ke <i>RegisterNatives</i> , yang akan mengarahkan kita ke fungsi <i>doCommandNative</i> .  Jadi kita melihat fungsi-fungsi yang dipanggil dari <i>JNI_OnLoad</i> , dan menemukannya di <i>sub_B7B0</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_B7F6</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jclass clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> signature[<span class="hljs-number"><span class="hljs-number">41</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// [sp+7h] [bp-55h] char name[16]; // [sp+30h] [bp-2Ch] JNINativeMethod method; // [sp+40h] [bp-1Ch] int v8; // [sp+4Ch] [bp-10h] v8 = *(_DWORD *)off_8AC00; decryptString((unsigned __int8 *)&amp;unk_83ED9, (unsigned __int8 *)name, 0x10u);// doCommandNative decryptString((unsigned __int8 *)&amp;unk_83EEA, (unsigned __int8 *)signature, 0x29u);// (I[Ljava/lang/Object;)Ljava/lang/Object; method.name = name; method.signature = signature; method.fnPtr = sub_B69C; return ((int (__fastcall *)(JNIEnv *, jclass, JNINativeMethod *, int))(*env)-&gt;RegisterNatives)(env, clazz, &amp;method, 1) &gt;&gt; 31; }</span></span></code> </pre> <br>  Dan memang, metode asli dengan nama <i>doCommandNative</i> terdaftar di sini.  Sekarang kita tahu alamatnya.  Mari kita lihat apa fungsinya. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jobject obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> command, jarray args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5; <span class="hljs-comment"><span class="hljs-comment">// r5 struc_2 *a5; // r6 int v9; // r1 int v11; // [sp+Ch] [bp-14h] int v12; // [sp+10h] [bp-10h] v5 = 0; v12 = *(_DWORD *)off_8AC00; v11 = 0; a5 = (struc_2 *)malloc(0x14u); if ( a5 ) { a5-&gt;field_0 = 0; a5-&gt;field_4 = 0; a5-&gt;field_8 = 0; a5-&gt;field_C = 0; v9 = command % 10000 / 100; a5-&gt;field_0 = command / 10000; a5-&gt;field_4 = v9; a5-&gt;field_8 = command % 100; a5-&gt;field_C = env; a5-&gt;field_10 = args; v5 = sub_9D60(command / 10000, v9, command % 100, 1, (int)a5, &amp;v11); } free(a5); if ( !v5 &amp;&amp; v11 ) sub_7CF34(env, v11, &amp;byte_83ED7); return v5; }</span></span></code> </pre> <br>  Nama ini menunjukkan bahwa itu adalah titik masuk untuk semua fungsi yang ditransfer pengembang ke perpustakaan asli.  Kami secara khusus tertarik pada nomor fungsi 10601. <br><br>  Dari kode, kita dapat melihat bahwa nomor perintah memberi kita tiga angka: perintah / 10000, perintah% 10000/100, dan perintah% 10 (dalam kasus kami, 1, 6, dan 1).  Tiga angka ini, serta penunjuk ke JNIEnv dan argumen yang ditransfer ke fungsi, membentuk struktur dan diteruskan.  Dengan tiga angka ini (kami akan menyatakannya N1, N2, dan N3), pohon perintah dibangun.  Sesuatu seperti ini: <br><br><img src="https://habrastorage.org/webt/xg/jk/l1/xgjkl1uhzmibo-nhmha3kpivf5a.png"><br><br>  Pohon dibuat secara dinamis di JNI_OnLoad.  Tiga angka mengkodekan jalur di pohon.  Setiap daun pohon berisi alamat xorred fungsi yang sesuai.  Kuncinya ada di simpul induk.  Sangat mudah untuk menemukan tempat dalam kode di mana fungsi yang kita butuhkan ditambahkan ke pohon jika kita memahami semua struktur di sana (kita tidak akan menghabiskan waktu menggambarkannya dalam artikel ini). <br><br><h3>  Lebih banyak kebingungan </h3><br>  Kami mendapat alamat fungsi yang seharusnya mendekripsi lalu lintas: 0x5F1AC.  Tapi masih terlalu dini untuk bersantai - pengembang UC Browser punya kejutan lain untuk kita. <br><br>  Setelah menerima parameter dari array dalam kode Java, kita pergi ke fungsi di 0x4D070.  Jenis lain dari kebingungan kode sudah menunggu. <br><br>  Kami kemudian mendorong dua indeks di R7 dan R4: <br><br><img src="https://habrastorage.org/webt/7i/fx/86/7ifx86mr4yph41jsxukpjqvxmfa.png"><br><br>  Indeks pertama bergerak ke R11: <br><br><img src="https://habrastorage.org/webt/fa/62/6j/fa626jaylcaaewtslff_-byaseo.jpeg"><br><br>  Kami menggunakan indeks ini untuk mendapatkan alamat dari tabel: <br><br><img src="https://habrastorage.org/webt/co/rk/s1/corks1o2dp75elfvdsxjimrohuo.png"><br><br>  Setelah mentransfer ke alamat pertama, kami menggunakan indeks kedua dari R4.  Tabel ini berisi 230 elemen. <br><br>  Apa yang kita lakukan dengannya?  Kita bisa memberi tahu IDA bahwa itu adalah semacam saklar: Edit -&gt; Lainnya -&gt; Tentukan idiom sakelar. <br><br><img src="https://habrastorage.org/webt/36/uu/xn/36uuxnabf3xesptr8qisxzzfutk.jpeg"><br><br>  Kode yang dihasilkan sangat menghebohkan.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Namun, kita dapat melihat panggilan ke </font><font style="vertical-align: inherit;">fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_6115C yang</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> familier dalam </font><i><font style="vertical-align: inherit;">kusutnya</font></i><font style="vertical-align: inherit;"> : </font></font><br><br><img src="https://habrastorage.org/webt/-d/pt/3a/-dpt3akb_yckinmdheczkktzlem.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada parameter sakelar dengan dekripsi RC4 dalam kasus 3. Dalam kasus ini, struktur yang mentransfer ke fungsi diisi dengan parameter yang ditransfer ke doCommandNative. Kami ingat bahwa kami memiliki magicInt di sana dengan nilai 16. Kami melihat kasus yang sesuai dan setelah beberapa transisi, menemukan kode yang membantu kami mengidentifikasi algoritma. </font></font><br><br><img src="https://habrastorage.org/webt/rn/_1/i4/rn_1i4avl8oki83hslk5u19ygoe.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu AES!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memiliki algoritme dan hanya perlu mendapatkan parameternya, seperti mode, kunci, dan (mungkin) vektor inisialisasi (keberadaannya tergantung pada mode operasi algoritme AES). </font><font style="vertical-align: inherit;">Struktur yang memuatnya harus dibuat di suatu tempat sebelum memanggil fungsi sub_6115C. </font><font style="vertical-align: inherit;">Tetapi karena bagian kode ini dikaburkan dengan sangat baik, kami memutuskan untuk menambal kode tersebut sehingga semua parameter fungsi dekripsi dapat dibuang ke file.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tambalan </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda tidak ingin menulis secara manual semua kode tambalan dalam bahasa rakitan, Anda dapat menjalankan Android Studio, memberi kode fungsi yang menerima parameter yang sama dengan fungsi dekripsi kami dan menulis ke file, lalu menyalin kode yang dihasilkan yang dihasilkan oleh kompiler </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teman baik kami dari tim UC Browser juga "memastikan" kenyamanan menambahkan kode. Kami ingat bahwa kami memiliki kode sampah di awal setiap fungsi, yang dapat dengan mudah diganti dengan kode lain. Sangat mudah :) Namun, tidak ada cukup ruang di awal fungsi target untuk kode yang menyimpan semua parameter ke file. Kami harus membaginya menjadi beberapa bagian dan menggunakan blok sampah dari fungsi yang berdekatan. Kami mendapat empat bagian secara total. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian satu:</font></font><br><br><img src="https://habrastorage.org/webt/hy/lk/qr/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empat parameter fungsi pertama dalam arsitektur ARM ditunjukkan dalam register R0-R3, sedangkan sisanya, jika ada, melewati stack. Register LR menunjukkan alamat kembali. Kita perlu menyimpan semua data ini agar fungsinya dapat berfungsi setelah kita membuang parameternya. Kita juga perlu menyimpan semua register yang kita gunakan dalam proses, jadi kita menggunakan PUSH.W {R0-R10, LR}. Di R7, kami mendapatkan alamat daftar parameter yang ditransfer ke fungsi melalui stack.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan menggunakan fungsi fopen, kita membuka file / data / local / tmp / aes dalam mode "ab" (sehingga kita dapat menambahkan sesuatu). Kami kemudian memuat alamat nama file di R0 dan alamat string yang menunjukkan mode di R1. Di sinilah kode sampah berakhir, jadi kami menavigasi ke fungsi berikutnya. Karena kami ingin terus bekerja, kami menempatkan transisi ke kode fungsi yang sebenarnya di awal, sebelum sampah, dan mengganti sampah dengan sisa tambalan. </font></font><br><br><img src="https://habrastorage.org/webt/68/ss/kf/68sskfcymjorl_flpf8mg9wwej4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami kemudian memanggil fopen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiga parameter pertama dari fungsi aes adalah dari tipe int. Karena kami mendorong register ke stack di awal, kami dapat dengan mudah mentransfer alamat mereka di stack ke fungsi fwrite.</font></font><br><br><img src="https://habrastorage.org/webt/d1/yt/iz/d1ytiz_jx7byflntqxxec2nece0.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selanjutnya, kami memiliki tiga struktur yang menunjukkan ukuran data dan berisi pointer ke data untuk kunci, vektor inisialisasi, dan data terenkripsi. </font></font><br><br><img src="https://habrastorage.org/webt/me/vy/kz/mevykztpkcwdr6xkpnenauxqccs.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada akhirnya, kami menutup file, mengembalikan register, dan memberikan kontrol kembali ke fungsi aes yang sebenarnya.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengkompilasi file APK dengan pustaka yang ditambal, menandatanganinya, mengunduhnya ke perangkat atau emulator, dan menjalankannya. Sekarang kita melihat dump telah dibuat dengan banyak data. Browser tidak hanya mendekripsi lalu lintas, tetapi data lain juga, dan semua dekripsi dilakukan melalui fungsi ini. Untuk beberapa alasan, kami tidak melihat data yang kami butuhkan, dan permintaan yang kami harapkan tidak terlihat dalam lalu lintas. Mari kita lewati menunggu sampai UC Browser memiliki kesempatan untuk membuat permintaan ini dan mengambil respons terenkripsi yang diperoleh sebelumnya dari server untuk menambal aplikasi lagi. Kami akan menambahkan dekripsi ke onCreate dari aktivitas utama.</font></font><br><br><pre> <code class="plaintext hljs"> const/16 v1, 0x62 new-array v1, v1, [B fill-array-data v1, :encrypted_data const/16 v0, 0x1f invoke-static {v0, v1}, Lcom/uc/browser/core/d/c/g;-&gt;j(I[B)[B move-result-object v1 array-length v2, v1 invoke-static {v2}, Ljava/lang/String;-&gt;valueOf(I)Ljava/lang/String; move-result-object v2 const-string v0, "ololo" invoke-static {v0, v2}, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengkompilasinya, menandatangani, menginstal, dan menjalankan. </font><font style="vertical-align: inherit;">Jadi, kami mendapatkan NullPointerException karena metode ini mengembalikan nilai nol. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setelah menganalisis kode lebih lanjut, kami menemukan fungsi dengan string yang agak menarik: "META-INF /" dan ".RSA". </font><font style="vertical-align: inherit;">Sepertinya aplikasi memverifikasi sertifikatnya, atau bahkan menghasilkan kunci darinya. </font><font style="vertical-align: inherit;">Kami tidak benar-benar ingin menggali apa yang terjadi dengan sertifikat, jadi mari kita berikan sertifikat yang benar. </font><font style="vertical-align: inherit;">Kami akan menambal string terenkripsi, jadi alih-alih ‚ÄúMETA-INF /‚Äù kami mendapatkan ‚ÄúBLABLINF /‚Äù, kami membuat folder dengan nama ini di file APK, dan menyimpan sertifikat browser di dalamnya. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengkompilasinya, menandatangani, menginstal, dan menjalankan. </font><font style="vertical-align: inherit;">Bingo! </font><font style="vertical-align: inherit;">Kami punya kuncinya!</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mitm </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekarang kita punya kunci dan vektor inisialisasi yang sama. Mari kita coba mendekripsi respons server dalam mode CBC. </font></font><br><br><img src="https://habrastorage.org/webt/9k/m7/un/9km7unymy_ybx1lwnflfbqd36ke.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami melihat URL arsip, sesuatu seperti MD5, "extract_unzipsize", dan sebuah angka. Mari kita periksa. MD5 dari arsip adalah sama; ukuran pustaka unzip adalah sama. Sekarang kita akan mencoba untuk menambal pustaka ini dan mengirimkannya ke browser. Untuk menunjukkan bahwa pustaka yang ditambal kami telah dimuat, kami akan membangun Intent untuk membuat pesan teks "PWNED!" Kami akan mengganti dua respons dari server: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan yang meminta unduhan arsip. Pada yang pertama, kami mengganti MD5 (ukurannya tetap sama setelah membuka ritsleting); di yang kedua, kami mengirim arsip dengan pustaka yang ditambal.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peramban melakukan beberapa upaya untuk mengunduh arsip, menghasilkan kesalahan. </font><font style="vertical-align: inherit;">Rupanya, sesuatu yang mencurigakan sedang terjadi di sana. </font><font style="vertical-align: inherit;">Menganalisis format aneh ini, kami menemukan bahwa server juga mentransmisikan ukuran arsip: </font></font><br><br><img src="https://habrastorage.org/webt/e2/-v/ua/e2-vuahng86h0bt0vm84f3xhqrg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini dikodekan LEB128. </font><font style="vertical-align: inherit;">Patch sedikit mengubah ukuran perpustakaan terkompresi, sehingga browser memutuskan bahwa arsip rusak saat diunduh dan menampilkan kesalahan setelah beberapa upaya. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jadi kami memperbaiki ukuran arsip dan ... voila! </font><font style="vertical-align: inherit;">:) Lihat hasilnya di video.</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Nfns7uH03J8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Konsekuensi dan respons pengembang </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan cara yang sama, peretas dapat menggunakan fitur UC Browser yang tidak aman ini untuk mendistribusikan dan meluncurkan perpustakaan jahat. Pustaka ini akan berfungsi dalam konteks browser, menghasilkan hak istimewa sistem penuh yang dimiliki browser. Ini memberi mereka pemerintahan bebas untuk menampilkan jendela phishing, serta akses ke file browser yang berfungsi termasuk login, kata sandi, dan cookie di database.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menghubungi pengembang UC Browser dan memberi tahu mereka tentang masalah yang kami temukan, mencoba menunjukkan kerentanan dan bahayanya, tetapi mereka menolak untuk membahas masalah tersebut. Sementara itu, browser dengan fungsi berbahaya tetap terlihat jelas. Meskipun begitu kami mengungkapkan rincian kerentanan, tidak mungkin untuk mengabaikannya seperti sebelumnya. Versi baru dari UC Browser 10.10.9.1193 dirilis pada tanggal 27 Maret, yang mengakses server melalui HTTPS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Selain itu, antara "perbaikan bug" dan saat kami menulis artikel ini, upaya untuk membuka PDF di browser menghasilkan pesan kesalahan dengan teks, "Ups, ada sesuatu yang salah." </font><font style="vertical-align: inherit;">Tidak ada permintaan ke server ketika mencoba membuka file PDF. </font><font style="vertical-align: inherit;">Ini dilakukan saat startup, yang merupakan pertanda bahwa kemampuan untuk mengunduh kode yang dapat dieksekusi yang melanggar kebijakan Google Play masih ada.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id452076/">https://habr.com/ru/post/id452076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id452064/index.html">Konfigurasi dan File Status yang Diinginkan PowerShell: Bagian 1. Mengkonfigurasi Server Tarik DSC agar berfungsi dengan SQL Database</a></li>
<li><a href="../id452066/index.html">Excelsior JET menghentikan pengembangan compiler AOT setelah 18 tahun bekerja</a></li>
<li><a href="../id452068/index.html">12. Titik Periksa Memulai R80.20. Log & laporan</a></li>
<li><a href="../id452072/index.html">Kami menerapkan CircularRevealAnimation on Flutter dan secara bersamaan menerbitkan perpustakaan di pub.dev</a></li>
<li><a href="../id452074/index.html">Game pertama tentang persatuan atau apa yang butuh saya enam bulan</a></li>
<li><a href="../id452078/index.html">Reservasi Kubernetes: Ada</a></li>
<li><a href="../id452082/index.html">Pembaruan Fleksibel Aplikasi dalam Aplikasi: Mempercepat Proses Pembaruan Aplikasi di Android</a></li>
<li><a href="../id452086/index.html">Apa yang ada di pixel saya untuk Anda: membuat nanopixels menggunakan metasurfaces plasmon</a></li>
<li><a href="../id452088/index.html">Pengenalan jalan melalui segmentasi semantik</a></li>
<li><a href="../id452090/index.html">Membuat generator puzzle prosedural</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>