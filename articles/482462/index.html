<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíµ üåë ü§üüèæ Aprenda Metaflow en 10 minutos üèÄ üêÉ üîé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Metaflow es un marco de Python creado en Netflix y enfocado en el campo de la ciencia de datos. A saber, est√° dise√±ado para crear proyectos destinados...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aprenda Metaflow en 10 minutos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/482462/">  Metaflow es un marco de Python creado en Netflix y enfocado en el campo de la ciencia de datos.  A saber, est√° dise√±ado para crear proyectos destinados a trabajar con datos y para gestionar dichos proyectos.  Recientemente, la compa√±√≠a lo transfiri√≥ a la categor√≠a de c√≥digo abierto.  El marco Metaflow ha sido ampliamente utilizado dentro de Netflix en los √∫ltimos 2 a√±os.  En particular, permiti√≥ reducir significativamente el tiempo requerido para la conclusi√≥n de proyectos en producci√≥n. <br><br> <a href="https://habr.com/ru/company/ruvds/blog/482462/"><img src="https://habrastorage.org/webt/yd/2j/7p/yd2j7p_dpzkyrjeef9us6a7pgs4.png"></a> <br><br>  El material que estamos traduciendo hoy es una gu√≠a r√°pida de Metaflow. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">¬øQu√© es el metaflujo?</font> </h2><br>  A continuaci√≥n se muestra un gr√°fico que ilustra la implementaci√≥n del marco Metaflow en Netflix. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6bd/bb8/297/6bdbb82972a098b8fd241f42d7f55b51.png"></div><br>  <i><font color="#999999">Implementaci√≥n de Metaflow en Netflix</font></i> <br><br>  En noviembre de 2018, este marco se utiliz√≥ en 134 proyectos de la empresa. <br><br>  Metaflow es un marco para crear y ejecutar flujos de trabajo de ciencia de datos.  Cuenta con las siguientes caracter√≠sticas: <br><br><ul><li>  Gesti√≥n de recursos inform√°ticos. </li><li>  Lanzamiento de tareas en contenedores. </li><li>  Gesti√≥n de dependencias externas. </li><li>  Versionado, re-ejecuci√≥n de tareas, ejecuci√≥n continua de tareas suspendidas. </li><li>  API de cliente para examinar los resultados de tareas que se pueden usar en el entorno de Jupyter Notebook. </li><li>  Soporte para la ejecuci√≥n de tareas locales (por ejemplo, en una computadora port√°til) y remotas (en la nube).  Posibilidad de cambiar entre estos modos. </li></ul><br>  El usuario vtuulos <a href="https://news.ycombinator.com/item%3Fid%3D21698711">escribi√≥</a> en Ycombinator que Metaflow puede crear autom√°ticamente instant√°neas (instant√°neas) de c√≥digo, datos y dependencias.  Todo esto se coloca en un repositorio con direccionamiento por contenido, que generalmente se basa en S3, aunque el sistema de archivos local tambi√©n es compatible.  Esto le permite continuar realizando tareas detenidas, reproducir resultados obtenidos previamente y explorar todo lo relacionado con las tareas, por ejemplo, en Jupyter Notebook. <br><br>  En general, podemos decir que Metaflow tiene como objetivo aumentar la productividad de los cient√≠ficos de datos.  Esto se hace debido al hecho de que el marco les permite participar exclusivamente en el trabajo con datos, sin distraerse resolviendo tareas relacionadas.  Adem√°s, Metaflow acelera la retirada de proyectos basados ‚Äã‚Äãen ella en producci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/311/176/d1631117682028c779664c90bef2a885.png"></div><br>  <i><font color="#999999">Las necesidades de un cient√≠fico de datos relacionadas con sus responsabilidades directas y la soluci√≥n de tareas auxiliares relacionadas con la infraestructura en la que se realizan los c√°lculos.</font></i> <br><br><h2>  <font color="#3AC1EF">Escenarios de flujo de trabajo con Metaflow</font> </h2><br>  Aqu√≠ hay algunos escenarios de flujo de trabajo que puede organizar usando Metaflow: <br><br><ul><li>  <b>Colaboraci√≥n</b>  Un cient√≠fico de datos quiere ayudar a otro a encontrar la fuente del error.  Al mismo tiempo, al asistente le gustar√≠a descargar a su computadora todo el entorno en el que funcion√≥ la tarea que se bloque√≥. </li><li>  <b>Continuaci√≥n de las tareas detenidas desde el lugar donde fueron detenidas.</b>  Alguna tarea se detuvo con un error (o se detuvo intencionalmente).  El error fue corregido (o el c√≥digo fue editado).  Es necesario reiniciar la tarea para que su trabajo contin√∫e desde el lugar donde fall√≥ (o se detuvo). </li><li>  <b>Ejecuci√≥n de tareas h√≠bridas.</b>  Es necesario realizar un cierto paso del flujo de trabajo localmente (tal vez este es el paso de descargar datos de un archivo que est√° almacenado en una carpeta en la computadora), y otro paso que requiere grandes recursos computacionales (tal vez esto es entrenar el modelo) debe realizarse en la nube. </li><li>  <b>Examen de metadatos obtenidos despu√©s de completar una tarea.</b>  Tres cient√≠ficos de datos participan en la selecci√≥n de hiperpar√°metros del mismo modelo, tratando de mejorar la precisi√≥n de este modelo.  Despu√©s de eso, debe analizar los resultados de completar las tareas de capacitaci√≥n del modelo y seleccionar el conjunto de hiperpar√°metros que ha demostrado ser el mejor. </li><li>  <b>Usando m√∫ltiples versiones del mismo paquete.</b>  En el proyecto debe usar diferentes versiones, por ejemplo, bibliotecas de sklearn.  Durante el preprocesamiento, se requiere su versi√≥n 0.20, y durante el modelado, se requiere la versi√≥n 0.22. </li></ul><br><h2>  <font color="#3AC1EF">Flujo de trabajo t√≠pico de Metaflow</font> </h2><br>  Considere un flujo de trabajo t√≠pico de Metaflow desde una perspectiva conceptual y de programaci√≥n. <br><br><h3>  <font color="#3AC1EF">LookMira conceptual del flujo de trabajo Metaflow</font> </h3><br>  Desde un punto de vista conceptual, los flujos de trabajo de Metaflow (cadenas de tareas) est√°n representados por <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BA%25D0%25BB%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584">gr√°ficos ac√≠clicos dirigidos</a> (DAG).  Las siguientes ilustraciones lo ayudar√°n a comprender mejor esta idea. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/584/53d/52e/58453d52e9dfbd50dcc5b974ffae11e1.png"></div><br>  <i><font color="#999999">Gr√°fico ac√≠clico lineal</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d7/a8d/810/3d7a8d81017d4112913a5c081c70b9a8.png"></div><br>  <i><font color="#999999">Gr√°fico ac√≠clico con caminos "paralelos"</font></i> <br><br>  Cada nodo del gr√°fico representa un paso de procesamiento de datos en el flujo de trabajo. <br><br>  En cada paso de la cadena de tareas, Metaflow ejecuta c√≥digo Python regular sin ning√∫n cambio especial.  El c√≥digo se ejecuta en contenedores separados en los que se empaqueta el c√≥digo junto con sus dependencias. <br><br>  Un aspecto clave de la arquitectura Metaflow est√° representado por el hecho de que le permite implementar casi cualquier biblioteca externa del ecosistema conda en proyectos basados ‚Äã‚Äãen ella sin usar complementos.  Esto distingue a Metaflow de otras soluciones similares de uso general.  Por ejemplo, de Airflow. <br><br><h3>  <font color="#3AC1EF">‚ñç Flujo de trabajo de Metaflow en t√©rminos de programaci√≥n</font> </h3><br>  Cada cadena de tareas (flujo) puede representarse como una clase est√°ndar de Python (los nombres de tales clases generalmente tienen la palabra <code>Flow</code> ) si cumple los siguientes requisitos m√≠nimos: <br><br><ul><li>  La clase es descendiente de la clase Metaflow <code>FlowSpec</code> . </li><li>  Cada funci√≥n que representa un paso en la cadena de tareas tiene el decorador <code>@step</code> . </li><li>  Al final de cada funci√≥n <code>@step</code> , debe haber una indicaci√≥n de una funci√≥n similar que le sigue.  Esto se puede hacer usando una construcci√≥n de este tipo: <code>self.next(self.function_name_here)</code> . </li><li>  La clase implementa las funciones de <code>start</code> y <code>end</code> . </li></ul><br>  Considere un ejemplo de una cadena m√≠nima de tareas que consta de tres nodos. <br><br>  Su esquema se ve as√≠: <br><br><pre> <code class="python hljs">start ‚Üí process_message ‚Üí end</code> </pre> <br>  Aqu√≠ est√° su c√≥digo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LinearFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>         <span class="hljs-string"><span class="hljs-string">"""     ,      Metaflow.    """</span></span>       <span class="hljs-comment"><span class="hljs-comment">#         @step    def start(self):        self.message = 'Thanks for reading.'        self.next(self.process_message)    @step    def process_message(self):        print('the message is: %s' % self.message)        self.next(self.end)    @step    def end(self):        print('the message is still: %s' % self.message) if __name__ == '__main__':    LinearFlow()</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Instrucciones de instalaci√≥n de Metaflow</font> </h2><br><h3>  <font color="#3AC1EF">‚ñçInstalaci√≥n y ejecuci√≥n de prueba</font> </h3><br>  Aqu√≠ est√° la secuencia de pasos que debe realizar para instalar y ejecutar Metaflow por primera vez: <br><br><ul><li>  Instalar Metaflow (se recomienda Python 3): <code>pip3 install metaflow</code> . </li><li>  Coloque el fragmento de c√≥digo anterior ( <a href="https://gist.github.com/Viveckh/95a3348309b158adba062fa031b753a1">aqu√≠</a> est√° en GitHub) en el archivo <code>linear_flow.py</code> . </li><li>  Para ver la arquitectura de la cadena de tareas implementada por este c√≥digo, utilice el comando <code>python3 linear_flow.py show</code> . </li><li>  Para iniciar la secuencia, ejecute el <code>python3 linear_flow.py run</code> . </li></ul><br>  Deber√≠a obtener algo similar al que se muestra a continuaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/5af/ec5/2815afec51573d8a01db3cd8b4ae19e0.png"></div><br>  <i><font color="#999999">Verificaci√≥n exitosa del estado de Metaflow</font></i> <br><br>  Aqu√≠ vale la pena prestar atenci√≥n a algunas cosas.  El marco Metaflow crea un <code>.metaflow</code> datos <code>.metaflow</code> local.  All√≠, almacena todos los metadatos relacionados con la ejecuci√≥n de tareas y las instant√°neas asociadas con las sesiones de ejecuci√≥n de tareas.  Si ha configurado los ajustes de Metaflow relacionados con el almacenamiento en la nube, las instant√°neas se almacenar√°n en AWS S3 Bucket, y los metadatos relacionados con el inicio de tareas ir√°n al servicio de metadatos, basado en RDS (Relational Data Store, almac√©n de datos relacionales).  M√°s adelante hablaremos sobre c√≥mo explorar estos metadatos utilizando la API del cliente.  Otro truco, aunque importante, al que vale la pena prestar atenci√≥n, es que los identificadores de proceso (pid, ID de proceso) adjuntos a los diferentes pasos difieren.  Recuerde: dijimos anteriormente que Metaflow contiene de forma independiente cada paso de la cadena de tareas y realiza cada paso en su propio entorno (pasando solo datos entre los pasos). <br><br><h3>  <font color="#3AC1EF">‚ñçInstalaci√≥n y configuraci√≥n de conda (si planea implementar dependencias)</font> </h3><br>  Siga estos pasos para instalar conda: <br><br><ul><li>  <a href="https://docs.conda.io/en/latest/miniconda.html">Descargue</a> e instale Miniconda. </li><li>  Agregue <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/concepts/channels.html">un canal conda con el</a> comando <code>conda config --add channels conda-forge</code> . </li></ul><br>  Ahora est√° listo para incrustar dependencias de conda en sus cadenas de tareas.  Los detalles de este proceso se discutir√°n a continuaci√≥n. <br><br><h2>  <font color="#3AC1EF">Ejemplo de flujo de trabajo realista</font> </h2><br>  Arriba, hablamos sobre c√≥mo instalar Metaflow y c√≥mo asegurarse de que el sistema est√© operativo.  Adem√°s, discutimos los conceptos b√°sicos de la arquitectura del flujo de trabajo y observamos un ejemplo simple.  Aqu√≠ observamos un ejemplo m√°s complejo, al tiempo que revelamos algunos de los conceptos de Metaflow. <br><br><h3>  <font color="#3AC1EF">‚ñçTrabajo</font> </h3><br>  Cree un flujo de trabajo utilizando Metaflow que implemente las siguientes funciones: <br><br><ul><li>  Carga de datos de pel√≠culas CSV en un marco de datos de Pandas. </li><li>  C√°lculo paralelo de cuartiles para g√©neros. </li><li>  Guardar un diccionario con los resultados de los c√°lculos. </li></ul><br><h3>  <font color="#3AC1EF">‚ñç Cadena de tareas</font> </h3><br>  El esqueleto de la clase <code>GenreStatsFlow</code> se muestra a <code>GenreStatsFlow</code> .  Despu√©s de analizarlo, comprender√° la esencia del enfoque implementado aqu√≠ para resolver nuestro problema. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step, catch, retry, IncludeFile, Parameter <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenreStatsFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>  <span class="hljs-string"><span class="hljs-string">"""    ,  ,   .         :    1)  CSV-   Pandas.    2)     .    3)     .  """</span></span>   @step  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span>    <span class="hljs-string"><span class="hljs-string">"""         :        1)      Pandas.        2)    .        3)        .    """</span></span>       <span class="hljs-comment"><span class="hljs-comment"># </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">  CSV         self.genres = []    self.next(self.compute_statistics, foreach='genres') #  1     @catch(var='compute_failed') #  2  @retry(times=1) #  3  @step  def compute_statistics(self):    """    .   ."""    self.genre = self.input #  4    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">        self.next(self.join)     @step  def join(self, inputs):    """       ."""    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      self.next(self.end)     @step  def end(self):      """End the flow."""      pass   if __name__ == '__main__':  GenreStatsFlow()</span></span></code> </pre> <br>  Considere algunas partes importantes de este ejemplo.  El c√≥digo contiene comentarios de la forma <code>#  n</code> , a los que nos referiremos a continuaci√≥n. <br><br><ul><li>  En el <code> 1</code> , en el paso de <code>start</code> , preste atenci√≥n al par√°metro <code>foreach</code> .  Gracias a √©l, las copias de los pasos <code>compute_statistics</code> se <code>compute_statistics</code> en <code>compute_statistics</code> en un <code>for each</code> ciclo <code>for each</code> entrada en la lista de <code>genres</code> . </li><li>  En el <code> 2</code> decorador <code>@catch(var='compute_failed')</code> detectar√° cualquier excepci√≥n que <code>compute_statistics</code> paso <code>compute_statistics</code> y lo escribir√° en la variable <code>compute_failed</code> (se puede leer en el siguiente paso). </li><li>  En el <code> 3</code> decorador <code>@retry(times=1)</code> hace exactamente lo que su nombre sugiere.  Es decir, cuando se producen errores, repite el paso. </li><li>  ¬øDe <code>self.input</code> <code> 4</code> , en <code>compute_statistics</code> , <code>self.input</code> ?  La cuesti√≥n es que la <code>input</code> es una variable de clase proporcionada por Metaflow.  Contiene datos aplicables a una instancia particular de <code>compute_statistics</code> (cuando hay m√∫ltiples copias de una funci√≥n ejecutada en paralelo).  Metaflow agrega esta variable solo cuando los nodos est√°n representados por varios procesos paralelos, o cuando se combinan varios nodos. </li><li>  Aqu√≠ hay un ejemplo de ejecuci√≥n de la misma funci√≥n en paralelo: <code>compute_statistics</code> .  Pero, si es necesario, puede ejecutar simult√°neamente funciones completamente diferentes que no est√°n relacionadas entre s√≠.  Para hacer esto, cambie lo que se muestra en el <code> 1</code> a algo como <code>self.next(self.func1, self.function2, self.function3)</code> .  Por supuesto, con este enfoque, tambi√©n ser√° necesario reescribir el paso de <code>join</code> , lo que permitir√° procesar los resultados de varias funciones en √©l. </li></ul><br>  Aqu√≠ se explica c√≥mo imaginar la clase de esqueleto anterior. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7af/b4b/d00/7afb4bd00f2cea2df0ebf9fff780b8d2.png"></div><br>  <i><font color="#999999">Representaci√≥n visual de la clase GenreStatsFlow.</font></i> <br><br><h3>  <font color="#3AC1EF">‚ñçLea el archivo de datos y transfiera los par√°metros</font> </h3><br><ul><li>  Descargue <a href="https://www.mediafire.com/file/g9vfu4xxqbs4h2o/movies.csv/file">este</a> archivo CSV de pel√≠cula. </li><li>  Ahora necesita equipar el programa con soporte para la posibilidad de transferir din√°micamente la ruta al archivo <code>movie_data</code> y el valor <code>max_genres</code> a la <code>max_genres</code> .  El mecanismo de los argumentos externos nos ayudar√° en esto.  Metaflow le permite pasar argumentos al programa utilizando indicadores adicionales en el comando de inicio del flujo de trabajo.  Por ejemplo, podr√≠a verse as√≠: <code>python3 tutorial_flow.py run --movie_data=path/to/movies.csv --max_genres=5</code> . </li><li>  Metaflow le da al desarrollador objetos <code>IncludeFile</code> y <code>Parameter</code> que le permiten leer la entrada en el c√≥digo del flujo de trabajo.  Nos referimos a los argumentos pasados ‚Äã‚Äãasignando objetos <code>IncludeFile</code> y <code>Parameter</code> a las variables de clase.  Depende de qu√© es exactamente lo que queremos leer: el archivo o el valor habitual. </li></ul><br>  As√≠ es como se ve el c√≥digo al leer los par√°metros pasados ‚Äã‚Äãal programa cuando se lanz√≥ desde la l√≠nea de comandos: <br><br><pre> <code class="python hljs">    movie_data = IncludeFile(<span class="hljs-string"><span class="hljs-string">"movie_data"</span></span>,                             help=<span class="hljs-string"><span class="hljs-string">"The path to a movie metadata file."</span></span>,                             default = <span class="hljs-string"><span class="hljs-string">'movies.csv'</span></span>)                               max_genres = Parameter(<span class="hljs-string"><span class="hljs-string">'max_genres'</span></span>,                help=<span class="hljs-string"><span class="hljs-string">"The max number of genres to return statistics for"</span></span>,                default=<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br><h3>  <font color="#3AC1EF">‚ñçInclusi√≥n de conda en la cadena de tareas</font> </h3><br><ul><li>  Si a√∫n no ha instalado conda, consulte la secci√≥n sobre instalaci√≥n y configuraci√≥n de conda en este art√≠culo. </li><li>  Agregue el decorador <code>GenreStatsFlow</code> proporcionado por Metaflow a la clase GenreStatsFlow.  Este decorador espera recibir la versi√≥n de Python.  Se puede establecer en el c√≥digo u obtener mediante una funci√≥n auxiliar.  A continuaci√≥n se muestra el c√≥digo que demuestra el uso del decorador y muestra una funci√≥n auxiliar. <br><br><pre> <code class="plaintext hljs">def get_python_version():    """     ,    python,       .         conda        python.    """    import platform    versions = {'2' : '2.7.15',                '3' : '3.7.4'}    return versions[platform.python_version_tuple()[0]] #       python. @conda_base(python=get_python_version()) class GenreStatsFlow(FlowSpec):</code> </pre> </li><li>  Ahora puede agregar el decorador <code>@conda</code> a cualquier paso en la cadena de tareas.  Espera un objeto con dependencias, que se le pasa a trav√©s del par√°metro de <code>libraries</code> .  Metaflow, antes de comenzar el paso, se encargar√° de preparar el contenedor con las dependencias especificadas.  Si es necesario, puede usar de manera segura diferentes versiones de paquetes en diferentes pasos, ya que Metaflow inicia cada paso en un contenedor separado. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">    @conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):</span></span></code> </pre> </li><li>  Ahora ejecute el siguiente comando: <code>python3 tutorial_flow.py --environment=conda run</code> . </li></ul><br><h3>  <font color="#3AC1EF">‚ñçInicio de implementaci√≥n de pasos</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):    """         :        1)      Pandas.        2)    .        3)        .    """        import pandas        from io import StringIO        #      Pandas.        self.dataframe = pandas.read_csv(StringIO(self.movie_data))        #   'genres'      .         #   .        self.genres = {genre for genres \                       in self.dataframe['genres'] \                       for genre in genres.split('|')}        self.genres = list(self.genres)        #        .        #  'foreach'             #          self.next(self.compute_statistics, foreach='genres')</span></span></code> </pre> <br>  Considere algunas de las caracter√≠sticas de este c√≥digo: <br><br><ul><li>  Tenga en cuenta que la expresi√≥n de importaci√≥n de pandas est√° dentro de la funci√≥n que describe el paso.  El hecho es que esta dependencia es introducida por conda solo en el alcance de este paso. </li><li>  Pero las variables declaradas aqu√≠ ( <code>dataframe</code> y <code>genres</code> ) est√°n disponibles incluso en el c√≥digo de los pasos realizados despu√©s de este paso.  El punto es que Metaflow funciona sobre la base de los principios de separaci√≥n de entornos de ejecuci√≥n de c√≥digo, pero permite que los datos se muevan naturalmente entre los pasos de la cadena de tareas. </li></ul><br><h3>  <font color="#3AC1EF">‚ñç Implementaci√≥n del paso compute_statistics</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@catch(var='compute_failed')    @retry    @conda(libraries={'pandas' : '0.25.3'})    @step    def compute_statistics(self):        """            .        """        #             # 'input'.        self.genre = self.input        print("Computing statistics for %s" % self.genre)        #         ,         #        .        selector = self.dataframe['genres'].\                   apply(lambda row: self.genre in row)        self.dataframe = self.dataframe[selector]        self.dataframe = self.dataframe[['movie_title', 'genres', 'gross']]        #     gross   .        points = [.25, .5, .75]        self.quartiles = self.dataframe['gross'].quantile(points).values        #  ,    .        self.next(self.join)</span></span></code> </pre> <br>  Tenga en cuenta que en este paso nos referimos a la variable del <code>dataframe</code> que se declar√≥ en el paso de <code>start</code> anterior.  Estamos modificando esta variable.  Al pasar a los siguientes pasos, este enfoque, que implica el uso de un nuevo objeto de <code>dataframe</code> modificado, le permite organizar un trabajo eficiente con datos. <br><br><h3>  <font color="#3AC1EF">‚ñç Implemente el paso de uni√≥n</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.25.3'})    @step    def join(self, inputs):        """               .        """        inputs = inputs[0:self.max_genres]        #   ,    .        self.genre_stats = {inp.genre.lower(): \                            {'quartiles': inp.quartiles,                             'dataframe': inp.dataframe} \                            for inp in inputs}        self.next(self.end)</span></span></code> </pre> <br>  Aqu√≠ vale la pena destacar un par de puntos: <br><br><ul><li>  En este paso, usamos una versi√≥n completamente diferente de la biblioteca de pandas. </li><li>  Cada elemento en la matriz de <code>inputs</code> es una copia de las <code>compute_statistics</code> ejecutadas <code>compute_statistics</code> .  Contiene el estado de la ejecuci√≥n de la funci√≥n correspondiente, es decir, los valores de varias variables.  Entonces, la <code>input[0].quartiles</code> puede contener cuartiles para el g√©nero de <code>comedy</code> , y la <code>input[1].quartiles</code> <code>input[0].quartiles</code> puede contener cuartiles para el g√©nero de <code>sci-fi</code> . </li></ul><br><h3>  <font color="#3AC1EF">‚ñçProyecto listo</font> </h3><br>  El c√≥digo completo del proyecto que acabamos de revisar se puede encontrar <a href="https://github.com/Viveckh/metaflow_crash_course_prep/blob/master/tutorial_flow.py">aqu√≠</a> . <br><br>  Para ver c√≥mo funciona el flujo de trabajo descrito en el archivo <code>tutorial_flow.py</code> , debe ejecutar el siguiente comando: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda show</code> </pre> <br>  Use el siguiente comando para iniciar el flujo de trabajo: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda run --movie_data=path/to/movies.csv --max_genres=<span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Examinar los resultados de ejecutar un flujo de trabajo utilizando la API del cliente</font> </h2><br>  Para examinar las instant√°neas de datos y el estado de los lanzamientos anteriores del flujo de trabajo, puede usar la <a href="https://docs.metaflow.org/metaflow/client">API</a> del cliente proporcionada por Metaflow.  Esta API es ideal para explorar los detalles de los experimentos realizados en el entorno de Jupyter Notebook. <br><br>  Aqu√≠ hay un ejemplo simple de la salida de la variable <code>genre_stats</code> , tomada de los datos del √∫ltimo lanzamiento exitoso de <code>GenreStatsFlow</code> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flow, get_metadata <span class="hljs-comment"><span class="hljs-comment">#      print("Using metadata provider: %s" % get_metadata()) #     MovieStatsFlow. run = Flow('GenreStatsFlow').latest_successful_run print("Using analysis from '%s'" % str(run)) genre_stats = run.data.genre_stats print(genre_stats)</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Ejecuci√≥n de flujos de trabajo en la nube</font> </h2><br>  Despu√©s de haber creado y probado el flujo de trabajo en una computadora normal, es muy probable que desee ejecutar el c√≥digo en la nube para acelerar el trabajo. <br><br>  Actualmente, Metaflow solo admite la integraci√≥n con AWS.  En la siguiente imagen, puede ver una asignaci√≥n de los recursos locales y en la nube utilizados por Metaflow. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08a/acc/458/08aacc458fc3202ec08624422bef0cb4.png"></div><br>  <i><font color="#999999">Integraci√≥n de Metaflow y AWS</font></i> <br><br>  Para conectar Metaflow a AWS, debe completar los siguientes pasos: <br><br><ul><li>  Primero, debe realizar una configuraci√≥n de AWS √∫nica creando recursos con los que Metaflow pueda trabajar.  Los mismos recursos pueden ser utilizados, por ejemplo, por miembros de un equipo de trabajo que se demuestran entre s√≠ los resultados de los flujos de trabajo.  <a href="https://docs.metaflow.org/metaflow-on-aws/deploy-to-aws">Puede</a> encontrar instrucciones relevantes aqu√≠.  La configuraci√≥n es lo suficientemente r√°pida, porque Metaflow tiene una plantilla de configuraci√≥n de CloudFormation. </li><li>  A continuaci√≥n, en la computadora local, debe ejecutar el <code>metaflow configure aws</code> e ingresar las respuestas a las preguntas del sistema.  Con estos datos, Metaflow podr√° usar almacenes de datos basados ‚Äã‚Äãen la nube. </li><li>  Ahora, para comenzar los flujos de trabajo locales en la nube, simplemente agregue la tecla <code>--with batch</code> al <code>--with batch</code> inicio del flujo de trabajo.  Por ejemplo, podr√≠a verse as√≠: <code>python3 sample_flow.py run --with batch</code> . </li><li>  Para realizar un lanzamiento h√≠brido del flujo de trabajo, es decir, para realizar algunos pasos localmente y algunos en la nube, debe agregar el decorador <code>@batch</code> a esos pasos que deben realizarse en la nube.  Por ejemplo, as√≠: <code>@batch(cpu=1, memory=500)</code> . </li></ul><br><h2>  <font color="#3AC1EF">Resumen</font> </h2><br>  Aqu√≠, me gustar√≠a se√±alar un par de caracter√≠sticas de Metaflow que pueden considerarse tanto las ventajas como las desventajas de este marco: <br><br><ul><li>  Metaflow est√° estrechamente integrado con AWS.  Pero en los planes de desarrollo del marco existe soporte para un mayor n√∫mero de proveedores de la nube. </li><li>  Metaflow es una herramienta que solo admite la interfaz de l√≠nea de comandos.  No tiene una interfaz gr√°fica (a diferencia de otros marcos universales para organizar procesos de trabajo, como Airflow). </li></ul><br>  <b>Estimados lectores!</b>  ¬øPlaneas usar Metaflow? <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482462/">https://habr.com/ru/post/482462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482450/index.html">MVP se ha convertido en un producto o mi experiencia con MVP en 2019</a></li>
<li><a href="../482452/index.html">El sistema brasile√±o no es un mito. ¬øC√≥mo usarlo en TI?</a></li>
<li><a href="../482456/index.html">Nuestro FunCode, o c√≥mo realizamos un concurso para desarrolladores de iOS</a></li>
<li><a href="../482458/index.html">5 caracter√≠sticas de Python que no conoc√≠a, pero en vano</a></li>
<li><a href="../482460/index.html">Instrucciones de SQL: dibujar patrones escarchados en SQL</a></li>
<li><a href="../482464/index.html">¬øQu√© son * args y ** kwargs en Python?</a></li>
<li><a href="../482466/index.html">5 cosas que puedes hacer para prepararte para Vue 3.0</a></li>
<li><a href="../482468/index.html">5 extensiones y temas para VS Code que pueden cambiar la vida de un desarrollador front-end</a></li>
<li><a href="../482470/index.html">Carga r√°pida de p√°ginas en los tel√©fonos m√°s simples y baratos</a></li>
<li><a href="../482472/index.html">¬øDe qu√© est√° hecho JavaScript?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>