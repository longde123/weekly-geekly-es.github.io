<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôá üèÜ ‚ô•Ô∏è Blackjack e prote√ß√£o contra vazamento ü§Ωüèª üë©üèª‚Äçüé§ üë©‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sauda√ß√µes. Existe uma coisa - hydrolock \ neptune \ avkvastorozh - sistemas de fechamento de √°gua se ocorrer um vazamento n√£o controlado. O princ√≠pio ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Blackjack e prote√ß√£o contra vazamento</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/399459/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sauda√ß√µes. Existe uma coisa - hydrolock \ neptune \ avkvastorozh - sistemas de fechamento de √°gua se ocorrer um vazamento n√£o controlado. O princ√≠pio √© simples - um sensor de √°gua + automa√ß√£o + um par de torneiras el√©tricas. Mas o diabo, como sempre, est√° nos detalhes: como as torneiras s√£o arranjadas, como os sensores de vazamento s√£o arranjados e por que um custa 50 rublos e o outro custa 500 rublos. Um quilo de boletim de layout ser√° embrulhado em volta dessa coisa toda, a embalagem tirar√° seus olhos, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na hist√≥ria, vou percorrer os tijolos do sistema, que me guiaram na escolha. Todo o sistema √© constru√≠do com sensores de f√°brica e um controlador caseiro baseado no Particle (ex.Spark) Photon (como um esp8266 que possui um IDE na nuvem para cabeamento pronto), a base do dispositivo √© o controlador stm + m√≥dulo wifi da Broadcom. Tudo isso est√° vinculado a um servidor openhab no Orange Pi One.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/715/6ee/aa2/7156eeaa28b44479a5d5aff2e63ff89c.png" width="600"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que n√£o um sistema acabado? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Porque eu posso fazer isso sozinho e √© alto </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - a integra√ß√£o com sistemas externos √© ruim em sistemas prontos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Os sistemas prontos n√£o possuem fun√ß√µes auxiliares - levando em considera√ß√£o as leituras do medidor, sensores de temperatura da √°gua, notifica√ß√£o de falta de √°gua e outras fantasias er√≥ticas ao caminhar.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos come√ßar com guindastes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escolheu estupidamente na testa em termos de torque. Por algum tempo, ele viveu nos sub√∫rbios, onde a qualidade da √°gua (como provavelmente em todos os lugares de Zamkadye) deixa muito a desejar. Portanto, v√°lvulas de esfera de 1/2 polegada se voc√™ n√£o tocar no ano - √© muito dif√≠cil girar. E no toalheiro aquecido de 1 polegada, nem tento mov√™-lo - apenas se fortalecer o ombro com uma chave inglesa, mas aqui voc√™ pode arrancar algo. O problema est√° nos dep√≥sitos de madeira de c√°lcio, "cobertos de vegeta√ß√£o" com uma palavra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consequentemente, a escolha recaiu sobre a s√©rie profissional do hydrolock - 21N * m de torque n√£o parece uma tagarelice publicit√°ria, o guindaste √© simplesmente enorme - avalie o local de sua instala√ß√£o antes da compra. </font></font><br>
<br>
<img src="https://habrastorage.org/files/758/e07/18c/758e0718cc9a46e09306bac214db8cf1.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A torneira √© selada, um selo de borracha ao redor do per√≠metro, a entrada sob a prensa-parafuso. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retire a tampa.</font></font><br>
<br>
<img src="https://habrastorage.org/files/f9d/aa4/a25/f9daa4a251e140c3bbe4b049a5af7f46.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä nossa frente est√° o topo do quadro e o motor de passo. Tudo isso √© alimentado por 12 volts. Colocar o cabo de controle em aterramento coloca a v√°lvula na posi√ß√£o fechada. No quadro, vemos um simples controlador PIC 12f629. Viveu, o controlador na movimenta√ß√£o do guindaste. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O verso do quadro √© o mais interessante. </font></font><br>
<br>
<img src="https://habrastorage.org/files/c14/e08/f2e/c14e08f2e4224088a534e1811fa3729a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Driver shagovik L293 e fotoacoplador (emissor + fotodetector). Ela olha para a engrenagem principal da unidade, pintada em partes - branca e preta, fechada / aberta. </font></font><br>
<br>
<img src="https://habrastorage.org/files/a14/cec/177/a14cec1771ef4d52bc15c83e9183124e.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O guindaste gira o tempo todo em uma dire√ß√£o, a l√≥gica do controlador √© simples - torcemos o eixo at√© mudarmos para a cor desejada. A rota√ß√£o do guindaste em uma dire√ß√£o √© menos desgastante, e a maneira sem contato de determinar a posi√ß√£o tem menos probabilidade de causar azedo / mau funcionamento de um resistor ou reboque vari√°vel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para instala√ß√£o, voc√™ pode desaparafusar o guindaste da unidade - ele √© mantido em 2 porcas. H√° uma junta de isolamento t√©rmico entre a unidade e o guindaste. </font></font><br>
<br>
<img src="https://habrastorage.org/files/bf7/37c/1f7/bf737c1f7a144c72baba7a17fdc94615.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tive o reparo h√° um ano e meio atr√°s. O guindaste comprou h√° tr√™s anos - para desmontar, olhar para dentro, comprar mais e enrolar durante o reparo. Sim, agora ... o m√°ximo que eu consegui neste circo infernal era colocar um coletor de sujeira na montagem do abastecimento de √°gua com a perspectiva de substitu√≠-lo por um guindaste. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E s√≥ depois de um ano e meio - comprei um segundo guindaste e ferrou-o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, observamos um fen√¥meno estranho e raro (lido na voz de Drozdov) - todas as informa√ß√µes do site do fabricante foram confirmadas. Al√©m disso, a descri√ß√£o √© peculiar, como se os t√©cnicos escrevessem, e o marketing fosse regado para as pessoas, mas poucas ainda entendem todas as fichas. N√£o h√° se√ß√£o suficiente no site - para integradores com detalhes t√©cnicos. Mesmo √† custa do aumento de torque, eles n√£o estavam no in√≠cio - o guindaste no in√≠cio est√° batendo com um motor de 1,5 A e ap√≥s 2-3 segundos come√ßa a subir no modo normal (corrente 0,7 A). Demora cerca de 25 a 30 segundos para fechar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra experi√™ncia: √†s custas do torque - √© excessivo para o tempo de Moscou, aqui a √°gua √© bastante boa; durante um ano e meio em um filtro de 100 Œºm, h√° um par de impurezas e sem excesso de crescimento. </font><font style="vertical-align: inherit;">Voc√™ tem que pagar pelo grande torque com o pre√ßo, o hor√°rio de abertura e o local no arm√°rio. </font><font style="vertical-align: inherit;">Eu acho que haver√° unidades convencionais suficientes de Hydrolock Ultimate, Netuno ou Aquastorozh. </font><font style="vertical-align: inherit;">N√£o posso garantir os dois √∫ltimos - n√£o consegui entender, h√° cerca de 5 anos eles tinham engrenagens parcialmente pl√°sticas, agora parecem ter consertado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe tamb√©m uma v√°lvula hidrost√°tica Winner com conex√£o direta de sensores ao inversor - isto √©, se voc√™ n√£o precisar de tudo o que eu fiz. </font><font style="vertical-align: inherit;">L√°, a energia √© aut√¥noma a partir de 4 baterias e a base √© semelhante a uma unidade definitiva. </font><font style="vertical-align: inherit;">Em geral, tamb√©m √© potencialmente interessante para um controlador de fabrica√ß√£o pr√≥pria - s√£o 5 volts, voc√™ n√£o precisa cercar dois barramentos de 5 e 12 volts e pode jogar fora o isolamento √≥ptico.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensores de vazamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu comprei os sensores do mesmo contador WSU - universal. </font><font style="vertical-align: inherit;">Eles t√™m duas sa√≠das de ‚Äúcoletor aberto‚Äù, uma puxa para o ch√£o somente se houver √°gua e a segunda - se a √°gua entra, ela puxa para o ch√£o o tempo todo at√© que a energia seja cortada. </font><font style="vertical-align: inherit;">Eu uso apenas a primeira sa√≠da, o restante da l√≥gica est√° no controlador, mas parece que essa sa√≠da pode ser √∫til para mais alguns sistemas de despacho de condom√≠nio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os fios do kit est√£o a tr√™s metros em algum lugar. </font><font style="vertical-align: inherit;">A cor dos fios √© Ad_i_Israel. </font><font style="vertical-align: inherit;">Confira a cita√ß√£o:</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fio vermelho (marrom) (Vcc) alimentado de +5 a +30 volts. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fio preto (branco) (OUT2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fio verde (OUT1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fio amarelo (GND)</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° o que impediu fazer terra branca / preta? </font><font style="vertical-align: inherit;">A prop√≥sito, tamb√©m no acionamento do guindaste, os fios de cor com l√≥gica n√£o s√£o ale. </font><font style="vertical-align: inherit;">O primeiro sensor est√° na cozinha, embaixo da pia ao lado da m√°quina de lavar lou√ßa. </font></font><br>
<br>
<img src="https://habrastorage.org/files/2ea/407/a25/2ea407a255b8420e9b1d6c26772e2709.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo no banheiro em uma vala de drenagem especial. </font><font style="vertical-align: inherit;">Quando ele fez a mesa, ele n√£o a trouxe para a parede. </font><font style="vertical-align: inherit;">O resultado foi uma esp√©cie de reservat√≥rio para coletar √°gua do banheiro e do banheiro. </font></font><br>
<br>
<img src="https://habrastorage.org/files/51d/715/898/51d71589848d4a77a59f8caf0dbf2041.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por experi√™ncia operacional - j√° havia um alarme falso do sensor na m√°quina de lavar lou√ßa. </font><font style="vertical-align: inherit;">A julgar pelo log de um ciclo de polling (500ms), havia um circuito, modificado o c√≥digo - a mudan√ßa de estado agora ocorre com 10 valores id√™nticos consecutivos do sensor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os contatos do sensor s√£o banhados a ouro. </font><font style="vertical-align: inherit;">Um amigo tem sensores semelhantes h√° v√°rios anos, nenhuma oxida√ß√£o foi observada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensores de press√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Praticamente - show√¥metros. </font><font style="vertical-align: inherit;">Precis√£o + - 0,5 atm me convinha completamente. </font><font style="vertical-align: inherit;">Baseado nos sensores, um alerta de desligamento de √°gua √© fornecido. </font><font style="vertical-align: inherit;">Eu comprei no Ali </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensores de temperatura</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E por que n√£o adicionar? </font><font style="vertical-align: inherit;">De √∫til - ser√° capaz de informar uma vez por ano sobre o desligamento da √°gua quente. </font><font style="vertical-align: inherit;">Banal ds18b20 usado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contadores</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Itelma mais comum, uma vez a cada 10 litros faz contato. </font><font style="vertical-align: inherit;">No lado do controlador, a sa√≠da √© puxada para + 3,3v, o medidor a puxa para o ch√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controlador</font></font></h3><br>
<img src="https://habrastorage.org/files/318/4e6/d7a/3184e6d7ad9c4eab99d9962410c7918c.jpg"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dentro</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/a83/72d/117/a8372d1170ca43f8b92925fa76a240f8.jpg"><br>
<img src="https://habrastorage.org/files/f7b/e62/ee8/f7be62ee80a54ff2a0ed60ad17467a8b.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baseado no Particle Photon, mais detalhes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Eles t√™m uma vers√£o com um m√≥dulo 2G ou 3G (Electron). O primeiro firmware foi uma esc√≥ria completa, piscando com diodos OK, mas assim que voc√™ come√ßa salsichas complicadas em borracha, brincar com o i2c e interrompe pode perder o wifi. Agora voc√™ pode viver. Em princ√≠pio, voc√™ pode tirar os sensores de press√£o do circuito e agitar tudo no ESP8266 - v√° em frente. Primeiro, o f√≥ton precisa estar vinculado √† conta de part√≠culas (feita pelo aplicativo no celular ou pelo console Particle CLI - eu uso apenas o segundo m√©todo) e registrar uma rede wifi. Ap√≥s a liga√ß√£o, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na se√ß√£o do dispositivo aparece o controlador e seu status de conex√£o com a nuvem.</font></font><br>
<br>
<img src="https://habrastorage.org/files/71d/c17/687/71dc17687ccb4a289d0a0dd2296fdfca.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho todos os n√≥s conectados √† nuvem apenas para atualizar o firmware. </font><font style="vertical-align: inherit;">N√£o que eu fosse paran√≥ico - apenas trabalhar com a nuvem n√£o consome recursos ricos do controlador. </font><font style="vertical-align: inherit;">O IDE suporta o trabalho com bibliotecas, literalmente uma d√∫zia √© suportada pelo pr√≥prio contador, e o restante pela comunidade. </font><font style="vertical-align: inherit;">Na minha observa√ß√£o, tudo o que √© comum foi portado por um longo tempo, e outro recurso √© que o IDE sabe imediatamente quantos projetos usam a biblioteca.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo fonte do firmware</font></font></b><div class="spoiler_text"><pre><code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Adafruit_SSD1306/Adafruit_SSD1306.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MQTT/MQTT.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"OneWire/OneWire.h"</span></span></span></span><font></font>
<font></font>
SYSTEM_THREAD(ENABLED);<font></font>
SYSTEM_MODE(MANUAL);<font></font>
STARTUP(WiFi.selectAntenna(ANT_EXTERNAL));<font></font>
STARTUP(System.enableFeature(FEATURE_RETAINED_MEMORY));<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">valve_struct</span></span></span><span class="hljs-class"> {</span></span><font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> currentMillis = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_conected = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_wifi_uptime = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_counter_read = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> wifi_uptime;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> read_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
byte display_timeout = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//temp onewire </span></span><font></font>
OneWire ds0 = OneWire(D2);<font></font>
OneWire ds1 = OneWire(D3);<font></font>
byte addr0[<span class="hljs-number"><span class="hljs-number">8</span></span>];<font></font>
byte addr1[<span class="hljs-number"><span class="hljs-number">8</span></span>];
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense0 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense1 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
byte data[<span class="hljs-number"><span class="hljs-number">12</span></span>];<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OLED_RESET A7</span></span>
<span class="hljs-function"><span class="hljs-function">Adafruit_SSD1306 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">display</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OLED_RESET)</span></span></span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//valve control</span></span>
retained valve_struct valve[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, D4}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, D5} };<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//counter control</span></span>
retained counter_struct counter[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A0}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A1} };
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pressure[<span class="hljs-number"><span class="hljs-number">2</span></span>] = {A2, A3};
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SENSOR_TIMEOUT 10</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> sensor_struct sensor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D6}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D7} };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span></span>;<font></font>
<font></font>
byte server[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span>};
<span class="hljs-function"><span class="hljs-function">MQTT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(server, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1883</span></span></span></span><span class="hljs-function"><span class="hljs-params">, callback)</span></span></span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)p, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(p), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf_d[<span class="hljs-number"><span class="hljs-number">12</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf_d,<span class="hljs-string"><span class="hljs-string">"%d"</span></span>,p);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)buf_d, n, retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-comment"><span class="hljs-comment">//char buf_f[18];</span></span>
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;
<span class="hljs-comment"><span class="hljs-comment">//    dtostrf(p, 9, 4, buf_f);</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//int n = sprintf(buf_f,"%f",p);</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)s.c_str(), s.length(), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// recieve message</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> p[length + <span class="hljs-number"><span class="hljs-number">1</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, payload, length);<font></font>
    p[length] = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p)</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(topic)</span></span></span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.equals(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"1"</span></span>))<font></font>
        {<font></font>
            Particle.connect();<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(Particle.connected, <span class="hljs-number"><span class="hljs-number">10000</span></span>)) <font></font>
                {publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
                {Particle.disconnect(); publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            Particle.disconnect();<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m = message.toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            set_valve(x, m);<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>),  valve[x].state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> m = message.toFloat();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt;= <span class="hljs-number"><span class="hljs-number">999999</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            counter[x].value = m;<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>),  counter[x].value , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
<span class="hljs-comment"><span class="hljs-comment">//Serial.begin(9600);</span></span><font></font>
    WiFi.on();<font></font>
    WiFi.connect();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(WiFi.ready, <span class="hljs-number"><span class="hljs-number">5000</span></span>)) {mqtt_connect();}
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
    {<font></font>
        pinMode(valve[i].pin, OUTPUT);<font></font>
        digitalWrite(valve[i].pin, valve[i].state);<font></font>
        pinMode(counter[i].pin, INPUT);<font></font>
        pinMode(sensor[i].pin, INPUT);<font></font>
        counter[i].state = digitalRead(counter[i].pin);<font></font>
        pinMode(pressure[i], AN_INPUT);<font></font>
    }<font></font>
    pinMode(A4, INPUT_PULLUP);<font></font>
<font></font>
    display.begin(SSD1306_SWITCHCAPVCC, <span class="hljs-number"><span class="hljs-number">0x3C</span></span>);  <span class="hljs-comment"><span class="hljs-comment">// initialize with the I2C addr 0x3C (for the 128x64)</span></span>
    display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.connect();</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> 
</span></span>{<font></font>
    currentMillis = millis();<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//       MQTT </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_conected &gt;= <span class="hljs-number"><span class="hljs-number">30000</span></span> || previous_conected &gt; currentMillis)<font></font>
    {<font></font>
        previous_conected = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.isConnected() &amp; wifi_uptime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>)<font></font>
        {<font></font>
            mqtt_connect();<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/rssi"</span></span>, WiFi.RSSI(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_wifi_uptime &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> || previous_wifi_uptime &gt; currentMillis)<font></font>
    {<font></font>
        previous_wifi_uptime = currentMillis;<font></font>
        WiFi.ready() ? wifi_uptime++ : wifi_uptime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        <span class="hljs-comment"><span class="hljs-comment">//work with button and display</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fg = digitalRead(A4);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            display_timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            { <font></font>
                display.clearDisplay();<font></font>
                display.display();<font></font>
            } <font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fg == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
            {<font></font>
                display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span>
                display.setTextSize(<span class="hljs-number"><span class="hljs-number">2</span></span>);<font></font>
                display.setTextColor(WHITE);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"C="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">0</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"H="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">1</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Valve="</span></span>);<font></font>
                display.print(valve[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(valve[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Sensor="</span></span>);<font></font>
                display.print(sensor[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(sensor[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.display();<font></font>
            }<font></font>
            display_timeout = <span class="hljs-number"><span class="hljs-number">10</span></span>;<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//counter check</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_counter_read &gt;= <span class="hljs-number"><span class="hljs-number">500</span></span> || previous_counter_read &gt; currentMillis)<font></font>
    {<font></font>
        previous_counter_read = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
        {<font></font>
            byte count_state = digitalRead(counter[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state != counter[i].state)<font></font>
            {<font></font>
                counter[i].state = count_state;<font></font>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    counter[i].value += <span class="hljs-number"><span class="hljs-number">0.01</span></span>;
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , counter[i].value, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-comment"><span class="hljs-comment">//    </span></span><font></font>
            byte sensor_state = digitalRead(sensor[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor_state != sensor[i].state) <span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
            {<font></font>
                sensor[i].state = sensor_state;<font></font>
                sensor[i].timeout = SENSOR_TIMEOUT; <font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            {<font></font>
                sensor[i].timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/sensor/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , sensor[i].state, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].state  == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                    {<font></font>
                        set_valve(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span>
                        set_valve(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span><font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// temp onewire</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - start_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">299000</span></span> || start_temp_timer &gt; currentMillis)<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        start_temp_timer = currentMillis;<font></font>
        presense0 = start_temp0();<font></font>
        presense1 = start_temp1();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - read_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">300000</span></span> || read_temp_timer &gt; currentMillis)<font></font>
    {<span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        read_temp_timer = currentMillis;<font></font>
        start_temp_timer = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense0) read_temp0();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense1) read_temp1();
        <span class="hljs-comment"><span class="hljs-comment">//preasure calc and send</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; 
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++)<font></font>
        {<font></font>
            <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/pressure/%d"</span></span>, i);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> read_val = analogRead(pressure[i]);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value = (read_val - <span class="hljs-number"><span class="hljs-number">600.0</span></span>) / <span class="hljs-number"><span class="hljs-number">300.0</span></span> ;<font></font>
            publish_message(buf18 , value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.process();</span></span><font></font>
    client.loop();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(<span class="hljs-string"><span class="hljs-string">"water_count"</span></span>))<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">//  spark    </span></span>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>);<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, Particle.connected() ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);<font></font>
        <font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds0.search(addr0)) { ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr0, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr0[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds1.search(addr1)) { ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr1, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr1[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds0.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/0"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds1.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/1"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_valve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vlv, byte state)</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    valve[vlv].state = state;<font></font>
    digitalWrite(valve[vlv].pin, state);<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf26[<span class="hljs-number"><span class="hljs-number">26</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf26,<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/%d"</span></span>, vlv);<font></font>
    publish_message(buf26 , state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atrav√©s do MQTT, nos conectamos ao broker. </font><font style="vertical-align: inherit;">Monitore os sensores e o capacete nos ramos correspondentes dos eventos e valores mqtt. </font><font style="vertical-align: inherit;">Por exemplo, home / water_count / valve / 0 - uma unidade de √°gua. </font><font style="vertical-align: inherit;">home / n√∫mero_de_√°gua / contador / 0 - leituras do contador de √°gua fria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assinamos os comandos para alterar o estado do inversor e definir o valor atual do contador (√°gua fria e quente):</font></font><br>
<br>
<pre><code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° um bot√£o no dispositivo - pressionando, ligamos a tela, desenhamos as leituras atuais de contadores, sensores e toques. Tela OLED, desaparecer rapidamente se ligado o tempo todo.</font></font><br>
<br>
<pre><code class="hljs lisp">STARTUP(<span class="hljs-name"><span class="hljs-name">System</span></span>.enableFeature(<span class="hljs-name"><span class="hljs-name">FEATURE_RETAINED_MEMORY</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um recurso interessante de hardware e software do controlador stm, na part√≠cula de refer√™ncia que eles chamam de BackupSRAM. O Photon possui uma sa√≠da vbat - isso n√£o √© energia da bateria ou carregamento. Enquanto houver tens√£o nesta perna, o conte√∫do de 4k bytes de SRAM √© mantido com o controlador completamente desenergizado. Isso elimina o problema de desgaste na EEPROM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No c√≥digo, as vari√°veis ‚Äã‚Äãque devem ser direcionadas para esta mem√≥ria s√£o declaradas com a indica√ß√£o: retidas. Eu implementei o hardware do supercapacitor em 1.5F. De acordo com a ficha t√©cnica, a mem√≥ria morrer√° em 1,6v, de acordo com meus experimentos de bancada na placa proto que ocorrer√° em 2 semanas com aproximadamente o meu capacitor. A l√≥gica de fechar os guindastes quando os sensores s√£o acionados √© "aut√¥noma" e n√£o depende da conex√£o com o openhab. H√° um interruptor de tr√™s vias para controle direto da unidade - autom√°tico, OFF (torneiras abertas), Fechar (fechar).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O diagrama de circuito abaixo: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a8/f4c/63d/1a8f4c63dba34f4e9905b703fabad0fd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O projeto Eagle, juntamente com as bibliotecas personalizadas, pode ser baixado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A taxa foi feita LUT, nas faixas n√£o encolheram.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melhor amigo de banho de √°gua LUT</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/351/e37/1c3/351e371c3caf487d9f14f839f89402be.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fonte de alimenta√ß√£o. </font><font style="vertical-align: inherit;">Precisamos de 12 e 5 volts. </font><font style="vertical-align: inherit;">O doador √© procurado no ebay pela linha: "adaptador de energia do disco r√≠gido 5v 12v", como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habita√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi impresso com pl√°stico PLA em uma impressora 3D (Tarantula Tevo). </font><font style="vertical-align: inherit;">Bico 0,4 mm, camada 0,25 mm. </font><font style="vertical-align: inherit;">A tampa √© ao mesmo tempo e a base para a montagem da placa controladora. </font><font style="vertical-align: inherit;">A base com a fonte de alimenta√ß√£o est√° conectada √† parede. </font><font style="vertical-align: inherit;">A base com a tampa n√£o √© presa com parafusos, h√° tens√£o suficiente na tampa (como a tampa da av√≥ em frascos de geleia) e a estrutura em camadas das paredes funciona. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modelo 3D no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/945/110/37d/94511037d3734ad1a573e84e5fc426ef.png"><br>
<br>
<img src="https://habrastorage.org/files/5aa/546/c0b/5aa546c0b6dd41d58fd6b33bde08df74.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veja como tudo parece montado em um cano de √°gua.</font></font><br>
<br>
<img src="https://habrastorage.org/files/cfb/293/f66/cfb293f66c3f4bb9ad2f46e812418918.jpg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implantado no Orange Pi One sob o Armbian.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do item</font></font></b><div class="spoiler_text"><pre><code class="hljs julia">  -    ,  .
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp1	<span class="hljs-string"><span class="hljs-string">"T cool [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp2	<span class="hljs-string"><span class="hljs-string">"T hot [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp2:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count0	<span class="hljs-string"><span class="hljs-string">"Count cool [%.2f ¬≥]"</span></span>					(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count1	<span class="hljs-string"><span class="hljs-string">"Count hot [%.2f ¬≥]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure0	<span class="hljs-string"><span class="hljs-string">"P cool [%.2f .]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure1	<span class="hljs-string"><span class="hljs-string">"P hot [%.2f .]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor0	<span class="hljs-string"><span class="hljs-string">"Sensor0 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor1	<span class="hljs-string"><span class="hljs-string">"Sensor1 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve0	<span class="hljs-string"><span class="hljs-string">"Valve cool"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/0:state:default], &gt;[mqtt_bro:home/water_count/valve/0/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve1	<span class="hljs-string"><span class="hljs-string">"Valve hot"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/1:state:default], &gt;[mqtt_bro:home/water_count/valve/1/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>	watercount_sendStr <span class="hljs-string"><span class="hljs-string">"LastVol:[%s]"</span></span>						(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendCool <span class="hljs-string"><span class="hljs-string">"Send cool [%.2f ¬≥]"</span></span>		(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendHot <span class="hljs-string"><span class="hljs-string">"Send hot [%.2f ¬≥]"</span></span>			(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendSwitch <span class="hljs-string"><span class="hljs-string">"Autosend"</span></span> 	(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_rssi	<span class="hljs-string"><span class="hljs-string">"WaterCount [%d dB]"</span></span>	(gSpark_RSSI)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/rssi:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_spark_state	<span class="hljs-string"><span class="hljs-string">"WaterCount Spark"</span></span>		(gSpark)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/spark:state:default], &gt;[mqtt_bro:home/water_count/spark/set:command:*:default]"</span></span> }</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma pequena regra de transforma√ß√£o √© necess√°ria para o sensor de vazamento.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transforma√ß√£o de configura√ß√µes</font></font></b><div class="spoiler_text"><b>transform\water_sensor.map </b><br>
1=dry<br>
0=wet<br>
undefined=undefined<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formamos a p√°gina para gerenciamento:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura o Sitemap</font></font></b><div class="spoiler_text"><b>Sitemap</b><br>
Text label=¬´¬ª icon=¬´water¬ª <br>
 {<br>
 Frame <br>
 {<br>
 Text item=watercount_temp1<br>
 Text item=watercount_count0<br>
 Text item=watercount_pressure0<br>
 Switch item=watercount_valve0 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_temp2<br>
 Text item=watercount_count1<br>
 Text item=watercount_pressure1<br>
 Switch item=watercount_valve1 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_sensor0<br>
 Text item=watercount_sensor1 <br>
 }<br>
 Frame <br>
 {<br>
 Switch item=watercount_sendSwitch mappings=[0=¬´OFF¬ª, 1=¬´ON¬ª]<br>
 Text item=watercount_sendStr<br>
 Text item=watercount_sendCool<br>
 Text item=watercount_sendHot<br>
 }<br>
 } <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E regras de processamento:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura regras</font></font></b><div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
	<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_temp2"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_temp2 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_temp2.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">37</span></span> )<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot water temp drop to %s", watercount_temp2.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure drop to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure rise to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure drop to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure rise to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Generate send string counters" //every <span class="hljs-number"><span class="hljs-number">24</span></span> day <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mounth  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">00.01</span></span> minutes
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 1 24 1/1 ?" 
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span><font></font>
		<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaCool = (watercount_count0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaHot = (watercount_count1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deltaCool &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; deltaHot &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{<font></font>
			watercount_sendStr.postUpdate(String::format(" %.2f / %.2f 3", deltaCool, deltaHot))<font></font>
			watercount_sendCool.state = watercount_count0.state<font></font>
			watercount_sendHot.state = watercount_count1.state<font></font>
			sendTelegram("****_bot", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3. %s", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), watercount_sendStr.state.toString()))<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			watercount_sendSwitch.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Current counters value less than sended last time. Turn off autosend.")<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Send string counters" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 23 24 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_sendSwitch.state == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendMail("uk@uk.ru", " 23,  5, . 23", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()));<font></font>
			sendTelegram("****_bot", "Send email with watercount values");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't send email with watercount values - autosend is OFF.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Rotate valves" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 05 25 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_valve0.state == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watercount_valve1.state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{	<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Valves was rotated.");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't rotate valves, it's closed.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para enviar mensagens, n√£o uso a funcionalidade interna do aplicativo android openhab, nem integro a nuvem deles. </font><font style="vertical-align: inherit;">Eu gosto do bot do Telegram. </font><font style="vertical-align: inherit;">Como configurar e conectar o bot pode ser visto no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para enviar cartas da caixa de correio do Gmail, se voc√™ tiver autentica√ß√£o de dois fatores, ser√° necess√°rio habilitar uma senha de uso √∫nico para o aplicativo de email e definir essa senha na configura√ß√£o do openhab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Siga as regras. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verifique watercount_sensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o controlador envia novos valores de sensor de vazamento somente quando o valor √© alterado ou se houve um alarme falso (menos de 10 ciclos). Analisamos o significado hist√≥rico e hist√≥rico, formamos mensagens informativas. H√° uma nuance - uma tentativa de obter prevoiusItem constantemente fornece o valor atual, n√£o encontrei uma solu√ß√£o - tomo o valor "-3 seg", se algu√©m o superou, anote-o nos coment√°rios ou no PM. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verifique watercount_temp2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - verifique se menos de 37, o que significa que a √°gua quente ficou fria; voc√™ deve ligar o aquecedor de fluxo na chegada. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verifique watercount_pressure</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - analisamos o valor atual e o anterior, respondemos com uma mensagem a uma queda abaixo de 1 atm e crescimento acima dele. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gere contadores de string de envio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- come√ßa no cron no dia 24 de cada m√™s √†s 13 horas da manh√£. Verificamos que os valores agora s√£o maiores que os enviados da √∫ltima vez. Se menor, desative o envio autom√°tico e gere um alerta. Se estiver bem - lembramos os valores dos contadores para enviar ao C√≥digo Penal, enviamos o corpo da mensagem futura para o telegrama. Ao mesmo tempo, economizamos em watercount_sendStr quanto consumimos no m√™s passado. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerar contadores de string de envio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - inicia no cron no 24¬∫ dia √†s 23h00. Verifica se o envio autom√°tico est√° ativado, se est√° ativado - o capacete envia contadores para o correio da transportadora. Acontece que eu tenho o 24¬∫ dia o dia todo, algo para corrigir ou simplesmente reduzir o envio autom√°tico, se ocorrer um erro nos telegramas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualize por coment√°rio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rodar v√°lvulas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- A regra para fechar / abrir a torneira uma vez por m√™s contra a fervura. </font><font style="vertical-align: inherit;">Dia 25 √†s 5h - para n√£o entrar no trabalho da m√°quina de lavar lou√ßa ou da m√°quina de lavar, mas mesmo que chegue l√° - n√£o √© cr√≠tico, a sobreposi√ß√£o de √°gua ser√° de cerca de 3-4 segundos. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E somente aqui come√ßa a casa inteligente ... A</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
combina√ß√£o de sistemas em um √∫nico ponto (openhab) permite criar uma l√≥gica que n√£o est√° dispon√≠vel para um conjunto de sistemas aut√¥nomos. </font><font style="vertical-align: inherit;">Por exemplo: chegou um evento de aumento no hidr√¥metro - o sistema de seguran√ßa est√° ativo, as travas da porta da frente est√£o fechadas, o consumo de energia da m√°quina de lavar lou√ßa e da lavadora de roupas √© inferior a 5 watts - o que significa que um vazamento pelos sensores √© detectado. </font><font style="vertical-align: inherit;">Formamos um comando para fechar os guindastes, enviar uma mensagem para o bot no Telegram. </font><font style="vertical-align: inherit;">Mas isso √© como um fio depois.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt399459/">https://habr.com/ru/post/pt399459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt399449/index.html">O DNA tem apenas metade do tamanho dos cromossomos. Tudo o resto √© uma concha de funcionalidade desconhecida</a></li>
<li><a href="../pt399451/index.html">Por que n√£o temos lembran√ßas infantis</a></li>
<li><a href="../pt399453/index.html">Cinco formas de dinheiro blockchain dispon√≠veis agora</a></li>
<li><a href="../pt399455/index.html">N√£o apenas eletrodom√©sticos: o que mais h√° no Audiomania para amantes de m√∫sica, amantes e m√∫sicos</a></li>
<li><a href="../pt399457/index.html">Russian FinTech Meetup # 2: Negocia√ß√£o na era digital</a></li>
<li><a href="../pt399461/index.html">A intelig√™ncia artificial ajudar√° as pessoas a se livrarem de fobias e medos</a></li>
<li><a href="../pt399463/index.html">Multicopter aprendeu a sentar no teto de carros em movimento</a></li>
<li><a href="../pt399469/index.html">Rede neural Pix2pix colore realisticamente desenhos a l√°pis e fotos em preto e branco</a></li>
<li><a href="../pt399471/index.html">Habita√ß√µes espaciais, parte 5: como viveremos em Merc√∫rio (ou n√£o)</a></li>
<li><a href="../pt399473/index.html">Chip Intel 4004 completou 45 anos. Um pouco da hist√≥ria de TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>