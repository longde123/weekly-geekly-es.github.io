<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤹🏼 🛐 🤭 Pergi yang luar biasa 🧚🏿 😎 🕐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Konsep desain penanganan kesalahan baru di Go 2 baru-baru ini telah diterbitkan. Sangat menyenangkan bahwa bahasa tidak berdiri di satu tempat - berke...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pergi yang luar biasa</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425145/"><p>  Konsep desain penanganan kesalahan baru di Go 2 baru-baru ini telah diterbitkan. Sangat menyenangkan bahwa bahasa tidak berdiri di satu tempat - berkembang dan setiap tahun tumbuh lebih cantik. </p><br><p>  Hanya sekarang, sementara Go 2 hanya terlihat di cakrawala, sangat menyakitkan dan sedih untuk menunggu.  Karena itu, kami menangani masalah kami sendiri.  Sedikit pembuatan kode, sedikit kerja dengan ast, dan dengan sedikit gerakan tangan, panik berubah, panik berubah ... menjadi pengecualian elegan! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0u/sd/fx/0usdfxkuqp9qtfe9biignfxdzxo.jpeg"></div><a name="habracut"></a><br><blockquote> Dan segera saya ingin membuat pernyataan yang sangat penting dan sangat serius. <br>  Keputusan ini bersifat menghibur dan pedagogis <em>secara eksklusif</em> . <br>  Maksud saya hanya 4 kesenangan.  Ini umumnya merupakan bukti konsep, dalam kebenaran.  Saya peringatkan :) </blockquote><br><h2 id="tak-chto-zhe-vyshlo">  Jadi apa yang terjadi? </h2><br><p>  Hasilnya adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">generator kode perpustakaan</a> kecil seperti itu.  Dan pembuat kode, seperti semua orang tahu, membawa kebaikan dan keanggunan di dalam diri mereka.  Sebenarnya tidak, tetapi di dunia Go mereka cukup populer. </p><br><p> Kami mengatur generator kode seperti itu di go-raw.  Dia mem-parsingnya untuk bantuan modul standar <code>go/ast</code> fungsi, melakukan beberapa <del>  tidak </del>  transformasi licik, hasilnya ditulis di sebelah file, menambahkan akhiran <code>_jex.go</code> .  File yang dihasilkan ingin runtime kecil berfungsi. </p><br><p>  Dengan cara sederhana ini, kami menambahkan pengecualian ke Go. </p><br><h2 id="polzuem">  Kami menggunakan </h2><br><p>  Kami menghubungkan generator ke file, di header (sebelum <code>package</code> ) kami menulis </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//+build jex //go:generate jex</span></span></code> </pre> <br><p>  Jika Anda sekarang menjalankan perintah <code>go generate -tags jex</code> , utilitas <code>jex</code> akan dieksekusi.  Dia mengambil nama file dari <code>os.Getenv("GOFILE")</code> , memakannya, mencernanya dan menulis <code>{file}_jex.go</code> .  File baru lahir sudah memiliki <code>//+build !jex</code> di header (tag dibalik), jadi <code>go build</code> , dan di kompartemen dengannya, perintah lain, seperti <code>go test</code> atau <code>go install</code> , hanya memperhitungkan file <em>baru yang</em> benar.  Lepota ... </p><br><p>  Sekarang dot-import <code>github.com/anjensan/jex</code> . <br>  Ya, sementara impor melalui suatu titik adalah wajib.  Di masa depan direncanakan untuk pergi sama saja. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> . <span class="hljs-string"><span class="hljs-string">"github.com/anjensan/jex"</span></span></code> </pre> <br><p>  Hebat, sekarang Anda dapat memasukkan panggilan ke fungsi rintisan. <code>TRY</code> , <code>THROW</code> , <code>EX</code> dalam kode.  Untuk semua ini, kode tersebut tetap valid secara sintaksis, dan bahkan dikompilasi dalam bentuk yang tidak diproses (tidak berfungsi), jadi pelengkapan otomatis tersedia dan linter <em>tidak benar-benar</em> bersumpah.  Editor juga akan menunjukkan dokumentasi untuk fungsi-fungsi ini, jika saja mereka punya satu. </p><br><p>  Lempar pengecualian </p><br><pre> <code class="go hljs">THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"error name"</span></span>))</code> </pre> <br><p>  Tangkap pengecualian </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { <span class="hljs-comment"><span class="hljs-comment">//   } else { fmt.Println(EX()) }</span></span></code> </pre> <br><p>  Fungsi anonim dihasilkan di bawah tenda.  Dan di dalamnya <code>defer</code> .  Dan itu memiliki satu fungsi lagi.  Dan di dalamnya <code>recover</code> ... Yah, masih ada sedikit ast-magic untuk menangani <code>return</code> dan <code>defer</code> . </p><br><p>  Dan ya, omong-omong, mereka didukung! </p><br><p>  Selain itu, ada <code>ERR</code> variabel makro khusus.  Jika Anda menetapkan kesalahan, pengecualian dilemparkan.  Lebih mudah memanggil fungsi yang masih mengembalikan <code>error</code> dengan cara lama </p><br><pre> <code class="go hljs">file, ERR := os.Open(filename)</code> </pre> <br><p>  Selain itu, ada beberapa tas utilitas kecil <code>ex</code> dan <code>must</code> , tetapi tidak ada banyak yang perlu dibicarakan. </p><br><h2 id="primery">  Contohnya </h2><br><p>  Berikut adalah contoh kode Go yang benar dan idiomatis </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(src, dst </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { r, err := os.Open(src) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> r.Close() w, err := os.Create(dst) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err := io.Copy(w, r); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.Close() os.Remove(dst) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := w.Close(); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { os.Remove(dst) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } }</code> </pre> <br><p>  Kode ini tidak begitu bagus dan elegan.  Ngomong-ngomong, ini bukan hanya pendapatku! <br>  Tapi <code>jex</code> akan membantu kita meningkatkannya. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFile_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(src, dst </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> ex.Logf(<span class="hljs-string"><span class="hljs-string">"copy %s %s"</span></span>, src, dst) r, ERR := os.Open(src) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> r.Close() w, ERR := os.Create(dst) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { ERR := io.Copy(w, r) ERR := w.Close() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { w.Close() os.Remove(dst) THROW() } }</code> </pre> <br><p>  Tapi misalnya, program berikut </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { hex, err := ioutil.ReadAll(os.Stdin) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } data, err := parseHexdump(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(hex)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } os.Stdout.Write(data) }</code> </pre> <br><p>  dapat ditulis ulang sebagai </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { hex, ERR := ioutil.ReadAll(os.Stdin) data, ERR := parseHexdump(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(hex)) os.Stdout.Write(data) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { log.Fatal(EX()) } }</code> </pre> <br><p>  Berikut adalah contoh lain untuk merasakan ide yang diusulkan lebih baik.  Kode asli </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { x, err := strconv.Atoi(a) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } y, err := strconv.Atoi(b) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } fmt.Println(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>, x + y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  dapat ditulis ulang sebagai </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printSum_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { x, ERR := strconv.Atoi(a) y, ERR := strconv.Atoi(b) fmt.Println(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>, x + y) }</code> </pre> <br><p>  atau bahkan itu </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printSum_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>, must.Int_(strconv.Atoi(a)) + must.Int_(strconv.Atoi(b))) }</code> </pre> <br><h2 id="isklyuchenie">  Pengecualian </h2><br><p>  Intinya adalah struktur pembungkus sederhana di atas contoh <code>error</code> . </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> exception <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,   err error //  ^W , ,    log []interface{} //      ,    suppress []*exception }</span></span></code> </pre> <br><p>  Poin penting adalah bahwa serangan panik biasa tidak dianggap sebagai pengecualian.  Jadi, semua kesalahan standar seperti <code>runtime.TypeAssertionError</code> tidak terkecuali.  Ini sejalan dengan praktik terbaik yang diterima di Go - jika kita memiliki, katakanlah, nihil-dereferensi, maka kita membatalkan seluruh proses dengan riang dan riang.  Dapat diandalkan dan dapat diprediksi.  Meskipun saya tidak yakin, mungkin ada baiknya meninjau momen ini dan menangkap kesalahan seperti itu.  Mungkin opsional? </p><br><p>  Dan di sini adalah contoh rantai pengecualian </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">one_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"one"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">two_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"two"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">three</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { one_() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { two_() } }</code> </pre> <br><p>  Di sini kita dengan tenang menangani satu pengecualian, karena tiba-tiba bam ... dan <code>two</code> pengecualian dilemparkan.  Jadi, sumber yang <code>one</code> <code>suppress</code> melampirkannya di bidang <code>suppress</code> .  Tidak ada yang akan hilang, semuanya akan masuk ke log.  Oleh karena itu, tidak ada kebutuhan khusus untuk mendorong seluruh rantai kesalahan langsung ke teks pesan menggunakan pola <code>fmt.Errorf("blabla: %v", err)</code> sangat populer <code>fmt.Errorf("blabla: %v", err)</code> .  Meskipun tidak seorang pun, tentu saja, tidak melarang penggunaannya di sini, jika Anda benar-benar menginginkannya. </p><br><h2 id="kogda-zabyli-otlovit">  Saat lupa menangkap </h2><br><p>  Ah, poin lain yang sangat penting.  Untuk meningkatkan keterbacaan, ada pemeriksaan tambahan: jika suatu fungsi dapat melempar pengecualian, maka namanya harus diakhiri dengan <code>_</code> .  Nama yang sengaja dibengkokkan yang akan memberi tahu programmer, "Tuan, di sini di program Anda ada yang tidak beres, harap berhati-hati dan rajin!" </p><br><p>  Pemeriksaan secara otomatis mulai untuk file yang diubah, ditambah itu juga dapat dimulai secara manual dalam proyek menggunakan perintah <code>jex-check</code> .  Mungkin masuk akal untuk menjalankannya sebagai bagian dari proses pembangunan bersama dengan linter lainnya. </p><br><p>  Pengecekan komentar <code>//jex:nocheck</code> .  Omong-omong, ini adalah satu-satunya cara untuk membuang pengecualian dari fungsi anonim. </p><br><p>  Tentu saja, ini bukan obat mujarab untuk semua masalah.  Pemeriksa akan melewatkan ini </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bad_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"ups"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { f := bad_ f() }</code> </pre> <br><p>  Di sisi lain, itu tidak jauh lebih buruk daripada pemeriksaan standar untuk <code>err declared and not used</code> , yang sangat mudah untuk dihindari. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { a, err := foo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } b, err := bar() <span class="hljs-comment"><span class="hljs-comment">//  ,    ok... go vet, ? }</span></span></code> </pre> <br><p>  Secara umum, pertanyaan ini agak filosofis, apa yang lebih baik untuk dilakukan ketika Anda lupa memproses kesalahan - diam-diam mengabaikannya, atau membuang kepanikan ... Ngomong-ngomong, hasil terbaik dari tes dapat dicapai dengan menerapkan dukungan pengecualian di kompiler, tetapi ini jauh di luar cakupan artikel ini . </p><br><p>  Beberapa orang mungkin mengatakan bahwa, meskipun ini adalah solusi yang luar biasa, itu bukan lagi pengecualian, karena sekarang pengecualian berarti implementasi yang sangat spesifik.  Nah, di sana, karena tumpukan jejak tidak melekat pada pengecualian, atau ada linter terpisah untuk memeriksa nama fungsi, atau bahwa fungsi dapat diakhiri dengan <code>_</code> tetapi tidak membuang pengecualian, atau tidak ada dukungan langsung dalam sintaks, atau bahwa itu benar-benar panik, dan kepanikan bukan pengecualian sama sekali, karena gladiol ... Spora bisa sepanas tidak berharga dan tidak ada gunanya.  Oleh karena itu, saya akan meninggalkan mereka di belakang papan artikel, dan saya akan terus memanggil solusi yang dijelaskan secara tidak selektif yang disebut "pengecualian." </p><br><h2 id="po-povodu-stektreysov">  Tentang stackraces </h2><br><p>  Seringkali pengembang, untuk menyederhanakan debugging, menempel jejak stack untuk implementasi <code>error</code> kustom.  Bahkan ada beberapa perpustakaan populer untuk ini.  Tetapi, untungnya, dengan pengecualian, ini tidak memerlukan tindakan tambahan karena satu fitur menarik dari Go - selama panik, blok <code>defer</code> dieksekusi dalam konteks tumpukan kode yang melemparkan panik.  Karena itu di sini </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"ups"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { foo_() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { debug.PrintStack() } }</code> </pre> <br><p>  Jejak tumpukan lengkap akan dicetak, meskipun sedikit verbose (saya memotong nama file) </p><br><pre> <code class="go hljs"> runtime/debug.Stack runtime/debug.PrintStack main.bar.func2 github.com/anjensan/jex/runtime.TryCatch.func1 <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span> main.foo_ main.bar.func1 github.com/anjensan/jex/runtime.TryCatch main.bar main.main</code> </pre> <br><p>  Tidak ada salahnya membuat helper Anda sendiri untuk memformat / mencetak jejak stack, dengan mempertimbangkan fungsi pengganti, menyembunyikannya agar mudah dibaca.  Saya pikir ide yang bagus, tulis di. </p><br><p>  Atau Anda dapat mengambil tumpukan dan melampirkannya ke pengecualian menggunakan <code>ex.Log()</code> .  Kemudian, pengecualian seperti itu diizinkan untuk ditransfer ke horoutin lain - strextraces tidak hilang. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foobar_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { e := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> error, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> <span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(e) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { checkZero_() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { EX().Log(debug.Stack()) <span class="hljs-comment"><span class="hljs-comment">//   e &lt;- EX().Wrap() //     } }() ex.Must_(&lt;-e) //  ,  ,  }</span></span></code> </pre> <br><h2 id="k-sozhaleniyu">  Sayangnya </h2><br><p>  Eh ... tentu saja, sesuatu seperti itu akan terlihat jauh lebih baik </p><br><pre> <code class="go hljs"> try { throw io.EOF, <span class="hljs-string"><span class="hljs-string">"some comment"</span></span> } catch e { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"exception: %v"</span></span>, e) }</code> </pre> <br><p>  Tapi sayangnya, ah, sintaksis Go tidak dapat diperluas. <br>  [serius] Meskipun, mungkin, ini menjadi lebih baik ... </p><br><p>  Bagaimanapun, Anda harus memutarbalikkan.  Salah satu ide alternatif adalah membuat </p><br><pre> <code class="go hljs"> TRY; { THROW(io.EOF, <span class="hljs-string"><span class="hljs-string">"some comment"</span></span>) }; CATCH; { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"exception: %v"</span></span>, EX) }</code> </pre> <br><p>  Tapi kode seperti itu terlihat agak bodoh setelah <code>go fmt</code> .  Dan kompiler bersumpah ketika melihat <code>return</code> di kedua cabang.  Tidak ada masalah dengan <code>if-TRY</code> . </p><br><p>  Akan lebih keren untuk mengganti <code>ERR</code> macro dengan fungsi <code>MUST</code> (lebih baik dari sekadar).  Untuk menulis </p><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MUST(strconv.Atoi(a)) + MUST(strconv.Atoi(b))</code> </pre> <br><p>  Pada prinsipnya, ini masih layak, ketika menganalisis Anda, Anda dapat memperoleh jenis ekspresi, karena semua jenis jenis menghasilkan fungsi pembungkus sederhana, seperti yang dinyatakan dalam paket <code>must</code> , dan kemudian ganti <code>MUST</code> dengan nama fungsi pengganti yang sesuai.  Ini tidak sepenuhnya sepele, tetapi sepenuhnya mungkin ... Hanya editor / ide yang tidak akan dapat memahami kode tersebut.  Bagaimanapun, tanda tangan dari fungsi rintisan <code>MUST</code> tidak dapat diungkapkan dalam sistem tipe Go.  Dan karena itu tidak ada pelengkapan otomatis. </p><br><h2 id="pod-kapotom">  Di bawah tenda </h2><br><p>  Impor baru ditambahkan ke semua file yang diproses. </p><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _jex <span class="hljs-string"><span class="hljs-string">"github.com/anjensan/jex/runtime"</span></span></code> </pre> <br><p>  Panggilan <code>panic(_jex.NewException(...))</code> diganti dengan <code>panic(_jex.NewException(...))</code> .  <code>EX()</code> juga diganti dengan nama variabel lokal yang berisi pengecualian yang ditangkap. </p><br><p>  Tetapi <code>if TRY() {..} else {..}</code> diproses sedikit lebih rumit.  Pertama, pemrosesan khusus terjadi untuk semua <code>return</code> dan <code>defer</code> .  Kemudian cabang diproses jika ditempatkan dalam fungsi anonim.  Dan kemudian fungsi-fungsi ini diteruskan ke <code>_jex.TryCatch(..)</code> .  Ini dia </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> a == <span class="hljs-number"><span class="hljs-number">0</span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"a == 0"</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> fmt.Printf(<span class="hljs-string"><span class="hljs-string">"a = %d\n"</span></span>, a) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"fail"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"hmm"</span></span> }</code> </pre> <br><p>  berubah menjadi sesuatu seperti ini (saya menghapus <code>//line</code> komentar): </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_jex_r0 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, _jex_r1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _jex_ret <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fmt.Println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _jex_md2502 _jex.MultiDefer <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> _jex_md2502.Run() _jex.TryCatch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> a == <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(_jex.NewException(errors.New(<span class="hljs-string"><span class="hljs-string">"a == 0"</span></span>))) } { _f, _p0, _p1 := fmt.Printf, <span class="hljs-string"><span class="hljs-string">"a = %d\n"</span></span>, a _jex_md2502.Defer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { _f(_p0, _p1) }) } _jex_ret, _jex_r0, _jex_r1 = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, a+<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_jex_ex _jex.Exception)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> _jex.Suppress(_jex_ex) fmt.Println(<span class="hljs-string"><span class="hljs-string">"fail"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _jex_ret { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"hmm"</span></span> }</code> </pre><br><p>  Banyak, tidak cantik, tetapi berhasil.  Oke, tidak semua dan tidak selalu.  Misalnya, Anda tidak dapat melakukan <code>defer-recover</code> di dalam TRY, karena panggilan fungsi berubah menjadi lambda tambahan. </p><br><p>  Juga, ketika menampilkan pohon ast, opsi "simpan komentar" ditunjukkan.  Jadi, secara teori, <code>go/printer</code> harus mencetaknya ... Apa yang dia jujur, kebenarannya sangat, sangat bengkok =) Saya tidak akan memberikan contoh, hanya bengkok.  Pada prinsipnya, masalah seperti itu sepenuhnya dapat dipecahkan jika Anda dengan hati-hati menentukan posisi untuk semua ast-node (sekarang mereka kosong), tetapi ini jelas tidak termasuk dalam daftar hal-hal yang diperlukan untuk prototipe. </p><br><h2 id="probuem">  Coba </h2><br><p>  Karena penasaran, saya menulis <a href="">tolok ukur</a> kecil. </p><br><p>  Kami memiliki implementasi qsort kayu yang memeriksa duplikat dalam beban.  Ditemukan - kesalahan.  Satu versi hanya melempar melalui <code>return err</code> , yang lain mengklarifikasi kesalahan dengan memanggil <code>fmt.Errorf</code> .  Dan satu lagi menggunakan pengecualian.  Kami mengurutkan irisan dengan ukuran yang berbeda, baik tanpa duplikat sama sekali (tidak ada kesalahan, irisan disortir sepenuhnya), atau dengan satu pengulangan (pengurutan terputus sekitar setengah, itu dapat dilihat oleh timing). </p><br><div class="spoiler">  <b class="spoiler_title">Hasil</b> <div class="spoiler_text"><pre> <code class="hljs powershell">~ &gt; cat /proc/cpuinfo | grep <span class="hljs-string"><span class="hljs-string">'model name'</span></span> | head <span class="hljs-literal"><span class="hljs-literal">-1</span></span> model name : Intel(R) Core(TM) i7<span class="hljs-literal"><span class="hljs-literal">-6700K</span></span> CPU <span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> <span class="hljs-number"><span class="hljs-number">4.00</span></span>GHz ~ &gt; go version go version go1.<span class="hljs-number"><span class="hljs-number">11</span></span> linux/amd64 ~ &gt; go test <span class="hljs-literal"><span class="hljs-literal">-bench</span></span>=. github.com/anjensan/jex/demo goos: linux goarch: amd64 pkg: github.com/anjensan/jex/demo BenchmarkNoErrors/_____10/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">10000000</span></span> <span class="hljs-number"><span class="hljs-number">236</span></span> ns/op BenchmarkNoErrors/_____10/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000000</span></span> <span class="hljs-number"><span class="hljs-number">255</span></span> ns/op BenchmarkNoErrors/_____10/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000000</span></span> <span class="hljs-number"><span class="hljs-number">287</span></span> ns/op BenchmarkNoErrors/____100/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3119</span></span> ns/op BenchmarkNoErrors/____100/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3194</span></span> ns/op BenchmarkNoErrors/____100/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3533</span></span> ns/op BenchmarkNoErrors/___1000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">30000</span></span> <span class="hljs-number"><span class="hljs-number">42356</span></span> ns/op BenchmarkNoErrors/___1000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">30000</span></span> <span class="hljs-number"><span class="hljs-number">42204</span></span> ns/op BenchmarkNoErrors/___1000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">30000</span></span> <span class="hljs-number"><span class="hljs-number">44465</span></span> ns/op BenchmarkNoErrors/__10000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-number"><span class="hljs-number">525864</span></span> ns/op BenchmarkNoErrors/__10000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-number"><span class="hljs-number">524781</span></span> ns/op BenchmarkNoErrors/__10000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-number"><span class="hljs-number">561256</span></span> ns/op BenchmarkNoErrors/_100000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">6309181</span></span> ns/op BenchmarkNoErrors/_100000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">6335135</span></span> ns/op BenchmarkNoErrors/_100000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">6687197</span></span> ns/op BenchmarkNoErrors/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">76274341</span></span> ns/op BenchmarkNoErrors/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">77806506</span></span> ns/op BenchmarkNoErrors/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">78019041</span></span> ns/op BenchmarkOneError/_____10/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">2000000</span></span> <span class="hljs-number"><span class="hljs-number">712</span></span> ns/op BenchmarkOneError/_____10/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000000</span></span> <span class="hljs-number"><span class="hljs-number">268</span></span> ns/op BenchmarkOneError/_____10/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">2000000</span></span> <span class="hljs-number"><span class="hljs-number">799</span></span> ns/op BenchmarkOneError/____100/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">2296</span></span> ns/op BenchmarkOneError/____100/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-number"><span class="hljs-number">1809</span></span> ns/op BenchmarkOneError/____100/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3529</span></span> ns/op BenchmarkOneError/___1000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-number"><span class="hljs-number">21168</span></span> ns/op BenchmarkOneError/___1000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-number"><span class="hljs-number">20747</span></span> ns/op BenchmarkOneError/___1000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50000</span></span> <span class="hljs-number"><span class="hljs-number">24560</span></span> ns/op BenchmarkOneError/__10000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-number"><span class="hljs-number">242077</span></span> ns/op BenchmarkOneError/__10000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-number"><span class="hljs-number">242376</span></span> ns/op BenchmarkOneError/__10000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-number"><span class="hljs-number">251043</span></span> ns/op BenchmarkOneError/_100000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">2753692</span></span> ns/op BenchmarkOneError/_100000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">2824116</span></span> ns/op BenchmarkOneError/_100000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">2845701</span></span> ns/op BenchmarkOneError/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">33452819</span></span> ns/op BenchmarkOneError/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">33374000</span></span> ns/op BenchmarkOneError/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">33705994</span></span> ns/op PASS ok github.com/anjensan/jex/demo <span class="hljs-number"><span class="hljs-number">64.008</span></span>s</code> </pre> </div></div><br><p>  Jika kesalahan belum dilemparkan (kode stabil dan diperkuat beton), maka jaminan dengan lemparan pengecualian kira-kira sebanding dengan <code>return err</code> dan <code>fmt.Errorf</code> .  Terkadang sedikit lebih cepat.  Tetapi jika kesalahan dilemparkan, maka pengecualian berada di posisi kedua.  Tetapi itu semua tergantung pada rasio "pekerjaan bermanfaat / kesalahan" dan kedalaman tumpukan.  Untuk irisan kecil, <code>return err</code> berjalan di depan celah, untuk irisan menengah dan besar, pengecualian sudah sama dengan penerusan manual. </p><br><p>  Singkatnya, jika kesalahan sangat jarang terjadi, pengecualian bahkan dapat mempercepat kode sedikit.  Jika seperti orang lain, maka itu akan menjadi sesuatu seperti itu.  Tetapi jika sangat sering ... maka pengecualian lambat jauh dari masalah yang paling penting, yang patut dikhawatirkan. </p><br><p>  Sebagai ujian, saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">memigrasikan</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">perpustakaan</a> gosh nyata untuk pengecualian. </p><br><div class="spoiler">  <b class="spoiler_title">Saya sangat menyesal, tidak berhasil menulis ulang 1-in-1</b> <div class="spoiler_text"><p>  Lebih tepatnya, itu akan berubah, tetapi ini pasti terganggu. </p><br><p>  Jadi, misalnya, fungsi <a href=""><code>rpc2XML</code></a> tampaknya mengembalikan <code>error</code> ... ya, itu tidak pernah mengembalikannya.  Jika Anda mencoba membuat serialisasi tipe data yang tidak didukung - tidak ada kesalahan, cukup kosongkan output.  Mungkin ini yang dimaksud? Tidak, hati nurani tidak membiarkannya seperti itu.  Ditambahkan oleh </p><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: THROW(fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"unsupported type %T"</span></span>, value))</code> </pre> <br><p>  Tetapi ternyata fungsi ini digunakan dengan cara khusus </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rpcParams2XML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rpc </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> err error buffer := <span class="hljs-string"><span class="hljs-string">"&lt;params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; reflect.ValueOf(rpc).Elem().NumField(); i++ { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xml <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> buffer += <span class="hljs-string"><span class="hljs-string">"&lt;param&gt;"</span></span> xml, err = rpc2XML(reflect.ValueOf(rpc).Elem().Field(i).Interface()) buffer += xml buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/param&gt;"</span></span> } buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer, err }</code> </pre> <br><p>  Di sini kita menjalankan daftar parameter, membuat serial semua, tetapi mengembalikan kesalahan <em>hanya</em> untuk yang terakhir.  Kesalahan yang tersisa diabaikan.  Perilaku aneh menjadi lebih mudah </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rpcParams2XML_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rpc </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { buffer := <span class="hljs-string"><span class="hljs-string">"&lt;params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; reflect.ValueOf(rpc).Elem().NumField(); i++ { buffer += <span class="hljs-string"><span class="hljs-string">"&lt;param&gt;"</span></span> buffer += rpc2XML_(reflect.ValueOf(rpc).Elem().Field(i).Interface()) buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/param&gt;"</span></span> } buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer }</code> </pre> <br><p>  Jika setidaknya satu bidang tidak berhasil membuat cerita bersambung - kesalahan.  Ya, itu lebih baik.  Tetapi ternyata fungsi ini juga digunakan <a href="">dengan</a> cara <a href="">khusus</a> . </p><br><pre> <code class="go hljs">xmlstr, _ = rpcResponse2XML(response)</code> </pre> <br><p>  sekali lagi, untuk kode sumber ini tidak begitu penting, karena ada kesalahan yang diabaikan.  Saya mulai menebak mengapa beberapa programmer menyukai penanganan kesalahan secara eksplisit <code>if err != nil</code> ... Tapi dengan pengecualian itu masih lebih mudah untuk diteruskan atau diproses daripada mengabaikan </p><br><pre> <code class="go hljs">xmlstr = rpcResponse2XML_(response)</code> </pre> <br><p>  Dan saya tidak mulai menghapus "rantai kesalahan."  Ini kode aslinya </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeClientResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader, reply </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { rawxml, err := ioutil.ReadAll(r) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FaultSystemError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xml2RPC(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(rawxml), reply) }</code> </pre> <br><p>  di sini adalah yang ditulis ulang </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeClientResponse_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader, reply </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rawxml []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { rawxml, ERR = ioutil.ReadAll(r) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { THROW(FaultSystemError) } xml2RPC_(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(rawxml), reply) }</code> </pre> <br><p>  Di sini kesalahan awal (yang mana <code>ioutil.ReadAll</code> dikembalikan) tidak akan hilang, itu akan dilampirkan ke pengecualian di bidang <code>suppress</code> .  Sekali lagi, ini dapat dilakukan seperti pada yang asli, tetapi harus dibuat bingung ... </p><br><p>  Saya menulis ulang tes, menggantikan <code>if err != nil { log.Error(..) }</code> dengan lemparan pengecualian sederhana.  Ada poin negatif - tes jatuh pada kesalahan pertama, tidak terus bekerja "baik, setidaknya entah bagaimana."  Menurut pikiran, akan perlu untuk membaginya menjadi sub-tes ... Apa, secara umum, layak dilakukan dalam hal apapun.  Tetapi sangat mudah untuk mendapatkan stackrace yang benar </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorReporter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t testing.TB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e error)</span></span></span></span> { t.Log(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(debug.Stack())) t.Fatal(e) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestRPC2XMLConverter_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> ex.Catch(errorReporter(t)) <span class="hljs-comment"><span class="hljs-comment">// ... xml := rpcRequest2XML_("Some.Method", req) }</span></span></code> </pre> <br><p>  Secara umum, kesalahan sangat mudah untuk diabaikan.  Dalam kode asli </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fault2XML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fault Fault)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { buffer := <span class="hljs-string"><span class="hljs-string">"&lt;methodResponse&gt;&lt;fault&gt;"</span></span> xml, _ := rpc2XML(fault) buffer += xml buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/fault&gt;&lt;/methodResponse&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer }</code> </pre> <br><p>  di sini kesalahan dari <code>rpc2XML</code> sekali lagi diabaikan dengan tenang.  Sudah menjadi seperti ini </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fault2XML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fault Fault)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { buffer := <span class="hljs-string"><span class="hljs-string">"&lt;methodResponse&gt;&lt;fault&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { buffer += rpc2XML_(fault) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"ERR: %v"</span></span>, EX()) buffer += <span class="hljs-string"><span class="hljs-string">"&lt;nil/&gt;"</span></span> } buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/fault&gt;&lt;/methodResponse&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer }</code> </pre> </div></div><br><p>  Menurut perasaan pribadi saya, lebih mudah untuk mengembalikan hasil "setengah jadi" dengan kesalahan. <br>  Misalnya, respons setengah dibangun.  Pengecualian lebih rumit, karena fungsi mengembalikan hasil yang sukses atau tidak menghasilkan apa-apa sama sekali.  Semacam atomicity.  Di sisi lain, pengecualian lebih sulit untuk diabaikan atau kehilangan akar penyebab dalam rantai pengecualian.  Bagaimanapun, Anda masih harus secara khusus mencoba melakukan ini.  Dengan kesalahan, ini terjadi dengan mudah dan alami. </p><br><h2 id="vmesto-zaklyucheniya">  Alih-alih sebuah kesimpulan </h2><br><p>  Saat <em>menulis</em> artikel ini, tidak ada gopher yang terluka. </p><br><p>  Terima kasih atas foto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://migranov.ru</a> dari goffer-alcoholic </p><br><p>  Saya tidak dapat memilih antara hub "Pemrograman" dan "Pemrograman abnormal". <br>  Pilihan yang sangat sulit, ditambahkan ke keduanya. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id425145/">https://habr.com/ru/post/id425145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id425135/index.html">Mengapa VoIP diakui sebagai layanan informasi di AS, dan apa artinya bagi industri dan pengguna telekomunikasi</a></li>
<li><a href="../id425137/index.html">Kami bekerja di konsol dengan cepat dan efisien</a></li>
<li><a href="../id425139/index.html">Bintang pop di bawah lensa kecerdasan buatan</a></li>
<li><a href="../id425141/index.html">"Menghadapi Guido What You Tell Him" ​​atau Percakapan Python dengan Bobuk</a></li>
<li><a href="../id425143/index.html">Sekolah Tinggi Ekonomi menolak kuliah yang mendukung kursus online</a></li>
<li><a href="../id425149/index.html">Antara langit dan bumi</a></li>
<li><a href="../id425151/index.html">Menguping pada obrolan telegram menggunakan klien Anda</a></li>
<li><a href="../id425153/index.html">Tiga emosi paling populer kesalahpahaman dalam Affective Computing</a></li>
<li><a href="../id425155/index.html">Kriptografi atau penelitian menarik tentang enkripsi reversibel dalam PHP</a></li>
<li><a href="../id425157/index.html">Temui komunitas .Net di CLRium # 4 + online. Di mana CoreCLR dan C # pergi. Semua orang diundang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>