<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚å®Ô∏è ‚úíÔ∏è üåù Barramento PCIe: as limita√ß√µes f√≠sicas afetam a taxa de transfer√™ncia? üòº ü¶É üé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vou come√ßar de longe. No inverno passado, fiz um dispositivo USB com um n√∫cleo hospedado no FPGA. Claro, eu realmente queria verificar a largura de ba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Barramento PCIe: as limita√ß√µes f√≠sicas afetam a taxa de transfer√™ncia?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414753/">  Vou come√ßar de longe.  No inverno passado, fiz um dispositivo USB com um n√∫cleo hospedado no FPGA.  Claro, eu realmente queria verificar a largura de banda real deste barramento.  Afinal, no controlador - h√° muito o que fazer.  Voc√™ sempre pode dizer que h√° um atraso ou por l√°.  No caso de FPGAs, vejo um bloco bombeando dados, ent√£o ele me disse que h√° dados nele.  Mas defino que tudo foi processado e estou pronto para aceitar uma nova parte (ao mesmo tempo, ele j√° recebe dados no segundo buffer do mesmo ponto de extremidade).  √ìtimo, defina a prontid√£o desde o primeiro compasso e veja o que acontece quando o USB pode "martelar" sem parar. <br><br><img src="https://habrastorage.org/webt/ab/ft/n3/abftn3olrakrhdj3zztrcksut5k.jpeg"><br><a name="habracut"></a><br>  Mas acontece uma coisa incr√≠vel.  Se o dispositivo USB 2.0 estiver preso no conector "azul" (que √© USB 3.0), a velocidade ser√° de uma.  Se em "preto" - outro.  Aqui est√° o meu gr√°fico da velocidade de grava√ß√£o USB versus o comprimento dos dados.  USB3 e USB2 s√£o o tipo de conector; o dispositivo √© sempre USB 2.0 HS. <br><br><img src="https://habrastorage.org/webt/ea/sg/ja/easgjasaj1jbzovcsgbiymhploa.png"><br><br>  Eu tentei em m√°quinas diferentes.  O resultado est√° pr√≥ximo.  Ningu√©m poderia explicar esse fen√¥meno para mim.  Mais tarde, encontrei o motivo mais prov√°vel.  E a raz√£o √© muito simples.  Aqui est√£o as propriedades do controlador USB 2.0: <br><br><img src="https://habrastorage.org/webt/2y/ek/xl/2yekxlpcnthq8p06z8wpxxasjgo.png"><br><br>  Os controladores que controlam o conector "azul" n√£o.  E a diferen√ßa √© de apenas 20%. <br><br>  A partir disso, conclu√≠mos que as limita√ß√µes de largura de banda nem sempre s√£o determinadas pelas propriedades f√≠sicas do barramento.  √Äs vezes, outras coisas s√£o sobrepostas.  Hoje passamos com esse conhecimento. <br><br><h2>  Experi√™ncia prim√°ria </h2><br>  Ent√£o  Tudo come√ßou bastante mundano.  Houve uma verifica√ß√£o de um programa.  O processo de grava√ß√£o de dados em v√°rios discos simultaneamente foi verificado.  O hardware √© simples: h√° uma placa-m√£e com quatro slots PCIe.  Placas absolutamente id√™nticas com controladores AHCI s√£o inseridas em todos os slots, cada um dos quais suporta exclusivamente PCIe x1. <br><br><img src="https://habrastorage.org/webt/4k/il/lz/4killzfbtb9r6evuybrs68e6xl0.jpeg"><br><br>  Cada placa serve 4 unidades. <br>  E ent√£o o seguinte efeito √© revelado.  Pegamos um disco e come√ßamos a gravar dados nele.  Temos uma velocidade de 180 a 220 megabytes por segundo (a seguir, megabytes s√£o 1024 * 1024 bytes): <br><br><img src="https://habrastorage.org/webt/we/cu/uy/wecuuyqewi743lh6kcxiqgpkk5i.png"><br><br>  Tomamos o segundo caminho.  A velocidade de grava√ß√£o √© de 170 a 190 MB / s: <br><br><img src="https://habrastorage.org/webt/cs/0o/g7/cs0og7k2kztps5h2vgvw7yfsrno.png"><br><br>  Escrevemos imediatamente para ambos - obtemos uma redu√ß√£o de velocidade: <br><br><img src="https://habrastorage.org/webt/xz/at/nk/xzatnk1bt2sog8qsvkjaryf34j0.png"><br><br>  A velocidade total √© de cerca de 290 MB / s.  Mas o mais incr√≠vel √© que depuramos (pelo que aconteceu) esse programa nas mesmas unidades, mas em outros canais.  E estava tudo bem l√°.  Transferimos rapidamente para esses canais (eles passar√£o por outro cart√£o), obtemos um excelente trabalho: <br><br><img src="https://habrastorage.org/webt/xd/jj/qo/xdjjqomypz-hhmaq6yt73wtoai4.png"><br><br><h2>  Vou comprar um slot em uma boa √°rea </h2><br>  Devo dizer imediatamente que n√£o vale a pena culpar tudo pelos componentes de outras pessoas.  Tudo aqui √© escrito por n√≥s, a partir do pr√≥prio programa, terminando com os drivers.  Portanto, todo o caminho dos dados pode ser monitorado.  O desconhecido vem somente quando a solicita√ß√£o foi para o hardware. <br><br>  Ap√≥s a an√°lise inicial, verificou-se que a velocidade n√£o √© limitada nos slots PCIe ‚Äúlongos‚Äù e √© limitada nos slots ‚Äúcurtos‚Äù.  Os longos s√£o onde voc√™ pode inserir cart√µes x16 (embora um deles funcione no modo n√£o superior a x4), e os curtos s√£o apenas para cart√µes x1. <br><br><img src="https://habrastorage.org/webt/38/kt/jt/38ktjtqf38knqdotsc3gxacmqos.jpeg"><br><br>  Tudo ficaria bem, mas os controladores nas placas atuais, em princ√≠pio, n√£o podem funcionar em um modo diferente do PCIex1.  Ou seja, todos os controladores devem estar em condi√ß√µes absolutamente id√™nticas, independentemente do comprimento do slot!  Mas n√£o.  Quem vive no "longo" - trabalha r√°pido, quem no "curto" - lentamente.  Bom  E r√°pido - qu√£o r√°pido?  Adicione uma terceira unidade, escreva para as tr√™s. <br><br>  Nos slots "curtos", o limite ainda √© de cerca de 290 MB / s: <br><br><img src="https://habrastorage.org/webt/i-/ti/jr/i-tijrldg-h9izkdypn5iyzir8k.png"><br><br>  No "longo" - na regi√£o de 400 MB / s: <br><br><img src="https://habrastorage.org/webt/qh/gn/w_/qhgnw_p59bewkzpoj8o0i8jexns.png"><br><br><img src="https://habrastorage.org/webt/oh/yz/gt/ohyzgt_cbix1f8uufh8-s5dnazk.png"><br><br>  Eu procurei na Internet inteira.  Em primeiro lugar, depois de algum tempo, eu j√° ri de artigos nos quais diz que o rendimento do PCIe gen 1 e gen 2 para x1 √© de 250 e 500 MB / s.  Estes s√£o megabytes brutos.  Devido √† sobrecarga (eu uso essa palavra n√£o russa para indicar uma troca de servi√ßos que segue as mesmas linhas que os dados principais) para a gera√ß√£o 2, obtemos exatamente 400 megabytes por segundo de fluxo √∫til.  Em segundo lugar, teimosamente n√£o consegui encontrar nada sobre o n√∫mero m√°gico 290 (olhando para o futuro - ainda n√£o o encontrei). <br><br>  √ìtimo.  Tentando examinar a topologia da inclus√£o de nossos controladores.  Aqui est√° (013-015 - estes s√£o os sufixos do nome do dispositivo pelos quais eu os combinei para distinguir de alguma forma).  Verde √© r√°pido, vermelho √© lento. <br><br><img src="https://habrastorage.org/webt/ae/xo/3o/aexo3oqtd-c7caogtc-bthelriq.png"><br><br>  O controlador "015" nem sequer consideramos.  Ele mora em um slot privilegiado projetado para uma placa de v√≠deo.  Mas o 013rd est√° conectado ao mesmo switch que o 012nd de 014th.  Como ele √© diferente? <br><br>  Alguns artigos dizem que cart√µes diferentes podem diferir nas configura√ß√µes de Max Payload.  Estudei o espa√ßo de configura√ß√£o de todas as placas - esse par√¢metro √© para todos no mesmo valor m√≠nimo poss√≠vel.  Al√©m disso, a documenta√ß√£o para o chipset desta placa-m√£e diz que n√£o pode haver outro significado. <br><br><img src="https://habrastorage.org/webt/ch/tg/iv/chtgivqtyksowq7blomsrtpmija.png"><br><br>  Em geral, vasculhei tudo no espa√ßo de configura√ß√£o - tudo √© configurado de forma id√™ntica.  E a velocidade √© diferente!  Releia a documenta√ß√£o repetidamente para o chipset - sem configura√ß√µes de largura de banda.  Prioridades - sim, algo foi escrito sobre elas, mas os testes s√£o realizados na completa aus√™ncia de carga em outros canais!  Ou seja, n√£o est√° neles. <br><br>  Por precau√ß√£o, desliguei o programa de interrup√ß√£o.  A carga do processador aumentou para quantidades insanas, porque agora constantemente l√™ estupidamente o bit de prontid√£o, mas as leituras de velocidade n√£o mudaram.  Portanto, √© imposs√≠vel culpar este subsistema por problemas. <br><br><h2>  E quanto a outras placas? </h2><br>  Tentamos mudar a placa-m√£e exatamente para o mesmo.  Nenhuma mudan√ßa.  Eles tentaram substituir o processador (havia raz√µes para acreditar que ele estava inutilizando).  Al√©m disso, nenhuma altera√ß√£o na velocidade (mas o processador antigo √© realmente in√∫til).  Instalamos uma placa-m√£e de nova gera√ß√£o - tudo funciona em todos os slots.  Al√©m disso, a velocidade m√°xima n√£o √© mais de 400, mas de 418 megabytes por segundo, mesmo em slots "longos", mesmo em "curtos": <br><br><img src="https://habrastorage.org/webt/kk/ct/yp/kkctypau1u3bn-klc-4bxzrgptk.png"><br><br>  Mas aqui - sem milagres.  Com o movimento manual usual (j√° usado at√© hoje), lemos o espa√ßo de configura√ß√£o e vemos que o par√¢metro Max Payload est√° definido n√£o para 128, mas para 256 bytes. <br><br>  Tamanho de pacote maior - menos pacotes.  Menos despesas gerais para envi√°-las - dados mais √∫teis conseguem ser executados ao mesmo tempo.  Isso mesmo. <br><br><h2>  Ent√£o, quem √© o culpado? </h2><br>  N√£o darei uma resposta exata para a pergunta do t√≠tulo, com refer√™ncia aos documentos.  Mas meu pensamento foi no seguinte caminho: digamos que a restri√ß√£o de fluxo esteja definida dentro do chipset.  N√£o pode ser programado, est√° bem ajustado, mas est√°.  Por exemplo, √© igual a 290 megabytes por segundo para cada diff.  um casal  Mais - ele j√° est√° cortado em algum lugar dentro do chipset em seus mecanismos internos.  Portanto, no slot "long" (onde voc√™ pode colar cart√µes de at√© x4), nada √© cortado para o cart√£o dentro do chipset, e descansamos contra o limite f√≠sico do barramento x1.  No conector "curto", encontramos essa limita√ß√£o. <br><br>  De fato, verificar isso n√£o √© f√°cil, mas muito simples.  Ficamos no slot 013rd, n√£o no AHCI, mas no controlador SAS, que serve 8 unidades de uma s√≥ vez e pode funcionar nos modos PCIe de at√© x4.  N√≥s conectamos 4 unidades SSD inteligentes a ele.  Observamos a velocidade de grava√ß√£o - tanto quanto a alma se alegra: <br><br><img src="https://habrastorage.org/webt/zo/hr/tv/zohrtvdgopxxvrgoavusiehb4mq.png"><br><br>  Agora, adicionamos os 4 discos que apareceram nos primeiros testes.  O desempenho do SSD caiu previsivelmente: <br><br><img src="https://habrastorage.org/webt/28/wp/hg/28wphgyghw6aaea9y3ddilidzc0.png"><br><br>  Calculamos a velocidade total que passa pelo controlador SAS, obtemos 1175 megabytes por segundo.  Divida por 4 (tantas linhas v√£o para o slot "longo"), obtemos ... Rolo de tambor ... 293 megabytes por segundo.  Em algum lugar eu j√° vi esse n√∫mero! <br><br>  Portanto, dentro da estrutura deste projeto, ficou provado que o problema n√£o est√° em nosso programa ou driver, mas nas estranhas limita√ß√µes do chipset, que provavelmente est√£o "conectadas" firmemente.  Foi desenvolvida a metodologia de sele√ß√£o de placas-m√£e que podem ser utilizadas no projeto.  Mas, em geral, tiramos as seguintes conclus√µes. <br><br><h2>  Conclus√£o </h2><br><ul><li>  Frequentemente, na vida real, o equipamento tem menos desempenho do que teoricamente poss√≠vel.  As restri√ß√µes podem at√© ser impostas pelos drivers, como mostrado no caso do USB.  √Äs vezes √© poss√≠vel pegar equipamentos que (ou cujos drivers) n√£o possuem essas restri√ß√µes. </li><li>  As limita√ß√µes podem at√© n√£o ser documentadas, mas claramente expressas. </li><li>  Muitos artigos dizem que um par diferencial de PCIe gen.  1 e gen 2 fornece aproximadamente 250 e 500 megabytes por segundo, est√£o errados.  Eles copiam o mesmo erro um do outro - um megabyte de dados brutos por segundo.  A sobrecarga se acumula em v√°rios n√≠veis da interface.  Com uma carga √∫til m√°xima de 128 bytes, o PCIe gen2 recebe cerca de 400 megabytes por segundo.  Nas gera√ß√µes mais recentes do PCIe, tudo deve ficar um pouco melhor, pois a codifica√ß√£o f√≠sica n√£o √© 8b / 10b, mas √© mais econ√¥mica, mas at√© agora n√£o foi encontrado nenhum controlador de unidade para testar isso na pr√°tica. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt414753/">https://habr.com/ru/post/pt414753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt414743/index.html">Localiza√ß√£o: Case Slack</a></li>
<li><a href="../pt414745/index.html">#BigGun. O cron√≥grafo "frame" mais simples do Arduino (medi√ß√£o da velocidade da bala)</a></li>
<li><a href="../pt414747/index.html">CNS, drogas e rock and roll: uma hist√≥ria sobre um dispositivo que nos fez beber, n√£o dormir e n√£o piscar</a></li>
<li><a href="../pt414749/index.html">Conjunto de sysadmin cavalheiro</a></li>
<li><a href="../pt414751/index.html">Domesticando o WSUS com Ansible e mais</a></li>
<li><a href="../pt414755/index.html">Hackathon √© a solu√ß√£o para o problema</a></li>
<li><a href="../pt414757/index.html">Formato de apresenta√ß√£o moderno</a></li>
<li><a href="../pt414759/index.html">Competi√ß√£o Servlet</a></li>
<li><a href="../pt414761/index.html">5 sites de not√≠cias criativas em ingl√™s</a></li>
<li><a href="../pt414763/index.html">Quatro tipos de erros do gerente de produto que podem (e devem) ser evitados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>