<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Ü©Ô∏è üéø üê∂ Swift: ARC et gestion de la m√©moire üïñ üë©üèΩ‚Äçüöí üë®üèª‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√âtant un langage moderne de haut niveau, Swift s'occupe essentiellement de la gestion de la m√©moire dans vos applications, allouant et lib√©rant de la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Swift: ARC et gestion de la m√©moire</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451130/">  √âtant un langage moderne de haut niveau, <b>Swift</b> s'occupe essentiellement de la gestion de la m√©moire dans vos applications, allouant et lib√©rant de la m√©moire.  Cela est d√ª √† un m√©canisme appel√© <b>Automatic Reference Counting</b> , ou <b>ARC pour faire</b> court.  Dans ce guide, vous apprendrez comment ARC fonctionne et comment g√©rer correctement la m√©moire dans Swift.  En comprenant ce m√©canisme, vous pouvez influencer la dur√©e de vie des objets situ√©s sur le tas ( <b>tas</b> ). <br><br>  Dans ce guide, vous approfondirez vos connaissances sur Swift et ARC en apprenant ce qui suit: <br><br><ul><li>  comment fonctionne ARC </li><li>  quels sont <b>les cycles de r√©f√©rence</b> et comment les corriger correctement </li><li>  comment cr√©er un exemple de boucle de lien </li><li>  Comment trouver des boucles de liens en utilisant les outils visuels offerts par Xcode </li><li>  comment g√©rer les types de r√©f√©rence et les types de valeur </li></ul><a name="habracut"></a><br><h2>  Pour commencer </h2><br>  T√©l√©chargez le <a href="" rel="nofollow">mat√©riel source.</a>  Ouvrez le projet dans le dossier <b>Cycles / Starter</b> .  Dans la premi√®re partie de notre guide, comprenant les concepts cl√©s, nous traiterons exclusivement du <b>fichier MainViewController.swif</b> t. <br><br>  Ajoutez cette classe au bas de MainViewController.swift: <br><br><pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(name: <span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name = name <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"User \(name) was initialized"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">deinit</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Deallocating user named: \(name)"</span></span>) } }</code> </pre> <br>  La classe <b>User</b> est d√©finie ici, ce qui, √† l'aide d'instructions <b>print</b> , nous informe de l'initialisation et de la lib√©ration de l'instance de classe. <br><br>  Cr√©ez maintenant une instance de la classe User en haut de MainViewController. <br><br>  Placez ce code avant la m√©thode <b>viewDidLoad ()</b> : <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> user = <span class="hljs-type"><span class="hljs-type">User</span></span>(name: <span class="hljs-string"><span class="hljs-string">"John"</span></span>)</code> </pre> <br>  Lancez l'appli.  Rendez la console Xcode visible avec <b>Command-Shift-Y</b> pour voir la sortie des instructions d'impression. <br><br>  Notez que l' <b>utilisateur John a √©t√© initialis√©</b> est apparu sur la console, mais l'instruction print dans <b>deinit n'a</b> pas <b>√©t√©</b> ex√©cut√©e.  Cela signifie que cet objet n'a pas √©t√© lib√©r√©, car il n'est pas sorti de son <b>champ</b> d' <b>application</b> . <br><br>  En d'autres termes, tant que le contr√¥leur de vue contenant cet objet ne sera pas hors de port√©e, l'objet ne sera jamais lib√©r√©. <br><br><h2>  Est-il dans la port√©e? </h2><br>  En encapsulant une instance de la classe User dans une m√©thode, nous lui permettons de sortir de la port√©e, permettant ainsi √† ARC de la lib√©rer. <br><br>  Cr√©ons la m√©thode <b>runScenario ()</b> dans la classe MainViewController et d√©pla√ßons l'initialisation de l'instance de classe User √† l'int√©rieur. <br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runScenario</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> user = <span class="hljs-type"><span class="hljs-type">User</span></span>(name: <span class="hljs-string"><span class="hljs-string">"John"</span></span>) }</code> </pre><br>  runScenario () d√©finit la port√©e de l'instance User.  En quittant cette zone, l' <b>utilisateur</b> doit √™tre lib√©r√©. <br><br>  Appelez maintenant runScenario () en ajoutant ceci √† la fin de viewDidLoad (): <br><br><pre> <code class="swift hljs">runScenario()</code> </pre> <br>  Lancez l'appli.  La sortie de la console ressemble maintenant √† ceci: <br><br>  L'utilisateur John a √©t√© initialis√© <br>  Utilisateur de d√©sallocation nomm√©: John <br><br>  Cela signifie que vous avez lib√©r√© un objet qui a quitt√© le champ de vision. <br><br><h2>  Dur√©e de vie de l'objet </h2><br><br>  L'existence de l'objet est divis√©e en cinq √©tapes: <br><br><ul><li>  allocation de m√©moire: √† partir de la pile ou du tas </li><li>  initialisation: le code est ex√©cut√© dans init </li><li>  utilisation de </li><li>  deinitialisation: le code est ex√©cut√© dans deinit </li><li>  m√©moire libre: la m√©moire allou√©e est retourn√©e √† la pile ou au tas </li></ul><br>  Il n'y a aucun moyen direct de suivre les √©tapes d'allocation et de lib√©ration de m√©moire, mais vous pouvez utiliser le code dans init et deinit. <br><br>  <b>Les d√©comptes de r√©f√©rence</b> , √©galement appel√©s <b>d√©comptes d'utilisation</b> , d√©terminent quand un objet n'est plus n√©cessaire.  Ce compteur indique le nombre de ceux qui "utilisent" cet objet.  Un objet devient inutile lorsque le compteur d'utilisation est nul.  Ensuite, l'objet est d√©sinitialis√© et lib√©r√©. <br><br><img src="https://habrastorage.org/webt/b5/oo/78/b5oo78ealf173ey0ayz7rngnszk.png"><br><br>  Lorsque l'objet utilisateur est initialis√©, son nombre de r√©f√©rences est 1, car la constante <b>utilisateur</b> fait r√©f√©rence √† cet objet. <br><br>  √Ä la fin de runScenario (), l'utilisateur sort de la port√©e et le nombre de r√©f√©rences est r√©duit √† 0. Par cons√©quent, l'utilisateur n'est pas initialis√©, puis lib√©r√©. <br><br><h2>  Cycles de r√©f√©rence </h2><br>  Dans la plupart des cas, ARC fonctionne comme il se doit.  Le d√©veloppeur n'a g√©n√©ralement pas √† s'inqui√©ter des fuites de m√©moire lorsque les objets inutilis√©s restent non allou√©s ind√©finiment. <br><br>  Mais pas toujours!  Fuites de m√©moire possibles. <br><br>  Comment cela peut-il arriver?  Imaginez une situation o√π deux objets ne sont plus utilis√©s, mais chacun se r√©f√®re √† l'autre.  √âtant donn√© que chaque compte de r√©f√©rence n'est pas 0, aucun d'entre eux ne sera lib√©r√©. <br><br><img src="https://habrastorage.org/webt/hd/zp/ff/hdzpffk1eh3rug0fgmgnlghnb3q.png"><br><br>  Il s'agit d'un <b>solide cycle de r√©f√©rence</b> .  Cette situation confond l'ARC et ne lui permet pas d'effacer la m√©moire. <br><br>  Comme vous pouvez le voir, le nombre de r√©f√©rences √† la fin n'est pas 0, et bien qu'aucun objet ne soit plus n√©cessaire, object1 et object2 ne seront pas lib√©r√©s. <br><br><h2>  Consultez nos liens </h2><br>  Pour tester tout cela en action, ajoutez ce code apr√®s la classe User dans MainViewController.swift: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phone</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> model: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> owner: <span class="hljs-type"><span class="hljs-type">User?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(model: <span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.model = model <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Phone \(model) was initialized"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">deinit</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Deallocating phone named: \(model)"</span></span>) } }</code> </pre> <br>  Ce code ajoute une nouvelle classe <b>Phone</b> avec deux propri√©t√©s, une pour le mod√®le et une pour le propri√©taire, ainsi que les m√©thodes init et deinit.  La propri√©t√© du propri√©taire est facultative, car le t√©l√©phone peut ne pas avoir de propri√©taire. <br><br>  Ajoutez maintenant cette ligne √† runScenario (): <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iPhone = <span class="hljs-type"><span class="hljs-type">Phone</span></span>(model: <span class="hljs-string"><span class="hljs-string">"iPhone Xs"</span></span>)</code> </pre><br>  Cela va cr√©er une instance de la classe Phone. <br><br><h2>  Tenez le mobile </h2><br>  Ajoutez maintenant ce code √† la classe User, imm√©diatement apr√®s la propri√©t√© name: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> phones: [<span class="hljs-type"><span class="hljs-type">Phone</span></span>] = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phone: Phone)</span></span></span></span> { phones.append(phone) phone.owner = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> }</code> </pre><br>  Ajoutez un tableau de t√©l√©phones appartenant √† l'utilisateur.  Le setter est marqu√© comme priv√©, donc ajoutez (t√©l√©phone :) doit √™tre utilis√©. <br><br>  Lancez l'appli.  Comme vous pouvez le voir, les instances des classes d'objets Phone et User sont lib√©r√©es selon les besoins. <br><br>  L'utilisateur John a √©t√© initialis√© <br>  Le t√©l√©phone iPhone XS a √©t√© initialis√© <br>  D√©sallocation du t√©l√©phone nomm√©: iPhone Xs <br>  Utilisateur de d√©sallocation nomm√©: John <br><br>  Ajoutez maintenant ceci √† la fin de runScenario (): <br><pre> <code class="swift hljs">user.add(phone: iPhone)</code> </pre> <br><br>  Ici, nous ajoutons notre iPhone √† la liste des t√©l√©phones appartenant √† l' <b>utilisateur</b> , et d√©finissons √©galement la <b>propri√©t√© du</b> propri√©taire du t√©l√©phone sur ¬´ <b>utilisateur</b> ¬ª. <br><br>  Ex√©cutez √† nouveau l'application.  Vous verrez que les objets utilisateur et iPhone ne sont pas lib√©r√©s.  Le cycle de liens forts entre eux emp√™che l'ARC de les lib√©rer. <br><br><img src="https://habrastorage.org/webt/lo/az/mu/loazmuamyoww2ttr7wnwcd8_n4w.png"><br><br><h2>  Liens faibles </h2><br>  Pour briser le cycle des liens forts, vous pouvez d√©signer la relation entre les objets comme faible. <br><br>  Par d√©faut, tous les liens sont solides et l'affectation entra√Æne une augmentation du nombre de r√©f√©rences.  Lorsque vous utilisez des r√©f√©rences faibles, le nombre de r√©f√©rences n'augmente pas. <br><br>  En d'autres termes, les <b>maillons faibles n'affectent pas la gestion de la vie d'un objet</b> .  Les liens faibles sont toujours d√©clar√©s <b>facultatifs</b> .  De cette fa√ßon, lorsque le nombre de liens devient 0, le lien peut √™tre d√©fini sur z√©ro. <br><br><img src="https://habrastorage.org/webt/ti/qd/kc/tiqdkcyfstrndd8xswpf8zfebfo.png"><br><br>  Dans cette illustration, les lignes pointill√©es indiquent des maillons faibles.  Notez que le nombre de r√©f√©rences de object1 est 1, car variable1 s'y r√©f√®re.  Le nombre de r√©f√©rences de object2 est 2, car il est r√©f√©renc√© par variable2 et object1. <br><br>  object2 fait √©galement r√©f√©rence √† object1, mais <b>FAIBLE</b> , ce qui signifie qu'il n'affecte pas le nombre de r√©f√©rences de object1. <br><br>  Lorsque variable1 et variable2 sont lib√©r√©es, object1 a un compte de r√©f√©rence de 0, ce qui le lib√®re.  Ceci, √† son tour, lib√®re une r√©f√©rence forte √† object2, ce qui conduit d√©j√† √† sa lib√©ration. <br><br>  Dans la classe Phone, modifiez la d√©claration de propri√©t√© du propri√©taire comme suit: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> owner: <span class="hljs-type"><span class="hljs-type">User?</span></span></code> </pre> <br>  En d√©clarant la r√©f√©rence de propri√©t√© propri√©taire comme ¬´faible¬ª, nous rompons la boucle des liens solides entre les classes Utilisateur et T√©l√©phone. <br><br><img src="https://habrastorage.org/webt/ym/ax/_m/ymax_mv9cvlpi8xqwnxmb14vr2g.png"><br><br>  Lancez l'appli.  L'utilisateur et le t√©l√©phone sont maintenant correctement lib√©r√©s. <br><br><h2>  Liens sans propri√©taire </h2><br>  Il existe √©galement un autre modificateur de lien qui n'augmente pas le nombre de r√©f√©rences: sans <b>propri√©taire</b> . <br><br>  Quelle est la difference entre <b>unowned</b> et un <b>faible</b> ?  Une r√©f√©rence faible est toujours facultative et devient automatiquement nulle lorsque l'objet r√©f√©renc√© est lib√©r√©. <br><br>  C'est pourquoi nous devons d√©clarer les propri√©t√©s faibles comme une variable optionnelle de type: cette propri√©t√© doit changer. <br><br>  Les liens non poss√©d√©s, en revanche, ne sont jamais facultatifs.  Si vous essayez d'acc√©der √† une propri√©t√© sans propri√©taire qui fait r√©f√©rence √† un objet lib√©r√©, vous obtiendrez une erreur qui ressemble √† un d√©ballage forc√© contenant une variable nil (d√©bouclage forc√©). <br><br><img src="https://habrastorage.org/webt/i9/hf/bc/i9hfbcizzk2eg38s_hidjq3evju.png"><br><br>  Essayons d'appliquer sans <b>propri√©taire</b> . <br><br>  Ajoutez une nouvelle classe <b>CarrierSubscription</b> √† la fin de MainViewController.swift: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CarrierSubscription</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> name: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> countryCode: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> number: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> user: <span class="hljs-type"><span class="hljs-type">User</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(name: <span class="hljs-type"><span class="hljs-type">String</span></span>, countryCode: <span class="hljs-type"><span class="hljs-type">String</span></span>, number: <span class="hljs-type"><span class="hljs-type">String</span></span>, user: <span class="hljs-type"><span class="hljs-type">User</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name = name <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.countryCode = countryCode <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.number = number <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.user = user <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"CarrierSubscription \(name) is initialized"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">deinit</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Deallocating CarrierSubscription named: \(name)"</span></span>) } }</code> </pre> <br>  CarrierSubscription a quatre propri√©t√©s: <br><br>  Nom: nom du fournisseur. <br>  CountryCode: code du pays. <br>  Num√©ro: num√©ro de t√©l√©phone. <br>  Utilisateur: lien vers l'utilisateur. <br><br><h2>  Quel est votre fournisseur? </h2><br>  Ajoutez maintenant ceci √† la classe User apr√®s la propri√©t√© name: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriptions: [<span class="hljs-type"><span class="hljs-type">CarrierSubscription</span></span>] = []</code> </pre> <br>  Ici, nous conservons un √©ventail de fournisseurs d'utilisateurs. <br><br>  Ajoutez maintenant ceci √† la classe Phone, apr√®s la propri√©t√© du propri√©taire: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> carrierSubscription: <span class="hljs-type"><span class="hljs-type">CarrierSubscription?</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provision</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(carrierSubscription: CarrierSubscription)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.carrierSubscription = carrierSubscription } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decommission</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { carrierSubscription = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br>  Cela ajoute la propri√©t√© facultative CarrierSubscription et deux m√©thodes d'enregistrement et de d√©sinscription du t√©l√©phone aupr√®s du fournisseur. <br><br>  Ajoutez maintenant la classe CarrierSubscription dans la m√©thode init, juste avant l'instruction print: <br><br><pre> <code class="swift hljs">user.subscriptions.append(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)</code> </pre> <br>  Nous ajoutons CarrierSubscription √† la gamme de fournisseurs d'utilisateurs. <br><br>  Enfin, ajoutez ceci √† la fin de la m√©thode runScenario (): <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">CarrierSubscription</span></span>( name: <span class="hljs-string"><span class="hljs-string">"TelBel"</span></span>, countryCode: <span class="hljs-string"><span class="hljs-string">"0032"</span></span>, number: <span class="hljs-string"><span class="hljs-string">"31415926"</span></span>, user: user) iPhone.provision(carrierSubscription: subscription)</code> </pre> <br>  Nous cr√©ons un abonnement au fournisseur pour l'utilisateur et y connectons le t√©l√©phone. <br><br>  Lancez l'appli.  Dans la console, vous verrez: <br><br>  L'utilisateur John a √©t√© initialis√© <br>  Le t√©l√©phone iPhone Xs a √©t√© initialis√© <br>  CarrierSubscription TelBel est initialis√© <br><br>  Et encore un cycle de liaison!  l'utilisateur, l'iPhone et l'abonnement n'√©taient pas gratuits √† la fin. <br><br>  Pouvez-vous trouver un probl√®me? <br><br><img src="https://habrastorage.org/webt/uu/fg/eq/uufgeqkvqa31jwwlsnlikc-iob8.png"><br><br><h2>  Briser la cha√Æne </h2><br>  Le lien de l'utilisateur √† l'abonnement ou le lien de l'abonnement √† l'utilisateur doit √™tre inconnu pour rompre la boucle.  La question est de savoir quelle option choisir.  Regardons les structures. <br><br>  Un utilisateur poss√®de un abonnement √† un fournisseur, mais vice versa - non, un abonnement √† un fournisseur ne poss√®de pas d'utilisateur. <br><br>  De plus, il n'y a aucun int√©r√™t √† l'existence de CarrierSubscription sans r√©f√©rence √† l'utilisateur qui en est propri√©taire. <br><br>  Par cons√©quent, le lien utilisateur doit √™tre sans propri√©taire. <br><br>  Modifiez la d√©claration de l'utilisateur dans CarrierSubscription: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> user: <span class="hljs-type"><span class="hljs-type">User</span></span></code> </pre><br>  D√©sormais utilisateur sans propri√©taire, ce qui rompt la boucle des liens et vous permet de lib√©rer tous les objets. <br><br><img src="https://habrastorage.org/webt/en/vx/cu/envxcuihbevfcfqv1cyg-kc3lo4.png"><br><br><h2>  Liens de boucle dans les fermetures </h2><br>  Les cycles de liaison pour les objets se produisent lorsque les objets ont des propri√©t√©s qui se r√©f√©rencent.  Comme les objets, les fermetures sont un type de r√©f√©rence et peuvent conduire √† des boucles de r√©f√©rence.  Les fermetures capturent les objets qu'ils utilisent. <br><br>  Par exemple, si vous affectez une fermeture √† une propri√©t√© d'une classe et que cette fermeture utilise des propri√©t√©s de la m√™me classe, nous obtenons une boucle de liens.  En d'autres termes, l'objet d√©tient un lien vers la fermeture √† travers la propri√©t√©.  La fermeture contient une r√©f√©rence √† l'objet √† travers la valeur captur√©e de soi. <br><br><img src="https://habrastorage.org/webt/z-/lh/ow/z-lhowlkfyvy4ycusafxhygjisw.png"><br><br>  Ajoutez ce code √† CarrierSubscription imm√©diatement apr√®s la propri√©t√© utilisateur: <br><br><pre> <code class="swift hljs"><span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> completePhoneNumber: () -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.countryCode + <span class="hljs-string"><span class="hljs-string">" "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.number }</code> </pre><br>  Cette fermeture calcule et renvoie le num√©ro de t√©l√©phone complet.  La propri√©t√© est d√©clar√©e <b>paresseuse</b> , elle sera attribu√©e lors de la premi√®re utilisation. <br><br>  Cela est n√©cessaire car il utilise self.countryCode et self.number, qui ne seront disponibles que lorsque le code d'initialisation sera ex√©cut√©. <br><br>  Ajoutez runScenario () √† la fin: <br><br><pre> <code class="swift hljs"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(subscription.completePhoneNumber())</code> </pre> <br>  L'appel de completePhoneNumber () ex√©cutera la fermeture. <br><br>  Lancez l'application et vous verrez que l'utilisateur et l'iPhone sont lib√©r√©s, mais CarrierSubscription ne l'est pas, en raison d'un cycle de liens solides entre l'objet et la fermeture. <br><br><img src="https://habrastorage.org/webt/7t/rb/ax/7trbaxtrrhtadtm29-dvqwehzo4.png"><br><br><h2>  Listes de capture </h2><br>  Swift fournit un moyen simple et √©l√©gant de rompre la boucle des liens solides lors des fermetures.  Vous d√©clarez une liste de capture dans laquelle vous d√©finissez la relation entre la fermeture et les objets qu'elle capture. <br><br>  Pour illustrer la liste de capture, tenez compte du code suivant: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> someClosure = { [x] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"\(x), \(y)"</span></span>) } x = <span class="hljs-number"><span class="hljs-number">6</span></span> y = <span class="hljs-number"><span class="hljs-number">6</span></span> someClosure() <span class="hljs-comment"><span class="hljs-comment">// Prints 5, 6 print("\(x), \(y)") // Prints 6, 6</span></span></code> </pre> <br>  x est dans la liste de capture de fermeture, donc la valeur de x est copi√©e dans la d√©finition de fermeture.  Il est captur√© par la valeur. <br><br>  y n'est pas dans la liste de capture, il est captur√© par r√©f√©rence.  Cela signifie que la valeur de y sera ce qu'elle √©tait au moment de l'appel du circuit. <br><br>  Les listes de verrouillage aident √† identifier les interactions faibles ou inconnues par rapport aux objets captur√©s dans la boucle.  Dans notre cas, le choix appropri√© n'est pas d√©tenu, car une fermeture ne peut pas exister si l'instance CarrierSubscription est lib√©r√©e. <br><br><h2>  Saisissez-vous </h2><br>  Remplacez la d√©finition completePhoneNumber par CarrierSubscription :: <br><br><pre> <code class="swift hljs"><span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> completePhoneNumber: () -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> = { [<span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.countryCode + <span class="hljs-string"><span class="hljs-string">" "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.number }</code> </pre> <br>  Nous ajoutons <b>[auto sans propri√©taire]</b> √† la liste de capture de fermeture.  Cela signifie que nous nous sommes captur√©s comme un lien sans <b>propri√©taire</b> au lieu d'un lien fort. <br><br>  Lancez l'application et vous verrez que CarrierSubscription est maintenant disponible. <br><br>  En fait, la syntaxe ci-dessus est une forme abr√©g√©e d'une syntaxe plus longue et plus compl√®te dans laquelle une nouvelle variable appara√Æt: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> closure = { [<span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> newID = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-comment"><span class="hljs-comment">// Use unowned newID here... }</span></span></code> </pre> <br>  Ici, newID est une copie de soi sans propri√©taire.  Au-del√† de la fermeture, le moi reste lui-m√™me.  Dans la forme abr√©g√©e donn√©e pr√©c√©demment, nous <b>cr√©ons une nouvelle variable auto</b> qui masque le soi existant √† l'int√©rieur de la fermeture. <br><br><h2>  Utilisez Unown avec pr√©caution </h2><br>  Dans votre code, la relation entre self et completePhoneNumber est d√©sign√©e comme non poss√©d√©e. <br><br>  Si vous √™tes s√ªr que l'objet utilis√© dans la fermeture ne sera pas lib√©r√©, vous pouvez l'utiliser sans propri√©taire.  S'il le fait, vous avez des ennuis! <br><br>  Ajoutez ce code √† la fin de MainViewController.swift: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WWDCGreeting</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> who: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(who: <span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.who = who } <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> greetingMaker: () -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> = { [<span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hello \(self.who)."</span></span> } }</code> </pre><br>  Voici maintenant la fin de runScenario (): <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> greetingMaker: () -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mermaid = <span class="hljs-type"><span class="hljs-type">WWDCGreeting</span></span>(who: <span class="hljs-string"><span class="hljs-string">"caffeinated mermaid"</span></span>) greetingMaker = mermaid.greetingMaker } <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(greetingMaker()) <span class="hljs-comment"><span class="hljs-comment">// !</span></span></code> </pre> <br>  Lancez l'application et vous verrez un crash et quelque chose comme √ßa dans la console: <br><br>  L'utilisateur John a √©t√© initialis√© <br>  Le t√©l√©phone iPhone XS a √©t√© initialis√© <br>  CarrierSubscription TelBel est initialis√© <br>  0032 31415926 <br>  Erreur fatale: tentative de lecture d'une r√©f√©rence non poss√©d√©e mais l'objet 0x600000f0de30 √©tait d√©j√† d√©sallou√©2019-02-24 12: 29: 40.744248-0600 Cycles [33489: 5926466] Erreur fatale: tentative de lecture d'une r√©f√©rence sans propri√©taire mais l'objet 0x600000f0de30 √©tait d√©j√† d√©sallou√© <br><br>  Une exception s'est produite car la fermeture attend que self.who existe, mais elle a √©t√© lib√©r√©e d√®s que la sir√®ne est devenue hors de port√©e √† la fin du bloc do. <br><br>  Cet exemple peut sembler aspir√© d'un doigt, mais de telles choses se produisent.  Par exemple, lorsque nous utilisons des fermetures pour d√©marrer quelque chose beaucoup plus tard, disons apr√®s la fin de l'appel asynchrone sur le r√©seau. <br><br><h2>  D√©samorcer le pi√®ge </h2><br>  Remplacez greetingMaker dans la classe WWDCGreeting par ceci: <br><br><pre> <code class="swift hljs"><span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> greetingMaker: () -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> = { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hello \(self?.who)."</span></span> }</code> </pre> <br>  Nous avons fait deux choses: premi√®rement, nous avons remplac√© les sans-propri√©taire par des faibles.  Deuxi√®mement, puisque le soi est devenu faible, nous acc√©dons √† la propri√©t√© who par le biais du soi.  Ignorez l'avertissement Xcode, nous le corrigerons bient√¥t. <br><br>  L'application ne se bloque plus, mais si vous l'ex√©cutez, nous obtenons un r√©sultat amusant: ¬´Bonjour nil¬ª. <br><br>  Peut-√™tre que le r√©sultat est tout √† fait acceptable, mais souvent nous devons faire quelque chose si l'objet a √©t√© lib√©r√©.  Cela peut √™tre fait en utilisant la d√©claration de garde. <br><br>  Remplacez le texte de cl√¥ture par ceci: <br><br><pre> <code class="swift hljs"><span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> greetingMaker: () -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> = { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"No greeting available."</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hello \(self.who)."</span></span> }</code> </pre><br>  La d√©claration du garde attribue le soi au soi faible.  Si l'auto est nul, la fermeture renvoie ¬´Aucun message d'accueil disponible¬ª.  Sinon, le moi devient une r√©f√©rence forte, donc l'objet est garanti de vivre jusqu'√† la fin de la fermeture. <br><br><h2>  Recherche de boucles de lien dans Xcode 10 </h2><br>  Maintenant que vous comprenez comment ARC fonctionne, ce que sont les boucles de liens et comment les rompre, il est temps de voir un exemple d'application r√©elle. <br><br>  Ouvrez le projet Starter situ√© dans le dossier Contacts. <br><br>  Lancez l'appli. <br><br><img src="https://habrastorage.org/webt/a8/ce/l1/a8cel1rgbdkm_fel_d880f2swf4.png"><br><br>  Il s'agit du gestionnaire de contacts le plus simple.  Essayez de cliquer sur un contact, ajoutez-en quelques nouveaux. <br><br>  Affectation des fichiers: <br><br>  ContactsTableViewController: affiche tous les contacts. <br>  DetailViewController: affiche les informations d√©taill√©es du contact s√©lectionn√©. <br>  NewContactViewController: permet d'ajouter un nouveau contact. <br>  ContactTableViewCell: cellule de tableau affichant les coordonn√©es. <br>  Contact: mod√®le de contact. <br>  Num√©ro: mod√®le de num√©ro de t√©l√©phone. <br><br>  Cependant, avec ce projet, tout va mal: il y a un cycle de liens.  Au d√©but, les utilisateurs ne remarqueront pas de probl√®mes en raison de la petite taille de la m√©moire qui fuit, pour la m√™me raison, il est difficile de trouver la fuite. <br><br>  Heureusement, Xcode 10 a des outils int√©gr√©s pour trouver la plus petite fuite de m√©moire. <br><br>  Relancez l'application.  Supprimez 3-4 contacts √† l'aide du balayage vers la gauche et du bouton Supprimer.  Il semble qu'ils disparaissent compl√®tement, non? <br><br><img src="https://habrastorage.org/webt/xu/d9/qf/xud9qf3rcyaf5ot_08l8vauizto.png"><br><br><h2>  O√π coule-t-il? </h2><br>  Lorsque l'application est en cours d'ex√©cution, cliquez sur le bouton Debug Memory Graph: <br><br><img src="https://habrastorage.org/webt/la/na/km/lanakmzc0d2ousrcf5jwkpu-ova.png"><br><br>  Observez les probl√®mes d'ex√©cution dans le navigateur de d√©bogage.  Ils sont marqu√©s de carr√©s violets avec un point d'exclamation blanc √† l'int√©rieur: <br><br><img src="https://habrastorage.org/webt/uc/ko/vj/uckovjp_eqoplopih79xuz1jl7e.png"><br><br>  S√©lectionnez l'un des objets Contact probl√©matiques dans le navigateur.  Le cycle est clairement visible: les objets Contact et Num√©ro, se r√©f√©rant l'un √† l'autre, tiennent. <br><br><img src="https://habrastorage.org/webt/7f/wi/os/7fwios8n7zdk4ww7bj81p4kvgle.png"><br><br>  On dirait que vous devriez regarder dans le code.  Gardez √† l'esprit qu'un contact peut exister sans num√©ro, mais pas vice versa. <br><br>  Comment r√©soudriez-vous cette boucle?  Lien du contact au num√©ro ou du num√©ro au contact?  faible ou sans propri√©taire?  Essayez-le d'abord! <br><br><div class="spoiler">  <b class="spoiler_title">Si vous aviez besoin d'aide ...</b> <div class="spoiler_text">  Il existe 2 solutions possibles: rendre un lien de Contact √† Num√©ro faible, ou de Num√©ro √† Contact sans propri√©taire. <br><br>  La documentation d'Apple recommande que l'objet parent ait une r√©f√©rence forte √† "enfant" - et non l'inverse.  Cela signifie que nous donnons √† Contact une r√©f√©rence forte au num√©ro et au num√©ro - un lien sans propri√©taire vers Contact: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Number</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contact: <span class="hljs-type"><span class="hljs-type">Contact</span></span> <span class="hljs-comment"><span class="hljs-comment">// Other code... } class Contact { var number: Number? // Other code... }</span></span></code> </pre> <br></div></div><br><h2>  Bonus: boucles avec types de r√©f√©rence et types de valeur. </h2><br>  Swift poss√®de des types de r√©f√©rence (classes et fermetures) et des types de valeur (structures, √©num√©rations).  Le type de valeur est copi√© lorsqu'il est transmis et les types de r√©f√©rence partagent la m√™me valeur √† l'aide du lien. <br><br>  Cela signifie que dans le cas des types de valeurs, il ne peut pas y avoir de cycles.  Pour qu'une boucle se produise, nous avons besoin d'au moins 2 types de r√©f√©rence. <br><br>  Revenons au projet Cycles et ajoutons ce code √† la fin de MainViewController.swift: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Error var payload = 0 var next: Node? }</span></span></code> </pre><br>  Ne fonctionnera pas!  La structure est un type de valeur et ne peut pas avoir de r√©cursivit√© sur une instance d'elle-m√™me.  Sinon, une telle structure aurait une taille infinie. <br><br>  Modifiez la structure en classe. <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payload = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> next: <span class="hljs-type"><span class="hljs-type">Node?</span></span> }</code> </pre> <br>  La r√©f√©rence √† elle-m√™me est tout √† fait acceptable pour les classes (type de r√©f√©rence), donc le compilateur n'a pas de probl√®mes. <br><br>  Ajoutez maintenant ceci √† la fin de MainViewController.swift: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> friends: [<span class="hljs-type"><span class="hljs-type">Person</span></span>] = [] <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(name: <span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name = name <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"New person instance: \(name)"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">deinit</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Person instance \(name) is being deallocated"</span></span>) } }</code> </pre> <br>  Et c'est √† la fin de runScenario (): <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ernie = <span class="hljs-type"><span class="hljs-type">Person</span></span>(name: <span class="hljs-string"><span class="hljs-string">"Ernie"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bert = <span class="hljs-type"><span class="hljs-type">Person</span></span>(name: <span class="hljs-string"><span class="hljs-string">"Bert"</span></span>) ernie.friends.append(bert) <span class="hljs-comment"><span class="hljs-comment">// Not deallocated bert.friends.append(ernie) // Not deallocated }</span></span></code> </pre><br>  Lancez l'appli.  Attention: ni ernie ni bert ne sont lib√©r√©s. <br><br><h2>  Lien et signification </h2><br>  Ceci est un exemple d'une combinaison d'un type de r√©f√©rence et d'un type de valeur qui a conduit √† une boucle de liens. <br><br>  ernie et bert restent in√©dits, se tenant dans leurs tableaux d'amis, bien que les tableaux eux-m√™mes soient des types de valeur. <br><br>  Essayez de faire en sorte que les amis archivent sans propri√©taire, et Xcode affichera une erreur: sans propri√©taire s'applique uniquement aux classes. <br><br>  Pour corriger cette boucle, nous devons cr√©er un objet wrapper et l'utiliser pour ajouter des instances au tableau. <br><br>  Ajoutez la d√©finition suivante avant la classe Person: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unowned</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unowned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value: <span class="hljs-type"><span class="hljs-type">T</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> (<span class="hljs-number"><span class="hljs-number">_</span></span> value: <span class="hljs-type"><span class="hljs-type">T</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.value = value } }</code> </pre><br>  Modifiez ensuite la d√©finition d'amis dans la classe Personne: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> friends: [<span class="hljs-type"><span class="hljs-type">Unowned</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Person</span></span>&gt;] = []</code> </pre> <br>  Enfin, remplacez le contenu du bloc do dans runScenario (): <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ernie = <span class="hljs-type"><span class="hljs-type">Person</span></span>(name: <span class="hljs-string"><span class="hljs-string">"Ernie"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bert = <span class="hljs-type"><span class="hljs-type">Person</span></span>(name: <span class="hljs-string"><span class="hljs-string">"Bert"</span></span>) ernie.friends.append(<span class="hljs-type"><span class="hljs-type">Unowned</span></span>(bert)) bert.friends.append(<span class="hljs-type"><span class="hljs-type">Unowned</span></span>(ernie)) }</code> </pre> <br>  Lancez l'application, maintenant ernie et bert sont correctement lib√©r√©s! <br><br>  Le tableau d'amis n'est plus une collection d'objets Person.  Il s'agit maintenant d'une <b>collection d'objets non poss√©d√©s</b> qui servent de wrappers pour les instances Person. <br><br>  Pour obtenir des objets Person de Unown, utilisez la propri√©t√© value: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> firstFriend = bert.friends.first?.value <span class="hljs-comment"><span class="hljs-comment">// get ernie</span></span></code> </pre> <br><h2>  Conclusion </h2><br>  Vous avez maintenant une bonne compr√©hension de la gestion de la m√©moire dans Swift et vous savez comment ARC fonctionne.  J'esp√®re que la publication vous a √©t√© utile. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Apple: comptage automatique des r√©f√©rences</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451130/">https://habr.com/ru/post/fr451130/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451116/index.html">Comment j'ai lutt√© avec la transition de l'√©l√©ment partag√© et √©crit ma premi√®re biblioth√®que open source</a></li>
<li><a href="../fr451118/index.html">Les tests ne sont pas pour les d√©butants</a></li>
<li><a href="../fr451120/index.html">√Ä propos des d√©fis du portage de Dead Cells sur des plateformes mobiles</a></li>
<li><a href="../fr451124/index.html">D√©veloppement de prot√©ines dans le cloud en utilisant Python et Transcriptic ou Comment cr√©er une prot√©ine pour 360 $</a></li>
<li><a href="../fr451126/index.html">Bo√Æte √† outils pour les chercheurs - Num√©ro un: auto-organisation et visualisation des donn√©es</a></li>
<li><a href="../fr451132/index.html">Contrats ax√©s sur le consommateur ou automatisation des tests d'assurance qualit√© Gitlab CI-eyed</a></li>
<li><a href="../fr451136/index.html">Introduit par .NET 5</a></li>
<li><a href="../fr451138/index.html">Symfony CLI - Nouvel outil de d√©veloppement local</a></li>
<li><a href="../fr451140/index.html">Combien cela co√ªte-t-il de cr√©er une solution IoT?</a></li>
<li><a href="../fr451144/index.html">Antiquit√©s: technique de la publicit√© t√©l√©vis√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>