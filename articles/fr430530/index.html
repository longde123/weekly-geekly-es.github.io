<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèº‚Äçü§ù‚Äçüßëüèª üë¢ ‚ùì Serveur simul√© pour l'automatisation des tests mobiles üõåüèª üçß ü§±üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En travaillant sur le dernier projet, j'ai √©t√© confront√© au test d'une application mobile connect√©e au niveau de la logique m√©tier avec diff√©rents ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur simul√© pour l'automatisation des tests mobiles</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/maxilect/blog/430530/">  En travaillant sur le dernier projet, j'ai √©t√© confront√© au test d'une application mobile connect√©e au niveau de la logique m√©tier avec diff√©rents services tiers.  Tester ces services ne faisait pas partie de ma t√¢che, cependant, des probl√®mes avec leur API ont bloqu√© le travail de l'application elle-m√™me - les tests ont √©chou√© non pas √† cause de probl√®mes √† l'int√©rieur, mais √† cause de l'inop√©rabilit√© de l'API, avant m√™me d'avoir v√©rifi√© la fonctionnalit√© n√©cessaire. <br><br>  Traditionnellement, les supports sont utilis√©s pour tester de telles applications.  Mais ils ne fonctionnent pas toujours normalement, ce qui interf√®re avec le travail.  Comme solution alternative, j'ai utilis√© moki.  Je veux parler de ce chemin √©pineux aujourd'hui. <br><br><img src="https://habrastorage.org/webt/kn/uf/vw/knufvwqxahfwy6zkqxrkgeirrga.jpeg" alt="image"><br><a name="habracut"></a><br>  Afin de ne pas toucher au code d'un vrai projet (sous NDA), pour plus de clart√©, j'ai cr√©√© un simple client REST pour Android, qui permet d'envoyer des requ√™tes HTTP (GET / POST) √† une certaine adresse avec les param√®tres dont j'ai besoin.  Nous allons le tester. <br>  Le code d'application client, les r√©partiteurs et les tests peuvent √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√©l√©charg√©s depuis GitLab</a> . <br><br><h2>  Quelles sont les options? </h2><br>  Il y avait deux fa√ßons de se moquer dans mon cas: <br><br><ul><li>  d√©ployer un faux serveur dans le cloud ou sur une machine distante (si nous parlons de d√©veloppements confidentiels qui ne peuvent pas √™tre transf√©r√©s vers le cloud); </li><li>  lancez le faux serveur localement - directement sur le t√©l√©phone sur lequel l'application mobile est test√©e. </li></ul><br>  La premi√®re option n'est pas tr√®s diff√©rente du banc d'essai.  En effet, il est possible d'allouer un poste de travail dans le r√©seau pour le faux serveur, mais il devra √™tre pris en charge, comme tout banc d'essai.  Et ici, il est n√©cessaire de rencontrer les principaux pi√®ges de cette approche.  Le poste de travail distant est mort, a cess√© de r√©pondre, quelque chose a chang√© - vous devez surveiller, modifier la configuration, c'est-√†-dire  faire la m√™me chose qu'avec le support d'un banc d'essai r√©gulier.  Nous ne pouvons pas corriger la situation par nous-m√™mes, et cela prendra certainement plus de temps que toute manipulation locale.  Donc, sp√©cifiquement dans mon projet, il √©tait plus pratique d'√©lever localement le faux serveur. <br><br><h2>  Choisir un faux serveur </h2><br>  Il existe de nombreux outils diff√©rents.  J'ai essay√© de travailler avec plusieurs et dans presque tout le monde, j'ai rencontr√© certains probl√®mes: <br><br><ul><li>  <b>Mock-server</b> , <b>wiremock</b> - deux faux serveurs que je ne pouvais pas ex√©cuter normalement sur Android.  √âtant donn√© que toutes les exp√©riences ont eu lieu dans le cadre d'un projet en direct, le temps de choix √©tait limit√©.  Apr√®s avoir creus√© avec eux quelques jours, j'ai renonc√© √† essayer. </li><li>  <b>Restmock</b> est un wrapper sur <b>okhttpmockwebserver</b> , qui sera discut√© plus en d√©tail plus tard.  √áa avait l'air bien, √ßa a commenc√©, mais le d√©veloppeur de ce wrapper a cach√© ¬´sous le capot¬ª la possibilit√© de d√©finir l'adresse IP et le port du faux serveur, et pour moi, c'√©tait critique.  Restmock a commenc√© sur un port al√©atoire.  En fouillant dans le code, j'ai vu que lorsque le serveur a √©t√© initialis√©, le d√©veloppeur a utilis√© une m√©thode qui d√©finissait le port au hasard s'il ne le recevait pas √† l'entr√©e.  En principe, on pouvait h√©riter de cette m√©thode, mais le probl√®me √©tait dans le constructeur priv√©.  En cons√©quence, j'ai refus√© l'emballage. </li><li>  <b>Okhttpmockwebserver</b> - apr√®s avoir essay√© diff√©rents outils, je me suis arr√™t√© sur le faux serveur, qui se r√©unissait normalement et a commenc√© localement sur l'appareil. </li></ul><br><h2>  Nous analysons le principe du travail </h2><br>  La version actuelle de okhttpmockwebserver vous permet d'impl√©menter plusieurs sc√©narios de travail: <br><br><ul><li>  <b>File d'attente de r√©ponses</b> .  Les r√©ponses du faux serveur sont ajout√©es √† la file d'attente FIFO.  Peu importe quelle API et quel chemin j'acc√©derai, le faux serveur lancera √† tour de r√¥le des messages dans cette file d'attente. </li><li> <b>Le r√©partiteur vous</b> permet de cr√©er des r√®gles qui d√©terminent la r√©ponse √† donner.  Supposons qu'une demande provienne d'une URL contenant un chemin, par exemple / get-login /.  Sur ce serveur / get-login / mock et donne une r√©ponse unique et pr√©d√©finie. </li><li>  <b>V√©rificateur de demande</b> .  Sur la base du sc√©nario pr√©c√©dent, je peux v√©rifier les requ√™tes que l'application envoie (que dans les conditions donn√©es, une requ√™te avec certains param√®tres part vraiment).  Cependant, la r√©ponse est sans importance, car elle est d√©termin√©e par le fonctionnement de l'API.  Ce script impl√©mente le v√©rificateur de demandes. </li></ul><br>  Examinez chacun des sc√©narios plus en d√©tail. <br><br><h3>  File d'attente de r√©ponse </h3><br>  L'impl√©mentation la plus simple du faux serveur est la file d'attente de r√©ponses.  Avant le test, je d√©termine l'adresse et le port o√π le faux serveur sera d√©ploy√©, ainsi que le fait qu'il fonctionnera sur le principe d'une file d'attente de messages - FIFO (premier entr√©, premier sorti). <br><br>  Ensuite, ex√©cutez le faux serveur. <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Before</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-class">() </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>)) mockServer.start(ip, port) } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queueTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>) returnFromResponseActivity() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>) returnFromResponseActivity() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>) returnFromResponseActivity() } }</code> </pre> <br>  Les tests sont √©crits √† l'aide du framework Espresso, con√ßu pour effectuer des actions dans les applications mobiles.  Dans cet exemple, je s√©lectionne les types de demande et les envoie √† tour de r√¥le. <br>  Apr√®s avoir commenc√© le test, le faux serveur lui donne des r√©ponses conform√©ment √† la file d'attente prescrite et le test r√©ussit sans erreur. <br><br><h3>  Impl√©mentation de Dispatcher </h3><br>  Un r√©partiteur est un ensemble de r√®gles selon lesquelles un faux serveur fonctionne.  Pour plus de commodit√©, j'ai cr√©√© trois r√©partiteurs diff√©rents: SimpleDispatcher, OtherParamsDispatcher et ListingDispatcher. <br><br><h4>  Simpledispatcher </h4><br>  Okhttpmockwebserver fournit la classe <code>Dispatcher()</code> pour impl√©menter le r√©partiteur.  Vous pouvez en h√©riter en rempla√ßant la fonction de <code>dispatch</code> √† votre mani√®re. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"GET"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) } }</code> </pre><br>  La logique de cet exemple est simple: si un GET arrive, je renvoie un message qu'il s'agit d'une demande GET.  Si POST, je renvoie un message sur la demande POST.  Dans d'autres situations, je renvoie une demande vide. <br><br>  <code>SimpleDispatcher</code> appara√Æt dans le test - un objet de la classe <code>SimpleDispatcher</code> , que j'ai d√©crit ci-dessus.  De plus, comme dans l'exemple pr√©c√©dent, le serveur simul√© est lanc√©, mais cette fois, une sorte de r√®gle pour travailler avec ce serveur simul√© est indiqu√©e - le m√™me r√©partiteur. <br><br>  Les sources de test avec <code>SimpleDispatcher</code> peuvent √™tre trouv√©es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans le r√©f√©rentiel</a> . <br><br><h4>  AutreParamsDispatcher </h4><br>  En rempla√ßant la fonction de <code>dispatch</code> , je peux repousser d'autres param√®tres de demande pour envoyer des r√©ponses: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OtherParamsDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> when { request.path.contains(<span class="hljs-string"><span class="hljs-string">"?queryKey=value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request with query parameter queryKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request with body parameter bodyKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.headers.toString().contains(<span class="hljs-string"><span class="hljs-string">"header: value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was some request with header equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ Wrong response }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } } }</code> </pre><br>  Dans ce cas, je d√©montre plusieurs options pour les conditions. <br><br>  Tout d'abord, vous pouvez transmettre des param√®tres √† l'API dans la barre d'adresse.  Par cons√©quent, je peux mettre une condition sur l'entr√©e de n'importe quel bundle dans le chemin, par exemple, <code>‚Äú?queryKey=value‚Äù</code> . <br>  Deuxi√®mement, cette classe vous permet d'entrer dans le corps du corps des requ√™tes POST ou PUT.  Par exemple, vous pouvez utiliser <code>contains</code> en ex√©cutant d'abord <code>toString()</code> .  Dans mon exemple, la condition est d√©clench√©e lorsqu'une requ√™te POST contenant <code>‚ÄúbodyKey‚Äù:‚Äùvalue‚Äù</code> .  De m√™me, je peux valider l'en- <code>header : value</code> la demande (en- <code>header : value</code> ). <br><br>  Pour des exemples de tests, je recommande de se r√©f√©rer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">au r√©f√©rentiel</a> . <br><br><h4>  ListingDispatcher </h4><br>  Si n√©cessaire, vous pouvez impl√©menter une logique plus complexe - ListingDispatcher.  De la m√™me mani√®re, je remplace la fonction de <code>dispatch</code> .  Cependant, maintenant dans la classe, j'ai d√©fini l'ensemble par d√©faut de <code>stubsList</code> ( <code>stubsList</code> ) - mok pour diff√©rentes occasions. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stubsList: ArrayList&lt;RequestClass&gt; = defaultRequests() <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { stubsList.first { it.matcher(request.path, request.body.toString()) }.response() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: NoSuchElementException) { Log.e(<span class="hljs-string"><span class="hljs-string">"Unexisting request path ="</span></span>, request.path) MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">404</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultRequests</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: ArrayList&lt;RequestClass&gt; </span></span>{ val allStubs = ArrayList&lt;RequestClass&gt;() allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/get"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /get url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and body contains bodyParam:value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allStubs } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ stubsList.add(stub) } }</code> </pre><br>  Pour ce faire, j'ai cr√©√© une classe ouverte <code>RequestClass</code> , dont tous les champs sont vides par d√©faut.  Pour cette classe, je d√©finis une fonction de <code>response</code> qui cr√©e un objet <code>MockResponse</code> (renvoyant une r√©ponse 200 ou un autre <code>responseText</code> ), et une fonction de correspondance qui retourne <code>true</code> ou <code>false</code> . <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">open class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val path:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val query: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val body:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val responseText: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code: Int = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">200</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: MockResponse </span></span>= MockResponse() .setResponseCode(code) .setBody(responseText) <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(apiCall: String, apiBody: String)</span></span></span><span class="hljs-function">: Boolean </span></span>= apiCall.startsWith(path)&amp;&amp;apiCall.contains(query)&amp;&amp;apiBody.contains(body) }</code> </pre><br>  Par cons√©quent, je peux cr√©er des combinaisons de conditions plus complexes pour les talons.  Cette conception m'a sembl√© plus flexible, bien que le principe de base soit tr√®s simple. <br><br>  Mais surtout dans cette approche, j'ai aim√© pouvoir remplacer certains stubs sur le pouce, s'il est n√©cessaire de changer quelque chose dans la r√©ponse du serveur simul√© lors d'un test.  Lorsque vous testez de grands projets, ce probl√®me se produit assez souvent, par exemple, lors de la v√©rification de certains sc√©narios sp√©cifiques. <br>  Le remplacement peut √™tre effectu√© comme suit: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) }</code> </pre><br>  Avec cette impl√©mentation du r√©partiteur, les tests restent simples.  Je d√©marre √©galement le faux serveur, s√©lectionnez uniquement <code>ListingDispatcher</code> . <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcherTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dispatcher</span></span></span><span class="hljs-class"> </span></span>= ListingDispatcher() <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.setDispatcher(dispatcher) mockServer.start(ip, port) } . . . }</code> </pre><br>  Par souci d'exp√©rience, j'ai remplac√© le talon par POST: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postReplacedStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyParam"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) replacePostStub() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, params = params) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br>  Pour ce faire, a appel√© la fonction <code>replacePostStub</code> partir d'un <code>dispatcher</code> r√©gulier et a ajout√© une nouvelle <code>response</code> . <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacePostStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.replaceMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br>  Dans le test ci-dessus, je v√©rifie que le talon a √©t√© remplac√©. <br>  Ensuite, j'ai ajout√© un nouveau stub, qui n'√©tait pas par d√©faut. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNewStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ addSomeStub() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/some_specific_url"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSomeStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.addMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/some_specific_url"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br><h3>  V√©rificateur de demande </h3><br>  Le dernier cas - Request verifier - ne pr√©voit pas l'espionnage, mais v√©rifie les demandes envoy√©es par l'application.  Pour ce faire, je d√©marre simplement le faux serveur en impl√©mentant le r√©partiteur afin que l'application renvoie au moins quelque chose. <br>  Lors de l'envoi d'une demande √† partir d'un test, elle arrive au serveur factice.  Gr√¢ce √† lui, je peux acc√©der aux param√®tres de la demande √† l'aide de <code>takeRequest()</code> . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestVerifierTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyKey"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) val headers: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"header"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, headers = headers, params = params) val request = mockServer.takeRequest() assertEquals(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, request.method) assertEquals(<span class="hljs-string"><span class="hljs-string">"value"</span></span>, request.getHeader(<span class="hljs-string"><span class="hljs-string">"header"</span></span>)) assertTrue(request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>)) assertTrue(request.path.startsWith(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>)) }</code> </pre><br>  Ci-dessus, j'ai montr√© le test avec un exemple simple.  Exactement la m√™me approche peut √™tre utilis√©e pour JSON complexe, y compris pour v√©rifier la structure enti√®re de la demande (vous pouvez comparer au niveau JSON ou analyser JSON en objets et v√©rifier l'√©galit√© au niveau objet). <br><br><h2>  R√©sum√© </h2><br>  En g√©n√©ral, j'ai aim√© l'outil (okhttpmockwebserver), et je l'utilise sur un grand projet.  Bien s√ªr, il y a quelques petites choses que j'aimerais changer. <br>  Par exemple, je n'aime pas que vous ayez √† frapper l'adresse locale (localhost: 8080 dans notre exemple) dans les configs de votre application;  peut-√™tre que je peux toujours trouver un moyen de tout configurer pour que le faux serveur r√©ponde lorsqu'il essaie d'envoyer une demande √† n'importe quelle adresse. <br>  De plus, je n'ai pas la possibilit√© de rediriger les demandes - lorsque le faux serveur envoie une demande suppl√©mentaire, s'il n'a pas de talon appropri√©.  Il n'y a pas une telle approche dans ce faux serveur.  Cependant, il n‚Äôa m√™me pas √©t√© mis en ≈ìuvre, car pour le moment le projet ¬´combat¬ª n‚Äôa pas une telle t√¢che. <br><br>  Auteur de l'article: Ruslan Abdulin <br><br>  PS Nous publions nos articles sur plusieurs sites du Runet.  Abonnez-vous √† nos pages sur les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cha√Ænes</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">VK</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FB</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Telegram</a> pour d√©couvrir toutes nos publications et autres actualit√©s Maxilect. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430530/">https://habr.com/ru/post/fr430530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430520/index.html">Pr√©sentation de Spring Data MongoDB</a></li>
<li><a href="../fr430522/index.html">Avez-vous besoin d'une culture d'entreprise en informatique? Confession du chef de marque du studio Krasnodar Plarium</a></li>
<li><a href="../fr430524/index.html">Architecture de r√©seau de neurones</a></li>
<li><a href="../fr430526/index.html">Machines √† sous: d'o√π viennent-elles en URSS et comment sont-elles arrang√©es</a></li>
<li><a href="../fr430528/index.html">Programmation avec PyUSB 1.0</a></li>
<li><a href="../fr430532/index.html">S√©curit√© dans les applications iOS</a></li>
<li><a href="../fr430534/index.html">Cr√©ation d'un mod√®le pour Zabbix en utilisant le DVR Trassir SDK comme exemple</a></li>
<li><a href="../fr430536/index.html">Conception de fonctions de fen√™tre r√©sum√©es en une unit√© avec un niveau donn√© de chevauchement</a></li>
<li><a href="../fr430538/index.html">Lisez-vous Scaladoc pour les m√©thodes de collecte ¬´√©videntes¬ª? Ou pourquoi la paresse n'est pas toujours bonne</a></li>
<li><a href="../fr430542/index.html">Webinaire ouvert ¬´Infrastructure en tant que code¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>