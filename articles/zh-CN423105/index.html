<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¦ˆ âšœï¸ ğŸ System.IO.Pipelinesï¼š.NETä¸­çš„é«˜æ€§èƒ½IO ğŸ‘ŒğŸ¼ ğŸ•¥ âœ¡ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="System.IO.Pipelinesæ˜¯ä¸€ä¸ªæ–°çš„åº“ï¼Œå¯ç®€åŒ–.NETä¸­çš„ä»£ç ç»„ç»‡ã€‚ å¦‚æœå¿…é¡»å¤„ç†å¤æ‚çš„ä»£ç ï¼Œå¾ˆéš¾ç¡®ä¿é«˜æ€§èƒ½å’Œå‡†ç¡®æ€§ã€‚ System.IO.Pipelinesçš„ä»»åŠ¡æ˜¯ç®€åŒ–ä»£ç ã€‚ å‰Šå‡æ›´å¤šç»†èŠ‚ï¼ 



 è¯¥åº“çš„äº§ç”Ÿæ˜¯.NET Coreå¼€å‘å›¢é˜ŸåŠªåŠ›ä½¿Kestrelæˆä¸ºä¸šç•Œæœ€å¿«çš„WebæœåŠ¡å™¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>System.IO.Pipelinesï¼š.NETä¸­çš„é«˜æ€§èƒ½IO</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/423105/">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">System.IO.Pipelines</a>æ˜¯ä¸€ä¸ªæ–°çš„åº“ï¼Œå¯ç®€åŒ–.NETä¸­çš„ä»£ç ç»„ç»‡ã€‚ å¦‚æœå¿…é¡»å¤„ç†å¤æ‚çš„ä»£ç ï¼Œå¾ˆéš¾ç¡®ä¿é«˜æ€§èƒ½å’Œå‡†ç¡®æ€§ã€‚  System.IO.Pipelinesçš„ä»»åŠ¡æ˜¯ç®€åŒ–ä»£ç ã€‚ å‰Šå‡æ›´å¤šç»†èŠ‚ï¼ <br><br><img src="https://habrastorage.org/webt/nq/me/p-/nqmep-tqvyyv5nlkpcxjnmlw8z4.jpeg"><a name="habracut"></a><br><br> è¯¥åº“çš„äº§ç”Ÿæ˜¯.NET Coreå¼€å‘å›¢é˜ŸåŠªåŠ›ä½¿Kestrelæˆä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸šç•Œæœ€å¿«çš„WebæœåŠ¡å™¨ä¹‹ä¸€çš„ç»“æœ</a> ã€‚ å®ƒæœ€åˆè¢«è®¤ä¸ºæ˜¯Kestrelå®ç°çš„ä¸€éƒ¨åˆ†ï¼Œä½†å·²ç»å‘å±•æˆä¸ºå¯é‡ç”¨çš„APIï¼Œåœ¨2.1ç‰ˆä¸­å¯ä½œä¸ºä¸€æµçš„BCL APIï¼ˆSystem.IO.Pipelinesï¼‰ä½¿ç”¨ã€‚ <br><br><h2> å¥¹èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ </h2><br> ä¸ºäº†æ­£ç¡®åˆ†ææ¥è‡ªæµæˆ–å¥—æ¥å­—çš„æ•°æ®ï¼Œæ‚¨éœ€è¦ç¼–å†™å¤§é‡æ ‡å‡†ä»£ç ã€‚ åŒæ—¶ï¼Œå­˜åœ¨è®¸å¤šä½¿ä»£ç æœ¬èº«åŠå…¶æ”¯æŒå¤æ‚åŒ–çš„é™·é˜±ã€‚ <br><br><h2> ä»Šå¤©å‡ºç°äº†ä»€ä¹ˆå›°éš¾ï¼Ÿ </h2><br> è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä»»åŠ¡å¼€å§‹ã€‚ æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªTCPæœåŠ¡å™¨æ¥ä»å®¢æˆ·ç«¯æ¥æ”¶è¡Œåˆ†éš”çš„æ¶ˆæ¯ï¼ˆ\ nï¼‰ã€‚ <br><br><h2> å¸¦æœ‰NetworkStreamçš„TCPæœåŠ¡å™¨ </h2><br> åå·®ï¼šå¦‚åŒåœ¨ä»»ä½•éœ€è¦é«˜æ€§èƒ½çš„ä»»åŠ¡ä¸­ä¸€æ ·ï¼Œåº”æ ¹æ®åº”ç”¨ç¨‹åºçš„åŠŸèƒ½æ¥è€ƒè™‘æ¯ç§ç‰¹å®šæƒ…å†µã€‚ å¦‚æœç½‘ç»œåº”ç”¨ç¨‹åºçš„è§„æ¨¡ä¸æ˜¯å¾ˆå¤§ï¼Œé‚£ä¹ˆèŠ±èµ„æºæ¥ä½¿ç”¨å„ç§æ–¹æ³•å¯èƒ½å°±æ²¡æœ‰æ„ä¹‰ï¼Œç¨åå°†å¯¹æ­¤è¿›è¡Œè®¨è®ºã€‚ <br><br> ä½¿ç”¨ç®¡é“ä¹‹å‰çš„å¸¸è§„.NETä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> stream.ReadAsync(buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer.Length); <span class="hljs-comment"><span class="hljs-comment">// Process a single line from the buffer ProcessLine(buffer); }</span></span></code> </pre> <br> è¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šçš„sample1.cs</a> <br><br> è¯¥ä»£ç å¯èƒ½ä¼šä¸æœ¬â€‹â€‹åœ°æµ‹è¯•ä¸€èµ·ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒæœ‰å¾ˆå¤šé”™è¯¯ï¼š <br><br><ul><li> ä¹Ÿè®¸åœ¨ä¸€æ¬¡è°ƒç”¨ReadAsyncä¹‹åï¼Œå°†ä¸ä¼šæ”¶åˆ°æ•´ä¸ªæ¶ˆæ¯ï¼ˆåˆ°è¯¥è¡Œçš„æœ«å°¾ï¼‰ã€‚ </li><li> å®ƒå¿½ç•¥stream.ReadAsyncï¼ˆï¼‰æ–¹æ³•çš„ç»“æœ-å®é™…ä¼ è¾“åˆ°ç¼“å†²åŒºçš„æ•°æ®é‡ã€‚ </li><li> è¯¥ä»£ç ä¸å¤„ç†åœ¨å•ä¸ªReadAsyncè°ƒç”¨ä¸­æ¥æ”¶å¤šè¡Œã€‚ </li></ul><br> è¿™äº›æ˜¯æœ€å¸¸è§çš„æµæ•°æ®è¯»å–é”™è¯¯ã€‚ ä¸ºäº†é¿å…å®ƒä»¬ï¼Œæ‚¨éœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹ï¼š <br><br><ul><li> æ‚¨éœ€è¦ç¼“å†²ä¼ å…¥çš„æ•°æ®ï¼Œç›´åˆ°æ‰¾åˆ°æ–°è¡Œã€‚ </li><li> æœ‰å¿…è¦åˆ†æè¿”å›åˆ°ç¼“å†²åŒºçš„æ‰€æœ‰è¡Œã€‚ </li></ul><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesBuffered = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesRead = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> stream.ReadAsync(buffer, bytesBuffered, buffer.Length - bytesBuffered); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytesRead == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// EOF break; } // Keep track of the amount of buffered bytes bytesBuffered += bytesRead; var linePosition = -1; do { // Look for a EOL in the buffered data linePosition = Array.IndexOf(buffer, (byte)'\n', bytesConsumed, bytesBuffered - bytesConsumed); if (linePosition &gt;= 0) { // Calculate the length of the line based on the offset var lineLength = linePosition - bytesConsumed; // Process the line ProcessLine(buffer, bytesConsumed, lineLength); // Move the bytesConsumed to skip past the line we consumed (including \n) bytesConsumed += lineLength + 1; } } while (linePosition &gt;= 0); } }</span></span></code> </pre> <br> è¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šçš„sample2.cs</a> <br><br> æˆ‘å†è¯´ä¸€éï¼šè¿™å¯ä»¥åœ¨æœ¬åœ°æµ‹è¯•ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯æœ‰æ—¶å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡1 Kbï¼ˆ1024å­—èŠ‚ï¼‰ã€‚ å¿…é¡»å¢åŠ è¾“å…¥ç¼“å†²åŒºçš„å¤§å°ï¼Œç›´åˆ°æ‰¾åˆ°æ–°è¡Œã€‚ <br><br> æ­¤å¤–ï¼Œåœ¨å¤„ç†é•¿å­—ç¬¦ä¸²æ—¶ï¼Œæˆ‘ä»¬ä¼šå°†ç¼“å†²åŒºæ”¶é›†åˆ°æ•°ç»„ä¸­ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ArrayPoolæ”¹è¿›æ­¤è¿‡ç¨‹ï¼Œå®ƒå¯ä»¥é¿å…åœ¨åˆ†ææ¥è‡ªå®¢æˆ·ç«¯çš„é•¿è¡Œæ—¶é‡æ–°åˆ†é…ç¼“å†²åŒºã€‚ <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buffer = ArrayPool&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;.Shared.Rent(<span class="hljs-number"><span class="hljs-number">1024</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesBuffered = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Calculate the amount of bytes remaining in the buffer var bytesRemaining = buffer.Length - bytesBuffered; if (bytesRemaining == 0) { // Double the buffer size and copy the previously buffered data into the new buffer var newBuffer = ArrayPool&lt;byte&gt;.Shared.Rent(buffer.Length * 2); Buffer.BlockCopy(buffer, 0, newBuffer, 0, buffer.Length); // Return the old buffer to the pool ArrayPool&lt;byte&gt;.Shared.Return(buffer); buffer = newBuffer; bytesRemaining = buffer.Length - bytesBuffered; } var bytesRead = await stream.ReadAsync(buffer, bytesBuffered, bytesRemaining); if (bytesRead == 0) { // EOF break; } // Keep track of the amount of buffered bytes bytesBuffered += bytesRead; do { // Look for a EOL in the buffered data linePosition = Array.IndexOf(buffer, (byte)'\n', bytesConsumed, bytesBuffered - bytesConsumed); if (linePosition &gt;= 0) { // Calculate the length of the line based on the offset var lineLength = linePosition - bytesConsumed; // Process the line ProcessLine(buffer, bytesConsumed, lineLength); // Move the bytesConsumed to skip past the line we consumed (including \n) bytesConsumed += lineLength + 1; } } while (linePosition &gt;= 0); } }</span></span></code> </pre> <br>  <i>å‚è§<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šçš„sample3.cs</a></i> <br><br> è¯¥ä»£ç å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯ç°åœ¨ç¼“å†²åŒºå¤§å°å·²æ›´æ”¹ï¼Œå› æ­¤å‡ºç°äº†è®¸å¤šå‰¯æœ¬ã€‚ è¿˜ä½¿ç”¨æ›´å¤šçš„å†…å­˜ï¼Œå› ä¸ºé€»è¾‘ä¸ä¼šåœ¨å¤„ç†è¡Œåå‡å°‘ç¼“å†²åŒºã€‚ ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥ä¿å­˜ç¼“å†²åŒºåˆ—è¡¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡å­—ç¬¦ä¸²åˆ°è¾¾â€‹â€‹çš„é•¿åº¦å¤§äº1 Kbæ—¶éƒ½æ›´æ”¹ç¼“å†²åŒºçš„å¤§å°ã€‚ <br><br> æ­¤å¤–ï¼Œåœ¨å®Œå…¨ä¸ºç©ºä¹‹å‰ï¼Œæˆ‘ä»¬ä¸ä¼šå¢åŠ 1 KBçš„ç¼“å†²åŒºå¤§å°ã€‚ è¿™æ„å‘³ç€æˆ‘ä»¬å°†è¶Šæ¥è¶Šå°çš„ç¼“å†²åŒºè½¬ç§»åˆ°ReadAsyncï¼Œç»“æœï¼Œå¯¹æ“ä½œç³»ç»Ÿçš„è°ƒç”¨æ¬¡æ•°å°†å¢åŠ ã€‚ <br><br> æˆ‘ä»¬å°†å°è¯•æ¶ˆé™¤è¿™ç§æƒ…å†µï¼Œå¹¶åœ¨ç°æœ‰ç¼“å†²åŒºçš„å¤§å°å°äº512å­—èŠ‚æ—¶ç«‹å³åˆ†é…ä¸€ä¸ªæ–°ç¼“å†²åŒºï¼š <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BufferSegment</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Buffer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Count { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Remaining =&gt; Buffer.Length - Count; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NetworkStream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minimumBufferSize = <span class="hljs-number"><span class="hljs-number">512</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> segments = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;BufferSegment&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumed = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesConsumedBufferIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> segment = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferSegment { Buffer = ArrayPool&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;.Shared.Rent(<span class="hljs-number"><span class="hljs-number">1024</span></span>) }; segments.Add(segment); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Calculate the amount of bytes remaining in the buffer if (segment.Remaining &lt; minimumBufferSize) { // Allocate a new segment segment = new BufferSegment { Buffer = ArrayPool&lt;byte&gt;.Shared.Rent(1024) }; segments.Add(segment); } var bytesRead = await stream.ReadAsync(segment.Buffer, segment.Count, segment.Remaining); if (bytesRead == 0) { break; } // Keep track of the amount of buffered bytes segment.Count += bytesRead; while (true) { // Look for a EOL in the list of segments var (segmentIndex, segmentOffset) = IndexOf(segments, (byte)'\n', bytesConsumedBufferIndex, bytesConsumed); if (segmentIndex &gt;= 0) { // Process the line ProcessLine(segments, segmentIndex, segmentOffset); bytesConsumedBufferIndex = segmentOffset; bytesConsumed = segmentOffset + 1; } else { break; } } // Drop fully consumed segments from the list so we don't look at them again for (var i = bytesConsumedBufferIndex; i &gt;= 0; --i) { var consumedSegment = segments[i]; // Return all segments unless this is the current segment if (consumedSegment != segment) { ArrayPool&lt;byte&gt;.Shared.Return(consumedSegment.Buffer); segments.RemoveAt(i); } } } } (int segmentIndex, int segmentOffest) IndexOf(List&lt;BufferSegment&gt; segments, byte value, int startBufferIndex, int startSegmentOffset) { var first = true; for (var i = startBufferIndex; i &lt; segments.Count; ++i) { var segment = segments[i]; // Start from the correct offset var offset = first ? startSegmentOffset : 0; var index = Array.IndexOf(segment.Buffer, value, offset, segment.Count - offset); if (index &gt;= 0) { // Return the buffer index and the index within that segment where EOL was found return (i, index); } first = false; } return (-1, -1); }</span></span></code> </pre> <br>  <i>è¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šçš„sample4.cs</a></i> <br><br> ç»“æœï¼Œä»£ç éå¸¸å¤æ‚ã€‚ åœ¨æœç´¢å®šç•Œç¬¦æœŸé—´ï¼Œâ€‹â€‹æˆ‘ä»¬è·Ÿè¸ªå¡«å……çš„ç¼“å†²åŒºã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªåˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨åœ¨æœç´¢æ–°çš„è¡Œåˆ†éš”ç¬¦æ—¶æ˜¾ç¤ºç¼“å†²çš„æ•°æ®ã€‚ ç»“æœï¼ŒProcessLineå’ŒIndexOfå°†æ¥å—Listè€Œä¸æ˜¯å­—èŠ‚[]ï¼Œåç§»é‡å’Œè®¡æ•°ã€‚ è§£æé€»è¾‘å°†å¼€å§‹å¤„ç†ç¼“å†²åŒºçš„ä¸€ä¸ªæˆ–å¤šä¸ªæ®µã€‚ <br><br> ç°åœ¨ï¼ŒæœåŠ¡å™¨å°†å¤„ç†éƒ¨åˆ†æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨å…±äº«å†…å­˜æ¥å‡å°‘æ•´ä½“å†…å­˜æ¶ˆè€—ã€‚ ä½†æ˜¯ï¼Œéœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹ï¼š <br><br><ol><li> åœ¨ArrayPoolbyteä¸­ï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨Byte []-æ ‡å‡†ç®¡ç†çš„æ•°ç»„ã€‚ æ¢å¥è¯è¯´ï¼Œå½“æ‰§è¡ŒReadAsyncæˆ–WriteAsyncå‡½æ•°æ—¶ï¼Œç¼“å†²åŒºçš„æœ‰æ•ˆæœŸä¸å¼‚æ­¥æ“ä½œçš„æ—¶é—´ï¼ˆä¸æ“ä½œç³»ç»Ÿè‡ªå·±çš„I / O APIè¿›è¡Œäº¤äº’ï¼‰æœ‰å…³ã€‚ ç”±äºå›ºå®šçš„å†…å­˜æ— æ³•ç§»åŠ¨ï¼Œå› æ­¤ä¼šå½±å“åƒåœ¾æ”¶é›†å™¨çš„æ€§èƒ½ï¼Œå¹¶å¯èƒ½å¯¼è‡´é˜µåˆ—ç¢ç‰‡åŒ–ã€‚ æ‚¨å¯èƒ½éœ€è¦æ›´æ”¹æ± çš„å®ç°ï¼Œå…·ä½“å–å†³äºå¼‚æ­¥æ“ä½œç­‰å¾…æ‰§è¡Œçš„æ—¶é—´ã€‚ </li><li> é€šè¿‡ä¸­æ–­è¯»å–å’Œå¤„ç†é€»è¾‘ä¹‹é—´çš„é“¾æ¥å¯ä»¥æé«˜ååé‡ã€‚ æˆ‘ä»¬å¾—åˆ°äº†æ‰¹å¤„ç†çš„æ•ˆæœï¼Œç°åœ¨è§£æé€»è¾‘å°†èƒ½å¤Ÿè¯»å–å¤§é‡æ•°æ®ï¼Œå¤„ç†è¾ƒå¤§çš„ç¼“å†²åŒºå—ï¼Œè€Œä¸æ˜¯åˆ†æå•ä¸ªè¡Œã€‚ ç»“æœï¼Œä»£ç å˜å¾—æ›´åŠ å¤æ‚ï¼š <br><br><ul><li> å¿…é¡»åˆ›å»ºä¸¤ä¸ªå½¼æ­¤ç‹¬ç«‹å·¥ä½œçš„å¾ªç¯ã€‚ ç¬¬ä¸€ä¸ªå°†ä»å¥—æ¥å­—è¯»å–æ•°æ®ï¼Œç¬¬äºŒä¸ªå°†åˆ†æç¼“å†²åŒºã€‚ </li><li> æ‰€éœ€è¦çš„æ˜¯ä¸€ç§å‘Šè¯‰è§£æé€»è¾‘æ•°æ®å˜å¾—å¯ç”¨çš„æ–¹æ³•ã€‚ </li><li> è¿˜å¿…é¡»ç¡®å®šå¦‚æœå¾ªç¯ä»å¥—æ¥å­—è¯»å–æ•°æ®çš„é€Ÿåº¦è¿‡å¿«ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ å¦‚æœè§£æé€»è¾‘è·Ÿä¸ä¸Šè¯»å–å‘¨æœŸï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§è°ƒæ•´è¯»å–å‘¨æœŸçš„æ–¹æ³•ã€‚ è¿™é€šå¸¸ç§°ä¸ºâ€œæµé‡æ§åˆ¶â€æˆ–â€œæµåŠ¨é˜»åŠ›â€ã€‚ </li><li> æˆ‘ä»¬å¿…é¡»ç¡®ä¿æ•°æ®å®‰å…¨ä¼ è¾“ã€‚ ç°åœ¨ï¼Œè¿™ç»„ç¼“å†²åŒºåœ¨è¯»å–å‘¨æœŸå’Œè§£æå‘¨æœŸä¸­éƒ½è¢«ä½¿ç”¨ï¼›å®ƒä»¬åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šå½¼æ­¤ç‹¬ç«‹å·¥ä½œã€‚ </li><li> å†…å­˜ç®¡ç†é€»è¾‘è¿˜æ¶‰åŠä¸¤ä¸ªä¸åŒçš„ä»£ç æ®µï¼šä»ç¼“å†²æ± å€Ÿç”¨æ•°æ®ï¼ˆä»å¥—æ¥å­—è¯»å–æ•°æ®ï¼‰ï¼Œä»¥åŠä»ç¼“å†²æ± è¿”å›ï¼ˆè¿™æ˜¯è§£æé€»è¾‘ï¼‰ã€‚ </li><li> æ‰§è¡Œè§£æé€»è¾‘åï¼Œåœ¨è¿”å›ç¼“å†²åŒºæ—¶å¿…é¡»æ ¼å¤–å°å¿ƒã€‚ å¦åˆ™ï¼Œæˆ‘ä»¬æœ‰æœºä¼šè¿”å›ä»å°†å¥—æ¥å­—è¯»å–é€»è¾‘å†™å…¥å…¶ä¸­çš„ç¼“å†²åŒºã€‚ </li></ul></li></ol><br> å¤æ‚æ€§å¼€å§‹è”“å»¶ï¼ˆè¿™è¿œéæ‰€æœ‰æƒ…å†µï¼ï¼‰ã€‚ è¦åˆ›å»ºé«˜æ€§èƒ½ç½‘ç»œï¼Œæ‚¨éœ€è¦ç¼–å†™éå¸¸å¤æ‚çš„ä»£ç ã€‚ <br><br>  System.IO.Pipelinesçš„ç›®çš„æ˜¯ç®€åŒ–æ­¤è¿‡ç¨‹ã€‚ <br><br><h4>  TCPæœåŠ¡å™¨å’ŒSystem.IO.Pipelines </h4><br> è®©æˆ‘ä»¬çœ‹çœ‹System.IO.Pipelinesçš„å·¥ä½œåŸç†ï¼š <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessLinesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Socket socket</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pipe = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pipe(); Task writing = FillPipeAsync(socket, pipe.Writer); Task reading = ReadPipeAsync(pipe.Reader); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.WhenAll(reading, writing); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FillPipeAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Socket socket, PipeWriter writer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minimumBufferSize = <span class="hljs-number"><span class="hljs-number">512</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Allocate at least 512 bytes from the PipeWriter Memory&lt;byte&gt; memory = writer.GetMemory(minimumBufferSize); try { int bytesRead = await socket.ReceiveAsync(memory, SocketFlags.None); if (bytesRead == 0) { break; } // Tell the PipeWriter how much was read from the Socket writer.Advance(bytesRead); } catch (Exception ex) { LogError(ex); break; } // Make the data available to the PipeReader FlushResult result = await writer.FlushAsync(); if (result.IsCompleted) { break; } } // Tell the PipeReader that there's no more data coming writer.Complete(); } async Task ReadPipeAsync(PipeReader reader) { while (true) { ReadResult result = await reader.ReadAsync(); ReadOnlySequence&lt;byte&gt; buffer = result.Buffer; SequencePosition? position = null; do { // Look for a EOL in the buffer position = buffer.PositionOf((byte)'\n'); if (position != null) { // Process the line ProcessLine(buffer.Slice(0, position.Value)); // Skip the line + the \n character (basically position) buffer = buffer.Slice(buffer.GetPosition(1, position.Value)); } } while (position != null); // Tell the PipeReader how much of the buffer we have consumed reader.AdvanceTo(buffer.Start, buffer.End); // Stop reading if there's no more data coming if (result.IsCompleted) { break; } } // Mark the PipeReader as complete reader.Complete(); }</span></span></code> </pre> <br>  <i>è¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šçš„sample5.cs</a></i> <br><br> æˆ‘ä»¬çš„çº¿è·¯é˜…è¯»å™¨çš„æµæ°´çº¿ç‰ˆæœ¬æœ‰ä¸¤ä¸ªå¾ªç¯ï¼š <br><br><ul><li>  FillPipeAsyncä»å¥—æ¥å­—è¯»å–å¹¶å†™å…¥PipeWriterã€‚ </li><li>  ReadPipeAsyncä»PipeReaderè¯»å–å¹¶åˆ†æä¼ å…¥çš„è¡Œã€‚ </li></ul><br> ä¸ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸åŒï¼Œæ²¡æœ‰ä¸“é—¨åˆ†é…çš„ç¼“å†²åŒºã€‚ è¿™æ˜¯System.IO.Pipelinesçš„ä¸»è¦åŠŸèƒ½ä¹‹ä¸€ã€‚ æ‰€æœ‰ç¼“å†²åŒºç®¡ç†ä»»åŠ¡éƒ½å°†ä¼ è¾“åˆ°PipeReader / PipeWriterå®ç°ã€‚ <br><br> è¯¥è¿‡ç¨‹å¾—ä»¥ç®€åŒ–ï¼šæˆ‘ä»¬ä»…å°†ä»£ç ç”¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯å®ç°å¤æ‚çš„ç¼“å†²åŒºç®¡ç†ã€‚ <br><br> åœ¨ç¬¬ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œé¦–å…ˆè°ƒç”¨PipeWriter.GetMemoryï¼ˆintï¼‰ä»ä¸»ç¼–å†™å™¨è·å–ä¸€å®šæ•°é‡çš„å†…å­˜ã€‚ ç„¶åè°ƒç”¨PipeWriter.Advanceï¼ˆintï¼‰ï¼Œå®ƒå‘Šè¯‰PipeWriterå®é™…å°†å¤šå°‘æ•°æ®å†™å…¥ç¼“å†²åŒºã€‚ æ¥ä¸‹æ¥æ˜¯å¯¹PipeWriter.FlushAsyncï¼ˆï¼‰çš„è°ƒç”¨ï¼Œä»¥ä¾¿PipeReaderå¯ä»¥è®¿é—®æ•°æ®ã€‚ <br><br> ç¬¬äºŒä¸ªå¾ªç¯ä½¿ç”¨ç”±PipeWriterå†™å…¥ä½†æœ€åˆä»å¥—æ¥å­—æ¥æ”¶çš„ç¼“å†²åŒºã€‚ å½“è¿”å›å¯¹PipeReader.ReadAsyncï¼ˆï¼‰çš„è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å°†è·å¾—ä¸€ä¸ªReadResultï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªé‡è¦æ¶ˆæ¯ï¼šä»¥ReadOnlySequenceå½¢å¼è¯»å–çš„æ•°æ®ä»¥åŠé€»è¾‘æ•°æ®ç±»å‹IsCompletedï¼Œè¯¥é€»è¾‘æ•°æ®ç±»å‹å‘ŠçŸ¥è¯»å–å™¨å†™å…¥å™¨æ˜¯å¦å·²å®Œæˆå·¥ä½œï¼ˆEOFï¼‰ã€‚ æ‰¾åˆ°è¡Œç»ˆæ­¢ç¬¦ï¼ˆEOLï¼‰å¹¶åˆ†æäº†å­—ç¬¦ä¸²åï¼Œæˆ‘ä»¬ä¼šå°†ç¼“å†²åŒºæ‹†åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ï¼Œä»¥è·³è¿‡å·²å¤„ç†çš„ç‰‡æ®µã€‚ æ­¤åï¼Œè°ƒç”¨PipeReader.AdvanceToï¼Œå®ƒå‘Šè¯‰PipeReaderå·²æ¶ˆè€—äº†å¤šå°‘æ•°æ®ã€‚ <br><br> åœ¨æ¯ä¸ªå‘¨æœŸç»“æŸæ—¶ï¼Œé˜…è¯»å™¨å’Œå†™å…¥å™¨å‡å®Œæˆã€‚ ç»“æœï¼Œä¸»é€šé“é‡Šæ”¾æ‰€æœ‰åˆ†é…çš„å†…å­˜ã€‚ <br><br><h2> ç³»ç»Ÿç®¡é“ </h2><br><h4> éƒ¨åˆ†é˜…è¯» </h4><br> é™¤äº†ç®¡ç†å†…å­˜ï¼ŒSystem.IO.Pipelinesè¿˜æ‰§è¡Œå¦ä¸€ä¸ªé‡è¦åŠŸèƒ½ï¼šå®ƒæ‰«æé€šé“ä¸­çš„æ•°æ®ï¼Œä½†ä¸ä½¿ç”¨å®ƒã€‚ <br><br>  PipeReaderå…·æœ‰ä¸¤ä¸ªä¸»è¦çš„APIï¼šReadAsyncå’ŒAdvanceToã€‚  ReadAsyncä»é€šé“æ¥æ”¶æ•°æ®ï¼ŒAdvanceToå‘Šè¯‰PipeReaderè¯»å–å™¨ä¸å†éœ€è¦è¿™äº›ç¼“å†²åŒºï¼Œå› æ­¤æ‚¨å¯ä»¥æ‘†è„±å®ƒä»¬ï¼ˆä¾‹å¦‚ï¼Œå°†å®ƒä»¬è¿”å›åˆ°ä¸»ç¼“å†²æ± ï¼‰ã€‚ <br><br> ä»¥ä¸‹æ˜¯HTTPåˆ†æå™¨çš„ç¤ºä¾‹ï¼Œè¯¥åˆ†æå™¨ä»éƒ¨åˆ†é€šé“æ•°æ®ç¼“å†²åŒºè¯»å–æ•°æ®ï¼Œç›´åˆ°æ¥æ”¶åˆ°åˆé€‚çš„èµ·å§‹è¡Œã€‚ <br><br><img src="https://habrastorage.org/webt/9c/lp/d8/9clpd8h1r6b1m1jrwultkuggw6i.png"><br><br><h2>  ReadOnlySequenceT </h2><br> é€šé“å®ç°å­˜å‚¨åœ¨PipeWriterå’ŒPipeReaderä¹‹é—´ä¼ é€’çš„ç›¸å…³ç¼“å†²åŒºçš„åˆ—è¡¨ã€‚  PipeReader.ReadAsyncå…¬å¼€ReadOnlySequenceï¼Œå®ƒæ˜¯ä¸€ç§æ–°å‹çš„BCLï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ªReadOnlyMemory &lt;T&gt;æ®µç»„æˆã€‚ å®ƒç±»ä¼¼äºSpanæˆ–Memoryï¼Œå®ƒä½¿æˆ‘ä»¬æœ‰æœºä¼šæŸ¥çœ‹æ•°ç»„å’Œå­—ç¬¦ä¸²ã€‚ <br><br><img src="https://habrastorage.org/webt/79/y0/kw/79y0kwylohggq941soblji6qd2o.png"><br><br> é€šé“å†…éƒ¨æœ‰æŒ‡é’ˆï¼Œè¿™äº›æŒ‡é’ˆæ˜¾ç¤ºè¯»å–å™¨å’Œå†™å…¥å™¨åœ¨çªå‡ºæ˜¾ç¤ºçš„å¸¸è§„æ•°æ®é›†ä¸­çš„ä½ç½®ï¼Œå¹¶åœ¨å†™å…¥å’Œè¯»å–æ•°æ®æ—¶å¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚  SequencePositionæ˜¯ç¼“å†²åŒºçš„é“¾æ¥åˆ—è¡¨ä¸­çš„å•ä¸ªç‚¹ï¼Œç”¨äºæœ‰æ•ˆåœ°åˆ†éš”ReadOnlySequence &lt;T&gt;ã€‚ <br><br> ç”±äºReadOnlySequence &lt;T&gt;æ”¯æŒä¸€ä¸ªæˆ–å¤šä¸ªæ®µï¼Œå› æ­¤é«˜æ€§èƒ½é€»è¾‘çš„æ ‡å‡†æ“ä½œæ˜¯æ ¹æ®æ®µæ•°åˆ†éš”å¿«é€Ÿè·¯å¾„å’Œæ…¢é€Ÿè·¯å¾„ã€‚ <br><br> ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå°†ASCII ReadOnlySequenceè½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„å‡½æ•°ï¼š <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAsciiString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ReadOnlySequence&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.IsSingleSegment) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Encoding.ASCII.GetString(buffer.First.Span); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Create((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)buffer.Length, buffer, (span, sequence) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> segment <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sequence) { Encoding.ASCII.GetChars(segment.Span, span); span = span.Slice(segment.Length); } }); }</code> </pre> <br> è¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šçš„sample6.cs</a> <br><br><h4> æµé˜»å’Œæµé‡æ§åˆ¶ </h4><br> ç†æƒ³æƒ…å†µä¸‹ï¼Œè¯»å–å’Œåˆ†æå¯ä»¥ååŒå·¥ä½œï¼šè¯»å–æµæ¶ˆè€—æ¥è‡ªç½‘ç»œçš„æ•°æ®å¹¶å°†å…¶æ”¾å…¥ç¼“å†²åŒºï¼Œè€Œåˆ†ææµåˆ›å»ºåˆé€‚çš„æ•°æ®ç»“æ„ã€‚ åˆ†æé€šå¸¸æ¯”ä»ç½‘ç»œå¤åˆ¶æ•°æ®å—èŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚ ç»“æœï¼Œè¯»å–æµå¾ˆå®¹æ˜“ä½¿åˆ†ææµè¶…è½½ã€‚ å› æ­¤ï¼Œè¯»å–æµå°†è¢«è¿«å‡æ…¢é€Ÿåº¦æˆ–æ¶ˆè€—æ›´å¤šå†…å­˜ä»¥ä¿å­˜åˆ†ææµçš„æ•°æ®ã€‚ ä¸ºäº†ç¡®ä¿æœ€ä½³æ€§èƒ½ï¼Œéœ€è¦åœ¨æš‚åœé¢‘ç‡å’Œåˆ†é…å¤§é‡å†…å­˜ä¹‹é—´å–å¾—å¹³è¡¡ã€‚ <br><br> ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œç®¡é“å…·æœ‰ä¸¤ä¸ªæ•°æ®æµæ§åˆ¶åŠŸèƒ½ï¼šPauseWriterThresholdå’ŒResumeWriterThresholdã€‚  PauseWriterThresholdç¡®å®šåœ¨PipeWriter.FlushAsyncæš‚åœä¹‹å‰éœ€è¦ç¼“å†²å¤šå°‘æ•°æ®ã€‚  ResumeWriterThresholdç¡®å®šè®°å½•å™¨æ¢å¤æ“ä½œä¹‹å‰è¯»å–å™¨å¯ä»¥æ¶ˆè€—å¤šå°‘å†…å­˜ã€‚ <br><br><img src="https://habrastorage.org/webt/qf/yj/5u/qfyj5u6aahkadlp8nk1gtc9bqr4.png"><br><br> å½“ç®¡é“æµä¸­çš„æ•°æ®é‡è¶…è¿‡PauseWriterThresholdä¸­è®¾ç½®çš„é™åˆ¶æ—¶ï¼ŒPipeWriter.FlushAsyncå°†â€œé”å®šâ€ï¼Œè€Œå½“å…¶ä¸‹é™åˆ°ResumeWriterThresholdä¸­è®¾ç½®çš„é™åˆ¶ä»¥ä¸‹æ—¶ï¼Œâ€œè§£é”â€ã€‚ ä¸ºäº†é˜²æ­¢è¶…å‡ºæ¶ˆè€—é™åˆ¶ï¼Œä»…ä½¿ç”¨ä¸¤ä¸ªå€¼ã€‚ <br><br><h4>  I / Oè°ƒåº¦ </h4><br> ä½¿ç”¨å¼‚æ­¥/ç­‰å¾…æ—¶ï¼Œé€šå¸¸åœ¨æ± çº¿ç¨‹æˆ–å½“å‰çš„SynchronizationContextä¸­è°ƒç”¨åç»­æ“ä½œã€‚ <br><br> åœ¨æ‰§è¡ŒI / Oæ—¶ï¼Œä»”ç»†ç›‘è§†æ‰§è¡Œä½ç½®éå¸¸é‡è¦ï¼Œä»¥ä¾¿æ›´å¥½åœ°åˆ©ç”¨å¤„ç†å™¨ç¼“å­˜ã€‚ è¿™å¯¹äºWebæœåŠ¡å™¨ç­‰é«˜æ€§èƒ½åº”ç”¨ç¨‹åºè‡³å…³é‡è¦ã€‚  System.IO.Pipelinesä½¿ç”¨PipeSchedulerç¡®å®šåœ¨å“ªé‡Œæ‰§è¡Œå¼‚æ­¥å›è°ƒã€‚ è¿™ä½¿æ‚¨å¯ä»¥éå¸¸ç²¾ç¡®åœ°æ§åˆ¶å°†å“ªäº›æµç”¨äºI / Oã€‚ <br><br> å®é™…åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªç¤ºä¾‹æ˜¯Kestrel Libuvä¼ è¾“ï¼Œå…¶ä¸­åœ¨äº‹ä»¶å¾ªç¯çš„ä¸“ç”¨é€šé“ä¸Šæ‰§è¡ŒI / Oå›è°ƒã€‚ <br><br><h2>  PipeReaderæ¨¡æ¿è¿˜æœ‰å…¶ä»–å¥½å¤„ã€‚ </h2><br><ul><li> ä¸€äº›åŸºæœ¬ç³»ç»Ÿæ”¯æŒâ€œç­‰å¾…è€Œä¸ç¼“å†²â€ï¼šæ‚¨ä¸éœ€è¦åˆ†é…ç¼“å†²åŒºï¼Œç›´åˆ°åŸºæœ¬ç³»ç»Ÿä¸­å‡ºç°å¯ç”¨æ•°æ®ä¸ºæ­¢ã€‚ å› æ­¤ï¼Œåœ¨å…·æœ‰epollçš„Linuxä¸Šï¼Œåœ¨æ•°æ®å‡†å¤‡å°±ç»ªä¹‹å‰ï¼Œæ‚¨æ— æ³•æä¾›è¯»å–ç¼“å†²åŒºã€‚ è¿™æ ·å¯ä»¥é¿å…å‡ºç°è®¸å¤šçº¿ç¨‹åœ¨ç­‰å¾…æ•°æ®çš„æƒ…å†µï¼Œè€Œæ‚¨éœ€è¦ç«‹å³ä¿ç•™å¤§é‡çš„å†…å­˜ã€‚ </li><li> é»˜è®¤ç®¡é“ä½¿ç¼–å†™ç½‘ç»œä»£ç çš„å•å…ƒæµ‹è¯•å˜å¾—å®¹æ˜“ï¼šè§£æé€»è¾‘ä¸ç½‘ç»œä»£ç åˆ†å¼€ï¼Œå¹¶ä¸”å•å…ƒæµ‹è¯•ä»…åœ¨å­˜å‚¨å™¨çš„ç¼“å†²åŒºä¸­è¿è¡Œæ­¤é€»è¾‘ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»ç½‘ç»œä½¿ç”¨å®ƒã€‚ é€šè¿‡å‘é€éƒ¨åˆ†æ•°æ®ï¼Œè¿˜å¯ä»¥è½»æ¾æµ‹è¯•å¤æ‚çš„æ¨¡å¼ã€‚  ASP.NET Coreä½¿ç”¨å®ƒæ¥æµ‹è¯•Kestrelçš„httpè§£æå·¥å…·çš„å„ä¸ªæ–¹é¢ã€‚ </li><li> å…è®¸ç”¨æˆ·ä»£ç ä½¿ç”¨ä¸»è¦OSç¼“å†²åŒºçš„ç³»ç»Ÿï¼ˆä¾‹å¦‚ï¼Œå·²æ³¨å†Œçš„Windows I / O APIï¼‰æœ€åˆé€‚åˆä½¿ç”¨ç®¡é“ï¼Œå› ä¸ºPipeReaderå®ç°å§‹ç»ˆæä¾›ç¼“å†²åŒºã€‚ </li></ul><br><h4> å…¶ä»–ç›¸å…³ç±»å‹ </h4><br> æˆ‘ä»¬è¿˜å‘System.IO.Pipelinesæ·»åŠ äº†è®¸å¤šæ–°çš„ç®€å•BCLç±»å‹ï¼š <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MemoryPoolT</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IMemoryOwnerT</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MemoryManagerT</a> ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ArrayPoolT</a>æ˜¯åœ¨.NET Core 1.0ä¸­æ·»åŠ çš„ï¼Œè€Œåœ¨.NET Core 2.1ä¸­ï¼Œç°åœ¨æœ‰ä¸€ç§é€‚ç”¨äºä»»ä½•MemoryTçš„æ± çš„æ›´é€šç”¨çš„æŠ½è±¡è¡¨ç¤ºã€‚ æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå®æ–½æ›´é«˜çº§çš„åˆ†å‘ç­–ç•¥ä»¥åŠæ§åˆ¶ç¼“å†²åŒºç®¡ç†ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨é¢„å®šä¹‰çš„ç¼“å†²åŒºè€Œä¸æ˜¯ä¸“é—¨ç®¡ç†çš„æ•°ç»„ï¼‰ã€‚ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IBufferWriterT</a>æ˜¯ç”¨äºè®°å½•åŒæ­¥ç¼“å†²æ•°æ®ï¼ˆç”±PipeWriterå®ç°ï¼‰çš„æ¥æ”¶å™¨ã€‚ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IValueTaskSource</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ValueTaskT</a>è‡ª.NET Core 1.1å‘å¸ƒä»¥æ¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°±</a>å­˜åœ¨ï¼Œä½†æ˜¯åœ¨.NET Core 2.1ä¸­ï¼Œå®ƒå·²ç»è·å¾—äº†éå¸¸æœ‰æ•ˆçš„å·¥å…·ï¼Œè¿™äº›å·¥å…·å¯ä»¥æä¾›ä¸é—´æ–­çš„å¼‚æ­¥æ“ä½œè€Œæ— éœ€åˆ†å‘ã€‚ æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a> ã€‚ </li></ul><br><h2> å¦‚ä½•ä½¿ç”¨è¾“é€æœºï¼Ÿ </h2><br> è¿™äº›APIä½äºnugetåŒ…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">System.IO.Pipelinesä¸­</a> ã€‚ <br><br> æœ‰å…³ä½¿ç”¨ç®¡é“å¤„ç†å°å†™æ¶ˆæ¯çš„ç¤ºä¾‹.NET Server 2.1æœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼ˆæ¥è‡ªä¸Šé¢çš„ç¤ºä¾‹ï¼‰ï¼Œè¯·å‚è§<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a> ã€‚ å¯ä»¥ä½¿ç”¨dotnet runï¼ˆæˆ–Visual Studioï¼‰å¯åŠ¨å®ƒã€‚ åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼ŒæœŸæœ›ä»ç«¯å£8087ä¸Šçš„å¥—æ¥å­—ä¼ è¾“æ•°æ®ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯å†™å…¥æ§åˆ¶å°ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨è¯¸å¦‚netcatæˆ–puttyä¹‹ç±»çš„å®¢æˆ·ç«¯è¿æ¥åˆ°ç«¯å£8087ã€‚ å‘é€ä¸€ä¸ªå°å†™çš„æ¶ˆæ¯ï¼Œçœ‹çœ‹å®ƒå¦‚ä½•å·¥ä½œã€‚ <br><br> å½“å‰ï¼Œç®¡é“åœ¨Kestrelå’ŒSignalRä¸Šè¿è¡Œï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ¥å®ƒå°†åœ¨è®¸å¤šç½‘ç»œåº“å’Œ.NETç¤¾åŒºçš„ç»„ä»¶ä¸­æ‰¾åˆ°æ›´å¹¿æ³›çš„åº”ç”¨ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423105/">https://habr.com/ru/post/zh-CN423105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423093/index.html">æˆ‘ä»¬å¢åŠ äº†[å¯èƒ½] [å‡ ä¹]æ˜¯å¶ç„¶çš„äº‹å®çš„éšæœºæ€§</a></li>
<li><a href="../zh-CN423095/index.html">Apple Presentationä¸Šçš„æ–°åŠŸèƒ½</a></li>
<li><a href="../zh-CN423097/index.html">PostgreSQLæˆ˜æ–—æœºçš„ä»»åŠ¡å’Œè§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="../zh-CN423101/index.html">ä¸ºProxmoxéƒ¨ç½²LINSTORå­˜å‚¨</a></li>
<li><a href="../zh-CN423103/index.html">Pythonæ’­å®¢ï¼šä»…æ­¤è€Œå·²</a></li>
<li><a href="../zh-CN423107/index.html">æˆ‘ä»¬é‚€è¯·æ‚¨å‚åŠ ç”Ÿäº§ä¸­çš„ä¼šè®®</a></li>
<li><a href="../zh-CN423109/index.html">è‹¹æœä»‹ç»äº†ä»€ä¹ˆä»¥åŠiOSå¼€å‘äººå‘˜å¯¹æ­¤æœ‰ä½•çœ‹æ³•</a></li>
<li><a href="../zh-CN423115/index.html">CSSèƒŒæ™¯å›¾å±‚æ··åˆæ¨¡å¼æ”¹å–„äº†æ•ˆæœ</a></li>
<li><a href="../zh-CN423117/index.html">å¯¿å‘½æ›´é•¿æˆ–å¹´é¾„å¢é•¿æ›´æ…¢ï¼šä¸€ç§æŠ€æœ¯æ‰‹æ®µæ¥å»¶å¹´ç›Šå¯¿</a></li>
<li><a href="../zh-CN423119/index.html">DIY TTLè¡—æœºæœº...åœ¨2018å¹´</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>