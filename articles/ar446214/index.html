<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ ๐ง๐พ OS1: ููุงุฉ ุจุฏุงุฆูุฉ ุนูู Rust ูู x86. ุงูุฌุฒุก 3. ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ุ ุงุณุชุซูุงุก ุฎุทุฃ ุงูุตูุญุฉ ุ ุงููููุฉ ูุงููุฎุตุตุงุช ๐จ๐พโ๐ซ โณ ๐จ๐พโ๐ผ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุงูุฌุฒุก ุงูุงูู 
 ุงูุฌุฒุก ุงูุซุงูู 


 ููุถูุน ูุญุงุฏุซุฉ ุงูููู ูู ุงูุนูู ูุน ุงูุฐุงูุฑุฉ. ุณุฃุชุญุฏุซ ุนู ุชููุฆุฉ ุฏููู ุงูุตูุญุฉ ุ ูุฑุณู ุงูุฎุฑุงุฆุท ููุฐุงูุฑุฉ ุงููุนููุฉ ุ ูุฅุฏุงุฑุฉ ูููุฉ ุงูุฐุงูุฑ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OS1: ููุงุฉ ุจุฏุงุฆูุฉ ุนูู Rust ูู x86. ุงูุฌุฒุก 3. ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ุ ุงุณุชุซูุงุก ุฎุทุฃ ุงูุตูุญุฉ ุ ุงููููุฉ ูุงููุฎุตุตุงุช</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446214/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฌุฒุก ุงูุงูู</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฌุฒุก ุงูุซุงูู</a> </p><br><p style=";text-align:right;direction:rtl">  ููุถูุน ูุญุงุฏุซุฉ ุงูููู ูู ุงูุนูู ูุน ุงูุฐุงูุฑุฉ.  ุณุฃุชุญุฏุซ ุนู ุชููุฆุฉ ุฏููู ุงูุตูุญุฉ ุ ูุฑุณู ุงูุฎุฑุงุฆุท ููุฐุงูุฑุฉ ุงููุนููุฉ ุ ูุฅุฏุงุฑุฉ ูููุฉ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ ุงูุงูุชุฑุงุถูุฉ ูุงููุคุณุณูุฉ ูููุฎุตุต. </p><br><p style=";text-align:right;direction:rtl">  ููุง ููุช ูู ุงูููุงูุฉ ุงูุฃููู ุ ูุฑุฑุช ุงุณุชุฎุฏุงู 4 ููุบุงุจุงูุช ูู ุงูุตูุญุงุช ูุชุจุณูุท ุญูุงุชู ูููุณ ูู ุงูุถุฑูุฑู ุงูุชุนุงูู ูุน ุงูุฌุฏุงูู ุงููุฑููุฉ.  ูู ุงููุณุชูุจู ุ ุขูู ุฃู ุฃุฐูุจ ุฅูู ุตูุญุงุช ุจุญุฌู 4 ููููุจุงูุช ุ ูุซู ูุนุธู ุงูุฃูุธูุฉ ุงูุญุฏูุซุฉ.  ูููููู ุฃู ุฃุณุชุฎุฏู ูุงุญุฏุฉ ุฌุงูุฒุฉ (ุนูู ุณุจูู ุงููุซุงู ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฃุฏุงุฉ ุชุฎุตูุต ุงูุจููู ูุฐู</a> ) ุ ููู ูุชุงุจุฉ ูุชุงุจู ูุงู ุฃูุซุฑ ุฅุซุงุฑุฉ ููุงูุชูุงู ููููุงู ูุฃุฑุฏุช ุฃู ุฃููู ููููุงู ููู ุชุนูุด ุงูุฐุงูุฑุฉ ุ ูุฐูู ูุฏู ุดูุก ุฃุฎุจุฑู ุจู. </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl"> ูู ุงููุฑุฉ ุงูุฃุฎูุฑุฉ ุงูุชู ุงุณุชูุฑุช ูููุง ุนูู ุฃุณููุจ setup_pd ุงูุฐู ูุนุชูุฏ ุนูู ุงูููุฏุณุฉ ูุฃุฑุฏุช ุงููุชุงุจุนุฉ ูุนู ุ ููุน ุฐูู ุ ูุงู ููุงู ูุฒูุฏ ูู ุงูุชูุงุตูู ุงูุชู ูู ุฃุบุทููุง ูู ุงูููุงูุฉ ุงูุณุงุจูุฉ - ุฅุฎุฑุงุฌ VGA ุจุงุณุชุฎุฏุงู Rust ู ุงููุงูุฑู println ุงูููุงุณู.  ููุฐ ุชูููุฐู ุชุงููุฉ ุ ุณุฃุฒููู ุชุญุช ุงูููุณุฏ.  ุงูุฑูุฒ ููุฌูุฏ ูู ุญุฒูุฉ ุงูุชุตุญูุญ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุงูุฑู println</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"><code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[macro_export]</span></span> <span class="hljs-built_in"><span class="hljs-built_in">macro_rules!</span></span> print { ($($arg:tt)*) =&gt; ($crate::debug::_print(<span class="hljs-built_in"><span class="hljs-built_in">format_args!</span></span>($($arg)*))); } <span class="hljs-meta"><span class="hljs-meta">#[macro_export]</span></span> <span class="hljs-built_in"><span class="hljs-built_in">macro_rules!</span></span> println { () =&gt; ($crate::<span class="hljs-built_in"><span class="hljs-built_in">print!</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>)); ($($arg:tt)*) =&gt; ($crate::<span class="hljs-built_in"><span class="hljs-built_in">print!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">format_args!</span></span>($($arg)*))); } <span class="hljs-meta"><span class="hljs-meta">#[cfg(target_arch = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"x86"</span></span></span><span class="hljs-meta">)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_print</span></span></span></span>(args: core::fmt::Arguments) { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> core::fmt::Write; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> super::arch::vga; vga::VGA_WRITER.lock().write_fmt(args).unwrap(); } <span class="hljs-meta"><span class="hljs-meta">#[cfg(target_arch = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"x86_64"</span></span></span><span class="hljs-meta">)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_print</span></span></span></span>(args: core::fmt::Arguments) { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> core::fmt::Write; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> super::arch::vga; <span class="hljs-comment"><span class="hljs-comment">// vga::VGA_WRITER.lock().write_fmt(args).unwrap(); }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุงูุขู ุ ุจุถููุฑ ูุฑุชุงุญ ุ ุฃุนูุฏ ุฅูู ุงูุฐุงูุฑุฉ. </p><br><h1 id="inicializaciya-direktorii-stranic" style=";text-align:right;direction:rtl">  ุชููุฆุฉ ุฏููู ุงูุตูุญุฉ </h1><br><p style=";text-align:right;direction:rtl">  ุฃุฎุฐุช ุทุฑููุฉ kmain ุงูุฎุงุตุฉ ุจูุง ุซูุงุซ ูุณูุทุงุช ููุฏุฎูุงุช ุ ุฅุญุฏุงูุง ูู ุงูุนููุงู ุงูุธุงูุฑู ูุฌุฏูู ุงูุตูุญุฉ.  ูุงุณุชุฎุฏุงููุง ูุงุญููุง ููุชุฎุตูุต ูุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุ ุชุญุชุงุฌ ุฅูู ุชุนููู ุจููุฉ ุงูุณุฌูุงุช ูุงูุฏูุงุฆู.  ุจุงููุณุจุฉ ุฅูู x86 ุ ูุชู ูุตู ุฏููู ุงูุตูุญุฉ ูุฌุฏูู ุงูุตูุญุฉ ุฌูุฏูุง ุ ูุฐูู ุณุฃูุตุฑ ููุณู ุนูู ุฏููู ุชูููุฏู ุตุบูุฑ.  ุฅุฏุฎุงู ุฏููู ุงูุตูุญุฉ ุนุจุงุฑุฉ ุนู ุจููุฉ ุญุฌู ูุคุดุฑ ุ ุจุงููุณุจุฉ ููุง ูู 4 ุจุงูุช.  ุชุญุชูู ุงููููุฉ ุนูู ุนููุงู ูุนูู ูุฏุฑู 4 ููููุจุงูุช ููุตูุญุฉ.  ุงูุจุงูุช ุงูุฃูู ุฃูููุฉ ูู ุงูุณุฌู ูุญุฌูุฒ ููุฃุนูุงู.  ุชุจุฏู ุขููุฉ ุชุญููู ุงูุนููุงู ุงูุงูุชุฑุงุถู ุฅูู ุนููุงู ูุนูู (ูู ุญุงูุฉ ุงูุชูุงุตูู ุงูุฏูููุฉ 4 ููุฌุงุจุงูุช ุ ูุญุฏุซ ุงูุชุบููุฑ ุจููุฏุงุฑ 22 ุจุช. ุจุงููุณุจุฉ ุฅูู ุงูุชูุงุตูู ุงูุฏูููุฉ ุงูุฃุฎุฑู ุ ุณูููู ุงูุชุบููุฑ ูุฎุชูููุง ูุณูุชู ุงุณุชุฎุฏุงู ุงูุฌุฏุงูู ุงููุฑููุฉ!): </p><br><blockquote style=";text-align:right;direction:rtl">  ุงูุนููุงู ุงูุงูุชุฑุงุถู 0xC010A110 -&gt; ุงุญุตู ุนูู ุงูููุฑุณ ูู ุงูุฏููู ุจููู ุงูุนููุงู 22 ุจุช ุฅูู ุงููููู -&gt; ุงูููุฑุณ 0x300 -&gt; ุงูุญุตูู ุนูู ุงูุนููุงู ุงููุนูู ููุตูุญุฉ ุจูุงุณุทุฉ ููุฑุณ 0x300 ุ ูุงูุชุญูู ูู ุงูุฃุนูุงู ูุงูุญุงูุฉ -&gt; 0x1000000 -&gt; ุฎุฐ ุงูุฌุฒุก ุงูุณููู 22 ุจุช ูู ุงูุนููุงู ุงูุธุงูุฑู ูุฅุฒุงุญุฉ ุ ุฃุถู ุฅูู ุงูุนููุงู ุงููุนูู ููุตูุญุฉ -&gt; 0x1000000 + 0x10A110 = ุงูุนููุงู ุงููุนูู ูู ุงูุฐุงูุฑุฉ 0x110A110 </blockquote><p style=";text-align:right;direction:rtl">  ูุชุณุฑูุน ุงููุตูู ุ ูุณุชุฎุฏู ุงููุนุงูุฌ TLB - ุงูุชุฑุฌูุฉ lookaside ุงููุฎุฒู ุงููุคูุช ุ ูุงูุฐู ูุฎุฒู ุนูุงููู ุงูุตูุญุงุช. </p><br><p style=";text-align:right;direction:rtl">  ูุฐูู ุ ุฅููู ููููุฉ ูุตู ุฏูููู ูุฅุฏุฎุงูุงุชู ุ ููุชู ุชูููุฐ ุทุฑููุฉ setup_pd ุฐุงุชูุง.  ููุชุงุจุฉ ุตูุญุฉ ุ ูุชู ุชุทุจูู ุทุฑููุฉ "ุงูููุดุฆ" ุ ูุงูุชู ุชุถูู ุงููุญุงุฐุงุฉ ุจููุฏุงุฑ 4 ููููุจุงูุช ูุฅุนุฏุงุฏ ุงูุฅุดุงุฑุงุช ุ ูุทุฑููุฉ ููุญุตูู ุนูู ุงูุนููุงู ุงููุนูู ููุตูุญุฉ.  ุฏููู ูู ูุฌุฑุฏ ูุฌููุนุฉ ูู 1024 ุฅุฏุฎุงูุงุช ุฃุฑุจุนุฉ ุจุงูุช.  ูููู ููุฏููู ุฅูุฑุงู ุนููุงู ุงูุชุฑุงุถู ุจุตูุญุฉ ุจุงุณุชุฎุฏุงู ุทุฑููุฉ set_by_addr. </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PDirectoryEntry</span></span></span></span>(<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> PDirectoryEntry { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">by_phys_address</span></span></span></span>(address: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, flags: PDEntryFlags) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Self</span></span> { PDirectoryEntry((address <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) &amp; ADDRESS_MASK | flags.bits()) } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flags</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; PDEntryFlags { PDEntryFlags::from_bits_truncate(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phys_address</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> &amp; ADDRESS_MASK } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dbg</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PDirectory</span></span></span></span> { entries: [PDirectoryEntry; <span class="hljs-number"><span class="hljs-number">1024</span></span>] } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> PDirectory { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, idx: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; PDirectoryEntry { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.entries[idx] } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_by_addr</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, logical_addr: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, entry: PDirectoryEntry) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set(PDirectory::to_idx(logical_addr), entry); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, idx: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, entry: PDirectoryEntry) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.entries[idx] = entry; <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { invalidate_page(idx); } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_logical_addr</span></span></span></span>(idx: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> { (idx &lt;&lt; <span class="hljs-number"><span class="hljs-number">22</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_idx</span></span></span></span>(logical_addr: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> { (logical_addr &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) } } <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> lazy_static::lazy_static; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> spin::Mutex; lazy_static! { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> PAGE_DIRECTORY: Mutex&lt;&amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> PDirectory&gt; = Mutex::new( <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> *(<span class="hljs-number"><span class="hljs-number">0xC0000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> PDirectory) } ); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup_pd</span></span></span></span>(pd: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> data = PAGE_DIRECTORY.lock(); *data = &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> *(pd <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> PDirectory); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุฏ ุฌุนูุช ูู ุงูุชููุฆุฉ ุงูุฃูููุฉ ุงูุซุงุจุชุฉ ุนููุงููุง ุบูุฑ ููุฌูุฏ ุญุฑุฌูุง ููุบุงูุฉ ุ ูุฐุง ุณุฃููู ููุชููุง ุฅุฐุง ูุชุจุช ูู ููู ูููู ูู ุงููุนุชุงุฏ ูู ูุฌุชูุน Rust ุงูููุงู ุจูุฐู ุงูุชููุฆุฉ ูุน ุฅุนุงุฏุฉ ุชุนููู ุงูุงุฑุชุจุงุท. </p><br><p style=";text-align:right;direction:rtl">  ูุงูุขู ุจุนุฏ ุฃู ุฃุตุจุญ ุจููุฏูุฑูุง ุฅุฏุงุฑุฉ ุงูุตูุญุงุช ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุนุงููุฉ ุงููุณุชูู ุ ูููููุง ุงูุงูุชูุงู ุฅูู ุชุฌููุน ุชููุฆุฉ ุงูุฐุงูุฑุฉ.  ุณูุญุฏุซ ุฐูู ุนูู ูุฑุญูุชูู: ูู ุฎูุงู ูุนุงูุฌุฉ ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ุงููุนููุฉ ูุชููุฆุฉ ุงููุฏูุฑ ุงูุธุงูุฑู </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> mb_magic { <span class="hljs-number"><span class="hljs-number">0x2BADB002</span></span> =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"multibooted v1, yeah, reading mb info"</span></span>); boot::init_with_mb1(mb_pointer); }, . . . . . . } memory::init();</code> </pre> <br><h1 id="karta-pamyati-grub-i-karta-fizicheskoy-pamyati-os1" style=";text-align:right;direction:rtl">  ุจุทุงูุฉ ุงูุฐุงูุฑุฉ GRUB ูุจุทุงูุฉ ุงูุฐุงูุฑุฉ ุงููุนููุฉ OS1 </h1><br><p style=";text-align:right;direction:rtl">  ูู ุฃุฌู ุงูุญุตูู ุนูู ุจุทุงูุฉ ุฐุงูุฑุฉ ูู GRUB ุ ูู ูุฑุญูุฉ ุงูุชูููุฏ ุ ููุช ุจุชุนููู ุงูุนูุงูุฉ ุงูููุงุจูุฉ ูู ุงูุฑุฃุณ ุ ูุฃุนุทุงูู GRUB ุงูุนููุงู ุงููุนูู ููุจููุฉ.  ููุฏ ูููุชู ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุซุงุฆู ุงูุฑุณููุฉ</a> ุฅูู ุชุฏููู ุงูุตุฏุฃ ุ ูุฃุถูุช ุฃูุถูุง ุทุฑููุง ููุชูุฑุงุฑ ุจุดูู ูุฑูุญ ุนุจุฑ ุจุทุงูุฉ ุงูุฐุงูุฑุฉ.  ูู ูุชู ููุก ูุนุธู ูููู GRUB ุ ููู ูุฐู ุงููุฑุญูุฉ ุ ููุณ ูู ุงููุซูุฑ ููุงูุชูุงู ุจุงููุณุจุฉ ูู.  ุงูุดูุก ุงูุฑุฆูุณู ูู ุฃููู ูุง ุฃุฑูุฏ ุชุญุฏูุฏ ููุฏุงุฑ ุงูุฐุงูุฑุฉ ุงููุชููุฑุฉ ูุฏูููุง. </p><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุงูุชููุฆุฉ ูู ุฎูุงู Multiboot ุ ูููู ุฃููุงู ุจุชุญููู ุงูุนููุงู ุงููุนูู ุฅูู ุงูุชุฑุงุถู.  ูุธุฑููุง ุ ูููู ูู GRUB ูุถุน ุงููููู ูู ุฃู ููุงู ุ ูุฐูู ุฅุฐุง ูุงู ุงูุนููุงู ููุชุฏ ุฅูู ูุง ุจุนุฏ ุงูุตูุญุฉ ุ ูุฃูุช ุจุญุงุฌุฉ ุฅูู ุชุฎุตูุต ุตูุญุฉ ุงูุชุฑุงุถูุฉ ูู ุฏููู ุงูุตูุญุฉ.  ูู ุงูููุงุฑุณุฉ ุงูุนูููุฉ ุ ููุน ุงููููู ุชูุฑูุจูุง ุฏุงุฆููุง ุจุฌูุงุฑ ุฃูู ููุฌุงุจุงูุช ุ ูุงูุฐู ูููุง ุจุชุฎุตูุตู ุจุงููุนู ูู ูุฑุญูุฉ ุงูุชูููุฏ.  ููุท ูู ุญุงูุฉ ุงูุชุญูู ูู ูุฌูุฏ ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ููุชุงุจุนุฉ ุชุญููููุง. </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> multiboot2; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> multiboot; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> super::arch; <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_pointer</span></span></span></span>(mb_pointer: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> { <span class="hljs-comment"><span class="hljs-comment">//if in first 4 MB - map to kernel address space if mb_pointer &lt; 0x400000 { arch::KERNEL_BASE | mb_pointer } else { arch::paging::allocate_page(mb_pointer, arch::MB_INFO_BASE, arch::paging::PDEntryFlags::PRESENT | arch::paging::PDEntryFlags::WRITABLE | arch::paging::PDEntryFlags::HUGE_PAGE ); arch::MB_INFO_BASE | mb_pointer } } pub fn init_with_mb1(mb_pointer: usize) { let ln_pointer = unsafe { process_pointer(mb_pointer) }; println!("mb pointer 0x{:X}", ln_pointer); let mb_info = multiboot::from_ptr(ln_pointer); println!("mb flags: {:?}", mb_info.flags().unwrap()); if mb_info.flags().unwrap().contains(multiboot::MBInfoFlags::MEM_MAP) { multiboot::parse_mmap(mb_info); println!("Multiboot memory map parsed, physical memory map has been built"); } else { panic!("MB mmap is not presented"); } }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ูู ูุงุฆูุฉ ูุฑุชุจุทุฉ ูุชู ุชุญุฏูุฏ ุงูุนููุงู ุงููุนูู ุงูุฃููู ููุง ูู ุงูุจููุฉ ุงูุฃุณุงุณูุฉ (ูุง ุชูุณ ุชุฑุฌูุฉ ูู ุดูุก ุฅูู ุนูุงููู ุงูุชุฑุงุถูุฉ) ูุญุฌู ุงูุตููู ุจุงูุจุงูุช.  ูุฌุจ ุนููู ุชูุฑุงุฑ ุงููุงุฆูุฉ ุจูุงุกู ุนูู ุญุฌู ูู ุนูุตุฑ ุ ูุธุฑูุง ูุฃู ุฃุญุฌุงููุง ูููู ุฃู ุชุฎุชูู ูู <em>ุงููุงุญูุฉ ุงููุธุฑูุฉ</em> .  ูุฐุง ูู ูุง ูุดุจู ุงูุชูุฑุงุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> MultibootInfo { . . . . . . <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mmap</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, index: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;*<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MemMapEntry&gt; { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> crate::arch::get_mb_pointer_base; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> base: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = get_mb_pointer_base(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mmap_addr <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> iter: *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MemMapEntry = (base <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mmap_addr) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MemMapEntry; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..index { iter = ((iter <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) + ((*iter).size <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) + <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MemMapEntry; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((iter <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) - base) &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mmap_addr + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mmap_lenght) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">None</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {} } <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(iter) } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุชุญููู ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ุ ููุฑุฑูุง ุนุจุฑ ุจููุฉ GRUB ููุญูููุง ุฅูู ุตูุฑุฉ ููุทูุฉ ุ ูุงูุชู ุณูุนูู ูุนูุง OS1 ูุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุงููุนููุฉ.  ูุฑุฑุช ุฃู ุฃูุตุฑ ููุณู ุนูู ูุฌููุนุฉ ุตุบูุฑุฉ ูู ุงูููู ุงููุชุงุญุฉ ููุฅุฏุงุฑุฉ - ูุฌุงููุฉ ุ ูุดุบูู ุ ูุญููุธุฉ ุ ุบูุฑ ูุชููุฑุฉ ุ ุนูู ุงูุฑุบู ูู ุฃู GRUB ู BIOS ูููุฑุงู ุงููุฒูุฏ ูู ุงูุฎูุงุฑุงุช.  ูุฐูู ุ ูููู ุจุงูุชูุฑุงุฑ ุนูู ุฅุฏุฎุงูุงุช ุงูุฎุฑูุทุฉ ููุญูู ุญุงูุชูุง ูู ููู GRUB / BIOS ุฅูู ููู OS1: </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_mmap</span></span></span></span>(mbi: &amp;MultibootInfo) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> mmap_opt = mbi.get_mmap(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> i: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mmap = mmap_opt.unwrap(); crate::memory::physical::map((*mmap).addr <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, (*mmap).len <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, translate_multiboot_mem_to_os1(&amp;(*mmap).mtype)); mmap_opt = mbi.get_mmap(i); <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> mmap_opt { <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>, _ =&gt; i += <span class="hljs-number"><span class="hljs-number">1</span></span>, } } } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">translate_multiboot_mem_to_os1</span></span></span></span>(mtype: &amp;<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> crate::memory::physical::{RESERVED, UNUSABLE, USABLE}; <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> mtype { &amp;MULTIBOOT_MEMORY_AVAILABLE =&gt; USABLE, &amp;MULTIBOOT_MEMORY_RESERVED =&gt; UNUSABLE, &amp;MULTIBOOT_MEMORY_ACPI_RECLAIMABLE =&gt; RESERVED, &amp;MULTIBOOT_MEMORY_NVS =&gt; UNUSABLE, &amp;MULTIBOOT_MEMORY_BADRAM =&gt; UNUSABLE, _ =&gt; UNUSABLE } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุชู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุงููุนููุฉ ูู ูุญุฏุฉ ุงูุฐุงูุฑุฉ :: ุงููุนููุฉ ุ ูุงูุชู ูุณูููุง ุทุฑููุฉ ุงูุฎุฑูุทุฉ ุฃุนูุงู ุ ูุชูุฑูุฑูุง ุนููุงู ุงูููุทูุฉ ูุทูููุง ูุญุงูุชูุง.  ูุชู ุชูุซูู ุฌููุน ุงูุฐุงูุฑุฉ ุงูุชู ุชุจูุบ 4 ุบูุบุงุจุงูุช ูุงูุชู ูุญุชูู ุฃู ุชููู ูุชุงุญุฉ ูููุธุงู ูุชููุณู ุฅูู ุฃุฑุจุน ุตูุญุงุช ููุบุง ุจุงูุช ุจุจุชูู ูู ุตูุฑุฉ ููุทูุฉ ุ ููุง ูุณูุญ ูู ุจุชุฎุฒูู 4 ุญุงูุงุช ูู 1024 ุตูุญุฉ.  ูู ุงููุฌููุน ุ ูุฃุฎุฐ ูุฐุง ุงูุจูุงุก 256 ุจุงูุช.  ุชุคุฏู ุงูุตูุฑุฉ ุงูููุทูุฉ ุฅูู ุชุฌุฒุฆุฉ ุฐุงูุฑุฉ ูุธูุนุฉ ุ ููููุง ูููููุฉ ูุณููุฉ ุงูุชูููุฐ ุ ููุฐุง ูู ุงูุดูุก ุงูุฑุฆูุณู ููุฏูู. </p><br><p style=";text-align:right;direction:rtl">  ุณุฃููู ุจุฅุฒุงูุฉ ุชุทุจูู ุงูุตูุฑุฉ ุงูููุทูุฉ ุถูู ุงูููุณุฏ ุญุชู ูุง ุชูุชู ุงูููุงูุฉ.  ูููู ูููููู ุญุณุงุจ ุนุฏุฏ ุงููุตูู ูุงูุฐุงูุฑุฉ ุงูุฎุงููุฉ ุ ููุถุน ุนูุงูุฉ ุนูู ุงูุตูุญุงุช ุญุณุจ ุงูููุฑุณ ูุงูุนููุงู ุ ููุฐูู ุงูุจุญุซ ุนู ุงูุตูุญุงุช ุงููุฌุงููุฉ (ุณุชููู ููุงู ุญุงุฌุฉ ูู ุงููุณุชูุจู ูุชูููุฐ ุงููููุฉ).  ุงูุจุทุงูุฉ ููุณูุง ุนุจุงุฑุฉ ุนู ูุฌููุนุฉ ููููุฉ ูู 64 ุนูุตุฑูุง ูู ุนูุงุตุฑ u32 ุ ูุนุฒู ุงูุจุชุงุช (ุงููุทุน) ุงูุถุฑูุฑูุฉ ุ ูุงูุชุญููู ุฅูู ูุง ูุณูู ุงููุทุนุฉ (ููุฑุณ ูู ุงููุฌููุนุฉ ุ ูุชุนุจุฆุฉ 16 ูุทุนุฉ) ุ ููุชู ุงุณุชุฎุฏุงู ุงููุชูุฉ (ููุถุน ุงูุจุช ูู ุงููุทุนุฉ). </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุตูุฑุฉ ููุทูุฉ ุงูุฐุงูุฑุฉ ุงููุนููุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> USABLE: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> USED: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RESERVED: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UNUSABLE: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DEAD: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">0xDEAD</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PhysMemoryInfo</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> total: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, used: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, reserved: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, chunks: [<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>; <span class="hljs-number"><span class="hljs-number">64</span></span>], } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> PhysMemoryInfo { <span class="hljs-comment"><span class="hljs-comment">// returns (chunk, page) pub fn find_free(&amp;self) -&gt; (usize, usize) { for chunk in 0..64 { for page in 0.. 16 { if ((self.chunks[chunk] &gt;&gt; page * 2) &amp; 3) ^ 3 == 3 { return (chunk, page) } else {} } } (DEAD, 0) } // marks page to given flag and returns its address pub fn mark(&amp;mut self, chunk: usize, block: usize, flag: usize) -&gt; usize { self.chunks[chunk] = self.chunks[chunk] ^ (3 &lt;&lt; (block * 2)); let mask = (0xFFFFFFFC ^ flag).rotate_left(block as u32 * 2); self.chunks[chunk] = self.chunks[chunk] &amp; (mask as u32); if flag == USED { self.used += 1; } else if flag == UNUSABLE || flag == RESERVED { self.reserved += 1; } else { if self.used &gt; 0 { self.used -= 1; } } (chunk * 16 + block) &lt;&lt; 22 } pub fn mark_by_addr(&amp;mut self, addr: usize, flag: usize) { let block_num = addr &gt;&gt; 22; let chunk: usize = (block_num / 16) as usize; let block: usize = block_num - chunk * 16; self.mark(chunk, block, flag); } pub fn count_total(&amp; mut self) { let mut count: usize = 0; for i in 0..64 { let mut chunk = self.chunks[i]; for _j in 0..16 { if chunk &amp; 0b11 != 0b11 { count += 1; } chunk = chunk &gt;&gt; 2; } } self.total = count; } pub fn get_total(&amp;self) -&gt; usize { self.total } pub fn get_used(&amp;self) -&gt; usize { self.used } pub fn get_reserved(&amp;self) -&gt; usize { self.reserved } pub fn get_free(&amp;self) -&gt; usize { self.total - self.used - self.reserved } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ูุงูุขู ูุตููุง ุฅูู ุชุญููู ุนูุตุฑ ูุงุญุฏ ูู ุงูุฎุฑูุทุฉ.  ุฅุฐุง ูุตู ุนูุตุฑ ุฎุฑูุทุฉ ููุทูุฉ ุฐุงูุฑุฉ ุฃูู ูู ุตูุญุฉ ูุงุญุฏุฉ ุจุณุนุฉ 4 ููุฌุงุจุงูุช ุฃู ูุณุงููุฉ ููุง ุ ูุฅููุง ูุญุชูู ุจูุฐู ุงูุตูุญุฉ ููู.  ุฅุฐุง ูุงู ุฃูุซุฑ - ูุงุฒ ูู ูุทุน ูู 4 ููุบุงุจุงูุช ูุนูุงูุฉ ูู ูุทุนุฉ ุนูู ุญุฏุฉ ูู ุฎูุงู ุงูุนูุฏูุฉ.  ูู ูุฑุญูุฉ ุชููุฆุฉ ุงูุตูุฑุฉ ุงูููุทูุฉ ุ ูุนุชุจุฑ ุฃู ุฌููุน ุฃูุณุงู ุงูุฐุงูุฑุฉ ูุง ูููู ุงููุตูู ุฅูููุง ุ ุจุญูุซ ุนูุฏูุง ุชููุฏ ุงูุจุทุงูุฉ ุ ุนูู ุณุจูู ุงููุซุงู ุ 128 ููุฌุงุจุงูุช ุ ูุชู ุชูููุฒ ุงูุฃูุณุงู ุงููุชุจููุฉ ุนูู ุฃููุง ุบูุฑ ูุงุจูุฉ ูููุตูู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> lazy_static::lazy_static; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> spin::Mutex; lazy_static! { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> RAM_INFO: Mutex&lt;PhysMemoryInfo&gt; = Mutex::new(PhysMemoryInfo { total: <span class="hljs-number"><span class="hljs-number">0</span></span>, used: <span class="hljs-number"><span class="hljs-number">0</span></span>, reserved: <span class="hljs-number"><span class="hljs-number">0</span></span>, chunks: [<span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>; <span class="hljs-number"><span class="hljs-number">64</span></span>] }); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span></span>(addr: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, len: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, flag: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// if len &lt;= 4MiB then mark whole page with flag if len &lt;= 4 * 1024 * 1024 { RAM_INFO.lock().mark_by_addr(addr, flag); } else { let pages: usize = len &gt;&gt; 22; for map_page in 0..(pages - 1) { map(addr + map_page &lt;&lt; 22, 4 * 1024 * 1024, flag); } map(addr + (pages &lt;&lt; 22), len - (pages &lt;&lt; 22), flag); } }</span></span></code> </pre> <br><h1 id="kucha-i-upravlenie-ey" style=";text-align:right;direction:rtl">  ูููุฉ ูุฅุฏุงุฑุฉ ููุง </h1><br><p style=";text-align:right;direction:rtl">  ุชูุชุตุฑ ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุงูุธุงูุฑูุฉ ุญุงูููุง ุนูู ุฅุฏุงุฑุฉ ุงููููุฉ ููุท ุ ูุธุฑูุง ูุฃู ุงูููุงุฉ ูุง ุชุนุฑู ุงููุซูุฑ.  ูู ุงููุณุชูุจู ุ ุจุงูุทุจุน ุ ุณูููู ูู ุงูุถุฑูุฑู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุจุงููุงูู ุ ูุณูุชู ุฅุนุงุฏุฉ ูุชุงุจุฉ ูุฐุง ุงููุฏูุฑ ุงูุตุบูุฑ.  ููุน ุฐูู ุ ูู ุงูููุช ุงูุญุงูู ุ ูู ูุง ุฃุญุชุงุฌ ุฅููู ูู ุฐุงูุฑุฉ ุซุงุจุชุฉ ุ ุชุญุชูู ุนูู ุงูููุฏ ุงููุงุจู ููุชูููุฐ ูุงูููุฏุณ ุ ูุฐุงูุฑุฉ ูููุฉ ุงูุฐุงูุฑุฉ ุงูุฏููุงููููุฉ ุ ุญูุซ ุณุฃุฎุตุต ุงูููุงูู ุงูุฎุงุตุฉ ุจูุถุงุนูุฉ ูุคุดุฑุงุช ุงูุชุฑุงุจุท.  ูุญู ูุฎุตุต ุฐุงูุฑุฉ ุซุงุจุชุฉ ูู ูุฑุญูุฉ ุงูุชูููุฏ (ูุญุชู ุงูุขู ูุฏููุง ุนุฏุฏ ูุญุฏูุฏ ูู 4 ููุฌุงุจุงูุช ุ ูุฃู ุงูููุงุฉ ุชูุงุณุจูุง) ูุจุตูุฉ ุนุงูุฉ ูุง ุชูุฌุฏ ูุดุงูู ูุนูุง ุงูุขู.  ุฃูุถุง ุ ูู ูุฐู ุงููุฑุญูุฉ ุ ููุณ ูุฏู ุฃุฌูุฒุฉ DMA ุ ูุฐูู ูู ุดูุก ุจุณูุท ููุบุงูุฉ ุ ูููู ููููู. </p><br><p style=";text-align:right;direction:rtl">  ุฃุนุทูุช 512 ููุบุงุจุงูุช ูู ูุณุงุญุฉ ุงูุฐุงูุฑุฉ kernel ุงูุฃุนูู (0xE0000000) ุฅูู ูููุฉ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ ุ ุฃููู ุจุชุฎุฒูู ุฎุฑูุทุฉ ุงุณุชุฎุฏุงู ูููุฉ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ (0xDFC00000) 4 ููุบุงุจุงูุช ุฃูู.  ุฃุณุชุฎุฏู ุตูุฑุฉ ููุทูุฉ ููุตู ุงูุญุงูุฉ ุ ุชูุงููุง ููุง ูู ุงูุฐุงูุฑุฉ ุงููุนููุฉ ุ ูููู ูุง ููุฌุฏ ุณูู ุญุงูุชูู - ูุดุบูู / ูุฌุงูู.  ุญุฌู ูุชูุฉ ุงูุฐุงูุฑุฉ ูู 64 ุจุงูุช - ููุฐุง ูุซูุฑ ูููุชุบูุฑุงุช ุงูุตุบูุฑุฉ ูุซู u32 ุ u8 ุ ูููู ุ ุฑุจูุง ุ ูู ุงูุฃูุซู ูุชุฎุฒูู ุจููุงุช ุงูุจูุงูุงุช.  ููุน ุฐูู ุ ูู ุบูุฑ ุงููุญุชูู ุฃู ูุญุชุงุฌ ุฅูู ุชุฎุฒูู ูุชุบูุฑุงุช ููุฑุฏุฉ ุนูู ุงููููุฉ ุ ูุงูุบุฑุถ ุงูุฑุฆูุณู ุงูุขู ูู ุชุฎุฒูู ุจูู ุงูุณูุงู ูุชุนุฏุฏ ุงูููุงู. </p><br><p style=";text-align:right;direction:rtl">  ูุชู ุชุฌููุน ูุชู 64 ุจุงูุช ูู ููุงูู ุชุตู ุญุงูุฉ ุตูุญุฉ 4 ููุบุงุจุงูุช ุจุงููุงูู ุ ุญุชู ูุชููู ูู ุชุฎุตูุต ูููุงุช ุตุบูุฑุฉ ููุจูุฑุฉ ูู ุงูุฐุงูุฑุฉ ูุนุฏุฉ ุตูุญุงุช.  ูููููู ุงุณุชุฎุฏุงู ุงููุตุทูุญุงุช ุงูุชุงููุฉ: ูุทุนุฉ - 64 ุจุงูุช ุ ุญุฒูุฉ - 2 ูููู ุจุงูุช (ูุงุญุฏ ูู 32 ุฅูู 64 ุจุงูุช * 32 ุจุช ููู ุญุฒูุฉ) ุ ุตูุญุฉ - 4 ููุบุงุจุงูุช. </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[repr(packed)]</span></span> <span class="hljs-meta"><span class="hljs-meta">#[derive(Copy, Clone)]</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeapPageInfo</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//every bit represents 64 bytes chunk of memory. 0 is free, 1 is busy //u32 size is 4 bytes, so page information total size is 8KiB pub _4mb_by_64b: [u32; 2048], } #[repr(packed)] #[derive(Copy, Clone)] struct HeapInfo { //Here we can know state of any 64 bit chunk in any of 128 4-MiB pages //Page information total size is 8KiB, so information about 128 pages requires 1MiB reserved data pub _512mb_by_4mb: [HeapPageInfo; 128], }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุทูุจ ุงูุฐุงูุฑุฉ ูู ุฃุญุฏ ุงูููุฎุตุตูู ุ ุฃููุฑ ูู ุซูุงุซ ุญุงูุงุช ุ ุงุนุชูุงุฏูุง ุนูู ุงูุชูุงุตูู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุทูุจ ููุฐุงูุฑุฉ ุฃูู ูู 2 ูููู ุจุงูุช ุฌุงุก ูู ุงููุฎุตุต.  ุณุชุญุชุงุฌ ุฅูู ุงูุนุซูุฑ ุนูู ุญุฒูุฉ ุณุชููู ูุฌุงููุฉ [size / 64 ุ ููุถูู ุฃู ุฌุฒุก ุบูุฑ ุตูุฑู ูุงุญุฏูุง] ูุทุนูุง ูุชุชุงููุฉ ุ ููุถุน ุนูุงูุฉ ุนูู ูุฐู ุงููุทุน ุนูู ุฃููุง ูุดุบูู ุ ููุนูุฏ ุนููุงู ุงููุทุนุฉ ุงูุฃููู. </li><li style=";text-align:right;direction:rtl">  ุฌุงุก ุทูุจ ูู ูุฎุตุต ุงูุฐุงูุฑุฉ ุฃูู ูู 4 ููุบุงุจุงูุช ุ ูููู ุฃูุซุฑ ูู 2 ูููู ุจุงูุช.  ุชุญุชุงุฌ ุฅูู ุงูุนุซูุฑ ุนูู ุตูุญุฉ ุชุญุชูู ุนูู [size / 2048] ูุฌุงููุง ุ ููุถูู ุฃู ูุง ุชุจูู ุบูุฑ ุตูุฑู ุญุฒููุง ูุงุญุฏุฉ ุนูู ุงูุชูุงูู.  ุญุฏุฏ ุญุฒู [size / 2048] ุนูู ุฃููุง ูุดุบูู ุ ุฅุฐุง ูุงู ููุงู ูุง ุชุจูู ุ ูู ุจุชูููุฒ ุงููุทุน [ุงููุชุจููุฉ] ูู ุงูุนุจูุฉ ุงูุฃุฎูุฑุฉ ุนูู ุฃููุง ูุดุบูู. </li><li style=";text-align:right;direction:rtl">  ุฌุงุก ุทูุจ ููุญุตูู ุนูู ุฐุงูุฑุฉ ุฃูุซุฑ ูู 4 ููุบุงุจุงูุช ูู ุงููุฎุตุต.  ุงุจุญุซ ุนู [size / 4 Mi ุ ุฃู ุฑุตูุฏ ุบูุฑ ุตูุฑู ูุถูู ุตูุญุฉ ูุงุญุฏุฉ] ุนูู ุงูุชูุงูู ุ ููู ุจุชูููุฒ ุงูุตูุญุงุช [size / 4 Mi] ุนูู ุฃููุง ูุดุบููุฉ ุ ุฅุฐุง ูุงู ููุงู ุญุฒู ููุงุฒูุฉ [balance] ูุดุบูู.  ูู ุงูุญุฒูุฉ ุงูุฃุฎูุฑุฉ ุ ุญุฏุฏ ุงูุฌุฒุก ุงููุชุจูู ูู ุงููุทุน ุนูู ุฃูู ูุดุบูู. </li></ul><br><p style=";text-align:right;direction:rtl">  ูุนุชูุฏ ุงูุจุญุซ ุนู ุงูููุงุทู ุงูุญุฑุฉ ุฃูุถูุง ุนูู ุงูุชูุงุตูู - ูุชู ุชุญุฏูุฏ ูุฌููุนุฉ ููุชูุฑุงุฑ ุฃู ุฃููุนุฉ ุงูุจุช.  ูููุง ุฐูุจุช ุฅูู ุงูุฎุงุฑุฌ ุ ูุญุฏุซ OOM.  ุนูุฏ ุฅูุบุงุก ุชุฎุตูุต ุ ูุชู ุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุฉ ููุงุซูุฉ ุ ููุท ููุถุน ุงูุนูุงูุงุช ุตุฏุฑ.  ูุง ูุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุฐุงูุฑุฉ ุงููุญุฑุฑุฉ.  ุงูููุฏ ููู ูุจูุฑ ุ ุณุฃุถุนู ุชุญุช ุงูููุณุฏ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุตูุฑุฉ ููุทูุฉ ุงูุฐุงูุฑุฉ ุงูุธุงูุฑูุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">//512 MiB should be enough for kernel heap. If not - ooops... pub const KHEAP_START: usize = 0xE0000000; //I will keep 1MiB info about my heap in separate 4MiB page before heap at this point pub const KHEAP_INFO_ADDR: usize = 0xDFC00000; pub const KHEAP_CHUNK_SIZE: usize = 64; pub fn init() { KHEAP_INFO.lock().init(); } #[repr(packed)] #[derive(Copy, Clone)] struct HeapPageInfo { //every bit represents 64 bytes chunk of memory. 0 is free, 1 is busy //u32 size is 4 bytes, so page information total size is 8KiB pub _4mb_by_64b: [u32; 2048], } impl HeapPageInfo { pub fn init(&amp;mut self) { for i in 0..2048 { self._4mb_by_64b[i] = 0; } } pub fn mark_chunks_used(&amp;mut self, _32pack: usize, chunk: usize, n: usize) { let mask: u32 = 0xFFFFFFFF &gt;&gt; (32 - n) &lt;&lt; chunk; self._4mb_by_64b[_32pack] = self._4mb_by_64b[_32pack] | mask; } pub fn mark_chunks_free(&amp;mut self, _32pack: usize, chunk: usize, n: usize) { let mask: u32 = 0xFFFFFFFF &gt;&gt; (32 - n) &lt;&lt; chunk; self._4mb_by_64b[_32pack] = self._4mb_by_64b[_32pack] ^ mask; } pub fn empty(&amp;self) -&gt; bool { for i in 0..2048 { if self._4mb_by_64b[i] != 0 { return false } } true } } #[repr(packed)] #[derive(Copy, Clone)] struct HeapInfo { //Here we can know state of any 64 bit chunk in any of 128 4-MiB pages //Page information total size is 8KiB, so information about 128 pages requires 1MiB reserved data pub _512mb_by_4mb: [HeapPageInfo; 128], } impl HeapInfo { pub fn init(&amp;mut self) { for i in 0..128 { self._512mb_by_4mb[i].init(); } } // returns page number pub fn find_free_pages_of_size(&amp;self, n: usize) -&gt; usize { if n &gt;= 128 { 0xFFFFFFFF } else { let mut start_page: usize = 0xFFFFFFFF; let mut current_page: usize = 0xFFFFFFFF; for page in 0..128 { if self._512mb_by_4mb[page].empty() { if current_page - start_page == n { return start_page } if start_page == 0xFFFFFFFF { start_page = page; } current_page = page; } else { start_page = 0xFFFFFFFF; current_page = 0xFFFFFFFF; } } 0xFFFFFFFF } } // returns (page number, 32pack number) pub fn find_free_packs_of_size(&amp;self, n: usize) -&gt; (usize, usize) { if n &lt; 2048 { for page in 0..128 { let mut start_pack: usize = 0xFFFFFFFF; let mut current_pack: usize = 0xFFFFFFFF; for _32pack in 0..2048 { let _32pack_info = self._512mb_by_4mb[page]._4mb_by_64b[_32pack]; if _32pack_info == 0 { if current_pack - start_pack == n { return (page, start_pack) } if start_pack == 0xFFFFFFFF { start_pack = _32pack; } current_pack = _32pack; } else { start_pack = 0xFFFFFFFF; current_pack = 0xFFFFFFFF; } } } (0xFFFFFFFF, 0xFFFFFFFF) } else { (0xFFFFFFFF, 0xFFFFFFFF) } } // returns (page number, 32pack number, chunk number) pub fn find_free_chunks_of_size(&amp;self, n: usize) -&gt; (usize, usize, usize) { if n &lt; 32 { for page in 0..128 { for _32pack in 0..2048 { let _32pack_info = self._512mb_by_4mb[page]._4mb_by_64b[_32pack]; let mask: u32 = 0xFFFFFFFF &gt;&gt; (32 - n); for chunk in 0..(32-n) { if ((_32pack_info &gt;&gt; chunk) &amp; mask) ^ mask == mask { return (page, _32pack, chunk) } } } } (0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF) } else { (0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF) } } fn mark_chunks_used(&amp;mut self, page: usize, _32pack: usize, chunk: usize, n: usize) { self._512mb_by_4mb[page].mark_chunks_used(_32pack, chunk, n); } fn mark_chunks_free(&amp;mut self, page: usize, _32pack: usize, chunk: usize, n: usize) { self._512mb_by_4mb[page].mark_chunks_free(_32pack, chunk, n); } fn mark_packs_used(&amp;mut self, page: usize, _32pack:usize, n: usize) { for i in _32pack..(_32pack + n) { self._512mb_by_4mb[page]._4mb_by_64b[i] = 0xFFFFFFFF; } } fn mark_packs_free(&amp;mut self, page: usize, _32pack:usize, n: usize) { for i in _32pack..(_32pack + n) { self._512mb_by_4mb[page]._4mb_by_64b[i] = 0; } } } use lazy_static::lazy_static; use spin::Mutex; lazy_static! { static ref KHEAP_INFO: Mutex&lt;&amp;'static mut HeapInfo&gt; = Mutex::new(unsafe { &amp;mut *(KHEAP_INFO_ADDR as *mut HeapInfo) }); } fn allocate_n_chunks_less_than_pack(n: usize, align: usize) -&gt; *mut u8 { let mut heap_info = KHEAP_INFO.lock(); let (page, _32pack, chunk) = heap_info.find_free_chunks_of_size(n); if page == 0xFFFFFFFF { core::ptr::null_mut() } else { let tptr: usize = KHEAP_START + 0x400000 * page + _32pack * 32 * 64 + chunk * 64; let res = tptr % align; let uptr = if res == 0 { tptr } else { tptr + align - res }; //check bounds: more than start and less than 4GiB - 64B //but according to chunks error should never happen if uptr &gt;= KHEAP_START &amp;&amp; uptr &lt;= 0xFFFFFFFF - 64 * n { heap_info.mark_chunks_used(page, _32pack, chunk, n); uptr as *mut u8 } else { core::ptr::null_mut() } } } fn allocate_n_chunks_less_than_page(n: usize, align: usize) -&gt; *mut u8 { let mut heap_info = KHEAP_INFO.lock(); let packs_n: usize = n / 32; let lost_chunks = n - packs_n * 32; let mut packs_to_alloc = packs_n; if lost_chunks != 0 { packs_to_alloc += 1; } let (page, pack) = heap_info.find_free_packs_of_size(packs_to_alloc); if page == 0xFFFFFFFF { core::ptr::null_mut() } else { let tptr: usize = KHEAP_START + 0x400000 * page + pack * 32 * 64; let res = tptr % align; let uptr = if res == 0 { tptr } else { tptr + align - res }; //check bounds: more than start and less than 4GiB - 64B //but according to chunks error should never happen if uptr &gt;= KHEAP_START &amp;&amp; uptr &lt;= 0xFFFFFFFF - 64 * n { heap_info.mark_packs_used(page, pack, packs_n); if lost_chunks != 0 { heap_info.mark_chunks_used(page, pack + packs_to_alloc, 0, lost_chunks); } uptr as *mut u8 } else { core::ptr::null_mut() } } } //unsupported yet fn allocate_n_chunks_more_than_page(n: usize, align: usize) -&gt; *mut u8 { let mut heap_info = KHEAP_INFO.lock(); let packs_n: usize = n / 32; let lost_chunks = n - packs_n * 32; let mut packs_to_alloc = packs_n; if lost_chunks != 0 { packs_to_alloc += 1; } let pages_n: usize = packs_to_alloc / 2048; let mut lost_packs = packs_to_alloc - pages_n * 2048; let mut pages_to_alloc = pages_n; if lost_packs != 0 { pages_to_alloc += 1; } if lost_chunks != 0 { lost_packs -= 1; } let page = heap_info.find_free_pages_of_size(pages_to_alloc); if page == 0xFFFFFFFF { core::ptr::null_mut() } else { let tptr: usize = KHEAP_START + 0x400000 * page; let res = tptr % align; let uptr = if res == 0 { tptr } else { tptr + align - res }; //check bounds: more than start and less than 4GiB - 64B * n //but according to chunks error should never happen if uptr &gt;= KHEAP_START &amp;&amp; uptr &lt;= 0xFFFFFFFF - 64 * n { for i in page..(page + pages_n) { heap_info.mark_packs_used(i, 0, 2048); } if lost_packs != 0 { heap_info.mark_packs_used(page + pages_to_alloc, 0, lost_packs); } if lost_chunks != 0 { heap_info.mark_chunks_used(page + pages_to_alloc, lost_packs, 0, lost_chunks); } uptr as *mut u8 } else { core::ptr::null_mut() } } } // returns pointer pub fn allocate_n_chunks(n: usize, align: usize) -&gt; *mut u8 { if n &lt; 32 { allocate_n_chunks_less_than_pack(n, align) } else if n &lt; 32 * 2048 { allocate_n_chunks_less_than_page(n, align) } else { allocate_n_chunks_more_than_page(n, align) } } pub fn free_chunks(ptr: usize, n: usize) { let page: usize = (ptr - KHEAP_START) / 0x400000; let _32pack: usize = ((ptr - KHEAP_START) - (page * 0x400000)) / (32 * 64); let chunk: usize = ((ptr - KHEAP_START) - (page * 0x400000) - (_32pack * (32 * 64))) / 64; let mut heap_info = KHEAP_INFO.lock(); if n &lt; 32 { heap_info.mark_chunks_free(page, _32pack, chunk, n); } else if n &lt; 32 * 2048 { let packs_n: usize = n / 32; let lost_chunks = n - packs_n * 32; heap_info.mark_packs_free(page, _32pack, packs_n); if lost_chunks != 0 { heap_info.mark_chunks_free(page, _32pack + packs_n, 0, lost_chunks); } } else { let packs_n: usize = n / 32; let pages_n: usize = packs_n / 2048; let lost_packs: usize = packs_n - pages_n * 2048; let lost_chunks = n - packs_n * 32; for i in page..(page + pages_n) { heap_info.mark_packs_free(i, 0, 2048); } if lost_packs != 0 { heap_info.mark_packs_free(page + pages_n, 0, lost_packs); } if lost_chunks != 0 { heap_info.mark_chunks_free(page + pages_n, packs_n, 0, lost_chunks); } } }</span></span></code> </pre> </div></div><br><h1 id="allokaciya-i-page-fault" style=";text-align:right;direction:rtl">  ุชุฎุตูุต ู ุฎุทุฃ ุงูุตูุญุฉ </h1><br><p style=";text-align:right;direction:rtl">  ูู ุฃุฌู ุงุณุชุฎุฏุงู ุงููููุฉ ุ ุชุญุชุงุฌ ุฅูู ูุฎุตุต.  ุฅู ุฅุถุงูุชู ุณููุชุญ ููุง ูุงูููุง ูุฃุดุฌุงุฑูุง ูุฌุฏุงูู ุชุฌุฒุฆุฉ ูุตูุงุฏูู ูุบูุฑ ุฐูู ุ ูุงูุชู ุจุฏูููุง ุณูููู ูู ุงููุณุชุญูู ุงูุนูุด ุนูููุง.  ุจูุฌุฑุฏ ุฃู ูููู ุจุชูุตูู ูุญุฏุฉ ุงูุชุฎุตูุต ูุฅุนูุงู ุชุฎุตูุต ุนุงููู ุ ุณุชุตุจุญ ุงูุญูุงุฉ ุนูู ุงูููุฑ ุฃุณูู. </p><br><p style=";text-align:right;direction:rtl">  ุชูููุฐ ุงููุฎุตุต ุจุณูุท ููุบุงูุฉ - ุฅูู ูุดูุฑ ุจุจุณุงุทุฉ ุฅูู ุงูุขููุฉ ุงูููุถุญุฉ ุฃุนูุงู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> alloc::alloc::{GlobalAlloc, Layout}; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Os1Allocator</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Sync</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Os1Allocator {} <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> GlobalAlloc <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Os1Allocator { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alloc</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, layout: Layout) -&gt; *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> super::logical::{KHEAP_CHUNK_SIZE, allocate_n_chunks}; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> size = layout.size(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> chunk_count: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> size &gt; KHEAP_CHUNK_SIZE { chunk_count = size / KHEAP_CHUNK_SIZE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> KHEAP_CHUNK_SIZE * chunk_count != size { chunk_count += <span class="hljs-number"><span class="hljs-number">1</span></span>; } } allocate_n_chunks(chunk_count, layout.align()) } <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dealloc</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, ptr: *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>, layout: Layout) { <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> super::logical::{KHEAP_CHUNK_SIZE, free_chunks}; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> size = layout.size(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> chunk_count: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> size &gt; KHEAP_CHUNK_SIZE { chunk_count = size / KHEAP_CHUNK_SIZE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> KHEAP_CHUNK_SIZE * chunk_count != size { chunk_count += <span class="hljs-number"><span class="hljs-number">1</span></span>; } } free_chunks(ptr <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, chunk_count); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุชู ุชุดุบูู ุงููุฎุตุต ูู lib.rs ููุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#![feature(alloc, alloc_error_handler)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> alloc; <span class="hljs-meta"><span class="hljs-meta">#[global_allocator]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ALLOCATOR: memory::allocate::Os1Allocator = memory::allocate::Os1Allocator;</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุนูุฏูุง ูุญุงูู ุชุฎุตูุต ุฃููุณูุง ููุท ุจูุฐู ุงูุทุฑููุฉ ุ ูุญุตู ุนูู ุงุณุชุซูุงุก ูู ุฎุทุฃ ุงูุตูุญุฉ ุ ูุฃููุง ูู ูุญุฏุฏ ุจุนุฏ ุชุฎุตูุต ุงูุฐุงูุฑุฉ ุงูุงูุชุฑุงุถูุฉ.  ุญุณูุง ุ ููู ุฐูู!  ุญุณููุง ุ ูุฌุจ ุนููู ุงูุฑุฌูุน ุฅูู ูุงุฏุฉ ุงูููุงูุฉ ุงูุณุงุจูุฉ ูุฅุถุงูุฉ ุงุณุชุซูุงุกุงุช.  ูุฑุฑุช ุชุทุจูู ุชุฎุตูุต ูุณูู ููุฐุงูุฑุฉ ุงูุธุงูุฑูุฉ ุ ุฃู ุฃูู ูู ูุชู ุชุฎุตูุต ุงูุตูุญุฉ ูู ููุช ุทูุจ ุงูุฐุงูุฑุฉ ุ ูููู ูู ููุช ูุญุงููุฉ ุงููุตูู ุฅูููุง.  ูุญุณู ุงูุญุธ ุ ูุฅู ูุนุงูุฌ x86 ูุณูุญ ุจุฐูู ููุดุฌุนู.   Page fault     ,   ,    ,          โ      ,     ,    CR2 โ  ,    . </p><br><p style=";text-align:right;direction:rtl">    ,      .        32 (     ,     ,     32 ),    .           Rust.           ,        .  ,   ,   iret    ,    ,     Page fault   Protection fault.        Protection fault โ ,        . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">eE_page_fault: pushad mov eax, [esp + 32] push eax mov eax, cr2 push eax call kE_page_fault pop eax pop eax popad add esp, 4 iret</code> </pre> <br><p style=";text-align:right;direction:rtl">  Rust         ,    .     ,     .            .            . </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"><span class="hljs-built_in"><span class="hljs-built_in">bitflags!</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PFErrorCode</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PROTECTION = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//1 - protection caused, 0 - not present page caused const WRITE = 1 &lt;&lt; 1; //1 - write caused, 0 - read caused const USER_MODE = 1 &lt;&lt; 2; //1 - from user mode, 0 - from kernel const RESERVED = 1 &lt;&lt; 3; //1 - reserved page (PAE/PSE), 0 - not const INSTRUCTION = 1 &lt;&lt; 4; //1 - instruction fetch caused, 0 - not } } impl PFErrorCode { pub fn to_pd_flags(&amp;self) -&gt; super::super::paging::PDEntryFlags { use super::super::paging; let mut flags = paging::PDEntryFlags::empty(); if self.contains(PFErrorCode::WRITE) { flags.set(paging::PDEntryFlags::WRITABLE, true); } if self.contains(PFErrorCode::USER_MODE) { flags.set(paging::PDEntryFlags::USER_ACCESSIBLE, true); } flags } } #[no_mangle] pub unsafe extern fn kE_page_fault(ptr: usize, code: usize) { use super::super::paging; println!("Page fault occured at addr 0x{:X}, code {:X}", ptr, code); let phys_address = crate::memory::physical::alloc_page(); let code_flags: PFErrorCode = PFErrorCode::from_bits(code).unwrap(); if !code_flags.contains(PFErrorCode::PROTECTION) { //page not presented, we need to allocate the new one let mut flags: paging::PDEntryFlags = code_flags.to_pd_flags(); flags.set(paging::PDEntryFlags::HUGE_PAGE, true); paging::allocate_page(phys_address, ptr, flags); println!("Page frame allocated at Paddr {:#X} Laddr {:#X}", phys_address, ptr); } else { panic!("Protection error occured, cannot handle yet"); } }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">        ,   .  ,       .           .          ,      .    ,      ,        : </p><br><pre style=";text-align:right;direction:rtl"> <code class="rust hljs"> <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"memory: total {} used {} reserved {} free {}"</span></span>, memory::physical::total(), memory::physical::used(), memory::physical::reserved(), memory::physical::free()); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> alloc::vec::<span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> vec: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>&gt; = <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>::new(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">1000000</span></span> { vec.push(i); } <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"vec len {}, ptr is {:?}"</span></span>, vec.len(), vec.as_ptr()); <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"Still works, check reusage!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> vec2: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>&gt; = <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>::new(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">10</span></span> { vec2.push(i); } <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"vec2 len {}, ptr is {:?}, vec is still here? {}"</span></span>, vec2.len(), vec2.as_ptr(), vec.get(<span class="hljs-number"><span class="hljs-number">1000</span></span>).unwrap()); <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"Still works!"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"memory: total {} used {} reserved {} free {}"</span></span>, memory::physical::total(), memory::physical::used(), memory::physical::reserved(), memory::physical::free());</code> </pre> <br><p style=";text-align:right;direction:rtl">     : <br><img src="https://habrastorage.org/webt/7x/y3/bs/7xy3bs8m91uxbmexphxpelzc2cs.jpeg" alt="OS1 heap"></p><br><p style=";text-align:right;direction:rtl">  ,   ,           .          3,5  + 3 ,   .          3,5     . </p><br><p style=";text-align:right;direction:rtl"> IRQ 1    โ        Alt + PrntScrn :) </p><br><p style=";text-align:right;direction:rtl"> ,    ,      Rust โ       ,   โ    ,    ! </p><br><p style=";text-align:right;direction:rtl">       ,                . </p><br><p style=";text-align:right;direction:rtl">  ุดูุฑุง ูุงูุชูุงููู! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar446214/">https://habr.com/ru/post/ar446214/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar446204/index.html">ุงูุชูุจุค ุจููููุฉ ุงูุชุบูุจ ุนูู ูููุฏ ุงูุฅูุชุฑูุช</a></li>
<li><a href="../ar446206/index.html">ุฑุฏ ูุนู ุงูุจุฑูุงูุฌ ุงูุชุนูููู ุงูุฌุฒุก 26: ููุฏุณุฉ ุงูุชุทุจูู ุ ููุท ุญุงููุฉ / ูููู</a></li>
<li><a href="../ar446208/index.html">ุฑุฏ ูุนู ุงูุจุฑูุงูุฌ ุงูุชุนูููู ุงูุฌุฒุก 25: ูุฑุดุฉ ุนูู ุนูู ุงูููุงุฐุฌ</a></li>
<li><a href="../ar446210/index.html">ADAM-3600 - ูุญุฏุฉ ุชุญูู ุตูุงุนูุฉ ูุชุนุฏุฏุฉ ุงููุธุงุฆู</a></li>
<li><a href="../ar446212/index.html">ุฃุนูุงู SIEM: ุงูุงุฑุชุจุงุทุงุช ุฎุงุฑุฌ ุงูุตูุฏูู. ุงูุฌุฒุก 5. ูููุฌูุฉ ูุชุทููุฑ ููุงุนุฏ ุงูุงุฑุชุจุงุท</a></li>
<li><a href="../ar446218/index.html">ูุตูู ุงููุนุจุฉ ูุง ูุฎุชูู ูุซูุฑุง ุนู ุงูููุณู. ููู ุตูุนูุง ูุนุจุฉ CMAN</a></li>
<li><a href="../ar446222/index.html">ุงุณุชุฎุฏุงู ุงูุฅููุงูุงุช ุงูุญุฑุงุฑูุฉ ูุชุญููู ุงูุฃุฑุงุถู</a></li>
<li><a href="../ar446228/index.html">ุชุญุณูู ุฌูุฏุฉ ุชุตููู ุงููุต ูู ุฎูุงู ุฑุจุท ููููุจูุฏูุง</a></li>
<li><a href="../ar446230/index.html">ุชุงุจุน ุฑุตุฏ ูุฅุฏุงุฑุฉ ุงูุฃุฌูุฒุฉ ุงููุณุชูุฏุฉ ุฅูู Linux / OpenWrt / Lede ุนุจุฑ ุงููููุฐ 80</a></li>
<li><a href="../ar446234/index.html">ููู ูุฎูู ุงููุชุทูุนูู ูู ุฌููุน ุฃูุญุงุก ุงูุนุงูู ุงูุจุซ ุงููุจุงุดุฑ ูู ICPC-2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>