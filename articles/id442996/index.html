<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏾 🛏️ 🍒 Membuat Penanganan Pengecualian C ++ Lebih Kecil Pada x64 🐻 👵🏽 👨🏿‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Visual Studio 2019 Pratinjau 3 memperkenalkan fitur baru untuk mengurangi ukuran biner penanganan pengecualian C ++ (coba / tangkap dan penghancur oto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membuat Penanganan Pengecualian C ++ Lebih Kecil Pada x64</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/442996/"><img width="140" align="left" src="https://habrastorage.org/webt/gq/ke/xi/gqkexi_dekwffzpjqtx04zp7ee8.png"><p>  Visual Studio 2019 Pratinjau 3 memperkenalkan fitur baru untuk mengurangi ukuran biner penanganan pengecualian C ++ (coba / tangkap dan penghancur otomatis) pada x64.  Dijuluki FH4 (untuk __CxxFrameHandler4, lihat di bawah), saya mengembangkan format dan pemrosesan baru untuk data yang digunakan untuk penanganan pengecualian C ++ yang ~ <strong>60%</strong> lebih kecil dari implementasi yang ada sehingga menghasilkan pengurangan biner keseluruhan hingga <strong>20%</strong> untuk program dengan penggunaan C ++ yang berat penanganan pengecualian. </p><br>  Artikel ini di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">blog</a> . <a name="habracut"></a><br><br><h2>  Bagaimana Saya Menghidupkan Ini? </h2><br><p>  FH4 saat ini <strong>mati secara default</strong> karena perubahan runtime yang diperlukan untuk aplikasi Store tidak dapat membuatnya menjadi rilis saat ini.  Untuk mengaktifkan FH4 untuk aplikasi non-Toko, berikan flag tidak berdokumen "/ d2FH4" ke kompiler MSVC di Visual Studio 2019 Pratinjau 3 dan seterusnya. </p><br><p>  Kami berencana mengaktifkan FH4 secara default setelah runtime Store diperbarui.  Kami berharap untuk melakukan ini di Visual Studio 2019 Pembaruan 1 dan akan memperbarui posting ini yang kita tahu lebih banyak. </p><br><h2>  Perubahan alat </h2><br><p>  Setiap instalasi Visual Studio 2019 Pratinjau 3 dan seterusnya akan memiliki perubahan dalam kompiler dan runtime C ++ untuk mendukung FH4.  Perubahan kompiler ada secara internal di bawah bendera “/ d2FH4” yang disebutkan di atas.  C ++ runtime menampilkan DLL baru bernama vcruntime140_1.dll yang diinstal secara otomatis oleh VCRedist.  Ini diperlukan untuk mengekspos penangan pengecualian baru __CxxFrameHandler4 yang menggantikan rutin __CxxFrameHandler3 yang lebih lama.  Penautan statis dan penyebaran aplikasi-lokal dari runtime C ++ baru juga didukung. </p><br><p>  Sekarang ke hal-hal yang menyenangkan!  Sisa dari posting ini akan membahas hasil internal dari percobaan FH4 pada Windows, Office, dan SQL, diikuti oleh rincian teknis yang lebih mendalam di balik teknologi baru ini. </p><br><h2>  Motivasi dan hasil </h2><br><p>  Sekitar setahun yang lalu, mitra kami pada proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">C ++ / WinR</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">T</a> datang ke tim Microsoft C ++ dengan sebuah tantangan: seberapa besar kita dapat mengurangi ukuran biner penanganan pengecualian C ++ untuk program yang banyak menggunakannya? </p><br><p>  Dalam konteks program yang menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">C ++ / WinRT</a> , mereka mengarahkan kami ke komponen Windows Microsoft.UI.Xaml.dll yang dikenal memiliki jejak biner besar karena penanganan pengecualian C ++.  Saya mengkonfirmasi bahwa ini memang benar dan menghasilkan pemecahan ukuran biner dengan __CxxFrameHandler3 yang ada, ditunjukkan di bawah ini.  Persentase di sisi kanan grafik adalah <strong>persen dari total ukuran biner yang</strong> ditempati oleh tabel metadata tertentu dan kode yang diuraikan. </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/350/cf5/402/350cf5402f932176e7c40f0af3f61161.png" alt="Rincian ukuran Microsoft.UI.Xaml.dll menggunakan __CxxFrameHandler3" width="720" height="480"></a> </h2><br><p>  Saya tidak akan membahas di posting ini apa struktur spesifik di sisi kanan grafik (lihat pembicaraan James McNellis tentang bagaimana <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">stack unwinding bekerja pada Windows</a> untuk lebih jelasnya).  Melihat total metadata dan kode, <strong>26,4%</strong> kekalahan dari ukuran biner digunakan oleh C ++ exception handling.  Ini adalah jumlah ruang yang sangat besar dan menghambat adopsi C ++ / WinRT. </p><br><p>  Kami telah membuat perubahan di masa lalu untuk mengurangi ukuran penanganan pengecualian C ++ di kompiler tanpa mengubah runtime.  Ini termasuk menjatuhkan metadata untuk wilayah kode yang tidak bisa melempar dan melipat negara yang identik secara logis.  Namun, kami mencapai akhir dari apa yang bisa kami lakukan hanya dalam kompiler dan tidak akan dapat membuat penyok signifikan dalam sesuatu sebesar ini.  Analisis menunjukkan bahwa ada kemenangan signifikan yang bisa didapat tetapi diperlukan perubahan mendasar pada data, kode, dan runtime.  Jadi kami pergi ke depan dan melakukannya. </p><br><p>  Dengan __CxxFrameHandler4 baru dan metadata yang menyertainya, rincian ukuran untuk Microsoft.UI.XAML.dll sekarang adalah sebagai berikut: </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e1d/a71/041/e1da71041bf442276ae15eb605a21e6a.png" alt="Rincian ukuran Microsoft.UI.Xaml.dll menggunakan __CxxFrameHandler4" width="720" height="481"></a> </h2><br><p>  Ukuran biner yang digunakan oleh penanganan pengecualian C ++ turun <strong>64% yang</strong> mengarah ke penurunan ukuran biner keseluruhan sebesar <strong>18,6%</strong> pada biner ini.  Setiap jenis struktur menyusut dalam ukuran dengan derajat mengejutkan: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Eh data</strong> </td><td>  <strong>Ukuran __CxxFrameHandler3 (Bytes)</strong> </td><td>  <strong>Ukuran __CxxFrameHandler4 (Bytes)</strong> </td><td>  <strong>% Pengurangan Ukuran</strong> </td></tr><tr><td>  Entri Pdata </td><td>  147.864 </td><td>  118.260 </td><td>  20,0% </td></tr><tr><td>  Lepaskan kode </td><td>  224.284 </td><td>  92.810 </td><td>  58,6% </td></tr><tr><td>  Informasi fungsi </td><td>  255.440 </td><td>  27.755 </td><td>  89,1% </td></tr><tr><td>  Peta IP2State </td><td>  186.944 </td><td>  45.098 </td><td>  75,9% </td></tr><tr><td>  Lepaskan peta </td><td>  80.952 </td><td>  69.757 </td><td>  13,8% </td></tr><tr><td>  Tangkap peta penangan </td><td>  52.060 </td><td>  6,147 </td><td>  88,2% </td></tr><tr><td>  Coba peta </td><td>  51.960 </td><td>  5,196 </td><td>  90,0% </td></tr><tr><td>  Dlets funclets </td><td>  54.570 </td><td> 45.739 </td><td>  16,2% </td></tr><tr><td>  Tangkap funclets </td><td>  102.400 </td><td>  4,301 </td><td>  95,8% </td></tr><tr><td>  Total </td><td>  <strong>1.156.474</strong> </td><td>  <strong>415.063</strong> </td><td>  <strong>64,1%</strong> </td></tr></tbody></table><p>  Gabungan, beralih ke __CxxFrameHandler4 menjatuhkan ukuran keseluruhan Microsoft.UI.Xaml.dll dari 4,4 MB menjadi 3,6 MB. </p><br><p>  Mengujicobakan FH4 pada set representatif binari Office menunjukkan ~ 10% pengurangan ukuran dalam DLL yang menggunakan banyak pengecualian.  Bahkan di Word dan Excel, yang dirancang untuk meminimalkan penggunaan pengecualian, masih ada pengurangan yang berarti dalam ukuran biner. </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Biner</strong> </td><td>  <strong>Ukuran Lama (MB)</strong> </td><td>  <strong>Ukuran Baru (MB)</strong> </td><td>  <strong>% Pengurangan Ukuran</strong> </td><td>  <strong>Deskripsi</strong> </td></tr><tr><td>  chart.dll </td><td>  17.27 </td><td>  15.10 </td><td>  12,6% </td><td>  Dukungan untuk berinteraksi dengan grafik dan grafik </td></tr><tr><td>  Csi.dll </td><td>  9,78 </td><td>  8.66 </td><td>  11,4% </td><td>  Dukungan untuk bekerja dengan file yang disimpan di cloud </td></tr><tr><td>  Mso20Win32Client.dll </td><td>  6.07 </td><td>  5.41 </td><td>  11,0% </td><td>  Kode umum yang dibagikan di antara semua aplikasi Office </td></tr><tr><td>  Mso30Win32Client.dll </td><td>  8.11 </td><td>  7.30 </td><td>  9,9% </td><td>  Kode umum yang dibagikan di antara semua aplikasi Office </td></tr><tr><td>  oart.dll </td><td>  18.21 </td><td>  16.20 </td><td>  11,0% </td><td>  Fitur grafik yang dibagikan di antara aplikasi Office </td></tr><tr><td>  wwlib.dll </td><td>  42.15 </td><td>  41.12 </td><td>  2,5% </td><td>  Biner utama Microsoft Word </td></tr><tr><td>  excel.exe </td><td>  52.86 </td><td>  50.29 </td><td>  4,9% </td><td>  Biner utama Microsoft Excel </td></tr></tbody></table><p>  Mengujicoba FH4 pada inti binari SQL menunjukkan pengurangan ukuran 4-21%, terutama dari kompresi metadata yang dijelaskan di bagian selanjutnya: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Biner</strong> </td><td>  <strong>Ukuran Lama (MB)</strong> </td><td>  <strong>Ukuran Baru (MB)</strong> </td><td>  <strong>% Pengurangan Ukuran</strong> </td><td>  <strong>Deskripsi</strong> </td></tr><tr><td>  sqllang.dll </td><td>  47.12 </td><td>  44.33 </td><td>  5,9% </td><td>  Layanan tingkat atas: Pengurai bahasa, pengikat, pengoptimal, dan mesin eksekusi </td></tr><tr><td>  sqlmin.dll </td><td>  48.17 </td><td>  45.83 </td><td>  4,8% </td><td>  Layanan tingkat rendah: mesin transaksi dan penyimpanan </td></tr><tr><td>  qds.dll </td><td>  1.42 </td><td>  1.33 </td><td>  6,3% </td><td>  Fungsionalitas toko kueri </td></tr><tr><td>  SqlDK.dll </td><td>  3.19 </td><td>  3.05 </td><td>  4,4% </td><td>  Abstraksi SQL OS: memori, utas, penjadwalan, dll. </td></tr><tr><td>  autoadmin.dll </td><td>  1.77 </td><td>  1.64 </td><td>  7,3% </td><td>  Penasihat logika penyetelan basis data </td></tr><tr><td>  xedetours.dll </td><td>  0,45 </td><td>  0,36 </td><td>  21,6% </td><td>  Perekam data penerbangan untuk pertanyaan </td></tr></tbody></table><h2>  Teknologi </h2><br><p>  Ketika menganalisis apa yang menyebabkan pengecualian C ++ penanganan data menjadi sangat besar di Microsoft.UI.Xaml.dll saya menemukan dua penyebab utama: </p><br><ol><li>  Struktur data sendiri besar: tabel metadata berukuran tetap dengan bidang offset relatif gambar dan bilangan bulat masing-masing berukuran empat byte.  Fungsi dengan satu coba / tangkap dan satu atau dua destruktor otomatis memiliki lebih dari 100 byte metadata. </li><li>  Struktur data dan kode yang dihasilkan tidak dapat digabungkan.  Tabel metadata berisi offset relatif-gambar yang mencegah pelipatan COMDAT (proses di mana penghubung dapat melipat bersama potongan data yang identik untuk menghemat ruang) kecuali fungsi yang diwakilinya identik.  Sebagai tambahan, catch funclets (kode yang diuraikan dari blok catch program) tidak dapat dilipat meskipun kode-identik karena metadata mereka terkandung dalam orang tua mereka. </li></ol><br><p>  Untuk mengatasi masalah ini, FH4 merestrukturisasi metadata dan kode sedemikian rupa sehingga: </p><br><ol><li>  Nilai-nilai ukuran tetap sebelumnya telah dikompresi menggunakan pengkodean integer panjang variabel yang turun&gt; 90% dari bidang metadata dari empat byte ke satu.  Tabel metadata sekarang juga panjang variabel dengan header untuk menunjukkan jika bidang tertentu hadir untuk menghemat ruang memancarkan bidang kosong. </li><li>  Semua offset gambar-relatif yang bisa menjadi fungsi-relatif telah dibuat fungsi-relatif.  Ini memungkinkan COMDAT melipat antara metadata dari fungsi yang berbeda dengan karakteristik yang sama (pikirkan contoh template) dan memungkinkan nilai-nilai ini dikompresi.  Catch funclets telah dirancang ulang untuk tidak lagi menyimpan metadata mereka di orang tua mereka sehingga setiap fungsi catch yang identik dengan kode sekarang dapat dilipat menjadi satu salinan dalam biner. </li></ol><br><p>  Untuk mengilustrasikan ini, mari kita lihat definisi asli untuk tabel metadata Function Info yang digunakan untuk __CxxFrameHandler3.  Ini adalah tabel awal untuk runtime saat memproses EH dan menunjuk ke tabel metadata lainnya.  Kode ini tersedia untuk umum di setiap instalasi VS, cari &lt;VS path install&gt; \ VC \ Tools \ MSVC \ &lt;version&gt; \ termasuk \ ehdata.h: </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s_FuncInfo</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> magicNumber:<span class="hljs-number"><span class="hljs-number">29</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Identifies version of compiler unsigned int bbtFlags:3; // flags that may be set by BBT processing __ehstate_t maxState; // Highest state number plus one (thus // number of entries in unwind map) int dispUnwindMap; // Image relative offset of the unwind map unsigned int nTryBlocks; // Number of 'try' blocks in this function int dispTryBlockMap; // Image relative offset of the handler map unsigned int nIPMapEntries; // # entries in the IP-to-state map. NYI (reserved) int dispIPtoStateMap; // Image relative offset of the IP to state map int dispUwindHelp; // Displacement of unwind helpers from base int dispESTypeList; // Image relative list of types for exception specifications int EHFlags; // Flags for some features. } FuncInfo;</span></span></code> </pre> <br><p>  Struktur ini berukuran tetap berisi 10 bidang masing-masing 4 byte.  Ini berarti setiap fungsi yang membutuhkan penanganan pengecualian C ++ secara default menghasilkan 40 byte metadata. </p><br><p>  Sekarang ke struktur data baru (&lt;VS install path&gt; \ VC \ Tools \ MSVC \ &lt;version&gt; \ termasuk \ ehdata4_export.h): </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FuncInfoHeader</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> isCatch : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 if this represents a catch funclet, 0 otherwise uint8_t isSeparated : 1; // 1 if this function has separated code segments, 0 otherwise uint8_t BBT : 1; // Flags set by Basic Block Transformations uint8_t UnwindMap : 1; // Existence of Unwind Map RVA uint8_t TryBlockMap : 1; // Existence of Try Block Map RVA uint8_t EHs : 1; // EHs flag set uint8_t NoExcept : 1; // NoExcept flag set uint8_t reserved : 1; }; uint8_t value; }; }; struct FuncInfo4 { FuncInfoHeader header; uint32_t bbtFlags; // flags that may be set by BBT processing int32_t dispUnwindMap; // Image relative offset of the unwind map int32_t dispTryBlockMap; // Image relative offset of the handler map int32_t dispIPtoStateMap; // Image relative offset of the IP to state map uint32_t dispFrame; // displacement of address of function frame wrt establisher frame, only used for catch funclets };</span></span></code> </pre> <br><p>  Perhatikan bahwa: </p><br><ol><li>  Angka ajaib telah dihapus, memancarkan 0x19930522 setiap kali menjadi masalah ketika sebuah program memiliki ribuan entri ini. </li><li>  EHFlags telah dipindahkan ke header sementara dispESTypeList telah dihapus karena menjatuhkan dukungan spesifikasi pengecualian dinamis di C ++ 17.  Compiler akan default ke __CxxFrameHandler3 yang lebih lama jika spesifikasi pengecualian dinamis digunakan. </li><li>  Panjang tabel lainnya tidak lagi disimpan dalam "Info Fungsi 4".  Hal ini memungkinkan lipatan COMDAT untuk melipat lebih banyak dari tabel menunjuk-ke ​​bahkan jika tabel "Info Fungsi 4" itu sendiri tidak dapat dilipat. </li><li>  (Tidak diperlihatkan secara eksplisit) Bidang dispFrame dan bbtFlags sekarang adalah bilangan bulat panjang variabel.  Representasi tingkat tinggi menjadikannya sebagai uint32_t untuk pemrosesan yang mudah. </li><li>  bbtFlags, dispUnwindMap, dispTryBlockMap, dan dispFrame dapat dihilangkan tergantung pada bidang yang diatur dalam header. </li></ol><br><p>  Dengan mempertimbangkan semua ini, ukuran rata-rata struktur "Function Info 4" yang baru sekarang adalah 13 byte (header 1 byte + tiga gambar relatif 4 byte offset ke tabel lain) yang dapat menurunkan skala lebih jauh jika beberapa tabel tidak diperlukan.  Panjang tabel dipindahkan, tetapi nilai-nilai ini sekarang dikompresi dan 90% di Microsoft.UI.Xaml.dll ditemukan sesuai dalam satu byte.  Menyatukan semua itu, ini berarti ukuran rata-rata untuk mewakili data fungsional yang sama di handler baru adalah 16 byte dibandingkan dengan 40 byte sebelumnya - peningkatan yang cukup dramatis! </p><br><p>  Untuk melipat, mari kita lihat jumlah meja dan fungsi unik dengan penangan lama dan baru: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  Eh data </td><td>  Hitung di __CxxFrameHandler3 </td><td>  Hitung di __CxxFrameHandler4 </td><td>  % Pengurangan </td></tr><tr><td>  Entri Pdata </td><td>  12.322 </td><td>  9,855 </td><td>  20,0% </td></tr><tr><td>  Informasi fungsi </td><td>  6,386 </td><td>  2,747 </td><td>  57,0% </td></tr><tr><td>  Entri Peta IP2State </td><td>  6,363 </td><td>  2,148 </td><td>  66,2% </td></tr><tr><td>  Lepaskan entri peta </td><td>  1,487 </td><td>  1,464 </td><td>  1,5% </td></tr><tr><td>  Tangkap peta penangan </td><td>  2,603 </td><td>  601 </td><td>  76,9% </td></tr><tr><td>  Coba peta </td><td>  2.598 </td><td>  648 </td><td>  75,1% </td></tr><tr><td>  Dlets funclets </td><td>  2,301 </td><td>  1,527 </td><td>  33,6% </td></tr><tr><td>  Tangkap funclets </td><td>  2,603 </td><td>  84 </td><td>  <strong><em>96,8%</em></strong> </td></tr><tr><td>  Total </td><td>  <strong>36.663</strong> </td><td>  <strong>19.074</strong> </td><td>  <strong>48.0%</strong> </td></tr></tbody></table><p>  Jumlah entri data EH unik turun <strong>48%</strong> dari menciptakan peluang lipat tambahan dengan menghapus RVA dan mendesain ulang funclets tangkapan.  Saya secara khusus ingin menyebutkan jumlah fungsi tangkapan yang dicetak miring dalam warna hijau: turun dari 2.603 menjadi hanya 84. Ini adalah konsekuensi dari C ++ / WinRT yang menerjemahkan HRESULTs ke pengecualian C ++ yang menghasilkan banyak fungsi tangkapan yang identik dengan kode yang sekarang dapat terlipat.  Tentu saja penurunan sebesar ini ada pada hasil akhir yang tinggi, namun demikian menunjukkan potensi penghematan ukuran yang dapat dicapai ketika struktur data dirancang dengan mempertimbangkan hal itu. </p><br><h2>  Performa </h2><br><p>  Dengan desain yang memperkenalkan kompresi dan memodifikasi eksekusi runtime, ada kekhawatiran kinerja penanganan pengecualian terpengaruh.  Namun, dampaknya adalah <strong>positif</strong> : kinerja penanganan pengecualian <strong>meningkat</strong> dengan __CxxFrameHandler4 dibandingkan dengan __CxxFrameHandler3.  Saya menguji throughput menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">program</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">benchmark</a> yang melepaskan 100 frame stack masing-masing dengan try / catch dan 3 objek otomatis untuk dihancurkan.  Ini dijalankan 50.000 kali untuk waktu eksekusi profil, yang mengarah ke keseluruhan waktu eksekusi: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td></td><td>  <strong>__CxxFrameHandler3</strong> </td><td>  <strong>__CxxFrameHandler4</strong> </td></tr><tr><td>  <strong>Waktu eksekusi</strong> </td><td>  4.84s </td><td>  4.25-an </td></tr></tbody></table><p>  Profiling menunjukkan bahwa dekompresi memang memperkenalkan waktu pemrosesan tambahan tetapi biayanya lebih besar daripada toko yang lebih sedikit untuk penyimpanan thread-lokal dalam desain runtime baru. </p><br><h2>  Rencana masa depan </h2><br><p>  Seperti disebutkan dalam judul, FH4 saat ini hanya diaktifkan untuk binari x64.  Namun, teknik yang dijelaskan dapat diperluas untuk ARM32 / ARM64 dan pada tingkat lebih rendah x86.  Kami sedang mencari contoh yang baik (seperti Microsoft.UI.Xaml.dll) untuk memotivasi perluasan teknologi ini ke platform lain - jika Anda pikir Anda memiliki kasus penggunaan yang baik, beri tahu kami! </p><br><p>  Proses mengintegrasikan perubahan runtime untuk aplikasi Store untuk mendukung FH4 sedang dalam proses.  Setelah selesai, penangan baru akan diaktifkan secara default sehingga semua orang bisa mendapatkan penghematan ukuran biner ini tanpa usaha tambahan. </p><br><h2>  Komentar penutup </h2><br><p>  Bagi siapa pun yang berpikir biner x64 mereka dapat melakukannya dengan beberapa pengurangan: coba FH4 (via '/ d2FH4') hari ini!  Kami senang melihat penghematan apa yang dapat diberikan ini sekarang setelah fitur ini keluar dari alam.  Tentu saja, jika Anda mengalami masalah apa pun, beri tahu kami di komentar di bawah ini, melalui email ( <a href="">visualcpp@microsoft.com</a> ), atau melalui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Komunitas Pengembang</a> .  Anda juga dapat menemukan kami di Twitter ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">@VisualC</a> ). </p><br><p>  Terima kasih kepada Kenny Kerr karena mengarahkan kami ke Microsoft.UI.Xaml.dll, Ravi Pinjala untuk mengumpulkan angka-angka di Office, dan Robert Roessler untuk menguji coba ini pada SQL. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id442996/">https://habr.com/ru/post/id442996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id442984/index.html">Perubahan PSU dari komputer IBM 5150 model A 230 V</a></li>
<li><a href="../id442986/index.html">Tesla Autopilot: Strategi Implementasi</a></li>
<li><a href="../id442988/index.html">Mesin virtual DIY</a></li>
<li><a href="../id442992/index.html">Kalkulator Windows Sekarang Open-Source</a></li>
<li><a href="../id442994/index.html">Mengumumkan Sumber Terbuka Kalkulator Windows</a></li>
<li><a href="../id442998/index.html">Under-Carpet Analytics: Tinjauan 18 Tahun Baru</a></li>
<li><a href="../id443000/index.html">Pembaruan untuk versi C # dan tooling C #</a></li>
<li><a href="../id443002/index.html">Keadaan ilmu kesadaran saat ini</a></li>
<li><a href="../id443004/index.html">Pacar saya dan gim video pertama. Pengembangan persatuan. Bagian 1</a></li>
<li><a href="../id443006/index.html">Grafana v6 dirilis - fitur baru alat visualisasi terbuka</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>