<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§Ωüèº ü§Ø üê∂ Mod√®les personnalis√©s dans GTM: un exemple üë©‚Äçüë¶‚Äçüë¶ üë®üèø‚Äçü§ù‚Äçüë®üèΩ ü§ôüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fin mai, Google a introduit une nouvelle fonctionnalit√© dans Google Tag Manager (GTM): des mod√®les personnalis√©s ou des mod√®les personnalis√©s. Voyons ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mod√®les personnalis√©s dans GTM: un exemple</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458788/">  Fin mai, Google a introduit une nouvelle fonctionnalit√© dans Google Tag Manager (GTM): des mod√®les personnalis√©s ou des mod√®les personnalis√©s.  Voyons pourquoi il est n√©cessaire, comment l'utiliser, quelles sont les diff√©rences avec les balises HTML et les variables JavaScript. <br><br>  Par exemple, envisagez de cr√©er un mod√®le personnalis√© pour un pixel de reciblage dynamique VKontakte et de personnaliser davantage les balises GTM √† travers lui. <br><br><img src="https://habrastorage.org/webt/c-/62/zr/c-62zrfxks1t6c2gfsv0kn2brjm.png"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mots simples sur les mod√®les personnalis√©s</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cr√©ation d'un mod√®le personnalis√©</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Ä¢ Onglet Info</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Ä¢ Onglet Champs</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Ä¢ Onglet Code</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Ä¢ Onglet Autorisations</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Personnalisation et test de la balise sur le mod√®le personnalis√© cr√©√©</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Ä¢ Page vue</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Ä¢ AddToCart</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Ä¢ Test minier</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conclusion</a> <br><br><a name="1"></a><h2>  Mots simples sur les mod√®les personnalis√©s </h2><br>  Les mod√®les personnalis√©s sont des mod√®les gr√¢ce auxquels les utilisateurs peuvent cr√©er de nouvelles balises ou variables.  GTM a des mod√®les pr√™ts √† l'emploi (dans la section En vedette ou recommand√©), par exemple, la balise Google Analytics, Google Optimize et autres.  Nous pouvons maintenant les compl√©ter avec nos mod√®les.  Une fois cr√©√©s, ils appara√Ætront dans l'onglet Personnalis√©: <br><br><img src="https://habrastorage.org/webt/nx/q_/mu/nxq_mu_uxl6tyiumnl8xbzt6o2c.png"><br><br>  La principale diff√©rence avec les balises HTML et les variables JS est que lorsqu'un utilisateur cr√©e une balise ou une variable √† l'aide d'un mod√®le pr√™t √† l'emploi, il n'interagit pas avec le code JS. <br><br>  Le code du mod√®le utilisateur est √©crit par le d√©veloppeur ou l'analyste Web au stade de sa cr√©ation.  Ensuite, lors de la cr√©ation d'une balise ou d'une variable selon un mod√®le utilisateur, toutes les interactions sont effectu√©es via l'interface (qui est √©galement configur√©e lors de la cr√©ation d'un mod√®le utilisateur): <br><br><img src="https://habrastorage.org/webt/pe/e2/te/pee2tevqbahm_nplbfgj0btis34.png"><br><br>  Par cons√©quent, par rapport √† l'√©criture d'une balise HTML ou d'une variable JS, la personnalisation d'une balise ou d'une variable selon un mod√®le utilisateur devient un ordre de grandeur plus facile, car cela ne n√©cessite pas de connaissances et de comp√©tences pour travailler avec JavaScript. <br><br>  Un autre grand avantage des mod√®les personnalis√©s est que la probabilit√© de "mettre" un site est r√©duite d'un ordre de grandeur en raison d'une erreur dans le code JS de la balise. <br><br>  Dans notre exemple, pour configurer la balise de reciblage dynamique "VKontakte", vous n'avez plus besoin de contacter les d√©veloppeurs - tout peut √™tre configur√© ind√©pendamment, m√™me le transfert de donn√©es sur les marchandises (lorsque le commerce √©lectronique avanc√© de Google est configur√© sur le site), n'ayant qu'une exp√©rience avec GTM. <br><br><a name="2"></a><h2>  Cr√©ation d'un mod√®le personnalis√© </h2><br>  Puisque nous cr√©ons un mod√®le de balise, nous devons aller dans la section Mod√®les et cliquer sur le bouton Nouveau dans la section Mod√®les de balises. <br><br><img src="https://habrastorage.org/webt/ca/bt/sa/cabtsaamxy-zoglccqgvt1v_tra.png"><br><br>  Apr√®s cela, l'√©diteur de mod√®le s'ouvre: <br><br><img src="https://habrastorage.org/webt/bf/c3/jf/bfc3jf2xgpkasmc3qvik2tp4wxy.png"><br><br>  Sur le c√¥t√© gauche de l'√©diteur, il y a une fen√™tre de param√®tres, sur le c√¥t√© droit il y a une fen√™tre d'aper√ßu et une console.  La fen√™tre des param√®tres contient quatre onglets n√©cessaires √† la cr√©ation et √† l'utilisation du mod√®le. <br><br><a name="3"></a><h3>  Onglet Info </h3><br>  Les informations sur le tag sont renseign√©es sur cet onglet: nom, description, ic√¥ne.  Voici les informations que nous verrons lors de la cr√©ation d'une nouvelle balise dans la liste des mod√®les: <br><br><img src="https://habrastorage.org/webt/dd/nm/9f/ddnm9fvcygh2ob6jzkliccqgi1o.png"><br><br>  Il y a des exigences pour l'ic√¥ne de balise: format PNG, JPEG ou GIF, une r√©solution d'au moins 64x64 pixels et une taille ne d√©passant pas 50 Ko. <br><br><a name="4"></a><h3>  Onglet Champs </h3><br>  Cette section cr√©e l'interface de notre mod√®le.  L'interface se compose de divers champs et formulaires avec lesquels l'utilisateur interagit au stade de la cr√©ation d'une nouvelle balise ou variable. <br><br>  √Ä l'avenir, les informations entr√©es par l'utilisateur lors de la cr√©ation de la balise √† l'aide de l'interface seront utilis√©es dans le code du mod√®le. <br><br>  Pour ajouter un nouvel √©l√©ment, cliquez sur le bouton Ajouter un champ.  La fen√™tre de s√©lection du type d'√©l√©ment appara√Æt: <br><br><img src="https://habrastorage.org/webt/g5/ko/d7/g5kod7ox7dal761180kpdfhojto.png"><br><br>  GTM vous permet de s√©lectionner les types d'√©l√©ments d'interface suivants: <br><br><ul><li>  <b>zone de texte</b> </li><li>  <b>menu d√©roulant</b> </li><li>  <b>case √† cocher</b> ; </li><li>  <b>interrupteurs</b> </li><li>  <b>tableau simple</b> , ici vous pouvez √©diter chaque cellule. </li><li>  <b>table √©tendue</b> , vous ne pouvez modifier qu'une ligne, ce type de table est pratique √† utiliser pour cr√©er un dictionnaire √† partir de paires cl√©-valeur; </li><li>  <b>groupe d'√©l√©ments</b> , vous permet de regrouper plusieurs types en un groupe; </li><li>  <b>le raccourci est</b> utilis√© pour ajouter du texte √† l'interface; il ne n√©cessite pas que l'utilisateur entre des donn√©es. </li></ul><br>  Apr√®s avoir ajout√© un √©l√©ment, vous devez lui donner un nom convivial, qui sera ensuite utilis√© dans le code.  Il s'agit d'une sorte de nom de variable - il doit √™tre compr√©hensible et r√©v√©ler l'essence de l'√©l√©ment d'interface cr√©√©.  Par exemple, le nom ¬´ID¬ª ne signifie rien de sp√©cifique, mais le nom ¬´pixelIDs¬ª montre d√©j√† que les identifiants de pixel saisis par l'utilisateur sont stock√©s dans cet √©l√©ment: <br><br><img src="https://habrastorage.org/webt/fv/1h/ht/fv1hht_iaatbuhi1ejovajkehhc.png"><br><br>  Ensuite, acc√©dez aux param√®tres de chaque √©l√©ment et activez les propri√©t√©s n√©cessaires. <br>  Dans diff√©rentes situations, diff√©rentes propri√©t√©s de l'√©l√©ment d'interface sont requises, donc par d√©faut, elles sont toutes cach√©es et nous devons activer celles qui sont n√©cessaires maintenant: <br><br><img src="https://habrastorage.org/webt/ah/jx/o1/ahjxo1oz0w8fp6pntytshfs1y_o.png"><br><br>  Pour diff√©rents types d'√©l√©ments, les propri√©t√©s disponibles diff√®rent, je vais indiquer les plus utilis√©es, qui sont presque tous des √©l√©ments: <br><br>  <b>1. Nom d'affichage</b> .  Voici le nom que l'utilisateur verra dans l'interface lors de la cr√©ation de la balise: <br><br><img src="https://habrastorage.org/webt/jf/lk/-g/jflk-glzt0dahft6vpdx9qrzy8q.png"><br><br>  <b>2. Exemple de valeur</b> .  Voici un indice pour l'utilisateur sur les valeurs √† saisir dans le champ: <br><br><img src="https://habrastorage.org/webt/b6/zz/sc/b6zzscielm1pjho74x22rk88c0c.png"><br><br>  <b>3. Texte d'aide</b> .  Voici le texte que l'utilisateur verra s'il survole l'ic√¥ne d'aide de l'√©l√©ment: <br><br><img src="https://habrastorage.org/webt/nv/wo/qr/nvwoqraide7hp-qrbdjaomwvg3e.png"><br><br>  <b>4. R√®gles de v√©rification des donn√©es</b> .  Dans cette propri√©t√©, vous pouvez d√©finir certaines r√®gles pour v√©rifier les donn√©es entr√©es par l'utilisateur dans le champ et, si n√©cessaire, le texte d'erreur qui appara√Æt lorsque vous essayez d'enregistrer une balise avec des donn√©es qui n'ont pas r√©ussi le test. <br><br>  Par exemple, vous pouvez sp√©cifier que le champ doit √™tre rempli.  Le deuxi√®me exemple: vous devez obtenir une adresse e-mail de l'utilisateur, puis vous pouvez v√©rifier que les donn√©es saisies par l'utilisateur doivent correspondre √† l'expression r√©guli√®re <b>. * @. * \ .. *</b> . <br><br><img src="https://habrastorage.org/webt/3s/ma/pb/3smapbl1aorsc4fsvhwpd-1oy4m.png"><br><br>  Pour sp√©cifier le texte d'erreur qui appara√Æt si les donn√©es saisies ne sont pas conformes aux r√®gles de v√©rification, vous devez activer les param√®tres de r√®gle avanc√©s: <br><br><img src="https://habrastorage.org/webt/kb/zw/qr/kbzwqr32irigkreu9bbht9fxf1m.png"><br><br><img src="https://habrastorage.org/webt/ek/xh/hg/ekxhhgobsta59wpr6uxsbaqzdwg.png"><br><br>  De plus, dans les param√®tres avanc√©s, vous pouvez sp√©cifier les conditions dans lesquelles cette r√®gle est activ√©e (le champ Activer la condition). <br><br>  <b>5. Conditions d'inclusion</b> .  Ce sont les conditions dans lesquelles l'utilisateur aura cet √©l√©ment d'interface. <br><br>  Par exemple, afin de ne pas surcharger le mod√®le avec des √©l√©ments d'interface, vous pouvez faire appara√Ætre les √©l√©ments n√©cessaires lorsque la case est coch√©e.  Autrement dit, supposons que si un utilisateur souhaite configurer le transfert des donn√©es de produit dans un pixel (cela est possible avec le site de commerce √©lectronique avanc√© de Google configur√© sur le site), il s√©lectionne la case "Utiliser dataLayer pour transf√©rer les donn√©es de produit", et apr√®s avoir coch√© la case, des √©l√©ments apparaissent dans l'interface du tag n√©cessaire pour configurer un tel transfert.  Si la case n'est pas coch√©e, il n'y a aucun √©l√©ment dans l'interface. <br><br><img src="https://habrastorage.org/webt/rp/ui/x_/rpuix__y-ya--_uat8taekcwpa0.png"><br><br>  Je note qu'ici, il est n√©cessaire d'indiquer le nom de l'√©l√©ment, qui devait lui √™tre attribu√© imm√©diatement apr√®s l'ajout. <br><br>  Lorsque vous ajoutez des param√®tres et cr√©ez une interface, toutes les modifications peuvent √™tre imm√©diatement visualis√©es et test√©es dans la fen√™tre d'aper√ßu: <br><br><img src="https://habrastorage.org/webt/df/bl/l9/dfbll9mc0qvpwcxnbzzx-fbg71g.png"><br><br><a name="5"></a><h3>  Onglet Code </h3><br>  Cet onglet est un √©diteur de code. <br><br>  Le code GTM Custom Templates est √©crit en JavaScript ¬´all√©g√©¬ª ES6 et s'ex√©cute dans un environnement isol√© o√π toutes les communications avec les donn√©es globales (c'est-√†-dire directement avec la page) se font via l'API.  Il n'y a pas d'objets globaux, tels que fen√™tre ou document, respectivement, dans les m√©thodes habituelles.  Par exemple, les constructeurs (nouvel objet et similaires), setTimeout, parseInt, delete, etc.  - tout cela ne fonctionnera pas dans le mod√®le personnalis√©. <br><br>  Mais il y a une API pour tout √ßa.  Et par cons√©quent, l'√©criture de code pour un mod√®le personnalis√© doit commencer par le fait que nous d√©finissons les API que nous utiliserons dans notre code: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// API //     const copyFromWindow = require('copyFromWindow'); //     const setInWindow = require('setInWindow'); //      const injectScript = require('injectScript'); //    const callInWindow = require('callInWindow'); //  ,     ,    const makeTableMap = require('makeTableMap'); //   URL  const getUrl = require('getUrl'); //    const getQueryParameters = require('getQueryParameters'); //     const makeInteger = require('makeInteger'); //    const makeString = require('makeString'); //  setTimeout const callLater = require('callLater'); //  console.log const logToConsole = require('logToConsole');</span></span></code> </pre> <br>  Consultez l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aide aux d√©veloppeurs Google pour obtenir une</a> liste compl√®te des API avec une documentation d√©taill√©e. <br><br>  Je vais vous montrer des exemples de la fa√ßon de travailler avec l'API: <br><div class="scrollable-table"><table><tbody><tr><th>  Description de l'action </th><th>  Classic js </th><th>  API de mod√®le personnalis√© </th></tr><tr><td>  Sortie console </td><td>  console.log ('Salut'); </td><td>  logToConsole ('Salut'); </td></tr><tr><td>  R√©gler la minuterie </td><td>  setTimeout (fonction, 100); </td><td>  callLater (fonction); </td></tr><tr><td>  Convertir en cha√Æne </td><td>  Cha√Æne (1234); </td><td>  makeString (1234); </td></tr><tr><td>  Conversion en entier </td><td>  parseInt (¬´1234¬ª, 10); </td><td>  makeInteger (¬´1234¬ª); </td></tr><tr><td>  H√¥te de la page </td><td>  window.location.hostname </td><td>  getUrl ('h√¥te'); </td></tr></tbody></table></div><br>  Comme vous pouvez le voir dans le tableau d'exemple, apr√®s avoir d√©fini l'API, vous devez l'utiliser √† la place des constructions JS standard. <br><br>  Apr√®s avoir d√©fini l'API, il est souhaitable de d√©finir un objet avec les param√®tres que l'utilisateur a saisis.  Cela peut √©galement √™tre fait apr√®s, par exemple, pendant le code ex√©cutable, en demandant les donn√©es n√©cessaires aux param√®tres de l'utilisateur.  Mais si nous d√©finissons l'objet settings depuis le tout d√©but, travailler avec le code devient plus facile et plus compr√©hensible, car tous les param√®tres utilisateur sont stock√©s dans un objet s√©par√©. <br><br>  Pour obtenir des donn√©es d'un √©l√©ment d'interface, vous devez utiliser la construction de donn√©es. <br><br>  {{nom d'√©l√©ment}}: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    const settings = { //  event: data.event, //ID  () pixelIDs: data.pixelIDs, //ID - (  1 -) priceListId: data.priceListId, //   -? fewPriceLists: data.fewPriceLists, //ID - (    ) priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), //  ecommerce   ? ecommerceUse: data.ecommerceUse, // ecommerce   eventEcommerce: data.eventEcommerce, //     siteSearchQueryParam: data.siteSearchQueryParam };</span></span></code> </pre><br>  Remarque: si vous passez undefined √† la m√©thode makeTableMap, cela provoquera une erreur de script, donc j'utilise une construction avec un op√©rateur ternaire (un enregistrement abr√©g√© de la construction if-else) pour filtrer ces scripts. <br><br><div class="spoiler">  <b class="spoiler_title">√Ä propos de la m√©thode makeTableMap.</b> <div class="spoiler_text">  Si l'interface utilise une table √©tendue, les donn√©es qu'elle contient sont stock√©es sous cette forme: <br><br><pre> <code class="javascript hljs">[ <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k1'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>}, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k2'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span>} ]</code> </pre><br>  Apr√®s traitement avec la m√©thode makeTableMap, les donn√©es deviennent un objet normal avec des paires cl√©-valeur: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">'k1'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-string"><span class="hljs-string">'k2'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span> }</code> </pre><br></div></div><br>  Autre exigence pour le code du mod√®le personnalis√©: si la balise est correctement ex√©cut√©e, vous devez appeler la m√©thode data.gtmOnSuccess () et en cas d'erreur, appeler la m√©thode data.gtmOnFailure (). <br><br>  Par exemple, dans mon code, la m√©thode data.gtmOnSuccess () est appel√©e apr√®s que la demande a √©t√© envoy√©e avec succ√®s et la m√©thode data.gtmOnFailure () est appel√©e si le t√©l√©chargement √©choue sur la page de script externe VK openapi.js. <br><br>  Apr√®s avoir d√©fini l'API et d√©fini l'objet avec les param√®tres, vous pouvez commencer √† √©crire un algorithme pour travailler le pixel. <br><br>  La principale chose √† retenir ici est: <br><br>  ‚Ä¢ Si vous avez besoin d'obtenir une variable globale - utilisez la m√©thode API copyFromWindow. <br><br><pre> <code class="javascript hljs">copyFromWindow(<span class="hljs-string"><span class="hljs-string">'VK'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//VK -   ,    </span></span></code> </pre><br>  ‚Ä¢ Si vous devez d√©finir une variable globale, nous utilisons la m√©thode API setInWindow. <br><br><pre> <code class="javascript hljs">setInWindow(<span class="hljs-string"><span class="hljs-string">'openapiInject'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//openapiInject -   ,    //1 - ,    .</span></span></code> </pre><br>  ‚Ä¢ Si vous devez ex√©cuter une fonction globale, nous utilisons la m√©thode API callInWindow. <br><br><pre> <code class="javascript hljs">callInWindow(<span class="hljs-string"><span class="hljs-string">'VK.Retargeting.Init'</span></span>, p); <span class="hljs-comment"><span class="hljs-comment">//VK.Retargeting.Init -   ,    //p - ,     </span></span></code> </pre><br>  ‚Ä¢ Si vous devez ajouter un script externe √† la page - utilisez la m√©thode API injectScript. <br><br><pre> <code class="javascript hljs">injectScript(<span class="hljs-string"><span class="hljs-string">'https://vk.com/js/api/openapi.js?159'</span></span>, pixel.setVkAsyncInit(), data.gtmOnFailure, <span class="hljs-string"><span class="hljs-string">'vkPixel'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//https://vk.com/js/api/openapi.js?159 -  ,      //pixel.setVkAsyncInit() - ,        //data.gtmOnFailure - ,        //vkPixel -  ,  ,   URL  .    ,   JavaScript      </span></span></code> </pre><br>  ‚Ä¢ Si vous devez obtenir l'URL (ou une partie de celle-ci) - utilisez la m√©thode API getUrl. <br><br><pre> <code class="javascript hljs">getUrl(<span class="hljs-string"><span class="hljs-string">'host'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//host -  URL,  .  ,  host: protocol, port, path, extension, fragment, query.</span></span></code> </pre><br>  Comme je l'ai √©crit ci-dessus, le mod√®le personnalis√© prend en charge JS ES6.  Il est conseill√© d'utiliser cette syntaxe, car elle raccourcit le code et le rend plus lisible, et le travail de JS est plus pr√©visible et similaire √† d'autres langages de programmation. <br><br><div class="spoiler">  <b class="spoiler_title">Plus d'informations sur la syntaxe JS ES6</b> <div class="spoiler_text">  La principale chose qu'il est souhaitable d'utiliser est les fonctions fl√©ch√©es et les d√©clarations de const et let variables au lieu de var. <br><br>  Une variable d√©clar√©e via const est une constante dont la valeur ne peut pas √™tre modifi√©e. <br><br>  Une variable d√©clar√©e par let diff√®re d'une variable d√©clar√©e par var comme suit: <br><br><ul><li>  let n'est pas ajout√© √† l'objet de fen√™tre globale; </li><li>  la visibilit√© est limit√©e au bloc de d√©claration; </li><li>  les variables d√©clar√©es via let ne peuvent pas √™tre re-d√©clar√©es. </li></ul><br>  Les fonctions fl√©ch√©es sont l'abr√©viation des fonctions habituelles: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//1.   const func1 = function() { return 'test'; } //    const func1 = () =&gt; 'test'; //2.   const func2 = function(arg) { if (arg &gt; 0) return 'plus'; else return 'minus'; } //    const func2 = arg =&gt; { if (arg &gt; 0) return 'plus'; else return 'minus'; } //3.   const func3 = function(arg1, arg2){ if (arg1 &gt; arg2) return arg1; else return arg2; } //    const func3 = (arg1, arg2) =&gt; { if (arg1 &gt; arg2) return arg1; else return arg2; }</span></span></code> </pre><br></div></div><br>  Maintenant que nous comprenons comment utiliser l'API de mod√®le personnalis√©, nous pouvons √©crire le code d'op√©ration de balise √† l'aide de la syntaxe JavaScript ES6. <br><br>  Mon code contient des m√©thodes pour lancer un pixel, installer VK openapi.js, r√©cup√©rer les donn√©es produit de dataLayer (avec le site de commerce √©lectronique avanc√© de Google configur√©), traiter ces donn√©es pour les mettre sous la forme n√©cessaire pour l'envoi au pixel de reciblage VKontakte et la m√©thode de r√©partition des √©v√©nements. <br><br>  La m√©thode de d√©clenchement par pixel prend en charge trois sc√©narios: <br><br><ol><li>  Le pixel s'ex√©cute sur une page o√π openapi.js est manquant. </li><li>  Le pixel s'ex√©cute sur la page o√π se trouve openapi.js, mais il n'a pas encore √©t√© charg√©. </li><li>  Le pixel est lanc√© sur la page avec openapi.js charg√©. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Le code complet de mon mod√®le GTM personnalis√© pour le pixel de reciblage dynamique VKontakte</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//api const copyFromWindow = require('copyFromWindow'); const setInWindow = require('setInWindow'); const injectScript = require('injectScript'); const callInWindow = require('callInWindow'); const makeTableMap = require('makeTableMap'); const getUrl = require('getUrl'); const getQueryParameters = require('getQueryParameters'); const makeInteger = require('makeInteger'); const makeString = require('makeString'); const callLater = require('callLater'); //    const settings = { event: data.event, pixelIDs: data.pixelIDs, priceListId: data.priceListId, fewPriceLists: data.fewPriceLists, priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), ecommerceUse: data.ecommerceUse, eventEcommerce: data.eventEcommerce, siteSearchQueryParam: data.siteSearchQueryParam }; //       const pixel = { //    getPageHostname: () =&gt; getUrl('host'), //    VK getVK: () =&gt; copyFromWindow('VK'), //    VK setVkAsyncInit: () =&gt; { setInWindow('vkAsyncInit', pixel.sendEvent); }, //       getSiteSearchPhrase: () =&gt; { if (settings.event === 'view_search') return getQueryParameters(settings.siteSearchQueryParam); else return undefined; }, //      getEventParams: (products, currencyCode, revenue) =&gt; { let eventParamsClean= {}; let eventParams = { products: eventProducts.getProductParams(products), category_ids: eventProducts.getCategoryString(products), currency_code: currencyCode, total_price: eventProducts.getTotalPrice(products, revenue), search_string: pixel.getSiteSearchPhrase() }; if (eventParams.products !== undefined) eventParamsClean.products = eventParams.products; if (eventParams.category_ids !== undefined) eventParamsClean.category_ids = eventParams.category_ids; if (eventParams.currency_code !== undefined) eventParamsClean.currency_code = eventParams.currency_code; if (eventParams.total_price !== undefined) eventParamsClean.total_price = eventParams.total_price; if (eventParams.search_string !== undefined) eventParamsClean.search_string = eventParams.search_string; return eventParamsClean; }, //  - getPriceListId: hostname =&gt; { if (settings.fewPriceLists) return settings.priceListIds[hostname]; else return settings.priceListId; }, //  openapi.js openapiInit: () =&gt; { injectScript('https://vk.com/js/api/openapi.js?159', pixel.setVkAsyncInit(), data.gtmOnFailure, 'vkPixel'); setInWindow('openapiInject', 1); }, //   sendEvent: () =&gt; { if (settings.event === 'hit') { settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.Hit'); }); } else { const pricelist = pixel.getPriceListId(pixel.getPageHostname()); const name = settings.event; let products = []; if(settings.ecommerceUse) products = name === 'view_home' || name === 'view_category' || name === 'view_search' || name === 'view_other' ? settings.eventEcommerce : settings.eventEcommerce.products; else products = undefined; const currencyCode = settings.ecommerceUse ? settings.eventEcommerce.currencyCode : undefined; const revenue = (settings.ecommerceUse &amp;&amp; name === 'purchase') ? settings.eventEcommerce.actionField.revenue : undefined; const eventParams = settings.ecommerceUse ? pixel.getEventParams(products, currencyCode, revenue) : undefined; settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.ProductEvent', pricelist, name, eventParams); }); }, //   start: () =&gt; { if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') !== 1) { pixel.openapiInit(); data.gtmOnSuccess(); } else if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') === 1) { if (pixel.count &lt; 50) { callLater(pixel.start); pixel.count++; } else return; } else { pixel.sendEvent(); data.gtmOnSuccess(); }, //   count: 0 }; //       const eventProducts = { //    products   getProductParams: products =&gt; { let arr = []; products.forEach(i =&gt; { let productParamsClean = {}; let productParams = { id: makeString(i.id), group_id: makeString(i.brand), price: makeInteger(i.price * 100) / 100 }; if (productParams.id !== 'undefined') productParamsClean.id = productParams.id; if (productParams.group_id !== 'undefined') productParamsClean.group_id = productParams.group_id; if (productParams.price !== 0) productParamsClean.price = productParams.price; arr.push(productParamsClean); }); return arr; }, //       'a,b,c'       getCategoryString: products =&gt; { let categoryId = ''; let check = []; products.forEach(i =&gt; { if(check.indexOf(i.category) === -1) { check.push(i.category); categoryId += ',' + i.category; }); return categoryId.slice(1); }, //     getTotalPrice: (products, revenue) =&gt; { let sumPrice = 0; if (revenue !== undefined ) return makeInteger(revenue * 100) / 100; else { products.forEach(i =&gt; { if (i.hasOwnProperty('quantity')) sumPrice += (makeInteger(i.price * 100) / 100) * makeInteger(i.quantity); else sumPrice += makeInteger(i.price * 100) / 100; }); return sumPrice; }; //  pixel.start();</span></span></code> </pre> <br></div></div><br><a name="6"></a><h2>  Onglet Autorisations </h2><br>  Apr√®s avoir √©crit le code de balise, la derni√®re √©tape reste - pour √©mettre des autorisations d'interagir avec les donn√©es globales de la page.  Cela se fait uniquement sur l'onglet Autorisations. <br><br>  √âtant donn√© que le code est ex√©cut√© dans un environnement isol√© et que l'interaction avec les donn√©es globales se produit via l'API, pour chaque m√©thode API (si n√©cessaire), nous devons sp√©cifier manuellement les autorisations pour certaines actions. <br><br>  Ceci est fait afin d'aborder le travail avec les donn√©es de page globales de mani√®re aussi r√©fl√©chie que possible, et ainsi minimiser les chances de "mettre" le site dans une erreur dans le code de notre mod√®le. <br><br>  Pour les m√©thodes API utilis√©es dans mon code, trois types d'autorisations doivent √™tre √©mis: <br><br><img src="https://habrastorage.org/webt/29/og/lw/29oglwyra6zkhac7_2lr4jpqq5a.png"><br><br>  <b>1. Acc√®de aux variables globales</b> - lire, √©crire, ex√©cuter l'acc√®s aux variables globales qui sont utilis√©es dans notre code.  Les variables doivent √™tre ajout√©es manuellement et pour chacune d'elles indiquer ce que nous autorisons √† faire. <br><br><img src="https://habrastorage.org/webt/f3/qb/6b/f3qb6b9sj6rn1v4q55t_z9f362e.png"><br><br>  Par exemple, la variable VK ne peut √™tre lue que, vkAsyncInit peut √™tre lu et red√©fini et la m√©thode VK.Retargeting.Hit ne peut √™tre ex√©cut√©e. <br><br>  <b>2. Lit l'URL</b> .  Ici, vous devez sp√©cifier quelles parties de l'URL sont autoris√©es √† recevoir.  J'autorise la r√©ception de toutes les parties de l'URL: <br><br><img src="https://habrastorage.org/webt/do/um/li/doumlixqd-rw2cppm4ordw1svae.png"><br><br>  Mais si vous le souhaitez, vous pouvez sp√©cifier tout sp√©cifique: <br><br><img src="https://habrastorage.org/webt/sj/d3/ne/sjd3nefe52_foeat88kifeodi-w.png"><br><br>  <b>3. Injecte des scripts</b> .  Ici, il est n√©cessaire d'enregistrer les adresses √† partir desquelles vous pouvez t√©l√©charger des scripts externes.  Dans mon code, un seul script avec VK openapi.js est charg√©, je pr√©cise son adresse: <br><br><img src="https://habrastorage.org/webt/xt/oy/hd/xtoyhd-yprd2sn_eu41mbquh2s0.png"><br><br>  C'est tout, la configuration du mod√®le personnalis√© est termin√©e, vous pouvez enregistrer le mod√®le et proc√©der aux tests. <br><br><a name="7"></a><h2>  Personnalisation et test de la balise sur le mod√®le personnalis√© cr√©√© </h2><br>  Par exemple, nous allons cr√©er deux balises de reciblage dynamique ¬´VKontakte¬ª en utilisant le mod√®le personnalis√© cr√©√©: pageview et addToCart. <br><br><a name="8"></a><h3>  Page vue </h3><br>  Nous allons entrer dans le conteneur GTM n√©cessaire, cr√©er une nouvelle balise, s√©lectionner le type de balise VK Pixel dans la section personnalis√©e: <br><br><img src="https://habrastorage.org/webt/gd/s-/fi/gds-fi0tqxxcmfkkccsi8trowq4.png"><br><br>  Remplissez le nom du tag, s√©lectionnez l'√©v√©nement √† suivre, s√©lectionnez Hit (il s'agit d'une page vue standard), dans le champ "Pixel ID" indiquez l'ID des deux pixels vers lesquels les donn√©es seront envoy√©es, et d√©finissez le d√©clencheur Toutes les pages: <br><br><img src="https://habrastorage.org/webt/vr/op/-0/vrop-0cjfqndkh35qnbtdsoxpc4.png"><br><br>  Enregistrez la balise cr√©√©e. <br><br><a name="9"></a><h3>  AddToCart </h3><br>  Cr√©er une balise pour un √©v√©nement en ajoutant un produit au panier sera un peu plus compliqu√© qu'une balise Hit. <br><br>  Tout d'abord, vous devez transf√©rer les marchandises ajout√©es au panier.  Comme je l'ai √©crit ci-dessus, cela est possible avec le commerce √©lectronique avanc√© de Google configur√© sur le site.  Dans ce cas, les donn√©es produit sont extraites de dataLayer. <br><br>  Pour ce faire, nous devons cr√©er la variable dataLayer dans GTM, qui stockera l'objet de commerce √©lectronique pour l'√©v√©nement addToCart.  Les param√®tres variables ressemblent √† ceci: <br><br><img src="https://habrastorage.org/webt/ko/r5/gu/kor5gumudjjzs9groemuo7nepco.png"><br><br>  Deuxi√®mement, vous devez cr√©er un d√©clencheur qui activera la balise lorsque l'√©v√©nement de commerce √©lectronique addToCart se produit (le d√©clencheur activera la balise lors de l'introduction du dataLayer lorsque l'√©v√©nement addToCart se produit): <br><br><img src="https://habrastorage.org/webt/og/xl/lt/ogxlltp_4_spurvq8fesqg3uy0m.png"><br><br>  Apr√®s avoir cr√©√© une variable avec un objet de commerce √©lectronique et un d√©clencheur, vous pouvez commencer √† cr√©er la balise: <br><br><img src="https://habrastorage.org/webt/dp/qg/zq/dpqgzqb27rcdydnjeen5fftp6ba.png"><br><br>  Pour: <br><br><ol><li>  En tant qu'√©v√©nement suivi, s√©lectionnez Ajouter au panier. </li><li>  Nous remplissons l'ID s√©par√© par des virgules de deux pixels dans lesquels les donn√©es doivent √™tre transf√©r√©es. </li><li>  Cochez la case ¬´Utiliser plusieurs listes de prix¬ª: pour Moscou et Saint-P√©tersbourg, dans notre exemple, il est n√©cessaire d'utiliser des listes de prix diff√©rentes. </li><li>  Remplissez le tableau avec les listes de prix. </li><li>  Cochez la case ¬´Utiliser le commerce √©lectronique pour transf√©rer des produits et des param√®tres¬ª. </li><li>  Dans l'objet de commerce √©lectronique de cet √©v√©nement, sp√©cifiez la variable cr√©√©e pr√©c√©demment. </li><li>  Nous avons d√©fini le d√©clencheur de l'√©v√©nement surveill√©, dans ce cas - AddToCart. </li><li>  Enregistrez. </li></ol><br><a name="10"></a><h3>  Test minier </h3><br>  Pour v√©rifier le fonctionnement des pixels du reciblage dynamique sur VKontakte, vous devez activer le mode Aper√ßu dans GTM, allez sur notre site Web et ouvrez la section R√©seau dans la console du navigateur et entrez 'rtrg' dans le champ Filtre: <br><img src="https://habrastorage.org/webt/ci/m9/z8/cim9z824mbc9dfvdz-4425fe02w.png"><br><br>  Apr√®s cela, nous actualisons la page et nous devrions avoir deux demandes - l'√©v√©nement Hit envoy√© en deux pixels: <br><br><img src="https://habrastorage.org/webt/o0/5x/80/o05x80jeypiwcogusca_zgsnaju.png"><br><br>  Le statut 200 signifie que les demandes sont envoy√©es et re√ßues par le serveur avec succ√®s. <br><br>  Toujours dans la fen√™tre Aper√ßu GTM, nous voyons que notre balise cr√©√©e a fonctionn√© correctement pour l'√©v√©nement Vue de page. <br><br>  Pour v√©rifier l'√©v√©nement Ajouter au panier, ajoutez le produit au panier et, dans la console, nous avons deux autres demandes: <br><br><img src="https://habrastorage.org/webt/wt/jm/-k/wtjm-k50mmapqa1xtyva_yd3wcc.png"><br><br>  Dans la fen√™tre Aper√ßu GTM, nous voyons que la deuxi√®me balise a fonctionn√© avec succ√®s.  Les donn√©es de produit de dataLayer sont remont√©es et trait√©es correctement, la liste de prix correcte a √©galement √©t√© remplac√©e. <br><br>  Pour le deuxi√®me h√¥te, la liste de prix est √©galement remplac√©e correctement: <br><br><img src="https://habrastorage.org/webt/n3/de/h3/n3deh30jep61h2kv9zefwruu8cy.png"><br><br>  Les balises des autres √©v√©nements sont configur√©es et v√©rifi√©es de la m√™me mani√®re. <br><br><a name="11"></a><h2>  Conclusion </h2><br>  Les mod√®les personnalis√©s changent le paradigme familier de l'utilisation de GTM.  Tout le monde est habitu√© aux balises HTML et aux variables JS, mais il existe maintenant une excellente alternative. <br><br>  Il suffit de cr√©er un mod√®le personnalis√© de haute qualit√© une fois, puis toute personne familiaris√©e avec GTM peut l'utiliser. <br><br>  √âtant donn√© la possibilit√© de partager les mod√®les cr√©√©s, je pense qu'ils devraient gagner en popularit√© aupr√®s des utilisateurs. <br><br>  Vous pouvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√©l√©charger le mod√®le de</a> pixel de reciblage dynamique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">personnalis√©</a> VKontakte, que nous avons examin√© dans cet article. <br><br>  Pour importer un mod√®le, vous devez cr√©er un nouveau mod√®le personnalis√© et s√©lectionner Importer dans le menu: <br><br><img src="https://habrastorage.org/webt/mx/nn/jc/mxnnjc0419poxmshokabjcgeoye.png"><br><br>  <i>Mat√©riel pr√©par√© par moi pour ppc.world</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458788/">https://habr.com/ru/post/fr458788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458774/index.html">SGBD fonctionnel</a></li>
<li><a href="../fr458778/index.html">Satellite 6.5 Reporting Engine: quoi et pourquoi</a></li>
<li><a href="../fr458782/index.html">Adaptation de programmes pour ZX Spectrum √† TR-DOS par des moyens modernes. 3e partie</a></li>
<li><a href="../fr458784/index.html">Diffuser des projets et des biblioth√®ques d'Altium Designer vers PADS Professional</a></li>
<li><a href="../fr458786/index.html">Les gardiens de jeux vid√©o gardent la culture du jeu √©tape par √©tape</a></li>
<li><a href="../fr458790/index.html">Introduction √† CatBoost. Rapport Yandex</a></li>
<li><a href="../fr458792/index.html">Employ√©s ¬´br√ªl√©s¬ª: y a-t-il une issue?</a></li>
<li><a href="../fr458794/index.html">R√©union des analystes d'affaires √† Redmadrobot le 18 juillet</a></li>
<li><a href="../fr458796/index.html">Comment pr√©parer votre site √† de lourdes charges de travail: 5 conseils pratiques et outils utiles</a></li>
<li><a href="../fr458798/index.html">Nutrient Bot ou comment je veux prendre du pain avec des entra√Æneurs de fitness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>