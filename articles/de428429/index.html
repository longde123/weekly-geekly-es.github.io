<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôäÔ∏è üëç üôÜüèº GOST R 34.10 elektronische Signatur von PDF-Dokumenten in der Office-Suite LibreOffice üë®‚Äçüé® üë®üèª‚Äçüíª üì©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Trotz aller Br√§nde ist es an der Zeit, unsere B√ºrgerpflicht zu erf√ºllen - Steuern zu zahlen. Wir zahlen Steuern √ºber das State Services- Portal. Wir w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GOST R 34.10 elektronische Signatur von PDF-Dokumenten in der Office-Suite LibreOffice</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428429/"><img src="https://habrastorage.org/webt/ds/ly/0g/dsly0gpk3xho5hfte1ksa3pmprg.png" align="left">  Trotz aller <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Br√§nde</a> ist es an der Zeit, unsere B√ºrgerpflicht zu erf√ºllen - Steuern zu zahlen.  Wir zahlen Steuern √ºber das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">State Services-</a> Portal.  Wir werden das pers√∂nliche Konto des State Services-Portals <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mit einer</a> elektronischen Signatur ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Terminologie</a> des State Services-Portals) eingeben, d. H.  mit einem Zertifikat, das bei einem akkreditierten Zertifizierungszentrum (CA) erworben wurde, und einem privaten Schl√ºssel.  Beide speichere ich auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PKCS # 11-Token</a> mit Unterst√ºtzung f√ºr die russische Kryptographie: <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/kb/hc/so/kbhcsojl7sh1w4rnu9au8johwje.png"><br><br>  Nachdem ich meine B√ºrgerpflicht erf√ºllt hatte, beschloss ich, die Funktion der elektronischen Signatur in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.google.ru/url%3Fsa%3Dt%26rct%3Dj%26q%3D%26esrc%3Ds%26source%3Dweb%26cd%3D1%26cad%3Drja%26uact%3D8%26ved%3D2ahUKEwj4kPyNm7HeAhUE_SoKHU-iA7AQFjAAegQIAxAC%26url%3D">libreoffice-</a> B√ºrosuite erneut zu √ºberpr√ºfen. <br><br>  Warum habe ich mich dazu entschieden?  F√ºr den Zugriff auf das Gosuslug-Portal verwende ich das Linux-Betriebssystem und den Redfox-Browser, einen Mozilla Firefox-Browser, der mit Unterst√ºtzung der russischen Kryptografie modifiziert wurde.  Wie Sie wissen, verwendet die libreoffice Office Suite den NSS-Speicher auch als Zertifikatspeicher. <br><br>  Der Redfox-52-Browser wurde im Ordner / usr / local / lib64 / Firefox-52 installiert. <br><br>  Legen Sie den Wert der Variablen LD_LIBRARY_PATH wie folgt fest, um die Bibliotheken des NSS-Pakets (Network Security Services) mit Unterst√ºtzung f√ºr GOST-Algorithmen zu verbinden: <br><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$export</span></span> LD_LIBRARY_PATH=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib64/firefox-52:<span class="hljs-variable"><span class="hljs-variable">$LD_LIBRARY_PATH</span></span> $</code> </pre> <br>  Als Zertifikatspeicher verwendet libreoffice normalerweise einen Zertifikatspeicher von Firefox, dem Thunderbird-E-Mail-Client oder dem integrierten Seamonkey-Paket.  Nichts hindert Sie daran, den Zertifikatspeicher des GoogleChrome / Cromium-Browsers zu verwenden oder einen eigenen unabh√§ngigen Speicher zu erstellen (Extras-&gt; Optionen-&gt; Sicherheit-&gt; Zertifikat): <br><br><img src="https://habrastorage.org/webt/fu/we/8r/fuwe8rrzfjin4gzvntoag8itdfc.png"><br><br>  Nachdem der Speicher ausgew√§hlt wurde, werden die Bibliotheken verbunden, f√ºhren libreoffice aus, erstellen eine Odt-Datei und versuchen, sie zu signieren (Datei-&gt; Digitale Signaturen-&gt; Digitale Signaturen). <br><br>  Zertifikate im Firefox / NSS-Repository werden erfolgreich angezeigt und √ºberpr√ºft: <br><br><img src="https://habrastorage.org/webt/se/ic/bn/seicbnhqivgte6wakn7kym63lck.png"><br><br>  Die Signatur nach Auswahl des Zertifikats und Dr√ºcken der OK-Taste wird jedoch nicht gebildet: <br><br><img src="https://habrastorage.org/webt/di/l0/id/dil0idhl4l_x4zetlzrdiguxkr8.png"><br><br>  Es scheint, dass libreoffice russische kryptografische Algorithmen nicht verstehen m√∂chte, obwohl NSS vom Redfox-Browser verwendet wird, der GOST-Algorithmen versteht, was durch eine erfolgreiche Zertifikats√ºberpr√ºfung best√§tigt wird. <br><br>  Wir machen den zweiten Versuch: Dieses Mal werden wir versuchen, die PDF-Datei zu signieren.  Exportieren Sie dazu das vorbereitete Dokument im PDF-Format.  Um eine PDF-Datei zu signieren, m√ºssen Sie sie nat√ºrlich herunterladen (Datei-&gt; Digitale Signaturen-&gt; PDF signieren).  Nach dem Herunterladen versuchen wir, es zu signieren (Datei-&gt; Digitale Signaturen-&gt; Digitale Signaturen) (siehe oben, w√§hlen Sie das Zertifikat aus und geben Sie beispielsweise den Zweck der Signatur des Dokuments an): <br><br><img src="https://habrastorage.org/webt/s1/eg/wz/s1egwzum3-s8q8krjgljjl8xjo4.png"><br><br>  Und die Unterschrift wird gebildet !!!  Wir sehen, dass die Signatur auf Basis des Zertifikats "Test 12 512" mit dem Schl√ºssel GOST R 34.10-2012 512 Bit bildet.  Die Unterschrift ist korrekt. <br><br>  Libreoffice verlassen.  F√ºhren Sie libreoffice erneut aus, laden Sie die signierte PDF-Datei und √ºberpr√ºfen Sie die Signaturen.  Alles ok.  Zertifikate von Unterzeichnern anzeigen.  Alles ok.  Wunder!  Das Signieren von PDFs funktioniert.  Wir setzen die zweite, dritte Unterschrift ... Alles funktioniert.  Aber etwas verfolgt.  Wir machen eine zus√§tzliche Pr√ºfung. <br><br>  √ñffnen Sie die signierte PDF-Datei (ich habe den integrierten Editor von mc - Midnight Commander - Konsolendateimanager f√ºr Linux verwendet).  Finden Sie die elektronische Signatur (/ Type / Sig /): <br><br><img src="https://habrastorage.org/webt/q3/kh/ja/q3khjadn38etedwmwo7jdmiyrhk.png"><br><br>  Wie Sie sehen k√∂nnen, wird die Signatur in symbolischer hexadezimaler Form gespeichert.  Wir kopieren es und speichern es in einer Datei.  Um die Datei in eine Bin√§rdatei (DER-Codierung) zu konvertieren, verwenden wir das Dienstprogramm xxd: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$xxd</span></span> ‚Äìp ‚Äìr &lt;    PDF&gt; &gt; &lt;&gt;.der $</code> </pre> <br>  Die resultierende Datei enth√§lt eine nicht verbundene DER-codierte Signatur im PKCS # 7-Format.  Jetzt kann diese Signatur mit jeder asn1-Prase angezeigt werden, beispielsweise mit dem Dienstprogramm openssl.  Da es sich jedoch um das NSS-Paket handelt, verwenden wir das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dienstprogramm</a> derdump oder das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dienstprogramm pp</a> : <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$pp</span></span> ‚Äìt p7 ‚Äìu ‚Äìi pkcs7_detach.p7 PKCS <span class="hljs-comment"><span class="hljs-comment">#7 Content Info: PKCS #7 Signed Data: Version: 1 (0x1) Digest Algorithm List: Digest Algorithm (1): SHA-256 Content Information: PKCS #7 Data: &lt;no content&gt; Certificate List: Certificate (1): Data: Version: 3 (0x2) Serial Number: 4107 (0x100b) Signature Algorithm: GOST R 34.10-2012 signature with GOST R 34.11-2012-512 Issuer: "E=ca_12_512@lissi.ru,OGRN=1234567890123,INN=1234 56789012,CN= 12_512,O= 12_512,L=GnuPG  -2012-512,ST= ,C=RU" Validity: Not Before: Sat Sep 08 07:17:56 2018 Not After : Tue Sep 12 07:17:56 2023 Subject: "C=RU,ST= ,CN=  ,SN=,givenName= ,E=xx@xx.ru,L= ,STREET=,INN=123456789012,SNILS=12345678901" Subject Public Key Info: Public Key Algorithm: GOST R 34.10-2012 512 Public Key: . . . Digest Encryption Algorithm: GOST R 34.10-2012 Key 512 Encrypted Digest: 34:9d:6f:37:e6:60:00:ed:fe:ef:f7:96:db:52:66:e1: 47:4c:5d:da:7f:9f:f3:20:50:ac:73:6c:97:db:f9:8d: 43:9b:8f:40:61:99:d3:4b:17:08:b8:34:e3:1e:92:76: b1:0c:dd:37:01:1e:2a:30:45:68:06:af:3d:33:5e:2f: 71:c8:17:b3:a9:8a:6b:2f:78:9e:e4:b2:00:59:6f:5a: a0:c5:9e:be:1e:4b:ca:d5:64:25:50:1a:6f:f9:55:b8: 3a:cf:37:a0:04:eb:89:b4:6c:39:77:27:92:de:61:c7: b1:d3:a5:2f:ef:66:9b:f5:71:42:77:0a:d2:10:7f:50 $</span></span></code> </pre> <br>  Und dann wurde klar, dass nicht alles so gut ist.  Ja, der Digest-Verschl√ºsselungsalgorithmus: GOST R 34.10-2012 Schl√ºssel 512-Signaturalgorithmus gem√§√ü dem zum Signieren ausgew√§hlten Zertifikat, aber die Signatur wird aus einem Hash generiert, der mit dem SHA-256-Algorithmus berechnet wurde (Digest-Algorithmus (1): SHA-256).  Und das ist von dem Punkt aus falsch: Der Hash f√ºr GOST R 34.10-2012 Schl√ºssel 512 sollte gem√§√ü dem GOST R 34.11-2012-512-Algorithmus ber√ºcksichtigt werden. <br><br>  Kommen wir zur Analyse des libreoffice-Quellcodes: Der Teufel ist nicht so schrecklich, wie er gemalt ist.  In diesem Artikel betrachten wir die Verwendung des NSS-Pakets zum Generieren einer elektronischen Signatur.  Wenn jemand die MS Windows-Plattform bevorzugt, verwenden Sie CryptoAPI (und dementsprechend GOST-CSP) und kann in Analogie zu diesem Material die entsprechende √úberarbeitung vornehmen. <br><br>  Die Analyse ergab, dass die √Ñnderungen nur in zwei Dateien vorgenommen werden m√ºssen: <br>  - <i>~ / libreoffice-5.3.7.2 / vcl / source / gdi / pdfwriter_impl.cxx</i> <br>  - <i>~ / libreoffice-5.3.7.2 / xmlsecurity / source / pdfio / pdfdocument.cxx</i> <br><br>  Diese √Ñnderungen h√§ngen mit der korrekten Auswahl der Hash-Funktion f√ºr GOST-Zertifikate zusammen.  Die Auswahl einer Hash-Funktion h√§ngt vom Typ des Zertifikatschl√ºssels ab.  Die Auswahl eines Hash-Algorithmus, beispielsweise in PDFWriter :: Sign (Datei pdfwriter_impl.cxx), sieht folgenderma√üen aus: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> PDFWriter::Sign(PDFSignContext&amp; rContext) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _WIN32 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* */</span></span></span><span class="hljs-meta"> SECKEYPublicKey *pubk = NULL; SECOidTag hashAlgTag; HASH_HashType hashType; int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); if (!cert) { SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } /*    */ pubk = CERT_ExtractPublicKey(cert); if (pubk == NULL) return NULL; /*   */ switch(pubk-&gt;keyType){ case gost3410Key: hashAlgTag = SEC_OID_GOSTHASH; hashType = HASH_AlgGOSTHASH; hashLen = SHA256_LENGTH; break; case gost3410Key_256: hashAlgTag = SEC_OID_GOST3411_2012_256; hashType = HASH_AlgGOSTHASH_12_256; hashLen = SHA256_LENGTH; break; case gost3410Key_512: hashAlgTag = SEC_OID_GOST3411_2012_512; hashLen = SHA256_LENGTH * 2; hashType = HASH_AlgGOSTHASH_12_512; break; default: hashAlgTag = SEC_OID_SHA256; hashType = HASH_AlgSHA256; hashLen = SHA256_LENGTH; break; } /* */ HashContextScope hc(HASH_Create(hashType)); . . . }</span></span></span></span></code> </pre> <br>  Andere √Ñnderungen in der Logik sind diesen √§hnlich.  Der Patch f√ºr die Datei ~ / libreoffice-5.3.7.2 / vcl / source / gdi / pdfwriter_impl.cxx befindet sich <br><br><div class="spoiler">  <b class="spoiler_title">hier:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfwriter_impl_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfwriter_impl.cxx 2018-10-31 19:48:32.078482227 +0300 @@ -6698,6 +6698,9 @@ CERTCertificate *cert, SECItem *digest) { + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + NSSCMSMessage *result = NSS_CMSMessage_Create(nullptr); if (!result) { @@ -6732,8 +6735,31 @@ NSS_CMSMessage_Destroy(result); return nullptr; } - + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; +fprintf(stderr, "CreateCMSMessage: gost3410Key Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; +fprintf(stderr, "CreateCMSMessage: gost3410Key_256 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; +fprintf(stderr, "CreateCMSMessage: gost3410Key_512 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + default: + hashAlgTag = SEC_OID_SHA256; + break; + } +/* *cms_signer = NSS_CMSSignerInfo_Create(result, cert, SEC_OID_SHA256); +*/ + *cms_signer = NSS_CMSSignerInfo_Create(result, cert, hashAlgTag); + if (!*cms_signer) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignerInfo_Create failed"); @@ -6773,8 +6799,8 @@ NSS_CMSMessage_Destroy(result); return nullptr; } + if (NSS_CMSSignedData_SetDigestValue(*cms_sd, hashAlgTag, digest) != SECSuccess) - if (NSS_CMSSignedData_SetDigestValue(*cms_sd, SEC_OID_SHA256, digest) != SECSuccess) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignedData_SetDigestValue failed"); NSS_CMSSignedData_Destroy(*cms_sd); @@ -6982,6 +7008,10 @@ bool PDFWriter::Sign(PDFSignContext&amp; rContext) { #ifndef _WIN32 + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + HASH_HashType hashType; + int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); @@ -6990,8 +7020,33 @@ SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; + hashType = HASH_AlgGOSTHASH; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; + hashType = HASH_AlgGOSTHASH_12_256; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; + hashLen = SHA256_LENGTH * 2; + hashType = HASH_AlgGOSTHASH_12_512; + break; + default: + hashAlgTag = SEC_OID_SHA256; + hashType = HASH_AlgSHA256; + hashLen = SHA256_LENGTH; + break; + } + HashContextScope hc(HASH_Create(hashType)); - HashContextScope hc(HASH_Create(HASH_AlgSHA256)); if (!hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7005,15 +7060,18 @@ HASH_Update(hc.get(), static_cast&lt;const unsigned char*&gt;(rContext.m_pByteRange2), rContext.m_nByteRange2); SECItem digest; - unsigned char hash[SHA256_LENGTH]; + unsigned char hash[SHA256_LENGTH * 2]; + digest.data = hash; - HASH_End(hc.get(), digest.data, &amp;digest.len, SHA256_LENGTH); + HASH_End(hc.get(), digest.data, &amp;digest.len, hashLen); + hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.hash.data", "wb"); - fwrite(hash, SHA256_LENGTH, 1, out); + fwrite(hash, hashLen, 1, out); + fclose(out); } #endif @@ -7078,8 +7136,8 @@ fclose(out); } #endif + HashContextScope ts_hc(HASH_Create(hashType)); - HashContextScope ts_hc(HASH_Create(HASH_AlgSHA256)); if (!ts_hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7090,16 +7148,19 @@ HASH_Begin(ts_hc.get()); HASH_Update(ts_hc.get(), ts_cms_signer-&gt;encDigest.data, ts_cms_signer-&gt;encDigest.len); SECItem ts_digest; - unsigned char ts_hash[SHA256_LENGTH]; + unsigned char ts_hash[SHA256_LENGTH * 2]; + ts_digest.type = siBuffer; ts_digest.data = ts_hash; - HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, SHA256_LENGTH); + HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, hashLen); + ts_hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.ts_hash.data", "wb"); - fwrite(ts_hash, SHA256_LENGTH, 1, out); + fwrite(ts_hash, hashLen, 1, out); + fclose(out); } #endif @@ -7111,7 +7172,8 @@ src.messageImprint.hashAlgorithm.algorithm.data = nullptr; src.messageImprint.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, hashAlgTag, nullptr); + src.messageImprint.hashedMessage = ts_digest; src.reqPolicy.type = siBuffer; @@ -7340,11 +7402,13 @@ // Write ESSCertIDv2.hashAlgorithm. aCertID.hashAlgorithm.algorithm.data = nullptr; aCertID.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, hashAlgTag, nullptr); + // Write ESSCertIDv2.certHash. SECItem aCertHashItem; - unsigned char aCertHash[SHA256_LENGTH]; - HashContextScope aCertHashContext(HASH_Create(HASH_AlgSHA256)); + unsigned char aCertHash[SHA256_LENGTH*2]; + HashContextScope aCertHashContext(HASH_Create(hashType)); + if (!aCertHashContext.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create() failed"); @@ -7354,7 +7418,8 @@ HASH_Update(aCertHashContext.get(), reinterpret_cast&lt;const unsigned char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); aCertHashItem.type = siBuffer; aCertHashItem.data = aCertHash; - HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, SHA256_LENGTH); + HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, hashLen); + aCertID.certHash = aCertHashItem; // Write ESSCertIDv2.issuerSerial. IssuerSerial aSerial;</span></span></code> </pre> <br></div></div><br>  Der Patch f√ºr die Datei ~ / libreoffice-5.3.7.2 / xmlsecurity / source / pdfio / pdfdocument.cxx befindet sich <br><br><div class="spoiler">  <b class="spoiler_title">hier:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfdocument_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfdocument.cxx 2018-10-31 19:49:34.174485641 +0300 @@ -2400,6 +2400,19 @@ case SEC_OID_PKCS1_SHA512_WITH_RSA_ENCRYPTION: eOidTag = SEC_OID_SHA512; break; + case SEC_OID_GOST3410_SIGN_256: + case SEC_OID_GOST3411_2012_256: + eOidTag = SEC_OID_GOST3411_2012_256; + break; + case SEC_OID_GOST3410_SIGN_512: + case SEC_OID_GOST3411_2012_512: + eOidTag = SEC_OID_GOST3411_2012_512; + break; + case SEC_OID_GOST3410_SIGNATURE: + case SEC_OID_GOSTHASH: + eOidTag = SEC_OID_GOSTHASH; + break; + default: break; } @@ -2453,6 +2466,16 @@ case SEC_OID_SHA512: nMaxResultLen = msfilter::SHA512_HASH_LENGTH; break; + case SEC_OID_GOST3411_2012_256: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + case SEC_OID_GOST3411_2012_512: + nMaxResultLen = msfilter::SHA512_HASH_LENGTH; + break; + case SEC_OID_GOSTHASH: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + default: SAL_WARN("xmlsecurity.pdfio", "PDFDocument::ValidateSignature: unrecognized algorithm"); return false;</span></span></code> </pre> <br></div></div><br>  Nachdem wir die √Ñnderungen vorgenommen haben, erstellen wir das libreoffice-Paket.  Die vorgenommenen √Ñnderungen betrafen drei Bibliotheken (/ usr / lib64 / libreoffice / program): <br><br><ul><li>  <i>libvcllo.so</i> ; </li><li>  <i>libxmlsecurity.so</i> ; </li><li>  <i>libxsec-xmlsec.so</i> </li></ul><br>  Diese drei Bibliotheken wurden in der installierten libreoffice-Distribution (/ usr / lib64 / libreoffice / program) ersetzt. <br><br>  Danach verlief das Signieren und √úberpr√ºfen der GOST-Signatur in den PDF-Dateien reibungslos.  Und hier an einer der Stellen f√§llt ein solcher Auszug auf: <br><blockquote>  Der Federal Tax Service bietet einen hervorragenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Service</a> f√ºr die Erlangung eines Auszugs aus dem Unified State Register of Legal Entities f√ºr jede juristische Person und ist absolut kostenlos.  Ein Auszug kann in Form eines PDF-Dokuments erhalten werden, das mit einer qualifizierten elektronischen Signatur signiert ist.  Ein solcher Auszug kann an eine Gesch√§ftsbank oder eine Regierungsbeh√∂rde gesendet werden, und Sie werden nicht in Papierform danach gefragt.  Alles in allem sehr bequem. </blockquote>  Wir bestellen, erhalten und verifizieren: <br><br><img src="https://habrastorage.org/webt/ye/rt/ul/yertuldamhhmiwc6wmveofj1a60.png"><br><br>  Es sei daran erinnert, dass Sie nicht vergessen sollten, eine Kette vertrauensw√ºrdiger Zertifikate f√ºr das Unterzeichnerzertifikat im Repository zu installieren.  Das ist aber nat√ºrlich. <br><br>  Das ist alles, jetzt besteht die M√∂glichkeit, eine elektronische Signatur (eine oder mehrere) in PDF-Dateien zu verwenden.  Dies ist sowohl beim Koordinieren von Dokumenten als auch beim Speichern von Dokumenten sehr praktisch. <br><br>  Und wenn jemand daran gew√∂hnt ist, mit der klassischen elektronischen Signatur im PKCS # 7-Format sowohl verbunden als auch getrennt zu arbeiten, wurde eine aktualisierte Version (f√ºr die Linux- und Windows-Plattformen) des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GUINSSPY</a> -Grafikpakets <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erstellt</a> : <br><br><img src="https://habrastorage.org/webt/qw/rz/h_/qwrzh_squqc7zzcd0qibmoakuyi.png"><br><br>  Die Entwicklung wurde in Python3 durchgef√ºhrt und wenn es auf der Linux-Plattform keine Probleme gab, musste ich unter MS Windows mit Codierungen schwitzen.  In der Tat war es eine separate Entwicklung und dies erfordert einen separaten Artikel.  All diese Nuancen sind im Quellcode zu sehen. <br><br>  Mit diesem Dienstprogramm k√∂nnen Sie einen Zertifikatspeicher f√ºr libreoffice erstellen, Zertifikate verwalten, Dateien signieren usw.: <br><br><img src="https://habrastorage.org/webt/3g/ge/zc/3ggezcie8_pq5mbnpnd_jtz9z14.png"><br><br>  Mit dem Dienstprogramm k√∂nnen Sie auch eine Zertifikatanforderung mit der Generierung eines Schl√ºsselpaars erstellen, das dann an das Zertifizierungscenter √ºbertragen werden kann, und das empfangene Zertifikat im Repository installieren: <br><br><img src="https://habrastorage.org/webt/xh/st/fx/xhstfxznuqdaoqk_rhl2llwthdk.png"><br><br>  Und wenn Hersteller von inl√§ndischen Linux-Gabeln verschiedene Pakete (NSS, Firefox, Thunderbiird, GnuPG / SMIME, SSH, KMail, Kleopatra, LibreOffice, OpenSSL usw. usw.) f√ºr die Arbeit mit russischer Kryptographie modifiziert haben, k√∂nnen Sie dies Es w√ºrde um Importsubstitution im Bereich der Kryptographie gehen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428429/">https://habr.com/ru/post/de428429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428415/index.html">√úbersicht √ºber den Cloud-Controller TP-Link Omada OC200</a></li>
<li><a href="../de428417/index.html">Maschinelles Lernen in MatLab / Octave: Beispiele f√ºr Algorithmen, die von Formeln unterst√ºtzt werden</a></li>
<li><a href="../de428419/index.html">Ziehen und wischen Sie in RecyclerView. Teil 2: Drag & Drop-Controller, Raster und benutzerdefinierte Animationen</a></li>
<li><a href="../de428421/index.html">Flexibles System zum Testen und Sammeln von Programmmetriken am Beispiel der LLVM-Testsuite</a></li>
<li><a href="../de428423/index.html">Wie ein 34-Milliarden-Dollar-Deal zwischen IBM und Red Hat den IT-Markt ver√§ndern wird: Experten und Analysten</a></li>
<li><a href="../de428431/index.html">Mehr als konzentrische Schichten</a></li>
<li><a href="../de428433/index.html">Private Pr√ºfungsanw√§lte</a></li>
<li><a href="../de428435/index.html">Was in PHP auf Russisch zu lesen?</a></li>
<li><a href="../de428437/index.html">Apple Wallet Was ist das und wie integrieren Sie Ihre Karte darin?</a></li>
<li><a href="../de428439/index.html">Ohne Ensemble</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>