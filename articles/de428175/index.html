<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â›“ï¸ ğŸ‘ğŸ¼ ğŸ‘¨ğŸ¿â€ğŸ¤â€ğŸ‘¨ğŸ» Schlaue PrÃ¤fixbaum-C-Implementierung ğŸ‘¨ğŸ½â€ğŸ”¬ ğŸ¤³ğŸ¿ ğŸ¤°ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="EinfÃ¼hrung 
 Seit der VerÃ¶ffentlichung des Artikels Ã¼ber meinen Versuch, den PrÃ¤fixbaum auf niedriger Ebene zu implementieren, sind vier Monate vergan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Schlaue PrÃ¤fixbaum-C-Implementierung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428175/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2cf/e02/c47/2cfe02c47506426be25fb36004a78b1d.jpg" alt="Bild"></div><br><h2>  EinfÃ¼hrung </h2><br>  Seit der VerÃ¶ffentlichung des Artikels Ã¼ber meinen Versuch, den PrÃ¤fixbaum auf niedriger Ebene zu implementieren, sind vier Monate vergangen.  Trotz aller BemÃ¼hungen betrug die Obergrenze, zu der sich meine vorherige Implementierung des PrÃ¤fixbaums als fÃ¤hig herausstellte, ~ 80.000 WÃ¶rter pro Sekunde.  Ich habe dann viel Zeit und Energie aufgewendet, aber das Ergebnis wÃ¤re nur als Laborarbeit in der Informatik geeignet. <br><br>  Viele sagten mir dann: â€Erfinde kein Fahrrad, das wir bereits erfunden haben!  Verwenden Sie die schlÃ¼sselfertige LÃ¶sung. â€œ  Die Schwierigkeit ist, dass ich etwas nicht verwenden konnte, was ich zumindest allgemein nicht verstehe. <br><br>  Ich glaube, ich habe den PrÃ¤fixbaum verstanden, und das habe ich erreicht. <br><a name="habracut"></a><br><h2>  Arbeitsprinzip </h2><br>  Ich kann nicht sehr gut Englisch. Von den vielen Artikeln, die ich zum Thema PrÃ¤fixbÃ¤ume gelesen habe, haben mich einige Informationen wahrscheinlich nicht erreicht.  Deshalb habe ich mir Ã¼berlegt, wie man alles anordnet und nur das Grundprinzip des PrÃ¤fixbaums versteht.  FÃ¼r diejenigen, die es nicht wissen, werde ich versuchen, es klarer zu beschreiben, als es auf Wikipedia geschrieben ist.  Also erklÃ¤rte ich meiner Frau, was ich tat. <br><br>  Der PrÃ¤fixbaum ist eine logische Struktur zum Speichern von Daten, die als Kartenverzeichnis von BÃ¼chern in einer Bibliothek dargestellt werden kÃ¶nnen.  Jede Box hat eine Nummer.  Jedes Feld entspricht einem bestimmten Buchstaben des Alphabets.  Im Inneren befinden sich die Nummern der folgenden Schubladen, deren Ã–ffnung Sie wie folgt herausfinden kÃ¶nnen und so weiter.  Wenn sich nichts in der Box befindet, bedeutet dies, dass der Buchstabe dieser Box der letzte im Wort ist.  Das Problem ist, dass einige Felder fast leer bleiben, da sie 1 oder 2 Zahlen enthalten und der verbleibende Platz leer ist. <br><br>  Um dieses Problem zu lÃ¶sen, sind viele Arten von PrÃ¤fixbÃ¤umen erschienen, einschlieÃŸlich: HAT-Trie, Double-Array-Trie, Tripple-Array-Trie.  Es war genau die Tatsache, dass ich das Prinzip ihrer Arbeit nicht grÃ¼ndlich verstehen konnte, die mich zu einem Baum drÃ¤ngte, der so einfach war wie eine Bibliotheksausweisdatei. <br><br>  Das letzte Mal gelang es mir, eine recht sparsame Implementierung eines einfachen PrÃ¤fixbaums fÃ¼r den Speicherverbrauch zu implementieren.  Ich setzte diese Metapher mit einem Bibliotheksausweis fort und fertigte Schubladen in meinem Aktenschrank in verschiedenen GrÃ¶ÃŸen an. FÃ¼r das vollstÃ¤ndige Alphabet ist die Box die grÃ¶ÃŸte, fÃ¼r 1 Buchstaben die kleinste. <br><br>  Ich habe es geschafft, genau das gleiche PHP-Schema in C zu implementieren. <br><br>  <b>1.</b> Jeder Buchstabe des Wortes gemÃ¤ÃŸ der festgelegten Tabelle wird mit einer Zahl von 2 bis 95 codiert. Beispielsweise wird das Wort "abv" mit drei Zahlen codiert: 11, 12, 13. FÃ¼r maximale Leistung wird ein zweidimensionales Array von Zahlen mit einer <code>uint8_t abc[256][256] = {};</code> von 1 Byte <code>uint8_t abc[256][256] = {};</code>  Um ein Programm zu konvertieren, liest es eine Zeile mal 1 Byte und versucht, den Wert jedes Bytes in unserem Array zu Ã¼bernehmen.  Zum Beispiel ist der Zifferncode 1 = 49, also schauen wir <code>abc[49][0];</code>  .  Wenn es einen anderen Wert als '\ 0' gibt, ist dies der Code unseres Buchstabens. Denken Sie daran und fahren Sie mit dem nÃ¤chsten Byte fort.  In unserem Fall besteht das Wort "abv" aus einer Folge von 6 Bytes, zwei Bytes pro Buchstabe: 208, 176, 208, 177, 208, 178. Da die utf-8-Codierung so ausgelegt ist, dass die ersten Bytes von Einzelbytezeichen niemals mit den ersten Bytes von Mehrbyte Ã¼bereinstimmen in unserem Array <code>abc[208][0] = 0;</code>  . <br><br>  FÃ¼r Bytepaare gibt es jedoch einige Ãœbereinstimmungen: <br><br><pre> <code class="hljs markdown">/<span class="hljs-bullet"><span class="hljs-bullet">*  [11] *</span></span>/ abc[<span class="hljs-string"><span class="hljs-string">208</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">176</span></span>] = 11; /<span class="hljs-bullet"><span class="hljs-bullet">*  [12] *</span></span>/ abc[<span class="hljs-string"><span class="hljs-string">208</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">177</span></span>] = 12; /<span class="hljs-bullet"><span class="hljs-bullet">*  [13] *</span></span>/ abc[<span class="hljs-string"><span class="hljs-string">208</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">178</span></span>] = 13;</code> </pre><br>  <b>2.</b> Jetzt mÃ¼ssen wir die Zahlen 11, 12 und 13 in die KÃ¤stchen unseres Baumes schreiben.  Der Baum besteht aus 2 separaten nicht explosiven SpeicherblÃ¶cken, der erste ist ein Knotenblock, der zweite ist ein Block von Links sowie zwei ZÃ¤hler von besetzten Knoten und besetzten Zellen eines Blockes von Links.  Jeder Baumknoten besteht aus 16 Bytes, 12 Bytes einer Bitmaske und 4 Bytes zum Speichern der ID des Verbindungsblocks.  Mit der Maske kÃ¶nnen Sie Zahlen von 2 bis 96 Bit speichern.  Das erste Bit der Maske wird verwendet, um das Ende des Wortes auf diesem Knoten zu kennzeichnen.  Jeder Knoten kann der ID aus dem Verbindungsblock entsprechen, wenn mindestens 1 Buchstabe in diesen Knoten geschrieben ist, oder nicht, wenn der Knoten ein "Blatt" in Bezug auf BÃ¤ume ist, dh ein Wort endet einfach darauf.  AusgedrÃ¼ckt in einer Bibliothek, einer leeren Schublade. <br><br>  <b>3.</b> Nehmen Sie die Maske des ersten (Wurzel-) Knotens.  trie-&gt; node [0] .mask;  Wir zÃ¤hlen die Bits, die in dieser Maske ausgelÃ¶st werden, beginnend mit der zweiten (die erste fÃ¼r das Wort-End-Flag).  Wenn keine Bits in der Maske angehoben werden, d.h.  Da der Knoten leer ist, benÃ¶tigen wir einen Verbindungsblock der GrÃ¶ÃŸe 1, um unsere Nummer 11 zu speichern, die Nummer vom VerbindungsreferenzzÃ¤hler des Blocks zu nehmen und den alten Wert um eins zu erhÃ¶hen (weil wir GrÃ¶ÃŸe 1 benÃ¶tigen).  Wir nehmen die Nummer vom KnotenzÃ¤hler und erhÃ¶hen auch den alten Wert um 1. Wir schreiben die Verbindungsblock-ID, die die vom VerbindungsblockzÃ¤hler erhaltene Nummer ist, in unseren Wurzelknoten.  Schreiben Sie in diese ID des Verbindungsblocks die ID des neuen Knotens, dh die vom KnotenzÃ¤hler erhaltene Nummer.  Jetzt haben wir zusÃ¤tzlich zum Wurzelknoten (ID 0) einen Knoten mit dem Buchstaben â€aâ€œ (ID 1).  Um die Zahl 12 zu schreiben, die dem Buchstaben "b" entspricht, machen wir dasselbe, jedoch mit dem Knoten des Buchstabens "a". <br><br>  <b>4.</b> Auf dem letzten Buchstaben "c" brauchen wir keinen Platz im Linkblock, da wir den letzten Knoten auf dem Zweig oder dem Knotenblatt haben.  Ein solcher Knoten hat nur 1 Bit in der angehobenen Maske. <br><br>  <b>5.</b> Der schwierigste Teil der Arbeit eines Baums tritt auf, wenn er auf einen Knoten geschrieben wird, in dem bereits einige Buchstaben geschrieben wurden.  In diesem Fall ist das Operationsschema wie folgt: <br><br>  Angenommen, wir mÃ¶chten unserem Baum das Wort â€bvgâ€œ (12, 13, 14) hinzufÃ¼gen, in dem das Wort â€abvâ€œ (11, 12, 13) bereits geschrieben ist.  Wir zÃ¤hlen die Bits in der Maske des Wurzelknotens bis zum Bit des fÃ¼r uns interessanten Buchstabens.  Wir haben den Buchstaben "b" mit Code 12, was bedeutet, dass das Bit dieses Buchstabens 12 ist, in der Maske von 1 bis 12 Bit wurde Bit 11 aus dem Buchstaben "a" bereits ausgelÃ¶st.  Wir haben also die aktuelle GrÃ¶ÃŸe des VerknÃ¼pfungsblocks fÃ¼r den Wurzelknoten 1. Wir schreiben den zweiten Buchstaben, also brauchen wir jetzt einen VerknÃ¼pfungsblock der GrÃ¶ÃŸe 2. Hier kommt die Registrierung der freigegebenen BlÃ¶cke ins Spiel, bei der die ID und GrÃ¶ÃŸe der Abschnitte im VerknÃ¼pfungsblock von den Knoten nicht mehr verwendet werden Baum.  Unsere alte ID des Linkblocks fÃ¼r den Stammknoten der GrÃ¶ÃŸe 1 wird nur in die Registrierung der freien Abschnitte der GrÃ¶ÃŸe 1 aufgenommen, da unser Stammknoten eine grÃ¶ÃŸere GrÃ¶ÃŸe benÃ¶tigt.  Unsere Registrierung hat keinen geeigneten Abschnitt der GrÃ¶ÃŸe 2 und wir nehmen wieder den Wert vom ZÃ¤hler des Verbindungsblocks als neue ID des Verbindungsblocks und erhÃ¶hen den ZÃ¤hler um 2. An der neuen Adresse des Verbindungsblocks in derselben Reihenfolge, in der sich die Bits in der Knotenmaske befinden, schreiben wir den ID-Wert Knoten aus dem alten Linkblock fÃ¼r den Buchstaben "a" des ersten Wortes und den Wert des gerade erstellten Knotens des Buchstabens "b" des zweiten Wortes. <br><img src="https://habrastorage.org/webt/nx/cr/md/nxcrmdtlm8gezn4zkxk2_5vni_m.png"><br><br><h2>  Arbeitsgeschwindigkeit </h2><br>  Der Drum Roll klingt ... Erinnerst du dich an das letzte Ergebnis?  UngefÃ¤hr 80.000 WÃ¶rter pro Sekunde.  Der Baum wurde aus dem WÃ¶rterbuch aller russischen WÃ¶rter OpenCorpora 3 039 982 WÃ¶rter erstellt.  Und hier ist, was jetzt passiert ist: <br><br><pre> <code class="hljs pgsql">yatrie creation <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">4.588216</span></span>s (<span class="hljs-number"><span class="hljs-number">666</span></span>k wps) yatrie <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> mln. rounds: <span class="hljs-number"><span class="hljs-number">0.565618</span></span>s (<span class="hljs-number"><span class="hljs-number">1.76</span></span>m wps)</code> </pre> <br>  <b>UPDATE 11/01/2018:</b> <br>  In Version 0.0.2 war es mÃ¶glich, die Geschwindigkeit um fast das Zweifache zu erhÃ¶hen, indem vollwertige Funktionen durch Makrofunktionen ersetzt und die Struktur der Knotenmaske in uint32_t mask [3] geÃ¤ndert wurden, zuvor war es uint8_t mask [12]. <br>  AuÃŸerdem wurden Makros LIKELY () UNLIKELY () hinzugefÃ¼gt, um die erwarteten Ergebnisse in diesen if () -BlÃ¶cken nach MÃ¶glichkeit vorherzusagen. <br>  <b>UPDATE 11/05/2018:</b> <br>  Ein bisschen mehr verdreht.  Ich habe es geschafft, dass es auch beim Kompilieren von -O3 und -Ofast einwandfrei funktioniert.  Die Suchgeschwindigkeit im Baum betrÃ¤gt ~ 0,2 Î¼s oder 0,2 c pro 1 Million Wiederholungen.  Anscheinend wurde diese Geschwindigkeit aufgrund des Ãœbergangs zu einem anderen Format der Maske erhalten.  FrÃ¼her gab es 12 Bytes mit 8 Bits und jetzt 3 int32 und eine sehr schnelle Funktion zum ZÃ¤hlen von Bits in int32. <br><br><h3>  Wie kompakt ist das? </h3><br>  Das angegebene OpenCorpora-WÃ¶rterbuch benÃ¶tigt ~ 84 MB, was nicht viel schlimmer ist als libdatrie, das ~ 80 MB ergibt. <br><br>  â†’ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Quellcode</a> <br><br>  Willkommen zurÃ¼ck! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428175/">https://habr.com/ru/post/de428175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428161/index.html">Reformen zur Subventionierung fossiler Brennstoffe, die durch harte Arbeit erreicht wurden, sind gefÃ¤hrdet</a></li>
<li><a href="../de428165/index.html">Linux-Kernel-Podcast mit Open Source Summit Europe 2018</a></li>
<li><a href="../de428167/index.html">Die erste Roboterfabrik in Russland und was hat die Wurst damit zu tun?</a></li>
<li><a href="../de428169/index.html">DJI kÃ¼ndigt Mavic 2 Enterprise an - ein leistungsstarkes Tool fÃ¼r Profis</a></li>
<li><a href="../de428173/index.html">Prettier, ESLint, Husky, Lint-Staged und EditorConfig: Tools zum Schreiben von aufgerÃ¤umtem Code</a></li>
<li><a href="../de428177/index.html">Was ist also falsch an der Arbeitssuche / den Arbeitnehmern in der IT?</a></li>
<li><a href="../de428179/index.html">Bei einer japanischen Auktion wurde ein Prototyp eines Wii-Controllers fÃ¼r den GameCube entwickelt</a></li>
<li><a href="../de428181/index.html">Moralische Maschine: gnadenlos oder bedeutungslos?</a></li>
<li><a href="../de428183/index.html">Implementierung des Levenberg-Marquardt-Algorithmus zur Optimierung neuronaler Netze auf TensorFlow</a></li>
<li><a href="../de428187/index.html">So schreiben Sie eine Erweiterung fÃ¼r die GNOME-Shell: Nicht stÃ¶ren</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>