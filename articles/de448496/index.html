<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>„ÄΩÔ∏è üåà ‚ò™Ô∏è .NET Core unter Linux, DevOps zu Pferd üë©üèæ‚Äçüåæ üè§ üèµÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir haben DevOps so gut wie m√∂glich entwickelt. Wir waren zu acht und Vasya war der coolste unter Windows. Pl√∂tzlich ging Vasya und ich hatte die Aufg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>.NET Core unter Linux, DevOps zu Pferd</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/448496/">  Wir haben DevOps so gut wie m√∂glich entwickelt.  Wir waren zu acht und Vasya war der coolste unter Windows.  Pl√∂tzlich ging Vasya und ich hatte die Aufgabe, ein neues Projekt herauszubringen, das die Windows-Entwicklung unterst√ºtzt.  Als ich den gesamten Stapel der Windows-Entwicklung auf den Tisch sch√ºttete, wurde mir klar, dass die Situation schmerzhaft ist ... <br><br>  So beginnt die Geschichte von <b>Alexander Sinchinov</b> bei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DevOpsConf</a> .  Als der f√ºhrende Windows-Spezialist das Unternehmen verlie√ü, fragte sich Alexander, was er jetzt tun sollte.  Wechseln Sie nat√ºrlich zu Linux!  Alexander wird am Beispiel eines abgeschlossenen Projekts f√ºr 100.000 Endbenutzer erl√§utern, wie er es geschafft hat, einen Pr√§zedenzfall zu schaffen und einen Teil der Windows-Entwicklung auf Linux zu √ºbertragen. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dcd/e76/321/dcde7632138481f5c01f851d9af8e2e2.png"><br><br>  Wie kann ein Projekt mit TFS, Puppet, Linux .NET Core einfach und m√ºhelos an RPM geliefert werden?  Wie kann die Versionierung der Projektdatenbank beibehalten werden, wenn die Entwicklung zuerst die W√∂rter Postgres und Flyway und die Frist √ºbermorgen h√∂rt?  Wie kann ich mich in Docker integrieren?  Wie kann man .NET-Entwickler motivieren, Windows und Smoothies zugunsten von Puppet und Linux aufzugeben?  Wie k√∂nnen ideologische Konflikte gel√∂st werden, wenn es keine Kr√§fte, keinen Wunsch und keine Ressourcen gibt, um Windows in der Produktion zu bedienen?  Dar√ºber sowie √ºber Web Deploy, Testing, CI, √ºber die Praktiken der Verwendung von TFS in bestehenden Projekten und nat√ºrlich √ºber kaputte Kr√ºcken und Arbeitsl√∂sungen bei der Entschl√ºsselung des Berichts von Alexander. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/tZH9Ro9j9KQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Also, Vasya ist gegangen, die Aufgabe ist f√ºr mich, die Entwickler freuen sich <s>mit einer Heugabel</s> .  Als ich endlich merkte, dass Vasya nicht zur√ºckgegeben werden konnte, machte ich mich an die Arbeit.  Zun√§chst sch√§tzte ich den Prozentsatz von Win VM in unserem Park.  Die Punktzahl war nicht zugunsten von Windows. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa7/3d8/061/fa73d80617e31117f8c2575cc747a17b.png"><br><br>  Da wir DevOps aktiv entwickeln, wurde mir klar, dass beim Ansatz, eine neue Anwendung herauszunehmen, etwas ge√§ndert werden muss.  Die L√∂sung war eine - wenn m√∂glich, √ºbertragen Sie alles auf Linux.  Google hat mir geholfen - zu dieser Zeit war .Net bereits auf Linux portiert, und mir wurde klar, dass diese L√∂sung! <br><br><h2>  Warum wird .NET Core mit Linux geb√ºndelt? </h2><br>  Daf√ºr gab es mehrere Gr√ºnde.  Zwischen "Geld bezahlen" und "Nicht bezahlen" w√§hlt die Mehrheit die zweite - wie ich.  Eine Lizenz f√ºr MSDB kostet ungef√§hr 1.000 US-Dollar, die Wartung einer virtuellen Windows-Maschinenflotte kostet Hunderte von US-Dollar.  F√ºr ein gro√ües Unternehmen ist dies ein gro√üer Aufwand.  Daher ist das <b>Speichern</b> der <b>erste Grund</b> .  Nicht das wichtigste, aber eines der wichtigsten. <br><br>  Virtuelle Windows-Maschinen beanspruchen mehr Ressourcen als ihre Linux-Br√ºder - <b>sie sind schwer</b> .  Angesichts der Gr√∂√üe eines gro√üen Unternehmens haben wir uns f√ºr Linux entschieden. <br><br>  <b>Das System wird einfach in das vorhandene CI integriert</b> .  Wir betrachten uns als progressive DevOps, wir verwenden Bamboo, Jenkins und GitLab CI, daher arbeiten wir haupts√§chlich unter Linux. <br><br>  Der letzte Grund ist <b>bequeme Begleitung.</b>  Wir mussten die Eintrittsschwelle f√ºr ‚ÄûEscorts‚Äú senken - Leute, die den technischen Teil verstehen, sorgen f√ºr einen unterbrechungsfreien Betrieb und Serviceleistungen ab der zweiten Linie.  Sie waren bereits mit dem Linux-Stack vertraut, sodass es f√ºr sie viel einfacher ist, das neue Produkt zu verstehen, zu warten und zu warten, als zus√§tzliche Ressourcen aufzuwenden, um die √§hnliche Funktionalit√§t der Software f√ºr die Windows-Plattform zu bew√§ltigen. <br><br><h2>  Anforderungen </h2><br>  In erster Linie die <b>Bequemlichkeit einer neuen L√∂sung f√ºr Entwickler</b> .  Nicht alle von ihnen waren bereit f√ºr Ver√§nderungen, insbesondere nach dem gesprochenen Wort Linux.  Entwickler m√∂chten ihr geliebtes Visual Studio, TFS, mit Build-Tests und Smoothies.  Wie die Lieferung in der Produktion erfolgt - das ist ihnen egal.  Aus diesem Grund haben wir beschlossen, den √ºblichen Prozess nicht zu √§ndern und alles f√ºr die Windows-Entwicklung unver√§ndert zu lassen. <br><br>  Das neue Projekt muss <b>in das vorhandene CI eingebettet werden</b> .  Die Schienen waren bereits vorhanden und alle Arbeiten mussten unter Ber√ºcksichtigung der Parameter des Konfigurationsmanagementsystems, der akzeptierten Lieferstandards und der √úberwachungssysteme durchgef√ºhrt werden. <br><br>  <b>Einfachheit in Support und Betrieb</b> als Voraussetzung f√ºr eine Mindesteintrittsschwelle f√ºr alle neuen Teilnehmer aus verschiedenen Abteilungen und Supportabteilungen. <br><br>  <b>Frist - gestern</b> . <br><br><h2>  Entwicklungsgruppe gewinnen </h2><br>  Womit hat das Windows-Team damals gearbeitet? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/527/4b9/5e9/5274b95e93a6d270259487b5c68ca600.png"><br><br>  Jetzt kann ich mit Sicherheit sagen, dass <b>IdentityServer4</b> eine coole, kostenlose Alternative zu ADFS mit √§hnlichen Funktionen ist oder dass <b>Entity Framework Core</b> ein Paradies f√ºr Entwickler ist, in dem Sie sich nicht die M√ºhe machen m√ºssen, SQL-Skripte zu schreiben, sondern Abfragen in der Datenbank in OOP-Begriffen beschreiben.  Bei der Er√∂rterung des Aktionsplans betrachtete ich diesen Stapel jedoch als eine sumerische Keilschrift, die nur PostgreSQL und Git erkennt. <br><br>  Zu dieser Zeit haben wir <b>Puppet</b> aktiv als Konfigurationsmanagementsystem verwendet.  In den meisten unserer Projekte verwendeten wir <b>GitLab CI</b> , <b>Elastic</b> , ausgeglichene, hoch ausgelastete Dienste mit <b>HAProxy,</b> √ºberwachten alles mit <b>Zabbix</b> , einer Reihe von <b>Grafana</b> und <b>Prometheus</b> , <b>Jaeger</b> , und all dies drehte sich auf <b>HP</b> Hardware mit <b>ESXi</b> auf <b>VMware</b> .  Jeder wei√ü - ein Klassiker des Genres. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ffb/768/38f/ffb76838f0538bd215bc5a54d5e005ad.png"><br><br>  Lassen Sie uns schauen und versuchen zu verstehen, was passiert ist, bevor wir mit all diesen Interventionen begonnen haben. <br><br><h2>  Was war </h2><br>  TFS ist ein ziemlich leistungsf√§higes System, das nicht nur Code vom Entwickler an die endg√ºltige Produktionsmaschine liefert, sondern auch eine Reihe f√ºr eine sehr flexible Integration mit verschiedenen Diensten bietet - um CI auf plattform√ºbergreifender Ebene bereitzustellen. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9b7/9a3/146/9b79a3146abb65be1c4dad29ad50e406.png"><br>  Zuvor waren dies solide Fenster.  TFS verwendete mehrere Build-Agenten, die viele Projekte sammelten.  Jeder Agent hat 3-4 Mitarbeiter - a, um Aufgaben zu parallelisieren und den Prozess zu optimieren.  Gem√§√ü den Release-Pl√§nen lieferte TFS den frisch gebackenen Build an den Windows-Anwendungsserver. <br><br><h2>  Zu was wir kommen wollten </h2><br>  F√ºr die Bereitstellung und Entwicklung verwenden wir TFS und starten die Anwendung auf dem Linux-Anwendungsserver. Zwischen ihnen liegt eine Art Magie.  Diese <b>Magic Box</b> ist das Salz der bevorstehenden Arbeit.  Bevor ich es in Teile zerlege, werde ich einen Schritt zur Seite treten und zwei Worte √ºber die Anwendung sagen. <br><br><h2>  Projekt </h2><br>  Die Anwendung bietet Funktionen f√ºr den Umgang mit Prepaid-Karten. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c2/3be/4cc/4c23be4cce98ad3b48de986826817c19.png"><br><br><h3>  Client </h3><br>  Es gab zwei Arten von Benutzern.  <b>Der erste</b> erhielt Zugriff, indem er sich mit dem SSL SHA-2-Zertifikat anmeldete.  Der <b>zweite</b> hatte Zugriff per Login und Passwort. <br><br><h3>  HAProxy </h3><br>  Ferner fiel die Kundenanfrage in HAProxy, das die folgenden Aufgaben l√∂ste: <br><br><ul><li>  Erstgenehmigung; <br></li><li>  SSL-Beendigung <br></li><li>  Optimierung von HTTP-Anfragen; <br></li><li>  Broadcast-Anfragen. <br></li></ul><br>  Die √úberpr√ºfung des Client-Zertifikats durchlief die Kette.  Wir sind <b>Autorit√§t</b> und k√∂nnen es uns leisten, da wir selbst Zertifikate f√ºr Servicekunden ausstellen. <br><br>  Achten Sie auf den dritten Punkt, wenig sp√§ter werden wir darauf zur√ºckkommen. <br><br><h3>  Backend </h3><br>  Sie planten ein Backend unter Linux.  Das Backend interagiert mit der Datenbank, l√§dt die erforderliche Liste der Berechtigungen und bietet dann, abh√§ngig von den Berechtigungen des autorisierten Benutzers, den Zugriff zum Signieren und Senden von Finanzdokumenten oder zum Generieren eines Berichts. <br><br><h2>  Sparen mit HAProxy </h2><br>  Zus√§tzlich zu den beiden Kontexten, die jeder Client durchlief, gab es auch einen Identit√§tskontext.  <b>Mit IdentityServer4</b> k√∂nnen Sie sich nur anmelden. Es ist ein kostenloses und leistungsstarkes Analogon f√ºr <b>ADFS</b> - <b>Active Directory Federation Services</b> . <br><br>  Die Identit√§tsanfrage wurde in mehreren Schritten bearbeitet.  Der erste Schritt - der <b>Client</b> <b>fiel in das Backend</b> , das Daten mit diesem Server austauschte und das Vorhandensein eines Tokens f√ºr den Client √ºberpr√ºfte.  Wenn ich es nicht gefunden habe, kehrte die Anfrage zu dem Kontext zur√ºck, aus dem sie stammte, aber mit einer Weiterleitung und mit einer Weiterleitung ging sie zur Identit√§t. <br><br>  Der zweite Schritt - Die Anforderung wurde <b>an die Authentifizierungsseite in IdentityServer weitergeleitet,</b> auf der der Client registriert war, und das sehr lang erwartete Token wurde in der IdentityServer-Datenbank angezeigt. <br><br>  Der dritte Schritt - der <b>Kunde leitete zur√ºck</b> zu dem Kontext, aus dem er kam. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ead/cc3/039/eadcc3039f4585956ccf9d25512a4370.png"><br><br>  IdentityServer4 hat eine Besonderheit: <b>Es gibt die Antwort auf die R√ºckgabeanforderung √ºber HTTP zur√ºck</b> .  Egal wie wir mit dem Server-Setup zu k√§mpfen hatten, egal wie wir mit der Dokumentation vertraut wurden, jedes Mal, wenn wir eine erste Client-Anfrage mit einer URL erhielten, die √ºber HTTPS kam, gab IdentityServer denselben Kontext zur√ºck, jedoch mit HTTP.  Wir standen unter Schock!  All dies wurde √ºber den Identit√§tskontext an HAProxy √ºbertragen, und in den Headern mussten wir das HTTP-Protokoll auf HTTPS √§ndern. <br><br>  Was ist die Verbesserung und wo haben sie gespart? <br><br><blockquote>  Wir haben Geld gespart, indem wir eine kostenlose L√∂sung zum Autorisieren einer Gruppe von Benutzern und Ressourcen verwendet haben, da wir IdentityServer4 nicht als separate Notiz in einem separaten Segment verwendet haben, sondern zusammen mit einem Backend auf demselben Server verwendet haben, auf dem sich das Anwendungs-Backend dreht. </blockquote><br><h2>  Wie es funktionieren soll </h2><br>  Also, wie ich versprochen habe - Magic Box.  Wir verstehen bereits, dass wir garantiert auf Linux umsteigen werden.  Formulieren wir spezifische Aufgaben, f√ºr die L√∂sungen erforderlich sind. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59b/f2c/bde/59bf2cbdeb581a1e53cea2dabfbd4aca.png"><br><br>  <b>Marionette manifestiert sich.</b>  Um die Konfiguration des Dienstes und der Anwendung bereitzustellen und zu verwalten, mussten Sie coole Rezepte schreiben.  Eine Bleistiftrolle zeigt eloquent, wie schnell und effizient dies geschehen ist. <br><br>  <b>Versandart.</b>  Der Standard ist RPM.  Jeder versteht, dass es unter Linux keinen Weg ohne gibt, aber das Projekt selbst nach dem Zusammenbau bestand aus einer Reihe ausf√ºhrbarer DLL-Dateien.  Es waren ungef√§hr 150 von ihnen, das Projekt ist ziemlich schwierig.  Die einzige harmonische L√∂sung besteht darin, diese Bin√§rdateien in RPM zu packen und die Anwendung von dort aus bereitzustellen. <br><br>  <b>Versionierung</b>  Wir mussten sehr oft ver√∂ffentlichen und wir mussten entscheiden, wie wir den Namen des Pakets bilden sollten.  Dies ist eine Frage der TFS-Integrationsstufe.  Wir hatten einen Build Agent unter Linux.  Wenn TFS die Aufgabe an den Handler - Worker - an den Build-Agenten sendet, sendet es auch eine Reihe von Variablen, die in die Umgebung des Handlerprozesses fallen.  Diesen Umgebungsvariablen werden der Name Build, der Name der Version und andere Variablen √ºbergeben.  Weitere Informationen hierzu finden Sie im Abschnitt ‚ÄûZusammenstellen eines RPM-Pakets‚Äú. <br><br>  <b>Beim Einrichten von TFS ging</b> es darum, die Pipeline einzurichten.  Fr√ºher haben wir alle Windows-Projekte auf Windows-Agenten gesammelt, und jetzt gibt es einen Linux-Agenten - einen Build-Agenten, der in die Assembly-Gruppe aufgenommen werden muss und mit einigen Artefakten angereichert ist. Geben Sie an, welche Art von Projekten auf diesem Build-Agenten erstellt werden sollen. und irgendwie Pipeline √§ndern. <br><br>  <b>IdentityServer.</b>  ADFS ist nicht unser Weg, wir ertrinken f√ºr Open Source. <br><br>  Lassen Sie uns die Komponenten durchgehen. <br><br><h2>  Magic Box </h2><br>  Besteht aus vier Teilen. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/737/6ef/bb5/7376efbb54d21a0dcc88f191b70dfe9f.png"><br><br>  <b>Linux Build Agent.</b>  Linux ist logisch, weil wir es kompilieren.  Dieser Teil wurde in drei Schritten durchgef√ºhrt. <br><br><ul><li>  <b>Konfigurieren Sie Mitarbeiter</b> und mehrere, da davon ausgegangen wurde, dass die Arbeit am Projekt verteilt ist. <br></li><li>  <b>Installieren Sie .NET Core 1.x.</b>  Warum 1.x, wenn 2.0 bereits im Standard-Repository verf√ºgbar ist?  Denn als wir mit der Entwicklung begannen, war die stabile Version 1.09 und es wurde beschlossen, das Projekt daf√ºr durchzuf√ºhren. <br></li><li>  <b>Git 2.x.</b> <br></li></ul><br>  <b>RPM-Repository.</b>  RPM-Pakete mussten irgendwo gespeichert werden.  Es wurde angenommen, dass wir dasselbe Unternehmens-RPM-Repository verwenden w√ºrden, das allen Linux-Hosts zur Verf√ºgung steht.  Und so taten sie es.  Auf dem Repository-Server <b>ist</b> ein <b>Webhook</b> konfiguriert, der das erforderliche RPM-Paket vom angegebenen Speicherort heruntergeladen hat.  Die Version des Pakets wurde vom Build-Agenten an den Webhook gemeldet. <br><br>  <b>Gitlab</b>  Achtung!  GitLab wird hier nicht von Entwicklern verwendet, sondern von der Betriebsabteilung, um Anwendungsversionen und Paketversionen zu steuern, den Status aller Linux-Computer zu √ºberwachen und das Rezept zu speichern - alle Puppet-Manifeste. <br><br>  <b>Puppet</b> - l√∂st alle kontroversen Probleme und liefert genau die Konfiguration, die wir von Gitlab wollen. <br><br>  Wir fangen an zu tauchen.  Wie wird DLL in RPM geliefert? <br><br><h3>  DDL-Lieferung an RPM </h3><br>  Nehmen wir an, wir haben einen Rockstar f√ºr die .NET-Entwicklung.  Es verwendet Visual Studio und erstellt einen Release-Zweig.  Danach wird es in Git geladen, und Git ist hier eine TFS-Entit√§t, dh es ist das Anwendungsrepository, mit dem der Entwickler arbeitet. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1fd/fcd/8db/1fdfcd8dbe8f5395907ce2e5ec450539.png"><br><br>  Danach sieht TFS, dass ein neues Commit eingetroffen ist.  Welche Anwendung?  In den TFS-Einstellungen gibt es eine Bezeichnung dar√ºber, √ºber welche Ressourcen ein bestimmter Build-Agent verf√ºgt.  In diesem Fall sieht er, dass wir ein .NET Core-Projekt erstellen und einen Linux-Build-Agenten aus dem Pool ausw√§hlen. <br><br>  Der Build-Agent empf√§ngt die Quellen, l√§dt die erforderlichen <b>Abh√§ngigkeiten</b> aus dem .NET, dem npm-Repository usw. herunter.  Nach dem Erstellen der Anwendung selbst und dem anschlie√üenden Packen wird das RPM-Paket an das RPM-Repository gesendet. <br><br>  Auf der anderen Seite tritt Folgendes auf.  Der Wartungstechniker ist direkt an der Einf√ºhrung des Projekts beteiligt: ‚Äã‚ÄãEr √§ndert die Version der Pakete in <b>Hiera</b> im Repository, in dem das Anwendungsrezept gespeichert ist. Anschlie√üend l√∂st Puppet <b>Yum aus</b> , holt das neue Paket aus dem Repository ab und die neue Version der Anwendung ist einsatzbereit. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/135/3dd/9ae/1353dd9ae0bf83bd4527ceaa8f4db1ee.png"><br><br>  Mit anderen Worten, alles ist einfach, aber was passiert im Build-Agenten selbst? <br><br><h3>  Packaging RPM DLL </h3><br>  Die Projektquellen und die Build-Aufgabe von TFS wurden empfangen.  Der Build Agent <b>beginnt mit der</b> Erstellung <b>des Projekts aus dem Quellcode</b> .  Das zusammengestellte Projekt ist in Form vieler <b>DLL-Dateien</b> verf√ºgbar, die in einem Zip-Archiv gepackt sind, um die Belastung des Dateisystems zu verringern. <br><br>  Das ZIP-Archiv wird <b>in das Build-Verzeichnis des RPM-Pakets</b> geworfen <b>.</b>  Als N√§chstes initialisiert das Bash-Skript die Umgebungsvariablen, findet die Build-Version, die Projektversion, den Pfad zum Build-Verzeichnis und startet RPM-Build.  Am Ende der Assembly wird das Paket im <b>lokalen Repository ver√∂ffentlicht</b> , das sich auf dem Build-Agenten befindet. <br><br>  Au√üerdem <b>wird</b> vom Build-Agenten eine <b>JSON-Anforderung</b> mit dem Versionsnamen und dem Build an den Server im RPM-Repository <b>gesendet</b> .  Webhook, √ºber den ich bereits gesprochen habe, l√§dt dasselbe Paket aus dem lokalen Repository des Build-Agenten herunter und stellt die neue Assembly f√ºr die Installation zur Verf√ºgung. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/44c/9a5/b5c/44c9a5b5c05b30293723eec126e0ff24.png"><br><br>  Warum ein solches Schema f√ºr die Bereitstellung eines Pakets an ein RPM-Repository?  Warum kann ich das zusammengestellte Paket nicht sofort an das Repository senden?  Tatsache ist, dass dies eine Sicherheitsbedingung ist.  Dieses Szenario schr√§nkt die M√∂glichkeit des unbefugten Herunterladens von RPM-Paketen durch Au√üenstehende auf einen Server ein, auf den alle Linux-Computer zugreifen k√∂nnen. <br><br><h2>  DB-Versionierung </h2><br>  Bei der Konsultation mit der Entwicklung stellte sich heraus, dass die Jungs n√§her an MS SQL sind, aber in den meisten Nicht-Windows-Projekten haben wir PostgreSQL bereits mit Macht und Haupt verwendet.  Da wir uns bereits entschlossen haben, alles, was bezahlt wurde, aufzugeben, haben wir hier begonnen, PostgreSQL zu verwenden. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9c/e1a/815/a9ce1a81549ee0de97167823755f9b25.png"><br><br>  In diesem Teil m√∂chte ich dar√ºber sprechen, wie wir die Datenbankversionierung implementiert haben und wie Sie zwischen Flyway und Entity Framework Core w√§hlen k√∂nnen.  Betrachten Sie ihre Vor- und Nachteile. <br><br><h3>  Nachteile </h3><br>  Flyway geht nur in eine Richtung, wir <b>k√∂nnen nicht zur√ºckrollen</b> - das ist ein deutliches Minus.  Der Vergleich mit Entity Framework Core kann anhand anderer Parameter erfolgen - aus Sicht der Entwicklerfreundlichkeit.  Sie erinnern sich, dass wir dies in den Vordergrund gestellt haben und das Hauptkriterium darin bestand, nichts f√ºr die Windows-Entwicklung zu √§ndern. <br><br>  F√ºr Flyway <b>brauchten</b> wir <b>eine Art Wrapper,</b> damit die Jungs keine <b>SQL-Abfragen</b> schrieben.  Sie sind in Bezug auf OOP viel n√§her am Betrieb.  Wir haben Anweisungen zum Arbeiten mit Datenbankobjekten geschrieben, eine SQL-Abfrage erstellt und ausgef√ºhrt.  Die neue Version der Datenbank ist fertig, gerollt - alles ist in Ordnung, alles funktioniert. <br><br>  Entity Framework Core hat ein Minus - unter hoher Last werden <b>nicht optimale SQL-Abfragen erstellt</b> , und der Datenbankabbau kann erheblich sein.  Da wir jedoch keinen Hochlastservice haben, berechnen wir die Last nicht mit Hunderten von RPS. Wir sind diese Risiken eingegangen und haben das Problem an die Zukunft delegiert. <br><br><h3>  Vorteile </h3><br>  Entity Framework Core <b>funktioniert sofort und ist einfach zu entwickeln</b> . Flyway l√§sst <b>sich nahtlos in vorhandene CI integrieren</b> .  Aber wir machen es bequem f√ºr Entwickler :) <br><br><h3>  Roll-up-Verfahren </h3><br>  Puppet sieht, dass sich die Version der Pakete √§ndert, unter denen die f√ºr die Migration verantwortliche ist.  Zun√§chst wird ein Paket installiert, das Migrationsskripts und an die Datenbank gebundene Funktionen enth√§lt.  Danach wird die Anwendung, die mit der Datenbank arbeitet, neu gestartet.  Als n√§chstes werden die restlichen Komponenten installiert.  Die Reihenfolge, in der Pakete installiert und Anwendungen gestartet werden, ist im Puppet-Manifest beschrieben. <br><br>  Anwendungen verwenden vertrauliche Daten wie Token und Kennw√∂rter f√ºr die Datenbank. All dies wird mit dem Puppet-Master in die Konfiguration gezogen und dort verschl√ºsselt gespeichert. <br><br><h2>  TFS-Probleme </h2><br>  Nachdem wir entschieden und festgestellt hatten, dass wirklich alles f√ºr uns funktioniert, entschied ich mich zu sehen, was mit den Baugruppen in TFS als Ganzes f√ºr die Win-Entwicklungsabteilung f√ºr andere Projekte los war - schnell oder nicht, wir wollten / ver√∂ffentlichen und stellten erhebliche Probleme mit der Geschwindigkeit fest . <br><br>  Eines der Hauptprojekte wird 12 bis 15 Minuten dauern - es ist eine lange Zeit, so kann man nicht leben.  Eine schnelle Analyse ergab einen schrecklichen R√ºckgang der E / A, und dies gilt auch f√ºr Arrays. <br><br>  Nachdem ich die Komponenten analysiert hatte, identifizierte ich drei Schwerpunkte.  Das erste ist <b>Kaspersky Antivirus</b> , das den Quellcode aller Windows Build-Agenten √ºberpr√ºft.  Der zweite ist der <b>Windows-</b> <b>Indexer.</b>  Es wurde nicht getrennt, und auf Build-Agenten wurde in Echtzeit alles w√§hrend des Bereitstellungsprozesses indiziert. <br><br>  Der dritte ist die <b>Npm-Installation.</b>  Es stellte sich heraus, dass wir in den meisten Pipelines dieses spezielle Szenario verwendet haben.  Warum ist er schlecht?  Die Npm-Installationsprozedur beginnt, wenn der Abh√§ngigkeitsbaum in <b>package-lock.json erstellt wird</b> , in dem die Versionen der Pakete festgelegt sind, die zum Erstellen des Projekts verwendet werden.  Das Minus ist, dass bei der Npm-Installation jedes Mal die neuesten Versionen von Paketen aus dem Internet abgerufen werden. Dies ist bei einem gro√üen Projekt eine betr√§chtliche Zeit. <br><br><blockquote>  Entwickler experimentieren manchmal auf dem lokalen Computer, um die Funktionsweise eines einzelnen Teils oder Projekts als Ganzes zu testen.  Manchmal stellte sich heraus, dass vor Ort alles cool war, aber zusammengebaut, ausgerollt - nichts funktionierte.  Wir beginnen zu verstehen, wo das Problem liegt - ja, verschiedene Versionen von Abh√§ngigkeitspaketen. </blockquote><br><h3>  L√∂sung </h3><br><ul><li>  Quellen zu AV-Ausnahmen. <br></li><li>  Indizierung deaktivieren. <br></li><li>  Wechseln Sie zu <b>npm ci</b> . <br></li></ul><br>  Der Vorteil von npm ci besteht darin, dass wir <b>den Abh√§ngigkeitsbaum einmal erfassen</b> und dem Entwickler die M√∂glichkeit geben, eine <b>aktuelle Liste von Paketen</b> bereitzustellen, mit denen er lokal so viel experimentieren kann, wie er m√∂chte.  Dies <b>spart Zeit f√ºr</b> Entwickler, die Code schreiben. <br><br><h3>  Konfiguration </h3><br>  Nun ein wenig zur Repository-Konfiguration.  In der Vergangenheit haben wir <b>Nexus</b> zum Verwalten von Repositorys verwendet, einschlie√ülich des <b>internen REPO</b> .  Alle Komponenten, die wir f√ºr interne Zwecke verwenden, z. B. die selbstgeschriebene √úberwachung, werden an dieses interne Repository geliefert. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/25d/4d9/204/25d4d920402193190f95e0783f31fc04.png"><br><br>  Wir verwenden auch <b>NuGet</b> , da es besser zwischengespeichert wird als andere Paketmanager. <br><br><h3>  Ergebnis </h3><br>  Nachdem wir die Build-Agenten optimiert hatten, wurde die durchschnittliche Build-Zeit von 12 Minuten auf 7 Minuten reduziert. <br><br><blockquote>    ,       Windows,    Linux   ,    $10 000.     ,     ‚Äî . </blockquote><br><h2>  Pl√§ne </h2><br>           . <br><br> <b>   Docker-</b> . TFS ‚Äî     ,     Pipeline,   ,    , , Docker-.         <b>package-lock.json</b> .  -    ,      ‚Äî     Docker-.          .   ,        Kubernetes,           . <br><br><h2>  Zusammenfassung </h2><br>    Windows,    ,      .   ,    Opensource- ‚Äî  <b>Linux-</b> .   <b>  </b> .   ,    Open Source  Linux   . <br><br> <i>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> GitHub</a> .</i> <br><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DevOps Conf</a> ‚Äî      ,       .   ,    ?   ,        .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DevOps Conf  ++</a> 27  28        .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> .   ! </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de448496/">https://habr.com/ru/post/de448496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de448484/index.html">Wurzelmikroben</a></li>
<li><a href="../de448486/index.html">"Im November 2018 sind wir f√§lschlicherweise an allen Fronten in Spam geraten." Wie ich Mailings von einem Unternehmen mit einer millionsten Basis gespeichert habe</a></li>
<li><a href="../de448488/index.html">Angst und Abscheu vor DevSecOps</a></li>
<li><a href="../de448490/index.html">So starten Sie die DevOps-Transformation</a></li>
<li><a href="../de448492/index.html">Was ist DevOps?</a></li>
<li><a href="../de448498/index.html">"Russland 404": Wie viel freies Internet bleibt noch zu leben</a></li>
<li><a href="../de448500/index.html">L√∂sen eines einfachen Crackme f√ºr Sega Mega Drive</a></li>
<li><a href="../de448504/index.html">Sie sammelten f√ºr alle "Habrom" das Nachschlagewerk "Von wem es ausgestellt wurde ..." f√ºr P√§sse. Auf Gesundheit herunterladen</a></li>
<li><a href="../de448506/index.html">Die Matrix ist 20 Jahre alt: Wie Wachowski Cyberpunk machte, der die Agenda f√ºr eine ganze Generation bestimmte</a></li>
<li><a href="../de448510/index.html">Acer im Jahr 2019: Was ist, wenn Sie alle Fliegen von den Gaming-Laptops entfernen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>