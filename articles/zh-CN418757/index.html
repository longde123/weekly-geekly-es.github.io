<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©â€âœˆï¸ ğŸ”‚ ğŸ§”ğŸ¿ ç¼©çŸ­æ—¶é—´èŒƒå›´ï¼ˆåŠ å¯†è´§å¸ï¼Œå¤–æ±‡ï¼Œäº¤æ˜“æ‰€ï¼‰ ğŸ‘¦ğŸ¾ âœŒğŸ¼ âœŠ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‰æ®µæ—¶é—´ï¼Œæˆ‘çš„ä»»åŠ¡æ˜¯ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥æ‰§è¡Œå¤–æ±‡å¸‚åœºæŠ¥ä»·ï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯æ—¶é—´èŒƒå›´æ•°æ®ï¼‰çš„ç¨€ç–æ“ä½œã€‚ 

 é—®é¢˜çš„é™ˆè¿°ï¼šä»¥è¿™ç§æ ¼å¼æ¯éš”1ç§’è¾“å…¥ä¸€æ¬¡æ•°æ®ï¼š 



- å·¥å…·åç§°ï¼ˆUSDEURå¯¹ä»£ç ç­‰ï¼‰ï¼Œ 
- UNIXæ—¶é—´æ ¼å¼çš„æ—¥æœŸå’Œæ—¶é—´ï¼Œ 
- å¼€ç›˜ä»·å€¼ï¼ˆåŒºé—´ä¸­ç¬¬ä¸€ç¬”äº¤æ˜“çš„ä»·æ ¼ï¼‰ï¼Œ 
- é«˜ä»·å€¼ï¼ˆæœ€é«˜ä»·æ ¼ï¼‰ï¼Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç¼©çŸ­æ—¶é—´èŒƒå›´ï¼ˆåŠ å¯†è´§å¸ï¼Œå¤–æ±‡ï¼Œäº¤æ˜“æ‰€ï¼‰</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418757/"> å‰æ®µæ—¶é—´ï¼Œæˆ‘çš„ä»»åŠ¡æ˜¯ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥æ‰§è¡Œå¤–æ±‡å¸‚åœºæŠ¥ä»·ï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯æ—¶é—´èŒƒå›´æ•°æ®ï¼‰çš„ç¨€ç–æ“ä½œã€‚ <br><br> é—®é¢˜çš„é™ˆè¿°ï¼šä»¥è¿™ç§æ ¼å¼æ¯éš”1ç§’è¾“å…¥ä¸€æ¬¡æ•°æ®ï¼š <br><br><ul><li> å·¥å…·åç§°ï¼ˆUSDEURå¯¹ä»£ç ç­‰ï¼‰ï¼Œ </li><li>  UNIXæ—¶é—´æ ¼å¼çš„æ—¥æœŸå’Œæ—¶é—´ï¼Œ </li><li> å¼€ç›˜ä»·å€¼ï¼ˆåŒºé—´ä¸­ç¬¬ä¸€ç¬”äº¤æ˜“çš„ä»·æ ¼ï¼‰ï¼Œ </li><li> é«˜ä»·å€¼ï¼ˆæœ€é«˜ä»·æ ¼ï¼‰ï¼Œ </li><li> ä½ä»·å€¼ </li><li> æ”¶ç›˜ä»·ï¼ˆæœ€åä¸€ç¬”äº¤æ˜“çš„ä»·æ ¼ï¼‰ï¼Œ </li><li>äº¤æ˜“é‡ï¼ˆäº¤æ˜“é‡æˆ–äº¤æ˜“é‡ï¼‰ã€‚ </li></ul><br> å¿…é¡»ç¡®ä¿è¡¨ä¸­æ•°æ®çš„é‡æ–°è®¡ç®—å’ŒåŒæ­¥ï¼š5ç§’ï¼Œ15ç§’ï¼Œ1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿç­‰ã€‚ <br><br> æ‰€æè¿°çš„æ•°æ®å­˜å‚¨æ ¼å¼ç§°ä¸ºOHLCæˆ–OHLCVï¼ˆæ‰“å¼€ï¼Œé«˜ï¼Œä½ï¼Œå…³é—­ï¼ŒéŸ³é‡ï¼‰ã€‚ å®ƒç»å¸¸ä½¿ç”¨ï¼Œæ‚¨å¯ä»¥ç«‹å³åœ¨å…¶ä¸Šæ„å»ºâ€œæ—¥æœ¬èœ¡çƒ›â€å›¾è¡¨ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/by/ws/8u/byws8uaklvxydw8d2wqkqhpb1ni.png" alt="å›¾ç‰‡"></div><br> åœ¨å‰Šå‡çš„åŸºç¡€ä¸Šï¼Œæˆ‘æè¿°äº†æˆ‘å¯ä»¥æƒ³åˆ°çš„æ‰€æœ‰é€‰é¡¹ï¼Œå¦‚ä½•ç¨€ç–ï¼ˆæ”¾å¤§ï¼‰æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œä»¥è¿›è¡Œåˆ†æï¼Œä¾‹å¦‚ï¼Œæ¯”ç‰¹å¸ä»·æ ¼çš„å†¬å­£ä¸Šæ¶¨ï¼Œç„¶åæ ¹æ®æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œæ‚¨å°†ç«‹å³æ„å»ºä¸€ä¸ªâ€œ Japanese Candlesâ€å›¾è¡¨ï¼ˆåœ¨MS Excelä¸­ä¹Ÿæœ‰è¿™æ ·çš„å›¾è¡¨ï¼‰ ï¼‰ åœ¨ä¸Šå›¾ä¸­ï¼Œæ­¤å›¾è¡¨æ˜¯é’ˆå¯¹â€œ bitstampUSDâ€å·¥å…·çš„â€œ 1ä¸ªæœˆâ€æ—¶é—´æ¡†æ¶æ„å»ºçš„ã€‚ èœ¡çƒ›çš„ç™½è‰²ä¸»ä½“è¡¨ç¤ºè¯¥æ—¶é—´é—´éš”å†…çš„ä»·æ ¼ä¸Šæ¶¨ï¼Œé»‘è‰²è¡¨ç¤ºä»·æ ¼ä¸‹é™ï¼Œä¸Šä¸‹ç¯èŠ¯æŒ‡ç¤ºè¯¥æ—¶é—´é—´éš”å†…è¾¾åˆ°çš„æœ€é«˜å’Œæœ€ä½ä»·æ ¼ã€‚ èƒŒæ™¯-äº¤æ˜“é‡ã€‚ å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œ2017å¹´12æœˆï¼Œä»·æ ¼æ¥è¿‘2ä¸‡é©¬å…‹ã€‚ <br><br> å°†ä¸ºä¸¤ä¸ªæ•°æ®åº“å¼•æ“ï¼ˆOracleå’ŒMS SQLï¼‰æä¾›è§£å†³æ–¹æ¡ˆï¼Œè¿™å°†ä»¥æŸç§æ–¹å¼ä½¿å®ƒä»¬å¯ä»¥é’ˆå¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œæ¯”è¾ƒï¼ˆæˆ‘ä»¬ä¸ä¼šå°†æ¯”è¾ƒç»“æœæ¨å¹¿åˆ°å…¶ä»–ä»»åŠ¡ï¼‰ã€‚ <br><a name="habracut"></a><br> ç„¶åï¼Œæˆ‘ä»¥ä¸€ç§ç®€å•çš„æ–¹å¼è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šåœ¨ä¸´æ—¶è¡¨ä¸­è®¡ç®—æ­£ç¡®çš„ç»†åŒ–å¹¶ä¸ç›®æ ‡è¡¨åŒæ­¥-åˆ é™¤ç›®æ ‡è¡¨ä¸­å­˜åœ¨ä½†ä¸´æ—¶è¡¨ä¸­ä¸å­˜åœ¨çš„è¡Œï¼Œå¹¶æ·»åŠ ä¸´æ—¶è¡¨ä¸­å­˜åœ¨ä½†ç›®æ ‡ä¸­ä¸å­˜åœ¨çš„è¡Œã€‚ é‚£æ—¶ï¼Œå®¢æˆ·æ»¡æ„äº†è§£å†³æ–¹æ¡ˆï¼Œäºæ˜¯æˆ‘å®Œæˆäº†ä»»åŠ¡ã€‚ <br><br> ä½†æ˜¯ç°åœ¨æˆ‘å†³å®šè€ƒè™‘æ‰€æœ‰é€‰é¡¹ï¼Œå› ä¸ºä¸Šè¿°è§£å†³æ–¹æ¡ˆåŒ…å«ä¸€ä¸ªåŠŸèƒ½-å¾ˆéš¾ä¸€æ¬¡é’ˆå¯¹ä¸¤ç§æƒ…å†µè¿›è¡Œä¼˜åŒ–ï¼š <br><br><ul><li> å½“ç›®æ ‡è¡¨ä¸ºç©ºå¹¶ä¸”æ‚¨éœ€è¦æ·»åŠ å¤§é‡æ•°æ®æ—¶ï¼Œ </li><li> å½“ç›®æ ‡è¡¨å¾ˆå¤§æ—¶ï¼Œæ‚¨éœ€è¦ä»¥å°å—æ·»åŠ æ•°æ®ã€‚ </li></ul><br> è¿™æ˜¯ç”±äºä»¥ä¸‹äº‹å®ï¼šåœ¨è¯¥è¿‡ç¨‹ä¸­ï¼Œæ‚¨å¿…é¡»è¿æ¥ç›®æ ‡è¡¨å’Œä¸´æ—¶è¡¨ï¼Œå¹¶ä¸”éœ€è¦é™„åŠ åˆ°è¾ƒå¤§çš„è¡¨ä¸Šï¼Œè€Œä¸æ˜¯ç›¸åã€‚ åœ¨ä¸Šè¿°ä¸¤ç§æƒ…å†µä¸‹ï¼Œå¤§/å°äº’æ¢ã€‚ ä¼˜åŒ–å™¨å°†åŸºäºç»Ÿè®¡ä¿¡æ¯ç¡®å®šè¿æ¥é¡ºåºï¼Œå¹¶ä¸”ç»Ÿè®¡ä¿¡æ¯å¯èƒ½å·²è¿‡æ—¶ï¼Œå¹¶ä¸”å†³ç­–å¯èƒ½ä¸æ­£ç¡®ï¼Œè¿™å°†å¯¼è‡´ä¸¥é‡çš„æ€§èƒ½ä¸‹é™ã€‚ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä¸€æ¬¡æ€§ç¨€ç–æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯èƒ½å¯¹è¯»è€…è¿›è¡Œåˆ†æå¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚ï¼Œæ¯”ç‰¹å¸ä»·æ ¼çš„å†¬å¤©ä¸Šæ¶¨ã€‚ <br><br> å¯ä»¥ä»githubæ–‡ç« åº•éƒ¨çš„é“¾æ¥ä¸‹è½½åœ¨çº¿ç¨€ç–è¿‡ç¨‹ã€‚ <br><br> åˆ°ç‚¹...æˆ‘çš„ä»»åŠ¡æ˜¯ä»â€œ 1ç§’â€æ—¶é—´é—´éš”åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘æ­£åœ¨è€ƒè™‘ä»äº‹åŠ¡çº§åˆ«ï¼ˆåœ¨æºè¡¨ä¸­ï¼Œå­—æ®µSTOCK_NAMEï¼ŒUTï¼ŒIDï¼ŒAPRICEï¼ŒAVOLUMEï¼‰è¿›è¡Œç˜¦åŒ–ã€‚ å› ä¸ºæ­¤ç±»æ•°æ®æ˜¯ç”±bitcoincharts.comå‘å¸ƒçš„ã€‚ <br> å®é™…ä¸Šï¼Œé€šè¿‡è¿™æ ·çš„å‘½ä»¤æ‰§è¡Œä»äº‹åŠ¡çº§åˆ«åˆ°â€œ 1ç§’â€çº§åˆ«çš„æŠ½å–ï¼ˆæ“ä½œå‘˜å¾ˆå®¹æ˜“è½¬æ¢ä¸ºä»â€œ 1ç§’â€çº§åˆ«åˆ°è¾ƒé«˜çº§åˆ«çš„æŠ½å–ï¼‰ï¼š <br><br>  <b>åœ¨Oracleä¸Šï¼š</b> <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br> å‡½æ•°<i>avgï¼ˆï¼‰keepï¼ˆæŒ‰UTï¼ŒIDï¼Œdense_rankä¸ºç¬¬ä¸€é¡ºåºï¼‰çš„</i>å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼šç”±äºè¯·æ±‚ä¸ºGROUP BYï¼Œå› æ­¤æ¯ä¸ªç»„çš„è®¡ç®—å‡ç‹¬ç«‹äºå…¶ä»–ç»„ã€‚ åœ¨æ¯ä¸ªç»„ä¸­ï¼Œå­—ç¬¦ä¸²æŒ‰UTå’ŒIDæ’åºï¼Œä»¥<i>density_rank</i>ç¼–å·ã€‚ ç”±äºéµå¾ªç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œå› æ­¤é€‰æ‹©äº†<i>ç¨ å¯†ç­‰çº§</i>è¿”å›1ï¼ˆæ¢å¥è¯è¯´ï¼Œé€‰æ‹©äº†æœ€å°å€¼ï¼‰çš„è¡Œ-é€‰æ‹©äº†è¯¥é—´éš”å†…çš„ç¬¬ä¸€ä¸ªäº‹åŠ¡ã€‚ å¯¹äºæ­¤æœ€å°çš„UTï¼ŒIDï¼Œå¦‚æœæœ‰å¤šè¡Œï¼Œåˆ™å°†è€ƒè™‘å¹³å‡å€¼ã€‚ ä½†æ˜¯åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç”±äºIDçš„å”¯ä¸€æ€§ï¼Œå°†ä¿è¯æœ‰ä¸€è¡Œï¼Œå› æ­¤ç»“æœå€¼å°†ç«‹å³ä½œä¸ºAOPENè¿”å›ã€‚ å¾ˆå®¹æ˜“æ³¨æ„åˆ°ï¼Œç¬¬<i>ä¸€ä¸ª</i>å‡½æ•°æ›¿æ¢äº†ä¸¤ä¸ªèšåˆå‡½æ•°ã€‚ <br><br>  <b>åœ¨MS SQL</b> <br><br> æ²¡æœ‰<i>first / last</i>å‡½æ•°ï¼ˆæœ‰<i>first_value / last_value</i> ï¼Œä½†ä¸æ˜¯ï¼‰ã€‚ å› æ­¤ï¼Œæ‚¨å¿…é¡»å°†è¡¨è¿æ¥åˆ°è‡ªèº«ã€‚ <br><br> æˆ‘ä¸ä¼šå•ç‹¬ç»™å‡ºè¯·æ±‚ï¼Œä½†æ˜¯æ‚¨å¯ä»¥åœ¨<i>dbo.THINNING_HABR_CALC</i>è¿‡ç¨‹ä¸­çœ‹åˆ°å®ƒã€‚ å½“ç„¶ï¼Œæ²¡æœ‰<i>ç¬¬ä¸€ä¸ª/æœ€åä¸€ä¸ªï¼Œ</i>å®ƒä¸æ˜¯é‚£ä¹ˆä¼˜é›…ï¼Œä½†æ˜¯ä¼šèµ·ä½œç”¨ã€‚ <br><br> ä¸€ä¸ªæ“ä½œå‘˜æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ  ï¼ˆåœ¨è¿™é‡Œï¼Œæœ¯è¯­â€œä¸€ä¸ªè¿ç®—ç¬¦â€å¹¶ä¸æ„å‘³ç€è¯¥è¿ç®—ç¬¦å°†æ˜¯ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œè€Œæ˜¯æ„å‘³ç€ä¸ä¼šæœ‰å¾ªç¯å°†æ•°æ®â€œæ‹‰â€åˆ°ä¸€è¡Œä¸Šã€‚ï¼‰ <br><br> æˆ‘å°†åˆ—å‡ºæˆ‘çŸ¥é“çš„è§£å†³æ­¤é—®é¢˜çš„æ‰€æœ‰é€‰é¡¹ï¼š <br><br><ol><li>  SIMPï¼ˆç®€å•ï¼Œç®€å•çš„ç¬›å¡å°”ç§¯ï¼‰ï¼Œ </li><li>  CALCï¼ˆè®¡ç®—ï¼Œä¸Šå±‚çš„è¿­ä»£å˜è–„ï¼‰ï¼Œ </li><li>  CHINï¼ˆä¸­å›½æ–¹å¼ï¼Œä¸€æ¬¡åˆä¸€æ¬¡è¦æ±‚æ‰€æœ‰çº§åˆ«ï¼‰ï¼Œ </li><li>  UDAFï¼ˆç”¨æˆ·å®šä¹‰çš„æ±‡æ€»å‡½æ•°ï¼‰ï¼Œ </li><li>  PPTFï¼ˆæµæ°´çº¿å’Œå¹¶è¡Œè¡¨å‡½æ•°ï¼Œè¿‡ç¨‹è§£å†³æ–¹æ¡ˆï¼Œä½†åªæœ‰ä¸¤ä¸ªæ¸¸æ ‡ï¼Œå®é™…ä¸Šæ˜¯ä¸¤ä¸ªSQLè¯­å¥ï¼‰ï¼Œ </li><li>  MODEï¼ˆæ¨¡å‹ï¼Œè¯ç»„ä¸ºMODELï¼‰ï¼Œ </li><li> å’ŒIDEAï¼ˆç†æƒ³çš„ç†æƒ³è§£å†³æ–¹æ¡ˆï¼Œç°åœ¨å¯èƒ½æ— æ³•ä½¿ç”¨ï¼‰ã€‚ </li></ol><br> å±•æœ›æœªæ¥ï¼Œæˆ‘è¦è¯´çš„æ˜¯ï¼Œç¨‹åºPPTFè§£å†³æ–¹æ¡ˆåœ¨Oracleä¸Šæœ€æœ‰æ•ˆçš„æƒ…å†µå¾ˆå°‘è§ã€‚ <br><br> ä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://api.bitcoincharts.com/v1/csv</a>ä¸‹è½½äº¤æ˜“æ–‡ä»¶ <br> æˆ‘å»ºè®®é€‰æ‹©kraken *æ–‡ä»¶ã€‚  localbtc *æ–‡ä»¶éå¸¸å˜ˆæ‚-å®ƒä»¬åŒ…å«åˆ†æ•£æ³¨æ„åŠ›çš„è¡Œå’Œä¸åˆ‡å®é™…çš„ä»·æ ¼ã€‚ æ‰€æœ‰kraken *éƒ½åŒ…å«å¤§çº¦3100ä¸‡ç¬”äº¤æ˜“ï¼Œæˆ‘å»ºè®®ä»é‚£é‡Œæ’é™¤krakenEURï¼Œè¿™æ ·äº¤æ˜“å°±å˜æˆ1100ä¸‡ç¬”ã€‚ è¿™æ˜¯æœ€æ–¹ä¾¿çš„æµ‹è¯•é‡ã€‚ <br><br> åœ¨Powershellä¸­è¿è¡Œè„šæœ¬ä»¥ä¸ºOracleçš„SQLLDRç”Ÿæˆæ§åˆ¶æ–‡ä»¶ï¼Œå¹¶ä¸ºMSSQLç”Ÿæˆå¯¼å…¥è¯·æ±‚ã€‚ <br><br><pre> <code class="hljs mel"> # MODIFY PARAMETERS THERE $OracleConnectString = <span class="hljs-string"><span class="hljs-string">"THINNING/aaa@P-ORA11/ORCL"</span></span> # For Oracle $PathToCSV = <span class="hljs-string"><span class="hljs-string">"Z:\10"</span></span> # without trailing slash $filenames = Get-ChildItem -name *.csv Remove-Item *.ctl -ErrorAction SilentlyContinue Remove-Item *.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> -ErrorAction SilentlyContinue Remove-Item *.bad -ErrorAction SilentlyContinue Remove-Item *.dsc -ErrorAction SilentlyContinue Remove-Item LoadData-Oracle.bat -ErrorAction SilentlyContinue Remove-Item LoadData-MSSQL.sql -ErrorAction SilentlyContinue ForEach ($FilenameExt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Filenames) { Write-Host <span class="hljs-string"><span class="hljs-string">"Processing file: "</span></span>$FilenameExt $StockName = $FilenameExt.<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, $FilenameExt.Length<span class="hljs-number"><span class="hljs-number">-5</span></span>) $FilenameCtl = <span class="hljs-string"><span class="hljs-string">'.'</span></span>+$Stockname+<span class="hljs-string"><span class="hljs-string">'.ctl'</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"OPTIONS (DIRECT=TRUE, PARALLEL=FALSE, ROWS=1000000, SKIP_INDEX_MAINTENANCE=Y)"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"UNRECOVERABLE"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"LOAD DATA"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INFILE '.$StockName.csv'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"BADFILE '.$StockName.bad'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"DISCARDFILE '.$StockName.dsc'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INTO TABLE TRANSACTIONS_RAW"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"APPEND"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"FIELDS TERMINATED BY ','"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"(ID SEQUENCE (0), STOCK_NAME constant '$StockName', UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-Oracle.bat -Value <span class="hljs-string"><span class="hljs-string">"sqlldr $OracleConnectString control=$FilenameCtl"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"insert into TRANSACTIONS_RAW (STOCK_NAME, UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"select '$StockName' as STOCK_NAME, UT, APRICE, AVOLUME"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"from openrowset (bulk '$PathToCSV\$FilenameExt', formatfile = '$PathToCSV\format_mssql.bcp') as T1;"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">""</span></span> }</code> </pre><br> è®©æˆ‘ä»¬åœ¨Oracleä¸Šåˆ›å»ºä¸€ä¸ªäº‹åŠ¡è¡¨ã€‚ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">32</span></span>) , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> nologging;</code> </pre><br> åœ¨Oracleä¸Šï¼Œè¿è¡Œ<i>LoadData-Oracle.batæ–‡ä»¶</i> ï¼Œä¹‹å‰å·²åœ¨Powershellè„šæœ¬çš„å¼€å¤´<i>å›ºå®š</i>äº†è¿æ¥å‚æ•°ã€‚ <br><br> æˆ‘åœ¨è™šæ‹Ÿæœºä¸Šå·¥ä½œã€‚ ä¸‹è½½8ä¸ªkraken *æ–‡ä»¶ä¸­çš„æ‰€æœ‰1100ä¸‡ä¸ªäº¤æ˜“æ–‡ä»¶ï¼ˆæˆ‘è·³è¿‡äº†EURæ–‡ä»¶ï¼‰å¤§çº¦èŠ±è´¹äº†1åˆ†é’Ÿã€‚ <br><br> å¹¶åˆ›å»ºå°†æ—¥æœŸæˆªæ–­ä¸ºåŒºé—´è¾¹ç•Œçš„å‡½æ•°ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span>) * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span>) * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span>) * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'Month'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'year'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> varchar2 <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to_char (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY.MM.DD HH24:MI:SS'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br> è€ƒè™‘é€‰é¡¹ã€‚ é¦–å…ˆï¼Œç»™å‡ºæ‰€æœ‰é€‰é¡¹çš„ä»£ç ï¼Œç„¶åç»™å‡ºå¯åŠ¨å’Œæµ‹è¯•çš„è„šæœ¬ã€‚ é¦–å…ˆï¼Œé’ˆå¯¹Oracleæè¿°ä»»åŠ¡ï¼Œç„¶åé’ˆå¯¹MS SQLæè¿°ä»»åŠ¡ <br><br><h4> é€‰é¡¹1-SIMPï¼ˆç‰¹æƒ ï¼‰ </h4><br> æ•´ä¸ªäº¤æ˜“é›†ä¸ç¬›å¡å°”ä¹˜ç§¯ä¹˜ä»¥ä¸€ç»„10è¡Œï¼Œæ•°å­—ä»1åˆ°10ã€‚è¿™å¯¹äºä»äº¤æ˜“çš„å•è¡Œä¸­è·å¾—10è¡Œï¼Œæ—¥æœŸè¢«æˆªæ–­ä¸º10ä¸ªé—´éš”çš„è¾¹ç•Œæ˜¯å¿…éœ€çš„ã€‚ <br><br> ä¹‹åï¼Œå°†è¡ŒæŒ‰é—´éš”å·å’ŒæˆªçŸ­æ—¥æœŸåˆ†ç»„ï¼Œå¹¶æ‰§è¡Œä¸Šè¿°è¯·æ±‚ã€‚ <br><br> åˆ›å»ºè§†å›¾ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW , (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID);</code> </pre><br><h4> é€‰é¡¹2-CALCï¼ˆè¿­ä»£è®¡ç®—ï¼‰ </h4><br> åœ¨æ­¤é€‰é¡¹ä¸­ï¼Œæˆ‘ä»¬è¿­ä»£åœ°å°†äº‹åŠ¡ä»çº§åˆ«1ç²¾ç®€åˆ°çº§åˆ«1åˆ°çº§åˆ«2ï¼Œä¾æ­¤ç±»æ¨ã€‚ <br><br> åˆ›å»ºä¸€ä¸ªè¡¨ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/*partition by list (STRIPE_ID) ( partition P01 values (1) , partition P02 values (2) , partition P03 values (3) , partition P04 values (4) , partition P05 values (5) , partition P06 values (6) , partition P07 values (7) , partition P08 values (8) , partition P09 values (9) , partition P10 values (10) )*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> nologging;</code> </pre><br> æ‚¨å¯ä»¥ä½¿ç”¨STRIPE_IDå­—æ®µæ¥åˆ›å»ºç´¢å¼•ï¼Œä½†æ˜¯é€šè¿‡å®éªŒå·²ç»ç¡®å®šï¼Œå¯¹äºæ²¡æœ‰ç´¢å¼•çš„1100ä¸‡ç¬”äº¤æ˜“ï¼Œå®ƒæ›´æœ‰åˆ©å¯å›¾ã€‚ å¯¹äºè¾ƒå¤§æ•°é‡ï¼Œæƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ æˆ–è€…ï¼Œæ‚¨å¯ä»¥é€šè¿‡å–æ¶ˆæ³¨é‡ŠæŸ¥è¯¢ä¸­çš„å—æ¥å¯¹è¡¨è¿›è¡Œåˆ†åŒºã€‚ <br><br> åˆ›å»ºä¸€ä¸ªè¿‡ç¨‹ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> THINNING_HABR_CALC_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rollback</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'truncate table QUOTES_CALC'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">--+ append into QUOTES_CALC select 1 as STRIPE_ID , STOCK_NAME , UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (APRICE * AVOLUME) , count (*) from TRANSACTIONS_RAW a group by STOCK_NAME, UT; commit; for i in 1..9 loop insert --+ append into QUOTES_CALC select --+ parallel(4) STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, i + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from QUOTES_CALC a where STRIPE_ID = i group by STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, i + 1); commit; end loop; end; /</span></span></code> </pre><br> ä¸ºäº†å¯¹ç§°ï¼Œè¯·åˆ›å»ºä¸€ä¸ªç®€å•çš„VIEWï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC;</code> </pre><br><h4> é€‰é¡¹3-CHINï¼ˆä¸­æ–‡ä»£ç ï¼‰ </h4><br> è¯¥æ–¹æ³•ä¸åŒäºè¯¥æ–¹æ³•çš„æ®‹é…·ç›´æˆªäº†å½“ï¼Œæ˜¯å¯¹â€œä¸è¦é‡å¤è‡ªå·±â€åŸåˆ™çš„æ‹’ç»ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‹’ç»å¾ªç¯ã€‚ <br><br> ä»…åœ¨å®Œæ•´æ€§æ–¹é¢æä¾›æ­¤é€‰é¡¹ã€‚ <br><br> å±•æœ›æœªæ¥ï¼Œæˆ‘è¦è¯´çš„æ˜¯ï¼Œåœ¨è¿™é¡¹ç‰¹å®šä»»åŠ¡çš„ç»©æ•ˆæ–¹é¢ï¼Œå®ƒä½å±…ç¬¬äºŒã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">å¤§è¦æ±‚</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CHIN_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T01 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) , T02 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T03 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T04 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T05 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T06 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T07 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T08 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T09 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T10 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T10;</code> </pre><br></div></div><br><h4> é€‰é¡¹4-UDAF </h4><br> æ­¤å¤„å°†ä¸æä¾›å¸¦æœ‰ç”¨æˆ·å®šä¹‰çš„èšåˆå‡½æ•°çš„é€‰é¡¹ï¼Œä½†å¯ä»¥åœ¨githubä¸ŠæŸ¥çœ‹ã€‚ <br><br><h4> é€‰é¡¹5-PPTFï¼ˆæµæ°´çº¿å’Œå¹¶è¡Œè¡¨åŠŸèƒ½ï¼‰ </h4><br> åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼ˆåœ¨åŒ…ä¸­ï¼‰ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TRANSACTION_RECORD_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> (STOCK_NAME varchar2(<span class="hljs-number"><span class="hljs-number">128</span></span>), UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, SEQ_NUM <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>); type CUR_RECORD_T is ref cursor return TRANSACTION_RECORD_T; type QUOTE_T is record (STRIPE_ID number, STOCK_NAME varchar2(128), UT number , AOPEN number, AHIGH number, ALOW number, ACLOSE number, AVOLUME number , AAMOUNT number, ACOUNT number); type QUOTE_LIST_T is table of QUOTE_T; function F (p_cursor CUR_RECORD_T) return QUOTE_LIST_T pipelined order p_cursor by (STOCK_NAME, UT, SEQ_NUM) parallel_enable (partition p_cursor by hash (STOCK_NAME)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; / <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> F (p_cursor CUR_RECORD_T) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QUOTE_LIST_T <span class="hljs-keyword"><span class="hljs-keyword">pipelined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (STOCK_NAME, UT, SEQ_NUM) <span class="hljs-keyword"><span class="hljs-keyword">parallel_enable</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> (STOCK_NAME)) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> QuoteTail QUOTE_LIST_T := QUOTE_LIST_T() ; rec TRANSACTION_RECORD_T; rec_prev TRANSACTION_RECORD_T; type ut_T is table of number index by pls_integer; ut number; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> QuoteTail.extend(<span class="hljs-number"><span class="hljs-number">10</span></span>); loop fetch p_cursor into rec; exit when p_cursor%notfound; if rec_prev.STOCK_NAME = rec.STOCK_NAME then if (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT &lt; rec_prev.UT) or (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT = rec_prev.UT and rec.SEQ_NUM &lt; rec_prev.SEQ_NUM) then raise_application_error (-20010, 'Rowset must be ordered, ('||rec_prev.STOCK_NAME||','||rec_prev.UT||','||rec_prev.SEQ_NUM||') &gt; ('||rec.STOCK_NAME||','||rec.UT||','||rec.SEQ_NUM||')'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.STOCK_NAME &lt;&gt; rec_prev.STOCK_NAME or rec_prev.STOCK_NAME is null then for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; for i in reverse 1..10 loop ut := TRUNC_UT (rec.UT, i); if QuoteTail(i).UT &lt;&gt; ut then for j in 1..i loop pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if QuoteTail(i).UT is null then QuoteTail(i).STRIPE_ID := i; QuoteTail(i).STOCK_NAME := rec.STOCK_NAME; QuoteTail(i).UT := ut; QuoteTail(i).AOPEN := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &lt; QuoteTail(i).ALOW or QuoteTail(i).ALOW is null then QuoteTail(i).ALOW := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &gt; QuoteTail(i).AHIGH or QuoteTail(i).AHIGH is null then QuoteTail(i).AHIGH := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; QuoteTail(i).AVOLUME := nvl (QuoteTail(i).AVOLUME, 0) + rec.AVOLUME; QuoteTail(i).AAMOUNT := nvl (QuoteTail(i).AAMOUNT, 0) + rec.AVOLUME * rec.APRICE; QuoteTail(i).ACOUNT := nvl (QuoteTail(i).ACOUNT, 0) + 1; QuoteTail(i).ACLOSE := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; rec_prev := rec; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; exception when no_data_needed then null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; /</code> </pre><br> åˆ›å»ºè§†å›¾ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_PPTF_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (THINNING_PPTF_P.F (<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW)));</code> </pre><br><h4> é€‰é¡¹6-MODEï¼ˆæ¨¡å‹å­å¥ï¼‰ </h4><br> è¯¥é€‰é¡¹ä½¿ç”¨å¸¦æœ‰çŸ­è¯­<i>ITERATE</i>çš„<i>MODEL</i>å­å¥çŸ­è¯­è¿­ä»£è®¡ç®—æ‰€æœ‰10ä¸ªçº§åˆ«çš„æŠ½å–ã€‚ <br><br> è¯¥é€‰é¡¹ä¹Ÿæ˜¯ä¸åˆ‡å®é™…çš„ï¼Œå› ä¸ºå®ƒå¾ˆæ…¢ã€‚ åœ¨æˆ‘çš„ç¯å¢ƒä¸­ï¼Œä¸€åˆ†é’Ÿå†…å°±è®¡ç®—å‡º8ç§å·¥å…·çš„1000ç¬”äº¤æ˜“ã€‚ å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨è®¡ç®—<i>MODEL</i>çŸ­è¯­ä¸Šã€‚ <br><br> åœ¨æ­¤ï¼Œæˆ‘ä»…å‡ºäºå®Œæ•´æ€§çš„ç›®çš„ç»™å‡ºæ­¤é€‰é¡¹ï¼Œå¹¶ç¡®è®¤ä»¥ä¸‹äº‹å®ï¼šåœ¨Oracleä¸Šï¼Œå‡ ä¹æ‰€æœ‰ä»»æ„å¤æ‚çš„è®¡ç®—éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªæŸ¥è¯¢æ‰§è¡Œï¼Œè€Œæ— éœ€ä½¿ç”¨PL / SQLã€‚ <br><br> è¯¥æŸ¥è¯¢ä¸­<i>MODEL</i>çŸ­è¯­çš„æ€§èƒ½ä½çš„åŸå› ä¹‹ä¸€æ˜¯ï¼Œå¯¹æˆ‘ä»¬æ‹¥æœ‰6æ¡çš„<i>æ¯ä¸ª</i>è§„åˆ™éƒ½æ‰§è¡Œäº†å³è¾¹çš„æœç´¢ã€‚å‰ä¸¤ä¸ªè§„åˆ™çš„è®¡ç®—éå¸¸å¿«ï¼Œå› ä¸ºæœ‰ç›´æ¥çš„æ˜¾å¼å¯»å€ï¼Œæ²¡æœ‰ç©ç¬‘è¯ã€‚ åœ¨å‰©ä½™çš„å››ä¸ªè§„åˆ™ä¸­ï¼Œæœ‰<i>ä»»ä½•</i>ä¸€ä¸ªè¯-è®¡ç®—é€Ÿåº¦è¾ƒæ…¢ã€‚ <br><br> ç¬¬äºŒä¸ªå›°éš¾æ˜¯æ‚¨å¿…é¡»è®¡ç®—å‚è€ƒæ¨¡å‹ã€‚ è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸º<b>åœ¨</b>è®¡ç®—<i>MODEL</i>çŸ­è¯­<b>ä¹‹å‰</b>å¿…é¡»çŸ¥é“ç»´åˆ—è¡¨ï¼Œæˆ‘ä»¬æ— æ³•åœ¨æ­¤çŸ­è¯­å†…è®¡ç®—æ–°ç»´ã€‚ ä¹Ÿè®¸å¯ä»¥å€ŸåŠ©ä¸¤ä¸ªMODELçŸ­è¯­æ¥è§„é¿æ­¤é—®é¢˜ï¼Œä½†æ˜¯ç”±äºå¤§é‡è§„åˆ™çš„æ€§èƒ½ä¸ä½³ï¼Œæˆ‘æ²¡æœ‰è¿™æ ·åšã€‚ <br><br> æˆ‘è¡¥å……è¯´ï¼Œæœ‰å¯èƒ½ä¸è®¡ç®—å‚è€ƒæ¨¡å‹ä¸­çš„<i>UT_OPEN</i>å’Œ<i>UT_CLOSE</i> ï¼Œè€Œæ˜¯ç›´æ¥åœ¨<i>MODEL</i>çŸ­è¯­ä¸­ä½¿ç”¨ç›¸åŒçš„å‡½æ•°<i>avgï¼ˆï¼‰keepï¼ˆdense_rank first / last order byï¼‰</i> ã€‚ ä½†è¿™ä¼šæ›´åŠ ç¼“æ…¢åœ°å‘ç”Ÿã€‚ <br> ç”±äºæ€§èƒ½é™åˆ¶ï¼Œæˆ‘ä¸ä¼šåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­åŒ…æ‹¬æ­¤é€‰é¡¹ã€‚ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-comment"><span class="hljs-comment">--       SOURCETRANS (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, TRUNC_UT (UT, 2), UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (AVOLUME * APRICE) , count (*) from TRANSACTIONS_RAW where ID &lt;= 1000 --       group by STOCK_NAME, UT) --   PARENT_UT, UT  2...10    UT_OPEN, UT_CLOSE --    , REFMOD (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, UT_OPEN, UT_CLOSE) as (select b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID) , min (TRUNC_UT (UT, b.STRIPE_ID - 1)) , max (TRUNC_UT (UT, b.STRIPE_ID - 1)) from SOURCETRANS a , (select rownum + 1 as STRIPE_ID from dual connect by level &lt;= 9) b group by b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID)) --        , MAINTAB as ( select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN , AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT, null, null from SOURCETRANS union all select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, null , null, null, null, null, null, null, UT_OPEN, UT_CLOSE from REFMOD) select STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from MAINTAB model return all rows --      2...10 reference RM on (select * from REFMOD) dimension by (STRIPE_ID, STOCK_NAME, UT) measures (UT_OPEN, UT_CLOSE) main MM partition by (STOCK_NAME) dimension by (STRIPE_ID, PARENT_UT, UT) measures (AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) rules iterate (9) ( AOPEN [iteration_number + 2, any, any] = AOPEN [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_OPEN [cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , ACLOSE [iteration_number + 2, any, any] = ACLOSE [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_CLOSE[cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , AHIGH [iteration_number + 2, any, any] = max (AHIGH)[cv (STRIPE_ID) - 1, cv (UT), any] , ALOW [iteration_number + 2, any, any] = min (ALOW)[cv (STRIPE_ID) - 1, cv (UT), any] , AVOLUME [iteration_number + 2, any, any] = sum (AVOLUME)[cv (STRIPE_ID) - 1, cv (UT), any] , AAMOUNT [iteration_number + 2, any, any] = sum (AAMOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] , ACOUNT [iteration_number + 2, any, any] = sum (ACOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] ) order by 1, 2, 3, 4;</span></span></code> </pre><br><h4> é€‰é¡¹6-IDEAï¼ˆç†æƒ³ï¼Œç†æƒ³ä½†ä¸èµ·ä½œç”¨ï¼‰ </h4><br> ä»¥ä¸‹æ‰€è¿°çš„è¯·æ±‚å¯èƒ½æ˜¯æœ€æœ‰æ•ˆçš„ï¼Œå¹¶ä¸”æ¶ˆè€—çš„èµ„æºé‡ç­‰äºç†è®ºä¸Šçš„æœ€å°å€¼ã€‚ <br><br> ä½†æ˜¯Oracleå’ŒMS SQLéƒ½ä¸å…è®¸æ‚¨ä»¥è¿™ç§å½¢å¼ç¼–å†™æŸ¥è¯¢ã€‚ æˆ‘ç›¸ä¿¡è¿™æ˜¯ç”±æ ‡å‡†å†³å®šçš„ã€‚ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> QUOTES_S1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-comment"><span class="hljs-comment">-- where rownum &lt;= 100 group by STOCK_NAME, TRUNC_UT (UT, 1)) , T1 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from QUOTES_S1 union all select STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from T1 where STRIPE_ID &lt; 10 group by STRIPE_ID + 1, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + 1) ) select * from T1</span></span></code> </pre><br> æ­¤æŸ¥è¯¢å¯¹åº”äºOracleæ–‡æ¡£çš„ä»¥ä¸‹éƒ¨åˆ†ï¼š <br><br>  <i>å¦‚æœsubquery_factoring_clauseåœ¨å®šä¹‰å®ƒçš„å­æŸ¥è¯¢ä¸­å¼•ç”¨äº†å®ƒè‡ªå·±çš„query_nameï¼Œåˆ™å¯ä»¥è¯´subquery_factoring_clauseæ˜¯é€’å½’çš„ã€‚</i>  <i>é€’å½’subquery_factoring_clauseå¿…é¡»åŒ…å«ä¸¤ä¸ªæŸ¥è¯¢å—ï¼šç¬¬ä¸€ä¸ªæ˜¯é”šæˆå‘˜ï¼Œç¬¬äºŒä¸ªæ˜¯é€’å½’æˆå‘˜ã€‚</i>  <i>é”šæˆå‘˜å¿…é¡»å‡ºç°åœ¨é€’å½’æˆå‘˜ä¹‹å‰ï¼Œå¹¶ä¸”å®ƒä¸èƒ½å¼•ç”¨query_nameã€‚</i>  <i>é”šæˆå‘˜å¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªç”±é›†åˆè¿ç®—ç¬¦ç»„åˆçš„æŸ¥è¯¢å—ç»„æˆï¼šUNION ALLï¼ŒUNIONï¼ŒINTERSECTæˆ–MINUSã€‚</i>  <i>é€’å½’æˆå‘˜å¿…é¡»è·Ÿéšé”šæˆå‘˜ï¼Œå¹¶ä¸”å¿…é¡»åªå¼•ç”¨ä¸€æ¬¡query_nameã€‚</i>  <i>æ‚¨å¿…é¡»ä½¿ç”¨UNION ALL setè¿ç®—ç¬¦å°†é€’å½’æˆå‘˜ä¸é”šæˆå‘˜ç»“åˆåœ¨ä¸€èµ·ã€‚</i> <br><br> ä½†è¿™ä¸æ–‡æ¡£çš„ä»¥ä¸‹æ®µè½çŸ›ç›¾ï¼š <br><br>  <i>é€’å½’æˆå‘˜ä¸èƒ½åŒ…å«ä»¥ä¸‹ä»»ä½•å…ƒç´ ï¼š</i> <i><br></i>  <i>DISTINCTå…³é”®å­—æˆ–GROUP BYå­å¥</i> <i><br></i>  <i>èšåˆå‡½æ•°ã€‚</i>  <i>ä½†æ˜¯ï¼Œé€‰æ‹©åˆ—è¡¨ä¸­å…è®¸ä½¿ç”¨åˆ†æåŠŸèƒ½ã€‚</i> <br><br> å› æ­¤ï¼Œåœ¨é€’å½’æˆå‘˜ä¸­ï¼Œä¸å…è®¸è¿›è¡Œèšåˆå’Œåˆ†ç»„ã€‚ <br><br><h3> æµ‹è¯•ä¸­ </h3><br><br> è®©æˆ‘ä»¬é¦–å…ˆä¸º<b>Oracle</b>åšå®ƒã€‚ <br><br> æ‰§è¡ŒCALCæ–¹æ³•çš„è®¡ç®—è¿‡ç¨‹ï¼Œå¹¶è®°å½•å…¶æ‰§è¡Œæ—¶é—´ï¼š <br><br><pre> <code class="sql hljs">exec THINNING_HABR_CALC_T</code> </pre> <br> å››ç§æ–¹æ³•çš„è®¡ç®—ç»“æœåœ¨å››ä¸ªè§†å›¾ä¸­ï¼š <br><br><ul><li>  THINNING_HABR_SIMP_Vï¼ˆå°†æ‰§è¡Œè®¡ç®—ï¼Œå¯¼è‡´å¤æ‚çš„SELECTï¼Œå› æ­¤å°†éœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰ï¼Œ </li><li>  THINNING_HABR_CALC_Vï¼ˆå°†æ˜¾ç¤ºQUOTES_CALCè¡¨ä¸­çš„æ•°æ®ï¼Œå› æ­¤å°†å¿«é€Ÿæ‰§è¡Œï¼‰ </li><li>  THINNING_HABR_CHIN_Vï¼ˆè¿˜å°†æ‰§è¡Œè®¡ç®—ï¼Œå¯¼è‡´å¤æ‚çš„SELECTï¼Œå› æ­¤å°†éœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰ï¼Œ </li><li>  THINNING_HABR_PPTF_Vï¼ˆå°†æ‰§è¡ŒåŠŸèƒ½THINNING_HABR_PPTFï¼‰ã€‚ </li></ul><br> æˆ‘å·²ç»æµ‹é‡äº†æ‰€æœ‰æ–¹æ³•çš„äº¤è´§æ—¶é—´ï¼Œå¹¶åœ¨æ–‡ç« æœ«å°¾çš„è¡¨æ ¼ä¸­ç»™å‡ºäº†äº¤è´§æ—¶é—´ã€‚ <br><br> å¯¹äºå…¶ä½™çš„VIEWï¼Œæˆ‘ä»¬æ‰§è¡Œè¯·æ±‚å¹¶å†™å‡ºæ‰§è¡Œæ—¶é—´ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre><br> å…¶ä¸­XXXXæ˜¯SIMPï¼ŒCHINï¼ŒPPTFã€‚ <br><br> è¿™äº›VIEWè®¡ç®—æ‹›è˜æ‘˜è¦ã€‚ è¦è®¡ç®—æ‘˜è¦ï¼Œæ‚¨éœ€è¦è·å–æ‰€æœ‰è¡Œï¼Œå¹¶ä½¿ç”¨æ‘˜è¦å¯ä»¥å°†é›†åˆç›¸äº’æ¯”è¾ƒã€‚ <br><br> æ‚¨è¿˜å¯ä»¥ä½¿ç”¨dbms_sqlhashè½¯ä»¶åŒ…æ¯”è¾ƒé›†ï¼Œä½†è¿™è¦æ…¢å¾—å¤šï¼Œå› ä¸ºæ‚¨éœ€è¦å¯¹åŸå§‹é›†è¿›è¡Œæ’åºï¼Œå¹¶ä¸”å“ˆå¸Œè®¡ç®—å¹¶ä¸å¿«ã€‚ <br> åŒæ ·åœ¨12cä¸­ï¼Œæœ‰ä¸€ä¸ªåŒ…DBMS_COMPARISONã€‚ <br><br> æ‚¨å¯ä»¥åŒæ—¶æ£€æŸ¥æ‰€æœ‰ç®—æ³•çš„æ­£ç¡®æ€§ã€‚ æˆ‘ä»¬è®¤ä¸ºæ‘˜è¦æ˜¯è¿™æ ·çš„è¯·æ±‚ï¼ˆåœ¨è™šæ‹Ÿæœºä¸­æœ‰11Mæ¡ç›®ï¼Œè¿™å°†ç›¸å¯¹è¾ƒé•¿ï¼Œå¤§çº¦15åˆ†é’Ÿï¼‰ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CHIN'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CHIN_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br> æˆ‘ä»¬çœ‹åˆ°æ‘˜è¦æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤æ‰€æœ‰ç®—æ³•ç»™å‡ºçš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚ <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬å°†åœ¨<b>MS SQLä¸­</b>é‡ç°æ‰€æœ‰ç›¸åŒå†…å®¹ã€‚ æˆ‘åœ¨2016ç‰ˆä¸Šè¿›è¡Œäº†æµ‹è¯•ã€‚ <br><br> é¦–å…ˆåˆ›å»ºDBTESTæ•°æ®åº“ï¼Œç„¶ååœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªäº‹åŠ¡è¡¨ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> );</code> </pre><br> ä¸‹è½½ä¸‹è½½çš„æ•°æ®ã€‚ <br><br> åœ¨MSSQLä¸­ï¼Œåˆ›å»ºæ–‡ä»¶format_mssql.bcpï¼š <br><br><pre> <code class="sql hljs">12.0 3 1 SQLCHAR 0 0 "," 3 UT "" 2 SQLCHAR 0 0 "," 4 APRICE "" 3 SQLCHAR 0 0 "\n" 5 AVOLUME ""</code> </pre><br> å¹¶åœ¨SSMSä¸­è¿è¡ŒLoadData-MSSQL.sqlè„šæœ¬ï¼ˆæ­¤è„šæœ¬ç”±æœ¬æ–‡éƒ¨åˆ†ä¸­é’ˆå¯¹Oracleçš„å”¯ä¸€Powershellè„šæœ¬ç”Ÿæˆï¼‰ã€‚ <br><br> è®©æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªå‡½æ•°ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, @p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> @p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span> * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">14400</span></span> * <span class="hljs-number"><span class="hljs-number">14400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span> * <span class="hljs-number"><span class="hljs-number">86400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(m, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (m, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(yy, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (yy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(s, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æˆ‘ä»¬ç»§ç»­æ‰§è¡Œè¿™äº›é€‰é¡¹ï¼š </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é€‰é¡¹1-SIMP </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è¿è¡Œï¼š </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) , T2 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , dbo.TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW, T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, dbo.TRUNC_UT (UT, STRIPE_ID)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.STRIPE_ID, t.STOCK_NAME, t.UT, t_op.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN, t.AHIGH , t.ALOW, t_cl.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T2 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.ID);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¼ºå°‘çš„</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬ä¸€ä¸ª/æœ€åä¸€ä¸ª</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŠŸèƒ½æ˜¯</font><font style="vertical-align: inherit;">é€šè¿‡åŒè¡¨è‡ªè¿æ¥å®ç°çš„ã€‚</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é€‰é¡¹2-CALC </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åˆ›å»ºä¸€ä¸ªè¡¨ï¼Œè¿‡ç¨‹å’Œè§†å›¾ï¼š </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dbo.QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> dbo.THINNING_HABR_CALC <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">truncate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @StripeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_ID , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.APRICE, t.AHIGH, t.ALOW, t_cl.APRICE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_ID = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_ID = t_cl.ID); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = <span class="hljs-number"><span class="hljs-number">1</span></span>; while (@StripeId &lt;= 9) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.AOPEN, t.AHIGH, t.ALOW, t_cl.ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT = t_op.UT) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT = t_cl.UT) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t_op.STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t_cl.STRIPE_ID = @StripeId; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.QUOTES_CALC; go</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æˆ‘æ²¡æœ‰åœ¨MS SQLä¸Šå®ç°é€‰é¡¹3ï¼ˆCHINï¼‰å’Œ4ï¼ˆUDAFï¼‰ã€‚ </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é€‰é¡¹5-PPTF </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ›å»ºä¸€ä¸ªè¡¨å‡½æ•°å¹¶æŸ¥çœ‹ã€‚</font><font style="vertical-align: inherit;">è¯¥å‡½æ•°åªæ˜¯ä¸€ä¸ªè¡¨å‡½æ•°ï¼Œè€Œä¸æ˜¯å¹¶è¡Œç®¡é“è¡¨å‡½æ•°ï¼Œåªæ˜¯è¯¥é€‰é¡¹ä¿ç•™äº†Oracleçš„å†å²åç§°ï¼š</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> dbo.THINNING_HABR_PPTF () <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> @rettab <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @i tinyint; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tut <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @QuoteTail <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> clustered , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> fast_forward <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- THIS ORDERING (STOCK_NAME, UT, ID) IS MANDATORY open c; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; while @@fetch_status = 0 begin if @trans_STOCK_NAME &lt;&gt; @trans_prev_STOCK_NAME or @trans_prev_STOCK_NAME is null begin insert into @rettab select * from @QuoteTail; delete @QuoteTail; end; set @i = 10; while @i &gt;= 1 begin set @tut = dbo.TRUNC_UT (@trans_UT, @i); if @tut &lt;&gt; (select UT from @QuoteTail where STRIPE_ID = @i) begin insert into @rettab select * from @QuoteTail where STRIPE_ID &lt;= @i; delete @QuoteTail where STRIPE_ID &lt;= @i; end; if (select count (*) from @QuoteTail where STRIPE_ID = @i) = 0 begin insert into @QuoteTail (STRIPE_ID, STOCK_NAME, UT, AOPEN, AVOLUME, AAMOUNT, ACOUNT) values (@i, @trans_STOCK_NAME, @tut, @trans_APRICE, 0, 0, 0); end; update @QuoteTail set AHIGH = case when AHIGH &lt; @trans_APRICE or AHIGH is null then @trans_APRICE else AHIGH end , ALOW = case when ALOW &gt; @trans_APRICE or ALOW is null then @trans_APRICE else ALOW end , ACLOSE = @trans_APRICE, AVOLUME = AVOLUME + @trans_AVOLUME , AAMOUNT = AAMOUNT + @trans_APRICE * @trans_AVOLUME , ACOUNT = ACOUNT + 1 where STRIPE_ID = @i; set @i = @i - 1; end; set @trans_prev_STOCK_NAME = @trans_STOCK_NAME; set @trans_prev_UT = @trans_UT; set @trans_prev_ID = @trans_ID; set @trans_prev_APRICE = @trans_APRICE; set @trans_prev_AVOLUME = @trans_AVOLUME; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; end; close c; deallocate c; insert into @rettab select * from @QuoteTail; return; end go create or alter view dbo.THINNING_HABR_PPTF_V as select * from dbo.THINNING_HABR_PPTF ();</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è®©æˆ‘ä»¬ä¸ºCALCæ–¹æ³•è®¡ç®—QUOTES_CALCè¡¨å¹¶å†™å‡ºæ‰§è¡Œæ—¶é—´ï¼š </font></font><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> exec dbo.THINNING_HABR_CALC</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è¿™ä¸‰ç§æ–¹æ³•çš„è®¡ç®—ç»“æœåœ¨ä»¥ä¸‹ä¸‰ä¸ªè§†å›¾ä¸­ï¼š </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_SIMP_Vï¼ˆå°†æ‰§è¡Œè®¡ç®—ï¼Œå¯¼è‡´å¤æ‚çš„SELECTï¼Œå› æ­¤å°†éœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰ï¼Œ </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_CALC_Vï¼ˆå°†æ˜¾ç¤ºQUOTES_CALCè¡¨ä¸­çš„æ•°æ®ï¼Œå› æ­¤å°†å¿«é€Ÿæ‰§è¡Œï¼‰ </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> THINNING_HABR_PPTF_Vï¼ˆå°†æ‰§è¡ŒåŠŸèƒ½THINNING_HABR_PPTFï¼‰ã€‚ </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å¯¹äºä¸¤ä¸ªVIEWï¼Œæˆ‘ä»¬æ‰§è¡Œè¯·æ±‚å¹¶å†™å‡ºæ‰§è¡Œæ—¶é—´ï¼š </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…¶ä¸­XXXXæ˜¯SIMPï¼ŒPPTFã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæ‚¨å¯ä»¥æ¯”è¾ƒMS SQLçš„ä¸‰ç§æ–¹æ³•çš„è®¡ç®—ç»“æœã€‚</font><font style="vertical-align: inherit;">å¯ä»¥åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­å®Œæˆã€‚</font><font style="vertical-align: inherit;">è¿è¡Œï¼š</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœä¸‰è¡Œåœ¨æ‰€æœ‰å­—æ®µä¸Šé‡åˆï¼Œåˆ™ä½¿ç”¨è¿™ä¸‰ç§æ–¹æ³•çš„è®¡ç®—ç»“æœå°†ç›¸åŒã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘å¼ºçƒˆå»ºè®®æ‚¨åœ¨æµ‹è¯•é˜¶æ®µä½¿ç”¨å°‘é‡é€‰æ‹©ï¼Œå› ä¸ºæ­¤ä»»åŠ¡åœ¨MS SQLä¸­çš„æ€§èƒ½è¾ƒä½ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœåªæœ‰MS SQLå¼•æ“å¹¶ä¸”è¦è®¡ç®—å¤§é‡æ•°æ®ï¼Œåˆ™å¯ä»¥å°è¯•ä»¥ä¸‹ä¼˜åŒ–æ–¹æ³•ï¼šå¯ä»¥åˆ›å»ºç´¢å¼•ï¼š</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> TRANSACTIONS_RAW_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> TRANSACTIONS_RAW (STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> QUOTES_CALC_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> åœ¨æˆ‘çš„è™šæ‹Ÿæœºä¸Šæµ‹é‡æ€§èƒ½çš„ç»“æœå¦‚ä¸‹ï¼š </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ss/4s/7x/ss4s7xhwteedzj1qgsjmb20hvvw.png" alt="å›¾ç‰‡"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯ä»¥ä»</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸‹è½½è„šæœ¬</font><font style="vertical-align: inherit;">ï¼šOracleï¼ŒTHINNINGæ–¹æ¡ˆ-æœ¬æ–‡çš„è„šæœ¬ï¼ŒTHINNING_LIVEæ–¹æ¡ˆ- </font><font style="vertical-align: inherit;">ä»bitcoincharts.com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨çº¿ä¸‹è½½</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®å¹¶</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨çº¿</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç²¾ç®€</font><font style="vertical-align: inherit;">ï¼ˆä½†è¯¥ç«™ç‚¹ä»…ä»¥åœ¨çº¿æ¨¡å¼</font><font style="vertical-align: inherit;">å‘é€</font><font style="vertical-align: inherit;">æœ€è¿‘5å¤©çš„æ•°æ®ï¼‰ï¼Œä»¥åŠè¯¥è„šæœ¬è¿™ç¯‡æ–‡ç« ä¹Ÿé€‚ç”¨äºMS SQLã€‚</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“è®ºï¼š</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯¥ä»»åŠ¡åœ¨Oracleä¸Šæ¯”åœ¨MS SQLä¸Šè§£å†³å¾—æ›´å¿«ã€‚éšç€äº¤æ˜“æ•°é‡çš„å¢åŠ ï¼Œå·®è·å˜å¾—è¶Šæ¥è¶Šå¤§ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨Oracleä¸Šï¼ŒPPTFæ˜¯æœ€ä½³é€‰æ‹©ã€‚åœ¨è¿™é‡Œï¼Œç¨‹åºåŒ–æ–¹æ³•è¢«è¯æ˜æ›´æœ‰åˆ©å¯å›¾ï¼Œè¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿã€‚å…¶ä»–æ–¹æ³•ä¹Ÿæ˜¾ç¤ºäº†å¯æ¥å—çš„ç»“æœ-æˆ‘ä»€è‡³åœ¨è™šæ‹Ÿæœºä¸­æµ‹è¯•äº†367Mäº‹åŠ¡çš„æ•°é‡ï¼ˆPPTFæ–¹æ³•è®¡ç®—äº†ä¸€ä¸ªåŠå°æ—¶çš„é—´éš”æ—¶é—´ï¼‰ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨MS SQLä¸Šï¼Œè¿­ä»£è®¡ç®—æ–¹æ³•ï¼ˆCALCï¼‰è¯æ˜æ˜¯æœ€æœ‰æ•ˆçš„ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆOracleä¸Šçš„PPTFæ–¹æ³•æœ€ç»ˆæˆä¸ºé¢†å¯¼è€…ï¼Ÿ</font><font style="vertical-align: inherit;">ç”±äºå¹¶å‘æ€§å’Œä½“ç³»ç»“æ„ï¼Œåœ¨æŸ¥è¯¢è®¡åˆ’çš„ä¸­é—´åµŒå…¥äº†ä¸€ä¸ªä½œä¸ºå¹¶è¡Œç®¡é“è¡¨å‡½æ•°åˆ›å»ºçš„å‡½æ•°ï¼š</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/ss/nl/zassnleqabvacrdkxnumjhd5mky.png" alt="å›¾ç‰‡"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN418757/">https://habr.com/ru/post/zh-CN418757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN418743/index.html">MLæ–°å…µè®­ç»ƒè¥VIçš„ç¬¬ä¸€åæ•…äº‹</a></li>
<li><a href="../zh-CN418747/index.html">è§£å†³é—®é¢˜ï¼šå¦‚ä½•æœ‰æ•ˆåœ°è§£å†³å›¢é˜Ÿä¸­çš„é—®é¢˜ï¼Ÿ</a></li>
<li><a href="../zh-CN418751/index.html">æ•æ·çš„æ— ç¤¼ä¸­å›½é—´è°</a></li>
<li><a href="../zh-CN418753/index.html">VMware Cloudä¸­çš„vSAN</a></li>
<li><a href="../zh-CN418755/index.html">ç”µå­å•†åŠ¡å¦‚ä½•åœ¨å¤§è§„æ¨¡ä¿ƒé”€ä¸­ç”Ÿå­˜ã€‚ ä¸ºç½‘ç»œä¸Šçš„å³°å€¼è´Ÿè½½åšå¥½å‡†å¤‡[ç¬¬1éƒ¨åˆ†]</a></li>
<li><a href="../zh-CN418759/index.html">ä¸€ä¸ªå­¦ç”Ÿå‘è¡ŒèŠ¯ç‰‡è¦èŠ±å¤šå°‘é’±ï¼Ÿ</a></li>
<li><a href="../zh-CN418761/index.html">ã€Šçº¯Pythonã€‚ ä¸“ä¸šäººå£«ç¼–ç¨‹çš„ç²¾å¦™ä¹‹å¤„Â»</a></li>
<li><a href="../zh-CN418763/index.html">ä¸­é«˜çº§ï¼šå¦‚ä½•æ‘†è„±æ²¼æ³½ï¼Ÿ</a></li>
<li><a href="../zh-CN418765/index.html">Dadataæç¤ºå¯å¸®åŠ©æ‚¨å¡«å†™ä»»ä½•è¾“å…¥è¡¨æ ¼ã€‚ ç°åœ¨heæ„ˆ</a></li>
<li><a href="../zh-CN418767/index.html">Adobe Flashçš„å·¨å¤§æ¸¸æˆé—äº§ä»¥åŠæˆ‘å¯¹å…¶è¿›è¡Œä¿å­˜çš„å°è¯•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>