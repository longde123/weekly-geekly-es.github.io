<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯШ┤ ЁЯЩЖЁЯП╗ ЁЯзХЁЯП╜ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬ рдЗрди рдЧреЛ рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдХрд╛рдо рдХрд░реЗрдВ: рдкреНрд░рдерд╛рдУрдВ, рд╕реБрд╡рд┐рдзрд╛рдУрдВ, рдмрд╛рд░реАрдХрд┐рдпреЛрдВ тЫ╡я╕П ЁЯСиЁЯП╝тАНЁЯТ╝ ЁЯЫМ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд╕рдВрдмрдВрдз рдореЗрдВ рдЖрд╡реЗрджрди рдХрд╛ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░ рдбреАрдмреАрдП рдФрд░ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЗ рдмреАрдЪ рдпреБрджреНрдз рдХреА рдУрд░ рдЬрд╛рддрд╛ рд╣реИ: рдбреАрдмреАрдП рдЪрд┐рд▓реНрд▓рд╛рддрд╛ рд╣реИ: "рдЖрдкрдХрд╛ рдЖрд╡реЗрджрди рдбреЗрдЯрд╛рдмреЗрд╕...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬ рдЗрди рдЧреЛ рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдХрд╛рдо рдХрд░реЗрдВ: рдкреНрд░рдерд╛рдУрдВ, рд╕реБрд╡рд┐рдзрд╛рдУрдВ, рдмрд╛рд░реАрдХрд┐рдпреЛрдВ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/461935/"><p><img src="https://habrastorage.org/webt/yg/8e/hm/yg8ehmpmicsm7ye6fwju6kwog14.png"></p><br><p>  рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд╕рдВрдмрдВрдз рдореЗрдВ рдЖрд╡реЗрджрди рдХрд╛ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░ рдбреАрдмреАрдП рдФрд░ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЗ рдмреАрдЪ рдпреБрджреНрдз рдХреА рдУрд░ рдЬрд╛рддрд╛ рд╣реИ: рдбреАрдмреАрдП рдЪрд┐рд▓реНрд▓рд╛рддрд╛ рд╣реИ: "рдЖрдкрдХрд╛ рдЖрд╡реЗрджрди рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рдЧрд┐рд░рд╛ рджреЗрддрд╛ рд╣реИ", рдбреЗрд╡рд▓рдкрд░реНрд╕ - "рд▓реЗрдХрд┐рди рд╕рдм рдХреБрдЫ рдкрд╣рд▓реЗ рдХрд╛рдо рдХрд┐рдпрд╛ рд╣реИ!"  рд╕рдмрд╕реЗ рдмреБрд░реА рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдбреАрдмреАрдП рдФрд░ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдПрдХ-рджреВрд╕рд░реЗ рдХреА рдорджрдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: рдХреБрдЫ рдХреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдмрд╛рд░реАрдХрд┐рдпреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдирд╣реАрдВ рдкрддрд╛ рд╣реИ, рджреВрд╕рд░реЛрдВ рдХреЛ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдирд╣реАрдВ рдкрддрд╛ рд╣реИред  рдРрд╕реА рд╕реНрдерд┐рддрд┐ рд╕реЗ рдмрдЪрдирд╛ рдЕрдЪреНрдЫрд╛ рд╣реЛрдЧрд╛ред </p><br><p>  рдЖрдкрдХреЛ рд╕рдордЭрдирд╛ рд╣реЛрдЧрд╛, рдпрд╣ рдЕрдХреНрд╕рд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">go-database-sql.org рдХреЗ</a> рдорд╛рдзреНрдпрдо рд╕реЗ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИред  рдЕрдкрдиреЗ рдЖрдк рдХреЛ рдЕрдиреНрдп рд▓реЛрдЧреЛрдВ рдХреЗ рдЕрдиреБрднрд╡ рдХреЗ рд╕рд╛рде рдмрд╛рдВрдЯрдирд╛ рдмреЗрд╣рддрд░ рд╣реИред  рдЗрд╕рд╕реЗ рднреА рдмреЗрд╣рддрд░ рдЕрдЧрд░ рдпрд╣ рд░рдХреНрдд рдФрд░ рдЦреЛрдП рд╣реБрдП рдкреИрд╕реЗ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЕрдиреБрднрд╡ рд╣реИред </p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Uojy57I-xP0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  рдореЗрд░рд╛ рдирд╛рдо <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд░рд╛рдпрдмрд┐рдиреНрдХреЛрд╡ рдЖрд░реНрдЯреЗрдо рд╣реИ</a> рдФрд░ рдпрд╣ рд▓реЗрдЦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рдВрддрд╛ рд╣рд╛рдИрд▓рд╛рдб</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">2019</a> рд╕рдореНрдореЗрд▓рди рд╕реЗ рдореЗрд░реА рд░рд┐рдкреЛрд░реНрдЯ рдХреА рдПрдХ рдореБрдХреНрдд рд╡реНрдпрд╛рдЦреНрдпрд╛ рд╣реИред </p><br><h1 id="instrumenty">  рдЙрдкрдХрд░рдг </h1><br><p>  рдЖрдк <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЧреЛ-</a> database-sql.org рдкрд░ рдХрд┐рд╕реА рднреА SQL рдЬреИрд╕реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдиреНрдпреВрдирддрдо рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред  рдпрджрд┐ рдЖрдкрдиреЗ рдЗрд╕реЗ рдирд╣реАрдВ рдкрдврд╝рд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рдкрдврд╝реЗрдВред </p><br><h2 id="sqlx">  sqlx </h2><br><p>  рдореЗрд░реА рд░рд╛рдп рдореЗрдВ, рдЧреЛ рдХреА рд╢рдХреНрддрд┐ рд╕рд░рд▓рддрд╛ рд╣реИред  рдФрд░ рдпрд╣ рд╡реНрдпрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЗрд╕рдореЗрдВ рдЧреЛ рдЯреВ рдирдВрдЧреЗ рдПрд╕рдХреНрдпреВрдПрд▓ рдореЗрдВ рдкреНрд░рд╢реНрди рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдерд╛рдЧрдд рд╣реИ (ORM рд╕рдореНрдорд╛рди рдореЗрдВ рдирд╣реАрдВ рд╣реИ)ред  рдпрд╣ рдПрдХ рдлрд╛рдпрджрд╛ рдФрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрдард┐рдирд╛рдЗрдпреЛрдВ рдХрд╛ рд╕реНрд░реЛрдд рд╣реИред </p><br><p> рдЗрд╕рд▓рд┐рдП, рдорд╛рдирдХ <code>database/sql</code> рднрд╛рд╖рд╛ рдкреИрдХреЗрдЬ рд▓реЗрддреЗ рд╣реБрдП, рдЖрдк рдЗрд╕рдХреЗ рдЗрдВрдЯрд░рдлреЗрд╕ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗред  рдПрдХ рдмрд╛рд░ рдРрд╕рд╛ рд╣реЛрдиреЗ рдкрд░, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">github.com/jmoiron/sqlx</a> рдкрд░ рдПрдХ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВред  рдореИрдВ рдЖрдкрдХреЛ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рддрд╛ рд╣реВрдВ рдХрд┐ рдпрд╣ рд╡рд┐рд╕реНрддрд╛рд░ рдЖрдкрдХреЗ рдЬреАрд╡рди рдХреЛ рдХреИрд╕реЗ рд╕рд░рд▓ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕реНрдЯреНрд░рдХреНрдЪрд░реНрд╕рд╕реНрдХреИрди</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рд╕реНрддрдВрднреЛрдВ рд╕реЗ рд╕рдВрд░рдЪрдирд╛ рдЧреБрдгреЛрдВ рдореЗрдВ рдбреЗрдЯрд╛ рдХреЛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддреА рд╣реИред </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Place <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Country <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> City sql.NullString TelephoneCode <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`db:"telcode"`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p Place err = rows.StructScan(&amp;p)</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">NamedQuery</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдЖрдк рдХрд┐рд╕реА рдХреНрд╡реЗрд░реА рдореЗрдВ рдкреНрд▓реЗрд╕рд╣реЛрд▓реНрдбрд░ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрд░рдЪрдирд╛ рдЧреБрдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><pre> <code class="go hljs">p := Place{Country: <span class="hljs-string"><span class="hljs-string">"South Africa"</span></span>} sql := <span class="hljs-string"><span class="hljs-string">`.. WHERE country=:country`</span></span> rows, err := db.NamedQuery(sql, p)</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЧреЗрдЯ</a> рдФрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕реЗрд▓реЗрдХреНрдЯ</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдЖрдк рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рд▓рд╛рдЗрдиреЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЫреЛрд░реЛрдВ рдХреЛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд▓рд┐рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╕реЗ рдЫреБрдЯрдХрд╛рд░рд╛ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p Place <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pp []Place <span class="hljs-comment"><span class="hljs-comment">// Get   p     err = db.Get(&amp;p, ".. LIMIT 1") // Select   pp   . err = db.Select(&amp;pp, ".. WHERE telcode &gt; ?", 50)</span></span></code> </pre> <br><h1 id="drayvery">  рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ </h1><br><p>  <code>database/sql</code> рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрдВрдЯрд░рдлреЗрд╕ рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╣реИ, рдФрд░ <code>sqlx</code> рдЙрдирдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рд╣реИред  рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрди рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЗ рд▓рд┐рдП, рдЙрдиреНрд╣реЗрдВ рдПрдХ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдбреНрд░рд╛рдЗрд╡рд░ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИрдВред </p><br><p>  рд╕рдмрд╕реЗ рд▓реЛрдХрдкреНрд░рд┐рдп рдбреНрд░рд╛рдЗрд╡рд░: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">github.com/lib/pq</a> - <code>pure Go Postgres driver for database/sql.</code>  рдпрд╣ рдбреНрд░рд╛рдЗрд╡рд░ рд▓рдВрдмреЗ рд╕рдордп рд╕реЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рдирдХ рдмрдирд╛ рд╣реБрдЖ рд╣реИред  рд▓реЗрдХрд┐рди рдЖрдЬ рдпрд╣ рдЕрдкрдиреА рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХрддрд╛ рдЦреЛ рдЪреБрдХрд╛ рд╣реИ рдФрд░ рд▓реЗрдЦрдХ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рдХрд╕рд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">github.com/jackc/pgx</a> - <code>PostgreSQL driver and toolkit for Go.</code>  рдЖрдЬ рдЗрд╕ рдЙрдкрдХрд░рдг рдХреЛ рдЪреБрдирдирд╛ рдмреЗрд╣рддрд░ рд╣реИред </li></ul><br><p>  <strong>github.com/jackc/pgx</strong> - рдпрд╣ рд╡рд╣ рдбреНрд░рд╛рдЗрд╡рд░ рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред  рдХреНрдпреЛрдВ? </p><br><ul><li>  рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ <strong>рд╕рдорд░реНрдерд┐рдд рдФрд░ рд╡рд┐рдХрд╕рд┐рдд</strong> ред </li><li>  рдпрджрд┐ <code>database/sql</code> рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЗ рдмрд┐рдирд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдпрд╣ рдЕрдзрд┐рдХ <strong>рдЙрддреНрдкрд╛рджрдХ</strong> рд╣реЛ рд╕рдХрддрд╛ рд╣реИред </li><li>  <strong>60</strong> рд╕реЗ <strong>рдЕрдзрд┐рдХ рдкреНрд░рдХрд╛рд░ рдХреЗ PostgreSQL рдХреЗ</strong> рд▓рд┐рдП рд╕рдорд░реНрдерди рдЬреЛ <code>SQL</code> рдорд╛рдирдХ рдХреЗ рдмрд╛рд╣рд░ <code>PostgreSQL</code> рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред </li><li>  рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдЕрдВрджрд░ рдХреНрдпрд╛ рд╣реЛ рд░рд╣рд╛ рд╣реИ, рдЗрд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ рд▓рд╛рдЧреВ <strong>рдХрд░рдиреЗ</strong> рдХреА рдХреНрд╖рдорддрд╛ред </li><li>  <code>pgx</code> <strong>рдорд╛рдирд╡-рдкрдардиреАрдп рддреНрд░реБрдЯрд┐рдпрд╛рдВ рд╣реИрдВ</strong> , рдЬрдмрдХрд┐ рд╕рд┐рд░реНрдл <code>lib/pq</code> рдкреИрдирд┐рдХ рдЕрдЯреИрдХ рдХрд░рддрд╛ рд╣реИред  рдпрджрд┐ рдЖрдк рдПрдХ рдЖрддрдВрдХ рдирд╣реАрдВ рдкрдХрдбрд╝рддреЗ рд╣реИрдВ, рддреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреНрд░реИрд╢ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред  ( <em>рдЖрдкрдХреЛ рдЧреЛ рдореЗрдВ рдЖрддрдВрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдпрд╣ рдЕрдкрд╡рд╛рдж рдХреЗ рд╕рдорд╛рди рдирд╣реАрдВ рд╣реИред</em> ) </li><li>  <code>pgx</code> рд╕рд╛рде, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ <strong>рдкреНрд░рддреНрдпреЗрдХ рдХрдиреЗрдХреНрд╢рди</strong> рдХреЛ рд╕реНрд╡рддрдВрддреНрд░ рд░реВрдк рд╕реЗ <strong>рдХреЙрдиреНрдлрд╝рд┐рдЧрд░</strong> рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИред </li><li>  <code>PostgreSQL</code> <strong>рддрд╛рд░реНрдХрд┐рдХ рдкреНрд░рддрд┐рдХреГрддрд┐ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рд▓рд┐рдП</strong> рд╕рдорд░реНрдерди <strong>рд╣реИ</strong> ред </li></ul><br><h2 id="4kb">  4KB </h2><br><p>  рдЖрдорддреМрд░ рдкрд░, рд╣рдо рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕ рд▓реВрдк рдХреЛ рд▓рд┐рдЦрддреЗ рд╣реИрдВ: </p><br><pre> <code class="go hljs">rows, err := s.db.QueryContext(ctx, sql) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() { err = rows.Scan(...) }</code> </pre> <br><p>  рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдЕрдВрджрд░, рд╣рдореЗрдВ <strong>рдПрдХ 4KB рдмрдлрд░</strong> рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд░рдХреЗ рдбреЗрдЯрд╛ рдорд┐рд▓рддрд╛ рд╣реИред  <code>rows.Next()</code> рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдпрд╛рддреНрд░рд╛ рдХреЛ рдЬрдиреНрдо рджреЗрддреА рд╣реИ рдФрд░ рдмрдлрд░ рдХреЛ рднрд░рддреА рд╣реИред  рдпрджрд┐ рдмрдлрд░ рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИ, рддреЛ рд╣рдо рд╢реЗрд╖ рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдЬрд╛рддреЗ рд╣реИрдВред  рдЕрдзрд┐рдХ рдиреЗрдЯрд╡рд░реНрдХ рдХрд╛ рджреМрд░рд╛ - рдХрдо рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдЧрддрд┐ред  рджреВрд╕рд░реА рдУрд░, рдЪреВрдВрдХрд┐ рдмрдлрд░ рд╕реАрдорд╛ 4KB рд╣реИ, рдЪрд▓реЛ рдкреВрд░реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдореЛрд░реА рдХреЛ рдирд╣реАрдВ рднреВрд▓рдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><p>  рд▓реЗрдХрд┐рди, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдореИрдВ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдХрдо рдХрд░рдиреЗ рдФрд░ рд╣рдорд╛рд░реА рд╕реЗрд╡рд╛ рдХреА рд╡рд┐рд▓рдВрдмрддрд╛ рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдлрд░ рд╡реЙрд▓реНрдпреВрдо рдХреЛ рдЕрдзрд┐рдХрддрдо рддрдХ рдкрд╣реБрдВрдЪрд╛рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВред  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣рдо</a> рдЗрд╕ рдЕрд╡рд╕рд░ рдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреЛрдбрд╝рддреЗ</a> рд╣реИрдВ рдФрд░ <a href="">рд╕рд┐рдВрдереЗрдЯрд┐рдХ рдкрд░реАрдХреНрд╖рдгреЛрдВ</a> рдкрд░ рдЕрдкреЗрдХреНрд╖рд┐рдд рддреНрд╡рд░рдг рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">$ go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -v -run=XXX -bench=. -benchmem goos: linux goarch: amd64 pkg: github.com/furdarius/pgxexperiments/bufsize BenchmarkBufferSize/4KB 5 315763978 ns/op 53112832 B/op 12967 allocs/op BenchmarkBufferSize/8KB 5 300140961 ns/op 53082521 B/op 6479 allocs/op BenchmarkBufferSize/16KB 5 298477972 ns/op 52910489 B/op 3229 allocs/op BenchmarkBufferSize/1MB 5 299602670 ns/op 52848230 B/op 50 allocs/op PASS ok github.com/furdarius/pgxexperiments/bufsize 10.964s</code> </pre> <br><p>  рдпрд╣ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЧрддрд┐ рдореЗрдВ рдХреЛрдИ рдмрдбрд╝рд╛ рдЕрдВрддрд░ рдирд╣реАрдВ рд╣реИред  рдРрд╕рд╛ рдХреНрдпреЛрдВ? </p><br><p>  рдпрд╣ рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ рдХрд┐ рд╣рдо рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬ рдХреЗ рдЕрдВрджрд░ рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдмрдлрд░ рдХреЗ рдЖрдХрд╛рд░ рддрдХ рд╕реАрдорд┐рдд рд╣реИрдВред  рдЗрд╕ рдмрдлрд╝рд░ рдХрд╛ рдЖрдХрд╛рд░ <strong>8KB рд╣реИ</strong> ред  <code>strace</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП <code>strace</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ</a> рдХрд┐ рдУрдПрд╕ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд░реАрдб</a> рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдореЗрдВ <code>8192</code> рдмрд╛рдЗрдЯ рджреЗрддрд╛ рд╣реИред  рдФрд░ <code>tcpdump</code> рдкреИрдХреЗрдЯ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХреЗ</a> рдЖрдХрд╛рд░ рдХреЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рд╛рде рдЗрд╕рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рддрд╛</a> рд╣реИред </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЯреЙрдо рд▓реЗрди</a> ( <em>рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬ рдХрд░реНрдиреЗрд▓ рдХреЗ рдореБрдЦреНрдп рдбреЗрд╡рд▓рдкрд░реНрд╕ рдореЗрдВ рд╕реЗ рдПрдХ</em> ) рдЗрд╕ рддрд░рд╣ рд╕реЗ <a href="">рдЯрд┐рдкреНрдкрдгреА рдХрд░рддрд╛ рд╣реИ</a> : </p><br><blockquote>  рдкрд░рдВрдкрд░рд╛рдЧрдд рд░реВрдк рд╕реЗ, рдХрдо рд╕реЗ рдХрдо, рдпрд╣ рдпреВрдирд┐рдХреНрд╕ рдорд╢реАрдиреЛрдВ рдореЗрдВ рдкрд╛рдЗрдк рдмрдлрд╝рд░реНрд╕ рдХреЗ рдЖрдХрд╛рд░ рдХрд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ рдпрд╣ рдпреВрдирд┐рдХреНрд╕ рд╕реЙрдХреЗрдЯ рдореЗрдВ рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЗрд╖реНрдЯрддрдо рдЪрдВрдХ рдЖрдХрд╛рд░ рд╣реИред </blockquote><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрдВрдбреНрд░реЗрд╕ рдлреНрд░реБрдВрдб</a> ( <em>рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬрдбреАрдмреА рд╕реЗ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬреБрдПрдЯ рдбреЗрд╡рд▓рдкрд░</em> ) <a href="">рдХрд╛ рдорд╛рдирдирд╛ тАЛтАЛрд╣реИ</a> рдХрд┐ 8KB рдмрдлрд░ рдЖрдЬ рддрдХ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╡рд┐рдХрд▓реНрдк рдирд╣реАрдВ рд╣реИ, рдФрд░ рдЖрдкрдХреЛ рд╡рд┐рднрд┐рдиреНрди рдЖрдХрд╛рд░реЛрдВ рдкрд░ рдФрд░ рдПрдХ рдЕрд▓рдЧ рд╕реЙрдХреЗрдЯ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p>  рд╣рдореЗрдВ рдпрд╣ рднреА рдпрд╛рдж рд░рдЦрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ PgBouncer рдореЗрдВ рдПрдХ рдмрдлрд░ рднреА рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЖрдХрд╛рд░ <code>pkt_buf</code> рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><h2 id="oids">  OIDs </h2><br><p>  Pgx ( <em>v3</em> ) рдбреНрд░рд╛рдЗрд╡рд░ рдХреА рдПрдХ рдФрд░ рд╡рд┐рд╢реЗрд╖рддрд╛: рдкреНрд░рддреНрдпреЗрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП, рдпрд╣ <strong>рдСрдмреНрдЬреЗрдХреНрдЯ рдЖрдИрдбреА</strong> ( <em>OID</em> ) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдЗрди рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЖрдВрддрд░рд┐рдХ рд╡рд╕реНрддреБрдУрдВ рдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░реВрдк рд╕реЗ рдкрд╣рдЪрд╛рдирдиреЗ рдХреЗ</a> рд▓рд┐рдП рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛: рдкрдВрдХреНрддрд┐рдпрд╛рдБ, рдЯреЗрдмрд▓, рдлрд╝рдВрдХреНрд╢рдВрд╕ рдЗрддреНрдпрд╛рджрд┐ред </p><br><p>  рдбреНрд░рд╛рдЗрд╡рд░ рдбреЗрдЯрд╛ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рд╕ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЙрд▓рдо рдореЗрдВ рднрд╛рд╖рд╛ рдХреЛ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП <code>OIDs</code> рдЬреНрдЮрд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рд▓рд┐рдП, <code>pgx</code> рдРрд╕реА рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ ( <em>рдХреБрдВрдЬреА рдкреНрд░рдХрд╛рд░ рдирд╛рдо рд╣реИ, рдорд╛рди рдСрдмреНрдЬреЗрдХреНрдЯ рдЖрдИрдбреА рд╣реИ</em> ) </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]Value{ <span class="hljs-string"><span class="hljs-string">"_aclitem"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"_bool"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"_int4"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"_int8"</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, ... }</code> </pre> <br><p>  рдпрд╣ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЗрд╕ рддрдереНрдп рдХреА рдУрд░ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рд╛рде рдкреНрд░рддреНрдпреЗрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдбреНрд░рд╛рдЗрд╡рд░ <code>Object ID</code> рд╕рд╛рде рддрд╛рд▓рд┐рдХрд╛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рдЧрднрдЧ рддреАрди рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред  рдбреЗрдЯрд╛рдмреЗрд╕ рдФрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рдореЛрдб рдореЗрдВ, рдЧреЛ рдореЗрдВ рдХрдиреЗрдХреНрд╢рди рдкреВрд▓ рдЖрдкрдХреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдирдП рдХрдиреЗрдХреНрд╢рди рдЙрддреНрдкрдиреНрди рдирд╣реАрдВ рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рдереЛрдбрд╝реА рдЧрд┐рд░рд╛рд╡рдЯ рдкрд░, рдЖрд╡реЗрджрди рдкрдХреНрд╖ рдкрд░ рдХрдиреЗрдХреНрд╢рди рдХрд╛ рдкреВрд▓ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдкреНрд░рддрд┐ рдпреВрдирд┐рдЯ рд╕рдордп рдкрд░ рдЙрддреНрдкрдиреНрди рдХрдиреЗрдХреНрд╢рди рдХреА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдХрд╛рдлреА рд╡реГрджреНрдзрд┐ рд╣реЛрддреА рд╣реИред  <code>OIDs</code> рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд╛рдлреА рднрд╛рд░реА рд╣реИрдВ, рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдЪрд╛рд▓рдХ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд▓рд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><p>  рдпрд╣рд╛рдВ рд╡рд╣ рдХреНрд╖рдг рд╣реИ рдЬрдм рдЗрд╕ рддрд░рд╣ рдХреЗ рдЕрдиреБрд░реЛрдз рд╣рдорд╛рд░реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╕реЗ рдПрдХ рдкрд░ рдбрд╛рд▓реЗ рдЧрдП рдереЗ: </p><br><p><img src="https://habrastorage.org/webt/lm/ra/vb/lmravbubtqb2ah8dvbvvpklbz8m.png"></p><br><p>  рд╕рд╛рдорд╛рдиреНрдп рдореЛрдб рдореЗрдВ <strong>рдкреНрд░рддрд┐ рдорд┐рдирдЯ 15 рд▓реЗрдирджреЗрди</strong> , рдЧрд┐рд░рд╛рд╡рдЯ рдХреЗ рджреМрд░рд╛рди <strong>6500 рддрдХ рдХрд╛ рд▓реЗрдирджреЗрди</strong> ред </p><br><p>  <strong>рдХреНрдпрд╛ рдХрд░реЗрдВ?</strong> </p><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рдФрд░ рд╕рдмрд╕реЗ рдКрдкрд░, рдЕрдкрдиреЗ рдкреВрд▓ рдХреЗ рдЖрдХрд╛рд░ рдХреЛ рдКрдкрд░ рд╕реЗ рд╕реАрдорд┐рдд рдХрд░реЗрдВред </p><br><p>  <code>database/sql</code> рдпрд╣ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">DB.SetMaxOpenConns</a> рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдпрджрд┐ рдЖрдк <code>database/sql</code> рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЛ рдЫреЛрдбрд╝ рджреЗрддреЗ рд╣реИрдВ рдФрд░ <code>pgx.ConnPool</code> ( <em>рдбреНрд░рд╛рдЗрд╡рд░ рджреНрд╡рд╛рд░рд╛ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдХрдиреЗрдХреНрд╢рди рдкреВрд▓</em> ) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк <code>MaxConnections</code> рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ ( <em>рдбрд┐рдлрд╝реЙрд▓реНрдЯ 5 рд╣реИ</em> )ред </p><br><p>  рд╡реИрд╕реЗ, <code>pgx.ConnPool</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ <code>pgx.ConnPool</code> рдЪрд╛рд▓рдХ рдкреНрд░рд╛рдкреНрдд <code>pgx.ConnPool</code> рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХрд╛ рдкреБрди: рдЙрдкрдпреЛрдЧ</a> рдХрд░реЗрдЧрд╛ рдФрд░ рд╣рд░ рдирдП рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдкреНрд░рд╢реНрди рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред </p><br><p>  рдпрджрд┐ рдЖрдк <code>database/sql</code> рдХреЛ рдордирд╛ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рд╕реНрд╡рдпрдВ <code>OIDs</code> рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдХреИрд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><pre> <code class="go hljs">github.com/jackc/pgx/stdlib.OpenDB(pgx.ConnConfig{ CustomConnInfo: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *pgx.Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*pgtype.ConnInfo, error)</span></span></span></span> { cachedOids = <span class="hljs-comment"><span class="hljs-comment">//  OIDs   . info := pgtype.NewConnInfo() info.InitializeDataTypes(cachedOids) return info, nil } })</span></span></code> </pre> <br><p>  рдпрд╣ рдПрдХ рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХрд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░рдирд╛ рджреЛ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЦрддрд░рдирд╛рдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ: </p><br><ul><li>  рдЖрдк Postgres рдореЗрдВ Enum рдпрд╛ рдбреЛрдореЗрди рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ; </li><li>  рдпрджрд┐ рд╡рд┐рдЬрд╝рд╛рд░реНрдб рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдк рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдкреНрд░рддрд┐рдХреГрддрд┐ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕реЗ рддрд╛рд░реНрдХрд┐рдХ рдкреНрд░рддрд┐рдХреГрддрд┐ рджреНрд╡рд╛рд░рд╛ рдбрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИред </li></ul><br><p>  рдЗрди рд╢рд░реНрддреЛрдВ рдХреЗ рдкреВрд░рд╛ рд╣реЛрдиреЗ рд╕реЗ рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдХреИрд╢реНрдб <code>OIDs</code> рдЕрдорд╛рдиреНрдп рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред  рд▓реЗрдХрд┐рди рд╣рдо рдЙрдиреНрд╣реЗрдВ рд╕рд╛рдл рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдВрдЧреЗ, рдХреНрдпреЛрдВрдХрд┐ рд╣рдо рдирдП рдЖрдзрд╛рд░ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рдХреНрд╖рдг рдХреЛ рдирд╣реАрдВ рдЬрд╛рдирддреЗ рд╣реИрдВред </p><br><p>  <code>Postgres</code> рджреБрдирд┐рдпрд╛ рдореЗрдВ, рднреМрддрд┐рдХ рдкреНрд░рддрд┐рдХреГрддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЖрдорддреМрд░ рдкрд░ рдЙрдЪреНрдЪ рдЙрдкрд▓рдмреНрдзрддрд╛ рдХреЛ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЛ рдереЛрдбрд╝рд╛-рдереЛрдбрд╝рд╛ рдХрд░рдХреЗ рдХреЙрдкреА рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП <code>OIDs</code> рдХреИрд╢рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╕рдорд╕реНрдпрд╛рдПрдВ рд╢рд╛рдпрдж рд╣реА рдХрднреА рдЬрдВрдЧрд▓реА рдореЗрдВ рджреЗрдЦреА рдЬрд╛рддреА рд╣реИрдВред  ( <em>рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ DBA рдХреЗ рд╕рд╛рде рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рдмреЗрд╣рддрд░ рд╣реИ рдХрд┐ рдЖрдкрдХреЗ рд▓рд┐рдП рдХрд┐рддрдирд╛ рд╕реНрдЯреИрдВрдбрдмрд╛рдп рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ</em> )ред </p><br><p>  <code>pgx</code> рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдЕрдЧрд▓реЗ рдкреНрд░рдореБрдЦ рд╕рдВрд╕реНрдХрд░рдг - <code>v4</code> , <code>pgx</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓рд┐рдП рдХреЛрдИ</a> рдЕрднрд┐рдпрд╛рди <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдирд╣реАрдВ рд╣реЛрдЧрд╛</a> ред  рдЕрдм рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗрд╡рд▓ <code>OIDs</code> рдХреА рд╕реВрдЪреА рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░реЗрдЧрд╛ рдЬреЛ рдХреЛрдб рдореЗрдВ <code>OIDs</code> рд╣реИрдВред  рдХрд╕реНрдЯрдо рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрдХреНрд╖ рдкрд░ рдбреАрд╕реЗрд░рд▓рд╛рдЗрдЬрд╝реЗрд╢рди рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА: рдбреНрд░рд╛рдЗрд╡рд░ рдмрд╕ рдмрд╛рдЗрдЯреНрд╕ рдХреА рдПрдХ рд╕рд░рдгреА рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдореГрддрд┐ рдХрд╛ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рдЫреЛрдбрд╝ рджреЗрдЧрд╛ред </p><br><h1 id="logirovanie-i-monitoring">  рд▓реЙрдЧрд┐рдВрдЧ рдФрд░ рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ </h1><br><p>  рдЖрдзрд╛рд░ рдХреНрд░реИрд╢ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдирд┐рдЧрд░рд╛рдиреА рдФрд░ рд▓реЙрдЧрд┐рдВрдЧ рд╕реЗ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рдиреЛрдЯрд┐рд╕ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓реЗрдЧреАред </p><br><p>  <code>database/sql</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">DB.Stats ()</a> рд╡рд┐рдзрд┐ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред  рд▓реМрдЯрд╛ рд╣реБрдЖ рд╕реНрдЯреЗрдЯрд╕ рд╕реНрдиреИрдкрд╢реЙрдЯ рдЖрдкрдХреЛ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдЕрдВрджрд░ рдХреНрдпрд╛ рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рдЗрд╕рдХрд╛ рдЕрдВрджрд╛рдЬрд╛ рд▓рдЧрд╛рдПрдЧрд╛ред </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> DBStats <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { MaxOpenConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-comment"><span class="hljs-comment">// Pool State OpenConnections int InUse int Idle int // Counters WaitCount int64 WaitDuration time.Duration MaxIdleClosed int64 MaxLifetimeClosed int64 }</span></span></code> </pre> <br><p>  рдпрджрд┐ рдЖрдк рд╕реАрдзреЗ <code>pgx</code> рдореЗрдВ рдкреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">ConnPool.Stat ()</a> рд╡рд┐рдзрд┐ рдЖрдкрдХреЛ рдЗрд╕реА рддрд░рд╣ рдХреА рдЬрд╛рдирдХрд╛рд░реА рджреЗрдЧреА: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ConnPoolStat <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { MaxConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CurrentConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> AvailableConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> }</code> </pre> <br><p>  рд▓реЙрдЧрд┐рдВрдЧ рд╕рдорд╛рди рд░реВрдк рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ, рдФрд░ <code>pgx</code> рдЖрдкрдХреЛ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рдбреНрд░рд╛рдЗрд╡рд░ <code>Logger</code> рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рд╕реЗ, рдЖрдкрдХреЛ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдЕрдВрджрд░ рд╣реЛрдиреЗ рд╡рд╛рд▓реА рд╕рднреА рдШрдЯрдирд╛рдПрдВ рдорд┐рд▓рддреА рд╣реИрдВред </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Logger <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Log a message at the given level with data key/value pairs. // data may be nil. Log(level LogLevel, msg string, data map[string]interface{}) }</span></span></code> </pre> <br><p>  рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ, рдЖрдкрдХреЛ рдЗрд╕ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рд╕реНрд╡рдпрдВ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред  рдмреЙрдХреНрд╕ рдХреЗ рдмрд╛рд╣рд░ <code>pgx</code> рдореЗрдВ рд╕рдмрд╕реЗ рд▓реЛрдХрдкреНрд░рд┐рдп рд▓реЙрдЧрд░ рдХреЗ рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрдбреЗрдкреНрдЯрд░</a> рдХрд╛ рдПрдХ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕реЗрдЯ рд╣реИ</a> , рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">uber-go /</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">zap</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">sirupsen / logrus</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">rs / zerolog</a> ред </p><br><h1 id="infrastruktura">  рдЖрдзрд╛рд░рднреВрдд рд╕рдВрд░рдЪрдирд╛ </h1><br><p>  рд▓рдЧрднрдЧ рд╣рдореЗрд╢рд╛ <code>Postgres</code> рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп рдЖрдк <strong>рдХрдиреЗрдХреНрд╢рди рдкреВрд▓рд░ рдХрд╛</strong> рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ, рдФрд░ рдпрд╣ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">PgBouncer</a> ( <em>рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдУрдбрд┐рд╕реА</a> - рдпрджрд┐ рдЖрдк</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╛рдВрдбреЗрдХреНрд╕</a> <em>рд╣реИрдВ</em> )ред </p><br><p>  рдРрд╕рд╛ рдХреНрдпреЛрдВ, рдЖрдк рдЙрддреНрдХреГрд╖реНрдЯ рд▓реЗрдЦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">brandur.org/postgres-connections</a> рдореЗрдВ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред  рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдЬрдм рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ <strong>100 рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛ рдЬрд╛рддреА рд╣реИ, рддреЛ</strong> рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдЕрдиреБрд░реЛрдзреЛрдВ <strong>рдХреА</strong> рдЧрддрд┐ рдХрдо рд╣реЛрдиреЗ рд▓рдЧрддреА рд╣реИред  рдпрд╣ рд╕реНрд╡рдпрдВ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬ рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреА рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рдХрд╛рд░рдг рд╣реЛрддрд╛ рд╣реИ: рдкреНрд░рддреНрдпреЗрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╢реБрднрд╛рд░рдВрдн, рд╕реНрдиреИрдкрд╢реЙрдЯ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рддрдВрддреНрд░ рдФрд░ рдмрд╛рддрдЪреАрдд рдХреЗ рд▓рд┐рдП рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ - рдпрд╣ рд╕рдм рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдпрд╣рд╛рдБ рд╡рд┐рднрд┐рдиреНрди рдХрдиреЗрдХреНрд╢рди рдкреВрд▓рд░ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХрд╛ рдмреЗрдВрдЪрдорд╛рд░реНрдХ рд╣реИ</a> : <br><img src="https://habrastorage.org/webt/im/p1/-n/imp1-nuasdxn1wmve7l89rrvmbw.png"></p><br><p>  рдФрд░ PgBouncer рдХреЗ рд╕рд╛рде рдФрд░ рдмрд┐рдирд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдмреЗрдВрдЪрдорд╛рд░реНрдХ</a> рдмреИрдВрдбрд╡рд┐рдбреНрдеред </p><br><p><img src="https://habrastorage.org/webt/jc/cp/21/jccp2150oefyeiixeu005lpsl_0.png"></p><br><p>  рдирддреАрдЬрддрди, рдЖрдкрдХрд╛ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪрд╛ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦреЗрдЧрд╛: </p><br><p><img src="https://habrastorage.org/webt/bf/ee/ok/bfeeokt_cdojbuddo7_rhzddjis.png"></p><br><p>  рдЬрд╣рд╛рдВ <code>Server</code> рд╡рд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реИ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЕрдиреБрд░реЛрдз рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИред  рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ 3 рдкреНрд░рддрд┐рдпреЛрдВ ( <em>рдХрдо рд╕реЗ рдХрдо</em> ) рдореЗрдВ <code>kubernetes</code> рдореЗрдВ рдШреВрдорддреА рд╣реИред  рдЕрд▓рдЧ рд╕реЗ, рдПрдХ рд▓реЛрд╣реЗ рдХреЗ рд╕рд░реНрд╡рд░ рдкрд░, <code>Postgres</code> , рдЬрд┐рд╕реЗ <code>PgBouncer'</code> рджреНрд╡рд╛рд░рд╛ рдХрд╡рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  <code>PgBouncer</code> рд╕реНрд╡рдпрдВ рд╕рд┐рдВрдЧрд▓-рдереНрд░реЗрдбреЗрдб рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдХрдИ рдмрд╛рдЙрдВрд╕рд░ рд▓реЙрдиреНрдЪ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рд╣рдо <code>HAProxy</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рд╕рдВрддреБрд▓рд┐рдд рдХрд░рддреЗ рд╣реИрдВред  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рд╣рдореЗрдВ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдХреНрд╡реЗрд░реА рдирд┐рд╖реНрдкрд╛рджрди рдХреА рдРрд╕реА рд╢реНрд░реГрдВрдЦрд▓рд╛ рдорд┐рд▓рддреА рд╣реИ: <code>   тЖТ HAProxy тЖТ PgBouncer тЖТ Postgres</code> ред </p><br><p>  <code>PgBouncer</code> рддреАрди рдореЛрдб рдореЗрдВ рдХрд╛рдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ: </p><br><ul><li>  <strong>рд╕рддреНрд░ рдкреВрд▓рд┐рдВрдЧ</strong> - рдкреНрд░рддреНрдпреЗрдХ рд╕рддреНрд░ рдХреЗ рд▓рд┐рдП, рдПрдХ рдХрдиреЗрдХреНрд╢рди рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдкреВрд░реЗ рдЬреАрд╡рди рд╕рдордп рдХреЗ рд▓рд┐рдП рд╕реМрдВрдкрд╛ рдЬрд╛рддрд╛ рд╣реИред </li><li>  <strong>рд▓реЗрди-</strong> рджреЗрди рдЪрд▓ рд░рд╣рд╛ рд╣реИ - <strong>рд▓реЗрди-рджреЗрди рдкреВрд▓рд┐рдВрдЧ</strong> - рдХрдиреЗрдХреНрд╢рди рд░рд╣рддрд╛ рд╣реИред  рдЬреИрд╕реЗ рд╣реА рд▓реЗрди-рджреЗрди рдкреВрд░рд╛ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, <code>PgBouncer</code> рдЗрд╕ рдХрдиреЗрдХреНрд╢рди рдХреЛ рд▓реЗрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рджреВрд╕рд░реЗ рд▓реЗрдирджреЗрди рдХреЛ рд╡рд╛рдкрд╕ рджреЗрддрд╛ рд╣реИред  рдпрд╣ рдореЛрдб рдпреМрдЧрд┐рдХреЛрдВ рдХреЗ рдмрд╣реБрдд рдЕрдЪреНрдЫреЗ рдирд┐рдкрдЯрд╛рди рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред </li><li>  <strong>рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдкреВрд▓рд┐рдВрдЧ</strong> - <strong>рдкрджрд╛рд╡рдирдд</strong> рдореЛрдбред  рдпрд╣ рдХреЗрд╡рд▓ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкреАрдПрд▓ / рдкреНрд░реЙрдХреНрд╕реА</a> рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ред </li></ul><br><p>  рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдореЛрдб рдореЗрдВ рдХреНрдпрд╛ рдЧреБрдг рдЙрдкрд▓рдмреНрдз рд╣реИрдВред  рд╣рдо <strong>Transaction Pooling</strong> рдЪреБрдирддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЗрд╕рдореЗрдВ <code>Prepared Statements</code> рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреА рд╕реАрдорд╛рдПрдБ рд╣реИрдВред </p><br><h2 id="transaction-pooling--prepared-statements">  рд▓реЗрди-рджреЗрди рдкреВрд▓рд┐рдВрдЧ + рддреИрдпрд╛рд░ рдХрдерди </h2><br><p>  рдЖрдЗрдП рдХрд▓реНрдкрдирд╛ рдХрд░реЗрдВ рдХрд┐ рд╣рдо рдПрдХ рдЕрдиреБрд░реЛрдз рддреИрдпрд╛рд░ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдЙрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВред  рдХреБрдЫ рдмрд┐рдВрджреБ рдкрд░, рд╣рдо рдПрдХ рд▓реЗрдирджреЗрди рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рд╣рдо рдПрдХ рддреИрдпрд╛рд░ рдЕрдиреБрд░реЛрдз рднреЗрдЬрддреЗ рд╣реИрдВ, рдФрд░ рд╣рдореЗрдВ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рддреИрдпрд╛рд░ рдЕрдиреБрд░реЛрдз рдХреА рдЖрдИрдбреА рдорд┐рд▓рддреА рд╣реИред </p><br><p><img src="https://habrastorage.org/webt/pb/tu/bq/pbtubqa7cvmly0ntnhs0dwc9etc.png"></p><br><p>  рдмрд╛рдж рдореЗрдВ, рдХрд┐рд╕реА рдЕрдиреНрдп рд╕рдордп рдореЗрдВ, рд╣рдо рдПрдХ рдФрд░ рд▓реЗрдирджреЗрди рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реИрдВред  рдЗрд╕рдореЗрдВ, рд╣рдо рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рдУрд░ рдореБрдбрд╝рддреЗ рд╣реИрдВ рдФрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд╕рд╛рде рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдиреБрд░реЛрдз рдХреЛ рдкреВрд░рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред </p><br><p><img src="https://habrastorage.org/webt/uy/ci/h4/uycih4iuh8aasw43aqodbsxolac.png"></p><br><p>  <strong>рд▓реЗрди-рджреЗрди рдкреВрд▓рд┐рдВрдЧ</strong> рдореЛрдб рдореЗрдВ, рджреЛ рд▓реЗрди-рджреЗрди рдЕрд▓рдЧ-рдЕрд▓рдЧ рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди <strong>рд╕реНрдЯреЗрдЯрдореЗрдВрдЯ рдЖрдИрдбреА</strong> рдХреЗрд╡рд▓ рдПрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рднреАрддрд░ рдорд╛рдиреНрдп рд╣реИред  рдХрд┐рд╕реА рдЕрдиреБрд░реЛрдз рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╕рдордп рд╣рдореЗрдВ рдПрдХ <code>prepared statement does not exist</code> ред </p><br><p>  рд╕рдмрд╕реЗ рдЕрдкреНрд░рд┐рдп: рдЪреВрдВрдХрд┐ рд╡рд┐рдХрд╛рд╕ рдФрд░ рдкрд░реАрдХреНрд╖рдг рдХреЗ рджреМрд░рд╛рди рд▓реЛрдб рдЫреЛрдЯрд╛ рд╣реИ, <code>PgBouncer</code> рдЕрдХреНрд╕рд░ рдПрдХ рд╣реА рдХрдиреЗрдХреНрд╢рди рдЬрд╛рд░реА рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рдм рдХреБрдЫ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдЬреИрд╕реЗ рд╣реА рд╣рдо рдареЗрд╕ рдкрд╣реБрдВрдЪрддреЗ рд╣реИрдВ, рдЕрдиреБрд░реЛрдз рдПрдХ рддреНрд░реБрдЯрд┐ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реИрдВред </p><br><p>  рдЕрдм рдЗрд╕ рдХреЛрдб рдореЗрдВ <code>Prepared Statements</code> рдЦреЛрдЬреЗрдВ: </p><br><pre> <code class="go hljs">sql := <span class="hljs-string"><span class="hljs-string">`select * from places where city = ?`</span></span> rows, err := s.db.Query(sql, city)</code> </pre> <br><p>  рдЖрдк рдЙрд╕реЗ рдирд╣реАрдВ рджреЗрдЦреЗрдВрдЧреЗ!  рдХреНрд╡реЗрд░реА рддреИрдпрд╛рд░реА рдЕрд╡реНрдпрд╡рд╕реНрдерд┐рдд рд░реВрдк рд╕реЗ <code>Query()</code> рдЕрдВрджрд░ рд╣реЛрдЧреАред  рдЙрд╕реА рд╕рдордп, рдЕрдиреБрд░реЛрдз рдХреА рддреИрдпрд╛рд░реА рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди рд╡рд┐рднрд┐рдиреНрди рд▓реЗрдирджреЗрди рдореЗрдВ рд╣реЛрдЧрд╛ рдФрд░ рд╣рдо рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЙрди рд╕рднреА рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗ рдЬреЛ рдореИрдВрдиреЗ рдКрдкрд░ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдерд╛ред </p><br><p>  <strong>рдХреНрдпрд╛ рдХрд░реЗрдВ?</strong> </p><br><p>  рдкрд╣рд▓рд╛, рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рд╡рд┐рдХрд▓реНрдк <strong><code>Session pooling</code> рд▓рд┐рдП <code>PgBouncer</code> рд╕реНрд╡рд┐рдЪ <code>PgBouncer</code> рд╣реИ</strong> ред  рдПрдХ рдХрдиреЗрдХреНрд╢рди рд╕рддреНрд░ рдХреЗ рд▓рд┐рдП рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╕рднреА рд▓реЗрдирджреЗрди рдЗрд╕ рд╕рдВрдмрдВрдз рдореЗрдВ рдЬрд╛рдиреЗ рд▓рдЧрддреЗ рд╣реИрдВ рдФрд░ рддреИрдпрд╛рд░ рдЕрдиреБрд░реЛрдз рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВред  рд▓реЗрдХрд┐рди рдЗрд╕ рдореЛрдб рдореЗрдВ, рдпреМрдЧрд┐рдХреЛрдВ рдХреЗ рдЙрдкрдпреЛрдЧ рдХреА рджрдХреНрд╖рддрд╛ рд╡рд╛рдВрдЫрд┐рдд рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдХреБрдЫ рдЫреЛрдбрд╝ рджреЗрддреА рд╣реИред  рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рд╡рд┐рдХрд▓реНрдк рдкрд░ рд╡рд┐рдЪрд╛рд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </p><br><p>  рджреВрд╕рд░рд╛ рд╡рд┐рдХрд▓реНрдк <strong>рдХреНрд▓рд╛рдЗрдВрдЯ рдкрдХреНрд╖ рдкрд░ рдПрдХ рдЕрдиреБрд░реЛрдз рддреИрдпрд╛рд░ рдХрд░рдирд╛ рд╣реИ</strong> ред  рдореИрдВ рджреЛ рдХрд╛рд░рдгреЛрдВ рд╕реЗ рдРрд╕рд╛ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛: </p><br><ul><li>  рд╕рдВрднрд╛рд╡рд┐рдд SQL рдХрдордЬреЛрд░рд┐рдпрд╛рдБред  рдбреЗрд╡рд▓рдкрд░ рднреВрд▓ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рдмрдЪ рд╕рдХрддрд╛ рд╣реИред </li><li>  рд╣рд░ рдмрд╛рд░ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд╣рд╛рдереЛрдВ рд╕реЗ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд╡реЗрд░реА рдорд╛рдкрджрдВрдбреЛрдВ рд╕реЗ рдмрдЪрдирд╛ рд╣реЛрдЧрд╛ред </li></ul><br><p>  рдПрдХ рдЕрдиреНрдп рд╡рд┐рдХрд▓реНрдк <strong>рд▓реЗрди-рджреЗрди рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдЕрдиреБрд░реЛрдз</strong> рдХреЛ <strong>рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд▓рдкреЗрдЯрдирд╛ рд╣реИ</strong> ред  рдЖрдЦрд┐рд░рдХрд╛рд░, рдЬрдм рддрдХ рд▓реЗрди-рджреЗрди рд░рд╣рддрд╛ рд╣реИ, <code>PgBouncer</code> рдХрдиреЗрдХреНрд╢рди рдирд╣реАрдВ <code>PgBouncer</code> рд╣реИред  рдпрд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди, рд╣рдорд╛рд░реЗ рдХреЛрдб рдореЗрдВ рд╡рд░реНрдмреЛрд╕рд┐рдЯреА рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╣рдореЗрдВ рдЕрдзрд┐рдХ рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрд▓ рднреА рдорд┐рд▓рддреЗ рд╣реИрдВ: рдЖрд░рдВрдн, рддреИрдпрд╛рд░, рдирд┐рд╖реНрдкрд╛рджрд┐рдд, рдкреНрд░рддрд┐рдмрджреНрдзред  рдкреНрд░рддрд┐ рдЕрдиреБрд░реЛрдз рдХреБрд▓ 4 рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрд▓ред  рд╡рд┐рд▓рдВрдмрддрд╛ рдмрдврд╝ рд░рд╣реА рд╣реИред </p><br><p>  рд▓реЗрдХрд┐рди рдореИрдВ рдЗрд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдФрд░ рдХреБрд╢рд▓рддрд╛ рд╕реЗ рдЪрд╛рд╣рддрд╛ рд╣реВрдВред  рдФрд░ рдРрд╕рд╛ рдПрдХ рд╡рд┐рдХрд▓реНрдк рд╣реИ!  рдЖрдк рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдмрддрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рд░рд▓ рдХреНрд╡реЗрд░реА</a> рдореЛрдб</strong> рдХрд╛ <strong>рдЙрдкрдпреЛрдЧ</strong> рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред  рдЗрд╕ рдореЛрдб рдореЗрдВ, рдХреЛрдИ рддреИрдпрд╛рд░реА рдирд╣реАрдВ рд╣реЛрдЧреА рдФрд░ рдкреВрд░рд╛ рдЕрдиреБрд░реЛрдз рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрд▓ рдореЗрдВ рдкрд╛рд╕ рд╣реЛрдЧрд╛ред  рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдореЗрдВ, рдЪрд╛рд▓рдХ рдкреНрд░рддреНрдпреЗрдХ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рд╕реНрд╡рдпрдВ рдмрдирд╛ рджреЗрдЧрд╛ ( <em><code>standard_conforming_strings</code> рдХреЛ рдмреЗрд╕ рд╕реНрддрд░ рдкрд░ рдпрд╛ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреЗ рд╕рдордп рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП</em> )ред </p><br><pre> <code class="go hljs">cfg := pgx.ConnConfig{ ... RuntimeParams: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"standard_conforming_strings"</span></span>: <span class="hljs-string"><span class="hljs-string">"on"</span></span>, }, PreferSimpleProtocol: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }</code> </pre> <br><h1 id="otmena-zaprosov">  рдЕрдиреБрд░реЛрдз рд░рджреНрдж рдХрд░реЗрдВ </h1><br><p>  рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореБрджреНрджреЗ рдЖрд╡реЗрджрди рдкрдХреНрд╖ рдореЗрдВ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд░рджреНрдж рдХрд░рдиреЗ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИрдВред </p><br><p>  рдЗрд╕ рдХреЛрдб рдкрд░ рдПрдХ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВред  рдиреБрдХрд╕рд╛рди рдХрд╣рд╛рдБ рд╣реИрдВ? </p><br><pre> <code class="go hljs">rows, err := s.db.QueryContext(ctx, ...)</code> </pre> <br><p>  рдЬрд╛рдУ рдХрд╛рд░реНрдпрдХреНрд░рдо рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдкреНрд░рд╡рд╛рд╣ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рдзрд┐ рд╣реИ - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рдВрджрд░реНрдн</a> ред <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рдВрджрд░реНрдн</a> ред  рдЗрд╕ рдХреЛрдб рдореЗрдВ, рд╣рдо рдбреНрд░рд╛рдЗрд╡рд░ <code>ctx</code> рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЬрдм рд╕рдВрджрд░реНрдн рдмрдВрдж рд╣реЛ рдЬрд╛рдП, рддреЛ рдбреНрд░рд╛рдЗрд╡рд░ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реНрддрд░ рдкрд░ рдЕрдиреБрд░реЛрдз рдХреЛ рд░рджреНрдж рдХрд░ рджреЗред </p><br><p>  рдЗрд╕реА рд╕рдордп, рдпрд╣ рдЙрдореНрдореАрдж рдХреА рдЬрд╛рддреА рд╣реИ рдХрд┐ рд╣рдо рдЙрди рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд░рджреНрдж рдХрд░рдХреЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдмрдЪрд╛рдПрдВрдЧреЗ рдЬрд┐рдирдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЗрдВрддрдЬрд╛рд░ рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдПрдХ рдЕрдиреБрд░реЛрдз рдХреЛ рд░рджреНрдж рдХрд░рддреЗ рд╕рдордп, <code>PgBouncer</code> рд╕рдВрд╕реНрдХрд░рдг <em>1.7</em> рдХрдиреЗрдХреНрд╢рди рдХреЛ рд╕реВрдЪрдирд╛ рднреЗрдЬрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдХрдиреЗрдХреНрд╢рди рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИ, рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рдЗрд╕реЗ рдкреВрд▓ рдореЗрдВ рд▓реМрдЯрд╛рддрд╛ рд╣реИред  <code>PgBouncer'</code> рдХрд╛ рдпрд╣ рд╡реНрдпрд╡рд╣рд╛рд░ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рдЧреБрдорд░рд╛рд╣ рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЬреЛ рдЕрдЧрд▓рд╛ рдЕрдиреБрд░реЛрдз рднреЗрдЬрдиреЗ рдкрд░ рддреБрд░рдВрдд рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ <code>ReadyForQuery</code> рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред  рдЕрдВрдд рдореЗрдВ, рд╣рдо <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд ReadyForQuery рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЛ рдкрдХрдбрд╝рддреЗ рд╣реИрдВ</a> ред </p><br><p>  <code>PgBouncer</code> рд╕рдВрд╕реНрдХрд░рдг <em>1.8 рд╕реЗ</em> рд╢реБрд░реВ рдХрд░рддреЗ <code>PgBouncer</code> <em>,</em> рдпрд╣ рд╡реНрдпрд╡рд╣рд╛рд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рддрдп</a> рдХрд┐рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЧрдпрд╛ рд╣реИ</a> ред  <code>PgBouncer</code> рдХреЗ рд╡рд░реНрддрдорд╛рди рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред </p><br><p>  рдФрд░, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рддреНрд░реБрдЯрд┐рдпрд╛рдВ рдЧрд╛рдпрдм рд╣реЛ рдЬрд╛рдПрдВрдЧреА - рджрд┐рд▓рдЪрд╕реНрдк рд╡реНрдпрд╡рд╣рд╛рд░ рдмрдирд╛ рд░рд╣реЗрдЧрд╛ред  рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рд╣рдорд╛рд░реЗ рдЖрд╡реЗрджрди рдХреЛ рдЗрд╕рдХреЗ рдЕрдиреБрд░реЛрдз рдХрд╛ рдЬрд╡рд╛рдм рдирд╣реАрдВ рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдкрдбрд╝реЛрд╕реА рдХреЛ (рдореБрдЦреНрдп рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдЕрдиреБрд░реЛрдз рдЕрдиреБрд░реЛрдз рдХрд┐рдП рдЧрдП рдбреЗрдЯрд╛ рдХреЗ рдкреНрд░рдХрд╛рд░ рдФрд░ рдЖрджреЗрд╢ рд╕реЗ рдореЗрд▓ рдЦрд╛рддреЗ рд╣реИрдВ)ред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЙрд╕ рдХреНрд╡реЗрд░реА рдХреЗ рд▓рд┐рдП <code>where user_id = 2</code> , рдЙрд╕ рдХреНрд╡реЗрд░реА рдХреА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ <code>where user_id = 42</code> рд╡рд╛рдкрд╕ рдЖрдПрдЧреАред  рдпрд╣ рд╡рд┐рднрд┐рдиреНрди рд╕реНрддрд░реЛрдВ рдкрд░ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд░рджреНрдж рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдХрд╛рд░рдг рд╣реИ: рдбреНрд░рд╛рдЗрд╡рд░ рдкреВрд▓ рдФрд░ рдмрд╛рдЙрдВрд╕рд░ рдкреВрд▓ рдХреЗ рд╕реНрддрд░ рдкрд░ред </p><br><h3 id="otlozhennaya-otmena">  рд╡рд┐рд▓рдВрдмрд┐рдд рд░рджреНрджреАрдХрд░рдг </h3><br><p>  рдЕрдиреБрд░реЛрдз рдХреЛ рд░рджреНрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ рдХрдиреЗрдХреНрд╢рди рдмрдирд╛рдиреЗ рдФрд░ рд░рджреНрдж рдХрд░рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  <code>Postgres</code> рдкреНрд░рддреНрдпреЗрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдмрдирд╛рддрд╛ рд╣реИред  рд╣рдо рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ <strong>рд╡рд░реНрддрдорд╛рди</strong> рдЕрдиреБрд░реЛрдз рдХреЛ рд░рджреНрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЖрджреЗрд╢ рднреЗрдЬрддреЗ рд╣реИрдВред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдирдпрд╛ рдХрдиреЗрдХреНрд╢рди рдмрдирд╛рдПрдВ рдФрд░ рдЗрд╕рдореЗрдВ рдмреНрдпрд╛рдЬ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА (рдкреАрдЖрдИрдбреА) рд╣рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВред  рд▓реЗрдХрд┐рди рдЬрдм рд░рджреНрдж рдЖрджреЗрд╢ рдЖрдзрд╛рд░ рдХреЗ рд▓рд┐рдП рдЙрдбрд╝рд╛рди рднрд░рддрд╛ рд╣реИ, рддреЛ рд░рджреНрдж рдЕрдиреБрд░реЛрдз рдЕрдкрдиреЗ рдЖрдк рд╕рдорд╛рдкреНрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИред </p><br><p><img src="https://habrastorage.org/webt/us/xf/v_/usxfv_i0ze_axpmjtlir183reiu.png"></p><br><p>  <code>Postgres</code> рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВрдЧреЗ рдФрд░ рджреА рдЧрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ <strong>рд╡рд░реНрддрдорд╛рди</strong> рдЕрдиреБрд░реЛрдз рдХреЛ рд░рджреНрдж рдХрд░ рджреЗрдВрдЧреЗред  рд▓реЗрдХрд┐рди рд╡рд░реНрддрдорд╛рди рдЕрдиреБрд░реЛрдз рд╡рд╣ рдирд╣реАрдВ рд╣реЛрдЧрд╛ рдЬрд┐рд╕реЗ рд╣рдо рд╢реБрд░реВ рдореЗрдВ рд░рджреНрдж рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рдереЗред  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЗ</a> рдХрд╛рд░рдг рдЬрдм <code>Postgres</code> рд╕рд╛рде <code>PgBouncer</code> рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ <code>PgBouncer</code> рдбреНрд░рд╛рдЗрд╡рд░ рд╕реНрддрд░ рдкрд░ рдЕрдиреБрд░реЛрдз рдХреЛ рд░рджреНрдж рдирд╣реАрдВ рдХрд░рдирд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк <code>CustomCancel</code> рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ <code>context.Context</code> рд░рджреНрдж рдирд╣реАрдВ рдХрд░реЗрдЧрд╛, рднрд▓реЗ рд╣реА <code>context.Context</code> ред </p><br><pre> <code class="go hljs">cfg := pgx.ConnConfig{ ... CustomCancel: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_ *pgx.Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }, }</code> </pre> <br><h1 id="cheklist-po-rabote-s-postgres">  рдЪреЗрдХрд▓рд┐рд╕реНрдЯ рдкреЛрд╕реНрдЯ рдХрд░рддрд╛ рд╣реИ </h1><br><p>  рдирд┐рд╖реНрдХрд░реНрд╖ рдХреЗ рдмрдЬрд╛рдп, рдореИрдВрдиреЗ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЪреЗрдХрд▓рд┐рд╕реНрдЯ рдмрдирд╛рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ред  рдЗрд╕рд╕реЗ рд▓реЗрдЦ рдХреЛ рдореЗрд░реЗ рд╕рд┐рд░ рдореЗрдВ рдлрд┐рдЯ рд╣реЛрдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓реЗрдЧреАред </p><br><ul><li>  Postgres рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд░реВрдк рдореЗрдВ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">github.com/jackc/pgx рдХрд╛</a> рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред </li><li>  рдКрдкрд░ рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдкреВрд▓ рдХрд╛ рдЖрдХрд╛рд░ рд╕реАрдорд┐рдд рдХрд░реЗрдВред </li><li>  рдпрджрд┐ рдЖрдк <code>pgx</code> рд╕рдВрд╕реНрдХрд░рдг 3 рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">CID OIDs</a> рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">pgx.ConnPool рдХрд╛</a> рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">DB.Stats ()</a> рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">ConnPool.Stat ()</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдиреЗрдХреНрд╢рди рдкреВрд▓ рд╕реЗ рдореИрдЯреНрд░рд┐рдХреНрд╕ рдПрдХрддреНрд░ рдХрд░реЗрдВред </li><li>  рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ рдХрд┐ рдбреНрд░рд╛рдЗрд╡рд░ рдореЗрдВ рдХреНрдпрд╛ рд╣реЛ рд░рд╣рд╛ рд╣реИред </li><li>  <code>PgBouncer</code> рд▓реЗрди-рджреЗрди рдореЛрдб рдореЗрдВ рдХреНрд╡реЗрд░реА рддреИрдпрд╛рд░реА рдХреЗ рд╕рд╛рде рд╕рдорд╕реНрдпрд╛рдУрдВ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рд░рд▓ рдХреНрд╡реЗрд░реА</a> рдореЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред </li><li>  <code>PgBouncer</code> рдХреЛ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВред </li><li>  рдЖрд╡реЗрджрди рд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд░рджреНрдж рдХрд░рдиреЗ рд╕реЗ рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВред </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi461935/">https://habr.com/ru/post/hi461935/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi461919/index.html">рд░рд┐рдПрдХреНрдЯ рдкрд░ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХреЗ рд░реВрдк</a></li>
<li><a href="../hi461921/index.html">HDMI-LVDSред MSMAR рд╕реЗ TSUMV59 рдкрд░ рд╡рд┐рдХрд╛рд╕</a></li>
<li><a href="../hi461923/index.html">рд╕реЗрдВрдЯ рдкреАрдЯрд░реНрд╕рдмрд░реНрдЧ рдореЗрдВ рдЬреЗрдЯрдмреНрд░реЗрдиреНрд╕ рдУрдкрди рдбреЗ: рд╡реАрдбрд┐рдпреЛ</a></li>
<li><a href="../hi461927/index.html">рд╕рдХреНрд░рд┐рдп рд░реИрдВрдХрд┐рдВрдЧ рд╕реАрдЦрдирд╛</a></li>
<li><a href="../hi461929/index.html">рд▓рд┐рдирдХреНрд╕ рдкрд░ рдПрд╕рдПрд╕рдбреА рд╕реНрдерд┐рддрд┐ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдФрд░ рдЬрд╛рдВрдЪ</a></li>
<li><a href="../hi461937/index.html">рдкрд╛рд░реНрдХрд┐рдВрд╕рдВрд╕ рдХрд╛рдиреВрди рдФрд░ рдЗрд╕реЗ рдХреИрд╕реЗ рддреЛрдбрд╝рдирд╛ рд╣реИ</a></li>
<li><a href="../hi461939/index.html">рдЧреНрд░рд╛рдлреАрди-рдкрд╛рдпрдерди рдХреЗ рд╕рд╛рде рд░реЛрдорд╛рдВрдЪ рдХрд╛ рд╡рд░реНрд╖</a></li>
<li><a href="../hi461941/index.html">рдЗрд╕рд╕реЗ рдорд╛рд▓рд┐рд╢ рдХрд░реЗрдВ</a></li>
<li><a href="../hi461945/index.html">рдЕрдЧрд╕реНрдд 2019 рдХреЗ рд▓рд┐рдП рдЖрдИрдЯреА рдХреЗ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдорд╛рдирд╡ рд╕рдВрд╕рд╛рдзрди рдкреЗрд╢реЗрд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдкрд╛рдЪрди</a></li>
<li><a href="../hi461949/index.html">AppCode 2019.2: рд╕реНрд╡рд┐рдлреНрдЯ 5.1, рдкрд░реАрдХреНрд╖рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рдХреЛрдб рдХрд╡рд░реЗрдЬ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг, рдЕрд╕рдВрддреБрд╖реНрдЯ рдХреЛрдб рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдФрд░ рдмрд╣реБрдд рдХреБрдЫ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>