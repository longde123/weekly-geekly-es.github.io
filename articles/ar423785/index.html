<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ฌ ๐ฉ๐ปโ๐คโ๐จ๐ฝ ๐๐ฟ ุฅูุดุงุก ูุฒุฑุนุฉ ุฎูุงุฏู ุฌุงูุฒุฉ ููุดุจูุฉ ูู Kubernetes ุจุงุณุชุฎุฏุงู LTSP ๐ต ๐ ๐๐ฟ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูู ูุฐู ุงูููุงูุฉ ุ ุฃูุฏ ุฃู ุฃุฑููู ุชูููุฉ ุฑุงุฆุนุฉ ุ ุฃุณุชุฎุฏููุง ุจูุฌุงุญ ูู Kubernetes. ูููู ุฃู ูููู ูููุฏูุง ุญููุง ูุจูุงุก ูุฌููุนุงุช ูุจูุฑุฉ. 


 ูู ุงูุขู ูุตุงุนุฏูุง ุ ูู ูุนุฏ ุน...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุฅูุดุงุก ูุฒุฑุนุฉ ุฎูุงุฏู ุฌุงูุฒุฉ ููุดุจูุฉ ูู Kubernetes ุจุงุณุชุฎุฏุงู LTSP</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423785/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/8bb/8a3/0c9/8bb8a30c990d198d478d1062f444b7a7.svg"></p><br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงูููุงูุฉ ุ ุฃูุฏ ุฃู ุฃุฑููู ุชูููุฉ ุฑุงุฆุนุฉ ุ ุฃุณุชุฎุฏููุง ุจูุฌุงุญ ูู Kubernetes.  ูููู ุฃู ูููู ูููุฏูุง ุญููุง ูุจูุงุก ูุฌููุนุงุช ูุจูุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงูุขู ูุตุงุนุฏูุง ุ ูู ูุนุฏ ุนููู ุงูุชูููุฑ ูู ุชุซุจูุช ูุธุงู ุงูุชุดุบูู ูุงูุญุฒู ุงููููุตูุฉ ููู ุนูุฏุฉ.  ููุงุฐุงุ  ููููู ุงูููุงู ุจูู ูุฐุง ุชููุงุฆููุง ูู ุฎูุงู ููู Dockerfile! </p><br><p style=";text-align:right;direction:rtl"> ุญูููุฉ ุฃูู ููููู ุดุฑุงุก ูุฆุงุช ุงูุฎูุงุฏู ุงูุฌุฏูุฏุฉ ูุฅุถุงูุชูุง ุฅูู ุจูุฆุฉ ุนููู ูุฌุนููุง ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู ุนูู ุงูููุฑ ุชูุฑูุจูุง ุฃูุฑ ูุฏูุด ุญููุง! </p><br><p style=";text-align:right;direction:rtl">  ููุชููุ  ุงูุขู ุฏุนููุง ูุชุญุฏุซ ุนู ูู ุดูุก ุจุงูุชุฑุชูุจ. </p><a name="habracut"></a><br><h1 id="rezyume" style=";text-align:right;direction:rtl">  ุงูููุฎุต </h1><br><p style=";text-align:right;direction:rtl">  ููุจุฏุก ุ ูุญุชุงุฌ ุฅูู ููู ููููุฉ ุนูู ูุฐู ุงูุฏุงุฆุฑุฉ ุจุงูุถุจุท. </p><br><p style=";text-align:right;direction:rtl">  ุจุงุฎุชุตุงุฑ ุ ูุฌููุน ุงูุนูุฏ ูุฌูุฒ ุตูุฑุฉ ูุงุญุฏุฉ ูุน ูุธุงู ุงูุชุดุบูู ุ Docker ุ Kubelet ููู ุดูุก ุขุฎุฑ. <br>  ูุชู ุฅูุดุงุก ุตูุฑุฉ ุงููุธุงู ูุฐู ูุน ุงูููุงุฉ ุชููุงุฆููุง ุจูุงุณุทุฉ CI ุจุงุณุชุฎุฏุงู ููู Dockerfile. <br>  ุชููู ุงูุนูุฏ ุงูููุงุฆูุฉ ุจุชุญููู ูุธุงู ุงูุชุดุบูู ู kernel ูู ูุฐู ุงูุตูุฑุฉ ูุจุงุดุฑุฉ ุนุจุฑ ุงูุดุจูุฉ. </p><br><p style=";text-align:right;direction:rtl"> ุชุณุชุฎุฏู ุงูุนูุฏ ุชุฑุงูุจุงุช ูุซู ูุธุงู ุงููููุงุช ุงูุฌุฐุฑ ุ ูุฐูู ูู ุญุงูุฉ ุฅุนุงุฏุฉ ุงูุชุดุบูู ุ ุณุชููุฏ ุฃู ุชุบููุฑุงุช (ููุฐูู ูู ุญุงูุฉ ุญุงููุงุช ุนุงูู ุงููููุงุก). <br>  ููุงู ุชูููู ุฑุฆูุณู ุ ููููู ููู ูุตู ููุงุท ุงูุชุญููู ูุจุนุถ ุงูุฃูุงูุฑ ุงูุชู ูุฌุจ ุชูููุฐูุง ุนูุฏ ุชุญููู ุงูุนูุฏุฉ (ุนูู ุณุจูู ุงููุซุงู ุ ุฃูุฑ ูุฅุถุงูุฉ ููุชุงุญ ssh ู <code>kubeadm join</code> ) </p><br><h2 id="process-podgotovki-obraza" style=";text-align:right;direction:rtl">  ุนูููุฉ ุฅุนุฏุงุฏ ุงูุตูุฑุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุณูุณุชุฎุฏู ูุดุฑูุน LTSP ูุฃูู ูููุญูุง ูู ูุง ูุญุชุงุฌู ูุชูุธูู ุชูููุฏ ุงูุดุจูุฉ. <br>  ุจุดูู ุนุงู ุ LTSP ุนุจุงุฑุฉ ุนู ุญุฒูุฉ ูู ุงููุตูุต ุงูุจุฑูุฌูุฉ ุงูุชู ุชุฌุนู ุญูุงุชูุง ุฃุณูู ุจูุซูุฑ. </p><br><p style=";text-align:right;direction:rtl">  ุฅูู ูููุฑ ูุญุฏุฉ initramfs ุ ูุงูุนุฏูุฏ ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ุงููุณุงุนุฏุฉ ุ ูููุนูุง ูู ูุธุงู ุงูุชูููู ุงูุฐู ูุนุฏ ุงููุธุงู ูู ูุฑุญูุฉ ูุจูุฑุฉ ูู ุงูุชุญููู ุ ุญุชู ูุจู ุงุณุชุฏุนุงุก init. </p><br><p style=";text-align:right;direction:rtl">  <strong>ููุฐุง ุชุจุฏู ุฅุฌุฑุงุกุงุช ุชุญุถูุฑ ุงูุตูุฑุฉ:</strong> </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุดุฑ ุงููุธุงู ุงูุฃุณุงุณู ูู ุจูุฆุฉ chroot. </li><li style=";text-align:right;direction:rtl">  ูููู ุจุฅุฌุฑุงุก ุงูุชุบููุฑุงุช ุงููุงุฒูุฉ ุ ุชุซุจูุช ุงูุจุฑูุงูุฌ. </li><li style=";text-align:right;direction:rtl">  ูู ุจุชุดุบูู ุงูุฃูุฑ <code>ltsp-build-image</code> </li></ul><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ุฐูู ูุจุงุดุฑุฉ ุณุชุญุตู ุนูู ุตูุฑุฉ ูุถุบูุทุฉ ูู ูุฐุง chroot ูุน ุฌููุน ุงูุจุฑุงูุฌ ุงููุซุจุชุฉ ูู ุงูุฏุงุฎู. <br>  ุณุชููู ูู ุนูุฏุฉ ุจุชูุฒูู ูุฐู ุงูุตูุฑุฉ ูู ููุช ุงูุชูููุฏ ูุงุณุชุฎุฏุงููุง ูุฌุฐูุฑ. <br>  ููุชุญุฏูุซ ุ ูุง ุนููู ุณูู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุนูุฏุฉ ุ ูุณูุชู ุชูุฒูู ุงูุตูุฑุฉ ุงูุฌุฏูุฏุฉ ูุงุณุชุฎุฏุงููุง ููุฌุฐูุฑ. </p><br><h2 id="servernye-komponenty" style=";text-align:right;direction:rtl">  ููููุงุช ุงูุฎุงุฏู </h2><br><p style=";text-align:right;direction:rtl">  <strong>ูุชุถูู ุฌุฒุก ุงูุฎุงุฏู ูู LTSP ูู ุญุงูุชูุง ูููููู ููุท:</strong> </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>ุฎุงุฏู TFTP</strong> - TFTP ูู ุจุฑูุชูููู ุชููุฆุฉ ุ ูุชู ุงุณุชุฎุฏุงูู ูุชุญููู ุงูููุงุฉ ุ ู initramfs ูุงูุชูููู ุงูุฑุฆูุณู - lts.conf. </li><li style=";text-align:right;direction:rtl">  <strong>ุฎุงุฏู NBD</strong> - ุจุฑูุชูููู NBD ุงููุณุชุฎุฏู ูุชูุฏูู ุตูุฑุฉ ุฌุฐูุฑ ูุถุบูุทุฉ ููุนููุงุก.  ูุฐู ูู ุฃุณุฑุน ุทุฑููุฉ ุ ูููู ุฅุฐุง ุฑุบุจุช ูู ุฐูู ุ ูููู ุงุณุชุจุฏุงููุง ุจู NFS ุฃู AoE. </li></ul><br><p style=";text-align:right;direction:rtl">  ุชุญุชุงุฌ ุฃูุถูุง ุฅูู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>ุฎุงุฏู DHCP</strong> - ุณููุฒุน ุชูููู IP ูุงูุนุฏูุฏ ูู ุงูุฎูุงุฑุงุช ุงูุฅุถุงููุฉ ุงูุชู ุณูุญุชุงุฌูุง ุนููุงุคูุง ุญุชู ูุชููููุง ูู ุงูุชูููุฏ ูู ุฎุงุฏู LTSP. </li></ul><br><h2 id="process-zagruzki-nody" style=";text-align:right;direction:rtl">  ุนูููุฉ ุชุญููู ุงูุนูุฏุฉ </h2><br><p style=";text-align:right;direction:rtl">  <strong>ูุตู ุนูููุฉ ุชุญููู ุงูุนูุฏุฉ</strong> </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฃููุงู ุ ุณุชุทูุจ ุงูุนูุฏุฉ ุนููุงู IP DHCP ูุฎูุงุฑุงุช <code>next-server</code> ุ <code>filename</code> . </li><li style=";text-align:right;direction:rtl">  ุซู ุณุชููู ุงูุนูุฏุฉ ุจุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ูุชูุฒูู ุฃุฏุงุฉ ุชุญููู ุงูุชุดุบูู (pxelinux ุฃู grub) </li><li style=";text-align:right;direction:rtl">  ุณูู ูููู ุจุฑูุงูุฌ bootloader ุจุชูุฒูู ุงูุชูููู ูุชุญูููู ุจุงูููุงุฉ ู initramfs. </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุฐูู ุ ุณูุชู ุชุญููู ุงูููุงุฉ ู initramfs ุจุฎูุงุฑุงุช ูุญุฏุฏุฉ ูุญุฏุฏุฉ ููููุงุฉ. </li><li style=";text-align:right;direction:rtl">  ูู ููุช ุงูุชูููุฏ ุ ุณุชููู ูุญุฏุงุช initramfs ุจูุนุงูุฌุฉ ุงููุนููุงุช ูู cmdline ูุชูููุฐ ุจุนุถ ุงูุฅุฌุฑุงุกุงุช ุ ูุซู ุชูุตูู ุฌูุงุฒ nbd ุ ูุฅุนุฏุงุฏ ุฌุฐูุฑ ุงูุชุฑุงูุจ ุ ุฅูุฎ. </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุฐูู ุ ุจุฏูุงู ูู ุงูุญุฑู ุงูุฃูู ุงููุนุชุงุฏ ุ ุณูุชู ุงุณุชุฏุนุงุก ltsp-init ุงูุฎุงุต. </li><li style=";text-align:right;direction:rtl">  ุณุชููู ูุตูุต ltsp-init ุจุฅุนุฏุงุฏ ุงููุธุงู ูู ููุช ูุจูุฑ ูุจู ุงุณุชุฏุนุงุก ุงูุญุฑู ุงูุฃูู ุงูุฑุฆูุณู.  ุจุดูู ุฃุณุงุณู ุ ูุชู ุงุณุชุฎุฏุงู ุงูุฎูุงุฑุงุช ูู lts.conf (ููู ุงูุชูููู ุงูุฑุฆูุณู) ููุง: ูุฐุง ูู ุชุญุฏูุซ ุงูุณุฌูุงุช ูู fstab ู rc.local ุ ุฅูุฎ. </li><li style=";text-align:right;direction:rtl">  ุซู ุณูููู ููุงู ููุงููุฉ ุฅูู init ุงูุฑุฆูุณูุฉ (systemd) ุ ูุงูุชู ุณุชููู ุจุชุญููู ุงููุธุงู ุงูุฐู ุชู ุชููููู ุจุงููุนู ูุงููุนุชุงุฏ ุ ูุชุซุจูุช ุงูููุงุฑุฏ ุงููุดุชุฑูุฉ ูู fstab ุ ูุฅุทูุงู ุงูุฃูุฏุงู ูุงูุฎุฏูุงุช ุ ูุชูููุฐ ุงูุฃูุงูุฑ ูู rc.local. </li><li style=";text-align:right;direction:rtl">  ููุชูุฌุฉ ูุฐูู ุ ูุญุตู ุนูู ูุธุงู ุชู ุชููููู ูุชุญูููู ุจุงููุงูู ุ ุฌุงูุฒูู ููุฒูุฏ ูู ุงูุฅุฌุฑุงุกุงุช. </li></ul><br><h1 id="podgotovka-servera" style=";text-align:right;direction:rtl">  ุฅุนุฏุงุฏ ุงูุฎุงุฏู </h1><br><p style=";text-align:right;direction:rtl">  ููุง ููุช ุ ุฃุฌูุฒ ุฎุงุฏู LTSP ุจุงูุตูุฑุฉ ุงููุณุญูุจุฉ ุชููุงุฆููุง ุจุงุณุชุฎุฏุงู ููู Dockerfile.  ูุฐู ุงูุทุฑููุฉ ููุณุช ุณูุฆุฉ ุ ูุฃูู ูููู ูุตู ุฌููุน ุฎุทูุงุช ุงูุจูุงุก ูู ูุณุชูุฏุน git ุงูุฎุงุต ุจู.  ููููู ุงูุชุญูู ูู ุงูุฅุตุฏุงุฑุงุช ูุงุณุชุฎุฏุงู ุงูุนูุงูุงุช ูุชุทุจูู CI ููู ูุง ุชุณุชุฎุฏูู ูุฅุนุฏุงุฏ ูุดุงุฑูุน Docker ุงููุนุชุงุฏุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูู ูุงุญูุฉ ุฃุฎุฑู ุ ููููู ูุดุฑ ุฎุงุฏู LTSP ูุฏูููุง ุจุงุชุจุงุน ุฌููุน ุงูุฎุทูุงุช ูุฏูููุง ุ ููุฏ ูููู ูุฐุง ุฌูุฏูุง ูุฃุบุฑุงุถ ุงูุชุฏุฑูุจ ูููู ุงููุจุงุฏุฆ ุงูุฃุณุงุณูุฉ. <br>  ูู ุจุชุดุบูู ุงูุฃูุงูุฑ ุงููุฏุฑุฌุฉ ูู ุงูููุงูุฉ ูุฏูููุง ุฅุฐุง ููุช ุชุฑูุฏ ููุท ุชุฌุฑุจุฉ LTSP ุจุฏูู ููู Dockerfile. </p><br><h2 id="spisok-ispolzovannyh-patchey" style=";text-align:right;direction:rtl">  ูุงุฆูุฉ ุงูุฑูุน ุงููุณุชุฎุฏูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ูู ุงูููุช ุงูุญุงูู ุ ูุฏู LTSP ุจุนุถ ุงูุนููุจ ุ ููุคููู ุงููุดุฑูุน ููุณูุง ุนูู ุงุณุชุนุฏุงุฏ ูุจูุฑ ููุจูู ุงูุชุตุญูุญุงุช.  ูุญุณู ุงูุญุธ ุ ูููู ุชุฎุตูุต LTSP ุจุณูููุฉ ุ ูุฐูู ููุช ุจุฅุนุฏุงุฏ ุจุนุถ ุงูุชุตุญูุญุงุช ูููุณู ุ ูุณุฃุนุทููุง ููุง. <br>  ุฑุจูุง ูููุง ูุง ุณูู ุชูุถุฌ ูู ุงูุดููุฉ ุฅุฐุง ูุจู ุงููุฌุชูุน ูุฑุงุฑู ุจุญุฑุงุฑุฉ. </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="">ููุฒุฉ grub.diff</a> <br>  ุจุดูู ุงูุชุฑุงุถู ุ ูุง ูุฏุนู LTSP EFI ุ ูุฐูู ููุช ุจุฅุนุฏุงุฏ ุชุตุญูุญ ูุถูู GRUB2 ูุน ุฏุนู EFI. </li><li style=";text-align:right;direction:rtl">  <a href="">feature_preinit.diff</a> <br>  ูุถูู ูุฐุง ุงูุชุตุญูุญ ุฎูุงุฑ PREINIT ุฅูู lts.conf ุ ูุงูุฐู ูุณูุญ ูู ุจุชุดุบูู ุฃูุงูุฑ ุนุดูุงุฆูุฉ ูุจู ุงุณุชุฏุนุงุก ุงูุญุฑู ุงูุฑุฆูุณู.  ูููู ุฃู ูููู ูุฐุง ูููุฏูุง ูุชุนุฏูู ูุญุฏุงุช systemd ูุฅุนุฏุงุฏุงุช ุงูุดุจูุฉ.  ูู ุงูุฌุฏูุฑ ุจุงูุฐูุฑ ุฃูู ูุชู ุญูุธ ุฌููุน ุงููุชุบูุฑุงุช ูู ุจูุฆุฉ ุงูุชูููุฏ ุ ูููููู ุงุณุชุฎุฏุงููุง ูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ุงูุฎุงุตุฉ ุจู ุงูุชู ูุชู ุงุณุชุฏุนุงุคูุง ูู ุฎูุงู ูุฐุง ุงูุฎูุงุฑ. </li><li style=";text-align:right;direction:rtl">  <a href="">feature_initramfs_params_from_lts_conf.diff</a> <br>  ูุญู ุงููุดููุฉ ูุน ุฎูุงุฑ NBD_TO_RAM ุงููุนุทู ุ ุจุนุฏ ูุฐุง ุงูุชุตุญูุญ ููููู ุชุญุฏูุฏู ูู lts.conf ุฏุงุฎู chroot.  (ููุณุช ุชูู ุงูููุฌูุฏุฉ ูู ุฏููู tftp) </li><li style=";text-align:right;direction:rtl">  <a href="">nbd-server-wrapper.sh</a> <br>  ูุฐุง ููุณ ุชุตุญูุญูุง ุ ููููู ูุฌุฑุฏ ูุต ุจุฑูุฌู ุ ูุณูุญ ูู ุจุชุดุบูู ุฎุงุฏู nbd ูู foregroud ุ ุณุชุญุชุงุฌู ุฅุฐุง ููุช ุชุฑุบุจ ูู ุชุดุบูู ุฎุงุฏู nbd ุฏุงุฎู ุญุงููุฉ Docker. </li></ul><br><h2 id="dockerfile-stages" style=";text-align:right;direction:rtl">  ูุฑุงุญู Dockerfile </h2><br><p style=";text-align:right;direction:rtl">  ุณูุณุชุฎุฏู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจูุงุก ุงููุฑุญูุฉ</a> ูู ููู Dockerfile ูุญูุธ ุงูุฃุฌุฒุงุก ุงูุถุฑูุฑูุฉ ููุท ูู ุตูุฑุฉ ุนุงูู ุงููููุงุก ูุฏููุง ุ ูุณูุชู ุงุณุชุจุนุงุฏ ุงูุฃุฌุฒุงุก ุงููุชุจููุฉ ุบูุฑ ุงููุณุชุฎุฏูุฉ ูู ุงูุตูุฑุฉ ุงูููุงุฆูุฉ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs ruby">ltsp-base (    ltsp ) <span class="hljs-params"><span class="hljs-params">| |</span></span>---basesystem <span class="hljs-params"><span class="hljs-params">| ( chroot-     ) |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|---builder |</span></span> <span class="hljs-params"><span class="hljs-params">| (    ,  ) |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">'---ltsp-image | (  , docker, kubelet   squashed ) | '</span></span>---final-stage ( squashed ,   initramfs   stage)</code> </pre> <br><h3 id="stage-1-ltsp-base" style=";text-align:right;direction:rtl">  ุงููุฑุญูุฉ 1: ูุงุนุฏุฉ ltsp </h3><br><p style=";text-align:right;direction:rtl">  ุญุณููุง ุ ููุจุฏุฃ ุ ูุฐุง ูู ุงูุฌุฒุก ุงูุฃูู ูู ููู Dockerfile: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">FROM ubuntu:16.04 as ltsp-base ADD nbd-server-wrapper.sh /bin/ ADD /patches/feature-grub.diff /patches/feature-grub.diff RUN apt-get -y update \ &amp;&amp; apt-get -y install \ ltsp-server \ tftpd-hpa \ nbd-server \ grub-common \ grub-pc-bin \ grub-efi-amd64-bin \ curl \ patch \ &amp;&amp; sed -i <span class="hljs-string"><span class="hljs-string">'s|in_target mount|in_target_nofail mount|'</span></span> \ /usr/share/debootstrap/<span class="hljs-built_in"><span class="hljs-built_in">functions</span></span> \ <span class="hljs-comment"><span class="hljs-comment">#   EFI   Grub (#1745251) &amp;&amp; patch -p2 -d /usr/sbin &lt; /patches/feature-grub.diff \ &amp;&amp; rm -rf /var/lib/apt/lists \ &amp;&amp; apt-get clean</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุงูููุช ุงูุญุงูู ุ ุชู ุชุซุจูุช ุตูุฑุฉ ุนุงูู ุงููููุงุก ูุฏููุง ุจุงููุนู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฎุงุฏู NBD </li><li style=";text-align:right;direction:rtl">  ุฎุงุฏู TFTP </li><li style=";text-align:right;direction:rtl">  ูุตูุต LTSP ูุน ุฏุนู ูุญูู ุฅููุงุน grub (ูู EFI) </li></ul><br><h3 id="stage-2-basesystem" style=";text-align:right;direction:rtl">  ุงููุฑุญูุฉ 2: ูุธุงู ุงูุฃุณุงุณ </h3><br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงููุฑุญูุฉ ุ ุณูููู ุจุฅุนุฏุงุฏ ุจูุฆุฉ chroot ูุน ุงููุธุงู ุงูุฃุณุงุณู ูุชุซุจูุช ุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู ูุน kernel. <br>  ุณูุณุชุฎุฏู <strong>debootstrap</strong> ุงููุนุชุงุฏ ุจุฏูุงู ูู <strong>ltsp-build-client</strong> ูุฅุนุฏุงุฏ ุงูุตูุฑุฉ ุ ูุฃู <strong>ltsp-build-client ุณูููู</strong> ุจุชุซุจูุช ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุฑุณูููุฉ ูุจุนุถ ุงูุฃุดูุงุก ุงูุฃุฎุฑู ุบูุฑ ุงูุถุฑูุฑูุฉ ุงูุชู ูู ุงููุงุถุญ ุฃููุง ูู ูููู ูููุฏูู ููุดุฑ ุงูุฎูุงุฏู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">FROM ltsp-base as basesystem ARG DEBIAN_FRONTEND=noninteractive <span class="hljs-comment"><span class="hljs-comment">#    RUN mkdir -p /opt/ltsp/amd64/proc/self/fd \ &amp;&amp; touch /opt/ltsp/amd64/proc/self/fd/3 \ &amp;&amp; debootstrap --arch amd64 xenial /opt/ltsp/amd64 \ &amp;&amp; rm -rf /opt/ltsp/amd64/proc/* #   RUN echo "\ deb http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse\n\ deb http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse\n\ deb http://archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse" \ &gt; /opt/ltsp/amd64/etc/apt/sources.list \ &amp;&amp; ltsp-chroot apt-get -y update \ &amp;&amp; ltsp-chroot apt-get -y upgrade #   LTSP RUN ltsp-chroot apt-get -y install ltsp-client-core #   initramfs # 1:    /etc/lts.conf    (#1680490) # 2:   PREINIT   lts.conf ADD /patches /patches RUN patch -p4 -d /opt/ltsp/amd64/usr/share &lt; /patches/feature_initramfs_params_from_lts_conf.diff \ &amp;&amp; patch -p3 -d /opt/ltsp/amd64/usr/share &lt; /patches/feature_preinit.diff #  LTSP_NBD_TO_RAM    ,     ram: RUN echo "[Default]\nLTSP_NBD_TO_RAM = true" \ &gt; /opt/ltsp/amd64/etc/lts.conf #   RUN echo 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";' \ &gt;&gt; /opt/ltsp/amd64/etc/apt/apt.conf.d/01norecommend \ &amp;&amp; ltsp-chroot apt-get -y install \ software-properties-common \ apt-transport-https \ ca-certificates \ ssh \ bridge-utils \ pv \ jq \ vlan \ bash-completion \ screen \ vim \ mc \ lm-sensors \ htop \ jnettop \ rsync \ curl \ wget \ tcpdump \ arping \ apparmor-utils \ nfs-common \ telnet \ sysstat \ ipvsadm \ ipset \ make #   RUN ltsp-chroot apt-get -y install linux-generic-hwe-16.04</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฑุฌู ููุงุญุธุฉ ุฃู ุจุนุถ ุงูุญุฒู ุ ูุซู lvm2 ุ ูุฏ ุชูุงุฌู ูุดุงูู.  ูู ูุชู ุชุญุณูููุง ุจุดูู ูุงูู ููุชุซุจูุช ูู ุฌุฐุฑ ุบูุฑ ูููุฒ.  ุชุญุงูู ุงูุจุฑุงูุฌ ุงููุตูุฉ ููุง ุจุนุฏ ุงูุชุซุจูุช ุงุณุชุฏุนุงุก ุงูุฃูุงูุฑ ุฐุงุช ุงูุงูุชูุงุฒุงุช ุงูุชู ูุฏ ุชูุดู ูุชููุน ุชุซุจูุช ุงูุญุฒูุฉ ุจุฃููููุง. </p><br><p style=";text-align:right;direction:rtl">  ุงูุญู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูููู ุชุซุจูุช ุจุนุถูุง ุฏูู ูุดุงูู ุฅุฐุง ููุช ุจุชุซุจูุชูุง ูุจู ุชุซุจูุช ุงูููุงุฉ (ุนูู ุณุจูู ุงููุซุงู ุ lvm2) </li><li style=";text-align:right;direction:rtl">  ูููู ุจุงููุณุจุฉ ููุจุนุถ ูููู ุ ุณุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงู ูุฐุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุญู ุงูุจุฏูู</a> ููุชุซุจูุช ุฏูู ุชุซุจูุช ุจุฑูุงูุฌ ูุตู. </li></ul><br><h3 id="stage-3-builder" style=";text-align:right;direction:rtl">  ุงููุฑุญูุฉ 3: ุงูุจูุงุก </h3><br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงููุฑุญูุฉ ุ ูููููุง ุฌูุน ุฌููุน ุงูุจุฑุงูุฌ ุงูุถุฑูุฑูุฉ ููุญุฏุงุช ุงูููุงุฉ ูู ุงููุตุงุฏุฑ ุ ููู ุงูุฑุงุฆุน ุฌุฏูุง ุฃู ุชุชููู ูู ุงูููุงู ุจุฐูู ูู ูุฐู ุงููุฑุญูุฉ ุ ูู ุงููุถุน ุงูุชููุงุฆู ุจุงููุงูู. <br>  ุชุฎุทู ูุฐู ุงูุฎุทูุฉ ุฅุฐุง ูู ุชูู ุจุญุงุฌุฉ ุฅูู ุฌูุน ุฃู ุดูุก ูู ุงูููุงููู. </p><br><p style=";text-align:right;direction:rtl">  ุณุฃุนุทูู ูุซุงูุงู ุนูู ุชุซุจูุช ุฃุญุฏุซ ุฅุตุฏุงุฑ ูู ุจุฑูุงูุฌ ุชุดุบูู MLNX_EN: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">FROM basesystem as builder <span class="hljs-comment"><span class="hljs-comment">#  cpuinfo (   ) RUN cp /proc/cpuinfo /opt/ltsp/amd64/proc/cpuinfo #    Mellanox driver RUN ltsp-chroot sh -cx \ ' VERSION=4.3-1.0.1.0-ubuntu16.04-x86_64 \ &amp;&amp; curl -L http://www.mellanox.com/downloads/ofed/MLNX_EN-${VERSION%%-ubuntu*}/mlnx-en-${VERSION}.tgz \ | tar xzf - \ &amp;&amp; export \ DRIVER_DIR="$(ls -1 | grep "MLNX_OFED_LINUX-\|mlnx-en-")" \ KERNEL="$(ls -1t /lib/modules/ | head -n1)" \ &amp;&amp; cd "$DRIVER_DIR" \ &amp;&amp; ./*install --kernel "$KERNEL" --without-dkms --add-kernel-support \ &amp;&amp; cd - \ &amp;&amp; rm -rf "$DRIVER_DIR" /tmp/mlnx-en* /tmp/ofed*' #    RUN ltsp-chroot sh -c \ ' export KERNEL="$(ls -1t /usr/src/ | grep -m1 "^linux-headers" | sed "s/^linux-headers-//g")" \ &amp;&amp; tar cpzf /modules.tar.gz /lib/modules/${KERNEL}/updates'</span></span></code> </pre><br><h3 id="stage-4-ltsp-image" style=";text-align:right;direction:rtl">  ุงููุฑุญูุฉ 4: ุตูุฑุฉ ltsp </h3><br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงููุฑุญูุฉ ุณูุญุฏุฏ ูุง ุฌูุนูุงู ูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">FROM basesystem as ltsp-image <span class="hljs-comment"><span class="hljs-comment">#    COPY --from=builder /opt/ltsp/amd64/modules.tar.gz /opt/ltsp/amd64/modules.tar.gz #    RUN ltsp-chroot sh -c \ ' export KERNEL="$(ls -1t /usr/src/ | grep -m1 "^linux-headers" | sed "s/^linux-headers-//g")" \ &amp;&amp; tar xpzf /modules.tar.gz \ &amp;&amp; depmod -a "${KERNEL}" \ &amp;&amp; rm -f /modules.tar.gz'</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ุณูููู ุงูุขู ุจุฅุฌุฑุงุก ุชุบููุฑุงุช ุฅุถุงููุฉ ูุฅููุงู ุตูุฑุฉ LTSP ุงูุฎุงุตุฉ ุจูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  docker RUN ltsp-chroot sh -c \ ' curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - \ &amp;&amp; echo "deb https://download.docker.com/linux/ubuntu xenial stable" \ &gt; /etc/apt/sources.list.d/docker.list \ &amp;&amp; apt-get -y update \ &amp;&amp; apt-get -y install \ docker-ce=$(apt-cache madison docker-ce | grep 18.06 | head -1 | awk "{print $ 3}")' #    docker RUN DOCKER_OPTS="$(echo \ --storage-driver=overlay2 \ --iptables=false \ --ip-masq=false \ --log-driver=json-file \ --log-opt=max-size=10m \ --log-opt=max-file=5 \ )" \ &amp;&amp; sed "/^ExecStart=/ s|$| $DOCKER_OPTS|g" \ /opt/ltsp/amd64/lib/systemd/system/docker.service \ &gt; /opt/ltsp/amd64/etc/systemd/system/docker.service #  kubeadm, kubelet  kubectl RUN ltsp-chroot sh -c \ ' curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - \ &amp;&amp; echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" \ &gt; /etc/apt/sources.list.d/kubernetes.list \ &amp;&amp; apt-get -y update \ &amp;&amp; apt-get -y install kubelet kubeadm kubectl cri-tools' #    RUN rm -f /opt/ltsp/amd64/etc/apt/apt.conf.d/20auto-upgrades #   apparmor RUN ltsp-chroot find /etc/apparmor.d \ -maxdepth 1 \ -type f \ -name "sbin.*" \ -o -name "usr.*" \ -exec ln -sf "{}" /etc/apparmor.d/disable/ \; #    (cmdline) RUN KERNEL_OPTIONS="$(echo \ init=/sbin/init-ltsp \ forcepae \ console=tty1 \ console=ttyS0,9600n8 \ nvme_core.default_ps_max_latency_us=0 \ )" \ &amp;&amp; sed -i "/^CMDLINE_LINUX_DEFAULT=/ s|=.*|=\"${KERNEL_OPTIONS}\"|" \ "/opt/ltsp/amd64/etc/ltsp/update-kernels.conf"</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุขู ูู ุจุนูู ุตูุฑุฉ ููุฒูุฌุฉ ูู ุฌุฐุฑูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   RUN rm -rf /opt/ltsp/amd64/var/lib/apt/lists \ &amp;&amp; ltsp-chroot apt-get clean #  squashed  RUN ltsp-update-image</span></span></code> </pre> <br><h3 id="stage-5-final-stage" style=";text-align:right;direction:rtl">  ุงููุฑุญูุฉ 5: ุงููุฑุญูุฉ ุงูููุงุฆูุฉ </h3><br><p style=";text-align:right;direction:rtl">  ูู ุงููุฑุญูุฉ ุงูููุงุฆูุฉ ุ ูููู ููุท ุจุญูุธ ุตูุฑุชูุง ููุณููุง ุงูููุฒูุฉ ุจุงุณุชุฎุฏุงู initramfs </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">FROM ltsp-base COPY --from=ltsp-image /opt/ltsp/images /opt/ltsp/images COPY --from=ltsp-image /etc/nbd-server/conf.d /etc/nbd-server/conf.d COPY --from=ltsp-image /var/lib/tftpboot /var/lib/tftpboot</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุญุณููุง ุ ูุฏููุง ุงูุขู ุตูุฑุฉ ุนุงูู ูููุงุก ุชุดูู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฎุงุฏู TFTP </li><li style=";text-align:right;direction:rtl">  ุฎุงุฏู NBD </li><li style=";text-align:right;direction:rtl">  ูุญูู ุงูุฅููุงุน </li><li style=";text-align:right;direction:rtl">  ููุงุฉ ูุน initramfs </li><li style=";text-align:right;direction:rtl">  ุตูุฑุฉ ุงูุฌุฐูุฑ ููุฑูุฏ </li></ul><br><h1 id="ispolzovanie" style=";text-align:right;direction:rtl">  ุงุณุชุฎุฏู </h1><br><p style=";text-align:right;direction:rtl">  ุญุณููุง ุ ุงูุขู ุจุนุฏ ุฃู ุฃุตุจุญุช ุตูุฑุฉ Docker ูุน ุฎุงุฏู LTSP ู kernel ู initramfs ู rootfs squashed ุฌุงูุฒุฉ ุชูุงููุง ุ ูููููุง ุชุดุบูู ุงููุดุฑ ูุนูุง. </p><br><p style=";text-align:right;direction:rtl">  ูููููุง ุงูููุงู ุจุฐูู ูุงููุนุชุงุฏ ุ ูููู ููุงู ูุดููุฉ ุฃุฎุฑู ุนูููุง ุญููุง. <br>  ููุฃุณู ุ ูุง ูููููุง ุงุณุชุฎุฏุงู ุฎุฏูุฉ Kubernetes ุงููุนุชุงุฏุฉ ููุดุฑูุง ุ ูุฃูู ูู ููุช ุงูุชูููุฏ ููุณุช ุงูุนูุฏ ุฌุฒุกูุง ูู ูุฌููุนุฉ Kubernetes ูุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงู externalIP ุ ููู Kubernetes ุชุณุชุฎุฏู ุฏุงุฆููุง NAT ูู externalIP ููุง ุชูุฌุฏ ุญุงูููุง ุทุฑููุฉ ูุชุบููุฑ ูุฐุง ุงูุณููู. </p><br><p style=";text-align:right;direction:rtl">  ุฃุนุฑู ุทุฑููุชูู ูุชุฌูุจ ูุฐุง: ุงุณุชุฎุฏุงู <code>hostNetwork: true</code> ุฃู ุงุณุชุฎุฏุงู <a href="">ุงูุฃูุงุจูุจ</a> ุ ุงูุฎูุงุฑ ุงูุซุงูู ุณูููุฑ ููุง ุฃูุถูุง ุงูุชุณุงูุญ ูุน ุงูุฎุทุฃ ุ ููุง  ูู ุญุงูุฉ ุงููุดู ุ ุณูุชู ููู ุนููุงู IP ุฅูู ุนูุฏุฉ ุฃุฎุฑู ูุน ุงูุญุงููุฉ.  ูุณูุก ุงูุญุธ ุ ูุง ุชุนุฏ ุงูููุงุณูุฑ ุทุฑููุฉ ูุญููุฉ ูุฃูู ุฃูุงููุง. <br>  ุฅุฐุง ููุช ุชุนุฑู ุฃู ุญู ุฃูุซุฑ ููุงุกูุฉ ุ ููุฑุฌู ุฅุฎุจุงุฑูุง ุจุฐูู. </p><br><p style=";text-align:right;direction:rtl">  ูููุง ููู ูุซุงู ูููุดุฑ ูุน hostNetwork: </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql">apiVersion: extensions/v1beta1 kind: Deployment metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> labels: app: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> spec: selector: matchLabels: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: metadata: labels: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> spec: hostNetwork: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: tftpd image: registry.example.org/example/ltsp:latest command: [ "/usr/sbin/in.tftpd", "-L", "-u", "tftp", "-a", ":69", "-s", "/var/lib/tftpboot" ] lifecycle: postStart: exec: command: ["/bin/sh", "-c", "cd /var/lib/tftpboot/ltsp/amd64; ln -sf config/lts.conf ." ] volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: config mountPath: "/var/lib/tftpboot/ltsp/amd64/config" - <span class="hljs-type"><span class="hljs-type">name</span></span>: nbd-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> image: registry.example.org/example/ltsp:latest command: [ "/bin/nbd-server-wrapper.sh" ] volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: config configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-config</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ูุงุญุธุช ุ <strong>ููุณุชุฎุฏู</strong> ููู configmap ูุน ููู <strong>lts.conf</strong> ููุง ุฃูุถูุง. <br>  ููุซุงู ุ ุณุฃูุฏู ุฌุฒุกูุง ูู ุงูุชูููู ุงูุฎุงุต ุจู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs 1c">apiVersion: v1 kind: ConfigMap metadata: name: ltsp-config data: lts.conf: <span class="hljs-string"><span class="hljs-string">| [default] KEEP_SYSTEM_SERVICES = "</span></span>ssh ureadahead dbus-org.freedesktop.login1 systemd-logind polkitd cgmanager ufw rpcbind nfs-kernel-server<span class="hljs-string"><span class="hljs-string">" PREINIT_00_TIME = "</span></span>ln -sf /usr/share/zoneinfo/Europe/Prague /etc/localtime<span class="hljs-string"><span class="hljs-string">" PREINIT_01_FIX_HOSTNAME = "</span></span>sed -i '/^127.0.0.2/d' /etc/hosts<span class="hljs-string"><span class="hljs-string">" PREINIT_02_DOCKER_OPTIONS = "</span></span>sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/dockerd -H fd:// --storage-driver overlay2 --iptables=false --ip-masq=false --log-driver=json-file --log-opt=max-size=10m --log-opt=max-file=5|' /etc/systemd/system/docker.service<span class="hljs-string"><span class="hljs-string">" FSTAB_01_SSH = "</span></span>/dev/data/ssh /etc/ssh ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_02_JOURNALD = "</span></span>/dev/data/journal /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/journal ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_03_DOCKER = "</span></span>/dev/data/docker /var/lib/docker ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" # Each command will stop script execution when fail RCFILE_01_SSH_SERVER = "</span></span>cp /rofs/etc/ssh/*_config /etc/ssh; ssh-keygen -A<span class="hljs-string"><span class="hljs-string">" RCFILE_02_SSH_CLIENT = "</span></span>mkdir -p /root/.ssh/; echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8+CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh/nsP9KEvxGvTJB3OD+/bBxpliTl5xY3Eu41+VmZqVOz3Yl98+X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz+BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX+8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 admin@kubernetes' &gt;&gt; /root/.ssh/authorized_keys<span class="hljs-string"><span class="hljs-string">" RCFILE_03_KERNEL_DEBUG = "</span></span>sysctl -w kernel.unknown_nmi_panic=<span class="hljs-number"><span class="hljs-number">1</span></span> kernel.softlockup_panic=<span class="hljs-number"><span class="hljs-number">1</span></span>; modprobe netconsole netconsole=@/vmbr0,@<span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.15</span></span>/<span class="hljs-string"><span class="hljs-string">" RCFILE_04_SYSCTL = "</span></span>sysctl -w fs.file-max=<span class="hljs-number"><span class="hljs-number">20000000</span></span> fs.nr_open=<span class="hljs-number"><span class="hljs-number">20000000</span></span> net.ipv4.neigh.default.gc_thresh1=<span class="hljs-number"><span class="hljs-number">80000</span></span> net.ipv4.neigh.default.gc_thresh2=<span class="hljs-number"><span class="hljs-number">90000</span></span> net.ipv4.neigh.default.gc_thresh3=<span class="hljs-number"><span class="hljs-number">100000</span></span><span class="hljs-string"><span class="hljs-string">" RCFILE_05_FORWARD = "</span></span>echo <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; /proc/sys/net/ipv4/ip_forward<span class="hljs-string"><span class="hljs-string">" RCFILE_06_MODULES = "</span></span>modprobe br_netfilter<span class="hljs-string"><span class="hljs-string">" RCFILE_07_JOIN_K8S = "</span></span>kubeadm join --token <span class="hljs-number"><span class="hljs-number">2</span></span>a4576.<span class="hljs-number"><span class="hljs-number">504356</span></span>e45fa3d365 <span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.20</span></span>:<span class="hljs-number"><span class="hljs-number">6443</span></span> --discovery-token-ca-cert-hash sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855<span class="hljs-string"><span class="hljs-string">"</span></span></code> " ุณู-ุขุฑ ุฅุณ ุฅูู AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8 + CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh / nsP9KEvxGvTJB3OD + / + bBxpliTl5xY3Eu41 VmZqVOz3Yl98 + X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz + BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX + 8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 ุงูุงุฏุงุฑุฉ @ kubernetes '&gt;&gt; /root/.ssh/authorized_keys " <code class="hljs 1c">apiVersion: v1 kind: ConfigMap metadata: name: ltsp-config data: lts.conf: <span class="hljs-string"><span class="hljs-string">| [default] KEEP_SYSTEM_SERVICES = "</span></span>ssh ureadahead dbus-org.freedesktop.login1 systemd-logind polkitd cgmanager ufw rpcbind nfs-kernel-server<span class="hljs-string"><span class="hljs-string">" PREINIT_00_TIME = "</span></span>ln -sf /usr/share/zoneinfo/Europe/Prague /etc/localtime<span class="hljs-string"><span class="hljs-string">" PREINIT_01_FIX_HOSTNAME = "</span></span>sed -i '/^127.0.0.2/d' /etc/hosts<span class="hljs-string"><span class="hljs-string">" PREINIT_02_DOCKER_OPTIONS = "</span></span>sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/dockerd -H fd:// --storage-driver overlay2 --iptables=false --ip-masq=false --log-driver=json-file --log-opt=max-size=10m --log-opt=max-file=5|' /etc/systemd/system/docker.service<span class="hljs-string"><span class="hljs-string">" FSTAB_01_SSH = "</span></span>/dev/data/ssh /etc/ssh ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_02_JOURNALD = "</span></span>/dev/data/journal /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/journal ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_03_DOCKER = "</span></span>/dev/data/docker /var/lib/docker ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" # Each command will stop script execution when fail RCFILE_01_SSH_SERVER = "</span></span>cp /rofs/etc/ssh/*_config /etc/ssh; ssh-keygen -A<span class="hljs-string"><span class="hljs-string">" RCFILE_02_SSH_CLIENT = "</span></span>mkdir -p /root/.ssh/; echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8+CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh/nsP9KEvxGvTJB3OD+/bBxpliTl5xY3Eu41+VmZqVOz3Yl98+X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz+BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX+8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 admin@kubernetes' &gt;&gt; /root/.ssh/authorized_keys<span class="hljs-string"><span class="hljs-string">" RCFILE_03_KERNEL_DEBUG = "</span></span>sysctl -w kernel.unknown_nmi_panic=<span class="hljs-number"><span class="hljs-number">1</span></span> kernel.softlockup_panic=<span class="hljs-number"><span class="hljs-number">1</span></span>; modprobe netconsole netconsole=@/vmbr0,@<span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.15</span></span>/<span class="hljs-string"><span class="hljs-string">" RCFILE_04_SYSCTL = "</span></span>sysctl -w fs.file-max=<span class="hljs-number"><span class="hljs-number">20000000</span></span> fs.nr_open=<span class="hljs-number"><span class="hljs-number">20000000</span></span> net.ipv4.neigh.default.gc_thresh1=<span class="hljs-number"><span class="hljs-number">80000</span></span> net.ipv4.neigh.default.gc_thresh2=<span class="hljs-number"><span class="hljs-number">90000</span></span> net.ipv4.neigh.default.gc_thresh3=<span class="hljs-number"><span class="hljs-number">100000</span></span><span class="hljs-string"><span class="hljs-string">" RCFILE_05_FORWARD = "</span></span>echo <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; /proc/sys/net/ipv4/ip_forward<span class="hljs-string"><span class="hljs-string">" RCFILE_06_MODULES = "</span></span>modprobe br_netfilter<span class="hljs-string"><span class="hljs-string">" RCFILE_07_JOIN_K8S = "</span></span>kubeadm join --token <span class="hljs-number"><span class="hljs-number">2</span></span>a4576.<span class="hljs-number"><span class="hljs-number">504356</span></span>e45fa3d365 <span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.20</span></span>:<span class="hljs-number"><span class="hljs-number">6443</span></span> --discovery-token-ca-cert-hash sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>KEEP_SYSTEM_SERVICES</strong> - ุฃุซูุงุก ุงูุชูููุฏ LTSP ูุญุฐู ุชููุงุฆููุง ุจุนุถ ุงูุฎุฏูุงุช ุ ูุฐุง ุงููุชุบูุฑ ูุทููุจ ูููุน ูุฐุง ุงูุณููู ููุฎุฏูุงุช ุงููุฏุฑุฌุฉ ููุง. </li><li style=";text-align:right;direction:rtl">  <b>PREINIT_ *</b> - ุณูุชู ุชูููุฐ ุงูุฃูุงูุฑ ุงููุฏุฑุฌุฉ ููุง ูุจู ุชุดุบูู systemd (ุชูุช ุฅุถุงูุฉ ูุฐู ุงูููุฒุฉ ุจูุงุณุทุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">patch_preinit.diff</a> patch) </li><li style=";text-align:right;direction:rtl">  <b>FSTAB_ *</b> - ุณุชุชู ุฅุถุงูุฉ ุงูุฃุณุทุฑ ุงููุฏุฑุฌุฉ ููุง ุฅูู ููู <code>/etc/fstab</code> . <br>  ูุฏ ุชูุงุญุธ ุฃููู <code>nofail</code> ุฎูุงุฑ <code>nofail</code> ุ ููู ูุนุทู ุงูุณููู ุงูุชุงูู ุ ุฃูู ูู ุญุงูุฉ ุนุฏู ูุฌูุฏ ุงููุณู ุ ูุณุชูุฑ ุงูุชูุฒูู ุจุฏูู ุฃุฎุทุงุก. </li><li style=";text-align:right;direction:rtl">  <b>RCFILE_ *</b> - ุณุชุชู ุฅุถุงูุฉ ูุฐู ุงูุฃูุงูุฑ ุฅูู ููู <code>rc.local</code> ุ ุงูุฐู ุณูุชู ุงุณุชุฏุนุงุคู ุจูุงุณุทุฉ systemd ูู ููุช ุงูุชูููุฏ. <br>  ููุง ุฃููู ุจุชุญููู ูุญุฏุงุช kernel ุงูุถุฑูุฑูุฉ ุ ูุชุดุบูู ุจุนุถ ุฅุนุฏุงุฏุงุช sysctl ุ ุซู ุชุดุบูู ุฃูุฑ <code>kubeadm join</code> ุ ุงูุฐู ูุถูู ุงูุนูุฏุฉ ุฅูู ูุฌููุนุฉ kubernetes. </li></ul><br><p style=";text-align:right;direction:rtl">  ููููู ุงูุญุตูู ุนูู ูุนูููุงุช ุฃูุซุฑ ุชูุตููุงู ุญูู ุฌููุน ุงููุชุบูุฑุงุช ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุตูุญุฉ ุฏููู lts.conf</a> . </p><br><p style=";text-align:right;direction:rtl">  ุงูุขู ููููู ุชูููู DHCP ุงูุฎุงุต ุจู.  ุจุดูู ุฃุณุงุณู ุ ูุง ุชุญุชุงุฌู ูู ุชุญุฏูุฏ ุฎูุงุฑุงุช <code>next-server</code> <code>filename</code> . </p><br><p style=";text-align:right;direction:rtl">  ุฃุณุชุฎุฏู ุฎุงุฏู ISC-DHCP ุ ูุณุฃุนุทู ูุซุงูุงู ุนู <code>dhcpd.conf</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs pgsql">shared-network ltsp-netowrk { subnet <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { authoritative; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; max-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span> "example.org"; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>-servers <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; next-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> ltsp<span class="hljs-number"><span class="hljs-number">-1</span></span>; # <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> hostname here <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> architecture = <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> { filename "/ltsp/amd64/grub/x86_64-efi/core.efi"; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { filename "/ltsp/amd64/grub/i386-pc/core.0"; } <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.250</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููููู ุงูุจุฏุก ุจูุฐุง ุ ูููู ุจุงููุณุจุฉ ูู ุ ูุฏู ุงูุนุฏูุฏ ูู ุฎูุงุฏู LTSP ูููู ุนูุฏุฉ ุฃููู ุจุชูููู ุนููุงู IP ุซุงุจุช ูููุตู ูุงูุฎูุงุฑุงุช ุงูุถุฑูุฑูุฉ ุจุงุณุชุฎุฏุงู Ansible playbook. </p><br><p style=";text-align:right;direction:rtl">  ุฌุฑุจ ุจุฏุก ุงูุนูุฏุฉ ุงูุฃููู ูุฅุฐุง ุชู ุนูู ูู ุดูุก ุจุดูู ุตุญูุญ ุ ูุณุชุญุตู ุนูู ูุธุงู ูุญูู ุนููู.  ุณุชุชู ุฃูุถูุง ุฅุถุงูุฉ ุงูุนูุฏุฉ ุฅูู ูุฌููุนุฉ Kubernetes. </p><br><p style=";text-align:right;direction:rtl">  ุงูุขู ููููู ูุญุงููุฉ ุฅุฌุฑุงุก ุงูุชุบููุฑุงุช ุงูุฎุงุตุฉ ุจู. </p><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุดูุก ุฃูุซุฑ ุ ููุงุญุธ ุฃูู ูููู ุชุฎุตูุต LTSP ุจุณูููุฉ ุดุฏูุฏุฉ ูุชูุงุณุจ ุงุญุชูุงุฌุงุชู.  ูุง ุชุชุฑุฏุฏ ูู ุงูุจุญุซ ูู ุงููุตุฏุฑ ุ ุญูุซ ููููู ุงูุนุซูุฑ ุนูู ุงููุซูุฑ ูู ุงูุฅุฌุงุจุงุช. </p><br><p style=";text-align:right;direction:rtl">  ุงูุถู ุฅูู ููุงุฉ Telegram: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ltsp_ru</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar423785/">https://habr.com/ru/post/ar423785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar423775/index.html">ุฃุฑุฏุช ูุทุนุฉ ุญุฏูุฏ ุฌูููุฉ. ุงุชุถุญ</a></li>
<li><a href="../ar423777/index.html">Keystone Project: ุจูุฆุฉ ููุซููุฉ ูุชุดุบูู ุงูุชุทุจููุงุช ุงููุณุชูุฏุฉ ุฅูู RISC-V</a></li>
<li><a href="../ar423779/index.html">ุงููุณุฎ ุงูุงุญุชูุงุทู ูู ุงูุณุญุงุจุฉ ุฅูู ุงูุณุญุงุจุฉ: ูุง ูู ูููุงุฐุง ูู ูุทููุจ</a></li>
<li><a href="../ar423781/index.html">ููุงุญุธุงุช ูููุฑ ุฅูุชุฑูุช ุงูุฃุดูุงุก. ุงูุญุงูุฉ: ูู ุจุฅูุดุงุก ุดุจูุฉ LoRa ูููุฒุน ุงููููุฏ ูู ุชุดูููุงุจููุณู</a></li>
<li><a href="../ar423783/index.html">Splunk: ุงูุชุนูู ุงูุขูู ุฅูู ุงููุณุชูู ุงูุชุงูู</a></li>
<li><a href="../ar423787/index.html">ูุฎุชุจุฑุงุช ุงุฎุชุจุงุฑ 2018. mitap ุนุจุฑ ุงูุฅูุชุฑูุช ูููุฎุชุจุฑูู. 28 - 29 ุณุจุชูุจุฑ</a></li>
<li><a href="../ar423791/index.html">ูุตูุน ุฃุฏุงุฉ ุชูููู ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ ุจุฏูู ุจุฑูุฌุฉ ูุชุฎุทูุท. ุงูุฌุฒุก ุงูุซุงูู</a></li>
<li><a href="../ar423793/index.html">"ููุฏ ุงุชุฎุฐูุง ูุฐุง ุงููุฑุงุฑ ุ ุงููุนูุฉ ุ ูู ุงูููุช ุงูููุงุณุจ!" - 10 ุฃุณุฆูุฉ ูููุจุฑูุฌ ุงูุนุฏุฏ 5</a></li>
<li><a href="../ar423797/index.html">ููุงูู ุงูุทููุฑ ุงูุตุงููุฉ: ุชุฏูู ุงูุชูููุฉ</a></li>
<li><a href="../ar423799/index.html">ุฅุญุงุทุฉ ูุงุณุชุซูุงุฑ. ูุดุฑ ุฅูุชุฑุงูุช ุจุดูู ุตุญูุญ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>