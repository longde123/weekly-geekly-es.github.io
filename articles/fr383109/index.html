<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤹🏻 👩‍🏭 👉🏻 Authentification automatique d'un appareil Android dans le Wi-Fi du métro de Moscou ✋🏾 👩🏼‍🔧 👨‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme vous le savez, presque toutes les voitures du métro de Moscou disposent de points d'accès Wi-Fi, avec lesquels les utilisateurs peuvent accéder ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Authentification automatique d'un appareil Android dans le Wi-Fi du métro de Moscou</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/383109/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme vous le savez, presque toutes les voitures du métro de Moscou disposent de points d'accès Wi-Fi, avec lesquels les utilisateurs peuvent accéder à Internet et passer agréablement le temps du trajet jusqu'au métro depuis leur lieu de travail: lire les actualités, consulter les mails, regarder les sceaux sur YouTube, etc. . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque appareil doit être authentifié avant de pouvoir accéder à Internet. Pour la première fois, l'utilisateur reçoit un SMS avec un code au numéro de téléphone spécifié, après quoi le système se souvient de l'adresse MAC de l'appareil et à l'avenir, pour l'authentification, l'utilisateur n'aura qu'à cliquer sur le lien «Entrer sur Internet» et attendre un peu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'inconvénient d'une telle organisation du système est que même si l'utilisateur n'a pas besoin d'un navigateur, et qu'il souhaite, par exemple, accéder au courrier ou lire Twitter à l'aide d'une application spécialisée, il doit toujours démarrer le navigateur, essayer d'accéder à une page, attendre la redirection , cliquez sur le lien, attendez le chargement de la page d'accueil (facultatif: voir la publicité), et seulement après cela, il pourra utiliser l'application souhaitée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous n'êtes pas un visiteur fréquent du métro, un tel système peut ne pas vous causer d'irritation, cependant, s'il est utilisé quotidiennement, il dérange toujours, par conséquent, comme un politicien bien connu et charismatique a déclaré: "Assez pour supporter cela!", Aujourd'hui, nous automatiserons l'authentification dans le métro de Moscou.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous avons besoin de l'application Tasker. Vous pouvez l'obtenir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (pour un peu d'argent), eh bien, ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quelque part ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (à vos risques et périls). Personnellement, j'ai préféré la première option et je ne l'ai pas regretté. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tasker est une application qui permet en fonction de certaines conditions (date / heure / emplacement / état de l'appareil / lectures du capteur, etc.) d'effectuer certaines actions (envoi de messages / affichage de notifications / allumage / extinction des appareils / rendu d'interfaces simples, etc. ré.). Les listes de conditions et d'actions sont simplement énormes et dépendent de la version d'Android et du matériel de l'appareil, il est donc inutile de les apporter complètement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, après avoir démarré Tasker, vous devez d'abord traduire l'interface en anglais, car la traduction est boiteuse sur les deux jambes: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paramètres-&gt; Interface-&gt; Langue-&gt; Anglais</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et redémarrez l'application. </font><font style="vertical-align: inherit;">Nous avons maintenant quatre onglets:</font></font><br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profils</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les profils contrôlent la connexion entre l'état de l'appareil / divers événements et tâches;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tâches</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les tâches décrivent la séquence d'actions qui doivent être effectuées;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scènes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les scènes sont comme des formulaires faits maison que les tâches peuvent créer et personnaliser, et des contrôles sur lesquels ils peuvent exécuter des tâches;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vars</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une liste de variables globales qui peuvent être utilisées pour stocker des données entre les lancements de tâches.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accédez à l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tâches</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et créez une nouvelle tâche, en la nommant Metro Auth:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/58a/b9f/a77/58ab9fa777894cc2ab48e7d8e40ceb78.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fenêtre qui s'ouvre, nous devons d'abord définir plusieurs variables. </font><font style="vertical-align: inherit;">Les variables sont définies comme suit:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/1e0/95a/df8/1e095adf89564c41a1f500df8d671ada.png"></div><br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nom de la </font><font style="vertical-align: inherit;">variable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le nom de la variable, doit commencer par le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> symbole </font><font style="vertical-align: inherit;">et se </font><font style="vertical-align: inherit;">composent de lettres minuscules. </font><font style="vertical-align: inherit;">Si le nom de la variable contient au moins une lettre majuscule, la variable deviendra globale, mais nous n'en avons pas besoin;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est la valeur de la variable.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons donc créer les variables suivantes:</font></font><br>
<ul>
<li><i>%url</i> —    ,          .        —   (     ).   HTTPS  ,     HTTP;</li>
<li><i>%forms</i> —    HTML-,      .       — '<i>auth-form,hidden_form</i>',        - ,         ,          (  );</li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% debug</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - cette variable, lorsqu'elle est définie sur une valeur autre que zéro, provoquera l'affichage d'informations de débogage supplémentaires, ce qui nous aidera à créer la liste de formulaires ci-dessus.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des actions simples, Tasker nous offre la possibilité d'écrire des scripts de complexité arbitraire à l'aide de plusieurs outils. </font><font style="vertical-align: inherit;">Nous utiliserons du JavaScript simple:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/69d/789/3e2/69d7893e20f5443784f873e8fd6e01ab.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici , </font><font style="vertical-align: inherit;">vous devez définir le maximum d' </font><font style="vertical-align: inherit;">exécution </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">délai d' </font><font style="vertical-align: inherit;">attente du</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script - 50 secondes, juste au cas où. </font><font style="vertical-align: inherit;">La </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">case à cocher Exit automatique</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est responsable de l'achèvement automatique d'une action après l'achèvement du thread principal du script. </font><font style="vertical-align: inherit;">Si des demandes asynchrones sont utilisées (notre cas) ou la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setTimeout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous devez décocher cette case et déterminer vous-même l'achèvement de l'action à l'aide de la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exit (); </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je présenterai le script lui-même en deux options de mise en forme: une mise en forme décente est nécessaire si vous souhaitez examiner le script sans vous casser les yeux, et la mise en forme sur un écran étroit permet au script de paraître plus ou moins décent sur l'écran étroit du téléphone. </font><font style="vertical-align: inherit;">Initialement, le script a été tapé sur le téléphone dans la version "étroite", et seulement alors je l'ai reformaté pour l'article:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script au format décent</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span>(<span class="hljs-params">url1,url2</span>)</span>{<font></font>
    url1=url1.split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> url2.length?<font></font>
        (<span class="hljs-regexp">/^http(s?):\/\//i</span>.test(url2)?url2:<font></font>
            (url2[<span class="hljs-number">0</span>]==<span class="hljs-string">'/'</span>?url1.split(<span class="hljs-string">'/'</span>).slice(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>).join(<span class="hljs-string">'/'</span>)+url2:url1.split(<span class="hljs-string">'/'</span>).slice(<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>).join(<span class="hljs-string">'/'</span>)+<span class="hljs-string">'/'</span>+url2)<font></font>
        ):url1;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getVars</span>(<span class="hljs-params">form,tag</span>)</span>{<font></font>
    vars=<span class="hljs-string">''</span>;<font></font>
    fields=form.getElementsByTagName(tag);<font></font>
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;fields.length;i++)<font></font>
        vars=vars+(i?<span class="hljs-string">'&amp;'</span>:<span class="hljs-string">''</span>)+fields[i].name+<span class="hljs-string">'='</span>+fields[i].value;
    <span class="hljs-keyword">return</span> vars;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">submit</span>(<span class="hljs-params">xhr,request,form</span>)</span>{<font></font>
    request.url=getUrl(request.url,form.action);<font></font>
    request.method=form.method;<font></font>
    vars1=getVars(form,<span class="hljs-string">'input'</span>);<font></font>
    vars2=getVars(form,<span class="hljs-string">'textarea'</span>);<font></font>
    request.vars=vars1||vars2?(vars1?vars1:<span class="hljs-string">''</span>)+(vars1&amp;&amp;vars2?<span class="hljs-string">'&amp;'</span>:<span class="hljs-string">''</span>)+(vars2?vars2:<span class="hljs-string">''</span>):<span class="hljs-literal">null</span>;<font></font>
    getPage(request,processPage,xhr);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processPage</span>(<span class="hljs-params">xhr,request</span>)</span>{<font></font>
    redir=xhr.getResponseHeader(<span class="hljs-string">'Location'</span>);
    <span class="hljs-keyword">if</span>(redir){
        <span class="hljs-keyword">if</span>(redir==request.url) finalize(<span class="hljs-string">':  '</span>);
        <span class="hljs-keyword">else</span>{<font></font>
            log(<span class="hljs-string">'\n\n'</span>);<font></font>
            getPage({<span class="hljs-string">'url'</span>:redir},processPage,xhr);<font></font>
        }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        forms=local(<span class="hljs-string">'forms'</span>).split(<span class="hljs-string">','</span>);<font></font>
        id=<span class="hljs-literal">null</span>;
        <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;forms.length;i++)
            <span class="hljs-keyword">if</span>(xhr.response.getElementById(forms[i])) id=forms[i];
        <span class="hljs-keyword">if</span>(id)submit(xhr,request,xhr.response.getElementById(id));
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Number</span>(local(<span class="hljs-string">'debug'</span>))){<font></font>
            log(<span class="hljs-string">'  :\n'</span>);<font></font>
            forms=xhr.response.getElementsByTagName(<span class="hljs-string">'form'</span>);
            <span class="hljs-keyword">if</span>(forms.length)
                <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;forms.length;i++)<font></font>
                    log((i?<span class="hljs-string">', "'</span>:<span class="hljs-string">'"'</span>)+forms[i].id+<span class="hljs-string">'"'</span>);
            <span class="hljs-keyword">else</span> log(<span class="hljs-string">''</span>);<font></font>
            finalize();<font></font>
        } <span class="hljs-keyword">else</span> finalize(<span class="hljs-string">' '</span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkConn</span>(<span class="hljs-params">xhr,request</span>)</span>{<font></font>
    redir=xhr.getResponseHeader(<span class="hljs-string">'Location'</span>);
    <span class="hljs-keyword">if</span>(redir){<font></font>
        log(<span class="hljs-string">'\n\n'</span>);<font></font>
        getPage({<span class="hljs-string">'url'</span>:redir},processPage,xhr);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        log(<span class="hljs-string">'  '</span>);<font></font>
        finalize();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">txt</span>)</span>{<font></font>
    logs=logs+(txt?txt:<span class="hljs-string">''</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestToText</span>(<span class="hljs-params">request</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'URL: '</span>+request.url+<span class="hljs-string">'\nMethod: '</span>+request.method+<span class="hljs-string">', Vars: '</span>+request.vars+<span class="hljs-string">'\n\n'</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finalize</span>(<span class="hljs-params">txt</span>)</span>{<font></font>
    log(txt);<font></font>
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Number</span>(local(<span class="hljs-string">'debug'</span>))) alert(logs);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(txt) flashLong(txt);<font></font>
    exit();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPage</span>(<span class="hljs-params">request,func,xhr</span>)</span>{
    <span class="hljs-keyword">if</span>(!request.method) request.method=<span class="hljs-string">'GET'</span>;
    <span class="hljs-keyword">if</span>(!request.vars) request.vars=<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span>(!xhr){<font></font>
        xhr=<span class="hljs-keyword">new</span> XMLHttpRequest();<font></font>
        xhr.responseType=<span class="hljs-string">"document"</span>;<font></font>
        xhr.timeout=<span class="hljs-number">20</span>*<span class="hljs-number">1000</span>;<font></font>
    }<font></font>
    xhr.open(request.method,request.url,<span class="hljs-literal">true</span>);<font></font>
    xhr.onload=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>(xhr.status==<span class="hljs-number">200</span> || xhr.status==<span class="hljs-number">401</span>){<font></font>
            log (requestToText(request)+<span class="hljs-string">'HTTP status: '</span>+xhr.status+<span class="hljs-string">' '</span>+xhr.statusText+<span class="hljs-string">'\n'</span>);<font></font>
            func(xhr,request);<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            log(requestToText(request));<font></font>
            finalize(<span class="hljs-string">' HTTP: '</span>+xhr.status+<span class="hljs-string">' '</span>+xhr.statusText);<font></font>
        }<font></font>
    }<font></font>
    xhr.onerror=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
        log(requestToText(request));<font></font>
        finalize(<span class="hljs-string">':  '</span>);<font></font>
    }<font></font>
    xhr.ontimeout=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
        log(requestToText(request));<font></font>
        finalize(<span class="hljs-string">':  '</span>);<font></font>
    }<font></font>
    xhr.send(request.vars);<font></font>
}<font></font>
<font></font>
logs=<span class="hljs-string">''</span>;<font></font>
getPage({<span class="hljs-string">'url'</span>:local(<span class="hljs-string">'url'</span>)},checkConn);
</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script au format écran étroit</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUrl</span>(<span class="hljs-params">url1,url2</span>)</span>{<font></font>
  url1=url1.split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">return</span> url2.length?<font></font>
    (<span class="hljs-regexp">/^http(s?):\/\//i</span>.test(url2)?<font></font>
      url2:<font></font>
        (url2[<span class="hljs-number">0</span>]==<span class="hljs-string">'/'</span>?<font></font>
        url1.split(<span class="hljs-string">'/'</span>).slice(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>).join(<span class="hljs-string">'/'</span>)+url2:<font></font>
        url1.split(<span class="hljs-string">'/'</span>).slice(<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>).join(<span class="hljs-string">'/'</span>)+
      <span class="hljs-string">'/'</span>+url2)<font></font>
    ):url1;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getVars</span>(<span class="hljs-params">form,tag</span>)</span>{<font></font>
  vars=<span class="hljs-string">''</span>;<font></font>
  fields=form.getElementsByTagName(<font></font>
    tag);<font></font>
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;fields.length;i++)<font></font>
    vars=vars+(i?<span class="hljs-string">'&amp;'</span>:<span class="hljs-string">''</span>)+fields[i].name+
      <span class="hljs-string">'='</span>+fields[i].value;
  <span class="hljs-keyword">return</span> vars;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">submit</span>(<span class="hljs-params">xhr,request,form</span>)</span>{<font></font>
  request.url=getUrl(request.url,<font></font>
    form.action);<font></font>
  request.method=form.method;<font></font>
  vars1=getVars(form,<span class="hljs-string">'input'</span>);<font></font>
  vars2=getVars(form,<span class="hljs-string">'textarea'</span>);<font></font>
  request.vars=vars1||vars2?<font></font>
    (vars1?vars1:<span class="hljs-string">''</span>)+<font></font>
    (vars1&amp;&amp;vars2?<span class="hljs-string">'&amp;'</span>:<span class="hljs-string">''</span>)+<font></font>
    (vars2?vars2:<span class="hljs-string">''</span>)<font></font>
    :<span class="hljs-literal">null</span>;<font></font>
  getPage(request,processPage,xhr);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processPage</span>(<span class="hljs-params">xhr,request</span>)</span>{<font></font>
  redir=xhr.getResponseHeader(<font></font>
    <span class="hljs-string">'Location'</span>);
  <span class="hljs-keyword">if</span>(redir){
    <span class="hljs-keyword">if</span>(redir==request.url)<font></font>
      finalize(<span class="hljs-string">':  '</span>+
        <span class="hljs-string">''</span>);
    <span class="hljs-keyword">else</span>{<font></font>
      log(<span class="hljs-string">'\n\n'</span>);<font></font>
      getPage({<span class="hljs-string">'url'</span>:redir},processPage,<font></font>
        xhr);<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    forms=local(<span class="hljs-string">'forms'</span>).split(<span class="hljs-string">','</span>);<font></font>
    id=<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;forms.length;i++)
      <span class="hljs-keyword">if</span>(xhr.response.getElementById(<font></font>
          forms[i]))<font></font>
        id=forms[i];<font></font>
    <span class="hljs-keyword">if</span>(id)submit(xhr,request,<font></font>
      xhr.response.getElementById(id));<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Number</span>(local(<span class="hljs-string">'debug'</span>))){<font></font>
      log(<span class="hljs-string">'  :\n'</span>);<font></font>
      forms=xhr.response.<font></font>
        getElementsByTagName(<span class="hljs-string">'form'</span>);
      <span class="hljs-keyword">if</span>(forms.length)
        <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;forms.length;i++)<font></font>
          log((i?<span class="hljs-string">', "'</span>:<span class="hljs-string">'"'</span>)+forms[i].id+<span class="hljs-string">'"'</span>);
      <span class="hljs-keyword">else</span> log(<span class="hljs-string">''</span>);<font></font>
      finalize();<font></font>
    } <span class="hljs-keyword">else</span> finalize(
      <span class="hljs-string">' '</span>);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkConn</span>(<span class="hljs-params">xhr,request</span>)</span>{<font></font>
  redir=xhr.getResponseHeader(<font></font>
    <span class="hljs-string">'Location'</span>);
  <span class="hljs-keyword">if</span>(redir){<font></font>
    log(<span class="hljs-string">'\n\n'</span>);<font></font>
    getPage({<span class="hljs-string">'url'</span>:redir},processPage,<font></font>
      xhr);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    log(<span class="hljs-string">'  '</span>+
      <span class="hljs-string">''</span>);<font></font>
    finalize();<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">txt</span>)</span>{logs=logs+(txt?txt:<span class="hljs-string">''</span>);}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestToText</span>(<span class="hljs-params">request</span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'URL: '</span>+request.url+
    <span class="hljs-string">'\nMethod: '</span>+request.method+
    <span class="hljs-string">', Vars: '</span>+request.vars+<span class="hljs-string">'\n\n'</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finalize</span>(<span class="hljs-params">txt</span>)</span>{<font></font>
  log(txt);<font></font>
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Number</span>(local(<span class="hljs-string">'debug'</span>))) alert(logs);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(txt) flashLong(txt);<font></font>
  exit();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPage</span>(<span class="hljs-params">request,func,xhr</span>)</span>{
  <span class="hljs-keyword">if</span>(!request.method)<font></font>
    request.method=<span class="hljs-string">'GET'</span>;
  <span class="hljs-keyword">if</span>(!request.vars)request.vars=<span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span>(!xhr){<font></font>
    xhr=<span class="hljs-keyword">new</span> XMLHttpRequest();<font></font>
    xhr.responseType=<span class="hljs-string">"document"</span>;<font></font>
    xhr.timeout=<span class="hljs-number">20</span>*<span class="hljs-number">1000</span>;<font></font>
  }<font></font>
  xhr.open(request.method,<font></font>
    request.url,<span class="hljs-literal">true</span>);<font></font>
  xhr.onload=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(xhr.status==<span class="hljs-number">200</span> ||<font></font>
        xhr.status==<span class="hljs-number">401</span>){<font></font>
      log (requestToText(request)+<font></font>
        <span class="hljs-string">'HTTP status: '</span>+xhr.status+<span class="hljs-string">' '</span>+<font></font>
        xhr.statusText+<span class="hljs-string">'\n'</span>);<font></font>
        func(xhr,request);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      log(requestToText(request));<font></font>
      finalize(<span class="hljs-string">' HTTP: '</span>+<font></font>
        xhr.status+<span class="hljs-string">' '</span>+xhr.statusText);<font></font>
    }<font></font>
  }<font></font>
  xhr.onerror=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
    log(requestToText(request));<font></font>
    finalize(<span class="hljs-string">':  '</span>+
      <span class="hljs-string">''</span>);<font></font>
  }<font></font>
  xhr.ontimeout=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
    log(requestToText(request));<font></font>
    finalize(<span class="hljs-string">':  '</span>+
      <span class="hljs-string">''</span>);<font></font>
  }<font></font>
  xhr.send(request.vars);<font></font>
}<font></font>
<font></font>
logs=<span class="hljs-string">''</span>;<font></font>
getPage({<span class="hljs-string">'url'</span>:local(<span class="hljs-string">'url'</span>)},checkConn);
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Taper un script à partir du clavier du téléphone, malheureusement, ne favorise pas les commentaires, mais je vais décrire brièvement l'algorithme:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentative de chargement de la page spécifiée dans la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% url</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la réponse n'a pas d'en-tête d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">emplacement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> HTTP </font><font style="vertical-align: inherit;">, nous ne sommes pas redirigés, ce qui signifie que l'authentification n'est pas nécessaire pour le moment, quittez</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous chargeons la page vers laquelle nous avons été dirigés.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il y a un en-tête d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">emplacement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , revenez à l'étape 3</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la page a un formulaire de la liste dans la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% forms</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , affichez sa soumission et revenez à l'étape 3</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans d'autres cas, nous nous sommes authentifiés avec succès</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir terminé le script, nous avons obtenu cette tâche:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/acb/140/3e1/acb1403e172e48acb699aa299c48bace.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant la première icône de la rangée du bas, vous pouvez essayer de la lancer. Il est maintenant temps de descendre dans le métro pour le mettre en place! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le métro, en nous connectant au point d'accès, nous essayons de démarrer la tâche. S'il n'y a pas de problème évident avec la disponibilité du serveur, nous verrons un message similaire à celui illustré dans la figure suivante à gauche. Ci-dessous, nous voyons l'identifiant du formulaire qui se trouve sur la dernière page chargée - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth-form</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ce formulaire est clairement notre client, nous introduisons son nom dans les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">formulaires%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variables </font><font style="vertical-align: inherit;">et exécutons à nouveau la tâche, nous obtenons approximativement ce qui est montré dans la figure suivante au centre. Le nouvel identifiant de formulaire est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hidden_form</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ajoutez-le à la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% forms</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , maintenant sa valeur sera ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth-form, hidden_form</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'. </font><font style="vertical-align: inherit;">Nous recommençons la tâche et voyons approximativement ce qui est montré dans la figure suivante à droite - soit il y aura un formulaire sans identifiant, soit la marque «absent» (selon la ligne de métro). </font><font style="vertical-align: inherit;">Si nous lançons maintenant le navigateur, il sera clair que nous avons réussi l'authentification. </font><font style="vertical-align: inherit;">Définissez la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% debug</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur "0" et fermez la tâche - nous y voilà.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/a9c/0c2/6eb/a9c0c26eb5874153a28dc89c0240262b.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À vous maintenant de configurer le lancement automatique des tâches lorsque vous êtes connecté au point d'accès souhaité. </font><font style="vertical-align: inherit;">Nous allons dans l'onglet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profils</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et créons un nouveau profil qui sera activé après la connexion au point d'accès du métro de Moscou. </font><font style="vertical-align: inherit;">Une fois la description du point d'accès terminée, le Tasker nous demandera à quelle tâche associer ce profil, bien sûr, choisissez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metro Auth</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/3a5/7ef/5b5/3a57ef5b534f48f5a6b3ab5e00206a1f.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autre nuance: bien que rare, l'authentification vole toujours, bien que la déconnexion du point ne se soit pas produite. </font><font style="vertical-align: inherit;">S'il n'y a pas eu de déconnexion, il n'y a pas eu de reconnexion, ce qui signifie que le Tasker ne redémarrera pas la tâche, nous allons donc configurer le Tasker afin que l'authentification soit automatiquement vérifiée toutes les 2 minutes (l'intervalle minimum possible), pour cela, nous devons cliquer longuement sur la condition déjà configurée pour appeler le menu, dans lequel ajouter une condition temporaire dans laquelle définir l'intervalle.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/2b7/28a/9af/2b728a9affee411abb30c1174d941fb2.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voilà donc tout. </font><font style="vertical-align: inherit;">A partir de maintenant et jusqu'à ce que vous deviez changer les identifiants dans la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% forms</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , l'algorithme de vos actions lors de l'entrée dans le chariot est le suivant:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Activez le Wi-Fi;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendez que le message «L'authentification est terminée» à l'écran;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sourire mystérieusement et vaquer à vos occupations.</font></font></li>
</ol><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sur les conseils  </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Self_Perfection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai exporté le projet et l'ai mis dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un fichier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce fichier doit être téléchargé et placé dans le dossier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ sdcard / Tasker / projects</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis exécutez Tasker, appuyez longuement sur l'icône de la maison dans le coin inférieur gauche pour appeler le menu et sélectionnez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dans cette version, j'ai vérifié une fois toutes les deux minutes dans un profil distinct - cela devrait fonctionner plus efficacement.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr383109/">https://habr.com/ru/post/fr383109/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr383097/index.html">Windows 10 Insider Preview 10525 tue Google Chrome</a></li>
<li><a href="../fr383099/index.html">L'avenir de BMW: une bouteille d'eau et une torpille dans l'habitacle</a></li>
<li><a href="../fr383101/index.html">BioLite offre une source d'électricité respectueuse de l'environnement</a></li>
<li><a href="../fr383103/index.html">Sony SmartBand 2 suit la fréquence cardiaque et le stress</a></li>
<li><a href="../fr383107/index.html">Il est temps de fermer: Histoires des célèbres bourses de Chicago</a></li>
<li><a href="../fr383111/index.html">Il y a une guerre civile pour Bitcoin</a></li>
<li><a href="../fr383115/index.html">"Palette 3D" mettra les choses en ordre sur le bureau du propriétaire d'un stylo 3D</a></li>
<li><a href="../fr383117/index.html">AfterShokz Trekz Titanium ™: nouvelle version du casque audio à conduction osseuse</a></li>
<li><a href="../fr383119/index.html">Un autre examen de Sailfish OS ou de la farine du choix d'un système d'exploitation mobile approprié</a></li>
<li><a href="../fr383121/index.html">Quadrocopter a appris à trouver des réseaux et des gadgets vulnérables à haute altitude</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>