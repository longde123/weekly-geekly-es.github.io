<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥀 💌 👨🏻‍💻 Máquina virtual no ESP8266 para executar jogos 👇🏻 🌔 🌄</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="VM escrita por uma mão incerta das ciências humanas no ambiente de programação do Arduino usando código rápido e bicicletas. E também há um compilador...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Máquina virtual no ESP8266 para executar jogos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459714/">  VM escrita por uma mão incerta das ciências humanas no ambiente de programação do Arduino usando código rápido e bicicletas.  E também há um compilador para ele a partir de uma linguagem semelhante a C, escrita em JavaScript usando os mesmos métodos.  Sim  Você já pode se apressar em comentários, jogar pedras.  Bem, para aqueles que ainda estão interessados, convido você a continuar lendo. <br><br><img src="https://habrastorage.org/webt/id/lf/6y/idlf6yqnyzplrex2cq3waeu0txc.png" alt="Trolley de pão"><br><a name="habracut"></a><br>  Em geral, meu trabalho já foi um pouco coberto pela respeitada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">tormozedison</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Mas naquela época havia um protótipo esférico no vácuo.  E agora eu tenho um dispositivo RomanS, que ele gentilmente me forneceu para experiências absolutamente gratuitas.  Este dispositivo é chamado ESPboy.  Difere de outros tipos de artesanato por seu slot de compactação e expansão usando o chip MCP23017.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> você pode aprender mais sobre ele. <br><br>  Se alguém estiver interessado, como uma idéia tão estranha me veio à mente como uma máquina virtual em um microcontrolador, você pode lê-la sob o spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Antecedentes</b> <div class="spoiler_text">  Uma vez na escola, eu fui levado por um criador de jogos de ioiôs e, como muitos, fascinado por ele, não entendo o que.  Essas demos mal escritas e mal desenhadas ainda podiam se gabar de amigos, mas na Internet estavam se afogando entre outras semelhantes.  Percebi como era difícil escrever um jogo simples, sem mencionar um jogo sério em que você podia roubar as vacas.  Mas o desejo de escrever jogos não foi perdido.  Quando comprei um celular, descobri o Midlet Pascal e me diverti com ele por vários anos.  Afinal, percebi que escrever um jogo para um dispositivo fraco é mais fácil do que para o seu irmão mais velho mais poderoso.  Pelo menos, sempre se pode falar não de mãos tortas, mas dos recursos limitados da plataforma.  No entanto, os jogadores de botão deram lugar aos sensores outra chance de conquistar o mundo foi perdida.  No entanto, em algum momento eu percebi que poderia reviver meus sonhos usando um microcontrolador. <br><br>  Comecei escrevendo um jogo no arduino uno, onde você iria sem ele.  Então ela era minha única, e eu estava muito preocupado com o desempenho dela.  Eu tentei piscar o mínimo possível.  Mas o caminho do rake segue em pequenos passos.  Cada edição pequena do código fazia com que ele piscasse novamente e novamente.  E eu decidi escrever uma máquina virtual empilhada.  Afinal, existem enormes dois kilobytes de RAM para bytes de código e dados a bordo.  Mas quão lento era, mas por algum motivo faltava memória constantemente.  Provavelmente, o ponto principal é que todas as minhas motos estavam com rodas quadradas e andavam devagar.  Decidi escrever um emulador de chip 8 no Arduino Mega recém-chegado da China.  Claro, então eu queria escrever um emulador de gameboy para ela, o primeiro playstation e um supercomputador mais fácil.  Como resultado, entendi o principal.  A máquina virtual chip-8 era muito simples, excessivamente simples.  Tanto que, ao escrever seus jogos para multiplicação ou divisão, você teve que escrever uma sub-rotina lenta separada.  Então você precisa escrever sua VM, se livrando de uma falha fatal.  Nesse momento, vários outros esp8266 chegaram, com seu espaço em 160MHz. <br></div></div><br>  Se lhe parece que uma máquina virtual é um desperdício de recursos, também reescrevi meu emulador de chip-8.  Descobriu uma máquina virtual em uma máquina virtual em um microcontrolador.  Você provavelmente pode ir além e escrever uma máquina de Turing no chip-8. <br><br><h4>  ESP Little Game Engine Especificações </h4><br>  Uma máquina virtual contém 16 registros de 16 bits cada, um registro zero é um ponteiro de pilha.  Cada instrução é de byte duplo, algumas instruções contêm dois bytes de dados.  Memória endereçável de 64 KB.  No caso do ESP8266, 20 KB estão disponíveis.  O programa pode ser baixado do SPIFFS e UART.  Se desejar, você pode adicionar um download de um cartão de memória ou via Wi-Fi.  Além das instruções aritméticas comuns e das instruções para mover dados, há instruções separadas para trabalhar com sprites, tela e som.  Tamanho da tela 128 por 128 pixels.  Com 16 cores por ponto, a tela ocupa 8 KB de memória, a mesma quantidade de buffer para desenhar sprites e partículas.  Embora a biblioteca TFT_eSPI usada seja capaz de atualizar a tela mais de 60 vezes por segundo, tive que me limitar a 20 quadros por segundo.  Caso contrário, não havia tempo de processador suficiente para a máquina virtual.  Você pode desenhar blocos e 32 sprites de até 128x128 pixels, com a possibilidade de rotação e espelhamento.  Para economizar memória, você pode usar imagens de um bit ou compactação RLE.  A física é simplificada: detecção de colisões de sprites com sprites e ladrilhos, resolução de colisões, gravidade.  A tela é atualizada linha por linha somente se uma linha tiver alterado pixels.  A velocidade da VM, dependendo de quantas linhas são desenhadas no quadro, varia de 100 mil a 900 mil operações por segundo.  Você pode usar telas coloridas diferentes, há um alongamento suave da imagem nas proporções desejadas. <br><br><img src="https://habrastorage.org/webt/jf/ai/mv/jfaimvgh6rbtnum5u-lpdsslpws.png"><br>  <i>Alguns dos jogos escritos por mim podem ser vistos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .</i> <br><br>  Ao mesmo tempo que o VM para ESP8266, escrevi um emulador de JavaScript para o navegador.  Para não editar o bytecode manualmente, foi adicionado um assembler simples, com base na minha experiência com o assembler para o MOS6502.  Então eu decidi adicionar um idioma de nível superior.  No entanto, minha principal tarefa foi escrever rapidamente jogos simples, e não um código de assembly de depuração longo.  Pareceu-me que escrever seu compilador seria mais fácil do que adicionar LLVM.  E escrevi em JavaScript, porque sei que não é tão ruim quanto em outros idiomas.  No momento, ele está longe de oferecer suporte aos padrões C e, ao compilar, é possível encontrar facilmente um erro incompreensível em um local incompreensível.  Mas é rápido, porque leva menos de 2000 linhas. <br><br>  E agora à pergunta, por que escrevi tudo isso aqui.  Agora você já pode escrever e executar jogos.  No entanto, a perfeição ainda está longe.  Se alguém quiser me ajudar a finalizar o ESP LGE ou escrever meu próprio jogo, ficarei muito feliz.  Se você achou minha ideia interessante e deseja saber mais, terei prazer em responder às suas perguntas.  Eu aviso, o código do Arduino é bastante difícil de ler.  Em parte porque sou autodidata.  Em parte devido ao fato de eu tentar reduzir o número de chamadas de função para aumentar a velocidade do trabalho.  Como resultado, muitas funções contêm enormes passos de código.  Portanto, não permita que mulheres grávidas e crianças sejam exibidas na tela.  Gradualmente, tentarei corrigir isso e melhorar a legibilidade. <br><br>  E para quem leu, um exemplo de jogo.  São necessários menos de cem linhas e menos de 1 KB na forma compilada. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stickCount; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> key,previouseKey,takenSticks; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redraw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-comment"><span class="hljs-comment">//   setcolor(2); //   for(i = 0; i &lt; stickCount; i++) line(22 + i * 6, 74, 22 + i * 6, 84); //   setcolor(11); //  for(i = stickCount; i &lt; 15; i++) line(22 + i * 6, 74, 22 + i * 6, 84); //     setcolor(1); //   delayredraw(); } void playersMove(){ //    ,     .  while(key == previouseKey){ key = getkey(); } while(key != KEY_LEFT &amp;&amp; key != KEY_DOWN &amp;&amp; key != KEY_RIGHT){ key = getkey(); } if(key &amp; KEY_LEFT){ takenSticks = 1; }else if(key &amp; KEY_DOWN){ takenSticks = 2; }else{ takenSticks = 3; } printf("%d, ", takenSticks); stickCount -= takenSticks; previouseKey = key; } void computersMove(){ if(stickCount % 4){ //   ,    takenSticks = stickCount % 4; }else{ //      takenSticks = 1 + random(1); } stickCount -= takenSticks; printf("%d, ", takenSticks); } void game(){ // stickCount = 15; clearscreen(); //       gotoxy(8,0); puts(""); gotoxy(2,1); puts(" 1,2  3 .  ,   . :\n"); // 27,25  26   printf(" %c 1 %c 2 %c 3", 27, 25, 26); gotoxy(0,12); redraw(); while(1){ playersMove(); if(stickCount &lt;= 0){ gotoxy(3,8); puts(" "); return; } redraw(); computersMove(); redraw(); if(stickCount &lt;= 0){ gotoxy(3,8); puts(" "); return; } } } void main(){ while(1){ game(); //  settimer(1,1000); while(gettimer(1)){} while(getkey() == 0){} previouseKey = key; } }</span></span></code> </pre> <br>  Você pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">testá-lo</a> imediatamente.  Siga o link, clique em compilar e, em seguida, execute.  Se você quiser saber mais sobre as possibilidades do IDE, leia o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tutorial</a> .  Obrigado pela atenção. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt459714/">https://habr.com/ru/post/pt459714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt459704/index.html">LLVM IR e Go</a></li>
<li><a href="../pt459706/index.html">5 razões pelas quais você deve esquecer o Redux nos aplicativos React</a></li>
<li><a href="../pt459708/index.html">Design de Interface do Jogo. Brent Fox Sobre o que é o livro?</a></li>
<li><a href="../pt459710/index.html">Sobreviva a uma colisão frontal e por que a amnésia não é o que você pensa</a></li>
<li><a href="../pt459712/index.html">Mommy Hackers em um trabalho oficial: O que os Pentesters fazem</a></li>
<li><a href="../pt459716/index.html">Alguns aspectos da otimização de consultas LINQ no C # .NET para MS SQL Server</a></li>
<li><a href="../pt459718/index.html">10 dicas para revisar o código que você não gosta</a></li>
<li><a href="../pt459722/index.html">O que o desenvolvimento de equipes e o alpinismo têm em comum</a></li>
<li><a href="../pt459726/index.html">7 peças que você definitivamente não precisa fazer ao abrir um clube de robótica. Aqui não há necessidade de fazer</a></li>
<li><a href="../pt459728/index.html">Smartphone com a brisa: revisão ZTE Red Magic 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>