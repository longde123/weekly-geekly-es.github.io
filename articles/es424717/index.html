<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé® üíÇüèº üõÖ Copia de seguridad de una gran cantidad de proyectos web heterog√©neos üë©üèΩ‚Äç‚öïÔ∏è üíÆ üè¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parecer√≠a que el tema est√° trillado: se ha dicho y escrito mucho sobre el respaldo, por lo que no hay nada que reinventar la rueda, solo t√≥malo y hazl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Copia de seguridad de una gran cantidad de proyectos web heterog√©neos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/424717/"><p>  Parecer√≠a que el tema est√° trillado: se ha dicho y escrito mucho sobre el respaldo, por lo que no hay nada que reinventar la rueda, solo t√≥malo y hazlo.  Sin embargo, cada vez que el administrador del sistema de un proyecto web se enfrenta a la tarea de configurar copias de seguridad, para muchos queda suspendido en el aire con un gran signo de interrogaci√≥n.  ¬øC√≥mo recopilar la copia de seguridad de datos correctamente?  ¬øD√≥nde almacenar las copias de seguridad?  ¬øC√≥mo proporcionar el nivel necesario de almacenamiento retrospectivo de copias?  ¬øC√≥mo unificar el proceso de copia de seguridad para todo el zool√≥gico de varios software? </p><br><p><img src="https://habrastorage.org/webt/xk/rn/7r/xkrn7rrnask1pgpv4uvrby6tnrc.jpeg"></p><a name="habracut"></a><br><p>  Por nosotros mismos, resolvimos este problema por primera vez en 2011. Luego nos sentamos y escribimos nuestros scripts de respaldo.  A lo largo de los a√±os, solo los utilizamos, y proporcionaron con √©xito un proceso confiable para recopilar y sincronizar copias de seguridad de proyectos web de nuestros clientes.  Las copias de seguridad se almacenaron en nuestro almacenamiento externo o en otro, con la posibilidad de realizar un ajuste para un proyecto espec√≠fico. </p><br><p>  Debo decir que estos guiones funcionaron al m√°ximo.  Pero cuanto m√°s crec√≠amos, m√°s ten√≠amos diversos proyectos con diferentes softwares y repositorios externos que nuestros scripts no admit√≠an.  Por ejemplo, no ten√≠amos soporte para Redis y las copias de seguridad de MySQL y PostgreSQL que aparecieron m√°s tarde.  El proceso de copia de seguridad no fue monitoreado, solo hubo alertas por correo electr√≥nico. </p><br><p>  Otro problema fue el proceso de soporte.  Con los a√±os, nuestros scripts que alguna vez fueron compactos han crecido y se han convertido en un enorme monstruo inc√≥modo.  Y cuando nos reunimos y lanzamos una nueva versi√≥n, vali√≥ la pena desplegar la actualizaci√≥n para esa parte de los clientes que usaban la versi√≥n anterior con alg√∫n tipo de personalizaci√≥n. </p><br><p>  Como resultado, a principios de este a√±o, tomamos una decisi√≥n decidida: reemplazar nuestros viejos scripts de respaldo con algo m√°s moderno.  Por lo tanto, al principio nos sentamos y escribimos toda la lista de deseos para una nueva soluci√≥n.  Result√≥ aproximadamente lo siguiente: </p><br><ul><li>  Haga una copia de seguridad de los datos del software utilizado con m√°s frecuencia: <br><ul><li>  Archivos (copia discreta e incremental) </li><li>  MySQL (copias de seguridad en fr√≠o / en caliente) </li><li>  PostgreSQL (copias de seguridad en fr√≠o / en caliente) </li><li>  Mongodb </li><li>  Redis </li></ul></li><li>  Almacene copias de seguridad en repositorios populares: <br><ul><li>  Local </li><li>  FTP </li><li>  Ssh </li><li>  SMB </li><li>  Nfs </li><li>  Webdav </li><li>  S3 </li></ul></li><li>  Reciba alertas en caso de cualquier problema durante el proceso de respaldo </li><li>  Tenga un √∫nico archivo de configuraci√≥n que le permita administrar las copias de seguridad de forma centralizada </li><li>  Agregue soporte para nuevo software conectando m√≥dulos externos </li><li>  Especificar opciones adicionales para recolectar volcados </li><li>  Tener la capacidad de restaurar copias de seguridad por medios regulares </li><li>  F√°cil configuraci√≥n inicial </li></ul><br><h1 id="analiziruem-imeyuschiesya-resheniya">  Analizamos las soluciones disponibles. </h1><br><p>  Analizamos las soluciones de c√≥digo abierto que ya existen: </p><br><ul><li>  Bacula y sus tenedores, por ejemplo, Bareos </li><li>  Amanda </li><li>  Borg </li><li>  Duplicidad </li><li>  Duplicidad </li><li>  Rsnapshot </li><li>  Rdiff-backup </li></ul><br><p>  Pero cada uno de ellos ten√≠a sus inconvenientes.  Por ejemplo, Bacula est√° sobrecargado con funciones que no necesitamos, la configuraci√≥n inicial es una tarea bastante laboriosa debido a la gran cantidad de trabajo manual (por ejemplo, para escribir / buscar scripts de copia de seguridad de la base de datos), y para recuperar copias es necesario utilizar utilidades especiales, etc. </p><br><p>  Al final, llegamos a dos conclusiones importantes: </p><br><ol><li> Ninguna de las soluciones existentes nos satisfizo completamente; </li><li>  Parece que nosotros mismos ten√≠amos suficiente experiencia y locura para comenzar a escribir nuestra decisi√≥n. </li></ol><br><p>  Entonces lo hicimos. </p><br><h1 id="rozhdenie-nxs-backup">  El nacimiento de nxs-backup </h1><br><p>  Python fue elegido como el lenguaje para la implementaci√≥n: es f√°cil de escribir y mantener, flexible y conveniente.  Se decidi√≥ describir los archivos de configuraci√≥n en formato yaml. </p><br><p>  Para la comodidad de admitir y agregar copias de seguridad del nuevo software, se eligi√≥ una arquitectura modular donde el proceso de recopilaci√≥n de copias de seguridad de cada software espec√≠fico (por ejemplo, MySQL) se describe en un m√≥dulo separado. </p><br><h2 id="podderzhka-faylov-bd-i-udalyonnyh-hranilisch">  Soporte para archivos, bases de datos y almacenamiento remoto. </h2><br><p>  Actualmente, se admiten los siguientes tipos de copias de seguridad de archivos, bases de datos y repositorios remotos: </p><br><p>  DB: </p><br><ul><li>  MySQL (copias de seguridad en caliente / en fr√≠o) </li><li>  PostgreSQL (copias de seguridad en caliente / en fr√≠o) </li><li>  Redis </li><li>  Mongodb </li></ul><br><p>  Archivos: </p><br><ul><li>  Copia discreta </li><li>  Copia incremental </li></ul><br><p>  Repositorios remotos: </p><br><ul><li>  Local </li><li>  S3 </li><li>  SMB </li><li>  Nfs </li><li>  FTP </li><li>  Ssh </li><li>  Webdav </li></ul><br><h2 id="diskretnoe-rezervnoe-kopirovanie">  Copia de seguridad discreta </h2><br><p>  Para diferentes tareas, las copias de seguridad discretas o incrementales son adecuadas, por lo tanto, implementaron ambos tipos.  Puede especificar qu√© m√©todo usar a nivel de archivos y directorios individuales. </p><br><p>  Para copias discretas (archivos y bases de datos), puede establecer una retrospectiva en el formato de d√≠as / semanas / meses. </p><br><h2 id="inkrementnoe-rezervnoe-kopirovanie">  Copia de seguridad incremental </h2><br><p>  Las copias incrementales de los archivos se realizan de la siguiente manera: <br><img src="https://habrastorage.org/webt/c7/wk/ss/c7wksse4j_mxjkgdffptngpglkw.jpeg"></p><br><p>  A principios de a√±o, se realizar√° una copia de seguridad completa.  A continuaci√≥n, al comienzo de cada mes, una copia mensual incremental en relaci√≥n con la anual.  Dentro de la menstruaci√≥n: decenal incremental en relaci√≥n con el mensual.  Dentro de cada d√≠a incremental de diez d√≠as en relaci√≥n con el per√≠odo de diez d√≠as. </p><br><p>  Cabe se√±alar que si bien existen algunos problemas al trabajar con directorios que contienen una gran cantidad de subdirectorios (decenas de miles).  En tales casos, la recopilaci√≥n de copias se ralentiza significativamente y puede llevar m√°s de un d√≠a.  Estamos abordando activamente esta deficiencia. </p><br><h2 id="vosstanavlivaemsya-iz-inkrementnyh-bekapov">  Nos recuperamos de las copias de seguridad incrementales </h2><br><p>  No hay problemas con la recuperaci√≥n de copias de seguridad discretas: solo tome una copia para la fecha requerida e implem√©ntela con el tar habitual de la consola.  Las copias incrementales son un poco m√°s complicadas.  Para recuperarse, por ejemplo, el 24 de julio de 2018, debe hacer lo siguiente: </p><br><ol><li>  Expanda una copia de seguridad de un a√±o, incluso si en nuestro caso comienza desde el 1 de enero de 2018 (en la pr√°ctica, puede ser cualquier fecha, dependiendo de cu√°ndo se decidi√≥ implementar copias de seguridad incrementales) </li><li>  Tira sobre √©l un respaldo mensual para julio </li><li>  Enrollar el respaldo de la d√©cada del 21 de julio </li><li>  Roll up backup diario para el 24 de julio </li></ol><br><p>  Al mismo tiempo, para realizar 2-4 puntos, debe agregar el interruptor -G al comando tar, lo que indica que se trata de una copia de seguridad incremental.  Por supuesto, este no es el proceso m√°s r√°pido, pero cuando considera que a menudo no es necesario recuperarse de las copias de seguridad y la rentabilidad es importante, tal esquema resulta ser bastante efectivo. </p><br><h2 id="isklyucheniya">  Excepciones </h2><br><p>  A menudo, debe excluir archivos o directorios individuales de las copias de seguridad, por ejemplo, directorios con cach√©.  Esto se puede hacer especificando las reglas de excepci√≥n apropiadas: </p><br><div class="spoiler">  <b class="spoiler_title">ejemplo de archivo de configuraci√≥n</b> <div class="spoiler_text"><pre><code class="hljs ruby">- <span class="hljs-symbol"><span class="hljs-symbol">target:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/*/data</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ excludes: - exclude1/exclude</span></span>_file - exclude2 - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/exclude_3</span></span></code> </pre> </div></div><br><h2 id="rotaciya-bekapov">  Rotaci√≥n de respaldo </h2><br><p>  En nuestras antiguas secuencias de comandos, la rotaci√≥n se implementaba para que la copia anterior se eliminara solo despu√©s de que la nueva se ensamblara correctamente.  Esto llev√≥ a problemas en proyectos en los que el espacio para copias de seguridad, en principio, se asign√≥ exactamente para una copia; no se pudo recopilar una copia nueva all√≠ debido a la falta de espacio. </p><br><p>  En la nueva implementaci√≥n, decidimos cambiar este enfoque: primero elimine el anterior y solo luego recopile una nueva copia.  Y el proceso de recopilaci√≥n de copias de seguridad debe ser monitoreado para descubrir cualquier problema. </p><br><p>  Para las copias de seguridad discretas, un archivo se considera una copia antigua que va m√°s all√° del esquema de almacenamiento especificado en el formato de d√≠as / semanas / meses.  En el caso de las copias de seguridad incrementales, las copias de seguridad se almacenan de forma predeterminada durante un a√±o, y las copias antiguas se eliminan al comienzo de cada mes, mientras que los archivos del mismo mes del a√±o pasado se consideran copias de seguridad antiguas.  Por ejemplo, antes de recopilar una copia de seguridad mensual el 1 de agosto de 2018, el sistema verificar√° si hay copias de seguridad para agosto de 2017 y, de ser as√≠, las eliminar√°.  Esto permite un uso √≥ptimo del espacio en disco. </p><br><h2 id="logirovanie">  Registro </h2><br><p>  En cualquier proceso, y especialmente en las copias de seguridad, es importante mantenerse al d√≠a y saber si algo sali√≥ mal.  El sistema mantiene un registro de su trabajo y captura el resultado de cada paso: inicio / detenci√≥n de fondos, inicio / finalizaci√≥n de una tarea espec√≠fica, el resultado de recopilar una copia en un directorio temporal, el resultado de copiar / mover una copia de un directorio temporal a una ubicaci√≥n permanente, el resultado de la rotaci√≥n de respaldo, etc. .. </p><br><p>  Los eventos se dividen en 2 niveles: </p><br><ul><li>  <em>Informaci√≥n</em> : nivel de informaci√≥n: el vuelo es normal, la siguiente etapa se complet√≥ con √©xito, se ingresa la informaci√≥n correspondiente en el registro </li><li>  <em>Error</em> : nivel de error: algo sali√≥ mal, la siguiente etapa fall√≥, se realiza un registro de error correspondiente en el registro </li></ul><br><h2 id="e-mail-notifikacii">  Notificaciones por correo electr√≥nico </h2><br><p>  Al final de la recopilaci√≥n de copias de seguridad, el sistema puede enviar notificaciones por correo electr√≥nico. </p><br><p>  Se admiten 2 listas de destinatarios: </p><br><ul><li>  <em>Los administradores</em> son aquellos que sirven al servidor.  Solo reciben notificaciones de errores; no est√°n interesados ‚Äã‚Äãen notificaciones de operaciones exitosas </li><li>  <em>Usuarios comerciales</em> : en nuestro caso, estos son clientes que a veces desean recibir notificaciones para asegurarse de que todo est√© bien con las copias de seguridad.  O, por el contrario, no realmente.  Pueden elegir recibir un registro completo o solo un registro con errores. </li></ul><br><h2 id="struktura-konfiguracionnyh-faylov">  Estructura del archivo de configuraci√≥n </h2><br><p>  La estructura de los archivos de configuraci√≥n es la siguiente: </p><br><div class="spoiler">  <b class="spoiler_title">ejemplo de estructura</b> <div class="spoiler_text"><pre> <code class="bash hljs">/etc/nxs-backup ‚îú‚îÄ‚îÄ conf.d ‚îÇ ‚îú‚îÄ‚îÄ desc_files_local.conf ‚îÇ ‚îú‚îÄ‚îÄ external_clickhouse_local.conf ‚îÇ ‚îú‚îÄ‚îÄ inc_files_smb.conf ‚îÇ ‚îú‚îÄ‚îÄ mongodb_nfs.conf ‚îÇ ‚îú‚îÄ‚îÄ mysql_s3.conf ‚îÇ ‚îú‚îÄ‚îÄ mysql_xtradb_scp.conf ‚îÇ ‚îú‚îÄ‚îÄ postgresql_ftp.conf ‚îÇ ‚îú‚îÄ‚îÄ postgresql_hot_webdav.conf ‚îÇ ‚îî‚îÄ‚îÄ redis_local_ftp.conf ‚îî‚îÄ‚îÄ nxs-backup.conf</code> </pre> </div></div><br><p>  Aqu√≠ <em>/etc/nxs-backup/nxs-backup.conf</em> es el archivo de configuraci√≥n principal en el que se indican las configuraciones globales: </p><br><div class="spoiler">  <b class="spoiler_title">archivo de configuraci√≥n</b> <div class="spoiler_text"><pre> <code class="hljs sql">main: server_name: SERVER_NAME admin_mail: project-tech@nixys.ru client_mail: - '' mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@domain.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file_name: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/nxs-backup.log jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> </div></div><br><p>  La matriz de tareas (trabajos) contiene una lista de tareas (trabajos), que son una descripci√≥n de qu√© exactamente respaldar, d√≥nde almacenar y en qu√© cantidad.  Como regla general, se mueven a archivos separados (un archivo por trabajo), que se conectan mediante incluir en el archivo de configuraci√≥n principal. </p><br><p>  Tambi√©n se encargaron de optimizar el proceso de preparaci√≥n de estos archivos tanto como sea posible y escribieron un generador simple.  Por lo tanto, el administrador no necesita pasar tiempo buscando la plantilla de configuraci√≥n para alg√∫n servicio, por ejemplo, MySQL, sino simplemente ejecutar el comando: </p><br><pre> <code class="bash hljs">nxs-backup generate --storage <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scp --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> mysql --path /etc/nxs-backup/conf.d/mysql_local_scp.conf</code> </pre> <br><p>  La salida genera el archivo <em>/etc/nxs-backup/conf.d/mysql_local_scp.conf</em> : </p><br><div class="spoiler">  <b class="spoiler_title">Contenido del archivo</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: PROJECT-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: <span class="hljs-string"><span class="hljs-string">''</span></span> db_port: <span class="hljs-string"><span class="hljs-string">''</span></span> socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: <span class="hljs-string"><span class="hljs-string">''</span></span> db_password: <span class="hljs-string"><span class="hljs-string">''</span></span> auth_file: <span class="hljs-string"><span class="hljs-string">''</span></span> target: - all excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: scp <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> host: <span class="hljs-string"><span class="hljs-string">''</span></span> port: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> path_to_key: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> </div></div><br><p>  En el que solo queda sustituir algunos valores necesarios. </p><br><p>  Tomemos un ejemplo.  Supongamos que en nuestro servidor en el directorio / var / www hay dos sitios de la tienda en l√≠nea 1C-Bitrix (bitrix-1.ru, bitrix-2.ru), cada uno de los cuales funciona con su propia base de datos en diferentes instancias de MySQL (puerto 3306 para bitrix_1_db y puerto 3307 para bitrix_2_db). </p><br><p>  La estructura de archivos de un proyecto t√≠pico de Bitrix es aproximadamente la siguiente: </p><br><pre> <code class="bash hljs">‚îú‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ bitrix ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ admin ‚îÇ ‚îú‚îÄ‚îÄ backup ‚îÇ ‚îú‚îÄ‚îÄ cache ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ managed_cache ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ stack_cache ‚îÇ ‚îî‚îÄ‚îÄ .. ‚îú‚îÄ‚îÄ upload ‚îî‚îÄ‚îÄ ...</code> </pre> <br><p>  Como regla general, el directorio de <em>carga</em> pesa mucho y solo crece con el tiempo, por lo que se realizar√° una copia de seguridad incremental.  Todos los dem√°s directorios son discretos, con la excepci√≥n de los directorios con cach√© y copias de seguridad recopilados por herramientas nativas de Bitrix.  Deje que el esquema de almacenamiento de respaldo para estos dos sitios sea el mismo, mientras que las copias de los archivos deben almacenarse localmente y en el almacenamiento remoto de ftp, y la base de datos debe almacenarse solo en el almacenamiento remoto de smb. </p><br><p>  Los archivos de configuraci√≥n resultantes para tal configuraci√≥n se ver√°n as√≠: </p><br><div class="spoiler">  <b class="spoiler_title">bitrix-desc-files.conf (archivo de configuraci√≥n con descripci√≥n del trabajo para copia de seguridad discreta)</b> <div class="spoiler_text"><pre> <code class="hljs powershell"> - job: Bitrix<span class="hljs-literal"><span class="hljs-literal">-desc</span></span><span class="hljs-literal"><span class="hljs-literal">-files</span></span> type: desc_files tmp_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump_tmp sources: - target: - /var/www/*/ excludes: - bitrix/backup - bitrix/cache - bitrix/managed_cache - bitrix/stack_cache - upload gzip: yes storages: - storage: local enable: yes backup_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span> - storage: ftp enable: yes backup_dir: /nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/databases/mysql/dump host: ftp_host user: ftp_usr password: ftp_usr_pass store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-inc-files.conf (archivo de configuraci√≥n con descripci√≥n del trabajo para copia de seguridad incremental)</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript"> - job: Bitrix-inc-files type: inc_files sources: - target: - <span class="hljs-regexp"><span class="hljs-regexp">/var/www/</span></span>*<span class="hljs-regexp"><span class="hljs-regexp">/upload/</span></span> gzip: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> storages: - storage: ftp enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /nxs-backup/files/inc host: ftp_host user: ftp_usr password: ftp_usr_pass - storage: local enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /var/nxs-backup/files/inc</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-mysql.conf (archivo de configuraci√≥n con descripci√≥n del trabajo para copias de seguridad de MySQL)</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: Bitrix-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3306</span></span> db_user: bitrux_usr_1 db_password: password_1 target: - bitrix_1_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3307</span></span> db_user: bitrix_usr_2 db_password: password_2 target: - bitrix_2_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: smb <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump host: smb_host port: smb_port <span class="hljs-keyword"><span class="hljs-keyword">share</span></span>: smb_share_name <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: smb_usr <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: smb_usr_pass <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><h2 id="parametry-dlya-zapuska-sbora-bekapov">  Opciones para comenzar a recopilar copias de seguridad </h2><br><p>  En el ejemplo anterior, preparamos archivos de configuraci√≥n de trabajo para recopilar copias de seguridad de todos los elementos a la vez: archivos (discretos e incrementales), dos bases de datos y almacenarlos en almacenes locales y externos (ftp, smb). </p><br><p>  Queda por ejecutar todo el asunto.  El lanzamiento se realiza mediante el comando </p><br><pre> <code class="bash hljs">nxs-backup start <span class="hljs-variable"><span class="hljs-variable">$JOB_NAME</span></span> -c <span class="hljs-variable"><span class="hljs-variable">$PATH_TO_MAIN_CONFIG</span></span></code> </pre> <br><p>  Hay varios nombres de trabajo reservados: </p><br><ul><li>  <strong>archivos</strong> : ejecuci√≥n arbitraria de todos los <em>trabajos</em> con tipos <em>desc_files</em> , <em>inc_files</em> (es decir, en esencia, solo se <em>respaldan los</em> archivos) </li><li>  <strong>bases de datos</strong> : ejecuci√≥n aleatoria de todos los trabajos con los tipos <em>mysql</em> , <em>mysql_xtradb</em> , <em>postgresql</em> , <em>postgresql_hot</em> , <em>mongodb</em> , <em>redis</em> (es <em>decir</em> , <em>respalde</em> solo la base de datos) </li><li>  <strong>externo</strong> : ejecutar aleatoriamente todos los trabajos con el tipo <em>externo</em> (ejecutando solo scripts personalizados adicionales, m√°s sobre esto a continuaci√≥n) </li><li>  <strong>all</strong> : imitaci√≥n de ejecutar el comando uno por uno con <em>archivos de</em> trabajo, <em>bases de datos</em> , <em>externos</em> (valor predeterminado) </li></ul><br><p>  Dado que necesitamos obtener copias de seguridad de los datos de ambos archivos y la base de datos al mismo tiempo (o con una diferencia m√≠nima) en la salida, se recomienda ejecutar nxs-backup con el trabajo <strong>all</strong> , lo que garantizar√° la ejecuci√≥n coherente del trabajo descrito (Bitrix-desc- archivos, Bitrix-inc_files, Bitrix-mysql). </p><br><p>  Es decir, un punto importante: las copias de seguridad no se recopilar√°n en paralelo, sino de forma secuencial, una tras otra, con una diferencia de tiempo m√≠nima.  Adem√°s, en el pr√≥ximo inicio, el software mismo verifica el proceso que ya se est√° ejecutando en el sistema y, si se detecta, finalizar√° autom√°ticamente su trabajo con la marca correspondiente en el registro.  Este enfoque reduce significativamente la carga en el sistema.  Menos: las copias de seguridad de elementos individuales se recopilan no de una vez, sino con alguna diferencia horaria.  Pero mientras nuestra pr√°ctica muestra que esto no es cr√≠tico. </p><br><h2 id="vneshnie-moduli">  M√≥dulos externos </h2><br><p>  Como se mencion√≥ anteriormente, gracias a la arquitectura modular, las capacidades del sistema se pueden ampliar utilizando m√≥dulos de usuario adicionales que interact√∫an con el sistema a trav√©s de una interfaz especial.  El objetivo es poder agregar en el futuro soporte para copias de seguridad de software nuevo sin la necesidad de reescribir nxs-backup. </p><br><div class="spoiler">  <b class="spoiler_title">ejemplo de archivo de configuraci√≥n</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: TEST-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">''</span></span> storages: ‚Ä¶.</code> </pre> </div></div><br><p>  Se debe prestar especial atenci√≥n a la clave <strong>dump_cmd</strong> , donde el valor es el comando completo para ejecutar un script externo.  Adem√°s, al completar este comando, se espera que: </p><br><ul><li>  Se recopilar√° un archivo de datos de software listo para usar. </li><li>  Los datos se enviar√°n a stdout en formato json, de la forma: <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"full_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"ABS_PATH_TO_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"basename"</span></span>: <span class="hljs-string"><span class="hljs-string">"BASENAME_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTERNSION_OF_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gzip"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>/<span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><ul><li>  En este caso, las claves <em>basename</em> , <em>extension</em> , <em>gzip son</em> necesarias exclusivamente para la formaci√≥n del nombre de la copia de seguridad final. </li></ul></li><li>  En caso de completar con √©xito el script, el c√≥digo de retorno debe ser 0 y cualquier otro en caso de alg√∫n problema. </li></ul><br><p>  Por ejemplo, supongamos que tenemos un script para crear una instant√°nea, etcd <em>/etc/nxs-backup-ext/etcd.py</em> : </p><br><div class="spoiler">  <b class="spoiler_title">c√≥digo de script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env python3 # -*- coding: utf-8 -*- import json import os import subprocess import sys import tarfile def archive(snapshot_path): abs_tmp_path = '%s.tar' %(snapshot_path) with tarfile.open(abs_tmp_path, 'w:') as tar: tar.add(snapshot_path) os.unlink(snapshot_path) return abs_tmp_path def exec_cmd(cmdline): data_dict = {} current_process = subprocess.Popen([cmdline], stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True, executable='/bin/bash') data = current_process.communicate() data_dict['stdout'] = data[0][0:-1].decode('utf-8') data_dict['stderr'] = data[1][0:-1].decode('utf-8') data_dict['code'] = current_process.returncode return data_dict def main(): snapshot_path = "/var/backups/snapshot.db" dump_cmd = "ETCDCTL_API=3 etcdctl --cacert=/etc/ssl/etcd/ssl/ca.pem --cert=/etc/ssl/etcd/ssl/member-node1.pem"+\ " --key=/etc/ssl/etcd/ssl/member-node1-key.pem --endpoints 'https://127.0.0.1:2379' snapshot save %s" %snapshot_path command = exec_cmd(dump_cmd) result_code = command['code'] if result_code: sys.stderr.write(command['stderr']) else: try: new_path = archive(snapshot_path) except tarfile.TarError as e: sys.exit(1) else: result_dict = { "full_path": new_path, "basename": "etcd", "extension": "tar", "gzip": False } print(json.dumps(result_dict)) sys.exit(result_code) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p>  La configuraci√≥n para ejecutar este script es la siguiente: </p><br><div class="spoiler">  <b class="spoiler_title">archivo de configuraci√≥n</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: etcd-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">'/etc/nxs-backup-ext/etcd.py'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /var/nxs-backup/<span class="hljs-keyword"><span class="hljs-keyword">external</span></span>/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><p>  En este caso, el programa cuando ejecuta el trabajo, <em>etcd-external</em> : </p><br><ul><li>  Ejecute el script <em>/etc/nxs-backup-ext/etcd.py</em> sin par√°metros </li><li>  Una vez que se complete el script, verificar√° el c√≥digo de finalizaci√≥n y la disponibilidad de los datos necesarios en stdout </li><li>  Si todas las comprobaciones son exitosas, se usa el mismo mecanismo que con los m√≥dulos ya integrados, donde el valor de la clave full_path se usa como tmp_path.  De lo contrario, completar√° esta tarea con la marca correspondiente en el registro. </li></ul><br><h1 id="podderzhka-i-obnovlenie">  Soporte y actualizaci√≥n </h1><br><p>  El proceso de desarrollo y soporte del nuevo sistema de respaldo se ha implementado con todos los c√°nones de CI / CD.  No m√°s actualizaciones y ediciones de script en servidores de batalla.  Todos los cambios pasan a trav√©s de nuestro repositorio central de git en Gitlab, donde el ensamblaje de nuevas versiones de paquetes deb / rpm se registra en la tuber√≠a, que luego se cargan en nuestros repositorios deb / rpm.  Y despu√©s de eso, a trav√©s del administrador de paquetes, se entregan a los servidores del cliente final. </p><br><h1 id="kak-skachat-nxs-backup">  ¬øC√≥mo descargar nxs-backup? </h1><br><p>  Realizamos un proyecto de c√≥digo abierto nxs-backup.  Cualquiera puede descargarlo y usarlo para organizar el proceso de copia de seguridad en sus proyectos, as√≠ como modificarlo seg√∫n sus necesidades, escribir m√≥dulos externos. </p><br><p>  El c√≥digo fuente de nxs-backup se puede descargar desde el repositorio de Github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en este enlace</a> .  Tambi√©n hay instrucciones de instalaci√≥n y configuraci√≥n. </p><br><p>  Tambi√©n preparamos una imagen de Docker y la publicamos en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DockerHub</a> . </p><br><p>  Si tiene alguna pregunta durante el proceso de configuraci√≥n o uso, escr√≠banos.  Le ayudaremos a comprender y finalizar las instrucciones. </p><br><h1 id="zaklyuchenie">  Conclusi√≥n </h1><br><p>  En un futuro cercano, implementaremos la siguiente funcionalidad: </p><br><ul><li>  Integraci√≥n de monitoreo </li><li>  Cifrado de respaldo </li><li>  Interfaz basada en web para administrar la configuraci√≥n de respaldo </li><li>  Implementaci√≥n de copias de seguridad con nxs-backup </li><li>  Y mucho mas </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es424717/">https://habr.com/ru/post/es424717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es424701/index.html">Historias ficticias de TI sobre impostores y por qu√© estas pr√°cticas oscuras aparecieron en entrevistas</a></li>
<li><a href="../es424703/index.html">Y nuevamente sobre la despersonalizaci√≥n</a></li>
<li><a href="../es424709/index.html">Obras maestras de la construcci√≥n de columnas mundiales: 225 W RMS por 28 000 rublos</a></li>
<li><a href="../es424711/index.html">Del hidrogel al intestino de cerdo: materiales inusuales en rob√≥tica</a></li>
<li><a href="../es424713/index.html">Toda la verdad sobre RTOS. Art√≠culo # 12. Servicios para trabajar con tareas.</a></li>
<li><a href="../es424723/index.html">Seminarios web de Skillbox Friday: √∫tiles para principiantes y m√°s</a></li>
<li><a href="../es424725/index.html">Acerca de Oracle JDK 11+ (licencia y distribuci√≥n)</a></li>
<li><a href="../es424729/index.html">¬øPor qu√© el compilador convirti√≥ mi bucle condicional en un infinito?</a></li>
<li><a href="../es424731/index.html">Historial de soporte t√©cnico, o ¬øPor qu√© AutoCAD elimina objetos proxy?</a></li>
<li><a href="../es424733/index.html">Pastilla azul STM32F103 como PLC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>