<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜó üë©üèª‚Äç‚úàÔ∏è üçª Forma de onda adaptativa para su servicio de audio üåº üë®‚Äç‚ù§Ô∏è‚Äçüë® ü§üüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando necesitaba configurar un archivo de audio para un solo sitio de transmisi√≥n, adem√°s del panel de administraci√≥n, tambi√©n necesitaba un reproduc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Forma de onda adaptativa para su servicio de audio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412629/"><img src="https://habrastorage.org/webt/nw/k4/n3/nwk4n3zrjoklldqz2vfmpq25nzs.gif"><br><br>  Cuando necesitaba configurar un archivo de audio para un solo sitio de transmisi√≥n, adem√°s del panel de administraci√≥n, tambi√©n necesitaba un reproductor de audio.  La transmisi√≥n dur√≥ 40 minutos m√°s dos pausas musicales.  Usar Waveform en formatos tan largos es especialmente conveniente, por lo tanto, como muchos servicios de m√∫sica, decid√≠ usar esta soluci√≥n en el dise√±o del reproductor. <br><br>  Con el redise√±o futuro planificado del sitio y, posiblemente, las futuras aplicaciones m√≥viles, la forma de onda r√°ster aqu√≠ simplemente descansaba contra la cu√±a.  No es adaptativo, es extremadamente intensivo en recursos para redise√±ar si est√° en la trama. <br><a name="habracut"></a><br>  La conocida SOUNDCLOUD resolvi√≥ este problema en pantallas peque√±as moviendo toda la forma de onda en relaci√≥n con el centro est√°tico.  Pero no quiero eso. <br><br>  La transmisi√≥n de radio se realiz√≥ a trav√©s del panel de administraci√≥n, e inmediatamente hice m√°s copias comprimidas de los archivos de audio a trav√©s de ffmpeg.  Ser√≠a una tonter√≠a renunciar a sus capacidades y generar una forma de onda. <br><br><h4>  Algoritmo de acciones: </h4><br>  1. Generaci√≥n de forma de onda en un tama√±o m√≠nimo para almacenamiento <br>  2. Traducci√≥n al vector (JSON) <br>  3. Dibujando un jugador para esta matriz <br>  4. Implementaci√≥n de adaptabilidad: reducci√≥n uniforme de la matriz y regreso al paso 3 <br><br><h3>  Generaci√≥n de forma de onda </h3><br><br>  En el momento de la implementaci√≥n de este enfoque, los camaradas de la BBC a√∫n no hab√≠an publicado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la</a> salida en JSON <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en su utilidad</a> , por lo que recuerdo.  Y en este momento, recomendar√≠a que reconstruya su utilidad para eliminar la salida in√∫til de n√∫meros negativos y extra.  Viejo sobre canales de bitness y otras tonter√≠as. <br>  Mientras tanto, contin√∫e: <br><br>  Si tomamos el dise√±o de mi reproductor (aqu√≠ se reduce su ancho), veremos que hay 2 p√≠xeles por tira (m√°s un separador de 1 p√≠xel).  Esto significa que 600px nos dar√° 1200px de ancho. <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br>  Supongo que en el futuro ser√° extremadamente improbable que se necesite una presentaci√≥n m√°s grande del archivo de audio.  Bueno, si no tira el dise√±o sobre el ancho completo del monitor 4K, deber√≠a pensarlo, pero me detengo en 600x60px. <br><br>  Y ahora m√°s cerca del c√≥digo: <br><br><pre><code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">"ffmpeg -y -i '$name.mp3' -filter_complex 'aformat=channel_layouts=mono,compand,showwavespic=s=600x120,crop=in_w:in_h/2:0:0' -c:v png -pix_fmt monob -frames:v 1 '$png_path.png' &gt; /dev/null 2&gt;/dev/null &amp;"</span></span>);</code> </pre> <br>  <i>-filter_complex</i> - conecta filtros <br><br>  <i>aformat</i> - trabaja con sonido <br><br>  <i>channel_layouts</i> <br><br>  <i>-mono</i> - modo mono <br><br>  <i>-compand</i> es un compresor y expansor.  En este modo, los sonidos tanto silenciosos como fuertes se igualar√°n en volumen, lo que le permite obtener una forma de onda sin picos y sobrecargas en grabaciones silenciosas y fuertes.  La forma de onda, por as√≠ decirlo, siempre se estira al m√°ximo. <br><br>  <i>-showwavespic = s = 600x120</i> - s toma el tama√±o de la imagen. <br><br>  <i>-crop = in_w: in_h / 2: 0: 0</i> - <i>recorta</i> la imagen recibida.  Como regla general, la respuesta de frecuencia de salida se refleja alrededor del eje x.  Por lo tanto, rociamos, dejando solo la punta del iceberg. <br><br>  <i>-c: v png -pix_fmt monob -frames: v 1</i> - formato de imagen de salida, paleta de colores bw y solo el primer fotograma (no necesitamos animaci√≥n).  png8 es excelente para la calidad (sin p√©rdidas en nuestro caso) / lugar. <br><br>  <i>&gt; / dev / null 2&gt; / dev / null &amp;</i> enviar salida y datos de trabajo al abismo.  Y '&amp;' permite que php no espere a que la consola termine de funcionar, sino que contin√∫e. <br><br>  En la salida, obtenemos esta imagen: <br><br><img src="https://habrastorage.org/webt/4f/ee/s6/4fees6nkctphgo1oaxk6j9es7s0.png"><br>  Tama√±o del archivo final 2.4kb <br><br>  <i>Lo curioso es que hace un par de a√±os en lugar de blanco hab√≠a un color rojo.</i>  <i>Los desarrolladores, aparentemente, cambiaron los valores predeterminados.</i> <br><br><h3>  Convertir forma de onda a vector </h3><br>  La imagen resultante es la amplitud en Y y el tiempo en X. Es elemental traducirla en una matriz JSON unidimensional.  Donde los valores actuar√°n como valores de amplitud, y el tiempo es simplemente su √≠ndice ordinal. <br><br>  Decid√≠ hacer la traducci√≥n sobre la marcha, sin almacenar en cach√© el resultado, se hace muy r√°pidamente. <br>  Medimos el n√∫mero de p√≠xeles a lo largo de Y desde la parte superior a la primera, y pasamos al siguiente p√≠xel a lo largo de X. <br><br><pre> <code class="php hljs">$a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"test.png"</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $h = <span class="hljs-string"><span class="hljs-string">'60'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; 600 ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ) { //echo imagecolorat($aa, $i, $c ); // test color if(imagecolorat($a, $i, $c ) == "255") { $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br>  La matriz resultante consta de 600 valores. <br><br> <code>[46,28,34,35,34,35,26,33,39,29,29,30,30,30,33,33,28...]</code> <br> <br><h3>  Representaci√≥n del jugador por JSON </h3><br>  Para una barra de progreso de trabajo conveniente, tom√© el archivo progressor.js de Elliot Bentley.  Lo hizo para un servicio de transcripci√≥n de audio. <br><br>  <a href="">github.com/ejb/progressor.js</a> 2.76 KB <br><br>  Echemos un vistazo a nuestro jugador nuevamente. <br><br><img src="https://habrastorage.org/webt/p9/dk/wf/p9dkwfisywv4-irpqxeyteuqpvw.jpeg"><br><br>  La barra de progreso consta de dos capas: un fondo con barras grises y verde. <br><br>  Debajo, las im√°genes se dibujan con la funci√≥n getGraph. <br><br>  Su significado es dibujar columnas del grosor y color deseados con separadores de columnas. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); c.width = width; c.height = height; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = c.getContext(<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGraph</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fillStyle1,fillStyle2,fillStyle3</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fillStyle3) { <span class="hljs-comment"><span class="hljs-comment">//console.log(fillStyle1); var grd = ctx.createLinearGradient(0,120,0,0); grd.addColorStop(0.5,fillStyle1); grd.addColorStop(1,fillStyle2); fillStyle1 = grd; fillStyle2 = fillStyle3; } json.forEach(function(item, i, arr) { ctx.fillStyle = fillStyle1; ctx.fillRect(i * 3, height, 2, item - height); ctx.fillStyle = fillStyle2; var next = json[i + 1]; if( item &lt;= next ) { h2 = next; } else { h2 = item; } ctx.fillRect(i * 3 + 2, height, 1, h2 - height); }); return c.toDataURL(); }</span></span></code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠ hay un ejemplo de trabajo sin adaptabilidad.</a> <br><br><h3>  4. Implementaci√≥n de adaptabilidad </h3><br>  Ahora necesitamos reducir la matriz JSON en el cliente al tama√±o deseado y aqu√≠ tiene la adaptabilidad. <br><br><h3>  Planificar un </h3><br>  El primer m√©todo que viene a la mente es eliminar cada segundo, tercero, cuarto ... en un ciclo, por lo que no puede reducir la matriz en menos de la mitad, y la precisi√≥n de p√≠xeles no se puede lograr aqu√≠. <br><br>  Modificar la forma de onda eliminando valores de matriz es un callej√≥n sin salida.  Cuando haga esto, ver√° cu√°nto se desgarra impersonalmente la forma de onda, porque arroja extremos y no promedia la altura de los vecinos. <br><br>  Necesitamos algoritmos de remuestreo.  Hay una implementaci√≥n del algoritmo en js: <br><br>  <a href=""><b>largerTriangleThreeBuckets</b></a> <br><br>  Funciona bien, solo pide una entrada como una matriz, en cuyos √≠ndices recibir√° las coordenadas XY. Tenemos una matriz unidimensional, as√≠ que tuve que burlarme un poco y rehacer la funci√≥n.  Esto funciona as√≠: <br><br><img src="https://habrastorage.org/webt/mf/xx/wt/mfxxwtrk4jf5nddwlkqpmzu3__e.gif"><br><br>  Y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> puedes tocar con adaptativos como KDPV. <br><br>  Establezca el modo de vista donde el marco html estar√° a la derecha.  Luego puede cambiar el ancho de esta ventana. <br><br><h3>  Plan B - Puff </h3><br>  Sin embargo, todav√≠a no me gustar√≠a cargar el lado del cliente.  Por ejemplo, quiero 1000 puntos-5000, pero todo el ancho de la pantalla.  Si tengo m√°s puntos, ¬øc√≥mo se comportar√° esto en un m√≥vil?  Por un lado, esto no es absolutamente ning√∫n problema, no es tan caro, a juzgar por las demostraciones del algoritmo, mastica 5000 puntos f√°cilmente.  Pero, por otro lado, uno debe dar tanto como pide.  Cuesti√≥n de dise√±o. <br><br>  Elemental, si tiene Node.Js, puede transferir este c√≥digo al servidor.  Y si tienes php, puedes encontrar una implementaci√≥n de este algoritmo en php pero ... por qu√©, pens√©. <br><br>  ¬øD√≥nde est√°n los algoritmos de remuestreo?  En la misma lib nativa GD que usamos para generar JSON.  Simplemente pasamos el par√°metro del cliente en p√≠xeles del ancho requerido y redimensionamos nuestra forma de onda antes de convertir a JSON. <br><br>  Por lo tanto, expandir√© el c√≥digo escrito al principio. <br><br><pre> <code class="php hljs">$h = <span class="hljs-number"><span class="hljs-number">60</span></span>; $width_new = <span class="hljs-number"><span class="hljs-number">600</span></span>; $a = imagecreatefrompng(<span class="hljs-string"><span class="hljs-string">"$id.png"</span></span>); $width_old = imagesx($a); $aa = imagecreatetruecolor($width_new, $h); imagecopyresized($aa, $a, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $width_new, $h, $width_old, $h); imagetruecolortopalette($aa, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// horizontal movener while ( $i &lt; $width_new ) { // vertical movener $y = $h-1; $c = 0; while ( $c &lt; $h ){ //echo imagecolorat($aa, $i, $c ); // search what color is needed if(imagecolorat($aa, $i, $c ) == "1"){ $arr[$i] = $c; break; } else { $arr[$i] = $y; } $c++; } $i++; }; echo json_encode($arr);</span></span></code> </pre><br>  Despu√©s de eso, no puede preocuparse si necesita cambiar el dise√±o, el ancho del reproductor, expandirse a una aplicaci√≥n m√≥vil.  Todo parece bastante flexible y muy inteligente. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El codigo esta aqui</a> <br><br><div class="spoiler">  <b class="spoiler_title">.</b> <div class="spoiler_text">  Huevo de pascua <br><br>  Probablemente fue un d√≠a soleado.  La ventana de nuestra habitaci√≥n daba a dos viejos pisos de ladrillo de 9 pisos, que recuerdo cuando era adolescente, s√© que un anillo de tranv√≠a se abre detr√°s de ellos, un poco m√°s all√°: el antiguo hospital, justo detr√°s de la escuela, y el edificio actual con la oficina donde intento cavar. En sus memorias, este es un antiguo hospital inacabado, ahora un edificio puramente de oficinas.  Recuerdo c√≥mo en mi infancia, las fuerzas especiales entrenadas aqu√≠, se mostraban en televisi√≥n, asaltando vigorosamente una estructura de hormig√≥n, cubierta de todo lo que la rodeaba.  Y ahora, resulta que estoy en√©rgicamente impactando la reja brillante, bajando las escaleras y admirando la forma de distorsiones de este edificio en el reflejo del complejo residencial m√°s cercano.  (Cerca, a lo largo de la l√≠nea del tranv√≠a, se abre la pared del antiguo cementerio grande. Y en ella hay una inscripci√≥n en pintura verde "Mientras Boris est√° en el poder" y "Labor Rusia". Dios sabe qui√©n y cu√°ndo se hicieron, pero despu√©s de un par de d√©cadas todav√≠a leen pero permanecen completamente invisibles. No he visto m√°s del legado de los 90 un monumento m√°s antiguo en la ciudad). <br><br>  En nuestro piso superior est√° vac√≠o, como sucede vac√≠o en un paquete con trigo sarraceno que se inici√≥: hay mucho de todo debajo y apretado: algunos ladrones de geo-inteligencia especial, oficina de 2gis, luego seoshniki regular, y arriba casi no hay granos.  ¬øCrees que algo deber√≠a crecer a trav√©s de los pisos de algo aqu√≠, pero durante los 5 a√±os solo el limpiador de ventanas mir√≥ desde lo trascendental y desde el contador inmanente con ojos locos, que toc√≥ todas las puertas en el piso en busca de alguien? , quien explicar√° c√≥mo firmar un pago a trav√©s de un complemento loco para la banca por Internet debido a otra actualizaci√≥n del navegador. <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es412629/">https://habr.com/ru/post/es412629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es412619/index.html">myDribbble Meetup 2017 en Mosc√∫</a></li>
<li><a href="../es412621/index.html">C√≥mo convertirse en un mago (parte 3). Carta de Hogwarts</a></li>
<li><a href="../es412623/index.html">El nuevo kit para Star Citizen costar√° $ 27 mil</a></li>
<li><a href="../es412625/index.html">C√≥mo encontrar r√°pidamente y no perder especialistas en inteligencia artificial y ciencia de datos</a></li>
<li><a href="../es412627/index.html">Exposici√≥n Internacional CMEF & ICMD 2018 Primavera en Shanghai (Parte 2)</a></li>
<li><a href="../es412633/index.html">Experiencia en la configuraci√≥n y uso de WSL (subsistema de Linux en Windows 10)</a></li>
<li><a href="../es412637/index.html">¬øHacer o no redise√±ar logotipos? Esa es la pregunta</a></li>
<li><a href="../es412639/index.html">Lo que debe esperar para crear estrategias para operar en el intercambio: cu√°n eficiente es el aprendizaje autom√°tico</a></li>
<li><a href="../es412641/index.html">¬øQu√© tienen en com√∫n la miner√≠a, Georgia e Irkutsk?</a></li>
<li><a href="../es412643/index.html">C√≥mo integramos el sistema de pago en el proyecto ruso</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>