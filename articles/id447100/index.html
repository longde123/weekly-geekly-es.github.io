<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😏 👨🏼‍🏫 👋🏽 Bekerja dengan MS SQL dari Powershell di Linux 🎧 🍂 👆🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Artikel ini murni praktis dan didedikasikan untuk kisah sedih saya. 
 Mempersiapkan Zero Touch PROD untuk RDS (MS SQL), tentang mana semua telinga kit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bekerja dengan MS SQL dari Powershell di Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447100/"><h2>  Artikel ini murni praktis dan didedikasikan untuk kisah sedih saya. </h2><br>  Mempersiapkan <b>Zero Touch PROD</b> untuk RDS (MS SQL), tentang mana semua telinga kita berdengung, saya membuat presentasi (POC - Proof Of Concept) otomatisasi: satu set skrip PowerShell.  Setelah presentasi, ketika tepuk tangan yang meriah dan berkepanjangan mereda, menjadi tepuk tangan tanpa henti, mereka mengatakan kepada saya bahwa semua ini baik, tetapi hanya untuk alasan ideologis kita semua memiliki budak Jenkins yang berjalan di Linux! <br><br>  Apakah itu mungkin?  Untuk mengambil yang hangat, tabung DBA dari bawah Windows dan memasukkannya ke dalam panas PowerShell di Linux?  Bukankah itu kejam? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/no/ah/qm/noahqmkdy7zdvyywgyno-gzeh6e.jpeg" width="500"></div><br>  Saya harus menyelami kombinasi teknologi yang aneh ini.  Tentu saja, semua 30+ skrip saya berhenti berfungsi.  Yang mengejutkan saya, dalam satu hari kerja saya berhasil memperbaiki semuanya.  Saya menulis dalam pengejaran.  Jadi, jebakan apa yang bisa Anda temui saat porting skrip PowerShell dari Windows ke Linux? <br><a name="habracut"></a><br><h2>  sqlcmd vs Invoke-SqlCmd </h2><br>  Biarkan saya mengingatkan Anda tentang perbedaan utama di antara mereka.  Utilitas <b>sqlcmd</b> tua yang baik <b>juga</b> bekerja di Linux, dengan fungsi yang hampir sama.  Untuk mengeksekusi query, kita mengirimkan -Q, file input sebagai -i, dan output -o.  Ini hanya nama file, tentu saja, dibuat case-sensitive.  Jika Anda menggunakan -i, tulis di file di akhir: <br><br><pre><code class="sql hljs">GO EXIT</code> </pre> <br>  Jika tidak ada EXIT di akhir, maka sqlcmd akan menunggu input, dan jika tidak ada <b>GO</b> sebelum <b>EXIT</b> , perintah terakhir tidak akan berfungsi.  Semua output, pilih, pesan, cetak, dll., Sampai ke file output. <br><br>  Invoke-SqlCmd mengembalikan hasilnya sebagai DataSet, DataTables atau DataRows.  Oleh karena itu, jika Anda dapat memproses hasil pemilihan sederhana melalui <b>sqlcmd</b> , <b>mem</b> - <b>parsing</b> outputnya, maka mengeluarkan sesuatu yang rumit hampir tidak mungkin: ada <b>Invoke-SqlCmd</b> untuk ini.  Tetapi tim ini memiliki lelucon sendiri: <br><br><ul><li>  Jika Anda meneruskan file ke sana melalui <b>-InputFile</b> , maka <b>EXIT</b> tidak diperlukan, apalagi, itu memberikan kesalahan sintaksis </li><li>  <b>-OutputFile</b> tidak, perintah mengembalikan Anda hasilnya sebagai objek </li><li>  Ada dua sintaks untuk menentukan server: <b>-ServerInstance -Username -Password -Database</b> dan melalui <b>-ConnectionString</b> .  Anehnya, dalam kasus pertama, Anda tidak dapat menentukan port selain 1433. </li><li>  output teks, dari tipe PRINT, yang "ditangkap" oleh <b>sqlcmd dengan cara</b> dasar, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">merupakan masalah</a> untuk <b>Invoke-SqlCmd</b> </li><li>  Dan yang terpenting: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">cmdlet ini kemungkinan besar tidak ada di Linux Anda!</a> </li></ul><br>  Dan ini adalah masalah utama.  Hanya pada bulan Maret cmdlet ini <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tersedia untuk platform non-windows</a> , dan akhirnya kita dapat bergerak maju! <br><br><h2>  Substitusi variabel </h2><br>  Sqlcmd memiliki substitusi variabel dengan -v, seperti: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># $conn    sqlcmd $cmd = $conn + " -i D:\apps\SlaveJobs\KillSpid.sql -o killspid.res -v spid =`"" + $spid + "`" -v age =`"" + $age + "`"" Invoke-Expression $cmd</span></span></code> </pre> <br>  Dalam skrip SQL, kami menggunakan substitusi: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @spid=$(spid) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @age=$(age)</code> </pre> <br>  Jadi disini.  Di * nix <b>, substitusi variabel tidak berfungsi</b> .  <b>Opsi -v</b> diabaikan.  <b>Invoke-SqlCmd</b> mengabaikan <b>-Variabel</b> .  Meskipun parameter yang mengatur variabel itu sendiri diabaikan, pergantian itu berfungsi - Anda bisa menggunakan variabel apa pun dari Shell.  Namun, saya tersinggung oleh variabel dan memutuskan untuk tidak bergantung pada mereka sama sekali, dan saya bertindak kasar dan primitif, karena skrip untuk sql pendek: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># prepend the parameters "declare @age int, @spid int" | Add-Content "q.sql" "set @spid=" + $spid | Add-Content "q.sql" "set @age=" + $age | Add-Content "q.sql" foreach ($line in Get-Content "Sqlserver/Automation/KillSpid.sql") { $line | Add-Content "q.sql" } $cmd = "/opt/mssql-tools/bin/" + $conn + " -i q.sql -o res.log"</span></span></code> </pre> <br>  Ini, seperti yang Anda pahami, adalah ujian dari versi Unix. <br><br><h2>  Unggah file </h2><br>  Dalam versi Windows, setiap operasi yang saya lakukan disertai dengan audit: mereka melakukan sqlcmd, mendapat semacam penyalahgunaan dalam file output, melampirkan file ini ke plat audit.  Untungnya, SQL server bekerja pada server yang sama dengan Jenkins, itu dilakukan seperti ini: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> AuditUpload @<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @filename <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#multi (filer NVARCHAR(MAX)) set @sql='BULK INSERT #multi FROM '''+@filename +''' WITH (ROWTERMINATOR = ''\0'',CODEPAGE = ''ACP'')' exec (@sql) select @sql=filer from #multi update JenkinsAudit set multiliner=@sql where ID=@id return</span></span></code> </pre> <br>  Dengan demikian, kami menelan seluruh file BCP, dan mendorong tabel audit di bidang nvarchar (maks).  Tentu saja, seluruh sistem ini hancur, karena alih-alih SQL server yang saya dapatkan RDS, dan BULK INSERT tidak bekerja di \\ UNC karena upaya untuk mengambil kunci eksklusif ke file, dan dengan RDS ini pada awalnya hancur.  Jadi saya memutuskan untuk mengubah desain sistem, menyimpan garis audit demi baris: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> AuditOut ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, TextLine <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, n <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> )</code> </pre> <br>  Dan tulis ke tabel ini seperti ini: <br><br><pre> <code class="python hljs">function WriteAudit([string]$Filename, [string]$ConnStr, [string]$Tabname, [string]$Jobname) { <span class="hljs-comment"><span class="hljs-comment"># get $lastid of the last execution --    #create grid and populate it with data from file $audit = Get-Content $Filename $DT = new-object Data.DataTable $COL1 = new-object Data.DataColumn; $COL1.ColumnName = "ID"; $COL1.DataType = [System.Type]::GetType("System.Int32") $COL2 = new-object Data.DataColumn; $COL2.ColumnName = "TextLine"; $COL2.DataType = [System.Type]::GetType("System.String") $DT.Columns.Add($COL1) $DT.Columns.Add($COL2) foreach ($line in $audit) { $DR = $dt.NewRow() $DR.Item("ID") = $lastid $DR.Item("TextLine") = $line $DT.Rows.Add($DR) } # write it to table $conn=new-object System.Data.SqlClient.SQLConnection $conn.ConnectionString = $ConnStr $conn.Open() $bulkCopy = new-object ("Data.SqlClient.SqlBulkCopy") $ConnStr $bulkCopy.DestinationTableName = $Tabname $bulkCopy.BatchSize = 50000 $bulkCopy.BulkCopyTimeout = 0 $bulkCopy.WriteToServer($DT) $conn.Close() }</span></span></code> </pre><br>  Untuk memilih konten, pilih berdasarkan ID, pilih n (identitas) secara berurutan. <br><br>  Pada artikel selanjutnya saya akan membahas lebih detail tentang bagaimana semua ini berinteraksi dengan Jenkins. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id447100/">https://habr.com/ru/post/id447100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id447090/index.html">Latar Belakang: Bagaimana Proses Integrasi Terus Menerus Bekerja</a></li>
<li><a href="../id447092/index.html">Berapa kisaran antena ini? Mengukur kinerja antena dengan OSA103 Mini</a></li>
<li><a href="../id447094/index.html">Pembelajaran Mesin untuk Manajer: Sakramen Pemisahan</a></li>
<li><a href="../id447096/index.html">Tahun ini tidak akan ada robomobiles, tidak peduli apa yang dikatakan Ilon.</a></li>
<li><a href="../id447098/index.html">Mentransfer proyek dari Swift 4.2 ke Swift 5.0</a></li>
<li><a href="../id447102/index.html">Progress MS-11 Record: Yang Paling Menarik Di Depan</a></li>
<li><a href="../id447104/index.html">Bagaimana saya menanamkan RFID di tangan saya, dan kemudian NFC. Bagian 2</a></li>
<li><a href="../id447106/index.html">Rendah, tinggi, terakhir. GLC - elemen kelima dari Lakhta Center</a></li>
<li><a href="../id447108/index.html">Desentralisasi: Masalah Besar untuk Blockchain</a></li>
<li><a href="../id447110/index.html">Intisari materi menarik untuk pengembang ponsel # 293 (pada 1 - 7 April)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>