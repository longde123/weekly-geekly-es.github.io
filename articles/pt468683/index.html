<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞ ‚ùî üëÇ Teoria e pr√°tica da padroniza√ß√£o de servi√ßos Docker üòå üßîüèæ üîé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As informa√ß√µes sobre o t√≥pico da arquitetura de aplicativos de microsservi√ßo, que j√° conseguiu preencher sua vantagem, s√£o suficientes hoje para decid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teoria e pr√°tica da padroniza√ß√£o de servi√ßos Docker</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/antiplagiat/blog/468683/"><p>  As informa√ß√µes sobre o t√≥pico da arquitetura de aplicativos de microsservi√ßo, que j√° conseguiu preencher sua vantagem, s√£o suficientes hoje para decidir se elas se adequam ao seu produto ou n√£o.  E n√£o √© segredo que as empresas que decidiram escolher esse caminho precisam enfrentar muitos desafios culturais e de engenharia.  Uma das fontes de problemas √© a sobrecarga que se multiplica em todos os lugares, e isso se aplica igualmente √† rotina associada aos processos de produ√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/6g/-f/o5/6g-fo54hrcctez4vg4-avzkijc0.jpeg"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fonte da imagem:</a></em></sub> </p><br><p>  Como voc√™ pode imaginar, o Anti-pl√°gio √© exatamente uma empresa dessas, onde gradualmente chegou-se ao entendimento de que estamos com os microsservi√ßos ao longo do caminho.  Mas antes de come√ßar a comer o cacto, decidimos limp√°-lo e cozinh√°-lo.  E como todas as √∫nicas solu√ß√µes verdadeiras e corretas para cada uma s√£o √∫nicas, em vez de slides universais do DevOps com lindas flechas, decidimos compartilhar nossa pr√≥pria experi√™ncia e contar como j√° cobrimos uma parte consider√°vel de nosso caminho especial para, espero, sucesso. </p><a name="habracut"></a><br><p>  Se voc√™ est√° produzindo um produto verdadeiramente √∫nico, composto em larga escala por know-how, quase n√£o h√° chance de se esquivar desse caminho em particular, pois √© formado por muitos particulares: a partir da cultura e dos dados hist√≥ricos desenvolvidos na empresa, terminando com sua pr√≥pria especificidade e a pilha tecnol√≥gica usada . </p><br><p>  Uma das tarefas de qualquer empresa e equipe √© encontrar o equil√≠brio ideal entre liberdades e regras, e os microsservi√ßos levam esse problema a um novo n√≠vel.  Isso pode parecer contradizer a pr√≥pria id√©ia de microsservi√ßos, o que implica ampla liberdade na escolha de tecnologias, mas se voc√™ n√£o se concentrar diretamente em quest√µes arquitet√¥nicas e tecnol√≥gicas, mas observar os problemas de produ√ß√£o como um todo, o risco de estar em algum lugar da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">trama do</a> ‚ÄúJardim das Del√≠cias Terrenas‚Äù √© bastante tang√≠vel . </p><br><p> No entanto, no livro "Criando microsservi√ßos", Sam Newman oferece uma solu√ß√£o para esse problema, onde, literalmente, desde as primeiras p√°ginas, ele fala da necessidade de limitar a criatividade das equipes no √¢mbito de acordos t√©cnicos.  Portanto, uma das chaves para o sucesso, especialmente no contexto de um recurso limitado a m√£o livre, √© a padroniza√ß√£o de tudo o que s√≥ pode ser negociado e que ningu√©m realmente gostaria de fazer o tempo todo.  Ao elaborar acordos, criamos regras claras do jogo para todos os participantes na produ√ß√£o e opera√ß√£o dos componentes do sistema.  E conhecendo as regras do jogo, voc√™ deve concordar, jog√°-lo deve ser mais f√°cil e agrad√°vel.  No entanto, seguir essas regras em si pode se tornar uma rotina e causar desconforto aos participantes, o que leva diretamente a todos os tipos de desvios deles e, como conseq√º√™ncia, ao fracasso de toda a ideia.  E a sa√≠da mais √≥bvia √© colocar todos os acordos no c√≥digo, porque nem um √∫nico regulamento pode fazer o que a automa√ß√£o e as ferramentas convenientes podem usar, cujo uso √© intuitivo e natural. </p><br><p>  Seguindo nessa dire√ß√£o, fomos capazes de automatizar cada vez mais, e mais forte nosso processo se tornou um transportador de ponta a ponta para a produ√ß√£o de bibliotecas e micro (ou n√£o) servi√ßos. </p><br><p></p><div class="spoiler">  <b class="spoiler_title">Isen√ß√£o de responsabilidade</b> <div class="spoiler_text">  Este texto n√£o √© uma tentativa de indicar ‚Äúcomo deveria‚Äù, n√£o h√° solu√ß√µes universais, apenas uma descri√ß√£o de nossa posi√ß√£o no caminho evolutivo e na dire√ß√£o escolhida.  Todas as op√ß√µes acima podem n√£o agradar a todos, mas, no nosso caso, faz sentido em grande parte porque: <br><br>  - O desenvolvimento da empresa em 90% dos casos √© feito em C #; <br>  - N√£o havia necessidade de come√ßar do zero, parte dos padr√µes, abordagens e tecnologias aceitos - este √© o resultado da experi√™ncia acumulada ou simplesmente de um legado hist√≥rico; <br>  - Reposit√≥rios com projetos .NET, diferentemente de equipes, dezenas (e haver√° mais); <br>  - Gostamos de usar um pipeline de CI muito simples, evitando o aprisionamento do fornecedor o m√°ximo poss√≠vel; <br>  - Para um desenvolvedor .NET comum, as palavras "cont√™iner", "janela de encaixe" e "Linux" ainda podem causar surtos de horror existencial, mas n√£o quero quebrar ningu√©m no joelho. </div></div><br><h2 id="nemnogo-predystorii">  Um pouco de fundo </h2><br><p>  Na primavera de 2017, a Microsoft apresentou ao mundo uma pr√©via do .NET Core 2.0, e este ano os astr√≥logos de C # imediatamente correram para declarar o Ano do Linux, ent√£o ... </p><br><p><img src="https://habrastorage.org/webt/ex/zm/0r/exzm0rw_jaawe48lclqgweok1rq.png"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fonte da imagem:</a></em></sub> </p><br><p>  Por algum tempo, n√£o confiando em m√°gica, coletamos e testamos tudo no Windows e Linux, publicamos artefatos com alguns scripts SSH, tentamos configurar antigos pipelines de CI / CD no modo de faca su√≠√ßo.  Mas depois de algum tempo eles perceberam que est√°vamos fazendo algo errado.  Al√©m disso, as refer√™ncias a microsservi√ßos e cont√™ineres eram cada vez mais frequentes.  Por isso, tamb√©m decidimos aproveitar a onda do hype e explorar essas instru√ß√µes. </p><br><p>  J√° no est√°gio de reflex√£o sobre o poss√≠vel futuro do microsservi√ßo, surgiram v√°rias quest√µes, ignorando quais, arriscamos nesse mesmo futuro novos problemas que n√≥s mesmos ter√≠amos criado em troca de resolv√™-los. </p><br><p>  Primeiramente, quando observamos o lado da opera√ß√£o do mundo dos microsservi√ßos te√≥ricos sem regras, ficamos assustados com a perspectiva de caos com todas as conseq√º√™ncias resultantes, incluindo n√£o apenas a qualidade imprevis√≠vel do resultado, mas tamb√©m conflitos entre equipes, desenvolvedores e engenheiros.  E tentar fazer algumas recomenda√ß√µes, n√£o sendo capaz de garantir a conformidade com elas, parecia imediatamente um empreendimento vazio. </p><br><p>  Em segundo lugar, ningu√©m realmente sabia como criar cont√™ineres corretamente e escrever arquivos docker, que, no entanto, j√° come√ßaram a movimentar-se em nossos reposit√≥rios.  Al√©m disso, muitos ‚Äúleem em algum lugar‚Äù que nem tudo √© t√£o simples l√°.  Ent√£o, algu√©m teve que se aprofundar e descobrir, e depois retornar com as melhores pr√°ticas de montagem de cont√™ineres.  Mas a perspectiva de assumir o papel de um docker packer em tempo integral, deixado sozinho com pilhas de arquivos, por algum motivo, n√£o inspirou ningu√©m na empresa.  Al√©m disso, como se viu, mergulhar uma vez claramente n√£o √© suficiente, e mesmo olhando √† primeira vista, bom e certo, pode acabar errado ou simplesmente n√£o muito bom. </p><br><p>  E, em terceiro lugar, queria ter certeza de que as imagens obtidas com os servi√ßos n√£o apenas estivessem corretas do ponto de vista das pr√°ticas de cont√™ineres, mas tamb√©m seriam previs√≠veis em seu comportamento e teriam todas as propriedades e atributos necess√°rios para simplificar o controle dos cont√™ineres lan√ßados.  Em outras palavras, eu queria obter imagens com aplicativos igualmente configurados e gravar logs, fornecer uma interface √∫nica para obter m√©tricas, ter um conjunto consistente de r√≥tulos e similares.  Tamb√©m era importante que a montagem no computador do desenvolvedor produzisse o mesmo resultado que a montagem em qualquer sistema de IC, incluindo aprova√ß√£o em testes e gera√ß√£o de artefatos. </p><br><p>  Assim, nasceu a compreens√£o de que seria necess√°rio algum processo para gerenciar e centralizar novos conhecimentos, pr√°ticas e padr√µes, e o caminho desde o primeiro commit para uma imagem do docker completamente pronta para a infraestrutura do produto deve ser unificado e o mais automatizado poss√≠vel, n√£o indo al√©m dos termos que come√ßam com a palavra cont√≠nua. </p><br><h2 id="cli-vs-gui">  CLI vs.  GUI </h2><br><p>  O ponto de partida para um novo componente, seja um servi√ßo ou uma biblioteca, √© criar um reposit√≥rio.  Esse est√°gio pode ser dividido em duas partes: criando e configurando o reposit√≥rio na hospedagem do sistema de controle de vers√£o (temos o Bitbucket) e inicializando-o com a cria√ß√£o de uma estrutura de arquivos.  Felizmente, j√° existiam v√°rios requisitos para ambos.  Portanto, formaliz√°-los em c√≥digo era uma tarefa l√≥gica. </p><br><p>  Ent√£o, qual deve ser o nosso reposit√≥rio: </p><br><ul><li>  Localizado em um dos projetos, no qual nome, direitos de acesso, pol√≠ticas para aceita√ß√£o de solicita√ß√µes pull, etc; </li><li>  Cont√™m arquivos e diret√≥rios necess√°rios, como: <br><ul><li> arquivo com a configura√ß√£o e as informa√ß√µes sobre o reposit√≥rio <code>SolutionInfo.props</code> (mais sobre isso abaixo); </li><li>  c√≥digos-fonte do projeto no diret√≥rio <code>src</code> ; </li><li>  <code>.gitignore</code> , <code>README.md</code> , etc. </li></ul></li><li>  Conter os subm√≥dulos Git necess√°rios; </li><li>  O projeto deve ser derivado de um dos modelos. </li></ul><br><p>  Como a API REST do Bitbucket fornece controle total sobre a configura√ß√£o dos reposit√≥rios, um utilit√°rio especial foi criado para interagir com ela - o gerador de reposit√≥rio.  No modo pergunta-resposta, ela recebe do usu√°rio todos os dados necess√°rios e cria um reposit√≥rio que atende totalmente a todos os nossos requisitos, a saber: </p><br><ul><li>  Define um projeto no Bitbucket para escolher; </li><li>  Valida o nome de acordo com nosso contrato; </li><li>  Faz todas as configura√ß√µes necess√°rias que n√£o podem ser herdadas do projeto; </li><li>  Atualiza a lista de modelos personalizados (usamos o modelo de <a href="">dotnet</a> ) para o projeto e sugere a sua escolha; </li><li>  Preenche as informa√ß√µes m√≠nimas necess√°rias sobre o reposit√≥rio no arquivo de configura√ß√£o e nos documentos <code>*.md</code> ; </li><li>  Ele conecta subm√≥dulos √† configura√ß√£o de pipeline de CI / CD (no nosso caso, s√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bamboo Specs</a> ) e scripts de montagem. </li></ul><br><p>  Em outras palavras, o desenvolvedor, iniciando um novo projeto, inicia o utilit√°rio, preenche v√°rios campos, seleciona o tipo de projeto e recebe, por exemplo, o ‚ÄúHello world!‚Äù Completamente finalizado.  um servi√ßo que j√° esteja conectado ao sistema de IC, de onde o servi√ßo pode at√© ser publicado se voc√™ fizer uma confirma√ß√£o que altere a vers√£o para diferente de zero. </p><br><p>  O primeiro passo foi dado.  Sem trabalho manual e erros, procurando documenta√ß√£o, registros e SMS.  Agora vamos ao que foi gerado l√°. </p><br><h2 id="struktura">  Estrutura </h2><br><p>  A padroniza√ß√£o da estrutura do reposit√≥rio criou ra√≠zes conosco por um longo tempo e foi necess√°ria para simplificar a montagem, a integra√ß√£o com o sistema de IC e o ambiente de desenvolvimento.  Inicialmente, partimos da ideia de que o pipeline no IC deve ser t√£o simples e, como voc√™ pode imaginar, padr√£o, o que garantiria a portabilidade e a reprodutibilidade da montagem.  Ou seja, o mesmo resultado pode ser facilmente obtido em qualquer sistema de IC e no local de trabalho do desenvolvedor.  Portanto, tudo o que n√£o se relaciona aos recursos de um ambiente de integra√ß√£o cont√≠nua espec√≠fico √© submetido a um subm√≥dulo Git especial e √© um sistema de constru√ß√£o auto-suficiente.  Mais precisamente, o sistema de padroniza√ß√£o de montagem.  O pipeline em si, com uma aproxima√ß√£o m√≠nima, deve executar apenas o script <code>build.sh</code> , pegar um relat√≥rio nos testes e iniciar uma implanta√ß√£o, se necess√°rio.  Para maior clareza, vamos ver o que acontece se voc√™ gerar o reposit√≥rio <em>SampleService</em> em um projeto com o nome falado <em>Sandbox</em> . </p><br><pre> <code class="plaintext hljs">. ‚îú‚îÄ‚îÄ [bamboo-specs] ‚îú‚îÄ‚îÄ [devops.build] ‚îÇ ‚îú‚îÄ‚îÄ build.sh ‚îÇ ‚îî‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ [docs] ‚îú‚îÄ‚îÄ [.scripts] ‚îú‚îÄ‚îÄ [src] ‚îÇ ‚îú‚îÄ‚îÄ [CodeAnalysis] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Bootstrap] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Client] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Tests] ‚îÇ ‚îú‚îÄ‚îÄ Directory.Build.props ‚îÇ ‚îú‚îÄ‚îÄ NLog.config ‚îÇ ‚îú‚îÄ‚îÄ NuGet.Config ‚îÇ ‚îî‚îÄ‚îÄ Sandbox.SampleService.sln ‚îú‚îÄ‚îÄ .gitattributes ‚îú‚îÄ‚îÄ .gitignore ‚îú‚îÄ‚îÄ .gitmodules ‚îú‚îÄ‚îÄ CHANGELOG.md ‚îú‚îÄ‚îÄ README.md ‚îî‚îÄ‚îÄ SolutionInfo.props</code> </pre> <br><p>  Os dois primeiros diret√≥rios s√£o subm√≥dulos do Git.  <code>bamboo-specs</code> √© ‚ÄúPipeline as Code‚Äù para o sistema Atlassian Bamboo CI (poderia haver algum arquivo Jenkins em seu lugar), <code>devops.build</code> √© o nosso sistema de compila√ß√£o, o qual discutirei em mais detalhes abaixo.  O diret√≥rio <code>.scripts</code> tamb√©m <code>.scripts</code> .  O projeto .NET em si est√° localizado em <code>src</code> : <code>NuGet.Config</code> cont√©m a configura√ß√£o do reposit√≥rio privado do <acronym>NuGet</acronym> , <code>NLog.config</code> configura√ß√£o em tempo de <acronym>desenvolvimento</acronym> do <acronym>NLog</acronym> .  Como voc√™ pode imaginar, usar o NLog em uma empresa tamb√©m √© um dos padr√µes.  Entre as coisas interessantes aqui est√° o arquivo <code>Directory.Build.props</code> quase m√°gico.  Por alguma raz√£o, poucas pessoas conhecem essa possibilidade em projetos .NET, como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">personaliza√ß√£o do assembly</a> .  Em resumo, os arquivos com os nomes <code>Directory.Build.props</code> e <code>Directory.Build.targets</code> importados automaticamente para seus projetos e permitem configurar propriedades comuns para todos os projetos em um √∫nico local.  Por exemplo, √© assim que conectamos o analisador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StyleCop.Analyzers</a> e sua configura√ß√£o do diret√≥rio <code>CodeAnalysis</code> a todos os projetos em estilo de c√≥digo, definimos regras de vers√£o e alguns atributos comuns para bibliotecas e pacotes ( <em>empresa</em> , <em>direitos autorais</em> etc.) e tamb√©m conectamos via <code>&lt;Import&gt;</code> arquivo <code>SolutionInfo.props</code> , que √© precisamente o mesmo arquivo de configura√ß√£o do reposit√≥rio, discutido acima.  Ele j√° cont√©m a vers√£o atual, informa√ß√µes sobre os autores, a URL do reposit√≥rio e sua descri√ß√£o, al√©m de v√°rias propriedades que afetam o comportamento do sistema de montagem e os artefatos resultantes. </p><br><div class="spoiler">  <b class="spoiler_title">Exemplo `SolutionInfo.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"devops.build/SolutionInfo.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product name --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product version. Version 0.0.0 wouldn't be published! --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project name which contains Main() --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService.Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Exposed port --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span>4000/tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- DOTNET_SYSTEM_GLOBALIZATION_INVARIANT value. See https://github.com/dotnet/corefx/blob/master/Documentation/architecture/globalization-invariant-mode.md --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Documentation URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/browse/README.md<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Your name here --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span>User Name &amp;lt;username@contoso.com&amp;gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project description --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span>The sample service for demo purposes.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bamboo plan key (required for Bamboo Specs --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span>SMPL<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemplo `Directory.Build.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Exists('..\SolutionInfo.props')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\SolutionInfo.props"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Link</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CopyToOutputDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Never"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StyleCop.Analyzers"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PrivateAssets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"all"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span>$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.ruleset<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable XML docs generating--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable C# 7.x features --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span>latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default base version --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BaseVersion)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default build number and format --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BuildNumber)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.String]::Format('{0:0000}',$(BuildNumber)))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default version suffix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>local<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- empty version suffix instead of 'prod' --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == 'prod'"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- format version prefix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span>$(BaseVersion).$(BuildNumber)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- disable IsPackable by default --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span>$(RepositoryUrl)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span>Contoso<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span>Copyright $([System.DateTime]::Now.Date.Year) Contoso Ltd<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h2 id="sborka">  Assembl√©ia </h2><br><p>  Vale mencionar imediatamente que eu e meus colegas j√° tivemos uma experi√™ncia bem-sucedida no uso de diferentes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sistemas de compila√ß√£o</a> .  E, em vez de ponderar uma ferramenta existente com funcionalidade completamente incomum, decidiu-se fazer outra, especializada em nosso novo processo, e deixar a antiga em paz para realizar suas tarefas como parte de projetos legados.  A id√©ia da corre√ß√£o era o desejo de obter uma ferramenta que transformasse o c√≥digo em uma imagem do docker que atenda a todos os nossos requisitos, usando um √∫nico processo padr√£o, ao mesmo tempo em que elimina a necessidade de os desenvolvedores se aprofundarem nos meandros da montagem, mas preserva a possibilidade de alguma personaliza√ß√£o. </p><br><p>  A sele√ß√£o de uma estrutura adequada foi iniciada.  Com base nos requisitos de reprodutibilidade do resultado, tanto na constru√ß√£o de m√°quinas com Linux quanto nas m√°quinas Windows de qualquer desenvolvedor, a verdadeira plataforma cruzada e o m√≠nimo de depend√™ncias predefinidas se tornaram uma condi√ß√£o essencial.  Em momentos diferentes, consegui conhecer bastante bem algumas das estruturas de montagem para desenvolvedores .NET: do MSBuild e suas monstruosas configura√ß√µes XML, que foram posteriormente traduzidas para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Psake</a> (Powershell), at√© o ex√≥tico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FAKE</a> (F #).  Mas desta vez eu queria algo novo e leve.  Al√©m disso, j√° estava decidido que a montagem e o teste deveriam ser executados inteiramente em um ambiente de cont√™iner isolado, portanto, n√£o planejei executar dentro de nada al√©m dos comandos CLI do Docker e Git, ou seja, a maior parte do processo deveria ter sido descrita no arquivo Dockerfile. <br>  Naquela √©poca, o FAKE 5 e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cake</a> for .NET Core ainda n√£o estavam prontos; portanto, com uma plataforma cruzada, esses projetos eram mais ou menos.  Mas o meu querido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PowerShell 6 Core</a> j√° foi lan√ßado e eu o usei ao m√°ximo.  Portanto, decidi voltar para o Psake novamente e, enquanto me vira, me deparei com um interessante projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Invoke-Build</a> , que √© repensar o Psake e, como o pr√≥prio autor aponta, √© o mesmo, apenas melhor e mais f√°cil.  Assim √©.  N√£o vou me debru√ßar sobre isso em detalhes na estrutura deste artigo, observarei apenas que a compacidade me suborna se todas as fun√ß√µes b√°sicas dessa classe de produtos estiverem dispon√≠veis: </p><br><ul><li>  A sequ√™ncia de a√ß√µes √© descrita por um conjunto de tarefas inter-relacionadas (tarefas), que podem ser controladas usando suas interdepend√™ncias e condi√ß√µes adicionais. </li><li>  Existem v√°rios auxiliares √∫teis, por exemplo, exec {} para manipular corretamente os c√≥digos de sa√≠da do aplicativo do console. </li><li>  Qualquer exce√ß√£o ou interrup√ß√£o do uso de Ctrl + C ser√° processada corretamente em um bloco Exit-Build interno especial.  Por exemplo, voc√™ pode excluir todos os arquivos tempor√°rios, um ambiente de teste ou desenhar um relat√≥rio agrad√°vel aos olhos. </li></ul><br><p><img src="https://habrastorage.org/webt/nw/sg/0g/nwsg0gzd3fo0a-ep6b60pfqce98.png"></p><br><h2 id="universalnyy-dockerfile">  Dockerfile gen√©rico </h2><br><p>  O pr√≥prio Dockerfile e o conjunto usando a <code>docker build</code> fornecem recursos de parametriza√ß√£o bastante fracos, e a flexibilidade dessas ferramentas n√£o √© um pouco maior do que a de uma al√ßa de p√°.  Al√©m disso, existem v√°rias maneiras de tornar a imagem ‚Äúerrada‚Äù, muito grande, insegura, pouco intuitiva ou simplesmente imprevis√≠vel.  Felizmente, <a href="">a documenta√ß√£o da Microsoft</a> j√° oferece v√°rios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exemplos de Dockerfile</a> , que permitem entender rapidamente os conceitos b√°sicos e criar seu primeiro Dockerfile, melhorando gradualmente mais tarde.  Ele j√° usa um padr√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√°rios est√°gios</a> e cria uma imagem especial " <a href="">Test Runner</a> " para executar testes. </p><br><h2 id="multi-stage-pattern-i-argumenty">  Padr√£o e argumentos em v√°rios est√°gios </h2><br><p>  O primeiro passo √© dividir os est√°gios de montagem em outros menores e adicionar novos.  Portanto, vale destacar o lan√ßamento da <code>dotnet build</code> do <code>dotnet build</code> como um est√°gio separado, pois para projetos que cont√™m apenas bibliotecas, n√£o faz sentido executar a <code>dotnet publish</code> .  Agora, a nosso crit√©rio, s√≥ podemos executar as etapas de montagem necess√°rias usando <br> <code>dotnet build --target &lt;name&gt;</code> <br>  Por exemplo, aqui estamos coletando um projeto contendo apenas bibliotecas.  Os artefatos aqui s√£o apenas pacotes NuGet, o que significa que n√£o faz sentido coletar uma imagem de tempo de execu√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/vn/_a/a3/vn_aa3w7oodzrpythwrixomkhs8.png"></p><br><p>  Ou j√° estamos construindo um servi√ßo, mas a partir do ramo de recursos.  N√£o precisamos de artefatos dessa montagem, √© importante apenas passar nos testes e na verifica√ß√£o de sa√∫de. </p><br><p><img src="https://habrastorage.org/webt/fo/ua/l1/foual199bsvqf2u7mk6xgjzbw9q.png"></p><br><p>  A pr√≥xima coisa a fazer √© parametrizar o uso de imagens b√°sicas.  J√° h√° algum tempo, no Dockerfile, a diretiva <code>ARG</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pode ser colocada</a> fora dos est√°gios de constru√ß√£o e os valores transferidos podem ser usados ‚Äã‚Äãno nome da imagem base. </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG BUILD_BASE=mcr.microsoft.com/dotnet/core/sdk:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/runtime:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${BUILD_BASE} AS restore ... FROM ${RUNTIME_BASE} AS runtime ...</code> </pre> <br><p>  Ent√£o, temos novas oportunidades, √† primeira vista, e n√£o oportunidades √≥bvias.  Primeiro, se queremos criar uma imagem com um aplicativo ASP.NET Core, a imagem de tempo de execu√ß√£o precisar√° de uma imagem diferente: <code>mcr.microsoft.com/dotnet/core/aspnet</code> .  O par√¢metro com uma imagem b√°sica n√£o padr√£o deve ser salvo na configura√ß√£o do reposit√≥rio <code>SolutionInfo.props</code> e passado como argumento durante a montagem.  Tamb√©m facilitamos ao desenvolvedor o uso de outras vers√µes das imagens do .NET Core: visualiza√ß√µes, por exemplo, ou mesmo personalizadas (voc√™ nunca sabe!). </p><br><p>  Em segundo lugar, a capacidade de "expandir" o Dockerfile √© ainda mais interessante, tendo participado das opera√ß√µes em outro assembly, cujo resultado ser√° tomado como base na prepara√ß√£o da imagem de tempo de execu√ß√£o.  Por exemplo, alguns de nossos servi√ßos usam JavaScript e Vue.js, cujo c√≥digo prepararemos em uma imagem separada, simplesmente adicionando um Dockerfile "em expans√£o" ao reposit√≥rio: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM node:alpine AS install WORKDIR /build COPY package.json . RUN npm install FROM install AS src COPY [".babelrc", ".eslintrc.js", ".stylelintrc", "./"] COPY ClientApp ./ClientApp FROM src AS publish RUN npm run build-prod FROM ${RUNTIME_BASE} AS appbase COPY --from=publish /build/wwwroot/ /app/wwwroot/</code> </pre> <br><p>  Vamos coletar essa imagem com a tag, que passaremos para o est√°gio de montagem da imagem de tempo de execu√ß√£o do servi√ßo ASP.NET como argumento para RUNTIME_BASE.  Assim, voc√™ pode expandir a montagem o quanto quiser, inclusive, pode parametrizar o que n√£o pode fazer na <code>docker build</code> .  Deseja parametrizar a adi√ß√£o de Volume?  F√°cil: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${RUNTIME_BASE} AS runtime ARG VOLUME VOLUME ${VOLUME}</code> </pre> <br><p>  Iniciamos a montagem deste Dockerfile quantas vezes quisermos adicionar diretivas VOLUME.  Usamos a imagem resultante como base para o servi√ßo. </p><br><h2 id="zapusk-testov">  Executando testes </h2><br><p>  Em vez de executar testes diretamente nas etapas de montagem, √© mais correto e mais conveniente fazer isso em um cont√™iner especial "Test Runner".  Transmitindo brevemente a ess√™ncia dessa abordagem, observo que ela permite: </p><br><ul><li>  Execute todos os lan√ßamentos agendados, mesmo se um deles travar; </li><li>  Monte o diret√≥rio do sistema de arquivos host no cont√™iner para receber um relat√≥rio de teste, que √© vital ao criar no sistema de IC; </li><li>  Execute o teste em um ambiente tempor√°rio passando o nome de sua rede para o <code>docker run --network &lt;test_network_name&gt;</code> . </li></ul><br><p>  O √∫ltimo par√°grafo significa que agora podemos executar n√£o apenas testes de unidade, mas tamb√©m testes de integra√ß√£o.  Descrevemos o ambiente, por exemplo, em <code>docker-compose.yaml</code> e o executamos por toda a compila√ß√£o.  Agora voc√™ pode verificar a intera√ß√£o com o banco de dados ou nosso outro servi√ßo e salvar os logs deles, caso precise deles para an√°lise. </p><br><p>  Sempre verificamos a imagem de tempo de execu√ß√£o resultante para passar na verifica√ß√£o de integridade, que tamb√©m √© um tipo de teste.  Um ambiente de teste tempor√°rio pode ser √∫til aqui se o servi√ßo que est√° sendo testado tiver depend√™ncias em seu ambiente. </p><br><p>  Tamb√©m observo que a abordagem com os cont√™ineres de corredor montados no est√°gio com a <code>dotnet build</code> servir√° muito bem para o lan√ßamento da <code>dotnet publish</code> <code>dotnet pack</code> , <code>dotnet pack</code> <code>dotnet nuget push</code> e <code>dotnet nuget push</code> .  Isso nos permitir√° salvar artefatos de montagem localmente. </p><br><h2 id="healthcheck-i-zavisimosti-os">  Verifica√ß√£o de integridade e depend√™ncias do SO </h2><br><p>  Muito rapidamente ficou claro que nossos servi√ßos padronizados ainda seriam √∫nicos √† sua maneira.  Eles podem ter requisitos diferentes para pacotes pr√©-instalados do sistema operacional na imagem e diferentes maneiras de verificar a verifica√ß√£o de integridade.  E se o curl √© adequado para verificar o status de um aplicativo da Web, ent√£o para um back-end de gRPC ou, al√©m disso, um servi√ßo sem cabe√ßa, ele ser√° in√∫til e tamb√©m ser√° um pacote extra no cont√™iner. </p><br><p>  Para dar aos desenvolvedores a oportunidade de personalizar a imagem e expandir sua configura√ß√£o, usamos o contrato em v√°rios scripts especiais que podem ser redefinidos no reposit√≥rio: </p><br><pre> <code class="plaintext hljs">.scripts ‚îú‚îÄ‚îÄ healthcheck.sh ‚îú‚îÄ‚îÄ run.sh ‚îî‚îÄ‚îÄ runtime-deps.sh</code> </pre> <br><p>  O script <code>healthcheck.sh</code> cont√©m os comandos necess√°rios para verificar o status: </p><br><ul><li><p>  Para a web usando curl: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe curl -sIf -o /dev/null -w "%{http_code}\n" 127.0.0.1/health || exit 1</span></span></code> </pre> <br></li><li><p>  Outros servi√ßos usando nosso pr√≥prio utilit√°rio cli: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe healthcheck || exit 1</span></span></code> </pre> <br></li></ul><br><p>  Usando o <code>runtime-deps.sh</code> , as depend√™ncias s√£o instaladas e, se necess√°rio, s√£o executadas quaisquer outras a√ß√µes necess√°rias no sistema operacional b√°sico para o funcionamento normal do aplicativo dentro do cont√™iner.  Exemplos t√≠picos: </p><br><ul><li><p>  Para um aplicativo da web: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache curl icu-libs</span></span></code> </pre> <br></li><li><p>  Para servi√ßo gRPC: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache libc6-compat</span></span></code> </pre> <br></li></ul><br><p>  Portanto, a maneira de gerenciar depend√™ncias e verificar o estado √© padronizada, mas h√° espa√ßo para alguma flexibilidade.  Quanto ao <code>run.sh</code> , √© mais adiante. </p><br><h2 id="entrypoint-skript">  Script de ponto de entrada </h2><br><p>  Tenho certeza de que todos que ao menos uma vez escreveram seu Dockerfile se perguntaram qual diretiva usar - <code>CMD</code> ou <code>ENTRYPOINT</code> .  Al√©m disso, essas equipes tamb√©m t√™m duas op√ß√µes de sintaxe, que da maneira mais dram√°tica afetam o resultado.  N√£o explicarei a diferen√ßa em detalhes, repetindo depois daqueles que j√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esclareceram tudo</a> .  Apenas recomendo lembrar que em 99% das situa√ß√µes √© correto usar ENTRYPOINT e a sintaxe exec: </p><br><p>  PONTO DE ENTRADA ["/ caminho / para / execut√°vel"] </p><br><p>  Caso contr√°rio, o aplicativo iniciado n√£o poder√° processar corretamente os comandos do SO, como SIGTERM, etc., e voc√™ tamb√©m poder√° ter problemas na forma de processos zumbis e tudo relacionado ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">problema do PID 1</a> .  Mas e se voc√™ quiser iniciar o cont√™iner sem iniciar o aplicativo?  Sim, voc√™ pode substituir o ponto de entrada: <br> <code>docker run --rm -it --entrypoint ash &lt;image_name&gt; &lt;params&gt;</code> <br>  N√£o parece muito confort√°vel e intuitivo, certo?  Mas h√° boas not√≠cias: voc√™ pode fazer melhor!  Ou seja, use um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script de ponto de entrada</a> .  Esse script permite tornar arbitrariamente complexa a inicializa√ß√£o ( <a href="">exemplo</a> ), processamento de par√¢metros e o que voc√™ desejar. </p><br><p>  No nosso caso, por padr√£o, o cen√°rio mais simples, mas ao mesmo tempo funcional, √© usado: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e if [ ! -z "$1" ] &amp;&amp; $(command -v $1 &gt;/dev/null 2&gt;&amp;1) then exec $@ else exec /usr/bin/dotnet /app/${ENTRY_PROJECT}.dll $@ fi</span></span></code> </pre> <br><p>  Permite controlar o lan√ßamento do cont√™iner de maneira muito intuitiva: <br>  <code>docker run &lt;image&gt; env</code> - apenas executa env na imagem, mostrando vari√°veis ‚Äã‚Äãde ambiente. <br>  <code>docker run &lt;image&gt; -param1 value1</code> - inicia o servi√ßo com os argumentos especificados. </p><br><p>  Separadamente, √© preciso prestar aten√ß√£o ao comando <code>exec</code> : sua presen√ßa antes de chamar o aplicativo execut√°vel fornecer√° o cobi√ßado PID 1 em seu cont√™iner. </p><br><h2 id="chto-esche">  O que mais </h2><br><p>  Obviamente, durante mais de um ano e meio de uso, o sistema de compila√ß√£o acumulou muitas funcionalidades diferentes.  Al√©m de gerenciar as condi√ß√µes de lan√ßamento de v√°rios est√°gios, trabalhando com o armazenamento de artefatos, vers√£o e outros recursos, tamb√©m foi desenvolvido nosso "padr√£o" do cont√™iner.  Ele foi preenchido com atributos importantes que o tornam mais previs√≠vel e conveniente em termos administrativos: </p><br><ul><li>  Todas as etiquetas de imagem necess√°rias est√£o instaladas: vers√µes, n√∫meros de revis√£o, links para documenta√ß√£o, autor e outros. </li><li>  No cont√™iner de tempo de execu√ß√£o, a configura√ß√£o do NLog √© redefinida para que, ap√≥s a publica√ß√£o, todos os logs sejam imediatamente apresentados em um formul√°rio estruturado usando json, cuja vers√£o √© versionada. </li><li>  As regras de an√°lise est√°tica e quaisquer outros padr√µes s√£o mantidos automaticamente atualizados. </li></ul><br><p>  Essa ferramenta, √© claro, sempre pode ser aprimorada e desenvolvida.  Tudo depende de necessidades e imagina√ß√£o.  Por exemplo, al√©m de tudo, era poss√≠vel empacotar utilit√°rios cli adicionais em uma imagem.  Um desenvolvedor pode facilmente coloc√°-los em uma imagem especificando no arquivo de configura√ß√£o apenas o nome do utilit√°rio necess√°rio e o nome do projeto .NET a partir do qual ele deve ser constru√≠do (por exemplo, nossa verifica√ß√£o de <code>healthcheck</code> ). </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  Descrito aqui √© apenas parte de uma abordagem integrada √† padroniza√ß√£o.     ,     ,        ,      ,      ,    .        .          ,  . </p><br><p>             ,      Linux    ,   -      .       , ,          . , ,  ,    Code Style,      ,           . </p><br><p> ,    !   ,    ¬´  ¬ª,       ,             .      ,    Docker        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468683/">https://habr.com/ru/post/pt468683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468657/index.html">Dan√ßas com apoio: tipos e formas de apoio. Sistemas de suporte trabalhando em batalha</a></li>
<li><a href="../pt468663/index.html">End2 End Approach em tarefas de reconhecimento autom√°tico de fala</a></li>
<li><a href="../pt468665/index.html">Mas √© hora de comprar um irrigador?</a></li>
<li><a href="../pt468677/index.html">O an√∫ncio do smartphone Xiaomi Mi Mix Alpha</a></li>
<li><a href="../pt468679/index.html">Os ABCs de seguran√ßa no Kubernetes: autentica√ß√£o, autoriza√ß√£o, auditoria</a></li>
<li><a href="../pt468687/index.html">Analisamos as novas iniciativas do Banco Central para regular o mercado de a√ß√µes: 3 grupos de investidores, restri√ß√µes para iniciantes</a></li>
<li><a href="../pt468689/index.html">Registrando seu neg√≥cio de TI em Cingapura: o que devo fazer?</a></li>
<li><a href="../pt468691/index.html">Drivers perigosos de terceiros em seu sistema ou LOLDrivers</a></li>
<li><a href="../pt468693/index.html">Como a automa√ß√£o destr√≥i os funcion√°rios do Walmart</a></li>
<li><a href="../pt468695/index.html">Meu primeiro hack: um site que permite definir qualquer senha de usu√°rio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>