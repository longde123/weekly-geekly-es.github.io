<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïö üó≥Ô∏è üë®üèø‚Äçüíª ¬øQu√© estamos haciendo mal con Spring? üë©üèø‚Äçüíº üò´ üåÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo quiero compartir observaciones sobre algunos antipatrones encontrados en el c√≥digo de aplicaciones que se ejecutan en Spring. Todos e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>¬øQu√© estamos haciendo mal con Spring?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472994/"><p> En este art√≠culo quiero compartir observaciones sobre algunos antipatrones encontrados en el c√≥digo de aplicaciones que se ejecutan en Spring.  Todos ellos aparecieron de una forma u otra en el c√≥digo viviente: o los encontr√© en las clases existentes o los descubr√≠ mientras le√≠a el trabajo de colegas. </p><br><p>  Espero que sea interesante para usted, y si despu√©s de leer reconoce sus "pecados" y se embarca en el camino de la correcci√≥n, estar√© doblemente complacido.  Tambi√©n te insto a que compartas tus propios ejemplos en el comentario, agregaremos los m√°s curiosos e inusuales a la publicaci√≥n. </p><a name="habracut"></a><br><h4 id="autowired">  Autowired </h4><br><p> El genial y terrible <code>@Autowired</code> es toda una era en primavera.  Todav√≠a no puede prescindir de √©l cuando escribe pruebas, pero en el c√≥digo principal (PMSM) es claramente superfluo.  En varios de mis proyectos recientes, no estaba en absoluto.  Durante mucho tiempo escribimos as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ServiceDependency; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AnotherServiceDependency; <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><p>  Las razones por las que se critica la inyecci√≥n de dependencia a trav√©s de campos y establecedores ya se han descrito en detalle, en particular <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Una alternativa es la implementaci√≥n a trav√©s del constructor.  Siguiendo el enlace, se describe un ejemplo: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyA dependencyA; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyB dependencyB; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyC dependencyC; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DependencyA dependencyA, DependencyB dependencyB, DependencyC dependencyC)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyA = dependencyA; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyB = dependencyB; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyC = dependencyC; }</code> </pre> <br><p>  Parece m√°s o menos decente, pero imagina que tenemos 10 dependencias (s√≠, s√≠, s√© que en este caso deben agruparse en clases separadas, pero ahora no se trata de eso).  La imagen ya no es tan atractiva: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyA dependencyA; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyB dependencyB; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyC dependencyC; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyD dependencyD; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyE dependencyE; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyF dependencyF; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyG dependencyG; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyH dependencyH; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyI dependencyI; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DependencyJ dependencyJ; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* ... */</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyA = dependencyA; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyB = dependencyB; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyC = dependencyC; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyD = dependencyD; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyE = dependencyE; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyF = dependencyF; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyG = dependencyG; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyH = dependencyH; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyI = dependencyI; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dependencyJ = dependencyJ; }</code> </pre> <br><p>  Francamente, el c√≥digo parece monstruoso. </p><br><p>  Y aqu√≠, muchos olvidan que aqu√≠ tambi√©n <del>  violinista </del>  <code>@Autowired</code> no <code>@Autowired</code> necesario!  Si una clase tiene solo un constructor, Spring (&gt; = 4) comprender√° que las dependencias deben implementarse a trav√©s de este constructor.  Entonces podemos tirarlo, reemplaz√°ndolo con el Lombok <code>@AllArgsContructor</code> .  O incluso mejor: en <code>@RequiredArgsContructor</code> , sin olvidar declarar todos los campos necesarios como <code>final</code> y recibir una inicializaci√≥n segura del objeto en un entorno de subprocesos m√∫ltiples (siempre que todas las dependencias tambi√©n se inicialicen de forma segura): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DI</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyA dependencyA; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyB dependencyB; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyC dependencyC; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyD dependencyD; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyE dependencyE; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyF dependencyF; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyG dependencyG; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyH dependencyH; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyI dependencyI; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DependencyJ dependencyJ; }</code> </pre> <br><h4 id="staticheskie-metody-v-utilitnyh-klassah-i-enum-funkcii">  M√©todos est√°ticos en clases de utilidad y funciones enum. </h4><br><p>  Bloody E a menudo tiene la tarea de convertir objetos de soporte de datos de una capa de aplicaci√≥n a objetos similares de otra capa.  Para esto, todav√≠a se usan clases de utilidad con m√©todos est√°ticos como este (recuerde, en el a√±o 2019): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@UtilityClass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Utils</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> UserDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entityToDto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserEntity user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... } }</span></span></code> </pre> <br><p>  Los usuarios m√°s avanzados que leen libros inteligentes son conscientes de las propiedades m√°gicas de las enumeraciones: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Function implements Function&lt;UserEntity, UserDto&gt; { INST; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UserDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserEntity user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... } }</span></span></code> </pre> <br><p>  Es cierto que, en este caso, la llamada a√∫n se produce a un solo objeto, y no a un componente controlado por Spring. <br>  Incluso los chicos (y las chicas) m√°s avanzados conocen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MapStruct</a> , que te permite describir todo en una sola interfaz: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Mapper</span></span>(componentModel = <span class="hljs-string"><span class="hljs-string">"spring"</span></span>, unmappedTargetPolicy = ReportingPolicy.ERROR) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CriminalRecommendationMapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">UserDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserEntity user)</span></span></span></span>; }</code> </pre> <br><p>  Ahora tenemos el componente de resorte.  Parece una victoria  Pero el diablo est√° en los detalles, y sucede que la victoria se vuelve abrumadora.  En primer lugar, los nombres de los campos deben ser los mismos (de lo contrario, comienzan las hemorroides), lo que no siempre es conveniente, y en segundo lugar, si hay transformaciones complejas de los objetos procesados, surgen dificultades adicionales.  Bueno, es necesario agregar Mapstruct en s√≠. </p><br><p>  Y pocas personas recuerdan la forma anticuada, pero sin embargo simple y funcional de obtener un convertidor accionado por resorte: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.convert.converter.Converter; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserEntityToDto</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Converter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserEntity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDto</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UserDto </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserEntity user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... } }</span></span></code> </pre> <br><p>  La ventaja aqu√≠ es que en otra clase, solo necesito escribir </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DI</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Converter&lt;UserEntity, UserDto&gt; userEnityToDto; }</code> </pre> <br><p>  ¬°y Spring resolver√° todo por s√≠ solo! </p><br><h4 id="nenuzhnyy-qualifier">  Calificador de residuos </h4><br><p>  Caso de vida: la aplicaci√≥n funciona con dos bases de datos.  En consecuencia, hay dos fuentes de datos ( <code>java.sql.DataSource</code> ), dos administradores de transacciones, dos grupos de repositorios, etc.  Todo esto se describe convenientemente en dos configuraciones separadas.  Esto es para Postgre: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PsqlDatasourceConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-meta"><span class="hljs-meta">@Primary</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span>(prefix = <span class="hljs-string"><span class="hljs-string">"spring.datasource.psql"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DataSource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">psqlDataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataSourceBuilder.create().build(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SpringLiquibase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">primaryLiquibase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ProfileChecker checker, @Qualifier(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"psqlDataSource"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> DataSource dataSource ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isTest = checker.isTest(); SpringLiquibase liquibase = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringLiquibase(); liquibase.setDataSource(dataSource); liquibase.setChangeLog(<span class="hljs-string"><span class="hljs-string">"classpath:liquibase/schema-postgre.xml"</span></span>); liquibase.setShouldRun(isTest); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> liquibase; } }</code> </pre> <br><p>  Y esto es para DB2: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Db2DatasourceConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span>(prefix = <span class="hljs-string"><span class="hljs-string">"spring.datasource.db2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DataSource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">db2DataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataSourceBuilder.create().build(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SpringLiquibase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">liquibase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ProfileChecker checker, @Qualifier(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"db2DataSource"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> DataSource dataSource ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isTest = checker.isTest(); SpringLiquibase liquibase = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringLiquibase(); liquibase.setDataSource(dataSource); liquibase.setChangeLog(<span class="hljs-string"><span class="hljs-string">"classpath:liquibase/schema-db2.xml"</span></span>); liquibase.setShouldRun(isTest); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> liquibase; } }</code> </pre> <br><p>  Como tengo dos bases de datos, para las pruebas quiero rodar dos DDL / DML separados en ellas.  Dado que ambas configuraciones se cargan al mismo tiempo cuando la aplicaci√≥n est√° <code>@Qualifier</code> , si <code>@Qualifier</code> , Spring perder√° su designaci√≥n de destino y, en el mejor de los casos, fallar√°.  Resulta que los <code>@Qualifier</code> engorrosos y propensos a los ara√±azos, y sin ellos no funciona.  Para romper el punto muerto, debe darse cuenta de que la dependencia se puede obtener no solo como un argumento, sino tambi√©n como un valor de retorno, reescribiendo el c√≥digo de esta manera: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PsqlDatasourceConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-meta"><span class="hljs-meta">@Primary</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span>(prefix = <span class="hljs-string"><span class="hljs-string">"spring.datasource.psql"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DataSource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">psqlDataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataSourceBuilder.create().build(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SpringLiquibase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">primaryLiquibase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProfileChecker checker)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isTest = checker.isTest(); SpringLiquibase liquibase = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringLiquibase(); liquibase.setDataSource(psqlDataSource()); <span class="hljs-comment"><span class="hljs-comment">// &lt;----- liquibase.setChangeLog("classpath:liquibase/schema-postgre.xml"); liquibase.setShouldRun(isTest); return liquibase; } } //... @Configuration public class Db2DatasourceConfig { @Bean @ConfigurationProperties(prefix = "spring.datasource.db2") public DataSource db2DataSource() { return DataSourceBuilder.create().build(); } @Bean public SpringLiquibase liquibase(ProfileChecker checker) { boolean isTest = checker.isTest(); SpringLiquibase liquibase = new SpringLiquibase(); liquibase.setDataSource(db2DataSource()); // &lt;----- liquibase.setChangeLog("classpath:liquibase/schema-db2.xml"); liquibase.setShouldRun(isTest); return liquibase; } }</span></span></code> </pre> <br><h4 id="javaxinjectprovider">  javax.inject.Provider </h4><br><p>  ¬øC√≥mo obtener un bean con prototipo de alcance?  A menudo me encontr√© con esto </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope</span></span>(SCOPE_PROTOTYPE) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectBuilder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProjectFileConverter converter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProjectRepository projectRepository; <span class="hljs-comment"><span class="hljs-comment">//... } @Component @RequiredArgsConstructor public class PrototypeUtilizer { private final Provider&lt;ProjectBuilder&gt; projectBuilderProvider; void method() { ProjectBuilder freshBuilder = projectBuilderProvider.get(); } }</span></span></code> </pre> <br><p>  Parece que todo est√° bien, el c√≥digo funciona.  Sin embargo, en este barril de miel hay una mosca en la pomada.  Necesitamos arrastrar una <code>javax.inject:javax.inject:1</code> m√°s de <code>javax.inject:javax.inject:1</code> , que se agreg√≥ a Maven Central exactamente hace 10 a√±os y nunca se ha actualizado desde entonces. </p><br><p>  ¬°Pero Spring ha sido capaz de hacer lo mismo sin adicciones de terceros!  Simplemente reemplace <code>javax.inject.Provider::get</code> con <code>org.springframework.beans.factory.ObjectFactory::getObject</code> y todo funciona de la misma manera. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PrototypeUtilizer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ObjectFactory&lt;ProjectBuilder&gt; projectBuilderFactory; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ProjectBuilder freshBuilder = projectBuilderFactory.getObject(); } }</code> </pre> <br><p>  Ahora podemos, con la conciencia tranquila, eliminar <code>javax.inject</code> de la lista de dependencias. </p><br><h4 id="ispolzovanie-strok-vmesto-klassov-v-nastroykah">  Usar cadenas en lugar de clases en la configuraci√≥n </h4><br><p>  Un ejemplo com√∫n de conectar repositorios Spring Data a un proyecto: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableJpaRepositories</span></span>(<span class="hljs-string"><span class="hljs-string">"com.smth.repository"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><p>  Aqu√≠ prescribimos expl√≠citamente el paquete que ser√° visto por Spring.  Si permitimos un poco de nomenclatura adicional, la aplicaci√≥n se bloquear√° al inicio.  Me gustar√≠a detectar tales errores est√∫pidos en las primeras etapas, en el l√≠mite, justo durante la edici√≥n del c√≥digo.  El marco se dirige hacia nosotros, por lo que el c√≥digo anterior se puede reescribir: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableJpaRepositories</span></span>(basePackageClasses = AuditRepository.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><p>  Aqu√≠ <code>AuditRepository</code> es uno de los repositorios de paquetes que veremos.  Como indicamos la clase, necesitaremos conectar esta clase a nuestra configuraci√≥n, y ahora los errores tipogr√°ficos se detectar√°n directamente en el editor o, en el peor de los casos, al compilar el proyecto. </p><br><p>  Este enfoque se puede aplicar en muchos casos similares, por ejemplo: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ComponentScan</span></span>(basePackages = <span class="hljs-string"><span class="hljs-string">"com.smth"</span></span>)</code> </pre> <br><p>  se convierte en </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.smth.Smth; <span class="hljs-meta"><span class="hljs-meta">@ComponentScan</span></span>(basePackageClasses = Smth.class)</code> </pre> <br><p>  Si necesitamos agregar alguna clase a un diccionario de la forma <code>Map&lt;String, Object&gt;</code> , esto se puede hacer as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocalContainerEntityManagerFactoryBean bean)</span></span></span><span class="hljs-function"> </span></span>{ String property = <span class="hljs-string"><span class="hljs-string">"hibernate.session_factory.session_scoped_interceptor"</span></span>; bean.getJpaPropertyMap().put(property, <span class="hljs-string"><span class="hljs-string">"com.smth.interceptor.AuditInterceptor"</span></span>); }</code> </pre> <br><p>  pero es mejor usar un tipo expl√≠cito: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.smth.interceptor.AuditInterceptor; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocalContainerEntityManagerFactoryBean bean)</span></span></span><span class="hljs-function"> </span></span>{ String property = <span class="hljs-string"><span class="hljs-string">"hibernate.session_factory.session_scoped_interceptor"</span></span>; bean.getJpaPropertyMap().put(property, AuditInterceptor.class); }</code> </pre> <br><p>  Y cuando hay algo como </p><br><pre> <code class="java hljs">LocalContainerEntityManagerFactoryBean bean = builder .dataSource(dataSource) .packages( <span class="hljs-comment"><span class="hljs-comment">//...     ) .persistenceUnit("psql") .build();</span></span></code> </pre> <br><p>  Vale la pena se√±alar que el m√©todo <code>packages()</code> est√° sobrecargado y utiliza las clases: <br><img src="https://habrastorage.org/webt/zt/tq/-8/zttq-8strhme7sjmgxc7ybnr6bu.png"></p><br><h4 id="ne-kladite-vse-biny-v-odin-paket">  No ponga todos los frijoles en un paquete </h4><br><p>  Creo que en muchos proyectos en Spring / Spring Booth viste una estructura similar: </p><br><pre> <code class="plaintext hljs">root-package | \ repository/ entity/ service/ Application.java</code> </pre> <br><p>  Aqu√≠ <code>Application.java</code> es la clase ra√≠z de la aplicaci√≥n: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableJpaRepositories</span></span>(basePackageClasses = SomeRepository.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(Application.class, args); } }</code> </pre> <br><p>  Este es el c√≥digo cl√°sico de microservicio: los componentes se organizan en carpetas seg√∫n el prop√≥sito, la clase con la configuraci√≥n est√° en la ra√≠z.  Si bien el proyecto es peque√±o, entonces todo est√° bien.  A medida que el proyecto crece, aparecen paquetes gordos con docenas de repositorios / servicios.  Y si el proyecto sigue siendo un monolito, entonces Di-s con ellos.  Pero si surge la tarea de dividir la aplicaci√≥n irregular en partes, entonces comienzan las preguntas.  Habiendo experimentado este dolor una vez, decid√≠ adoptar un enfoque diferente, es decir, agrupar las clases por su dominio.  El resultado es algo como </p><br><pre> <code class="plaintext hljs">root-package/ | \ user/ | \ repository/ domain/ service/ controller/ UserConfig.java billing/ | \ repository/ domain/ service/ BillingConfig.java //... Application.java</code> </pre> <br><p>  Aqu√≠, el paquete del <code>user</code> incluye subpaquetes con clases responsables de la l√≥gica del usuario: </p><br><pre> <code class="plaintext hljs">user/ | \ repository/ UserRepository.java domain/ UserEntity.java service/ UserService.java controller/ UserController.java UserConfig.java</code> </pre> <br><p>  Ahora en <code>UserConfig</code> puede describir todas las configuraciones asociadas con esta funcionalidad: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@ComponentScan</span></span>(basePackageClasses = UserServiceImpl.class) <span class="hljs-meta"><span class="hljs-meta">@EnableJpaRepositories</span></span>(basePackageClasses = UserRepository.class) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserConfig</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><p>  La ventaja de este enfoque es que, si es necesario, los m√≥dulos se pueden asignar m√°s f√°cilmente a servicios / aplicaciones separados.  Tambi√©n es √∫til si tiene la intenci√≥n de modularizar su proyecto agregando <code>module-info.java</code> , ocultando clases de utilidad del mundo exterior. </p><br><p>  Eso es todo, espero, mi trabajo te ha sido √∫til.  Describa sus antipatrones en los comentarios, los resolveremos juntos :) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472994/">https://habr.com/ru/post/472994/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472978/index.html">Curso de autor Arduino para su propio hijo</a></li>
<li><a href="../472980/index.html">Pantalones cortos Belokamentseva</a></li>
<li><a href="../472982/index.html">‚ÄúEscucha para encontrar un desglose‚Äù: se publican grabaciones de audio de m√°quinas industriales fallidas</a></li>
<li><a href="../472984/index.html">Carro para camiones ROS. Parte 7. Localizaci√≥n del robot: gmapping, AMCL, puntos de referencia en el mapa de la sala.</a></li>
<li><a href="../472988/index.html">Analizamos la tonalidad de los textos usando Fast.ai</a></li>
<li><a href="../472996/index.html">El Pent√°gono desarrolla tecnolog√≠a de control de drones con los pensamientos de los soldados.</a></li>
<li><a href="../473000/index.html">Una breve gu√≠a matem√°tica para extranjeros</a></li>
<li><a href="../473002/index.html">Explicaci√≥n de la paradoja de Fermi en el marco de la sociolog√≠a espacial Liu Qixin</a></li>
<li><a href="../473006/index.html">DevOps: todo</a></li>
<li><a href="../473008/index.html">La ley de los rendimientos acelerados (Parte 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>