<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë®üèæ üëÉüèø üï§ Ignore o controle de conta de usu√°rio (UAC) imitando diret√≥rios confi√°veis üéã üë©üèø‚Äçü§ù‚Äçüë©üèª üç∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O especialista em seguran√ßa da informa√ß√£o David Wells publicou uma maneira de ignorar os controles de conta de usu√°rio do UAC no Windows 10 

 Ol√° pes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ignore o controle de conta de usu√°rio (UAC) imitando diret√≥rios confi√°veis</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430498/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ny/uq/43/nyuq43x709tvrsyldvgpxcq1ez0.jpeg"></div><br>  O especialista em seguran√ßa da informa√ß√£o David Wells publicou uma maneira de ignorar os controles de conta de usu√°rio do UAC no Windows 10 <br><a name="habracut"></a><br>  Ol√° pessoal! <br><br>  Ao pesquisar algumas novas solu√ß√µes alternativas para o Controle de Conta de Usu√°rio (UAC), eu descobri uma solu√ß√£o completamente nova para o UAC no momento da reda√ß√£o deste artigo.  Vale ressaltar que a Microsoft n√£o considera o UAC um limite de seguran√ßa; no entanto, ainda relatamos v√°rios bugs na Microsoft e quero compartilhar os detalhes da vulnerabilidade encontrada aqui.  Este m√©todo foi testado com sucesso no Windows 10 Build 17134. Antes de me aprofundar nos detalhes da minha descoberta, primeiro darei uma pequena explica√ß√£o sobre como o servi√ßo UAC funciona. <br><br>  <b>Uac primer</b> <br><br>  Quando um usu√°rio que √© membro do grupo Administradores deseja executar um aplicativo que requer privil√©gios elevados, o UAC exibe uma solicita√ß√£o correspondente e um usu√°rio que √© membro do grupo Administradores precisa confirmar a a√ß√£o.No entanto, essa solicita√ß√£o do UAC n√£o ocorre para TODOS os arquivos execut√°veis ‚Äã‚Äãadministrativamente no Windows .  Existem algumas exce√ß√µes que elevam ‚Äúautomaticamente‚Äù os privil√©gios de um arquivo execut√°vel sem causar uma solicita√ß√£o de UAC, ignorando o UAC (para sua surpresa!).  Esse grupo espec√≠fico de execut√°veis ‚Äã‚Äãconfi√°veis ‚Äã‚Äãselecionados passa por verifica√ß√µes de seguran√ßa adicionais pelo sistema para garantir que esses arquivos sejam realmente confi√°veis; portanto, os invasores de informa√ß√µes geralmente n√£o abusam desse recurso.  Essa abordagem foi usada nos m√©todos anteriores de desvio do UAC e ser√° a base do meu novo m√©todo de desvio.  No entanto, existem algumas brechas que precisamos tomar para que nosso ataque seja bem-sucedido.  Vejamos os requisitos que devem ser atendidos se queremos que nosso execut√°vel seja "automaticamente elevado a privil√©gios".  Para fazer isso, mostrarei algumas fotos da biblioteca desmontada appinfo.dll (o servi√ßo AIS que processa solicita√ß√µes de escalonamento de privil√©gios √© um dos principais componentes do UAC). <br><br>  <b>Requisito 1:</b> arquivo configurado para elevar privil√©gios automaticamente <br><br>  Quando surge uma solicita√ß√£o de escala√ß√£o de privil√©gios para um programa, o servi√ßo AIS (appinfo.dll) faz uma chamada RPC com o caminho execut√°vel de destino passado como argumento.  Esse servi√ßo mapear√° o conte√∫do execut√°vel de destino do arquivo para leitura.  No manifesto do arquivo execut√°vel, √© feita uma tentativa de ler o valor para obter a chave "autoElevate" (se existir). <br><br>  Figura 1 - Lendo o manifesto do arquivo execut√°vel para obter o valor da chave "autoElevate". <br><br><img src="https://habrastorage.org/webt/mk/tv/sl/mktvslanjr3qsewhdydmwz96chc.png"><br><br>  Se o valor for recebido e for True, o arquivo ser√° considerado como um arquivo execut√°vel de privil√©gio elevado "autom√°tico", que ser√° executado com eleva√ß√£o de privil√©gio e n√£o invocar√° a caixa de di√°logo do servi√ßo UAC (desde que cumpra os seguintes requisitos mencionados abaixo). <br><br>  Figura 2 - chamando ‚Äúbsearch‚Äù para verificar o nome do arquivo execut√°vel na lista de execut√°veis ‚Äã‚Äã‚Äúauto elevating‚Äù <br><br><img src="https://habrastorage.org/webt/dk/qm/bn/dkqmbnfzsazhanihl0gxyk4lpsc.png"><br><br>  Alguns desses arquivos programados no sistema est√£o na lista de permiss√µes: <br>  'cttunesvr.exe', 'inetmgr.exe', 'migsetup.exe', 'mmc.exe', 'oobe.exe', 'pkgmgr.exe', 'provisionharehare', 'provisionstorage.exe', 'spinstall .exe ',' winsat.exe ' <br><br>  <b>Requisito 2:</b> Assinado corretamente <br><br>  Sup√µe-se que a segunda condi√ß√£o para o aumento "autom√°tico" de privil√©gios ap√≥s o envio de uma solicita√ß√£o ao UAC seja executar uma verifica√ß√£o de assinatura usando "wintrust!  WTGetSignatureInfo ". <br><br>  Isso significa que o invasor n√£o poder√° simplesmente criar seu pr√≥prio arquivo de manifesto ou execut√°vel necess√°rio para a eleva√ß√£o "autom√°tica" de privil√©gios e obter √™xito, pois o arquivo bin√°rio do invasor provavelmente ser√° assinado incorretamente e o √∫ltimo requisito, execu√ß√£o, tamb√©m falhar√°. de um diret√≥rio confi√°vel. <br><br>  <b>Requisito 3:</b> Execu√ß√£o de um diret√≥rio confi√°vel <br><br>  O requisito final para obter uma eleva√ß√£o "autom√°tica" de privil√©gios √© que o execut√°vel de destino esteja em um "diret√≥rio confi√°vel", por exemplo, "C: \ Windows \ System32".  A Figura 3 mostra que o AIS executa essa verifica√ß√£o do caminho com a solicita√ß√£o de atualiza√ß√£o. Nesse caso, um dos caminhos considerados ‚Äúconfi√°veis‚Äù √© ‚ÄúC: \ Windows \ System32‚Äù. <br><br>  Figura 3 <br><br><img src="https://habrastorage.org/webt/cx/rq/k1/cxrqk1n2ozxd7hnmkmkf4juvgpo.png"><br><br>  O t√≠tulo deste artigo √© "Ignorar controle de conta de usu√°rio (UAC) imitando diret√≥rios confi√°veis", para que voc√™ possa adivinhar facilmente o que acontecer√° a seguir. <br><br>  <b>Bypass do UAC</b> <br><br>  Como mencionado anteriormente na se√ß√£o UAC Primer, o privil√©gio autom√°tico (desvio do UAC) ser√° executado para arquivos execut√°veis ‚Äã‚Äãque: <br><br><ol><li>  Configurado para receber escalonamento de privil√©gios "autom√°tico" </li><li>  Assinado corretamente </li><li>  Executar a partir de um diret√≥rio confi√°vel ("C: \ Windows \ System32") </li></ol><br>  Appinfo.dll (AIS) usa a API RtlPrefixUnicodeString para verificar se o caminho do arquivo execut√°vel corresponde a ‚ÄúC: \ Windows \ System32 \‚Äù para verificar um dos diret√≥rios confi√°veis.  Este √© um teste de concreto bastante refor√ßado, dada a compara√ß√£o com a localiza√ß√£o do arquivo can√¥nico. <br><br>  Portanto, para organizar um desvio dessa verifica√ß√£o, eu crio um diret√≥rio chamado "C: \ Windows \" (observe o espa√ßo ap√≥s "Windows").  Obviamente, usando essa a√ß√£o, voc√™ ainda n√£o pode passar na verifica√ß√£o RtlPrefixUnicodeString, e tamb√©m mencionarei que esse √© um nome de diret√≥rio um tanto inv√°lido (ou pelo menos "hostil"), pois o Windows n√£o permite que espa√ßos sejam adicionados ao final do nome ao criar o diret√≥rio (tente ) <br><br>  No entanto, usando a API CreateDirectory e adicionando "\\?  \ "Para o nome do diret√≥rio que quero criar, podemos ignorar algumas dessas regras de filtragem de nomes e enviar uma solicita√ß√£o para criar o diret√≥rio diretamente no sistema de arquivos. <br><br><img src="https://habrastorage.org/webt/yf/tu/p3/yftup388pyrdgxxokxetbkhm8em.png"><br><br>  Isso leva √† cria√ß√£o de um diret√≥rio inconveniente que felizmente coexiste no sistema de arquivos junto com o real "C: \ Windows \" (exceto quando voc√™ est√° tentando fazer algo com ele no Windows Explorer). <br><br><img src="https://habrastorage.org/webt/z7/4i/kz/z74ikzx_ninr8cegntrm_vwtyfy.png"><br><br>  Agora que temos o diret√≥rio "C: \ Windows \", podemos criar o diret√≥rio "System32" e copiar um dos arquivos execut√°veis ‚Äã‚Äãassinados (que s√£o permitidos pelo sistema para "automaticamente" elevar privil√©gios) do diret√≥rio real "C: \ Windows \ System32 ". <br>  Para fazer isso, copiei o ‚ÄúwinSAT.exe‚Äù (um dos arquivos da lista branca de arquivos execut√°veis ‚Äã‚Äãdo Windows com a eleva√ß√£o ‚Äúautom√°tica‚Äù de privil√©gios permitidos pelo sistema). <br>  Quando tentamos executar esse arquivo em nosso novo diret√≥rio ‚ÄúC: \ Windows \ System32 \ winSAT.exe‚Äù, ele percorre as seguintes APIs (consulte a Figura 6) em appinfo.dll antes de executar uma verifica√ß√£o de diret√≥rio confi√°vel.  Isso √© importante e o fundamento do porqu√™ essa solu√ß√£o alternativa funciona. <br><br>  Figura 6 <br><br><img src="https://habrastorage.org/webt/gu/ky/j_/gukyj_juwwrpa-pkz2mzv441pvi.png"><br><br>  Quando esse caminho inconveniente com um espa√ßo √© enviado ao AIS para solicitar a escala√ß√£o de privil√©gios, o caminho √© passado para GetLongPathNameW, que o converte novamente em "C: \ Windows \ System32 \ winSAT.exe" (espa√ßo removido). <br><br>  √ìtimo! <br><br>  Agora, esta √© a linha na qual a verifica√ß√£o de diret√≥rio v√°lida foi aprovada (usando RtlPrefixUnicodeString) pelo restante da verifica√ß√£o. <br><br>  A beleza da minha solu√ß√£o √© que, depois de verificar o diret√≥rio confi√°vel, esse caminho convertido √© executado, que √© liberado e o restante das verifica√ß√µes (e a solicita√ß√£o final de escala√ß√£o de privil√©gios) s√£o realizadas com o nome original do diret√≥rio execut√°vel (com um espa√ßo extra). <br><br>  Isso me permite passar por todas as outras verifica√ß√µes e faz com que o appinfo.dll aceite minha c√≥pia do winSAT.exe como tendo uma eleva√ß√£o "autom√°tica" de privil√©gios (uma vez que foi corretamente assinada e adicionada √† lista branca de eleva√ß√£o "autom√°tica" de privil√©gios). <br><br>  Para realmente usar o c√≥digo malicioso, copiei o WINMM.dll falso (winSAT.exe importado) no meu diret√≥rio atual ‚ÄúC: \ Windows \ System32 \‚Äù para falsificar a dll local.  O conceito completo pode ser visto na figura abaixo. <br><br>  Figura 7 <br><br><img src="https://habrastorage.org/webt/ko/mj/mj/komjmj6mfh1mexldjb7bqyauqc0.png"><br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link para o Github</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430498/">https://habr.com/ru/post/pt430498/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430488/index.html">Troca de dados ass√≠ncrona com um aplicativo remoto via SSH</a></li>
<li><a href="../pt430490/index.html">Antecipe, eduque e decida: como e por que o EPAM constr√≥i o Java Competency Center</a></li>
<li><a href="../pt430492/index.html">Stick de computa√ß√£o neural da Intel. Mente artificial em uma unidade flash USB - 2</a></li>
<li><a href="../pt430494/index.html">Monitor de Tr√°fego InfoWatch. √Ä beira de bugs e recursos</a></li>
<li><a href="../pt430496/index.html">NB-IoT: como funciona? Parte 1</a></li>
<li><a href="../pt430500/index.html">Evitando o caos da base de conhecimento corporativo: nossa experi√™ncia de conflu√™ncia</a></li>
<li><a href="../pt430502/index.html">Teste de carga com gafanhoto</a></li>
<li><a href="../pt430504/index.html">M√©todos de pensamento j√∫nior e racional</a></li>
<li><a href="../pt430506/index.html">Arte escura da ressurrei√ß√£o: como recuperar dados de m√≠dia danificada</a></li>
<li><a href="../pt430508/index.html">DevOps: o que √© realmente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>