<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚ÄçüöÄ üñêüèΩ üö∂üèª Dispositif de compilateur Swift. 3e partie ü¶Ñ üÉè üë©üèΩ‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous continuons √† √©tudier le compilateur Swift. Cette partie est d√©di√©e au Swift Intermediate Language. 


 Si vous n'avez pas vu les pr√©c√©dents, je v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dispositif de compilateur Swift. 3e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/e-Legion/blog/438696/"><img src="https://habrastorage.org/webt/w6/d3/5f/w6d35fpnglkxq8suebz-fhsl2de.png"><br><p>  Nous continuons √† √©tudier le compilateur Swift.  Cette partie est d√©di√©e au Swift Intermediate Language. </p><br><p>  Si vous n'avez pas vu les pr√©c√©dents, je vous recommande de suivre le lien et de lire: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pr√©sentation g√©n√©rale des composants</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Analyse du fichier source</a> . <a name="habracut"></a></li></ul><br><h1 id="silgen">  Silgen </h1><br><p>  L'√©tape suivante consiste √† convertir l'AST typ√© en SIL brut.  Swift Intermediate Language (SIL) est une repr√©sentation interm√©diaire sp√©cialement cr√©√©e pour Swift.  Une description de toutes les instructions se trouve dans la <a href="">documentation</a> . </p><br><p>  SIL a une forme SSA.  Static Single Assignment (SSA) - Repr√©sentation de code dans laquelle chaque variable se voit attribuer une valeur une seule fois.  Il est cr√©√© √† partir de code normal en ajoutant des variables suppl√©mentaires.  Par exemple, utiliser un suffixe num√©rique qui indique la version d'une variable apr√®s chaque affectation. </p><br><p>  Gr√¢ce √† ce formulaire, il est plus facile pour le compilateur d'optimiser le code.  Ci-dessous, un exemple de pseudo-code.  De toute √©vidence, la premi√®re ligne est inutile: </p><br><pre><code class="plaintext hljs">a = 1 a = 2 b = a</code> </pre> <br><p>  Mais ce n'est que pour nous.  Pour apprendre au compilateur √† d√©terminer cela, il faudrait √©crire des algorithmes non triviaux.  Mais avec SSA, c'est beaucoup plus facile.  Maintenant, m√™me pour un simple compilateur, il sera √©vident que la valeur de la variable <strong>a1 n'est</strong> pas utilis√©e, et cette ligne peut √™tre supprim√©e: </p><br><pre> <code class="plaintext hljs">a1 = 1 a2 = 2 b1 = a2</code> </pre> <br><p>  SIL vous permet d'appliquer des optimisations et des contr√¥les sp√©cifiques au code Swift qui seraient difficiles, voire impossibles √† r√©aliser dans la phase AST. </p><br><h3 id="ispolzovanie-generatora-sil">  Utilisation de SIL Generator </h3><br><p>  Pour g√©n√©rer SIL, utilisez l' <strong>indicateur -emit-silgen</strong> : </p><br><pre> <code class="plaintext hljs">swiftc -emit-silgen main.swift</code> </pre> <br><p>  Le r√©sultat de la commande: </p><br><pre> <code class="plaintext hljs">sil_stage raw import Builtin import Swift import SwiftShims let x: Int // x sil_global hidden [let] @$S4main1xSivp : $Int // main sil @main : $@convention(c) (Int32, UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;) -&gt; Int32 { bb0(%0 : $Int32, %1 : $UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;): alloc_global @$S4main1xSivp // id: %2 %3 = global_addr @$S4main1xSivp : $*Int // user: %8 %4 = metatype $@thin Int.Type // user: %7 %5 = integer_literal $Builtin.Int2048, 16 // user: %7 // function_ref Int.init(_builtinIntegerLiteral:) %6 = function_ref @$SSi22_builtinIntegerLiteralSiBi2048__tcfC : $@convention(method) (Builtin.Int2048, @thin Int.Type) -&gt; Int // user: %7 %7 = apply %6(%5, %4) : $@convention(method) (Builtin.Int2048, @thin Int.Type) -&gt; Int // user: %8 store %7 to [trivial] %3 : $*Int // id: %8 %9 = integer_literal $Builtin.Int32, 0 // user: %10 %10 = struct $Int32 (%9 : $Builtin.Int32) // user: %11 return %10 : $Int32 // id: %11 } // end sil function 'main' // Int.init(_builtinIntegerLiteral:) sil [transparent] [serialized] @$SSi22_builtinIntegerLiteralSiBi2048__tcfC : $@convention(method) (Builtin.Int2048, @thin Int.Type) -&gt; Int</code> </pre> <br><p>  SIL, comme LLVM IR, peut √™tre sorti en tant que code source.  Vous pouvez y trouver qu'√† ce stade, l'importation des modules Swift Builtin, Swift et SwiftShims a √©t√© ajout√©e. </p><br><p>  Malgr√© le fait que le code Swift peut √™tre √©crit directement dans la port√©e globale, SILGen g√©n√®re la fonction principale - le point d'entr√©e du programme.  Tout le code √©tait situ√© √† l'int√©rieur, sauf pour d√©clarer une constante, car il est global et devrait √™tre accessible partout. </p><br><p>  La plupart des lignes ont une structure similaire.  √Ä gauche, un pseudo-registre dans lequel le r√©sultat de l'instruction est enregistr√©.  Ensuite - l'instruction elle-m√™me et ses param√®tres, et √† la fin - un commentaire indiquant le registre pour lequel ce registre sera utilis√©. </p><br><p>  Par exemple, un litt√©ral entier de type Int2048 et une valeur de 16. est cr√©√© sur cette ligne. Ce litt√©ral est stock√© dans le cinqui√®me registre et sera utilis√© pour calculer la valeur du septi√®me: </p><br><pre> <code class="plaintext hljs">%5 = integer_literal $Builtin.Int2048, 16 // user: %7</code> </pre> <br><p>  Une d√©claration de fonction commence par le mot-cl√© sil.  Voici le nom avec le pr√©fixe @, la convention d'appel, les param√®tres, le type de retour et le code de fonction.  Pour l'initialiseur <strong>Int.init (_builtinIntegerLiteral :),</strong> il n'est bien s√ªr pas sp√©cifi√©, car cette fonction provient d'un autre module et n'a besoin que d'√™tre d√©clar√©e, mais non d√©finie.  Un signe dollar indique le d√©but d'une indication de type: </p><br><pre> <code class="plaintext hljs">// Int.init(_builtinIntegerLiteral:) sil [transparent] [serialized] @$SSi22_builtinIntegerLiteralSiBi2048__tcfC : $@convention(method) (Builtin.Int2048, @thin Int.Type) -&gt; Int</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La convention d'appel</a> indique comment appeler correctement une fonction.  Cela est n√©cessaire pour g√©n√©rer le code machine.  Une description d√©taill√©e de ces principes d√©passe le cadre de cet article. </p><br><p>  Le nom des initialiseurs, ainsi que les noms des structures, classes, m√©thodes, protocoles, sont d√©form√©s (nom mangling).  Cela r√©sout plusieurs probl√®mes √† la fois. </p><br><p>  Tout d'abord, il permet d'utiliser les m√™mes noms dans diff√©rents modules et entit√©s imbriqu√©es.  Par exemple, pour la premi√®re m√©thode <strong>fff</strong> , le nom <strong>S4main3AAAV3fffSiyF est utilis√©</strong> , et pour la seconde, <strong>S4main3BBBVVffffSiyF</strong> est <strong>utilis√©</strong> : </p><br><pre> <code class="plaintext hljs">struct AAA { func fff() -&gt; Int { return 8 } } struct BBB { func fff() -&gt; Int { return 8 } }</code> </pre> <br><p>  <strong>S</strong> signifie Swift, 4 est le nombre de caract√®res dans le nom du module et 3 dans le nom de la classe.  Dans l'initialiseur litt√©ral, <strong>Si</strong> d√©signe le type standard Swift.Int. </p><br><p>  Deuxi√®mement, les noms et types d'arguments de fonction sont ajout√©s au nom.  Cela permet d'utiliser la surcharge.  Par exemple, pour la premi√®re m√©thode, <strong>S4main3AAAV3fff3iiiS2i_tF est</strong> g√©n√©r√©, et pour la seconde - <strong>S4main3AAAV3fff3dddSiSd_tF</strong> : </p><br><pre> <code class="plaintext hljs">struct AAA { func fff(iii internalName: Int) -&gt; Int { return 8 } func fff(ddd internalName: Double) -&gt; Int { return 8 } }</code> </pre> <br><p>  Apr√®s les noms des param√®tres, le type de la valeur de retour est indiqu√©, suivi des types de param√®tres.  Cependant, leurs noms internes ne sont pas indiqu√©s.  Malheureusement, il n'y a pas de documentation sur le changement de nom dans Swift, et son impl√©mentation peut changer √† tout moment. </p><br><p>  Le nom de la fonction est suivi de sa d√©finition.  Il se compose d'un ou plusieurs blocs de base.  Un bloc de base est une s√©quence d'instructions avec un point d'entr√©e, un point de sortie, qui ne contient pas d'instructions de branchement ni de conditions pour une sortie anticip√©e. </p><br><p>  La fonction principale a une unit√© de base, qui prend tous les param√®tres pass√©s √† la fonction en entr√©e et contient tout son code, car il n'y a pas de branches: </p><br><pre> <code class="plaintext hljs">bb0(%0 : $Int32, %1 : $UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;):</code> </pre> <br><p>  Nous pouvons supposer que chaque √©tendue d√©limit√©e par des accolades est une unit√© de base distincte.  Supposons que le code contienne une branche: </p><br><pre> <code class="plaintext hljs">// before if 2 &gt; 5 { // true } else { // false } // after</code> </pre> <br><p>  Dans ce cas, au moins 4 blocs de base seront g√©n√©r√©s pour: </p><br><ul><li>  code avant de se ramifier, </li><li>  cas o√π l'expression est vraie </li><li>  cas o√π l'expression est fausse </li><li>  code apr√®s branchement. </li></ul><br><p>  <strong>cond_br</strong> - instruction pour le saut conditionnel.  Si la valeur du pseudo-registre% 14 est vraie, alors la transition vers le bloc <strong>bb1 est effectu√©e</strong> .  Sinon, alors dans <strong>bb2</strong> .  br - saut inconditionnel qui d√©marre l'ex√©cution du bloc de base sp√©cifi√©: </p><br><pre> <code class="plaintext hljs">// before cond_br %14, bb1, bb2 // id: %15 bb1: // true br bb3 // id: %21 bb2: // Preds: bb0 // false br bb3 // id: %27 bb3: // Preds: bb2 bb1 // after</code> </pre> <br><p>  Code source: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fichiers d'impl√©mentation SILGen</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fichiers d'en-t√™te SIL</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fichiers d'impl√©mentation SIL</a> , </li><li>  <a href="">Documentation SIL</a> . </li></ul><br><h1 id="sil-guaranteed-transformations">  Transformations garanties SIL </h1><br><p>  La repr√©sentation interm√©diaire brute obtenue √† la derni√®re √©tape est analys√©e pour √™tre correcte et transform√©e en canonique: les fonctions marqu√©es transparentes sont en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ligne</a> (l'appel de fonction est remplac√© par son corps), les valeurs des expressions constantes sont calcul√©es, la fonction est v√©rifi√©e que les fonctions qui renvoient les valeurs faites cela dans toutes les branches de code et ainsi de suite. </p><br><p>  Ces conversions sont obligatoires et sont effectu√©es m√™me si l'optimisation de code est d√©sactiv√©e. </p><br><h3 id="generaciya-kanonichnogo-sil">  Canon SIL Generation </h3><br><p>  Pour g√©n√©rer un SIL canonique, le drapeau <strong>-emit-sil</strong> est utilis√©: </p><br><pre> <code class="plaintext hljs">swiftc -emit-sil main.swift</code> </pre> <br><p>  Le r√©sultat de la commande: </p><br><pre> <code class="plaintext hljs">sil_stage canonical import Builtin import Swift import SwiftShims let x: Int // x sil_global hidden [let] @$S4main1xSivp : $Int // main sil @main : $@convention(c) (Int32, UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;) -&gt; Int32 { bb0(%0 : $Int32, %1 : $UnsafeMutablePointer&lt;Optional&lt;UnsafeMutablePointer&lt;Int8&gt;&gt;&gt;): alloc_global @$S4main1xSivp // id: %2 %3 = global_addr @$S4main1xSivp : $*Int // user: %6 %4 = integer_literal $Builtin.Int64, 16 // user: %5 %5 = struct $Int (%4 : $Builtin.Int64) // user: %6 store %5 to %3 : $*Int // id: %6 %7 = integer_literal $Builtin.Int32, 0 // user: %8 %8 = struct $Int32 (%7 : $Builtin.Int32) // user: %9 return %8 : $Int32 // id: %9 } // end sil function 'main' // Int.init(_builtinIntegerLiteral:) sil public_external [transparent] [serialized] @$SSi22_builtinIntegerLiteralSiBi2048__tcfC : $@convention(method) (Builtin.Int2048, @thin Int.Type) -&gt; Int { // %0 // user: %2 bb0(%0 : $Builtin.Int2048, %1 : $@thin Int.Type): %2 = builtin "s_to_s_checked_trunc_Int2048_Int64"(%0 : $Builtin.Int2048) : $(Builtin.Int64, Builtin.Int1) // user: %3 %3 = tuple_extract %2 : $(Builtin.Int64, Builtin.Int1), 0 // user: %4 %4 = struct $Int (%3 : $Builtin.Int64) // user: %5 return %4 : $Int // id: %5 } // end sil function '$SSi22_builtinIntegerLiteralSiBi2048__tcfC'</code> </pre> <br><p>  Il y a peu de changements dans un exemple aussi simple.  Pour voir le vrai travail de l'optimiseur, vous devez compliquer un peu le code.  Par exemple, ajoutez un ajout: </p><br><pre> <code class="plaintext hljs">let x = 16 + 8</code> </pre> <br><p>  Dans son SIL brut, vous pouvez trouver l'ajout de ces litt√©raux: </p><br><pre> <code class="plaintext hljs">%13 = function_ref @$SSi1poiyS2i_SitFZ : $@convention(method) (Int, Int, @thin Int.Type) -&gt; Int // user: %14 %14 = apply %13(%8, %12, %4) : $@convention(method) (Int, Int, @thin Int.Type) -&gt; Int // user: %15</code> </pre> <br><p>  Mais dans le canonique, il n'est plus l√†.  Au lieu de cela, une valeur constante de 24 est utilis√©e: </p><br><pre> <code class="plaintext hljs">%4 = integer_literal $Builtin.Int64, 24 // user: %5</code> </pre> <br><p>  Code source: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Optimiseur SIL obligatoire</a> </li></ul><br><h1 id="sil-optimization">  Optimisation du sil </h1><br><p>  Des transformations sp√©cifiques √† Swift suppl√©mentaires sont appliqu√©es si l'optimisation est activ√©e.  Parmi eux, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sp√©cialisation des g√©n√©riques</a> (optimisation du code g√©n√©rique pour un type de param√®tre particulier), la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©virtualisation</a> (remplacement des appels dynamiques par des appels statiques), l'inline, l' <a href="">optimisation ARC,</a> et bien plus encore.  Une explication de ces techniques ne rentre pas dans un article d√©j√† envahi. </p><br><p>  Code source: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">En-t√™tes d'optimiseur SIL</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fichiers d'impl√©mentation de SIL Optimizer</a> </li></ul><br><p>  √âtant donn√© que SIL est une fonctionnalit√© Swift, je n'ai pas montr√© d'exemples d'impl√©mentation cette fois.  Nous reviendrons sur le compilateur de parenth√®ses dans la prochaine partie lorsque nous serons engag√©s dans la g√©n√©ration IR LLVM. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438696/">https://habr.com/ru/post/fr438696/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438682/index.html">Lancement du jubil√© de l'astronautique iranienne</a></li>
<li><a href="../fr438688/index.html">Bus PCIe 5.0 pr√™t pour la mise en service</a></li>
<li><a href="../fr438690/index.html">Si le module CRT de Pascal √©tait en JavaScript</a></li>
<li><a href="../fr438692/index.html">Soucoupe volante inertielle. Poussez tout</a></li>
<li><a href="../fr438694/index.html">Comment le processus de support du site a chang√© au cours des vingt derni√®res ann√©es</a></li>
<li><a href="../fr438698/index.html">Trag√©die systemd</a></li>
<li><a href="../fr438700/index.html">Carte des accidents</a></li>
<li><a href="../fr438708/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 350 (28 janvier - 3 f√©vrier 2019)</a></li>
<li><a href="../fr438710/index.html">Frontend Weekly Digest (28 janvier - 3 f√©vrier 2019)</a></li>
<li><a href="../fr438714/index.html">Pr√©sentation de Veeam Backup & Replication 9.5 Update 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>