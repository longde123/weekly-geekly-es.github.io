<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåø üîô üìÇ Imers√£o no driver: o princ√≠pio geral de revers√£o usando o exemplo da tarefa NeoQUEST-2019 üíáüèø üöÄ ü•ú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como todos os programadores, voc√™ ama c√≥digo. Voc√™ e ele s√£o melhores amigos. Mas, mais cedo ou mais tarde na vida, chegar√° um momento em que n√£o have...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Imers√£o no driver: o princ√≠pio geral de revers√£o usando o exemplo da tarefa NeoQUEST-2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/neobit/blog/446462/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ql/w3/1t/qlw31t-4mz--bhpo4qa81o_ptse.gif"></div><br>  Como todos os programadores, voc√™ ama c√≥digo.  Voc√™ e ele s√£o melhores amigos.  Mas, mais cedo ou mais tarde na vida, chegar√° um momento em que n√£o haver√° c√≥digo com voc√™.  Sim, √© dif√≠cil de acreditar, mas haver√° uma enorme lacuna entre voc√™s: voc√™ est√° do lado de fora e ele est√° bem no fundo.  Do desespero, voc√™, como todos, ter√° que ir para o outro lado.  Ao lado da engenharia reversa. <br><br>  Usando o exemplo da tarefa n¬∫ 2 da fase online do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NeoQUEST-2019,</a> analisaremos o princ√≠pio geral do driver reverso do Windows.  Obviamente, o exemplo √© bastante simplificado, mas a ess√™ncia do processo n√£o muda com isso - a √∫nica quest√£o √© a quantidade de c√≥digo que precisa ser visualizada.  Armado com experi√™ncia e sorte, vamos come√ßar! <a name="habracut"></a><br><h2>  Dado </h2><br>  Segundo a lenda, recebemos dois arquivos: um despejo de tr√°fego e um arquivo bin√°rio que gerou o mesmo tr√°fego.  Primeiro, d√™ uma olhada no despejo usando o Wireshark: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xb/4k/gs/xb4kgshocgnwhickftcvukhjqtk.png"></div><br>  O dump cont√©m um fluxo de pacotes UDP, cada um dos quais cont√©m 6 bytes de dados.  Esses dados, √† primeira vista, s√£o algum tipo de conjunto aleat√≥rio de bytes - n√£o √© poss√≠vel obter nada do tr√°fego.  Portanto, voltamos nossa aten√ß√£o para o bin√°rio, que deve lhe dizer como descriptografar tudo. <br>  Abra-o na IDA: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pp/v_/cq/ppv_cqotco3m7vjdjxdwyxmmqpc.png"></div><br>  Parece que estamos enfrentando algum tipo de motorista.  As fun√ß√µes com o prefixo WSK referem-se ao Winsock Kernel, a interface de programa√ß√£o de rede no modo kernel do Windows.  No MSDN, voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ver uma</a> descri√ß√£o das estruturas e fun√ß√µes usadas no WSK. <br><br>  Por conveni√™ncia, voc√™ pode carregar a biblioteca do Windows Driver Kit 8 (modo kernel) - wdk8_km (ou qualquer mais recente) no IDA para usar os tipos definidos aqui: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zf/8e/gu/zf8egusvoa5plmcn2uadxwtmapk.png"></div><br><h2>  Cuidado, inverta! </h2><br>  Como sempre, comece pelo ponto de entrada: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z6/ry/e1/z6rye1bxurfesyaglba_f_4q9aq.png"></div><br>  Vamos em ordem.  Primeiro, o Wsk √© inicializado, um soquete √© criado e vinculado - n√£o descreveremos essas fun√ß√µes em detalhes, elas n√£o carregam nenhuma informa√ß√£o √∫til para n√≥s. <br><br>  A fun√ß√£o sub_140001608 define 4 vari√°veis ‚Äã‚Äãglobais.  Vamos cham√°-lo de InitVars.  Em um deles, um valor √© gravado no endere√ßo 0xFFFFF78000000320.  Pesquisando um pouco esse endere√ßo, podemos assumir que ele registra o n√∫mero de ticks do timer do sistema a partir do momento em que o sistema √© inicializado.  Por enquanto, vamos nomear a vari√°vel TickCount. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e5/7_/2x/e57_2xuaa7zyx0fxfz7ebyc9kqu.png"></div><br>  O EntryPoint configura fun√ß√µes para processar pacotes IRP (pacote de solicita√ß√£o de E / S).  Voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ler</a> mais sobre eles no MSDN.  Para todos os tipos de solicita√ß√µes, √© definida uma fun√ß√£o que simplesmente passa o pacote para o pr√≥ximo driver na pilha. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b3/xj/sa/b3xjsa1qqtxxc-r7zydxxlzu48w.png"></div><br>  Mas para o tipo IRP_MJ_READ (3) uma fun√ß√£o separada √© definida;  vamos cham√°-lo de IrpRead. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/a1/5y/gia15yhygs63v9qm5nooaxboay4.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hu/yd/9w/huyd9wgps6ubfztj72vrfl3pxfm.png"></div><br>  Por sua vez, est√° instalado o CompletionRoutine. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2l/5o/wq/2l5owqwqa0pqcmy3zrbfnen1h28.png"></div><br>  A CompletionRoutine preenche a estrutura desconhecida com os dados recebidos do IRP e os coloca na lista.  At√© o momento, n√£o sabemos o que est√° dentro do pacote - retornaremos a essa fun√ß√£o mais tarde. <br>  Analisamos mais detalhadamente o EntryPoint.  Ap√≥s definir os manipuladores de IRP, a fun√ß√£o sub_1400012F8 √© chamada.  Vamos olhar para dentro e perceber imediatamente que um dispositivo (IoCreateDevice) √© criado nele. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xn/bv/hg/xnbvhgsku6con1ppuedpwuo2kw8.png"></div><br>  Chame a fun√ß√£o AddDevice.  Se os tipos estiverem corretos, veremos que o nome do dispositivo √© "\\ Device \\ KeyboardClass0".  Portanto, nosso driver interage com o teclado.  Pesquisando sobre o IRP_MJ_READ no contexto do teclado, voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descobrir</a> que a estrutura KEYBOARD_INPUT_DATA √© transmitida em pacotes.  Vamos voltar √† CompletionRoutine e ver que tipo de dados eles passam. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/hi/rc/y1hirc1v347d7sqvedm0__ht01m.png"></div><br>  O IDA aqui n√£o analisa bem a estrutura, mas voc√™ pode entender pelas compensa√ß√µes e chamadas adicionais que consiste em ListEntry, KeyData (o c√≥digo de verifica√ß√£o da chave √© armazenado aqui) e KeyFlags. <br>  Ap√≥s AddDevice, a fun√ß√£o sub_140001274 √© chamada no EntryPoint.  Ela cria um novo fluxo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/an/k2/bg/ank2bgcarpusbca9wgiydrkjmo0.png"></div><br>  Vamos ver o que acontece no ThreadFunc. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4b/ia/6f/4bia6fkojwowshkdfwfcj5e5xkq.png"></div><br>  Ela obt√©m o valor da lista e os processa.  Preste imediatamente aten√ß√£o √† fun√ß√£o sub_140001A18. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oa/tp/6z/oatp6zuhwpkm-3yvwoi51heuqzw.png"></div><br>  Ele passa os dados processados ‚Äã‚Äãpara a entrada da fun√ß√£o sub_140001A68, juntamente com um ponteiro para WskSocket e o n√∫mero 0x89E0FEA928230002.  Depois de analisar o n√∫mero do par√¢metro por bytes (0x89 = 137, 0xE0 = 224, 0xFE = 243, 0xA9 = 169, 0x2328 = 9000), obtemos exatamente o mesmo endere√ßo e porta do despejo de tr√°fego: 169.243.224.137:9000.  √â l√≥gico supor que esta fun√ß√£o envie um pacote de rede para o endere√ßo e porta especificados - n√£o o consideraremos em detalhes. <br>  Vamos ver como os dados s√£o processados ‚Äã‚Äãantes do envio. <br><br>  Para os dois primeiros elementos, um equivalente √© executado com o valor gerado.  Como o n√∫mero de ticks √© usado para calcular, pode-se supor que estamos diante da gera√ß√£o de um n√∫mero pseudo-aleat√≥rio. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/vi/xa/h1vixaqacqmhbn6nr0p6nbw03py.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2f/xg/xr/2fxgxrgvu-0be2wb5r2bbnszljy.png"></div><br>  Depois de gerar o n√∫mero, ele substitui o valor da vari√°vel que chamamos anteriormente de TickCount.  Vari√°veis ‚Äã‚Äãpara a f√≥rmula s√£o definidas em InitVars.  Se retornarmos √† chamada para essa fun√ß√£o, descobriremos os valores para essas vari√°veis ‚Äã‚Äãe, como resultado, obteremos a seguinte f√≥rmula: <br><br>  <b><i>(54773 + 7141 * prev_value)% 259200</i></b> <br><br>  Este √© um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gerador</a> linear de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√∫meros pseudoaleat√≥rios</a> congruentes.  √â inicializado no InitVars usando TickCount.  Para cada n√∫mero subseq√ºente, o anterior atua como o valor inicial (o gerador retorna um valor de dois bytes e o mesmo √© usado para a gera√ß√£o subseq√ºente). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/td/pd/2f/tdpd2fq9xc9kvskq-tf4ax87xms.png"></div><br>  Ap√≥s o equivalente a um n√∫mero aleat√≥rio de dois valores transmitidos pelo teclado, √© chamada uma fun√ß√£o que forma os dois bytes restantes da mensagem.  Simplesmente produz <i>xor de</i> dois par√¢metros j√° criptografados e algum valor constante.  √â improv√°vel que isso decodifique os dados, de modo que os dois √∫ltimos bytes da mensagem para n√≥s n√£o carregam nenhuma informa√ß√£o √∫til e n√£o podem ser considerados.  Mas o que fazer com dados criptografados? <br>  Vamos dar uma olhada no que exatamente est√° criptografado.  KeyData √© um c√≥digo de verifica√ß√£o que pode assumir uma gama bastante ampla de valores; acho que n√£o √© f√°cil.  Mas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">KeyFlags</a> √© um campo de bits: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ww/rw/cp/wwrwcpfjwzk1ixnguh7jk-aafiw.png"></div><br>  Se voc√™ olhar para a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tabela de</a> c√≥digos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">de</a> varredura, notar√° que na maioria das vezes o sinalizador ser√° 0 (a tecla est√° pressionada) ou 1 (a tecla est√° levantada).  KEY_E0 ser√° exposto muito raramente, mas pode aparecer, mas para atender a KEY_E1 as chances s√£o muito pequenas.  Portanto, voc√™ pode tentar fazer o seguinte: examinamos os dados do dump, selecionamos um valor criptografado KeyFlags, fazemos um equivalente com 0, geramos dois PSCs sucessivos.  Em primeiro lugar, KeyData √© um byte √∫nico e podemos verificar a corre√ß√£o do MSS gerado por byte alto.  E segundo, os pr√≥ximos KeyFlags criptografados, ao executar um equivalente com o PSC correto, ter√£o os mesmos valores de bits.  Se isso estiver errado, assumimos que o KeyFlags que analisamos originalmente era 1 etc. <br>  Vamos tentar implementar nosso algoritmo.  Vamos usar python para isso: <br><br><div class="spoiler">  <b class="spoiler_title">Implementa√ß√£o de algoritmo</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  -   keymap = [‚Ä¶] # ,   Wireshark traffic_dump = [‚Ä¶] #  def bxnor(a, b): return ((~a &amp; 0xffff) | b) &amp; (a | (~b &amp; 0xffff)) #   def brgen(a): return ((7141 * a + 54773) % 259200) &amp; 0xffff def decode(): #     for i in range(0, len(traffic_dump) - 1): #   KeyFlags probe = traffic_dump[i][1] #   - scancode = traffic_dump[i+1][0] #    KeyFlags tester = traffic_dump[i+1][1] fail = True #     (  KEY_E1) for flag in range(4): rnd_flag = bxnor(flag, probe) rnd_sc = brgen(rnd_flag) next_flag = bxnor(tester, brgen(rnd_sc)) #   KeyFlags if next_flag in range(4): sc = bxnor(rnd_sc, scancode) if sc &lt; len(keymap): sym = keymap[sc] if next_flag % 2 == 0: print(sym, end='') fail = False break #   -      KeyFlags   if fail: print('Something went wrong on {} pair'.format(i)) return print() if __name__ == "__main__": decode()</span></span></code> </pre> <br></div></div><br>  Execute nosso script nos dados recebidos do dump: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/ct/lp/htctlp99gtxcxje2krcgsjkqnpu.png"></div><br>  E no tr√°fego descriptografado, encontramos nossa linha mais desej√°vel! <br><br>  <i><b>NQ2019DABE17518674F97DBA393415E9727982FC52C202549E6C1740BC0933C694B3DE</b></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z9/3u/ma/z93umaswtxopnn-zbqi4qwbanfu.jpeg"></div><br>  Em breve haver√° artigos com an√°lise das demais tarefas, n√£o perca! <br><br>  PS E lembramos que todos que conclu√≠ram pelo menos uma tarefa no NeoQUEST-2019 t√™m direito a um pr√™mio!  Verifique se h√° uma carta no seu e-mail e, se n√£o chegou, escreva para <b>support@neoquest.ru</b> ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt446462/">https://habr.com/ru/post/pt446462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt446452/index.html">Miss√£o lunar ‚ÄúBereshit‚Äù - em 4 de abril de 2019, a transi√ß√£o para a √≥rbita lunar est√° conclu√≠da, 7 dias de voo, 6 manobras e 1 pouso</a></li>
<li><a href="../pt446454/index.html">Desenvolvimento de servidor Web Golang - do f√°cil ao complexo</a></li>
<li><a href="../pt446456/index.html">Substitui√ß√£o de importa√ß√£o na pr√°tica. Parte 1. Op√ß√µes</a></li>
<li><a href="../pt446458/index.html">DRO universal baseado no Arduino Nano - shDRO. Parte 2</a></li>
<li><a href="../pt446460/index.html">Food Design Digest Mar√ßo de 2019</a></li>
<li><a href="../pt446466/index.html">Marketing de conte√∫do para empresas: Habraseminar # 6 e seus principais pontos</a></li>
<li><a href="../pt446468/index.html">Guia pr√°tico de vari√°veis ‚Äã‚Äãde ambiente no Go</a></li>
<li><a href="../pt446470/index.html">A primeira h√©lice 3D do mundo lan√ßada</a></li>
<li><a href="../pt446472/index.html">Atualiza√ß√£o global para a exibi√ß√£o dos resultados do Lamptest.ru</a></li>
<li><a href="../pt446476/index.html">Planos para Angular 8.0 e Ivy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>