<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëê üñåÔ∏è üë©üèø‚Äçü§ù‚Äçüë®üèº Los autores del juego 0 AD - bien hecho ‚¨ÜÔ∏è üòµ üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0 AD es un juego tridimensional en el g√©nero de la estrategia hist√≥rica en tiempo real, desarrollado por la comunidad de voluntarios. El tama√±o de la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Los autores del juego 0 AD - bien hecho</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/420267/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c5/b41/bfb/6c5b41bfb68b23ef10d61f6ecd1a6665.png" alt="PVS-Studio y 0 A.D."></div><br>  0 AD es un juego tridimensional en el g√©nero de la estrategia hist√≥rica en tiempo real, desarrollado por la comunidad de voluntarios.  El tama√±o de la base del c√≥digo es peque√±o y decid√≠ comprobar el juego como un descanso de grandes proyectos como Android y XNU Kernel.  Entonces, ante nosotros hay un proyecto que contiene 165,000 l√≠neas de c√≥digo en C ++.  Veamos qu√© es lo interesante que se puede encontrar usando el analizador est√°tico PVS-Studio. <br><a name="habracut"></a><br><h2>  0 AD </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">0 AD</a> (0 A.D.) es un juego tridimensional gratuito en el g√©nero de la estrategia hist√≥rica en tiempo real, desarrollado por una comunidad de voluntarios (los principales desarrolladores est√°n unidos en el equipo de Wildfire Games).  El juego te permite controlar civilizaciones que existieron en el per√≠odo 500 AC.  e.- 1 a√±o antes de Cristo.  e.  A partir del verano de 2018, el proyecto est√° en versi√≥n alfa.  [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Descripci√≥n</a> tomada de Wikipedia]. <br><br>  ¬øPor qu√© exactamente 0 AD? <br><br>  Le ped√≠ a un colega de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Egor Bredikhin</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">EgorBredikhin</a> ) que eligiera y verificara para m√≠ alg√∫n peque√±o proyecto abierto con el que pudiera trabajar entre otras tareas.  Me envi√≥ un registro para el proyecto AD 0. A la pregunta: "¬øPor qu√© este proyecto?"  - hubo una respuesta: "S√≠, acabo de jugar este juego, una buena estrategia en tiempo real".  Ok, entonces ser√° 0 AD :). <br><br><h2>  Densidad de error </h2><br>  Quiero elogiar a los autores de 0 AD por la buena calidad del c√≥digo C ++.  Bien hecho, rara vez logras cumplir con una densidad tan baja de errores.  Por supuesto, estos no son todos los errores, sino aquellos que se pueden detectar con PVS-Studio.  Como dije, aunque PVS-Studio no encuentra todos los errores, sin embargo, podemos hablar con seguridad sobre la relaci√≥n entre la densidad de errores y la calidad del c√≥digo en su conjunto. <br><br>  Unos cuantos n√∫meros.  El n√∫mero total de l√≠neas de c√≥digo no vac√≠as es 231270. De estas, el 28.7% son comentarios.  En total, 165,000 l√≠neas de c√≥digo C ++ puro. <br><br>  El n√∫mero de mensajes emitidos por el analizador era peque√±o, y despu√©s de mirarlos a todos, escrib√≠ 19 errores.  Considerar√© todos estos errores m√°s adelante en el art√≠culo.  Tal vez me perd√≠ algo, considerando que el error es un c√≥digo descuidado inofensivo.  Sin embargo, en general, esto no cambia la imagen. <br><br>  Entonces, encontr√© 19 errores en 165,000 l√≠neas de c√≥digo.  Calculamos la densidad del error: 19 * 1000/165000 = 0.115. <br><br>  Para simplificar, redondeamos y suponemos que el analizador PVS-Studio detecta 0.1 errores por 1000 l√≠neas de c√≥digo en el c√≥digo del juego. <br><br>  Gran resultado!  A modo de comparaci√≥n, en mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> reciente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sobre Android,</a> calcul√© que detect√© al menos 0.25 errores por 1000 l√≠neas de c√≥digo.  De hecho, la densidad de errores all√≠ es a√∫n mayor, simplemente no encontr√© la fuerza para analizar todo el informe cuidadosamente. <br><br>  O tome las bibliotecas principales de EFL como ejemplo, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estudi√©</a> cuidadosamente y calcul√© el n√∫mero de defectos.  En √©l, PVS-Studio detecta 0.71 errores por 1000 l√≠neas de c√≥digo. <br><br>  Por lo tanto, los autores de 0 AD son buenos compa√±eros, sin embargo, en aras de la equidad, debe tenerse en cuenta que una peque√±a cantidad de c√≥digo escrito en C ++ les ayuda.  Desafortunadamente, cuanto m√°s grande es el proyecto, m√°s r√°pido crece su complejidad y la densidad de error aumenta de forma no lineal ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√°s</a> ). <br><br><h2>  Errores </h2><br>  Veamos ahora los 19 errores que encontr√© en el juego.  Para analizar el proyecto, utilic√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PVS-Studio</a> versi√≥n 6.24.  Le sugiero que intente descargar la versi√≥n demo y verifique los proyectos en los que est√° trabajando. <br><br>  <b>Nota</b>  Posicionamos PVS-Studio como una soluci√≥n B2B.  Para proyectos peque√±os y desarrolladores individuales, tenemos una opci√≥n de licencia gratuita: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥mo usar PVS-Studio de forma gratuita</a> ". <br><br>  <b>Error N1</b> <br><br>  Comencemos mirando un error complejo.  De hecho, no es complicado, pero tendr√° que familiarizarse con un c√≥digo bastante grande. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> WaterManager::CreateWaveMeshes() { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p = <span class="hljs-number"><span class="hljs-number">0</span></span>; p &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; ++p) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CoastalPointsSet.count(xx+around[p][<span class="hljs-number"><span class="hljs-number">0</span></span>] + (yy + around[p][<span class="hljs-number"><span class="hljs-number">1</span></span>])*SideSize)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nbNeighb &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { CoastalPointsSet.erase(xx + yy*SideSize); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } ++nbNeighb; <span class="hljs-comment"><span class="hljs-comment">// We've found a new point around us. // Move there xx = xx + around[p][0]; yy = yy + around[p][1]; indexx = xx + yy*SideSize; if (i == 0) Chain.push_back(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); else Chain.push_front(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); CoastalPointsSet.erase(xx + yy*SideSize); found = true; break; } } if (!found) endedChain = true; .... }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Advertencia de</a> PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V547</a> CWE-570 La expresi√≥n 'nbNeighb&gt; = 2' siempre es falsa.  WaterManager.cpp 581 <br><br>  A primera vista, el mensaje del analizador parece extra√±o.  ¬øPor qu√© la condici√≥n <i>nbNeighb&gt; = 2</i> siempre es falsa?  De hecho, en el cuerpo del bucle hay un incremento de la variable <i>nbNeighb</i> ! <br><br>  Mire a continuaci√≥n y ver√° una declaraci√≥n de interrupci√≥n que interrumpe la ejecuci√≥n del bucle.  Por lo tanto, si aumenta la variable <i>nbNeighb</i> , el ciclo se detendr√°.  Por lo tanto, el valor de la variable <i>nbNeighb</i> nunca alcanzar√° un valor mayor que 1. <br><br>  El c√≥digo claramente contiene alg√∫n tipo de error l√≥gico. <br><br>  <b>Error N2</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CmpRallyPointRenderer::MergeVisibilitySegments( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;SVisibilitySegment&gt;&amp; segments) { .... segments.erase(segments.end()); .... }</code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V783</a> CWE-119 Puede tener lugar la desreferenciaci√≥n del iterador inv√°lido 'segmentos.end ()'.  CCmpRallyPointRenderer.cpp 1290 <br><br>  Muy, muy extra√±o c√≥digo.  Quiz√°s el programador quer√≠a eliminar el √∫ltimo elemento del contenedor.  En este caso, el c√≥digo deber√≠a ser as√≠: <br><br><pre> <code class="cpp hljs">segments.erase(segments.end() - <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Aunque, entonces ser√≠a m√°s f√°cil escribir: <br><br><pre> <code class="cpp hljs">segments.pop_back();</code> </pre> <br>  Para ser honesto, no est√° del todo claro para m√≠ qu√© se deber√≠a haber escrito exactamente aqu√≠. <br><br>  <b>Error N3, N4</b> <br><br>  Decid√≠ considerar dos errores juntos, ya que est√°n relacionados con una p√©rdida de recursos y requieren primero mostrar qu√© es la macro <i>WARN_RETURN</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WARN_RETURN(status)\ do\ {\ DEBUG_WARN_ERR(status);\ return status;\ }\ while(0)</span></span></code> </pre> <br>  Entonces, como puede ver, la macro <i>WARN_RETURN</i> hace que la funci√≥n salga del cuerpo.  Ahora veamos formas inexactas de usar esta macro. <br><br>  El primer fragmento. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_generate_random_bytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(u8* buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ FILE* f = fopen(<span class="hljs-string"><span class="hljs-string">"/dev/urandom"</span></span>, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!f) WARN_RETURN(ERR::FAIL); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count) { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> numread = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, count, f); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numread == <span class="hljs-number"><span class="hljs-number">0</span></span>) WARN_RETURN(ERR::FAIL); buf += numread; count -= numread; } fclose(f); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V773</a> CWE-401 La funci√≥n se cerr√≥ sin soltar el controlador 'f'.  Una fuga de recursos es posible.  unix.cpp 332 <br><br>  Si la funci√≥n <i>fread</i> no puede leer los datos, la funci√≥n <i>sys_generate_random_bytes se</i> cerrar√° sin liberar el descriptor de archivo.  En la pr√°ctica, esto es casi imposible.  Es dudoso que no pueda leer datos de "/ dev / urandom".  Sin embargo, el c√≥digo es descuidado. <br><br>  El segundo fragmento. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_cursor_create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... sys_cursor_impl* impl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> sys_cursor_impl; impl-&gt;image = image; impl-&gt;cursor = XcursorImageLoadCursor(wminfo.info.x11.display, image); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(impl-&gt;cursor == None) WARN_RETURN(ERR::FAIL); *cursor = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;sys_cursor&gt;(impl); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Advertencia de PVS-Studio: V773 CWE-401 La funci√≥n se cerr√≥ sin soltar el puntero 'impl'.  Una p√©rdida de memoria es posible.  x.cpp 421 <br><br>  Si el cursor no se carga, se produce una p√©rdida de memoria. <br><br>  <b>Error N5</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadHeightmapImageOs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]); .... }</code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V554</a> CWE-762 Uso incorrecto de shared_ptr.  La memoria asignada con 'nuevo []' se limpiar√° con 'eliminar'.  MapIO.cpp 54 <br><br>  La opci√≥n correcta: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8[]&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]);</code> </pre> <br>  <b>Error N6</b> <br><br><pre> <code class="cpp hljs">FUTrackedPtr(ObjectClass* _ptr = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) : ptr(_ptr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) FUTracker::TrackObject((FUTrackable*) ptr); ptr = ptr; }</code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V570</a> La variable 'ptr' se asigna a s√≠ misma.  FUTracker.h 122 <br><br>  <b>Error N7, N8</b> <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring TraceEntry::EncodeAsText() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> action = (<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>)m_action; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> buf[<span class="hljs-number"><span class="hljs-number">1000</span></span>]; swprintf_s(buf, ARRAY_SIZE(buf), <span class="hljs-string"><span class="hljs-string">L"%#010f: %c \"%ls\" %lu\n"</span></span>, m_timestamp, action, m_pathname.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>().c_str(), (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)m_size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf; }</code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V576</a> CWE-628 Formato incorrecto.  Considere verificar el quinto argumento real de la funci√≥n 'swprintf_s'.  Se espera el argumento de tipo char.  trace.cpp 93 <br><br>  Aqu√≠ nos encontramos con un historial confuso e indistinto de una implementaci√≥n alternativa de la funci√≥n <i>swprintf</i> en Visual C ++.  No lo volver√© a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">contar</a> , pero consulte la documentaci√≥n para los diagn√≥sticos del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V576</a> (consulte la secci√≥n "L√≠neas anchas"). <br><br>  En este caso, lo m√°s probable es que este c√≥digo funcione correctamente al compilar en Visual C ++ para Windows e incorrectamente al compilar para Linux o macOS. <br><br>  Error similar: V576 CWE-628 Formato incorrecto.  Considere verificar el cuarto argumento real de la funci√≥n 'swprintf_s'.  Se espera el argumento de tipo char.  vfs_tree.cpp 211 <br><br>  <b>Error N9, N10, N11</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cl√°sico</a>  Al principio, se usa el puntero, y solo luego se verifica. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TEST_CAT2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(dst, dst_val); <span class="hljs-comment"><span class="hljs-comment">// &lt;= int ret = strcat_s(dst, max_dst_chars, src); TS_ASSERT_EQUALS(ret, expected_ret); if(dst != 0) // &lt;= TS_ASSERT(!strcmp(dst, expected_dst)); }</span></span></code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V595</a> CWE-476 El puntero 'dst' se utiliz√≥ antes de verificarlo con nullptr.  L√≠neas de verificaci√≥n: 140, 143. test_secure_crt.h 140 <br><br>  Creo que el error no requiere explicaci√≥n.  Advertencias similares: <br><br><ul><li>  V595 CWE-476 El puntero 'dst' se utiliz√≥ antes de que se verificara contra nullptr.  L√≠neas de verificaci√≥n: 150, 153. test_secure_crt.h 150 </li><li>  V595 CWE-476 El puntero 'dst' se utiliz√≥ antes de que se verificara contra nullptr.  L√≠neas de verificaci√≥n: 314, 317. test_secure_crt.h 314 </li></ul><br>  <b>Error N12</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tbool; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MikkTSpace::setTSpace(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tbool bIsOrientationPreserving, ....) { .... m_NewVertices.push_back(bIsOrientationPreserving &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-number"><span class="hljs-number">1.0f</span></span> : (<span class="hljs-number"><span class="hljs-number">-1.0f</span></span>)); .... }</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V674</a> CWE-682 El literal '0.5' del tipo 'doble' se compara con un valor del tipo 'int'.  Considere inspeccionar la expresi√≥n 'bIsOrientationPreserving&gt; 0.5'.  MikktspaceWrap.cpp 137 <br><br>  No tiene sentido comparar una variable de tipo <i>int</i> con una constante de 0.5.  Adem√°s, en t√©rminos de significado, esta es generalmente una variable de tipo booleano, lo que significa que compararlo con 0.5 parece muy extra√±o.  Suponga que en lugar de <i>bIsOrientationPreserving se</i> debe <i>usar</i> otra variable aqu√≠. <br><br>  <b>Error N13</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VfsPath&amp; pathname, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;u8&gt;&amp; fileContents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ ScopedLock s; VfsDirectory* directory; VfsFile* file; Status st; st = vfs_Lookup(pathname, &amp;m_rootDirectory, directory, &amp;file, VFS_LOOKUP_ADD|VFS_LOOKUP_CREATE); <span class="hljs-comment"><span class="hljs-comment">// There is no such file, create it. if (st == ERR::VFS_FILE_NOT_FOUND) { s.~ScopedLock(); return CreateFile(pathname, fileContents, size); } .... }</span></span></code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V749</a> CWE-675 Destructor del objeto 's' se invocar√° por segunda vez despu√©s de abandonar el alcance del objeto.  vfs.cpp 165 <br><br>  Antes de crear un archivo, es necesario que un objeto de tipo <i>ScopedLock</i> "desbloquee" un objeto.  Para esto, se llama expl√≠citamente a un destructor.  El problema es que el destructor para el objeto <i>s se</i> volver√° a llamar autom√°ticamente cuando salga la funci√≥n.  Es decir  el destructor se llamar√° dos veces.  No he estudiado el dispositivo de la clase <i>ScopedLock</i> , pero en cualquier caso, no debes hacer esto.  A menudo, esta doble llamada al destructor conduce a un comportamiento indefinido u otros errores desagradables.  Incluso si el c√≥digo funciona bien ahora, es muy f√°cil romper todo cambiando la implementaci√≥n de la clase <i>ScopedLock</i> . <br><br>  <b>Error N14, N15, N16, N17</b> <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { .... pEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CFsmEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... }</code> </pre> <br>  Advertencia de PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V668</a> CWE-570 No tiene sentido probar el puntero 'pEvent' contra nulo, ya que la memoria se asign√≥ utilizando el operador 'nuevo'.  La excepci√≥n se generar√° en caso de error de asignaci√≥n de memoria.  fsm.cpp 259 <br><br>  Comprobar el puntero no tiene sentido, porque en caso de un error de asignaci√≥n de memoria, se <i>lanzar√°</i> una excepci√≥n <i>std :: bad_alloc</i> . <br><br>  Entonces, la verificaci√≥n es superflua, pero el error no es grave.  Sin embargo, todo es mucho peor cuando se ejecuta algo de l√≥gica en el cuerpo de la <i>instrucci√≥n if</i> .  Considere el siguiente caso: <br><br><pre> <code class="cpp hljs">CFsmTransition* CFsm::AddTransition(....) { .... CFsmEvent* pEvent = AddEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Create new transition CFsmTransition* pNewTransition = new CFsmTransition( state ); if ( !pNewTransition ) { delete pEvent; return NULL; } .... }</span></span></code> </pre> <br>  Advertencia del analizador: V668 CWE-570 No tiene sentido probar el puntero 'pNewTransition' contra nulo, ya que la memoria se asign√≥ utilizando el operador 'nuevo'.  La excepci√≥n se generar√° en caso de error de asignaci√≥n de memoria.  fsm.cpp 289 <br><br>  Se intenta liberar memoria cuya direcci√≥n se almacena en el puntero <i>pEvent</i> .  Naturalmente, esto no suceder√° y se producir√° una p√©rdida de memoria. <br><br>  De hecho, cuando comenc√© a lidiar con este c√≥digo, result√≥ que todo era m√°s complicado y tal vez no hubo un error, sino dos.  Ahora explicar√© lo que est√° mal con este c√≥digo.  Para hacer esto, necesitamos familiarizarnos con el dispositivo de funci√≥n <i>AddEvent</i> . <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { CFsmEvent* pEvent = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Lookup event by type EventMap::iterator it = m_Events.find( eventType ); if ( it != m_Events.end() ) { pEvent = it-&gt;second; } else { pEvent = new CFsmEvent( eventType ); if ( !pEvent ) return NULL; // Store new event into internal map m_Events[ eventType ] = pEvent; } return pEvent; }</span></span></code> </pre> <br>  Tenga en cuenta que la funci√≥n no siempre devuelve un puntero a un nuevo objeto creado con el <i>nuevo</i> operador.  Algunas veces toma un objeto existente del contenedor <i>m_Events</i> .  Y el puntero al objeto reci√©n creado, por cierto, tambi√©n se colocar√° en <i>m_Events</i> . <br><br>  Y aqu√≠ surge la pregunta: ¬øqui√©n posee y debe destruir los objetos cuyos punteros est√°n almacenados en el contenedor <i>m_Events</i> ?  No estoy familiarizado con el proyecto, pero lo m√°s probable es que en alg√∫n lugar haya un c√≥digo que destruya todos estos objetos.  Luego, eliminar un objeto dentro de la funci√≥n <i>CFsm :: AddTransition es</i> generalmente superfluo. <br><br>  Tengo la impresi√≥n de que simplemente puede eliminar el siguiente fragmento de c√≥digo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pNewTransition ) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pEvent; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  Otros errores: <br><br><ul><li>  V668 CWE-571 No tiene sentido probar el puntero 'ret' contra nulo, ya que la memoria se asign√≥ utilizando el operador 'nuevo'.  La excepci√≥n se generar√° en caso de error de asignaci√≥n de memoria.  TerrainTextureEntry.cpp 120 </li><li>  V668 CWE-571 No tiene sentido probar el puntero de 'respuesta' contra nulo, ya que la memoria se asign√≥ utilizando el operador 'nuevo'.  La excepci√≥n se generar√° en caso de error de asignaci√≥n de memoria.  SoundManager.cpp 542 </li></ul><br>  <b>Error N18, N19</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dir_scan_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct de *de, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dsd</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || dsd-&gt;num_entries &gt;= dsd-&gt;arr_size) { dsd-&gt;arr_size *= <span class="hljs-number"><span class="hljs-number">2</span></span>; dsd-&gt;entries = (struct de *) <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(dsd-&gt;entries, dsd-&gt;arr_size * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dsd-&gt;entries[<span class="hljs-number"><span class="hljs-number">0</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// TODO(lsm): propagate an error to the caller dsd-&gt;num_entries = 0; } else { dsd-&gt;entries[dsd-&gt;num_entries].file_name = mg_strdup(de-&gt;file_name); dsd-&gt;entries[dsd-&gt;num_entries].st = de-&gt;st; dsd-&gt;entries[dsd-&gt;num_entries].conn = de-&gt;conn; dsd-&gt;num_entries++; } }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Advertencia de</a> PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V701</a> CWE-401 realloc () posible fuga: cuando realloc () falla en la asignaci√≥n de memoria, el puntero original 'dsd-&gt; entradas' se pierde.  Considere asignar realloc () a un puntero temporal.  mongoose.cpp 2462 <br><br>  Si el tama√±o de la matriz se vuelve insuficiente, la memoria se asigna utilizando la funci√≥n <i>realloc</i> .  El error es que el valor del puntero al bloque de memoria original se sobrescribe inmediatamente con el nuevo valor devuelto por la funci√≥n <i>realloc</i> . <br><br>  Si la asignaci√≥n de memoria falla, la funci√≥n <i>realloc</i> devolver√° NULL, y este NULL se escribir√° en la variable <i>dsd-&gt; entradas</i> .  Despu√©s de lo cual ser√° imposible liberar el bloque de memoria cuya direcci√≥n se almacen√≥ previamente en <i>entradas dsd-&gt;</i> .  Se producir√° una p√©rdida de memoria. <br><br>  Otro error: V701 CWE-401 realloc () posible fuga: cuando realloc () falla en la asignaci√≥n de memoria, se pierde el puntero original 'Buffer'.  Considere asignar realloc () a un puntero temporal.  Preprocessor.cpp 84 <br><br><h2>  Conclusi√≥n </h2><br>  No puedo decir que esta vez el art√≠culo result√≥ ser fascinante, o que logr√© mostrar muchos errores terribles.  Qu√© hacer, una vez a la vez, no es necesario.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lo que veo, luego lo escribo</a> . <br><br>  Gracias por su atencion  Para variar, terminar√© el art√≠culo con una invitaci√≥n para seguirme en Instagram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@pvs_studio_unicorn</a> y en Twitter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@Code_Analysis</a> . <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Si desea compartir este art√≠culo con una audiencia de habla inglesa, utilice el enlace a la traducci√≥n: Andrey Karpov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Buen trabajo, autores del juego 0 AD!</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420267/">https://habr.com/ru/post/es420267/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420257/index.html">¬øTodav√≠a instalas Windows 2008? Yo tambi√©n, y por eso</a></li>
<li><a href="../es420259/index.html">Panel de diagn√≥stico de envejecimiento de Singapur</a></li>
<li><a href="../es420261/index.html">¬øQu√© mediremos? C√≥mo elegir las m√©tricas de ML adecuadas para tareas empresariales</a></li>
<li><a href="../es420263/index.html">ServiceNow-conferencia "Conocimiento18"</a></li>
<li><a href="../es420265/index.html">Siete problemas de implementaci√≥n de Scrum que no conoc√≠amos</a></li>
<li><a href="../es420269/index.html">Dinero por el desag√ºe: ¬øpor qu√© su antiphishing no detecta sitios de phishing y c√≥mo Data Science lo hace funcionar?</a></li>
<li><a href="../es420271/index.html">Entrenamiento de empat√≠a: estimulando las conexiones neuronales del cerebro a trav√©s de un videojuego</a></li>
<li><a href="../es420273/index.html">C√≥mo se organiza un autom√≥vil de pasajeros de larga distancia</a></li>
<li><a href="../es420275/index.html">Grandes conferencias en Internet de las cosas en 2018-2019. Rusia y el mundo</a></li>
<li><a href="../es420277/index.html">Despu√©s de la fiebre del oro: perspectivas de la tecnolog√≠a Blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>