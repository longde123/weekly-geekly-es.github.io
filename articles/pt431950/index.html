<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ï üë©üèø‚Äçü§ù‚Äçüë©üèª üßòüèø Como prever a demanda e automatizar as compras usando o aprendizado de m√°quina: caso Ozon üë©üèΩ‚Äçü§ù‚Äçüë©üèº üê® üë©üèΩ‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A loja on-line Ozon tem praticamente tudo: geladeiras, comida para beb√™, laptops por 100.000, etc. Isso significa que tudo isso tamb√©m est√° nos armaz√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como prever a demanda e automatizar as compras usando o aprendizado de m√°quina: caso Ozon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ozontech/blog/431950/"><img src="https://habrastorage.org/webt/rl/bh/0z/rlbh0zbeah9dcpem3uio1wdstxs.png" alt="imagem"><br>  A loja on-line Ozon tem praticamente tudo: geladeiras, comida para beb√™, laptops por 100.000, etc.  Isso significa que tudo isso tamb√©m est√° nos armaz√©ns da empresa - e quanto mais tempo os produtos estiverem l√°, mais cara a empresa ser√°.  Para descobrir quanto e o que as pessoas gostariam de pedir, e o Ozon precisaria comprar, usamos o aprendizado de m√°quina. <br><a name="habracut"></a><br><h3>  Previs√£o de vendas: desafios </h3><br>  Antes de nos aprofundarmos na declara√ß√£o do problema, come√ßamos com um exemplo.  Este √© um cronograma de vendas real da Ozon por um tempo.  Pergunta: onde ele ir√° a seguir? <br><br><img src="https://habrastorage.org/webt/jl/nk/1j/jlnk1jejwxtqka-skph4hjccxno.png" alt="imagem"><br><br>  Uma pessoa com forma√ß√£o quase t√©cnica para essa formula√ß√£o do problema ter√° perguntas: Onde est√£o os eixos?  E que tipo de produto?  E em que unidades?  De que instituto voc√™ se formou?  - e muitos outros n√£o inclu√≠dos neste artigo por raz√µes √©ticas. <br><br>  De fato, ningu√©m pode responder corretamente √† pergunta em tal afirma√ß√£o, e se algu√©m puder, provavelmente ser√° enganado. <br><br>  Adicione mais informa√ß√µes a este gr√°fico: eixos e mudan√ßas de pre√ßo no site da Ozon (azul) e no site do concorrente (laranja). <br><br><img src="https://habrastorage.org/webt/n1/m8/ap/n1m8apunf5mos5bid2xs4qsq1ka.png" alt="imagem"><br><br>  Nosso pre√ßo caiu em algum momento, mas a concorr√™ncia permaneceu a mesma - e as vendas da Ozon aumentaram.  Conhecemos os planos de pre√ßos: nosso pre√ßo permanecer√° no mesmo n√≠vel, mas o concorrente, seguindo Ozon, reduziu o pre√ßo para quase o nosso. <br><br>  Esses dados s√£o suficientes para fazer uma suposi√ß√£o significativa - por exemplo, que as vendas retornar√£o ao n√≠vel anterior.  E se voc√™ olhar para o gr√°fico, verifica-se que ser√° assim. <br><br><img src="https://habrastorage.org/webt/rk/mb/aw/rkmbawctxwb2hf4lhs7l025c9y4.png" alt="imagem"><br><br>  O problema √© que, de fato, a demanda por este produto n√£o √© muito afetada pelo pre√ßo, e o crescimento das vendas foi causado, entre outras coisas, pela aus√™ncia da maioria dos concorrentes desse produto em nossa loja.  Ainda existem muitos fatores que n√£o levamos em considera√ß√£o: os produtos foram anunciados na TV?  ou talvez sejam doces, e logo em 8 de mar√ßo? <br><br>  Uma coisa √© clara: fazer uma previs√£o "no joelho" n√£o funcionar√°.  Seguimos o caminho padr√£o de um <s>ancinho e muletas para</s> construir qualquer algoritmo de ML.  E √© assim que foi. <br><br><h3>  Sele√ß√£o de m√©tricas </h3><br>  A escolha de uma m√©trica √© por onde come√ßar se pelo menos uma outra pessoa al√©m de voc√™ usar sua previs√£o. <br><br>  Considere um exemplo: temos tr√™s op√ß√µes de previs√£o.  Qual √© melhor? <br><img src="https://habrastorage.org/webt/ix/zg/gp/ixzggpclvbgaqpmkzaeehzhamb0.png" alt="imagem"><br>  Do ponto de vista dos especialistas no armaz√©m, precisamos de uma previs√£o azul - compraremos um pouco menos e vamos perder o pico em meados de outubro, mas nada permanecer√° no armaz√©m.  Os especialistas cujo KPI est√° vinculado √†s vendas t√™m a opini√£o oposta: mesmo a previs√£o turquesa n√£o √© muito correta, nem todos os saltos na demanda se refletiram - v√° modific√°-la.  Mas, do ponto de vista de uma pessoa, de fora, geralmente algo melhor est√° em ordem - para que todos se sintam bem ou vice-versa. <br><br>  Portanto, antes de fazer uma previs√£o, √© necess√°rio determinar quem o usar√° e por qu√™.  Ou seja, escolha uma m√©trica e entenda o que esperar de uma previs√£o criada com base nessa m√©trica.  E espere por isso. <br><br>  Escolhemos o MAE - o erro absoluto m√©dio.  Essa m√©trica √© adequada para nossa amostra de treinamento altamente desequilibrada.  Como o sortimento √© muito amplo (1,5 milh√£o de itens), cada produto individualmente em uma regi√£o espec√≠fica √© vendido em pequenas quantidades.  E se no total vendermos centenas de vestidos verdes, um vestido verde espec√≠fico com gatos ser√° vendido a 2-3 por dia.  Como resultado, a amostra muda para valores pequenos.  Por outro lado, existem iPhones, spinners, um novo livro de Olga Buzova (uma piada), etc.  - e s√£o vendidos em qualquer cidade em grandes quantidades.  O MAE permite que voc√™ n√£o receba multas enormes em iPhones condicionais e geralmente funcione bem na maior parte dos produtos. <br><br><h3>  Primeiros passos </h3><br>  Come√ßamos construindo a previs√£o mais est√∫pida que poderia ser: um n√∫mero aleat√≥rio de 0 a 1000 ser√° vendido na pr√≥xima semana e obter√° a m√©trica MAE = 496. Provavelmente, pode ser pior, mas isso j√° √© muito ruim.  Ent√£o, temos uma orienta√ß√£o: se obtivermos um valor t√£o m√©trico, obviamente estaremos fazendo algo errado. <br><br>  Em seguida, come√ßamos a interpretar pessoas que sabem como fazer uma previs√£o sem aprendizado de m√°quina e tentamos prever as vendas de mercadorias na pr√≥xima semana iguais √†s vendas m√©dias de todas as √∫ltimas semanas e obtivemos a m√©trica MAE = 1,45 - que √© muito melhor. <br><br>  Continuando a raciocinar, decidimos que as vendas da semana passada n√£o seriam mais relevantes para a previs√£o de vendas para a pr√≥xima semana.  Para tal previs√£o, o MAE foi de 1,26.  Na pr√≥xima rodada de pensamento progn√≥stico, decidimos levar em conta os fatores e prever vendas para a pr√≥xima semana como a soma de 50% das vendas m√©dias e 50% das vendas na semana passada - obtivemos MAE = 1,23. <br><br>  Mas parecia-nos muito simples e decidimos complicar as coisas.  Coletamos uma pequena amostra de treinamento na qual os sinais eram vendas passadas e m√©dias, e as metas eram vendas na semana seguinte e treinamos nela uma regress√£o linear simples.  Obtivemos pesos de 0,46 e 0,55 para a m√©dia e as √∫ltimas semanas e o MAE na amostra de teste foi igual a 1,2. <br>  Conclus√£o: nossos dados t√™m potencial preditivo. <br><br><h3>  Engenharia de recursos </h3><br>  Tendo decidido que construir uma previs√£o por dois motivos n√£o √© o nosso n√≠vel, sentamos para gerar novos recursos complexos.  S√£o informa√ß√µes sobre vendas anteriores - 1, 2, 3, 4 semanas atr√°s, uma semana exatamente h√° um ano, etc.  E visualiza√ß√µes nas √∫ltimas semanas, adi√ß√µes √† cesta, convers√£o de visualiza√ß√µes e adi√ß√µes √† cesta em pedidos - e tudo isso por diferentes per√≠odos. <br><br>  Precis√°vamos fornecer um modelo de conhecimento sobre como o produto como um todo √© vendido, como a din√¢mica de suas vendas mudou recentemente, como o interesse est√° evoluindo, como suas vendas dependem do pre√ßo e de outros fatores que, em nossa opini√£o, podem ser √∫teis. <br><br>  Quando nossas id√©ias acabaram, fomos aos especialistas do departamento de vendas.  L√°, por exemplo, aprendemos que o pr√≥ximo ano √© o ano do porco, portanto, produtos pelo menos remotamente parecidos com porcos ser√£o muito populares.  Ou, por exemplo, que o ‚Äún√£o congelamento‚Äù que nosso pessoal n√£o compra com anteced√™ncia, mas exatamente no dia das primeiras geadas - por isso, leve em considera√ß√£o a previs√£o do tempo.  Em geral, todos estavam satisfeitos.  N√≥s - porque recebemos um monte de novas id√©ias que nunca ter√≠amos pensado em n√≥s mesmos e nos empres√°rios - que em breve ser√° poss√≠vel fazer algo mais interessante do que a previs√£o de vendas. <br><br>  Mas ainda √© muito simples - e adicionamos sintomas combinados: <br><br><ul><li>  convers√£o de visualiza√ß√µes em vendas - como foi, como mudou; </li><li>  a propor√ß√£o de vendas ao longo de 4 semanas e vendas na semana passada (se esse valor for muito diferente de 4, no momento a demanda por esse produto est√° sujeita a "turbul√™ncia"); </li><li>  a propor√ß√£o entre vendas de produtos e vendas em toda a categoria - se esse valor for pr√≥ximo de um, o produto ser√° um "monopolista". </li></ul><br>  Nesta fase, voc√™ precisa apresentar o m√°ximo poss√≠vel - jogue fora sinais n√£o informativos na fase de treinamento. <br><br>  Como resultado, temos 170 sinais.  No futuro, a maior import√¢ncia dos recursos <br><br><ul><li>  Vendas da semana passada (para duas, tr√™s e quatro). </li><li>  A disponibilidade do produto na semana passada √© a porcentagem de tempo em que o produto esteve presente no site. </li><li>  O coeficiente angular do cronograma de vendas de mercadorias nos √∫ltimos 7 dias. </li><li>  A propor√ß√£o do pre√ßo passado para o futuro - com um grande desconto, comece a comprar mercadorias de forma mais ativa. </li><li>  O n√∫mero de concorrentes diretos em nosso site.  Se, por exemplo, esta caneta for a √∫nica em sua categoria, as vendas ser√£o bastante estacion√°rias. </li><li>  Dimens√µes do produto - descobriu-se que o comprimento e a largura afetam significativamente a previsibilidade das vendas.  Por alguma raz√£o, para objetos longos e estreitos - guarda-chuvas ou varas de pesca, por exemplo - o cronograma √© muito mais vol√°til.  Ainda n√£o sabemos como explicar isso. </li><li>  N√∫mero do dia do ano - mostra se o Ano Novo est√° chegando, 8 de mar√ßo, o in√≠cio de um aumento sazonal nas vendas, etc. </li></ul><br><h3>  Amostragem </h3><br>  A amostra de treinamento √© dor.  N√≥s o coletamos por cerca de quatro semanas, duas das quais foram apenas para guardi√µes de dados diferentes e pedimos uma olhada no que eles t√™m.  Isso acontece sempre que voc√™ precisar de dados por um longo per√≠odo.  Mesmo em um sistema ideal de coleta de dados, por muito tempo, algo acontecer√° no esp√≠rito de "costum√°vamos pensar assim, mas depois come√ßamos a pensar de maneira diferente e a escrever os dados na mesma coluna".  Ou h√° um ou dois anos, o servidor travou, mas ningu√©m anotou exatamente quando - e os zeros n√£o significam mais que n√£o houve vendas. <br><br>  Como resultado, tivemos informa√ß√µes sobre o que as pessoas fizeram no site, o que e em que quantidades foram adicionadas aos favoritos e a uma cesta e compradas.  Coletamos uma amostra de aproximadamente 15 milh√µes de amostras de 170 recursos cada, o objetivo era o n√∫mero de vendas para a pr√≥xima semana. <br><br>  Escrevemos 2 mil linhas de c√≥digo no Spark.  Funcionou devagar, mas permitiu mastigar grandes quantidades de dados.  Parece que calcular a inclina√ß√£o de uma linha reta √© simples.  E faz√™-lo 10kk vezes quando as vendas s√£o puxadas de v√°rias bases - a tarefa n√£o √© para os fracos de cora√ß√£o. <br><br>  Por mais uma semana, estivemos envolvidos na limpeza de dados, para que o modelo n√£o se distra√≠sse com as emiss√µes e os recursos de amostragem local, mas extra√≠mos apenas as verdadeiras depend√™ncias inerentes √†s vendas da Ozon.  Aqui est√£o 3 m√©todos sigma e mais astutos para procurar anomalias.  O caso mais dif√≠cil √© restaurar as vendas durante per√≠odos de falta de mercadorias em estoque.  A solu√ß√£o mais simples √© descartar as semanas em que o produto foi lan√ßado durante a semana "segmentada". <br><br><img src="https://habrastorage.org/webt/kk/li/_z/kkli_zozkhocyxgrkur-eocnq3g.png" alt="imagem"><br><br>  Como resultado, de 15 milh√µes de amostras, restaram 10 milh√µes.√â importante aqui n√£o se deixar levar e n√£o perder a integridade da amostra (de fato, a falta de mercadorias no armaz√©m √© uma caracter√≠stica indireta de sua import√¢ncia para a empresa; remover esses bens da amostra n√£o √© o mesmo que jogar amostras aleat√≥rias ) <br><br><h3>  Tempo ML </h3><br>  Em uma amostra limpa e come√ßou a treinar modelos.  Naturalmente, come√ßamos com regress√£o linear e obtivemos MAE = 1,15.  Parece que este √© um aumento muito pequeno, mas quando voc√™ tem uma amostra de 10 milh√µes em que os valores m√©dios s√£o de 5 a 10, mesmo uma pequena altera√ß√£o no valor da m√©trica fornece um aumento incomensur√°vel na qualidade visual da previs√£o.  E como voc√™ eventualmente ter√° que apresentar a solu√ß√£o para os clientes corporativos, aumentar o n√≠vel de alegria √© um fator importante. <br><br>  A seguir, foi apresentado o sklearn.ensemble.RandomForestRegressor, que ap√≥s uma pequena sele√ß√£o de hiperpar√¢metros mostrou MAE = 1,10.  Em seguida, tentamos o XGBoost (onde sem ele) - tudo ficaria bem e o MAE = 1,03 - apenas por muito tempo.  Infelizmente, n√£o tivemos acesso √† GPU para treinar o XGBoost e, nos processadores, um modelo foi treinado por muito tempo.  Tentamos encontrar algo mais r√°pido e adotamos o LightGBM - ele treinou duas vezes mais r√°pido e mostrou o MAE ainda um pouco menos - 1,01. <br><br>  Dividimos todos os produtos em 13 categorias, como no cat√°logo do site: mesas, laptops, garrafas e, para cada categoria, treinamos modelos com diferentes profundidades de previs√£o - de 5 a 16 dias. <br><br>  O treinamento levou cerca de cinco dias e, para isso, criamos enormes clusters de computa√ß√£o.  Desenvolvemos esse pipeline: a pesquisa aleat√≥ria funciona por um longo tempo, fornece os 10 principais conjuntos de hiperpar√¢metros e, em seguida, o cientista trabalha com eles manualmente - cria m√©tricas adicionais de qualidade (calculamos o MAE para diferentes faixas de objetivos), cria curvas de aprendizado (por exemplo, descartamos parte do treinamento amostras e treinadas novamente, verificando se novos dados reduzem a perda na amostra de teste) e outros gr√°ficos. <br><br>  Um exemplo de uma an√°lise detalhada para um dos conjuntos de hiperpar√¢metros: <br><br><div class="spoiler">  <b class="spoiler_title">M√©trica de qualidade detalhada</b> <div class="spoiler_text"><table><tbody><tr><td><p>  Conjunto de trem: </p><br></td><td><p>  Conjunto de teste: </p><br></td></tr><tr><td>  Para destino = 0, MAE = 0,142222484602 </td><td>  Para 0 MAE = 0,141900737761 </td></tr><tr><td>  Para o destino&gt; 0, MAPE = 45.168530676 </td><td>  Para&gt; 0 MAPE = 45.5771812826 </td></tr><tr><td>  Erros maiores que 0 - 67.931341691% </td><td>  Erros maiores que 0 - 51.6405939896% </td></tr><tr><td>  Erros maiores que 1 - 19.0346986379% </td><td>  Erros maiores que 1 - 12.1977096603% </td></tr><tr><td>  Erros mais de 2 - 8.94313926245% </td><td>  Erros mais de 2 - 5.16977226441% </td></tr><tr><td>  Erros mais de 3 - 5,42406856507% </td><td>  Erros mais de 3 - 3,12760834969% </td></tr><tr><td>  Erros mais de 4 - 3.67938161595% <br></td><td>  Erros mais de 4 - 2.10263125679% </td></tr><tr><td>  Erros mais de 5 - 2,67322988948% <br></td><td>  Erros mais de 5 - 1,56473158807% <br></td></tr><tr><td>  Erros mais de 6 - 2,0618556701% <br></td><td>  Erros mais de 6 - 1.19599209102% <br></td></tr><tr><td>  Erros mais de 7 - 1,65887701209% </td><td>  Erros maiores que 7 - 0,949300173983% <br></td></tr><tr><td>  Erros mais de 8 - 1,36821095777% <br></td><td>  Erros mais de 8 - 0,77810772461% </td></tr><tr><td>  Erros mais de 9 - 1,15368611519% </td><td>  Erros maiores que 9 - 0,659205318158% <br></td></tr><tr><td>  Erros mais de 10 - 0,99199395014% </td><td>  Erros mais de 10 - 0,554593106723% </td></tr><tr><td>  Erros mais de 11 - 0,863969667827% </td><td>  Erros mais de 11 - 0,490045146476% <br></td></tr><tr><td>  Erros mais de 12 - 0,764347266082% <br></td><td>  Erros mais de 12 - 0,428835873827% <br></td></tr><tr><td>  Erros mais de 13 - 0,68086818247% </td><td>  Erros com mais de 13 - 0,386545830907% <br></td></tr><tr><td>  Erros mais de 14 - 0,613446089087% </td><td>  Erros mais de 14 - 0,343884822697% <br></td></tr><tr><td>  Erros mais de 15 - 0,556297016335% <br></td><td>  Erros mais de 15 - 0,316433391328% <br></td></tr><tr><td>  Para destino = 0, MAE = 0,142222484602 <br></td><td>  Para destino = 0, MAE = 0,141900737761 <br></td></tr><tr><td>  Para destino = 1, MAE = 0,63978556493 <br></td><td>  Para destino = 1, MAE = 0,660823509405 </td></tr><tr><td>  Para destino = 2, MAE = 1,01528075312 </td><td>  Para destino = 2, MAE = 1,01098070566 </td></tr><tr><td>  Para destino = 3, MAE = 1,43762342295 </td><td>  Para destino = 3, MAE = 1,44836233499 </td></tr><tr><td>  Para destino = 4, MAE = 1,82790678437 <br></td><td>  Para destino = 4, MAE = 1,86539223382 <br></td></tr><tr><td>  Para destino = 5, MAE = 2,15369976552 <br></td><td>  Para destino = 5, MAE = 2,16017884573 </td></tr><tr><td>  Para destino = 6, MAE = 2,51629758129 <br></td><td>  Para destino = 6, MAE = 2,51987403661 <br></td></tr><tr><td>  Para destino = 7, MAE = 2,80225497415 <br></td><td>  Para destino = 7, MAE = 2,97580015564 <br></td></tr><tr><td>  Para destino = 8, MAE = 3,09405048248 <br></td><td>  Para destino = 8, MAE = 3,21914648525 <br></td></tr><tr><td>  Para destino = 9, MAE = 3,39256765159 <br></td><td>  Para destino = 9, MAE = 3,54572928241 <br></td></tr><tr><td>  Para destino = 10, MAE = 3,6640339953 </td><td>  Para destino = 10, MAE = 3,84409605282 <br></td></tr><tr><td>  Para destino = 11, MAE = 4,02797747118 <br></td><td>  Para destino = 11, MAE = 4,21828735273 <br></td></tr><tr><td>  Para destino = 12, MAE = 4,17163467899 <br></td><td>  Para destino = 12, MAE = 3,92536509115 <br></td></tr><tr><td>  Para meta = 14, MAE = 4,789090364522 <br></td><td>  Para destino = 14, MAE = 5,11290428675 </td></tr><tr><td>  Para destino = 15, MAE = 4,89409916994 <br></td><td>  Para destino = 15, MAE = 5,20892023117 <br></td></tr></tbody></table><br>  Perda de trem = 0,535842111392 <br>  Perda de teste = 0,895529959873 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Previs√£o de gr√°fico (alvo) para o conjunto de treinamento</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3m/o6/ho/3mo6hoqfklfc69z55btog7e6q_w.png" alt="imagem"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Previs√£o de gr√°fico (alvo) para amostra de teste</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hq/q6/bm/hqq6bm7aqcbngqum8mgdyhjibna.png" alt="imagem"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Erro de previs√£o de tempos em tempos</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/in/mu/be/inmubedyg9b6hzyttimdneuh5-s.png" alt="imagem"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Classificar erro crescente na amostra de teste</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/74/h3/kt/74h3ktebx43a9mhmie6sgp5ua_i.png" alt="imagem"><br></div></div><br>  Se nenhum deles corresponder, procure aleatoriamente novamente.  Foi assim que treinamos o modelo por 5 ou 5 dias no ritmo industrial.  Est√°vamos de servi√ßo, algu√©m √† noite, algu√©m acordou de manh√£, olhou para os 10 principais par√¢metros, reiniciou ou salvou o modelo e foi dormir mais.  Nesse modo, trabalhamos por uma semana e treinamos 130 modelos - 13 tipos de produtos e 10 profundidades de previs√£o, cada um com 170 recursos.  O MAE m√©dio para a s√©rie temporal cv de 5 vezes √© igual a 1. <br><br>  Pode parecer que isso n√£o √© muito legal - e √© assim, a menos que voc√™ tenha uma grande parte na sele√ß√£o de unidades.  Como uma an√°lise dos resultados mostra, as unidades s√£o as piores de todas - o fato de um produto ser comprado uma vez por semana n√£o diz nada sobre se existe demanda por ele.  Uma vez que qualquer coisa pode ser vendida - existe uma pessoa que compra uma estatueta de porcelana na forma de um dentista, e isso n√£o diz nada sobre vendas futuras ou sobre vendas passadas.  Em geral, n√£o ficamos muito chateados com isso. <br><br><h3>  Dicas e truques </h3><br>  O que deu errado e como isso pode ser evitado? <br><br>  O primeiro problema √© a sele√ß√£o de par√¢metros.  Come√ßamos a usar o RandomizedSearchCV - uma ferramenta conhecida da sklearn para classificar hiperpar√¢metros.  √â aqui que a primeira surpresa nos esperava. <br><br><div class="spoiler">  <b class="spoiler_title">Assim</b> <div class="spoiler_text"><code>from sklearn.model_selection import ParameterSampler <br> from sklearn.model_selection import RandomizedSearchCV <br> <br> estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=72) <br> param_grid = {'boosting_type': boosting_type, 'num_leaves': num_leaves, 'max_depth': max_depth, 'learning_rate':learning_rate, 'n_estimators': n_estimators, 'subsample_for_bin': subsample_for_bin, 'min_child_samples': min_child_samples, 'colsample_bytree': colsample_bytree, 'reg_alpha': reg_alpha, 'max_bin': max_bin} <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=1, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  O c√°lculo simplesmente p√°ra (o que √© importante, n√£o cai, mas continua a funcionar, mas em um n√∫mero cada vez menor de n√∫cleos e, em algum momento, apenas p√°ra). <br><br><div class="spoiler">  <b class="spoiler_title">Eu tive que paralelizar o processo devido ao RandomizedSearchCV</b> <div class="spoiler_text"> <code>estimator = lightgbm.LGBMRegressor(application='regression_l1', is_training_metric = True, objective = 'regression_l1', num_threads=1) <br> <br> rscv = RandomizedSearchCV(estimator, param_grid, refit=False, n_iter=100, scoring='neg_mean_absolute_error', n_jobs=72, cv=10, verbose=3, pre_dispatch='1*n_jobs', error_score=-1, return_train_score='warn') <br> <br> rscv .fit(X_train.values, y_train['target'].values) <br> print('Best parameters found by grid search are:', rscv.best_params_)</code> <br> </div></div><br>  Mas o RandomizedSearchCV pega quase todo o conjunto de dados para cada "trabalho".  Portanto, √© necess√°rio expandir bastante a quantidade de RAM, possivelmente sacrificando o n√∫mero de n√∫cleos. <br><br>  Quem nos diria ent√£o sobre coisas maravilhosas como o hiperopt!  Desde que aprendemos, usamos apenas. <br><br>  Outro truque que ocorreu mais perto do final do projeto foi escolher modelos que tivessem o par√¢metro colsample_bytree (este √© o par√¢metro LightGBM, que indica a porcentagem de recursos a serem oferecidos a cada lener) na regi√£o de 0,2-0,3, porque quando o carro Funciona na produ√ß√£o, pode n√£o haver tabelas e os recursos individuais podem n√£o ser contados corretamente.  Essa regulariza√ß√£o permite garantir que esses recursos n√£o contabilizados afetem pelo menos nem todos os lerners do modelo. <br>  Empiricamente, chegamos √† conclus√£o de que precisamos fazer mais estimadores e distorcer mais a regulariza√ß√£o.  Esta n√£o √© uma regra de trabalho com o LightGBM, mas esse esquema funcionou para n√≥s. <br><br>  Bem e, claro, Spark.  Por exemplo, existe um bug que o pr√≥prio Spark conhece: se voc√™ pegar v√°rias colunas de uma tabela e criar uma nova, e depois pegar outras da mesma tabela e criar uma nova, e depois sintonizar as tabelas que voc√™ recebe, tudo vai quebrar, embora n√£o deva.  Voc√™ pode ser salvo apenas se livrando de todos os c√°lculos pregui√ßosos.  At√© escrevemos uma fun√ß√£o especial - bumb_df, que transforma o Data Frame em um RDD de volta em um Data Frame.  Ou seja, redefine todos os c√°lculos pregui√ßosos.  Isso pode se proteger da maioria dos problemas do Spark. <br><br><div class="spoiler">  <b class="spoiler_title">bumb_df</b> <div class="spoiler_text"> <code>def bump_df(df): <br> # to avoid problem: AnalysisException: resolved attribute(s) <br> df_rdd = df.rdd <br> if df_rdd.isEmpty(): <br> df = df_rdd.toDF(schema=df.schema) <br> return df <br> else: <br> return df_rdd.toDF(schema=df.schema) <br></code> <br></div></div><br><h3>  A previs√£o est√° pronta: quanto vamos pedir? </h3><br>  A previs√£o de vendas √© uma tarefa puramente matem√°tica, e se a distribui√ß√£o normal de um erro com m√©dia zero for uma vit√≥ria para um matem√°tico, ent√£o para comerciantes que t√™m todos os rublos em sua conta, isso √© inaceit√°vel. <br><br>  Se um iPhone extra ou um vestido da moda no armaz√©m n√£o √© um problema, mas um estoque de seguros, a aus√™ncia do mesmo iPhone no armaz√©m √© uma perda de pelo menos margem e no m√°ximo de imagem, e isso n√£o pode ser permitido. <br><br>  Para ensinar o algoritmo a comprar o quanto for necess√°rio, tivemos que calcular o custo de recompra e subcompra de cada produto e treinar um modelo simples para minimizar poss√≠veis perdas de dinheiro. <br><br>  O modelo recebe uma previs√£o de vendas na entrada, adiciona ru√≠do aleat√≥rio e normalmente distribu√≠do (simulamos as imperfei√ß√µes dos fornecedores) e aprende a adicionar exatamente o mesmo √† previs√£o de cada produto em particular para minimizar as perdas de dinheiro. <br><br>  Assim, um pedido √© uma previs√£o + estoque de seguran√ßa, que garante a cobertura do erro de previs√£o e da imperfei√ß√£o do mundo exterior. <br><br><h3>  Como no prod </h3><br>  O Ozon possui seu pr√≥prio cluster de computa√ß√£o bastante grande, no qual todas as noites um pipeline (usamos fluxo de ar) de mais de 15 trabalhos √© lan√ßado.  √â assim: <br><br><img src="https://habrastorage.org/webt/cc/sq/gb/ccsqgbj2p2xztr9qlllahzgr_4c.png" alt="imagem"><br><br>  Todas as noites, o algoritmo √© lan√ßado, extrai cerca de 20 GB de dados de v√°rias fontes para hdfs locais, seleciona um fornecedor para cada produto, coleta recursos para cada produto, faz uma previs√£o de vendas e gera pedidos com base no cronograma de entrega.  √Äs 6-7 da manh√£, damos √† mesa as pessoas respons√°veis ‚Äã‚Äãpor trabalhar com os fornecedores de mesas prontas que voam com um clique de um bot√£o para os fornecedores. <br><br><h3>  Nem uma √∫nica previs√£o </h3><br>  O modelo treinado conhece a depend√™ncia da previs√£o em qualquer recurso e, como resultado, se voc√™ congelar os sinais N-1 e come√ßar a mudar um, poder√° observar como isso afeta a previs√£o.  Obviamente, o mais interessante √© como as vendas dependem do pre√ßo. <br><br>  √â importante observar que a demanda depende n√£o apenas do pre√ßo.  Por exemplo, se voc√™ fizer pequenos descontos em tren√≥s no ver√£o, isso ainda n√£o os ajudar√° a vender.  Estamos fazendo mais descontos, e aparecem pessoas que est√£o "preparando um tren√≥ no ver√£o".  Mas at√© um certo n√≠vel de descontos, ainda n√£o conseguimos alcan√ßar a parte do c√©rebro respons√°vel pelo planejamento.  No inverno, funciona como qualquer produto - voc√™ faz um desconto e vende mais rapidamente. <br><br><img src="https://habrastorage.org/webt/zp/by/jg/zpbyjgawjuxfa0pfm3rrp0sb4f0.png" alt="imagem"><br><br><h3>  Planos </h3><br>  Agora, estamos estudando ativamente o agrupamento de s√©ries temporais para distribuir mercadorias entre os clusters com base na natureza da curva que descreve suas vendas.  Por exemplo, sazonal, tradicionalmente popular no ver√£o ou, inversamente, no inverno.  Quando aprendemos a separar produtos com um longo hist√≥rico de vendas, planejamos destacar os recursos baseados em itens que informar√£o qual ser√° o padr√£o de vendas para um novo produto rec√©m-lan√ßado - por enquanto, essa √© a nossa principal tarefa. <br><br>  Redes neurais e modelos param√©tricos de s√©ries temporais, e tudo isso no conjunto, certamente ser√£o maiores. <br><br>  Particularmente, gra√ßas ao novo sistema de previs√£o, a Ozon passou da compra de mercadorias com estoque para entregas c√≠clicas, quando compramos de um suprimento para outro e n√£o armazenamos saldos em estoque. <br><br>  Agora temos que decidir como ensinar o algoritmo a prever vendas de novos produtos e categorias inteiras.  No pr√≥ximo ano, a empresa planeja aumentar 10 vezes as vendas nas categorias e 2,5 nas √°reas de atendimento.  E precisamos dizer aos modelos que esses dados antigos s√£o relevantes, mas para um armazenamento passado diferente.  E enquanto estamos pensando em como faz√™-lo. <br><br>  A segunda coisa irracional por natureza que precisamos aprender a prever √© a moda.  Como algu√©m poderia prever que um girador venderia assim?  Como prever as vendas de novos livros de Dan Brown se um de seus livros estiver esgotado e o outro n√£o?  Enquanto estamos trabalhando nisso. <br><br>  Se voc√™ souber fazer melhor ou tiver hist√≥rias sobre o uso de aprendizado de m√°quina em batalha nos coment√°rios, discutiremos isso. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt431950/">https://habr.com/ru/post/pt431950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt431940/index.html">As pessoas se esgotam se n√£o sentem seu valor. O que fazer sobre isso?</a></li>
<li><a href="../pt431942/index.html">Inje√ß√£o de depend√™ncia hier√°rquica no React e MobX State Tree como um modelo de dom√≠nio</a></li>
<li><a href="../pt431944/index.html">Yealink Meeting Server 2.0 - Novos recursos de videoconfer√™ncia</a></li>
<li><a href="../pt431946/index.html">Semana 49 de seguran√ßa: hackers Dell e Marriott</a></li>
<li><a href="../pt431948/index.html">Deep Mind ensinou sua IA a prever a estrutura das prote√≠nas</a></li>
<li><a href="../pt431954/index.html">Ex-vice-presidente da Sun e DEC se torna presidente do MIPS / Wave, fala sobre R√∫ssia e RISC / V</a></li>
<li><a href="../pt431956/index.html">L√≥gica, explicabilidade e entendimento futuro</a></li>
<li><a href="../pt431958/index.html">Esta√ß√£o de energia da bateria virtual da Tesla se expande para 1.000 casas na Austr√°lia</a></li>
<li><a href="../pt431960/index.html">Nvidia enlouquece e abre PhysX sob BSD-3</a></li>
<li><a href="../pt431964/index.html">Mesclar classifica√ß√µes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>