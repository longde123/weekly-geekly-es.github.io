<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤›ğŸ» ğŸ™‡ğŸ¿ ğŸ˜¯ ä½¿ç”¨pytestè¿›è¡ŒPythonæµ‹è¯•ã€‚ ç¬¬3ç« pytestå›ºå®šè£…ç½® ğŸ™‰ ğŸŒ¶ï¸ ğŸ‘¨ğŸ¼â€ğŸ¤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¿”å› ä¸‹ä¸€ä¸ª 


 æœ¬ä¹¦æ˜¯æ¯æœ¬å…¨é¢çš„Pythonä¹¦ç±ä¸­éƒ½ç¼ºå°‘çš„ç« èŠ‚ã€‚ 


 å¼—å…°å…‹Â·é²ä¼Šæ–¯ 
 Boxï¼ŒInc.é¦–å¸­ç«™ç‚¹å¯é æ€§å·¥ç¨‹å¸ˆ 





 æœ¬ä¹¦ä¸­çš„ç¤ºä¾‹æ˜¯ä½¿ç”¨Python 3.6å’Œpytest 3.2ç¼–å†™çš„ã€‚ pytest 3.2æ”¯æŒPython 2.6ã€2.7å’ŒPython 3.3+ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨pytestè¿›è¡ŒPythonæµ‹è¯•ã€‚ ç¬¬3ç« pytestå›ºå®šè£…ç½®</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448786/"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿”å›</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸‹ä¸€ä¸ª</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p> æœ¬ä¹¦æ˜¯æ¯æœ¬å…¨é¢çš„Pythonä¹¦ç±ä¸­éƒ½ç¼ºå°‘çš„ç« èŠ‚ã€‚ </p><br><p> å¼—å…°å…‹Â·é²ä¼Šæ–¯ <br>  Boxï¼ŒInc.é¦–å¸­ç«™ç‚¹å¯é æ€§å·¥ç¨‹å¸ˆ </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><p> æœ¬ä¹¦ä¸­çš„ç¤ºä¾‹æ˜¯ä½¿ç”¨Python 3.6å’Œpytest 3.2ç¼–å†™çš„ã€‚  pytest 3.2æ”¯æŒPython 2.6ã€2.7å’ŒPython 3.3+ </p><br><blockquote>æœ¬ä¹¦ç½‘é¡µä¸Šçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://pragprog.com/titles/bopytest/source_code">é“¾æ¥</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://pragprog.com/titles/bopytest">pragprog.com</a>ä¸Šæä¾›äº†Tasksé¡¹ç›®ä»¥åŠæœ¬ä¹¦ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰æµ‹è¯•çš„æºä»£ç ã€‚ æ‚¨æ— éœ€ä¸‹è½½æºä»£ç å³å¯äº†è§£æµ‹è¯•ä»£ç ã€‚ ç¤ºä¾‹ä¸­ä»¥æ–¹ä¾¿çš„å½¢å¼æä¾›äº†æµ‹è¯•ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸ºäº†è·Ÿä¸Šé¡¹ç›®çš„ä»»åŠ¡ï¼Œæˆ–è€…æ”¹ç¼–æµ‹è¯•ç¤ºä¾‹æ¥æµ‹è¯•è‡ªå·±çš„é¡¹ç›®ï¼ˆä¸è´¹åŠ›æ°”ï¼ï¼‰ï¼Œæ‚¨å¿…é¡»è½¬åˆ°æœ¬ä¹¦çš„ç½‘é¡µå¹¶ä¸‹è½½å·¥ä½œã€‚ åœ¨è¯¥ä¹¦çš„ç½‘é¡µä¸Šï¼Œæœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://pragprog.com/titles/bopytest/errata">å‹˜è¯¯</a>ä¿¡æ¯é“¾æ¥å’Œä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="https://forums.pragprog.com/forums/438">è®ºå›</a> ã€‚ </blockquote><p> åœ¨å‰§é€ä¸‹æ–¹æ˜¯è¯¥ç³»åˆ—æ–‡ç« çš„åˆ—è¡¨ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç›®å½•</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>å¼•è¨€</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ç¬¬1ç« ï¼špytestå…¥é—¨</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ç¬¬2ç« ï¼šç¼–å†™æµ‹è¯•å‡½æ•°</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ç¬¬3ç« ï¼šPytestå›ºå®šè£…ç½®</strong></a> ï¼ˆæœ¬æ–‡ï¼‰ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ç¬¬4ç« ï¼šå†…ç½®ç¯å…·</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ç¬¬5ç« ï¼šæ’ä»¶</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ç¬¬6ç« ï¼šé…ç½®</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ç¬¬7ç« ï¼šä¸å…¶ä»–å·¥å…·ä¸€èµ·ä½¿ç”¨pytest</strong></a> </li></ul></div></div><br><p> æ—¢ç„¶æ‚¨å·²ç»äº†è§£äº†pytestçš„åŸºç¡€çŸ¥è¯†ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬å°†æ³¨æ„åŠ›è½¬å‘å›ºå®šè£…ç½®ï¼Œè¿™äº›å›ºå®šè£…ç½®å¯¹äºæ„å»ºå‡ ä¹æ‰€æœ‰éå¹³å‡¡çš„è½¯ä»¶ç³»ç»Ÿçš„æµ‹è¯•ä»£ç éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ã€‚ å¤¹å…·æ˜¯pyteståœ¨å®é™…æµ‹è¯•åŠŸèƒ½ä¹‹å‰ï¼ˆæœ‰æ—¶æ˜¯ä¹‹åï¼‰æ‰§è¡Œçš„åŠŸèƒ½ã€‚ ç¯å…·ä»£ç å¯ä»¥æ‰§è¡Œæ‚¨éœ€è¦çš„ä»»ä½•æ“ä½œã€‚ æ‚¨å¯ä»¥ä½¿ç”¨å¤¹å…·æ¥è·å–æ•°æ®é›†è¿›è¡Œæµ‹è¯•ã€‚ æ‚¨å¯ä»¥åœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰ä½¿ç”¨Fixturesä½¿ç³»ç»Ÿå¤„äºå·²çŸ¥çŠ¶æ€ã€‚ å¤¹å…·ä¹Ÿç”¨äºè·å–å¤šä¸ªæµ‹è¯•çš„æ•°æ®ã€‚ </p><br><p> è¿™æ˜¯è¿”å›æ•°å­—çš„ç®€å•å¤¹å…·ç¤ºä¾‹ï¼š </p><br><blockquote> <strong>ch3 / <code>test_fixtures.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">import pytest @pytest.fixture() def some_data(): """Return answer to ultimate question.""" return 42 def test_some_data(some_data): """Use fixture return value in a test.""" assert some_data == 42</code> </pre> <br><p>  <code>@pytest.fixture()</code>è£…é¥°å™¨ç”¨äºå‘Šè¯‰pytestè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªå›ºå®šè£…ç½®ã€‚ å½“æ‚¨åœ¨æµ‹è¯•åŠŸèƒ½çš„å‚æ•°åˆ—è¡¨ä¸­åŒ…å«ç¯å…·åç§°æ—¶ï¼Œpytestä¼šåœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰çŸ¥é“å¦‚ä½•è¿è¡Œå®ƒã€‚ å¤¹å…·å¯ä»¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œä¹Ÿå¯ä»¥å°†æ•°æ®è¿”å›åˆ°æµ‹è¯•åŠŸèƒ½ã€‚ </p><br><p>  <code>test_some_data()</code>æµ‹è¯•å°†<code>test_some_data()</code>åç§°<code>some_data</code>ä½œä¸ºå‚æ•°ã€‚  pytestä¼šæ£€æµ‹åˆ°è¿™ä¸€ç‚¹å¹¶æ‰¾åˆ°å…·æœ‰è¯¥åç§°çš„ç¯å…·ã€‚ è¯¥åç§°åœ¨pytestä¸­æœ‰æ„ä¹‰ã€‚  pytestå°†åœ¨æµ‹è¯•æ¨¡å—ä¸­æŸ¥æ‰¾å…·æœ‰è¯¥åç§°çš„ç¯å…·ã€‚ å¦‚æœä»–åœ¨<em>conftest.py</em>ä¸­æ‰¾ä¸åˆ°å®ƒï¼Œä»–è¿˜å°†æœç´¢ã€‚ </p><br><p> åœ¨å¼€å§‹ç ”ç©¶å¤¹å…·ï¼ˆå’Œconftest.pyæ–‡ä»¶ï¼‰ä¹‹å‰ï¼Œæˆ‘éœ€è¦è€ƒè™‘ä»¥ä¸‹äº‹å®ï¼šæœ¯è¯­å¤¹å…·åœ¨ç¼–ç¨‹å’Œæµ‹è¯•ç¤¾åŒºï¼Œç”šè‡³åœ¨Pythonç¤¾åŒºä¸­éƒ½æœ‰è®¸å¤šå«ä¹‰ã€‚ æˆ‘å¯ä»¥äº¤æ›¿ä½¿ç”¨<code>fixture</code> ï¼Œ <code>fixture function</code>å’Œ<code>fixture method</code>æ¥å¼•ç”¨æœ¬ç« ä¸­ä»‹ç»çš„<code>@pytest.fixture()</code>å‡½æ•°ã€‚ å¤¹å…·ä¹Ÿå¯ä»¥ç”¨äºæŒ‡ç¤ºå¤¹å…·åŠŸèƒ½æ‰€å¼•ç”¨çš„èµ„æºã€‚ å¤¹å…·åŠŸèƒ½é€šå¸¸ä¼šè®¾ç½®æˆ–æ£€ç´¢æµ‹è¯•å¯ä»¥ä½¿ç”¨çš„ä¸€äº›æ•°æ®ã€‚ æœ‰æ—¶ï¼Œè¿™äº›æ•°æ®è¢«è®¤ä¸ºæ˜¯å¤¹å…·ã€‚ ä¾‹å¦‚ï¼ŒDjangoç¤¾åŒºç»å¸¸ä½¿ç”¨å›ºå®šè£…ç½®æ¥æŒ‡ç¤ºä¸€äº›åœ¨åº”ç”¨ç¨‹åºå¼€å§‹æ—¶åŠ è½½åˆ°æ•°æ®åº“ä¸­çš„åŸå§‹æ•°æ®ã€‚ </p><br><p> ä¸ç®¡å…¶ä»–å«ä¹‰å¦‚ä½•ï¼Œåœ¨pytestå’Œæœ¬ä¹¦ä¸­ï¼Œæµ‹è¯•è£…ç½®éƒ½æ˜¯æŒ‡pytestæä¾›çš„æœºåˆ¶ï¼Œç”¨äºå°†â€œå‡†å¤‡å°±ç»ªâ€å’Œâ€œæ¸…ç†åâ€ä»£ç ä¸æµ‹è¯•åŠŸèƒ½åˆ†å¼€ã€‚ </p><br><p>  pytestå›ºå®šè£…ç½®æ˜¯ä½¿pytestè¶…è¶Šå…¶ä»–æµ‹è¯•ç¯å¢ƒçš„ç‹¬ç‰¹åŠŸèƒ½ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯è®¸å¤šå—äººå°Šæ•¬çš„äººè½¬è€Œé€‰æ‹©â€¦å¹¶åšæŒä½¿ç”¨pytestçš„åŸå› ã€‚ ä½†æ˜¯ï¼Œpytestä¸­çš„è£…ç½®ä¸Djangoä¸­çš„è£…ç½®ä¸åŒï¼Œå¹¶ä¸”ä¸unittestå’Œé¼»å­ä¸­çš„è®¾ç½®å’Œæ‹†å¸ç¨‹åºä¸åŒã€‚ å›ºå®šè£…ç½®æœ‰è®¸å¤šåŠŸèƒ½å’Œç»†å¾®å·®åˆ«ã€‚ ä¸€æ—¦æœ‰äº†å…³äºå®ƒä»¬å¦‚ä½•å·¥ä½œçš„è‰¯å¥½å¿ƒç†æ¨¡å‹ï¼Œæ‚¨å°±ä¼šæ„Ÿè§‰å¥½äº›ã€‚ ä½†æ˜¯ï¼Œæ‚¨éœ€è¦ä¸å®ƒä»¬ç©ä¸€ä¼šå„¿æ‰èƒ½è¿›å…¥ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§ã€‚ </p><br><h2 id="obmen-fixtures-cherez-conftestpy"> é€šè¿‡conftest.pyå…±äº«è£…ç½® </h2><br><p> æ‚¨å¯ä»¥å°†å›ºå®šè£…ç½®æ”¾åœ¨å•ç‹¬çš„æµ‹è¯•æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯è¦åœ¨å¤šä¸ªæµ‹è¯•æ–‡ä»¶ä¸­å…±äº«å›ºå®šè£…ç½®ï¼Œæœ€å¥½åœ¨å…¬å…±ä½ç½®é›†ä¸­ä½¿ç”¨<em>conftest.py</em>æ–‡ä»¶ï¼Œé›†ä¸­è¿›è¡Œæ‰€æœ‰æµ‹è¯•ã€‚ å¯¹äºä»»åŠ¡é¡¹ç›®ï¼Œæ‰€æœ‰å›ºå®šè£…ç½®éƒ½å°†ä½äº<code>tasks_proj/tests/conftest.py</code> ã€‚ </p><br><p> ä»é‚£é‡Œï¼Œä»»ä½•é¢å›¢éƒ½å¯ä»¥å…±äº«å›ºå®šè£…ç½®ã€‚ å¦‚æœå¸Œæœ›ä»…åœ¨æ­¤æ–‡ä»¶çš„æµ‹è¯•ä¸­ä½¿ç”¨ç¯å…·ï¼Œåˆ™å¯ä»¥å°†ç¯å…·æ”¾åœ¨å•ç‹¬çš„æµ‹è¯•æ–‡ä»¶ä¸­ã€‚ åŒæ ·ï¼Œæ‚¨å¯ä»¥åœ¨<em>é¡¶éƒ¨æµ‹è¯•</em>ç›®å½•çš„å­ç›®å½•ä¸­æ‹¥æœ‰å…¶ä»–<em>conftest.py</em>æ–‡ä»¶ã€‚ å¦‚æœè¿™æ ·åšï¼Œè¿™äº›ä½çº§conftest.pyæ–‡ä»¶ä¸­å®šä¹‰çš„å›ºå®šè£…ç½®å°†å¯ç”¨äºæ­¤ç›®å½•å’Œå­ç›®å½•ä¸­çš„æµ‹è¯•ã€‚ ä½†æ˜¯ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒTasksé¡¹ç›®ä¸­çš„è£…ç½®éƒ½æ˜¯é’ˆå¯¹ä»»ä½•æµ‹è¯•è€Œè®¾è®¡çš„ã€‚ å› æ­¤ï¼Œåœ¨æµ‹è¯•æ ¹ç›®å½•<em>conftest.py</em>æ–‡ä»¶ä¸­ä½¿ç”¨æˆ‘ä»¬æ‰€æœ‰çš„å·¥å…·<code>tasks_proj/tests</code>æœ€æœ‰æ„ä¹‰ã€‚ </p><br><p> å°½ç®¡conftest.pyæ˜¯Pythonæ¨¡å—ï¼Œä½†ä¸åº”ç”±æµ‹è¯•æ–‡ä»¶å¯¼å…¥ã€‚ ä½•æ—¶ä¸è¾“å…¥conftestï¼  conftest.pyæ–‡ä»¶ç”±pytestè¯»å–ï¼Œå¹¶è¢«è§†ä¸ºæœ¬åœ°æ’ä»¶ï¼Œå½“æˆ‘ä»¬åœ¨ç¬¬95é¡µç¬¬5ç« â€œæ’ä»¶â€ä¸­å¼€å§‹è°ˆè®ºæ’ä»¶æ—¶ï¼Œè¯¥æ–‡ä»¶å°†å˜å¾—å¾ˆæ¸…æ¥šã€‚ç°åœ¨ï¼Œå°†<code>tests/conftest.py</code>è§†ä¸ºæ”¾ç½®ç¯å…·çš„åœ°æ–¹æµ‹è¯•ç›®å½•ä¸­çš„æ‰€æœ‰æµ‹è¯•ã€‚ ç„¶åï¼Œè®©æˆ‘ä»¬å¯¹<code>task_proj</code>è¿›è¡Œä¸€äº›æµ‹è¯•ï¼Œä»¥æ­£ç¡®ä½¿ç”¨å›ºå®šè£…ç½®ã€‚ </p><br><h2 id="ispolzovanie--fixtures-dlya-setup-i-teardown"> ä½¿ç”¨æ²»å…·è¿›è¡Œè®¾ç½®å’Œæ‹†å¸ </h2><br><p>  Tasksé¡¹ç›®ä¸­çš„å¤§å¤šæ•°æµ‹è¯•éƒ½å‡å®šTasksæ•°æ®åº“å·²ç»é…ç½®ï¼Œæ­£åœ¨è¿è¡Œå¹¶ä¸”å·²ç»å‡†å¤‡å°±ç»ªã€‚ å¦‚æœéœ€è¦æ¸…æ´ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æœ€ååˆ é™¤ä¸€äº›æ¡ç›®ã€‚ å¹¶ä¸”æ‚¨å¯èƒ½è¿˜éœ€è¦æ–­å¼€ä¸æ•°æ®åº“çš„è¿æ¥ã€‚ å¹¸è¿çš„æ˜¯ï¼Œå¤§å¤šæ•°ä»»åŠ¡å·²åœ¨ä»»åŠ¡ä»£ç ä¸­é€šè¿‡ä½¿ç”¨<code>tasks.start_tasks_db(&lt;directory to store db\&gt;, 'tiny' or 'mongo')</code>å’Œ<code>tasks.stop_tasks_db()</code> ã€‚ æˆ‘ä»¬åªéœ€è¦åœ¨æ­£ç¡®çš„æ—¶é—´è°ƒç”¨å®ƒä»¬ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚ </p><br><p> å¹¸è¿çš„æ˜¯ï¼ŒpyteståŒ…å«äº†ä¸€ä¸ªå‡ºè‰²çš„å¤¹å…·ï¼Œç§°ä¸ºtmpdirã€‚ æˆ‘ä»¬å¯ä»¥å°†å…¶ç”¨äºæµ‹è¯•ï¼Œè€Œä¸å¿…æ‹…å¿ƒæ¸…ç†ã€‚ è¿™ä¸æ˜¯é­”æœ¯ï¼Œåªæ˜¯æœ€å¥½å¥‡çš„äººçš„è‰¯å¥½ç¼–ç ä¹ æƒ¯ã€‚  ï¼ˆè¯·æ”¾å¿ƒï¼›æˆ‘ä»¬å°†åˆ†ætmpdirå¹¶åœ¨ç¬¬71é¡µä¸Šçš„â€œä½¿ç”¨tmpdirå’Œtmpdir_factoryâ€éƒ¨åˆ†ä¸­ä½¿ç”¨tmpdir_factoryè¿›è¡Œæ›´è¯¦ç»†åœ°ç¼–å†™ã€‚ï¼‰ </p><br><p> è€ƒè™‘åˆ°æ‰€æœ‰è¿™äº›ç»„ä»¶ï¼Œæ­¤ç¯å…·éå¸¸æœ‰æ•ˆï¼š </p><br><blockquote>  <strong>ch3 / a /tasks_proj/tests/conftest.py</strong> </blockquote><br><pre> <code class="plaintext hljs">import pytest import tasks from tasks import Task @pytest.fixture() def tasks_db(tmpdir): """    ,  .""" # Setup : start db tasks.start_tasks_db(str(tmpdir), 'tiny') yield #    # Teardown : stop db tasks.stop_tasks_db()</code> </pre> <br><p>  <em>tmpdir</em>å€¼ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªä»£è¡¨ç›®å½•çš„å¯¹è±¡ã€‚ ä½†æ˜¯ï¼Œå®ƒå®ç°äº†<code>__str__</code> ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>str()</code>å°†å­—ç¬¦ä¸²ä¼ é€’ç»™<code>start_tasks_db()</code> ã€‚ ç›®å‰ï¼Œæˆ‘ä»¬ä»åœ¨TinyDBä¸­ä½¿ç”¨tinyã€‚ </p><br><p> å¤¹å…·åŠŸèƒ½åœ¨ä½¿ç”¨å®ƒçš„æµ‹è¯•ä¹‹å‰è¿è¡Œã€‚ ä½†æ˜¯ï¼Œå¦‚æœå‡½æ•°å…·æœ‰<em>yield</em> ï¼Œåˆ™å®ƒå°†åœ¨æ­¤å¤„åœæ­¢ï¼Œæ§åˆ¶å°†ä¼ é€’ç»™æµ‹è¯•ï¼Œå¹¶åœ¨æµ‹è¯•å®Œæˆåæ‰§è¡Œ<em>yield</em>ä¹‹åçš„ä¸‹ä¸€è¡Œã€‚ å› æ­¤ï¼Œå°†<em>yield</em>ä¸Šæ–¹çš„ä»£ç è§†ä¸ºâ€œ setupâ€ï¼Œå¹¶å°†<em>yield</em>ä¹‹åçš„ä»£ç è§†ä¸ºâ€œ teardownâ€ã€‚ ä¸ç®¡æµ‹è¯•æœŸé—´å‘ç”Ÿä»€ä¹ˆï¼Œéƒ½å°†æ‰§è¡Œ<em>yield</em> â€œ teardownâ€ä¹‹åçš„ä»£ç ã€‚ æˆ‘ä»¬ä¸ä¼šåœ¨æ­¤ç¯å…·ä¸­è¿”å›å¸¦æœ‰è¾“å‡ºçš„æ•°æ®ã€‚ ä½†æ˜¯å¯ä»¥ã€‚ </p><br><p> è®©æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„<code>tasks.add()</code>æµ‹è¯•ä¹‹ä¸€ä»¥ä½¿ç”¨æ­¤å›ºå®šè£…ç½®ï¼š </p><br><blockquote>  ch3 / a <code>test_add</code> </blockquote><br><pre> <code class="plaintext hljs">import pytest import tasks from tasks import Task def test_add_returns_valid_id(tasks_db): """tasks.add(&lt;valid task&gt;)    .""" # GIVEN    # WHEN    # THEN  task_id  int new_task = Task('do something') task_id = tasks.add(new_task) assert isinstance(task_id, int)</code> </pre> <br><p> æ­¤å¤„çš„ä¸»è¦æ›´æ”¹æ˜¯æ–‡ä»¶ä¸­å¤šä½™çš„å›ºå®šè£…ç½®å·²è¢«åˆ é™¤ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨æµ‹è¯•å‚æ•°åˆ—è¡¨ä¸­æ·»åŠ äº†<code>tasks_db</code> ã€‚ æˆ‘å–œæ¬¢ä½¿ç”¨æ³¨é‡Šæ„é€ <em>GIVEN / WHEN / THEN</em>æ ¼å¼ï¼ˆDANO / WHEN / AFTERï¼‰çš„æµ‹è¯•ï¼Œå°¤å…¶æ˜¯å¦‚æœè¿™ä»ä»£ç ä¸­çœ‹ä¸å‡ºæ¥çš„è¯ã€‚ æˆ‘è®¤ä¸ºè¿™åœ¨è¿™ç§æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚ å¸Œæœ›GIVENåˆå§‹åŒ–çš„dbä»»åŠ¡å°†æœ‰åŠ©äºæ‰¾å‡ºä¸ºä»€ä¹ˆä½¿ç”¨<code>tasks_db</code>ä½œä¸ºæµ‹è¯•å·¥å…·ã€‚ </p><br><hr><br><p> ç¡®ä¿å·²å®‰è£…ä»»åŠ¡ã€‚ </p><br><hr><br><p> æˆ‘ä»¬ä»åœ¨æœ¬ç« ä¸­ä¸ºTasksé¡¹ç›®ç¼–å†™æµ‹è¯•ï¼Œè¯¥é¡¹ç›®æœ€åˆæ˜¯åœ¨ç¬¬2ç« ä¸­å®‰è£…çš„ã€‚å¦‚æœæ‚¨è·³è¿‡äº†æœ¬ç« ï¼Œè¯·ç¡®ä¿ä½¿ç”¨cdä»£ç å®‰è£…ä»»åŠ¡ï¼›  <code>pip install ./tasks_proj/</code> ã€‚ </p><br><hr><br><h2 id="trassirovka-fixture-execution-s-setup-show"> ä½¿ç”¨â€“setup-showè·Ÿè¸ªå¤¹å…·æ‰§è¡Œ </h2><br><p> å¦‚æœæ‚¨ä»ä¸Šä¸€èŠ‚å¼€å§‹è¿è¡Œæµ‹è¯•ï¼Œåˆ™ä¸ä¼šçœ‹åˆ°æ­£åœ¨è¿è¡Œçš„ç¯å…·ï¼š </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ $ pip install ./tasks_proj/ #      $ cd /path/to/code/ch3/a/tasks_proj/tests/func $ pytest -v test_add.py -k valid_id ===================== test session starts ====================== collected 3 items test_add.py::test_add_returns_valid_id PASSED ====================== 2 tests deselected ====================== ============ 1 passed, 2 deselected in 0.02 seconds ============</code> </pre> <br><p> åœ¨è®¾è®¡ç¯å…·æ—¶ï¼Œæˆ‘éœ€è¦æŸ¥çœ‹ä»€ä¹ˆæœ‰æ•ˆä»¥åŠä½•æ—¶å¯ç”¨ã€‚ å¹¸è¿çš„æ˜¯ï¼Œpytestæä¾›äº†è¿™æ ·çš„å‘½ä»¤è¡Œæ ‡å¿—<code>-- setup-show</code> ï¼Œå®ƒå¯ä»¥åšåˆ°ï¼š </p><br><pre> <code class="plaintext hljs">$ pytest --setup-show test_add.py -k valid_id ============================= test session starts ============================= collected 3 items / 2 deselected test_add.py SETUP S tmpdir_factory SETUP F tmpdir (fixtures used: tmpdir_factory) SETUP F tasks_db (fixtures used: tmpdir) func/test_add.py::test_add_returns_valid_id (fixtures used: tasks_db, tmpdir, tmpdir_factory). TEARDOWN F tasks_db TEARDOWN F tmpdir TEARDOWN S tmpdir_factory =================== 1 passed, 2 deselected in 0.18 seconds ====================</code> </pre> <br><p> æˆ‘ä»¬çš„æµ‹è¯•åœ¨ä¸­é—´ï¼Œè€Œpytestä¸ºæ¯ä¸ªç¯å…·æŒ‡å®šäº†SETUPå’ŒTEARDOWNéƒ¨åˆ†ã€‚ ä»<code>test_add_returns_valid_id</code>å¼€å§‹ï¼Œæ‚¨ä¼šçœ‹åˆ°<code>tmpdir</code>åœ¨æµ‹è¯•ä¹‹å‰èµ·ä½œç”¨ã€‚ åœ¨é‚£ä¹‹å‰<code>tmpdir_factory</code> ã€‚  <code>tmpdir</code>ä¼¼ä¹<code>tmpdir</code>å°†å…¶ç”¨ä½œå›ºå®šè£…ç½®ã€‚ </p><br><p> ç¯å…·åç§°å‰é¢çš„<strong>F</strong>å’Œ<strong>S</strong>è¡¨ç¤ºè¯¥åŒºåŸŸã€‚  <strong>F</strong>è¡¨ç¤ºä½œç”¨åŸŸï¼Œ <strong>S</strong>è¡¨ç¤ºä¼šè¯ä½œç”¨åŸŸã€‚ æˆ‘å°†åœ¨ç¬¬56é¡µçš„â€œç¤ºæ³¢å™¨å¤¹å…·è§„æ ¼â€éƒ¨åˆ†ä»‹ç»ç¤ºæ³¢å™¨ã€‚ </p><br><h2 id="ispolzovanie-fixtures-dlya-test-data"> ä½¿ç”¨å¤¹å…·æµ‹è¯•æ•°æ® </h2><br><p> å¤¹å…·æ˜¯å­˜å‚¨æ•°æ®è¿›è¡Œæµ‹è¯•çš„å¥½åœ°æ–¹ã€‚ æ‚¨å¯ä»¥é€€è´§ã€‚ è¿™æ˜¯ä¸€ä¸ªè¿”å›æ··åˆå‹å…ƒç»„çš„å¤¹å…·ï¼š </p><br><blockquote>  <strong>ch3 / test_fixtures.py</strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.fixture() def a_tuple(): """ -  """ return (1, 'foo', None, {'bar': 23}) def test_a_tuple(a_tuple): """Demo the a_tuple fixture.""" assert a_tuple[3]['bar'] == 32</code> </pre> <br><p> ç”±äº<code>test_a_tuple()</code>åº”è¯¥å¤±è´¥<em>ï¼ˆ23ï¼= 32ï¼‰</em> ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¤¹å…·æµ‹è¯•å¤±è´¥æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3 $ pytest test_fixtures.py::test_a_tuple ============================= test session starts ============================= collected 1 item test_fixtures.py F [100%] ================================== FAILURES =================================== ________________________________ test_a_tuple _________________________________ a_tuple = (1, 'foo', None, {'bar': 23}) def test_a_tuple(a_tuple): """Demo the a_tuple fixture.""" &gt; assert a_tuple[3]['bar'] == 32 E assert 23 == 32 test_fixtures.py:38: AssertionError ========================== 1 failed in 0.17 seconds ===========================</code> </pre> <br><p>  pytestä¸å †æ ˆè·Ÿè¸ªéƒ¨åˆ†ä¸€èµ·æ˜¾ç¤ºäº†å¯¼è‡´å¼‚å¸¸æˆ–æ–­è¨€å¤±è´¥çš„å‡½æ•°çš„å€¼å‚æ•°ã€‚ åœ¨æµ‹è¯•çš„æƒ…å†µä¸‹ï¼Œå¤¹å…·æ˜¯æµ‹è¯•çš„å‚æ•°ï¼Œå› æ­¤ä½¿ç”¨å †æ ˆè·Ÿè¸ªæŠ¥å‘Šå®ƒä»¬ã€‚ å¦‚æœåœ¨å¤¹å…·ä¸­å‘ç”Ÿæ–­è¨€ï¼ˆæˆ–å¼‚å¸¸ï¼‰ä¼šæ€æ ·ï¼Ÿ </p><br><pre> <code class="plaintext hljs">$ pytest -v test_fixtures.py::test_other_data ============================= test session starts ============================= test_fixtures.py::test_other_data ERROR [100%] =================================== ERRORS ==================================== ______________________ ERROR at setup of test_other_data ______________________ @pytest.fixture() def some_other_data(): """Raise an exception from fixture.""" x = 43 &gt; assert x == 42 E assert 43 == 42 test_fixtures.py:21: AssertionError =========================== 1 error in 0.13 seconds ===========================</code> </pre> <br><p> æœ‰å‡ ä»¶äº‹å‘ç”Ÿã€‚ å †æ ˆè·Ÿè¸ªæ­£ç¡®æ˜¾ç¤ºæ–­è¨€å‘ç”Ÿåœ¨å¤¹å…·å‡½æ•°ä¸­ã€‚ æ­¤å¤–ï¼Œ <code>test_other_data</code>æŠ¥å‘Šä¸º<strong>FAIL</strong> ï¼Œè€Œæ˜¯æŠ¥å‘Šä¸º<strong>ERROR</strong> ã€‚ è¿™æ˜¯ä¸€ä¸ªä¸»è¦åŒºåˆ«ã€‚ å¦‚æœæµ‹è¯•çªç„¶å¤±è´¥ï¼Œæ‚¨å°†çŸ¥é“å¤±è´¥å‘ç”Ÿåœ¨æµ‹è¯•æœ¬èº«ä¸­ï¼Œå¹¶ä¸”ä¸æŸäº›å›ºå®šè£…ç½®æ— å…³ã€‚ </p><br><p> ä½†æ˜¯ä»»åŠ¡é¡¹ç›®å‘¢ï¼Ÿ å¯¹äºTasksé¡¹ç›®ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨ä¸€äº›æ•°æ®å›ºå®šè£…ç½®ï¼Œå¯èƒ½ä½¿ç”¨å…·æœ‰ä¸åŒå±æ€§çš„ä¸åŒä»»åŠ¡åˆ—è¡¨ï¼š </p><br><blockquote>  <strong>ch3 / a / tasks_proj /æµ‹è¯•/conftest.py</strong> </blockquote><br><pre> <code class="plaintext hljs">#    Task constructor # Task(summary=None, owner=None, done=False, id=None) # summary    # owner  done   # id    @pytest.fixture() def tasks_just_a_few(): """    .""" return ( Task('Write some code', 'Brian', True), Task("Code review Brian's code", 'Katie', False), Task('Fix what Brian did', 'Michelle', False)) @pytest.fixture() def tasks_mult_per_owner(): """     .""" return ( Task('Make a cookie', 'Raphael'), Task('Use an emoji', 'Raphael'), Task('Move to Berlin', 'Raphael'), Task('Create', 'Michelle'), Task('Inspire', 'Michelle'), Task('Encourage', 'Michelle'), Task('Do a handstand', 'Daniel'), Task('Write some books', 'Daniel'), Task('Eat ice cream', 'Daniel'))</code> </pre> <br><p> æ‚¨å¯ä»¥ç›´æ¥ä»æµ‹è¯•æˆ–å…¶ä»–å›ºå®šè£…ç½®ä¸­ä½¿ç”¨å®ƒä»¬ã€‚ è®©æˆ‘ä»¬åˆ›å»ºéç©ºæ•°æ®åº“ä»¥åœ¨å…¶å¸®åŠ©ä¸‹è¿›è¡Œæµ‹è¯•ã€‚ </p><br><h2 id="ispolzovanie-multiple-fixtures"> ä½¿ç”¨å¤šä¸ªç¯å…· </h2><br><p> æ‚¨å·²ç»çœ‹åˆ°tmpdirä½¿ç”¨tmpdir_factoryã€‚ æ‚¨åœ¨æˆ‘ä»¬çš„task_dbå›ºå®šè£…ç½®ä¸­ä½¿ç”¨äº†tmpdirã€‚ è®©æˆ‘ä»¬ç»§ç»­è¿›è¡Œé“¾æ¥ï¼Œå¹¶ä¸ºä»»åŠ¡é¡¹ç›®çš„éç©ºåŸºç¡€æ·»åŠ ä¸€äº›ä¸“ç”¨å›ºå®šè£…ç½®ï¼š </p><br><blockquote>  <strong>ch3 / a / tasks_proj /æµ‹è¯•/conftest.py</strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.fixture() def db_with_3_tasks(tasks_db, tasks_just_a_few): """   3 ,  .""" for t in tasks_just_a_few: tasks.add(t) @pytest.fixture() def db_with_multi_per_owner(tasks_db, tasks_mult_per_owner): """   9 , 3 owners,  3   .""" for t in tasks_mult_per_owner: tasks.add(t)</code> </pre> <br><p> æ‰€æœ‰è¿™äº›è£…ç½®éƒ½åœ¨å…¶å‚æ•°åˆ—è¡¨ä¸­åŒ…æ‹¬ä¸¤ä¸ªè£…ç½®ï¼š <code>tasks_db</code>å’Œæ•°æ®é›†ã€‚ æ•°æ®é›†ç”¨äºå°†ä»»åŠ¡æ·»åŠ åˆ°æ•°æ®åº“ã€‚ ç°åœ¨ï¼Œå¦‚æœæ‚¨å¸Œæœ›æµ‹è¯•ä»éç©ºæ•°æ®åº“å¼€å§‹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æµ‹è¯•ï¼Œä¾‹å¦‚ï¼š </p><br><blockquote>  <strong>ch3 / a / tasks_proj /æµ‹è¯•/func/test_add.py</strong> </blockquote><br><pre> <code class="plaintext hljs">def test_add_increases_count(db_with_3_tasks): """Test tasks.add()    tasks.count().""" # GIVEN db  3  # WHEN     tasks.add(Task('throw a party')) # THEN    1 assert tasks.count() == 4</code> </pre> <br><p> è¿™ä¹Ÿè¯´æ˜äº†ä½¿ç”¨å›ºå®šè£…ç½®çš„ä¸»è¦åŸå› ä¹‹ä¸€ï¼šå°†æµ‹è¯•é‡ç‚¹æ”¾åœ¨æ‚¨å®é™…æµ‹è¯•çš„å†…å®¹ä¸Šï¼Œè€Œä¸æ˜¯ä¸ºå‡†å¤‡æµ‹è¯•åšäº›ä»€ä¹ˆã€‚ æˆ‘å–œæ¬¢å¯¹GIVEN / WHEN / THENä½¿ç”¨æ³¨é‡Šï¼Œå¹¶å‡ºäºä¸¤ä¸ªåŸå› å°è¯•å°†å°½å¯èƒ½å¤šçš„æ•°æ®ï¼ˆGIVENï¼‰æ¨é€åˆ°å›ºå®šè£…ç½®ä¸­ã€‚ é¦–å…ˆï¼Œå®ƒä½¿æµ‹è¯•æ›´å…·å¯è¯»æ€§ï¼Œå› æ­¤æ›´æ˜“äºç»´æŠ¤ã€‚ å…¶æ¬¡ï¼Œå¤¹å…·ä¸­çš„æ–­è¨€æˆ–å¼‚å¸¸ä¼šå¯¼è‡´é”™è¯¯ï¼ˆERRORï¼‰ï¼Œè€Œæµ‹è¯•åŠŸèƒ½ä¸­çš„æ–­è¨€æˆ–å¼‚å¸¸ä¼šå¯¼è‡´é”™è¯¯ï¼ˆFAILï¼‰ã€‚ å¦‚æœæ•°æ®åº“åˆå§‹åŒ–<code>test_add_increases_count()</code>æˆ‘ä¸å¸Œæœ›<code>test_add_increases_count()</code>å¤±è´¥ã€‚ è¿™åªæ˜¯ä»¤äººå›°æƒ‘ã€‚ æˆ‘å¸Œæœ›åªæœ‰åœ¨<code>add ()</code>ç¡®å®æ— æ³•æ›´æ”¹è®¡æ•°å™¨çš„æƒ…å†µä¸‹ï¼Œ <code>test_add_increases_count()</code>çš„å¤±è´¥ï¼ˆFAILï¼‰ <code>test_add_increases_count()</code>å¯èƒ½ã€‚ è®©æˆ‘ä»¬è¿è¡Œå¹¶æŸ¥çœ‹æ‰€æœ‰ç¯å…·å¦‚ä½•å·¥ä½œï¼š </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/a/tasks_proj/tests/func $ pytest --setup-show test_add.py::test_add_increases_count ============================= test session starts ============================= collected 1 item test_add.py SETUP S tmpdir_factory SETUP F tmpdir (fixtures used: tmpdir_factory) SETUP F tasks_db (fixtures used: tmpdir) SETUP F tasks_just_a_few SETUP F db_with_3_tasks (fixtures used: tasks_db, tasks_just_a_few) func/test_add.py::test_add_increases_count (fixtures used: db_with_3_tasks, tasks_db, tasks_just_a_few, tmpdir, tmpdir_factory). TEARDOWN F db_with_3_tasks TEARDOWN F tasks_just_a_few TEARDOWN F tasks_db TEARDOWN F tmpdir TEARDOWN S tmpdir_factory ========================== 1 passed in 0.20 seconds ===========================</code> </pre> <br><p> åœ¨åŠŸèƒ½å’Œä¼šè¯åŒºåŸŸï¼Œæˆ‘ä»¬åˆå¾—åˆ°äº†ä¸€å †Fså’ŒSsã€‚ è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯ä»€ä¹ˆã€‚ </p><br><h2 id="specifikaciya-oblasteyscope-fixture"> ç¤ºæ³¢å™¨å¤¹å…·è§„æ ¼ </h2><br><p> ç¯å…·åŒ…æ‹¬ä¸€ä¸ªåä¸º<strong>scope</strong>çš„å¯é€‰å‚æ•°ï¼Œè¯¥å‚æ•°ç¡®å®šç¯å…·æ¥æ”¶å®‰è£…å’Œæ‹†å¸çš„é¢‘ç‡ã€‚  <code>@ pytest.fixture()</code>çš„<em>scope</em>å‚æ•°å¯ä»¥å…·æœ‰å‡½æ•°ï¼Œç±»ï¼Œæ¨¡å—æˆ–ä¼šè¯å€¼ã€‚  <em>èŒƒå›´</em>æ˜¯é»˜è®¤æƒ…å†µä¸‹çš„åŠŸèƒ½ã€‚  task_dbè®¾ç½®å’Œæ‰€æœ‰è£…ç½®éƒ½å°šæœªå®šä¹‰åŒºåŸŸã€‚ å› æ­¤ï¼Œå®ƒä»¬æ˜¯åŠŸèƒ½æ€§å›ºå®šè£…ç½®ã€‚ </p><br><p> ä»¥ä¸‹æ˜¯æ¯ä¸ª<em>èŒƒå›´</em>å€¼çš„ç®€è¦è¯´æ˜ï¼š </p><br><ul><li><p>  <em>èŒƒå›´='åŠŸèƒ½'</em> </p><br><p> å¯¹äºæµ‹è¯•çš„æ¯ä¸ªåŠŸèƒ½éƒ½æ‰§è¡Œä¸€æ¬¡ã€‚ åœ¨ä½¿ç”¨å¤¹å…·è¿›è¡Œæ¯æ¬¡æµ‹è¯•ä¹‹å‰ï¼Œå°†è¿è¡Œè®¾ç½®éƒ¨åˆ†ã€‚ æ¯æ¬¡ä½¿ç”¨å¤¹å…·æµ‹è¯•åï¼Œæ‹†å¸éƒ¨åˆ†å°±ä¼šå¼€å§‹ã€‚ å¦‚æœæœªæŒ‡å®šscopeå‚æ•°ï¼Œåˆ™è¿™æ˜¯é»˜è®¤åŒºåŸŸã€‚ </p><br></li><li><p>  <em>èŒƒå›´='ç±»åˆ«'</em> </p><br><p> æ— è®ºè¯¥ç±»ä¸­æœ‰å¤šå°‘ç§æµ‹è¯•æ–¹æ³•ï¼Œå®ƒéƒ½ä¼šå¯¹æ¯ä¸ªæµ‹è¯•ç±»æ‰§è¡Œä¸€æ¬¡ã€‚ </p><br></li><li><p>  <em>èŒƒå›´='æ¨¡å—'</em> </p><br><p> æ— è®ºä½¿ç”¨è¯¥æ¨¡å—å¤šå°‘æ¬¡æµ‹è¯•åŠŸèƒ½ï¼Œæ–¹æ³•æˆ–å…¶ä»–å›ºå®šè£…ç½®ï¼Œæ¯ä¸ªæ¨¡å—éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚ </p><br></li><li><p>  <em>èŒƒå›´=â€œä¼šè¯â€</em> </p><br><p> æ¯ä¸ªä¼šè¯æ‰§è¡Œä¸€æ¬¡ã€‚ æ‰€æœ‰ä½¿ç”¨ä¼šè¯èŒƒå›´å›ºå®šè£…ç½®çš„æµ‹è¯•æ–¹æ³•å’ŒåŠŸèƒ½éƒ½ä½¿ç”¨å•ä¸ªè®¾ç½®å’Œæ‹†å¸è°ƒç”¨ã€‚ </p><br></li></ul><br><p> å®é™…ä½œç”¨åŸŸèŒƒå›´å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><blockquote>  <strong>ch3 / test_scope.py</strong> </blockquote><br><pre> <code class="plaintext hljs">"""Demo fixture scope.""" import pytest @pytest.fixture(scope='function') def func_scope(): """A function scope fixture.""" @pytest.fixture(scope='module') def mod_scope(): """A module scope fixture.""" @pytest.fixture(scope='session') def sess_scope(): """A session scope fixture.""" @pytest.fixture(scope='class') def class_scope(): """A class scope fixture.""" def test_1(sess_scope, mod_scope, func_scope): """   ,   .""" def test_2(sess_scope, mod_scope, func_scope): """     .""" @pytest.mark.usefixtures('class_scope') class TestSomething(): """Demo class scope fixtures.""" def test_3(self): """Test using a class scope fixture.""" def test_4(self): """Again, multiple tests are more fun."""</code> </pre> <br><p> è®©æˆ‘ä»¬ä½¿ç”¨<code>--setup-show</code>æ¥æ¼”ç¤ºæ ¹æ®åŒºåŸŸæ‰§è¡Œçš„å…·å¤¹å…·å’Œè®¾ç½®è°ƒç”¨ä¸æ‹†å¸çš„é…å¯¹æ¬¡æ•°ï¼š </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/ $ pytest --setup-show test_scope.py ============================= test session starts ============================= collected 4 items test_scope.py SETUP S sess_scope SETUP M mod_scope SETUP F func_scope test_scope.py::test_1 (fixtures used: func_scope, mod_scope, sess_scope). TEARDOWN F func_scope SETUP F func_scope test_scope.py::test_2 (fixtures used: func_scope, mod_scope, sess_scope). TEARDOWN F func_scope SETUP C class_scope test_scope.py::TestSomething::()::test_3 (fixtures used: class_scope). test_scope.py::TestSomething::()::test_4 (fixtures used: class_scope). TEARDOWN C class_scope TEARDOWN M mod_scope TEARDOWN S sess_scope ========================== 4 passed in 0.11 seconds ===========================</code> </pre> <br><p> ç°åœ¨ï¼Œæ‚¨ä¸ä»…å¯ä»¥çœ‹åˆ°<strong>F</strong>å’Œ<strong>S</strong>è¡¨ç¤ºåŠŸèƒ½å’Œä¼šè¯ï¼Œè€Œä¸”è¿˜å¯ä»¥çœ‹åˆ°<strong>C</strong>å’Œ<strong>M</strong>è¡¨ç¤ºç±»å’Œæ¨¡å—ã€‚ </p><br><p> èŒƒå›´æ˜¯ä½¿ç”¨ç¯å…·å®šä¹‰çš„ã€‚ æˆ‘çŸ¥é“è¿™ä»ä»£ç ä¸­æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä½†è¿™æ˜¯ç¡®ä¿å®Œå…¨completelyåŸçš„é‡è¦ä¸€ç‚¹ã€‚äº†è§£â€œï¼‰ã€‚ èŒƒå›´æ˜¯åœ¨ç¯å…·å®šä¹‰ä¸­å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯åœ¨å…¶è°ƒç”¨ä½ç½®å®šä¹‰çš„ã€‚ ä½¿ç”¨å¤¹å…·çš„æµ‹è¯•åŠŸèƒ½æ— æ³•æ§åˆ¶è®¾ç½®ï¼ˆSETUPï¼‰å’Œå¤¹å…·æŸåï¼ˆTEARDOWNï¼‰çš„é¢‘ç‡ã€‚ </p><br><p> ç¯å…·åªèƒ½ä¾é æ¥è‡ªç›¸åŒæˆ–æ›´å¤šæ‰©å±•èŒƒå›´çš„å…¶ä»–ç¯å…·ã€‚ å› æ­¤ï¼ŒåŠŸèƒ½èŒƒå›´å›ºå®šè£…ç½®å¯èƒ½ä¾èµ–äºå…¶ä»–åŠŸèƒ½èŒƒå›´å›ºå®šè£…ç½®ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œä»åœ¨Tasksé¡¹ç›®ä¸­ä½¿ç”¨ï¼‰ã€‚ åŠŸèƒ½èŒƒå›´å›ºå®šè£…ç½®ä¹Ÿå¯èƒ½å–å†³äºä¼šè¯åŒºåŸŸçš„ç±»ï¼Œæ¨¡å—å’Œå›ºå®šè£…ç½®ï¼Œä½†ç»ä¸ä¼šç›¸åã€‚ </p><br><h3 id="smena-scope-dlya-tasks-project-fixtures"> ä»»åŠ¡é¡¹ç›®å›ºå®šè£…ç½®çš„æ›´æ”¹èŒƒå›´ </h3><br><p> æœ‰äº†å¯¹èŒƒå›´çš„äº†è§£ï¼Œç°åœ¨è®©æˆ‘ä»¬æ›´æ”¹Taské¡¹ç›®çš„æŸäº›å›ºå®šè£…ç½®çš„èŒƒå›´ã€‚ </p><br><p> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•æ—¶é—´ä¸Šæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ ä½†æ˜¯ï¼Œæ‚¨å¿…é¡»æ‰¿è®¤ï¼Œä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•å’Œä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥æ˜¯æ²¡æœ‰ç”¨çš„ã€‚ åªè¦æˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªç©ºçš„æ•°æ®åº“ï¼Œåˆ™åœ¨å¿…è¦æ—¶å°±è¶³å¤Ÿäº†ã€‚ </p><br><p> è¦å°†<code>tasks_db</code>ä¹‹ç±»çš„<code>tasks_db</code>ç”¨ä½œä¼šè¯èŒƒå›´ï¼Œå¿…é¡»ä½¿ç”¨<code>tmpdir_factory</code> ï¼Œå› ä¸º<code>tmpdir</code>æ˜¯å‡½æ•°çš„èŒƒå›´ï¼Œè€Œ<code>tmpdir_factory</code>æ˜¯ä¼šè¯çš„èŒƒå›´ã€‚ å¹¸è¿çš„æ˜¯ï¼Œè¿™åªæ˜¯ä¸€è¡Œä»£ç æ›´æ”¹ï¼ˆå—¯ï¼Œå¦‚æœåœ¨å‚æ•°åˆ—è¡¨ä¸­è€ƒè™‘<code>tmpdir-&gt;tmpdir_factory</code> ï¼Œ <code>tmpdir-&gt;tmpdir_factory</code>ä¸¤è¡Œï¼‰ï¼š </p><br><blockquote>  <strong>ch3 / b / tasks_proj /æµ‹è¯•/conftest.py</strong> </blockquote><br><pre> <code class="plaintext hljs">"""Define some fixtures to use in the project.""" import pytest import tasks from tasks import Task @pytest.fixture(scope='session') def tasks_db_session(tmpdir_factory): """Connect to db before tests, disconnect after.""" temp_dir = tmpdir_factory.mktemp('temp') tasks.start_tasks_db(str(temp_dir), 'tiny') yield tasks.stop_tasks_db() @pytest.fixture() def tasks_db(tasks_db_session): """An empty tasks db.""" tasks.delete_all()</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ ¹æ®<code>tasks_db_session</code>æ›´æ”¹äº†<code>tasks_db_session</code> ï¼Œå¹¶åˆ é™¤äº†æ‰€æœ‰æ¡ç›®ä»¥ç¡®ä¿å…¶ä¸ºç©ºã€‚ ç”±äºæˆ‘ä»¬å°šæœªæ›´æ”¹å…¶åç§°ï¼Œå› æ­¤å·²ç»åŒ…å«å®ƒçš„æ‰€æœ‰å›ºå®šè£…ç½®æˆ–æµ‹è¯•éƒ½ä¸åº”æ›´æ”¹ã€‚ </p><br><p> æ•°æ®å›ºå®šè£…ç½®åªæ˜¯è¿”å›ä¸€ä¸ªå€¼ï¼Œå› æ­¤å®é™…ä¸Šæ²¡æœ‰ç†ç”±è®©å®ƒä»¬ä¸€ç›´å·¥ä½œã€‚ æ¯ä¸ªä¼šè¯ä¸€æ¬¡å°±è¶³å¤Ÿäº†ï¼š </p><br><blockquote>  <strong>ch3 / b / tasks_proj /æµ‹è¯•/conftest.py</strong> </blockquote><br><pre> <code class="plaintext hljs"># Reminder of Task constructor interface # Task(summary=None, owner=None, done=False, id=None) # summary is required # owner and done are optional # id is set by database @pytest.fixture(scope='session') def tasks_just_a_few(): """All summaries and owners are unique.""" return ( Task('Write some code', 'Brian', True), Task("Code review Brian's code", 'Katie', False), Task('Fix what Brian did', 'Michelle', False)) @pytest.fixture(scope='session') def tasks_mult_per_owner(): """Several owners with several tasks each.""" return ( Task('Make a cookie', 'Raphael'), Task('Use an emoji', 'Raphael'), Task('Move to Berlin', 'Raphael'), Task('Create', 'Michelle'), Task('Inspire', 'Michelle'), Task('Encourage', 'Michelle'), Task('Do a handstand', 'Daniel'), Task('Write some books', 'Daniel'), Task('Eat ice cream', 'Daniel'))</code> </pre> <br><p> ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ‰€æœ‰è¿™äº›æ›´æ”¹æ˜¯å¦éƒ½é€‚ç”¨äºæˆ‘ä»¬çš„æµ‹è¯•ï¼š </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/b/tasks_proj $ pytest ===================== test session starts ====================== collected 55 items tests/func/test_add.py ... tests/func/test_add_variety.py ............................ tests/func/test_add_variety2.py ............ tests/func/test_api_exceptions.py ....... tests/func/test_unique_id.py . tests/unit/test_task.py .... ================== 55 passed in 0.17 seconds ===================</code> </pre> <br><p> ä¸€åˆ‡ä¼¼ä¹äº•äº•æœ‰æ¡ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å•ä¸ªæµ‹è¯•æ–‡ä»¶çš„å›ºå®šè£…ç½®ï¼Œä»¥äº†è§£ä¸åŒåŒºåŸŸå¦‚ä½•æ ¹æ®æˆ‘ä»¬çš„æœŸæœ›è¿›è¡Œå·¥ä½œï¼š </p><br><pre> <code class="plaintext hljs">$ pytest --setup-show tests/func/test_add.py ============================= test session starts ============================= platform win32 -- Python 3.6.5, pytest-3.9.3, py-1.7.0, pluggy-0.8.0 rootdir: c:\_BOOKS_\pytest_si\bopytest-code\code\ch3\b\tasks_proj\tests, inifile: pytest.ini collected 3 items tests\func\test_add.py SETUP S tmpdir_factory SETUP S tasks_db_session (fixtures used: tmpdir_factory) SETUP F tasks_db (fixtures used: tasks_db_session) func/test_add.py::test_add_returns_valid_id (fixtures used: tasks_db, tasks_db_session, tmpdir_factory). TEARDOWN F tasks_db SETUP F tasks_db (fixtures used: tasks_db_session) func/test_add.py::test_added_task_has_id_set (fixtures used: tasks_db, tasks_db_session, tmpdir_factory). TEARDOWN F tasks_db SETUP S tasks_just_a_few SETUP F tasks_db (fixtures used: tasks_db_session) SETUP F db_with_3_tasks (fixtures used: tasks_db, tasks_just_a_few) func/test_add.py::test_add_increases_count (fixtures used: db_with_3_tasks, tasks_db, tasks_db_session, tasks_just_a_few, tmpdir_factory). TEARDOWN F db_with_3_tasks TEARDOWN F tasks_db TEARDOWN S tasks_db_session TEARDOWN S tmpdir_factory TEARDOWN S tasks_just_a_few ========================== 3 passed in 0.24 seconds ===========================</code> </pre> <br><p> æ˜¯çš„  . <code>tasks_db_session</code>     ,    <code>task_db</code>        . </p><br><h3 id="specifying-fixtures-with-usefixtures"> Specifying Fixtures with usefixtures </h3><br><p>   ,   ,    ,       .  ,        <code>@pytest.mark.usefixtures('fixture1', 'fixture2')</code> . <em>usefixtures</em>  ,    ,  .          â€”     .       : </p><br><blockquote> <strong>ch3/test_scope.py</strong> </blockquote><br><pre> <code class="plaintext hljs">@pytest.mark.usefixtures('class_scope') class TestSomething(): """Demo class scope fixtures.""" def test_3(self): """Test using a class scope fixture.""" def test_4(self): """Again, multiple tests are more fun."""</code> </pre> <br><p>  <em>usefixtures</em>    ,         .     ,       ,       . ,   -  <em>usefixtures</em> ,      . </p><br><h2 id="ispolzovanie--autouse-dlya-fixtures-that-always-get-used-kotorye-ispolzuyutsya-nepreryvno">  autouse  Fixtures That Always Get Used (  ) </h2><br><p>        ,  ,    (  <em>usefixtures</em>     ).     <em>autouse=True</em> ,    .     ,       ,              .    : </p><br><blockquote> <strong>ch3/test_autouse.py</strong> </blockquote><br><pre> <code class="plaintext hljs">""" autouse fixtures.""" import pytest import time @pytest.fixture(autouse=True, scope='session') def footer_session_scope(): """    session().""" yield now = time.time() print('--') print('finished : {}'.format(time.strftime('%d %b %X', time.localtime(now)))) print('-----------------') @pytest.fixture(autouse=True) def footer_function_scope(): """     .""" start = time.time() yield stop = time.time() delta = stop - start print('\ntest duration : {:0.3} seconds'.format(delta)) def test_1(): """   .""" time.sleep(1) def test_2(): """    .""" time.sleep(1.23)</code> </pre> <br><p>         ,         .     : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3 $ pytest -v -s test_autouse.py ===================== test session starts ====================== collected 2 items test_autouse.py::test_1 PASSED test duration : 1.0 seconds test_autouse.py::test_2 PASSED test duration : 1.24 seconds -- finished : 25 Jul 16:18:27 ----------------- =================== 2 passed in 2.25 seconds ===================</code> </pre> <br><p>  <em>autouse</em>  .    ,  .    ,          . </p><br><p> ,    <em>autouse</em>  ,   ,       <code>tasks_db</code>   .   Tasks  ,     ,  ,      API   .      .      ,     . </p><br><h2 id="pereimenovanie-fixtures">  Fixtures </h2><br><p>  ,        ,  ,      . , <em>pytest</em>       name  <code>@pytest.fixture()</code> : </p><br><blockquote> <strong>ch3/ <code>test_rename_fixture.py</code></strong> </blockquote><br><pre> <code class="plaintext hljs">""" fixture renaming.""" import pytest @pytest.fixture(name='lue') def ultimate_answer_to_life_the_universe_and_everything(): """  .""" return 42 def test_everything(lue): """   .""" assert lue == 42</code> </pre> <br><p>  <em>lue</em>    <code>fixture</code> ,   <code>fixture_with_a_name_much_longer_than_lue</code> .    ,       <code>--setup-show</code> : </p><br><pre> <code class="plaintext hljs">$ pytest --setup-show test_rename_fixture.py ======================== test session starts ======================== collected 1 items test_rename_fixture.py SETUP F lue test_rename_fixture.py::test_everything (fixtures used: lue). TEARDOWN F lue ===================== 1 passed in 0.01 seconds ======================</code> </pre> <br><p>    ,   <em>lue</em> ,    pytest <code>--fixtures</code>       .     ,   ,    ,   : </p><br><pre> <code class="plaintext hljs">$ pytest --fixtures test_rename_fixture.py ======================== test session starts ======================= ... ------------------ fixtures defined from test_rename_fixture ------------------ lue Return ultimate answer. ================= no tests ran in 0.01 seconds =================</code> </pre> <br><p>      â€”   .  , ,   ,  ,   ,   .    ,    <em>lue</em> .      Â«TasksÂ»: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/b/tasks_proj $ pytest --fixtures tests/func/test_add.py ======================== test session starts ======================== ... tmpdir_factory Return a TempdirFactory instance for the test session. tmpdir Return a temporary directory path object which is unique to each test function invocation, created as a sub directory of the base temporary directory. The returned object is a `py.path.local`_ path object. ----------------------- fixtures defined from conftest ------------------------ tasks_db An empty tasks db. tasks_just_a_few All summaries and owners are unique. tasks_mult_per_owner Several owners with several tasks each. db_with_3_tasks Connected db with 3 tasks, all unique. db_with_multi_per_owner Connected db with 9 tasks, 3 owners, all with 3 tasks. tasks_db_session Connect to db before tests, disconnect after. =================== no tests ran in 0.01 seconds ====================</code> </pre> <br><p> !     <em>conftest.py</em> .        <code>tmpdir</code>  <code>tmpdir_factory</code> ,    . </p><br><h2 id="parametrizaciya-fikstur">   </h2><br><p>  [Parametrized Testing] ,  . 42,   .     .  -    ,      ,   : </p><br><blockquote> <code>ch3/b/tasks_proj/tests/func/test_add_variety2.py</code> <br> <br> """Test the tasks.add() API function.""" <br><br> import pytest <br> import tasks <br> from tasks import Task <br><br> tasks_to_try = (Task('sleep', done=True), <br> Task('wake', 'brian'), <br> Task('breathe', 'BRIAN', True), <br> Task('exercise', 'BrIaN', False)) <br><br> task_ids = ['Task({},{},{})'.format(t.summary, t.owner, t.done) <br> for t in tasks_to_try] <br><br> def equivalent(t1, t2): <br> """Check two tasks for equivalence.""" <br> return ((t1.summary == t2.summary) and <br> (t1.owner == t2.owner) and <br> (t1.done == t2.done)) </blockquote><p>  ,   ,      <code>a_task</code> : </p><br><blockquote> <strong>ch3/b/tasks_proj/tests/func/ <code>test_add_variety2.py</code></strong> <br><br> @pytest.fixture(params=tasks_to_try) <br> def a_task(request): <br> """ .""" <br> return request.param <br><br> def test_add_a(tasks_db, a_task): <br> """  a_task ( ids).""" <br> task_id = tasks.add(a_task) <br> t_from_db = tasks.get(task_id) <br> assert equivalent(t_from_db, a_task) </blockquote><p> ,    fixture,    ,    .      .    param,      ,  params  <code>@pytest.fixture(params=tasks_to_try)</code> . </p><br><p>  <code>a_task</code>   â€”    <code>request.param</code>     ,  .        ,     ,       : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/b/tasks_proj/tests/func $ pytest -v test_add_variety2.py::test_add_a ===================== test session starts ====================== collected 4 items test_add_variety2.py::test_add_a[a_task0] PASSED test_add_variety2.py::test_add_a[a_task1] PASSED test_add_variety2.py::test_add_a[a_task2] PASSED test_add_variety2.py::test_add_a[a_task3] PASSED =================== 4 passed in 0.03 seconds ===================</code> </pre> <br><p>    ,  pytest   ,   ()   .        ,       : </p><br><blockquote> <strong>ch3/b/tasks_proj/tests/func/ <code>test_add_variety2.py</code></strong> <br><br> @pytest.fixture(params=tasks_to_try, ids=task_ids) <br> def b_task(request): <br> """  .""" <br> return request.param <br><br> def test_add_b(tasks_db, b_task): <br> """  b_task,  .""" <br> task_id = tasks.add(b_task) <br> t_from_db = tasks.get(task_id) <br> assert equivalent(t_from_db, b_task) </blockquote><p>      : </p><br><pre> <code class="plaintext hljs">$ pytest -v test_add_variety2.py::test_add_b ===================== test session starts ====================== collected 4 items test_add_variety2.py::test_add_b[Task(sleep,None,True)] PASSED test_add_variety2.py::test_add_b[Task(wake,brian,False)] PASSED test_add_variety2.py::test_add_b[Task(breathe,BRIAN,True)] PASSED test_add_variety2.py::test_add_b[Task(exercise,BrIaN,False)] PASSED =================== 4 passed in 0.04 seconds ===================</code> </pre> <br><p>      <code>ids</code>  ,   ,   .    ,       : </p><br><blockquote> <strong>ch3/b/tasks_proj/tests/func/ <code>test_add_variety2.py</code></strong> <br><br> def id_func(fixture_value): <br> """   .""" <br> t = fixture_value <br> return 'Task({},{},{})'.format(t.summary, t.owner, t.done) <br><br> @pytest.fixture(params=tasks_to_try, ids=id_func) <br> def c_task(request): <br> """  (id_func)   .""" <br> return request.param <br><br> def test_add_c(tasks_db, c_task): <br> """    .""" <br> task_id = tasks.add(c_task) <br> t_from_db = tasks.get(task_id) <br> assert equivalent(t_from_db, c_task) </blockquote><p>         .       Task, <code>id_func()</code>     <em>Task</em> ,       <em>namedtuple</em>      <em>Task</em>      <em>Task</em>  .   ,      ,   : </p><br><pre> <code class="plaintext hljs">$ pytest -v test_add_variety2.py::test_add_c ===================== test session starts ====================== collected 4 items test_add_variety2.py::test_add_c[Task(sleep,None,True)] PASSED test_add_variety2.py::test_add_c[Task(wake,brian,False)] PASSED test_add_variety2.py::test_add_c[Task(breathe,BRIAN,True)] PASSED test_add_variety2.py::test_add_c[Task(exercise,BrIaN,False)] PASSED =================== 4 passed in 0.04 seconds ===================</code> </pre> <br><p>          .       ,   ,    .    , ! </p><br><h3 id="parametrizaciya-fixtures-v-tasks-project">  Fixtures  Tasks Project </h3><br><p>   ,         Tasks.      <em>TinyDB</em>   .   ,        .   ,   ,   ,   ,     <em>TinyDB</em> ,    <em>MongoDB</em> . </p><br><p>  ( ),     ,    <code>start_tasks_db()</code>   <code>tasks_db_session</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ch3/b/tasks_proj/tests/conftest.py</a> <br><br> """      .""" <br><br> import pytest <br> import tasks <br> from tasks import Task <br><br> @pytest.fixture(scope='session') <br> def tasks_db_session(tmpdir_factory): <br> """    ,  .""" <br> temp_dir = tmpdir_factory.mktemp('temp') <br> tasks.start_tasks_db(str(temp_dir), 'tiny') <br> yield <br> tasks.stop_tasks_db() <br><br> @pytest.fixture() <br> def tasks_db(tasks_db_session): <br> """   tasks.""" <br> tasks.delete_all() </blockquote><p>  <code>db_type</code>   <code>start_tasks_db()</code>   .      ,        : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>tasks_proj/src/tasks/api.py</strong></a> </blockquote><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_tasks_db</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db_path, db_type)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># type: (str, str) -None """  API  .""" if not isinstance(db_path, string_types): raise TypeError('db_path must be a string') global _tasksdb if db_type == 'tiny': import tasks.tasksdb_tinydb _tasksdb = tasks.tasksdb_tinydb.start_tasks_db(db_path) elif db_type == 'mongo': import tasks.tasksdb_pymongo _tasksdb = tasks.tasksdb_pymongo.start_tasks_db(db_path) else: raise ValueError("db_type   'tiny'  'mongo'")</span></span></code> </pre> <br><p>   MongoDB,       db_type  mongo.  : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>ch3/c/tasks_proj/tests/conftest.py</strong></a> </blockquote><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tasks <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tasks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Task <span class="hljs-comment"><span class="hljs-comment"># @pytest.fixture(scope='session', params=['tiny',]) @pytest.fixture(scope='session', params=['tiny', 'mongo']) def tasks_db_session(tmpdir_factory, request): """Connect to db before tests, disconnect after.""" temp_dir = tmpdir_factory.mktemp('temp') tasks.start_tasks_db(str(temp_dir), request.param) yield # this is where the testing happens tasks.stop_tasks_db() @pytest.fixture() def tasks_db(tasks_db_session): """An empty tasks db.""" tasks.delete_all()</span></span></code> </pre> <br><p>    params=['tiny',' mongo']  -.   <code>request</code>    <em>temp_db</em>   <em>db_type</em>  <code>request.param</code>  ,    "tiny"  "mongo". </p><br><p>   <code>--verbose</code>   <code>-v</code>    pytest     , pytest        .      ,   . </p><br><hr><br><p>  <strong>å®‰è£…MongoDB</strong> </p><br><hr><br><p>    MongoDB, ,   MongoDB  <em>pymongo</em> .       MongoDB,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.mongodb.com/download-center</a> . pymongo   pipâ€” <em>pip install pymongo</em> .   MongoDB       ;           <strong> 7</strong> . </p><br><hr><br><p>     : </p><br><pre> <code class="plaintext hljs"> $ cd /path/to/code/ch3/c/tasks_proj $ pip install pymongo $ pytest -v --tb=no ===================== test session starts ====================== collected 92 items test_add.py::test_add_returns_valid_id[tiny] PASSED test_add.py::test_added_task_has_id_set[tiny] PASSED test_add.py::test_add_increases_count[tiny] PASSED test_add_variety.py::test_add_1[tiny] PASSED test_add_variety.py::test_add_2[tiny-task0] PASSED test_add_variety.py::test_add_2[tiny-task1] PASSED ... test_add.py::test_add_returns_valid_id[mongo] FAILED test_add.py::test_added_task_has_id_set[mongo] FAILED test_add.py::test_add_increases_count[mongo] PASSED test_add_variety.py::test_add_1[mongo] FAILED test_add_variety.py::test_add_2[mongo-task0] FAILED ... ============= 42 failed, 50 passed in 4.94 seconds =============</code> </pre> <br><p> å—¯ . ,     ,     -   Mongo.  ,     pdb:   ,  . 125.        TinyDB. </p><br><h2 id="uprazhneniya"> ç»ƒä¹ é¢˜ </h2><br><ol><li>    <code>test_fixtures.py</code> . <br> 2.  fixturesâ€”functions     <code>@pytest.fixture()</code> ,     . ,   ,  . </li><li>         ,   . </li><li>   ,       . </li><li>  <code>pytest --setup-show test_fixtures.py</code> .      ? </li><li>  <code>scope= 'module'</code>     4. </li><li>   <code>pytest --setup-show test_fixtures.py</code> . æœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ </li><li>     6  <code>return &lt;data&gt;</code>  <code>yield &lt;data&gt;</code> . </li><li>       <code>yield</code> . </li><li>  <code>pytest -s -v test_fixtures.py</code> .    ? </li></ol><br><h2 id="chto-dalshe"> æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆ </h2><br><p>  pytest fixture  ,   ,   <em>building blocks</em> ,    <em>setup</em>  <em>teardown</em> ,        (,  Mongo  TinyDB).    ,      ,         . </p><br><p>       pytest,   ,    (builtin)  tmpdir  tmpdir_factory.        (builtin) . </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿”å›</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸‹ä¸€ä¸ª</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN448786/">https://habr.com/ru/post/zh-CN448786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN448774/index.html">ä½¿ç”¨DBMS_SQLçš„SQLè‡³CSV</a></li>
<li><a href="../zh-CN448776/index.html">RxVMS-é€‚ç”¨äºFlutteråº”ç”¨ç¨‹åºçš„å®ç”¨æ¶æ„</a></li>
<li><a href="../zh-CN448778/index.html">ä¸ºVisual Studio Enterprise 2019å¼•å…¥æ—¶é—´æ—…è¡Œè°ƒè¯•</a></li>
<li><a href="../zh-CN448780/index.html">ä»€ä¹ˆä½¿è½¯ä»¶å¯ä»¥èµšé’±</a></li>
<li><a href="../zh-CN448782/index.html">ä½¿ç”¨pytestè¿›è¡ŒPythonæµ‹è¯•ã€‚ pytestå…¥é—¨ï¼Œç¬¬1ç« </a></li>
<li><a href="../zh-CN448788/index.html">ä½¿ç”¨pytestè¿›è¡ŒPythonæµ‹è¯•ã€‚ ç¬¬2ç« ï¼Œç¼–å†™æµ‹è¯•å‡½æ•°</a></li>
<li><a href="../zh-CN448790/index.html">SpaceVIL-ç”¨äºåœ¨.Net Coreï¼Œ.Net Standardå’ŒJVMä¸Šå¼€å‘çš„è·¨å¹³å°GUIæ¡†æ¶</a></li>
<li><a href="../zh-CN448796/index.html">ä½¿ç”¨pytestè¿›è¡ŒPythonæµ‹è¯•ã€‚ é…ç½®ï¼Œç¬¬6ç« </a></li>
<li><a href="../zh-CN448798/index.html">ä½¿ç”¨pytestè¿›è¡ŒPythonæµ‹è¯•ã€‚ å°†pytestä¸å…¶ä»–å·¥å…·ç»“åˆä½¿ç”¨ï¼Œç¬¬7ç« </a></li>
<li><a href="../zh-CN448800/index.html">ä½¿ç”¨.vsconfigåœ¨æ•´ä¸ªç»„ç»‡ä¸­é…ç½®Visual Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>