<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚û∞ ‚öñÔ∏è üöµüèº √Ä quoi ressemble l'archive zip et ce que nous pouvons en faire. Partie 3 - Application pratique üê¨ ‚ö±Ô∏è üö°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suite de l'article A quoi ressemble l'archive zip et ce que nous pouvons en faire. Partie 2 - Descripteur de donn√©es et compression . 

 Chers lecteur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√Ä quoi ressemble l'archive zip et ce que nous pouvons en faire. Partie 3 - Application pratique</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484520/"> <i>Suite de l'article A <a href="https://habr.com/ru/post/472966/">quoi ressemble l'archive zip et ce que nous pouvons en faire.</a></i>  <i><a href="https://habr.com/ru/post/472966/">Partie 2 - Descripteur de donn√©es et compression</a> .</i> <br><br>  Chers lecteurs, je vous souhaite √† nouveau la bienvenue au transfert de la programmation non conventionnelle en PHP.  Pour comprendre ce qui se passe, je vous recommande de lire les deux articles pr√©c√©dents sur les archives zip: √Ä <a href="https://habr.com/ru/post/471066/">quoi ressemble une archive zip et que pouvons-nous en faire</a> ? √Ä <a href="https://habr.com/ru/post/471066/">quoi ressemble une archive zip</a> <a href="https://habr.com/ru/post/472966/">et que pouvons-nous en faire.</a>  <a href="https://habr.com/ru/post/472966/">Partie 2 - Descripteur de donn√©es et compression</a> <br><br>  Plus t√¥t, j'ai expliqu√© comment cr√©er des archives en utilisant uniquement du code PHP et sans utiliser de biblioth√®ques et d'extensions (y compris le <a href="https://www.php.net/manual/ru/book.zip.php">zip</a> standard), et j'ai √©galement mentionn√© certains sc√©narios d'utilisation.  Aujourd'hui, je vais essayer de donner un exemple de l'un de ces sc√©narios. <br><br>  Nous allons stocker les images dans l'archive sur un serveur distant et, si n√©cessaire, montrer une image sp√©cifique √† l'utilisateur sans t√©l√©charger ou d√©compresser l'archive, mais uniquement recevoir des donn√©es du serveur lui-m√™me, une photo sp√©cifiquement prise et rien de plus (eh bien, personne n'a annul√© la surcharge pour les en-t√™tes mais quand m√™me). <br><a name="habracut"></a><br><h3>  Cuisine </h3><br>  Un de mes projets pour animaux de compagnie a un script simple que j'utilise pour t√©l√©charger un tas de photos et les enregistrer dans les archives.  Le script accepte une liste de liens dans json pour entrer dans STDIN, donne l'archive elle-m√™me √† STDOUT et json avec une structure de tableau dans STDERR (bien s√ªr, c'est un peu exag√©r√© et il n'est pas n√©cessaire de cr√©er une archive en utilisant PHP natif, vous pouvez utiliser des outils plus appropri√©s pour cela, puis juste lire la structure - je vais essayer de mettre en √©vidence ce point √† l'avenir, mais √† ce stade, il me semble, ce sera plus √©vident). <br><br>  Ce script, avec quelques modifications, je cite ci-dessous: <br><br><div class="spoiler">  <b class="spoiler_title">zip.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof(STDIN)) { $buffer .= fread(STDIN, <span class="hljs-number"><span class="hljs-number">4096</span></span>); } $photos = json_decode($buffer, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); $skeleton = [<span class="hljs-string"><span class="hljs-string">'files'</span></span> =&gt; []]; $written = <span class="hljs-number"><span class="hljs-number">0</span></span>; [$written, $skeleton] = writeZip($written, $skeleton, $photos); $CDFH_Offset = $written; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $index =&gt; $info) { $written += fwrite(STDOUT, $info[<span class="hljs-string"><span class="hljs-string">'CDFH'</span></span>]); $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'CDFH'</span></span>] = base64_encode($info[<span class="hljs-string"><span class="hljs-string">'CDFH'</span></span>]); } $skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>] = pack(<span class="hljs-string"><span class="hljs-string">'LSSSSLLS'</span></span>, <span class="hljs-number"><span class="hljs-number">0x06054b50</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $records = count($skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>]), $records, $written - $CDFH_Offset, $CDFH_Offset, <span class="hljs-number"><span class="hljs-number">0</span></span>); $written += fwrite(STDOUT, $skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>]); $skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>] = base64_encode($skeleton[<span class="hljs-string"><span class="hljs-string">'EOCD'</span></span>]); fwrite(STDERR, json_encode($skeleton)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeZip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($written, $skeleton, $files)</span></span></span><span class="hljs-function"> </span></span>{ $c = curl_init(); curl_setopt_array($c, [ CURLOPT_RETURNTRANSFER =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, CURLOPT_TIMEOUT =&gt; <span class="hljs-number"><span class="hljs-number">50</span></span>, CURLOPT_FOLLOWLOCATION =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, ]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($files <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $index =&gt; $url) { $fileName = $index . <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>; $i++ ) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { curl_setopt($c, CURLOPT_URL, $url); [$content, $code, $contentLength] = [ curl_exec($c), (int) curl_getinfo($c, CURLINFO_HTTP_CODE), (int) curl_getinfo($c, CURLINFO_CONTENT_LENGTH_DOWNLOAD) ]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($code !== <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"[{$index}] "</span></span> . <span class="hljs-string"><span class="hljs-string">'Photo download error ('</span></span> . $code . <span class="hljs-string"><span class="hljs-string">'): '</span></span> . curl_error($c)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen($content) !== $contentLength) { var_dump(strlen($content), $contentLength); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"[{$index}] "</span></span> . <span class="hljs-string"><span class="hljs-string">'Different content-length'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> === $imageSize = @getimagesizefromstring($content)) || $imageSize[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || $imageSize[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"[{$index}] "</span></span> . <span class="hljs-string"><span class="hljs-string">'Broken image'</span></span>); } [$width, $height] = $imageSize; $t = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\Throwable $t) {} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($t !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Error: '</span></span> . $index . <span class="hljs-string"><span class="hljs-string">' &gt; '</span></span> . $url, <span class="hljs-number"><span class="hljs-number">0</span></span>, $t); } $fileInfo = [ <span class="hljs-string"><span class="hljs-string">'versionToExtract'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'generalPurposeBitFlag'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'compressionMethod'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationTime'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">28021</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationDate'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">20072</span></span>, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; hexdec(hash(<span class="hljs-string"><span class="hljs-string">'crc32b'</span></span>, $content)), <span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span> =&gt; $size = strlen($content), <span class="hljs-string"><span class="hljs-string">'uncompressedSize'</span></span> =&gt; $size, <span class="hljs-string"><span class="hljs-string">'filenameLength'</span></span> =&gt; strlen($fileName), <span class="hljs-string"><span class="hljs-string">'extraFieldLength'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, ]; $LFH_Offset = $written; $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index] = [ <span class="hljs-string"><span class="hljs-string">'LFH'</span></span> =&gt; pack(<span class="hljs-string"><span class="hljs-string">'LSSSSSLLLSSa*'</span></span>, <span class="hljs-number"><span class="hljs-number">0x04034b50</span></span>, ...array_values($fileInfo + [<span class="hljs-string"><span class="hljs-string">'filename'</span></span> =&gt; $fileName])), <span class="hljs-string"><span class="hljs-string">'CDFH'</span></span> =&gt; pack(<span class="hljs-string"><span class="hljs-string">'LSSSSSSLLLSSSSSLLa*'</span></span>, <span class="hljs-number"><span class="hljs-number">0x02014b50</span></span>, <span class="hljs-number"><span class="hljs-number">798</span></span>, ...array_values($fileInfo + [ <span class="hljs-string"><span class="hljs-string">'fileCommentLength'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'diskNumber'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'internalFileAttributes'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'externalFileAttributes'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2176057344</span></span>, <span class="hljs-string"><span class="hljs-string">'localFileHeaderOffset'</span></span> =&gt; $LFH_Offset, <span class="hljs-string"><span class="hljs-string">'filename'</span></span> =&gt; $fileName, ])), <span class="hljs-string"><span class="hljs-string">'width'</span></span> =&gt; $width, <span class="hljs-string"><span class="hljs-string">'height'</span></span> =&gt; $height, ]; $written += fwrite(STDOUT, $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'LFH'</span></span>]); $written += fwrite(STDOUT, $content); $skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'LFH'</span></span>] = base64_encode($skeleton[<span class="hljs-string"><span class="hljs-string">'files'</span></span>][$index][<span class="hljs-string"><span class="hljs-string">'LFH'</span></span>]); } curl_close($c); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [$written, $skeleton]; }</code> </pre> </div></div><br>  Enregistrons-le quelque part, appelons zip.php et essayons de l'ex√©cuter. <br><br>  J'ai d√©j√† une liste de liens pr√™te √† l'emploi, je recommande de l'utiliser, car il y a des images d'environ ~ 18 Mo, et nous avons besoin que la taille totale de l'archive ne d√©passe pas 20 Mo (un peu plus tard, je dirai pourquoi) - <a href="">https://gist.githubusercontent.com /userqq/d0ca3aba6b6762c9ce5bc3ace92a9f9e/raw/70f446eb98f1ba6838ad3c19c3346cba371fd263/photos.json</a> <br><br>  Nous allons courir comme ceci: <br><br><pre> <code class="bash hljs">$ curl -s \ https://gist.githubusercontent.com/userqq/d0ca3aba6b6762c9ce5bc3ace92a9f9e/raw/70f446eb98f1ba6838ad3c19c3346cba371fd263/photos.json \ | php zip.php \ 2&gt; structure.json \ 1&gt; photos.zip</code> </pre> <br>  Lorsque le script a termin√© son travail, √† la sortie, nous devrions obtenir deux fichiers - <i>photos.zip</i> , je recommande de le v√©rifier avec la commande: <br><br><pre> <code class="bash hljs">$ unzip -tq photos.zip</code> </pre> <br>  et <i>structure.json</i> , dans lequel nous stockons json avec base64 de tout ce qui est dans nos archives, √† l'exception des donn√©es elles-m√™mes - toutes les structures LFH et CDFH, ainsi que EOCD.  Je ne vois pas encore d‚Äôapplication pratique d‚ÄôEOCD s√©par√©ment de l‚Äôarchive, mais la position du d√©calage LFH par rapport au d√©but du fichier et la longueur des donn√©es sont indiqu√©es dans CDFH.  Ainsi, connaissant la longueur de la LFH, nous pouvons certainement savoir √† partir de quelle position les donn√©es commenceront et o√π elles se termineront. <br><br>  Maintenant, nous devons t√©l√©charger notre fichier sur un serveur distant. <br><br>  Par exemple, j'utiliserai le bot de t√©l√©gramme - c'est le plus simple, c'est pourquoi il √©tait si important de tenir dans la limite de 20 Mo. <br><br>  Enregistrez le bot avec @BotFather, si vous n'en avez pas d√©j√† un, √©crivez quelque chose de bienvenu √† votre bot, recherchez votre message dans <a href="https://api.telegram.org/bot%257B%257BTOKEN%257D%257D/getUpdates">https://api.telegram.org/bot{{TOTOK‚ñ∫‚ñ∫/getUpdates</a> , d'o√π nous isolons la propri√©t√© message.from .id = c'est l'identifiant de votre bot de chat. <br><br>  Remplissez nos archives avec vous, obtenues √† l'√©tape pr√©c√©dente: <br><br><pre> <code class="bash hljs">$ curl -F document=@<span class="hljs-string"><span class="hljs-string">"photos.zip"</span></span> <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot{{TOKEN}}/sendDocument?chat_id={{CHAT ID}}"</span></span> &gt; stored.json</code> </pre> <br>  Maintenant, nous avons d√©j√† deux fichiers json - <i>structure.json</i> et <i>stored.json</i> . <br><br>  Et si tout s'est bien pass√©, le fichier stored.json contiendra json avec des champs ok √©gaux √† true, ainsi que result.document.file_id, dont nous avons besoin. <br><br><h3>  Prototype </h3><br>  Maintenant que tout est enfin pr√™t, passons aux choses s√©rieuses: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> define(<span class="hljs-string"><span class="hljs-string">'TOKEN'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    $structure = json_decode(file_get_contents('structure.json'), true, 512, JSON_THROW_ON_ERROR); $stored = json_decode(file_get_contents('stored.json'), true, 512, JSON_THROW_ON_ERROR); $selectedFile = $structure['files'][array_rand($structure['files'])]; $LFH = base64_decode($selectedFile['LFH']); $CDFH = base64_decode($selectedFile['CDFH']); $fileLength = unpack('Llen', substr($CDFH, 24, 4))['len']; $fileStart = unpack('Lpos', substr($CDFH, 42, 4))['pos'] + strlen($LFH); $fileEnd = $fileStart + $fileLength; $response = json_decode(file_get_contents('https://api.telegram.org/bot' . TOKEN . '/getFile?' . http_build_query([ 'file_id' =&gt; $stored['result']['document']['file_id'] ])), true, 512, JSON_THROW_ON_ERROR); header('Content-Type: image/jpeg'); readfile('https://api.telegram.org/file/bot' . TOKEN . '/' . $response['result']['file_path'], false, stream_context_create([ 'http' =&gt; ['header' =&gt; "Range: bytes={$fileStart}-{$fileEnd}"] ]));</span></span></code> </pre><br>  Dans ce script, nous s√©lectionnons un fichier al√©atoire dans la liste que nous avons dans l'archive, trouvons la position du d√©but de LFH, y ajoutons la longueur de LFH et obtenons ainsi la position du d√©but des donn√©es d'un fichier particulier dans l'archive. <br><br>  En ajoutant la longueur du fichier √† cela, nous obtenons la position de la fin des donn√©es. <br><br>  Il reste √† obtenir l'adresse du fichier lui-m√™me (c'est dans un cas particulier avec un t√©l√©gramme) puis √† faire une requ√™te avec l'en-t√™te <code>Range: bytes=&lt;-&gt;-&lt;-&gt;</code> <br><br>  (en supposant que le serveur prend en charge les demandes de plage) <br><br>  Par cons√©quent, lors de l'acc√®s au script sp√©cifi√©, nous verrons le contenu d'une image al√©atoire de nos archives. <br><br><h3>  Non, eh bien, ce n'est pas grave ... </h3><br>  Il va sans dire que la demande de <i>getFile</i> doit √™tre mise en cache, car les t√©l√©grammes garantissent que le lien durera au moins une heure.  En g√©n√©ral, cet exemple n'est bon √† rien que pour montrer qu'il fonctionne. <br><br>  Essayons un peu plus - ex√©cutez le tout sur amphp.  Apr√®s tout, les gens distribuent des statiques en production sur node.js, mais qu'est-ce qui nous emp√™che (enfin, √† part le bon sens, bien s√ªr)?  Nous avons aussi l'asynchronie, vous savez. <br><br>  Nous aurons besoin de 3 packages: <br><br><ul><li>  <b>amphp / http-server</b> - √©videmment, le serveur vers lequel nous distribuerons les fichiers </li><li>  <b>amphp / artax</b> - client http avec lequel nous allons extraire les donn√©es, ainsi que mettre √† jour un lien direct vers le fichier dans le cache. </li><li>  <b>amphp / parallel</b> est une biblioth√®que pour le multithreading et tout √ßa.  Mais n'ayez pas peur, nous n'avons besoin que de SharedMemoryParcel, qui nous servira de cache im-memory. </li></ul><br>  Nous mettons les d√©pendances n√©cessaires: <br><br><pre> <code class="bash hljs">$ composer require amphp/http-server amphp/artax amphp/parallel</code> </pre> <br>  Et √©cris ceci <br><br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> define(<span class="hljs-string"><span class="hljs-string">'TOKEN'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    use Amp\Artax\DefaultClient; use Amp\Artax\Request as ArtaxRequest; use Amp\Http\Server\RequestHandler\CallableRequestHandler; use Amp\Http\Server\Server as HttpServer; use Amp\Http\Server\Request; use Amp\Http\Server\Response; use Amp\Http\Status; use Amp\Parallel\Sync\SharedMemoryParcel; use Amp\Socket; use Psr\Log\NullLogger; require 'vendor/autoload.php'; Amp\Loop::run(function () { $structure = json_decode(file_get_contents('structure.json'), true, 512, JSON_THROW_ON_ERROR); $stored = json_decode(file_get_contents('stored.json'), true, 512, JSON_THROW_ON_ERROR); $parcel = SharedMemoryParcel::create($id = bin2hex(random_bytes(10)), []); $client = new DefaultClient(); $handler = function (Request $request) use ($parcel, $client, $structure, $stored) { $cached = yield $parcel-&gt;synchronized(function (array $value) use ($client, $stored) { if (!isset($value['file_path']) || $value['expires'] &lt;= time()) { $response = yield $client-&gt;request('https://api.telegram.org/bot' . TOKEN . '/getFile?' . http_build_query([ 'file_id' =&gt; $stored['result']['document']['file_id'] ])); $json = json_decode(yield $response-&gt;getBody(), true, 512, JSON_THROW_ON_ERROR); $value = ['file_path' =&gt; $json['result']['file_path'], 'expires' =&gt; time() + 55 * 60]; } return $value; }); $selectedFile = $structure['files'][array_rand($structure['files'])]; $LFH = base64_decode($selectedFile['LFH']); $CDFH = base64_decode($selectedFile['CDFH']); $fileLength = unpack('Llen', substr($CDFH, 24, 4))['len']; $fileStart = unpack('Lpos', substr($CDFH, 42, 4))['pos'] + strlen($LFH); $fileEnd = $fileStart + $fileLength; $request = (new ArtaxRequest('https://api.telegram.org/file/bot' . TOKEN . '/' . $cached['file_path'])) -&gt;withHeader('Range', "bytes={$fileStart}-{$fileEnd}"); $response = yield $client-&gt;request($request); if (!in_array($response-&gt;getStatus(), [200, 206])) { return new Response(Status::SERVICE_UNAVAILABLE, ['content-type' =&gt; 'text/plain'], "Service Unavailable."); } return new Response(Status::OK, ['content-type' =&gt; 'image/jpeg'], $response-&gt;getBody()); }; $server = new HttpServer([Socket\listen("0.0.0.0:10051")], new CallableRequestHandler($handler), new NullLogger); yield $server-&gt;start(); Amp\Loop::onSignal(SIGINT, function (string $watcherId) use ($server) { Amp\Loop::cancel($watcherId); yield $server-&gt;stop(); }); });</span></span></code> </pre></div></div><br>  R√©sultat: nous avons maintenant un cache o√π nous enregistrons un lien vers un document pendant 55 minutes, ce qui garantit √©galement que nous ne demanderons pas un lien plusieurs fois de suite si nous recevons beaucoup de demandes au moment o√π le cache expire.  Eh bien, tout cela est clairement plus facile que le fichier de lecture avec PHP-FPM (ou, Dieu nous en pr√©serve, PHP-CGI). <br><br>  De plus, vous pouvez augmenter le pool d'instances amphp - SharedMemoryParcel, par son nom, indique que notre cache va t√¢tonner entre les processus / threads.  Eh bien, ou, si vous avez encore de <a href="https://habr.com/ru/post/460685/">s√©rieuses</a> pr√©occupations concernant la fiabilit√© de cette conception, alors <a href="https://habr.com/ru/post/460685/">proxy_pass et nginx</a> . <br><br>  En g√©n√©ral, l'id√©e est loin d'√™tre nouvelle et m√™me dans les ann√©es barbus, DownloadMaster vous a permis de t√©l√©charger un fichier sp√©cifique √† partir de l'archive Zip sans t√©l√©charger l'archive enti√®re, il n'est donc pas n√©cessaire de stocker la structure s√©par√©ment, mais il enregistre quelques demandes.  Et si, par exemple, nous voulons proxy le fichier √† l'utilisateur √† la vol√©e, cela affecte √† peu pr√®s la vitesse de la demande. <br><br>  Pourquoi cela pourrait-il √™tre utile?  Pour enregistrer l'inode, par exemple, lorsque vous avez des dizaines de millions de petits fichiers et que vous ne souhaitez pas les stocker directement dans la base de donn√©es, vous pouvez les stocker dans des archives, connaissant le d√©calage pour recevoir un seul fichier. <br><br>  Ou si vous stockez des fichiers √† distance.  Dans un t√©l√©gramme de 20 Mo, bien s√ªr, vous ne pouvez pas vous d√©placer, mais qui sait, il existe d'autres options. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484520/">https://habr.com/ru/post/fr484520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484504/index.html">Fabriquer un ioniseur d'air pour moins de 10 $</a></li>
<li><a href="../fr484506/index.html">Je suis photographe et je vais me faire un outil de travail</a></li>
<li><a href="../fr484512/index.html">TOP 25 des plus grandes ICO: qu'en est-il maintenant?</a></li>
<li><a href="../fr484514/index.html">Routage universel pour les applications React</a></li>
<li><a href="../fr484518/index.html">Nous obtenons la vid√©o de la cam√©ra via DVRIP en utilisant PHP</a></li>
<li><a href="../fr484522/index.html">Conf√©rence DEFCON 27. Pirater la police. 2e partie</a></li>
<li><a href="../fr484526/index.html">Pr√©paration d'un projet SDL2 pour s'ex√©cuter sur Android</a></li>
<li><a href="../fr484528/index.html">Comment j'ai transf√©r√© mon projet de passe-temps sur K8s</a></li>
<li><a href="../fr484530/index.html">Machine CNC pour le traitement plasma / modification de mat√©riaux polym√®res</a></li>
<li><a href="../fr484532/index.html">√Ä propos de la signification g√©om√©trique des codes Gray</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>