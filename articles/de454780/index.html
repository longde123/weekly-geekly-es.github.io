<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëç üîô üòõ Was wir √ºber Microservices wissen üßîüèª üë®üèø üë©üèΩ‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! Mein Name ist Vadim Madison, ich leite die Entwicklung der Systemplattform Avito. Wie wir im Unternehmen von der monolithischen Architektur zur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Was wir √ºber Microservices wissen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/454780/"><p>  Hallo!  Mein Name ist Vadim Madison, ich leite die Entwicklung der Systemplattform Avito.  Wie wir im Unternehmen von der monolithischen Architektur zur Microservice-Architektur √ºbergehen, wurde mehr als einmal gesagt.  Es ist Zeit zu teilen, wie wir unsere Infrastruktur ver√§ndert haben, um das Beste aus Microservices herauszuholen und uns nicht in ihnen zu verlieren.  Wie PaaS uns hier hilft, wie wir die Bereitstellung vereinfacht und die Erstellung eines Microservices auf einen Klick reduziert haben - lesen Sie weiter.  Nicht alles, was ich unten schreibe, ist vollst√§ndig in Avito implementiert. Ein Teil davon ist, wie wir unsere Plattform entwickeln. </p><br><p>  (Und am Ende dieses Artikels werde ich √ºber die M√∂glichkeit sprechen, ein dreit√§giges Seminar von einem Experten f√ºr Mikroservice-Architektur, Chris Richardson, zu besuchen.) </p><br><p><img src="https://habrastorage.org/webt/9e/m3/xm/9em3xmzspjfadie85f_elruwij4.png"></p><a name="habracut"></a><br><h1 id="kak-my-prishli-k-mikroservisam">  Wie wir zu Microservices kamen </h1><br><p>  Avito ist eine der gr√∂√üten Kleinanzeigen der Welt und ver√∂ffentlicht t√§glich mehr als 15 Millionen neue Anzeigen.  Unser Backend akzeptiert mehr als 20.000 Anfragen pro Sekunde.  Jetzt haben wir mehrere hundert Microservices. </p><br><p>  Wir bauen seit mehreren Jahren eine Microservice-Architektur.  Wie genau - unsere Kollegen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sprachen</a> ausf√ºhrlich in unserem Abschnitt √ºber RIT ++ 2017. Auf dem CodeFest 2017 (siehe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Video</a> ) erkl√§rten Sergey Orlov und Mikhail Prokopchuk ausf√ºhrlich, warum wir den √úbergang zu Microservices brauchten und welche Rolle Kubernetes hier spielte.  Nun tun wir alles, um die Skalierungskosten zu minimieren, die einer solchen Architektur inh√§rent sind. </p><br><p>  Anfangs haben wir kein √ñkosystem geschaffen, das uns bei der Entwicklung und Einf√ºhrung von Mikrodiensten umfassend helfen w√ºrde.  Sie sammelten einfach sinnvolle Open-Source-L√∂sungen, starteten sie zu Hause und schlugen dem Entwickler vor, sich mit ihnen zu befassen.  Infolgedessen ging er zu einem Dutzend Orten (Dashboards, interne Dienste), wonach er st√§rker in dem Wunsch wurde, den Code auf die alte Art und Weise in einem Monolithen zu schneiden.  Die gr√ºne Farbe in den folgenden Diagrammen zeigt an, was der Entwickler auf die eine oder andere Weise mit seinen eigenen H√§nden tut, die gelbe Farbe zeigt die Automatisierung an. </p><br><p><img src="https://habrastorage.org/webt/2a/h8/br/2ah8breno6ypqrbgo7uwi4g_ymw.png"></p><br><p>  Jetzt erstellt ein Team im PaaS CLI-Dienstprogramm einen neuen Dienst, und zwei weitere f√ºgen eine neue Datenbank hinzu und stellen sie f√ºr Stage bereit. </p><br><p><img src="https://habrastorage.org/webt/ku/wf/ek/kuwfekxz9r75rl_hobbjp-rd82i.png"></p><br><h1 id="kak-preodolet-epohu-mikroservisnoy-razdroblennosti">  Wie man die √Ñra der "Microservice-Fragmentierung" √ºberwindet </h1><br><p> Bei einer monolithischen Architektur mussten Entwickler aus Gr√ºnden der Konsistenz der Produkt√§nderungen herausfinden, was mit ihren Nachbarn geschah.  Bei der Arbeit an der neuen Architektur h√§ngen Servicekontexte nicht mehr voneinander ab. </p><br><p>  Dar√ºber hinaus m√ºssen viele Prozesse eingerichtet werden, damit die Microservice-Architektur effektiv ist, n√§mlich: </p><br><p>  ‚Ä¢ Protokollierung; <br>  ‚Ä¢ Abfrageverfolgung (Jaeger); <br>  ‚Ä¢ Fehleraggregation (Sentry); <br>  ‚Ä¢ Status, Nachrichten, Ereignisse von Kubernetes (Event Stream Processing); <br>  ‚Ä¢ Race Limit / Leistungsschalter (Sie k√∂nnen Hystrix verwenden); <br>  ‚Ä¢ Kontrolle der Servicekonnektivit√§t (wir verwenden Netramesh); <br>  ‚Ä¢ √úberwachung (Grafana); <br>  ‚Ä¢ Montage (TeamCity); <br>  ‚Ä¢ Kommunikation und Benachrichtigung (Slack, E-Mail); <br>  ‚Ä¢ Aufgabenverfolgung;  (Jira) <br>  ‚Ä¢ Zusammenstellung von Dokumentationen. </p><br><p>  Damit das System skaliert, seine Integrit√§t nicht verliert und effektiv bleibt, haben wir die Organisation der Arbeit von Microservices in Avito √ºberdacht. </p><br><h1 id="kak-my-upravlyaemsya-s-mikroservisami">  Wie wir mit Microservices umgehen </h1><br><p>  Die Durchf√ºhrung einer einheitlichen ‚ÄûParteipolitik‚Äú unter den vielen Mikrodiensten, die Avito anbietet, hilft: </p><br><ul><li>  Aufteilung der Infrastruktur in Schichten; </li><li>  Platform as a Service (PaaS) -Konzept; </li><li>  √úberwachung von allem, was mit Microservices passiert. </li></ul><br><p>  Infrastrukturabstraktionsschichten umfassen drei Schichten.  Gehen wir von oben nach unten. </p><br><p>  <strong>A. Oberes Netz.</strong>  Zuerst haben wir Istio ausprobiert, aber es stellte sich heraus, dass es zu viele Ressourcen verbraucht, was f√ºr unsere Volumes zu teuer ist.  Aus diesem Grund hat der leitende Ingenieur des Architekturteams Alexander Lukyanchenko seine eigene L√∂sung entwickelt - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Netramesh</a> (verf√ºgbar auf Open Source), die wir jetzt in der Produktion verwenden und die um ein Vielfaches weniger Ressourcen verbraucht als Istio (aber nicht alles tut, was Istio vorweisen kann). <br>  <strong>B. Medium - Kubernetes.</strong>  Darauf setzen wir Microservices ein und betreiben sie. <br>  <strong>C. Unteres blankes Metall.</strong>  Wir verwenden keine Wolken und Dinge wie OpenStack, sondern sitzen komplett auf Bare Metal. </p><br><p>  Alle Schichten werden von PaaS kombiniert.  Und diese Plattform besteht wiederum aus drei Teilen. </p><br><p>  <strong>I. Generatoren,</strong> die √ºber das CLI-Dienstprogramm gesteuert werden.  Sie hilft dem Entwickler, einen Microservice auf die richtige Art und Weise und mit minimalem Aufwand zu erstellen. </p><br><p>  <strong>II.</strong>  <strong>Kombinierter Kollektor</strong> mit Steuerung aller Werkzeuge √ºber ein gemeinsames Dashboard. </p><br><p>  <strong>III.</strong>  <strong>Repository</strong> .  Es st√∂rt Planer, die automatisch Ausl√∂ser f√ºr wichtige Aktionen setzen.  Dank eines solchen Systems wird keine einzige Aufgabe √ºbersehen, nur weil jemand vergessen hat, eine Aufgabe in Jira zu stellen.  Wir verwenden hierf√ºr ein internes Tool namens Atlas. </p><br><p><img src="https://habrastorage.org/webt/xq/if/9g/xqif9gz-91gsn2qzo6up78dgqts.png"></p><br><p>  Die Implementierung von Microservices in Avito erfolgt ebenfalls nach einem einzigen Schema, das die Kontrolle √ºber diese Services in jeder Phase der Entwicklung und Ver√∂ffentlichung vereinfacht. </p><br><h1 id="kak-ustroen-standartnyy-konveyer-razrabotki-mikroservisa">  Funktionsweise der Standard-Microservice-Entwicklungspipeline </h1><br><p>  Im Allgemeinen lautet die Erstellungskette f√ºr Mikroservices wie folgt: </p><br><p>  <em>CLI-Push ‚Üí Kontinuierliche Integration ‚Üí Backen ‚Üí Bereitstellen ‚Üí K√ºnstliche Tests ‚Üí Kanarische Tests ‚Üí Quetschtests ‚Üí Produktion ‚Üí Service.</em> </p><br><p>  Wir gehen es genau in dieser Reihenfolge durch. </p><br><h2 id="cli-push">  CLI-Push </h2><br><p>  <strong>‚Ä¢ Erstellen eines Microservices</strong> . <br>  Wir hatten lange M√ºhe, jedem Entwickler beizubringen, wie man Microservices herstellt.  Einschlie√ülich in Confluence geschriebene detaillierte Anweisungen.  Aber die Regelungen haben sich ge√§ndert und erg√§nzt.  Fazit - ein Engpass, der sich zu Beginn der Reise gebildet hat: Das Starten von Microservices dauerte viel l√§nger als zul√§ssig, und dennoch traten bei der Erstellung h√§ufig Probleme auf. </p><br><p>  Am Ende haben wir ein einfaches CLI-Dienstprogramm erstellt, das die grundlegenden Schritte beim Erstellen eines Microservices automatisiert.  Tats√§chlich ersetzt es den ersten Git-Push.  Das macht sie. </p><br><p>  - Erstellt einen Dienst gem√§√ü der Vorlage - Schritt f√ºr Schritt im "Assistenten" -Modus.  Wir haben Vorlagen f√ºr die wichtigsten Programmiersprachen im Avito-Backend: PHP, Golang und Python. </p><br><p>  - Mit einem Befehl wird die Umgebung f√ºr die lokale Entwicklung auf einem bestimmten Computer bereitgestellt. - Minikube steigt, Helm-Diagramme werden automatisch generiert und in lokalen Kubernetzen gestartet. </p><br><p>  - Verbindet die gew√ºnschte Datenbank.  Der Entwickler muss die IP-Adresse, das Login und das Passwort nicht kennen, um auf die von ihm ben√∂tigte Datenbank zugreifen zu k√∂nnen - zumindest lokal, zumindest in Stage, zumindest in der Produktion.  Dar√ºber hinaus wird die Datenbank sofort in einer fehlertoleranten Konfiguration und mit Ausgleich bereitgestellt. </p><br><p>  - Es selbst f√ºhrt eine Live-Montage durch.  Angenommen, ein Entwickler hat √ºber seine IDE etwas in einem Microservice behoben.  Das Dienstprogramm erkennt die √Ñnderungen im Dateisystem und setzt darauf basierend die Anwendung (f√ºr Golang) wieder zusammen und startet neu.  F√ºr PHP leiten wir einfach das Verzeichnis innerhalb des Cubes weiter und dort wird das Live-Reload "automatisch" erhalten. </p><br><p>  - Erzeugt Autotests.  In Form von Scheiben, aber durchaus einsatzbereit. </p><br><p>  <strong>‚Ä¢ Stellen Sie den Microservice bereit</strong> . </p><br><p>  Es war ein bisschen trostlos, vorher einen Microservice bereitzustellen.  Obligatorisch erforderlich: </p><br><p>  I. Dockerfile. </p><br><p>  II.  Konfig. <br>  III.  Eine Helmkarte, die selbst sperrig ist und Folgendes enth√§lt: </p><br><p>  - die Diagramme selbst; <br>  - Vorlagen; <br>  - spezifische Werte unter Ber√ºcksichtigung unterschiedlicher Umgebungen. </p><br><p>  Wir haben den Schmerz beseitigt, Kubernetes-Manifeste zu wiederholen, und jetzt werden sie automatisch generiert.  Vor allem aber vereinfachten sie die Bereitstellung bis an die Grenzen.  Von nun an haben wir eine Docker-Datei und der Entwickler schreibt die gesamte Konfiguration in eine einzige kurze app.toml-Datei. </p><br><p><img src="https://habrastorage.org/webt/o6/fd/g-/o6fdg-lpen5l_8evpr1j0rsltbe.png"></p><br><p>  Ja, und in der App.toml selbst geht es jetzt um eine Minute.  Wir schreiben auf, wo wie viele Kopien des Dienstes (auf dem Dev-Server, beim Staging, bei der Produktion) ausgel√∂st werden sollen, und geben seine Abh√§ngigkeiten an.  Beachten Sie die Zeilengr√∂√üe = "klein" im Block [engine].  Dies ist das Limit, das dem Dienst √ºber Kubernetes zugewiesen wird. </p><br><p>  Weiterhin werden anhand der Konfiguration automatisch alle notwendigen Helm-Charts generiert und Verbindungen zu den Datenbanken hergestellt. </p><br><p>  <strong>‚Ä¢ Grundlegende Validierung.</strong>  Solche √úberpr√ºfungen werden ebenfalls automatisiert. <br>  <strong>M√ºssen verfolgen:</strong> <br>  - Gibt es eine Docker-Datei? <br>  - gibt es app.toml; <br>  - ob es Unterlagen gibt; <br>  - ob die Abh√§ngigkeiten in Ordnung sind; <br>  - sind die Regeln f√ºr Warnungen festgelegt. <br>  Zum letzten Punkt: Der Servicebesitzer gibt selbst an, welche Produktmetriken √ºberwacht werden sollen. </p><br><p>  <strong>‚Ä¢ Vorbereitung der Dokumentation.</strong> <br>  Immer noch ein Problemort.  Es scheint das offensichtlichste, aber gleichzeitig ein rekordverd√§chtiges ‚Äûoft vergessenes‚Äú und damit verletzliches Glied in der Kette zu sein. <br>  Es ist erforderlich, dass sich die Dokumentation unter jedem Microservice befindet.  Die folgenden Bl√∂cke sind darin enthalten. </p><br><p>  <strong>I. Kurze Beschreibung des Dienstes</strong> .  Nur ein paar S√§tze dar√ºber, was er tut und wof√ºr er gebraucht wird. </p><br><p>  <strong>II.</strong>  <strong>Link zum Architekturdiagramm</strong> .  Es ist wichtig, dass ein kurzer Blick darauf leicht verst√§ndlich macht, ob Sie Redis zum Zwischenspeichern oder als Hauptdatenspeicher im permanenten Modus verwenden.  In Avito ist dies bisher eine Verbindung zu Confluence. </p><br><p>  <strong>III.</strong>  <strong>Runbook</strong> .  Eine kurze Anleitung zum Starten des Dienstes und die Feinheiten bei der Handhabung. </p><br><p>  <strong>IV.</strong>  <strong>FAQ</strong> , wo es gut ist, die Probleme zu antizipieren, auf die Ihre Kollegen bei der Arbeit mit dem Service sto√üen k√∂nnen. </p><br><p>  <strong>V. Beschreibung der Endpunkte f√ºr die API</strong> .  Wenn Sie Ihr Ziel pl√∂tzlich nicht mehr angegeben haben, werden Sie mit ziemlicher Sicherheit von Kollegen bezahlt, deren Microservices mit Ihrem verwandt sind.  Jetzt verwenden wir Swagger daf√ºr und unsere L√∂sung hei√üt kurz. </p><br><p>  <strong>VI.</strong>  <strong>Etiketten</strong>  Oder Markierungen, die anzeigen, zu welchem ‚Äã‚ÄãProdukt, welcher Funktionalit√§t und welcher Struktureinheit des Unternehmens die Dienstleistung geh√∂rt.  Sie helfen beispielsweise dabei, schnell zu verstehen, ob Sie nicht die Funktionen sehen, die Ihre Kollegen vor einer Woche f√ºr denselben Gesch√§ftsbereich eingef√ºhrt haben. </p><br><p>  <strong>VII.</strong>  <strong>Der Eigent√ºmer oder die Eigent√ºmer des Dienstes</strong> .  In den meisten F√§llen kann es - oder sie - automatisch mithilfe von PaaS ermittelt werden. F√ºr Versicherungen muss der Entwickler sie jedoch manuell angeben. </p><br><p>  Schlie√ülich empfiehlt es sich, die Dokumentation zu √ºberpr√ºfen, √§hnlich wie bei der Code√ºberpr√ºfung. </p><br><h2 id="continuous-integration">  Kontinuierliche Integration </h2><br><ul><li>  <strong>Repositorys vorbereiten.</strong> </li><li>  <strong>Erstellen einer Pipeline in TeamCity.</strong> </li><li>  <strong>Rechte einstellen.</strong> </li><li>  <strong>Suche nach Service-Eigent√ºmern.</strong>  Es gibt ein Hybridschema - manuelle Kennzeichnung und minimale Automatisierung von PaaS.  Ein vollautomatisches Schema kann keine Dienste zur Unterst√ºtzung an ein anderes Entwicklungsteam √ºbertragen oder beispielsweise, wenn ein Dienstentwickler beendet wird. </li><li>  <strong>Serviceregistrierung in Atlas</strong> (siehe oben).  Mit all seinen Besitzern und Abh√§ngigkeiten. </li><li>  <strong>√úberpr√ºfen Sie die Migrationen.</strong>  Wir pr√ºfen, ob sich unter ihnen potenziell gef√§hrliche befinden.  In einer von ihnen wird beispielsweise eine √Ñnderungstabelle oder etwas anderes angezeigt, das die Kompatibilit√§t des Datenschemas zwischen verschiedenen Versionen des Dienstes beeintr√§chtigen kann.  Dann wird die Migration nicht durchgef√ºhrt, sondern ein Abonnement abgeschlossen. PaaS sollte dem Eigent√ºmer des Dienstes signalisieren, wann die Verwendung sicher wird. </li></ul><br><h2 id="bake">  Backen </h2><br><p>  Die n√§chste Stufe ist das Packen von Diensten vor der Bereitstellung. </p><br><ul><li>  <strong>Erstellen Sie die Anwendung.</strong>  Nach den Klassikern - im Docker-Bild. </li><li>  <strong>Generierung von Helmdiagrammen f√ºr den Service selbst und zugeh√∂rige Ressourcen.</strong>  Einschlie√ülich f√ºr Datenbanken und Cache.  Sie werden automatisch gem√§√ü der app.toml-Konfiguration erstellt, die in der CLI-Push-Phase generiert wurde. </li><li>  <strong>Erstellen von Tickets f√ºr Administratoren zum √ñffnen von Ports</strong> (falls erforderlich). </li><li>  <strong>Unit-Testlauf und Berechnung der Codeabdeckung</strong> .  Wenn die Codeabdeckung unter einem bestimmten Schwellenwert liegt, schl√§gt der Dienst h√∂chstwahrscheinlich weiter fehl - bei der Bereitstellung.  Wenn es kurz vor dem Zul√§ssigen steht, wird dem Service ein ‚ÄûPessimierungskoeffizient‚Äú zugewiesen. Wenn sich der Indikator im Laufe der Zeit nicht verbessert, erh√§lt der Entwickler eine Benachrichtigung, dass seitens der Tests keine Fortschritte erzielt wurden (und diesbez√ºglich muss etwas unternommen werden). </li><li>  <strong>Ber√ºcksichtigung von Speicher- und CPU-Einschr√§nkungen</strong> .  Wir schreiben haupts√§chlich Microservices in Golang und betreiben sie in Kubernetes.  Von hier aus gibt es eine Feinheit, die mit der Besonderheit der Golang-Sprache verbunden ist: Standardm√§√üig werden beim Start alle Kernel auf dem Computer verwendet. Wenn Sie die Variable GOMAXPROCS nicht explizit festlegen und mehrere solcher Dienste auf demselben Computer gestartet werden, beginnen sie um Ressourcen zu konkurrieren und st√∂ren sich gegenseitig.  Die folgenden Grafiken zeigen, wie sich die Laufzeit √§ndert, wenn Sie die Anwendung ohne Konkurrenz und im Wettlauf um Ressourcen ausf√ºhren.  (Die Quelle der Grafiken ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ). </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/dl/1g/df/dl1gdfpfvj_me2wgpj28p0ucg90.png"></a> </p><br><p>  <em>Vorlaufzeit, weniger ist besser.</em>  <em>Maximum: 643 ms; Minimum: 42 ms.</em>  <em>Das Foto ist anklickbar.</em> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/nb/zj/fv/nbzjfv9lx89orqn9r8ngnn84zr4.png"></a> </p><br><p>  <em>Zeit f√ºr eine Operation, weniger ist besser.</em>  <em>Maximum: 14091 ns, Minimum: 151 ns.</em>  <em>Das Foto ist anklickbar.</em> </p><br><p>  In der Phase der Vorbereitung der Baugruppe k√∂nnen Sie diese Variable explizit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">festlegen</a> oder die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">automaxprocs-</a> Bibliothek der Uber- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mitarbeiter</a> verwenden. </p><br><h2 id="deploy">  Bereitstellen </h2><br><p>  <strong>‚Ä¢ √úberpr√ºfung von Konventionen.</strong>  Bevor Sie mit der Bereitstellung von Servicebaugruppen f√ºr vorgesehene Umgebungen beginnen, m√ºssen Sie Folgendes √ºberpr√ºfen: <br>  - API-Endpunkte. <br>  - Einhaltung des Endpunktschemas f√ºr API-Antworten. <br>  - Protokollformat. <br>  - Header f√ºr Serviceanfragen setzen (Netramesh macht das jetzt) <br>  - Festlegen des Besitzertokens beim Senden von Nachrichten an den Bus (Ereignisbus).  Dies ist erforderlich, um die Konnektivit√§t von Diensten √ºber den Bus zu verfolgen.  Sie k√∂nnen idempotente Daten an den Bus senden, die die Konnektivit√§t von Diensten nicht erh√∂hen (was gut ist), sowie Gesch√§ftsdaten, die die Konnektivit√§t von Diensten verbessern (was sehr schlecht ist!).  In dem Moment, in dem diese Konnektivit√§t zu einem Problem wird, hilft das Verstehen, wer den Bus schreibt und liest, die Dienste richtig aufzuteilen. </p><br><p>  Es gibt zwar nicht viele Konventionen in Avito, aber ihr Pool erweitert sich.  Je mehr solche Vereinbarungen in Form eines verst√§ndlichen und bequemen Befehls vorliegen, desto einfacher ist es, die Konsistenz zwischen Microservices aufrechtzuerhalten. </p><br><h2 id="sinteticheskie-testy">  Synthetische Tests </h2><br><p>  <strong>‚Ä¢ Closed-Loop-Test.</strong>  F√ºr ihn verwenden wir jetzt die Open Source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hoverfly.io</a> .  Zuerst wird die tats√§chliche Auslastung des Dienstes aufgezeichnet und dann - nur in einer geschlossenen Schleife - emuliert. </p><br><p>  <strong>‚Ä¢ Lasttest.</strong>  Wir versuchen, alle Dienstleistungen auf optimale Leistung zu bringen.  Alle Versionen jedes Dienstes sollten Stresstests unterzogen werden, damit wir die aktuelle Leistung des Dienstes und den Unterschied zu fr√ºheren Versionen desselben Dienstes verstehen k√∂nnen.  Wenn nach einem Service-Update die Leistung um das Eineinhalbfache gesunken ist, ist dies ein klares Signal f√ºr die Eigent√ºmer: Sie m√ºssen sich in den Code vertiefen und die Situation beheben. <br>  Wir bauen beispielsweise auf den gesammelten Daten auf, um die automatische Skalierung korrekt zu implementieren und letztendlich allgemein zu verstehen, wie skalierbar der Service ist. </p><br><p>  W√§hrend des Stresstests pr√ºfen wir, ob der Ressourcenverbrauch die festgelegten Grenzwerte erreicht.  Und wir konzentrieren uns haupts√§chlich auf Extreme. </p><br><p>  <strong>a) Wir betrachten die Gesamtlast.</strong> <br>  - Zu klein - h√∂chstwahrscheinlich funktioniert etwas √ºberhaupt nicht, wenn die Last pl√∂tzlich mehrmals abf√§llt. <br>  - Zu gro√ü - Optimierung ist erforderlich. </p><br><p> <strong>b) Wir betrachten den Cut-off von RPS.</strong> <br>  Hier betrachten wir den Unterschied zwischen der aktuellen und der vorherigen Version und der Gesamtzahl.  Wenn ein Dienst beispielsweise 100 U / min erzeugt, ist er entweder schlecht geschrieben oder es ist seine Spezifit√§t. In jedem Fall ist dies jedoch eine Gelegenheit, den Dienst sehr genau zu betrachten. <br>  Wenn RPS im Gegenteil zu viel ist, werden m√∂glicherweise eine Art Fehler und einige der Endpunkte die Nutzdaten nicht mehr ausf√ºhren, aber eine Art <code>return true;</code> ausgel√∂st <code>return true;</code> </p><br><h2 id="canary-testy">  Kanarische Tests </h2><br><p>  Nachdem die synthetischen Tests bestanden wurden, f√ºhren wir den Microservice f√ºr eine kleine Anzahl von Benutzern aus.  Wir beginnen vorsichtig mit einem winzigen Bruchteil der gesch√§tzten Zielgruppe des Dienstes - weniger als 0,1%.  In dieser Phase ist es sehr wichtig, dass die richtigen technischen und Produktmetriken in der √úberwachung festgelegt werden, damit sie das Problem im Service so schnell wie m√∂glich anzeigen.  Die Mindestzeit f√ºr einen Kanarientest betr√§gt 5 Minuten, die Hauptzeit 2 Stunden.  F√ºr komplexe Dienste stellen wir die Zeit im manuellen Modus ein. <br>  Wir analysieren: <br>  - sprachspezifische Metriken, insbesondere PHP-Fpm-Mitarbeiter; <br>  - Fehler in Sentry; <br>  - Status der Antworten; <br>  - Reaktionszeit (Reaktionszeit), genau und durchschnittlich; <br>  - Latenz; <br>  - Ausnahmen, verarbeitet und unverarbeitet; <br>  - Lebensmittelmetriken. </p><br><h2 id="squeeze-testing">  Quetschtest </h2><br><p>  Squeeze Testing wird auch als Extrusionstest bezeichnet.  Der Name der Technik wurde in Netflix eingef√ºhrt.  Das Wesentliche ist, dass wir zun√§chst eine Instanz mit echtem Datenverkehr bis zum Fehlerzustand f√ºllen und damit ihre Grenze festlegen.  F√ºgen Sie als N√§chstes eine weitere Instanz hinzu und laden Sie dieses Paar erneut auf das Maximum.  Wir sehen ihre Decke und ihr Delta beim ersten "Squeeze".  Und so verbinden wir eine Instanz pro Schritt und berechnen das √Ñnderungsmuster. <br>  Testdaten durch ‚ÄûExtrusion‚Äú str√∂men auch zur allgemeinen metrischen Basis, wo wir sie entweder mit k√ºnstlichen Belastungsergebnissen anreichern oder sie sogar durch ‚ÄûKunststoffe‚Äú ersetzen. </p><br><h2 id="prodakshen">  Produktion </h2><br><p>  <strong>‚Ä¢ Skalierung.</strong>  Indem wir den Service auf die Produktion ausweiten, verfolgen wir, wie er skaliert.  In diesem Fall ist es nach unserer Erfahrung ineffizient, nur CPU-Indikatoren zu √ºberwachen.  Die automatische Skalierung mit RPS-Benchmarking in reiner Form funktioniert jedoch nur f√ºr bestimmte Dienste, z. B. Online-Streaming.  Daher betrachten wir haupts√§chlich anwendungsspezifische Produktmetriken. </p><br><p>  <strong>Als Ergebnis analysieren wir bei der Skalierung:</strong> <br>  - CPU- und RAM-Anzeigen, <br>  - die Anzahl der Anfragen in der Warteschlange, <br>  - Reaktionszeit <br>  - Prognose basierend auf historischen Daten. </p><br><p>  Beim Skalieren eines Dienstes ist es auch wichtig, seine Abh√§ngigkeiten zu √ºberwachen, damit sich nicht herausstellt, dass wir der erste Dienst in der Skalierungskette sind und diejenigen, auf die er sich bezieht, unter Last fallen.  Um eine akzeptable Auslastung f√ºr den gesamten Servicepool zu ermitteln, betrachten wir die historischen Daten des "n√§chsten" abh√§ngigen Dienstes (basierend auf einer Kombination aus CPU und RAM und app-spezifischen Metriken) und vergleichen sie mit den historischen Daten des Initialisierungsdienstes usw. entlang der gesamten "Abh√§ngigkeitskette". ", Von oben nach unten. </p><br><h2 id="obsluzhivanie">  Service </h2><br><p>  Nachdem der Microservice in Betrieb genommen wurde, k√∂nnen wir Trigger daran h√§ngen. </p><br><p>  <strong>Hier sind typische Situationen, in denen Feuer ausgel√∂st wird.</strong> <br>  - Potenziell gef√§hrliche Migrationen erkannt. <br>  - Sicherheitsupdates wurden ver√∂ffentlicht. <br>  - Der Dienst selbst wurde lange nicht aktualisiert. <br>  - Die Belastung des Dienstes hat erheblich abgenommen oder eine seiner Produktmetriken liegt au√üerhalb des normalen Bereichs. <br>  - Der Dienst erf√ºllt die neuen Plattformanforderungen nicht mehr. </p><br><p>  Einige der Ausl√∂ser sind f√ºr die Stabilit√§t der Arbeit verantwortlich, andere als Funktion der Wartung des Systems. Einige Dienste wurden beispielsweise schon lange nicht mehr bereitgestellt, und das grundlegende Image hat die Sicherheits√ºberpr√ºfungen nicht mehr bestanden. </p><br><h1 id="dashbord">  Dashboard </h1><br><p>  Kurz gesagt, das Dashboard ist das Bedienfeld unseres gesamten PaaS. </p><br><ul><li>  Ein einzelner Informationspunkt √ºber einen Dienst mit Daten zu seiner Abdeckung durch Tests, der Anzahl seiner Bilder, der Anzahl der Produktionskopien, Versionen usw. </li><li>  Ein Tool zum Filtern von Daten nach Services und Labels (Kennzeichen f√ºr die Zugeh√∂rigkeit zu Gesch√§ftsbereichen, Produktfunktionalit√§t usw.) </li><li>  Integrationsmittel in Infrastruktur-Tools zum Nachverfolgen, Protokollieren und √úberwachen. </li><li>  Eine einzige Point-of-Service-Dokumentation. </li><li>  Eine einzige Sicht auf alle Serviceereignisse. </li></ul><br><p><img src="https://habrastorage.org/webt/gi/lx/to/gilxtozg66qrpsxbrnjccubhiw0.png"><br><img src="https://habrastorage.org/webt/hq/wl/lc/hqwllckcrjfwl48sv_2qrjfefp4.png"><br><img src="https://habrastorage.org/webt/hu/ey/bj/hueybjd31isqaeav3w8iwx_oruq.png"><br><img src="https://habrastorage.org/webt/8z/ir/xk/8zirxkio-65hh2rqrj-impyozmc.png"></p><br><h1 id="itogo">  Insgesamt </h1><br><p>  Vor der Einf√ºhrung von PaaS konnte ein neuer Entwickler mehrere Wochen damit verbringen, alle Tools zu sortieren, die zum Starten eines Microservices in der Produktion erforderlich sind: Kubernetes, Helm, unsere internen TeamCity-Funktionen, das Herstellen einer Verbindung zu Datenbanken und Caches in fehlertoleranter Form usw. Jetzt dauert es ein paar Stunden, um den Schnellstart zu lesen und den Dienst selbst zu erstellen. </p><br><hr><br><p>  Ich habe einen Bericht zu diesem Thema f√ºr HighLoad ++ 2018 erstellt. Sie k√∂nnen das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Video</a> und die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pr√§sentation</a> ansehen. </p><br><h1 id="bonus-trek-dlya-teh-kto-dochital-do-konca">  Bonustrack f√ºr diejenigen, die bis zum Ende gelesen haben </h1><br><p>  Wir in Avito organisieren eine interne dreit√§gige Schulung f√ºr Entwickler von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Chris Richardson</a> , einem Experten f√ºr Microservice-Architektur.  Wir m√∂chten einem der Leser dieses Beitrags die M√∂glichkeit geben, daran teilzunehmen.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hier</a> ist ein Trainingsprogramm. </p><br><p>  Das Training findet vom 5. bis 7. August in Moskau statt.  Dies sind Arbeitstage, die voll belegt sind.  Das Mittagessen und die Schulung finden in unserem B√ºro statt und der ausgew√§hlte Teilnehmer bezahlt die Reise und die Unterkunft selbst. </p><br><p>  Sie k√∂nnen die Teilnahme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">an diesem Google-Formular</a> beantragen.  Von Ihnen - die Antwort auf die Frage, warum genau Sie an der Schulung teilnehmen m√ºssen, und Informationen zur Kontaktaufnahme.  Antworte auf Englisch, da Chris den Teilnehmer ausw√§hlt, der zum Training kommt. <br>  Wir werden den Namen des Schulungsteilnehmers bis sp√§testens 19. Juli als Update f√ºr diesen Beitrag in den sozialen Netzwerken von Avito f√ºr Entwickler (AvitoTech auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Facebook</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Vkontakte</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Twitter</a> ) bekannt geben. </p><br><p>  <em>UPD, 19.07.:</em> Wir haben Dutzende von Bewerbungen erhalten.  Chris untersuchte sie und w√§hlte einen Teilnehmer aus: Zusammen mit unseren Kollegen wird Andrei Igumnov studieren gehen.  Gl√ºckwunsch! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de454780/">https://habr.com/ru/post/de454780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de454766/index.html">HBO, danke, dass Sie mich daran erinnert haben ... "Tschernobyl-Erste-Hilfe-Kasten" eines belarussischen Apothekers</a></li>
<li><a href="../de454770/index.html">Samsung Startup Membership - ein neues Programm f√ºr Startups in Russland</a></li>
<li><a href="../de454774/index.html">Wir haben den n√ºtzlichsten Code in unserem Leben geschrieben, ihn aber in den Papierkorb geworfen. Bei uns</a></li>
<li><a href="../de454776/index.html">Freiberuflich oder im B√ºro? Freelancer-Antwort</a></li>
<li><a href="../de454778/index.html">Das Buch "Maschinelles Lernen: Algorithmen f√ºr Unternehmen"</a></li>
<li><a href="../de454788/index.html">Waffe eines vorsichtigen Anlegers: Wir betrachten den beizulegenden Zeitwert von Investmentanleihen</a></li>
<li><a href="../de454790/index.html">Java Native Image: Usability-Pr√ºfung</a></li>
<li><a href="../de454792/index.html">Vergleich von Austauschsortierungsalgorithmen</a></li>
<li><a href="../de454804/index.html">Erstellen Sie Ihre Komponente mit Mikrovorlagen</a></li>
<li><a href="../de454806/index.html">Schulung Cisco 200-125 CCNA v3.0. Tag 9. Die physische Welt der Schalter. Teil 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>