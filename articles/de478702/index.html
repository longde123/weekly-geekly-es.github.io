<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈚️ 📍 🤵🏿 Metrische Verarbeitungstricks in Kapacitor 🦏 🏀 👨🏼‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Höchstwahrscheinlich hat heute niemand eine Frage, warum Servicemetriken erfasst werden müssen. Der nächste logische Schritt ist die Konfiguration des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Metrische Verarbeitungstricks in Kapacitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/478702/">  Höchstwahrscheinlich hat heute niemand eine Frage, warum Servicemetriken erfasst werden müssen.  Der nächste logische Schritt ist die Konfiguration des Alarms für die erfassten Metriken, der Sie über Abweichungen in den Daten in den für Sie geeigneten Kanälen (Mail, Slack, Telegramm) informiert.  Im Online-Reservierungsservice von Hotels in <a href="https://www.habr.com/%3Futm_source%3Dhabr%26utm_medium%3Dpr%26utm_campaign%3DErmolaev_dec19%26utm_content%3Darticle">Ostrovok.ru</a> werden alle Metriken unserer Services in InfluxDB eingegeben und in Grafana angezeigt. Dort wird auch der Basisalarm eingestellt.  Für Aufgaben wie "Sie müssen etwas berechnen und damit vergleichen" verwenden wir Kapacitor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oe/cl/5h/oecl5hgip8nkmeau21l2qaem8ek.png"></div><br>  Kapacitor ist Teil des TICK-Stacks, der Metriken aus InfluxDB verarbeiten kann.  Er kann mehrere Dimensionen miteinander verbinden (Join), aus den empfangenen Daten etwas Nützliches berechnen, das Ergebnis in InfluxDB zurückschreiben, einen Alarm an Slack / Telegram / Mail senden. <br><br>  Der gesamte Stack verfügt über eine coole und detaillierte <a href="">Dokumentation</a> , aber es gibt immer nützliche Dinge, die nicht explizit in den Handbüchern angegeben sind.  In diesem Artikel habe ich beschlossen, eine Reihe solcher nützlichen, nicht offensichtlichen Tipps (die grundlegende TICKscipt-Syntax wird <a href="https://docs.influxdata.com/kapacitor/v1.5/tick/syntax/">hier</a> beschrieben) zu sammeln und anhand eines Beispiels zur Lösung eines unserer Probleme zu zeigen, wie sie angewendet werden können. <br><br>  Lass uns gehen! <br><a name="habracut"></a><br><h4>  float &amp; int, Rechenfehler </h4><br>  Absolut Standardproblem, es wird durch Kasten gelöst: <br><br><pre><code class="python hljs">var alert_float = <span class="hljs-number"><span class="hljs-number">5.0</span></span> var alert_int = <span class="hljs-number"><span class="hljs-number">10</span></span> data|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &gt; alert_float OR float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &lt; float(<span class="hljs-string"><span class="hljs-string">"alert_int"</span></span>))</code> </pre> <br><h4>  Standard () verwenden </h4><br>  Wenn das Tag / Feld nicht ausgefüllt ist, treten Fehler bei den Berechnungen auf: <br><br><pre> <code class="python hljs">|default() .tag(<span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'empty'</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><h4>  Füllen Sie den Join aus (innerer vs. äußerer) </h4><br>  Standardmäßig löscht der Join Punkte, an denen keine Daten vorhanden sind (inner). <br>  Mit fill ('null') wird der Outer Join ausgeführt. Danach müssen Sie default () ausführen und die leeren Werte eingeben: <br><br><pre> <code class="python hljs">var data = res1 |join(res2) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'res1'</span></span>, <span class="hljs-string"><span class="hljs-string">'res2) .fill('</span></span>null<span class="hljs-string"><span class="hljs-string">') |default() .field('</span></span>res1.value<span class="hljs-string"><span class="hljs-string">', 0.0) .field('</span></span>res2.value<span class="hljs-string"><span class="hljs-string">', 100.0)</span></span></code> </pre><br>  Es gibt noch eine Nuance.  Wenn im obigen Beispiel eine der Reihen (res1 oder res2) leer ist, ist auch die letzte Reihe (Daten) leer.  Es gibt mehrere Tickets zu diesem Thema auf dem Github ( <a href="https://github.com/influxdata/kapacitor/issues/1633">1633</a> , <a href="https://github.com/influxdata/kapacitor/issues/1871">1871</a> , <a href="https://github.com/influxdata/influxdb/issues/6967">6967</a> ) - wir warten auf Korrekturen und leiden ein wenig. <br><br><h4>  Bedingungen in Berechnungen verwenden (wenn in Lambda) </h4><br><pre> <code class="python hljs">|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, true, false)</code> </pre><br><h4>  Die letzten fünf Minuten von der Pipeline im Zeitraum </h4><br>  Beispielsweise müssen Sie die Werte der letzten fünf Minuten mit der vorherigen Woche vergleichen.  Sie können zwei Datenpakete mit zwei getrennten batch'ami nehmen oder einen Teil der Daten aus einem größeren Zeitraum entnehmen: <br><br><pre> <code class="python hljs"> |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>))/<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br>  Eine Alternative für die letzten fünf Minuten könnte die Verwendung des BarrierNode-Knotens sein, der Daten vor der angegebenen Zeit abschneidet: <br><br><pre> <code class="python hljs">|barrier() .period(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br><h2>  Beispiele für die Verwendung von Go'sh-Mustern in Nachrichten </h2><br>  Die Vorlagen entsprechen dem Format des Pakets <a href="https://golang.org/pkg/text/template/">text.template. Nachfolgend</a> sind einige allgemeine Aufgaben aufgeführt. <br><br><h4>  wenn-sonst </h4><br>  Wir ordnen die Dinge, wir lösen nicht noch einmal Menschen mit dem Text aus: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'{{ if eq .Level "OK" }}It is ok now{{ else }}Chief, everything is broken{{end}}'</span></span> )</code> </pre><br><h4>  Zwei Dezimalstellen in der Nachricht </h4><br>  Verbesserung der Lesbarkeit der Nachricht: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'now value is {{ index .Fields "value" | printf "%0.2f" }}'</span></span> )</code> </pre><br><h4>  Variablen in der Nachricht erweitern </h4><br>  In der Nachricht werden weitere Informationen angezeigt, um die Frage zu beantworten: "Warum schreit es?" <br><br><pre> <code class="python hljs">var warnAlert = <span class="hljs-number"><span class="hljs-number">10</span></span> |alert() ... .message( <span class="hljs-string"><span class="hljs-string">'Today value less then '</span></span>+string(warnAlert)+<span class="hljs-string"><span class="hljs-string">'%'</span></span> )</code> </pre><br><h4>  Unique Alert Identifier </h4><br>  Das Richtige, wenn mehr als eine Gruppe in den Daten enthalten ist, andernfalls wird nur eine Warnung generiert: <br><br><pre> <code class="python hljs">|alert() ... .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "myname" }}/{{ index .Tags "myfield" }}'</span></span>)</code> </pre><br><h4>  Benutzerdefinierte Handler </h4><br>  Die große Liste der Handler verfügt über exec, mit dem Sie Ihr Skript mit den übergebenen Parametern (stdin) ausführen können - Kreativität und mehr! <br><br>  Eines unserer benutzerdefinierten Tools ist ein kleines Python-Skript zum Senden von Benachrichtigungen an Slack. <br>  Zuerst wollten wir ein Bild von einer Grafik senden, die durch die Autorisierung in der Nachricht geschützt ist.  Danach - Schreiben Sie OK in den Thread für die vorherige Warnung aus derselben Gruppe und nicht als separate Nachricht.  Wenig später - um den häufigsten Fehler in den letzten X Minuten an die Nachricht anzuhängen. <br><br>  Ein separates Thema ist die Kommunikation mit anderen Diensten und alle Aktionen, die durch eine Warnung ausgelöst werden (nur wenn Ihre Überwachung gut genug funktioniert). <br>  Ein Beispiel für eine Beschreibung eines Handlers, wobei slack_handler.py unser selbst geschriebenes Skript ist: <br><br><pre> <code class="python hljs">topic: slack_graph id: slack_graph.alert match: level() != INFO AND changed() == TRUE kind: <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> options: prog: /sbin/slack_handler.py args: [<span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"CHANNELID"</span></span>, <span class="hljs-string"><span class="hljs-string">"--graph"</span></span>, <span class="hljs-string"><span class="hljs-string">"--search"</span></span>]</code> </pre><br><h2>  Wie debütieren? </h2><br><h4>  Option zur Protokollausgabe </h4><br><pre> <code class="python hljs">|log() .level(<span class="hljs-string"><span class="hljs-string">"error"</span></span>) .prefix(<span class="hljs-string"><span class="hljs-string">"something"</span></span>)</code> </pre><br>  Beobachten Sie (cli): kapacitor -url <a href="http://host-or-ip/">host-or-ip</a> : 9092 logs lvl = error <br><br><h4>  Variante mit httpOut </h4><br>  Zeigt Daten in der aktuellen Pipeline an: <br><br><pre> <code class="python hljs">|httpOut(<span class="hljs-string"><span class="hljs-string">'something'</span></span>)</code> </pre><br>  Watch (get): <a href="http://host-or-ip/">host-or-ip</a> : 9092 / kapacitor / v1 / tasks / aufgabenname / something <br><br><h4>  Ausführungsschema </h4><br><ul><li>  Jede Task gibt einen Ausführungsbaum mit nützlichen Zahlen im <a href="https://www.graphviz.org/">Grafikformat zurück</a> . </li><li>  Nimm den <a href="http://host-or-ip:9092/kapacitor/v1/tasks/task_name%3Fdot-view%3Dlabels">Punktblock</a> . </li><li>  Wir fügen in den Betrachter ein, <a href="https://dreampuf.github.io/GraphvizOnline">genießen</a> . <br></li></ul><br><br><h2>  Wo sonst kann ich einen Rechen bekommen </h2><br><h4>  influxdb timestamp on writeback </h4><br>  Zum Beispiel haben wir eine Warnung für die Summe der Anforderungen pro Stunde eingerichtet (groupBy (1h)) und möchten die aufgetretene Warnung in influxdb aufzeichnen (um die Tatsache eines Problems in der Grafik in grafana schön darzustellen). <br><br>  influxDBOut () schreibt den Zeitwert von der Warnung zum Zeitstempel bzw. der Punkt auf dem Diagramm wird früher / später als die Warnung aufgezeichnet. <br><br>  Wenn Genauigkeit erforderlich ist: Wir umgehen dieses Problem, indem wir einen benutzerdefinierten Handler aufrufen, der Daten mit dem aktuellen Zeitstempel in influxdb schreibt. <br><br><h4>  Docker erstellen und bereitstellen </h4><br>  Beim Start kann kapacitor Tasks, Templates und Handler aus dem in der Konfiguration im Block [load] angegebenen Verzeichnis laden. <br><br>  Um eine Aufgabe korrekt zu erstellen, sind folgende Dinge erforderlich: <br><br><ol><li>  Dateiname - wird zu ID / Skriptname erweitert </li><li>  Typ - Stream / Charge </li><li>  dbrp - Schlüsselwort, um anzugeben, in welcher Datenbank + Richtlinie das Skript funktioniert (dbrp "supplier". "autogen") </li></ol><br>  Wenn in einer Batch-Task keine Zeile mit dbrp vorhanden ist, wird der gesamte Dienst den Start verweigern und ehrlich darüber im Protokoll schreiben. <br><br>  In chronograf hingegen sollte diese Zeile nicht sein, sie wird nicht über die Schnittstelle akzeptiert und wirft einen Fehler aus. <br><br>  Hack beim Erstellen des Containers: Dockerfile wird mit -1 beendet, wenn es Zeilen mit //.+dbrp gibt, wodurch der Grund für die Datei beim Erstellen des Builds sofort erkannt wird. <br><br><h4>  Schließe dich einem zu vielen an </h4><br>  Beispielaufgabe: Sie müssen das 95. Perzentil der Betriebszeit des Dienstes pro Woche nehmen und jede Minute der letzten 10 mit diesem Wert vergleichen. <br><br>  Sie können nicht eins zu viele verbinden, last / mean / median nach Punktegruppe, um den Knoten in einen Datenstrom zu verwandeln. Der Fehler "Nicht übereinstimmende untergeordnete Kanten können nicht hinzugefügt werden: Batch -&gt; Datenstrom" wird zurückgegeben. <br><br>  Das Ergebnis von Batch als Variable in einem Lambda-Ausdruck wird ebenfalls nicht ersetzt. <br><br>  Es besteht die Möglichkeit, die erforderlichen Nummern aus dem ersten Stapel über udf in eine Datei zu speichern und diese Datei über Sideload zu laden. <br><br><h2>  Was haben wir entschieden? </h2><br>  Wir haben ungefähr 100 Hotelanbieter, jeder von ihnen kann mehrere Verbindungen haben, nennen wir es einen Kanal.  Es gibt ungefähr 300 dieser Kanäle, wobei jeder der Kanäle abfallen kann.  Von allen aufgezeichneten Metriken überwachen wir die Fehlerrate (Anforderungen und Fehler). <br><br><h4>  Warum nicht Grafana? </h4><br>  In grafan konfigurierte Fehlermeldungen haben mehrere Nachteile.  Manche kritisch, manche können je nach Situation die Augen schließen. <br><br>  Grafana weiß nicht, wie man zwischen Dimensionen + Alert berechnet, aber wir benötigen eine Rate (Anfragen-Fehler) / Anfragen. <br><br>  Fehler sehen bösartig aus: <br><br><img src="https://habrastorage.org/webt/iq/0h/nq/iq0hnqauk_l0nm4akwynyeb0hbc.png"><br><br>  Und bei erfolgreichen Anfragen weniger bösartig: <br><br><img src="https://habrastorage.org/webt/mw/vs/ok/mwvsok9hb7qfa3lifpna4_rrno4.png"><br><br>  Okay, wir können die Rate im Service vorab vorab berechnen, und in einigen Fällen ist dies auch der Fall.  Aber nicht bei uns, weil  Für jeden Kanal wird das Verhältnis als „normal“ betrachtet und die Warnungen werden anhand statischer Werte ausgegeben (wir schauen mit unseren Augen, ändern uns, wenn sie oft alarmieren). <br><br>  Dies sind Beispiele für "normal" für verschiedene Kanäle: <br><br><img src="https://habrastorage.org/webt/3f/d5/fg/3fd5fg6los9dg7pjlkuanfuv_mk.png"><br><br><img src="https://habrastorage.org/webt/hp/n-/q6/hpn-q6cnqtaugwlsmch1jvapnuc.png"><br><br>  Wir vernachlässigen den vorherigen Absatz und gehen davon aus, dass alle Lieferanten ein "normales" Bild haben.  Jetzt ist alles in Ordnung, und können wir mit Warnungen in Grafana auskommen? <br>  Wir können, wollen aber wirklich nicht, weil wir eine der Optionen wählen müssen: <br>  a) viele Diagramme für jeden Kanal separat zu erstellen (und sie schmerzlich zu begleiten) <br>  b) Lassen Sie eine Karte mit allen Kanälen (und verlieren Sie sich in bunten Linien und eingestellten Warnungen) <br><br><img src="https://habrastorage.org/webt/sk/8c/-b/sk8c-bayyodb08xuchmfbfjhe8q.png"><br><br><h4>  Wie hast du das gemacht </h4><br>  Auch hier hat die Dokumentation ein gutes Startbeispiel ( <a href="https://docs.influxdata.com/kapacitor/v1.5/guides/join_backfill/">Berechnen von Raten für verbundene Serien</a> ), das Sie einsehen oder als Grundlage für ähnliche Aufgaben verwenden können. <br><br>  Was haben Sie als Ergebnis gemacht: <br><br><ul><li>  Verbinden Sie zwei Episoden in wenigen Stunden und gruppieren Sie sie nach Kanälen. </li><li>  Füllen Sie die Reihe nach Gruppen aus, wenn keine Daten vorhanden sind. </li><li>  Vergleichen Sie den Median der letzten 10 Minuten mit den vorherigen Daten. </li><li>  wir schreien, wenn wir etwas finden; </li><li>  berechnete Raten und aufgetretene Warnungen in influxdb schreiben; </li><li>  Sende eine nützliche Nachricht an Slack. </li></ul><br>  Meiner Meinung nach haben wir so gut wie möglich alles geschafft, was wir am Ausgang haben möchten (und noch ein bisschen mehr mit benutzerdefinierten Handlern). <br><br>  Auf github.com sehen Sie den <a href="">Beispielcode</a> und das <a href="">Minimaldiagramm (graphviz) des</a> resultierenden Skripts. <br><br><div class="spoiler">  <b class="spoiler_title">Beispiel für den resultierenden Code:</b> <div class="spoiler_text"><pre> <code class="python hljs">dbrp <span class="hljs-string"><span class="hljs-string">"supplier"</span></span>.<span class="hljs-string"><span class="hljs-string">"autogen"</span></span> var name = <span class="hljs-string"><span class="hljs-string">'requests.rate'</span></span> var grafana_dash = <span class="hljs-string"><span class="hljs-string">'pczpmYZWU/mydashboard'</span></span> var grafana_panel = <span class="hljs-string"><span class="hljs-string">'26'</span></span> var period = <span class="hljs-number"><span class="hljs-number">8</span></span>h var todayPeriod = <span class="hljs-number"><span class="hljs-number">10</span></span>m var every = <span class="hljs-number"><span class="hljs-number">1</span></span>m var warnAlert = <span class="hljs-number"><span class="hljs-number">15</span></span> var warnReset = <span class="hljs-number"><span class="hljs-number">5</span></span> var reqQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."requests"'</span></span> var errQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."errors"'</span></span> var prevErr = batch |query(errQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var prevReq = batch |query(reqQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var rates = prevReq |join(prevErr) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'req'</span></span>, <span class="hljs-string"><span class="hljs-string">'err'</span></span>) .tolerance(<span class="hljs-number"><span class="hljs-number">1</span></span>m) .fill(<span class="hljs-string"><span class="hljs-string">'null'</span></span>) //   ,     |default() .field(<span class="hljs-string"><span class="hljs-string">'err.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'req.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:  ,     |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100.0</span></span> * (float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>) - float(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span>)) / float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>), <span class="hljs-number"><span class="hljs-number">100.0</span></span>)) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) //      rates |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'rates'</span></span>) //     <span class="hljs-number"><span class="hljs-number">10</span></span> ,   var todayRate = rates |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>)) / <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; todayPeriod) |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var prevRate = rates |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var joined = todayRate |join(prevRate) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'today'</span></span>, <span class="hljs-string"><span class="hljs-string">'prev'</span></span>) |httpOut(<span class="hljs-string"><span class="hljs-string">'join'</span></span>) var trigger = joined |alert() .warn(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &gt; warnAlert) .warnReset(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &lt; warnReset) .flapping(<span class="hljs-number"><span class="hljs-number">0.25</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .stateChangesOnly() //   message      .message( <span class="hljs-string"><span class="hljs-string">'{{ .Level }}: {{ index .Tags "channel" }} err/req ratio ({{ index .Tags "supplier" }}) {{ if eq .Level "OK" }}It is ok now{{ else }} '</span></span>+string(todayPeriod)+<span class="hljs-string"><span class="hljs-string">' median is {{ index .Fields "today.median" | printf "%0.2f" }}%, by previous '</span></span>+string(period)+<span class="hljs-string"><span class="hljs-string">' is {{ index .Fields "prev.median" | printf "%0.2f" }}%{{ end }} http://grafana.ostrovok.in/d/'</span></span>+string(grafana_dash)+ <span class="hljs-string"><span class="hljs-string">'?var-supplier={{ index .Tags "supplier" }}&amp;var-channel={{ index .Tags "channel" }}&amp;panelId='</span></span>+string(grafana_panel)+<span class="hljs-string"><span class="hljs-string">'&amp;fullscreen&amp;tz=UTC%2B03%3A00'</span></span> ) .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "name" }}/{{ index .Tags "channel" }}'</span></span>) .levelTag(<span class="hljs-string"><span class="hljs-string">'level'</span></span>) .messageField(<span class="hljs-string"><span class="hljs-string">'message'</span></span>) .durationField(<span class="hljs-string"><span class="hljs-string">'duration'</span></span>) .topic(<span class="hljs-string"><span class="hljs-string">'slack_graph'</span></span>) // <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>   <span class="hljs-string"><span class="hljs-string">"value"</span></span>,        (keep) trigger |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>) .keep() |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'alerts'</span></span>) .tag(<span class="hljs-string"><span class="hljs-string">'alertName'</span></span>, name)</code> </pre><br></div></div><br><h2>  Was ist die Schlussfolgerung? </h2><br>  Kapacitor ist sehr gut darin, Warnungen mit einer Reihe von Gruppen zu überwachen, zusätzliche Berechnungen für bereits aufgezeichnete Metriken durchzuführen, benutzerdefinierte Aktionen durchzuführen und Skripte (udf) auszuführen. <br><br>  Die Einstiegsschwelle ist nicht sehr hoch - versuchen Sie es, wenn Grafana oder andere Tools Ihre Wunschliste nicht vollständig erfüllen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de478702/">https://habr.com/ru/post/de478702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de478690/index.html">Dynamische Assemblierung und Bereitstellung von Docker-Images mit werf anhand der Beispielsite der versionierten Dokumentation</a></li>
<li><a href="../de478692/index.html">Wie Java 8 auf Android unterstützt wird</a></li>
<li><a href="../de478694/index.html">Da empfehlen wir die neuesten Kataloge im ivi Online-Kino (+ Python-Code)</a></li>
<li><a href="../de478696/index.html">Wie ich Urban Tech 2019 besuchte. Veranstaltungsbericht</a></li>
<li><a href="../de478698/index.html">In 15 Minuten erstellen wir einen interaktiven Geländeplan</a></li>
<li><a href="../de478706/index.html">Hochlast-Architekt. Neuer Kurs von OTUS</a></li>
<li><a href="../de478708/index.html">Wie Sie mit Zufallsgeneratoren alten Spielen neues Leben einhauchen können</a></li>
<li><a href="../de478710/index.html">Einfache und übersichtliche Bereitstellung von Anwendungen auf Tarantool Cartridge (Teil 1)</a></li>
<li><a href="../de478712/index.html">So zahlen Sie nicht für Java-Hosting oder den Schnellstart mit Google App Engine</a></li>
<li><a href="../de478714/index.html">Die RetouchMe-Fallstudie: Was wir aus der Lokalisierung einer App in 35 Sprachen gelernt haben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>