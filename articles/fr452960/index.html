<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüíª üíì üë©‚Äçüíº Vous r√©pondrez de tout! Contrats ax√©s sur le consommateur √† travers les yeux du d√©veloppeur üë®üèæ‚Äçüíª ü•† üéí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, nous parlerons des probl√®mes r√©solus par les contrats pilot√©s par les consommateurs et montrerons comment l'appliquer √† l'aide de l'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vous r√©pondrez de tout! Contrats ax√©s sur le consommateur √† travers les yeux du d√©veloppeur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/452960/">  Dans cet article, nous parlerons des probl√®mes r√©solus par les contrats pilot√©s par les consommateurs et montrerons comment l'appliquer √† l'aide de l'exemple de Pacte avec Node.js et Spring Boot.  Et parlez des limites de cette approche. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gu/vg/za/guvgzadja02vflw5bi8mgh_wbbo.png"></div><br><h2>  Probl√®me </h2><br>  Lors des tests de produits, des tests de sc√©narios sont souvent utilis√©s dans lesquels l'int√©gration de divers composants du syst√®me dans un environnement sp√©cialement s√©lectionn√© est v√©rifi√©e.  Ces tests sur les services en direct donnent le r√©sultat le plus fiable (sans compter les tests au combat).  Mais en m√™me temps, ils sont l'un des plus chers. <br><a name="habracut"></a><br><ul><li>  On pense souvent √† tort que l'environnement d'int√©gration ne doit pas √™tre tol√©rant aux pannes.  SLA, les garanties pour de tels environnements sont rarement exprim√©es, mais s'il n'est pas disponible, les √©quipes doivent soit retarder les versions, soit esp√©rer le meilleur et se battre sans tests.  Bien que tout le monde sache que l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">espoir n'est pas une strat√©gie</a> .  De plus, les nouvelles technologies d'infrastructure compliquent le travail avec les environnements d'int√©gration. </li><li>  <b>Une autre douleur est de travailler avec des donn√©es de test</b> .  De nombreux sc√©narios n√©cessitent un certain √©tat du syst√®me, des appareils.  √Ä quel point doivent-ils √™tre proches pour combattre les donn√©es?  Comment les mettre √† jour avant le test et les nettoyer apr√®s la fin? </li><li> <b>Les tests sont trop instables</b> .  Et pas seulement √† cause de l'infrastructure que nous avons mentionn√©e dans le premier paragraphe.  Le test peut √©chouer car une √©quipe voisine a lanc√© ses propres contr√¥les qui ont cass√© l'√©tat attendu du syst√®me!  De nombreux faux tests n√©gatifs, tests floconneux <code>@Ignored</code> fin √† leurs jours chez <code>@Ignored</code> .  En outre, diff√©rentes parties de l'int√©gration peuvent √™tre prises en charge par diff√©rentes √©quipes.  Ils ont d√©ploy√© une nouvelle version candidate avec des erreurs - ils ont cass√© tous les consommateurs.  Quelqu'un r√©sout ce probl√®me avec des boucles de test d√©di√©es.  Mais au prix de multiplier le co√ªt du support. </li><li>  <b>De tels tests prennent beaucoup de temps</b> .  M√™me en pensant √† l'automatisation, les r√©sultats peuvent √™tre attendus pendant des heures. </li><li>  Et pour couronner le tout, si le test a vraiment bien fonctionn√©, il est loin d'√™tre toujours possible de trouver imm√©diatement la cause du probl√®me.  Il peut se cacher profond√©ment derri√®re les couches d'int√©gration.  Ou cela peut √™tre le r√©sultat d'une combinaison inattendue d'√©tats de nombreux composants du syst√®me. </li></ul><br>  Des tests stables dans un environnement d'int√©gration n√©cessitent un investissement s√©rieux de la part de l'AQ, des d√©veloppeurs et m√™me des op√©rateurs.  Pas √©tonnant qu'ils soient tout en haut de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pyramide des tests</a> .  Ces tests sont utiles, mais l'√©conomie des ressources ne leur permet pas de tout v√©rifier.  La principale source de leur valeur est l'environnement. <br><br>  En dessous de la m√™me pyramide se trouvent d'autres tests dans lesquels nous √©changeons la confiance pour des maux de t√™te de support plus petits - en utilisant des contr√¥les d'isolement.  Plus le granulaire est petit, plus l'√©chelle du test est petite, moins la d√©pendance √† l'environnement externe est importante.  Tout en bas de la pyramide se trouvent des tests unitaires.  Nous v√©rifions les fonctions individuelles, les classes, nous op√©rons moins avec la s√©mantique m√©tier qu'avec les constructions d'une impl√©mentation sp√©cifique.  Ces tests donnent un retour rapide. <br><br>  Mais d√®s que nous descendons la pyramide, nous devons remplacer l'environnement par quelque chose.  Les stubs apparaissent - comme des services entiers et des entit√©s individuelles du langage de programmation.  C'est √† l'aide de fiches que nous pouvons tester les composants isol√©ment.  Mais ils r√©duisent √©galement la validit√© des ch√®ques.  Comment s'assurer que le talon renvoie les donn√©es correctes?  Comment garantir sa qualit√©? <br><br>  <b>La solution peut √™tre une documentation compl√®te</b> qui d√©crit divers sc√©narios et √©tats possibles des composants du syst√®me.  Mais toute formulation laisse encore la libert√© d'interpr√©tation.  Par cons√©quent, une bonne documentation est un artefact vivant qui s'am√©liore constamment √† mesure que l'√©quipe comprend le probl√®me.  Comment alors assurer le respect des talons de documentation? <br><br>  Sur de nombreux projets, vous pouvez observer une situation o√π les talons sont √©crits par les m√™mes gars qui ont d√©velopp√© l'artefact de test.  Par exemple, les d√©veloppeurs d'applications mobiles cr√©ent eux-m√™mes des talons pour leurs tests.  En cons√©quence, les programmeurs peuvent comprendre la documentation √† leur mani√®re (ce qui est tout √† fait normal), ils cr√©ent le stub avec le mauvais comportement attendu, √©crivent le code conform√©ment √† celui-ci (avec des tests verts) et des erreurs se produisent lors de la v√©ritable int√©gration. <br><br>  De plus, la documentation se d√©place g√©n√©ralement en aval - les clients utilisent des sp√©cifications de services (dans ce cas, un autre service peut √™tre client du service).  Il n'exprime pas <strong>comment les</strong> consommateurs utilisent les donn√©es, quelles donn√©es sont n√©cessaires, quelles hypoth√®ses ils font pour ces donn√©es.  La cons√©quence de cette ignorance est la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">loi d'Hyrum</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ek/bh/ho/ekbhhofe0ox95w50drdg8tybsbi.png" width="300"></div><br><br>  Hyrum Wright d√©veloppe depuis longtemps des outils publics au sein de Google et a observ√© comment les plus petits changements peuvent provoquer des pannes pour les clients qui ont utilis√© les fonctionnalit√©s implicites (non document√©es) de ses biblioth√®ques.  Cette connectivit√© cach√©e complique l'√©volution de l'API. <br><br>  Ces probl√®mes peuvent √™tre r√©solus dans une certaine mesure √† l'aide de contrats ax√©s sur le consommateur.  Comme toute approche et tout outil, il a une gamme d'applicabilit√© et de co√ªt, que nous consid√©rerons √©galement.  Les impl√©mentations de cette approche ont atteint un niveau de maturit√© suffisant pour essayer leurs projets. <br><br><h2>  Qu'est-ce qu'un CDC? </h2><br>  Trois √©l√©ments cl√©s: <br><br><ul><li>  <b>Le contrat</b> .  D√©crit √† l'aide de DSL, d√©pend de l'impl√©mentation.  Il contient une description de l'API sous forme de sc√©narios d'interaction: si une demande sp√©cifique arrive, le client doit recevoir une r√©ponse sp√©cifique. </li><li>  <b>Tests clients</b> .  De plus, ils utilisent un talon, qui est g√©n√©r√© automatiquement √† partir du contrat. </li><li>  <b>Tests pour l'API</b> .  Ils sont √©galement g√©n√©r√©s √† partir du contrat. </li></ul><br>  Ainsi, le contrat est ex√©cutable.  Et la principale caract√©ristique de l'approche est que les exigences pour le comportement de l'API vont en <b>amont</b> , du client au serveur. <br><br>  Le contrat se concentre sur le comportement qui compte <strong>vraiment</strong> pour le consommateur.  Rend ses hypoth√®ses sur l'API explicites. <br><br>  L'objectif principal du CDC est d'apporter une compr√©hension du comportement de l'API √† ses d√©veloppeurs et aux d√©veloppeurs de ses clients.  Cette approche est bien combin√©e avec BDD, lors de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©unions de trois amigo,</a> vous pouvez esquisser les blancs pour le contrat.  En fin de compte, ce contrat sert √©galement √† am√©liorer les communications;  partager une compr√©hension commune de la probl√©matique et mettre en ≈ìuvre la solution au sein et entre les √©quipes. <br><br><h2>  Pacte </h2><br>  Envisagez d'utiliser CDC comme exemple de Pact, l'une de ses impl√©mentations.  Supposons que nous cr√©ons une application Web pour les participants √† la conf√©rence.  Dans la prochaine it√©ration, l'√©quipe √©labore un calendrier de pr√©sentation - jusqu'√† pr√©sent sans histoires comme le vote ou les notes, uniquement la sortie de la grille des rapports.  Le code source de l'exemple est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Lors d'une r√©union de <s>trois</s> quatre amigo, un produit, un testeur, les d√©veloppeurs du backend et une application mobile se rencontrent.  Ils disent que <br><br><ul><li>  Une liste avec le texte sera affich√©e dans l'interface utilisateur: titre du rapport + conf√©renciers + date et heure. </li><li>  Pour ce faire, le backend doit renvoyer des donn√©es comme dans l'exemple ci-dessous. </li></ul><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"talks"</span></span>:[ { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"      "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"speakers"</span></span>:[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">" "</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-05-27T12:00:00+03:00"</span></span> } ] }</code> </pre> <br>  Apr√®s quoi le d√©veloppeur frontend va √©crire le code client (backend pour frontend).  Il installe une biblioth√®que de contrats de pacte dans le projet: <br><br><pre> <code class="bash hljs">yarn add --dev @pact-foundation/pact</code> </pre> <br>  Et commence √† √©crire un test.  Il configure le serveur de stub local, qui simulera le service avec des planifications de rapports: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> provider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pact({ <span class="hljs-comment"><span class="hljs-comment">//      consumer: "schedule-consumer", provider: "schedule-producer", // ,     port: pactServerPort, //  pact     log: path.resolve(process.cwd(), "logs", "pact.log"), // ,     dir: path.resolve(process.cwd(), "pacts"), logLevel: "WARN", //  DSL  spec: 2 });</span></span></code> </pre> <br>  Le contrat est un fichier JSON qui d√©crit les sc√©narios d'interaction du client avec le service.  Mais vous n'avez pas besoin de le d√©crire manuellement, car il est form√© √† partir des param√®tres du stub dans le code.  Le d√©veloppeur avant le test d√©crit le comportement suivant. <br><br><pre> <code class="javascript hljs">provider.setup().then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> provider .addInteraction({ <span class="hljs-attr"><span class="hljs-attr">uponReceiving</span></span>: <span class="hljs-string"><span class="hljs-string">"a request for schedule"</span></span>, <span class="hljs-attr"><span class="hljs-attr">withRequest</span></span>: { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">"/schedule"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">willRespondWith</span></span>: { <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json;charset=UTF-8"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: { <span class="hljs-attr"><span class="hljs-attr">talks</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"      "</span></span>, <span class="hljs-attr"><span class="hljs-attr">speakers</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-05-27T12:00:00+03:00"</span></span> } ] } } }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> done()) );</code> </pre> <br>  Ici, dans l'exemple, nous avons sp√©cifi√© la demande de service attendue sp√©cifique, mais pact-js prend √©galement en charge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plusieurs m√©thodes pour d√©terminer les correspondances</a> . <br><br>  Enfin, le programmeur √©crit un test de la partie du code qui utilise ce stub.  Dans l'exemple suivant, nous l'appellerons directement pour plus de simplicit√©. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"fetches schedule"</span></span>, done =&gt; { fetch(<span class="hljs-string"><span class="hljs-string">`http://localhost:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${pactServerPort}</span></span></span><span class="hljs-string">/schedule`</span></span>) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> response.json()) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">json</span></span></span><span class="hljs-function"> =&gt;</span></span> expect(json).toStrictEqual({ <span class="hljs-attr"><span class="hljs-attr">talks</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"      "</span></span>, <span class="hljs-attr"><span class="hljs-attr">speakers</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-05-27T12:00:00+03:00"</span></span> } ] })) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> done()); });</code> </pre> <br>  Dans un projet r√©el, cela peut √™tre soit un test unitaire rapide d'une fonction d'interpr√©tation de r√©ponse distincte, soit un test d'interface utilisateur lent pour afficher les donn√©es re√ßues d'un service. <br><br>  Pendant le test, pact v√©rifie que le stub a re√ßu la demande sp√©cifi√©e dans les tests.  Les √©carts peuvent √™tre consid√©r√©s comme diff√©rents dans le fichier pact.log. <br><br><pre> <code class="plaintext hljs">E, [2019-05-21T01:01:55.810194 #78394] ERROR -- : Diff with interaction: "a request for schedule" Diff -------------------------------------- Key: - is expected + is actual Matching keys and values are not shown { "headers": { - "Accept": "application/json" + "Accept": "*/*" } } Description of differences -------------------------------------- * Expected "application/json" but got "*/*" at $.headers.Accept</code> </pre> <br><br>  Si le test r√©ussit, un contrat est g√©n√©r√© au format JSON.  Il d√©crit le comportement attendu de l'API. <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"consumer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"schedule-consumer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"provider"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"schedule-producer"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"interactions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"a request for schedule"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"/schedule"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"headers"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Accept"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"response"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-attr"><span class="hljs-attr">"headers"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json;charset=UTF-8"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"talks"</span></span>:[ { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"      "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"speakers"</span></span>:[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">" "</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-05-27T12:00:00+03:00"</span></span> } ] }}} ], <span class="hljs-attr"><span class="hljs-attr">"metadata"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"pactSpecification"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0.0"</span></span> } } }</code> </pre> <br>  Il donne ce contrat au d√©veloppeur backend.  Disons que l'API est sur Spring Boot.  Pact poss√®de une biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pact-jvm-provider-spring</a> qui peut fonctionner avec MockMVC.  Mais nous allons jeter un ≈ìil au Spring Cloud Contract, qui impl√©mente CDC dans l'√©cosyst√®me Spring.  Il utilise son propre format de contrats, mais dispose √©galement d'un point d'extension pour connecter des convertisseurs d'autres formats.  Son format de contrat natif n'est pris en charge que par le contrat Spring Cloud lui-m√™me - contrairement √† Pact, qui poss√®de des biblioth√®ques pour JVM, Ruby, JS, Go, Python, etc. <br><br>  Supposons, dans notre exemple, que le d√©veloppeur principal utilise Gradle pour cr√©er le service.  Il connecte les d√©pendances suivantes: <br><br><pre> <code class="plaintext hljs">buildscript { // ... dependencies { classpath "org.springframework.cloud:spring-cloud-contract-pact:2.1.1.RELEASE" } } plugins { id "org.springframework.cloud.contract" version "2.1.1.RELEASE" // ... } // ... dependencies { // ... testImplementation 'org.springframework.cloud:spring-cloud-starter-contract-verifier' }</code> </pre> <br>  Et il place le contrat Pact re√ßu du soumissionnaire dans le r√©pertoire <code>src/test/resources/contracts</code> . <br><br>  Par d√©faut, le plugin Spring-Cloud-Contract soustrait les contrats.  Pendant l'assemblage, la t√¢che Gradle generateContractTests est ex√©cut√©e, ce qui g√©n√®re le test suivant dans le r√©pertoire build / generated-test-sources. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContractVerifierTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContractsBaseTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate_aggregator_client_aggregator_service</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// given: MockMvcRequestSpecification request = given() .header("Accept", "application/json"); // when: ResponseOptions response = given().spec(request) .get("/scheduler"); // then: assertThat(response.statusCode()).isEqualTo(200); assertThat(response.header("Content-Type")).isEqualTo("application/json;charset=UTF-8"); // and: DocumentContext parsedJson = JsonPath.parse(response.getBody().asString()); assertThatJson(parsedJson).array("['talks']").array("['speakers']").contains("['name']").isEqualTo( /*...*/ ); assertThatJson(parsedJson).array("['talks']").contains("['time']").isEqualTo( /*...*/ ); assertThatJson(parsedJson).array("['talks']").contains("['title']").isEqualTo( /*...*/ ); } }</span></span></code> </pre> <br><br>  Au d√©marrage de ce test, nous verrons une erreur: <br><br><pre> <code class="plaintext hljs">java.lang.IllegalStateException: You haven't configured a MockMVC instance. You can do this statically</code> </pre> <br>  Comme nous pouvons utiliser diff√©rents outils pour les tests, nous devons indiquer au plug-in celui que nous avons configur√©.  Cela se fait via la classe de base, qui h√©ritera des tests g√©n√©r√©s par les contrats. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContractsBaseTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ScheduleController scheduleController = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScheduleController(); <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RestAssuredMockMvc.standaloneSetup(scheduleController); } }</code> </pre> <br><br>  Pour utiliser cette classe de base lors de la g√©n√©ration, vous devez configurer le plugin gradle Spring-Cloud-Contract. <br><br><pre> <code class="plaintext hljs">contracts { baseClassForTests = 'ru.example.schedule.ContractsBaseTest' }</code> </pre> <br><br>  Maintenant, nous avons g√©n√©r√© le test suivant: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContractVerifierTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContractsBaseTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate_aggregator_client_aggregator_service</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre> <br>  Le test d√©marre correctement, mais √©choue avec une erreur de v√©rification - le d√©veloppeur n'a pas encore √©crit l'impl√©mentation du service.  Mais maintenant, il peut le faire sur la base d'un contrat.  Il peut s‚Äôassurer qu‚Äôil est en mesure de traiter la demande du client et de renvoyer la r√©ponse attendue. <br><br>  Le d√©veloppeur de services sait par le contrat ce qu'il doit faire, quel comportement mettre en ≈ìuvre. <br><br>  Le pacte peut √™tre int√©gr√© plus profond√©ment dans le processus de d√©veloppement.  Vous pouvez d√©ployer un courtier Pact qui regroupe ces contrats, prend en charge leur versioning et peut afficher un graphique de d√©pendance. <br><br><img src="https://habrastorage.org/webt/dq/pd/v0/dqpdv0c4qk89kboewjxrafys1iq.png"><br><br>  Le t√©l√©chargement d'un nouveau contrat g√©n√©r√© vers le courtier peut √™tre effectu√© √† l'√©tape CI lors de la cr√©ation du client.  Et dans le code du serveur, indiquez le chargement dynamique du contrat par URL.  Spring Cloud Contract prend √©galement cela en charge. <br><br><h2>  Applicabilit√© CDC </h2><br>  Quelles sont les limites des contrats ax√©s sur le consommateur? <br><br>  Pour utiliser cette approche, <b>vous devez payer avec des outils suppl√©mentaires</b> comme le pacte.  Les contrats en soi sont un artefact suppl√©mentaire, une autre abstraction qui doit √™tre soigneusement entretenue et appliqu√©e consciemment des pratiques d'ing√©nierie. <br><br>  <b>Ils ne remplacent pas les tests e2e</b> , car les <b>stubs</b> restent des stubs - des mod√®les de composants syst√®me r√©els, qui peuvent √™tre un peu, mais ne correspondent pas √† la r√©alit√©.  Gr√¢ce √† eux, les sc√©narios complexes ne peuvent pas √™tre v√©rifi√©s. <br><br>  De plus, les <b>CDC ne remplacent pas les tests fonctionnels de l'API</b> .  Ils sont plus co√ªteux √† g√©rer que les tests unitaires simples anciens.  Les d√©veloppeurs de Pact recommandent d'utiliser les heuristiques suivantes - si vous supprimez le contrat et que cela ne provoque pas d'erreurs ou d'interpr√©tation erron√©e par le client, cela n'est pas n√©cessaire.  Par exemple, il n'est pas n√©cessaire de d√©crire absolument tous les codes d'erreur API via un contrat si le client les traite de la m√™me mani√®re.  En d'autres termes, le contrat ne d√©crit pour le service <strong>que ce qui est important pour son client</strong> .  Pas plus, mais pas moins. <br><br>  Trop de contrats compliquent √©galement l'√©volution de l'API.  <b>Chaque contrat suppl√©mentaire est l'occasion de tests rouges</b> .  Il est n√©cessaire de concevoir un CDC de telle mani√®re que chaque test d'√©chec porte une charge s√©mantique utile qui l'emporte sur le co√ªt de son support.  Par exemple, si le contrat fixe la longueur minimale d'un certain champ de texte indiff√©rent au consommateur (il utilise la technique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Toleran Reader</a> ), chaque modification de cette valeur minimale rompra le contrat et les nerfs de ceux qui l'entourent.  Une telle v√©rification doit √™tre transf√©r√©e au niveau de l'API elle-m√™me et impl√©ment√©e en fonction de la source des restrictions. <br><br><h2>  Conclusion </h2><br>  CDC am√©liore la qualit√© du produit en d√©crivant explicitement le comportement d'int√©gration.  Il aide les clients et les d√©veloppeurs de services √† parvenir √† une compr√©hension commune, vous permet de parler de code.  Mais cela se fait au prix de l'ajout d'outils, de l'introduction de nouvelles abstractions et d'actions suppl√©mentaires des membres de l'√©quipe. <br><br>  Dans le m√™me temps, les outils et frameworks CDC sont activement d√©velopp√©s et sont d√©j√† arriv√©s √† maturit√© pour tester vos projets.  Test :) <br><br><blockquote>  Lors de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">QualityConf</a> du 27 au 28 mai, Andrei Markelov <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parlera</a> des techniques de test sur prod, et Arthur Khineltsev parlera <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de la surveillance d'un</a> front-end tr√®s charg√©, alors que le prix d'une petite erreur est de dizaines de milliers d'utilisateurs tristes. <br><br>  Venez discuter pour la qualit√©! </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452960/">https://habr.com/ru/post/fr452960/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452946/index.html">Relire la ¬´philosophie de programmation de Windows 95 / NT¬ª de Lou Greenaw</a></li>
<li><a href="../fr452952/index.html">Journ√©e portes ouvertes JetBrains √† Saint-P√©tersbourg</a></li>
<li><a href="../fr452954/index.html">Temps de construction, vitesse du r√©seau et routage: comment nous avons am√©lior√© notre r√©seau maill√© et un peu sur les r√©seaux de neurones</a></li>
<li><a href="../fr452956/index.html">R√©f√©rence de consommation de CPU pour Istio et Linkerd</a></li>
<li><a href="../fr452958/index.html">JMAP - un protocole ouvert remplace IMAP lors de l'√©change de courriels</a></li>
<li><a href="../fr452962/index.html">La principale cause d'accidents dans les centres de donn√©es est la pose entre l'ordinateur et le fauteuil</a></li>
<li><a href="../fr452964/index.html">Une explication abordable de l'hypoth√®se de Riemann</a></li>
<li><a href="../fr452966/index.html">Le mythe de la pleine conscience: une vision ¬´neurocentrique¬ª de la m√©ditation</a></li>
<li><a href="../fr452968/index.html">Index dans PostgreSQL - 10 (Bloom)</a></li>
<li><a href="../fr452974/index.html">Programmation asynchrone (cours complet)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>