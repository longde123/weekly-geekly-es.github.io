<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéâ üöΩ üì∞ Usando los controladores UDB PSoC de Cypress para reducir las interrupciones en una impresora 3D üñºÔ∏è üíÜüèæ üë©üèº‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En los comentarios sobre la traducci√≥n de documentaci√≥n patentada en UDB, se observ√≥ correctamente que los hechos simples no contribuyen a la comprens...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando los controladores UDB PSoC de Cypress para reducir las interrupciones en una impresora 3D</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433800/"><img src="https://habrastorage.org/webt/8h/et/xb/8hetxbp_jjuad07ws86ov24ch-c.jpeg"><br><br>  En los comentarios sobre la traducci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n patentada en UDB,</a> se observ√≥ correctamente que los hechos simples no contribuyen a la comprensi√≥n del material.  Pero ese documento contiene precisamente los hechos secos.  Para diluirlos con la pr√°ctica, tomemos un descanso de la traducci√≥n.  Volteemos este bloque en nuestras manos y veamos qu√© y c√≥mo se puede lograr en la pr√°ctica. <br><a name="habracut"></a><br><h2>  Larga introducci√≥n </h2><br>  Este art√≠culo es la segunda parte de la trilog√≠a concebida.  La primera parte se encuentra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> (control de LED RGB a trav√©s de la unidad de microcontrolador Cypress UDB PSoC). <br><br>  Adem√°s de los controladores UDB PSoC de Cypress, donde se implementan ciertas interfaces en ellos, ser√≠a interesante comprobar c√≥mo estos bloques pueden facilitar la vida de los programadores al descargar el procesador central de ciertas tareas que requieren muchos recursos.  Pero para aclarar lo que voy a hacer, tengo que escribir un extenso prefacio. <br><br>  En el oto√±o de 2015, compr√© una nueva impresora 3D MZ3D, y para la primavera de 2016 estaba cansada de c√≥mo sacud√≠an sus motores paso a paso.  Los tiempos eran salvajes, sobrevivimos lo mejor que pudimos, por lo que la √∫nica soluci√≥n era pasar del microstep 1/16 a 1/32.  La correspondencia con la f√°brica mostr√≥ que esto no es posible en Arduino.  Al final result√≥ que hab√≠a una restricci√≥n en el "firmware" de esos a√±os, con una frecuencia de paso superior a 10 KHz, no se tomaron pasos virtuales, sino dos pasos virtuales, de lo contrario el sistema simplemente no ten√≠a suficiente tiempo para procesar todas las interrupciones de "paso".  Solo hab√≠a una salida: arrastrar todo a la plataforma ARM.  Fue una operaci√≥n de arrastrar y soltar, no una descarga, ya que tampoco hab√≠a soluciones ARM preparadas en ese momento.  En un par de semanas transfer√≠ todo esto a STM32F4, el sonido de los motores se volvi√≥ m√°s agradable, el problema se resolvi√≥. <br><br>  Luego, el desarrollo del sistema operativo comenz√≥ en nuestra empresa, y en las reuniones tuve que demostrar durante mucho tiempo que el enfoque t√≠pico para las interrupciones de procesamiento no siempre es aceptable en t√©rminos de velocidad, apelando solo a ese caso t√≠pico, pero muy glot√≥n.  Las discusiones sobre este tema se publican en mi art√≠culo sobre las interrupciones en el sistema operativo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> (Descripci√≥n general de un RTOS ruso, parte 8. Trabajar con interrupciones).  En general, un problema se ha resuelto en mi cabeza durante mucho tiempo: las interrupciones auxiliares frecuentes que sirven a un subsistema ralentizan todo lo dem√°s.  El refinamiento simple del procesador central, por supuesto, elimina el problema, pero no trae la Satisfacci√≥n Moral Profunda de que todo est√© bien hecho. <br><br>  Peri√≥dicamente, volv√≠ a esta pregunta en un sentido puramente te√≥rico.  Por ejemplo, un d√≠a se me ocurri√≥ la idea de que en lugar de usar un controlador costoso, puede tomar tres STM32F103C8T6, en el que una placa de prueba ya hecha cuesta 110 rublos, teniendo en cuenta la entrega, y el chip en s√≠ es a√∫n m√°s barato.  En uno de ellos para sacar solo la funci√≥n de control del motor.  Perm√≠tale gastar toda su potencia inform√°tica en esta funci√≥n.  Un par de los otros (tal vez incluso uno) resuelve otras tareas (procesar comandos, trabajar con PWM, mantener la temperatura, etc.) en un ambiente tranquilo.  Esta soluci√≥n tambi√©n tiene una gran ventaja adicional: el n√∫mero total de pines para varios controladores es simplemente enorme.  En un STM32, tuve que dise√±ar solitario durante mucho tiempo, a qu√© pierna asignar.  Aunque las patas de las salidas del temporizador y las patas ADC de los BRAZOS se asignan de manera m√°s flexible que los controladores antiguos (una salida de la unidad de hardware puede ir a una de las varias patas f√≠sicas), pero al desplegar el solitario, comprende que la flexibilidad puede no ser suficiente.  Si hay muchos controladores, entonces la elecci√≥n aumenta.  En el que sirve a motores paso a paso, en general, simplemente asignamos todas las patas como salidas digitales.  Los otros tambi√©n tienen d√≥nde dar la vuelta. <br><br>  Un problema con este enfoque es c√≥mo sincronizar estos controladores.  En teor√≠a, el MAX Max RTOS contiene todo lo que necesita.  El controlador de comandos genera una lista de tareas para mover cabezas.  Peri√≥dicamente, los modifica (coordinando aceleraciones con tareas reci√©n llegadas).  Por lo tanto, la memoria para el formador y el artista debe ser compartida.  RTOS MAX contiene la funcionalidad para organizar dicha memoria compartida.  Lo describ√≠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> (Descripci√≥n general de un RTOS ruso, parte 7. Medios de intercambio de datos entre tareas).  Pero en la pr√°ctica, un matiz arruina todo: el mantenimiento de motores paso a paso es un tipo de tarea de tiempo cr√≠tico.  El menor retraso, y obtenemos flujos de pl√°stico para una impresora 3D, para otras m√°quinas CNC, bueno, por ejemplo, hilos incorrectamente roscados.  Cualquier comunicaci√≥n a trav√©s de interfaces seriales no es la m√°s r√°pida.  Adem√°s: tiempo de arbitraje y otras necesidades oficiales.  Y resulta que todas las ganancias de la eliminaci√≥n de la funcionalidad del procesador principal se destinan a gastos generales.  Por supuesto, aprovech√© mi posici√≥n oficial: fui y discut√≠ este problema con los desarrolladores de este subsistema.  Por desgracia  Dijeron que hay sincronizaci√≥n sin demasiada sobrecarga en el sistema operativo, pero para equipos que admiten los buses correspondientes.  Ahora, si tomo la arquitectura TigerShark como base, el sistema operativo organizar√° todo por m√≠ sin ning√∫n gasto.  Solo los controladores fabricados de acuerdo con esta arquitectura son varias veces m√°s caros que toda la impresora 3D que quer√≠a poner en ella.  En general, nuevamente inaceptable. <br><br>  Nos acercamos al final de una introducci√≥n prolongada.  Alguien dir√° que por alguna raz√≥n todav√≠a estoy buscando un pr√≠ncipe en un caballo blanco.  Puede tomar y hacer todo sin un sistema operativo, y aqu√≠ estoy considerando todo tipo de opciones ... Puede, pero puede, pero cuando surgi√≥ el problema pr√°ctico "Cansado de escuchar el bloqueo de la impresora", se solucion√≥ r√°pidamente.  Eso es todo.  Ella ya no est√°.  Adem√°s, desde entonces han aparecido nuevos controladores de motor paso a paso que generalmente resuelven el problema de una manera completamente diferente (obtienen un microstep de 1/16 y dan 1/256).  Y en esta introducci√≥n, describo precisamente que "No hay <b>una</b> soluci√≥n <b>hermosa</b> al problema de las interrupciones frecuentes".  Hace mucho que se tom√≥ una decisi√≥n fea.  No quer√≠a perder el tiempo revisando otras decisiones feas.  Simplemente se desplazaron en mi cabeza. <br><br>  Pero cuando me ocup√© de los bloques UDB, me pareci√≥ que el problema se puede resolver de manera hermosa y dram√°tica.  Simplemente puede llevar el procesamiento de interrupciones desde el software al nivel de firmware, dejando la parte inform√°tica en la conciencia del procesador principal.  ¬°No se necesitan controladores adicionales!  ¬°Todo se coloca en el mismo chip!  Entonces, comencemos. <br><br><h2>  Caballo esf√©rico en el vac√≠o </h2><br>  En este art√≠culo, trabajar con UDB estar√° a la vanguardia.  Si hablara de estar atado a un "firmware" espec√≠fico, podr√≠an se√±alarme correctamente que estaba equivocado con el concentrador.  ¬øQu√© es para GeekTimes?  Por lo tanto, UDB es primario, y los motores paso a paso son solo una cosa hermosa para ilustrar.  En esta parte, generalmente har√© un caballo esf√©rico en el vac√≠o.  Tendr√° deficiencias pr√°cticas, que eliminar√© en la segunda parte.  Pero repitiendo mis acciones, los lectores podr√°n dominar la metodolog√≠a de desarrollo de firmware para UDB. <br><br>  Entonces  ¬øC√≥mo funciona el mecanismo de control del motor paso a paso?  Hay una tarea que pone en l√≠nea los segmentos que la cabeza debe pasar con velocidad lineal.  Hasta ahora, pretender√© no recordar la aceleraci√≥n al principio y al final del segmento.  Solo la cabeza deber√≠a pasar.  Nuevos segmentos se ponen en la cola de la cola.  Basado en la grabaci√≥n de la cabeza, una tarea separada env√≠a se√±ales <b>STEP</b> a todos los motores activos. <br><br>  Deje que la impresora tenga una velocidad m√°xima del cabezal de 200 mm / s.  Deje 200 pasos necesarios por 1 mil√≠metro de movimiento (esta cifra corresponde a una impresora real MZ3D-256C con un micropaso 1/32).  Luego, los pulsos se deben suministrar con una frecuencia de hasta 200 * 200 = 40,000 Hz = 40 KHz.  Es con tal frecuencia que una tarea que env√≠a pulsos de paso puede ser invocada.  Debe formar los pulsos mediante programaci√≥n, y tambi√©n calcular cu√°nto tiempo despu√©s de lo cual debe llamarse la pr√≥xima interrupci√≥n que lo active. <br><br>  Recuerdo una broma sobre Kolobok y los Tres Bogatyrs, donde Kolobok saludaba constantemente a los Bogatyrs, luego les hac√≠a preguntas y recib√≠a respuestas.  Luego sucesivamente se despidi√≥ de ellos.  Bueno, entonces se reuni√≥ con los Treinta y tres Caballeros.  El procesador est√° en el papel de un bollo, y los motores paso a paso est√°n en el papel de Bogatyrs.  Est√° claro que en presencia de una gran cantidad de bloques UDB, es posible paralelizar el trabajo con los motores, haciendo que cada motor sea reparado a su bloque.  Y dado que tenemos segmentos durante los cuales los motores se mover√°n de manera uniforme, intentemos que el equipo funcione con tales transacciones, y no con cada paso. <br><br>  ¬øQu√© informaci√≥n se requiere para que un caballo esf√©rico atraviese una secci√≥n lineal en el vac√≠o? <br><br><ul><li>  Numero de pasos. </li><li>  El per√≠odo de tiempo entre pasos. </li></ul><br>  Dos par√°metros  UDB solo tiene dos bater√≠as y dos registros de par√°metros D0 y D1.  Parece que todo es realizable.  Solo estimamos la profundidad de bits que deber√≠an tener estos registros. <br><br>  Primero, el n√∫mero de pasos.  Si hay 8 d√≠gitos, entonces, en un ciclo de operaci√≥n UDB, la impresora podr√° mover el cabezal de la impresora cartesiana un poco m√°s de 1 mm (200 micro pasos).  No es suficiente  Si la capacidad es de 16 bits, el n√∫mero de pasos ser√° 65536. Esto es 65536/200 = 327 mil√≠metros.  Aceptable para la mayor√≠a de los modelos.  Para Core, Delta y otros es necesario estimar, pero en su conjunto, para un trazo completo, el segmento se puede dividir en varias partes.  No habr√° tantos (dos, bueno, un m√°ximo de tres). <br><br>  Ahora el periodo.  Deje que la frecuencia del reloj sea de 48 MHz.  48000000/65536 = 732.  Es decir, la frecuencia m√≠nima permitida que se puede obtener con un divisor de 16 bits es de 732 Hz.  Demasiado  En el firmware Marlin, el m√≠nimo es de 120 Hz (que corresponde aproximadamente a 8 MHz dividido por la misma constante 65536).  Tendremos que hacer los registros de 24 bits.  Entonces la frecuencia m√≠nima ser√° igual a 48000000 / (2 ^ 24) = 48000000/16777216 = 2.861 Hz. <br><br>  Bueno  ¬°Alto a la aburrida teor√≠a!  ¬°Pasemos a practicar!  Inicie PSoC Creator y seleccione Archivo-&gt; Nuevo-&gt; Proyecto: <br><br><img src="https://habrastorage.org/webt/tk/9t/bj/tk9tbjfppfjemih3s-ydrk54lfc.png"><br><br>  Luego, seleccion√© la placa de prueba que tengo, de la cual el entorno tomar√° informaci√≥n b√°sica sobre el controlador utilizado y su configuraci√≥n: <br><br><img src="https://habrastorage.org/webt/dv/st/hi/dvsthib82j6ynrdxc0sk-5j20nk.png"><br><br>  Ya me siento listo para crear un proyecto desde cero, as√≠ que selecciono <b>Esquema vac√≠o</b> : <br><br><img src="https://habrastorage.org/webt/oi/fx/vv/oifxvvsf0qye7j-mdyoxmbfux4q.png"><br><br>  D√© al entorno de trabajo el nombre <b>PSoC3DTest</b> : <br><br><img src="https://habrastorage.org/webt/rr/0u/pd/rr0updtyevaseusbwel37v76bgc.png"><br><br>  Y aqu√≠ est√°, ¬°un proyecto terminado! <br><br><img src="https://habrastorage.org/webt/fw/0s/xu/fw0sxucryznmujjsvr5ockarrjc.png"><br><br>  Lo primero que quiero hacer es crear mi propio componente basado en UDB.  Por lo tanto, como ya se se√±al√≥ en el √∫ltimo art√≠culo, necesito cambiar a la pesta√±a <b>Componentes</b> : <br><br><img src="https://habrastorage.org/webt/oa/o8/s5/oao8s5whrsdn9xsnophfoaom_n4.png"><br><br>  Haga clic derecho en el proyecto y seleccione <b>Agregar elemento componente</b> : <br><br><img src="https://habrastorage.org/webt/zq/kt/hu/zqkthur3pa19fpcrq4kcrmdac_y.png"><br><br>  Decimos que necesitamos agregar un <b>documento UDB</b> , cambiar el nombre a <b>StepperController</b> y hacer clic en <b>Crear nuevo</b> : <br><br><img src="https://habrastorage.org/webt/tz/v8/qk/tzv8qkfqumypnq3ctjeh9moitpc.png"><br><br>  El componente apareci√≥ en el √°rbol, adem√°s, el editor de este componente abri√≥: <br><br><img src="https://habrastorage.org/webt/yo/4g/np/yo4gnpvs5fuewpovam09lbq3zmw.png"><br><br>  Coloque el bloque Datapath en el formulario: <br><br><img src="https://habrastorage.org/webt/nx/1o/bl/nx1oblbig1eqyqat0yj-evlvwo0.png"><br><br>  Una vez seleccionado este bloque, vamos a sus propiedades y cambiamos la profundidad de bits de 8 a 24. Los par√°metros restantes pueden dejarse sin cambios. <br><br><img src="https://habrastorage.org/webt/1e/oq/rf/1eoqrfsjz5uh1fj2mopwtmf5vao.png"><br><br>  Para iniciar todos los bloques (para todos los motores) al mismo tiempo, iniciar√© la se√±al de inicio desde el exterior (agregue la entrada de <b>Inicio</b> ).  Salidas: Har√© que <b>Step</b> salga directamente, para poder enviarlo al controlador del motor paso a paso, as√≠ como a <b>Out_Idle</b> .  Seg√∫n esta se√±al, el procesador podr√° determinar que en el momento en que la unidad haya terminado su trabajo.  Los nombres de los circuitos que coinciden con estas entradas y salidas son visibles en la figura. <br><br><img src="https://habrastorage.org/webt/sx/xq/gv/sxxqgvsyvpyr_jvzdblaf_l1soc.png"><br><br>  Antes de hablar sobre la l√≥gica del aut√≥mata, describir√© otro problema puramente de ingenier√≠a: establecer la duraci√≥n del pulso <b>Paso</b> .  La documentaci√≥n del controlador DRV8825 requiere que el ancho de pulso sea de al menos 1.9 Œºs.  Otros conductores son menos exigentes en su ancho.  Como ya se se√±al√≥ en la parte te√≥rica, los registros existentes ya est√°n ocupados estableciendo la duraci√≥n del paso y el n√∫mero de pasos.  Nos guste o no, se debe colocar un contador de siete bits en el circuito.  Lo llamamos one-shot, que establece el pulso de paso.  A una frecuencia de 48 MHz, para garantizar una duraci√≥n de 1.9 Œºs, este contador debe contar al menos 91.2 pasos.  Redondea a 92. Cualquier valor que exceda esto no ser√° menor.  Resulta la siguiente configuraci√≥n: <br><br><img src="https://habrastorage.org/webt/6w/k9/em/6wk9emz-qedseywswmgk24bdjqe.png"><br><br>  Nombre del contador <b>SingleVibrator</b> .  Nunca se restablece, por lo que la entrada <b>Restablecer</b> siempre est√° conectada a cero, considera que cuando la m√°quina (descrita a continuaci√≥n) est√° en el estado Uno, se carga en todos los dem√°s estados (al principio seleccion√© los estados espec√≠ficos de la m√°quina, pero result√≥ que con un m√©todo tan complicado , se requieren muchos menos recursos PLD, pero el resultado es el mismo).  El valor de carga es decimal 92. Es cierto, un buen editor reemplazar√° inmediatamente este valor con hexadecimal: <br><br><img src="https://habrastorage.org/webt/qt/h0/nv/qth0nvcbb_8m7qty2mj1zpde2m4.png"><br><br>  Cuando el contador se cuenta hasta cero, informar√° esto a la cadena con el nombre <b>One_Finished</b> .  Con el mostrador, eso es todo. <br><br>  ¬øQu√© tipo de indicadores de estado utilizar√° nuestra m√°quina?  Lo tengo as√≠ (le recuerdo que haga doble clic en la lista de salidas en Datapath para configurarlas): <br><br><img src="https://habrastorage.org/webt/mk/oo/z_/mkooz_ywbi5vnaenpgfqo98p580.png"><br><br><img src="https://habrastorage.org/webt/br/u9/rz/bru9rzw4kk4ja4j6ehutvm7od14.png"><br><br>  Usar√© la bater√≠a A0 como contador durante la duraci√≥n del pulso, por lo que cuando su valor llegue a cero, se <b>activar√°</b> la bandera a la que le di el nombre <b>Pulse_Finished</b> .  La bater√≠a A1 contar√° pulsos para m√≠.  Por lo tanto, su <b>puesta a</b> cero activar√° la bandera <b>Process_Finished</b> . <br><br>  Construimos el gr√°fico de transici√≥n del aut√≥mata: <br><br><img src="https://habrastorage.org/webt/bv/rr/cv/bvrrcv0pgjs9fvadt08iyqaj92i.png"><br><br>  La variable que establece su estado se llama <b>Estado</b> .  Asigne inmediatamente esta variable al registro de direcci√≥n de la instrucci√≥n ALU.  Al principio olvid√© hacer esto, as√≠ que durante mucho tiempo no pude entender por qu√© mi m√°quina no funciona.  Haga doble clic en el bloque de entradas en Datapath: <br><br><img src="https://habrastorage.org/webt/zl/z2/e0/zlz2e0tvkl11wc5ot0id4vsdnh4.png"><br><br>  Y partido: <br><br><img src="https://habrastorage.org/webt/1e/sp/q1/1espq1co36mt063kgyvig-kzhsw.png"><br><br>  Comenzamos a tratar con el gr√°fico de transici√≥n y las instrucciones ALU asociadas con √©l. <br><br>  Comencemos con el estado <b>inactivo</b> .  Est√° bastante saturado en sus acciones. <br><br>  En primer lugar, el valor de los registros de datos D0 y D1 se coloca constantemente en las bater√≠as A0 y A1, respectivamente: <br><br><img src="https://habrastorage.org/webt/hz/8p/c-/hz8pc-lydhvzq3cnvsg2jw2qcem.png"><br><br>  Desde esta entrada, el ojo entrenado ver√° todo lo que necesita.  Como nuestros ojos a√∫n no est√°n establecidos, hacemos doble clic en la entrada y vemos lo mismo, pero con m√°s detalle: <br><br><img src="https://habrastorage.org/webt/yu/yy/qe/yuyyqemtvqbcsp25mbud7y3y1mu.png"><br><br>  El valor principal aqu√≠ es llenar la bater√≠a A1, el contador de pulsos.  Cuando el programa ingresa el valor D1, inmediatamente va a A1.  El programa definitivamente no tendr√° tiempo para comenzar el proceso hasta la pr√≥xima medida.  Este valor se verifica para formar una condici√≥n para salir de este estado, es decir, no hay otro lugar para llenarlo. <br><br>  Ahora veamos qu√© se hace en el nivel del gr√°fico de transici√≥n: <br><br><img src="https://habrastorage.org/webt/97/p-/2d/97p-2dwdvbxyb_tpi-xaqjdhuck.png"><br><br>  El disparador auxiliar <b>Start_Prev le</b> permite capturar un <b>borde</b> positivo en la entrada <b>Start</b> , organizando una l√≠nea de retardo para 1 ciclo.  Siempre contendr√° el estado de la entrada de <b>Inicio</b> , que estaba en la medida anterior.  Alguien est√° m√°s familiarizado con ver esto en Verilog: <br><br><img src="https://habrastorage.org/webt/mm/pc/vw/mmpcvwuturlr5nieqnkgieml_tm.png"><br><br><div class="spoiler">  <b class="spoiler_title">Mismo texto</b> <div class="spoiler_text"><pre><code class="plaintext hljs">always @ (posedge clock) begin : Idle_state_logic case(State) Idle : begin Start_Prev &lt;= (Start); IsIdle &lt;= (1); if (( Start&amp;(!Start_Prev)&amp;(!Process_Finished) ) == 1'b1) begin State &lt;= One ; end end</code> </pre> <br></div></div><br>  En consecuencia, la <b>condici√≥n de Inicio y (! Start_Prev) es</b> verdadera solo cuando se <b>produce una</b> diferencia de l√≠nea de <b>Inicio</b> positiva <b>entre las medidas</b> . <br><br>  Adem√°s, cuando la m√°quina est√° en este estado, la salida <b>IsIdle</b> se <b>pone</b> en un solo estado, informando al entorno externo que el bloque es pasivo.  Con este enfoque, se gastan menos recursos PLD que si la construcci√≥n <b>State == Idle</b> se enviara a la salida. <br><br>  Cuando la diferencia de la se√±al de <b>Inicio</b> proviene del entorno externo, y el acumulador A1 tiene un valor distinto de cero, la m√°quina saldr√° del estado <b>Inactivo</b> .  Si se ingresa cero en A1, entonces el motor no participa en el desarrollo de este segmento, por lo que se ignora la diferencia en la l√≠nea de <b>Inicio</b> .  Esto se aplica a una extrusora no utilizada.  Para algunas impresoras, el motor del eje Z tambi√©n se usa raramente. Perm√≠tanme recordarles c√≥mo se forma una condici√≥n que revela un valor cero en A1 (y su inversi√≥n no es cero): <br><br><img src="https://habrastorage.org/webt/ez/kk/up/ezkkuprcmblrfjx22av9dlfu5bc.png"><br><br>  Luego, la m√°quina ingresa al estado <b>Uno</b> : <br><br><img src="https://habrastorage.org/webt/zr/qc/cm/zrqccmzwghfncwcqyfekuhawmcg.png"><br><br>  En este estado, la salida de <b>paso</b> se establece en 1. Se aplica un impulso de paso al controlador.  Adem√°s, se <b>restablece</b> el valor del desencadenador <b>IsIdle</b> .  Se informa al entorno externo que la unidad est√° en la fase activa. <br><br>  La se√±al <b>One_Finished sale de</b> este estado, que se elevar√° a uno cuando el contador de siete bits cuente a cero.  Perm√≠tame recordarle que la se√±al <b>One_Finished es</b> generada por este contador en particular: <br><br><img src="https://habrastorage.org/webt/ls/yp/re/lsypreow8ydou_tqhrls8us-qem.png"><br><br>  Mientras la m√°quina est√° en este estado, la ALU carga en la bater√≠a A0 (configurando la duraci√≥n del pulso) el valor del registro D0.  D√©jame mostrarte solo una breve nota que dice esto: <br><br><img src="https://habrastorage.org/webt/am/b_/fa/amb_faw1o-9vsgframn5iswseas.png"><br><br>  El valor cargado se usar√° en el siguiente estado.  Al estar en √©l, la m√°quina genera un retraso que establece la duraci√≥n del pulso: <br><br><img src="https://habrastorage.org/webt/hh/eb/kf/hhebkfiwmsmnnrtkf17w2wqby8o.png"><br><br>  La salida del <b>paso</b> se restablece a cero.  La bater√≠a A0 disminuye, como lo demuestra la siguiente breve entrada: <br><br><img src="https://habrastorage.org/webt/bb/63/dk/bb63dkglkjd8_7wn1s2by22_hym.png"><br><br>  Y si hace doble clic en √©l, una entrada completa: <br><br><img src="https://habrastorage.org/webt/-8/6d/ry/-86dryefyslh1qsvlo4ggkdojhg.png"><br><br>  Cuando el valor de A0 llega a cero, se levantar√° el indicador Pules_Finished y la m√°quina pasar√° al estado <b>Decremento</b> : <br><br><img src="https://habrastorage.org/webt/6k/sw/yv/6kswyvakmiszucfe1cx49pjcyig.png"><br><br>  En este estado, en ALU, el valor del acumulador A1 disminuye, lo que establece el n√∫mero de pulsos <br><br><img src="https://habrastorage.org/webt/ci/9r/1e/ci9r1ervyzj1gyma_tpj4uxnzfq.png"><br><br>  Versi√≥n completa del registro: <br><br><img src="https://habrastorage.org/webt/l9/dk/hy/l9dkhy0a6bb2bqpzgmzgtox7clk.png"><br><br>  Dependiendo del resultado, se produce una transici√≥n al siguiente pulso o al estado <b>inactivo</b> .  Haga doble clic en el estado para ver las transiciones teniendo en cuenta las prioridades: <br><br><img src="https://habrastorage.org/webt/jm/r-/7n/jmr-7nle2advdfl95fn8hnkid0i.png"><br><br>  En realidad, con UDB todo.  Ahora hacemos el s√≠mbolo correspondiente.  Para hacer esto, haga clic derecho en el editor y seleccione <b>Generar s√≠mbolo</b> : <br><br><img src="https://habrastorage.org/webt/j6/j3/qc/j6j3qcgoye9-2gac8fgowordfx8.png"><br><br>  Vamos al diagrama del proyecto: <br><br><img src="https://habrastorage.org/webt/ab/hb/l4/abhbl4ocjtfgw8r4vjfo8nfs05c.png"><br><br>  Y presentamos un circuito en el que hay un cierto n√∫mero de estos controladores.  Eleg√≠ cinco (tres ejes m√°s dos extrusoras).  Las impresoras con una gran cantidad de extrusoras no se considerar√°n baratas.  Puedes poner FPGA en ellos.  En el camino, para ver la complejidad real, arroj√© un bloque USB-UART (para recibir datos de una computadora o el mismo Raspberry Pi) y un UART real (proporcionar√° comunicaci√≥n con un m√≥dulo Wi-Fi barato ESP8266 o, por ejemplo, una pantalla inteligente que puede enviar GCODE a trav√©s de UART).  No agregu√© PWM, etc., ya que su complejidad es aproximadamente clara y el sistema real a√∫n est√° muy lejos.  Result√≥ de alguna manera as√≠: <br><br><img src="https://habrastorage.org/webt/he/a6/ok/hea6okfr7irbrzjwm-bze2xlfxy.png"><br><br>  El registro de control genera una se√±al de disparo, que se dirige a todos los bloques simult√°neamente.  Adem√°s, deje que salgan se√±ales, que son est√°ticas durante la formaci√≥n del segmento.  Recopil√© todas las salidas <b>inactivas</b> por "Y" y apliqu√© a la entrada de interrupci√≥n.  Nombr√© una interrupci√≥n en un frente positivo.  Si al menos un motor arranca, la entrada de interrupci√≥n se restablecer√°.  Al final del √∫ltimo motor, se activar√°, lo que informar√° al procesador sobre la preparaci√≥n para la conclusi√≥n del pr√≥ximo segmento.  Ahora ajuste las frecuencias haciendo doble clic en el elemento del √°rbol <b>Clocks</b> : <br><br><img src="https://habrastorage.org/webt/zy/yf/kl/zyyfklrmcfz5kmg-59qmzgdztug.png"><br><br>  En la tabla que aparece, haga doble clic en el elemento <b>PLL_OUT</b> : <br><br><img src="https://habrastorage.org/webt/8z/m0/r1/8zm0r10tu28rjatkhmo1h0skp80.png"><br><br>  Completaremos la tabla de alguna manera (no he entendido bien las reglas para configurar esta tabla, por eso uso el t√©rmino "Algo as√≠"): <br><br><img src="https://habrastorage.org/webt/se/55/ps/se55ps9rti9fyvyguffgxdx0f0i.png"><br><br>  Ahora haga doble clic en la l√≠nea <b>Clock_1</b> : <br><br><img src="https://habrastorage.org/webt/vn/py/px/vnpypxluipgeeme1fyf9icn9tu4.png"><br><br>  Configure la frecuencia de reloj de los bloques UDB a 48 MHz: <br><br><img src="https://habrastorage.org/webt/8z/sk/ik/8zskik6rpyovzo7ryqrxjeptinm.png"><br><br>  Como el proyecto es experimental, no tiene sentido hacer una API.  Pero para consolidar el material estudiado en el art√≠culo anterior, volvemos a la pesta√±a Componentes y para el proyecto StepperController, hacemos clic con el bot√≥n derecho en Agregar elemento componente primero agregamos el archivo de encabezado y luego el archivo de c√≥digo fuente C: <br><br><img src="https://habrastorage.org/webt/3i/bg/zk/3ibgzkq8nugwau5lszhe9ikudxi.png"><br><br><img src="https://habrastorage.org/webt/bm/k3/iw/bmk3iwh-aouvspv20g7_1bgi3wq.png"><br><br>  Mostrar√© superficialmente las dos funciones de inicializaci√≥n e inicio del segmento que agregu√©.  El resto se puede ver en el ejemplo del art√≠culo. <br><br><pre> <code class="plaintext hljs">void `$INSTANCE_NAME`_Start() { `$INSTANCE_NAME`_SingleVibrator_Start(); //"One" Generator start } void `$INSTANCE_NAME`_PrepareStep(int nSteps,int duration) { CY_SET_XTND_REG24(`$INSTANCE_NAME`_Datapath_1_D0_PTR, duration&gt;92?duration-92:0); CY_SET_XTND_REG24(`$INSTANCE_NAME`_Datapath_1_D1_PTR, nSteps&gt;1?nSteps-1:0); }</code> </pre><br>  <b>Reemplac√©</b> el nombre de <b>main.c</b> por <b>main.cpp</b> para verificar que el entorno de desarrollo responder√° normalmente a C ++, porque el firmware de Marlin est√° orientado a objetos.  Errores predecibles de lluvia que fueron eliminados previsiblemente mediante la adici√≥n de algo regular: <br><br><img src="https://habrastorage.org/webt/5m/mn/cd/5mmncdgxig9oxchcekaofuv1k9y.png"><br><br><div class="spoiler">  <b class="spoiler_title">Mismo texto</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">extern "C" { #include "project.h" }</code> </pre><br></div></div><br>  Para el lanzamiento global de motores, hice una funci√≥n de este tipo (es muy dif√≠cil, pero para los experimentos con un caballo esf√©rico en el vac√≠o, lo har√°, en los experimentos el tiempo de desarrollo es m√°s importante que la belleza): <br><pre> <code class="plaintext hljs">void StartSteppers() { Stepper_Control_Reg_Write (1); Stepper_Control_Reg_Write (1); Stepper_Control_Reg_Write (1); Stepper_Control_Reg_Write (0); }</code> </pre><br>  Ella inicia la se√±al de <b>Inicio</b> , por si acaso, inmediatamente por tres medidas, luego la vuelve a soltar. <br><br>  Bueno, comencemos los experimentos.  Primero, simplemente pase por encima de los motores X e Y (en el ejemplo, el primer grupo de llamadas inicializa todos los controladores, el segundo establece los controladores X e Y en el n√∫mero requerido de pasos e inicia el proceso): <br><br><pre> <code class="plaintext hljs">int main(void) { CyGlobalIntEnable; /* Enable global interrupts. */ StepperController_X_Start(); StepperController_Y_Start(); StepperController_Z_Start(); StepperController_E0_Start(); StepperController_E1_Start(); StepperController_X_PrepareStep (10,1000); //    StepperController_Y_PrepareStep (50,500); StartSteppers(); //   for(;;) { } }</code> </pre><br>  Nos fijamos en el resultado: <br><br><img src="https://habrastorage.org/webt/6x/io/v7/6xiov7g15a-ksl1_6kw7vkko0dc.png"><br><br>  Verifique la duraci√≥n del pulso positivo: <br><br><img src="https://habrastorage.org/webt/ay/hk/jy/ayhkjyjphl4-pearn7zi3hnnknc.png"><br><br>  Eso es correcto  Finalmente, verificamos qu√© tan bien funciona la interrupci√≥n.  Agregue una variable de contador global: <br><br><pre> <code class="plaintext hljs">static int nStep=0;</code> </pre><br>  Esta variable se asigna a uno en la funci√≥n <b>principal</b> y aumenta en la funci√≥n de manejo de interrupciones.  El controlador de interrupciones se disparar√° solo una vez, solo para verificaci√≥n.  Lo hice as√≠: <br><br><pre> <code class="plaintext hljs">extern "C" { CY_ISR(StepperFinished) { if (nStep == 1) { StepperController_X_PrepareStep (5,500); StartSteppers(); nStep += 1; } } }</code> </pre><br>  Y en la funci√≥n <b>principal</b> , agregu√© literalmente dos l√≠neas: la inclusi√≥n de interrupciones y la asignaci√≥n de esta muy variable.  Y ya asigno cuando las m√°quinas comenzaron.  De lo contrario, lleg√≥ una solicitud de interrupci√≥n falsa.  No hay ninguna raz√≥n particular para combatirlo ahora.  El proyecto es experimental. <br><br><img src="https://habrastorage.org/webt/kb/v2/dm/kbv2dmk2s6cg9nzc9fjzypg5uyo.png"><br><br><div class="spoiler">  <b class="spoiler_title">Mismo texto</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">int main(void) { CyGlobalIntEnable; /* Enable global interrupts. */ isr_1_StartEx(StepperFinished); StepperController_X_Start(); StepperController_Y_Start(); StepperController_Z_Start(); StepperController_E0_Start(); StepperController_E1_Start(); /* Place your initialization/startup code here (eg MyInst_Start()) */ StepperController_X_PrepareStep (10,1000); StepperController_Y_PrepareStep (20,500); StartSteppers(); nStep = 1; for(;;) { } }</code> </pre><br></div></div><br>  Verificamos el resultado (en el segundo paso, solo el motor X deber√≠a funcionar, y los pasos deber√≠an ser la mitad): <br><br><img src="https://habrastorage.org/webt/0q/vi/iq/0qviiqvpko6m9i7o9tub3gmnqhw.png"><br><br>  Eso es correcto <br><br><h2>  Conclusi√≥n </h2><br>  En general, ya est√° claro que los bloques UDB pueden usarse no solo para configurar funciones r√°pidas de hardware, sino tambi√©n para mover la l√≥gica del software al nivel de firmware.  Desafortunadamente, el volumen del art√≠culo result√≥ ser tan grande que parece imposible completar la revisi√≥n y obtener una respuesta inequ√≠voca si las capacidades de UDB son suficientes para la soluci√≥n final de la tarea.  Hasta ahora, solo un caballo esf√©rico est√° listo en el vac√≠o, cuyas acciones en principio son muy similares a las requeridas, pero un lector molesto familiarizado con la teor√≠a del control del motor paso a paso encontrar√° muchas deficiencias en √©l.  La unidad presentada no es compatible con la aceleraci√≥n, sin la cual el funcionamiento de un motor paso a paso real es imposible.  M√°s bien, es compatible, pero en esta etapa se requerir√° una alta tasa de interrupci√≥n, y todo fue concebido para evitar esto. <br><br>  La precisi√≥n de establecer la frecuencia del bloque presentado est√° lejos de ser aceptable.  En particular, proporcionar√° una frecuencia de pulso de 40,000 Hz con un divisor de 1200 y 39966 Hz con un divisor de 1201. Las frecuencias intermedias entre estos dos valores en esta unidad son inalcanzables. <br><br>  Quiz√°s hay algunas otras deficiencias en √©l.  Pero trataremos con ellos en el pr√≥ximo art√≠culo para verificar si hay suficientes recursos de UDB. <br><br>  Mientras tanto, los lectores han recibido, entre otras cosas, un ejemplo real de crear un bloque basado en UDB desde cero.  El proyecto de prueba obtenido durante la redacci√≥n de este art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se puede tomar aqu√≠</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433800/">https://habr.com/ru/post/es433800/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433788/index.html">Oferta segura y nuevas revisiones independientes</a></li>
<li><a href="../es433790/index.html">Plantillas avanzadas de compilaci√≥n de varias etapas</a></li>
<li><a href="../es433792/index.html">Scripts de shell en Ansible</a></li>
<li><a href="../es433796/index.html">C√≥mo el Homo Sapiens conquist√≥ el mundo. Habilidades de comunicaci√≥n y negociaci√≥n.</a></li>
<li><a href="../es433798/index.html">HomeKit y ioBroker Hagamos amigos en casa</a></li>
<li><a href="../es433802/index.html">C√≥mo y por qu√© ganamos la pista de Big Data en el Hackathon Urban Tech Challenge</a></li>
<li><a href="../es433804/index.html">Redes de densidad de mezclas</a></li>
<li><a href="../es433806/index.html">Cuando el archivo en l√≠nea se olvida</a></li>
<li><a href="../es433808/index.html">5 errores m√°s comunes que cometen los programadores en la entrevista</a></li>
<li><a href="../es433810/index.html">Un enfoque orientado a problemas para proyectos en marketing en Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>