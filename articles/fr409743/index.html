<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§õüèª üìß üÄÑÔ∏è Contr√¥leur DIY de panneau LED sur CPLD utilisant la modulation BAM üñ•Ô∏è üéã üóìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, il a particip√© √† une discussion sur le projet DIY d'une montre √† matrice LED. 
 Et ce qui m'a surpris - l'ancienne matrice LED m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Contr√¥leur DIY de panneau LED sur CPLD utilisant la modulation BAM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409743/">  Il y a quelque temps, il a particip√© √† une discussion sur le projet DIY d'une montre √† matrice LED. <br>  Et ce qui m'a surpris - l'ancienne matrice LED monochromatique 8x8 avec un pas de 5 millim√®tres a √©t√© utilis√©e comme dispositif d'affichage.  De plus, des cartes de circuits imprim√©s complexes ont √©t√© cr√©√©es pour eux, une indication dynamique douce a √©t√© faite.  Et c'est √† un moment o√π les panneaux LED 64x32 polychromes pr√™ts √† l'emploi avec un pas de 3 mm sont disponibles depuis longtemps au prix de 10-20 $.  Et l'assortiment g√©n√©ral de ces panneaux est tr√®s grand et a un pas de pixel de 2 √† 10 mm et presque toutes les tailles. <br><a name="habracut"></a><br>  Dans le m√™me temps, l'utilisation de tels panneaux dans des conceptions de bricolage est assez difficile - les contr√¥leurs pr√™ts √† l'emploi co√ªtent beaucoup d'argent et n'ont pas d'API normale.  Il est assez difficile de faire un scan assez rapide du panneau sur des microcontr√¥leurs couramment utilis√©s en DIY.  De plus, les intervalles de temps doivent √™tre maintenus avec une grande pr√©cision - sinon une in√©galit√© notable de luminosit√© commence. <br><br>  Il existe de bonnes solutions chez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Adafruit</a> , mais elles sont toutes assez co√ªteuses et complexes. <br><br>  Apr√®s r√©flexion, l'id√©e est venue - pourquoi ne pas cr√©er une carte extr√™mement peu co√ªteuse qui sera un pont entre une carte penny ordinaire comme un arduino et un panneau LED?  Apr√®s quelques mois d'agitation, quelque chose de fonctionnel est n√©. <br><br>  Cet article d√©crit la deuxi√®me version am√©lior√©e du contr√¥leur. <br><cut><br><h2>  D√©fi </h2><br>  En tant que t√¢che de base, je voulais pouvoir contr√¥ler un panneau d'une taille totale d'au moins 64x64, tout en ayant la possibilit√© de travailler au moins en Highcolor (RGB565) tout en maintenant un taux de rafra√Æchissement d'√©cran acceptable (au moins 50 Hz).  Dans la premi√®re version du contr√¥leur, la t√¢che de base a √©t√© enti√®rement mise en ≈ìuvre, mais l'id√©e est venue de mettre en ≈ìuvre la t√¢che par une autre m√©thode tr√®s prometteuse, √† partir de laquelle la deuxi√®me version est n√©e. <br><br><h2>  Explication de base de la conception d'un panneau LED typique </h2><br>  Interface d'entr√©e HUB75: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2d/yn/gt/2dyngtqqelfmxsb9iseipe2c29u.jpeg"></div><br>  √Ä chaque entr√©e de couleur, il y a une cha√Æne de registres du type HC595 (mais des versions sp√©ciales √† 16 canaux pour les LED).  Il y a tellement de registres qui sont suffisants pour la largeur du panneau.  Les autorisations de destruction, de d√©marrage parall√®le et de sortie sont communes √† tous les registres.  Les entr√©es ABCDE - c'est le choix d'une s√©rie - vont vers un d√©codeur classique. <br><br>  Principe de fonctionnement: <br><br><ul><li>  d√©finissez les donn√©es sur les entr√©es RVB, cliquez sur le bouton CLK.  R√©p√©tez jusqu'√† ce que nous chargions toute la ligne </li><li>  d√©sactiver les sorties OE = 1 (pour qu'il n'y ait pas d'interf√©rence) </li><li>  donner au d√©codeur le num√©ro de la ligne charg√©e </li><li>  cliquez sur charge parall√®le LAT - les donn√©es de ligne sont transf√©r√©es vers les registres de sortie <br>  activer les sorties OE = 0 </li><li>  r√©p√©ter pour la ligne suivante </li></ul><br>  C'est une indication dynamique classique.  Il est clair qu'avec cette m√©thode dans un tel cycle, nous ne pouvons allumer / √©teindre que chaque LED sp√©cifique. <br><br>  Afin d'obtenir des gradations de luminosit√© avec PWM classique, un tel cycle doit √™tre r√©p√©t√© N-1 fois, o√π N est le nombre de gradations de luminosit√© (256 pour RGB888).  Et √©tant donn√© qu'en m√™me temps, il scintille toujours - tout cela doit √™tre fait tr√®s, tr√®s rapidement. <br><br>  Il existe une solution de contournement: la modulation d'angle de bit (BAM).  Dans ce cas, le temps de lueur dans chaque cycle est proportionnel au poids du bit affich√©.  Autrement dit, pour RGB888, vous n'avez besoin que de 8 cycles d'affichage.  Un peu plus en d√©tail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  La premi√®re version du contr√¥leur utilisait le PWM classique, qui imposait une limite stricte sur le nombre de cycles de balayage.  Dans la deuxi√®me version, BAM est impl√©ment√©, ce qui a donn√© un √©norme gain de vitesse. <br><br><h2>  Impl√©mentation </h2><br>  Il √©tait √©vident qu'un microcontr√¥leur conventionnel ne tire que de petits panneaux - les grands n'ont tout simplement pas assez de vitesse.  Par cons√©quent, CPLD ou FPGA est indispensable ici - il est physiquement impossible de produire des dizaines de Mo / s sur des microcontr√¥leurs √† faible co√ªt. <br><br>  En tant que m√©moire, j'ai √©t√© recommand√© sur le forum IXBT par la tr√®s int√©ressante m√©moire FIFO Averlogic AL422B, qui a environ 400 Ko de m√©moire et peut fonctionner √† des fr√©quences allant jusqu'√† 50 MHz. <br><br>  √âtant donn√© que ma principale exigence √©tait le faible co√ªt maximum des composants, afin que l'√©charpe finie soit accessible aux fabricants de produits maison, l'Altera EPM3064 - CPLD avec 64 macrocellules a √©t√© choisie.  En m√™me temps, un si petit nombre de macrocellules ne permet pas de cr√©er une carte configurable dynamiquement - la configuration doit √™tre compil√©e directement dans CPLD. <br><br>  ‚Üí Le circuit r√©sultant se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> <br><br>  D√©tails: <br><br><ul><li>  CPLD EPM3064ATC44-10 - le prix d'Ali est d'environ 13-15 $ pour une douzaine </li><li>  FIFO RAM AL422B - le prix d'Ali est d'environ 15 $ la douzaine </li><li>  Oscillateur √† cristal 50 MHz.  La carte permet l'installation dans des bo√Ætiers DIP14 / DIP8 / 7050.  Le prix d'Ali est d'environ 6-7 $ la douzaine </li><li>  Stabilisateur 3,3 V dans le bo√Ætier SOT223.  Prix ‚Äã‚Äãen Chip and Dip - 40r chacun </li><li>  Connecteur IDC-10MS.  Prix ‚Äã‚Äãen Chip &amp; Dip - 3 p / pi√®ce </li><li>  Connecteur IDC-16MS.  Prix ‚Äã‚Äãen Chip &amp; Dip - 8 r / pi√®ce </li><li>  Connecteur IDC-14MS.  Prix ‚Äã‚Äãen Chip &amp; Dip - 7 r / pi√®ce </li><li>  Condensateurs 1 microfarad 0805 - 8 pi√®ces d'environ 1 r / pi√®ce </li><li>  Condensateur 0.1uF 0805 - environ 1 r / pi√®ce </li><li>  R√©sistance 10k 0805 - un sou </li></ul><br>  Le total en d√©tail est obtenu 1,5 + 1,5 + 0,7 = 3,7 $ et 40 + 3 + 8 + 7 + 8 * 1 + 1 = 67 p.  Tous ensemble dans 5 $ - un sou. <br><br>  ‚Üí L'image originale du tableau est <a href="">ici</a> <br><br>  ‚Üí <a href="">Fichiers</a> Gerber pr√©par√©s <a href="">pour la commande</a> <br><br>  La carte est pr√©par√©e pour la premi√®re version, dans laquelle il n'y avait pas de contr√¥le RE.  Pour l'utiliser avec la deuxi√®me version, vous devez couper le cavalier entre les bornes 23 et 24 de AL422B et jeter les fils de la borne 28 de EPM3064 (il est amen√© au bornier) √† la borne 24 de AL422B. <br><br>  Lors du soudage de la carte, n'oubliez pas de souder les cavaliers d'alimentation √† l'arri√®re de la carte. <br><br><img src="https://habrastorage.org/webt/y6/hy/i6/y6hyi6obrqqyyybfvractvmtuqy.jpeg"><br><br><img src="https://habrastorage.org/webt/u1/n1/jr/u1n1jr2zzs7sqfwpzxji2xpg2pg.jpeg"><br><br><h2>  Calculs </h2><br>  Les calculs des param√®tres requis sont assez compliqu√©s. <br><br>  Le fait est que dans le contr√¥leur, deux processus sont ex√©cut√©s en parall√®le - chargement des donn√©es de la ligne suivante / indiquant une ligne d√©j√† charg√©e. <br><br>  Les processus d√©marrent simultan√©ment, mais se terminent √† des moments diff√©rents, donc un processus plus rapide attend l'ach√®vement d'un processus plus long. <br><br>  ‚Üí Une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tablette Excel a</a> √©t√© r√©alis√©e pour le calcul <br><br>  Donn√©es sources: <br><br><ul><li>  CRYSTAL_FRQ (MHz) - fr√©quence du g√©n√©rateur (50 MHz) </li><li>  PIXEL_COUNT - le nombre de pixels dans la barre de t√©l√©chargement.  Plus de d√©tails dans la section commutation. </li><li>  RGB_INPUTS - le nombre d'entr√©es RGB utilis√©es dans l'interface HUB75E du panneau utilis√©.  1 ou 2 </li><li>  BYTES_PER_PIXEL - octets par pixel.  Dans notre cas, toujours 3 - RGB888 </li><li>  SCAN_LINES - nombre de lignes de num√©risation dans le panneau utilis√©.  16/08/32 </li></ul><br>  Param√®tres s√©lectionn√©s: <br><br><ul><li>  PRE_DELAY - d√©lai entre le signal LAT et la mise sous tension de l'OE, d√©fini par ticks </li><li>  PRESCALER - Prescaler pour le compteur principal.  Autrement dit, si la liste de prix est 8 et que le poids du bit actuel est 4, OE sera activ√© pendant 8 * 4 = 32 cycles </li><li>  POST_DELAY - d√©lai minimum entre la mise hors tension de l'OE et le signal LAT suivant, d√©fini par ticks </li></ul><br>  Par exemple, nous avons un panneau 32x32 qui a 8 lignes de balayage et 2 entr√©es RVB.  Un tel panneau a deux connecteurs HUB75E, c'est-√†-dire que physiquement ce sont deux panneaux 32x16.  Nous connectons ces panneaux en s√©rie, c'est-√†-dire que ce panneau ressemblera logiquement √† 64x16. <br><br>  PRE_DELAY et POST_DELAY sont des intervalles de suppression avant et apr√®s l'activation de la sortie (OE) afin que les multiplexeurs puissent commuter les sorties et les touches ouvrir / fermer.  Sans eux, il y aura des ¬´astuces¬ª de la gravure des pixels aux lignes adjacentes.  Les valeurs sont s√©lectionn√©es exp√©rimentalement pour un panneau particulier.  Habituellement, 15 mesures sont suffisantes (fix√©es en mesures). <br><br>  Cela soul√®ve la question du choix du prescaler - comment le choisir. <br><br>  Une valeur de mise √† l'√©chelle faible donne un temps d'affichage d'image court, mais r√©duit la luminosit√© globale.  La valeur √©lev√©e du d√©tartreur augmente le temps d'affichage de la trame, c'est-√†-dire que lorsqu'il √©num√®re, il scintille √† l'√©cran. <br><br>  Essayons PRESCALER = 1 <br><br>  Nous obtenons: <br><br>  OE_EFFICIENCE - 8,3%, c'est-√†-dire que le panneau ne fonctionnera que 8,3% de la luminosit√© maximale possible <br>  FRAMES_PER_SECOND - 2034 ips - mais le taux de rafra√Æchissement de l'image sera √©norme - plus de 2000 ips. <br><br>  La perte de luminosit√© est d√©j√† tr√®s importante. <br><br>  Essayons PRESCALER = 16 <br><br>  Nous obtenons: <br><br>  OE_EFFICIENCE - 72,9% c'est-√†-dire que le panneau fonctionnera √† 72,9% de la luminosit√© maximale possible <br>  FRAMES_PER_SECOND - 1117 - et le taux de rafra√Æchissement de l'image est tr√®s bon - plus de 1000 fps. <br>  Eh bien, c'est tout √† fait normal - une efficacit√© de plus de 50% est tout √† fait normale et la fr√©quence d'images est tr√®s bonne. <br><br>  La r√®gle g√©n√©rale est que PRESCALER est environ 8 fois plus petit que le produit PIXEL_COUNT * RGB_INPUTS <br><br>  Eh bien, continuez de compter et de v√©rifier. <br><br><h2>  Commutation des panneaux LED </h2><br>  Tous les panneaux sont connect√©s en s√©rie.  Sch√©ma de connexion: d'abord de droite √† gauche, puis de bas en haut.  Autrement dit, nous connectons d'abord les horizontales en s√©rie, puis la sortie de la rang√©e du bas √† l'entr√©e de la deuxi√®me rang√©e du bas, etc.  √† la rang√©e sup√©rieure. <br><br>  Le contr√¥leur s'accroche au panneau inf√©rieur droit. <br><br>  Il y a des panneaux qui ont deux connecteurs d'entr√©e et deux de sortie.  De tels panneaux ne sont essentiellement qu'un assemblage m√©canique de deux panneaux verticalement.  Commut√©e en deux panels ind√©pendants. <br><br>  Apr√®s l'assemblage, nous devons calculer la longueur totale de la cha√Æne en pixels - pour cela, nous regardons - combien de panneaux totaux √©taient dans la cha√Æne et multiplier ce nombre par la largeur du panneau en pixels.  Ce nombre devra ensuite √™tre introduit dans la valeur PIXEL_COUNT pendant la configuration CPLD et dans le calculateur de synchronisation. <br><br><h2>  Micrologiciel FPGA </h2><br>  Tous les fichiers n√©cessaires sont sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> .  Vous devez t√©l√©charger directement avec le dossier. <br><br>  Apr√®s l'enregistrement, vous devez t√©l√©charger et installer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quartus II 13.0sp1 √†</a> partir du site Web d'Altera.  Vous devez t√©l√©charger EXACTEMENT CETTE version - les versions plus r√©centes ne prennent plus en charge la s√©rie MAX3000.  Il n'est pas n√©cessaire de le casser - la version (gratuite) de l'√©dition Web suffit.  Lors du t√©l√©chargement, assurez-vous de cocher les cases pour la prise en charge du MAX3000 et du programmeur.  Au cas o√π, je vous pr√©viens - le paquet est gros, environ deux concerts.  Vous aurez √©galement besoin d'Altera USB Blaster - le prix habituel pour ali est d'environ 3 $. <br><br>  Ouvrez le projet al422_bam.qpf.  Sur la gauche, ouvrez l'onglet fichier et ouvrez le fichier al422_bam.v - il s'agit du fichier de projet principal.  Vous devez y configurer les param√®tres: <br><br>  Combien d'entr√©es RVB sur un panneau - sur les panneaux avec une entr√©e HUB75, il peut y avoir 1 ou 2 entr√©es RVB.  Pour savoir exactement combien d'entr√©es sont possibles de cette fa√ßon - nous prenons le nombre de pixels dans le panneau verticalement.  Divisez-le par le nombre de lignes de balayage (indiqu√© par exemple dans la d√©signation du panneau 8S).  Divisez par le nombre de connecteurs d'entr√©e (1 ou 2).  Par exemple - j'ai un panneau 32x32, un balayage 8S et deux connecteurs d'entr√©e - 32/8/2 = 2 - ce qui signifie deux entr√©es RVB. <br><br><pre><code class="hljs powershell">`define RGB_outs <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Combien de lignes de num√©risation sur le panneau - puisque la norme HUB75E est prise en charge, elle peut aller jusqu'√† 32x.  Le nombre de lignes de balayage est g√©n√©ralement dans le nom du panneau sous la forme de 8S / 16S / 32S, respectivement. <br><br>  Une seule ligne doit √™tre d√©comment√©e: <br><br><pre> <code class="hljs powershell">`define SCAN_x8 <span class="hljs-number"><span class="hljs-number">1</span></span> //`define SCAN_x16 <span class="hljs-number"><span class="hljs-number">1</span></span> //`define SCAN_x32 <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Nombre total de pixels horizontaux dans la cha√Æne.  Les pixels sont pris en compte dans toute la cha√Æne de panneaux - voir la section ci-dessus ¬´Commutation des panneaux LED¬ª <br><br><pre> <code class="hljs powershell">`define PIXEL_COUNT <span class="hljs-number"><span class="hljs-number">64</span></span></code> </pre><br>  Les phases des signaux de sortie.  La configuration la plus typique est la suivante: OE est actif √† un niveau bas (commentaires supprim√©s), CLK fonctionne √† l'avant (les commentaires sont activ√©s), LAT est actif √† un niveau √©lev√© (les commentaires sont activ√©s).  Toutes sortes d'options √©tranges sont possibles.  D√©couvrez lequel vous n'avez qu'√† titre exp√©rimental ou en supprimant le circuit et en recherchant des fiches techniques pour les puces utilis√©es). <br><br><pre> <code class="hljs powershell">//`define LED_LAT_ACTIVE_LOW <span class="hljs-number"><span class="hljs-number">1</span></span> `define LED_OE_ACTIVE_LOW <span class="hljs-number"><span class="hljs-number">1</span></span> //`define LED_CLK_ON_FALL <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  D√©lai avant et apr√®s le signal OE par rapport au LAT et pr√©-√©chelle pour le compteur principal.  Voir ci-dessus. <br><br><pre> <code class="hljs powershell">`define OE_PRESCALER <span class="hljs-number"><span class="hljs-number">16</span></span> `define OE_PREDELAY <span class="hljs-number"><span class="hljs-number">31</span></span> `define OE_POSTDELAY <span class="hljs-number"><span class="hljs-number">31</span></span></code> </pre><br>  Tout, appuyez sur ctrl-L - le projet est compil√©.  Si vous ne l'avez pas g√¢ch√©, il y aura plusieurs avertissements, mais il ne devrait y avoir aucune erreur.  Ensuite, nous accrochons la carte soud√©e au USB Blaster, appliquons l'alimentation √† la carte.  Dans Quartus, acc√©dez √† tools - programmer.  S√©lectionnez USB-blaster dans la configuration mat√©rielle, cliquez sur D√©marrer.  Voil√†, CPLD est programm√©. <br><br><h2>  Pi√®ce microcontr√¥leur </h2><br>  La sortie de donn√©es vers le contr√¥leur, en g√©n√©ral, est extr√™mement simple - nous r√©initialisons l'adresse d'√©criture, puis √©mettons s√©quentiellement des octets de donn√©es, en les caressant avec le signal WCLK.  Et il semble que m√™me un arduinka banal suffit au travail.  Mais il y a deux probl√®mes: <br><br>  a) Cela prend beaucoup de m√©moire.  M√™me un petit panneau 32x32 en mode RGB888 n√©cessite 3 Ko de m√©moire pour un tampon d'√©cran.  L'Atmega328 bas√© sur Arduino ordinaire ne contient que 2 Ko de RAM.  Vous pouvez bien s√ªr utiliser une carte Mega bas√©e sur Atmega2560, qui contient jusqu'√† 8 Ko de RAM, mais cela n'est pas suffisant pour les panneaux de taille normale - un panneau 128x64 en mode RGB565 n√©cessite 16 Ko de m√©moire. <br><br>  b) Dans le processus de travail avec AL422B, un probl√®me qui n'a √©t√© document√© nulle part est sorti - lors de l'√©criture de donn√©es √† une vitesse inf√©rieure √† 2 Mo / s, le compteur d'adresses ne fonctionne pas correctement et √©crit les donn√©es ¬´absentes¬ª.  C'est peut-√™tre un petit probl√®me de ma f√™te.  Peut-√™tre pas.  Mais ce probl√®me doit √™tre contourn√©.  √âtant donn√© que l'AVR8 fonctionne √† 16 MHz, il est presque impossible d'en obtenir des donn√©es aux vitesses souhait√©es. <br><br>  La solution propos√©e est d'opter pour des foulards bon march√© bas√©s sur le contr√¥leur STM32F103C8T6 32 bits.  Une telle √©charpe co√ªte √† Ali environ 2,5 $ par pi√®ce, soit environ 1,7 $ lors de l'achat d'une douzaine, c'est-√†-dire encore moins cher qu'un Arduino Nano.  Dans le m√™me temps, nous obtenons un microcontr√¥leur 32 bits √† part enti√®re fonctionnant √† 72 MHz et disposant de 20 Ko de RAM et de 64 Ko de flash (√† comparer avec le Atmega328 2 Ko / 8 Ko, qui est sur Nano). <br><br>  Dans le m√™me temps, ces cartes sont programm√©es avec succ√®s dans l'environnement Arduino.  √Ä ce sujet, il y a un bon article sur l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">horloge</a> , donc je ne le reproduirai pas.  En g√©n√©ral, faites tout comme d√©crit dans l'article. <br><br>  Dans un environnement Arduino, choisissez la carte Generic STM32F103C, variante STM32F103C8.  Les donn√©es transitent par DMA, vous pouvez donc utiliser n'importe quelle option d'optimisation. <br><br>  La commutation se produit comme suit: <br><br>  Fermement clou√© dans la biblioth√®que: <br>  A0..A7 ‚Üí DI0..DI7 AL422B <br>  B0 ‚Üí WCLK AL422B <br>  B1 ‚Üí WRST AL422B <br><br>  Attribu√© dans un croquis au contr√¥leur: <br>  B10 ‚Üí WE AL422B <br><br>  Fil commun: <br>  G ‚Üí GND <br><br>  N'oubliez pas de fournir une alimentation 5V / GND du panneau aux broches du contr√¥leur correspondantes. <br><br>  Retirez le brochage du connecteur du contr√¥leur du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">circuit</a> . <br><br><img src="https://habrastorage.org/webt/nh/p7/_y/nhp7_ygm9hqmkawess06ypt1oy4.jpeg"><br><br><h2>  Partie logiciel </h2><br>  Comme la t√¢che √©tait de tout rendre aussi simple et abordable que possible, tous les logiciels ont √©t√© con√ßus pour l'environnement Arduino et ont √©t√© con√ßus comme une biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LED_PANEL</a> . <br><br>  La biblioth√®que LED-PANEL utilise activement la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Adafruit GFX</a> , elle doit donc √™tre install√©e. <br><br>  Je recommande fortement de ne pas mettre la biblioth√®que LED_PANEL dans le r√©pertoire des biblioth√®ques, mais de la laisser dans le dossier d'esquisse.  Le fait est qu'il y a beaucoup de param√®tres li√©s au fer, et si vous voulez transf√©rer le travail vers un microcontr√¥leur plus "gros", vous devrez changer beaucoup de choses dans le code lui-m√™me. <br><br>  L'initialisation se pr√©sente approximativement sous la forme suivante: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"LED_PANEL.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> width 32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> height 32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> bpp 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> scan_lines 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RGB_inputs 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> we_out_pin PB10 LED_PANEL led_panel = LED_PANEL(width, height, bpp, scan_lines, RGB_inputs, we_out_pin);</span></span></code> </pre><br>  c'est-√†-dire que nous cr√©ons une instance de la classe LED_PANEL, pour laquelle nous sp√©cifions les param√®tres: <br><br>  width - la largeur totale du panneau en pixels (total) <br>  height - la hauteur totale du panneau en pixels (total) <br>  bpp - octet par pixel, 3 pour RGB888.  La version BAM ne fonctionne qu'en RGB888 <br>  scan_lines - le nombre de lignes de scan est 8/16/32.  Il doit correspondre au mode flash√© dans le contr√¥leur. <br>  RGB_inputs - le nombre d'entr√©es RGB dans le connecteur HUB75 est 1/2.  Il doit correspondre au mode flash√© dans le contr√¥leur. <br>  we_out_pin - broche √† laquelle la sortie WE est accroch√©e <br><br>  Veuillez noter que lors de l'initialisation, seule la broche WE est sp√©cifi√©e.  Toutes les autres broches sont enregistr√©es de mani√®re rigide dans le code, car elles sont li√©es au minuteur et aux canaux DMA utilis√©s et leur modification entra√Ænera des modifications importantes du code. <br><br>  D√©marrage et effacement de l'√©cran dans la section de configuration: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">led_panel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.begin</span></span>(); <span class="hljs-selector-tag"><span class="hljs-selector-tag">led_panel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.clear</span></span>();</code> </pre><br>  commencer initialise les broches n√©cessaires √† la sortie, connecte une minuterie et un DMA <br>  clear efface le tampon <br><br>  Pour le dessin, vous pouvez utiliser toutes les proc√©dures standard de la biblioth√®que Adafruit GFX - du plus simple drawPixel √† la sortie de texte.  Pour sortir les proc√©dures trac√©es vers le tampon, on utilise: <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>();</code> </pre><br>  Sous cette forme, show lance le transfert de donn√©es vers le contr√¥leur via DMA et retourne imm√©diatement le contr√¥le.  D√©couvrez si le transfert s'est termin√© √† l'aide de la fonction led_panel.OutIsFree () - s'il est vrai, le transfert est termin√©.  Il y a une fonctionnalit√© - si vous appelez show alors que le transfert n'est pas encore termin√© - elle sera simplement ignor√©e. <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre><br>  analogue de show (), mais si vous appelez show (false) et que le transfert n'est pas encore termin√©, la proc√©dure attendra la fin du transfert, puis d√©marrera un nouveau contr√¥le de transfert et de retour: <br><br><pre> <code class="hljs pgsql">led_panel.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  analogue de show (false), mais si vous appelez show (true), puis apr√®s le d√©but d'un nouveau transfert, la proc√©dure ne renverra le contr√¥le qu'une fois le transfert termin√©. <br><br>  En g√©n√©ral, c'est tout. <br><br><img src="https://habrastorage.org/webt/pn/-a/of/pn-aofhwnhuuzszuk_mcf9upqje.jpeg"><br><br>  Quelques notes sur le logiciel: <br><br>  a) La correction gamma est introduite lors du recalcul de la couleur √† partir de RGB565 (que la biblioth√®que utilise) avec la fonction ExpandColor.  Dans tous les autres cas, une fonction de transfert lin√©aire est utilis√©e, c'est-√†-dire que la luminosit√© est directement proportionnelle √† la valeur. <br>  b) Le logiciel vous permet de connecter plusieurs contr√¥leurs LED √† une seule carte microcontr√¥leur.  Pour ce faire, envoyez le bus de donn√©es, les lignes RST et CLK aux contr√¥leurs en parall√®le.  Le contr√¥leur souhait√© est s√©lectionn√© via la ligne WE.  Dans le logiciel, vous devez cr√©er une instance distincte de la classe LED_PANEL pour chaque contr√¥leur, et chaque instance doit avoir des lignes WE diff√©rentes (le dernier param√®tre) lors de l'initialisation. <br><br><h2>  √Ä FAIRE </h2><br>  - Traitez le "ramassage" des fleurs dans les rang√©es voisines.  Cela ressemble √† un mauvais c√¢blage du panneau lui-m√™me (les cl√©s sont sales), mais vous devez v√©rifier.  Je viens d'arriver un nouveau panneau - je vais v√©rifier; <br>  - Faire une nouvelle version de la carte - avec RE d√©j√† divorc√© et l'ajout de convertisseurs de niveau de sortie en 5V; <br>  - Cr√©er la classe META_LED_PANEL, qui permettra de combiner plusieurs LED_PANEL en un seul √©cran virtuel - cela permettra de cr√©er de tr√®s grands √©crans avec plusieurs contr√¥leurs; <br>  - √Ä l'avenir, passez √† une s√©rie CPLD plus puissante, par exemple CycloneIV.  Cela augmenterait consid√©rablement les capacit√©s tout en maintenant un faible co√ªt (EP4CE6E22 co√ªte environ 5 $ pour les chinois, alors qu'il y a 100 fois plus de macrocellules et environ 32 Ko de m√©moire interne).  Mais je le ferai un jour plus tard.  Si je veux.  √âtant donn√© que de tels d√©veloppements prennent trop de temps. </cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr409743/">https://habr.com/ru/post/fr409743/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr409731/index.html">Revue de rentabilit√© Hashflare. Mon exp√©rience en 6 mois</a></li>
<li><a href="../fr409733/index.html">Besoin de donn√©es plus rapides et d'une plan√®te plus propre? Commencez √† d√©velopper des ast√©ro√Ødes</a></li>
<li><a href="../fr409735/index.html">Illusion au niveau du consensus</a></li>
<li><a href="../fr409739/index.html">Bloomberg: Telegram pr√©voit de gagner plus d'un milliard de dollars lors de l'ICO</a></li>
<li><a href="../fr409741/index.html">La Maison Blanche souhaite lancer Falcon Heavy</a></li>
<li><a href="../fr409745/index.html">Le sp√©cialiste de l'IA pr√©tend avoir r√©ussi √† comprendre dans quelle langue le manuscrit de Voynich est √©crit</a></li>
<li><a href="../fr409747/index.html">Le r√©seau de neurones AttnGAN dessine des objets en plusieurs parties, en utilisant l'espace vectoriel non seulement des phrases, mais aussi des mots</a></li>
<li><a href="../fr409749/index.html">Chaudi√®re de pyrolyse √† domicile, ou lorsque le prix du gaz n'a pas d'importance</a></li>
<li><a href="../fr409751/index.html">Lettre AudioFilkina: musique blue tooth - pas pour le battage m√©diatique, mais pour le bien</a></li>
<li><a href="../fr409753/index.html">L'ONU pourrait terminer une exp√©rience al√©atoire √† grande √©chelle pour r√©duire le r√©chauffement climatique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>