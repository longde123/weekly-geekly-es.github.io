<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêä üö∞ üíÜüèø JOIN cole√ß√£o local e DbSet no Entity Framework üïú üë∂üèª üôåüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pouco mais de um ano com a minha participa√ß√£o, ocorreu o seguinte "di√°logo": 


 .Net App : Hey Entity Framework, por favor, me d√™ muitos dados! 
 Est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>JOIN cole√ß√£o local e DbSet no Entity Framework</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435810/"><p>  Pouco mais de um ano com a minha participa√ß√£o, ocorreu o seguinte "di√°logo": </p><br><p>  <strong>.Net App</strong> : Hey Entity Framework, por favor, me d√™ muitos dados! <br>  <strong>Estrutura de entidades</strong> : desculpe, eu n√£o entendi voc√™.  Como assim? <br>  <strong>.Net App</strong> : Sim, acabei de receber uma cole√ß√£o de 100 mil transa√ß√µes.  E agora precisamos verificar rapidamente a corre√ß√£o dos pre√ßos dos valores mobili√°rios que s√£o indicados l√°. <br>  <strong>Entity Framework</strong> : Ahh, bem, vamos tentar ... <br>  <strong>.Net App</strong> : Aqui est√° o c√≥digo: </p><br><pre><code class="cpp hljs">var query = from p in context.Prices join t in transactions on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { p.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; query.ToList();</code> </pre> <br><p>  <strong>Estrutura da entidade</strong> : </p><br><p><img src="https://habrastorage.org/webt/kc/jh/lp/kcjhlpnggo_fhkdgik481svjuea.png"></p><br><p>  Cl√°ssico  Eu acho que muitas pessoas est√£o familiarizadas com esta situa√ß√£o: quando eu realmente quero "lindamente" e rapidamente fa√ßo uma pesquisa no banco de dados usando o <em>JOIN da</em> cole√ß√£o local e o <em>DbSet</em> .  Geralmente essa experi√™ncia √© decepcionante. </p><br><p>  Neste artigo (que √© uma <em>tradu√ß√£o gratuita do meu outro artigo</em> ), conduzirei uma s√©rie de experimentos e tentarei diferentes maneiras de contornar essa limita√ß√£o.  Haver√° um c√≥digo (sem complica√ß√µes), pensamentos e algo como um final feliz. </p><a name="habracut"></a><br><h2 id="vvedenie">  1. Introdu√ß√£o </h2><br><p>  Todo mundo conhece o <em>Entity Framework</em> , muitos o utilizam todos os dias e h√° muitos bons artigos sobre como prepar√°-lo corretamente (use consultas mais simples, use os par√¢metros em Ignorar e Aceitar, use o VIEW, solicite apenas os campos necess√°rios, monitore o cache de consultas e outro), no entanto, o tema <em>JOIN</em> da cole√ß√£o local e <em>DbSet</em> ainda √© um ponto fraco. </p><br><h2 id="zadacha">  Desafio </h2><br><p>  Suponha que exista um banco de dados com pre√ßos e que haja uma cole√ß√£o de transa√ß√µes para as quais voc√™ precisa verificar a exatid√£o dos pre√ßos.  E suponha que tenhamos o seguinte c√≥digo. </p><br><pre> <code class="cpp hljs">var localData = GetDataFromApiOrUser(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in localData on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; var result = query.ToList();</code> </pre> <br><p>  Este c√≥digo n√£o funciona no <em>Entity Framework 6</em> .  No <em>Entity Framework Core</em> - funciona, mas tudo ser√° feito no lado do cliente e no caso de milh√µes de registros no banco de dados - isso n√£o √© uma op√ß√£o. </p><br><p>  Como eu disse, tentarei maneiras diferentes de contornar isso.  Do simples ao complexo.  Para minhas experi√™ncias, eu uso o c√≥digo do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio</a> a seguir.  O c√≥digo √© escrito usando: <em>C #</em> , <em>.Net Core</em> , <em>EF Core</em> e <em>PostgreSQL</em> . </p><br><p>  Tamb√©m tirei algumas m√©tricas: tempo gasto e consumo de mem√≥ria.  Isen√ß√£o de responsabilidade: se o teste foi realizado por mais de 10 minutos, eu o interrompi (a restri√ß√£o √© de cima).  M√°quina de teste Intel Core i5, 8 GB de RAM, SSD. </p><br><div class="spoiler">  <b class="spoiler_title">Esquema do banco de dados</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/1d5/f8c/cec/1d5f8ccec6ef1b7361195c18ac139d09.png" alt="imagem"></p><br><p>  Apenas 3 tabelas: <em>pre√ßos</em> , <em>valores mobili√°rios</em> e <em>fontes de pre√ßos</em> .  <em>Pre√ßos</em> - cont√©m 10 milh√µes de entradas. </p></div></div><br><h4 id="sposob-1-naive">  M√©todo 1. Ing√™nuo </h4><br><p>  Vamos come√ßar de forma simples e usar o seguinte c√≥digo: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo para o m√©todo 1</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in TestData) { result.AddRange(context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId)); } }</code> </pre> </div></div><br><p>  A id√©ia √© simples: em um loop, lemos os registros do banco de dados, um de cada vez, e adicionamos √† cole√ß√£o resultante.  Este c√≥digo tem apenas uma vantagem - simplicidade.  E uma desvantagem √© a baixa velocidade: mesmo se houver um √≠ndice no banco de dados, na maioria das vezes ser√° necess√°rio comunica√ß√£o com o servidor de banco de dados.  As m√©tricas s√£o as seguintes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/985/61c/b6a/98561cb6a2566faff490fc2bf7432fb9.png" alt="imagem"></p><br><p>  O consumo de mem√≥ria √© pequeno.  Uma cole√ß√£o grande leva 1 minuto.  Para come√ßar, n√£o √© ruim, mas eu quero isso mais r√°pido. </p><br><h4 id="sposob-2-naive-parallel">  M√©todo 2: paralelo ing√™nuo </h4><br><p>  Vamos tentar adicionar paralelismo.  A id√©ia √© acessar o banco de dados a partir de v√°rios threads. </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo para o m√©todo 2</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Price&gt;(); var partitioner = Partitioner.Create(<span class="hljs-number"><span class="hljs-number">0</span></span>, TestData.Count); Parallel.ForEach(partitioner, range =&gt; { var subList = TestData.Skip(range.Item1) .Take(range.Item2 - range.Item1) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in subList) { var query = context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId); foreach (var el in query) { result.Add(el); } } } });</code> </pre> </div></div><br><p>  Resultado: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/916/d22/428/916d224282a3020dc31df6c67a18b070.png" alt="imagem"></p><br><p>  Para cole√ß√µes pequenas, essa abordagem √© ainda mais lenta que o primeiro m√©todo.  E para os maiores - duas vezes mais r√°pido.  Curiosamente, 4 threads foram gerados na minha m√°quina, mas isso n√£o levou √† acelera√ß√£o de 4x.  Isso sugere que a sobrecarga nesse m√©todo √© significativa: no lado do cliente e no servidor.  O consumo de mem√≥ria aumentou, mas n√£o significativamente. </p><br><h4 id="sposob-3-multiple-contains">  M√©todo 3: v√°rios cont√©m </h4><br><p>  Hora de tentar outra coisa e tentar reduzir a tarefa para uma consulta.  Isso pode ser feito da seguinte maneira: </p><br><ol><li>  Prepare 3 cole√ß√µes exclusivas de <em>Ticker</em> , <em>PriceSourceId</em> e <em>Date</em> </li><li>  Execute a solicita√ß√£o e use 3 <em>Cont√©m</em> </li><li>  Verifique novamente os resultados localmente </li></ol><br><div class="spoiler">  <b class="spoiler_title">C√≥digo para o m√©todo 3</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">//   var tickers = TestData.Select(x =&gt; x.Ticker).Distinct().ToList(); var dates = TestData.Select(x =&gt; x.TradedOn).Distinct().ToList(); var ps = TestData.Select(x =&gt; x.PriceSourceId).Distinct().ToList(); //    3 Contains var data = context.Prices .Where(x =&gt; tickers.Contains(x.Security.Ticker) &amp;&amp; dates.Contains(x.TradedOn) &amp;&amp; ps.Contains(x.PriceSourceId)) .Select(x =&gt; new { Price = x, Ticker = x.Security.Ticker, }) .ToList(); var lookup = data.ToLookup(x =&gt; $"{x.Ticker}, {x.Price.TradedOn}, {x.Price.PriceSourceId}"); //  foreach (var el in TestData) { var key = $"{el.Ticker}, {el.TradedOn}, {el.PriceSourceId}"; result.AddRange(lookup[key].Select(x =&gt; x.Price)); } }</span></span></code> </pre> </div></div><br><p>  O problema aqui √© que o tempo de execu√ß√£o e a quantidade de dados retornados s√£o altamente dependentes dos dados em si (na consulta e no banco de dados).  Ou seja, apenas um conjunto de dados necess√°rios pode retornar e registros extras podem ser retornados (at√© 100 vezes mais). </p><br><p>  Isso pode ser explicado usando o exemplo a seguir.  Suponha que exista a seguinte tabela com dados: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f3f/2bb/ea5/f3f2bbea5148127963cab9010d2b2f10.png" alt="imagem"></p><br><p>  Suponha tamb√©m que eu precise de pre√ßos para o <em>Ticker1</em> com <em>TradedOn</em> = <em>01-01-2018</em> e para o <em>Ticker2</em> com <em>TradedOn</em> = <em>02-01-2018</em> . </p><br><p>  Em seguida, valores exclusivos para <em>Ticker</em> = ( <em>Ticker1</em> , <em>Ticker2</em> ) <br>  E valores exclusivos para <em>TradedOn</em> = ( <em>2018-01-01</em> , <em>2018-01-02</em> ) </p><br><p>  No entanto, 4 registros ser√£o retornados como resultado, porque eles realmente correspondem a essas combina√ß√µes.  O ruim √© que, quanto mais campos s√£o usados, maior a chance de obter registros extras como resultado. </p><br><p>  Por esse motivo, os dados obtidos por esse m√©todo devem ser filtrados adicionalmente no lado do cliente.  E essa √© a maior desvantagem. <br>  As m√©tricas s√£o as seguintes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dd5/078/5ef/dd50785efd38900c4d18467607b87a1e.png" alt="imagem"></p><br><p>  O consumo de mem√≥ria √© pior que todos os m√©todos anteriores.  O n√∫mero de linhas lidas √© muitas vezes maior que o n√∫mero solicitado.  Os testes para grandes cole√ß√µes foram interrompidos porque foram executados por mais de 10 minutos.  Este m√©todo n√£o √© bom. </p><br><h4 id="sposob-4-predicate-builder">  M√©todo 4. Construtor de Predicado </h4><br><p>  Vamos tentar do outro lado: a boa e velha <em>express√£o</em> .  Com eles, voc√™ pode criar 1 consulta grande no seguinte formato: </p><br><p> <code>‚Ä¶ (.. AND .. AND ..) OR (.. AND .. AND ..) OR (.. AND .. AND ..) ‚Ä¶</code> </p> <br><p>  Isso d√° esperan√ßa de que seja poss√≠vel criar 1 solicita√ß√£o e obter apenas os dados necess√°rios para 1 chamada.  C√≥digo: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo para o m√©todo 4</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { var baseQuery = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId select <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestData() { Ticker = s.Ticker, TradedOn = p.TradedOn, PriceSourceId = p.PriceSourceId, PriceObject = p }; var tradedOnProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>); var priceSourceIdProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>); var tickerProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>); var paramExpression = Expression.Parameter(typeof(TestData)); Expression wholeClause = null; foreach (var td in TestData) { var elementClause = Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, tradedOnProperty), Expression.Constant(td.TradedOn) ), Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, priceSourceIdProperty), Expression.Constant(td.PriceSourceId) ), Expression.Equal( Expression.MakeMemberAccess( paramExpression, tickerProperty), Expression.Constant(td.Ticker)) )); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wholeClause == null) wholeClause = elementClause; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wholeClause = Expression.OrElse(wholeClause, elementClause); } var query = baseQuery.Where( (Expression&lt;Func&lt;TestData, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;)Expression.Lambda( wholeClause, paramExpression)).Select(x =&gt; x.PriceObject); result.AddRange(query); }</code> </pre> </div></div><br><p>  O c√≥digo acabou sendo mais complicado do que nos m√©todos anteriores.  Construir manualmente o <em>Expression</em> n√£o <em>√©</em> a opera√ß√£o mais f√°cil e r√°pida. </p><br><p>  M√©tricas: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/312/373/4fc/3123734fc82c4fc4d783f4f9ce2cf225.png" alt="imagem"></p><br><p>  Os resultados tempor√°rios foram ainda piores do que no m√©todo anterior.  Parece que a sobrecarga durante a constru√ß√£o e ao andar pela √°rvore acabou sendo muito mais do que o ganho do uso de uma solicita√ß√£o. </p><br><h4 id="sposob-5-shared-query-data-table">  M√©todo 5: tabela de dados de consulta compartilhada </h4><br><p>  Vamos tentar outra op√ß√£o: <br>  Criei uma nova tabela no banco de dados na qual <em>gravarei</em> os dados necess√°rios para concluir a solicita√ß√£o (implicitamente, preciso de um novo <em>DbSet</em> no contexto). </p><br><p>  Agora, para obter o resultado, voc√™ precisa: </p><br><ol><li>  Iniciar transa√ß√£o </li><li>  Carregar dados da consulta para uma nova tabela </li><li>  Execute a pr√≥pria consulta (usando a nova tabela) </li><li>  Reverter uma transa√ß√£o (para limpar a tabela de dados para consultas) </li></ol><br><p>  O c√≥digo fica assim: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo para o m√©todo 5</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { context.Database.BeginTransaction(); var reducedData = TestData.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedQueryModel() { PriceSourceId = x.PriceSourceId, Ticker = x.Ticker, TradedOn = x.TradedOn }).ToList(); <span class="hljs-comment"><span class="hljs-comment">//      context.QueryDataShared.AddRange(reducedData); context.SaveChanges(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in context.QueryDataShared on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); context.Database.RollbackTransaction(); }</span></span></code> </pre> </div></div><br><p>  Primeiras m√©tricas: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/df0/ab7/d7d/df0ab7d7d01b0aeaeebf2b9a41f5e75b.png" alt="imagem"></p><br><p>  Todos os testes funcionaram e funcionaram rapidamente!  O consumo de mem√≥ria tamb√©m √© aceit√°vel. <br>  Assim, atrav√©s do uso de uma transa√ß√£o, esta tabela pode ser usada simultaneamente por v√°rios processos.  E como essa √© uma tabela existente, todos os recursos do <em>Entity Framework</em> est√£o dispon√≠veis para n√≥s: voc√™ s√≥ precisa carregar os dados na tabela, criar uma consulta usando <em>JOIN</em> e execut√°-la.  √Ä primeira vista, √© disso que voc√™ precisa, mas h√° desvantagens significativas: </p><br><ul><li>  Voc√™ deve criar uma tabela para um tipo espec√≠fico de consulta </li><li>  √â necess√°rio usar transa√ß√µes (e desperdi√ßar recursos de DBMS nelas) </li><li>  E a pr√≥pria id√©ia de que voc√™ precisa ESCREVER algo, quando precisa ler, parece estranha.  E na Read Replica, simplesmente n√£o funciona. <br>  E o resto √© uma solu√ß√£o mais ou menos funcional que j√° pode ser usada. </li></ul><br><h4 id="sposob-6-memoryjoin-extension">  M√©todo 6. Extens√£o MemoryJoin </h4><br><p>  Agora voc√™ pode tentar melhorar a abordagem anterior.  Os pensamentos s√£o: </p><br><ul><li>  Em vez de usar uma tabela espec√≠fica para um tipo de consulta, voc√™ pode usar alguma op√ß√£o generalizada.  Ou seja, crie uma tabela com um nome como <em>shared_query_data</em> e adicione v√°rios campos <em>Guid</em> , v√°rios <em>Long</em> , v√°rios <em>String</em> etc. a ele.  Nomes simples podem ser <em>usados</em> : <em>Guid1</em> , <em>Guid2</em> , <em>String1</em> , <em>Long1</em> , <em>Date2</em> , etc.  Em seguida, esta tabela pode ser usada para 95% dos tipos de consulta.  Os nomes das propriedades podem ser "ajustados" posteriormente usando a perspectiva <strong>Selecionar</strong> . </li><li>  Em seguida, voc√™ precisa adicionar um <em>DbSet</em> para <em>shared_query_data</em> . </li><li>  Mas e se, em vez de gravar dados no banco de dados, transmitir valores usando a constru√ß√£o <strong>VALUES</strong> ?  Ou seja, √© necess√°rio que na consulta SQL final, em vez de acessar <em>shared_query_data,</em> haja um apelo a <strong>VALUES</strong> .  Como fazer isso? <br><ul><li>  No Entity Framework Core - apenas usando o <em>FromSql</em> . </li><li>  No Entity Framework 6 - √© necess√°rio usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DbInterception</a> - ou seja, altere o SQL gerado adicionando a constru√ß√£o <strong>VALUES</strong> imediatamente antes da execu√ß√£o.  Isso resultar√° em uma limita√ß√£o: em uma √∫nica solicita√ß√£o, n√£o mais que uma constru√ß√£o <strong>VALUES</strong> .  Mas vai funcionar! </li></ul></li><li>  Como n√£o vamos gravar no banco de dados, obtemos a tabela <em>shared_query_data</em> criada na primeira etapa, n√£o √© necess√°ria?  Resposta: sim, n√£o √© necess√°rio, mas o <em>DbSet</em> ainda √© necess√°rio, pois o Entity Framework deve conhecer o esquema de dados para criar consultas.  Acontece que precisamos de um <em>DbSet</em> para algum modelo generalizado que n√£o exista no banco de dados e seja usado apenas para inspirar o Entity Framework, que ele sabe o que est√° fazendo. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Converter IEnumerable em IQueryable Example</b> <div class="spoiler_text"><ol><li>  A entrada recebeu uma cole√ß√£o de objetos do seguinte tipo: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeQueryData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Ticker {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTimeTradedOn {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PriceSourceId {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} }</code> </pre> </li><li>  Temos √† nossa disposi√ß√£o <em>DbSet</em> com os campos <em>String1</em> , <em>String2</em> , <em>Date1</em> , <em>Long1</em> , <em>etc</em> </li><li>  Deixe o <em>Ticker</em> ser armazenado em <em>String1</em> , <em>TradedOn</em> em <em>Date1</em> e <em>PriceSourceId</em> em <em>Long1</em> ( <em>int</em> mapeia em <em>long</em> , para n√£o criar campos para <em>int</em> e <em>long</em> separados) </li><li>  Ent√£o <em>FromSql</em> + <em>VALUES</em> ser√° assim: <br><pre> <code class="cpp hljs">var query = context.QuerySharedData.FromSql( <span class="hljs-string"><span class="hljs-string">"SELECT * FROM ( VALUES (1, 'Ticker1', @date1, @id1), (2, 'Ticker2', @date2, @id2) ) AS __gen_query_data__ (id, string1, date1, long1)"</span></span>)</code> </pre> </li><li>  Agora voc√™ pode fazer uma proje√ß√£o e retornar um <em>IQueryable</em> conveniente usando o mesmo tipo que estava na entrada: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> query.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeQueryData() { Ticker = x.String1, TradedOn = x.Date1, PriceSourceId = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)x.Long1 });</code> </pre> </li></ol></div></div><br><p>  Consegui implementar essa abordagem e at√© projet√°-la como um pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NuGet EntityFrameworkCore.MemoryJoin</a> (o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digo</a> tamb√©m <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√°</a> dispon√≠vel).  Apesar do nome conter a palavra <em>Core</em> , o <em>Entity Framework</em> 6 tamb√©m √© suportado.  Eu o chamei de <strong>MemoryJoin</strong> , mas na verdade ele envia dados locais para o DBMS na constru√ß√£o <em>VALUES</em> e todo o trabalho √© feito nele. </p><br><p>  O c√≥digo √© o seguinte: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo para o m√©todo 6</b> <div class="spoiler_text"><pre> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">// :    ,      var reducedData = TestData.Select(x =&gt; new { x.Ticker, x.TradedOn, x.PriceSourceId }).ToList(); //  IEnumerable&lt;&gt;   IQueryable&lt;&gt; var queryable = context.FromLocalList(reducedData); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in queryable on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); }</span></span></code> </pre> </div></div><br><p>  M√©tricas: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6a7/d72/bb2/6a7d72bb265d9dedbc8e54d94fe16a4f.png" alt="imagem"></p><br><p>  Este √© o melhor resultado que eu j√° tentei.  O c√≥digo era muito simples e direto e, ao mesmo tempo, trabalhava para a Read Replica. </p><br><div class="spoiler">  <b class="spoiler_title">Um exemplo de uma solicita√ß√£o gerada para receber 3 elementos</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"ClosePrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"OpenPrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Price"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Security"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> = <span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"string1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"date1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"long1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> int4) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, @__gen_q_p0, @__gen_q_p1, @__gen_q_p2), (<span class="hljs-number"><span class="hljs-number">2</span></span>, @__gen_q_p3, @__gen_q_p4, @__gen_q_p5), (<span class="hljs-number"><span class="hljs-number">3</span></span>, @__gen_q_p6, @__gen_q_p7, @__gen_q_p8) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> __gen_query_data__ (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, string1, date1, long1) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"t"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ((<span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (<span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>)</code> </pre> <br><p>  Aqui voc√™ tamb√©m pode ver como o modelo generalizado (com os campos <em>String1</em> , <em>Date1</em> , <em>Long1</em> ) usando Select se transforma no modelo usado no c√≥digo (com os campos <em>Ticker</em> , <em>TradedOn</em> , <em>PriceSourceId</em> ). </p></div></div><br><p>  Todo o trabalho √© realizado em uma consulta no servidor SQL.  E este √© um pequeno final feliz, sobre o qual falei no in√≠cio.  No entanto, o uso desse m√©todo requer compreens√£o e as seguintes etapas: </p><br><ul><li>  Voc√™ precisa adicionar um <em>DbSet</em> adicional ao seu contexto (embora a pr√≥pria tabela possa ser <em>omitida</em> ) </li><li>  No modelo generalizado, que √© usado por padr√£o, s√£o declarados 3 campos dos tipos <em>Guid</em> , <em>String</em> , <em>Double</em> , <em>Long</em> , <em>Date</em> , etc.  Isso deve ser suficiente para 95% dos tipos de solicita√ß√£o.  E se voc√™ passar uma cole√ß√£o de objetos com 20 campos para <em>FromLocalList</em> , uma <em>exce√ß√£o</em> ser√° lan√ßada, dizendo que o objeto √© muito complexo.  Essa √© uma restri√ß√£o simples e pode ser contornada - voc√™ pode declarar seu tipo e adicionar pelo menos 100 campos l√°.  No entanto, mais campos s√£o mais lentos para o trabalho. </li><li>  Mais detalhes t√©cnicos est√£o descritos no meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> . </li></ul><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  Neste artigo, apresentei meus pensamentos sobre o t√≥pico JOIN collection local e DbSet.  Pareceu-me que meu desenvolvimento usando <em>VALUES</em> poderia ser de interesse da comunidade.  Pelo menos n√£o encontrei essa abordagem quando resolvi esse problema.  Pessoalmente, esse m√©todo me ajudou a superar v√°rios problemas de desempenho em meus projetos atuais, talvez tamb√©m o ajude. </p><br><p>  Algu√©m dir√° que o uso do <em>MemoryJoin √©</em> muito "obscuro" e precisa ser mais desenvolvido, e at√© ent√£o voc√™ n√£o precisa us√°-lo.  Esta √© exatamente a raz√£o pela qual fiquei muito duvidosa e, durante quase um ano, n√£o escrevi este artigo.  Concordo que gostaria que o trabalho fosse mais f√°cil (espero que um dia), mas tamb√©m digo que a otimiza√ß√£o nunca foi uma tarefa dos juniores.  A otimiza√ß√£o sempre exige um entendimento de como a ferramenta funciona.  E se houver uma oportunidade de obter acelera√ß√£o em ~ 8 vezes ( <em>Naive Parallel</em> vs <em>MemoryJoin</em> ), eu <em>dominaria</em> 2 pontos e documenta√ß√£o. </p><br><p>  E, finalmente, os diagramas: </p><br><p>  Tempo gasto.  Apenas 4 m√©todos conclu√≠ram a tarefa em menos de 10 minutos e o <em>MemoryJoin</em> √© a √∫nica maneira de concluir a tarefa em menos de 10 segundos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/720/256/846/72025684620477d221c0f113a6cb354f.png" alt="imagem"></p><br><p>  Consumo de mem√≥ria.  Todos os m√©todos mostraram aproximadamente o mesmo consumo de mem√≥ria, exceto <em>M√∫ltiplos Cont√©m</em> .  Isso ocorre devido √† quantidade de dados retornados. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e07/a91/b63/e07a91b63375d49a21adb81e8213ffdb.png" alt="imagem"></p><br><p>  Obrigado pela leitura! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435810/">https://habr.com/ru/post/pt435810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435798/index.html">Sony WH-1000XM3 - os melhores fones de ouvido sem fio?</a></li>
<li><a href="../pt435800/index.html">Carta dezembrista 11</a></li>
<li><a href="../pt435802/index.html">OpenVPN, sobre o qual voc√™ sabia t√£o pouco</a></li>
<li><a href="../pt435804/index.html">O Intel Cyclone n√£o salva a configura√ß√£o ap√≥s a reinicializa√ß√£o</a></li>
<li><a href="../pt435806/index.html">An√°lises cl√≠nicas de retalhos de bioengenharia no cora√ß√£o anunciadas no Jap√£o</a></li>
<li><a href="../pt435812/index.html">Teoria da felicidade. A estat√≠stica como forma cient√≠fica de n√£o saber nada</a></li>
<li><a href="../pt435814/index.html">[The Old New Thing] Posso usar minha pilha como quiser?</a></li>
<li><a href="../pt435816/index.html">O Massachusetts Hospital e o DeepMind abriram independentemente a caixa preta da IA ‚Äã‚Äãem medicina</a></li>
<li><a href="../pt435822/index.html">Como controlar o hardware em um data center usando som</a></li>
<li><a href="../pt435824/index.html">O que voc√™ precisa saber antes de iniciar uma carreira na ind√∫stria de √°udio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>