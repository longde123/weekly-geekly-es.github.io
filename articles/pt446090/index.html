<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëæ üë©‚Äç‚öñÔ∏è ‚òÄÔ∏è Micropython no m√≥dulo GSM + GPS A9G üëä üè¨ üë©üèª‚Äçü§ù‚Äçüë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Desta vez, pensei em esconder um rastreador GPS na minha bicicleta como precau√ß√£o. Existem toneladas de dispositivos aut√¥nomos no mercado para rastrea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Micropython no m√≥dulo GSM + GPS A9G</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446090/"><p>  Desta vez, pensei em esconder um rastreador GPS na minha bicicleta como precau√ß√£o.  Existem toneladas de dispositivos aut√¥nomos no mercado para rastrear carros, cargas, bicicletas, malas, crian√ßas e animais.  A grande maioria deles interage com o usu√°rio via SMS.  Op√ß√µes mais caras fornecem a funcionalidade Localizar meu telefone, mas est√£o vinculadas a um servi√ßo online espec√≠fico. <br>  Idealmente, eu gostaria de ter controle total sobre o rastreador: use-o em um modo conveniente, sem SMS e registro.  O google superficial me trouxe alguns m√≥dulos da China, um dos quais eu pedi (placa de pudim A9G) (~ $ 15). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f7f/b34/fe0/f7fb34fe016bb3a6c532712b9b2e75e1.png" alt="M√≥dulo"></p><br><p>  Este artigo √© sobre como eu fiz o python funcionar neste m√≥dulo. </p><a name="habracut"></a><br><p>  Se o A9G for um an√°logo do ESP (a prop√≥sito, o fabricante √© o mesmo), a placa de pudim em si √© uma analogia da placa NodeMCU, exceto que a placa de pudim n√£o possui um conversor USB-UART embutido.  Mas h√° muitas outras coisas interessantes.  Especifica√ß√µes do <a href="">Fabricante</a> : </p><br><ul><li>  N√∫cleo de 32 bits (RISC), at√© 312 MHz </li><li>  GPIO 29x (todos s√£o soldados, todas as interfaces est√£o inclu√≠das neste n√∫mero) </li><li>  rel√≥gios e c√£o de guarda </li><li>  1x interface USB 1.1 (n√£o a encontrei l√°, mas copie do local) e microUSB para alimenta√ß√£o </li><li>  2x UART (servi√ßo +1) </li><li>  2x SPI (n√£o tentado) </li><li>  3x I2C (n√£o tentei) </li><li>  1x SDMMC (com slot f√≠sico) </li><li>  2x entradas anal√≥gicas (10 bits, possivelmente uma delas √© usada pelos controladores de bateria de l√≠tio) </li><li>  Flash de 4 Mb </li><li>  PSRAM de 4Mb </li><li>  ADC (microfone, existe fisicamente no quadro) e DAC (alto-falante, ausente) </li><li>  controlador de carga da bateria (n√£o h√° bateria propriamente dita) </li><li>  de fato, GSM (800, 900, 1800, 1900 MHz) com SMS, voz e GPRS </li><li>  GPS conectado via UART2 (existe um m√≥dulo "A9" sem ele) </li><li>  Slot SIM (nanoSIM) </li><li>  dois bot√µes (um reset, outro - inclus√£o e fun√ß√£o program√°vel) </li><li>  dois LEDs </li></ul><br><p>  A tens√£o operacional √© de 3,3V, a tens√£o de entrada √© de 5-3,8V (dependendo da conex√£o).  Em geral, o m√≥dulo possui todo o hardware necess√°rio para montar um simples dispositivo m√≥vel com bot√£o de press√£o.  Mas a partir dos exemplos, parece que os chineses est√£o comprando-o para venda em m√°quinas ca√ßa-n√≠queis ou ca√ßa-n√≠queis ou algo assim.  Alternativas ao m√≥dulo s√£o os bastante populares m√≥dulos SIM800, que, infelizmente, n√£o t√™m um SDK no dom√≠nio p√∫blico (ou seja, os m√≥dulos s√£o vendidos como modems AT). </p><br><h1>  SDK </h1><br><p> O m√≥dulo vem com um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SDK</a> em ingl√™s satisfat√≥rio.  Instala no Ubuntu, mas Windows e containers s√£o os preferidos.  Tudo funciona atrav√©s da cutucada na GUI: ESPtool para este m√≥dulo ainda n√£o foi revertida.  O firmware em si √© constru√≠do pelo Makefile.  O depurador est√° presente: antes do congelamento, o m√≥dulo lan√ßa o rastreamento de pilha na porta de servi√ßo.  Mas, pessoalmente, n√£o consegui traduzir os endere√ßos em linhas de c√≥digo (o gdb relata que os endere√ßos n√£o correspondem a nada).  √â poss√≠vel que isso se deva ao pouco suporte ao Linux como tal.  Portanto, se voc√™ quiser mexer no m√≥dulo - tente faz√™-lo no Windows (e cancele a inscri√ß√£o no github).  Caso contr√°rio, aqui est√° a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√£o</a> para Linux.  Ap√≥s a instala√ß√£o, √© necess√°rio verificar a corre√ß√£o dos caminhos no arquivo .bashrc e excluir (renomear) todos os <code>CSDTK/lib/libQt*</code> : caso contr√°rio, o pisca-pisca (tamb√©m conhecido como depurador) simplesmente n√£o ser√° iniciado devido a um conflito com o libQt instalado, provavelmente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7a7/955/5bc/7a79555bca02e1ad6363b8da9559c91e.png" alt="Flasher"></p><br><p>  Para o pisca-pisca h√° uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√£o</a> . </p><br><h1>  Liga√ß√£o </h1><br><p>  Tudo √© mais complicado do que no NodeMCU.  Os m√≥dulos parecem semelhantes, mas n√£o h√° chip USB-TTY na placa de pudim e o microUSB √© usado apenas para energia.  Assim, voc√™ precisar√° de USB-TTY em 3.3V.  Dois s√£o melhores: um para porta de depura√ß√£o e outro para UART1: o primeiro √© usado para fazer upload de firmware e o segundo que voc√™ pode usar como um terminal comum.  Para n√£o arrastar todos esses obst√°culos para o computador, comprei adicionalmente um divisor USB de 4 portas com um cabo de dois metros e uma fonte de alimenta√ß√£o externa (necess√°ria).  O custo total deste kit com o pr√≥prio m√≥dulo ser√° de US $ 25 a 30 (sem fonte de alimenta√ß√£o: use pelo telefone). </p><br><h1>  Firmware </h1><br><p>  O m√≥dulo vem com firmware AT: voc√™ pode conectar-se a um arduino de 3.3V e us√°-lo como modem via UART1.  Seu firmware est√° escrito em C. <code>make</code> cria dois arquivos de firmware: um √© costurado por cerca de um minuto, o outro √© r√°pido o suficiente.  Somente um desses arquivos pode ser costurado: a primeira vez √© grande, os tempos subsequentes s√£o pequenos.  No total, durante o processo de desenvolvimento, tenho o SDK chin√™s ( <code>coolwatcher</code> ) aberto na √°rea de trabalho para gerenciar o m√≥dulo, o miniterm como stdio e o editor de c√≥digo. </p><br><h1>  API </h1><br><p>  O conte√∫do da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API</a> reflete a lista acima e se assemelha ao ESP8266 nos primeiros dias: levei cerca de 3 horas para lan√ßar o HelloWorld.  Infelizmente, o conjunto de fun√ß√µes dispon√≠veis para o usu√°rio √© muito limitado: por exemplo, n√£o h√° acesso √† lista telef√¥nica no cart√£o SIM, informa√ß√µes de baixo n√≠vel sobre a conex√£o √† rede celular e assim por diante.  A documenta√ß√£o da API √© ainda menos completa, portanto, voc√™ deve confiar em exemplos (dos quais existem duas d√∫zias) e incluir arquivos.  No entanto, o m√≥dulo pode fazer muitas coisas at√© conex√µes SSL: obviamente, o fabricante focou nas fun√ß√µes mais priorit√°rias. </p><br><p>  No entanto, a programa√ß√£o de microcontroladores chineses por meio da API chinesa deve ser amada.  Para todos os outros, o fabricante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">come√ßou a portar</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">micropython</a> para este m√≥dulo.  Decidi me testar em um projeto de c√≥digo aberto e continuar esse bom trabalho (link no final do artigo). </p><br><h1>  micropython </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9a1/b46/e00/9a1b46e00d290db2f478ebb54f7d9e74.jpg" alt="logo"></p><br><p>  Micropython √© um projeto de c√≥digo aberto que transporta o cPython para microcontroladores.  O desenvolvimento √© realizado em duas dire√ß√µes.  O primeiro √© o suporte e o desenvolvimento de bibliotecas principais comuns a todos os microcontroladores que descrevem o trabalho com os principais tipos de dados em python: objetos, fun√ß√µes, classes, strings, tipos at√¥micos e muito mais.  A segunda √©, de fato, as portas: para cada microcontrolador √© necess√°rio "ensinar" a biblioteca a trabalhar com o UART para entrada e sa√≠da, selecionar uma pilha para uma m√°quina virtual, especificar um conjunto de otimiza√ß√µes.  Opcionalmente, o trabalho com hardware √© descrito: GPIO, energia, sem fio, sistema de arquivos. <br>  Tudo isso √© escrito em C puro com macros: o micropython possui um conjunto de receitas recomendadas, desde a declara√ß√£o de strings na ROM at√© a grava√ß√£o de m√≥dulos.  Al√©m disso, os m√≥dulos auto-escritos python s√£o totalmente suportados (o principal √© n√£o esquecer o tamanho da mem√≥ria).  Os curadores do projeto estabeleceram como objetivo a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">oportunidade de lan√ßar uma dzhanga</a> (figura com um peda√ßo de p√£o).  Como an√∫ncio publicit√°rio: o projeto vende sua pr√≥pria placa para estudantes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pyboard</a> , mas as portas para os m√≥dulos ESP8266 e ESP32 tamb√©m s√£o populares. </p><br><p>  Quando o firmware estiver pronto e carregado - basta conectar-se ao microcontrolador via UART e entrar no Python REPL. </p><br><pre> <code class="bash hljs">$ miniterm.py /dev/ttyUSB1 115200 --raw MicroPython cd2f742 on 2017-11-29; unicorn with Cortex-M3 Type <span class="hljs-string"><span class="hljs-string">"help()"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more information. &gt;&gt;&gt; <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"hello"</span></span>) hello</code> </pre> <br><p>  Depois disso, voc√™ pode come√ßar a escrever <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em python3 quase normal,</a> sem esquecer as limita√ß√µes de mem√≥ria. </p><br><p>  O m√≥dulo A9G n√£o √© oficialmente suportado (uma lista de m√≥dulos oficialmente suportados est√° dispon√≠vel em <code>micropython/ports</code> , existem cerca de uma d√∫zia deles).  No entanto, o fabricante de ferro bifurcou o micropython e criou o ambiente para a porta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>micropython/ports/gprs_a9</code></a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>micropython/ports/gprs_a9</code></a> , pela qual muitos agradecimentos a ele.  No momento em que me interessei por esse problema, a porta foi compilada com √™xito e o microcontrolador me recebeu com REPL.  Infelizmente, a partir de m√≥dulos de terceiros, havia apenas trabalho com o sistema de arquivos e o GPIO: nada relacionado √† rede sem fio e ao GPS estava dispon√≠vel.  Decidi consertar esse defeito e estabeleci o objetivo de portar todas as fun√ß√µes necess√°rias para um rastreador GPS.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A documenta√ß√£o oficial</a> para este caso √© desnecessariamente concisa: portanto, tive que vasculhar o c√≥digo. </p><br><h2>  Por onde come√ßar </h2><br><p>  Primeiro, v√° para <code>micropython/ports</code> e copie <code>micropython/ports/minimal</code> para a nova pasta em que a porta estar√° localizada.  Em seguida, edite <code>main.c</code> para sua plataforma.  Lembre-se de que todo o gostoso est√° na fun√ß√£o <code>main</code> , onde voc√™ precisa chamar o inicializador <code>mp_init()</code> , tendo preparado previamente o microcontrolador e as configura√ß√µes de pilha para ele.  Em seguida, para a API orientada a eventos, voc√™ precisa chamar <code>pyexec_event_repl_init()</code> e alimentar os caracteres digitados via UART para a fun√ß√£o <code>pyexec_event_repl_process_char(char)</code> .  Isso fornecer√° interoperabilidade atrav√©s do REPL.  O segundo arquivo, <code>micropython/ports/minimal/uart_core.c</code> descreve o bloqueio de entrada e sa√≠da no UART.  Eu trago o c√≥digo original do STM32 para aqueles que est√£o com pregui√ßa de procurar. </p><br><p> <code>main.c</code> </p> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stack_dummy; stack_top = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)&amp;stack_dummy; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> MICROPY_ENABLE_GC gc_init(heap, heap + sizeof(heap)); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> mp_init(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> MICROPY_ENABLE_COMPILER #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> MICROPY_REPL_EVENT_DRIVEN pyexec_event_repl_init(); for (;;) { int c = mp_hal_stdin_rx_chr(); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (pyexec_event_repl_process_char(c)) { break; } } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> pyexec_friendly_repl(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//do_str("print('hello world!', list(x+1 for x in range(10)), end='eol\\n')", MP_PARSE_SINGLE_INPUT); //do_str("for i in range(10):\r\n print(i)", MP_PARSE_FILE_INPUT); #else pyexec_frozen_module("frozentest.py"); #endif mp_deinit(); return 0; }</span></span></span></span></code> </pre> <br><p> <code>uart_core.c</code> </p> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Receive single character int mp_hal_stdin_rx_chr(void) { unsigned char c = 0; #if MICROPY_MIN_USE_STDOUT int r = read(0, &amp;c, 1); (void)r; #elif MICROPY_MIN_USE_STM32_MCU // wait for RXNE while ((USART1-&gt;SR &amp; (1 &lt;&lt; 5)) == 0) { } c = USART1-&gt;DR; #endif return c; } // Send string of given length void mp_hal_stdout_tx_strn(const char *str, mp_uint_t len) { #if MICROPY_MIN_USE_STDOUT int r = write(1, str, len); (void)r; #elif MICROPY_MIN_USE_STM32_MCU while (len--) { // wait for TXE while ((USART1-&gt;SR &amp; (1 &lt;&lt; 7)) == 0) { } USART1-&gt;DR = *str++; } #endif }</span></span></code> </pre> <br><p>  Depois disso, voc√™ precisa reescrever o Makefile usando as recomenda√ß√µes / compilador do fabricante: tudo aqui √© individual.  Tudo, idealmente, deve ser suficiente: coletamos, preenchemos o firmware e vemos REPL no UART. <br>  Ap√≥s reviver o <code>micropython</code> voc√™ precisa cuidar do seu bem-estar: configurar o coletor de lixo, a rea√ß√£o correta ao Ctrl-D (reinicializa√ß√£o suave) e algumas outras coisas nas quais n√£o vou me debru√ßar: consulte o arquivo <code>mpconfigport.h</code> . </p><br><h2>  Crie um m√≥dulo </h2><br><p>  O mais interessante √© escrever seus pr√≥prios m√≥dulos.  Portanto, o m√≥dulo (n√£o necess√°rio, mas desej√°vel) come√ßa com seu pr√≥prio arquivo <code>mod[].c</code> , que √© adicionado pelo <code>Makefile</code> (vari√°vel <code>SRC_C</code> , se voc√™ seguir a conven√ß√£o).  Um m√≥dulo vazio √© o seguinte: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// nlr - non-local return:  C  ,      goto-  . //  nlr_raise             . #include "py/nlr.h" //   .  ,  mp_map_elem_t,  ,   . #include "py/obj.h" //   . mp_raise_ValueError(char* msg)  mp_raise_OSError(int errorcode)   . //  ,   mp_call_function_*     Callable (  callback-). #include "py/runtime.h" #include "py/binary.h" //  header   :       #include "portmodules.h" //    --  .     MP_QSTR_[ ]. MP_OBJ_NEW_QSTR   . //             RAM. //      -      __name__ STATIC const mp_map_elem_t mymodule_globals_table[] = { { MP_OBJ_NEW_QSTR(MP_QSTR___name__), MP_OBJ_NEW_QSTR(MP_QSTR_mymodule) }, }; //      STATIC MP_DEFINE_CONST_DICT (mp_module_mymodule_globals, mymodule_globals_table); //   :             const mp_obj_module_t mp_module_mymodule = { .base = { &amp;mp_type_module }, .globals = (mp_obj_dict_t*)&amp;mp_module_mymodule_globals, };</span></span></code> </pre> <br><p>  Obviamente, a porta em si n√£o reconhece a constante <code>mp_module_mymodule</code> : ela deve ser adicionada √† vari√°vel <code>MICROPY_PORT_BUILTIN_MODULES</code> nas <code>mpconfigport.h</code> porta <code>mpconfigport.h</code> .  By the way <del>  pap√©is de parede chatos </del>  o nome do chip e o nome da porta tamb√©m mudam por l√°.  Ap√≥s todas essas altera√ß√µes, voc√™ pode tentar compilar o m√≥dulo e import√°-lo do REPL.  Somente um atributo <code>__name__</code> com o nome do m√≥dulo estar√° dispon√≠vel para o m√≥dulo (um √≥timo caso para verificar a conclus√£o autom√°tica no REPL via guia). </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mymodule &gt;&gt;&gt; mymodule.__name__ <span class="hljs-string"><span class="hljs-string">'mymodule'</span></span></code> </pre> <br><h2>  Constantes </h2><br><p>  O pr√≥ximo est√°gio da complexidade √© adicionar constantes.  As constantes geralmente s√£o necess√°rias para configura√ß√µes ( <code>INPUT</code> , <code>OUTPUT</code> , <code>HIGH</code> , <code>LOW</code> etc.) Tudo aqui √© bem simples.  Aqui, por exemplo, a constante <code>magic_number = 10</code> : </p><br><pre> <code class="cpp hljs">STATIC <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mp_map_elem_t</span></span> mymodule_globals_table[] = { { MP_OBJ_NEW_QSTR(MP_QSTR___name__), MP_OBJ_NEW_QSTR(MP_QSTR_mymodule) }, { MP_OBJ_NEW_QSTR(MP_QSTR_magic_number), MP_OBJ_NEW_SMALL_INT(<span class="hljs-number"><span class="hljs-number">10</span></span>) }, };</code> </pre> <br><p>  Teste: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mymodule &gt;&gt;&gt; mymodule.magic_number <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><h2>  Fun√ß√µes </h2><br><p>  A adi√ß√£o de uma fun√ß√£o a um m√≥dulo segue o princ√≠pio geral: declarar, quebrar, adicionar (eu dou um exemplo um pouco mais complexo do que na documenta√ß√£o). </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  STATIC mp_obj_t conditional_add_one(mp_obj_t value) { //   int.         -  :   . int value_int = mp_obj_get_int(value); value_int ++; if (value_int == 10) { //  None return mp_const_none; } //   int return mp_obj_new_int(value); } //    .     // runtime.h   . STATIC MP_DEFINE_CONST_FUN_OBJ_1(conditional_add_one_obj, conditional_add_one); //  STATIC const mp_map_elem_t mymodule_globals_table[] = { { MP_OBJ_NEW_QSTR(MP_QSTR___name__), MP_OBJ_NEW_QSTR(MP_QSTR_mymodule) }, { MP_OBJ_NEW_QSTR(MP_QSTR_magic_number), MP_OBJ_NEW_SMALL_INT(10) }, { MP_OBJ_NEW_QSTR(MP_QSTR_conditional_add_one), (mp_obj_t)&amp;conditional_add_one_obj }, };</span></span></code> </pre> <br><p>  Teste: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mymodule &gt;&gt;&gt; mymodule.conditional_add_one(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span> &gt;&gt;&gt; mymodule.conditional_add_one(<span class="hljs-number"><span class="hljs-number">9</span></span>) &gt;&gt;&gt;</code> </pre> <br><h2>  Classes (Tipos) </h2><br><p>  Com as classes (tipos), tudo tamb√©m √© relativamente simples.  Aqui est√° um exemplo da documenta√ß√£o (bem, quase): </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//     STATIC const mp_map_elem_t mymodule_hello_locals_dict_table[] = {}; //   STATIC MP_DEFINE_CONST_DICT(mymodule_hello_locals_dict, mymodule_hello_locals_dict_table); // ,  ,   const mp_obj_type_t mymodule_helloObj_type = { //    { &amp;mp_type_type }, // : helloObj .name = MP_QSTR_helloObj, //  .locals_dict = (mp_obj_dict_t*)&amp;mymodule_hello_locals_dict, }; //    STATIC const mp_map_elem_t mymodule_globals_table[] = { { MP_OBJ_NEW_QSTR(MP_QSTR___name__), MP_OBJ_NEW_QSTR(MP_QSTR_mymodule) }, { MP_OBJ_NEW_QSTR(MP_QSTR_magic_number), MP_OBJ_NEW_SMALL_INT(10) }, { MP_OBJ_NEW_QSTR(MP_QSTR_conditional_add_one), (mp_obj_t)&amp;conditional_add_one_obj }, { MP_OBJ_NEW_QSTR(MP_QSTR_conditional_add_one), (mp_obj_t)&amp;mymodule_helloObj_type }, };</span></span></code> </pre> <br><p>  Teste: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>mymodule.helloObj &lt;type <span class="hljs-string"><span class="hljs-string">'helloObj'</span></span>&gt;</code> </pre> <br><p>  O tipo resultante pode ser herdado, comparado, mas n√£o possui um construtor ou dados associados.  Os dados s√£o adicionados "ao lado" do construtor: prop√µe-se criar uma estrutura separada na qual o tipo Python ser√° armazenado separadamente e separadamente - um conjunto de dados arbitr√°rio. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  -. ,    typedef struct _mymodule_hello_obj_t { //   mp_obj_base_t base; // -  uint8_t hello_number; } mymodule_hello_obj_t;</span></span></code> </pre> <br><p>  Como interagir com esses dados?  Uma das maneiras mais dif√≠ceis √© atrav√©s do construtor. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// -,   (,  ,   mymodule_helloObj_type //   ,     - ),   (args  kwargs)  //        : args, kwargs STATIC mp_obj_t mymodule_hello_make_new( const mp_obj_type_t *type, size_t n_args, size_t n_kw, const mp_obj_t *args ) { //    mp_arg_check_num(n_args, n_kw, 1, 1, true); //   mymodule_hello_obj_t *self = m_new_obj(mymodule_hello_obj_t); //     self-&gt;base.type = &amp;mymodule_hello_type; //   self-&gt;hello_number = mp_obj_get_int(args[0]) //   return MP_OBJ_FROM_PTR(self); //    __init__, ,  } //      make_new const mp_obj_type_t mymodule_helloObj_type = { { &amp;mp_type_type }, .name = MP_QSTR_helloObj, .locals_dict = (mp_obj_dict_t*)&amp;mymodule_hello_locals_dict, //  .make_new = mymodule_hello_make_new, };</span></span></code> </pre> <br><p>  Dos outros campos, h√° tamb√©m <code>.print</code> , e acho que o resto da magia do <code>Python3</code> . </p><br><p>  Mas <code>make_new</code> n√£o √© necess√°rio para obter uma inst√¢ncia de um objeto: a inicializa√ß√£o pode ser feita em uma fun√ß√£o arbitr√°ria.  Aqui est√° um bom exemplo de <code>micropython/ports/esp32/modsocket.c</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   :       STATIC mp_obj_t get_socket(size_t n_args, const mp_obj_t *args) { socket_obj_t *sock = m_new_obj_with_finaliser(socket_obj_t); sock-&gt;base.type = &amp;socket_type; sock-&gt;domain = AF_INET; sock-&gt;type = SOCK_STREAM; sock-&gt;proto = 0; sock-&gt;peer_closed = false; if (n_args &gt; 0) { sock-&gt;domain = mp_obj_get_int(args[0]); if (n_args &gt; 1) { sock-&gt;type = mp_obj_get_int(args[1]); if (n_args &gt; 2) { sock-&gt;proto = mp_obj_get_int(args[2]); } } } sock-&gt;fd = lwip_socket(sock-&gt;domain, sock-&gt;type, sock-&gt;proto); if (sock-&gt;fd &lt; 0) { exception_from_errno(errno); } _socket_settimeout(sock, UINT64_MAX); return MP_OBJ_FROM_PTR(sock); } //     0-3  STATIC MP_DEFINE_CONST_FUN_OBJ_VAR_BETWEEN(get_socket_obj, 0, 3, get_socket);</span></span></code> </pre> <br><h2>  M√©todos vinculados </h2><br><p>  O pr√≥ximo passo √© adicionar os m√©todos vinculados.  No entanto, isso n√£o √© muito diferente de todos os outros m√©todos.  Retornamos ao exemplo da documenta√ß√£o: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    :     1 (self) STATIC mp_obj_t mymodule_hello_increment(mp_obj_t self_in) { mymodule_hello_obj_t *self = MP_OBJ_TO_PTR(self_in); self-&gt;hello_number += 1; return mp_const_none; } //     MP_DEFINE_CONST_FUN_OBJ_1(mymodule_hello_increment_obj, mymodule_hello_increment); //      'inc' STATIC const mp_map_elem_t mymodule_hello_locals_dict_table[] = { { MP_OBJ_NEW_QSTR(MP_QSTR_inc), (mp_obj_t)&amp;mymodule_hello_increment_obj }, }</span></span></code> </pre> <br><p>  Isso √© tudo! </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>x = mymodule.helloObj(<span class="hljs-number"><span class="hljs-number">12</span></span>) &gt;&gt;&gt; x.inc()</code> </pre> <br><h2>  Todos os outros atributos: <strong>getattr</strong> , <strong>setattr</strong> </h2><br><p>  Que tal adicionar n√£o fun√ß√µes, usando <code>@property</code> e geralmente seu pr√≥prio <code>__getattr__</code> ?  Por favor: isso √© feito manualmente ignorando <code>mymodule_hello_locals_dict_table</code> . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//     ... STATIC void mymodule_hello_attr(mp_obj_t self_in, qstr attr, mp_obj_t *dest) { mymodule_hello_obj_t *self = MP_OBJ_TO_PTR(self_in); if (dest[0] != MP_OBJ_NULL) { // __setattr__ if (attr == MP_QSTR_val) { self-&gt;val = dest[1]; dest[0] = MP_OBJ_NULL; } } else { // __getattr__ if (attr == MP_QSTR_val) { dest[0] = self-&gt;val; } } } // ...     attr const mp_obj_type_t mymodule_helloObj_type = { { &amp;mp_type_type }, .name = MP_QSTR_helloObj, //     //.locals_dict = (mp_obj_dict_t*)&amp;mymodule_hello_locals_dict, .make_new = mymodule_hello_make_new, //   - attr .attr = mymodule_hello_attr, };</span></span></code> </pre><br><p>  Algo dolorosamente conciso acabou, voc√™ diz.  Onde est√£o todos esses <code>mp_raise_AttributeError</code> ( <em>nota</em> : essa fun√ß√£o n√£o existe)?  De fato, um <code>AttributeError</code> ser√° chamado automaticamente.  O segredo √© que <code>dest</code> √© uma matriz de dois elementos.  O primeiro elemento tem o significado de "sa√≠da", somente grava√ß√£o: ele assume o valor <code>MP_OBJ_SENTINEL</code> se o valor precisar ser gravado e <code>MP_OBJ_NULL</code> se precisar ser lido.  Assim, na sa√≠da da fun√ß√£o, <code>MP_OBJ_NULL</code> √© esperado no primeiro caso e algo <code>mp_obj_t</code> no segundo.  O segundo elemento √© entrada, somente leitura: pega o valor do objeto a ser gravado se o valor precisar ser gravado e <code>MP_OBJ_NULL</code> se precisar ser lido.  Voc√™ n√£o precisa mudar isso. </p><br><p>  Isso √© tudo, voc√™ pode verificar: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>x = mymodule.helloObj(<span class="hljs-number"><span class="hljs-number">12</span></span>) &gt;&gt;&gt; x.val = <span class="hljs-number"><span class="hljs-number">3</span></span> &gt;&gt;&gt; x.val <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  O mais interessante √© que a conclus√£o da guia no REPL ainda funciona e oferece <code>.val</code> !  Para ser sincero, n√£o sou especialista em C, portanto, s√≥ posso adivinhar como isso acontece (redefinindo o operador '=='). </p><br><h2>  Port </h2><br><p>  Voltando ao m√≥dulo A9G, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descrevi o</a> suporte de todas as fun√ß√µes b√°sicas, como SMS, GPRS (usockets), GPS, gerenciamento de energia.  Agora voc√™ pode enviar algo assim para o m√≥dulo e ele funcionar√°: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cellular <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> usocket <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sock <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gps <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> machine <span class="hljs-comment"><span class="hljs-comment">#   print("Waiting network registration ...") while not c.is_network_registered(): time.sleep(1) time.sleep(2) #  GPRS print("Activating ...") c.gprs_activate("internet", "", "") print("Local IP:", sock.get_local_ip()) #  GPS gps.on() #    thingspeak host = "api.thingspeak.com" api_key = "some-api-key" fields = ('latitude', 'longitude', 'battery', 'sat_visible', 'sat_tracked') #  ,      ! fields = dict(zip(fields, map(lambda x: "field{}".format(x+1), range(len(fields))) )) x, y = gps.get_location() level = machine.get_input_voltage()[1] sats_vis, sats_tracked = gps.get_satellites() s = sock.socket() print("Connecting ...") s.connect((host, 80)) print("Sending ...") #      ,     HTTP.           HTTP, SSL   print("Sent:", s.send("GET /update?api_key={}&amp;{latitude}={:f}&amp;{longitude}={:f}&amp;{battery}={:f}&amp;{sat_visible}={:d}&amp;{sat_tracked}={:d} HTTP/1.1\r\nHost: {}\r\nConnection: close\r\n\r\n".format( api_key, x, y, level, sats_vis, sats_tracked, host, **fields ))) print("Receiving ...") print("Received:", s.recv(128)) s.close()</span></span></code> </pre> <br><p>  O projeto agradece qualquer ajuda poss√≠vel.  Se voc√™ gostou do projeto e / ou deste artigo, n√£o se esque√ßa de deixar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">like no github</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt446090/">https://habr.com/ru/post/pt446090/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt446078/index.html">"Som": discutindo um podcast sobre tecnologia de √°udio</a></li>
<li><a href="../pt446080/index.html">Nos EUA, o tribunal recomendou proibir a importa√ß√£o de certos modelos de iPhone devido √† viola√ß√£o das patentes da Qualcomm Apple</a></li>
<li><a href="../pt446082/index.html">O Conto dos Meios An√©is</a></li>
<li><a href="../pt446086/index.html">Hist√≥ria do Linux. Parte III: novos mercados e velhos "inimigos"</a></li>
<li><a href="../pt446088/index.html">Coisas que n√£o sei em 2018</a></li>
<li><a href="../pt446092/index.html">S√≥ sem m√£os! Rob√¥s que n√£o repetem a√ß√µes do usu√°rio</a></li>
<li><a href="../pt446094/index.html">Com uma tabela peri√≥dica para toda a vida</a></li>
<li><a href="../pt446096/index.html">O livro ‚ÄúTasteVill: Como fazer uma revolu√ß√£o no varejo, fazendo tudo errado‚Äù</a></li>
<li><a href="../pt446098/index.html">Centro de controle de v√¥o sovi√©tico dos tempos de "Vostok" e "Sunrise"</a></li>
<li><a href="../pt446100/index.html">Crie automaticamente arquivos de localiza√ß√£o Android e iOS a partir da planilha do Excel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>