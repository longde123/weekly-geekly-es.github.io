<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÇ üöæ üë®üèº‚Äç‚öñÔ∏è Guia Discovery.js: In√≠cio r√°pido ‚ñ´Ô∏è ü§πüèø üßóüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este e os guias a seguir o guiar√£o pelo processo de cria√ß√£o de uma solu√ß√£o baseada no projeto Discovery.js . Nosso objetivo √© criar um inspetor para d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Guia Discovery.js: In√≠cio r√°pido</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/469115/"><p> Este e os guias a seguir o guiar√£o pelo processo de cria√ß√£o de uma solu√ß√£o baseada no projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Discovery.js</a> .  Nosso objetivo √© criar um inspetor para depend√™ncias do NPM, ou seja, uma interface para examinar a estrutura de <code>node_modules</code> . </p><br><p><img src="https://habrastorage.org/webt/ih/d_/sc/ihd_schofzsmx1xbptuvltrxmu8.png"></p><br><blockquote>  Nota: O Discovery.js est√° em um est√°gio inicial de desenvolvimento, portanto, com o tempo, algo ser√° simplificado e se tornar√° mais √∫til.  Se voc√™ tem id√©ias sobre como melhorar algo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escreva-nos</a> . </blockquote><br><h2 id="annotaciya">  Anota√ß√£o </h2><br><p>  Abaixo, voc√™ encontrar√° uma vis√£o geral dos principais conceitos do Discovery.js.  Voc√™ pode aprender todo o c√≥digo do manual <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no reposit√≥rio no GitHub</a> , ou pode tentar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como ele funciona online</a> . </p><a name="habracut"></a><br><h2 id="nachalnye-usloviya">  Condi√ß√µes iniciais </h2><br><p>  Primeiro de tudo, precisamos escolher um projeto para an√°lise.  Pode ser um projeto rec√©m-criado ou um projeto existente, o principal √© que ele cont√©m <code>node_modules</code> (o objeto de nossa an√°lise). </p><br><p>  Primeiro, instale o pacote principal do <code>discoveryjs</code> e suas ferramentas de console: </p><br><pre> <code class="bash hljs">npm install @discoveryjs/discovery @discoveryjs/cli</code> </pre> <br><p>  Em seguida, inicie o servidor Discovery.js: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery No config is used Models are not defined (model free mode is enabled) Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Se voc√™ abrir <code>http://localhost:8123</code> no navegador, poder√° ver o seguinte: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4e6/fc9/228/4e6fc922872955e6a2f3355e2856b3d1.png" alt="Descoberta sem configura√ß√£o"></p><br><p>  Este √© um modo sem modelo, ou seja, quando nada est√° configurado.  Mas agora, usando o bot√£o "Carregar dados", voc√™ pode selecionar qualquer arquivo JSON ou simplesmente arrast√°-lo para a p√°gina e iniciar a an√°lise. </p><br><p>  No entanto, precisamos de algo espec√≠fico.  Em particular, precisamos obter uma vis√£o da estrutura <code>node_modules</code> .  Para fazer isso, adicione a configura√ß√£o. </p><br><h2 id="dobavlyaem-konfiguraciyu">  Adicionar configura√ß√£o </h2><br><p>  Como voc√™ deve ter notado, a mensagem <code>No config is used</code> exibida quando o servidor foi iniciado.  Vamos criar um arquivo de configura√ß√£o <code>.discoveryrc.js</code> com o seguinte conte√∫do: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, data() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span> }; } };</code> </pre> <br><p>  Nota: se voc√™ criar um arquivo no diret√≥rio de trabalho atual (ou seja, na raiz do projeto), nada mais ser√° necess√°rio.  Caso contr√°rio, voc√™ precisar√° passar o caminho para o arquivo de configura√ß√£o usando a op√ß√£o <code>--config</code> ou defina o caminho no <code>package.json</code> : </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"discovery"</span></span>: <span class="hljs-string"><span class="hljs-string">"path/to/discovery/config.js"</span></span>, ... }</code> </pre> <br><p>  Reinicie o servidor para que a configura√ß√£o seja aplicada: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery Load config from .discoveryrc.js Init single model default Define default routes ... OK Cache: DISABLED Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Como voc√™ pode ver, agora o arquivo que criamos √© usado.  E o modelo padr√£o descrito por n√≥s √© aplicado (o Discovery pode funcionar no modo de muitos modelos, falaremos sobre esse recurso nos manuais a seguir).  Vamos ver o que mudou no navegador: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/16f/f45/ac8/16ff45ac8eef467b6ccd0ff5624c9652.png" alt="Com configura√ß√£o b√°sica"></p><br><p>  O que pode ser visto aqui: </p><br><ul><li>  <code>name</code> usado como o t√≠tulo da p√°gina; </li><li>  o resultado da chamada do m√©todo de <code>data</code> √© exibido como o conte√∫do principal da p√°gina. </li></ul><br><blockquote>  Nota: o m√©todo <code>data</code> deve retornar dados ou Promise, que s√£o resolvidos. </blockquote><p>  As configura√ß√µes b√°sicas s√£o feitas, voc√™ pode seguir em frente. </p><br><h2 id="kontekst">  Contexto </h2><br><p>  Vejamos a p√°gina do relat√≥rio personalizado (clique em <code>Make report</code> ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/def/52b/57a/def52b57a6be174730f07fe55273517a.png" alt="P√°gina relat√≥rio"></p><br><p>  √Ä primeira vista, isso n√£o √© muito diferente da p√°gina inicial ... Mas aqui voc√™ pode mudar tudo!  Por exemplo, podemos recriar facilmente a apar√™ncia da p√°gina inicial: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/919/de1/c6c919de17d2fed5bdb0501fe1ff9dae.png" alt="Recriando uma p√°gina inicial"></p><br><p>  Observe como o cabe√ßalho est√° definido: <code>"h1:#.name"</code> .  Este √© o cabe√ßalho de primeiro n√≠vel com o conte√∫do de <code>#.name</code> , que √© uma solicita√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Jora</a> .  <code>#</code> refere-se ao contexto da solicita√ß√£o.  Para visualizar seu conte√∫do, basta digitar <code>#</code> no editor de consultas e usar a exibi√ß√£o padr√£o: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/524/7a6/2cc/5247a62cc6194ab9bd4797c21ab084b9.png" alt="Valores de contexto"></p><br><p>  Agora voc√™ sabe como obter o ID da p√°gina atual, seus par√¢metros e outros valores √∫teis. </p><br><h2 id="sbor-dannyh">  Coleta de dados </h2><br><p>  Agora usamos um esbo√ßo no projeto em vez de dados reais, mas precisamos de dados reais.  Para fazer isso, crie um m√≥dulo e altere o valor dos <code>data</code> na configura√ß√£o (a prop√≥sito, ap√≥s essas altera√ß√µes, n√£o √© necess√°rio reiniciar o servidor): </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>) };</code> </pre> <br><p>  O conte√∫do de <code>collect-node-modules-data.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> scanFs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/scan-fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packages = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scanFs({ <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [<span class="hljs-string"><span class="hljs-string">'node_modules'</span></span>], <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\/package.json$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">extract</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, content</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pkg = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(content); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pkg.name &amp;&amp; pkg.version) { packages.push({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: pkg.name, <span class="hljs-attr"><span class="hljs-attr">version</span></span>: pkg.version, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: path.dirname(file.filename), <span class="hljs-attr"><span class="hljs-attr">dependencies</span></span>: pkg.dependencies }); } } }] }).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> packages); };</code> </pre> <br><p>  Usei o pacote <code>@discoveryjs/scan-fs</code> , que simplifica a verifica√ß√£o do sistema de arquivos.  Um exemplo de uso do pacote √© descrito em seu leia-me, tomei este exemplo como base e finalizei conforme necess√°rio.  Agora, temos algumas informa√ß√µes sobre o conte√∫do de <code>node_modules</code> : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d0c/f24/64c/d0cf2464cadda8a8bc0433871200ae9b.png" alt="Dados coletados"></p><br><p>  O que voc√™ precisa!  E, apesar do JSON comum, j√° podemos analis√°-lo e tirar algumas conclus√µes.  Por exemplo, usando o pop-up da estrutura de dados, voc√™ pode descobrir o n√∫mero de pacotes e descobrir quantos deles t√™m mais de uma inst√¢ncia f√≠sica (devido √† diferen√ßa nas vers√µes ou nos problemas com a deduplica√ß√£o). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8f3/93e/5e0/8f393e5e05a1385aa11aad92d8ad15a0.png" alt="Pesquisa de estrutura de dados"></p><br><p>  Apesar de j√° termos alguns dados, precisamos de mais detalhes.  Por exemplo, seria bom saber qual inst√¢ncia f√≠sica resolve cada uma das depend√™ncias declaradas de um m√≥dulo espec√≠fico.  No entanto, o trabalho para melhorar a extra√ß√£o de dados est√° al√©m do escopo deste guia.  Portanto, iremos substitu√≠-lo pelo pacote <code>@discoveryjs/node-modules</code> (que tamb√©m √© baseado em <code>@discoveryjs/scan-fs</code> ) para recuperar os dados e obter os detalhes necess√°rios sobre os pacotes.  Como resultado, o <code>collect-node-modules-data.js</code> bastante simplificado: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fetchNodeModules = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/node-modules'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fetchNodeModules(); };</code> </pre> <br><p>  Agora, as informa√ß√µes sobre o <code>node_modules</code> assim: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1f5/1c2/187/1f51c2187d527694cbf71089e8d74ba8.png" alt="Nova estrutura de dados"></p><br><h2 id="skript-podgotovki">  Script de prepara√ß√£o </h2><br><p>  Como voc√™ deve ter notado, alguns objetos que descrevem pacotes cont√™m <code>deps</code> - uma lista de depend√™ncias.  Cada depend√™ncia possui um campo <code>resolved</code> cujo valor √© uma refer√™ncia a uma inst√¢ncia f√≠sica do pacote.  Esse link √© o valor do <code>path</code> de um dos pacotes, √© √∫nico.  Para resolver o link para o pacote, voc√™ precisa usar c√≥digo adicional (por exemplo, <code>#.data.pick(&lt;path=resolved&gt;)</code> ).  E, √© claro, seria muito mais conveniente se esses links j√° fossem resolvidos em refer√™ncias a objetos. </p><br><p>  Infelizmente, no est√°gio de coleta de dados, n√£o podemos resolver os links, pois isso levar√° a conex√µes circulares, o que criar√° o problema de transferir esses dados na forma de JSON.  No entanto, existe uma solu√ß√£o: este √© um script de <code>prepare</code> especial.  √â definido na configura√ß√£o e chamado sempre que um novo dado √© atribu√≠do √† inst√¢ncia do Discovery.  Vamos come√ßar com a configura√ß√£o: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... prepare: __dirname + <span class="hljs-string"><span class="hljs-string">'/prepare.js'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// :   ,    ... };</span></span></code> </pre> <br><p>  Defina <code>prepare.js</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -  data /   discovery });</span></span></code> </pre> <br><p>  Neste m√≥dulo, definimos a fun√ß√£o de <code>prepare</code> para a inst√¢ncia Discovery.  Essa fun√ß√£o √© chamada sempre antes de aplicar dados √† inst√¢ncia do Discovery.  Este √© um bom lugar para permitir valores nas refer√™ncias de objetos: </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packageIndex = data.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, pkg</span></span></span><span class="hljs-function">) =&gt;</span></span> map.set(pkg.path, pkg), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); data.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pkg</span></span></span><span class="hljs-function"> =&gt;</span></span> pkg.deps.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dep</span></span></span><span class="hljs-function"> =&gt;</span></span> dep.resolved = packageIndex.get(dep.resolved) ) ); });</code> </pre> <br><p>  Aqui, criamos um √≠ndice de pacote no qual a chave √© o valor do <code>path</code> do pacote (exclusivo).  Depois, examinamos todos os pacotes e suas depend√™ncias e, nas depend√™ncias, substitu√≠mos o valor <code>resolved</code> por uma refer√™ncia ao objeto do pacote.  Resultado: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/95b/277/dd6/95b277dd63dc3aff1fdf3716c6881356.png" alt="Deps.resolvido convertido"></p><br><p>  Agora √© muito mais f√°cil fazer consultas ao gr√°fico de depend√™ncia.  √â assim que voc√™ pode obter um cluster de depend√™ncias (ou seja, depend√™ncias, depend√™ncias, etc.) para um pacote espec√≠fico: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c64/793/a78/c64793a78d40961af1b234fc111e4dc2.png" alt="Exemplo de cluster de depend√™ncia"></p><br><blockquote>  Uma hist√≥ria de sucesso inesperada: enquanto estudava os dados durante a reda√ß√£o do manual, descobri um problema no <code>@discoveryjs/cli</code> (usando a consulta <code>.[deps.[not resolved]]</code> ), que tinha um erro de digita√ß√£o nas depend√™ncias de pares.  O problema <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">foi corrigido</a> imediatamente.  O caso √© um bom exemplo de como essas ferramentas ajudam. </blockquote><p>  Talvez tenha chegado a hora de mostrar na p√°gina inicial v√°rios n√∫meros e pacotes com takes. </p><br><h2 id="nastraivaem-startovuyu-stranicu">  Personalizar p√°gina inicial </h2><br><p>  Primeiro, precisamos criar um m√≥dulo de p√°gina, por exemplo, <code>pages/default.js</code> .  Usamos o <code>default</code> , porque esse √© o identificador da p√°gina inicial, que podemos substituir (no Discovery.js, voc√™ pode substituir muito).  Vamos come√ßar com algo simples, por exemplo: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, <span class="hljs-string"><span class="hljs-string">'text:"Hello world!"'</span></span> ]);</code> </pre> <br><p>  Agora, na configura√ß√£o, voc√™ precisa conectar o m√≥dulo de p√°gina: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>), <span class="hljs-attr"><span class="hljs-attr">view</span></span>: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//     ] } };</span></span></code> </pre> <br><p>  Verifique no navegador: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e0c/d07/8d5/e0cd078d55637ef62a697809544909b9.png" alt="P√°gina inicial substitu√≠da"></p><br><p>  Isso funciona! </p><br><p>  Agora vamos pegar alguns contadores.  Para fazer isso, fa√ßa altera√ß√µes em <code>pages/default.js</code> : </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'indicator'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`[ { label: 'Package entries', value: size() }, { label: 'Unique packages', value: name.size() }, { label: 'Dup packages', value: group(&lt;name&gt;).[value.size() &gt; 1].size() } ]`</span></span> } ]);</code> </pre> <br><p>  Aqui, definimos uma lista embutida de indicadores.  O valor dos <code>data</code> √© uma consulta Jora que cria uma matriz de registros.  A lista de pacotes (raiz de dados) √© usada como base para as consultas; portanto, obtemos o tamanho da lista ( <code>size()</code> ), o n√∫mero de nomes de pacotes exclusivos ( <code>name.size()</code> ) e o n√∫mero de nomes de pacotes duplicados ( <code>group(&lt;name&gt;).[value.size() &gt; 1].size()</code> ). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebf/c97/8a2/ebfc978a2b2da44214a99a8382e17107.png" alt="Coloque indicadores na p√°gina inicial"></p><br><p>  Nada mal.  No entanto, seria melhor ter, al√©m de n√∫meros, links para as amostras correspondentes: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Package entries'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Unique packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Dup packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'group(&lt;name&gt;).[value.size() &gt; 1]'</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">`indicator:{ label, value: value.query(#.data, #).size(), href: pageLink('report', { query: value, title: label }) }`</span></span> } ]);</code> </pre> <br><p>  Primeiro, alteramos o valor dos <code>data</code> , agora √© uma matriz regular com alguns objetos.  Al√©m disso, o m√©todo <code>size()</code> foi removido das solicita√ß√µes de valor. </p><br><p>  Al√©m disso, uma subconsulta foi adicionada √† exibi√ß√£o do <code>indicator</code> .  Esses tipos de consultas criam um novo objeto para cada elemento no qual o <code>value</code> e <code>href</code> s√£o calculados.  Para <code>value</code> , uma consulta √© executada usando o m√©todo <code>query()</code> , para o qual os dados s√£o transferidos do contexto e, em seguida, o m√©todo <code>size()</code> √© aplicado ao resultado da consulta.  Para <code>href</code> , √© usado o m√©todo <code>pageLink()</code> , que gera um link para a p√°gina do relat√≥rio com uma solicita√ß√£o e cabe√ßalho espec√≠ficos.  Ap√≥s todas essas altera√ß√µes, os indicadores se tornaram clic√°veis ‚Äã‚Äã(observe que seus valores se tornaram azuis) e mais funcionais. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e72/104/33c/e7210433ca45798701f34c6625cae050.gif" alt="Indicadores clic√°veis"></p><br><p>  Para tornar a p√°gina inicial mais √∫til, adicione uma tabela com pacotes com duplicatas. </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-comment"><span class="hljs-comment">// ...      'h2:"Packages with more than one physical instance"', { view: 'table', data: ` group(&lt;name&gt;) .[value.size() &gt; 1] .sort(&lt;value.size()&gt;) .reverse() `, cols: [ { header: 'Name', content: 'text:key' }, { header: 'Version &amp; Location', content: { view: 'list', data: 'value.sort(&lt;version&gt;)', item: [ 'badge:version', 'text:path' ] } } ] } ]);</span></span></code> </pre> <br><p>  A tabela usa os mesmos dados que o indicador de <code>Dup packages</code> .  A lista de pacotes foi classificada por tamanho de grupo na ordem inversa.  O restante da configura√ß√£o est√° relacionado √†s colunas (a prop√≥sito, geralmente elas n√£o precisam ser ajustadas).  Para a coluna <code>Version &amp; Location</code> , definimos uma lista aninhada (classificada por vers√£o), na qual cada elemento √© um par do n√∫mero da vers√£o e o caminho para a inst√¢ncia. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a50/5fd/4ab/a505fd4aba48f6a0d025fc5cd4b84b24.png" alt="Tabela adicionada com pacotes que possuem mais de uma inst√¢ncia f√≠sica"></p><br><h2 id="stranica-paketov">  P√°gina do pacote </h2><br><p>  Agora temos apenas uma vis√£o geral dos pacotes.  Mas seria √∫til ter uma p√°gina com detalhes sobre um pacote espec√≠fico.  Para fazer isso, crie um novo m√≥dulo <code>pages/package.js</code> e defina uma nova p√°gina: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'context'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`{ name: #.id, instances: .[name = #.id] }`</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: [ <span class="hljs-string"><span class="hljs-string">'h1:name'</span></span>, <span class="hljs-string"><span class="hljs-string">'table:instances'</span></span> ] });</code> </pre> <br><p>  Neste m√≥dulo, definimos a p√°gina com o <code>package</code> identificador.  O componente de <code>context</code> foi utilizado como representa√ß√£o inicial.  Este √© um componente n√£o visual que ajuda a definir dados para mapeamentos aninhados.  Observe que usamos <code>#.id</code> para obter o nome do pacote, que √© recuperado de uma URL como esta <code>http://localhost:8123/#package:{id}</code> . </p><br><p>  N√£o esque√ßa de incluir o novo m√≥dulo na configura√ß√£o: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'pages/package.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//   ] } };</span></span></code> </pre> <br><p>  Resultado no navegador: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3ee/698/da0/3ee698da0907aebaa1ace032942c0575.png" alt="Exemplo de p√°gina de pacote"></p><br><p>  N√£o √© muito impressionante, mas por enquanto.  Criaremos mapeamentos mais complexos nos manuais subseq√ºentes. </p><br><h2 id="bokovaya-panel">  Painel lateral </h2><br><p>  Como j√° temos uma p√°gina de pacote, seria bom ter uma lista de todos os pacotes.  Para fazer isso, voc√™ pode definir uma vista especial - <code>sidebar</code> , que ser√° exibida se estiver definida (n√£o definida por padr√£o).  Crie um novo m√≥dulo <code>views/sidebar.js</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'link:{ text: $, href: pageLink("package") }'</span></span> });</code> </pre> <br><p>  Agora temos uma lista de todos os pacotes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/503/326/a02/503326a020869af76a3b2076c5df2394.png" alt="Barra lateral adicionada"></p><br><p>  Parece bom.  Mas com um filtro seria ainda melhor.  Expandimos a defini√ß√£o de <code>sidebar</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'content-filter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.[no #.filter or $~=#.filter].sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'link'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'{ text: $, href: pageLink("package"), match: #.filter }'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">'text-match'</span></span> } } });</code> </pre> <br><p>  Aqui, agrupamos a lista em um componente de <code>content-filter</code> que converte o valor de entrada no campo de entrada em express√µes regulares (ou <code>null</code> se o campo estiver vazio) e o salva como um valor de <code>filter</code> no contexto (o nome pode ser alterado com a op√ß√£o de <code>name</code> ).  Al√©m disso, para filtrar os dados da lista, usamos <code>#.filter</code> .  Por fim, aplicamos o mapeamento de links para destacar partes correspondentes com correspond√™ncia de <code>text-match</code> .  Resultado: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d55/74f/67e/d5574f67e7a2dd222194c66f5ecf0673.png" alt="Lista de filtros"></p><br><p>  Caso n√£o goste do design padr√£o, voc√™ pode personalizar os estilos como desejar.  Digamos que voc√™ queira alterar a largura da barra lateral. Para isso, √© necess√°rio criar um arquivo de estilo (por exemplo, <code>views/sidebar.css</code> ): </p><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.discovery-sidebar</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">300px</span></span>; }</code> </pre> <br><p>  E adicione um link a este arquivo na configura√ß√£o, bem como aos m√≥dulos JavaScript: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ ... <span class="hljs-string"><span class="hljs-string">'views/sidebar.css'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  assets    *.css  'views/sidebar.js' ] } };</span></span></code> </pre> <br><h2 id="avtossylki">  AutoLinks </h2><br><p>  O cap√≠tulo final deste guia √© dedicado aos links.  Anteriormente, usando o m√©todo <code>pageLink()</code> , criamos um link para a p√°gina do pacote.  Mas, al√©m do link, voc√™ tamb√©m deve definir o texto do link.  Mas como facilitamos? </p><br><p>  Para simplificar o trabalho dos links, precisamos definir uma regra para gerar links.  √â melhor fazer isso no script de <code>prepare</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ ... const packageIndex = data.reduce( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, item</span></span></span><span class="hljs-function">) =&gt;</span></span> map .set(item, item) <span class="hljs-comment"><span class="hljs-comment">// key is item itself .set(item.name, item), // and `name` value new Map() ); discovery.addEntityResolver(value =&gt; { value = packageIndex.get(value) || packageIndex.get(value.name); if (value) { return { type: 'package', id: value.name, name: value.name }; } }); });</span></span></code> </pre> <br><p>  Adicionamos um novo mapa (√≠ndice) de pacotes e o usamos para resolver entidades.  O resolvedor de entidades tenta, se poss√≠vel, converter o valor passado a ele em um descritor de entidade.  O descritor cont√©m: </p><br><ul><li>  <code>type</code> - tipo de entidade </li><li>  <code>id</code> - uma refer√™ncia exclusiva a uma inst√¢ncia de entidade usada em links como um ID </li><li>  <code>name</code> - usado como texto do link </li></ul><br><p>  Finalmente, voc√™ precisa atribuir esse tipo a uma p√°gina espec√≠fica (o link deve levar a algum lugar, certo?). </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { ... }, { <span class="hljs-attr"><span class="hljs-attr">resolveLink</span></span>: <span class="hljs-string"><span class="hljs-string">'package'</span></span> <span class="hljs-comment"><span class="hljs-comment">//    `package`    });</span></span></code> </pre> <br><p>  A primeira conseq√º√™ncia dessas altera√ß√µes √© que alguns valores na visualiza√ß√£o <code>struct</code> agora est√£o marcados com um link para a p√°gina do pacote: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eb2/dcd/502/eb2dcd5024f589a3ba8180f2b1ec538f.png" alt="Links autom√°ticos em struct"></p><br><p>  E agora voc√™ tamb√©m pode aplicar o componente de <code>auto-link</code> a um nome de objeto ou pacote: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/64d/3c2/f24/64d3c2f244164a22c55ff433409f6e22.png" alt="Usando link autom√°tico"></p><br><p>  E, como exemplo, voc√™ pode refazer um pouco a barra lateral: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//   item: { view: 'link', data: '{ text: $, href: pageLink("package"), match: #.filter }', content: 'text-match' }, //   `auto-link` item: { view: 'auto-link', content: 'text-match:{ text, match: #.filter }' }</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  Agora voc√™ tem um entendimento b√°sico dos principais conceitos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Discovery.js</a> .  Nos seguintes guias, examinaremos mais de perto os t√≥picos abordados. </p><br><p>  Voc√™ pode ver o c√≥digo-fonte inteiro do guia no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio no GitHub</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tentar como ele funciona online</a> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Siga @js_discovery</a> no Twitter para acompanhar as √∫ltimas not√≠cias! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt469115/">https://habr.com/ru/post/pt469115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt469097/index.html">Servidor web CentOS 8 com php7, node.js e redis</a></li>
<li><a href="../pt469099/index.html">Tarefas de teste na entrevista do desenvolvedor - isso faz sentido?</a></li>
<li><a href="../pt469101/index.html">Aprendendo ingl√™s: como aprender a falar como falante nativo</a></li>
<li><a href="../pt469109/index.html">Brinquedos de madeira, parte tr√™s - 1989</a></li>
<li><a href="../pt469111/index.html">Substitua Object por var: o que poderia dar errado?</a></li>
<li><a href="../pt469117/index.html">Programa√ß√£o sob BC 0010 em 2019</a></li>
<li><a href="../pt469119/index.html">Os endere√ßos IPv4 no RIPE terminaram. Completamente terminado ...</a></li>
<li><a href="../pt469125/index.html">Tema sombrio do Thunderbird como um motivo para executar um analisador de c√≥digo</a></li>
<li><a href="../pt469127/index.html">Otimiza√ß√£o ou como n√£o dar um tiro no pr√≥prio p√©</a></li>
<li><a href="../pt469129/index.html">Devido ao tema sombrio, o Thunderbird teve que executar um analisador de c√≥digo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>