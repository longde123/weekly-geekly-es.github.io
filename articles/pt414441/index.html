<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíáüèø üë®üèæ‚Äçüè´ üëÉüèº Experimente 1440 migra√ß√µes de banco de dados üë©üèº‚Äçü§ù‚Äçüë®üèΩ üôåüèæ ‚ò¢Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine o Oracle DBA. Ele j√° tem mais de trinta anos, est√° um pouco acima do peso, veste um colete, possui um token de acesso secreto a todas as bases...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experimente 1440 migra√ß√µes de banco de dados</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/wrike/blog/414441/"><img src="https://habrastorage.org/webt/pv/6j/9e/pv6j9e1v5h6g8nvmd5am7bhtmb8.jpeg"><br><br>  Imagine o Oracle DBA.  Ele j√° tem mais de trinta anos, est√° um pouco acima do peso, veste um colete, possui um token de acesso secreto a todas as bases penduradas no pesco√ßo e em um resumo de meia p√°gina das certifica√ß√µes aprovadas.  S√°bado  Grande dia de lan√ßamento.  Climax.  Hora de rolar as altera√ß√µes no banco de dados.  Ele digita sqlplus, pressiona ENTER e, em algum lugar acima da tela preta no vazio, quil√¥metros de comandos SQL correm.  Assim como em star wars.  Cinco minutos depois, est√° tudo pronto.  Uma hora depois, o lan√ßamento est√° completo.  O trabalho est√° feito, o dia foi um sucesso.  Agora voc√™ pode tomar algumas cervejas. <br><a name="habracut"></a><br>  Outra coisa √© segunda-feira.  Acontece que alguns comandos n√£o foram executados devido a erros, que, no entanto, n√£o pararam o script em sua busca desenfreada pelo vazio preto.  A tarefa j√° dif√≠cil de descobrir o que est√° quebrado √© complicada por alguma press√£o da lideran√ßa.  Em geral, segunda-feira n√£o deu certo. <br><br>  Claro, esta √© uma hist√≥ria fict√≠cia.  Isso nunca aconteceu com ningu√©m.  Pelo menos, n√£o teria acontecido se o trabalho de altera√ß√£o do esquema do banco de dados tivesse sido organizado por meio de migra√ß√µes. <br><br><h3>  O que √© uma ferramenta de migra√ß√£o de banco de dados? </h3><br>  A id√©ia de gerenciar altera√ß√µes no esquema do banco de dados por meio de migra√ß√µes √© extremamente simples: <br><br><ol><li>  Cada altera√ß√£o √© emitida como um arquivo de migra√ß√£o separado. </li><li>  O arquivo de migra√ß√£o inclui altera√ß√µes diretas e reversas. </li><li>  A aplica√ß√£o de migra√ß√µes para o banco de dados √© realizada por um utilit√°rio especial. </li></ol><br>  O exemplo mais simples de migra√ß√£o: <br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- 20180618152059: create sequence for some_table CREATE SEQUENCE some_table_seq; --//@UNDO DROP SEQUENCE some_table_seq;</span></span></code> </pre> <br>  Essa abordagem oferece muitas vantagens sobre a organiza√ß√£o de altera√ß√µes em um arquivo SQL comum.  A mera aus√™ncia de conflitos de mesclagem vale a pena. <br><br>  √â ainda mais surpreendente que a pr√≥pria abordagem tenha ganhado popularidade relativamente recentemente.  Parece que a estrutura do Ruby on Rails, na qual a ferramenta de migra√ß√£o foi originalmente criada, foi a principal fama da abordagem, foi o final de 2005.  Um pouco antes, Martin Fowler, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escreveu</a> sobre a abordagem em 2003. Provavelmente, o ponto principal √© que o desenvolvimento come√ßou a adaptar ativamente o uso do sistema de controle de vers√£o apenas no in√≠cio deste s√©culo.  Em 2000, o primeiro par√°grafo do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">teste de Joel Spolsky</a> era <i>"Voc√™ usa o controle de origem?"</i>  - isso sugere que nem todos usavam sistemas de controle de vers√£o naquele momento.  Mas n√≥s est√°vamos distra√≠dos. <br><br><h3>  Oito anos com MyBatis Migrations </h3><br>  No <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Wrike,</a> come√ßamos a usar a abordagem de mudan√ßa de banco de dados por meio de migra√ß√µes em 2010, 29 de mar√ßo, √†s doze e meia.  Desde ent√£o, implementamos 1.440 migra√ß√µes, contendo 6.436 mudan√ßas diretas e 5.015 reversas.  Em geral, adquirimos alguma experi√™ncia usando a ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Migra√ß√µes MyBatis</a> em conjunto com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PostgreSQL</a> . <br><br>  Em suma, nunca nos arrependemos.  Se acontecer que voc√™ n√£o est√° usando Migra√ß√µes ou algo semelhante, √© hora de come√ßar.  Sim, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pentium 4</a> tamb√©m <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√°</a> desatualizado. <br><br>  Mas √© chato falar sobre os m√©ritos de qualquer coisa, vamos imediatamente para as dificuldades. <br><br><h3>  Especificidades do PostgreSQL </h3><br>  Talvez n√£o haja dificuldades em escrever migra√ß√µes para o Postgres, exceto por duas: <br><ul><li>  Voc√™ n√£o pode criar √≠ndices, </li><li>  Voc√™ n√£o pode adicionar colunas NOT NULL. </li></ul><br>  N√£o, na verdade √© poss√≠vel, mas n√£o de uma maneira totalmente √≥bvia.  Ao criar um √≠ndice, voc√™ sempre deve especificar <i>CREATE INDEX CONCURRENTLY</i> ; caso contr√°rio, interromper√° a produ√ß√£o, porque o Postgres bloquear√° a tabela pela dura√ß√£o da cria√ß√£o do √≠ndice, e isso pode levar um longo tempo.  Obviamente, os desenvolvedores esquecem uma vez, voc√™ sempre deve ter essa sutileza em mente.  Aqui algu√©m poderia escrever um teste.  Mas isso √© apenas um pequeno inconveniente. <br><br>  Criar colunas NOT NULL √© mais complicado, aqui voc√™ precisa fazer uma altera√ß√£o em quatro etapas: <br><ol><li>  Crie uma coluna NULL (no Postgres √© gr√°tis). </li><li>  Defina a coluna PADR√ÉO para um valor. </li><li>  Em um loop, atualize incrementalmente os valores NULL em DEFAULT. </li><li>  Defina SET NOT NULL. </li></ol><br>  O maior problema aqui √© o terceiro par√°grafo.  Os valores NULL precisam ser atualizados em partes, porque <code>UPDATE some_table SET some_column='' WHERE some_column IS NULL</code> ;  ir√° bloquear a tabela, como √© o caso do √≠ndice, com as mesmas consequ√™ncias.  E as migra√ß√µes s√≥ podem executar comandos SQL; portanto, esses scripts precisam ser lan√ßados na produ√ß√£o manualmente.  Prazer abaixo da m√©dia.  Agora, se um ciclo pudesse ser escrito em Migra√ß√µes, n√£o haveria problema.  Talvez isso seja implementado atrav√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ganchos</a> . <br><br>  Criar um √≠ndice <code>UNIQUE</code> e alterar uma <code>PRIMARY KEY</code> tamb√©m requer alguma habilidade, mas essas opera√ß√µes s√£o relativamente raras. <br><br><h3>  Espec√≠ficos de cluster </h3><br>  A ferramenta de gerenciamento de migra√ß√£o de banco de dados √© v√°lida desde que voc√™ tenha um banco de dados.  Ainda mais divertido se voc√™ tiver v√°rias bases.  Especialmente se voc√™ tiver v√°rios tipos de bancos de dados, cada um com v√°rias inst√¢ncias. <br><br>  Como resultado, ap√≥s o <code>git pull</code> desenvolvedor deve rolar as altera√ß√µes para a primeira inst√¢ncia do primeiro banco de dados, depois para a segunda inst√¢ncia, depois para a primeira inst√¢ncia do segundo banco de dados e assim por diante - esse princ√≠pio.  Aqui √© justo escrever um utilit√°rio para gerenciar o utilit√°rio de gerenciamento de migra√ß√£o de banco de dados.  Automa√ß√£o total. <br><br><h3>  Malabarismo de fun√ß√µes </h3><br>  N√£o √© segredo que fun√ß√µes como entidades n√£o vivem no n√≠vel de um banco de dados separado, mas no n√≠vel de todo o servidor de banco de dados, pelo menos no Postgres.  Nesse caso, pode ser necess√°rio especificar <code>REVOKE INSERT ON some_table FROM some_role</code> ;  Ainda √© poss√≠vel esperar que as fun√ß√µes sejam pr√©-configuradas na produ√ß√£o, mas para o desenvolvimento ou prepara√ß√£o isso j√° √© dif√≠cil.  Ao mesmo tempo, no desenvolvimento, √© claro, todos os bancos de dados existem no mesmo servidor local, portanto, voc√™ simplesmente n√£o pode escrever <code>CREATE ROLE</code> na migra√ß√£o, e <code>IF NOT EXISTS</code> n√£o h√° suporte.  Tudo √© resolvido simplesmente: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_roles <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> rolname = <span class="hljs-string"><span class="hljs-string">'some_role'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> <span class="hljs-string"><span class="hljs-string">"some_role"</span></span> NOLOGIN; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$;</code> </pre><br>  Assista!  Eu pego e atiro, apanho e atiro, √© t√£o simples. <br><br><h3>  Um pouco da realidade do desenvolvimento </h3><br>  Os desenvolvedores cometem erros e, mesmo nas migra√ß√µes de SQL, isso acontece.  Geralmente, os erros podem ser notados na revis√£o, mas tamb√©m pode ser incomum.  Se falamos de mudan√ßas diretas, os batentes ainda n√£o atingem a produ√ß√£o - h√° muitos est√°gios de verifica√ß√£o.  Mas com as mudan√ßas inversas, incidentes podem surgir.  Para evitar erros na migra√ß√£o UNDO, ao testar a migra√ß√£o, voc√™ precisa executar n√£o apenas <code>./migrate up</code> , mas <code>./migrate up</code> , depois <code>./migrate down</code> e novamente <code>./migrate up</code> .  Isso n√£o √© nada complicado, voc√™ s√≥ precisa garantir que quarenta desenvolvedores sempre fa√ßam isso.  De uma maneira boa, o utilit√°rio pode executar essa combina√ß√£o automaticamente para o ambiente do desenvolvedor. <br><br><h3>  Ambientes de teste </h3><br>  Se o ambiente de teste tiver vida curta: digamos que voc√™ crie um cont√™iner, inicialize o banco de dados e execute testes de integra√ß√£o, n√£o haver√° problemas.  <code>./migrate bootstrap</code> , depois <code>./migrate up</code> , e pronto.  √â quando o n√∫mero de migra√ß√µes excede mil, esse processo pode ser adiado.  √â uma pena que o banco de dados seja inicializado por mais tempo do que os testes executados.  Temos que nos esquivar. <br><br>  Em ambientes de vida longa, ainda √© mais dif√≠cil.  Controle de qualidade, voc√™ sabe, eles n√£o gostam de ver um banco de dados impecavelmente limpo quando chegam ao trabalho.  N√£o sei por que isso √© assim, mas fato √© fato.  Portanto, o estado das bases usadas nos testes manuais deve ser mantido em integridade.  E isso nem sempre √© f√°cil. <br><br>  A sutileza √© que, se a migra√ß√£o for aplicada ao banco de dados, o identificador da migra√ß√£o ser√° gravado nele.  E se o c√≥digo de migra√ß√£o for alterado posteriormente, o banco de dados n√£o ser√° afetado.  Se as altera√ß√µes n√£o forem cr√≠ticas, o c√≥digo poder√° chegar √† produ√ß√£o com sucesso.  Rssynchron.  Claro, isso √© uma vergonha.  O primeiro princ√≠pio de trabalhar com migra√ß√µes nunca √© alterar migra√ß√µes escritas, mas sempre criar novas.  Mas √†s vezes tenho vontade de me atrapalhar - vou mudar um pouco aqui, nada vai quebrar, porque a verdade √©.  Claro!  V√° em frente! <br><br>  Se as migra√ß√µes fossem assinadas ap√≥s a revis√£o, seria poss√≠vel proibir a aplica√ß√£o de rascunhos para prepara√ß√£o.  E seria poss√≠vel salvar n√£o apenas o identificador de migra√ß√£o no <code>changelog</code> , mas tamb√©m a <code>checksum</code> - tamb√©m √∫til. <br><br><h3>  Volte como estava </h3><br>  Uma virada particularmente insidiosa acontece quando uma tarefa √© cancelada: eles fizeram, fizeram e mudaram de id√©ia.  √â uma situa√ß√£o normal.  Quando o c√≥digo n√£o for mais necess√°rio, a ramifica√ß√£o dever√° ser exclu√≠da.  E houve migra√ß√£o ... e ela j√° est√° encenando ... ah, ... opa.  Um bom motivo para verificar se voc√™ pode restaurar o backup do reposit√≥rio.  Embora lembrando que talvez tenha sido mais f√°cil. <br><br>  Ao mesmo tempo, a migra√ß√£o √© texto.  E seria poss√≠vel salvar esse texto l√°, no <code>changelog</code> .  Ent√£o, se a migra√ß√£o do c√≥digo acabar, n√£o importa por que motivos, ela sempre poder√° ser revertida.  E mesmo automaticamente. <br><br><h3>  Desfazer novamente </h3><br>  A se√ß√£o UNDO √© definitivamente necess√°ria.  Mas por que escrever?  Obviamente, existem casos cativantes, mas a maioria das altera√ß√µes √© <code>CREATE TABLE</code> ou <code>ADD COLUMN</code> ou <code>CREATE INDEX</code> .  Para eles, o utilit√°rio poderia gerar opera√ß√µes reversas automaticamente, diretamente usando o c√≥digo SQL.  Claro, h√° uma especificidade.  <code>CREATE TABLE ${name}</code> - esta √© uma equipe t√£o especial que, de repente, n√£o √© padr√£o.  Sim, e para gerar <code>DROP TABLE ${name}</code> , voc√™ precisa analisar a express√£o at√© a terceira palavra.  Embora, em geral, essa seja uma tarefa t√©cnica totalmente vi√°vel.  Pode estar fora da caixa. <br><br><h3>  Conclus√£o </h3><br>  Claro, acho falha.  O MyBatis Migrations foi concebido como um utilit√°rio simples e universal, minimamente ligado √†s especificidades dos bancos de dados.  E ela √© mais do que se justificar.  Mas parece que algumas pequenas melhorias o tornariam muito melhor, principalmente quando usadas em longas dist√¢ncias. <br>  - <br>  <i>Dmitry Mamonov / Wrike</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt414441/">https://habr.com/ru/post/pt414441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt414427/index.html">O que uma impressora 3D pode fazer? Relat√≥rio da exposi√ß√£o Maker Faire Bay Area 2018</a></li>
<li><a href="../pt414429/index.html">Como aprender uma l√≠ngua estrangeira sem professor. Parte 1. "Minha experi√™ncia"</a></li>
<li><a href="../pt414431/index.html">Mitap JavaJam. Debate Javista, rafting, experimentos e microsservi√ßos</a></li>
<li><a href="../pt414433/index.html">Andamos pela cidade com sabedoria: como eu fiz o servi√ßo para construir percursos pedestres interessantes</a></li>
<li><a href="../pt414437/index.html">O bloqueio de telegrama provocou um aumento no custo de startups dom√©sticas</a></li>
<li><a href="../pt414443/index.html">Recursos de chamadas de fun√ß√£o em C ++</a></li>
<li><a href="../pt414445/index.html">Melhorando o Zimbra com o Zextras Suite</a></li>
<li><a href="../pt414447/index.html">Tipos de todos os tempos</a></li>
<li><a href="../pt414449/index.html">Como fazer amigos de todos os operadores do est√°dio e n√£o seme√°-lo com centenas de antenas</a></li>
<li><a href="../pt414451/index.html">"Calend√°rio do testador" para junho. O testador deve pegar o erro, ler Caner e organizar a mudan√ßa.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>