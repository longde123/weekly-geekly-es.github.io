<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏩 👨‍👨‍👦‍👦 🚕 Sberbank ou là et retour 👩🏻‍💻 🚯 🛀🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CHAPITRE 1. Des invités inattendus 
 Tout a commencé ce matin malheureux lorsque le chef de projet a annoncé que les délais de mise en œuvre du projet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sberbank ou là et retour</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451188/"><img src="https://habrastorage.org/webt/si/bq/2u/sibq2unjy0i1yoy_7sa0qljphae.jpeg"><br><br><h2>  CHAPITRE 1. Des invités inattendus </h2><br>  Tout a commencé ce matin malheureux lorsque le chef de projet a annoncé que les délais de mise en œuvre du projet devraient être rapidement et résolument réduits d'un mois.  Plus précisément, le projet devrait être prêt en 4 jours.  Non, notre PO n'est pas une bête, et ne ressemble pas du tout à un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">hibou</a> (peut-être juste un peu comme un corbeau), c'est juste arrivé.  Eh bien, si c'est nécessaire, c'est nécessaire, d'autant plus que l'équipe (et je suis le principal développeur de l'équipe "C") s'est vu promettre quelque chose de savoureux.  L'horloge et le calendrier étaient jeudi, 11h00, lundi, le projet devrait être prêt. <br><br>  Pour commencer, que faisons-nous du tout.  Nous nous consacrons à l'automatisation des salles de cinéma - contrôle automatique et à distance des équipements, automatisation de la projection de films, surveillance, panneaux vidéo, et maintenant aussi terminaux pour la vente de billets et de bars.  Plus précisément, le dernier paragraphe est consacré à cet article. <br><a name="habracut"></a><br>  Le projet lui-même, qui devait être achevé avant lundi, est une sorte de couche entre le serveur principal de Scala et le terminal de paiement en fer VeriFone VX 820 (en fait, il y a plus de terminaux, mais prenez-le comme exemple).  Il est clair que personne ne nous donnera de transactions comme ça, donc les utilitaires et les bibliothèques de Sberbank / Arcus et UCS sont utilisés.  Par conséquent, le plan de travail devrait être le suivant: <br><br><img src="https://habrastorage.org/webt/ak/k4/do/akk4do9scie61w_tobeuwpk6liu.png"><br><br>  Extérieurement, cela ressemble à ceci: <br><br><img src="https://habrastorage.org/webt/oh/ul/ts/ohultstzocyw8za06mbxqwmnrma.jpeg"><br><br>  En outre, ce sous-système devrait être utilisé sur les caisses enregistreuses standard que tout le monde a vues dans n'importe quelle salle de cinéma des caissières. <br><br>  Selon la tradition interne, nous appelons chaque projet de notre équipe un nom de la mythologie nordique ancienne, pour ce sous-système le nom Gefjon a été choisi - le nom de la déesse de la fertilité et de la fertilité (un bon nom pour un serveur de paiement, n'est-ce pas? Eh bien, la légende des taureaux coupant l'île correspond parfaitement à l'architecture actuelle, couper le travail avec des équipements d'une langue de haut niveau). <br><br>  Le format des messages entrants et sortants est un serveur HTTP avec une charge JSON.  Il s'agit du compromis optimal entre Scala, difficile à isoler les données binaires des flux de socket et C, difficile à transférer pour transférer des objets via le réseau.  Il n'y a pas beaucoup d'opérations possibles qui doivent être opérées: paiement, annulation, retour, différents types de rapports, ouverture du menu de service et ping.  Cela n'a rien de compliqué.  Puisqu'il existe trois systèmes bancaires (et qu'une reconstitution ultérieure de la famille est prévue), il a été décidé de diviser le projet en composantes: <br><br><img src="https://habrastorage.org/webt/rk/vm/sc/rkvmscw9ret9atfnts-nezxtaqg.png"><br><br>  Les blocs verts sont ceux que nous devions faire, les bleus sont ceux qui ne peuvent pas être modifiés et que la banque fournit. <br><br>  Étant donné que les principaux problèmes ne sont apparus qu'avec les logiciels de Sberbank, l'article dans son ensemble sera consacré aux pièges que nous avons comptés avec notre bateau. <br><br><h2>  CHAPITRE 2. Agneau rôti </h2><br><img src="https://habrastorage.org/webt/zr/-d/ez/zr-dez83p56hekuceyiiqka2rdi.jpeg"><br>  (photo: heaclub.ru) <br><br>  ... ressemble à quelque chose comme ça.  Le code de ce prototype, qui a été écrit il y a plusieurs mois afin de faire comprendre à toutes les personnes de niveau supérieur que nous pouvons travailler avec des applications bancaires, était à peu près le même. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_KB * <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * null; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * grep; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT char * ptr; null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"nul"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"findstr"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/dev/null"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"grep"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> sprintf(buf, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"= %sops.ini &gt;%s 2&gt;%s || "</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"echo %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=9,6,PINPAD_TEST &gt;&gt; %sops.ini"</span></span></span><span class="hljs-meta">, grep, TERM_ARCUS_TEST_PINPAD, TERM_PATH, null, null, TERM_ARCUS_TEST_PINPAD, TERM_PATH); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT ptr = buf; while (*ptr) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (*ptr == </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'/'</span></span></span><span class="hljs-meta">) *ptr = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\\'</span></span></span><span class="hljs-meta">; ptr++; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  Il est clair que cela ne convenait pas à la version Production, il était donc essentiellement nécessaire de tout réécrire. <br><br>  Chaque banque qui fournit des bibliothèques pour travailler avec le terminal propose généralement deux options de connexion: via les fonctions de bibliothèque (.so / .dll) ou via un utilitaire prêt à l'emploi qui n'a besoin que de passer deux valeurs - le type d'opération et le montant (si nécessaire).  En théorie, rien de compliqué, juste quelque chose <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[<span class="hljs-number"><span class="hljs-number">100</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%d %d"</span></span>, atoi(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]), atoi(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>])); system(buffer);</code> </pre> <br>  Le résultat de l'opération sera placé dans le fichier «e», et le slip-check dans le fichier «p».  Envoyez simplement ces fichiers à stdout avec conversion en JSON, de sorte que le serveur HTTP les envoie simplement en tant que charge utile sans penser à ce qui s'y trouve. <br><br>  Mais cet article n'aurait pas été publié si tout avait été si simple. <br><br><h2>  CHAPITRE 4. À travers la montagne et sous la montagne </h2><br>  La version initiale de l'implémentation était un simple appel d'application - le serveur HTTP a appelé l'encapsuleur nécessaire avec des paramètres unifiés (par exemple, le rapport X est 4), et l'utilitaire, par exemple gfj_pilot, a lancé sb_pilot avec le paramètre requis pour cette opération (par exemple, le rapport X est 9) .  L'utilitaire wrapper a ensuite lu le résultat de l'opération à partir du fichier électronique (par exemple, 2000 - «paiement refusé, répétez l'opération») et l'a converti en une erreur universelle (par exemple 3 - «Erreur de lecture ou de traitement de la carte / du compte, répétez l'opération»).  Après cela, le fichier «p» a été converti en base64 pour éviter la rupture du formatage et envoyé avec le résultat à stdout en tant que JSON. <br><br>  Tout cela a parfaitement fonctionné jusqu'à ce qu'à un moment précis, on nous informe que ... <br><br>  ... cela ne fonctionne pas sous Windows. <br><br><img src="https://habrastorage.org/webt/yp/44/t_/yp44t_qwokissyt75mayl71mcdm.jpeg"><br><br>  Eh bien, plus précisément, Windows lui-même n'a aucun problème (sauf que le glissement est généré dans l'encodage Cp-1251, et la console fonctionne dans CP866).  Le fichier «e» n'a tout simplement pas été généré.  Lancement direct d'un utilitaire bancaire: <br><br><pre> <code class="plaintext hljs">C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 01.02.2019 16:51 91 646 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 20  5 659 718  2  37 567 004 672   #    (1)  10  (1000 ) C:\banks\sber\sb_pilot&gt;loadparm.exe 1 1000 C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 04.02.2019 12:28 216 commerr.log 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 01.02.2019 18:51 1 349 p 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 04.02.2019 12:28 92 218 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 19  5 659 029  2  37 567 008 768   C:\banks\sber\sb_pilot&gt;</code> </pre> <br>  En effet, il n'y a pas de fichier "e".  Pierre vers Sberbank # 1.  Nous écrivons une lettre à Sberbank (nous avons par la suite reçu une réponse selon laquelle cela devrait être le cas), et comme il n'y a pas de temps pour la correspondance et qu'il est nécessaire de commencer dès maintenant, nous recherchons des solutions de contournement pour obtenir le résultat. <br><br><pre> <code class="plaintext hljs">04.02 12:28:55 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Result = 0 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 GATE: lock:'00000054' 'UPOSWINMUTEX2' 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 LOADPARM: Unloading GATE.DLL... 04.02 12:28:56 GATE: SB_KERNEL.DLL is unloaded 04.02 12:28:56 LOADPARM: GATE.DLL unloaded</code> </pre> <br>  Oui, le résultat peut être obtenu à partir du journal sbkernel.log.  Inconvénient, en plus il n'y a pas de hachage de carte pour visser par la suite «Merci» de Sberbank.  Pas bon. <br><br>  Vous devrez vous connecter à la bibliothèque pilot_nt.dll et importer des fonctions à partir de celle-ci.  Tout irait bien, mais ... Une pierre vers Sberbank # 2: il n'y a pas une telle bibliothèque sous Linux, vous devrez créer deux applications différentes pour différentes plates-formes - pour linux, appelez l'utilitaire sb_pilot (similaire à loadparm.exe, d'ailleurs la pierre # 3 pour un nom d'utilitaire différent sous différentes plates-formes ), sous Windows, connectez-vous à la bibliothèque pilot_nt.dll. <br><br><h2>  CHAPITRE 5. Énigmes dans le noir </h2><br>  À 19h00. <br><br>  Sberbank est une grande entreprise, la plupart des solutions logicielles sont produites conformément aux GOST et aux documents officiels.  Nous entrons dans le catalogue que Sberbank fournit avec les bibliothèques: <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs  30160 drwx------ 2 alex alex 4096  17 19:31 FAQ -rw-rw-r-- 1 alex alex 3398465  9 2018   UPOS    ().docx -rw-rw-r-- 1 alex alex 1182078  9 2018   UPOS  .docx -rw-rw-r-- 1 alex alex 853504  9 2018   .doc drwx------ 3 alex alex 4096  31 17:11     -rw-rw-r-- 1 alex alex 5280787  9 2018    POS-.docx -rw-rw-r-- 1 alex alex 1149640  9 2018  .docx drwx------ 2 alex alex 4096  28 2018  UPOS drwx------ 2 alex alex 4096  28 2018    -rw-rw-r-- 1 alex alex 3451601  9 2018     ().docx -rw-rw-r-- 1 alex alex 1956196  9 2018   .docx -rw-rw-r-- 1 alex alex 1043161  9 2018       ()_().docx -rw-rw-r-- 1 alex alex 4348157  9 2018  POS-.docx -rw-rw-r-- 1 alex alex 3970267  9 2018   .docx drwx------ 3 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 2644702  9 2018    POS-.docx drwx------ 2 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 1558211  9 2018   .png</code> </pre> <br>  Beaucoup de bien, mais nous ne sommes intéressés que par le répertoire pour les développeurs: <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs/\ \ \ /  8704 -rw-rw-r-- 1 alex alex 47105  9 2018 1C.docx -rw-rw-r-- 1 alex alex 1824  9 2018 cardtype.h -rw-rw-r-- 1 alex alex 2590378  9 2018 cr_ttk_protocol_ru.rtf -rw-rw-r-- 1 alex alex 208  9 2018 deprtmnt.h -rw-rw-r-- 1 alex alex 16681  9 2018 errors.h drwx------ 6 alex alex 4096  28 2018 examples -rw-rw-r-- 1 alex alex 58575  9 2018 gate.h -rw-rw-r-- 1 alex alex 4218  9 2018 paramsln.h -rw-rw-r-- 1 alex alex 61693  9 2018 pilot_nt.h -rw-rw-r-- 1 alex alex 28160  9 2018 ReadTrack2.doc -rw-rw-r-- 1 alex alex 7417  9 2018 sbkernel.h -rw-rw-r-- 1 alex alex 144896  9 2018 sb_pilot.doc -rw-rw-r-- 1 alex alex 3525323  9 2018     ole- sbrf.dll.rtf -rw-rw-r-- 1 alex alex 46683  9 2018      gate.dll.chi -rw-rw-r-- 1 alex alex 255414  9 2018      gate.dll.chm -rw-rw-r-- 1 alex alex 814653  9 2018      gate.dll.pdf -rw-rw-r-- 1 alex alex 41618  9 2018      pilot_nt.chi -rw-rw-r-- 1 alex alex 241716  9 2018      pilot_nt.chm -rw-rw-r-- 1 alex alex 968753  9 2018      pilot_nt.pdf -rw-rw-r-- 1 alex alex 81  9 2018  .txt</code> </pre> <br>  Beaucoup de vieux papiers, juste au cas où, relisez pilot_nt, dont nous apprenons ce qui suit: <br><blockquote>  Tableau 1. Système d'exploitation sb_pilot pris en charge. <br><div class="scrollable-table"><table><tbody><tr><th>  OS </th><th>  Capacité </th><th>  Nom du module </th></tr><tr><td>  Windows </td><td>  32 </td><td>  sb_pilot.exe </td></tr><tr><td>  Linux </td><td>  32 </td><td>  sb_pilot </td></tr><tr><td>  Dos </td><td>  16 </td><td>  sb_pilot.exe </td></tr></tbody></table></div></blockquote><br>  Il s'avère que l'utilitaire pour Windows devrait toujours s'appeler sb_pilot.  Eh bien, une pierre vers Sberbank # 4 pour l'incohérence de sa propre documentation. <br><blockquote>  Transfert des résultats du programme. <br><br>  À la fin du programme, deux fichiers texte sont formés - le fichier d'échange et le fichier de contrôle. <br><br>  Le premier est nommé e et est destiné à transmettre les paramètres de l'opération parfaite au programme appelant.  La première ligne de ce fichier contient le code du résultat de l'opération et un texte séparé par des virgules expliquant le message texte.  Le code 0 signifie un paiement réussi, toute autre valeur - refus ou incapacité d'effectuer le paiement. </blockquote><br><br><img src="https://habrastorage.org/webt/c8/7f/m2/c87fm26nwcdjtfol6m0vamuvk8e.jpeg"><br><br>  Paresseusement, nous jetons une pierre de plus et commençons à étudier la documentation pour connecter directement la bibliothèque. <br><blockquote>  <b>La procédure d'appel des fonctions de bibliothèque</b> <br><br>  Lors du paiement (retour) d'achats par carte de crédit, le programme de caisse doit appeler la fonction card_authorize () de la bibliothèque Sberbank en remplissant les champs TType et Amount et en spécifiant zéro dans les champs restants.  À la fin de la fonction, vous devez analyser le champ RCode.  S'il contient la valeur «0» ou «00», l'autorisation est considérée comme terminée avec succès, sinon rejetée.  De plus, vous devez vérifier la valeur du champ Vérifier. <br><br>  S'il n'est pas NULL, il doit être envoyé à l'impression (en mode non fiscal) puis <br>  supprimer en appelant la fonction GlobalFree ().  Lors de la fermeture d'un quart de travail, le programme de trésorerie doit appeler la fonction close_day () à partir de la bibliothèque Sberbank en remplissant le champ TType = 7 et en spécifiant des valeurs nulles dans les champs restants.  À la fin de la fonction, vérifiez la valeur du champ Vérifier. <br><br>  Si le champ Vérifier n'est pas NULL, il doit être envoyé à l'impression (en mode non fiscal) puis supprimé en appelant la fonction GlobaFree (). </blockquote>  Cela semble facile, même un fichier d'en-tête est fourni.  Eh bien, branchez-le, compilez et ... <br><br><pre> <code class="cpp hljs">$ cat main.c &amp;&amp; i686-w64-mingw32-gcc main.c -o main.a <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pilot_nt.h"</span></span></span><span class="hljs-meta"> int main(void) { return 0; } In file included from main.c:1:0: pilot_nt.h:525:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:544:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:567:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:590:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:627:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:668:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span></span></code> </pre> <br>  Ummm ... quoi?  Ouvrez pilot_nt.h: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta">{ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;...&gt; /** *    * ,         . */ struct auth_answer{ int TType; /**&lt; [in]  .  ::OpetationTypes */ unsigned long Amount; /**&lt; [in]    */ char RCode[3]; /**&lt; [out]    */ char AMessage[16]; /**&lt; [out]    */ int CType; /**&lt; [in,out]   */ char* Check; /**&lt; [out]  ,   GlobalFree    */ }; &lt;...&gt; struct auth_answer7{ auth_answer auth_answ; /**&lt; [in, out]   . . ::auth_answer */ &lt;---- THIS char AuthCode[MAX_AUTHCODE]; /**&lt; [out]  . 7 . */ char CardID [CARD_ID_LEN]; /**&lt; [out]  . 25 . */ int SberOwnCard; /**&lt; [out]     */ };</span></span></span></span></code> </pre> <br>  Immédiatement, sans regarder la pierre pour des commentaires en russe dans le codage CP1251. <br><br>  Eh bien, la pierre la plus sérieuse: chers développeurs C ++.  Si vous écrivez «C» externe, cela signifie que le code à l'intérieur du bloc doit être compilé par le compilateur C.  Si vous n'avez PAS fait de `typedef` d'une structure, chaque fois que vous le mentionnez comme référence de type, vous devez écrire le mot-clé` struct`. <br><br>  Corrigez le fichier pour les développeurs, en remplaçant le mot `struct` là où vous en avez besoin.  Lien vers la bibliothèque `pilot_nt.dll`.  Victoire, non?  Nous lançons notre application. <br><br><h2>  CHAPITRE 6. Du feu aux flammes </h2><br>  Eh bien, vous comprenez, non?  L'application se bloque simplement.  Jusqu'au principal.  Méditez, ajoutez l'analogue NIH de la fonction errno pour Windows: GetLastError (pierre # 3 vers Microsoft, les deux premiers sont pour les encodages). <br><br><pre> <code class="plaintext hljs">C:\banks\sber\WIN&gt;sb_pilot.exe 1 1000 E: !g_sblibrary (0xc0000096)</code> </pre> <br>  0xc0000096?  GetLastError ne devrait-elle pas renvoyer un code d'erreur adéquat? <br><blockquote>  Pour une liste complète des codes d'erreur fournis par le système d'exploitation, voir Codes d'erreur système. </blockquote>  Ouais, ouvrez l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> : <br><blockquote>  Les rubriques suivantes fournissent des listes de codes d'erreur système.  Ces valeurs sont définies dans le fichier d'en-tête WinError.h. <br><br><ul><li>  Codes d'erreur système (0-499) (0x0-0x1f3) </li><li>  Codes d'erreur système (500-999) (0x1f4-0x3e7) </li><li>  Codes d'erreur système (1000-1299) (0x3e8-0x513) </li><li>  Codes d'erreur système (1300-1699) (0x514-0x6a3) </li><li>  Codes d'erreur système (1700-3999) (0x6a4-0xf9f) </li><li>  Codes d'erreur système (4000-5999) (0xfa0-0x176f) </li><li>  Codes d'erreur système (6000-8199) (0x1770-0x2007) </li><li>  Codes d'erreur système (8200-8999) (0x2008-0x2327) </li><li>  Codes d'erreur système (9000-11999) (0x2328-0x2edf) </li><li>  Codes d'erreur système (12000-15999) (0x2ee0-0x3e7f) </li></ul></blockquote>  Ok, nous avons eu une erreur non documentée, nous jetons une pierre et ouvrons le google omniscient: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forum.vingrad.ru/forum/topic-346194/kw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bbs.csdn.net/topics/80078275</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">forums.codeguru.com/showthread.php?179566-0xC0000096-Privileged-Instruction</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.unknowncheats.me/forum/general-programming-and-reversing/97763-privileged-instruction-error.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cboard.cprogramming.com/windows-programming/146130-prallel-port-programming.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">computer-programming-forum.com/82-mfc/dc2481c0ecead2f2.htm</a> </li></ul><br>  L'essence de l'erreur est qu'un sous-programme utilise l'une des instructions <br><br><ul><li>  _inp () </li><li>  _inpw () </li><li>  _inpd () </li><li>  _outp () </li><li>  _outpw () </li><li>  _outpd () </li></ul><br>  Leur utilisation est interdite sous les cœurs NT, car ils essaient de travailler directement avec le port parallèle.  Apparemment, ce code est appelé dans l'initialiseur de bibliothèque, c'est-à-dire  la bibliothèque au démarrage veut interroger les ports pour les périphériques, mais le noyau NT nécessite un travail via le pilote. <br><br>  Situation désespérée? <br><br><h2>  CHAPITRE 8. Araignées et mouches </h2><br>  22 h 00  Juste au cas où, l'idée surgit de vérifier que ce n'est pas dû au fait que nous utilisons la compilation croisée avec Linux en utilisant mingw.  Dans le même temps, nous comprenons que Sberbank ne fournit qu'une application 32 bits, donc cela ne fonctionnera pas avec une application 64 bits, d'accord, mais nous allons tout de même lancer une pierre vers Sberbank pour la version 32 uniquement en 2019. <br><br>  Éléments fournis: installé dans virtualbox windows 7; <br>  <b>Obligatoire</b> : installez Visual Studio et copiez MVP. <br><br>  Nous allons sur le site Web de Microsoft, téléchargeons Visual Studio 2017. Nous prenons la licence communautaire, car nous la prenons pour vérification, pour les entreprises, la licence sera achetée si elle décolle. <br>  Téléchargez quelques centaines de mégaoctets et ... <br><br>  Nous constatons que notre version du système d'exploitation (Windows 7) n'est pas prise en charge. <br><br>  Ok, on va sur toutes sortes de sites obscènes, on cherche Visual Studio 2008, on télécharge à nouveau quelques centaines de mégaoctets et ... <br><br>  Nous obtenons le fichier iso. <br><br>  D'accord, essayons d'installer Daemon Tools 10 (puisque c'est la version que le site propose) pour insérer ce disque virtuel. <br><br>  Exécutez le binaire téléchargé.  Raté, nécessite .NET Framework 4.5, téléchargez, installez. <br>  Nous commençons le binaire téléchargé, l'installation a commencé, le chargeur de démarrage dit qu'il a besoin de 4.5.2, téléchargez, installez. <br>  Nous commençons le binaire téléchargé, l'installation a commencé, le chargeur de démarrage dit qu'il n'ira nulle part avant d'installer la mise à jour de sécurité KB3033929, de télécharger, d'installer. <br><br>  Et nous recevons une claque au visage de Microsoft comme message: <br><br><img src="https://habrastorage.org/webt/r6/qe/de/r6qedenl5w3dez4ysscvod8rmjw.png"><br><br>  Nous lançons violemment une pierre très pointue vers Microsoft, téléchargeons les anciens Daemon Tools de torrents, décompressons avec succès Visual Studio, installons, enfin (00:00) compilons MVP, nous obtenons la même erreur.  Eh bien, il y avait une bonne version, mais elle n'a pas grandi ensemble. <br><br><h2>  CHAPITRE 11. Au seuil </h2><br>  Nous écrivons au deuxième programmeur, qui à ce moment achève de toute urgence le serveur et la procédure d'enregistrement.  Il rappelle qu'il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">référentiel</a> git qui se connecte à cette bibliothèque sur NT et fonctionne avec. <br><br>  En regardant de manière suspecte le référentiel, téléchargez-le, compilez-le et exécutez-le.  Ça marche. <br><br><img src="https://habrastorage.org/webt/mt/gl/q-/mtglq-c68eyegv74wjnzjvpmddi.png"><br><br>  Nous regardons le code avec encore plus de méfiance.  Le code est identique, sauf qu'il est écrit en C ++ et non en C. <br>  Nous comprenons que la langue n'y est pour rien.  Nous regardons les bibliothèques de la Sberbank, que le code tire. <br>  Nous voyons le dernier commit. <br><br>  Et ici, nous attendons une autre surprise. <br><br>  Il s'avère que les versions de la bibliothèque Sberbank peuvent être différentes.  Le dernier commit augmente la version du 23 au 27.  Copiez la version de la gita sur votre ordinateur de test - FONCTIONNE! <br><br>  Nous vérifions toutes les archives envoyées par Sberbank, comparons les versions et construisons une tablette: <br><div class="scrollable-table"><table><tbody><tr><th>  La version </th><th>  Oeuvres </th></tr><tr><td>  26.0.15 - Basique </td><td>  non </td></tr><tr><td>  27.4.12 - Depuis le référentiel </td><td>  oui </td></tr><tr><td>  23.0.13 - Depuis le référentiel </td><td>  oui </td></tr><tr><td>  29.0.9 - Les dernières nouvelles de sam </td><td>  oui </td></tr><tr><td>  23.0.13 - Avec un patch pour le système Cryptor </td><td>  oui </td></tr></tbody></table></div><br>  Très bien, guérissons maintenant.  Sur les systèmes où cela coûte 26, passez à 29 ou 27 et tout décollera. <br>  Nous jetons la pierre n ° 9 vers Sberbank pour avoir rompu le comportement sur les systèmes NT. <br><br><h2>  CHAPITRE 12. Ce qui les attendait à l'intérieur </h2><br>  Pas assez de fichier e?  Peu importe, nous prenons des en-têtes corrigés, nous lions dynamiquement à la bibliothèque pour retourner correctement une erreur, écrivons un code qui écrit simplement le code de retour de la fonction dans le fichier "e", appelons le biner sb_pilot.exe et ... <br><br>  Pour travailler, ça marche. <br><br>  C'est juste la version pour le système "Cryptor" qui ne crée pas de fichier "p". <br><br>  <i>Nous regardons tristement le sang qui coule sur les jointures et la dent dans le mur.</i> <br><br>  Pour commencer, quel est le système Cryptor. <br><br>  Cryptera est une entreprise danoise qui produit des équipements de cryptage / équipements de sécurité / clés, etc. Je pense que vous avez tous vu une des copies de leurs produits: <br><br><img src="https://habrastorage.org/webt/pb/dz/85/pbdz85atzxiscdkdkq0z97ahhsm.png"><br><br>  Ainsi, Sberbank utilise son module de chiffrement pour les pinpads et publie une bibliothèque spéciale «corrigée», dans laquelle, comme nous l'avons déjà compris, le fichier «p» n'est pas créé.  Nous écrivons à Sberbank à ce sujet et dans quelques jours, nous obtiendrons la réponse que «sous le système d'origine, le fichier« p »sera créé, mais sous le correctif de Cryptor, il ne le sera pas.»  Nous leur donnerons la pierre n ° 10 dans quelques jours, car vous devez travailler maintenant. <br><br>  Heureusement ou malheureusement, les fonctions que nous utilisons pour mener des opérations renvoient la structure déjà mentionnée: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br>  Oh, très bien, le chèque est déjà là, nous pouvons l'enregistrer nous-mêmes dans un fichier ou l'imprimer immédiatement en JSON ... <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, answer.Check);</code> </pre> <br>  Et nous obtenons le blocage de l'application en raison de l'accès à un pointeur non valide. <br><br><h2>  CHAPITRE 14. Feu et eau </h2><br>  4 h  Nous effectuons Seth Bandha Sarvangasana pour se calmer et lisons attentivement le manuel: <br><blockquote>  [out] image du chèque, doit être libérée par GlobalFree dans le programme appelant </blockquote>  Qu'est-ce que cela nous donne?  Beaucoup.  Tout d'abord, puisque le pointeur doit être nettoyé à l'aide de GlobalFree, il a été placé à l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GlobalAlloc</a> .  Par conséquent, il n'émet pas de pointeur sur la mémoire, comme c'était le cas dans la version 16 bits, mais un numéro d'objet avec le type sémantiquement déclaré HGLOBAL, qui peut être alimenté dans la fonction GlobalSize pour obtenir la taille du bloc alloué et GlobalLock pour bloquer un morceau de mémoire, mais obtenir le pointeur d'origine.  Par ailleurs, pierre # 6 vers Microsoft pour NIH malloc et gratuit, qui sont dans la bibliothèque standard. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, GlobalLock(answer.Check));</code> </pre> <br>  Et obtenez toujours une goutte.  D'accord, que montre GlobalSize?  Zéro?  D'une certaine manière étrange. <br><br>  Nous vérifions d'autres fonctions qui devraient également donner un glissement - nous voyons la même image. <br><br>  Je pense que je peux générer un bordereau par moi-même en fonction des données que la fonction de paiement la plus cool peut donner (oui, Sberbank a des fonctions appelées card_authorize2..14, je ne jetterai pas de pierre pour cela): <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer14</span></span></span><span class="hljs-class"> {</span></span> auth_answer ans; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]   . . ::auth_answer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AuthCode[MAX_AUTHCODE]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 7 . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardID[CARD_ID_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 25 .     ,   6   4,    '*'.*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ErrorCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> TransDate[TRANSDATE_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TransNumber; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    . , .    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SberOwnCard; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Hash[CARD_HASH_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]  SHA1   ,   ASCII     . 40 .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Track3[CARD_TRACK3_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]   */</span></span> DWORD RequestID; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   .  PCI DSS .*/</span></span> DWORD Department; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     0  14-, .      0xFFFFFFFF,          .        ,      4191. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RRN[MAX_REFNUM]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   ,  .    ,     .   12-  .       (   pilot_nt.dll),     –  (     ;     ,   ).*/</span></span> DWORD CurrencyCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    (810, 643, 840, 978  ..) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardEntryMode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    ('D'-., 'M'- , 'C'-, 'E'- EMV, 'R'- magstripe, 'F'-fallback)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardName[MAX_CARD_NAME_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AID[MAX_AID_ASCII_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out] Application ID   (   ASCIIZ-)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> FullErrorText[MAX_FULL_ERROR_TEXT]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> DWORD GoodsPrice; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    ,  (34.99-&gt;3499)*/</span></span> DWORD GoodsVolume; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  ,  .  (30.234-&gt;30234)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsCode[MAX_GOODS_CODE+<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsName[MAX_GOODS_NAME]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     . !   auth_answer14         gate.dll TGoodsData.     */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/** @brief     * @param[in] track2      .  NULL,     . * @param[in,out] auth_answer . ::auth_answer14 * @param[in,out] payinfo     * @return int  . */</span></span> <span class="hljs-function"><span class="hljs-function">PILOT_NT_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">card_authorize14</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *track2, struct auth_answer14 *auth_answer, struct payment_info_item *payinfo )</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous essayons de sélectionner les champs ... Nous découvrons qu'une seule chose nous a séparés du bonheur - Nom et prénom du titulaire de la carte. </font><font style="vertical-align: inherit;">Sans eux, un bordereau n'est pas considéré comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">légal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Détails: identifiant d'un GAB, d'un terminal électronique ou d'autres moyens techniques destinés aux transactions par carte de paiement; </font><font style="vertical-align: inherit;">type d'opération; </font><font style="vertical-align: inherit;">date de transaction; </font><font style="vertical-align: inherit;">montant de la transaction; </font><font style="vertical-align: inherit;">monnaie de transaction; </font><font style="vertical-align: inherit;">code d'autorisation du montant de la commission; </font><font style="vertical-align: inherit;">détails de la carte de paiement.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est dommage, mais former un bordereau juridique avec les données que nous avons ne fonctionnera pas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinons à nouveau la documentation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On retrouve l'exemple que Sberbank livre dans le répertoire «examples»</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Authorization completion finished with code '"</span></span> &lt;&lt; result &lt;&lt; <span class="hljs-string"><span class="hljs-string">"'"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">ofstream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CHEQUE_FILENAME)</span></span></span></span>; file &lt;&lt; argument.auth_answ.Check; file.close(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argument.auth_answ.Check) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Cheque saved to file "</span></span> &lt;&lt; CHEQUE_FILENAME &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-comment"><span class="hljs-comment">//GlobaFree(argument.auth_answ.Check); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il affiche simplement le texte situé sur le pointeur. </font><font style="vertical-align: inherit;">Mais nous avons déjà vu que cela ne fonctionne pas comme ça ... Juste au cas où, nous allons compiler leur exemple et l'exécuter. </font><font style="vertical-align: inherit;">Départ sur la ligne `file &lt;&lt; argument.auth_answ.Check;`, eh bien, Sberbank, tenez la pierre n ° 11 pour les exemples qui ne fonctionnent pas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 h </font><font style="vertical-align: inherit;">Vous pouvez déjà écrire aux développeurs d'un autre wrapper qui a été écrit en Delphi il y a plusieurs années. </font><font style="vertical-align: inherit;">Nous obtenons la réponse que tout fonctionne pour eux. </font><font style="vertical-align: inherit;">Nous recherchons la base de leur wrapper et trouvons sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="cpp hljs">TAuthAnswer = packed record TType: integer; Amount: UINT; <span class="hljs-comment"><span class="hljs-comment">// IN     Rcode: array [0 .. 2] of AnsiChar; AMessage: array [0 .. 15] of AnsiChar; CType: integer; Check: PAnsiChar; end; Result := Func(nil, @FAuthAnswer); FLastError := Result; FCheque := PAnsiChar(FAuthAnswer.Check);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conversion de type simple en pointeur sans appel de fonction. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous commençons à soupçonner les mauvais esprits.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CHAPITRE 17. Un orage a éclaté </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les gens commencent à retourner au bureau, hochant la tête avec sympathie. </font><font style="vertical-align: inherit;">PO n'a pas l'air très heureux de connaître les dernières nouvelles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, je me souviens d'un détail. </font><font style="vertical-align: inherit;">Lorsque nous avons affiché les champs de la structure # 14 pour voir leurs valeurs, un octet de chaque ligne a été coupé. </font><font style="vertical-align: inherit;">D'une part, d'autre part</font></font><br><blockquote>  Attention!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la structure auth_answer14, le nom du produit est un caractère plus court que dans gate.dll TGoodsData. </font><font style="vertical-align: inherit;">Corrigez cette erreur en standard</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peut-être que c'est toujours lié à ... Une </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terrible supposition surgit dans le cerveau comme un éclair. </font><font style="vertical-align: inherit;">Déclarez la structure comme</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed</span></span></span><span class="hljs-class">)) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rien ne change. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Still Size = 0, Still Lock = NULL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La douleur </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourriture. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Involontairement, vous cherchez avec vos yeux une poutre confortable au plafond, telle qu'elle puisse supporter le poids. Après tant d'heures ininterrompues de codage et d'étude de la documentation, de minces rangées d'octets flottent sous nos yeux. Mais que faire si nous imprimons des octets qui sont généralement renvoyés?</font></font><br><br><pre> <code class="cpp hljs"> u32 i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(answ); i++) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%02x "</span></span>, *((u8 *)&amp;answ + i)); } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); C:\banks\sber\sb_pilot&gt;sb_pilot.exe <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> e8 <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ce e4 ee e1 f0 e5 ed ee <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> f8 <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">7</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">`30 00 00 ce` - ce qui signifie que Sberbank utilise toujours des structures Packed. </font><font style="vertical-align: inherit;">Mais il n'y a pas un mot à ce sujet dans les en-têtes. </font><font style="vertical-align: inherit;">Par conséquent, les exemples ne fonctionnent pas, par conséquent, il est impossible d'obtenir un pointeur sur le texte à la fin - car il est cassé en raison d'un décalage de 1 octet. </font><font style="vertical-align: inherit;">Pierre énorme et épineuse vers Sberbank! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et puis une nuance maaaalenky a attiré mon attention. </font><font style="vertical-align: inherit;">4 + 4 + 3 + 16 + 4 + 4 = 35. Et voici 36 octets, Obelix. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il y a 36 octets, le compilateur aligne toujours la structure. </font><font style="vertical-align: inherit;">Ainsi, entre RCode et AMessage, un octet supplémentaire est toujours inséré. </font><font style="vertical-align: inherit;">Mais pourquoi? </font><font style="vertical-align: inherit;">Après tout, nous avons indiqué «__packed__»!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CHAPITRE 18. Le voyage de retour </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les raisons pour lesquelles l'alignement est toujours activé sont apparues en 2012: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=52991</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Un bug n'a été corrigé que dans GCC 8 (une pierre pour 6 ans de buggy!), Qui n'est pas encore possible d'être mis à jour. </font><font style="vertical-align: inherit;">Heureusement, il existe une solution:</font></font><br><br><pre> <code class="cpp hljs">-mno-ms-bitfields</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous n'analyserons pas maintenant le mécanisme de fonctionnement de ce drapeau, il suffit de le passer au compilateur: </font></font><br><br><img src="https://habrastorage.org/webt/ve/tr/d4/vetrd4m4rsdhmkyxkgrvxbkepko.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slip! </font><font style="vertical-align: inherit;">Chéri! </font><font style="vertical-align: inherit;">Tu m'as manqué, je ne jurerai même pas à cause du krakozyabry, j'ai déjà jeté une pierre pour ça. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et enfin, nous nourrissons la pierre de Microsoft du fait que GlobalSize / Lock donne des zéros sur des pointeurs invalides.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CHAPITRE 19. Dernier chapitre </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour minimiser le nombre d'ifdefs pour la couche sb_pilot, nous avons écrit une application distincte qui imite complètement la version linux de sb_pilot. </font><font style="vertical-align: inherit;">Ainsi, en laissant le code de couche # 1 identique, en ne laissant qu'une seule condition:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(BXI_OS_GLX) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> defined(BXI_OS_WIN) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot.exe"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><img src="https://habrastorage.org/webt/wo/eu/2g/woeu2gk8m1mvtibiepfxwiijrbo.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Résultats de la bataille: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sberbank: 12 pierres </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Microsoft: 7 pierres </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GCC: 1 pierre </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Réalisation-souvenir sur notre tableau de commande: </font></font><br><br><img src="https://habrastorage.org/webt/ko/im/3y/koim3ykfftmlltegcqh_rkdkgxc.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451188/">https://habr.com/ru/post/fr451188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451178/index.html">Essai de collision de l'atterrissage du parachute de l'équipage du dragon</a></li>
<li><a href="../fr451180/index.html">PCB remplace deux moteurs linéaires</a></li>
<li><a href="../fr451182/index.html">Comment les tailles des tableaux C sont devenues une partie de l'interface binaire de la bibliothèque</a></li>
<li><a href="../fr451184/index.html">Blue Origin Blue Moon Project: les gens sur la Lune d'ici 2024</a></li>
<li><a href="../fr451186/index.html">Référentiel LINSTOR et son intégration avec OpenNebula</a></li>
<li><a href="../fr451196/index.html">Séparation des profils client et freelance</a></li>
<li><a href="../fr451198/index.html">Le rôle de la réalité augmentée et de la réalité virtuelle dans la NBA</a></li>
<li><a href="../fr451200/index.html">Obtention automatique de certificats SSL par Let's Encrypt en utilisant le défi DNS-01 et AWS</a></li>
<li><a href="../fr451204/index.html">Éditeurs de texte gratuits pour la collaboration</a></li>
<li><a href="../fr451206/index.html">Que se passe-t-il actuellement avec les référentiels RDF?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>