<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöó üèΩ üïäÔ∏è "20 000 IOPS par n≈ìud sont de bonnes performances avec une latence de 5 ms." Pour OLTP - non üßúüèø üî∏ üë©üèø‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La raison de la r√©daction de cet article √©tait un examen tr√®s utile de la fa√ßon dont nous avons test√© VMware vSAN ... CROC. La critique en vaut la pei...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"20 000 IOPS par n≈ìud sont de bonnes performances avec une latence de 5 ms." Pour OLTP - non</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414269/"><p><img src="https://habrastorage.org/webt/fq/yy/2k/fqyy2kbw4iqx5ikqy7v-o60jfce.jpeg" alt="KDPV"></p><br><p>  La raison de la r√©daction de cet article √©tait un examen tr√®s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utile</a> de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fa√ßon dont nous avons test√© VMware vSAN ...</a> CROC.  La critique en vaut la peine, mais elle contient une phrase avec laquelle je me bats depuis plus d'une d√©cennie.  Les administrateurs de stockage, les virtualiseurs et les int√©grateurs r√©p√®tent encore et encore: "Les d√©lais de 5 ms sont un excellent indicateur."  M√™me le chiffre de 5 ms pendant dix ans ne change pas.  J'ai entendu cela en direct d'administrateurs tr√®s respect√©s pas moins d'une douzaine de fois.  De moins respect√© - des dizaines, et combien de fois j'ai lu sur Internet ... Non, non, non.  Pour les charges OLTP de 5 ms, d'autant plus qu'elles sont g√©n√©ralement mesur√©es, ce sont des √©checs √©piques.  J'ai d√ª expliquer les raisons de cela √† plusieurs reprises, cette fois j'ai d√©cid√© de rassembler mes pens√©es sous une forme r√©utilisable. </p><br><p>  Je dois dire tout de suite qu'il n'y a pas de telles erreurs dans l'article mentionn√© ci-dessus, plut√¥t que la phrase a fonctionn√© comme d√©clencheur. </p><a name="habracut"></a><br><h2 id="tipichnoe-nachalo">  D√©but typique </h2><br><p>  Tout ce qui est d√©crit dans cet article s'applique aux SGBD courants utilis√©s pour les OLTP d'entreprise classiques.  Surtout, j'ai de l'exp√©rience avec MS SQL Server, mais, au moins pour PostgeSQL, Oracle et Sybase, de nombreux points et conclusions resteront √©galement vrais. </p><br><p>  Les SGBD de performance sont g√©n√©ralement m√©contents de tout le monde.  S'il y a un SGBD dans un grand syst√®me - et il est soudainement presque toujours l√† - alors ce SGBD est un goulot d'√©tranglement.  Eh bien, ou cela deviendra imm√©diatement un goulot d'√©tranglement si vous commencez √† optimiser tout le reste.  Et donc, le client vient et dit d'une voix humaine: "Aide! √âconomise! Ils ont pay√© $ NNNNNNNN pour le serveur et le stockage, mais la vitesse n'augmente pas! Oh, et l'administrateur s'est install√© et le vendeur a consult√©, mais ne bouge toujours pas."  Si les d√©veloppeurs du syst√®me correspondent √† la d√©finition de Lavrov (nous pouvons nous passer d'un devis exact) et que les sp√©cialistes de l'exploitation et de la maintenance ¬´luttent contre les incidents en red√©marrant le serveur¬ª, alors le probl√®me est souvent simple et sans pr√©tention: il n'y a pas d'index, de requ√™tes tordues, d'erreurs de configuration fatales (√† propos desquelles la documentation est en gras il dit <strong>"vous ne pouvez pas faire √ßa !!!"</strong> ), des verrous excessifs, des blocages et autres b√™tises simples et claires.  Il existe de nombreux cas de ce type, la plupart, mais pas tous.  Si le syst√®me, en complexit√© ou en charge, a franchi une limite invisible, alors il mourra de ces probl√®mes ou passera au niveau suivant. </p><br><div class="spoiler">  <b class="spoiler_title">Conseils de diagnostic SQL Server</b> <div class="spoiler_text"><p> √Ä mon humble avis, le meilleur outil est d√©sormais le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kit SQL Server First Responder</a> , promu par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Brent Ozar</a> .  Cet outil se d√©veloppe tr√®s activement.  Il y a encore un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">set</a> digne de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Glenn Berry</a> , il n'a pas non plus abandonn√© son projet.  Les deux ensembles sont magnifiques √† leur mani√®re, la lecture des commentaires et des requ√™tes pour la premi√®re fois ouvre beaucoup de nouvelles choses.  Moi-m√™me, je commence toujours √† regarder autour de <code>sys.dm_os_waitsats</code> avec <code>sys.dm_os_waitsats</code> , un rapide coup d'≈ìil au journal des erreurs et √† savoir s'il existe au moins un syst√®me de sauvegarde qui fonctionne. </p></div></div><br><p>  √Ä ce niveau, le serveur n'est plus sous la table du directeur, les disques ne sont plus √† l'int√©rieur du serveur, mais dans le syst√®me de stockage, les d√©veloppeurs connaissent les index et les administrateurs connaissent d√©j√† PowerShell, et les responsables informatiques commencent √† dire des mots intelligents comme SLA et RPO / RTO.  Une situation int√©ressante se pr√©sente √† ce niveau: </p><br><ul><li>  Le SGBD est un goulot d'√©tranglement. </li><li>  Le serveur semble √™tre suffisant √† tous √©gards. </li><li>  Le SGBD peut √™tre encore am√©lior√© par programme, mais il est difficile (soit de passer √† des licences plus ch√®res, soit de passer √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"zone rouge de la courbe Shipilev"</a> pour l'optimisation) </li><li>  Le syst√®me de disques est achet√© cher et, semble-t-il, est m√™me en quelque sorte configur√©. </li></ul><br><p>  Mais non.  Le crocodile n'est pas pris, la noix de coco ne pousse pas et les performances du syst√®me sont identiques ou inf√©rieures √† celles de l'ancien serveur.  Je regarde dans <code>sys.dm_os_waitsats</code> et vois <code>WRITELOG</code> , <code>PAGEIOLATCH_SH</code> et <code>PAGEIOLATCH_EX</code> en haut, le temps d'attente moyen est de 5+ ms.  Eh bien, typique, cho: "H√©, les administrateurs et DBA, ici vous avez un syst√®me de disque - goulot d'√©tranglement" et ici commence une vieille chanson d'environ 5 ms: </p><br><ul><li>  Nous avons 5 ms pour SLA </li><li>  Oui, nous avons un r√©giment de 20 000 IOPS </li><li>  Le vendeur nous a dit que tous les fichiers de base de donn√©es peuvent √™tre sur une seule partition </li><li>  Nous avons la virtualisation et l'hyperconvergence et nous ne pouvons pas allouer de disques s√©par√©s sous la base de donn√©es </li><li>  Selon nos donn√©es, utilisation du serveur 5% </li><li>  Tout est configur√© selon les recommandations </li><li>  Vos bases de donn√©es n'ont pas besoin de beaucoup de performances, elles ne font pas plus de 300 IOPS (et nous avons une √©tag√®re pour 20 000 IOPS) </li></ul><br><p>  Soit dit en passant, tout ce qui pr√©c√®de, non seulement sur "leurs" serveurs, mais aussi sur les services cloud et la virtualisation.  Il y a un tas de ses sp√©cificit√©s, mais le tableau clinique typique est √† peu pr√®s le m√™me: base de donn√©es mod√©r√©ment optimis√©e, personnel de d√©veloppement et de maintenance intelligent, il y a une r√©serve pour le processeur et la m√©moire, le "pot d'√©chappement" des investissements futurs est presque nul. </p><br><p>  Alors voil√†.  Toute cette chanson sur "5 ms" est un non-sens et un non-sens.  Si vous le dites vous-m√™me, lisez cet article.  Et s'ils vous le disent, pr√©parez les arguments.  Avant, quand j'ai entendu ces mots, j'√©tais en col√®re, mais je ne suis plus en col√®re.  Moi, comme ce pot avec un p√©tunia du Guide de l'auto-stoppeur de la galaxie, je n'ai qu'une seule pens√©e: "Eh bien, encore une fois ...". </p><br><h2 id="kto-vinovat">  Qui est √† bl√¢mer? </h2><br><p>  Pourquoi la base de donn√©es est-elle si lente?  Eh bien, il semblerait qu'un serveur typique avec 20 √† 64 c≈ìurs √† une fr√©quence de 2 √† 3 GHz est capable d'effectuer 50 √† 150 milliards d'op√©rations simples, et les tests de base de donn√©es (synth√©tiques) maximaux ne montrent sur ces machines que 10 000 √† 5 000 transactions par seconde.  H√©!  Eh bien, cela repr√©sente un million √† une douzaine de millions de transactions possibles par transaction.  Ce n'est pas seulement beaucoup, c'est beaucoup √† ressentir. <br>  Ces frais g√©n√©raux ont co√ªt√© les exigences <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ACID</a> pour les transactions. </p><br><ul><li>  <strong>Une</strong> tomicit√© - soit l'ensemble de la transaction est termin√©e, soit l'ensemble n'est pas termin√©. </li><li>  Coh√©rence - √† l'entr√©e et √† la sortie d'une transaction, le syst√®me est dans un √©tat coh√©rent </li><li>  <strong>I</strong> solation - les transactions ne voient pas les √©tats interm√©diaires de l'autre </li><li>  <strong>D</strong> urabilit√© - si la transaction a √©t√© effectu√©e avec succ√®s (valid√©e), alors, quelles que soient les circonstances, les modifications apport√©es doivent rester dans le syst√®me. </li></ul><br><p>  Soit dit en passant, lettre par lettre, ces exigences ne sont pas remplies presque partout et jamais, mais simplement jamais dans les syst√®mes distribu√©s (le th√©or√®me CAP interf√®re).  Pour notre situation, l'exigence ¬´D¬ª est plus susceptible d'√™tre plus ch√®re que d'autres, cette exigence est fournie par le m√©canisme cl√© de tous les SGBD OLTP courants: WAL, journal d'√©criture anticip√©e (PostgeSQL), c'est aussi un journal de transactions (SQL Server), alias journal REDO (Oracle).  Le voici - une pierre sur le goulot de la productivit√©, et c'est le fondement des transactions de durabilit√©. </p><br><h3 id="chto-takoe-wal">  Qu'est-ce que le WAL? </h3><br><p>  Oublions un instant les SSD modernes, les syst√®mes de stockage sympas.  Supposons que nous ayons un serveur, il a un ou plusieurs disques. <br>  Toute transaction, m√™me l'insertion d'un enregistrement, est au moins potentiellement, mais en fait presque toujours et de mani√®re r√©aliste une action non atomique.  Nous devons presque toujours changer non seulement la page o√π se trouve l'enregistrement, mais aussi les pages d'index, √©ventuellement les pages de service.  De plus, dans la m√™me transaction, la m√™me page peut changer plusieurs fois.  De plus, d'autres transactions peuvent √™tre effectu√©es en parall√®le avec nous.  De plus - les transactions voisines dans le temps "tirent" constamment les m√™mes pages.  Si nous attendons que chaque page soit √©crite sur le disque avant de continuer, ce qui est essentiellement ce que la durabilit√© exige, nous devrons √©crire plusieurs fois plus et attendre que chaque enregistrement soit termin√© sur un support non volatile.  Pas de caches, pas de r√©arrangement des op√©rations dans la file d'attente, sinon il n'y aura pas d'int√©grit√©!  De plus, nous devons en quelque sorte noter quelles donn√©es sont d√©j√† sur des transactions fixes et lesquelles ne le sont pas encore (et quelles donn√©es √©taient ant√©rieures).  Pour la compr√©hension - un disque dur unique typique (HDD) dans ce mode donnera 50-100 IOPS et cela a √©t√© une constante pendant 20 ans.  Une petite transaction n√©cessitera 5 √† 10 op√©rations d'√©criture.  Ah oui, pour savoir quoi enregistrer, il faut le lire.  M√™me les syst√®mes OLTP tr√®s, tr√®s inscriptibles lisent 3 fois plus qu‚Äôils n‚Äô√©crivent.  Ainsi, notre transaction co√ªte entre 20 et 40 E / S, ce qui signifie 0,2 √† 0,8 seconde par disque. <br>  2 transactions par seconde.  Pas assez?  Essayons de disperser les disques?  Oh, mais nous devons encore attendre que le pr√©c√©dent soit enregistr√© et qu'il n'y ait pas de parall√©lisme √† la fin.  Comment √™tre  Et commen√ßons un fichier journal dans lequel nous enregistrerons s√©quentiellement toutes les op√©rations d'√©criture dans la base de donn√©es et les marques de transaction!  Avantages: </p><br><ul><li>  Les informations sur l'op√©ration peuvent √™tre beaucoup plus compactes que l'enregistrement de la page enti√®re (une taille de page typique est de 8 Ko, les informations √©crites dans le journal sont souvent de 0,5 √† 1 Ko). </li><li>  Au lieu d'√©crire si la transaction est enregistr√©e ou non directement sur la page, il y a suffisamment d'√©tiquettes sur le d√©but et la fixation de la transaction dans le journal. </li><li>  Les pages ne peuvent pas √™tre √©crites apr√®s chaque transaction - plusieurs fois moins.  Le processus de lecture / √©criture des donn√©es est compl√®tement "d√©li√©" du journal. </li><li>  L'essentiel.  Si nous pla√ßons notre journal sur un disque s√©par√© et √©crivons des enregistrements s√©quentiellement, du fait que vous n'avez pas besoin de repositionner constamment les t√™tes de disque, m√™me un disque dur domestique dans ce mode r√©duit jusqu'√† 1000 IOPS, √©tant donn√© que les petites transactions "co√ªtent" 2-4 entr√©es de journal, alors vous pouvez presser 200-400 TPS </li><li>  En cas d'√©chec, l'√©tat du fichier de donn√©es peut √™tre restaur√© √† l'aide d'un tel journal et si une transaction est annul√©e, les modifications peuvent √™tre annul√©es. </li></ul><br><p>  Un tel journal est appel√© journal d'√©criture anticip√©e / journal des transactions / journal REDO. </p><br><p>  Hourra!  Super!  Il y avait 2 transactions par seconde, il est devenu 300 - am√©lior√© 150 fois.  Et √† quel prix?  Il s'av√®re que le prix est important: </p><br><ul><li>  Dans tous les SGBD courants, la journalisation est strictement coh√©rente.  Un thread est responsable de l'√©criture dans le journal.  Avez-vous 100 processeurs?  Cool.  Et le journal √©crit toujours un thread.  La profondeur de la file d'attente est exactement une. </li><li>  Toujours - pas de caches OS, pas de permutations d'op√©rations.  Les exigences de durabilit√© sont rest√©es.  Op√©rations d'√©criture: jusqu'√† ce que le disque r√©ponde "J'ai √©crit, je l'ai √©crit directement √† la surface, pas dans le cache, c'est s√ªr" Le SGBD ne continue pas de fonctionner. </li><li>  Si vous placez le fichier journal sur le disque de donn√©es, presque tous les avantages de l'enregistrement s√©quentiel seront perdus.  De plus - pour de bon, s'il y a plusieurs bases de donn√©es sur le serveur, puis plusieurs disques pour les magazines. </li><li>  Restauration de transaction (au moins dans MS SQL Server) - lisez le journal et restaurez-en l'√©tat.  Il s'agit d'autant d'op√©rations d'√©criture, voire plus, que d'op√©rations d'√©criture dans la transaction.  Le retour en arri√®re co√ªte cher! </li></ul><br><p>  Cette explication est tr√®s simplifi√©e, "sur les doigts".  Cela suffit pour notre sujet.  Le WAL est un m√©canisme cl√© et fondamental pour garantir la transactionnalit√©, il est n√©cessairement √©crit, l'acc√®s est monothread uniquement pour l'enregistrement s√©quentiel, du point de vue du stockage, la profondeur de la file d'attente est de 1. </p><br><div class="spoiler">  <b class="spoiler_title">Si ce sujet vous int√©resse</b> <div class="spoiler_text"><ul><li>  Un article tr√®s introductif sur la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conception des bases de donn√©es</a> </li><li>  Il existe une excellente s√©rie d'articles pour SQL Server: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comment arr√™ter d'appeler le journal des transactions SQL Server un fichier journal et arr√™ter de se battre pour sa taille.</a> </li><li>  Il est int√©ressant de regarder un peu de l‚Äôautre c√¥t√©, par exemple, la transcription d‚Äôun excellent rapport sur le SGBD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tarantool en</a> m√©moire </li><li>  Chaque SGBD comporte de nombreuses sections expliquant le fonctionnement de WAL. </li></ul></div></div><br><p>  Le sujet de la journalisation en √©criture anticip√©e dans la base de donn√©es doit √™tre au moins minimal connu de toute personne qui, d'une mani√®re ou d'une autre, administre le SGBD ou l'infrastructure du SGBD ou d√©veloppe des bases de donn√©es. </p><br><h3 id="wal-i-shd">  WAL et SHD </h3><br><p>  Les fabricants de stockage ¬´d√®s la naissance¬ª sont confront√©s au SGBD.  C'est pour les bases de donn√©es que les entreprises ach√®tent ces complexes incroyablement chers: √† partir des stockages de prix de rue de Dell-EMC, HP, Hitachi, NetApp, lors de la conception d'un budget, les yeux sont remplis de larmes de la plupart des cadres sup√©rieurs, √† moins, bien s√ªr, qu'ils n'obtiennent un pourcentage de ce prix.  Mais il y a un conflit d'ing√©nierie et de marketing.  Je vais l'expliquer en utilisant l'exemple de Dell-EMC, mais uniquement parce que je me souviens o√π ils ont la documentation. </p><br><p>  Donc: </p><br><ol><li>  Journal √† fil unique </li><li>  Le journal d'√©criture, c'est-√†-dire la latence, est "√©ternel" par rapport aux performances du processeur </li><li>  Les charges OLTP sont beaucoup de transactions relativement petites, </li><li>  La plupart des autres charges SGBD sont parall√®les d'une mani√®re ou d'une autre. </li></ol><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La loi d'Amdahl</a> nous dit sans piti√© qu'une charge basse performance √† un seul thread rendra inutile l'ajout de processeurs, et les performances seront d√©termin√©es par le journal.  De plus, en ce moment, nous ne nous soucierons pas des performances de stockage dans les IOPS, et seule la latence deviendra importante. <br>  Mais ne n√©gligez pas les autres op√©rations sur le disque - lecture et √©criture dans les fichiers de donn√©es et <code>tempdb</code> .  La lecture est √©galement une op√©ration "en attente".  Tant qu'une page de donn√©es n'est pas lue du disque dans la m√©moire, le processeur ne peut pas la traiter.  Mais pour ces op√©rations, de grandes files d'attente et la permutation des op√©rations dans cette file d'attente sont possibles: le SGBD sait souvent quelles pages charger en m√©moire, quelles pages √† vider et met beaucoup de files d'attente pour la lecture √† la fois.  √âtant donn√© que dans ce sc√©nario, il est important lorsque la derni√®re op√©ration du bundle se termine, dans cette charge, au contraire, l'IOPS est plus important pour nous que la latence d'une seule op√©ration.  Pour comprendre la port√©e: les op√©rations de lecture dans un syst√®me OLTP typique sont de 85% √† 95%.  Oui, oui, oui, les op√©rations d'√©criture sont un ordre de grandeur moins. </p><br><p>  Les ing√©nieurs de stockage des fournisseurs travaillent en √©troite collaboration avec les fournisseurs de SGBD et connaissent bien toutes les nuances techniques du fonctionnement d'un SGBD avec un sous-syst√®me de disque.  Une bonne planification, partitionnement et allocation des ressources disque pour le SGBD est une comp√©tence complexe et importante de l' <strong>administrateur du syst√®me de stockage</strong> .  Le m√™me Dell-EMC a m√™me le livre blanc de base <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">H14621</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">H12341</a> pour les recommandations de partitionnement pour SQL Server - plus d'une centaine de pages.  H√©!  Ce n'est pas un dock d√©taill√©, c'est le livre blanc le plus courant!  Il y en a encore <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plein</a> de sp√©cifiques ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">h15142</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">h16389</a> ... il y a de l'obscurit√© l√†-bas).  Les ¬´contigus¬ª de VMware - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Architecture de Microsoft SQL Server sur VMware vSphere</a> ne sont pas loin derri√®re.  Veuillez noter que ces documents ne sont pas seulement et pas tant pour les administrateurs de base de donn√©es que pour les administrateurs d'infrastructure et de stockage. <br>  Je note √©galement que dans tous ces documents, des LUN s√©par√©s sont coup√©s pour les donn√©es, les journaux et <code>tempdb</code> .  Oui, quelque part dans les derniers documents, ils disent clairement que pour les solutions All-Flash, cela n'a aucun sens de s√©parer les journaux sur des supports physiquement s√©par√©s, mais les LUN proposent toujours de les couper s√©par√©ment.  Si vous transf√©rez des donn√©es et vous connectez dans un LUN, du point de vue du syst√®me d'exploitation, ce sera une file d'attente IO.  Et il y aura un probl√®me.  Les op√©rations de latence auront imm√©diatement un ordre de grandeur de plus.  Et du fait que des op√©rations de journalisation non d√©pla√ßables appara√Ætront dans la file d'attente, IOPS glissera sur les fichiers de donn√©es et <code>tempdb</code> .  Ce n'est pas une "d√©couverte du si√®cle", c'est une v√©rit√© √©l√©mentaire de travailler avec la base de donn√©es.  Il n'est pas obsol√®te ni annul√© avec l'av√®nement de All-Flash.  Oui, les retards dans les op√©rations avec les disques SSD sont plus rapides d'un ordre de grandeur que dans les op√©rations avec les disques durs, mais toujours deux fois plus lents que les op√©rations avec m√©moire.  IO est toujours le goulot d'√©tranglement du SGBD. <br>  Et les documents techniques soulignent correctement que dans les journaux de transactions, le nombre d'IOPS n'est pas important, mais il est important que la latence soit minimale (dans les temps modernes, il est √©crit moins de 1 ms). </p><br><p>  Mais les commer√ßants doivent vendre.  Hyperconvergence!  Virtualisation!  Flexibilit√© de d√©ploiement!  D√©duplication!  Configuration facile!  Beaucoup, beaucoup d'IOPS!  Belles pr√©sentations, voix confiante, costumes formels.  Mais comment vendre autrement une solution avec un prix de 6 √† 7 chiffres en dollars?  Pour cela, on oublie en quelque sorte que la latence ou le d√©bit peuvent √™tre obtenus √† partir du syst√®me de stockage, mais pas les deux √† la fois, qu'une sorte de licence pour l'√©quilibreur de charge est comme une autre √©tag√®re, que si l'enregistrement intensif dure plus d'une heure, alors la RAM des contr√¥leurs ce n'est pas suffisant et la productivit√© descendra "comme s'il n'y avait pas de cache", que la formation des employ√©s du client co√ªte encore 100 000 roubles pour la premi√®re ann√©e, eh bien, de telles astuces ... </p><br><h3 id="5-ms">  5 ms </h3><br><p>  Soit avoir beaucoup entendu parler de la lecture des sp√©cialistes du marketing, soit de la paresse, soit √† cause d'une sorte de cafards, mais pour une raison quelconque, les administrateurs de stockage font souvent quelque chose comme √ßa.  Nous prenons une grande √©tag√®re, combinons le tout en quelque chose de plat, le coupons en LUN provisionn√©s fins et le distribuons par LUN au serveur.  Ou deux, parce que "la partition syst√®me est bien d√©dupliqu√©e".  Et quand, je vois qu'avec le sous-syst√®me de disque du c√¥t√© de l'enfer-enfer-enfer SQL, alors la chanson commence que "5 ms est un excellent indicateur", que "100000 IOPS", "Votre charge de stockage est inf√©rieure √† 5%" </p><br><p>  <strong>Non</strong> . </p><br><ul><li>  Pour les syst√®mes OLTP sur une partition avec WAL / journaux de transactions de 5 ms, il s'agit d'un indicateur non valide.  Sur le morceau de fer "presque marchandise" pour un prix de 1000 (en mots: mille) fois moins cher, l'indicateur normal sera d√©sormais 0,1-0,3 ms.  Et demain - 0,01 ms.  La vitesse, comme celle du disque dur 2008, au prix de toute une entr√©e d'appartements √† Moscou, n'est pas n√©cessaire.  Aucune ¬´facilit√© d'entretien¬ª n'en vaut la peine. </li><li>  Le fournisseur √©crit-il que les journaux de transactions n'exigent pas d'IOPS et peuvent-ils √™tre plac√©s sur le disque dur?  Oui.  Mais pour cela, il est n√©cessaire qu'aucun de ces disques <del>  contagion </del>  En plus d'√©crire des journaux, le SGBD n'a pas touch√© la t√¢che.  Et pour que le syst√®me de stockage r√©ponde au serveur que les donn√©es sont √©crites, imm√©diatement lorsque les donn√©es sont entr√©es dans la m√©moire non volatile (c'est beaucoup plus t√¥t qu'elles ne seront √©crites) </li><li>  Les disques minces pour les vraies bases de donn√©es OLTP sont mauvais. </li><li>  Pour WAL, il n'est absolument pas int√©ressant de savoir combien d'IOPS peut √™tre compress√© √† une profondeur de file d'attente de 10 ou 20. Il n'y a pas de profondeur l√†-bas. </li><li>  Pour WAL, ce n'est absolument pas un indicateur que la file d'attente d'E / S dans le syst√®me d'exploitation est ¬´seulement environ 1¬ª.  Elle ne sera plus. </li><li>  Non, les d√©veloppeurs DBA et DB ne sont pas des "pics excentriques qui ne peuvent pas correctement configurer pour √©crire sur le parall√®le WAL" <em>(avis r√©el de l'administrateur)</em> </li><li>  La logique des fans de consid√©rer le recyclage "puisque votre syst√®me que <em>nous avons configur√© de mani√®re tordue dans une partition</em> ne fait pas 10 000 IOPS, alors il doit √™tre d√©plac√© d'une baie haut de gamme vers le milieu de gamme" - c'est une logique incorrecte. </li><li>  Si le serveur √† 40 c≈ìurs a une charge de processeur de 2,5%, cela ne signifie pas qu'il n'a rien √† faire, mais, tr√®s probablement, signifie qu'il existe une sorte de t√¢che qui bloque tout le monde. </li></ul><br><p>  Lorsque le chargement de certaines donn√©es sur l'ordinateur portable du d√©veloppeur prend 5 minutes, et sur le 40e serveur nucl√©aire avec 1 TiB de RAM et un stockage pour un demi-million de dollars, la m√™me t√¢che est effectu√©e pendant une heure, m√™me les clients les plus patients auront des questions sur la faisabilit√© des co√ªts. </p><br><table><thead><tr><th>  Latence moyenne de la partition WAL </th><th>  il n'y aura jamais plus de transactions par seconde que: </th></tr></thead><tbody><tr><td>  5 ms </td><td>  200 </td></tr><tr><td>  1 ms </td><td>  1000 </td></tr><tr><td>  0,5 ms </td><td>  2000 </td></tr><tr><td>  0,1 ms </td><td>  10 000 </td></tr><tr><td>  0,05 ms </td><td>  20000 </td></tr></tbody></table><br><h2 id="chto-delat">  Que faire </h2><br><h3 id="sovety-administratoram-i-dba">  Conseils d'administration et DBA </h3><br><p>  Pour OLTP, arr√™tez de compter ¬´recyclage¬ª et IOPS.  S√©par√©ment, je note - ne regardez pas du tout les IOPS avec de grandes profondeurs de file d'attente: m√™me sur les partitions de donn√©es, les grandes files d'attente ont g√©n√©ralement une courte rafale ou quelque chose qui n'affecte pas les performances r√©elles d'OLTP. </p><br><p>  Le partage d'espace disque par LUN n'est pas un caprice DBA.  La base de donn√©es poss√®de plusieurs profils de chargement de sous-syst√®me de disque diff√©rents.  Au minimum, on peut distinguer: </p><br><ul><li>  Travaillez avec des fichiers de donn√©es.  Il s'agit g√©n√©ralement de lire et d'√©crire avec des blocs al√©atoires de 8/64 Ko.  Lectures 80-95%.  Des files d'attente surviennent: pendant les p√©riodes de service, pendant les p√©riodes de chargement en vrac, sur des demandes inefficaces ou massives, et pendant le point de contr√¥le.  La performance est affect√©e par la r√©activit√© √† la lecture.  Il est important que l'alignement des blocs 8/64 KiB ¬´√† travers¬ª passe par l'ensemble du syst√®me de stockage. </li><li>  Travailler avec <code>tempdb</code> est le m√™me que travailler avec des fichiers de donn√©es, mais les lectures sont g√©n√©ralement de 40 √† 75% et la r√©activit√© en √©criture peut √™tre importante.  Dans les syst√®mes MS SQL modernes, cette base de donn√©es peut √™tre charg√©e plusieurs fois plus fort que les bases de donn√©es.  Dans une configuration de SGBD non en cluster, cette section doit √™tre exclue de toute r√©plication de stockage.  Son contenu apr√®s le red√©marrage du service sera toujours d√©truit. </li><li>  Travailler avec des donn√©es archiv√©es / DWH.  Les lectures sont proches de 100%.  La taille d'un bloc de lecture est g√©n√©ralement de 64 Ko.  Les demandes sont lues beaucoup et d'affil√©e, de sorte que la file d'attente peut sauter jusqu'√† 1000 ou plus. </li><li>  Travaillez avec les journaux de transactions.  La lecture est uniquement destin√©e √† la maintenance (sauvegarde, r√©plication, etc.), les performances des applications ne sont affect√©es que par l'√©criture.  Enregistrement en blocs de 0,5 √† 64 Ko.  Sans file d'attente, dans un seul fil.  Le d√©lai est critique pour les applications. </li><li>  Sauvegarde et restauration.  Du point de vue de la base de donn√©es, on lit en gros blocs (souvent 1 Mio).  Il est important que cette charge puisse reposer sur les canaux / bus (FC et Ethernet) et sur les performances des processeurs de stockage dans certains cas.  La sauvegarde d'un serveur peut affecter les performances des autres serveurs du m√™me SAN / SHD. </li><li>  Travailler avec des fichiers d'application: ce sont les journaux, la trace par d√©faut, les fichiers binaires, etc.  Cette charge est rarement importante et n'est importante qu'au d√©but du syst√®me. </li></ul><br><p>  Il existe d'autres types de charge, mais ils sont l√©g√®rement exotiques (par exemple, il peut y avoir un r√©f√©rentiel de fichiers stock√©s dans la base de donn√©es sous la forme du r√©pertoire FileStream).  Tous ces types de charges ont des exigences de disque diff√©rentes, souvent conflictuelles.  S'ils sont tous empil√©s sur une partition, vous d√©grade non seulement les performances, mais il est tr√®s important que vous perdiez la capacit√© de comprendre pourquoi le syst√®me ralentit, et vous perdez √©galement la possibilit√© d'am√©liorer uniquement la partie qui a besoin d'am√©lioration sans am√©liorations / mises √† niveau globales du stockage.  Par cons√©quent, la principale recommandation: </p><br><p> <strong>      ,   "   "        .        .</strong> </p><br><p>     </p><br><ul><li>    ,   .  Dell/EMC  SQL Server     . </li><li>    .      ""  (, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> NUC c SSD,  , </a> ).    --,    . </li><li>      <strong></strong>     DBA,    -   ( 200   ). </li><li>        (etrolaster   ), ,     ,  .      +0,5 ,    0,2,     0,7     3 . </li><li>   ,          .      <code>tempdb</code>  , , ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RCSI</a>   12      . </li><li> Latency    throughput.         ,   " ",   .    throughput  latency,    .      . </li></ul><br><h3 id="ms-sql-server"> MS SQL Server </h3><br><p>    MS SQL,            bottleneck  ,  - : </p><br><ol><li>        .  C'est correct.        . 1000          5-30      1000 <code>INSERT</code> . , , ,       ,      "  ‚Äî  ". </li><li>  <code>tempdb</code>   " ".    . ,     ,       . </li><li>     ,    BULK INSERT      .            ,      "Simple"  "Bulk logged". , ,         Simple/Bulk logged  Full  .         ‚Äî <a href="">The Data Loading Performance Guide</a> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .   (  ETL,   OLTP)       <a href="">We Loaded 1TB in 30 Minutes with SSIS, and So Can You</a> </li><li>    SQL Server  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Delayed Transaction Durability</a> ‚Äî ,       . </li><li>    SQL Server  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">In-Memory OLTP</a> .    ,        . </li><li> ,     ,   AlwaysOn . </li></ol><br><h2>  *** </h2><br><p>  C‚Äôest tout.   . 20000 IOPS  5  latency    4-16         OLTP.  OLTP    ,        . </p><br><div class="spoiler"> <b class="spoiler_title">PS:    SSD.</b> <div class="spoiler_text"><p>              .  Intel Optane.   SSD ""       4,       .            SSD, ,     ,      .    SSD  . ,      ""   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,    </a> .      Intel Optane:      ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> )        1     20 .     ,  . SSD        100-300 .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>     SSD. <br>  , .         OLTP "",  in-memory     ACID.     latency 20      "" .  low-latency        Optane ( <em>    ?</em> ). <br>          ( ) Optane. </p></div></div><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">eugeneb0</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">apatyukov</a>     . </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414269/">https://habr.com/ru/post/fr414269/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414255/index.html">R√™ve brevet√© du programmeur - Partie II</a></li>
<li><a href="../fr414261/index.html">O√π stockez-vous les donn√©es?</a></li>
<li><a href="../fr414263/index.html">Y a-t-il de la vie en dehors de Roscosmos? Aper√ßu de l'exploration de l'espace priv√© russe</a></li>
<li><a href="../fr414265/index.html">Richard Hamming: Chapitre 7. Intelligence artificielle - II</a></li>
<li><a href="../fr414267/index.html">Comment remplacer un comptable par un robot?</a></li>
<li><a href="../fr414271/index.html">Comment apprivoiser un disque dur dans un ordinateur portable et emp√™cher le stationnement en 8 secondes d'arr√™t</a></li>
<li><a href="../fr414273/index.html">Ce que vous devez savoir avant de d√©velopper un backtester pour une strat√©gie de trading: probl√®mes typiques, types de syst√®mes et leurs param√®tres</a></li>
<li><a href="../fr414277/index.html">L'homme, son environnement et l'Internet des objets</a></li>
<li><a href="../fr414279/index.html">Vote des rapports lors de la huiti√®me r√©union de bricolage du groupe Mail.Ru (07.07.2018)</a></li>
<li><a href="../fr414281/index.html">D√©veloppement d'un compteur de vitesse de v√©lo bas√© sur un √©cran du Nokia 3310</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>