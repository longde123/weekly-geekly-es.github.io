<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì≠ üå≤ üë©üèø‚Äçüî¨ Si puedes, parcheame: c√≥mo estamos depurando la producci√≥n. Parte 1 üöΩ üëâüèø ‚òùüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPD: la segunda parte del art√≠culo est√° lista . 

 Hola Habr! Me llamo Alexander Izmailov. En Badoo, lidero un equipo de ingenieros de lanzamiento. S√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Si puedes, parcheame: c√≥mo estamos depurando la producci√≥n. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/413503/">  <b>UPD: la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">segunda parte del art√≠culo</a> est√° lista <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">.</a></b> <br><br>  Hola Habr!  Me llamo Alexander Izmailov.  En Badoo, lidero un equipo de ingenieros de lanzamiento.  S√© que en muchas empresas puede enviar cambios de c√≥digo a una persona especialmente capacitada, √©l los mira y los agrega a donde deber√≠an (por ejemplo, esto es exactamente lo que sucede con el c√≥digo Git).  Y quiero hablar sobre c√≥mo automatizamos este proceso con nosotros. <br><br>  Mi historia constar√° de dos partes.  En esta parte, hablar√© sobre lo que quer√≠amos lograr del nuevo sistema, c√≥mo se ve√≠a en su primera versi√≥n y por qu√© al final tuvimos que rehacerlo.  En la segunda parte, hablaremos sobre el proceso de rehacer el sistema y sobre las bonificaciones inesperadas que nos trajo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kz/rx/oo/kzrxooelulor2_oeeddmmd-o7xg.png" height="500"></div><br>  Imagen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fuente</a> <br><a name="habracut"></a><br>  √ârase una vez en nuestra empresa, todos pod√≠an hacer sus cambios directamente en la rama maestra y exponerlos con sus propias manos.  Para hacer esto, escribimos una utilidad especial de MSCP que funcion√≥ de manera bastante primitiva: copi√≥ los cambios de una m√°quina a otra y estableci√≥ los derechos necesarios. <br><br>  A medida que pas√≥ el tiempo, la empresa creci√≥, y tuvimos que pensar en la automatizaci√≥n de los procesos, incluido el proceso de presentar peque√±os cambios.  Entonces se nos ocurri√≥ la idea de crear un sistema de parches.  En primer lugar, quer√≠amos que permitiera a cualquier desarrollador enviar sus cambios a Git y distribuirlos en los servidores.  Por nuestra parte, exigimos que otro desarrollador analice los cambios y que est√©n vinculados a la tarea desde nuestro sistema de seguimiento de errores (utilizamos Jira). <br><br><div class="spoiler">  <b class="spoiler_title">Patch collector 6000</b> <div class="spoiler_text">  Debo decir que estos requisitos no atrajeron a todos los desarrolladores.  Nos pareci√≥ que pasar un par de minutos creando una tarea no es una cosa, pero para nosotros esto significar√≠a un uso m√°s deliberado del sistema.  Pero los desarrolladores comenzaron a resistirse, argumentando que presentar los cambios lleva varias veces menos tiempo que crear un nuevo boleto.  Como resultado, todav√≠a tenemos tareas "universales", a las que se adjuntan cientos de parches. <br><br>  Adem√°s, el sistema fue concebido con el objetivo de solucionar problemas urgentes, y encontrar un revisor para un parche a las tres de la ma√±ana puede ser dif√≠cil. <br></div></div><br><h2>  Que necesitamos </h2><br>  <s>S√≠, solo una luz en la ventana ...</s> Nuestro problema podr√≠a dividirse en dos partes: necesit√°bamos alguna forma de aceptar los cambios en el repositorio y otra forma de presentar estos cambios. <br><br>  Decidimos la primera pregunta con la suficiente rapidez: hicimos un formulario al que ten√≠amos que adjuntar nuestros cambios e indicar los detalles (revisor y tarea). <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kl/yk/gt/klykgtwk7gjwahm7bittw-jrf58.png" height="500"></div><br><br>  En la segunda p√°gina, puede ver los cambios, rechazarlos o aceptarlos. <br><br><img src="https://habrastorage.org/webt/dd/2k/s8/dd2ks86twqszir9vu7jsaiu6cym.png"><br><br>  Despu√©s de la confirmaci√≥n, los cambios cayeron en maestro. <br><br>  Segunda pregunta: ¬øc√≥mo se pueden entregar estos cambios a los servidores r√°pidamente?  Hoy en d√≠a, muchos utilizan la integraci√≥n continua, y podr√≠a funcionar bien si nuestras construcciones y dise√±os "honestos" no tomaran tanto tiempo. <br><br><h3>  Asamblea justa </h3><br>  Nuestro montaje siempre ha sido bastante complicado.  El principio general era el siguiente: en un directorio separado, distribuimos los archivos como estar√≠an en los servidores de destino;  luego guardamos este estado en una instant√°nea (instant√°nea del sistema de archivos) y la presentamos. <br><br>  Ponemos el c√≥digo PHP en el directorio, que tomamos del repositorio tal cual, agregamos los archivos generados (por ejemplo, plantillas y traducciones).  Presentamos las estad√≠sticas por separado.  Este es un proceso bastante complicado, y puede dedicarle un art√≠culo completo, pero como resultado, ten√≠amos un mapa de versiones para generar enlaces de archivos para los usuarios que se fueron junto con el c√≥digo principal. <br><br>  A continuaci√≥n, el estado del directorio deb√≠a guardarse en alguna parte.  Para hacer esto, utilizamos un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dispositivo de bloque</a> , que llamamos un bucle.  Todo el directorio se copi√≥ a un dispositivo vac√≠o, que luego se archiv√≥ y se entreg√≥ a servidores "principales" separados.  De estos servidores tomamos archivos en el proceso de dise√±o.  Cada archivo ten√≠a un tama√±o de 200 MB, y cuando se descomprimi√≥, los bucles pesaron 1 GB.  Nos llev√≥ unos cinco minutos construir sin est√°tica. <br><br><h3>  Dise√±o justo </h3><br>  Primero ten√≠amos que entregar el archivo a los servidores de destino.  Tenemos miles de ellos, por lo que la pregunta de entrega para nosotros siempre ha sido un gran problema: tenemos varias plataformas (centros de datos) y en los mil servidores "m√°s gruesos" con un c√≥digo.  En un intento por lograr un mejor rendimiento (tiempo y recursos m√≠nimos), probamos diferentes m√©todos: desde un SCP simple hasta torrents.  Al final, decidimos usar UFTP.  El m√©todo fue r√°pido (con buen tiempo, un minuto), pero desafortunadamente no estuvo libre de problemas.  Peri√≥dicamente, algo se romp√≠a y ten√≠amos que recurrir a los administradores y a los networkers. <br><br>  Despu√©s de que el archivo (de alguna manera) se encuentre en los servidores, debe desempaquetarse, lo que tampoco es gratuito.  Este procedimiento parece especialmente costoso si recuerda que se realiza miles de veces, aunque en paralelo en diferentes m√°quinas. <br><br><h3>  Sin montaje </h3><br>  Por lo tanto, la publicaci√≥n honesta de los cambios tom√≥ mucho tiempo, y la velocidad de entrega fue muy importante para el sistema de parches, porque se supon√≠a que lo usar√≠an cuando algo ya no funcionara.  Por lo tanto, volvimos a la idea de usar MSCP: r√°pido y f√°cil de implementar.  Por lo tanto, despu√©s de que aparecieron los cambios en el asistente, en una p√°gina separada fue posible descomponer los archivos modificados a su vez. <br><br><img src="https://habrastorage.org/webt/6v/xr/zh/6vxrzhjqovb_itqx7g8caopp5zq.png"><br><br><h2>  Esta vivo </h2><br>  El sistema esta funcionando.  A pesar de cierta insatisfacci√≥n con las peque√±as cosas, los desarrolladores pod√≠an hacer su trabajo, y para esto no necesitaban acceso al maestro o acceso a los servidores. <br><br>  Pero, por supuesto, con este m√©todo de dise√±o, tuvimos problemas.  Algunos eran predecibles, algunos incluso decidimos de alguna manera.  La mayor√≠a de ellos estaban relacionados con la edici√≥n de archivos en paralelo. <br><br><h3>  Un parche para m√∫ltiples archivos </h3><br>  Un ejemplo de un problema predecible.  Se presentaron nuevos archivos a su vez.  ¬øQu√© hacer si necesita cambiar varios archivos y los cambios est√°n relacionados con ellos?  Por ejemplo, quiero agregar un nuevo m√©todo en un archivo e inmediatamente usarlo en otros.  Mientras no haya bucle invertido utilizando m√©todos (ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recursi√≥n mutua</a> ), es suficiente recordar el orden correcto de dise√±o del archivo. <br><br><div class="spoiler">  <b class="spoiler_title">Decisi√≥n honesta</b> <div class="spoiler_text">  Para resolver el problema, necesit√°bamos reemplazar varios archivos at√≥micamente.  En el caso de un solo archivo, la soluci√≥n es conocida: debe usar el cambio de nombre de la operaci√≥n de archivo.  Supongamos que tenemos un archivo F y necesitamos reemplazar su contenido.  Para hacer esto, cree un archivo TMP, escr√≠bale la informaci√≥n necesaria y luego cambie el nombre de TMP F. <br><br>  Vamos a complicar la tarea.  Supongamos que tenemos un directorio D y necesitamos reemplazar su contenido.  La operaci√≥n de cambio de nombre no nos ayudar√°, ya que no puede reemplazar un directorio no vac√≠o.  Sin embargo, existe una soluci√≥n alternativa: puede reemplazar previamente el directorio D con un llamado enlace simb√≥lico (enlace simb√≥lico).  Entonces el contenido en s√≠ mismo estar√° en otro lugar, por ejemplo, en el directorio D_1, y D ser√° un enlace a D_1.  En el momento en que se requiere reemplazo, el nuevo contenido se escribe en el directorio D_2, en el que se crea un nuevo enlace TMP.  Ahora cambiar el nombre de TMP D funcionar√° porque esta operaci√≥n se puede aplicar a los enlaces. <br><br>  Esta soluci√≥n parece apropiada: puede cambiar todo el directorio con el c√≥digo, copiando archivos antiguos y escribiendo nuevos encima.  El problema es que copiar todo el c√≥digo es largo y costoso.  Solo puede reemplazar el subdirectorio donde cambiaron los archivos, pero luego todos los subdirectorios con el c√≥digo deben ser enlaces, porque no podemos reemplazar el directorio lleno con nada durante el proceso de dise√±o.  Esta soluci√≥n no solo parece muy complicada: debe recordar agregar algunas restricciones para que los dos procesos no puedan cambiar simult√°neamente el mismo directorio o directorio y sus subdirectorios. <br></div></div><br>  Como resultado, no pudimos encontrar una soluci√≥n t√©cnica, pero descubrimos c√≥mo simplificar un poco la vida: realizamos el dise√±o de varios archivos con una sola acci√≥n en la interfaz.  El desarrollador especific√≥ el dise√±o de los archivos y el sistema los entreg√≥. <br><br><h3>  M√∫ltiples parches por archivo </h3><br>  Es m√°s dif√≠cil si hay un archivo y hay varios desarrolladores que desean cambiarlo.  Aplicamos el primer parche, pero no lo descomponemos.  En este punto, llega el segundo parche y se le pide que se descomponga.  Que hacer  A√∫n m√°s interesante, si se aplica el segundo parche, y en este momento se nos pide que descompongamos el primero. <br><br>  Probablemente, necesitamos aclarar que siempre presentamos solo la √∫ltima versi√≥n del asistente.  De lo contrario, podr√≠an surgir otros problemas.  Por ejemplo, dise√±ando la versi√≥n anterior sobre la nueva. <br><br>  No encontramos una soluci√≥n realmente buena para este problema.  Les mostramos a los desarrolladores la diferencia entre lo que presentan y lo que hay en las m√°quinas en un momento dado, pero esto no siempre funcion√≥.  Por ejemplo, podr√≠a haber muchos cambios, y el desarrollador podr√≠a tener prisa o ser flojo (puede pasar cualquier cosa). <br><br><h3>  Muchos parches, y todos cambian los mismos archivos </h3><br>  Esta es la peor opci√≥n en la que ni siquiera quieres detenerte.  Si los cambios de varios desarrolladores afectaron a varios de los mismos archivos, nuestro sistema de parches no podr√≠a ayudar particularmente: segu√≠a dependiendo de la atenci√≥n de los desarrolladores y su capacidad para comunicarse entre s√≠.  Pero en teor√≠a, es bastante posible obtener "peces" cuando, en cualquier orden de dise√±o, en alg√∫n punto del servidor habr√° un c√≥digo parcialmente roto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n-/qn/fs/n-qnfsbv6myxc8d7oav-yhyitu4.png"></div><br>  Imagen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fuente</a> <br><br><h3>  Problemas de hierro </h3><br>  Otro problema surgi√≥ cuando, por alguna raz√≥n, uno de los servidores dej√≥ de estar disponible.  Ten√≠amos un mecanismo para excluir dichos servidores del dise√±o, que funcion√≥ bastante bien;  dificultades aparecieron despu√©s de su regreso al deber.  El hecho es que las versiones de las configuraciones y el c√≥digo en los servidores en funcionamiento se verifican con nosotros (¬°hay un departamento de monitoreo completo!), Y nos aseguramos de que todas las versiones est√©n actualizadas cuando el servidor vuelva a funcionar.  Pero no ten√≠amos ning√∫n control de versiones para parches, simplemente copiamos nuevos archivos al c√≥digo actual. <br><br>  No encontramos una forma precisa de versionar los parches descompuestos, pero tratamos de resolver el problema con soluciones alternativas.  Por ejemplo, rsync desde una m√°quina vecina al final del proceso de dise√±o.  Pero de alguna manera no pudimos verificar de alguna manera. <br><br>  Revisamos varias soluciones a este problema, por ejemplo, tambi√©n quer√≠amos aplicar parches en los servidores "principales" (es importante recordar que estamos implementando la versi√≥n empaquetada, es decir, necesitamos aplicar el parche y volver a empacar la versi√≥n), pero fue bastante dif√≠cil de implementar. <br><br><h2>  Una cucharada de miel </h2><br>  Pero, adem√°s de los problemas, hubo aspectos positivos. <br><br>  En primer lugar, los desarrolladores descubrieron r√°pidamente que, adem√°s de arreglar las cosas, con la ayuda del sistema de parches, a veces puedes cargar nuevas funciones, por ejemplo, cuando las necesitas con urgencia.  Como en cualquier empresa, tenemos fuerza mayor.  Pero si antes ten√≠amos que crear una construcci√≥n extraordinaria, en la que los probadores y los ingenieros de lanzamiento se distrajeron, ahora el desarrollador podr√≠a descomponer algunos cambios por su cuenta. <br><br>  En segundo lugar, ya no se necesitaba una persona especial con derechos para arreglar algo.  Cualquier desarrollador podr√≠a publicar sus ediciones.  Pero esto no es todo: las compilaciones en general se han vuelto m√°s f√°ciles, ahora los problemas se dividieron en cr√≠ticos y aquellos que se pueden solucionar con parches.  Esto hizo posible retroceder con menos frecuencia y tomar una decisi√≥n m√°s r√°pida sobre si tuvimos √©xito. <br><br>  En pocas palabras, nos gust√≥ el sistema y ganamos popularidad.  Continuamos tratando de mejorarlo, pero con los problemas descritos tuvimos que vivir unos a√±os m√°s.  Y c√≥mo lo decidimos, c√≥mo funciona el sistema ahora y c√≥mo casi matamos las vacaciones de A√±o Nuevo durante el proceso de actualizaci√≥n, lo dir√© en la segunda parte del art√≠culo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413503/">https://habr.com/ru/post/es413503/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413491/index.html">Food Design Digest, mayo de 2018</a></li>
<li><a href="../es413493/index.html">Infraestructura de clave p√∫blica (continuaci√≥n): Autoridad de certificaci√≥n basada en OpenSSL y SQLite3</a></li>
<li><a href="../es413495/index.html">Implementaci√≥n r√°pida o c√≥mo implementar front-end en 15 minutos</a></li>
<li><a href="../es413499/index.html">Apertura de un programa conjunto de maestr√≠a en JetBrains e ITMO</a></li>
<li><a href="../es413501/index.html">El a√±o pasado con React: conclusiones y recomendaciones</a></li>
<li><a href="../es413505/index.html">2 entradas gratis para In-Memory Computing Summit Europe</a></li>
<li><a href="../es413511/index.html">Elegir un esc√°ner 3D para la industria. Maxim Zhuravlev. Informe en Top 3D Expo 2018</a></li>
<li><a href="../es413513/index.html">Est√°ndares de comunicaci√≥n "olvidados": WiMAX, CDMA, ALOHAnet y otros</a></li>
<li><a href="../es413515/index.html">Doh en im√°genes</a></li>
<li><a href="../es413517/index.html">¬øCu√°l es la paradoja de la productividad de TI y c√≥mo la nube ayuda a resolverla?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>