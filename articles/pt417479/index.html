<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèº ‚òïÔ∏è üë©üèæ‚Äçüîß Concatena√ß√£o de string mais r√°pida do tipo fa√ßa voc√™ mesmo no Go üë©‚Äçüé§ ‚û°Ô∏è üëû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje vamos acelerar a liga√ß√£o de linhas curtas em Go em 30%. E, para isso, n√£o precisaremos modificar o Go, tudo isso ser√° implementado como uma bibli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Concatena√ß√£o de string mais r√°pida do tipo fa√ßa voc√™ mesmo no Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417479/"><p><img src="https://habrastorage.org/webt/36/bi/u0/36biu0kvugh_maxmmyhmuvqlrs8.png"></p><br><p>  Hoje vamos acelerar a liga√ß√£o de linhas curtas em Go em 30%.  E, para isso, n√£o precisaremos modificar o Go, tudo isso ser√° implementado como uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca de terceiros</a> . </p><br><p>  Abaixo do corte que voc√™ est√° esperando: </p><br><ul><li> Comparando as fun√ß√µes <code>+</code> , <code>strings.Builder</code> e concatena√ß√£o nativa </li><li>  Ir para detalhes da linha interna </li><li>  Bastante montador </li></ul><br><p>  Este artigo tamb√©m pode ser considerado uma desculpa para discutir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CL123256: tempo de execu√ß√£o, cmd / compile: specialize concatstring2</a> .  Id√©ias para melhorar essa lista de altera√ß√µes s√£o bem-vindas. </p><a name="habracut"></a><br><h1 id="srazu-rezultaty">  Resultados Imediatamente </h1><br><p>  A compara√ß√£o foi feita com a vers√£o <code>go tip</code> (master) do compilador.  Voc√™ pode obter resultados semelhantes nas vers√µes do Go 1.5.  A √∫ltima altera√ß√£o significativa na fun√ß√£o <code>concatstrings</code> foi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CL3120: cmd / gc: aloque buffers para seq√º√™ncias de caracteres n√£o escapadas na pilha</a> . </p><br><pre> <code class="hljs powershell">BenchmarkConcat2Operator<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20000000</span></span> <span class="hljs-number"><span class="hljs-number">83.8</span></span> ns/op BenchmarkConcat2Builder<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20000000</span></span> <span class="hljs-number"><span class="hljs-number">70.9</span></span> ns/op BenchmarkConcat2<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20000000</span></span> <span class="hljs-number"><span class="hljs-number">62.1</span></span> ns/op BenchmarkConcat3Operator<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20000000</span></span> <span class="hljs-number"><span class="hljs-number">104</span></span> ns/op BenchmarkConcat3Builder<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20000000</span></span> <span class="hljs-number"><span class="hljs-number">89.9</span></span> ns/op BenchmarkConcat3<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20000000</span></span> <span class="hljs-number"><span class="hljs-number">82.1</span></span> ns/op</code> </pre> <br><p>  <code>ConcatOperator</code> usa <code>+</code> . <br>  <code>ConcatBuilder</code> usa <code>strings.Builder</code> com a pr√©-aloca√ß√£o correta. <br>  <code>Concat</code> usa a fun√ß√£o que implementamos como parte desta hist√≥ria. </p><br><p>  Compara√ß√£o via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">benchstat</a> : </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>/op <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>/op delta Concat2<span class="hljs-number"><span class="hljs-number">-8</span></span> <span class="hljs-number"><span class="hljs-number">84.2</span></span>ns ¬± <span class="hljs-number"><span class="hljs-number">1</span></span>% <span class="hljs-number"><span class="hljs-number">62.7</span></span>ns ¬± <span class="hljs-number"><span class="hljs-number">2</span></span>% <span class="hljs-number"><span class="hljs-number">-25.49</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) Concat3<span class="hljs-number"><span class="hljs-number">-8</span></span> <span class="hljs-number"><span class="hljs-number">103</span></span>ns ¬± <span class="hljs-number"><span class="hljs-number">3</span></span>% <span class="hljs-number"><span class="hljs-number">83</span></span>ns ¬± <span class="hljs-number"><span class="hljs-number">4</span></span>% <span class="hljs-number"><span class="hljs-number">-19.83</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">9</span></span>)</code> </pre> <br><p>  A implementa√ß√£o do assembler em <code>GOARCH=AMD64</code> um pouco mais r√°pida e possui otimiza√ß√£o adicional, que est√° presente no operador <code>+</code> incorporado, mas mais sobre isso abaixo: </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>/op <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>/op delta Concat2<span class="hljs-number"><span class="hljs-number">-8</span></span> <span class="hljs-number"><span class="hljs-number">84.2</span></span>ns ¬± <span class="hljs-number"><span class="hljs-number">1</span></span>% <span class="hljs-number"><span class="hljs-number">57.1</span></span>ns ¬± <span class="hljs-number"><span class="hljs-number">3</span></span>% <span class="hljs-number"><span class="hljs-number">-32.20</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">9</span></span>)</code> </pre> <br><p>  Assumiremos a fun√ß√£o assembler como 100% de desempenho (em rela√ß√£o ao restante das implementa√ß√µes consideradas). </p><br><blockquote>  Os resultados para linhas mais longas podem ser vistos em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">README.md</a> .  Quanto maior a string, menos pronunciada √© a diferen√ßa entre implementa√ß√µes. </blockquote><br><h1 id="naivnaya-konkatenaciya">  Concatena√ß√£o ing√™nua </h1><br><p>  A solu√ß√£o mais f√°cil √© usar o operador <code>+</code> . </p><br><p>  A sem√¢ntica desta instru√ß√£o √© a seguinte: pegue duas linhas e retorne uma sequ√™ncia de resultados que contenha a concatena√ß√£o de ambas as linhas.  N√£o h√° garantia de que uma nova linha ser√° retornada.  Por exemplo, se houver uma concatena√ß√£o de uma cadeia vazia e de qualquer outra, o tempo de execu√ß√£o poder√° retornar um argumento n√£o vazio, evitando a necessidade de alocar nova mem√≥ria e copiar dados nela. </p><br><p>  Mas, como pode ser visto nos resultados no in√≠cio do artigo, esse √© o caminho mais lento. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concat2operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, y </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x + y }</code> </pre> <br><blockquote>  Avalia√ß√£o de desempenho: <strong>67,8%</strong> . </blockquote><br><h1 id="stringsbuilder">  strings.Builder </h1><br><p>  N√£o faz muito tempo, um novo tipo foi adicionado ao Go - <a href="">strings.Builder</a> .  Este √© um an√°logo de <code>bytes.Buffer</code> , mas ao chamar o m√©todo <code>String()</code> , a mem√≥ria n√£o √© realocada e os dados n√£o s√£o copiados. </p><br><p>  Diferentemente de <code>bytes.Buffer</code> , o construtor n√£o possui otimiza√ß√£o de um <a href="">buffer pequeno</a> e, portanto, alocou mem√≥ria anteriormente para uma sequ√™ncia.  Se voc√™ n√£o usar o m√©todo <code>Grow</code> , o desempenho ser√° pior do que com <code>bytes.Buffer</code> .  V√°rias regress√µes no Go 1.11 s√£o causadas por esse recurso espec√≠fico (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CL113235</a> ). </p><br><p>  Em nosso c√≥digo, pela pureza do experimento, evitaremos esse erro. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concat2builder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, y </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder strings.Builder builder.Grow(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(x) + <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(y)) <span class="hljs-comment"><span class="hljs-comment">//      builder.WriteString(x) builder.WriteString(y) return builder.String() }</span></span></code> </pre> <br><blockquote>  Avalia√ß√£o de desempenho: <strong>80,5%</strong> (+12,7). </blockquote><br><h1 id="kodogeneraciya-dlya-konkatenacii">  Gera√ß√£o de c√≥digo para concatena√ß√£o </h1><br><p>  Se voc√™ olhar para qual c√≥digo o compilador gera para o operador <code>+</code> , veremos as chamadas para as <code>concatstring3</code> , <code>concatstring3</code> e assim por diante (at√© <code>concatstring5</code> inclusive). </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concat2codegen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, y)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x + y } <span class="hljs-comment"><span class="hljs-comment">// =&gt; CALL runtime.concatstring2(SB) func concat3codegen(x, y, z) string { return x + y + z } // =&gt; CALL runtime.concatstring3(SB)</span></span></code> </pre> <br><p>  <a href="">D√™ uma</a> olhada no pr√≥prio <a href="">runtime / string.go</a> : </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concatstring2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(buf *tmpBuf, a [2]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> concatstrings(buf, a[:]) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concatstring3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(buf *tmpBuf, a [3]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> concatstrings(buf, a[:]) }</code> </pre> <br><p>  Portanto, resta aprender as fun√ß√µes <code>concatstrings</code> . <br>  Uma lista completa est√° dispon√≠vel abaixo do spoiler, mas aqui est√° uma descri√ß√£o de alto n√≠vel: </p><br><ol><li>  O par√¢metro <code>buf</code> pode ser <code>nil</code> .  Esse buffer √© alocado pelo compilador se a linha n√£o "escapar" de sua defini√ß√£o.  Se a string viver mais do que o quadro, esse buffer ser√° sempre <code>nil</code> (como acontece com mais freq√º√™ncia).  No entanto, se esse buffer estiver dispon√≠vel, ser√° poss√≠vel evitar a aloca√ß√£o caso o resultado seja invadido (seu tamanho √© 32 bytes). </li><li>  Se todas as linhas, exceto uma, estiverem vazias, a fun√ß√£o retornar√° essa linha.  Mas, ao mesmo tempo, as linhas selecionadas na pilha e deixando seu quadro ignoram essa otimiza√ß√£o para que o chamador n√£o receba mem√≥ria j√° liberada. </li><li>  Al√©m disso, todas as linhas s√£o copiadas para a nova mem√≥ria. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Lista completa da fun√ß√£o concatstrings</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// concatstrings implements a Go string concatenation x+y+z+... // The operands are passed in the slice a. // If buf != nil, the compiler has determined that the result does not // escape the calling function, so the string data can be stored in buf // if small enough. func concatstrings(buf *tmpBuf, a []string) string { idx := 0 l := 0 count := 0 for i, x := range a { n := len(x) if n == 0 { continue } if l+n &lt; l { throw("string concatenation too long") } l += n count++ idx = i } if count == 0 { return "" } // If there is just one string and either it is not on the stack // or our result does not escape the calling frame (buf != nil), // then we can return that string directly. if count == 1 &amp;&amp; (buf != nil || !stringDataOnStack(a[idx])) { return a[idx] } s, b := rawstringtmp(buf, l) for _, x := range a { copy(b, x) b = b[len(x):] } return s }</span></span></code> </pre> </div></div><br><p>  Aqui vemos v√°rios lugares ao mesmo tempo que podem ser otimizados para um caso espec√≠fico: </p><br><ul><li>  <code>buf</code> geralmente est√° vazio.  Quando o compilador n√£o p√¥de provar que a string √© segura para colocar na pilha, passar um par√¢metro extra e verificar se h√° <code>nil</code> dentro da fun√ß√£o gera apenas sobrecarga. </li><li>  Para o caso especial com <code>len(a) == 2</code> n√£o precisamos de um ciclo e os c√°lculos podem ser simplificados.  E esta √© a forma mais comum de concatena√ß√£o. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Estat√≠sticas de concatena√ß√£o</b> <div class="spoiler_text"><p>  Ao executar <code>./make.bash</code> ( <code>./make.bash</code> compilador Go e stdlib), vemos 445 concatena√ß√µes com dois operandos: </p><br><ul><li>  398 resultados est√£o fugindo.  Nesse caso, nossa especializa√ß√£o faz sentido. </li><li>  47 resultados n√£o saem do seu quadro. </li></ul><br><p>  No total, <strong>89% das</strong> concatena√ß√µes de dois argumentos obt√™m otimiza√ß√£o do suor. </p><br><p>  Para o utilit√°rio <code>go</code> , temos: </p><br><ul><li>  501 chamadas concatstring2 </li><li>  194 chamadas concatstring3 </li><li>  55 chamadas concatstring4 </li></ul></div></div><br><h1 id="versiya-dlya-vseh-arhitektur">  Vers√£o para todas as arquiteturas </h1><br><p>  Para implementar a especializa√ß√£o, precisamos saber como as linhas s√£o representadas no Go.  A compatibilidade bin√°ria √© importante para n√≥s, enquanto <code>unsafe.Pointer</code> . O <code>unsafe.Pointer</code> pode ser substitu√≠do por <code>*byte</code> sem sacrif√≠cios. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> stringStruct <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { str *<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> }</code> </pre> <br><p>  A segunda conclus√£o importante que podemos tirar do tempo de execu√ß√£o: as linhas come√ßam sua vida mut√°vel.  √â alocada uma parte da mem√≥ria que √© referenciada por <code>[]byte</code> , na qual o conte√∫do da nova linha √© gravada e somente depois que o <code>[]byte</code> descartado, e a mem√≥ria √† qual ela se refere √© armazenada em <code>stringStruct</code> . </p><br><p>  Para quem deseja obter mais detalhes, sugere-se estudar as fun√ß√µes de <code>rawstringtmp</code> e <code>rawstring</code> . </p><br><div class="spoiler">  <b class="spoiler_title">runtime.rawstring</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// rawstring allocates storage for a new string. The returned // string and byte slice both refer to the same storage. // The storage is not zeroed. Callers should use // b to set the string contents and then drop b. func rawstring(size int) (s string, b []byte) { p := mallocgc(uintptr(size), nil, false) stringStructOf(&amp;s).str = p stringStructOf(&amp;s).len = size *(*slice)(unsafe.Pointer(&amp;b)) = slice{p, size, size} return }</span></span></code> </pre> </div></div><br><p>  Podemos iniciar o mesmo, usando o lado escuro do pacote <code>unsafe</code> : </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concat2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x, y </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { length := <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(x) + <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(y) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> length == <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> } b := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, length) <span class="hljs-built_in"><span class="hljs-built_in">copy</span></span>(b, x) <span class="hljs-built_in"><span class="hljs-built_in">copy</span></span>(b[<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(x):], y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> goString(&amp;b[<span class="hljs-number"><span class="hljs-number">0</span></span>], length) }</code> </pre> <br><p>  Destacamos <code>[]byte</code> , que usamos para formar o conte√∫do de uma nova linha.  S√≥ podemos finalizar a linha trazendo-a para a representa√ß√£o de tempo de execu√ß√£o esperada.  A fun√ß√£o <code>goString</code> √© respons√°vel por isso: </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ptr *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, length </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { s := stringStruct{str: ptr, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>: length} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *(*<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)(unsafe.Pointer(&amp;s)) }</code> </pre> <br><blockquote>  Avalia√ß√£o de desempenho: <strong>91.9%</strong> (+10.9). </blockquote><br><h1 id="versiya-dlya-amd64">  Vers√£o AMD64 </h1><br><p>  Infelizmente, a vers√£o anterior da fun√ß√£o n√£o possui otimiza√ß√£o para concatena√ß√£o com uma string vazia, e tamb√©m realizamos v√°rios c√°lculos desnecess√°rios devido √† incapacidade de alocar mem√≥ria diretamente, precisamos trabalhar com a fatia de bytes. </p><br><p>  Um dos recursos interessantes do montador Go √© que ele permite chamar, por exemplo, fun√ß√µes de tempo de execu√ß√£o n√£o export√°veis.  Podemos chamar o <code>runtime¬∑mallocgc</code> partir do c√≥digo do assembly, mesmo que n√£o fa√ßa parte do pacote de <code>runtime</code> de <code>runtime</code> .  Usaremos essa propriedade. </p><br><p>  Tamb√©m podemos verificar a propriedade das linhas de mem√≥ria da pilha, o que torna seguro otimizar o retorno de um dos argumentos como resultado. </p><br><p>  Suponha que uma fun√ß√£o seja chamada com argumentos <code>concat2("", "123")</code> .  <code>x</code> √© uma string vazia e, se <code>y</code> n√£o <code>y</code> alocado na pilha, podemos devolv√™-la como resultado da concatena√ß√£o. </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/; ,  x  y   stringStruct. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/; CX - y.str. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/; SI - y.len. maybe_return_y: /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/;      . MOVQ (TLS), AX /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/; *g CMPQ CX, (AX) JL return_y /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/;  y_str &lt; g.stack.lo CMPQ CX, 8(AX) JGE return_y /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/;  y_str &gt;= g.stack.hi JMP concatenate /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/; y  ,    return_y: MOVQ CX, ret+32(FP) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/; stringStruct.len MOVQ SI, ret+40(FP) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/; stringStruct.str RET</span></span></code> </pre> <br><p>  <code>MOVQ (TLS), AX</code> mover√° <a href="">* g</a> para o registro do <code>AX</code> .  A leitura no deslocamento zero dar√° o campo <code>g.stack.lo</code> e <code>g.stack.hi</code> come√ßa com o 8¬∫ byte (para uma plataforma de 64 bits). </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> g <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { stack <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { lo <span class="hljs-keyword"><span class="hljs-keyword">uintptr</span></span> <span class="hljs-comment"><span class="hljs-comment">// 0(AX) hi uintptr // 8(AX) } stackguard0 uintptr // 16(AX) stackguard1 uintptr // 24(AX) // ...   }</span></span></code> </pre> <br><p>  O corpo <code>concatenate</code> aloca mem√≥ria, preenche-a com as duas linhas e retorna uma nova linha. </p><br><div class="spoiler">  <b class="spoiler_title">Lista completa com coment√°rios</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"textflag.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"funcdata.h"</span></span> <span class="hljs-type"><span class="hljs-type">TEXT</span></span> ¬∑<span class="hljs-type"><span class="hljs-type">Strings</span></span>(<span class="hljs-type"><span class="hljs-type">SB</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">$4</span></span>8<span class="hljs-number"><span class="hljs-number">-48</span></span> <span class="hljs-type"><span class="hljs-type">NO_LOCAL_POINTERS</span></span> //    . <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> x+<span class="hljs-number"><span class="hljs-number">0</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">DX</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> x+<span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">DI</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> y+<span class="hljs-number"><span class="hljs-number">16</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">CX</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> y+<span class="hljs-number"><span class="hljs-number">24</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">SI</span></span> <span class="hljs-type"><span class="hljs-type">TESTQ</span></span> <span class="hljs-type"><span class="hljs-type">DI</span></span>, <span class="hljs-type"><span class="hljs-type">DI</span></span> <span class="hljs-type"><span class="hljs-type">JZ</span></span> maybe_return_y // x -  ,   y <span class="hljs-type"><span class="hljs-type">TESTQ</span></span> <span class="hljs-type"><span class="hljs-type">SI</span></span>, <span class="hljs-type"><span class="hljs-type">SI</span></span> <span class="hljs-type"><span class="hljs-type">JZ</span></span> maybe_return_x // y -  ,   x concatenate: <span class="hljs-type"><span class="hljs-type">LEAQ</span></span> (<span class="hljs-type"><span class="hljs-type">DI</span></span>)(<span class="hljs-type"><span class="hljs-type">SI</span></span>*<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-type"><span class="hljs-type">R8</span></span> // len(x) + len(y) //     . <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">R8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVB</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">CALL</span></span> runtime¬∑mallocgc(<span class="hljs-type"><span class="hljs-type">SB</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>), <span class="hljs-type"><span class="hljs-type">AX</span></span> //     <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">AX</span></span>, newstr<span class="hljs-number"><span class="hljs-number">-8</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) //  x. <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> x+<span class="hljs-number"><span class="hljs-number">0</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">DX</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> x+<span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">DI</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">AX</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">DX</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">DI</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">CALL</span></span> runtime¬∑memmove(<span class="hljs-type"><span class="hljs-type">SB</span></span>) //  y   len(x). <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> x+<span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">DI</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> y+<span class="hljs-number"><span class="hljs-number">16</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">CX</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> y+<span class="hljs-number"><span class="hljs-number">24</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">SI</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> newstr<span class="hljs-number"><span class="hljs-number">-8</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>), <span class="hljs-type"><span class="hljs-type">AX</span></span> <span class="hljs-type"><span class="hljs-type">LEAQ</span></span> (<span class="hljs-type"><span class="hljs-type">AX</span></span>)(<span class="hljs-type"><span class="hljs-type">DI</span></span>*<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-type"><span class="hljs-type">BX</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">BX</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">CX</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">SI</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>) <span class="hljs-type"><span class="hljs-type">CALL</span></span> runtime¬∑memmove(<span class="hljs-type"><span class="hljs-type">SB</span></span>) //   . <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> newstr<span class="hljs-number"><span class="hljs-number">-8</span></span>(<span class="hljs-type"><span class="hljs-type">SP</span></span>), <span class="hljs-type"><span class="hljs-type">AX</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> x+<span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">R8</span></span> <span class="hljs-type"><span class="hljs-type">ADDQ</span></span> y+<span class="hljs-number"><span class="hljs-number">24</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>), <span class="hljs-type"><span class="hljs-type">R8</span></span> <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">AX</span></span>, ret+<span class="hljs-number"><span class="hljs-number">32</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">R8</span></span>, ret+<span class="hljs-number"><span class="hljs-number">40</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>) <span class="hljs-type"><span class="hljs-type">RET</span></span> maybe_return_y: //      . <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> (<span class="hljs-type"><span class="hljs-type">TLS</span></span>), <span class="hljs-type"><span class="hljs-type">AX</span></span> // *g <span class="hljs-type"><span class="hljs-type">CMPQ</span></span> <span class="hljs-type"><span class="hljs-type">CX</span></span>, (<span class="hljs-type"><span class="hljs-type">AX</span></span>) <span class="hljs-type"><span class="hljs-type">JL</span></span> return_y //  y_ptr &lt; stk.lo <span class="hljs-type"><span class="hljs-type">CMPQ</span></span> <span class="hljs-type"><span class="hljs-type">CX</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">AX</span></span>) <span class="hljs-type"><span class="hljs-type">JGE</span></span> return_y //  y_ptr &gt;= stk.hi <span class="hljs-type"><span class="hljs-type">JMP</span></span> concatenate // y  ,    return_y: <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">CX</span></span>, ret+<span class="hljs-number"><span class="hljs-number">32</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">SI</span></span>, ret+<span class="hljs-number"><span class="hljs-number">40</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>) <span class="hljs-type"><span class="hljs-type">RET</span></span> maybe_return_x: //      . <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> (<span class="hljs-type"><span class="hljs-type">TLS</span></span>), <span class="hljs-type"><span class="hljs-type">AX</span></span> // *g <span class="hljs-type"><span class="hljs-type">CMPQ</span></span> <span class="hljs-type"><span class="hljs-type">DX</span></span>, (<span class="hljs-type"><span class="hljs-type">AX</span></span>) <span class="hljs-type"><span class="hljs-type">JL</span></span> return_x //  x_ptr &lt; stk.lo <span class="hljs-type"><span class="hljs-type">CMPQ</span></span> <span class="hljs-type"><span class="hljs-type">DX</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>(<span class="hljs-type"><span class="hljs-type">AX</span></span>) <span class="hljs-type"><span class="hljs-type">JGE</span></span> return_x //  x_ptr &gt;= stk.hi <span class="hljs-type"><span class="hljs-type">JMP</span></span> concatenate // x  ,    return_x: <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">DX</span></span>, ret+<span class="hljs-number"><span class="hljs-number">32</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>) <span class="hljs-type"><span class="hljs-type">MOVQ</span></span> <span class="hljs-type"><span class="hljs-type">DI</span></span>, ret+<span class="hljs-number"><span class="hljs-number">40</span></span>(<span class="hljs-type"><span class="hljs-type">FP</span></span>) <span class="hljs-type"><span class="hljs-type">RET</span></span></code> </pre> <br><p>  Se voc√™ estiver interessado na natureza de <code>NO_LOCAL_POINTERS</code> neste c√≥digo, poder√° ler <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a fun√ß√£o Calling a Go de asm ("erro fatal: falta de mapa de pilha")</a> . </p></div></div><br><blockquote>  Avalia√ß√£o de desempenho: <strong>100%</strong> (+8,6). </blockquote><br><h1 id="v-kachestve-zaklyucheniya">  Em conclus√£o </h1><br><p>  Todo o c√≥digo √© fornecido como um pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">concat</a> . </p><br><p>  O mundo est√° pronto para uma concatena√ß√£o t√£o r√°pida?  Quem sabe </p><br><p>  No in√≠cio do artigo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CL123256</a> foi mencionado.  Ele tem v√°rios caminhos de desenvolvimento: </p><br><ol><li>  Especializa√ß√£o variacional para o caso em que o compilador n√£o aloca um buffer tempor√°rio.  H√° menos crescimento para cada caso, mas abrange mais tipos de concatena√ß√£o e praticamente n√£o aumenta o tamanho do c√≥digo (m√°quina e c√≥digo Go). </li><li>  Mais especializa√ß√µes para casos especiais.  Ganhos mais altos, mas mais c√≥digo de m√°quina, podem prejudicar o cache de instru√ß√µes. </li><li>  Toneladas de c√≥digo de m√°quina, para cada caso especial e memorando especializado, da maneira como isso √© feito na glibc.  Aqui surgem principalmente quest√µes de conveni√™ncia. </li></ol><br><p>  A atual op√ß√£o proposta acelera apenas o caso mais comum e mais simples de concatena√ß√£o de um par de strings (arity = 2). </p><br><p>  Se o Go n√£o aceitar essa altera√ß√£o, poder√° obter uma acelera√ß√£o compar√°vel implementando opera√ß√µes de cadeia de caracteres na forma de uma biblioteca de terceiros.  Menos conveniente, bonito e elegante, mas funciona. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt417479/">https://habr.com/ru/post/pt417479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../In146151/index.html">‡§è‡§ú‡§æ‡§á‡§≤ ‡§°‡§æ‡§á‡§µ ‡§°‡•á‡§™‡•ç‡§•: ‡§è‡§ú‡§æ‡§á‡§≤ ‡§á‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç‡§è‡§∂‡§® ‡§´‡•ç‡§∞‡•á‡§Æ‡§µ‡§∞‡•ç‡§ï</a></li>
<li><a href="../In146152/index.html">‡§ü‡•à‡§≤‡•á‡§Ç‡§ü ‡§Æ‡•à‡§™ ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ‡•á ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ - ‡§∞‡§ø‡§≤‡•Ä‡§ú‡§º ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§∞‡§æ‡§∏‡•ç‡§§‡•á ‡§™‡§∞ ‡§è‡§°‡§µ‡•á‡§Ç‡§ö‡§∞‡•ç‡§∏</a></li>
<li><a href="../pt417473/index.html">Armazenamento confi√°vel com DRBD9 e Proxmox (parte 1: NFS)</a></li>
<li><a href="../pt417475/index.html">Codifica√ß√£o Glusterfs + apagamento: quando voc√™ precisar de muito, barato e confi√°vel</a></li>
<li><a href="../pt417477/index.html">Secret√°ria quente</a></li>
<li><a href="../pt417481/index.html">Sobre geradores no JavaScript ES6 e por que √© opcional estud√°-los</a></li>
<li><a href="../pt417483/index.html">Compara√ß√£o de estruturas JS: React, Vue e Hyperapp</a></li>
<li><a href="../pt417485/index.html">[marcador] Folha de dicas do administrador do sistema para ferramentas de rede Linux</a></li>
<li><a href="../pt417487/index.html">O lugar onde a Internet russa come√ßou</a></li>
<li><a href="../pt417489/index.html">Relat√≥rio do Clube de Roma de 2018, cap√≠tulo 3.4: ‚ÄúEnergia descentralizada‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>