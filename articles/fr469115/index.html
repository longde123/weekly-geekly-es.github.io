<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèä üßóüèª ü§Ø Guide Discovery.js: D√©marrage rapide üë®üèø‚Äçüöí üÜò üóúÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ce guide et les guides suivants vous guideront tout au long du processus de cr√©ation d'une solution bas√©e sur le projet Discovery.js . Notre objectif ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Guide Discovery.js: D√©marrage rapide</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/469115/"><p> Ce guide et les guides suivants vous guideront tout au long du processus de cr√©ation d'une solution bas√©e sur le projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Discovery.js</a> .  Notre objectif est de cr√©er un inspecteur pour les d√©pendances NPM, c'est-√†-dire une interface pour examiner la structure de <code>node_modules</code> . </p><br><p><img src="https://habrastorage.org/webt/ih/d_/sc/ihd_schofzsmx1xbptuvltrxmu8.png"></p><br><blockquote>  Remarque: Discovery.js est √† un stade pr√©coce de d√©veloppement, donc au fil du temps, quelque chose se simplifiera et deviendra plus utile.  Si vous avez des id√©es pour am√©liorer quelque chose, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crivez-nous</a> . </blockquote><br><h2 id="annotaciya">  Annotation </h2><br><p>  Vous trouverez ci-dessous un aper√ßu des concepts cl√©s de Discovery.js.  Vous pouvez apprendre l'int√©gralit√© du code manuel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans le r√©f√©rentiel sur GitHub</a> , ou vous pouvez essayer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comment cela fonctionne en ligne</a> . </p><a name="habracut"></a><br><h2 id="nachalnye-usloviya">  Conditions initiales </h2><br><p>  Tout d'abord, nous devons choisir un projet √† analyser.  Il peut s'agir d'un projet fra√Æchement cr√©√© ou d'un projet existant, l'essentiel est qu'il contient <code>node_modules</code> (l'objet de notre analyse). </p><br><p>  Tout d'abord, installez le package core <code>discoveryjs</code> et ses outils de console: </p><br><pre> <code class="bash hljs">npm install @discoveryjs/discovery @discoveryjs/cli</code> </pre> <br><p>  Ensuite, lancez le serveur Discovery.js: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery No config is used Models are not defined (model free mode is enabled) Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Si vous ouvrez <code>http://localhost:8123</code> dans le navigateur, vous pouvez voir ce qui suit: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4e6/fc9/228/4e6fc922872955e6a2f3355e2856b3d1.png" alt="Decouverte sans configuration"></p><br><p>  Il s'agit d'un mode sans mod√®le, c'est-√†-dire un mode lorsque rien n'est configur√©.  Mais maintenant, en utilisant le bouton "Charger les donn√©es", vous pouvez s√©lectionner n'importe quel fichier JSON, ou simplement le faire glisser sur la page et d√©marrer l'analyse. </p><br><p>  Cependant, nous avons besoin de quelque chose de sp√©cifique.  En particulier, nous devons avoir une id√©e de la structure <code>node_modules</code> .  Pour ce faire, ajoutez la configuration. </p><br><h2 id="dobavlyaem-konfiguraciyu">  Ajouter une configuration </h2><br><p>  Comme vous l'avez peut-√™tre remarqu√©, le message <code>No config is used</code> s'affichait au d√©marrage du serveur.  Cr√©ons un fichier de configuration <code>.discoveryrc.js</code> avec le contenu suivant: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, data() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span> }; } };</code> </pre> <br><p>  Remarque: si vous cr√©ez un fichier dans le r√©pertoire de travail actuel (c'est-√†-dire √† la racine du projet), rien d'autre n'est requis.  Sinon, vous devez transmettre le chemin d'acc√®s au fichier de configuration √† l'aide de l'option <code>--config</code> ou d√©finir le chemin d'acc√®s dans <code>package.json</code> : </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"discovery"</span></span>: <span class="hljs-string"><span class="hljs-string">"path/to/discovery/config.js"</span></span>, ... }</code> </pre> <br><p>  Red√©marrez le serveur pour que la configuration soit appliqu√©e: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery Load config from .discoveryrc.js Init single model default Define default routes ... OK Cache: DISABLED Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Comme vous pouvez le voir, maintenant le fichier que nous avons cr√©√© est utilis√©.  Et le mod√®le par d√©faut que nous d√©crivons est appliqu√© (la d√©couverte peut fonctionner dans le mode de nombreux mod√®les, nous parlerons de cette fonctionnalit√© dans les manuels suivants).  Voyons ce qui a chang√© dans le navigateur: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/16f/f45/ac8/16ff45ac8eef467b6ccd0ff5624c9652.png" alt="Avec configuration de base"></p><br><p>  Que peut-on voir ici: </p><br><ul><li>  <code>name</code> utilis√© comme titre de page; </li><li>  le r√©sultat de l'appel de la m√©thode de <code>data</code> est affich√© comme contenu principal de la page. </li></ul><br><blockquote>  Remarque: la m√©thode de <code>data</code> doit renvoyer des donn√©es ou Promise, qui se r√©sout en donn√©es. </blockquote><p>  Les param√®tres de base sont d√©finis, vous pouvez continuer. </p><br><h2 id="kontekst">  Contexte </h2><br><p>  Regardons la page du rapport personnalis√© (cliquez sur <code>Make report</code> ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/def/52b/57a/def52b57a6be174730f07fe55273517a.png" alt="Page de rapport"></p><br><p>  √Ä premi√®re vue, ce n'est pas tr√®s diff√©rent de la page d'accueil ... Mais ici, vous pouvez tout changer!  Par exemple, nous pouvons facilement recr√©er l'apparence de la page de d√©marrage: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/919/de1/c6c919de17d2fed5bdb0501fe1ff9dae.png" alt="Recr√©er la page de d√©marrage"></p><br><p>  Remarquez comment l'en-t√™te est d√©fini: <code>"h1:#.name"</code> .  Il s'agit de l'en-t√™te de premier niveau avec le contenu de <code>#.name</code> , qui est une demande <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jora</a> .  <code>#</code> Fait r√©f√©rence au contexte de la demande.  Pour afficher son contenu, entrez simplement <code>#</code> dans l'√©diteur de requ√™te et utilisez l'affichage par d√©faut: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/524/7a6/2cc/5247a62cc6194ab9bd4797c21ab084b9.png" alt="Valeurs de contexte"></p><br><p>  Vous savez maintenant comment obtenir l'ID de la page actuelle, ses param√®tres et d'autres valeurs utiles. </p><br><h2 id="sbor-dannyh">  Collecte de donn√©es </h2><br><p>  Maintenant, nous utilisons un stub dans le projet au lieu de vraies donn√©es, mais nous avons besoin de vraies donn√©es.  Pour ce faire, cr√©ez un module et modifiez la valeur des <code>data</code> dans la configuration (au fait, apr√®s ces modifications, il n'est pas n√©cessaire de red√©marrer le serveur): </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>) };</code> </pre> <br><p>  Le contenu de <code>collect-node-modules-data.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> scanFs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/scan-fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packages = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scanFs({ <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [<span class="hljs-string"><span class="hljs-string">'node_modules'</span></span>], <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\/package.json$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">extract</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, content</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pkg = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(content); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pkg.name &amp;&amp; pkg.version) { packages.push({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: pkg.name, <span class="hljs-attr"><span class="hljs-attr">version</span></span>: pkg.version, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: path.dirname(file.filename), <span class="hljs-attr"><span class="hljs-attr">dependencies</span></span>: pkg.dependencies }); } } }] }).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> packages); };</code> </pre> <br><p>  J'ai utilis√© le package <code>@discoveryjs/scan-fs</code> , qui simplifie l'analyse du syst√®me de fichiers.  Un exemple d'utilisation du package est d√©crit dans son fichier Lisezmoi, j'ai pris cet exemple comme base et finalis√© au besoin.  Nous avons maintenant quelques informations sur le contenu de <code>node_modules</code> : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d0c/f24/64c/d0cf2464cadda8a8bc0433871200ae9b.png" alt="Donn√©es collect√©es"></p><br><p>  Ce dont vous avez besoin!  Et malgr√© le fait qu'il s'agit d'un JSON ordinaire, nous pouvons d√©j√† l'analyser et tirer des conclusions.  Par exemple, en utilisant la fen√™tre contextuelle de la structure de donn√©es, vous pouvez conna√Ætre le nombre de paquets et savoir combien d'entre eux ont plus d'une instance physique (en raison de la diff√©rence de versions ou de probl√®mes de d√©duplication). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8f3/93e/5e0/8f393e5e05a1385aa11aad92d8ad15a0.png" alt="Recherche sur la structure des donn√©es"></p><br><p>  Malgr√© le fait que nous ayons d√©j√† quelques donn√©es, nous avons besoin de plus de d√©tails.  Par exemple, il serait int√©ressant de savoir quelle instance physique r√©sout chacune des d√©pendances d√©clar√©es d'un module particulier.  Cependant, les travaux sur l'am√©lioration de l'extraction des donn√©es d√©passent le cadre de ce guide.  Par cons√©quent, nous allons le remplacer par le package <code>@discoveryjs/node-modules</code> (qui est √©galement bas√© sur <code>@discoveryjs/scan-fs</code> ) pour r√©cup√©rer les donn√©es et obtenir les d√©tails n√©cessaires sur les packages.  En cons√©quence, <code>collect-node-modules-data.js</code> grandement simplifi√©: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fetchNodeModules = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/node-modules'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fetchNodeModules(); };</code> </pre> <br><p>  Maintenant, les informations sur <code>node_modules</code> ressemblent √† ceci: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1f5/1c2/187/1f51c2187d527694cbf71089e8d74ba8.png" alt="Nouvelle structure de donn√©es"></p><br><h2 id="skript-podgotovki">  Script de pr√©paration </h2><br><p>  Comme vous pouvez le voir, quelques - uns des objets d√©crivant les paquets contiennent <code>deps</code> - la liste des d√©pendances.  Chaque d√©pendance a un champ <code>resolved</code> dont la valeur est une r√©f√©rence √† une instance physique du package.  Un tel lien est la valeur de <code>path</code> de l'un des packages, il est unique.  Pour r√©soudre le lien vers le package, vous devez utiliser du code suppl√©mentaire (par exemple, <code>#.data.pick(&lt;path=resolved&gt;)</code> ).  Et bien s√ªr, il serait beaucoup plus pratique que ces liens soient d√©j√† r√©solus en r√©f√©rences d'objets. </p><br><p>  Malheureusement, au stade de la collecte des donn√©es, nous ne pouvons pas r√©soudre les liens, car cela conduira √† des connexions circulaires, ce qui cr√©era le probl√®me de transfert de ces donn√©es sous forme de JSON.  Cependant, il existe une solution: il s'agit d'un script de <code>prepare</code> sp√©cial.  Il est d√©fini dans la configuration et appel√© chaque fois qu'une nouvelle donn√©e est affect√©e √† l'instance Discovery.  Commen√ßons par la configuration: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... prepare: __dirname + <span class="hljs-string"><span class="hljs-string">'/prepare.js'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// :   ,    ... };</span></span></code> </pre> <br><p>  D√©finissez <code>prepare.js</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -  data /   discovery });</span></span></code> </pre> <br><p>  Dans ce module, nous avons d√©fini la fonction <code>prepare</code> pour l'instance Discovery.  Cette fonction est appel√©e √† chaque fois avant d'appliquer des donn√©es √† l'instance de d√©couverte.  C'est un bon endroit pour autoriser les valeurs dans les r√©f√©rences d'objet: </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packageIndex = data.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, pkg</span></span></span><span class="hljs-function">) =&gt;</span></span> map.set(pkg.path, pkg), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); data.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pkg</span></span></span><span class="hljs-function"> =&gt;</span></span> pkg.deps.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dep</span></span></span><span class="hljs-function"> =&gt;</span></span> dep.resolved = packageIndex.get(dep.resolved) ) ); });</code> </pre> <br><p>  Ici, nous avons cr√©√© un index de package dans lequel la cl√© est la valeur du <code>path</code> du package (unique).  Ensuite, nous parcourons tous les packages et leurs d√©pendances, et dans les d√©pendances, nous rempla√ßons la valeur <code>resolved</code> par une r√©f√©rence √† l'objet package.  R√©sultat: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/95b/277/dd6/95b277dd63dc3aff1fdf3716c6881356.png" alt="D√©p√¥ts convertis r√©solus"></p><br><p>  Maintenant, il est beaucoup plus facile de faire des requ√™tes de graphe de d√©pendance.  Voici comment obtenir un cluster de d√©pendances (c'est-√†-dire les d√©pendances, les d√©pendances de d√©pendances, etc.) pour un package sp√©cifique: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c64/793/a78/c64793a78d40961af1b234fc111e4dc2.png" alt="Exemple de cluster de d√©pendance"></p><br><blockquote>  Une r√©ussite inattendue: en √©tudiant les donn√©es lors de la r√©daction du manuel, j'ai d√©couvert un probl√®me dans <code>@discoveryjs/cli</code> (en utilisant la requ√™te <code>.[deps.[not resolved]]</code> ), qui avait une faute de frappe dans peerDependencies.  Le probl√®me imm√©diatement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">a √©t√© corrig√©</a> .  Le cas est un bon exemple de la fa√ßon dont ces outils aident. </blockquote><p>  Peut-√™tre que le moment est venu de montrer sur la page d'accueil plusieurs num√©ros et packages avec des prises. </p><br><h2 id="nastraivaem-startovuyu-stranicu">  Personnaliser la page de d√©marrage </h2><br><p>  Tout d'abord, nous devons cr√©er un module de page, par exemple, <code>pages/default.js</code> .  Nous utilisons <code>default</code> , car il s'agit de l'identifiant de la page de d√©marrage, que nous pouvons remplacer (dans Discovery.js, vous pouvez remplacer beaucoup).  Commen√ßons par quelque chose de simple, par exemple: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, <span class="hljs-string"><span class="hljs-string">'text:"Hello world!"'</span></span> ]);</code> </pre> <br><p>  Maintenant, dans la configuration, vous devez connecter le module de page: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>), <span class="hljs-attr"><span class="hljs-attr">view</span></span>: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//     ] } };</span></span></code> </pre> <br><p>  V√©rifiez dans le navigateur: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e0c/d07/8d5/e0cd078d55637ef62a697809544909b9.png" alt="Page de d√©marrage remplac√©e"></p><br><p>  √áa marche! </p><br><p>  Maintenant, prenons quelques compteurs.  Pour ce faire, modifiez <code>pages/default.js</code> : </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'indicator'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`[ { label: 'Package entries', value: size() }, { label: 'Unique packages', value: name.size() }, { label: 'Dup packages', value: group(&lt;name&gt;).[value.size() &gt; 1].size() } ]`</span></span> } ]);</code> </pre> <br><p>  Nous d√©finissons ici une liste en ligne d'indicateurs.  La valeur des <code>data</code> est une requ√™te Jora qui cr√©e un tableau d'enregistrements.  La liste des packages (racine des donn√©es) est utilis√©e comme base pour les requ√™tes, nous obtenons donc la longueur de la liste ( <code>size()</code> ), le nombre de noms de packages uniques ( <code>name.size()</code> ) et le nombre de noms de packages qui ont des doublons ( <code>group(&lt;name&gt;).[value.size() &gt; 1].size()</code> ). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebf/c97/8a2/ebfc978a2b2da44214a99a8382e17107.png" alt="Ajouter des indicateurs √† la page de d√©marrage"></p><br><p>  Pas mal.  N√©anmoins, il serait pr√©f√©rable d'avoir, en plus des num√©ros, des liens vers les √©chantillons correspondants: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Package entries'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Unique packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Dup packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'group(&lt;name&gt;).[value.size() &gt; 1]'</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">`indicator:{ label, value: value.query(#.data, #).size(), href: pageLink('report', { query: value, title: label }) }`</span></span> } ]);</code> </pre> <br><p>  Tout d'abord, nous avons chang√© la valeur des <code>data</code> , maintenant c'est un tableau r√©gulier avec quelques objets.  En outre, la m√©thode <code>size()</code> a √©t√© supprim√©e des demandes de valeur. </p><br><p>  De plus, une sous-requ√™te a √©t√© ajout√©e √† la vue des <code>indicator</code> .  Ces types de requ√™tes cr√©ent un nouvel objet pour chaque √©l√©ment dans lequel la <code>value</code> et le <code>href</code> sont calcul√©s.  Pour <code>value</code> , une requ√™te est ex√©cut√©e √† l'aide de la m√©thode <code>query()</code> , √† laquelle les donn√©es sont transf√©r√©es du contexte, puis la m√©thode <code>size()</code> est appliqu√©e au r√©sultat de la requ√™te.  Pour <code>href</code> , la m√©thode <code>pageLink()</code> est utilis√©e, ce qui g√©n√®re un lien vers la page de rapport avec une demande et un en-t√™te sp√©cifiques.  Apr√®s tous ces changements, les indicateurs sont devenus cliquables (notez que leurs valeurs sont devenues bleues) et plus fonctionnels. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e72/104/33c/e7210433ca45798701f34c6625cae050.gif" alt="Indicateurs cliquables"></p><br><p>  Pour rendre la page de d√©marrage plus utile, ajoutez un tableau avec des packages contenant des doublons. </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-comment"><span class="hljs-comment">// ...      'h2:"Packages with more than one physical instance"', { view: 'table', data: ` group(&lt;name&gt;) .[value.size() &gt; 1] .sort(&lt;value.size()&gt;) .reverse() `, cols: [ { header: 'Name', content: 'text:key' }, { header: 'Version &amp; Location', content: { view: 'list', data: 'value.sort(&lt;version&gt;)', item: [ 'badge:version', 'text:path' ] } } ] } ]);</span></span></code> </pre> <br><p>  Le tableau utilise les m√™mes donn√©es que l'indicateur des <code>Dup packages</code> .  La liste des packages a √©t√© tri√©e par taille de groupe dans l'ordre inverse.  Les autres param√®tres sont li√©s aux colonnes (au fait, ils n'ont g√©n√©ralement pas besoin d'√™tre configur√©s).  Pour la colonne <code>Version &amp; Location</code> , nous avons d√©fini une liste imbriqu√©e (tri√©e par version), dans laquelle chaque √©l√©ment est une paire du num√©ro de version et du chemin d'acc√®s √† l'instance. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a50/5fd/4ab/a505fd4aba48f6a0d025fc5cd4b84b24.png" alt="Table ajout√©e avec les packages qui ont plus d'une instance physique"></p><br><h2 id="stranica-paketov">  Page Package </h2><br><p>  Maintenant, nous n'avons qu'un aper√ßu g√©n√©ral des packages.  Mais il serait utile d'avoir une page avec des d√©tails sur un paquet particulier.  Pour ce faire, cr√©ez un nouveau module <code>pages/package.js</code> et d√©finissez une nouvelle page: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'context'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`{ name: #.id, instances: .[name = #.id] }`</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: [ <span class="hljs-string"><span class="hljs-string">'h1:name'</span></span>, <span class="hljs-string"><span class="hljs-string">'table:instances'</span></span> ] });</code> </pre> <br><p>  Dans ce module, nous avons d√©fini la page avec le <code>package</code> identifiant.  Le composant de <code>context</code> √©t√© utilis√© comme repr√©sentation initiale.  Il s'agit d'un composant non visuel qui vous aide √† d√©finir des donn√©es pour les mappages imbriqu√©s.  Notez que nous avons utilis√© <code>#.id</code> pour obtenir le nom du package, qui est r√©cup√©r√© √† partir d'une URL comme celle-ci <code>http://localhost:8123/#package:{id}</code> . </p><br><p>  N'oubliez pas d'inclure le nouveau module dans la configuration: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'pages/package.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//   ] } };</span></span></code> </pre> <br><p>  R√©sultat dans le navigateur: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3ee/698/da0/3ee698da0907aebaa1ace032942c0575.png" alt="Exemple de page de package"></p><br><p>  Pas trop impressionnant, mais pour l'instant.  Nous cr√©erons des mappages plus complexes dans les manuels suivants. </p><br><h2 id="bokovaya-panel">  Panneau lat√©ral </h2><br><p>  Comme nous avons d√©j√† une page de package, il serait bien d'avoir une liste de tous les packages.  Pour ce faire, vous pouvez d√©finir une vue sp√©ciale - <code>sidebar</code> , qui s'affiche si elle est d√©finie (non d√©finie par d√©faut).  Cr√©ez un nouveau module <code>views/sidebar.js</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'link:{ text: $, href: pageLink("package") }'</span></span> });</code> </pre> <br><p>  Nous avons maintenant une liste de tous les packages: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/503/326/a02/503326a020869af76a3b2076c5df2394.png" alt="Barre lat√©rale ajout√©e"></p><br><p>  √áa a l'air bien.  Mais avec un filtre, ce serait encore mieux.  Nous √©largissons la d√©finition de la <code>sidebar</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'content-filter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.[no #.filter or $~=#.filter].sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'link'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'{ text: $, href: pageLink("package"), match: #.filter }'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">'text-match'</span></span> } } });</code> </pre> <br><p>  Ici, nous avons envelopp√© la liste dans un composant de <code>content-filter</code> qui convertit la valeur d'entr√©e dans le champ d'entr√©e en expressions r√©guli√®res (ou <code>null</code> si le champ est vide) et l'enregistre en tant que valeur de <code>filter</code> dans le contexte (le nom peut √™tre modifi√© avec l'option de <code>name</code> ).  De plus, pour filtrer les donn√©es de la liste, nous avons utilis√© <code>#.filter</code> .  Enfin, nous avons appliqu√© le mappage de liens pour mettre en √©vidence les parties correspondantes avec <code>text-match</code> .  R√©sultat: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d55/74f/67e/d5574f67e7a2dd222194c66f5ecf0673.png" alt="Liste des filtres"></p><br><p>  Si vous n'aimez pas la conception par d√©faut, vous pouvez personnaliser les styles √† votre guise.  Disons que vous souhaitez modifier la largeur de la barre lat√©rale, pour cela, vous devez cr√©er un fichier de style (par exemple, <code>views/sidebar.css</code> ): </p><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.discovery-sidebar</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">300px</span></span>; }</code> </pre> <br><p>  Et ajoutez un lien vers ce fichier dans la configuration, ainsi que vers les modules JavaScript: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ ... <span class="hljs-string"><span class="hljs-string">'views/sidebar.css'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  assets    *.css  'views/sidebar.js' ] } };</span></span></code> </pre> <br><h2 id="avtossylki">  Liens automatiques </h2><br><p>  Le dernier chapitre de ce guide est consacr√© aux liens.  Plus t√¥t, en utilisant la m√©thode <code>pageLink()</code> , nous avons cr√©√© un lien vers la page du package.  Mais en plus du lien, vous devez √©galement d√©finir le texte du lien.  Mais comment pourrions-nous faciliter les choses? </p><br><p>  Pour simplifier le travail des liens, nous devons d√©finir une r√®gle pour g√©n√©rer des liens.  Il est pr√©f√©rable de le faire dans le script <code>prepare</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ ... const packageIndex = data.reduce( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, item</span></span></span><span class="hljs-function">) =&gt;</span></span> map .set(item, item) <span class="hljs-comment"><span class="hljs-comment">// key is item itself .set(item.name, item), // and `name` value new Map() ); discovery.addEntityResolver(value =&gt; { value = packageIndex.get(value) || packageIndex.get(value.name); if (value) { return { type: 'package', id: value.name, name: value.name }; } }); });</span></span></code> </pre> <br><p>  Nous avons ajout√© une nouvelle carte (index) des packages et l'avons utilis√©e pour le r√©solveur d'entit√©.  Le r√©solveur d'entit√© essaie, si possible, de convertir la valeur qui lui est transmise en un descripteur d'entit√©.  Le descripteur contient: </p><br><ul><li>  <code>type</code> - type d'entit√© </li><li>  <code>id</code> - une r√©f√©rence unique √† une instance d'entit√© utilis√©e dans les liens comme ID </li><li>  <code>name</code> - utilis√© comme texte de lien </li></ul><br><p>  Enfin, vous devez affecter ce type √† une page sp√©cifique (le lien doit mener quelque part, non?). </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { ... }, { <span class="hljs-attr"><span class="hljs-attr">resolveLink</span></span>: <span class="hljs-string"><span class="hljs-string">'package'</span></span> <span class="hljs-comment"><span class="hljs-comment">//    `package`    });</span></span></code> </pre> <br><p>  La premi√®re cons√©quence de ces modifications est que certaines valeurs de la vue <code>struct</code> sont d√©sormais marqu√©es par un lien vers la page du package: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eb2/dcd/502/eb2dcd5024f589a3ba8180f2b1ec538f.png" alt="Liens automatiques dans la structure"></p><br><p>  Et maintenant, vous pouvez √©galement appliquer le composant de <code>auto-link</code> √† un nom d'objet ou de package: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/64d/3c2/f24/64d3c2f244164a22c55ff433409f6e22.png" alt="Utilisation de la liaison automatique"></p><br><p>  Et, √† titre d'exemple, vous pouvez retravailler l√©g√®rement la barre lat√©rale: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//   item: { view: 'link', data: '{ text: $, href: pageLink("package"), match: #.filter }', content: 'text-match' }, //   `auto-link` item: { view: 'auto-link', content: 'text-match:{ text, match: #.filter }' }</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Vous avez maintenant une compr√©hension de base des concepts cl√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Discovery.js</a> .  Dans les guides suivants, nous examinerons de plus pr√®s les sujets trait√©s. </p><br><p>  Vous pouvez voir l'int√©gralit√© du code source du guide dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel sur GitHub</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essayer son fonctionnement en ligne</a> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Suivez @js_discovery</a> sur Twitter pour rester au courant des derni√®res nouvelles! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469115/">https://habr.com/ru/post/fr469115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469097/index.html">Serveur Web CentOS 8 avec php7, node.js et redis</a></li>
<li><a href="../fr469099/index.html">Tester les t√¢ches lors de l'entretien avec le d√©veloppeur - est-ce que cela a du sens?</a></li>
<li><a href="../fr469101/index.html">Apprendre l'anglais: comment apprendre √† parler en tant que locuteur natif</a></li>
<li><a href="../fr469109/index.html">Jouets en bois, troisi√®me partie - 1989</a></li>
<li><a href="../fr469111/index.html">Remplacer l'objet par var: qu'est-ce qui pourrait mal tourner?</a></li>
<li><a href="../fr469117/index.html">Programmation sous BC 0010 en 2019</a></li>
<li><a href="../fr469119/index.html">Les adresses IPv4 dans RIPE sont termin√©es. Compl√®tement termin√© ...</a></li>
<li><a href="../fr469125/index.html">Th√®me sombre de Thunderbird comme raison d'ex√©cuter un analyseur de code</a></li>
<li><a href="../fr469127/index.html">Optimisation ou comment ne pas se tirer une balle dans le pied</a></li>
<li><a href="../fr469129/index.html">En raison du th√®me sombre, Thunderbird a d√ª ex√©cuter un analyseur de code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>