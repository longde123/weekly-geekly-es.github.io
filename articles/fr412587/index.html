<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öóÔ∏è üå¨Ô∏è ‚úçüèæ Marionnette + Hiera. Pressez le maximum üöã üö¶ üëáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je voudrais parler de la fa√ßon dont nous utilisons Puppet et Hiera pour configurer les serveurs de fer et virtuels. Fondamentalement...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Marionnette + Hiera. Pressez le maximum</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/412587/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vq/z-/bj/vqz-bjm4yx2wvhzcf-frffyuh04.png"></div><br><p>  Dans cet article, je voudrais parler de la fa√ßon dont nous utilisons <strong>Puppet</strong> et <strong>Hiera</strong> pour configurer les serveurs de fer et virtuels.  Fondamentalement, il s'agira de l'architecture et de la hi√©rarchie que nous avons invent√©es, ce qui facilite et syst√©matise la configuration des serveurs. </p><br><p>  J'ai √©t√© invit√© √† √©crire cet article par le fait que sur Internet, je n'ai pas trouv√© de bons exemples vraiment efficaces de la fa√ßon dont vous pouvez travailler avec hiera et √† quoi il sert.  Fondamentalement, ce sont des tutoriels avec des exemples pour entrer dans le sujet.  Mais la v√©ritable application pratique de hiera n'y est pas √©crite.  Je n'ai peut-√™tre pas bien regard√©, mais voici un exemple r√©el qui vous aidera probablement √† mettre tous les points sur i, comme je l'ai fait une fois. </p><br><h3 id="dlya-kogo-byla-by-polezna-dannaya-statya">  Pour qui cet article serait utile </h3><br><p>  Si: </p><br><ul><li>  Vous savez ce que sont Puppet et Hiera, mais vous ne les utilisez pas vraiment ensemble, car on ne sait pas comment le faire et pourquoi </li><li>  Vous avez beaucoup d'√©quipes dans votre entreprise et vous devez en quelque sorte diff√©rencier la configuration du serveur au niveau des commandes </li><li>  Vous utilisez un pappet et les fichiers de noeud que vous avez d√©velopp√©s √† des tailles incroyables </li><li>  Aimez-vous lire la configuration du serveur au format divine yaml :) </li><li>  Vous √™tes essentiellement int√©ress√© par le sujet de la gestion de la configuration et de l'administration syst√®me. </li></ul><br><p>  Cet article est fait pour vous. </p><a name="habracut"></a><br><h3 id="prezhde-chem-nachat">  Avant de commencer </h3><br><p>  Je vous pr√©viens tout de suite, l'article s'est av√©r√© long, mais, je l'esp√®re, utile.  De plus, il est entendu que vous avez d√©j√† connect√© hiera √† marionnette, et vous √™tes au moins en quelque sorte familier avec la marionnette.  Si hiera n'est pas connect√©, ce n'est pas difficile √† faire. </p><br><ul><li>  En savoir plus sur ce qu'est Puppet ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Puppet pour les d√©butants</a> . </li><li>  Comment fonctionne Hiera - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pr√©sentation √† Hiera</a> . </li></ul><br><h3 id="vvodnye-dannye">  Entrer les donn√©es </h3><br><ul><li>  Nous avons environ 30 √©quipes de d√©veloppement chez SEMrush, chacune ayant ses propres serveurs </li><li>  Chaque √©quipe travaille avec son propre ensemble de technologies (PL, SGBD, etc.) </li><li>  Les √©quipes peuvent et doivent (id√©alement) utiliser une configuration commune pour des projets sp√©cifiques (r√©utilisation du code) </li><li>  Les √©quipes g√®rent elles-m√™mes le d√©ploiement des applications sur leurs serveurs (cela ne se fait pas via le pappet) </li></ul><br><h3 id="nemnogo-istorii">  Un peu d'histoire </h3><br><p>  Initialement, nous avions tout dans le pappet de la version 3, puis nous avons d√©cid√© d'impl√©menter le 4e pappet, et tous les nouveaux serveurs ont commenc√© √† y √™tre plac√©s, et les anciens ont √©t√© lentement port√©s sur le 4e. </p><br><p>  Dans le troisi√®me pappet, nous utilisions le syst√®me classique de fichiers et modules de n≈ìuds.  Les modules ont √©t√© cr√©√©s dans un groupe sp√©cial de projets dans Gitlab, ils ont √©t√© clon√©s sur un serveur pappet (en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r10k</a> ), puis les agents pappet sont venus √† l'assistant et ont re√ßu un r√©pertoire pour l'appliquer au serveur. </p><br><p>  Ensuite, ils ont commenc√© √† essayer de ne pas le faire et √† ne pas utiliser les modules locaux, mais √† mettre des liens vers les modules n√©cessaires et leurs r√©f√©rentiels dans le Puppetfile.  Pourquoi?  Parce que ces modules sont constamment pris en charge et am√©lior√©s (enfin, id√©alement) par la communaut√© et les d√©veloppeurs, et nos modules locaux ne le sont pas.  Plus tard, ils ont introduit hiera et y sont compl√®tement pass√©s, et les fichiers de n≈ìuds (tels que n≈ìuds.pp) sont tomb√©s dans l'oubli. </p><br><p> Dans le quatri√®me pappet, nous avons essay√© d'abandonner compl√®tement les modules locaux et d'utiliser uniquement des modules distants.  Malheureusement, une r√©servation doit √™tre ins√©r√©e √† nouveau ici, car cela ¬´n'a pas fonctionn√© compl√®tement¬ª, parfois vous devez encore incliner et terminer quelque chose vous-m√™me.  Bien s√ªr, il n'y a que des fichiers hiera et aucun n≈ìud. </p><br><p>  <strong>Lorsque vous avez 30 √©quipes avec un zoo technologique, le probl√®me de la conservation de cette m√©nagerie avec&gt; 1000 serveurs devient particuli√®rement aigu.</strong>  <strong>De plus, je dirai comment hiera nous aide dans ce domaine.</strong> </p><br><h3 id="ierarhiya">  Hi√©rarchie </h3><br><p>  Hiera (en fait, d'o√π il tire son nom) √©tablit une hi√©rarchie.  Chez nous, √ßa ressemble √† √ßa: </p><br><pre><code class="hljs axapta">--- :hierarchy: - <span class="hljs-string"><span class="hljs-string">"nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/roles/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/%{::team}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Voyons d'abord les variables obscures (faits). </p><br><p>  Chaque serveur dans SEMrush devrait id√©alement avoir 4 faits sp√©ciaux expos√©s d√©crivant son affiliation: </p><br><ul><li>  fait d' <strong><code>team</code></strong> - √† quelle √©quipe appartient-il </li><li>  <strong><code>project</code></strong> - √† quel projet se rapporte-t-il </li><li>  <strong><code>role</code></strong> fait - quel r√¥le ce projet a-t-il </li><li>  fait de <strong><code>tier</code></strong> - quel type de mise en sc√®ne a-t-il (prod, test, dev) </li></ul><br><p>  Comment √ßa marche?  L'agent Pappet vient au ma√Ætre Pappet et, sur la base de ces faits, recherche des fichiers pour lui-m√™me, en parcourant les dossiers conform√©ment √† notre hi√©rarchie.  Pas besoin d'indiquer que les fichiers de configuration appartiennent aux serveurs.  Au lieu de cela, les serveurs eux-m√™mes savent quels fichiers leur appartiennent, ne regardant que leur chemin et leurs faits. </p><br><p>  Lors de la configuration du serveur, les administrateurs contactent les d√©veloppeurs et sp√©cifient ces param√®tres (souvent, au contraire, des personnes bien inform√©es contactent les administrateurs eux-m√™mes) afin de construire une hi√©rarchie dans hiera √† l'avenir, sur la base de laquelle d√©crire ensuite la configuration du serveur.  Un tel syst√®me permet de r√©utiliser le code et d'√™tre plus flexible en termes de configuration du serveur. </p><br><p>  Par exemple, nous avons un projet <em>sp√©cial</em> .  Dans ce projet, il peut y avoir un serveur frontal avec nginx, un serveur principal avec python, un cluster db avec mysql, un serveur redis pour la mise en cache.  Tous ces serveurs doivent √™tre plac√©s dans un projet appel√© <strong>sp√©cial</strong> , puis attribuer des <strong>r√¥les</strong> aux serveurs. </p><br><p>  Dans le fichier projet, nous d√©crivons les param√®tres communs √† l'ensemble du projet.  La premi√®re chose qui me vient √† l'esprit est la cr√©ation sur tous les serveurs de l'utilisateur pour le d√©ploiement avec la d√©livrance des droits n√©cessaires √† lui et le d√©ploiement de ses cl√©s ssh. </p><br><p>  Dans le r√¥le de chaque serveur, le service est g√©n√©ralement d√©crit et personnalis√© - pour ce √† quoi ce serveur est destin√© (nginx, python, mysql, etc.). Dans ce cas, nous aurons certainement besoin si nous devons √©galement d√©ployer une copie de l'environnement de production sur la plate-forme de d√©veloppement, mais changez-y quelque chose (mots de passe, par exemple).  Dans ce cas, le serveur de d√©veloppement et le serveur de production ne diff√©reront que par le fait que le niveau est d√©fini sur la ¬´position¬ª souhait√©e (prod ou dev).  Et puis un peu de magie et d'Hiera fera l'affaire. </p><br><p>  Si nous devons d√©ployer deux serveurs identiques dans le m√™me r√¥le, mais que quelque chose en eux devrait diff√©rer, par exemple, certaines lignes de la configuration, alors une autre partie de la hi√©rarchie viendra √† la rescousse.  Nous pla√ßons les fichiers avec le nom du format <strong><code>{fqdn }.yaml</code></strong> au bon endroit (par exemple, <strong><code>nodes/myserver.domain.net</code></strong> ), d√©finissons les valeurs n√©cessaires des variables au niveau d'un serveur sp√©cifique, et le pappet appliquera la m√™me configuration pour les deux serveurs pour le r√¥le, et unique pour chacun des serveurs. </p><br><p>  Exemple: deux backends avec du code php ont le m√™me r√¥le et sont compl√®tement identiques.  Il est clair que nous ne voulons pas sauvegarder les deux serveurs - cela n'a aucun sens.  Nous pouvons cr√©er un r√¥le dans lequel d√©crire la m√™me configuration pour les deux serveurs, puis cr√©er un autre fichier <strong><code>nodes/backend1.semrush.net</code></strong> dans lequel placer la configuration pour la sauvegarde. </p><br><p>  Le fichier de commandes <strong><code>teams/team-name.yaml</code></strong> indique la configuration de tous les serveurs qui appartiennent √† l'√©quipe.  Le plus souvent, il d√©crit les utilisateurs qui peuvent interagir avec ces serveurs, ainsi que leurs droits d'acc√®s. </p><br><p>  Sur la base de ces variables, nous avons construit cette <strong>hi√©rarchie</strong> .  Plus le fichier trouv√© dans la hi√©rarchie est √©lev√©, plus la priorit√© de la configuration qui y est sp√©cifi√©e est √©lev√©e. </p><br><p>  Il s'ensuit que les variables peuvent <strong>remplacer en</strong> fonction de cette hi√©rarchie.  C'est-√†-dire que la variable dans le fichier de r√¥le " <strong><code>projects/%{::project}/%{::role}</code></strong> " a priorit√© sur la variable dans le fichier de projet " <strong><code>projects/%{::project}</code></strong> ".  Les variables peuvent √©galement fusionner √† tous les niveaux de la hi√©rarchie si vous avez un module et / ou un profil / r√¥le √©crit de mani√®re √† vous permettre de le faire.  En sp√©cifiant la partie commune de la configuration mysql pour tous les serveurs de projet, vous pouvez ajouter des parties sp√©ciales qui ont du poids pour ce r√¥le √† la m√™me variable √† d'autres niveaux de la hi√©rarchie (il y aura une section suppl√©mentaire dans la configuration pour l'esclave). </p><br><p>  Il s'av√®re que le fichier du n≈ìud sp√©cifique situ√© le long du chemin " <strong><code>hieradata/nodes/%{::fqdn}</code></strong> " a la priorit√© la plus √©lev√©e.  Vient ensuite le fichier de noeud, mais d√©j√† au niveau de la commande.  Voici le bloc qui d√©crit d'autres faits plus g√©n√©raux: </p><br><pre> <code class="hljs axapta"> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Par cons√©quent, dans le fichier <strong><code>common.yaml</code></strong> nous avons une configuration qui devrait d√©finitivement arriver √† <strong>tous les</strong> serveurs, dans le fichier <strong><code>users.yaml</code></strong> tous les utilisateurs sont d√©crits (mais tous ne sont pas cr√©√©s sur les serveurs, bien s√ªr), dans <strong><code>os/%{::operatingsystem}</code></strong> configuration g√©n√©rale typique pour les serveurs avec un OS sp√©cifique (fact <code>::operatingsystem</code> ) et ainsi de suite. </p><br><p>  Je pense qu'en regardant cette hi√©rarchie, tout devient clair.  Ci-dessous, je consid√©rerai un exemple d'utilisation d'une telle hi√©rarchie.  Mais vous devez d'abord parler des profils. </p><br><h3 id="profili">  Profils </h3><br><p>  Un point important dans la configuration des serveurs √† l'aide de modules est l'utilisation de profils.  Ils sont situ√©s sur le <strong><code>site/profiles</code></strong> chemin d'acc√®s et constituent les points d'entr√©e des modules.  Gr√¢ce √† eux, vous pouvez configurer plus finement les modules suspendus sur le serveur et cr√©er les ressources n√©cessaires. </p><br><p>  Prenons un exemple simple.  Il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module</a> qui installe et configure redis.  Et nous voulons √©galement mettre le param√®tre <code>vm.overcommit_memory</code> √† 1 lors de la connexion de ce module, car <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Ensuite, nous √©crivons un petit profil qui fournit cette fonctionnalit√©: </p><br><pre> <code class="hljs lua"># standalone redis server class profiles::db::redis ( Hash $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = {}, String $output_buffer_limit_slave = <span class="hljs-string"><span class="hljs-string">'256mb 64mb 60'</span></span>, ) { # https://redis.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/topics/faq#background-saving-fails-with-a-fork-<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>-under-linux-even-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-i-have-a-lot-of-free-ram sysctl { <span class="hljs-string"><span class="hljs-string">'vm.overcommit_memory'</span></span>: ensure =&gt; present, value =&gt; <span class="hljs-string"><span class="hljs-string">'1'</span></span>, } class { <span class="hljs-string"><span class="hljs-string">'::redis'</span></span>: * =&gt; $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, } }</code> </pre> <br><p>  Comme mentionn√© ci-dessus, les profils sont un outil qui vous permet de changer / am√©liorer le comportement du module, ainsi que de r√©duire le nombre de configurations dans hiera.  Si vous utilisez des modules distants, vous pouvez souvent rencontrer le probl√®me que les modules ¬´approuv√©s¬ª n'ont souvent pas les fonctionnalit√©s dont vous avez besoin, ou ont des bugs / d√©fauts.  Ensuite, en principe, vous pouvez cloner ce module et corriger / ajouter des fonctionnalit√©s.  Mais la bonne d√©cision serait, si possible, d'√©crire un bon profil qui peut ¬´pr√©parer¬ª le module de la mani√®re dont vous avez besoin.  Vous trouverez ci-dessous quelques exemples de profils et vous comprendrez mieux pourquoi ils sont n√©cessaires. </p><br><h3 id="sokrytie-sekretov-v-hiera">  Cacher des secrets √† Hiera </h3><br><p>  Un des avantages importants de hiera par rapport au pappet nu est sa capacit√© √† stocker des donn√©es sensibles dans des fichiers de configuration sous forme crypt√©e dans le r√©f√©rentiel.  Vos mots de passe seront en s√©curit√©. </p><br><p>  En bref, vous utilisez la cl√© publique pour crypter les informations dont vous avez besoin et les placez avec une telle ligne dans le fichier hiera.  La partie priv√©e de la cl√© est stock√©e sur le ma√Ætre Pappet, ce qui vous permet de d√©crypter ces donn√©es.  Plus de d√©tails peuvent √™tre trouv√©s sur la page du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet</a> . </p><br><p>  Sur le client (ordinateur de travail), l'outil est install√© simplement en utilisant <strong><code>gem install hiera-eyaml</code></strong> .  De plus, en utilisant une commande de la forme <strong><code>eyaml encrypt --pkcs7-public-key=/path/to/public_key.pkcs7.pem -s 'hello'</code></strong> vous pouvez crypter les donn√©es et les coller dans un fichier avec l'extension eyaml ou simplement yaml, selon la fa√ßon dont vous configurer, puis le pappet le d√©couvrira.  Vous obtenez quelque chose comme: </p><br><pre> <code class="hljs ruby">roles::postrgresql::<span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T+Lq194Y6QdElMD1XTev5y+VPSHtkPTu6Al6TJaSrXF+7phJIjue+NF4ZVtJCLkHxUR6nJJqks0fcGS1vF2+6mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTewqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv+qnptnZ7pilR2veOCPW2UMm6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV/5lfcL5ajdNBJXkvKqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA+0wjAMblkKgBCR/f9KGXUgLh3/Ok60OIT5]'</span></span></code> </pre> <br><p>  Ou une cha√Æne multi-lignes: </p><br><pre> <code class="hljs powershell">roles::postgresql::password: &gt; ENC[<span class="hljs-type"><span class="hljs-type">PKCS7</span></span>,<span class="hljs-type"><span class="hljs-type">MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEw</span></span> <span class="hljs-type"><span class="hljs-type">DQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T</span></span>+<span class="hljs-type"><span class="hljs-type">Lq194Y6QdElMD1XTev5y</span></span> +<span class="hljs-type"><span class="hljs-type">VPSHtkPTu6Al6TJaSrXF</span></span>+<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-type"><span class="hljs-type">phJIjue</span></span>+<span class="hljs-type"><span class="hljs-type">NF4ZVtJCLkHxUR6nJJqks0fcGS1vF</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-type"><span class="hljs-type">mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTe</span></span> <span class="hljs-type"><span class="hljs-type">wqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv</span></span>+<span class="hljs-type"><span class="hljs-type">qnptnZ7pilR2veOCPW2UM</span></span> <span class="hljs-type"><span class="hljs-type">m6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-type"><span class="hljs-type">lfcL5ajdNBJXkv</span></span> <span class="hljs-type"><span class="hljs-type">KqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7</span></span> <span class="hljs-type"><span class="hljs-type">iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">wjAM</span></span> <span class="hljs-type"><span class="hljs-type">blkKgBCR</span></span>/<span class="hljs-type"><span class="hljs-type">f9KGXUgLh3</span></span>/<span class="hljs-type"><span class="hljs-type">Ok60OIT5</span></span>]</code> </pre> <br><p>  Il semble que nous ayons termin√© la pr√©paration, maintenant nous pouvons consid√©rer un exemple. </p><br><h3 id="primer-na-palcah">  Exemple de doigt </h3><br><p>  <strong>Spoiler</strong> : il y <em>aura beaucoup plus de configurations, donc ceux qui sont int√©ress√©s par cet article d'int√©r√™t purement th√©orique peuvent sauter cette section et aller √† la fin.</em> </p><br><p>  Voyons maintenant un exemple de configuration d'un serveur utilisant hiera dans puppet4.  Je ne publierai pas le code pour tous les profils, car sinon le message s'av√©rera assez volumineux.  Je vais me concentrer sur la hi√©rarchie et la configuration de hiera. </p><br><p>  <strong>La t√¢che est la suivante:</strong> nous devons d√©ployer: </p><br><ul><li>  Deux serveurs DB identiques sur lesquels postgresql est d√©ploy√© </li><li>  Deux autres serveurs - frontend avec nginx </li><li>  Cinqui√®me et sixi√®me serveur - backends python dans docker </li><li>  Tout est identique dans l'environnement de d√©veloppement, √† l'exception d'une certaine configuration de serveur </li></ul><br><p>  Nous allons cr√©er notre hi√©rarchie dans l'ordre et nous allons commencer par le fichier projet. </p><br><h4 id="proekt">  Projet </h4><br><p>  Cr√©ez le fichier de projet <strong><code>projects/kicker.yaml</code></strong> .  Nous y mettons ce qui est commun √† tous les serveurs: nous avons besoin de certains r√©f√©rentiels et dossiers pour le d√©ploiement, ainsi que de l'utilisateur de d√©ploiement lui-m√™me. </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - apt::debian::semrush <span class="hljs-symbol"><span class="hljs-symbol">files:</span></span> <span class="hljs-string"><span class="hljs-string">"/srv/data"</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0755'</span></span> <span class="hljs-string"><span class="hljs-string">'/srv/data/shared_temp'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0775'</span></span> user_management::<span class="hljs-symbol"><span class="hljs-symbol">present:</span></span> - deploy</code> </pre> <br><h4 id="rol-db">  R√¥le Db </h4><br><p>  Cr√©ez un fichier de r√¥le pour les serveurs de base de donn√©es <strong><code>projects/kicker/db.yaml</code></strong> .  Jusqu'√† pr√©sent, nous nous passerons de diviser les serveurs en environnements: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::db::postgresql profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">globals:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">manage_package_repo:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">db_configs:</span></span> <span class="hljs-string"><span class="hljs-string">'listen_addresses'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">databases:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">kicker:</span></span> {} profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">hba_rules:</span></span> <span class="hljs-string"><span class="hljs-string">'local connect to kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'local'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'001'</span></span> <span class="hljs-string"><span class="hljs-string">'allow connect from 192.168.1.100'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'host'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">address:</span></span> <span class="hljs-string"><span class="hljs-string">'192.168.1.100/32'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'002'</span></span></code> </pre> <br><p>  Ici, nous connectons un profil √©crit pour une utilisation g√©n√©rale par tous ceux qui souhaitent installer postgres sur leur serveur.  Nous configurons le profil et vous permettons de configurer le module de mani√®re flexible avant de l'appliquer. </p><br><p>  Pour les plus curieux, en dessous du code cat de ce profil: </p><br><div class="spoiler">  <b class="spoiler_title">Profil :: db :: postgresql</b> <div class="spoiler_text"><pre> <code class="hljs mel">class profiles::db::postgresql ( Hash $globals = {}, Hash $params = {}, Hash $recovery = {}, Hash[String, Hash[String, Variant[String, Boolean, Integer]]] $roles = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $db_configs = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $databases = {}, Hash[String, String] $db_grants = {}, Hash[String, Hash[String, String]] $extensions = {}, Hash[String, String] $table_grants = {}, Hash[String, Hash[String, String]] $hba_rules = {}, Hash[String, String] $indent_rules = {}, Optional[String] $role = undef, # <span class="hljs-string"><span class="hljs-string">'master'</span></span>, <span class="hljs-string"><span class="hljs-string">'slave'</span></span> Optional[String] $master_host = undef, Optional[String] $replication_password = undef, Integer $master_port = <span class="hljs-number"><span class="hljs-number">5432</span></span>, String $replication_user = <span class="hljs-string"><span class="hljs-string">'repl'</span></span>, String $trigger_file = <span class="hljs-string"><span class="hljs-string">'/tmp/pg_trigger.file'</span></span>, ){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $role { <span class="hljs-string"><span class="hljs-string">'slave'</span></span>: { $_params = { manage_recovery_conf =&gt; true, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $globals[<span class="hljs-string"><span class="hljs-string">'datadir'</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { <span class="hljs-string"><span class="hljs-string">"${globals['datadir']}/recovery.done"</span></span>: ensure =&gt; absent, } } $_recovery = { <span class="hljs-string"><span class="hljs-string">'recovery config'</span></span> =&gt; { standby_mode =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, primary_conninfo =&gt; <span class="hljs-string"><span class="hljs-string">"host=${master_host} port=${master_port} user=${replication_user} password=${replication_password}"</span></span>, trigger_file =&gt; $trigger_file, } } $_conf = { <span class="hljs-string"><span class="hljs-string">'hot_standby'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; absent, } } <span class="hljs-string"><span class="hljs-string">'master'</span></span>: { $_conf = { <span class="hljs-string"><span class="hljs-string">'wal_level'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'replica'</span></span>, }, <span class="hljs-string"><span class="hljs-string">'max_wal_senders'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>, }, <span class="hljs-string"><span class="hljs-string">'wal_keep_segments'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; present, } } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { $_params = {} $_recovery = {} $_conf = {} } } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::globals'</span></span>: * =&gt; $globals, } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::server'</span></span>: * =&gt; deep_merge($_params, $params), } create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::config_entry'</span></span>, deep_merge($_conf, $db_configs)) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::role'</span></span>, $roles) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database'</span></span>, $databases) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database_grant'</span></span>, $db_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::extension'</span></span>, $extensions) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::table_grant'</span></span>, $table_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_hba_rule'</span></span>, $hba_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_indent_rule'</span></span>, $indent_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::recovery'</span></span>, deep_merge($_recovery, $recovery)) }</code> </pre> </div></div><br><p>  Ainsi, nous installons <code>Postgresql 10</code> un seul coup, configurons la configuration ( <code>listen</code> ), cr√©ons la base de donn√©es <code>kicker</code> et √©crivons √©galement deux r√®gles d'acc√®s √† cette base de donn√©es dans <code>pg_hba.conf</code> .  Cool! </p><br><h4 id="rol-frontend">  R√¥le frontal </h4><br><p>  Nous prenons la t√™te.  Cr√©ez le fichier <strong><code>projects/kicker/frontend.yaml</code></strong> avec le contenu suivant: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::webserver::nginx profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Ici, tout est simple.  Nous connectons le <strong><code>profiles::webserver::nginx</code></strong> , qui pr√©pare l'entr√©e dans le module nginx, et d√©finissons √©galement les variables, en particulier le <code>server</code> et l' <code>location</code> de ce site. </p><br><p>  Un lecteur attentif remarquera qu'il serait plus appropri√© de placer la description du site plus haut dans la hi√©rarchie, car nous aurons toujours un environnement de d√©veloppement, et d'autres variables ( <code>server_name</code> , <code>proxy</code> ) y seront utilis√©es, mais ce n'est pas trop important.  En d√©crivant le r√¥le de cette mani√®re, nous pouvons voir comment ces variables ne sont red√©finies que par la hi√©rarchie. </p><br><h4 id="rol-docker">  R√¥le Docker </h4><br><p>  Le r√¥le des <strong><code>projects/kicker/docker.yaml</code></strong> <code>docker</code> <strong><code>projects/kicker/docker.yaml</code></strong> : </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::docker profiles::docker::<span class="hljs-symbol"><span class="hljs-symbol">params:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'17.05.0~ce-0~debian-stretch'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">packages:</span></span> <span class="hljs-string"><span class="hljs-string">'python3-pip'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> apt <span class="hljs-string"><span class="hljs-string">'Fabric3'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> pip3 <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-number"><span class="hljs-number">1.12</span></span>.post1 user_management::<span class="hljs-symbol"><span class="hljs-symbol">users:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">deploy:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">groups:</span></span> - docker</code> </pre> <br><p>  Le <strong><code>profiles/docker.pp</code></strong> tr√®s simple et √©l√©gant.  Je donnerai son code: </p><br><div class="spoiler">  <b class="spoiler_title">Profil :: docker</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">profiles</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">:docker </span></span></span></span>( Hash $params = {}, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> $install_kernel = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ){ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-string"><span class="hljs-string">'docker'</span></span>: * =&gt; $params, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($install_kernel) { include profiles::docker::kernel } }</code> </pre> </div></div><br><p>  Tout est pr√™t.  Cela suffit d√©j√† pour d√©ployer le produit dont nous avons besoin sur de nombreux serveurs, en leur attribuant simplement un projet et un r√¥le sp√©cifiques (par exemple, en pla√ßant le fichier au format souhait√© dans le r√©pertoire facts.d, dont l'emplacement d√©pend de la m√©thode d'installation de la marionnette). </p><br><p>  Nous avons maintenant la structure de fichiers suivante: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ kicker ‚îÇ ‚îú‚îÄ‚îÄ db.yaml ‚îÇ ‚îú‚îÄ‚îÄ docker.yaml ‚îÇ ‚îî‚îÄ‚îÄ frontend.yaml ‚îî‚îÄ‚îÄ kicker.yaml 1 directory, 4 files</code> </pre> <br><p>  Nous allons maintenant traiter des environnements et de la d√©finition d'une configuration unique √† un r√¥le sur un site particulier. </p><br><h4 id="okruzheniya-i-override">  Environnement et d√©rogation </h4><br><p>  Cr√©ons la configuration g√©n√©rale pour toutes les ventes.  Le fichier <strong><code>projects/kicker/tiers/prod.yaml</code></strong> contient une indication que nous devons connecter une classe avec un pare-feu √† cet environnement (enfin, prod tout de m√™me), ainsi qu'une certaine classe qui offre un niveau de s√©curit√© accru: </p><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- classes: - semrush_firewall - strict_security_level</span></span></code> </pre> <br><p>  Pour un environnement de d√©veloppement, si nous devons d√©crire quelque chose de sp√©cifique, le m√™me fichier est cr√©√© et la configuration n√©cessaire y est entr√©e. </p><br><p>  Ensuite, vous devez encore red√©finir les variables pour la configuration nginx du r√¥le <code>frontend</code> dans l'environnement de d√©veloppement.  Pour ce faire, vous devez cr√©er le fichier <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> .  Faites attention √† un nouveau niveau de hi√©rarchie. </p><br><pre> <code class="hljs ruby">--- profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend-dev.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Vous n'avez plus besoin de sp√©cifier une classe, elle est h√©rit√©e des niveaux pr√©c√©dents de la hi√©rarchie.  Ici, nous avons chang√© <code>server_name</code> et <code>proxy_pass</code> .  Un serveur qui a les faits role = frontend et tier = dev trouvera d'abord le fichier <strong><code>projects/kicker/frontend.yaml</code></strong> pour lui-m√™me, mais ensuite les variables de ce fichier seront remplac√©es par le fichier <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> avec une priorit√© plus √©lev√©e . </p><br><h4 id="sokrytie-parolya-dlya-postgresql">  Masquage du mot de passe pour PostgreSQL </h4><br><p>  Et nous avons donc le dernier point √† l'ordre du jour - d√©finir des mots de passe pour PostgreSQL. </p><br><p>  Les mots de passe doivent varier dans les environnements.  Nous utiliserons eyaml pour stocker en toute s√©curit√© les mots de passe.  Cr√©ez des mots de passe: </p><br><pre> <code class="bash hljs">eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'verysecretpassword'</span></span> eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'testpassword'</span></span></code> </pre> <br><p>  Nous collons les lignes re√ßues dans les fichiers <code>**projects/kicker/tiers/prod/db.yaml**</code> et <code>**projects/kicker/tiers/dev/db.yaml**</code> (ou vous pouvez utiliser l'extension eyaml, c'est personnalisable), respectivement.  Voici un exemple: </p><br><pre> <code class="hljs ruby">--- profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">password_hash:</span></span> &gt; <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAsdpb2P0axUJzyWr2duRKAjh0WooGYUmoQ5gw0nO9Ym5ftv6uZXv25DRMKh7vsbzrrOR5/lLesx/pAVmcs2qbhd/y0Vr1oc2ohHlZBBKtCSEYwem5VN+kTMhWPvlt93x/S9ERoBp8LrrsIvicSYZByNfpS2DXCFbogSXCfEPxTTmCOtlOnxdjidIc9Q1vfAXv7FRQanYIspr2UytScm56H/ueeAc/8RYK51/nXDMtdPOiAP5VARioUKyTDSk8FqNvdUZRqA3cl+hA+xD5PiBHn5T09pnH8HyE/39q09gE0pXRe5+mOnU/4qfqFPc/EvAgAq5mVawlCR6c/cCKln5wJTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBDNKijGHBLPCth0sfwAjfl/gBAaPsfvzZQ/Umgjy1n+im0s]'</span></span></code> </pre> <br><p>  Ensuite, le mot de passe pour le r√¥le <code>kicker</code> viendra, sera d√©chiffr√© et appliqu√© sur le serveur de base de donn√©es dans PostgreSQL. </p><br><p>  En fait, c'est tout.  Oui, l'exemple s'est av√©r√© √©norme, mais, je l'esp√®re, fonctionnel, ne laissant pas de questions, clair et utile.  La hi√©rarchie r√©sultante dans hiera est la suivante: </p><br><pre> <code class="bash hljs">. ‚îú‚îÄ‚îÄ db.yaml ‚îú‚îÄ‚îÄ docker.yaml ‚îú‚îÄ‚îÄ frontend.yaml ‚îî‚îÄ‚îÄ tiers ‚îú‚îÄ‚îÄ dev ‚îÇ ‚îú‚îÄ‚îÄ db.yaml ‚îÇ ‚îî‚îÄ‚îÄ frontend.yaml ‚îú‚îÄ‚îÄ prod ‚îÇ ‚îî‚îÄ‚îÄ db.yaml ‚îî‚îÄ‚îÄ prod.yaml 3 directories, 7 files</code> </pre> <br><p>  Vous pouvez regarder ces fichiers en direct en clonant un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> sp√©cialement cr√©√© </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  La marionnette est bonne et facile √† utiliser avec hiera.  Je ne dirais pas que c'est un outil de configuration id√©al dans le monde moderne, pas du tout, mais il m√©rite l'attention.  Il g√®re tr√®s bien certaines t√¢ches, et sa ¬´philosophie¬ª de maintien d'un √©tat de ressources et de configuration constamment identique peut jouer un r√¥le important pour garantir la s√©curit√© et l'uniformit√© des configurations. </p><br><p>  Le monde moderne se synergise et se d√©veloppe progressivement.  Peu de gens utilisent d√©sormais un seul syst√®me de configuration, souvent dans l'arsenal des d√©veloppeurs et des administrateurs, il existe plusieurs syst√®mes √† la fois.  Et c'est bien, car il y a beaucoup de choix.  L'essentiel est que tout soit logique et compr√©hensible, comment et o√π il peut √™tre configur√©. </p><br><p>  En cons√©quence, notre objectif en tant qu'administrateurs est de ne rien configurer nous-m√™mes.  Tout cela devrait id√©alement √™tre fait par les √©quipes elles-m√™mes.  Et nous devons leur donner un outil ou un produit qui nous permet de le faire en toute s√©curit√©, facilement et, surtout, avec un r√©sultat pr√©cis.  Eh bien, et aidez √† r√©soudre des probl√®mes architecturaux et plus graves que "Vous devez installer PostgreSQL sur le serveur et cr√©er un utilisateur."  Camon, 2018 est dans la cour! <del>  Alors lancez marionnette et ansible et passez √† un avenir sans serveur. </del></p><br><p>  Avec le d√©veloppement des syst√®mes de cloud, de conteneurisation et d'orchestration des conteneurs, les syst√®mes de gestion de configuration reculent lentement en arri√®re-plan pour les utilisateurs et les clients.  Vous pouvez √©galement cr√©er un cluster de conteneurs √† s√©curit√© int√©gr√©e dans le cloud et conserver vos applications dans des conteneurs avec auto-skelling, sauvegarde, r√©plication, d√©couverte automatique, etc., sans √©crire une seule ligne pour ansible, marionnette, chef, etc.  Vous n'avez rien √† faire (enfin, presque).  En revanche, il y a moins de serveurs de fer √† cause des nuages.  C'est juste que vous n'avez plus besoin de les configurer, cette action est de la responsabilit√© du fournisseur de cloud.  Mais il est peu probable qu'ils utilisent les m√™mes syst√®mes que les mortels ordinaires. </p><br><h4 id="credits">  Cr√©dits </h4><br><p>  Merci: </p><br><ul><li>  Dmitry Tupitsin, Dmitry Loginov, Stepan Fedorov et toute l'√©quipe d'administrateurs syst√®me pour leur aide dans la pr√©paration de cet article </li><li>  Vladimir Legkostupov pour la photo </li><li>  Yana Tabakova pour avoir organis√© tout cela et aid√© √† passer par toutes les √©tapes de la pr√©-publication </li><li>  Nikita Zakharov pour son assistance en mati√®re de licences </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412587/">https://habr.com/ru/post/fr412587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412573/index.html">Ce qui ne va pas avec le retour des Geektimes √† Habr</a></li>
<li><a href="../fr412575/index.html">Chaque ann√©e, la musique pop devient de plus en plus monotone, car les m√™mes personnes la composent</a></li>
<li><a href="../fr412579/index.html">Marvel: Infinity War ou Comment collecter des donn√©es pour votre projet en quelques minutes</a></li>
<li><a href="../fr412581/index.html">De l'√¢ge de pierre √† la Seconde Guerre mondiale: comment les robots sont utilis√©s pour rechercher des artefacts historiques</a></li>
<li><a href="../fr412583/index.html">Nous d√©montons le protocole de la bouilloire Redmond G200S et le connectons au HomeAssistant</a></li>
<li><a href="../fr412589/index.html">25 biblioth√®ques Android divertissantes. Printemps 2018</a></li>
<li><a href="../fr412591/index.html">Construire un jetpack: le 29 mai est le Memorial Day de Wendell Moore</a></li>
<li><a href="../fr412593/index.html">Nouveaux produits, plates-formes et tout-en-un: Webinaires HPE</a></li>
<li><a href="../fr412595/index.html">Rapport 2018 du Club de Rome, chapitre 1.1.2: ¬´Financement¬ª</a></li>
<li><a href="../fr412597/index.html">Jeff Bezos va construire une colonie √† la surface de la lune</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>