<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∂ üö© üíå Plug-in Kubectl-debug para depura√ß√£o nos pods do Kubernetes üî§ üë®üèΩ‚Äç‚öñÔ∏è üë©üèª‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No final do ano passado, o Reddit introduziu um plugin para o kubectl, que ajuda a depurar os pods do cluster Kubernetes - kubectl-debug . Essa ideia ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Plug-in Kubectl-debug para depura√ß√£o nos pods do Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/436112/"><img src="https://habrastorage.org/webt/t4/le/ko/t4lekoyyijply0zcuwy84_3mhay.jpeg"><br><br>  No final do ano passado, o Reddit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">introduziu um</a> plugin para o kubectl, que ajuda a depurar os pods do cluster <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubernetes</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kubectl-debug</a> .  Essa ideia imediatamente pareceu interessante e √∫til para nossos engenheiros, por isso decidimos analisar sua implementa√ß√£o e estamos felizes em compartilhar nossos resultados com os leitores do hubr. <a name="habracut"></a><br><br><h2>  Por que isso √© necess√°rio? </h2><br>  No momento, h√° um s√©rio inconveniente no processo de depura√ß√£o de algo dentro da estrutura dos pods.  O principal objetivo ao montar a imagem do cont√™iner √© <b>minimiz√°-</b> la, ou seja,  fa√ßa o menor tamanho poss√≠vel e contenha o m√≠nimo poss√≠vel de "excesso" no interior.  No entanto, quando se trata de problemas na opera√ß√£o do software final em cont√™ineres ou depura√ß√£o de sua comunica√ß√£o com outros servi√ßos no cluster / fora ... o minimalismo nos engana - porque n√£o h√° <b>nada</b> nos cont√™ineres para o processo real de encontrar problemas.  Como regra, utilit√°rios como netstat / ip / ping / curl / wget etc. n√£o est√£o dispon√≠veis. <br><br>  E muitas vezes tudo termina com o fato de o engenheiro preparar o software necess√°rio diretamente no cont√™iner em execu√ß√£o para "ver" e ver o problema.  √â nesses casos que o plug-in kubectl-debug parecia ser uma ferramenta muito √∫til - porque evita dores urgentes. <br><br>  Com sua ajuda, voc√™ pode <b>iniciar um cont√™iner com todas as ferramentas necess√°rias</b> a bordo no contexto de um <b>pod de</b> problemas <b>com um comando</b> e estudar todos os processos "de fora", estando dentro.  Se voc√™ j√° encontrou a solu√ß√£o de problemas do Kubernetes, isso parece atraente, n√£o √©? <br><br><h2>  O que √© este plugin? </h2><br>  Em termos gerais, a arquitetura desta solu√ß√£o parece um pacote do <b>plug</b> - <b>in</b> para o kubectl e um <b>agente</b> que come√ßa a usar o controlador DaemonSet.  O plug-in serve comandos que come√ßam com <code>kubectl debug ‚Ä¶</code> e interage com agentes nos n√≥s do cluster.  O agente, por sua vez, √© executado na rede host e o host docker.sock √© montado no pod do agente para obter acesso total aos cont√™ineres neste servidor. <br><br>  Assim, ao solicitar o lan√ßamento de um cont√™iner de depura√ß√£o no pod especificado: <br>  existe um processo para identificar o <code>hostIP</code> do <code>hostIP</code> e uma solicita√ß√£o √© enviada ao agente (trabalhando em um host adequado) para iniciar um cont√™iner de depura√ß√£o nos namespaces correspondentes ao pod de destino. <br><br>  Uma vis√£o mais detalhada dessas etapas est√° dispon√≠vel na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto</a> . <br><br><h2>  O que √© necess√°rio para o trabalho? </h2><br>  O autor do kubectl-debug afirma ser compat√≠vel com as vers√µes do cliente / cluster <b>Kubernetes 1.12.0+</b> , no entanto, eu tinha o K8s 1.10.8 em m√£os, no qual tudo funcionava sem problemas vis√≠veis ... com uma √∫nica nota: para a equipe de <code>kubectl debug</code> do <code>kubectl debug</code> trabalhar neste formul√°rio, a vers√£o do <b>kubectl √©</b> exatamente <b>1.12+</b> .  Caso contr√°rio, todos os comandos s√£o semelhantes, mas s√£o chamados apenas atrav√©s do <code>kubectl-debug ‚Ä¶</code> <br><br>  Ao iniciar o modelo DaemonSet descrito em <code>README</code> n√£o se esque√ßa da mancha usada nos n√≥s: sem as toler√¢ncias apropriadas, os pods do agente n√£o ser√£o instalados l√° e, como resultado, voc√™ n√£o poder√° usar os pods que vivem nesses n√≥s pode se conectar com um depurador. <br><br>  A Ajuda do depurador √© muito abrangente e parece descrever todas as possibilidades atuais para iniciar / configurar o plug-in.  Em geral, o utilit√°rio agrada a um grande n√∫mero de diretivas a serem executadas: voc√™ pode anexar certificados, especificar o contexto do kubectl, especificar uma configura√ß√£o separada do kubectl ou o endere√ßo do servidor da API do cluster e muito mais. <br><br><h2>  Trabalhar com um depurador </h2><br>  A instala√ß√£o at√© o momento ‚Äútudo funciona‚Äù √© reduzida para duas etapas: <br><br><ol><li>  execute o <code>kubectl apply -f agent_daemonset.yml</code> ; </li><li>  instale diretamente o pr√≥prio plug-in - em geral, tudo √© como descrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </li></ol><br>  Como us√°-lo?  Suponha que tenhamos o seguinte problema: as m√©tricas de um dos servi√ßos no cluster n√£o s√£o coletadas - e queremos verificar se h√° problemas de rede entre o Prometheus e o servi√ßo de destino.  Como voc√™ pode imaginar, a imagem do Prometheus n√£o possui as ferramentas necess√°rias. <br><br>  Vamos tentar conectar-se ao cont√™iner com o Prometheus (se houver v√°rios cont√™ineres no pod, voc√™ precisar√° especificar qual deles se conectar, caso contr√°rio, o depurador selecionar√° o primeiro por padr√£o): <br><br><pre> <code class="plaintext hljs">kubectl-debug --namespace kube-prometheus prometheus-main-0 Defaulting container name to prometheus. pulling image nicolaka/netshoot:latest... latest: Pulling from nicolaka/netshoot 4fe2ade4980c: Already exists ad6ddc9cd13b: Pull complete cc720038bf2b: Pull complete ff17a2bb9965: Pull complete 6fe9f5dade08: Pull complete d11fc7653a2e: Pull complete 4bd8b4917a85: Pull complete 2bd767dcee18: Pull complete Digest: sha256:897c19b0b79192ee5de9d7fb40d186aae3c42b6e284e71b93d0b8f1c472c54d3 Status: Downloaded newer image for nicolaka/netshoot:latest starting debug container... container created, open tty... [1] ‚Üí root @ /</code> </pre> <br>  Anteriormente, descobrimos que o servi√ßo problem√°tico fica no endere√ßo 10.244.1.214 e escuta na porta 8080. Naturalmente, tamb√©m podemos verificar a disponibilidade dos hosts, no entanto, para um processo de depura√ß√£o confi√°vel, essas opera√ß√µes devem ser reproduzidas em condi√ß√µes id√™nticas (ou o mais pr√≥ximas poss√≠vel).  Portanto, a verifica√ß√£o de um pod / cont√™iner com o Prometheus √© a melhor op√ß√£o.  Vamos come√ßar com um simples: <br><br><pre> <code class="plaintext hljs"> [1] ‚Üí ping 10.244.1.214 PING 10.244.1.214 (10.244.1.214) 56(84) bytes of data. 64 bytes from 10.244.1.214: icmp_seq=1 ttl=64 time=0.056 ms 64 bytes from 10.244.1.214: icmp_seq=2 ttl=64 time=0.061 ms 64 bytes from 10.244.1.214: icmp_seq=3 ttl=64 time=0.047 ms 64 bytes from 10.244.1.214: icmp_seq=4 ttl=64 time=0.049 ms ^C --- 10.244.1.214 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 61ms rtt min/avg/max/mdev = 0.047/0.053/0.061/0.007 ms</code> </pre> <br>  Est√° tudo bem.  Talvez a porta esteja indispon√≠vel? <br><br><pre> <code class="plaintext hljs"> [1] ‚Üí curl -I 10.244.1.214:8080 HTTP/1.1 200 OK Date: Sat, 12 Jan 2019 14:01:29 GMT Content-Length: 143 Content-Type: text/html; charset=utf-8</code> </pre> <br>  E n√£o h√° problema.  Em seguida, verificaremos se a comunica√ß√£o real entre o Prometheus e o terminal com m√©tricas ocorre: <br><br><pre> <code class="plaintext hljs"> [2] ‚Üí tcpdump host 10.244.1.214 tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes 14:04:19.234101 IP prometheus-main-0.prometheus-operated.kube-prometheus.svc.cluster.local.36278 &gt; 10.244.1.214.8080: Flags [P.], seq 4181259750:4181259995, ack 2078193552, win 1444, options [nop,nop,TS val 3350532304 ecr 1334757657], length 245: HTTP: GET /metrics HTTP/1.1 14:04:19.234158 IP 10.244.1.214.8080 &gt; prometheus-main-0.prometheus-operated.kube-prometheus.svc.cluster.local.36278: Flags [.], ack 245, win 1452, options [nop,nop,TS val 1334787600 ecr 3350532304], length 0 14:04:19.290904 IP 10.244.1.214.8080 &gt; prometheus-main-0.prometheus-operated.kube-prometheus.svc.cluster.local.36278: Flags [P.], seq 1:636, ack 245, win 1452, options [nop,nop,TS val 1334787657 ecr 3350532304], length 635: HTTP: HTTP/1.1 200 OK 14:04:19.290923 IP prometheus-main-0.prometheus-operated.kube-prometheus.svc.cluster.local.36278 &gt; 10.244.1.214.8080: Flags [.], ack 636, win 1444, options [nop,nop,TS val 3350532361 ecr 1334787657], length 0 ^C 4 packets captured 4 packets received by filter 0 packets dropped by kernel</code> </pre> <br>  Pedidos de respostas v√™m.  Com base nos resultados dessas opera√ß√µes, podemos concluir que n√£o h√° problemas no n√≠vel de intera√ß√£o da rede, o que significa (provavelmente) que voc√™ precisa procurar pelo lado aplicado.  N√≥s nos conectamos ao cont√™iner com o exportador (tamb√©m, √© claro, usando o depurador em quest√£o, porque os exportadores sempre t√™m imagens extremamente minimalistas) e ... ficamos surpresos ao descobrir que h√° um problema na configura√ß√£o do servi√ßo - por exemplo, esquecemos de direcionar o exportador para o correto Endere√ßo do Aplicativo de Destino  <b>O caso est√° resolvido!</b> <br><br>  Obviamente, outras formas de depura√ß√£o s√£o poss√≠veis na situa√ß√£o descrita aqui, mas as deixaremos fora do escopo do artigo.  O resultado √© que o kubectl-debug tem muitas oportunidades de uso: voc√™ pode executar qualquer imagem no trabalho e, se desejar, pode at√© montar uma espec√≠fica (com o conjunto de ferramentas necess√°rio). <br><br>  Que outras aplica√ß√µes v√™m imediatamente √† sua mente? <br><br><ul><li>  Um aplicativo "silencioso", para o qual desenvolvedores <s>prejudiciais</s> n√£o implementaram o log normal.  Mas ele tem a capacidade de conectar-se √† porta de servi√ßo e depurar com uma ferramenta espec√≠fica, que, √© claro, n√£o deve ser colocada na imagem final. </li><li>  Inicie pr√≥ximo ao aplicativo de combate id√™ntico no modo ‚Äúmanual‚Äù, mas com a depura√ß√£o ativada - para verificar a intera√ß√£o com os servi√ßos vizinhos. </li></ul><br>  Em geral, √© √≥bvio que existem muito mais situa√ß√µes em que essa ferramenta pode ser √∫til.  Os engenheiros que os encontram no trabalho todos os dias poder√£o avaliar o potencial da empresa em termos de depura√ß√£o "ao vivo". <br><br><h2>  Conclus√µes </h2><br>  O Kubectl-debug √© uma ferramenta √∫til e promissora.  Obviamente, existem clusters e aplicativos do Kubernetes para os quais n√£o faz muito sentido, mas ainda existem casos mais prov√°veis ‚Äã‚Äãem que ele fornecer√° assist√™ncia valiosa na depura√ß√£o - especialmente se se tratar do ambiente de combate e da necessidade de encontrar rapidamente os motivos, aqui e agora o problema que voc√™ encontrou. <br><br>  A primeira experi√™ncia de uso revelou uma necessidade urgente da capacidade de conectar-se a um pod / cont√™iner, que n√£o inicia at√© o fim (por exemplo, trava no <code>CrashLoopbackOff</code> ), apenas para verificar <code>CrashLoopbackOff</code> os motivos do aplicativo n√£o iniciar.  Nesta ocasi√£o, criei um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">problema correspondente</a> no reposit√≥rio do projeto, ao qual o desenvolvedor respondeu positivamente e prometeu a implementa√ß√£o em um futuro pr√≥ximo.  Muito satisfeito com o feedback r√°pido e adequado.  Por isso, aguardamos ansiosamente novos recursos do utilit√°rio e seu desenvolvimento adicional! <br><br><h2>  PS </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ferramentas para desenvolvedores de aplicativos em execu√ß√£o no Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dicas e truques do Kubernetes: acesso a sites de desenvolvimento</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubebox e outros shells de console para o Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o ao loghouse - um sistema de c√≥digo aberto para trabalhar com logs no Kubernetes</a> ‚Äù; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Monitoramento e Kubernetes (revis√£o e relat√≥rio de v√≠deo)</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt436112/">https://habr.com/ru/post/pt436112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt436100/index.html">Falta apenas um ano para o final do suporte gratuito ao Windows 7</a></li>
<li><a href="../pt436104/index.html">Dodocode ou como os conceitos de "palavra de c√≥digo" e "c√≥digo de confirma√ß√£o digital" s√£o confundidos no sistema de trabalho via SMS</a></li>
<li><a href="../pt436106/index.html">De onde v√™m os textos: um pequeno guia para quem deseja economizar em conte√∫do de SEO</a></li>
<li><a href="../pt436108/index.html">Revis√£o da impressora 3D HP na IMTS 2018</a></li>
<li><a href="../pt436110/index.html">Matem√°ticos provam que polin√¥mios n√£o ajudar√£o a hackear o RSA</a></li>
<li><a href="../pt436116/index.html">PERDIX: um algoritmo para o design autom√°tico de DNA-origami de diferentes geometrias</a></li>
<li><a href="../pt436118/index.html">A experi√™ncia de criar o primeiro rob√¥ no Arduino (ca√ßador de rob√¥s)</a></li>
<li><a href="../pt436120/index.html">O bug dif√≠cil de detectar no LittleBigPlanet</a></li>
<li><a href="../pt436122/index.html">Intel Lakefield: processador h√≠brido Atom + Core em 3D</a></li>
<li><a href="../pt436124/index.html">Lemos coment√°rios sobre Habr√© com conveni√™ncias</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>