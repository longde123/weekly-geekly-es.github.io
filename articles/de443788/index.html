<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆙 🏴󠁧󠁢󠁳󠁣󠁴󠁿 🌽 Die Grundlagen des statischen Routings in Mikrotik RouterOS 👩🏻‍🤝‍👨🏿 ⚕️ 👶🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beim Routing wird der optimale Pfad für die Paketübertragung in TCP / IP-Netzwerken gefunden. Jedes mit einem IPv4-Netzwerk verbundene Gerät enthält P...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die Grundlagen des statischen Routings in Mikrotik RouterOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443788/"><p>  Beim Routing wird der optimale Pfad für die Paketübertragung in TCP / IP-Netzwerken gefunden.  Jedes mit einem IPv4-Netzwerk verbundene Gerät enthält Prozess- und Routing-Tabellen. </p><br><p>  Dieser Artikel ist kein HOWTO, er beschreibt das statische Routing in RouterOS als Beispiel. Ich habe den Rest der Einstellungen absichtlich weggelassen (z. B. srcnat für den Zugriff auf das Internet), daher erfordert das Verständnis dieses Materials ein gewisses Maß an Kenntnissen über Netzwerke und RouterOS. </p><a name="habracut"></a><br><h3 id="kommutaciya-i-marshrutizaciya">  Switching und Routing </h3><br><p><img src="https://habrastorage.org/webt/5v/h7/a2/5vh7a2relrje9g9e5kbonuogsqw.png"></p><br><p>  Beim Switching werden Pakete innerhalb eines Layer2-Segments (Ethernet, ppp, ...) ausgetauscht.  Wenn das Gerät feststellt, dass sich der Paketempfänger im selben Ethernet-Subnetz befindet wie es ist, erkennt es die Mac-Adresse mithilfe des Arp-Protokolls und sendet das Paket direkt unter Umgehung des Routers.  Eine ppp-Verbindung (Punkt-zu-Punkt) kann nur zwei Teilnehmer haben, und das Paket wird immer an dieselbe 0xff-Adresse gesendet. </p><br><p>  Beim Routing werden Pakete zwischen Layer2-Segmenten übertragen.  Wenn das Gerät ein Paket senden möchte, dessen Empfänger sich außerhalb des Ethernet-Segments befindet, überprüft es seine Routing-Tabelle und leitet das Paket an ein Gateway weiter, das weiß, wohin das Paket weiter gesendet werden soll (oder es weiß möglicherweise nicht, dass der ursprüngliche Absender des Pakets dies nicht weiß). </p><br><p>  Der einfachste Weg, einen Router in Betracht zu ziehen, besteht darin, ein Gerät zu verwenden, das mit zwei oder mehr Layer2-Segmenten verbunden ist und Pakete zwischen diesen übertragen kann, um die optimale Route aus der Routing-Tabelle zu bestimmen. </p><br><p>  Wenn Ihnen alles klar ist oder Sie es bereits gewusst haben, lesen Sie weiter.  Ich empfehle anderen dringend, einen kleinen, aber sehr umfassenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel zu</a> lesen. </p><br><h3 id="marshrutizaciya-v-routeros-i-packetflow">  Routing in RouterOS und PacketFlow </h3><br><p>  Fast alle Funktionen im Zusammenhang mit statischem Routing sind im <em>Systempaket</em> enthalten.  Das <em>Routing-</em> Paket bietet Unterstützung für dynamische Routing-Algorithmen (RIP, OSPF, BGP, MME), Routing-Filter und BFD. </p><br><p> Das Hauptmenü zum Konfigurieren des Routings: <code>[IP]-&gt;[Route]</code> .  Komplexe Schemata erfordern möglicherweise eine vorläufige Kennzeichnung von Paketen mit einem Routing-Label in: <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> ( <code>PREROUTING</code> und <code>OUTPUT</code> Ketten). </p><br><p>  Es gibt drei Stellen in PacketFlow, an denen Entscheidungen über das Weiterleiten von IP-Paketen getroffen werden: <br><img src="https://habrastorage.org/webt/pk/ie/mp/pkiempktzjkwz6tcwrnwyl1c1dc.png"></p><br><ol><li>  Vom Router empfangene Routing-Pakete.  In dieser Phase wird entschieden, dass das Paket an den lokalen Prozess gesendet oder weiter an das Netzwerk gesendet wird.  Transitpakete erhalten eine <em>Ausgabeschnittstelle</em> </li><li>  Routing lokaler ausgehender Pakete.  Ausgehende Pakete erhalten eine <em>Ausgabeschnittstelle</em> </li><li>  Ein zusätzlicher Routing-Schritt für ausgehende Pakete ermöglicht es Ihnen, die Routing-Entscheidung in <code>[Output|Mangle]</code> zu ändern. </li></ol><br><ul><li>  Der Paketpfad in den Blöcken 1, 2 hängt von den Regeln in <code>[IP]-&gt;[Route]</code> </li><li>  Der Paketpfad in den Schritten 1, 2 und 3 hängt von den Regeln in <code>[IP]-&gt;[Route]-&gt;[Rules]</code> </li><li>  Der Paketpfad in den Blöcken 1, 3 kann mit <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li></ul><br><h3 id="rib-fib-routing-cache">  RIB, FIB, Routing-Cache </h3><br><p><img src="https://habrastorage.org/webt/fw/jc/ku/fwjckuzqzyxo4udazveb8uhotuq.png"></p><br><p>  <strong>Routing-Informationsbasis</strong> <br>  Die Basis, auf der Routen von dynamischen Routing-Protokollen gesammelt werden, Routen von ppp und dhcp, statische und verbundene Routen.  Diese Datenbank enthält alle Routen mit Ausnahme der vom Administrator gefilterten. </p><br><p>  <em>Konventionell</em> können wir davon ausgehen, dass <code>[IP]-&gt;[Route]</code> RIB anzeigt. </p><br><p>  <strong>Weiterleitungsinformationsbasis</strong> <br><img src="https://habrastorage.org/webt/kt/jn/q1/ktjnq1ebrd0--d9afkseuixtap8.png"></p><br><p>  Die Basis, auf der die besten Routen von RIB verlaufen.  Alle Routen in der FIB sind aktiv und werden zum Weiterleiten von Paketen verwendet.  Wenn die Route inaktiv wird (vom Administrator (System) deaktiviert oder die Schnittstelle, über die das Paket gesendet werden soll, inaktiv ist), wird die Route aus der FIB gelöscht. </p><br><p>  Um eine Entscheidung über das Routing zu treffen, werden die folgenden IP-Paketdaten in der FIB-Tabelle verwendet: </p><br><ul><li>  Quelladresse </li><li>  Zieladresse </li><li>  Quellschnittstelle </li><li>  Routing-Marke </li><li>  ToS (DSCP) </li></ul><br><p>  Der Einstieg in das FIB-Paket umfasst die folgenden Schritte: </p><br><ul><li>  Ist das Paket für den lokalen Router-Prozess ausgelegt? </li><li>  Fällt das Paket unter die PBR-System- oder Benutzerregeln? <br><ul><li>  In diesem Fall wird das Paket an die angegebene Routing-Tabelle gesendet. </li></ul></li><li>  Das Paket wird an die Haupttabelle gesendet </li></ul><br><p>  <em>Konventionell</em> können wir davon ausgehen, dass <code>[IP]-&gt;[Route Active=yes]</code> FIB anzeigt. </p><br><p>  <strong>Routing-Cache</strong> <br>  Der Mechanismus zum Zwischenspeichern von Routen.  Der Router merkt sich, wohin die Pakete gesendet wurden, und wenn es ähnliche gibt (vermutlich von derselben Verbindung), startet er sie auf derselben Route, ohne die FIB einzuchecken.  Der Routen-Cache wird regelmäßig gelöscht. </p><br><p>  Für Administratoren hatte RouterOS nicht die Möglichkeit, den Routing-Cache anzuzeigen und zu verwalten, aber mit ihm können Sie ihn unter <code>[IP]-&gt;[Settings]</code> deaktivieren. </p><br><p>  <em>Dieser Mechanismus wurde aus dem Linux 3.6-Kernel entfernt, aber Kernel 3.3.5 wird weiterhin in RouterOS verwendet. Möglicherweise ist der Routing-Cache einer der Gründe.</em> </p><br><h3 id="dialog-dobavleniya-marshruta">  Dialogfeld "Route hinzufügen" </h3><br><p> <code>[IP]-&gt;[Route]-&gt;[+]</code> <br> <img src="https://habrastorage.org/webt/th/lb/el/thlbel_kvf2gk-s2125imh_z7cg.png"></p><br><ol><li>  Das Subnetz, für das Sie eine Route erstellen möchten (Standard: 0.0.0.0/0) </li><li>  Gateway-IP oder Schnittstelle, an die das Paket gesendet wird (es können mehrere vorhanden sein, siehe ECMP unten) </li><li>  Überprüfen der Gateway-Verfügbarkeit </li><li>  Datensatztyp </li><li>  Entfernung (metrisch) für die Route </li><li>  Routing-Tabelle </li><li>  IP für lokale ausgehende Pakete über diese Route </li><li>  Der Zweck von Scope und Target Scope steht am Ende des Artikels. </li></ol><br><p>  <strong>Routenflaggen</strong> <br><img src="https://habrastorage.org/webt/ai/ro/iv/airoivo1bmk3lgbqj_hivpbjdyc.png"></p><br><ul><li>  X - Die Route wird vom Administrator <code>disabled=yes</code> ( <code>disabled=yes</code> ). </li><li>  A - Die Route wird zum Übertragen von Paketen verwendet. </li><li>  D - Route dynamisch hinzugefügt (BGP, OSPF, RIP, MME, PPP, DHCP, verbunden) </li><li>  C - Das Subnetz ist direkt mit dem Router verbunden </li><li>  S - Statische Route </li><li>  r, b, o, m - Die Route wurde von einem der dynamischen Routing-Protokolle hinzugefügt </li><li>  B, U, P - Filterroute (verwirft Pakete anstatt zu senden) </li></ul><br><h3 id="chto-ukazyvat-v-gateway-ip-adres-ili-interfeys">  Was ist im Gateway anzugeben: IP-Adresse oder Schnittstelle? </h3><br><p>  Das System ermöglicht es Ihnen, beide anzugeben, während es nicht schwört und keine Hinweise gibt, wenn Sie etwas falsch gemacht haben. </p><br><p>  <strong>IP-Adresse</strong> <br>  Die Gateway-Adresse muss über Layer2 zugänglich sein.  Für Ethernet bedeutet dies, dass der Router eine IP-Adresse aus demselben Subnetz auf einer der aktiven Schnittstellen haben muss, für ppp - dass die Gateway-Adresse auf einer der aktiven Schnittstellen als Subnetzadresse aufgeführt ist. <br>  Wenn die Verfügbarkeitsbedingung für Layer2 nicht erfüllt ist, wird die Route als inaktiv betrachtet und fällt nicht in die FIB. </p><br><p>  <strong>Schnittstelle</strong> <br>  Alles ist komplizierter und das Verhalten des Routers hängt von der Art der Schnittstelle ab: </p><br><ul><li>  PPP (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *) Bei der Verbindung wird davon ausgegangen, dass nur zwei Teilnehmer vorhanden sind. Das Paket wird immer zur Übertragung an das Gateway gesendet. Wenn das Gateway erkennt, dass es der Empfänger selbst ist, überträgt es das Paket an seinen lokalen Prozess. <br><img src="https://habrastorage.org/webt/90/-g/xk/90-gxkgtlplrv8sstcs4r70bxx4.png"></li><li>  Ethernet geht davon aus, dass es viele Teilnehmer gibt, und sendet Anforderungen mit der Adresse des Paketempfängers an die Arp-Schnittstelle. Dies ist das erwartete und ganz normale Verhalten für verbundene Routen. <br>  Wenn Sie jedoch versuchen, die Schnittstelle als Route für ein Remote-Subnetz zu verwenden, tritt die folgende Situation auf: Die Route ist aktiv, Ping wird an das Gateway weitergeleitet, erreicht den Empfänger jedoch nicht über das angegebene Subnetz.  Wenn Sie die Schnittstelle über einen Sniffer betrachten, werden Arp-Anforderungen mit Adressen aus einem Remote-Subnetz angezeigt. <br><img src="https://habrastorage.org/webt/62/si/qp/62siqpa8gbtxi-8x4eymxgv19vi.png"></li></ul><br><p><img src="https://habrastorage.org/webt/i6/-n/nb/i6-nnbyrlylq0jk6pqwefb_2qz8.png"></p><br><p>  Versuchen Sie, wann immer möglich, die IP-Adresse als Gateway anzugeben.  Die Ausnahmen sind verbundene Routen (automatisch erstellt) und PPP-Schnittstellen (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *). </p><br><p>  <em>OpenVPN enthält keinen PPP-Header, aber Sie können den Namen der OpenVPN-Schnittstelle verwenden, um die Route zu erstellen.</em> </p><br><h3 id="more-specific-route">  Spezifischere Route </h3><br><p>  Die Grundregel des Routings.  Eine Route, die ein kleineres Subnetz (mit der größten Subnetzmaske) beschreibt, hat eine höhere Priorität bei der Entscheidung über das Paketrouting.  Die Position der Einträge in der Routing-Tabelle hängt nicht mit der Auswahl zusammen - die Grundregel lautet Spezifischer. </p><br><p><img src="https://habrastorage.org/webt/sm/cy/i9/smcyi9gkebkm8iq-yjcbev8-vs0.png"></p><br><p>  Alle Routen aus dem angegebenen Schema sind aktiv (in der FIB), weil  Zeigen Sie auf verschiedene Subnetze und stehen Sie nicht in Konflikt miteinander. </p><br><p>  Wenn eines der Gateways nicht mehr verfügbar ist, wird die zugehörige Route als inaktiv (aus der FIB entfernt) betrachtet und von den verbleibenden Routen nach Paketen gesucht. </p><br><p>  Eine Route mit einem Subnetz von 0.0.0.0/0 hat manchmal eine besondere Bedeutung und wird als „Standardroute“ oder „Gateway des letzten Auswegs“ bezeichnet.  Tatsächlich ist nichts Magisches daran und es enthält einfach alle möglichen IPv4-Adressen, aber diese Namen beschreiben seinen Zweck gut - es gibt ein Gateway an, an das Pakete weitergeleitet werden sollen, für die es keine anderen, genaueren Routen gibt. </p><br><p>  Die maximal mögliche Subnetzmaske für IPv4 ist / 32; diese Route zeigt auf einen bestimmten Host und kann in der Routing-Tabelle verwendet werden. </p><br><p>  <em>Das Verständnis der spezifischeren Route ist für jedes TCP / IP-Gerät von grundlegender Bedeutung.</em> </p><br><h3 id="distance">  Entfernung </h3><br><p>  Entfernungen (oder Metriken) sind für die administrative Filterung von Routen zu einem Subnetz erforderlich, auf das über mehrere Gateways zugegriffen werden kann.  Eine Route mit einer niedrigeren Metrik wird als Priorität betrachtet und befindet sich in der FIB.  Wenn eine Route mit einer niedrigeren Metrik nicht mehr aktiv ist, wird sie in der FIB durch eine Route mit einer höheren Metrik ersetzt. <br><img src="https://habrastorage.org/webt/dz/yz/mh/dzyzmhb2y_fjqpbkbp2juyhfxsi.png"></p><br><p>  Wenn es mehrere Routen zu demselben Subnetz mit derselben Metrik gibt, fügt der Router der FIB-Tabelle nur eine davon hinzu, die von seiner internen Logik geleitet wird. </p><br><p>  Die Metrik kann einen Wert von 0 bis 255 annehmen: <br><img src="https://habrastorage.org/webt/rh/fk/j1/rhfkj1shnnjhqmvwhcc7o0itq8i.png"></p><br><ul><li>  0 - Metrik für verbundene Routen.  Der Abstand 0 kann vom Administrator nicht festgelegt werden </li><li>  1-254 - Dem Administrator zur Verfügung stehende Metriken zum Festlegen von Routen.  Metriken mit einem niedrigeren Wert haben Vorrang. </li><li>  255 - Dem Administrator zur Verfügung stehende Metrik zum Festlegen von Routen.  Im Gegensatz zu 1-254 bleibt eine Route mit einer Metrik von 255 immer inaktiv und fällt nicht in die FIB </li><li>  Spezielle Metriken.  Von dynamischen Routing-Protokollen empfangene Routen haben Standardmetrikwerte </li></ul><br><h3 id="check-gateway">  Überprüfen Sie das Gateway </h3><br><p>  Gateway überprüfen - MikroTik RoutesOS-Erweiterung zur Überprüfung der Gateway-Verfügbarkeit über icmp oder arp.  Alle 10 Sekunden (kann nicht geändert werden) wird eine Anfrage an das Gateway gesendet. Wenn die Antwort nicht zweimal eingeht, wird die Route als nicht verfügbar betrachtet und aus der FIB entfernt.  Wenn das Prüfgateway die Überprüfungsroute deaktiviert hat, wird sie fortgesetzt und die Route wird nach einer erfolgreichen Prüfung wieder aktiv. <br><img src="https://habrastorage.org/webt/a_/km/vd/a_kmvd8xeoeyrnjqz78ciry1ja4.png"></p><br><p>  Check Gateway deaktiviert den Eintrag, in dem es konfiguriert ist, und alle anderen Einträge (in allen Routing-Tabellen und ecmp-Routen) mit dem angegebenen Gateway. </p><br><p>  Im Allgemeinen funktioniert das Überprüfen des Gateways einwandfrei, wenn kein Problem mit dem Paketverlust zum Gateway vorliegt.  Check Gateway weiß nicht, was mit der Kommunikation außerhalb des überprüften Gateways passiert. Hierfür werden zusätzliche Tools benötigt: Skripte, rekursives Routing, dynamische Routing-Protokolle. </p><br><p>  Die meisten VPNs und Tunneling-Protokolle enthalten integrierte Tools zum Überprüfen der Verbindungsaktivität. Das Aktivieren des Check-Gateways für sie ist eine zusätzliche (aber sehr geringe) Belastung für die Netzwerk- und Geräteleistung. </p><br><h3 id="ecmp-marshruty">  ECMP-Routen </h3><br><p>  Equal-Cost Multi-Path - Senden von Paketen an den Empfänger über mehrere Gateways gleichzeitig mit dem Round Robin-Algorithmus. </p><br><p>  Eine ECMP-Route wird vom Administrator erstellt, indem mehrere Gateways für ein Subnetz angegeben werden (oder automatisch, wenn zwei OSPF-äquivalente Routen vorhanden sind). <br><img src="https://habrastorage.org/webt/4v/gz/yh/4vgzyh240kmasdj186yz2c3ovws.png"></p><br><p>  ECMP wird verwendet, um die Last zwischen zwei Kanälen auszugleichen. Wenn sich in einer ecmp-Route theoretisch zwei Kanäle befinden, sollte der ausgehende Kanal für jedes Paket unterschiedlich sein.  Der Routing-Cache-Mechanismus sendet jedoch Pakete von der Verbindung entlang der Route, zu der das erste Paket gegangen ist. Infolgedessen erhalten wir eine Art Lastausgleich pro Verbindung. </p><br><p>  Wenn Sie den Routing-Cache deaktivieren, werden die Pakete in der ECMP-Route korrekt aufgeteilt, es liegt jedoch ein Problem mit NAT vor.  Die NAT-Regel verarbeitet nur das erste Paket von der Verbindung (der Rest wird automatisch verarbeitet), und die Situation besteht darin, dass Pakete mit einer Quelladresse von verschiedenen Schnittstellen stammen. <br><img src="https://habrastorage.org/webt/gj/cw/bl/gjcwblj73dmsczyhyqyuchcpdw0.png"></p><br><p>  Überprüfen Sie, ob das Gateway (RouterOS-Fehler) in ECMP-Routen nicht funktioniert.  Sie können diese Einschränkung jedoch umgehen, wenn Sie zusätzliche Routen zur Überprüfung erstellen, wodurch Einträge in ECMP deaktiviert werden. </p><br><h3 id="filtraciya-sredstvami-routing">  Routing-Filterung </h3><br><p>  Die Option Typ bestimmt, was mit dem Paket geschehen soll: </p><br><ul><li>  Unicast - an das angegebene Gateway (Schnittstelle) senden </li><li>  Schwarzes Loch - lassen Sie das Paket fallen </li><li>  Verbieten, nicht erreichbar - Verwerfen Sie das Paket und senden Sie eine ICMP-Nachricht an den Absender </li></ul><br><p>  Das Filtern wird normalerweise verwendet, wenn Sie das Senden von Paketen auf die falsche Weise sichern müssen. Natürlich können Sie dies durch eine Firewall filtern. </p><br><h3 id="para-primerov">  Ein paar Beispiele </h3><br><p>  Zur Behebung grundlegender Probleme beim Routing. </p><br><p>  <strong>Typischer Heimrouter</strong> <br><img src="https://habrastorage.org/webt/2a/fk/xx/2afkxxlv7lhluitqufsybt3s5pg.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1</code> </pre> <br><ol><li>  Statische Route zu 0.0.0.0/0 (Standardroute) </li><li>  Verbundene Route auf der Schnittstelle mit dem Anbieter </li><li>  Verbundene Route auf der LAN-Schnittstelle </li></ol><br><p>  <strong>Typischer PPPoE-Heimrouter</strong> <br><img src="https://habrastorage.org/webt/im/wn/8p/imwn8pafrqins6erowkhiek2dqa.png"></p><br><ol><li>  Statische Route zur Standardroute, seitdem automatisch hinzugefügt  Dies ist in den Verbindungseigenschaften angegeben </li><li>  Verbundene Route für PPP-Verbindung </li><li>  Verbundene Route auf der LAN-Schnittstelle </li></ol><br><p>  <strong>Typischer Heimrouter mit zwei Anbietern und Redundanz</strong> <br><img src="https://habrastorage.org/webt/wq/2a/v0/wq2av0eskridghrj9yroknjz76o.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 distance=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><ol><li>  Statische Route zur Standardroute durch den ersten Anbieter mit Metrik 1 und Überprüfung der Verfügbarkeit des Gateways </li><li>  Statische Route zur Standardroute durch den zweiten Anbieter mit Metrik 2 </li><li>  Verbundene Routen </li></ol><br><p>  Der Datenverkehr zu 0.0.0.0/0 läuft über 10.10.10.1, während dieses Gateway verfügbar ist, andernfalls wechselt es zu 10.20.20.1 </p><br><p>  <em>Ein solches Schema kann als Kanalreservierung angesehen werden, ist jedoch nicht ohne Nachteile.</em>  <em>Wenn eine Unterbrechung außerhalb des Gateways des Anbieters auftritt (z. B. innerhalb des Carrier-Netzwerks), weiß Ihr Router nichts davon und betrachtet die Route weiterhin als aktiv.</em> </p><br><p>  <strong>Typischer Heimrouter mit zwei Anbietern, Redundanz und ECMP</strong> <br><img src="https://habrastorage.org/webt/un/fj/aw/unfjawyzmjdzo6_ekmmg93vlsk8.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1,10.20.20.1 distance=1</code> </pre> <br><ol><li>  Statische Routen zum Überprüfen des Chack-Gateways </li><li>  ECMP-Route </li><li>  Verbundene Routen </li></ol><br><p>  Routen zur Überprüfung von Blau (die Farbe inaktiver Routen), die jedoch den Betrieb des Überprüfungsgateways nicht beeinträchtigen.  In der aktuellen Version (6.44) RoS wird der ECMP-Route automatisch Priorität eingeräumt. Es ist jedoch besser, Testrouten zu anderen Routing-Tabellen hinzuzufügen (Option <code>routing-mark</code> ). </p><br><p>  Auf Speedtest und anderen ähnlichen Sites wird die Geschwindigkeit nicht erhöht (ECMP teilt den Datenverkehr eher durch Verbindungen als durch Pakete), aber P2P-Anwendungen sollten schneller geladen werden. </p><br><p>  <strong>Filtern durch Routing</strong> <br><img src="https://habrastorage.org/webt/gv/bj/nh/gvbjnhvblrebv9051hd_x8adklo.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 add dst-address=192.168.200.0/24 gateway=10.30.30.1 distance=1 add dst-address=192.168.200.0/24 gateway=10.10.10.1 distance=2 type=blackhole</code> </pre> <br><ol><li>  Statische Route zur Standardroute </li><li>  Statische Route zum 192.168.200.0/24 über den IPip-Tunnel </li><li>  Verbieten der statischen Route zu 192.168.200.0/24 über den Router des Anbieters </li></ol><br><p>  Eine Filteroption, bei der der Tunnelverkehr nicht zum Router des Anbieters geleitet wird, wenn die IPIP-Schnittstelle deaktiviert ist.  Solche Schemata sind selten erforderlich, weil  Es ist möglich, das Blockieren durch eine Firewall zu implementieren. </p><br><p>  <strong>Routing-Schleife</strong> <br>  Eine Routing-Schleife ist eine Situation, in der ein Paket zwischen Routern ausgeführt wird, bevor ttl abläuft.  Normalerweise ist es eine Folge eines Konfigurationsfehlers, in großen Netzwerken wird es durch die Implementierung dynamischer Routing-Protokolle behandelt, in kleinen Netzwerken - vorsichtig. </p><br><p>  Es sieht ungefähr so ​​aus: <br><img src="https://habrastorage.org/webt/ii/h8/-v/iih8-vpacnim4b6flslcvy-v0eg.png"></p><br><p>  Beispiel (am einfachsten), wie man ein ähnliches Ergebnis erzielt: <br><img src="https://habrastorage.org/webt/ky/9v/gv/ky9vgvnxvno8x79cbu79be0_buu.png"></p><br><p>  Das Beispiel für eine Routing-Schleife hat keine praktische Verwendung, zeigt jedoch, dass Router keine Ahnung von der Routing-Tabelle ihrer Nachbarn haben. </p><br><h3 id="policy-base-routing-i-dopolnitelnye-tablicy-marshrutizacii">  Richtlinienbasis-Routing und zusätzliche Routing-Tabellen </h3><br><p>  Bei der Auswahl einer Route verwendet der Router nur ein Feld aus dem Paket-Header (Dst. Adresse) - dies ist das grundlegende Routing.  Routing basierend auf anderen Bedingungen wie Quelladresse, Verkehrstyp (ToS), Ausgleich ohne ECMP bezieht sich auf Policy Base Routing (PBR) und verwendet zusätzliche Routing-Tabellen. </p><br><p><img src="https://habrastorage.org/webt/cf/31/fj/cf31fjsrsjd2aszbzkl_hmg9wuw.png"></p><br><p>  <em>Spezifischere Route</em> ist die Grundregel für die Auswahl einer Route innerhalb einer Routing-Tabelle. </p><br><p>  Standardmäßig werden alle Routing-Regeln zur Haupttabelle hinzugefügt.  Ein Administrator kann eine beliebige Anzahl zusätzlicher Routing-Tabellen erstellen und Pakete an diese weiterleiten.  Regeln in verschiedenen Tabellen stehen nicht in Konflikt miteinander.  Wenn das Paket in der angegebenen Tabelle keine geeignete Regel findet, wird es in die Haupttabelle verschoben. </p><br><p>  Verteilungsbeispiel über Firewall: <br><img src="https://habrastorage.org/webt/uw/nd/jz/uwndjzt8mtfett8l84vg-n65p90.png"></p><br><ul><li>  192.168.100.10 -&gt; 8.8.8.8 <br><ol><li>  Der <em>Datenverkehr</em> von 192.168.100.10 erhält das <em>Via-isp1-Label</em> in <code>[Prerouting|Mangle]</code> </li><li>  In der Routing-Phase wird in der Tabelle <em>via-isp1 eine Route</em> bis 8.8.8.8 gesucht </li><li>  Die Route wird gefunden, der Verkehr wird an das Gateway 10.10.10.1 gesendet </li></ol></li><li>  192.168.200.20 -&gt; 8.8.8.8 <br><ol><li>  Der <em>Datenverkehr</em> vom 192.168.200.20 erhält das <em>Via-isp2-Label</em> in <code>[Prerouting|Mangle]</code> </li><li>  In der Routing <em>-Phase sucht die</em> Tabelle <em>via-isp2 nach</em> einer Route bis 8.8.8.8 </li><li>  Die Route wird gefunden, der Verkehr wird an das Gateway 10.20.20.1 gesendet </li></ol></li><li>  Wenn eines der Gateways (10.10.10.1 oder 10.20.20.1) nicht mehr verfügbar ist, wird das Paket an die Haupttabelle gesendet und sucht dort nach einer geeigneten Route </li></ul><br><h3 id="problemy-terminologii">  Terminologieprobleme </h3><br><p>  RouterOS weist bestimmte Terminologieprobleme auf. <br>  Bei der Arbeit mit Regeln in <code>[IP]-&gt;[Routes]</code> Routing-Tabelle angezeigt, obwohl auf dem Etikett Folgendes angegeben ist: <br><img src="https://habrastorage.org/webt/8i/kh/kh/8ikhkhsxvmlwnh9hd9g-quxnk18.png"></p><br><p>  In <code>[IP]-&gt;[Routes]-&gt;[Rule]</code> ist in der Bedingungsbezeichnung in der Tabellenaktion alles korrekt: <br><img src="https://habrastorage.org/webt/0m/hl/5j/0mhl5jj73m7rfm4rvtb5qwpbix4.png"></p><br><h3 id="kak-otpravit-paket-v-opredelennuyu-tablicu-marshrutizacii">  So senden Sie ein Paket an eine bestimmte Routing-Tabelle </h3><br><p>  RouterOS bietet verschiedene Tools: </p><br><ul><li>  Regeln in <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> </li><li>  Routenbeschriftungen ( <code>action=mark-routing</code> ) in <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li><li>  VRF </li></ul><br><p>  <strong>Regeln <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Regeln werden nacheinander verarbeitet. Wenn das Paket den Bedingungen der Regel entspricht, geht es nicht weiter. </p><br><p>  Mit den Routing-Regeln können Sie die Routing-Funktionen erweitern und sich dabei nicht nur auf die Empfängeradresse, sondern auch auf die Quelladresse und die Schnittstelle verlassen, an die das Paket empfangen wurde. </p><br><p><img src="https://habrastorage.org/webt/hg/ip/py/hgippyt0pgilh0l9zouqqqpbsoe.png"></p><br><p>  Regeln bestehen aus Bedingungen und Aktionen: </p><br><ul><li>  Bedingungen.  Sie wiederholen praktisch die Liste der Zeichen, anhand derer das Paket in der FIB geprüft wird, nur ToS fehlt. </li><li>  Aktionen <br><ul><li>  Lookup - Senden Sie ein Paket an eine Tabelle </li><li>  Nur in Tabelle suchen - Sperren Sie das Paket in der Tabelle. Wenn die Route nicht gefunden wird, wird das Paket nicht in die Haupttabelle verschoben </li><li>  drop - Verwerfen Sie das Paket </li><li>  nicht erreichbar - Löschen Sie das Absender-Benachrichtigungspaket </li></ul></li></ul><br><p>  In der FIB wird der Datenverkehr zu lokalen Prozessen unter Umgehung der Regeln <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : <br><img src="https://habrastorage.org/webt/yk/f4/gt/ykf4gt4ywwzgbklpyzlyulije8k.png"></p><br><p>  <strong>Markierung <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  Mit Routenbezeichnungen können Sie das Gateway für das Paket unter nahezu allen Firewall-Bedingungen festlegen: <br><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><p>  <em>Praktisch, weil nicht alle sinnvoll sind und einige möglicherweise instabil arbeiten.</em> </p><br><p><img src="https://habrastorage.org/webt/6b/_m/om/6b_mom-f6nde0zyuy-mr62asho4.png"></p><br><p>  Es gibt zwei Möglichkeiten, ein Paket zu markieren: </p><br><ul><li>  <em>Routing-Marke</em> sofort setzen </li><li>  Setzen Sie zuerst die <em>Verbindungsmarke</em> , dann basierend auf der <em>Verbindungsmarke</em> die <em>Routingmarke</em> </li></ul><br><p>  In einem Artikel über Firewall schrieb ich, dass die zweite Option vorzuziehen ist, weil  reduziert die CPU-Belastung beim Markieren von Routen - dies ist nicht ganz richtig.  Diese Markierungsmethoden sind nicht immer gleichwertig und werden normalerweise zur Lösung verschiedener Probleme verwendet. </p><br><h3 id="primery-ispolzovaniya">  Anwendungsbeispiele </h3><br><p>  Wir gehen auf Beispiele für die Verwendung von Policy Base Routing ein. Es ist viel einfacher, ihnen zu zeigen, warum dies alles erforderlich ist. </p><br><p>  <strong>MultiWAN und ausgehender Antwortverkehr (Ausgabe)</strong> <br>  Ein häufiges Problem bei der MultiWAN-Konfiguration: Auf Mikrotik kann nur über den "aktiven" Anbieter aus dem Internet zugegriffen werden. <br><img src="https://habrastorage.org/webt/ob/1p/ph/ob1pph0eph9qvz9nqvt759mptiq.png"></p><br><p>  Für den Router spielt es keine Rolle, auf welche IP die Anforderung eingegangen ist. Beim Generieren einer Antwort wird in der Routing-Tabelle nach einer Route gesucht, auf der die Route über isp1 aktiv ist.  Ferner wird ein solches Paket höchstwahrscheinlich auf dem Weg zum Empfänger gefiltert. </p><br><p>  <em>Ein weiterer interessanter Punkt.</em>  <em>Wenn die "einfache" Quelle nat auf der ether1-Schnittstelle konfiguriert ist: <code>/ip fi nat add out-interface=ether1 action=masquerade</code> Paket mit src an das Netzwerk gesendet.</em>  <em>Adresse = 10.10.10.100, was die Situation weiter verschärfen wird.</em> </p><br><p>  Es gibt verschiedene Möglichkeiten, um das Problem zu beheben, für jede sind jedoch zusätzliche Routing-Tabellen erforderlich: <br><img src="https://habrastorage.org/webt/g9/65/vy/g965vychbnzbsksplywfc3npi90.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping distance=1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping distance=2 add dst-address=0.0.0.0/0 gateway=10.10.10.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 routing-mark=over-isp2</code> </pre> <br><p>  <strong>Verwenden von <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Geben Sie die Routing-Tabelle an, die für Pakete mit der angegebenen Quell-IP verwendet wird. <br><img src="https://habrastorage.org/webt/na/lm/b3/nalmb3u0yrde35z0mzdjm1xygr4.png"></p><br><pre> <code class="plaintext hljs">/ip route rule add src-address=10.10.10.100/32 action=lookup-only-in-table table=over-isp1 add src-address=10.20.20.200/32 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>  <em>Sie können <code>action=lookup</code> , aber für lokalen ausgehenden Datenverkehr schließt diese Option Verbindungen von der falschen Schnittstelle vollständig aus.</em> </p><br><ul><li>  Das System generiert ein Antwortpaket mit Src.  Adresse: 10.20.20.200 </li><li>  In der Phase der Routing-Entscheidung (2) wird <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> überprüft und das Paket an die Routing-Tabelle <em>over-isp2</em> gesendet </li><li>  Gemäß der Routing-Tabelle muss das Paket über die ether2-Schnittstelle an das Gateway 10.20.20.1 gesendet werden </li></ul><br><p><img src="https://habrastorage.org/webt/k-/zf/sg/k-zfsgxxdpqbufnwoobbno8d_aq.png"></p><br><p>  Diese Methode erfordert im Gegensatz zur Verwendung der Mangle-Tabelle keinen funktionierenden Connection Tracker. </p><br><p>  <strong>Verwenden von <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  Die Verbindung beginnt mit dem eingehenden Paket, daher markieren wir es ( <code>action=mark-connection</code> ). Für ausgehende Pakete von der markierten Verbindung setzen wir die Routenbezeichnung ( <code>action=mark-routing</code> ). <br><img src="https://habrastorage.org/webt/lg/4v/ni/lg4vni1mt8eteade7mcitz_3s3g.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle #   add chain=input in-interface=ether1 connection-state=new action=mark-connection new-connection-mark=from-isp1 add chain=input in-interface=ether2 connection-state=new action=mark-connection new-connection-mark=from-isp2 #      add chain=output connection-mark=from-isp1 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=output connection-mark=from-isp2 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p> <em>      ip,     <code>dst-address</code>  .</em> </p><br><ul><li>   ether2    .    <code>[INPUT|Mangle]</code>         <em>from-isp2</em> </li><li>      Src. Address: 10.20.20.200 </li><li>   Routing Decision(2)          10.20.20.1   ether1.        <code>[OUTPUT|Filter]</code> </li><li>   <code>[OUTPUT|Mangle]</code>       <em>from-isp2</em>      <em>over-isp2</em> </li><li>   Routing Adjusment(3)             </li><li>            10.20.20.1   ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/rd/mr/qs/rdmrqst9dam9m7r9s4jsnudwdly.png"></p><br><h3 id="multiwan-i-otvetnyy-dst-nat-trafik"> MultiWAN   dst-nat  </h3><br><p>  ,        ( web)             . </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether1 action=dst-nat to-address=192.168.100.100 add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether2 action=dst-nat to-address=192.168.100.100</code> </pre> <br><p>     ,      Firewall Mangle,     : <br><img src="https://habrastorage.org/webt/3w/9i/pq/3w9ipqogda4itpjkpvqbw7ewxrg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting connection-state=new in-interface=ether1 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp1 add chain=prerouting connection-state=new in-interface=ether2 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp2 add chain=prerouting connection-mark=web-input-isp1 in-interface=ether3 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting connection-mark=web-input-isp2 in-interface=ether3 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/fb/qf/np/fbqfnpzfpcshxwzl2ruppyjh5qw.png"><br> <em>    NAT,      .</em> </p><br><h3 id="multiwan-i-ishodyaschie-soedineniya"> MultiWAN    </h3><br><p>    PBR    vpn (  SSTP)     . </p><br><p><img src="https://habrastorage.org/webt/pt/jg/m3/ptjgm36vdijiuvygzwl8csvwg5q.png"></p><br><p>   : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=192.168.100.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 routing-mark=over-isp3 add dst-address=0.0.0.0/0 gateway=192.168.100.1 distance=1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 distance=2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 distance=3</code> </pre> <br><p>  : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output dst-address=10.10.10.100 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp1 passtrough=no add chain=output dst-address=10.10.10.101 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp2 passtrough=no add chain=output dst-address=10.10.10.102 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp3 passtrough=no</code> </pre> <br><p>   NAT,        Src.  Adresse: </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=srcnat out-interface=ether1 action=masquerade add chain=srcnat out-interface=ether2 action=masquerade add chain=srcnat out-interface=ether3 action=masquerade</code> </pre> <br><p> : </p><br><ul><li>     SSTP </li><li>   Routing Decision (2)     ,     main.       Src. Address    ether1 </li><li>  <code>[Output|Mangle]</code>        </li><li>         Routing Adjusment        </li><li>       Src. Address  ether1,   <code>[Nat|Srcnat]</code>       </li></ul><br><p> ,        : <br><img src="https://habrastorage.org/webt/i9/gd/x0/i9gdx0o9s0iqnr4shoxdtfqnh2i.png"></p><br><p> Connection Tracker   <code>[Mangle]</code>  <code>[Srcnat]</code> ,       ,      <code>Replay Dst. Address</code>    NAT: <br><img src="https://habrastorage.org/webt/ps/op/qa/psopqak9ysxfem9lebg7woyizk4.png"></p><br><p>  VPN  (      )         : <br><img src="https://habrastorage.org/webt/s7/nc/jz/s7ncjzninvkxn_a6-p3wdd5ywnw.png"></p><br><p> <strong> </strong> <br>   ,         : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=10.10.10.100 gateway=192.168.100.1 add dst-address=10.10.10.101 gateway=192.168.200.1 add dst-address=10.10.10.102 gateway=192.168.0.1</code> </pre> <br><p>              . ,        vpn      ,     6   <code>[IP]-&gt;[Routes]</code>  <code>type=blackhole</code> .    — 3   <code>[IP]-&gt;[Route]-&gt;[Rules]</code> . </p><br><h3 id="raspredelenie-soedineniy-polzovateley-po-kanalam-svyazi">       </h3><br><p> ,  .      : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2</code> </pre> <br><p> <strong> <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br><img src="https://habrastorage.org/webt/-m/4o/jv/-m4ojve7wspajkjoc00afbpsbru.png"></p><br><pre> <code class="plaintext hljs">/ip route rules add src-address=192.168.100.0/25 action=lookup-only-in-table table=over-isp1 add src-address=192.168.100.128/25 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>action=lookup</code> ,           main     .     —   . </p><br><p> <strong>   <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>     ip .       . <em>  layer7,      ,      ,       .</em> <br><img src="https://habrastorage.org/webt/u8/k5/yi/u8k5yito7_iuseo5cki-nhkaz5o.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address-list=users-over-isp1 dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 add chain=prerouting src-address-list=users-over-isp2 dst-address-type=!local action=mark-routing new-routing-mark=over-isp2</code> </pre> <br><p> ""        <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : </p><br><pre> <code class="plaintext hljs">/ip route rules add routing-mark=over-isp1 action=lookup-only-in-table table=over-isp1 add routing-mark=over-isp2 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>[IP]-&gt;[Firewall]-&gt;[Filter]</code> : </p><br><pre> <code class="plaintext hljs">/ip firewall filter add chain=forward routing-mark=over-isp1 out-interface=!ether1 action=reject add chain=forward routing-mark=over-isp2 out-interface=!ether2 action=reject</code> </pre> <br><p> <strong>  <code>dst-address-type=!local</code></strong> <br>   <code>dst-address-type=!local</code>           (dns, winbox, ssh, ...).       ,          ,   <code>dst-address-table</code> . </p><br><p>     <code>[IP]-&gt;[Route]-&gt;[Rules]</code>   ,      .   ,    FIB    <code>[PREROUTING|Mangle]</code>           main,    .    Routing Rules,            User PBR      . </p><br><p> <strong> <code>[IP]-&gt;[Firewall]-&gt;[Mangle action=route]</code></strong> <br>      <code>[Prerouting|Mangle]</code>            ,    : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address=192.168.100.0/25 action=route gateway=10.10.10.1 add chain=prerouting src-address=192.168.128.0/25 action=route gateway=10.20.20.1</code> </pre> <br><p>  <code>route</code>        ( <code>[IP]-&gt;[Route]-&gt;[Rules]</code> ).          ,    <code>action=route</code>    <code>action=mark-route</code> ,     (    <code>passtrough</code> ),   . <br> <em> wiki            ,               .</em> </p><br><h3 id="dinamicheskaya-balansirovka-na-osnove-ppc">     PPC </h3><br><p> Per Connection Classificator —     ECMP.    ECMP       (ECMP     ,     Routing Cache   ). </p><br><p> PCC  <em> </em>  ip ,    32-     <em></em> .       <em></em>    ,    .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Weitere Details</a> .  ,  . <br><img src="https://habrastorage.org/webt/md/xn/kz/mdxnkzst4p7nxatp2bnvjbrlsoe.png"></p><br><p>    : </p><br><pre> <code class="plaintext hljs">192.168.100.10: 192+168+100+10 = 470 % 3 = 2 192.168.100.11: 192+168+100+11 = 471 % 3 = 0 192.168.100.12: 192+168+100+12 = 472 % 3 = 1</code> </pre> <br><p>      src.address   : <br><img src="https://habrastorage.org/webt/sq/dn/rt/sqdnrtcsgypqle5ftv2rg23xvmg.png"></p><br><pre> <code class="plaintext hljs">#  /ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=3 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=1 routing-mark=over-isp3 #    /ip firewall mangle add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/0 action=mark-connection new-connection-mark=conn-over-isp1 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/1 action=mark-connection new-connection-mark=conn-over-isp2 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/2 action=mark-connection new-connection-mark=conn-over-isp3 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp1 action=mark-routing new-routing-mark=over-isp1 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp2 action=mark-routing new-routing-mark=over-isp2 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp3 action=mark-routing new-routing-mark=over-isp3</code> </pre> <br><p>      : <code>in-interface=br-lan</code> ,    <code>action=mark-routing</code>               . </p><br><h3 id="pereklyuchenie-kanalov-svyazi">    </h3><br><p> Check ping —  ,        IP ,                 ,            ,   check ping          . <br>           BGP,                 . </p><br><p>   ,        ip    ,      ,  google dns: 8.8.8.8. 8.8.4.4.    Mikrotik      . </p><br><p> <strong>    </strong> <br>      Multihop BGP               MikroTik,          check gateway       . </p><br><p>         scope/target scope       : <br><img src="https://habrastorage.org/webt/_m/kz/aw/_mkzawioocf0friubndc9q2pofw.png"></p><br><ol><li>           scope      main      target scope </li><li>     ,        </li><li>   connected        </li></ol><br><p>        ,    : <br><img src="https://habrastorage.org/webt/s4/jo/tv/s4jotv0vsxcofu8pcod2uzugfo4.png"></p><br><ul><li> 1-3  connected    ,       </li><li> 4-6   connected   ""  </li></ul><br><p>        RIB,   FIB    : <code>0.0.0.0/0 via 10.10.10.1 on ether1</code> . </p><br><p> <strong>      </strong> <br><img src="https://habrastorage.org/webt/f1/gd/hj/f1gdhjwli1fqi4yk7i-cfdyf2l0.png"></p><br><p>  Konfiguration: <br><img src="https://habrastorage.org/webt/d8/bb/ae/d8bbaepprp0wswv54ly0ryzphhc.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=8.8.8.8 check-gateway=ping distance=1 target-scope=10 add dst-address=8.8.8.8 gateway=10.10.10.1 scope=10 add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><p>  ,      10.10.10.1: <br><img src="https://habrastorage.org/webt/k6/nq/a9/k6nqa98jmecubjxx8e2zndbclcc.png"></p><br><p> Check gateway          ping'   8.8.8.8,  (   main)    10.10.10.1. </p><br><p>      10.10.10.1  8.8.8.8,    ,   (  ping)  8.8.8.8    10.10.10.1: <br><img src="https://habrastorage.org/webt/hj/v2/tg/hjv2tg5bnkaae2gyr7iunr74kt4.png"></p><br><p>      ether1,    ,    8.8.8.8    : <br><img src="https://habrastorage.org/webt/rt/_d/ad/rt_dadf8--ghn5pmgyg7q1ya258.png"></p><br><p>  ,    NetWatch      8.8.8.8.    NetWatch            .     : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=8.8.8.8 gateway=10.20.20.1 distance=100 type=blackhole</code> </pre> <br><p><img src="https://habrastorage.org/webt/ks/6e/k3/ks6ek3swyj9uyiih0bkbef1i6eu.png"></p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> ,    NetWatch   . </p><br><p>  ,      8.8.8.8       ,       dns    . </p><br><h3 id="para-slov-pro-virtual-routing-and-forwarding-vrf">    Virtual Routing and Forwarding (VRF) </h3><br><p>  VRF         ,        (    MPLS)    L3VPN     : <br><img src="https://habrastorage.org/webt/hk/0l/ep/hk0lep0gncmeajzj1pkp2wix6yk.png"></p><br><p>  VRF  Mikrotik         ,   ip      VRF,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> . </p><br><p>   vrf: <br><img src="https://habrastorage.org/webt/gl/g8/k8/glg8k8isgjjsgyjodp7-rnqq5fi.png"></p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0</code> </pre> <br><p>     ether2 ,   ping      vrf (  ),   ping    : <br><img src="https://habrastorage.org/webt/pz/a7/h_/pza7h_xts_jyk6czos89h47q45u.png"></p><br><p>            main (  vrf   route leaking): <br><img src="https://habrastorage.org/webt/on/p-/5z/onp-5z4cvah-erroi_flwnjn2ik.png"></p><br><pre> <code class="plaintext hljs">/ip route add distance=1 gateway=172.17.0.1@main routing-mark=vrf1 add distance=1 gateway=172.17.0.1%wlan1 routing-mark=vrf2</code> </pre> <br><p> <em>    route leaking:   : <code>172.17.0.1@main</code>    : <code>172.17.0.1%wlan1</code> .</em> </p><br><p>        <code>[PREROUTING|Mangle]</code> : <br><img src="https://habrastorage.org/webt/ge/w3/pa/gew3paz7vdzqkzc0-pt0mz5b6yg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting in-interface=ether1 action=mark-connection new-connection-mark=from-vrf1 passthrough=no add chain=prerouting connection-mark=from-vrf1 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting in-interface=ether2 action=mark-connection new-connection-mark=from-vrf2 passthrough=no add chain=prerouting connection-mark=from-vrf2 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/i8/dd/kx/i8ddkxzzdogtht7gvzyo-rzcr-g.png"></p><br><p> <strong>   </strong> <br>            VRF  netmap: <br><img src="https://habrastorage.org/webt/yl/vx/kb/ylvxkbg-tyalsczpx9datttwgs0.png"></p><br><p>  : </p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 add address=192.168.0.1/24 interface=ether3 network=192.168.0.0</code> </pre> <br><p>  firewall: </p><br><pre> <code class="plaintext hljs">#        /ip firewall mangle add chain=prerouting dst-address=192.168.101.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting dst-address=192.168.102.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf2 passthrough=no # netmap   ""     /ip firewall nat add chain=dstnat dst-address=192.168.101.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24 add chain=dstnat dst-address=192.168.102.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">#      route leaking,       connected  /ip route add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf1 add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf2</code> </pre> <br><p> <strong>    dhcp    </strong> <br> VRF   ,       (  dhcp client)    . </p><br><p>    vrf: </p><br><pre> <code class="plaintext hljs">/ip route vrf add interface=ether1 routing-mark=over-isp1</code> </pre> <br><p>     (  )   <em>over-isp1</em> : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output out-interface=!br-lan action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting in-interface=br-lan dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 passthrough=no</code> </pre> <br><p> ,      : </p><br><pre> <code class="plaintext hljs">/interface bridge add name=bare /ip route add dst-address=0.0.0.0/0 gateway=bare</code> </pre> <br><p>            Routing decision (2)  <code>[OUTPUT|Mangle]</code>    ,         0.0.0.0/0   main   . <br><img src="https://habrastorage.org/webt/ff/p-/qh/ffp-qhi41y5wxswp6wzrtp69bjk.png"></p><br><h3 id="cepochki-connected-in-i-dynamic-in-v-routing---filters">  <code>connected-in</code>  <code>dynamic-in</code>  <code>[Routing] -&gt; [Filters]</code> </h3><br><p>   (  ) —           (      <em>routing</em> ),        : </p><br><ul><li> connected-in —  connected  </li><li> dynamic-in —     PPP  DCHP </li></ul><br><p>      ,     : distance, routing-mark, comment, scope, target scope, ... </p><br><p>         -  Routing Filters (  ),    Routing Filters,           .     Routing Filters      . </p><br><p> <strong> Routing Mark   </strong> <br>    .     VPN            .     -      : </p><br><pre> <code class="plaintext hljs">#  vpn    default route    /interface pptp-client add connect-to=XXXX add-default-route=yes default-route-distance=101 ... add connect-to=YYYY add-default-route=yes default-route-distance=100 ... #             /routing filter add chain=dynamic-in distance=100 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn1 add chain=dynamic-in distance=101 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn2</code> </pre> <br><p> <em>  ,  ,    vrf  ppp ,    0.0.0.0/0     main.      .</em> </p><br><p> <strong> Connected </strong> <br>    : </p><br><pre> <code class="plaintext hljs">/route filter add chain=connected-in prefix=192.168.100.0/24 action=reject</code> </pre> <br><h3 id="instrumenty-otladki">   </h3><br><p> RouterOS      : </p><br><ul><li> <code>[Tool]-&gt;[Torch]</code> —      </li><li> <code>/ip route check</code> —        ,      </li><li> <code>/ping routing-table=&lt;name&gt;</code>  <code>/tool traceroute routing-table=&lt;name&gt;</code> — ping       </li><li> <code>action=log</code>  <code>[IP]-&gt;[Firewall]</code> —  ,       packet flow,         </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de443788/">https://habr.com/ru/post/de443788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de443774/index.html">Wie sich die Neurobiologie in US-Präsidentschaftswahlen einmischt</a></li>
<li><a href="../de443776/index.html">China führt ein experimentelles Gesichtserkennungssystem ein, wenn es für die U-Bahn bezahlt</a></li>
<li><a href="../de443780/index.html">MCDM-Projekt. Teil 1. Konzept</a></li>
<li><a href="../de443782/index.html">Entwickler können jetzt die Netzwerk-API von Valve für ihre Steam-Spiele verwenden</a></li>
<li><a href="../de443786/index.html">Analyse des zweiten Android-Quizwettbewerbs vom HeadHunter-Stand auf der Mobius 2018 in Moskau</a></li>
<li><a href="../de443790/index.html">Fehler des Überlebenden</a></li>
<li><a href="../de443792/index.html">Typische Fehler bei der Arbeit mit PostgreSQL. Teil 2</a></li>
<li><a href="../de443794/index.html">Die Hauptrichtungen für IT-Startups im Bereich Immobilienverkäufe</a></li>
<li><a href="../de443798/index.html">Zotero-Hacks: unbegrenzter synchronisierter Speicher und reibungslose Verwendung mit rmarkdown</a></li>
<li><a href="../de443804/index.html">C # ist eine einfache Sprache?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>