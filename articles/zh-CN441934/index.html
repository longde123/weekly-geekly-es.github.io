<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘§ğŸ¼ ğŸ‘¶ğŸ¼ â®ï¸ ä½¿ç”¨Roomçš„7ä¸ªæ­¥éª¤ã€‚ å°†åº”ç”¨ç¨‹åºè¿ç§»åˆ°Roomçš„æ¼”ç»ƒ ğŸ§‘ğŸ½â€ğŸ¤â€ğŸ§‘ğŸ¼ ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦ ğŸ‘¨ğŸ½â€ğŸ’»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Roomæ˜¯ä¸€ä¸ªåº“ï¼Œæ˜¯Android ä½“ç³»ç»“æ„ç»„ä»¶çš„ä¸€éƒ¨åˆ†ã€‚ å®ƒæœ‰åŠ©äºåœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨SQLiteDatabaseå¯¹è±¡ï¼Œä»è€Œå‡å°‘æ ‡å‡†ä»£ç é‡å¹¶åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥SQLæŸ¥è¯¢ã€‚ 


 å·²ç»æœ‰ä¸€ä¸ªä½¿ç”¨SQLiteå­˜å‚¨æ•°æ®çš„Androidé¡¹ç›®ï¼Ÿ å¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™å¯ä»¥å°†å…¶è¿ç§»åˆ°Roomã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡7ä¸ªç®€å•æ­¥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨Roomçš„7ä¸ªæ­¥éª¤ã€‚ å°†åº”ç”¨ç¨‹åºè¿ç§»åˆ°Roomçš„æ¼”ç»ƒ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441934/"><p><img src="https://habrastorage.org/getpro/habr/post_images/810/7f6/165/8107f6165672ecb492fe2ff90d693b05.png" alt="ä½¿ç”¨Roomçš„7ä¸ªæ­¥éª¤ã€‚å°†åº”ç”¨ç¨‹åºè¿ç§»åˆ°Roomçš„æ¼”ç»ƒ"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Room</a>æ˜¯ä¸€ä¸ªåº“ï¼Œæ˜¯Android <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½“ç³»ç»“æ„ç»„ä»¶çš„</a>ä¸€éƒ¨åˆ†ã€‚ å®ƒæœ‰åŠ©äºåœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨<code>SQLiteDatabase</code>å¯¹è±¡ï¼Œä»è€Œå‡å°‘æ ‡å‡†ä»£ç é‡å¹¶åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥SQLæŸ¥è¯¢ã€‚ </p><br><p> å·²ç»æœ‰ä¸€ä¸ªä½¿ç”¨SQLiteå­˜å‚¨æ•°æ®çš„Androidé¡¹ç›®ï¼Ÿ å¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™å¯ä»¥å°†å…¶è¿ç§»åˆ°Roomã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡7ä¸ªç®€å•æ­¥éª¤å°†ç°æœ‰é¡¹ç›®é‡æ„å¹¶é‡æ„ä¸ºä½¿ç”¨Roomã€‚ </p><br><blockquote>  <em><strong>TLï¼› DRï¼š</strong>æ›´æ–°gradleä¾èµ–å…³ç³»ï¼Œåˆ›å»ºæ‚¨çš„å®ä½“ï¼ŒDAOå’Œæ•°æ®åº“ï¼Œç”¨DAOæ–¹æ³•è°ƒç”¨æ›¿æ¢<code>SQLiteDatabase</code>è°ƒç”¨ï¼Œæµ‹è¯•æ‚¨åˆ›å»ºæˆ–ä¿®æ”¹çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶åˆ é™¤æœªä½¿ç”¨çš„ç±»ã€‚</em>  <em>ä»…æ­¤è€Œå·²ï¼</em> </blockquote><a name="habracut"></a><br><p> åœ¨ç”¨äºè¿ç§»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„ç¤ºä¾‹åº”ç”¨ç¨‹åº</a>ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>User</code>ç±»å‹çš„å¯¹è±¡ã€‚ æˆ‘ä»¬ä½¿ç”¨äº§å“å£å‘³æ¥æ¼”ç¤ºå„ç§æ•°æ®çº§åˆ«çš„å®ç°ï¼š </p><br><ol><li>  <code>SQLiteOpenHelper</code>ä½¿ç”¨<code>SQLiteOpenHelper</code>å’Œä¼ ç»Ÿçš„SQLiteæ¥å£ã€‚ </li><li>  room-ç”¨Roomä»£æ›¿å®æ–½å¹¶æä¾›è¿ç§»ã€‚ </li></ol><br><p> æ¯ä¸ªé€‰é¡¹ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ç•Œé¢å±‚ï¼Œè¿™å½’åŠŸäºMVPæ¨¡å¼ï¼Œå¯ä¸<code>UserRepository</code>ç±»ä¸€èµ·ä½¿ç”¨ã€‚ </p><br><p> åœ¨sqliteå˜ä½“ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°å¾ˆå¤šé‡å¤çš„ä»£ç ï¼Œå®ƒä»¬åœ¨<code>UsersDbHelper</code>å’Œ<code>LocalUserDataSource</code>ä½¿ç”¨æ•°æ®åº“ã€‚ ä½¿ç”¨<code>ContentValues</code>æ„å»ºæŸ¥è¯¢ï¼Œå¹¶é€åˆ—è¯»å–<code>Cursor</code>å¯¹è±¡è¿”å›çš„æ•°æ®ã€‚ æ‰€æœ‰è¿™äº›ä»£ç éƒ½ä¼šå¯¼è‡´éšå¼é”™è¯¯çš„å‡ºç°ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è·³è¿‡å‘æŸ¥è¯¢ä¸­æ·»åŠ åˆ—çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥ä¸æ­£ç¡®åœ°ä»æ•°æ®åº“ä¸­ç»„è£…å¯¹è±¡ã€‚ </p><br><p> è®©æˆ‘ä»¬çœ‹çœ‹Roomå¦‚ä½•æ”¹è¿›æˆ‘ä»¬çš„ä»£ç ã€‚ æœ€åˆï¼Œæˆ‘ä»¬åªæ˜¯ä»sqliteå˜ä½“ä¸­å¤åˆ¶ç±»ï¼Œç„¶åé€æ­¥å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚ </p><br><h2 id="shag-1-obnovlenie-zavisimostey-gradle"> æ­¥éª¤1.æ›´æ–°gradleä¾èµ–é¡¹ </h2><br><p> å¯é€šè¿‡æ–°çš„Google Mavenå­˜å‚¨åº“è·å¾—Roomçš„ä¾èµ–å…³ç³»ã€‚ åªéœ€å°†å…¶æ·»åŠ åˆ°ä¸»<code>build.gradle</code>æ–‡ä»¶ä¸­çš„å­˜å‚¨åº“åˆ—è¡¨ä¸­<code>build.gradle</code> ï¼š </p><br><pre> <code class="plaintext hljs">allprojects { repositories { google() jcenter() } }</code> </pre> <br><p> åœ¨åŒä¸€æ–‡ä»¶ä¸­å®šä¹‰Roomåº“çš„ç‰ˆæœ¬ã€‚ è™½ç„¶å®ƒæ˜¯Alphaç‰ˆæœ¬ï¼Œä½†è¯·ç»§ç»­å…³æ³¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¼€å‘äººå‘˜é¡µé¢</a>ä¸Šçš„ç‰ˆæœ¬æ›´æ–°ï¼š </p><br><pre> <code class="plaintext hljs">ext { roomVersion = '2.1.0-alpha03' }</code> </pre> <br><p> åœ¨æ‚¨çš„<code>app/build.gradle</code>æ·»åŠ Roomçš„ä¾èµ–é¡¹ï¼š </p><br><pre> <code class="plaintext hljs">dependencies { implementation â€œandroid.arch.persistence.room:runtime:$rootProject.roomVersionâ€ annotationProcessor â€œandroid.arch.persistence.room:compiler:$rootProject.roomVersionâ€ androidTestImplementation â€œandroid.arch.persistence.room:testing:$rootProject.roomVersionâ€ }</code> </pre> <br><p> ä¸ºäº†è¿ç§»åˆ°Roomï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ æ•°æ®åº“çš„ç‰ˆæœ¬ï¼Œå¹¶ä¿å­˜ç”¨æˆ·æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Migration</a>ç±»ã€‚ ä¸ºäº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æµ‹è¯•è¿ç§»</a> ï¼Œæˆ‘ä»¬éœ€è¦å¯¼å‡ºæ¨¡å¼ã€‚ ä¸ºæ­¤ï¼Œå°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°<code>app/build.gradle</code> ï¼š </p><br><pre> <code class="plaintext hljs">android { defaultConfig { ... // used by Room, to test migrations javaCompileOptions { annotationProcessorOptions { arguments = ["room.schemaLocation": "$projectDir/schemas".toString()] } } } // used by Room, to test migrations sourceSets { androidTest.assets.srcDirs += files("$projectDir/schemas".toString()) } ...</code> </pre> <br><h2 id="shag-2-obnovlenie-klassov-modeli-do-suschnostey"> æ­¥éª¤2.å°†æ¨¡å‹ç±»æ›´æ–°ä¸ºå®ä½“ </h2><br><p>  Roomä¸ºæ¯ä¸ªæ ‡è®°ä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@Entityçš„</a>ç±»åˆ›å»ºä¸€ä¸ªè¡¨ã€‚ ç±»ä¸­çš„å­—æ®µå¯¹åº”äºè¡¨ä¸­çš„åˆ—ã€‚ å› æ­¤ï¼Œå®ä½“ç±»é€šå¸¸æ˜¯ä¸åŒ…å«ä»»ä½•é€»è¾‘çš„æ¨¡å‹çš„å°ç±»ã€‚ æˆ‘ä»¬çš„<code>User</code>ç±»ä»£è¡¨æ•°æ®åº“ä¸­æ•°æ®çš„æ¨¡å‹ã€‚ å› æ­¤ï¼Œè®©æˆ‘ä»¬å¯¹å…¶è¿›è¡Œæ›´æ–°ä»¥å‘Šè¯‰Roomåº”è¯¥åŸºäºæ­¤ç±»åˆ›å»ºè¡¨ï¼š </p><br><ul><li> ç”¨<code>@Entity</code>æ³¨é‡Šç±»ï¼Œå¹¶ä½¿ç”¨<code>tableName</code>å±æ€§è®¾ç½®è¡¨åç§°ã€‚ </li><li> é€šè¿‡å°†<code>@PrimaryKey</code>æ‰¹æ³¨æ·»åŠ åˆ°æ­£ç¡®çš„å­—æ®µæ¥è®¾ç½®ä¸»é”®-åœ¨æœ¬ä¾‹ä¸­ï¼Œè¿™æ˜¯ç”¨æˆ·IDã€‚ </li><li> ä½¿ç”¨<code>@ColumnInfo(name = "column_name")</code>æ‰¹æ³¨æŒ‡å®šç±»å­—æ®µçš„åˆ—å<code>@ColumnInfo(name = "column_name")</code> ã€‚ å¦‚æœæ‚¨çš„å­—æ®µå·²ç»å‘½åï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ï¼Œå› ä¸ºåº”å‘½ååˆ—ã€‚ </li><li> å¦‚æœç±»ä¸­æœ‰å¤šä¸ªæ„é€ å‡½æ•°ï¼Œè¯·æ·»åŠ <code>@Ignore</code>æ‰¹æ³¨ä»¥å‘ŠçŸ¥Roomä½¿ç”¨å“ªä¸ªï¼Œä¸ä½¿ç”¨å“ªä¸ªã€‚ </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(tableName = <span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-meta"><span class="hljs-meta">@ColumnInfo</span></span>(name = <span class="hljs-string"><span class="hljs-string">"userid"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mId; <span class="hljs-meta"><span class="hljs-meta">@ColumnInfo</span></span>(name = <span class="hljs-string"><span class="hljs-string">"username"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mUserName; <span class="hljs-meta"><span class="hljs-meta">@ColumnInfo</span></span>(name = <span class="hljs-string"><span class="hljs-string">"last_update"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Date mDate; <span class="hljs-meta"><span class="hljs-meta">@Ignore</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userName)</span></span></span><span class="hljs-function"> </span></span>{ mId = UUID.randomUUID().toString(); mUserName = userName; mDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(System.currentTimeMillis()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id, String userName, Date date)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mId = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mUserName = userName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mDate = date; } ... }</code> </pre> <br><p>  <strong>æ³¨æ„ï¼š</strong>ä¸ºäº†é¡ºåˆ©è¿ç§»ï¼Œè¯·å¯†åˆ‡æ³¨æ„åŸå§‹å®ç°ä¸­çš„è¡¨å’Œåˆ—çš„åç§°ï¼Œå¹¶ç¡®ä¿åœ¨<code>@Entity</code>å’Œ<code>@ColumnInfo</code>æ­£ç¡®è®¾ç½®å®ƒä»¬ã€‚ </p><br><h2 id="shag-3-sozdanie-obektov-dostupa-k-dannym-dao"> æ­¥éª¤3.åˆ›å»ºæ•°æ®è®¿é—®å¯¹è±¡ï¼ˆDAOï¼‰ </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DAO</a>è´Ÿè´£å®šä¹‰æ•°æ®åº“è®¿é—®æ–¹æ³•ã€‚ åœ¨æˆ‘ä»¬çš„SQLiteé¡¹ç›®çš„æœ€åˆå®ç°ä¸­ï¼Œæ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢éƒ½åœ¨æˆ‘ä»¬ä½¿ç”¨<code>Cursor</code>å¯¹è±¡çš„<code>LocalUserDataSource</code>ç±»ä¸­æ‰§è¡Œã€‚ åœ¨Roomä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸æ¸¸æ ‡ç›¸å…³çš„æ‰€æœ‰ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>UserDao</code>ç±»ä¸­çš„æ³¨é‡Šæ¥ç®€å•åœ°å®šä¹‰æˆ‘ä»¬çš„è¯·æ±‚ã€‚ </p><br><p> ä¾‹å¦‚ï¼Œå½“ä»æ•°æ®åº“æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·æ—¶ï¼ŒRoomä¼šå®Œæˆæ‰€æœ‰â€œè‰°è‹¦çš„å·¥ä½œâ€ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(â€œSELECT * FROM Usersâ€) <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><h2 id="shag-4-sozdanie-bazy-dannyh"> æ­¥éª¤4.åˆ›å»ºæ•°æ®åº“ </h2><br><p> æˆ‘ä»¬å·²ç»å®šä¹‰äº†<code>Users</code>è¡¨åŠå…¶å¯¹åº”çš„æŸ¥è¯¢ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰åˆ›å»ºå°†Roomçš„æ‰€æœ‰è¿™äº›ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·çš„æ•°æ®åº“ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ‰©å±•<code>RoomDatabase</code>çš„æŠ½è±¡ç±»ã€‚ æ­¤ç±»æ ‡è®°ä¸º<code>@Database</code> ï¼Œåˆ—å‡ºäº†æ•°æ®åº“ä¸­åŒ…å«çš„å¯¹è±¡ä»¥åŠè®¿é—®å®ƒä»¬çš„DAOã€‚ ä¸åŸå§‹å€¼ç›¸æ¯”ï¼Œæ•°æ®åº“ç‰ˆæœ¬åº”å¢åŠ 1ï¼Œå› æ­¤åœ¨æœ¬ä¾‹ä¸­ä¸º2ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Database</span></span>(entities = {User.class}, version = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@TypeConverters</span></span>(DateConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UsersDatabase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomDatabase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> UsersDatabase INSTANCE; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> UserDao </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userDao</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><p> ç”±äºæˆ‘ä»¬è¦ä¿å­˜ç”¨æˆ·æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®ç°<code>Migration</code>ç±»ï¼Œä»¥å‘ŠçŸ¥Roomä»ç‰ˆæœ¬1è¿ç§»åˆ°ç‰ˆæœ¬2æ—¶åº”æ‰§è¡Œçš„æ“ä½œã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œç”±äºæ•°æ®åº“æ¶æ„æ²¡æœ‰æ›´æ”¹ï¼Œå› æ­¤æˆ‘ä»¬åªæä¾›ä¸€ä¸ªç©ºçš„å®ç°ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Migration MIGRATION_1_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Migration(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">migrate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SupportSQLiteDatabase database)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,      . } };</span></span></code> </pre> <br><p> é€šè¿‡å®šä¹‰æ•°æ®åº“åç§°å’Œè¿ç§»ï¼Œåœ¨<code>UsersDatabase</code>ç±»ä¸­åˆ›å»ºæ•°æ®åº“å¯¹è±¡ï¼š </p><br><pre> <code class="java hljs">database = Room.databaseBuilder(context.getApplicationContext(), UsersDatabase.class, <span class="hljs-string"><span class="hljs-string">"Sample.db"</span></span>) .addMigrations(MIGRATION_1_2) .build();</code> </pre> <br><p> è¦äº†è§£æœ‰å…³å¦‚ä½•å®æ–½æ•°æ®åº“è¿ç§»ä»¥åŠå®ƒä»¬å¦‚ä½•åœ¨åå°å·¥ä½œçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¬æ–‡</a> ã€‚ </p><br><h2 id="shag-5-obnovlenie-repozitoriya-dlya-ispolzovaniya-room"> æ­¥éª¤5.æ›´æ–°å­˜å‚¨åº“ä»¥ä½¿ç”¨Room </h2><br><p> æˆ‘ä»¬åˆ›å»ºäº†æ•°æ®åº“ï¼Œç”¨æˆ·è¡¨å’ŒæŸ¥è¯¢ï¼Œå› æ­¤ç°åœ¨è¯¥ä½¿ç”¨å®ƒä»¬äº†ã€‚ æ­¤æ—¶ï¼Œæˆ‘ä»¬å°†æ›´æ–°<code>LocalUserDataSource</code>ç±»ä»¥ä½¿ç”¨<code>UserDao</code>æ–¹æ³•ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆæ›´æ–°æ„é€ å‡½æ•°ï¼šåˆ é™¤<code>Context</code>å¹¶æ·»åŠ <code>UserDao</code> ã€‚ å½“ç„¶ï¼Œä»»ä½•åˆ›å»º<code>LocalUserDataSource</code>å®ä¾‹çš„ç±»ä¹Ÿå¿…é¡»æ›´æ–°ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡è°ƒç”¨<code>UserDao</code>æ–¹æ³•æ¥æ›´æ–°è¿›è¡ŒæŸ¥è¯¢çš„<code>LocalUserDataSource</code>æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œç°åœ¨ä¸€ä¸ªè¯·æ±‚æ‰€æœ‰ç”¨æˆ·çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mUserDao.getUsers(); }</code> </pre> <br><p> ç°åœ¨æ˜¯å¯åŠ¨æˆ‘ä»¬æ‰€åšçš„å·¥ä½œçš„æ—¶å€™äº†ã€‚ </p><br><p>  Roomçš„æœ€ä½³åŠŸèƒ½ä¹‹ä¸€æ˜¯ï¼Œå¦‚æœæ‚¨åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºå°†å´©æºƒå¹¶æ˜¾ç¤ºä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š </p><br><pre> <code class="xml hljs">java.lang.IllegalStateException: Cannot access database on the main thread since it may potentially lock the UI for a long period of time.</code> </pre> <br><p> ä»ä¸»çº¿ç¨‹ç§»å‡ºI / Oæ“ä½œçš„ä¸€ç§å¯é æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Runnable</code> ï¼Œå®ƒå°†ä¸ºæ¯ä¸ªæ•°æ®åº“æŸ¥è¯¢åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚ ç”±äºæˆ‘ä»¬å·²ç»åœ¨sqliteå˜ä½“ä¸­ä½¿ç”¨äº†è¿™ç§æ–¹æ³•ï¼Œå› æ­¤æ— éœ€è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚ </p><br><h2 id="shag-6-testirovanie-na-ustroystve"> æ­¥éª¤6.åœ¨è®¾å¤‡ä¸Šæµ‹è¯• </h2><br><p> æˆ‘ä»¬åˆ›å»ºäº†æ–°ç±»<code>UserDao</code>å’Œ<code>UsersDatabase</code>å¹¶æ›´æ”¹äº†<code>LocalUserDataSource</code>ä»¥ä½¿ç”¨Roomæ•°æ®åº“ã€‚ ç°åœ¨æˆ‘ä»¬éœ€è¦æµ‹è¯•å®ƒä»¬ã€‚ </p><br><h3 id="testirovanie-userdao"> æµ‹è¯•UserDao </h3><br><p> è¦æµ‹è¯•<code>UserDao</code> ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»<code>AndroidJUnit4</code> ã€‚  Roomçš„æƒŠäººåŠŸèƒ½æ˜¯å¯ä»¥åœ¨å†…å­˜ä¸­åˆ›å»ºæ•°æ®åº“ã€‚ è¿™æ ·å°±æ— éœ€åœ¨æ¯æ¬¡æµ‹è¯•åè¿›è¡Œæ¸…æ´ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mDatabase = Room.inMemoryDatabaseBuilder( InstrumentationRegistry.getContext(), UsersDatabase.class) .build(); }</code> </pre> <br><p> æˆ‘ä»¬è¿˜éœ€è¦ç¡®ä¿åœ¨æ¯æ¬¡æµ‹è¯•åå…³é—­æ•°æ®åº“è¿æ¥ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@After</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mDatabase.close(); }</code> </pre> <br><p> ä¾‹å¦‚ï¼Œè¦æµ‹è¯•ç”¨æˆ·çš„ç™»å½•åï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦å¯ä»¥ä»æ•°æ®åº“ä¸­è·å–è¯¥ç”¨æˆ·ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertAndGetUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      mDatabase.userDao().insertUser(USER); //        List&lt;User&gt; users = mDatabase.userDao().getUsers(); assertThat(users.size(), is(1)); User dbUser = users.get(0); assertEquals(dbUser.getId(), USER.getId()); assertEquals(dbUser.getUserName(), USER.getUserName()); }</span></span></code> </pre> <br><h3 id="testirovanie-ispolzovaniya-userdao-v-localuserdatasource"> æµ‹è¯•LocalUserDataSourceä¸­UserDaoçš„ä½¿ç”¨ </h3><br><p> ç¡®ä¿<code>LocalUserDataSource</code>ä»èƒ½æ­£å¸¸å·¥ä½œå¾ˆå®¹æ˜“ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰æè¿°æ­¤ç±»è¡Œä¸ºçš„æµ‹è¯•ã€‚ æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œä»ä¸­è·å–ä¸€ä¸ª<code>UserDao</code>å¯¹è±¡ï¼Œå¹¶å°†å…¶ç”¨ä½œ<code>LocalUserDataSource</code>æ„é€ å‡½æ•°çš„å‚æ•°ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mDatabase = Room.inMemoryDatabaseBuilder( InstrumentationRegistry.getContext(), UsersDatabase.class) .build(); mDataSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocalUserDataSource(mDatabase.userDao()); }</code> </pre> <br><p> åŒæ ·ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨æ¯æ¬¡æµ‹è¯•åå…³é—­æ•°æ®åº“ã€‚ </p><br><h3 id="testirovanie-migracii-bazy-dannyh"> æ•°æ®åº“è¿ç§»æµ‹è¯• </h3><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å¯ä»¥é˜…è¯»æœ‰å…³å¦‚ä½•å®æ–½æ•°æ®åº“è¿ç§»æµ‹è¯•ä»¥åŠ<code>MigrationTestHelper</code>å·¥ä½œæ–¹å¼çš„æ›´å¤š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¿¡æ¯</a> ã€‚ </p><br><p> æ‚¨è¿˜å¯ä»¥ä»æ›´è¯¦ç»†çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿ç§»åº”ç”¨ç¨‹åº</a>ç¤ºä¾‹ä¸­æŸ¥çœ‹ä»£ç ã€‚ </p><br><h2 id="shag-7-udalenie-vsego-nenuzhnogo"> æ­¥éª¤7.åˆ é™¤æ‰€æœ‰ä¸å¿…è¦çš„ </h2><br><p> åˆ é™¤ç°åœ¨ç”±RoomåŠŸèƒ½æ›¿æ¢çš„æ‰€æœ‰æœªä½¿ç”¨çš„ç±»å’Œä»£ç è¡Œã€‚ åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ é™¤<code>UsersDbHelper</code>ç±»ï¼Œå³å¯æ‰©å±•<code>SQLiteOpenHelper</code>ç±»ã€‚ </p><br><p> å¦‚æœæ‚¨æœ‰ä¸€ä¸ªæ›´å¤§ï¼Œæ›´å¤æ‚çš„æ•°æ®åº“ï¼Œå¹¶ä¸”æƒ³è¦é€æ­¥åˆ‡æ¢åˆ°Roomï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¨è<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™ç¯‡æ–‡ç« </a> ã€‚ </p><br><p> ç°åœ¨ï¼Œæ ‡å‡†çš„å®¹æ˜“å‡ºé”™çš„ä»£ç æ•°é‡å‡å°‘äº†ï¼Œåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥äº†è¯·æ±‚ï¼Œå¹¶æµ‹è¯•äº†æ‰€æœ‰å†…å®¹ã€‚ é€šè¿‡7ä¸ªç®€å•çš„æ­¥éª¤ï¼Œæˆ‘ä»¬ä¾¿èƒ½å¤Ÿå°†ç°æœ‰åº”ç”¨ç¨‹åºè¿ç§»åˆ°Roomã€‚ æ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>æŸ¥çœ‹ç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN441934/">https://habr.com/ru/post/zh-CN441934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN441916/index.html">è‰°è‹¦çš„ç°å®-è¥¿æ˜Œå«æ˜Ÿå‘å°„ä¸­å¿ƒ-XSLC</a></li>
<li><a href="../zh-CN441918/index.html">æˆ‘ä»¬åœ¨UltraHD Mortyä¸­ï¼ å¦‚ä½•ä»¥4Kè§‚çœ‹ç”µå½±</a></li>
<li><a href="../zh-CN441920/index.html">ä¿¡æ¯å®‰å…¨ç­–ç•¥ï¼šæ‚¨æ˜¯å¦å·²å†³å®šå¦‚ä½•å‰è¿›ï¼Ÿ</a></li>
<li><a href="../zh-CN441928/index.html">åœ¨Openshiftä¸­å¯åŠ¨åº”ç”¨ç¨‹åºå¹¶æ¯”è¾ƒç°æœ‰å·¥å…·</a></li>
<li><a href="../zh-CN441932/index.html">å¦‚ä½•é¢†å…ˆç«äº‰å¯¹æ‰‹ï¼šSIBURå¼€å‘å¢æåˆ¶é€ </a></li>
<li><a href="../zh-CN441938/index.html">é€‚ç”¨äºéŸ©è¯­çš„å…¬å¼ï¼Œæˆ–è€…å¿«é€Ÿï¼Œè½»æ¾ä¸”æ²¡æœ‰é”™è¯¯åœ°è¯†åˆ«éŸ©æ–‡ã€‚</a></li>
<li><a href="../zh-CN441942/index.html">ç ´å-ä¸å»ºè®¾ã€‚ æˆ–ä¸‹æ”¾</a></li>
<li><a href="../zh-CN441944/index.html">ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹©é›·å…‹è¨æ–¯RX450h</a></li>
<li><a href="../zh-CN441946/index.html">100è¡Œä»£ç ä¸­Laravelä¸Šçš„REST API</a></li>
<li><a href="../zh-CN441950/index.html">Eclipse Che 7å·²ç»åœ¨è¿™é‡Œ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>