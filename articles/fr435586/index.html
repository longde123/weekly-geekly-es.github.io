<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç≥ ü§• üßîüèø L'art du chamanisme ou du firmware personnalis√© pour Olinuxino. Noyau et Ubuntu Partie 3 üññüèø üë®‚Äçüë¶‚Äçüë¶ ü§ôüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Assemblage du noyau 
 Je vais expliquer pourquoi les images existantes ne conviennent pas. Leur principal probl√®me est qu'ils sont construits sur l'an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'art du chamanisme ou du firmware personnalis√© pour Olinuxino. Noyau et Ubuntu Partie 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435586/"><h3>  Assemblage du noyau </h3><br>  Je vais expliquer pourquoi les images existantes ne conviennent pas.  Leur principal probl√®me est qu'ils sont construits sur l'ancien noyau 3.4, et cela impose imm√©diatement une limite √† la version maximale du compilateur 4 et √† ubuntu 12.04 pour s√ªr, je ne me souviens pas de 14.04.  Il s'av√®re donc que si vous souhaitez utiliser les derniers logiciels et biblioth√®ques, vous devrez reconstruire le dernier noyau.  Bien s√ªr, vous pouvez supprimer la restriction sur la compilation d'au moins la version 5 de gcc dans les sources et corriger le code afin qu'il puisse √™tre construit sous la version 4, mais c'est toujours une merde.  Sans oublier le fait que dans notre cas la partie graphique de linux est superflue. <br><br>  Pour commencer avec kernel.org, nous pompons le noyau 4.14.57, √† l'√©poque c'√©tait la derni√®re version stable. <br><br>  Dans le dossier source, cr√©ez un script qui d√©marre la configuration: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh make O=../olimex-kernel-4.14.57 #      -j2 #     ARCH=arm #      CROSS_COMPILE=arm-linux-gnueabihf- #   xconfig #  </span></span></code> </pre> <br>  Nous obtenons quelque chose comme √ßa: <br><br><img src="https://habrastorage.org/webt/4i/lp/ho/4ilpho-rpzrzbqsoln6yekylxri.jpeg"><br><a name="habracut"></a><br>  Dans le menu fichier de <code>/linux-4.14.57/arch/arm/configs/</code> s√©lectionnez le fichier <code>/linux-4.14.57/arch/arm/configs/</code> , il y a les param√®tres de base pour les processeurs de la s√©rie sunxi.  Et puis vous devez ajouter des param√®tres.  C'est-√†-dire  Nous recherchons ci-dessous les drapeaux sp√©cifi√©s et les configurons. <br><br>  Nous int√©grons tout dans le noyau chaque fois que possible. <br><br>  CONFIG_BLK_DEV_INITRD - nous n'utiliserons pas de ramfs √† la place, puis nous lancerons Aufs (syst√®me de fichiers d'unification multicouche avanc√©).  Bref, d√©cochez la case. <br>  CONFIG_MEMCG - allumer comme tout √† l'int√©rieur <br>  CONFIG_BLK_CGROUP - allumer <br>  CONFIG_CGROUP_DEVICE - allumer <br>  CONFIG_CGROUP_CPUACCT - allumer <br>  CONFIG_CGROUP_PERF - allumer comme tout √† l'int√©rieur <br>  CONFIG_EXPERT - s√©lectionnez et laissez tout √† l'int√©rieur par d√©faut <br>  CONFIG_BLK_WBT - choisissez comme tout √† l'int√©rieur <br>  CONFIG_PARTITION_ADVANCED - s√©lectionnez l'int√©rieur <br>  CONFIG_SUN_PARTITION - s√©lectionnez <br>  ARCH_SUNXI - √† l'int√©rieur nous ne laissons que MACH_SUN5I <br><br>  Dans la prise en charge du bus, s√©lectionnez CONFIG_PCI, car l'USB wifi n√©cessite la prise en charge du bus PCI.  √âvidemment, lorsque le support wifi est activ√©, le noyau ne n√©cessite pas de bus pci, cependant, sans ce wpa, le demandeur ne trouve pas de wifi usb.  Pourquoi cela se produit, vous pouvez regarder dans les profondeurs de l'histoire, mais √† en juger par tout, cela s'est produit historiquement, en g√©n√©ral, vous devez le savoir et vous en souvenir. <br><br>  CONFIG_CPU_FREQ_STAT - rechercher et s√©lectionner <br>  Dans CONFIG_NET, nous s√©lectionnons WIRELESS puis CONFIG_CFG80211 et l√† nous marquons CONFIG_NL80211_TESTMODE et CONFIG_CFG80211_WEXT ce dernier inclut notre pilote wifi pour le demandeur. <br>  CONFIG_MAC80211 - allumez la pile r√©seau. <br>  CONFIG_MAC80211_MESH - allumer <br>  CONFIG_MAC80211_LED - eh bien, choisissons ceci <br>  CONFIG_NFC - nous incluons aussi bien que ce qui est √† l'int√©rieur sauf CONFIG_NFC_NCI. <br>  CONFIG_PARPORT - activer <br>  CONFIG_LED_TRIGGER_PHY - s√©lectionnez <br>  CONFIG_REALTEK_PHY - s√©lectionnez <br>  CONFIG_WLAN - s√©lectionnez <br>  CONFIG_RTL8XXXU - s√©lectionnez et √† l'int√©rieur de CONFIG_RTL8XXXU_UNTESTED nous marquons. <br>  CONFIG_SERIO_SUN4I_PS2 - allumer <br>  CONFIG_SERIAL_DEV_BUS - allumez-le et s√©lectionnez SERIAL_DEV_CTRL_TTYPORT √† l'int√©rieur. <br>  CONFIG_USB_WUSB_CBAF - activer <br>  CONFIG_USB_WUSB_CBAF_DEBUG - allumer <br>  CONFIG_USB_WDM - allumer <br>  CONFIG_USB_SERIAL - s√©lectionnez <br>  CONFIG_UWB - s√©lectionnez et √† l'int√©rieur s√©lectionnez CONFIG_UWB_HWA et CONFIG_UWB_I1480U et apr√®s cela CONFIG_USB_WUSB appara√Ætra et s√©lectionnez √©galement. <br>  Nous s√©lectionnons CONFIG_STAGING et √† l'int√©rieur nous s√©lectionnons le pilote CONFIG_RTL8192U et CONFIG_RTLLIB, et √† l'int√©rieur du dernier, nous s√©lectionnons √©galement tout.  Ils sont marqu√©s par des modules de po√©sie plus tard ils devront √™tre viss√©s s√©par√©ment. <br>  CONFIG_R8188EU - s√©lectionnez <br><br>  En g√©n√©ral, c'est un minimum n√©cessaire de param√®tres du noyau, si vous voulez soudainement activer quelque chose d'autre, alors lisez attentivement les d√©pendances de ce param√®tre, sinon il y aura une erreur lors de la compilation.  Ensuite, vous devez commencer la compilation: <br><br><pre> <code class="bash hljs">make O=../olimex-kernel-4.14.57/ -j2 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- uImage <span class="hljs-comment"><span class="hljs-comment">#   modules #   LOADADDR=0x40008000 #       </span></span></code> </pre><br>  Dans le m√™me temps, collectez et cr√©ez des fichiers: <br><br><pre> <code class="bash hljs">make O=../olimex-kernel-4.14.57 -j2 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- dtbs</code> </pre><br>  C'est juste au cas o√π, car les fichiers source peuvent √™tre en erreur m√™me s'ils sont les m√™mes dans le noyau et dans uboot.  Par cons√©quent, pas l'un pour que l'autre fonctionne. <br><br>  L'√©tape suivante consiste √† collecter les fichiers collect√©s sur la premi√®re section de la carte SD: <br>  - <code>/olimex-kernel-4.14.57/arch/arm/boot/</code> partir d'ici, nous obtenons le noyau assembl√©, il s'appelle uImage et ne p√®se que 4,7 m√®tres. <br>  - <code>/olimex-uboot/arch/arm/dts/</code> d'ici nous obtenons l'arbre compil√©, fichier sun5i-a13-olinuxino.dtb <br>  - <code>/u-boot-2018.05/</code> partir d'ici, nous obtenons le script de d√©marrage compil√© boot.scr. <br><br><h3>  Build Ubuntu </h3><br>  Puisque toutes les parties n√©cessaires au t√©l√©chargement de rootfs sont pr√©par√©es, il reste √† construire ubuntu et pour cela nous prenons la derni√®re version 18.04. <br><br>  Cr√©ez d'abord un dossier dans le r√©pertoire racine: <br><br><pre> <code class="plaintext hljs">sudo mkdir /destrupt</code> </pre> <br>  Exactement ici, car pour appliquer le chroot plus tard, vous devez disposer des droits complets comme dans le r√©pertoire racine ou enregistrer la configuration du chroot pour tout autre dossier.  En bref, il est plus facile de cr√©er un dossier dans le r√©pertoire racine et ne se trompe pas avec la configuration. <br><br>  Pour l'assemblage, nous avons besoin des packages suivants, ils doivent √™tre fournis sinon: <br>  - Qemu-user-static <br>  - debootstarp <br>  - schroot <br><br>  Ensuite, ex√©cutez la build ubuntu: <br><br>  <code>sudo qemu-debootstrap</code> # nous utilisons qemu car qemu sera install√© avec l'assemblage ubuntu, ce qui vous permettra d'ex√©cuter imm√©diatement chroot sur la version assembl√©e d'ubuntu <br>  <code>--arch armhf</code> # type d'architecture de processeur <br>  <code>--variant=minbase</code> # assembly dans la version minimale <br>  <code>bionic</code> # build version 18.04 <br>  <code>/destrup/</code> # adresse o√π collecter <br>  <code>http://ports.ubuntu.com/ubuntu-ports</code> # o√π collecter les sources <br><br>  Eh bien, que Ubuntu 18.04 est d√©j√† assembl√©, nous allons maintenant proc√©der √† la configuration √©tape par √©tape: <br><br>  1. Avant de commencer, nous montons dans / destrup / etc / apt / et √©ditons sources.list, ajoutez ce qui suit: <br><br><pre> <code class="plaintext hljs">deb http://ports.ubuntu.com/ubuntu-ports bionic main restricted deb http://ports.ubuntu.com/ubuntu-ports bionic universe deb http://ports.ubuntu.com/ubuntu-ports bionic multiverse</code> </pre> <br>  Ce ne sont que des sources de distributions pour notre processeur. <br><br>  2. Ex√©cutez change root sur la nouvelle distribution ubuntu: <br><br><pre> <code class="plaintext hljs">sudo chroot /destrup</code> </pre> <br>  Tout d'abord, d√©finissez le mot de passe de l'utilisateur root: <br><br><pre> <code class="plaintext hljs">passwd root</code> </pre> <br>  Ce mot de passe est requis pour se connecter au d√©marrage. <br><br>  3. Installez les packages suivants. <br><br>  <code>apt update</code> - mise √† jour des packages <br><br>  Nous <code>iputils-ping, dhcpcd5, iproute2, iw, networkd-dispatcher, wireless-tools, net-tools.</code> les packages pour le r√©seau: <code>iputils-ping, dhcpcd5, iproute2, iw, networkd-dispatcher, wireless-tools, net-tools.</code> <br><br>  <code>linux-firmware, wpasupplicant, systemd, hostapd, kmod, udev.</code> syst√®me r√©seau: <code>linux-firmware, wpasupplicant, systemd, hostapd, kmod, udev.</code> <br><br>  Eh bien et le reste pour qu'il soit pratique d'√©diter et de configurer tout cela: nano, mc, usbutils, sudo. <br>  Et je ne d√©crirai pas tout, car cela s‚Äô√©tendra sur quelques articles de plus, nous allons simplement parcourir certains des packages n√©cessaires √† la configuration. <br><br><h3>  Configuration de wpa supplicant. </h3><br>  Pour commencer, nous analyserons bri√®vement ce qu'est le wifi USB. <br><br>  La puce elle-m√™me qui fournit le wifi (dans ce cas rtl8188) est un ADC envelopp√©, avec sa propre pr√©sentation sp√©ciale des donn√©es et l'acc√®s √† l'usb.  c'est-√†-dire  si vous ex√©cutez la commande lsmod sans le module r8188eu.ko charg√©, nous verrons seulement que quelqu'un a pris le port usb.  Lorsque le module est charg√©, le nom de l'appareil sera d√©j√† visible, en d'autres termes, ce module n'est qu'une interface de programme pour contr√¥ler cette puce. <br><br>  La biblioth√®que suivante la plus importante est lib80211.ko, la norme IEEE 802.11 elle-m√™me, en termes simples, c'est l'interpr√©tation des signaux num√©riques √©ther dans la repr√©sentation de protocoles ehternet sp√©cifiques.  Mais pour g√©rer tout cela, vous devez installer linux-firmware, il inclura le pilote -wext-, qui fera tout cela.  Nous le relierons plus loin au suppliant. <br><br>  Commen√ßons la configuration suppliante. <br><br>  Nous montons dans un ubunte fra√Æchement assembl√© √† cette adresse: <br><br><pre> <code class="plaintext hljs">/ etc / wpa_supplicant / wpa_supplicant.conf</code> </pre> <br>  Et nous cr√©ons un fichier de configuration sinon et s'il y en a, nous corrigeons ce type: <br><br><pre> <code class="bash hljs">ctrl_interface_group=0 <span class="hljs-comment"><span class="hljs-comment">#        ctrl_interface=/var/run/wpa_supplicant #       #       usb  #      ap_scan=1 #wpa_supplicant   ,  - network={ ssid="SSID_" psk=" " key_mgmt=WPA-PSK #   proto=WPA2 pairwise=CCMP }</span></span></code> </pre><br>  Si tout est correctement configur√© et que les modules d√©crits ci-dessus sont charg√©s, un fichier de p√©riph√©rique sera cr√©√© √† l'adresse sp√©cifi√©e dans la configuration (param√®tre ctrl_interface). <br><br><h3>  Configuration de Systemd </h3><br>  Nous avons configur√© le suppliant, mais il n'y a encore personne pour l'ex√©cuter.  Vous pouvez bien s√ªr installer le gestionnaire de r√©seau et profiter du r√©glage automatique, mais o√π est le hardcore puis o√π se trouve la poubelle.  En g√©n√©ral, l'ennui pur. <br><br>  Nous montons donc √† l'adresse: <br><br><pre> <code class="plaintext hljs">/ etc / systemd / system/</code> </pre> <br>  Et ici, nous cr√©ons un fichier appel√© <code>network-wireless.service</code> sinon, et s'il y en a, nous commen√ßons √† √©diter: <br><br><pre> <code class="bash hljs">[Unit] <span class="hljs-comment"><span class="hljs-comment">#       Description=Wireless network connectivity Wants=network.target After=sys-subsystem-net-devices-wlx007005012449.device Before=network.target BindsTo=sys-subsystem-net-devices-wlx007005012449.device [Service] #    Type=oneshot RemainAfterExit=yes ExecStart=/sbin/ifconfig wlx007005012449 up #   ExecStart=/sbin/wpa_supplicant -B -i wlx007005012449 -D wext -c /etc/wpa_supplicant/wpa_supplicant.conf #   ExecStart=/sbin/dhcpcd wlx007005012449 #  dhcp   [Install] WantedBy=multi-user.target</span></span></code> </pre><br>  Arr√™tons-nous sur le lancement du suppliant: <br><br>  <code>ExecStart=/sbin/wpa_supplicant</code> # chemin d'acc√®s au demandeur <br>  <code>-B</code> # ex√©cut√© en arri√®re-plan <br>  <code>-i wlx007005012449</code> # interface √† ex√©cuter, le m√™me fichier de p√©riph√©rique <br>  <code>-D wext</code> # nom du pilote pour sifflet depuis linux-firmware <br>  <code>-c /etc/wpa_supplicant/wpa_supplicant.conf</code> # adresse du fichier de configuration du <code>-c /etc/wpa_supplicant/wpa_supplicant.conf</code> <br><br>  Eh bien, en g√©n√©ral, tout ce dont vous avez besoin est configur√©, allez √† l'installation des modules. <br><br><h3>  Installation de modules. </h3><br>  Pour installer les modules, revenons un peu en arri√®re, √† savoir dans le dossier avec la source du noyau et ex√©cutons la commande pour copier les modules du noyau dans le dossier avec ubuntu √† partir de l√†: <br><br><pre> <code class="bash hljs">make O=../olimex-kernel-4.14.57 -j2 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- modules_install <span class="hljs-comment"><span class="hljs-comment">#     INSTALL_MOD_PATH=/destrup #   </span></span></code> </pre><br>  Apr√®s cela, tous nos modules assembl√©s sont copi√©s sur ubuntu √†: <br><br><pre> <code class="plaintext hljs">/ lib / modules / 4.14.57 / kernel</code> </pre> <br>  Maintenant, la chose la plus importante est d'enregistrer le lancement des modules copi√©s et toutes leurs d√©pendances, nous montons donc √† l'adresse: <br><br><pre> <code class="plaintext hljs">/ etc / modules</code> </pre> <br>  Et ex√©cutez ouvrir le fichier des modules pour l'√©dition et ajoutez les modules suivants: <br><br><pre> <code class="plaintext hljs">michael_mic r8188eu #   r8192e_pci rtllib rtllib_crypt_ccmp rtllib_crypt_tkip rtllib_crypt_wep r8192u_usb # lib80211 #   IEEE 802.11</code> </pre> <br>  Il reste maintenant √† copier tous les ubuntu assembl√©s dans la section de carte sd marqu√©e dans l'article pr√©c√©dent en tant que section pour ubuntu. <br><br>  Apr√®s cela, vous pouvez ins√©rer le lecteur flash USB dans la carte, mettre sous tension et vous asseoir sur son uart pour acc√©der √† sa gestion ou entrer via ssh.  Vous pouvez ajouter une commande √† systemd pour d√©finir l'adresse IP ou une autre configuration en g√©n√©ral, puis tout le reste est entre vos mains ... <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La premi√®re partie de l'article</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La deuxi√®me partie de l'article</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435586/">https://habr.com/ru/post/fr435586/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435576/index.html">1C, pas de douleur</a></li>
<li><a href="../fr435578/index.html">Sortie dans l'espace pour No√´l</a></li>
<li><a href="../fr435580/index.html">Java, Spring, Kurento et Media Services</a></li>
<li><a href="../fr435582/index.html">Comment ajouter un index sur un syst√®me charg√© 24/7 sans interruption?</a></li>
<li><a href="../fr435584/index.html">Slush 2018. Premier jour, deuxi√®me jour</a></li>
<li><a href="../fr435588/index.html">Promotion d'une application mobile avec une r√©elle exp√©rience des chiffres</a></li>
<li><a href="../fr435590/index.html">Pr√©vision √† nouveau, partie 1</a></li>
<li><a href="../fr435592/index.html">A√ßores: derni√®re r√©serve de flore au milieu de l'oc√©an Atlantique</a></li>
<li><a href="../fr435594/index.html">Graphique d'itin√©raire pour Apache Camel</a></li>
<li><a href="../fr435600/index.html">Comment migrer vers un autre op√©rateur mobile et ne pas faire faillite (pour les propri√©taires d'iOS)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>