<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôåüèΩ üëç üéÉ Wir streben das Maximum an: vom ORM bis zur Bytecode-Analyse üë∞üèæ üßïüèº üë©üèø‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wie Sie wissen, sollte ein echter Programmierer drei Dinge in seinem Leben tun: seine eigene Programmiersprache erstellen, sein eigenes Betriebssystem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir streben das Maximum an: vom ORM bis zur Bytecode-Analyse</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409043/"><p>  Wie Sie wissen, sollte ein echter Programmierer drei Dinge in seinem Leben tun: seine eigene Programmiersprache erstellen, sein eigenes Betriebssystem schreiben und sein eigenes ORM erstellen.  Und wenn ich die Sprache vor langer Zeit geschrieben habe (vielleicht erz√§hle ich es Ihnen ein andermal) und das Betriebssystem noch in Betrieb ist, dann m√∂chte ich Ihnen jetzt etwas √ºber ORM erz√§hlen.  Genauer gesagt geht es nicht einmal um ORM selbst, sondern um die Implementierung einer kleinen, lokalen und scheinbar v√∂llig einfachen Funktion. </p><br><p> Gemeinsam werden wir den ganzen Weg von der Freude, eine einfache L√∂sung zu finden, bis zur Bitterkeit des Bewusstseins f√ºr seine Zerbrechlichkeit und Unrichtigkeit gehen.  Von der Verwendung einer ausschlie√ülich √∂ffentlichen API bis hin zu schmutzigen Hacks.  Von "fast ohne Reflexion" bis "knietief im Bytecode-Interpreter". </p><br><p>  Wen interessiert es, wie der Bytecode zu analysieren ist, mit welchen Schwierigkeiten er behaftet ist und was f√ºr ein erstaunliches Ergebnis Sie am Ende erzielen k√∂nnen? Willkommen bei cat. </p><a name="habracut"></a><br><h3 id="soderzhanie">  Inhalt </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">1</a> - Wie alles begann. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">2-4</a> - Auf dem Weg zum Bytecode. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">5</a> - Wer ist der Bytecode? <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">6</a> - Die Analyse selbst.  Um dieses Kapitels willen wurde alles konzipiert und es war der Mut darin. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">7</a> - Was kann noch beendet werden.  Tr√§ume, Tr√§ume ... <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nachwort</a> - Nachwort. </p><br><p>  <em>UPD: Unmittelbar nach der Ver√∂ffentlichung gingen die Teile 6-8 verloren (f√ºr die alles gestartet wurde).</em>  <em>Behoben.</em> </p><br><a name="1"></a><br><h3 id="chast-pervaya-problema">  Teil Eins  Das Problem </h3><br><p>  Stellen Sie sich vor, wir haben ein einfaches Schema.  Es gibt einen Kunden, er hat mehrere Konten.  Einer von ihnen ist voreingestellt.  Ein Client kann auch mehrere SIM-Karten haben und jede SIM-Karte kann explizit festgelegt oder ein Standard-Client verwendet werden. </p><br><p><img src="https://habrastorage.org/webt/dh/io/ag/dhioagv6hwl7cmpls9cuh2a_dyq.png"></p><br><p>  So wird dieses Modell in unserem Code beschrieben (ohne Getter / Setter / Konstruktoren / ...). </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"DEFAULTACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account defaultAccount; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long balance; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CARD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String msisdn; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; }</code> </pre> <br><p>  In ORM selbst m√ºssen keine Proxys vorhanden sein (wir m√ºssen eine Instanz dieser bestimmten Klasse erstellen) und eine einzelne Anforderung.  Dementsprechend wird hier Folgendes an SQL gesendet, wenn versucht wird, eine Karte abzurufen. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.id <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, CARD.msisdn msisdn, ACCOUNT_2.id ACCOUNT_2_id, ACCOUNT_2.balance ACCOUNT_2_balance, CLIENT_3.id CLIENT_3_id, CLIENT_3.name CLIENT_3_name, CLIENT_1.id CLIENT_1_id, CLIENT_1.name CLIENT_1_name, ACCOUNT_4.id ACCOUNT_4_id, ACCOUNT_4.balance ACCOUNT_4_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = CLIENT_1.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = ACCOUNT_2.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ACCOUNT_2.CLIENT = CLIENT_3.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_4 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CLIENT_1.DEFAULTACCOUNT = ACCOUNT_4.id;</code> </pre> <br><p>  Ups.  Der Kunde und die Rechnung werden dupliziert.  Wenn Sie dar√ºber nachdenken, ist dies zwar verst√§ndlich - schlie√ülich wei√ü das Framework nicht, dass der Kartenclient und der Kartenkonto-Client derselbe Client sind.  Und die Anfrage muss statisch und nur eine generiert werden (erinnern Sie sich an die Einschr√§nkung der Eindeutigkeit der Anfrage?). </p><br><p>  Aus genau dem gleichen Grund gibt es hier √ºberhaupt keine Felder f√ºr <code>Card.account.client.defaultAccount</code> und <code>Card.client.defaultAccount.client</code> .  Nur wir wissen, dass <code>client</code> und <code>client.defaultAccount.client</code> immer √ºbereinstimmen.  Und der Rahmen wei√ü es nicht, f√ºr ihn ist dies eine willk√ºrliche Verbindung.  Und was in solchen F√§llen zu tun ist, ist nicht sehr klar.  Ich kenne 3 Optionen: </p><br><ol><li>  Beschreiben Sie Invarianten explizit in Anmerkungen. </li><li>  Stellen Sie rekursive Abfragen ( <code>with recursive</code> / <code>connect by</code> ). </li><li>  Um zu punkten. </li></ol><br><p>  Ratet mal, welche Option wir gew√§hlt haben?  Richtig.  Infolgedessen werden jetzt nicht alle rekursiven Felder gef√ºllt und es gibt immer null. </p><br><p>  Wenn Sie genau hinschauen, k√∂nnen Sie das zweite Problem hinter der Vervielf√§ltigung erkennen, und es ist viel schlimmer.  Was wollten wir?  Kartennummer und Guthaben.  Was hast du bekommen  4 Verkn√ºpfungen und 10 Spalten.  Und dieses Ding w√§chst exponentiell!  Nun, d.h.  Wir haben wirklich eine Situation, in der wir zun√§chst aus Gr√ºnden der Sch√∂nheit und Integrit√§t das Modell f√ºr Anmerkungen vollst√§ndig beschreiben und dann <strong>aus Gr√ºnden von 5 Feldern</strong> eine Anforderung f√ºr <strong>15 Verkn√ºpfungen und 150 Spalten</strong> angefordert wird.  Und in diesem Moment wird es wirklich be√§ngstigend. </p><br><a name="2"></a><br><h3 id="chast-vtoraya-rabochee-no-neudobnoe-reshenie">  Teil Zwei  Eine funktionierende, aber unpraktische L√∂sung </h3><br><p>  Eine einfache L√∂sung bittet sofort.  Es d√ºrfen nur die Lautsprecher gezogen werden, die verwendet werden!  Einfach zu sagen.  Die naheliegendste Option (um die Auswahl mit Ihren H√§nden zu schreiben) werden wir sofort fallen lassen.  Nun, nicht dann haben wir das Modell beschrieben, um es nicht zu verwenden.  Vor langer Zeit wurde eine spezielle Methode entwickelt - <code>partialGet</code> .  Im Gegensatz zu simple <code>get</code> akzeptiert es <code>List&lt;String&gt;</code> - die Namen der zu f√ºllenden Felder.  Dazu m√ºssen Sie zuerst Aliase in den Tabellen registrieren </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"a"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"c"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>  Und dann genie√üen Sie das Ergebnis. </p><br><pre> <code class="java hljs">List&lt;String&gt; requiredColumns = asList(<span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); String query = cardMapper.getSelectSQL(requiredColumns, DatabaseType.ORACLE); System.out.println(query);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.msisdn msisdn, c_a.balance c_a_balance, a.balance a_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = a.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = c.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> c_a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.DEFAULTACCOUNT = c_a.id;</code> </pre> <br><p>  Und alles scheint in Ordnung zu sein, aber tats√§chlich nein.  Hier ist, wie es in echtem Code verwendet wird. </p><br><pre> <code class="java hljs">Card card = cardDAO.partialGet(cardId, <span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); ... ... ...    ... ... ... <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> clientId = card.getClient().getId();<span class="hljs-comment"><span class="hljs-comment">//, NPE.  , id    ?!</span></span></code> </pre> <br><p>  Und es stellt sich heraus, dass Sie PartialGet jetzt nur verwenden k√∂nnen, wenn der Abstand zwischen ihm und der Verwendung des Ergebnisses nur wenige Zeilen betr√§gt.  Aber wenn das Ergebnis weit geht oder, Gott bewahre, innerhalb einer Methode weitergegeben wird, ist es bereits √§u√üerst schwierig zu verstehen, welche Felder gef√ºllt sind und welche nicht.  Wenn NPE irgendwo passiert ist, m√ºssen Sie au√üerdem noch verstehen, ob es wirklich aus der Nulldatenbank zur√ºckgegeben wurde oder ob wir dieses Feld einfach nicht ausgef√ºllt haben.  Alles in allem sehr unzuverl√§ssig. </p><br><p>  Sie k√∂nnen nat√ºrlich einfach ein anderes Objekt mit Ihrer Zuordnung speziell f√ºr die Anforderung schreiben oder das Ganze sogar vollst√§ndig mit Ihren H√§nden ausw√§hlen und zu einem <code>Tuple</code> .  Tats√§chlich tun wir in der Realit√§t an den meisten Orten genau das.  Trotzdem m√∂chte ich keine Auswahl mit meinen H√§nden schreiben und keine Zuordnung duplizieren. </p><br><a name="3"></a><br><h3 id="chast-tretya-udobnoe-no-nerabochee-reshenie">  Teil drei.  Eine bequeme, aber nicht funktionsf√§hige L√∂sung. </h3><br><p>  Wenn Sie ein bisschen mehr nachdenken, f√§llt mir ziemlich schnell die Antwort ein - Sie m√ºssen Schnittstellen verwenden.  Dann einfach deklarieren </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MsisdnAndBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMsisdn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  Und verwenden </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, ...);</code> </pre> <br><p>  Und alle.  Rufen Sie nichts extra an.  Dar√ºber hinaus kann mit dem √úbergang zu Kotlin / ten / lomb auch dieser schreckliche Typ beseitigt werden.  Aber hier wird der wichtigste Punkt immer noch weggelassen.  Welche Argumente sollten an <code>partialGet</code> ?  Riemen f√ºhlen sich nach wie vor nicht mehr so ‚Äã‚Äãan, weil das Risiko zu gro√ü ist, um Fehler zu machen und die falschen Felder zu schreiben.  Und ich m√∂chte, dass du es irgendwie kannst </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, MsisdnAndBalance.class);</code> </pre> <br><p>  Oder noch besser auf Kotlin durch reifizierte Generika </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> card = cardDAO.paritalGet&lt;MsisdnAndBalance&gt;(cardId)</code> </pre> <br><p>  Ehh, ein Fehler.  Tats√§chlich ist die ganze weitere Geschichte genau die Implementierung dieser Option. </p><br><a name="4"></a><br><h3 id="chast-chetvertaya-na-puti-k-baytkodu">  Teil vier  Auf dem Weg zum Bytecode </h3><br><p>  Das Hauptproblem besteht darin, dass Methoden von der Schnittstelle stammen und Anmerkungen √ºber den Feldern liegen.  Und wir m√ºssen dieselben Felder mit Methoden finden.  Der erste und naheliegendste Gedanke ist die Verwendung der Standard-Java-Bean-Konvention.  Und f√ºr triviale Eigenschaften funktioniert dies sogar.  Aber es stellt sich als sehr instabil heraus.  Zum Beispiel lohnt es sich, eine Methode in einer Schnittstelle umzubenennen (durch ideologisches Refactoring), da alles sofort auseinander f√§llt.  Die Idee ist klug genug, um Methoden in Implementierungsklassen umzubenennen, aber nicht genug, um zu verstehen, dass es sich um einen Getter handelt und Sie das Feld selbst umbenennen m√ºssen.  Eine √§hnliche L√∂sung f√ºhrt zu doppelten Feldern.  Wenn ich beispielsweise die Methode <code>getClientId()</code> in meiner Schnittstelle ben√∂tige, kann ich sie nicht auf die einzig richtige Weise implementieren </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  Und ich muss Felder duplizieren.  Ziehen Sie im <code>Client</code> sowohl die <code>id</code> als auch die Client- <code>clientId</code> , und in der Zuordnung neben dem Client befindet sich explizit die Client- <code>clientId</code> .  Und stellen Sie sicher, dass dies alles nicht verl√§sst.  Dar√ºber hinaus m√∂chte ich zum Beispiel, dass Getter mit nicht trivialer Logik funktionieren </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> account.getBalance(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getDefaultAccount().getBalance(); } }</code> </pre> <br><p>  Die Option zum Suchen nach Namen wird also nicht mehr ben√∂tigt, Sie ben√∂tigen etwas Schwierigeres. </p><br><p>  Die n√§chste Option war v√∂llig verr√ºckt und lebte nicht lange in meinem Kopf, aber der Vollst√§ndigkeit halber werde ich sie auch beschreiben.  In der Analysephase k√∂nnen wir eine leere Entit√§t erstellen und einfach abwechselnd einige Werte in die Felder schreiben. Danach erhalten wir die Getter und sehen, dass sich ge√§ndert hat, was sie zur√ºckgeben oder nicht.  Wir werden also sehen, dass sich der Wert von <code>getClientId</code> aus dem Datensatz im <code>getClientId</code> nicht √§ndert, sondern aus der Datensatz- <code>id</code> - er √§ndert sich.  Dar√ºber hinaus wird hier automatisch die Situation unterst√ºtzt, in der Getter und Felder unterschiedlichen Typs (z. B. <code>isActive() = i_active != 0</code> ) automatisch unterst√ºtzt werden.  Aber es gibt mindestens drei schwerwiegende Probleme (vielleicht mehr, aber ich habe nicht weiter dar√ºber nachgedacht). </p><br><ol><li>  Die offensichtliche Voraussetzung f√ºr das Wesentliche bei diesem Algorithmus besteht darin, den "gleichen" Wert vom Getter zur√ºckzugeben, wenn sich das "entsprechende" Feld nicht ge√§ndert hat.  "Ein und dasselbe" - aus Sicht des von uns gew√§hlten Vergleichsoperators.  <code>==</code> es kann offensichtlich nicht sein (andernfalls <code>getAsInt() = Integer.parseInt(strField))</code> nicht mehr <code>getAsInt() = Integer.parseInt(strField))</code> .  Bleibt gleich.  Wenn der Getter also eine Art Benutzerentit√§t zur√ºckgibt, die bei jedem Aufruf von Feldern generiert wird, muss er eine √úberschreibung von <code>equals</code> . </li><li>  Komprimierungszuordnungen.  Wie im obigen Beispiel mit <code>int -&gt; boolean</code> .  Wenn wir die Werte 0 und 1 √ºberpr√ºfen, sehen wir eine √Ñnderung.  Aber wenn wir 40 und 42 sind, dann werden wir beide Male wahr. </li><li>  Es kann komplexe Konverter in Gettern geben, die auf bestimmten Invarianten in Feldern beruhen (z. B. ein spezielles Zeichenfolgenformat).  Und auf unsere generierten Daten werden sie Ausnahmen werfen. </li></ol><br><p>  Im Allgemeinen funktioniert die Option also auch nicht. </p><br><p>  W√§hrend ich √ºber das Ganze diskutierte, sprach ich zun√§chst scherzhaft den Satz aus: "Nun, nafig, es ist einfacher, Bytecode zu sehen, alles ist dort geschrieben."  Zu dieser Zeit war mir nicht einmal klar, dass diese Idee mich verschlucken w√ºrde und wie weit alles gehen w√ºrde. </p><br><a name="5"></a><br><h3 id="chast-pyataya-chto-takoe-baytkod-i-kak-on-rabotaet">  F√ºnfter Teil  Was ist Bytecode und wie funktioniert es? </h3><br><p> <code>new #4, dup, invokespecial #5, areturn</code> <br>  Wenn Sie verstehen, was hier geschrieben steht und was dieser Code bewirkt, k√∂nnen Sie mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">n√§chsten</a> Teil fortfahren. </p><br><p>  <em>Haftungsausschluss 1.</em> Um die weitere Geschichte zu verstehen, ben√∂tigen Sie leider mindestens ein grundlegendes Verst√§ndnis des Aussehens von Java-Bytecode. Daher schreibe ich ein paar Abs√§tze dar√ºber.  In keiner Weise vorgeben, vollst√§ndig zu sein. </p><br><p>  <em>Haftungsausschluss 2.</em> Es geht ausschlie√ülich um die Methoden.  Weder √ºber den konstanten Pool noch √ºber die Struktur der Klasse als Ganzes noch √ºber die Methodendeklarationen selbst werde ich ein Wort sagen. </p><br><p>  Das Wichtigste, was Sie √ºber Bytecode wissen m√ºssen, ist der Assembler f√ºr die virtuelle Java-Stack-Maschine.  Dies bedeutet, dass die Argumente f√ºr die Anweisungen aus dem Stapel √ºbernommen werden und die R√ºckgabewerte aus den Anweisungen auf den Stapel zur√ºckgeschoben werden.  Unter diesem Gesichtspunkt k√∂nnen wir sagen, dass der Bytecode in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">umgekehrter polnischer Notation geschrieben ist</a> .  Zus√§tzlich zum Stapel verf√ºgt die Methode √ºber ein Array lokaler Variablen.  Bei der Eingabe der Methode werden <code>this</code> und alle Argumente dieser Methode in die Methode geschrieben und dort w√§hrend der Ausf√ºhrung lokale Variablen gespeichert.  Hier ist ein einfaches Beispiel. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateAndReturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> baz, String str)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) baz; result += str.length(); bar = result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br><p>  Ich werde Kommentare im Format schreiben </p><br><pre> <code class="plaintext hljs"># [(&lt;local_variable_index&gt;:&lt;actual_value&gt;)*], [(&lt;value_on_stack&gt;)*]</code> </pre> <br><p>  Oben auf dem Stapel links. </p><br><pre> <code class="plaintext hljs">public int updateAndReturn(long, java.lang.String); Code: # [0:this, 1:long baz, 3:str], () 0: lload_1 # [0:this, 1:long baz, 3:str], (long baz) 1: l2i # [0:this, 1:long baz, 3:str], (int baz) 2: istore 4 # [0:this, 1:long baz, 3:str, 4:int baz], () 4: iload 4 # [0:this, 1:long baz, 3:str, 4:int baz], (int baz) 6: aload_3 # [0:this, 1:long baz, 3:str, 4:int baz], (str, int baz) 7: invokevirtual #2 // Method java/lang/String.length:()I # [0:this, 1:long baz, 3:str, 4:int baz], (length(str), int baz) 10: iadd # [0:this, 1:long baz, 3:str, 4:int baz], (length(str) + int baz) 11: istore 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], () 13: aload_0 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (this) 14: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz, this) 16: putfield #3 // Field bar:I # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (),     bar 19: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz) 21: ireturn #  int   ,      </code> </pre> <br><p>  Es gibt viele Anweisungen.  Die vollst√§ndige Liste muss im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">sechsten Kapitel von JVMS nachgeschlagen werden</a> , auf Wikipedia gibt es eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">kurze Nacherz√§hlung</a> .  Eine gro√üe Anzahl von Anweisungen dupliziert sich f√ºr verschiedene Typen (z. B. <code>iload</code> f√ºr int und <code>lload</code> f√ºr long).  <code>lload_1</code> Sie mit den ersten 4 lokalen Variablen arbeiten, werden deren Anweisungen hervorgehoben (zum Beispiel gibt es <code>lload_1</code> und es werden √ºberhaupt keine Argumente verwendet, aber es gibt nur <code>lload</code> , es wird die Nummer der lokalen Variablen als Argument verwendet. Im obigen Beispiel gibt es eine √§hnliche <code>iload</code> ). </p><br><p>  Weltweit werden wir an folgenden Anweisungsgruppen interessiert sein: </p><br><ol><li>  <code>*load*</code> , <code>*store*</code> - lokale Variable lesen / schreiben </li><li>  <code>*aload</code> , <code>*astore</code> - Lesen / Schreiben eines Array-Elements nach Index </li><li>  <code>getfield</code> , <code>putfield</code> - Lese- / Schreibfeld </li><li>  <code>getstatic</code> , <code>putstatic</code> - statisches Feld lesen / schreiben </li><li>  <code>checkcast</code> - zwischen Objekttypen <code>checkcast</code> .  Brauche da  Typisierte Werte liegen auf dem Stapel und in lokalen Variablen.  Zum Beispiel war oben l2i f√ºr die Besetzung long -&gt; int. </li><li>  <code>invoke*</code> - Methodenaufruf aufrufen </li><li>  <code>*return</code> - gibt den Wert zur√ºck und beendet die Methode </li></ol><br><a name="6"></a><br><h3 id="chast-shestaya-glavnaya">  Teil Sechs  Zuhause </h3><br><p>  F√ºr diejenigen, die eine so lange Einf√ºhrung verpasst haben und um vom urspr√ºnglichen Problem und der Vernunft in Bezug auf die Bibliothek abzulenken, formulieren wir das Problem genauer. </p><br><blockquote>  Mit einer <code>java.lang.reflect.Method</code> Instanz muss eine Liste aller nicht statischen Felder (sowohl aktuelle als auch alle verschachtelten Objekte) abgerufen werden, deren Messwerte (direkt oder transitiv) innerhalb dieser Methode liegen. </blockquote><p>  Zum Beispiel f√ºr eine solche Methode </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>  Sie m√ºssen eine Liste mit zwei Feldern <code>account.balance</code> : <code>account.balance</code> und <code>client.defaultAccount.balance</code> . </p><br><p>  Ich werde, wenn m√∂glich, eine allgemeine L√∂sung schreiben.  An einigen Stellen m√ºssen Sie jedoch das Wissen √ºber das urspr√ºngliche Problem nutzen, um unl√∂sbare, im allgemeinen Fall auftretende Probleme zu l√∂sen. </p><br><p>  Zuerst m√ºssen Sie den Bytecode des Methodenk√∂rpers selbst abrufen, dies kann jedoch nicht direkt √ºber Java erfolgen.  Aber seitdem  Da die Methode urspr√ºnglich in einer Klasse vorhanden war, ist es einfacher, die Klasse selbst abzurufen.  Weltweit kenne ich zwei M√∂glichkeiten: Keilen Sie sich in den Klassenladevorgang ein und fangen Sie das bereits gelesene <code>byte[]</code> dort ab, oder suchen <code>ClassName.class</code> einfach die Datei <code>ClassName.class</code> auf der Festplatte und lesen Sie sie.  Das Abfangen des Ladens auf der Ebene der √ºblichen Bibliothek kann nicht durchgef√ºhrt werden.  Sie m√ºssen entweder Javaagent verbinden oder einen benutzerdefinierten ClassLoader verwenden.  In jedem Fall sind zus√§tzliche Schritte erforderlich, um die JVM / Anwendung zu konfigurieren, und dies ist unpraktisch.  Sie k√∂nnen es einfacher machen.  Alle "normalen" Klassen befinden sich immer in derselben Datei mit der Erweiterung ".class", deren Pfad das Klassenpaket ist.  Ja, es wird nicht funktionieren, dynamisch hinzugef√ºgte Klassen oder Klassen zu finden, die von einem benutzerdefinierten Klassenladeprogramm geladen wurden, aber wir ben√∂tigen dies f√ºr das jdbc-Modell, sodass wir mit Sicherheit sagen k√∂nnen, dass alle Klassen auf die "Standardmethode" in Jars gepackt werden.  Gesamt: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); }</code> </pre> <br><p>  Hurra, lies das Byte-Array.  Was machen wir als n√§chstes damit?  Im Prinzip gibt es in Java mehrere Bibliotheken zum Lesen / Schreiben von Bytecode, aber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">ASM</a> wird normalerweise f√ºr Arbeiten auf niedriger Ebene verwendet.  Weil  Es ist f√ºr eine hohe Leistung und einen schnellen Betrieb gesch√§rft. Die Besucher-API ist die wichtigste dort - asm liest die Klasse nacheinander und ruft die entsprechenden Methoden ab </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FieldVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, Object value)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{...} ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MethodVisitor mv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodVisitor mv)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mv = mv; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, Label label)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mv != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mv.visitJumpInsn(opcode, label); } } ... }</code> </pre> <br><p>  Der Benutzer wird aufgefordert, die f√ºr ihn interessanten Methoden neu zu definieren und dort seine eigene Analyse- / Transformationslogik zu schreiben.  <code>MethodVisitor</code> m√∂chte ich am Beispiel von <code>MethodVisitor</code> , dass alle Besucher eine Standardimplementierung durch Delegierung haben. </p><br><p>  Neben der Haupt-API gibt es auch eine sofort einsatzbereite Tree-API.  Wenn die Core-API ein Analogon zum SAX-Parser ist, ist die Tree-API ein Analogon zum DOM.  Wir erhalten ein Objekt, in dem alle Informationen √ºber die Klasse / Methode gespeichert sind, und k√∂nnen sie nach Belieben mit Spr√ºngen an einen beliebigen Ort analysieren.  Tats√§chlich handelt es sich bei dieser API um eine <code>*Visitor</code> , bei der in den Besuchsmethoden einfach Informationen gespeichert werden.  Fast alle Methoden dort sehen so aus: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Label label)</span></span></span><span class="hljs-function"> </span></span>{ instructions.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JumpInsnNode(opcode, getLabelNode(label))); } ... }</code> </pre> <br><p>  Jetzt k√∂nnen wir endlich die Methode zur Analyse laden. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      if (!name.equals(getterName) || !desc.equals(getterDesc)) return null; return new AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } private class AnalyzerMethodVisitor extends MethodVisitor { public AnalyzerMethodVisitor(int access, String name, String desc, String signature, String[] exceptions) { super(ASM6, new MethodNode(ASM6, access, name, desc, signature, exceptions)); } @Override public void visitEnd() { //     ,     MethodVisitor    if (methodNode != null) throw new IllegalStateException(); methodNode = (MethodNode) mv; } } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Vollst√§ndige Code-Lesemethode.</b> <div class="spoiler_text"><p>  <code>MethodNode</code> nicht direkt zur√ºckgegeben, sondern ein Wrapper mit einem Paar ext.  Felder weil  wir werden sie auch sp√§ter brauchen.  Der Einstiegspunkt (und die einzige √∂ffentliche Methode) ist <code>readMethod(Method): MethodInfo</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodReader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalDeclaringClassName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> classAccess, MethodNode methodNode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internalDeclaringClassName = internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classAccess = classAccess; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.methodNode = methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInternalDeclaringClassName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> internalDeclaringClassName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> classAccess; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MethodInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method)</span></span></span><span class="hljs-function"> </span></span>{ Class&lt;?&gt; clazz = method.getDeclaringClass(); String internalClassName = getInternalName(clazz); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream is = getClassFile(clazz)) { ClassReader cr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassReader(is); AnalyzerClassVisitor cv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerClassVisitor(internalClassName, method); cr.accept(cv, SKIP_DEBUG | SKIP_FRAMES); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodInfo(internalClassName, cv.getAccess(), cv.getMethodNode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String className; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> access; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalClassName, Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.className = internalClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(className)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.access = access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(getterName) || !desc.equals(getterDesc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodNode(ASM6, access, name, desc, signature, exceptions)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); methodNode = (MethodNode) mv; } } } }</code> </pre> </div></div><br><p>  Es ist Zeit, die Analyse direkt durchzuf√ºhren.  Wie macht man das?  Der erste Gedanke ist, alle <code>getfield</code> Anweisungen zu <code>getfield</code> .  Jedes <code>getfield</code> statisch an, um welches Feld es sich handelt und welche Klasse.  Es k√∂nnen alle Felder unserer Klasse als notwendig angesehen werden, zu denen Zugang bestand.  Dies funktioniert aber leider nicht.  Das erste Problem hierbei ist, dass der √úberschuss erfasst wird. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> baz; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bar + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Foo().baz; } }</code> </pre> <br><p>  Bei diesem Algorithmus ber√ºcksichtigen wir, dass das Baz-Feld ben√∂tigt wird, obwohl tats√§chlich nein.  Dieses Problem konnte jedoch noch behoben werden.  Aber was tun mit den Methoden? </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HasClientId obj = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.getClientId(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><p>  Wenn wir nach Methodenaufrufen genauso suchen wie nach <code>getClientId</code> finden wir <code>getClientId</code> .  Denn es gibt keinen Aufruf von <code>Client.getClientId</code> , sondern nur einen Aufruf von <code>HasClientId.getClientId</code> .  Nat√ºrlich k√∂nnen Sie alle Methoden der aktuellen Klasse, alle ihre Oberklassen und alle zu verwendenden Schnittstellen ber√ºcksichtigen, aber das ist bereits zu viel.  Sie k√∂nnen also versehentlich <code>toString</code> erfassen und darin finden Sie eine Auflistung aller Felder im Allgemeinen. </p><br><p>  Dar√ºber hinaus m√∂chten wir, dass Getter-Aufrufe f√ºr verschachtelte Objekte auch funktionieren </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  Und hier gilt der Aufruf der <code>Client.getId</code> Methode √ºberhaupt nicht f√ºr die <code>Account</code> Klasse. </p><br><p>  Mit einem starken Wunsch k√∂nnen Sie noch einige Zeit an Hacks f√ºr Sonderf√§lle denken, aber ziemlich schnell wird klar, dass ‚ÄûDinge nicht so gemacht werden‚Äú und Sie den Ablauf der Ausf√ºhrung und der Datenbewegung vollst√§ndig √ºberwachen m√ºssen.        <code>getfield</code> ,      <code>this</code> ,   -   <code>this</code> .  Hier ist ein Beispiel: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.id + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Account().id; } }</code> </pre> <br><pre> <code class="plaintext hljs">class Account { public Client client; public long test(); Code: 0: aload_0 1: getfield #2 // Field client:LClient; 4: getfield #3 // Field Client.id:J 7: new #4 // class Account 10: dup 11: invokespecial #5 // Method "&lt;init&gt;":()V 14: getfield #6 // Field id:J 17: ladd 18: lreturn }</code> </pre> <br><ul><li> <code>1: getfield</code>              <code>this</code> ,    <code>aload_0</code> . </li><li> <code>4: getfield</code> ‚Äî       ,    <code>1: getfield</code> , , ,  <code>this</code> . </li><li> <code>14: getfield</code>   .  Weil    ,       ( <code>Account</code> ),     <code>this</code> ,    ,       <code>7: new</code> . </li></ul><br><p> ,        <code>Account.client.id</code> ,  <code>Account.id</code> ‚Äî .     ,    ,       . </p><br><p>      ‚Äî    ,    ,   <code>aload_0</code>  <code>getfield</code>         <code>this</code>  , ,        . , .   .     ‚Äî    !   -,    .     <code>MethodNode</code> ,    (  ).     , ..    (//)        . </p><br><p>     : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Interpreter&lt;V&gt; interpreter)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Frame&lt;V&gt;[] analyze(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String owner, <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode m) {...} }</code> </pre> <br><p> <code>Analyzer</code>      (  <code>Frame</code> ,    )   .      ,    ,   ,  ,       //etc. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Interpreter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2, V value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends V&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value, V expected)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(V v, V w)</span></span></span></span>; }</code> </pre> <br><p>  <code>V</code> ‚Äî   ,      ,    . <code>Analyzer</code>          ,    ,           ,      . , <code>getfield</code>      ‚Äî ,    ,     . ,   <code>unaryOperation(AbstractInsnNode insn, V value): V</code> ,                 .     <code>1: getfield</code>   <code>Value</code> ,     "  <code>client</code> ,  <code>Client</code>        ",   <code>14: getfield</code>  " ‚Äî  -  ,         ". </p><br><p>       <code>merge(V v, V w): V</code> .      ,        ,    .  Zum Beispiel: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>    <code>Account.getBalance()</code>     .  - .       .   ?         <code>merge</code> . </p><br><p>        ‚Äî  <code>SuperInterpreter extends Interpreter&lt;SuperValue&gt;</code> ?  Richtig.    <code>SuperValue</code> .     ‚Äî       ,        .                ,           . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } }</code> </pre> <br><p>     <code>composite</code> .   ,     . ,  <code>String</code>   .         <code>String.length()</code> ,   ,       <code>name</code> ,   <code>name.value.length</code> . , <code>length</code> ‚Äî    ,   ,    <code>arraylength</code> .     ?  Nein!          ‚Äî         . ,       ,     ,      . ,  <code>Date</code> , <code>String</code> , <code>Long</code> ,          . ,     ,      .     </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persion</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span>(converter = CustomJsonConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PassportInfo passportInfo; }</code> </pre> <br><p>     <code>PassportInfo</code>    .     ,  .  ,  <code>composite</code>    .       . </p><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Field&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> composite; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Ref ref = (Ref) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(path, ref.path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;[this]&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + path.stream().map(Field::getName).collect(joining(<span class="hljs-string"><span class="hljs-string">"."</span></span>)) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Ref </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thisRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ref(emptyList(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ref parent, Field field, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parent.isComposite()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field))<span class="hljs-comment"><span class="hljs-comment">//    ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.add(field); return of(new Ref(path, configuration.isCompositeField(field))); } public static Optional&lt;Ref&gt; childRef(Ref parent, Ref child) { if (!parent.isComposite()) return empty(); if (child.path.stream().anyMatch(parent.path::contains))// ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.addAll(child.path); return of(new Ref(path, child.composite)); } }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Set&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRefs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> refs; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.equals(o)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Value value = (Value) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(refs, value.refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.hashCode(), refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"("</span></span> + refs.stream().map(Object::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">","</span></span>)) + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typedValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Ref ref)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, singleton(ref)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, Value child)</span></span></span><span class="hljs-function"> </span></span>{ Type type = child.getType(); Set&lt;Ref&gt; fields = parent.refs.stream() .flatMap(p -&gt; child.refs.stream().map(c -&gt; childRef(p, c))) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, FieldInsnNode childInsn, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ Type type = Type.getType(childInsn.desc); Field child = resolveField(childInsn); Set&lt;Ref&gt; fields = parent.refs.stream() .map(p -&gt; childRef(p, child, configuration)) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;Value&gt; values)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Type&gt; types = values.stream().map(BasicValue::getType).distinct().collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (types.size() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { String typesAsString = types.stream().map(Type::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">", "</span></span>, <span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + typesAsString); } Set&lt;Ref&gt; fields = values.stream().flatMap(v -&gt; v.refs.stream()).distinct().collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(types.get(<span class="hljs-number"><span class="hljs-number">0</span></span>), fields); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value &amp;&amp; value.getType().getSort() == Type.OBJECT &amp;&amp; ((Value) value).refs.stream().anyMatch(Ref::isComposite); } }</code> </pre> </div></div><br><p>   ,    .  Lass uns gehen! </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldsInterpreter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicInterpreter</span></span></span><span class="hljs-class"> </span></span>{</code> </pre> <br><p>       ,    <code>BasicInterpreter</code> .    <code>BasicValue</code> (    ,   <code>Value</code>  <code>extends BasicValue</code> )      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue UNINITIALIZED_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue INT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.INT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue FLOAT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.FLOAT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue LONG_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.LONG_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue DOUBLE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.DOUBLE_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue REFERENCE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.getObjectType(<span class="hljs-string"><span class="hljs-string">"java/lang/Object"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue RETURNADDRESS_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.VOID_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Type type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.type = type; } }</code> </pre> <br><p>         ( <code>(Value)basicValue</code> )  ,          ,     ( " <code>iconst</code>  ")  . </p><br><p>   <code>newValue</code> .       ,       ,  " ".   , <code>this</code>     <code>catch</code> .  ,     ,     .    <code>BasicInterpreter</code>  <code>BasicValue(actualType)</code>   <code>BasicValue.REFERENCE_VALUE</code> .       . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; type.getSort() == OBJECT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.newValue(type); }</code> </pre> <br><p>  entry point.      <code>this</code> . ,  - ,  ,   <code>this</code> ,     <code>BasicValue(actualType)</code> ,  <code>Value.typedValue(actualType, Ref.thisRef())</code> . ,     ,   <code>this</code>    <code>newValue</code> ,     .       , ..         ,   <code>this</code> .     <code>this</code>    . ,  . ,     <code>this</code>       0.       ,      .   ,            ,  .             . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wasUpdated || insn.getType() != VAR_INSN || ((VarInsnNode) insn).<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ALOAD: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typedValue(value.getType(), thisRef()); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ISTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ASTORE: wasUpdated = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); }</code> </pre> <br><p>  Mach weiter.    .    ,   ,    ,   ‚Äî ,   .   ,    . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue v, BasicValue w)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v.equals(w)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value || w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Objects.equals(v.getType(), w.getType())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v == UNINITIALIZED_VALUE || w == UNINITIALIZED_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UNINITIALIZED_VALUE; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + v + <span class="hljs-string"><span class="hljs-string">" and "</span></span> + w); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value != w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> w; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(asList((Value) v, (Value) w)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.merge(v, w); }</code> </pre> <br><p>    .      ""?         ?  Nicht wirklich.          .        , ..       . ,      3 (       ): <code>putfield</code> , <code>putstatic</code> , <code>aastore</code> .    .     <code>putstatic</code> (   )    .     ,          .    <code>putfield</code>  <code>aastore</code> .   ,           ,      .   (  )              .            ,             . ,    ‚Äî      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>    ,        ( <code>ofNullable</code>    <code>Optional</code>  <code>client</code>      <code>value</code> ),         . .     . ,         - <code>ofNullable(client)</code> ,    - <code>map(Client::getId)</code> ,    . </p><br><p>        <code>putfield</code> , <code>putstatic</code>  <code>aastore</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == PUTFIELD &amp;&amp; Value.isComposite(value2)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value2 + <span class="hljs-string"><span class="hljs-string">" over putfield"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.binaryOperation(insn, value1, value2); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2, BasicValue value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == AASTORE &amp;&amp; Value.isComposite(value3)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value3 + <span class="hljs-string"><span class="hljs-string">" over aastore"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.ternaryOperation(insn, value1, value2, value3); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PUTSTATIC: { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value + <span class="hljs-string"><span class="hljs-string">" over putstatic"</span></span>); } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>   .       <code>checkcast</code> .          :      .  ‚Äî    </p><br><pre> <code class="java hljs">Client client1 = ...; Object objClient = client1; Client client2 = (Client) objClient;</code> </pre> <br><p>         ,        .         ,   ,       <code>client1</code>  <code>objClient</code> ,   . ,   <code>checkcast</code>          . </p><br><p>     . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;?&gt; list; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trimToSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ((ArrayList&lt;?&gt;) list).trimToSize(); } }</code> </pre> <br><p>      .       ,      ,  ,     .  ,   ,         ,        ,    ,     .          ?  , !       .   ,          ,  ,              null/0/false.    .   ‚Äî   </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>    ,       , ORM      ,    .       <code>checkcast</code> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CHECKCAST: { Class&lt;?&gt; original = reflectClass(value.getType()); Type targetType = getObjectType(((TypeInsnNode) insn).desc); Class&lt;?&gt; afterCast = reflectClass(targetType); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (afterCast.isAssignableFrom(original)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"type specification not supported"</span></span>); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>     ‚Äî <code>getfield</code> .      ‚Äî   ? </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Foo child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Foo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Foo loopedRef = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ThreadLocalRandom.current().nextBoolean()) { loopedRef = loopedRef.child; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> loopedRef; } }</code> </pre> <br><p> ,        .     ? <code>child</code> , <code>child.child</code> , <code>child.child.child</code> ?  ? ,       .  ,        .       , </p><br><blockquote>           null. </blockquote><p>        child,       null, , ,     .        <code>Ref.childRef</code>  </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty();</code> </pre> <br><p>    .       ,    . </p><br><p>       "  ".          .   ,           . ,   ,       ( <code>@JdbcJoinedObject</code> ,  <code>@JdbcColumn</code> ),      ,    . ORM        . </p><br><p> ,   <code>getfield</code>           ,     .     ,   ,     ,      .  ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GETFIELD: { Optional&lt;Value&gt; optionalFieldValue = childValue((Value) value, (FieldInsnNode) insn, configuration); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!optionalFieldValue.isPresent()) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; Value fieldValue = optionalFieldValue.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configuration.isInterestingField(resolveField((FieldInsnNode) insn))) { context.addUsedField(fieldValue); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(fieldValue)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldValue; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>    .  ,    , .   ,    <code>invoke*</code> .         , ,   ,        .  , : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getClient().getId(); }</code> </pre> <br><p>  ,      ,     .           ,   .    .      ,          .    ?          .    .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Client </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } }</code> </pre> <br><p>  <code>Account.client</code>          .   ,      .        .    ‚Äî        ,     . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Value&gt; usedFields; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Value returnedCompositeValue; }</code> </pre> <br><p>    ?  ,   .          .  , ..      (  ,   ‚Äî  ),   ,       <code>areturn</code> , ,   ,    <code>*return</code> .  <code>MethodNode</code> ( ,     Tree API)       .     .  ‚Äî          . ,             ?      .         . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnedCompositeValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Frame&lt;BasicValue&gt;[] frames, AbstractInsnNode[] insns)</span></span></span><span class="hljs-function"> </span></span>{ Set&lt;Value&gt; resultValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; insns.length; i++) { AbstractInsnNode insn = insns[i]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ARETURN: BasicValue value = frames[i].getStack(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { resultValues.add((Value) value); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(resultValues); }</code> </pre> <br><p>    <code>analyzeField</code>   </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyzeField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Modifier.isNative(method.getModifiers())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not analyze native method "</span></span> + method); MethodInfo methodInfo = readMethod(method); MethodNode mn = methodInfo.getMethodNode(); String internalClassName = methodInfo.getInternalDeclaringClassName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess = methodInfo.getClassAccess(); Context context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(method, classAccess); FieldsInterpreter interpreter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldsInterpreter(context, configuration); Analyzer&lt;BasicValue&gt; analyzer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Analyzer&lt;&gt;(interpreter); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { analyzer.analyze(internalClassName, mn); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AnalyzerException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } Frame&lt;BasicValue&gt;[] frames = analyzer.getFrames(); AbstractInsnNode[] insns = mn.instructions.toArray(); Value returnedCompositeValue = getReturnedCompositeValue(frames, insns); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result(context.getUsedFields(), returnedCompositeValue); }</code> </pre> <br><p>   , -,     . <code>invoke*</code> .      5 : </p><br><ol><li> <code>invokespecial</code> ‚Äî      .    ,  ,   (     <code>super.call()</code> ). </li><li> <code>invokevirtual</code> ‚Äî     .          . ,        . </li><li> <code>invokeinterface</code> ‚Äî   ,   <code>invokevirtual</code> ,    ‚Äî      . </li><li> <code>invokestatic</code> ‚Äî    </li><li> <code>invokedynamic</code> ‚Äî  ,   7    JSR 292.          JVM,   <code>invokedynamic</code>       (     dynamic).   ,          (+  ),        .  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Invokedynamic:   ?</a>  . </li></ol><br><p>  ,      ,       ,      .  <code>invokedynamic</code>   ,   .  ,      ,       ,     (,       ),   <code>invokedynamic</code>  .   ,   ""  .  ,         <code>invokedynamic</code> ,      . </p><br><p>  Mach weiter. ,         .  ,        . ,      <code>this</code> ,     0? ,    - ,         <code>FieldsInterpreter</code>   <code>copyOperation</code>     .  ,    <code>MethodAnalyzer.analyzeFields</code>    "     <code>this</code> "  "      " ( <code>this</code> ‚Äî  ).     ,   .   ,   ,  .          ,               - .    ,         (- <code>Optional.ofNullable(client)</code> ).             . </p><br><p> , <code>invokestatic</code>   (..   ,  <code>this</code>   ).  <code>invokespecial</code> , <code>invokevirtual</code>  <code>invokeinterface</code> .  ,         .  ,      ,     jvm.  <code>invokespecial</code>  ,               ,     .    <code>invokevirtual</code>  <code>invokeinterface</code> .   ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objectToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.toString(); }</code> </pre> <br><pre> <code class="plaintext hljs">public static java.lang.String objectToString(java.lang.Object); Code: 0: aload_0 1: invokevirtual #104 // Method java/lang/Object.toString:()Ljava/lang/String; 4: areturn</code> </pre> <br><p> , ,    ( )  . ,       ,    .            ?        <em>  ORM</em> .  ORM   ,            ,     .      <code>invokevirtual</code>  <code>invokeinterface</code>   . </p><br><p>  Hurra!   .  Was weiter?      ,        (         ,     <code>this</code>  ),     ( ,    )       .  ! </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends BasicValue&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ Method method = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Value methodThis = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESPECIAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEVIRTUAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEINTERFACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>))) { MethodInsnNode methodNode = (MethodInsnNode) insn; Class&lt;?&gt; objectClass = reflectClass(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getType()); Method interfaceMethod = resolveInterfaceMethod(reflectClass(methodNode.owner), methodNode.name, getMethodType(methodNode.desc)); method = lookupInterfaceMethod(objectClass, interfaceMethod); methodThis = (Value) values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); } List&lt;?&gt; badValues = values.stream().skip(<span class="hljs-number"><span class="hljs-number">1</span></span>).filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESTATIC: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEDYNAMIC: { List&lt;?&gt; badValues = values.stream().filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { MethodAnalyzer.Result methodResult = analyzeFields(method, configuration); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Value usedField : methodResult.getUsedFields()) { childValue(methodThis, usedField).ifPresent(context::addUsedField); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodResult.getReturnedCompositeValue() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Optional&lt;Value&gt; returnedValue = childValue(methodThis, methodResult.getReturnedCompositeValue()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (returnedValue.isPresent()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnedValue.get(); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.naryOperation(insn, values); }</code> </pre> <br><p>         .    ,      .  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">  JVMS</a>      1  1.            .   ‚Äî    .  ,   ,        .   ,     ..     ,   -    ,       2  ‚Äî   .         ,   ,       .   ,   ‚Äî .    ,   <a href="" rel="nofollow">ResolutionUtil</a>  <a href="" rel="nofollow">LookupUtil</a> . </p><br><p> ! </p><br><a name="7"></a><br><h3 id="chast-sedmaya-chto-esche-mozhno-dodelat">  .     </h3><br><p>  ,   80%   20%     20%   80% . ,     ,    ,   ? </p><br><ul><li><p>        .          . </p><br></li><li><p>       .    (..        ),        . ,    .        ,      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>     <code>Optional</code> ,   <code>ofNullable</code>     <code>getClientId</code>  ,  ,      <code>value</code>    .  ,        <code>returnedCompositeValue</code> ‚Äî  ,   ,     . , ,        (  )               ,  .        -.          ,    ,    ,  "  <code>value</code>  <code>Optional@1234</code>  <code>Client@5678</code> "   . </p><br></li><li><p>  <code>invokedynamic</code> ,     .    indy      ,      .    ,          . ,     .  ,         invokedynamic.     .    . ,           <code>java.lang.invoke.LambdaMetafactory.metafactory</code> .    ,  ,   ,      .    <code>java.lang.invoke.StringConcatFactory.makeConcat/makeConcatWithConstants</code> .     .          <code>toString()</code> . , ,  ,  ,  .    ,     ,   ,  /-     .            jvm,      .    ,  ,  .             .    .   ,  ,               .          indy .    ?     indy    ,     ‚Äî <code>CallSite</code> .           . , ,    <code>LambdaMetafactory.metafactory</code>       <code>getValue</code> ,         .       <code>getValue</code> .     (  )  .  , , ,   stateless. ,    !    -    ,      .  <code>CallSite</code>   <code>ConstantCallSite</code> , <code>MutableCallSite</code>  <code>VolatileCallSite</code> .    mutable  volatile   ,       ,   <code>ConstantCallSite</code>  .         "-   ". ,  ,    .    ,         VM,       . </p><br></li></ul><br><a name="8"></a><br><h3 id="posleslovie">  Nachwort </h3><br><p> - ,   .   -  <code>partialGet</code>     . ,    .   ,   ,       ,         ,   " "   . </p><br><p>  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de409043/">https://habr.com/ru/post/de409043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de409033/index.html">Versteckter Supercluster kann das Geheimnis der Milchstra√üe l√∂sen</a></li>
<li><a href="../de409035/index.html">Schlie√ülich besch√§ftigen wir uns mit Abschl√ºssen: der Ursache des Fregattenunfalls</a></li>
<li><a href="../de409037/index.html">3D-Scanner der neuen Generation EinScan-SE</a></li>
<li><a href="../de409039/index.html">PocketBook-2017: Erinnern Sie sich an das vergangene Jahr und fassen Sie es zusammen</a></li>
<li><a href="../de409041/index.html">Die Hinrichtung kann nicht begnadigt werden: Wir besch√§ftigen uns mit Zeichensetzung auf Englisch</a></li>
<li><a href="../de409045/index.html">Die geheime Verbindung von reiner Mathematik und Physik wird enth√ºllt</a></li>
<li><a href="../de409047/index.html">Neustart der gebrauchten ersten Stufe und Frachtkapsel zur ISS. Die NASA hat nichts dagegen</a></li>
<li><a href="../de409049/index.html">FDA genehmigt erste Gentherapie mit direkten genetischen Erkrankungen</a></li>
<li><a href="../de409051/index.html">Dmitry Muromtsev (ITMO) - √ºber ontologische Modellierung und die Bildung von Konversationsintelligenz</a></li>
<li><a href="../de409053/index.html">Startete einen Hubschrauber - bekam eine Geldstrafe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>