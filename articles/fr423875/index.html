<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçé üë©üèø‚Äçüè≠ üöâ Stockage d'un grand nombre de fichiers üí§ üõï üíÜüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonne sant√©, Hawkers! Dans le cadre du travail sur un projet de site de rencontres, il est devenu n√©cessaire d'organiser le stockage des photos des ut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stockage d'un grand nombre de fichiers</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423875/"><img src="https://habrastorage.org/webt/ti/up/px/tiuppxliueu75a1ycliw537yw-k.jpeg" alt="image"><br><br>  Bonne sant√©, Hawkers!  Dans le cadre du travail sur un projet de site de rencontres, il est devenu n√©cessaire d'organiser le stockage des photos des utilisateurs.  Selon les termes de r√©f√©rence, le nombre de photos par utilisateur est limit√© √† 10 fichiers.  Mais il peut y avoir des dizaines de milliers d'utilisateurs.  Surtout si l'on consid√®re que le projet dans sa forme actuelle existe d√©j√† depuis le d√©but du "z√©ro".  Autrement dit, il y a d√©j√† des milliers d'utilisateurs dans la base de donn√©es.  √Ä ma connaissance, presque tous les syst√®mes de fichiers r√©agissent tr√®s n√©gativement √† un grand nombre de n≈ìuds enfants dans un dossier.  Par exp√©rience, je peux dire que les probl√®mes commencent apr√®s 1000 √† 1500 fichiers / dossiers dans le dossier parent. <br><a name="habracut"></a><br>  <i>Clause de non-responsabilit√©.</i>  <i>J'ai cherch√© sur Google avant d'√©crire l'article et j'ai trouv√© plusieurs solutions au probl√®me en discussion (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ).</i>  <i>Mais je n'ai pas trouv√© une seule solution qui correspond exactement √† la mienne.</i>  <i>De plus, dans cet article, je ne partage que ma propre exp√©rience dans la r√©solution du probl√®me.</i> <br><br><h3>  Th√©orie </h3><br>  En plus de la t√¢che de stockage en tant que telle, il y avait √©galement une condition dans l'√©nonc√© des travaux, selon laquelle il √©tait n√©cessaire de laisser des l√©gendes et des l√©gendes pour les photos.  Bien s√ªr, vous ne pouvez pas vous passer d'une base de donn√©es.  Autrement dit, la premi√®re chose que nous faisons est de cr√©er un tableau dans lequel nous prescrivons le mappage des m√©tadonn√©es (signatures, titres, etc.) avec les fichiers sur le disque.  Chaque fichier correspond √† une ligne de la base de donn√©es.  En cons√©quence, chaque fichier a un identifiant. <br><br>  Une petite digression.  Parlons de l'auto-incr√©mentation.  Un site de rencontres peut compter une douzaine ou deux mille utilisateurs.  La question est de savoir combien d'utilisateurs passent g√©n√©ralement par le projet pendant toute la dur√©e de son existence.  Par exemple, le public actif de dating-ru est de plusieurs centaines de milliers.  Cependant, imaginez simplement combien d'utilisateurs sont rest√©s pendant la dur√©e de vie de ce projet;  combien d'utilisateurs ne sont pas activ√©s jusqu'√† pr√©sent.  Maintenant, ajoutons √† notre l√©gislation, qui nous oblige √† stocker des informations sur les utilisateurs pendant au moins six mois ... T√¥t ou tard, 4 avec un sou d' <b>UNSIGNED INT</b> se terminera.  Par cons√©quent, il est pr√©f√©rable de prendre <b>BIGINT</b> pour la cl√© primaire. <br><br>  Essayons maintenant d'imaginer un certain nombre de type <b>BIGINT</b> .  C'est 8 octets.  Chaque octet est compris entre 0 et 255. 255 n≈ìuds enfants sont tout √† fait normaux pour tout syst√®me de fichiers.  Autrement dit, nous prenons l'identifiant du fichier en repr√©sentation hexad√©cimale, nous le divisons en morceaux de deux caract√®res.  Nous utilisons ces morceaux comme noms de dossier, ces derniers comme nom de fichier physique.  PROFIT! <br><br> <code>0f/65/84/10/67/68/19/ff.file</code> <br> <br>  √âl√©gant et simple.  L'extension de fichier n'est pas importante ici.  Quoi qu'il en soit, le fichier sera fourni par un script qui donnera au navigateur un type MIME particulier, que nous stockerons √©galement dans la base de donn√©es.  De plus, le stockage d'informations sur le fichier dans la base de donn√©es vous permet de red√©finir le chemin d'acc√®s au navigateur.  Supposons que le fichier que nous avons se trouve r√©ellement par rapport au r√©pertoire du projet le long du chemin <code>/content/files/0f/65/84/10/67/68/19/ff.file</code> .  Et dans la base de donn√©es, vous pouvez y √©crire une URL, par exemple, <code>/content/users/678/files/somefile</code> .  Les SEO sont probablement assez souriants en ce moment.  Tout cela nous permet de ne plus nous soucier de l'emplacement physique du fichier. <br><br><h3>  Table dans la base de donn√©es </h3><br>  En plus de l'identifiant, du type MIME, de l'URL et de l'emplacement physique, nous stockons les fichiers md5 et sha1 dans le tableau pour filtrer les m√™mes fichiers si n√©cessaire.  Bien s√ªr, nous devons √©galement stocker les relations d'entit√© dans cette table.  Supposons l'ID utilisateur auquel appartiennent les fichiers.  Et si le projet n'est pas tr√®s important, alors dans le m√™me syst√®me, nous pouvons stocker, disons, des photographies de marchandises.  Par cons√©quent, nous allons √©galement stocker le nom de la classe d'entit√© √† laquelle appartient l'enregistrement. <br><br>  En parlant d'oiseaux.  Si vous fermez le dossier √† l'aide de .htaccess pour un acc√®s externe, le fichier ne peut √™tre obtenu que via le script.  Et dans le script, il sera possible de d√©terminer l'acc√®s au fichier.  Pour l'avenir, je dirai que dans mon CMS (o√π le projet susmentionn√© est actuellement en cours de sciage), l'acc√®s est d√©termin√© par des groupes d'utilisateurs de base, dont j'ai 8 - invit√©s, utilisateurs, gestionnaires, administrateurs, inactifs, bloqu√©s, supprim√©s et super-administrateurs.  Le super-administrateur peut absolument tout faire, il ne participe donc pas √† la d√©termination de l'acc√®s.  Si l'utilisateur a un drapeau de super-administrateur, il est alors super-administrateur.  Tout est simple.  Autrement dit, nous d√©terminerons l'acc√®s aux sept groupes restants.  L'acc√®s est simple - soit donner le fichier ou ne pas donner.  Au total, vous pouvez prendre un champ de type <b>TINYINT</b> . <br><br>  Et encore une chose.  Selon notre loi, nous devrons stocker physiquement des images personnalis√©es.  Autrement dit, nous devons en quelque sorte marquer les images comme supprim√©es, au lieu de les supprimer physiquement.  Il est plus pratique d'utiliser un champ de bits √† ces fins.  Dans de tels cas, j'utilise g√©n√©ralement un champ de type <b>INT</b> .  Pour r√©server, pour ainsi dire.  De plus, j'ai une tradition d√©j√† √©tablie de placer le drapeau <b>SUPPRIM√â</b> dans le 5e bit depuis la fin.  Mais cela n'a plus d'importance √† nouveau. <br><br>  Qu'avons-nous en cons√©quence: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">`files`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> auto_increment, <span class="hljs-comment"><span class="hljs-comment">--   `entity_type` char(32) not null default '', --   `entity` bigint null, -- ID  `mime` char(32) not null default '', -- MIME- `md5` char(32) not null default '', -- MD5 `sha1` char(40) not null default '', -- SHA1 `file` char(64) not null default '', --   `url` varchar(250) not null default '', -- URL `meta` text null, -- -   JSON    `size` bigint not null default '0', --  `created` datetime not null, --   `updated` datetime null, --   `access` tinyint not null default '0', --   `flags` int not null default '0', --  primary key (`id`), index (`entity_type`), index (`entity`), index (`mime`), index (`md5`), index (`sha1`), index (`url`) ) engine = InnoDB;</span></span></code> </pre> <br><h3>  Classe Dispatcher </h3><br>  Maintenant, nous devons cr√©er une classe avec laquelle nous allons t√©l√©charger des fichiers.  La classe devrait permettre de cr√©er des fichiers, de remplacer / modifier des fichiers, de supprimer des fichiers.  En outre, il convient de consid√©rer deux points.  Tout d'abord, le projet peut √™tre transf√©r√© de serveur en serveur.  Donc, dans la classe, vous devez d√©finir une propri√©t√© qui contient le r√©pertoire racine des fichiers.  Deuxi√®mement, ce sera tr√®s d√©sagr√©able si quelqu'un frappe une table dans la base de donn√©es.  Vous devez donc pr√©voir la possibilit√© de r√©cup√©ration des donn√©es.  Avec le premier, tout est g√©n√©ralement clair.  Quant √† la sauvegarde des donn√©es, nous ne r√©serverons que ce qui ne peut pas √™tre restaur√©. <br><br>  <b>ID</b> - restaur√© √† partir de l'emplacement physique du fichier <br>  <b>entity_type</b> - non restaur√© <br>  <b>entit√©</b> - non restaur√©e <br>  <b>mime</b> - restaur√© √† l'aide de l'extension finfo <br>  <b>md5</b> - est restaur√© √† partir du fichier lui-m√™me <br>  <b>sha1</b> - restaur√© √† partir du fichier lui-m√™me <br>  <b>fichier</b> - restaur√© √† partir de l'emplacement physique du fichier <br>  <b>URL</b> - non restaur√©e <br>  <b>m√©ta</b> - non restaur√© <br>  <b>taille</b> - restaur√©e √† partir du fichier lui-m√™me <br>  <b>cr√©√©</b> - vous pouvez prendre des informations √† partir d'un fichier <br>  <b>mis √† jour</b> - vous pouvez extraire des informations d'un fichier <br>  <b>acc√®s</b> - non restaur√© <br>  <b>drapeaux</b> - non restaur√©s <br><br>  Vous pouvez imm√©diatement supprimer les m√©ta-informations.  Il n'est pas essentiel au fonctionnement du syst√®me.  Et pour une r√©cup√©ration plus rapide, vous devez toujours enregistrer le type MIME.  Total: type d'entit√©, ID d'entit√©, MIME, URL, acc√®s et indicateurs.  Afin d'augmenter la fiabilit√© du syst√®me, nous stockons les informations de sauvegarde pour chaque dossier de destination s√©par√©ment dans le dossier lui-m√™me. <br><br><div class="spoiler">  <b class="spoiler_title">Code de classe</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BigFiles</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FLAG_DELETED = <span class="hljs-number"><span class="hljs-number">0x08000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    "" /** @var mysqli $_db */ protected $_db = null; protected $_webRoot = ''; protected $_realRoot = ''; function __construct(mysqli $db = null) { $this-&gt;_db = $db; } /** * /   URL- * @param string $v  * @return string */ public function webRoot($v = null) { if (!is_null($v)) { $this-&gt;_webRoot = $v; } return $this-&gt;_webRoot; } /** * /    * @param string $v  * @return string */ public function realRoot($v = null) { if (!is_null($v)) { $this-&gt;_realRoot = $v; } return $this-&gt;_realRoot; } /** *   * @param array $data   * @param string $url URL   * @param string $eType   * @param int $eID ID  * @param mixed $meta - * @param int $access  * @param int $flags  * @param int $fileID ID   * @return bool * @throws Exception */ public function upload(array $data, $url, $eType = '', $eID = null, $meta = null, $access = 127, $flags = 0, $fileID = 0) { $meta = is_array($meta) ? serialize($meta) : $meta; if (empty($data['tmp_name']) || empty($data['name'])) { $fid = intval($fileID); if (empty($fid)) { return false; } $meta = empty($meta) ? 'null' : "'" . $this-&gt;_db-&gt;real_escape_string($meta) . "'"; $q = "`meta`={$meta},`updated`=now()"; $this-&gt;_db-&gt;query("UPDATE `files` SET {$q} WHERE (`id` = {$fid}) AND (`entity_type` = '{$eType}')"); return $fid; } // File data $meta = empty($meta) ? 'null' : "'" . $this-&gt;_db-&gt;real_escape_string($meta) . "'"; $finfo = finfo_open(FILEINFO_MIME_TYPE); $mime = finfo_file($finfo , $data['tmp_name']); finfo_close($finfo); // FID, file name if (empty($fileID)) { $eID = empty($eID) ? 'null' : intval($eID); $q = &lt;&lt;&lt;sql insert into `files` set `mime` = '{$mime}', `entity` = {$eID}, `entityType` = '{$eType}', `created` = now(), `access` = {$access}, `flags` = {$flags} sql; $this-&gt;_db-&gt;query($q); $fid = $this-&gt;_db-&gt;insert_id; list($ffs, $fhn) = self::fid($fid); $url = $this-&gt;_webRoot . $url . '/' . $fid; $fdir = $this-&gt;_realRoot . $ffs; self::validateDir($fdir); $index = self::getIndex($fdir); $index[$fhn] = array($fhn, $mime, $url, ($eID == 'null' ? 0 : $eID), $access, $flags); self::setIndex($fdir, $index); $fname = $ffs . '/' . $fhn . '.file'; } else { $fid = intval($fileID); $fname = $this-&gt;fileName($fid); } // Move file $fdir = $this-&gt;_realRoot . $fname; if (!move_uploaded_file($data['tmp_name'], $fdir)) { throw new Exception('Upload error'); } $q = '`md5`=\'' . md5_file($fdir) . '\',`sha1`=\'' . sha1_file($fdir) . '\',' . '`size`=' . filesize($fdir) . ',`meta`=' . $meta . ',' . (empty($fileID) ? "`url`='{$url}',`file`='{$fname}'" : '`updated`=now()'); $this-&gt;_db-&gt;query("UPDATE `files` SET {$q} WHERE (`id` = {$fid}) AND (`entity_type` = '{$eType}')"); return $fid; } /** *   * @param string $url URL * @param string $basicGroup    * @throws Exception */ public function read($url, $basicGroup = 'anonimous') { if (!ctype_alnum(str_replace(array('/', '.', '-', '_'), '', $url))) { header('HTTP/1.1 400 Bad Request'); exit; } $url = $this-&gt;_db-&gt;real_escape_string($url); $q = "SELECT * FROM `files` WHERE `url` = '{$url}' ORDER BY `created` ASC"; if ($result = $this-&gt;_db-&gt;query($q)) { $vars = array(); $ints = array('id', 'entity', 'size', 'access', 'flags'); while ($row = $result-&gt;fetch_assoc()) { foreach ($ints as $i) { $row[$i] = intval($row[$i]); } $fid = $row['id']; $vars[$fid] = $row; } if (empty($vars)) { header('HTTP/1.1 404 Not Found'); exit; } $deleted = false; $access = true; $found = ''; $mime = ''; foreach ($vars as $fdata) { $flags = intval($fdata['flags']); $deleted = ($flags &amp; self::FLAG_DELETED) != 0; $access = self::granted($basicGroup, $fdata['access']); if (!$access || $deleted) { continue; } $found = $fdata['file']; $mime = $fdata['mime']; } if (empty($found)) { if ($deleted) { header('HTTP/1.1 410 Gone'); exit; } elseif (!$access) { header('HTTP/1.1 403 Forbidden'); exit; } } else { header('Content-type: ' . $mime . '; charset=utf-8'); readfile($this-&gt;_realRoot . $found); exit; } } header('HTTP/1.1 404 Not Found'); exit; } /** *   ()   * @param mixed $fid () * @return bool * @throws Exception */ public function delete($fid) { $fid = is_array($fid) ? implode(',', $fid) : $fid; $q = "delete from `table` where `id` in ({$fid})"; $this-&gt;_db-&gt;query($q); $result = true; foreach ($fid as $fid_i) { list($ffs, $fhn) = self::fid($fid_i); $fdir = $this-&gt;_realRoot . $ffs; $index = self::getIndex($fdir); unset($index[$fhn]); self::setIndex($fdir, $index); $result &amp;= unlink($fdir . '/'. $fhn . '.file'); } return $result; } /** *  ()  "" * @param int $fid () * @param bool $value   * @return bool */ public function setDeleted($fid, $value=true) { $fid = is_array($fid) ? implode(',', $fid) : $fid; $o = $value ? ' | ' . self::FLAG_DELETED : ' &amp; ' . (~self::FLAG_DELETED); $this-&gt;_db-&gt;query("update `files` set `flags` = `flags` {$o} where `id` in ({$fid})"); return true; } /** *   * @param int $fid  * @return string * @throws Exception */ public function fileName($fid) { list($ffs, $fhn) = self::fid($fid); self::validateDir($this-&gt;_realRoot . $ffs); return $ffs . '/' . $fhn . '.file'; } /** *   . *           . * @param int $fid   * @return array */ public static function fid($fid) { $ffs = str_split(str_pad(dechex($fid), 16, '0', STR_PAD_LEFT), 2); $fhn = array_pop($ffs); $ffs = implode('/', $ffs); return array($ffs, $fhn); } /** *    * @param string $f     * @return bool * @throws Exception */ public static function validateDir($f) { if (!is_dir($f)) { if (!mkdir($f, 0700, true)) { throw new Exception('cannot make dir: ' . $f); } } return true; } /** *    * @param string $f       * @return array */ public static function getIndex($f) { $index = array(); if (file_exists($f . '/.index')) { $_ = file($f . '/.index'); foreach ($_ as $_i) { $row = trim($_i); $row = explode('|', $row); array_walk($row, 'trim'); $rid = $row[0]; $index[$rid] = $row; } } return $index; } /** *    * @param string $f       * @param array $index    * @return bool */ public static function setIndex($f, array $index) { $_ = array(); foreach ($index as $row) { $_[] = implode('|', $row); } return file_put_contents($f . '/.index', implode("\r\n", $_)); } /** *   * @param string $group   (. ) * @param int $value   * @return bool */ public static function granted($group, $value=0) { $groups = array('anonimous', 'user', 'manager', 'admin', 'inactive', 'blocked', 'deleted'); if ($group == 'root') { return true; } foreach ($groups as $groupID =&gt; $groupName) { if ($groupName == $group) { return (((1 &lt;&lt; $groupID) &amp; $value) != 0); } } return false; } }</span></span></code> </pre> <br></div></div><br>  Consid√©rez quelques points: <br><br>  - <b>realRoot</b> - le chemin complet vers le dossier avec le syst√®me de fichiers se terminant par une barre oblique. <br>  - <b>webRoot</b> - le chemin depuis la racine du site sans barre oblique (voir pourquoi ci-dessous). <br>  - En tant que SGBD, j'utilise l'extension <b>MySQLi</b> . <br>  - En fait, les informations du tableau <b>$ _FILES</b> sont pass√©es comme premier argument √† la m√©thode de <b>t√©l√©chargement</b> . <br>  - Si vous appelez la m√©thode de <b>mise</b> √† <b>jour</b> pour transmettre l'ID d'un fichier existant, elle sera remplac√©e si le tableau d'entr√©e dans <b>tmp_name</b> n'est pas vide. <br>  - Vous pouvez supprimer et modifier les drapeaux de fichiers plusieurs √† la fois.  Pour ce faire, au lieu de passer l'identifiant du fichier, vous devez passer soit un tableau avec des identifiants, soit une cha√Æne avec eux, s√©par√©s par des virgules. <br><br><h3>  Acheminement </h3><br>  En fait, cela se r√©sume √† quelques lignes dans htaccess √† la racine du site (on suppose que mod_rewrite est activ√©): <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteCond</span></span></span></span> <span class="hljs-variable"><span class="hljs-variable">%{REQUEST_URI}</span></span> ^/content/(.*)$ RewriteCond <span class="hljs-variable"><span class="hljs-variable">%{REQUEST_FILENAME}</span></span> !-f RewriteRule ^(.+)$ content/index.php?file=<span class="hljs-number"><span class="hljs-number">$1</span></span><span class="hljs-meta"><span class="hljs-meta"> [L,QSA]</span></span></code> </pre> <br>  ¬´Contenu¬ª est le dossier √† la racine du site dans mon cas.  Bien s√ªr, vous pouvez nommer le dossier diff√©remment.  Et bien s√ªr index.php lui-m√™me, stock√© dans mon cas dans le dossier de contenu: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dbHost = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $dbUser = <span class="hljs-string"><span class="hljs-string">'user'</span></span>; $dbPass = <span class="hljs-string"><span class="hljs-string">'****'</span></span>; $dbName = <span class="hljs-string"><span class="hljs-string">'database'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_REQUEST[<span class="hljs-string"><span class="hljs-string">'file'</span></span>])) { header(<span class="hljs-string"><span class="hljs-string">'HTTP/1.1 400 Bad Request'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; } $userG = <span class="hljs-string"><span class="hljs-string">'anonimous'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      ;      $files = new BigFiles(new mysqli($dbHost,$dbUser,$dbPass,$dbName)); $files-&gt;realRoot(dirname(__FILE__).'/files/'); $files-&gt;read($_REQUEST['file'],$userG); } catch (Exception $e) { header('HTTP/1.1 500 Internal Error'); header('Content-Type: text/plain; charset=utf-8'); echo $e-&gt;getMessage(); exit; }</span></span></code> </pre><br>  Eh bien, en soi, nous fermons le syst√®me de fichiers lui-m√™me de l'acc√®s externe.  Placez le fichier <code>.htaccess</code> √† la racine du dossier <code>content/files</code> avec une seule ligne: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">Deny</span></span></span></span> from <span class="hljs-literal"><span class="hljs-literal">all</span></span></code> </pre> <br><h3>  R√©sum√© </h3><br>  Cette solution √©vite la perte de performances du syst√®me de fichiers en raison d'une augmentation du nombre de fichiers.  Au moins, les probl√®mes sous la forme de milliers de fichiers dans un dossier peuvent certainement √™tre √©vit√©s.  Et en m√™me temps, nous pouvons organiser et contr√¥ler l'acc√®s aux fichiers √† des adresses lisibles par l'homme.  De plus, le respect de notre sombre l√©gislation.  Faites imm√©diatement une r√©servation, cette solution n'est PAS un moyen complet de prot√©ger le contenu.  N'oubliez pas: si quelque chose joue dans le navigateur, il peut √™tre t√©l√©charg√© gratuitement. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423875/">https://habr.com/ru/post/fr423875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423865/index.html">Roskomnadzor a rendu public</a></li>
<li><a href="../fr423867/index.html">Fondateur du studio d'impression 3D - √† propos de son travail</a></li>
<li><a href="../fr423869/index.html">L'avenir de l'emploi. L'essentiel du rapport du Forum √©conomique mondial</a></li>
<li><a href="../fr423871/index.html">Nous r√©solvons un probl√®me logique pour les √©tudiants en SQL</a></li>
<li><a href="../fr423873/index.html">Pr√©sentation de l'imprimante 3D PICASO 3D Designer X</a></li>
<li><a href="../fr423877/index.html">29-31 octobre: ‚Äã‚Äãcr√©ation d'un cluster Kubernetes pr√™t pour la production</a></li>
<li><a href="../fr423879/index.html">Est-il facile d'ajouter de nouvelles fonctionnalit√©s √† l'ancien framework? Farine de choix sur l'exemple du d√©veloppement de SObjectizer</a></li>
<li><a href="../fr423881/index.html">Quels √©taient les soudeurs pour l'optique (deuxi√®me partie)</a></li>
<li><a href="../fr423885/index.html">Une invitation √† un spectacle de lumi√®re et un petit initi√© de la future plateforme Circle of Light √† Moscou</a></li>
<li><a href="../fr423889/index.html">Ma d√©ception dans le logiciel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>