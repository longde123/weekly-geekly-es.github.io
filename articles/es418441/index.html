<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèæ üßú ü¶ó Conceptos b√°sicos de escalada de privilegios de Windows üìÉ üóø üîò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Decid√≠ por m√≠ mismo y para aquellos que lo encontrar√≠an √∫til, recopilar todo lo que s√©, pero no recuerdo sobre el tema, en este art√≠culo. Comparte con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conceptos b√°sicos de escalada de privilegios de Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418441/"> Decid√≠ por m√≠ mismo y para aquellos que lo encontrar√≠an √∫til, recopilar todo lo que s√©, pero no recuerdo sobre el tema, en este art√≠culo.  Comparte consejos.  La fuente principal de este art√≠culo es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta</a> . <br><br>  Traduje libremente y agregu√© un poco de m√≠ mismo, lo que reun√≠ y aprend√≠ de otras fuentes. <br><br>  En general, aqu√≠ hay formas de ayudarnos a lograr nuestro objetivo de escalada de privilegios. <br><a name="habracut"></a><br>  El punto de partida para este breve art√≠culo es un shell (cuenta) sin privilegios.  Quiz√°s usamos un exploit o realizamos un ataque y obtuvimos este shell. <br><br>  B√°sicamente, en el momento inicial, no entendemos la m√°quina: qu√© hace, a qu√© est√° conectada, qu√© nivel de privilegios tenemos o incluso qu√© sistema operativo es. <br><br>  Primero, necesitamos obtener la informaci√≥n que necesitamos para comprender d√≥nde estamos y qu√© tenemos: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systeminfo</span></span> | findstr /B /C:<span class="hljs-string"><span class="hljs-string">" "</span></span> /C:<span class="hljs-string"><span class="hljs-string">" "</span></span></code> </pre> <br>  Este comando le permite determinar, como puede ver en √©l, el nombre y la versi√≥n del sistema operativo.  Puede ejecutarlo sin par√°metros, luego la salida del comando ser√° m√°s completa, pero esto es suficiente para nosotros. <br><br>  A continuaci√≥n, es importante averiguar el nombre de la m√°quina y el nombre de usuario con el que estamos conectados. <br><br><ul><li>  hostname es el nombre de usuario. </li><li>  echo% username% - nombre de usuario. </li></ul><br>  A continuaci√≥n, veamos qu√© usuarios siguen en este host y obtengamos informaci√≥n m√°s detallada sobre su usuario. <br><br><ul><li>  usuarios netos - otros usuarios </li><li>  net user user1: informaci√≥n detallada sobre el usuario, donde user1 es el nombre de su usuario. </li></ul><br>  Habiendo recibido informaci√≥n sobre la cuenta, veremos informaci√≥n sobre la interacci√≥n de red de este host. <br><br>  Primero, eche un vistazo a las interfaces disponibles y la tabla de enrutamiento. <br><br><ul><li>  ipconfig / all: informaci√≥n sobre las interfaces disponibles. </li><li>  ruta de impresi√≥n - tabla de enrutamiento </li><li>  arp -A - tabla de entradas arp </li></ul><br>  A continuaci√≥n, veremos las conexiones de red activas y las reglas de firewall. <br><br><ul><li>  netstat -ano: conexiones de red activas. </li></ul><br>  -a: el inicio con este par√°metro muestra todas las conexiones TCP activas, as√≠ como los puertos TCP y UDP escuchados por el sistema; <br>  -n: el par√°metro le permite mostrar conexiones TCP activas con direcciones y n√∫meros de puerto; <br>  -o: al igual que la clave anterior, muestra las conexiones TCP activas, pero los c√≥digos de proceso se agregan a las estad√≠sticas, ya es posible determinar exactamente qu√© aplicaci√≥n usa la conexi√≥n. <br><br><ul><li>  estado del firewall de netsh show - estado del firewall </li><li>  netsh firewall show config - configuraci√≥n del firewall </li></ul><br>  Finalmente, examinamos brevemente qu√© funciona en un host comprometido: tareas programadas, procesos en ejecuci√≥n, servicios en ejecuci√≥n y controladores instalados. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">schtasks</span></span> /query /fo LIST /v</code> </pre> <br>  donde <br>  / query: muestra datos sobre todas las tareas programadas, <br>  / fo LIST - Lista de salida. <br>  / v - Imprimir detalles del trabajo. <br><br>  El siguiente comando asocia procesos en ejecuci√≥n con servicios en ejecuci√≥n. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tasklist</span></span> /SVC</code> </pre> <br>  donde <br>  / SVC: servicios de mapeo para cada proceso. <br><br>  Consulte tambi√©n una lista de los servicios de Windows en ejecuci√≥n. <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre> <br>  Tambi√©n es √∫til ver informaci√≥n sobre los controladores de un sistema comprometido. <br><br><pre> <code class="hljs">DRIVERQUERY</code> </pre> <br>  A continuaci√≥n, quiero mencionar sobre probablemente el comando de Windows m√°s √∫til: wmic.  El comando WMIC (Comando de instrumentaci√≥n de administraci√≥n de Windows) se utiliza para obtener informaci√≥n sobre el hardware y el sistema, administrar procesos y sus componentes, y cambiar la configuraci√≥n utilizando las capacidades de Instrumental de administraci√≥n de Windows (Instrumental de administraci√≥n de Windows o WMI).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Buena descripcion</a> . <br><br>  Desafortunadamente, algunas configuraciones de Windows no permiten el acceso a WMIC de manera predeterminada si el usuario no es miembro del grupo de Administradores (lo cual es una muy buena idea).  Cualquier versi√≥n de XP no permit√≠a el acceso a WMIC desde una cuenta sin privilegios. <br><br>  En contraste, Windows 7 Professional y Windows 8 Enterprise permitieron a los usuarios con bajos privilegios usar WMIC de manera predeterminada. <br><br>  Como de costumbre - par√°metros del programa: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wmic</span></span> /?</code> </pre> <br>  <a href="">Un buen gui√≥n para recopilar informaci√≥n a trav√©s de wmic.</a> <br><br>  Antes de continuar, vale la pena revisar la informaci√≥n recopilada.  Tambi√©n vale la pena prestar atenci√≥n a los parches instalados en el sistema, ya que cualquier informaci√≥n sobre los agujeros en el sistema nos dar√° soporte adicional para aumentar nuestros privilegios.  HotFix puede buscar vulnerabilidades de escalada de privilegios. <br><br>  A continuaci√≥n, consideraremos una instalaci√≥n desatendida.  Si es necesario instalar y configurar una gran flota de m√°quinas, entonces, por regla general, el personal t√©cnico no se mover√° de una m√°quina a otra para configurar cada una de ellas.  Existen varias soluciones para la instalaci√≥n desatendida.  No es tan importante para nosotros cu√°les son estos m√©todos y c√≥mo funcionan, pero lo que importa es que dejan los archivos de configuraci√≥n que se utilizan para el proceso de instalaci√≥n que contienen mucha informaci√≥n confidencial, como la clave del producto del sistema operativo y la contrase√±a del administrador.  Lo que m√°s nos interesa es la contrase√±a de administrador, que podemos usar para aumentar nuestros privilegios. <br><br>  Como regla general, estos son los siguientes directorios: <br><br><ul><li>  c: \ sysprep.inf </li><li>  c: \ sysprep \ sysprep.xml </li><li>  % WINDIR% \ Panther \ Unattend \ Unattended.xml </li><li>  % WINDIR% \ Panther \ Unattended.xml </li></ul><br>  Pero vale la pena revisar todo el sistema. <br><br>  Estos archivos contienen contrase√±as en texto claro o codificadas en BASE64. <br>  Ejemplos: <br><br>  Sysprep.inf: contrase√±a en texto sin cifrar. <br><br><img src="https://habrastorage.org/webt/fq/1t/qm/fq1tqm53bjiwjlwsbrevzdcy6qw.png">  " <br><br>  Sysprep.xml: contrase√±a codificada en base64. <br><br><img src="https://habrastorage.org/webt/rh/2r/gk/rh2rgkl3wtby-9lagcxmfrnrlgu.png">  " <br><br>  Unattended.xml: contrase√±a codificada en base64. <br><br><img src="https://habrastorage.org/webt/5e/1p/gl/5e1pglvwtogk0kd0xn4cmey_hlo.png"><br><br>  Adem√°s, para los hosts conectados al dominio, puede buscar el archivo Group.xml, que contiene la contrase√±a cifrada AES256, pero que puede descifrarse, porque  la clave se publica en msdn (https://msdn.microsoft.com/en-us/library/cc422924.aspx) y otras fuentes.  Pero este es el caso si se usa la pol√≠tica de crear usuarios locales en hosts o, por ejemplo, establecer una contrase√±a para un administrador local. <br><br>  Por ejemplo, tengo aqu√≠: <br><br><img src="https://habrastorage.org/webt/jy/wu/4g/jywu4g6xzymrbkwwniw4m_3uckg.png"><br><br>  Una vez abierto, estamos buscando el par√°metro "cpassword". <br><br><img src="https://habrastorage.org/webt/i9/ow/hk/i9owhkwprnwlpmltga00uj-awx4.png"><br><br>  A continuaci√≥n, debe descifrar esta secuencia.  Usamos, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CrypTool</a> .  Primero, decodifica Base64. <br>  Las caracter√≠sticas de Base64 son que su longitud debe ser un m√∫ltiplo de 4. Por lo tanto, consideramos bloques de 4, y si no hay suficientes caracteres en el √∫ltimo bloque, agregamos los caracteres que faltan con "=". <br>  Tengo 2 "=". <br><br><img src="https://habrastorage.org/webt/bm/sc/73/bmsc73fsqblniktrnrsyugqowhi.png"><br><br>  A continuaci√≥n lo desciframos.  Usando la tecla de arriba. <br><br><img src="https://habrastorage.org/webt/-f/n0/nt/-fn0ntf9um-zfyfoqpn7uwafoay.png"><br><br>  Eliminamos los puntos extra que separan los caracteres y obtenemos la contrase√±a. <br><br>  Adem√°s de Group.xml, aqu√≠ hay algunos otros archivos de preferencias de pol√≠ticas que pueden tener un conjunto adicional de atributos de cPassword: <br><br><ul><li>  Services \ Services.xml </li><li>  ScheduledTasks \ ScheduledTasks.xml </li><li>  Impresoras \ Impresoras.xml </li><li>  Drives \ Drives.xml </li><li>  DataSources \ DataSources.xml </li></ul><br>  Sin embargo, a todos nos encantan las soluciones automatizadas, por lo que podemos llegar a la l√≠nea de meta lo m√°s r√°pido posible.  Aqu√≠ hay dos opciones principales, seg√∫n el tipo de shell / acceso que tengamos.  Hay un m√≥dulo metasploit que se puede ejecutar a trav√©s de una sesi√≥n establecida (https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp) o puede usar Get-GPPPassword, que es parte de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PowerSploit</a> . <br><br>  De acuerdo, el siguiente.  Buscaremos el extra√±o par√°metro de registro "AlwaysInstallElevated".  Esta opci√≥n permite a los usuarios sin privilegios instalar archivos .msi desde NT AUTHORITY \ SYSTEM. <br><br>  Para poder usar esto, debemos verificar que ambas claves de registro est√©n instaladas y, de ser as√≠, podemos obtener un shell de SYSTEM.  Comprobar: <br><br><pre> <code class="hljs tex">reg query HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br><pre> <code class="hljs tex">reg query HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br>  Metasploit incluye un m√≥dulo especial exploit / windows / local / always_install_elevated, que crea un archivo MSI con un archivo ejecutable especial incorporado, que el instalador extrae y ejecuta con privilegios del sistema.  Despu√©s de su ejecuci√≥n, el archivo msi detiene la instalaci√≥n para evitar el registro de acciones en el sistema.  Adem√°s, si comienza la instalaci√≥n con el modificador / quiet, ni siquiera recibir√° un error. <br><br>  Bueno, algunos comandos de b√∫squeda √∫tiles en el sistema: <br><br>  El siguiente comando buscar√° en el sistema de archivos nombres de archivo que contengan palabras clave espec√≠ficas.  Puede especificar cualquier cantidad de palabras clave. <br><br><pre> <code class="hljs markdown">dir /s <span class="hljs-emphasis"><span class="hljs-emphasis">*pass*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*cred*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*vnc*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*.config*</span></span></code> </pre> <br>  Al buscar tipos de archivo espec√≠ficos por palabra clave, este comando puede generar muchos resultados. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">findstr</span></span> /si password <span class="hljs-regexp"><span class="hljs-regexp">*.xml</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.ini</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.txt</span></span></code> </pre> <br>  Del mismo modo, los dos comandos a continuaci√≥n se pueden utilizar para seleccionar el registro de palabras clave, en este caso, "contrase√±a". <br><br><pre> <code class="hljs pgsql">reg query HKLM /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br><pre> <code class="hljs pgsql">reg query HKCU /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br>  Por el momento, ya tenemos suficiente para poner en marcha el sistema.  Pero hay un par de ataques m√°s dirigidos para obtener el resultado deseado: analizaremos los servicios y permisos de Windows para archivos y carpetas.  Nuestro objetivo aqu√≠ es utilizar permisos d√©biles para mejorar los privilegios de sesi√≥n. <br><br>  Comprobaremos muchos derechos de acceso, accesschk.exe, que es una herramienta de Microsoft Sysinternals Suite, nos ayudar√° con esto.  Microsoft Sysinternals contiene muchas herramientas excelentes.  El paquete se puede descargar desde el sitio web de Microsoft Technet (https://docs.microsoft.com/ru-ru/sysinternals/downloads/sysinternals-suite). <br><br>  Podemos verificar el nivel de privilegio requerido para cada servicio usando accesschk. <br><br>  Podemos ver los permisos que tiene cada nivel de usuario. <br><br><img src="https://habrastorage.org/webt/jo/pf/q2/jopfq2pwodrwtcexiainzaji4yk.png"><br><br>  Accesschk puede verificar autom√°ticamente si tenemos acceso de escritura a un servicio de Windows con un nivel de usuario espec√≠fico.  Como regla general, como usuario con bajos privilegios, queremos verificar los "Usuarios".  Aseg√∫rese de verificar a qu√© grupos de usuarios pertenece. <br><br>  -c El nombre es un servicio de Windows, por ejemplo ssdpsrv (especifique "*" para mostrar todos los servicios) <br>  -d Solo procesa directorios <br>  -e solo muestra los niveles de integridad especificados expl√≠citamente (solo Windows Vista) <br>  -k El nombre es una clave de registro, por ejemplo, hklm \ software <br>  -n Mostrar solo objetos que no tienen reglas de acceso <br>  -p El nombre o identificador de proceso (PID) se especifica como el nombre, por ejemplo cmd.exe (especifique "*" como nombre para mostrar todos los procesos) <br>  -q Omitir encabezado <br>  -r Imprimir solo objetos que tienen acceso de lectura <br>  -s Procesamiento recursivo <br>  -v Imprimir informaci√≥n detallada <br>  -w Lista solo los objetos que tienen acceso de escritura <br><br><img src="https://habrastorage.org/webt/4z/1r/u6/4z1ru6mikuprkxybtdzohmzgl5s.png"><br><br>  Tambi√©n hay otro comando interesante: <br><br><pre> <code class="hljs dos">autorunsc.exe -a | <span class="hljs-built_in"><span class="hljs-built_in">findstr</span></span> /n /R "File\ <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>\ found"</code> </pre> <br>  Le permite encontrar una entrada de registro sobre un archivo que se inici√≥ autom√°ticamente, pero que ya falta en el sistema.  El registro podr√≠a permanecer si, por ejemplo, el servicio se elimin√≥ incorrectamente.  En cada inicio, el sistema intenta ejecutar este archivo sin √©xito.  Tambi√©n puede aprovechar esta situaci√≥n para ampliar su autoridad.  Simplemente sustituya este archivo por el nuestro. <br><br>  A continuaci√≥n, consideramos dos vulnerabilidades: <br><br>  Primero: replicar los resultados de una publicaci√≥n escrita por Parvez de GreyHatHacker;  "Elevar los privilegios explotando los permisos de carpetas d√©biles" (http://www.greyhathacker.net/?p=738). <br><br>  Este ejemplo es un caso especial de secuestro de dll.  Los programas generalmente no pueden funcionar por s√≠ solos, tienen muchos recursos que necesitan para conectarse (principalmente dll, pero tambi√©n sus propios archivos).  Si un programa o servicio descarga un archivo de un directorio en el que tenemos acceso de escritura, podemos abusar de √©l para iniciar un shell con privilegios bajo los cuales se ejecuta el programa. <br><br>  Por lo general, una aplicaci√≥n de Windows usar√° rutas de b√∫squeda predefinidas para encontrar el archivo dll, y verificar√° estas rutas en un orden espec√≠fico.  El secuestro de Dll generalmente ocurre colocando dlls maliciosos a lo largo de una de estas rutas.  Este problema se puede solucionar indicando a la aplicaci√≥n rutas absolutas a la dll requerida. <br><br>  Orden de b√∫squeda de dll: <br><br><ol><li>  El directorio desde el que se ejecuta la aplicaci√≥n. </li><li>  Directorio del sistema de 32 bits (C: \ Windows \ System32) </li><li>  Directorio del sistema de 16 bits (C: \ Windows \ System) </li><li>  Directorio de Windows (C: \ Windows) </li><li>  Directorio de trabajo actual (CWD) </li><li>  Directorios en la variable de entorno PATH (sistema luego usuario) </li></ol><br>  A veces, las aplicaciones intentan descargar archivos dll que faltan en la m√°quina.  Esto puede suceder por varias razones, por ejemplo, si la biblioteca dll solo es necesaria para ciertos complementos o componentes que no est√°n instalados.  En este caso, Parvez descubri√≥ que algunos servicios de Windows est√°n intentando cargar bibliotecas dll que no existen en la configuraci√≥n predeterminada. <br><br>  Como el dll no existe, terminamos recorriendo todas las rutas de b√∫squeda.  Como usuario con un nivel de privilegio bajo, tenemos pocas posibilidades de colocar una dll maliciosa en los elementos 1-4, 5. Pero si tenemos acceso de escritura a cualquiera de los directorios, entonces nuestras posibilidades de ganar son grandes. <br><br>  Veamos c√≥mo funciona en la pr√°ctica, para nuestro ejemplo utilizaremos el servicio IKEEXT (IPSec IKE y m√≥dulos de clave AuthIP) que intenta descargar wlbsctrl.dll. <br><br>  Cualquier directorio en "C: \" proporcionar√° acceso de escritura para usuarios autenticados, esto nos da una oportunidad. <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; accesschk.exe -dqv "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs pgsql">C:\Python27 Medium Mandatory <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>) [<span class="hljs-keyword"><span class="hljs-keyword">No</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>-Up] RW BUILTIN\Administrators FILE_ALL_ACCESS RW NT AUTHORITY\<span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span> FILE_ALL_ACCESS R BUILTIN\Users FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE SYNCHRONIZE READ_CONTROL RW NT AUTHORITY\Authenticated Users FILE_ADD_FILE FILE_ADD_SUBDIRECTORY FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE FILE_WRITE_ATTRIBUTES FILE_WRITE_EA <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> SYNCHRONIZE READ_CONTROL</code> </pre><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; icacls "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27 BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(OI)(CI)(IO)(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(OI)(CI)(IO)(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span>:(OI)(CI)(ID)R NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(ID)C NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(OI)(CI)(IO)(ID)C</code> </pre><br>  F - acceso completo. <br>  (OI) - herencia por objetos. <br>  (CI) - herencia por contenedores. <br>  (IO) - solo herencia. <br>  (NP): prohibici√≥n de la distribuci√≥n de la herencia. <br>  (I): hereda los permisos del contenedor principal. <br><br>  Antes de continuar con la acci√≥n, debe verificar el estado del servicio IKEEXT.  ¬°En este caso, podemos ver que est√° configurado en "AUTO_START"! <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sc</span></span> qc IKEEXT</code> </pre> <br><pre> <code class="hljs tex">[SC] QueryServiceConfig SUCCESS SERVICE_NAME: IKEEXT TYPE : 20 WIN32_SHARE_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svchost</span></span></span></span>.exe -k netsvcs LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : IKE and AuthIP IPsec Keying Modules DEPENDENCIES : BFE SERVICE_START_NAME : LocalSystem</code> </pre> <br>  ¬°Ahora sabemos que tenemos las condiciones necesarias, y podemos crear un dll malicioso e interceptar el shell! <br><br>  Usamos Metasploit -&gt; msfvenom, por ejemplo. <br><br><img src="https://habrastorage.org/webt/ac/-m/_z/ac-m_z8lymihvi6r6g3dsxmebr8.png"><br><br>  Despu√©s de transferir evil.dll a nuestra computadora de destino, todo lo que tenemos que hacer es cambiarle el nombre a wlbsctrl.dll y moverlo a "C: \ Python27".  Una vez hecho esto, debemos esperar pacientemente a que la m√°quina se reinicie (o podemos intentar forzar el reinicio), y obtendremos el shell del sistema. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">copy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">evil</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Python27</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">wlbsctrl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre> <br>  Despu√©s de eso, solo queda esperar a que el sistema se reinicie. <br><br>  Para nuestro √∫ltimo ejemplo, consideraremos las tareas planificadas.  Describir√© el principio, porque  Todos pueden tener diferentes casos. <br><br>  Encontramos el proceso, servicio, aplicaci√≥n lanzada por el programador de tareas de SYSTEM. <br>  Verificamos los derechos de acceso a la carpeta donde se encuentra nuestro objetivo. <br><br><pre> <code class="hljs powershell">accesschk.exe <span class="hljs-literal"><span class="hljs-literal">-dqv</span></span> <span class="hljs-string"><span class="hljs-string">"__"</span></span></code> </pre> <br>  Est√° claro que este es un problema de configuraci√≥n grave, pero lo peor es el hecho de que cualquier usuario autenticado (usuario autenticado) tiene acceso de escritura a esta carpeta.  En este ejemplo, simplemente podemos sobrescribir el ejecutable binario con el archivo generado por metasploit. <br><br>  Se puede codificar opcionalmente. <br><br><img src="https://habrastorage.org/webt/7c/p6/qv/7cp6qviajkpgxvibpruzsgqhjv4.png"><br><br>  Ahora todo lo que queda es descargar el archivo ejecutable malicioso y sobrescribirlo en la carpeta del archivo ejecutable.  Una vez hecho esto, podemos irnos a la cama de manera segura y hacer una caminata sist√©mica temprano en la ma√±ana. <br><br>  Estos dos ejemplos deber√≠an darnos una idea de las vulnerabilidades que deben buscarse al considerar los permisos para archivos y carpetas.  Tomar√° tiempo aprender todas las rutas de binpath para servicios de Windows, tareas programadas y tareas de ejecuci√≥n autom√°tica. <br><br>  Finalmente, un par de consejos para usar accesschk.exe. <br><br>  Encuentre todos los permisos d√©biles para carpetas en el disco. <br><br><pre> <code class="hljs swift">accesschk.exe -uwdqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\ accesschk.exe -uwdqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\</code> </pre><br>  Encuentre todos los permisos d√©biles para archivos en disco. <br><br><pre> <code class="hljs swift">accesschk.exe -uwqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.* accesschk.exe -uwqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.*</code> </pre> <br>  Como todo </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es418441/">https://habr.com/ru/post/es418441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es418429/index.html">Mi experiencia laboral para el papel del entrenador √°gil en Europa, segunda parte</a></li>
<li><a href="../es418431/index.html">Problemas imaginarios: la ra√≠z del mal software</a></li>
<li><a href="../es418433/index.html">4 de agosto Peter La primera b√∫squeda de bicicletas para programadores</a></li>
<li><a href="../es418437/index.html">Oc equipo al rescate</a></li>
<li><a href="../es418439/index.html">Conceptos b√°sicos de aplicaciones web progresivas</a></li>
<li><a href="../es418443/index.html">GObject: encapsulaci√≥n, instanciaci√≥n, introspecci√≥n</a></li>
<li><a href="../es418445/index.html">Canales de Django: la respuesta a la web moderna</a></li>
<li><a href="../es418447/index.html">Por qu√© Mosc√∫ Python Conf es ahora ++</a></li>
<li><a href="../es418449/index.html">M√≥dulos binarios para Python</a></li>
<li><a href="../es418451/index.html">Lecciones de impresi√≥n 3D. Soporte efectivo y cambio de altura de capa en la pr√°ctica desde 3Dtool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>