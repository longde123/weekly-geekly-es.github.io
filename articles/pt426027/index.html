<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ô†Ô∏è ‚õ∫Ô∏è üõ∞Ô∏è An√°lise de portf√≥lio de investimentos e servi√ßos em nuvem da Amazon üë©üèº‚Äçüç≥ üóúÔ∏è üî≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, houve alta volatilidade nos mercados de a√ß√µes, quando, por exemplo, um artigo est√°vel de uma empresa conhecida pode perder v√°rios por ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise de portf√≥lio de investimentos e servi√ßos em nuvem da Amazon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426027/">  Recentemente, houve alta volatilidade nos mercados de a√ß√µes, quando, por exemplo, um artigo est√°vel de uma empresa conhecida pode perder v√°rios por cento ao mesmo tempo com not√≠cias de san√ß√µes contra sua administra√ß√£o ou vice-versa, subir aos c√©us em um relat√≥rio positivo e expectativas dos investidores sobre dividendos super lucrativos. <br><br>  Como determinar se a propriedade de um determinado t√≠tulo trouxe renda ou apenas perdas e decep√ß√µes? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q3/2q/zs/q32qzs8fmzzpilpnbmfcek6l57a.png"></div>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">(Fonte)</a> <br><br>  Neste artigo, mostrarei como identificar e visualizar o resultado financeiro ajustado para t√≠tulos. <br><br>  Usando o exemplo de abertura de relat√≥rios do cliente, o Opening Broker, consideraremos a an√°lise e consolida√ß√£o dos relat√≥rios de corretagem para o mercado de a√ß√µes, construindo a arquitetura de um sistema de relat√≥rios em nuvem com posterior an√°lise simples e conveniente no AWS Quicksight. <br><a name="habracut"></a><br><h2>  Descri√ß√£o da tarefa </h2><br>  Muitos treinamentos e li√ß√µes educacionais nos dizem sobre a necessidade de um di√°rio do trader, onde todos os par√¢metros de transa√ß√£o s√£o registrados para an√°lise posterior e resumo da estrat√©gia de negocia√ß√£o.  Concordo que essa abordagem para trabalhar no Exchange permite disciplinar um profissional, aumentar sua consci√™ncia, mas tamb√©m pode cans√°-lo de um processo tedioso. <br><br>  Admito que, a princ√≠pio, tentei seguir cuidadosamente o conselho do registro em di√°rio, escrevi meticulosamente cada transa√ß√£o com seus par√¢metros em uma tabela do Excel, constru√≠ alguns relat√≥rios, gr√°ficos de resumo, planejei transa√ß√µes futuras, mas ... Eu estava rapidamente cansado de tudo. <br><br><div class="spoiler">  <b class="spoiler_title">Por que manter o di√°rio de um comerciante manualmente √© inconveniente?</b> <div class="spoiler_text"><ul><li>  o preenchimento manual do di√°rio (mesmo usando automa√ß√£o parcial, na forma de descarregar transa√ß√µes di√°rias do terminal de negocia√ß√£o) se cansa rapidamente; </li><li>  existe um alto risco de erro ou erro de digita√ß√£o na entrada manual; </li><li>  pode acontecer que um operador ativo se torne um investidor passivo e volte cada vez menos a esta revista e depois se esque√ßa completamente dela (meu caso);  bem e finalmente </li><li>  podemos programar, por que n√£o tirar proveito disso e automatizar todo o processo?  Ent√£o vamos l√°! </li></ul></div></div><br>  Freq√ºentemente, as corretoras s√£o organiza√ß√µes de alta tecnologia que fornecem aos clientes an√°lises de alta qualidade em quase todas as quest√µes de interesse.  √â justo dizer que esses relat√≥rios est√£o ficando cada vez melhores a cada atualiza√ß√£o, mas mesmo os mais avan√ßados podem n√£o ter a personaliza√ß√£o e a consolida√ß√£o que os clientes exigentes e inquisidores desejam ver. <br><br>  Por exemplo, o Opening Broker permite que voc√™ receba relat√≥rios de corretagem no formato XML em sua conta pessoal, mas se voc√™ tiver um IIA e uma conta corretagem regular na Bolsa de Valores de Moscou (MOEX), esses ser√£o dois relat√≥rios diferentes e se voc√™ tiver outra conta no St. Petersburg Stock Exchange (SPB), os dois primeiros adicionar√£o mais um. <br><br>  No total, para obter um di√°rio consolidado do investidor, ser√° necess√°rio processar tr√™s arquivos no formato XML. <br><br>  Os relat√≥rios acima mencionados sobre MOEX e SPB diferem ligeiramente em seus formatos, que precisam ser levados em considera√ß√£o no processo de implementa√ß√£o do mapeamento de dados. <br><br><h2>  Arquitetura do sistema em desenvolvimento </h2><br>  O diagrama abaixo mostra o modelo de arquitetura do sistema em desenvolvimento: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vv/uq/ed/vvuqedfvl-l8tnghx3v6vtujabc.jpeg"></div><br><h2>  Implementa√ß√£o do analisador </h2><br>  Receberemos relat√≥rios nas tr√™s contas da Conta Pessoal pelo per√≠odo m√°ximo poss√≠vel (podem ser divididos em v√°rios relat√≥rios para cada ano), salv√°-los no formato XML e coloc√°-los em uma pasta.  Como dados de teste para o estudo, usaremos uma carteira de clientes fict√≠cia, mas com par√¢metros o mais pr√≥ximo poss√≠vel das realidades do mercado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/og/ig/xw/ogigxw4yganahuuzbdqecsbqmry.png"></div><br>  Suponha que o investidor Sr. X em considera√ß√£o tenha uma pequena carteira de cinco t√≠tulos: <br><br><ol><li>  O relat√≥rio sobre a troca do SPB ter√° dois documentos: Apple e Microsoft; </li><li>  O relat√≥rio sobre a bolsa MOEX (corretagem) cont√©m um artigo: FGC UES; </li><li>  O relat√≥rio no MOEX Exchange (IIS) cont√©m dois t√≠tulos: MMK e OFZ 24019; </li></ol><br>  De acordo com nossos cinco t√≠tulos, pode haver transa√ß√µes de compra / venda, pagamento de dividendos e cupom, o pre√ßo pode mudar etc.  Queremos ver a situa√ß√£o no momento atual, a saber: o resultado financeiro, levando em considera√ß√£o todos os pagamentos, transa√ß√µes e valor de mercado atual. <br><br>  E aqui o Python entra em cena, lemos as informa√ß√µes de todos os relat√≥rios em uma matriz: <br><br><pre><code class="python hljs">my_files_list = [join(<span class="hljs-string"><span class="hljs-string">'Data/'</span></span>, f) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> listdir(<span class="hljs-string"><span class="hljs-string">'Data/'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isfile(join(<span class="hljs-string"><span class="hljs-string">'Data/'</span></span>, f))] my_xml_data = [] <span class="hljs-comment"><span class="hljs-comment">#     for f in my_files_list: tree = ET.parse(f) root = tree.getroot() my_xml_data.append(root)</span></span></code> </pre> <br><blockquote>  Para an√°lises, a partir dos relat√≥rios, precisamos de v√°rias entidades, a saber: <br><br><ul><li>  Posi√ß√µes de valores mobili√°rios em uma carteira; </li><li>  Neg√≥cios conclu√≠dos; </li><li>  Opera√ß√µes de n√£o negocia√ß√£o e outros movimentos de conta; </li><li>  Pre√ßos m√©dios das posi√ß√µes em aberto </li></ul></blockquote>  Para preparar a amostra, usaremos quatro dicion√°rios para descrever os conjuntos acima. <br><br><pre> <code class="python hljs">dict_stocks = {<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'account'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'currency'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'current_cost'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'current_cost_rub'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'saldo'</span></span> : []} dict_deals = {<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'account'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'date_oper'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'type_oper'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'quantity'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'price'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'currency'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'brokerage'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'result'</span></span>: []} dict_flows = {<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'account'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'date_oper'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'type_oper'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'result'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'currency'</span></span>: []} dict_avg_price = {<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'account'</span></span>: [], <span class="hljs-string"><span class="hljs-string">'avg_open_price'</span></span> : []}</code> </pre> <br>  Algumas palavras sobre o que esses dicion√°rios s√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Dicion√°rio dict_stocks</b> <div class="spoiler_text">  O dicion√°rio dict_stocks √© necess√°rio para armazenar informa√ß√µes gerais no portf√≥lio: <br><br><ul><li>  Nome do papel (stock_name); </li><li>  Nome da conta (SPB, MOEX BROK, MOEX IIS) (conta); </li><li>  Moeda usada para liquida√ß√µes neste documento (moeda); </li><li>  Valor atual (no momento da gera√ß√£o do relat√≥rio no Personal Account Opening Broker) (current_cost).  Aqui, quero observar que, para clientes com excesso de demanda, √© poss√≠vel fazer melhorias adicionais no futuro e usar o recebimento din√¢mico de uma cota√ß√£o de seguran√ßa de um terminal comercial ou do site da bolsa correspondente; </li><li>  O valor atual da posi√ß√£o de seguran√ßa no momento em que o relat√≥rio foi gerado (current_cost_rub) <br>  Da mesma forma que o item acima, aqui voc√™ tamb√©m pode obter a taxa do Banco Central no momento atual ou a taxa de c√¢mbio, como desejar. </li><li>  Saldo atual de t√≠tulos (saldo) </li></ul></div></div><br><div class="spoiler">  <b class="spoiler_title">Dicion√°rio dict_deals</b> <div class="spoiler_text">  O dicion√°rio dict_deals √© necess√°rio para armazenar as seguintes informa√ß√µes sobre transa√ß√µes conclu√≠das: <br><br><ul><li>  Nome do papel (stock_name); </li><li>  Nome da conta (SPB, MOEX BROK, MOEX IIS) (conta); </li><li>  Data da transa√ß√£o, ou seja,  T0 (data_operador); </li><li>  Tipo de opera√ß√£o (type_oper); </li><li>  O volume de t√≠tulos que participam da transa√ß√£o (quantidade); </li><li>  O pre√ßo pelo qual a transa√ß√£o foi executada (pre√ßo); </li><li>  Moeda na qual a transa√ß√£o foi realizada (moeda); </li><li>  Comiss√£o de corretagem para uma transa√ß√£o (corretagem); </li><li>  O resultado financeiro da transa√ß√£o (resultado) </li></ul></div></div><br><div class="spoiler">  <b class="spoiler_title">Dicion√°rio Dict_flows</b> <div class="spoiler_text">  O dicion√°rio dict_flows reflete a movimenta√ß√£o de fundos na conta do cliente e √© usado para armazenar as seguintes informa√ß√µes: <br><br><ul><li>  Nome do papel (stock_name); </li><li>  Nome da conta (SPB, MOEX BROK, MOEX IIS) (conta); </li><li>  Data da transa√ß√£o, ou seja,  T0 (data_operador); </li><li>  Tipo de opera√ß√£o (type_oper).  Pode levar v√°rios valores: div, NKD, tax; </li><li>  Moeda na qual a transa√ß√£o foi realizada (moeda); </li><li>  O resultado financeiro da opera√ß√£o (resultado) </li></ul></div></div><br><div class="spoiler">  <b class="spoiler_title">Dicion√°rio dict_avg_price</b> <div class="spoiler_text">  O dicion√°rio dict_avg_price √© necess√°rio para informa√ß√µes cont√°beis ao pre√ßo m√©dio de compra de cada artigo: <br><br><ul><li>  Nome do papel (stock_name); </li><li>  Nome da conta (SPB, MOEX BROK, MOEX IIS) (conta); </li><li>  Pre√ßo m√©dio de uma posi√ß√£o em aberto (avg_open_price) </li></ul></div></div><br>  Processamos uma matriz de documentos XML e preenchemos esses dicion√°rios com os dados apropriados: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       for XMLdata in my_xml_data: #      exchange_name = 'SPB' if XMLdata.get('board_list') == ' ' else 'MOEX' client_code = XMLdata.get('client_code') account_name = get_account_name(exchange_name, client_code) #   current_position, deals, flows, stock_name, \ saldo, ticketdate, price, brokerage, \ operationdate, currency, \ current_cost, current_cost_rub, \ stock_name_deal, payment_currency, currency_flows = get_allias(exchange_name) #      get_briefcase(XMLdata) df_stocks = pd.DataFrame(dict_stocks) df_stocks.set_index("stock_name", drop = False, inplace = True) #    get_deals(XMLdata) df_deals = pd.DataFrame(dict_deals) df_avg = pd.DataFrame(dict_avg_price) #       get_nontrade_operation(XMLdata) df_flows = pd.DataFrame(dict_flows)</span></span></code> </pre> <br>  Todo o processamento passa pelo loop sobre todos os dados XML dos relat√≥rios.  As informa√ß√µes sobre a plataforma de negocia√ß√£o, o c√≥digo do cliente, s√£o iguais em todos os relat√≥rios, para que voc√™ possa extra√≠-lo com seguran√ßa das mesmas tags sem usar o mapeamento. <br><br>  Mas temos que usar um design especial que forne√ßa o alias necess√°rio para a tag com base no relat√≥rio (SPB ou MOEX), porque  dados de natureza id√™ntica nesses relat√≥rios s√£o chamados de maneira diferente. <br><br><div class="spoiler">  <b class="spoiler_title">Discrep√¢ncias de tag</b> <div class="spoiler_text"><ul><li>  A comiss√£o do corretor de transa√ß√µes no relat√≥rio SBP est√° na etiqueta de <b>corretagem</b> e no relat√≥rio <b>MOEX</b> - <b>broker_commission</b> ; </li><li>  A data da transa√ß√£o da conta que n√£o √© de negocia√ß√£o no relat√≥rio SPB √© data da <b>opera√ß√£o</b> e, no MOEX, data da <b>opera√ß√£o</b> etc. </li></ul></div></div><br><div class="spoiler">  <b class="spoiler_title">Exemplo de mapeamento de tags</b> <div class="spoiler_text"><pre> <code class="python hljs">tags_mapping = { <span class="hljs-string"><span class="hljs-string">'SPB'</span></span>: { <span class="hljs-string"><span class="hljs-string">'current_position'</span></span>: <span class="hljs-string"><span class="hljs-string">'briefcase_position'</span></span>, <span class="hljs-string"><span class="hljs-string">'deals'</span></span>: <span class="hljs-string"><span class="hljs-string">'closed_deal'</span></span>, <span class="hljs-string"><span class="hljs-string">'flows'</span></span>: <span class="hljs-string"><span class="hljs-string">'nontrade_money_operation'</span></span>, ... <span class="hljs-string"><span class="hljs-string">'stock_name_deal'</span></span>: <span class="hljs-string"><span class="hljs-string">'issuername'</span></span>, <span class="hljs-string"><span class="hljs-string">'paymentcurrency'</span></span>: <span class="hljs-string"><span class="hljs-string">'paymentcurrency'</span></span>, <span class="hljs-string"><span class="hljs-string">'currency_flows'</span></span>: <span class="hljs-string"><span class="hljs-string">'currencycode'</span></span> }, <span class="hljs-string"><span class="hljs-string">'MOEX'</span></span>: { <span class="hljs-string"><span class="hljs-string">'current_position'</span></span>: <span class="hljs-string"><span class="hljs-string">'spot_assets'</span></span>, <span class="hljs-string"><span class="hljs-string">'deals'</span></span>: <span class="hljs-string"><span class="hljs-string">'spot_main_deals_conclusion'</span></span>, <span class="hljs-string"><span class="hljs-string">'flows'</span></span>: <span class="hljs-string"><span class="hljs-string">'spot_non_trade_money_operations'</span></span>, ... <span class="hljs-string"><span class="hljs-string">'stock_name_deal'</span></span>: <span class="hljs-string"><span class="hljs-string">'security_name'</span></span>, <span class="hljs-string"><span class="hljs-string">'paymentcurrency'</span></span>: <span class="hljs-string"><span class="hljs-string">'price_currency_code'</span></span>, <span class="hljs-string"><span class="hljs-string">'currency_flows'</span></span>: <span class="hljs-string"><span class="hljs-string">'currency_code'</span></span> } }</code> </pre></div></div><br>  A fun√ß√£o get_allias retorna o nome da tag necess√°ria para o processamento, levando o nome da plataforma de negocia√ß√£o como uma entrada: <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o Get_allias</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_allias</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(exchange_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>( tags_mapping[exchange_name][<span class="hljs-string"><span class="hljs-string">'current_position'</span></span>], tags_mapping[exchange_name][<span class="hljs-string"><span class="hljs-string">'deals'</span></span>], tags_mapping[exchange_name][<span class="hljs-string"><span class="hljs-string">'flows'</span></span>], ... tags_mapping[exchange_name][<span class="hljs-string"><span class="hljs-string">'stock_name_deal'</span></span>], tags_mapping[exchange_name][<span class="hljs-string"><span class="hljs-string">'paymentcurrency'</span></span>], tags_mapping[exchange_name][<span class="hljs-string"><span class="hljs-string">'currency_flows'</span></span>] )</code> </pre></div></div><br>  A fun√ß√£o get_briefcase √© respons√°vel pelo processamento de informa√ß√µes sobre o status do portf√≥lio de clientes: <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o Get_briefcase</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_briefcase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XMLdata)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#         briefcase_position briefcase_position = XMLdata.find(current_position) if not briefcase_position: return try: for child in briefcase_position: stock_name_reduce = child.get(stock_name).upper() stock_name_reduce = re.sub('[,\.]|(\s?INC)|(\s+$)|([-\s]?)', '', stock_name_reduce) dict_stocks['stock_name'].append(stock_name_reduce) dict_stocks['account'].append(account_name) dict_stocks['currency'].append(child.get(currency)) dict_stocks['current_cost'].append(float(child.get(current_cost))) dict_stocks['current_cost_rub'].append(float(child.get(current_cost_rub))) dict_stocks['saldo'].append(float(child.get(saldo))) except Exception as e: print('get_briefcase --&gt; Oops! It seems we have a BUG!', e)</span></span></code> </pre> </div></div><br>  Em seguida, a fun√ß√£o get_deals recupera informa√ß√µes sobre transa√ß√µes: <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o Get_deals</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_deals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XMLdata)</span></span></span><span class="hljs-function">:</span></span> stock_name_proc = <span class="hljs-string"><span class="hljs-string">''</span></span> closed_deal = XMLdata.find(deals) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> closed_deal: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-comment"><span class="hljs-comment">#   SPB    -    , #    MOEX:  ,      #    : if exchange_name == 'SPB': sortchildrenby(closed_deal, stock_name_deal) for child in closed_deal: sortchildrenby(child, stock_name_deal) try: for child in closed_deal: stock_name_reduce = child.get(stock_name_deal).upper() stock_name_reduce = re.sub('[,\.]|(\s?INC)|(\s+$)|([-\s]?)', '', stock_name_reduce) dict_deals['stock_name'].append(stock_name_reduce) dict_deals['account'].append(account_name) dict_deals['date_oper'].append(to_dt(child.get(ticketdate)).strftime('%Y-%m-%d')) current_cost = get_current_cost(stock_name_reduce) #    SPB     - quantity, #   MOEX  : buy_qnty  sell_qnty if exchange_name == 'MOEX': if child.get('buy_qnty'): quantity = float(child.get('buy_qnty')) else: quantity = - float(child.get('sell_qnty')) else: quantity = float(child.get('quantity')) dict_deals['quantity'].append(quantity) dict_deals['price'].append(float(child.get('price'))) dict_deals['type_oper'].append('deal') dict_deals['currency'].append(child.get(payment_currency)) brok_comm = child.get(brokerage) if brok_comm is None: brok_comm = 0 else: brok_comm = float(brok_comm) dict_deals['brokerage'].append(float(brok_comm)) #         if stock_name_proc != stock_name_reduce: if stock_name_proc != '': put_avr_price_in_df(account_name, stock_name_proc, \ pnl.m_net_position, pnl.m_avg_open_price) current_cost = get_current_cost(stock_name_proc) pnl.update_by_marketdata(current_cost) if len(dict_deals['result']) &gt; 0: if exchange_name != 'SPB': dict_deals['result'][-1] = pnl.m_unrealized_pnl * 0.87 -dict_deals['brokerage'][-2] else: dict_deals['result'][-1] = pnl.m_unrealized_pnl - dict_deals['brokerage'][-2] stock_name_proc = stock_name_reduce pnl = PnlSnapshot(stock_name_proc, float(child.get('price')), quantity) dict_deals['result'].append(-1 * brok_comm) else: pnl.update_by_tradefeed(float(child.get('price')), quantity) #  ,   if quantity &lt; 0: if pnl.m_realized_pnl &gt; 0 and exchange_name != 'SPB': pnl_sum = pnl.m_realized_pnl * 0.87 - brok_comm else: pnl_sum = pnl.m_realized_pnl - brok_comm dict_deals['result'].append(float(pnl_sum)) else: pnl.update_by_marketdata(current_cost) dict_deals['result'].append(-1 * brok_comm) put_avr_price_in_df(account_name, stock_name_proc, \ pnl.m_net_position, pnl.m_avg_open_price) current_cost = get_current_cost(stock_name_proc) pnl.update_by_marketdata(current_cost) if len(dict_deals['result']) &gt; 0: if exchange_name != 'SPB': dict_deals['result'][-1] = pnl.m_unrealized_pnl * 0.87 -dict_deals['brokerage'][-2] else: dict_deals['result'][-1] = pnl.m_unrealized_pnl - dict_deals['brokerage'][-2] except Exception as e: print('get_deals --&gt; Oops! It seems we have a BUG!', e)</span></span></code> </pre> </div></div><br>  Al√©m de processar uma matriz com informa√ß√µes sobre os par√¢metros da transa√ß√£o, o pre√ßo m√©dio de uma posi√ß√£o em aberto e realizado pelo PNL usando o m√©todo FIFO tamb√©m √© calculado aqui.  A classe PnlSnapshot √© respons√°vel por esse c√°lculo, cuja cria√ß√£o com as pequenas modifica√ß√µes em que o c√≥digo apresentado aqui foi tomado como base: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√°lculo do resultado</a> <br><br>  E, finalmente, a mais dif√≠cil de implementar √© a fun√ß√£o de obter informa√ß√µes sobre opera√ß√µes que n√£o s√£o comerciais - <b>get_nontrade_operation</b> .  Sua complexidade est√° no fato de que, no bloco de relat√≥rio usado para opera√ß√µes que n√£o s√£o de negocia√ß√£o, n√£o h√° informa√ß√µes claras sobre o tipo de transa√ß√£o e a seguran√ßa √† qual essa opera√ß√£o est√° vinculada. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de destinos de pagamento para opera√ß√µes n√£o comerciais</b> <div class="spoiler_text">  O pagamento de dividendos ou a receita acumulada de cupons podem ser indicados da seguinte forma: <br><br><ol><li>  Pagamento de dividendos do cliente de renda &lt;777777&gt; &lt; <font color="#cc0000">APPLE</font> INC-ao&gt; -&gt; pagamento de dividendos do relat√≥rio do SPB; </li><li>  Pagamento de dividendos do cliente de renda &lt;777777&gt; &lt; <font color="#cc0000">MICROSOFT</font> COM-¬Æ&gt; </li><li>  Pagamento de renda retida na fonte 777777i (NKD 2 <font color="#cc0000">OFZ 24019</font> ) imposto retido na fonte 0,00 rublos -&gt; pagamento de cupom do relat√≥rio MOEX; </li><li>  Pagamento de renda ao cliente 777777 <font color="#cc0000">dividendos do FGC UES -</font> imposto retido na fonte XX.XX rublos -&gt; pagamento de dividendos a partir do relat√≥rio MOEX.  etc. </li></ol></div></div><br>  Portanto, ser√° dif√≠cil ficar sem express√µes regulares, portanto, us√°-las-emos ao m√°ximo.  O outro lado da quest√£o √© que o nome da empresa nem sempre coincide com o nome no portf√≥lio ou nas transa√ß√µes para fins de pagamento.  Portanto, o nome recebido do emissor da finalidade do pagamento deve ser adicionalmente correlacionado com o dicion√°rio.  Como dicion√°rio, usaremos uma variedade de neg√≥cios, porque  existe a lista mais completa de empresas. <br><br>  A fun√ß√£o <b>get_company_from_str</b> recupera o nome do emissor do coment√°rio: <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o Get_company_from_str</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_company_from_str</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(comment)</span></span></span><span class="hljs-function">:</span></span> company_name = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-comment"><span class="hljs-comment">#    / flows_pattern = [ '^.+\s&lt;(\w+)?.+-&gt;$', '^.+\s(.+)-.+$', '^.+\(\s\d?\s(.+)\).+$', '^.+\s(.+)-.+$' ] for pattern in flows_pattern: match = re.search(pattern, comment) if match: return match.group(1).upper() return company_name</span></span></code> </pre> </div></div><br>  A fun√ß√£o <b>get_company_from_briefcase</b> leva o nome da empresa ao dicion√°rio se encontrar uma correspond√™ncia entre as empresas que participaram das transa√ß√µes: <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o Get_company_from_briefcase</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_company_from_briefcase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(company_name)</span></span></span><span class="hljs-function">:</span></span> company_name_full = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> value_from_dic = df_deals[df_deals[<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>].str.contains(company_name)] company_arr = value_from_dic[<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>].unique() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(company_arr) == <span class="hljs-number"><span class="hljs-number">1</span></span>: company_name_full = company_arr[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> company_name_full</code> </pre> <br></div></div><br>  E, finalmente, a fun√ß√£o final de coletar dados sobre opera√ß√µes que n√£o s√£o de negocia√ß√£o √© <b>get_nontrade_operation</b> : <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o Get_nontrade_operation</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_nontrade_operation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XMLdata)</span></span></span><span class="hljs-function">:</span></span> nontrade_money_operation = XMLdata.find(flows) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> nontrade_money_operation: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> child <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> nontrade_money_operation: comment = child.get(<span class="hljs-string"><span class="hljs-string">'comment'</span></span>) type_oper_match = re.search(<span class="hljs-string"><span class="hljs-string">'||^.+.+.+$'</span></span>, comment) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> type_oper_match: company_name = get_company_from_str(comment) type_oper = get_type_oper(comment) dict_flows[<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>].append(company_name) dict_flows[<span class="hljs-string"><span class="hljs-string">'account'</span></span>].append(account_name) dict_flows[<span class="hljs-string"><span class="hljs-string">'date_oper'</span></span>].append(to_dt(child.get(operationdate)).strftime(<span class="hljs-string"><span class="hljs-string">'%Y-%m-%d'</span></span>)) dict_flows[<span class="hljs-string"><span class="hljs-string">'type_oper'</span></span>].append(type_oper) dict_flows[<span class="hljs-string"><span class="hljs-string">'result'</span></span>].append(float(child.get(<span class="hljs-string"><span class="hljs-string">'amount'</span></span>))) dict_flows[<span class="hljs-string"><span class="hljs-string">'currency'</span></span>].append(child.get(currency_flows)) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(<span class="hljs-string"><span class="hljs-string">'get_nontrade_operation --&gt; Oops! It seems we have a BUG!'</span></span>, e)</code> </pre> </div></div><br>  O resultado da coleta de dados dos relat√≥rios ser√£o tr√™s DataFrames, aproximadamente os seguintes: <br><br><ol><li>  DataFrame com informa√ß√µes sobre pre√ßos m√©dios de posi√ß√µes em aberto: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1o/c-/qs/1oc-qs_akl5cvraaq7sg7pvfwfu.png"></div></li><li>  DataFrame da oferta especial: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/lp/xb/gqlpxby2utfl0ahr-fm8l_fqywc.png"></div></li><li>  DataFrame com informa√ß√µes sobre opera√ß√µes n√£o comerciais: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hx/-7/su/hx-7suk1zgheyiyr6ov6o0z5yd0.png"></div><br></li></ol><br>  Ent√£o, tudo o que resta fazer √© realizar uma uni√£o externa da tabela de transa√ß√µes com a tabela de informa√ß√µes do portf√≥lio: <br><br><pre> <code class="python hljs">df_result = pd.merge(df_deals, df_stocks_avg, how=<span class="hljs-string"><span class="hljs-string">'outer'</span></span>, on=[<span class="hljs-string"><span class="hljs-string">'stock_name'</span></span>, <span class="hljs-string"><span class="hljs-string">'account'</span></span>, <span class="hljs-string"><span class="hljs-string">'currency'</span></span>]).fillna(<span class="hljs-number"><span class="hljs-number">0</span></span>) df_result.sample(<span class="hljs-number"><span class="hljs-number">10</span></span>)</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jo/wj/nz/jowjnzmldhgscs30ynz5lrdcueu.png"></div><br>  E, finalmente, a parte final do processamento da matriz de dados √© a mesclagem da matriz de dados obtida na etapa anterior com o DataFrame para transa√ß√µes n√£o comerciais. <br>  O resultado do trabalho realizado √© uma grande mesa plana com todas as informa√ß√µes necess√°rias para an√°lise: <br><br><pre> <code class="python hljs">df_result_full = df_result.append(df_flows, ignore_index=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>).fillna(<span class="hljs-number"><span class="hljs-number">0</span></span>) df_result_full.sample(<span class="hljs-number"><span class="hljs-number">10</span></span>).head()</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cc/jc/rh/ccjcrh4dq5auyrg3jba6csb_s0g.png"></div><br>  O conjunto de dados resultante (Relat√≥rio Final) do DataFrame √© facilmente carregado no CSV e pode ser usado para an√°lises detalhadas em qualquer sistema de BI. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exists(<span class="hljs-string"><span class="hljs-string">'OUTPUT'</span></span>): makedirs(<span class="hljs-string"><span class="hljs-string">'OUTPUT'</span></span>) report_name = <span class="hljs-string"><span class="hljs-string">'OUTPUT\my_trader_diary.csv'</span></span> df_result_full.to_csv(report_name, index = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">'utf-8-sig'</span></span>)</code> </pre> <br><br><h2>  Carregar e processar dados na AWS </h2><br>  O progresso n√£o p√°ra e agora os servi√ßos em nuvem e os modelos de computa√ß√£o sem servidor est√£o ganhando grande popularidade no processamento e armazenamento de dados.  Isso se deve em grande parte √† simplicidade e baixo custo dessa abordagem, quando voc√™ n√£o precisa comprar equipamentos caros para construir uma arquitetura de sistema para computa√ß√£o complexa ou processar big data, mas apenas aluga a energia na nuvem pelo tempo necess√°rio e implanta os recursos necess√°rios com rapidez suficiente por uma taxa relativamente pequena . <br><br>  Um dos maiores e mais conhecidos fornecedores de nuvem do mercado √© a Amazon.  Vejamos o exemplo do ambiente Amazon Web Services (AWS) para criar um sistema anal√≠tico para o processamento de dados em nosso portf√≥lio de investimentos. <br><br>  A AWS possui uma ampla sele√ß√£o de ferramentas, mas usaremos o seguinte: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Amazon S3</a> - armazenamento de objetos, que permite armazenar quantidades quase ilimitadas de informa√ß√µes; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AWS Glue</a> - o servi√ßo ETL em nuvem mais poderoso que pode determinar a estrutura e gerar o c√≥digo ETL a partir dos dados de origem fornecidos; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Amazon Athena</a> , um servi√ßo de consulta SQL on-line sem servidor, permite analisar rapidamente os dados do S3 sem muita prepara√ß√£o.  Ele tamb√©m tem acesso aos metadados que o AWS Glue prepara, o que permite acessar os dados imediatamente ap√≥s a transmiss√£o do ETL; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Amazon QuickSight</a> - servi√ßo de BI sem servidor, voc√™ pode criar qualquer visualiza√ß√£o, relat√≥rios anal√≠ticos "on the fly" etc. </li></ul><br>  A documenta√ß√£o da Amazon est√° correta, em particular, h√° um bom artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pr√°ticas recomendadas ao usar o Athena com AWS Glue</a> , que descreve como criar e usar tabelas e dados usando o AWS Glue.  Vamos tirar proveito das principais id√©ias deste artigo e aplic√°-las para criar nossa pr√≥pria arquitetura de um sistema de relat√≥rio anal√≠tico. <br><br>  Os arquivos CSV preparados pelo nosso analisador de relat√≥rios ser√£o adicionados ao bloco S3.  Est√° previsto que a pasta correspondente no S3 seja reabastecida todos os s√°bados - no final da semana de negocia√ß√£o, para que voc√™ n√£o possa ficar sem o particionamento de dados at√© a data de forma√ß√£o e processamento do relat√≥rio. <br>  Al√©m de otimizar a opera√ß√£o de consultas SQL para esses dados, essa abordagem nos permitir√° realizar an√°lises adicionais, por exemplo, para obter a din√¢mica das mudan√ßas nos resultados financeiros de cada artigo, etc. <br><br><div class="spoiler">  <b class="spoiler_title">Trabalhar com o Amazon S3</b> <div class="spoiler_text"><ul><li>  Crie um bucket no S3, chame-o de "analisador de relat√≥rios"; </li><li>  Nesse bloco "analisador de relat√≥rios", crie uma pasta chamada "my_trader_diary"; </li><li>  No diret√≥rio "my_trader_diary", crie um diret√≥rio com a data do relat√≥rio atual, por exemplo, "date_report = 2018-10-01" e coloque o arquivo CSV nele; </li><li>  Somente para o experimento e uma melhor compreens√£o do particionamento, criaremos mais dois diret√≥rios: "date_report = 2018-09-27" e "date_report = 2018-10-08".  Colocamos o mesmo arquivo CSV neles; </li><li>  O intervalo final do S3 "analisador de relat√≥rios" deve ser semelhante ao mostrado nas figuras abaixo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n1/4z/c9/n14zc9odchiv6l-_dpc_qbs3s_o.png"></div></li></ul></div></div><br><div class="spoiler">  <b class="spoiler_title">Trabalhar com o AWS Glue</b> <div class="spoiler_text">  Em geral, voc√™ pode fazer apenas o Amazon Athena para criar uma tabela externa a partir dos dados do S3, mas o AWS Glue √© uma ferramenta mais flex√≠vel e conveniente para isso. <br><br><ul><li>  Entramos no AWS Glue e criamos um novo rastreador, que coletar√° uma tabela de arquivos CSV separados por datas de relat√≥rio: <br><ul><li>  Defina o nome do novo rastreador; </li><li>  Indicamos o reposit√≥rio de onde obter os dados (s3: // report-parser / my_trader_diary /) </li><li>  Selecionamos ou criamos uma nova fun√ß√£o do IAM que ter√° acesso para iniciar o Crawler e acessar o recurso especificado no S3; </li><li>  Em seguida, voc√™ precisa definir a frequ√™ncia de in√≠cio.  Definimos isso sob demanda por enquanto, mas, no futuro, acho que isso mudar√° e o lan√ßamento se tornar√° semanal; </li><li>  Salve e aguarde a cria√ß√£o do rastreador. </li></ul></li><li>  Quando o rastreador entrar no estado Pronto, inicie-o! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ed/xx/z9/edxxz9kurfrebky5-fuaqwzt-0e.png"></div></li><li>  Quando funcionar, uma nova tabela my_trader_diary aparecer√° na guia AWS Glue: Database -&gt; Tables: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u6/2n/rt/u62nrttephj6m-hxxguky4il6os.png"></div></li></ul></div></div><br>  Considere a tabela gerada com mais detalhes. <br>  Se voc√™ clicar no nome da tabela criada, iremos para a p√°gina com a descri√ß√£o dos metadados.  Na parte inferior, h√° um layout de tabela e a mais recente √© uma coluna que n√£o estava no arquivo CSV de origem - date_report.  Essa coluna que o AWS Glue cria automaticamente com base na defini√ß√£o de se√ß√µes dos dados de origem (no Bucket S3, nomeamos especialmente as pastas date_report = AAAA-MM-DD, o que nos permitiu us√°-las como se√ß√µes separadas por data). <br><br><div class="spoiler">  <b class="spoiler_title">Particionamento de tabela</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/5o/30/2v/5o302vb08y_zmylnfyaiign5us0.png"></div><br>  Na mesma p√°gina, no canto superior direito, h√° um bot√£o Visualizar parti√ß√µes, clicando no qual podemos ver em quais se√ß√µes nossa tabela gerada consiste: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/82/0l/kk/820lkk4mytj34kzh0tt__ieb6me.png"></div></div></div><br><h2>  An√°lise de dados </h2><br>  Tendo √† nossa disposi√ß√£o os dados processados ‚Äã‚Äãcarregados, podemos facilmente come√ßar a analis√°-los.  Para come√ßar, considere os recursos do Amazon Athena como a maneira mais f√°cil e r√°pida de executar consultas anal√≠ticas.  Para fazer isso, acesse o servi√ßo Amazon Athena, selecione o banco de dados de que precisamos (financeiro) e escreva o seguinte c√≥digo SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> d.date_report, d.account, d.stock_name, d.currency, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d.quantity) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> quantity, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(d.result), <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> my_trader_diary d <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> d.date_report, d.account, d.stock_name, d.currency <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> d.account, d.stock_name, d.date_report;</code> </pre> <br>  Essa solicita√ß√£o nos exibir√° um resultado financeiro l√≠quido para cada t√≠tulo para todas as datas dos relat√≥rios.  Porque  baixamos o mesmo relat√≥rio tr√™s vezes para datas diferentes, o resultado n√£o ser√° alterado, o que, √© claro, em um mercado real ser√° diferente: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9o/fg/dl/9ofgdloafbrxbvctdyprolilvna.png"></div><br>  Mas e se quisermos visualizar os dados recebidos na forma de tabelas ou diagramas flex√≠veis?  Aqui, o Amazon QuickSight vem em socorro, com a ajuda da qual voc√™ pode configurar an√°lises flex√≠veis quase t√£o rapidamente quanto escrever uma consulta SQL.  Iremos ao servi√ßo Amazon QuickSight (se voc√™ ainda n√£o se cadastrou, o registro ser√° necess√°rio). <br><br>  Clique no bot√£o Novas an√°lises -&gt; Novo conjunto de dados e, na janela exibida, selecione as fontes para o conjunto de dados, clique em Athena: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yq/kr/bv/yqkrbv144qas16af4jolsj3rnci.png"></div><br><br>  Vamos criar um nome para nossa fonte de dados, por exemplo, "PNL_analysis" e clicar no bot√£o "Criar fonte de dados". <br><br>  Em seguida, a janela Escolha sua tabela √© aberta, onde voc√™ precisa selecionar o banco de dados e a tabela de origem de dados.  Selecionamos o banco de dados - financeiro e a tabela: my_traider_diary.  Por padr√£o, a tabela inteira √© usada, mas se voc√™ selecionar "Usar SQL personalizado", poder√° personalizar e ajustar a amostra de dados necess√°ria.  Por exemplo, usamos a tabela inteira e clicamos no bot√£o Editar / Visualizar dados. <br><br>  Uma nova p√°gina ser√° aberta, onde voc√™ poder√° fazer configura√ß√µes adicionais e processar os dados existentes. <br><br>  Agora precisamos adicionar campos calculados adicionais ao nosso conjunto de dados: trimestre e ano de opera√ß√£o.  Um leitor atento pode perceber que essas manipula√ß√µes eram mais f√°ceis de executar no lado do analisador antes de salvar o Relat√≥rio Final em CSV.  Sem d√∫vida, meu objetivo agora √© demonstrar os recursos e a flexibilidade das configura√ß√µes do sistema de BI em tempo real.  Continuamos a criar campos calculados clicando no bot√£o "Novo campo". <br><br><div class="spoiler">  <b class="spoiler_title">Crie um novo campo</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ax/1z/ag/ax1zagyy7nnryd62t5najdntcio.png"></div></div></div><br>  Para destacar o ano da opera√ß√£o e o trimestre, s√£o utilizadas f√≥rmulas simples: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pm/yc/bi/pmycbiybxqtus62nkaa_5v2fu4s.png"></div><br><div class="spoiler">  <b class="spoiler_title">Preenchendo F√≥rmulas para um Novo Campo</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/uo/e1/u1/uoe1u1uco3ygn7cljsr6qcnhwbk.png"></div></div></div><br>  Quando os campos calculados tiverem sido criados e adicionados √† sele√ß√£o com sucesso, d√™ um nome ao nosso conjunto de dados, por exemplo, "my_pnl_analyze" e clique no bot√£o "Salvar e visualizar". <br><br>  Depois disso, transferimos para a placa principal do Amazon QuickSight e a primeira coisa que precisamos fazer √© configurar um filtro para a data do relat√≥rio (levando em considera√ß√£o que os mesmos dados foram coletados em tr√™s se√ß√µes).  Selecione a data do relat√≥rio 2018-10-01 e clique no bot√£o Aplicar e v√° para a guia Visualizar. <br><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o de filtro</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/an/jo/et/anjoet5xt_divhygnebb5v9ys8k.png"></div></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora podemos visualizar o resultado do portf√≥lio em qualquer plano, por exemplo, para cada t√≠tulo dentro da conta de negocia√ß√£o e dividido por moeda (porque o resultado n√£o √© compar√°vel em moedas diferentes) e tipos de opera√ß√µes. </font><font style="vertical-align: inherit;">Vamos come√ßar com a ferramenta mais poderosa de qualquer tabela din√¢mica de BI. </font><font style="vertical-align: inherit;">Para economizar espa√ßo e exibir flexibilidade, coloquei a moeda em um controle separado (an√°logo da fatia no MS Excel)</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/90/3e/it/903eitay8v9j1psyz05d8qaqh_k.png"></div><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tabela acima mostra que, se um investidor decidir vender todas as a√ß√µes do FGC UES agora, ele registrar√° uma perda, pois </font><font style="vertical-align: inherit;">Dividendos pagos no valor de 1.509,91 p. </font><font style="vertical-align: inherit;">eles n√£o cobrem seus custos (1.763,36 rublos - uma diferen√ßa cambial negativa e 174 rublos - imposto de renda pessoal sobre dividendos). </font><font style="vertical-align: inherit;">Faz sentido esperar e esperar por melhores tempos no Exchange.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O gr√°fico a seguir √© um gr√°fico de barras: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/up/a7/qj/upa7qjdqjiqyo-j6tx0bnrth67m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E agora formaremos uma tabela que nos mostrar√° quanto investimos em cada artigo, quantos dias h√° em nosso portf√≥lio e qual √© a lucratividade para todo o per√≠odo de propriedade. </font><font style="vertical-align: inherit;">Para fazer isso, adicione dois novos campos calculados: sum_investment e count_days.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Campo sum_investment</font></font></b> <div class="spoiler_text">   sum_investment ( )   : <br><br> ifelse({stock_name} = ' 24019',{avg_open_price} * quantity * 10,{avg_open_price} * quantity) <br><br>           ,       ‚Äì     (    ‚Äì 1000). <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Campo count_days</font></font></b> <div class="spoiler_text">   count_day (   )                : <br><br> dateDiff(parseDate({date_oper}),parseDate({date_report})) <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A mesa final √© apresentada na captura de tela abaixo: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ut/ws/dk/utwsdkbzhksrjh3wunw_w6stqr0.png"></div><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conclus√µes e Resumo </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinamos com voc√™ a implementa√ß√£o do analisador de relat√≥rios e os m√©todos para analisar os dados preparados por ele "on the fly" usando os servi√ßos da Amazon. Tamb√©m abordamos alguns aspectos comerciais e fundamentais da an√°lise do portf√≥lio de investimentos, como esse t√≥pico √© quase imenso e √© bastante dif√≠cil encaix√°-lo em um artigo, acho que faz sentido coloc√°-lo em uma publica√ß√£o separada ou mesmo em uma s√©rie de publica√ß√µes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quanto ao uso da ferramenta de processamento de relat√≥rios do broker e as abordagens e algoritmos envolvidos, eles podem ser usados ‚Äã‚Äã(com modifica√ß√µes apropriadas) para processar os relat√≥rios de outros brokers. De qualquer forma, se voc√™ planeja adaptar o c√≥digo √†s suas necessidades, estou pronto para dar algumas dicas, por isso n√£o hesite em fazer perguntas - tentarei definitivamente respond√™-las.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estou certo de que este sistema encontrar√° sua aplica√ß√£o e ter√° mais desenvolvimento. Por exemplo, est√° planejado adicionar o c√°lculo do deposit√°rio e outras taxas (por exemplo, para retirada de fundos), bem como o resgate de t√≠tulos, etc. ao c√°lculo do PNL completo para o portf√≥lio ... Os campos calculados no lado Quicksight foram usados ‚Äã‚Äãpara fins de demonstra√ß√£o, na pr√≥xima vers√£o do analisador, todas essas colunas adicionais ser√£o portadas para Python e ser√£o calculadas no lado do analisador.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como arquiteto e o principal cliente comercial desta solu√ß√£o, vejo uma nova atualiza√ß√£o da seguinte forma: bem, n√£o quero solicitar manualmente esses relat√≥rios XML sempre! </font><font style="vertical-align: inherit;">Obviamente, n√£o h√° outra possibilidade at√© agora, mas a API do Broker com a transfer√™ncia do token e o intervalo de amostragem seria ideal para receber relat√≥rios brutos semanais. </font><font style="vertical-align: inherit;">Processamento autom√°tico completo subseq√ºente no lado da Amazon: desde o acionamento do trabalho ETL no AWS Glue at√© a obten√ß√£o de resultados prontos na forma de gr√°ficos e tabelas no Amazon QuickSight, voc√™ poder√° automatizar completamente o processo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo fonte completo pode ser encontrado no meu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reposit√≥rio GitHub</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426027/">https://habr.com/ru/post/pt426027/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426017/index.html">Como reduzir o n√∫mero de experi√™ncias em animais</a></li>
<li><a href="../pt426019/index.html">Esta√ß√£o meteorol√≥gica no Arduino de A a Z. Parte 5</a></li>
<li><a href="../pt426021/index.html">libgdx e sentimentos</a></li>
<li><a href="../pt426023/index.html">Li√ß√£o aberta "Laborat√≥rio virtual no Vagrant"</a></li>
<li><a href="../pt426025/index.html">Usando m√©todos ofensivos para enriquecer a Intelig√™ncia de Amea√ßas</a></li>
<li><a href="../pt426029/index.html">Voc√™ desiste e quer sair da tarefa? √â assim que o treinamento eficaz para desenvolvedores se parece</a></li>
<li><a href="../pt426031/index.html">Preocupar-se em capturar o mundo com intelig√™ncia artificial pode se basear em suposi√ß√µes n√£o cient√≠ficas</a></li>
<li><a href="../pt426033/index.html">Tit√£s matem√°ticos colidem com prova √©pica da hip√≥tese do ABC</a></li>
<li><a href="../pt426039/index.html">Lan√ßamento de emerg√™ncia "Soyuz MS-10" (equipe resgatada, transmitida)</a></li>
<li><a href="../pt426041/index.html">Solu√ß√£o simb√≥lica de equa√ß√µes diferenciais lineares e sistemas pelo m√©todo de transforma√ß√£o de Laplace usando SymPy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>