<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐄 🧕🏽 💃🏽 带有Padavan和Keenetic OS固件的路由器上的锁选择锁 🧑‍🤝‍🧑 🥑 🍣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="已经发布了大量说明，其中包含用于绕过阻止Internet资源的各种选项。 但是这个话题并没有失去意义。 甚至更经常地，在立法层面上听到了一些倡议，以阻止有关绕过锁的方法的文章。 并且有传言称，罗斯科姆纳佐尔将因“更好”的锁而获得另一包纳税人的钱。 有经验的用户不会从本文中学到任何新知识或有用的东西。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>带有Padavan和Keenetic OS固件的路由器上的锁选择锁</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428992/">已经发布了大量说明，其中包含用于绕过阻止Internet资源的各种选项。 但是这个话题并没有失去意义。 甚至更经常地，在立法层面上听到了一些倡议，以阻止有关绕过锁的方法的文章。 并且有传言称，罗斯科姆纳佐尔将因“更好”的锁而获得另一包纳税人的钱。 有经验的用户不会从本文中学到任何新知识或有用的东西。 但是其他人将收到现成的分步说明，以简单有效地选择旁路使用Padavan和Keenetic固件的流行路由器上的锁。 <br><br><img src="https://habrastorage.org/webt/is/kb/td/iskbtdxuaisqiyg3r4tsrjhj6aw.jpeg"><br><a name="habracut"></a><br><h1> 目录内容 </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">引言</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">配置后如何管理旁路锁？</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">工作原理</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">配置Padavan路由器</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用Keenetic OS配置路由器</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">配置后诊断错误的基本方法</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">额外绕过提供商过滤DNS查询的方法</a> </li></ul><br><a name="con1"></a><h1> 引言 </h1><br> 我使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Zolg</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">锁旁路选项</a>大约两年了。 网络上的许多指令都基于此。 矿山包括。 <br><br> 一切都很好，但是“最好永远是善的敌人”。 首先，一些新程序变得过于“智能”，将绕过路由器的DNS服务器使用自己的方法来解析域。 这不允许路由器上的dnsmasq将地址添加到ipset集以进行解锁，并导致逻辑结果-资源保持锁定状态。 在Android 9中，原生支持基于TLS的DNS，即 这种绕过锁定的方法将停止工作（如果其他设备之前尚未访问过dnsmasq）。 其次，每次从antizapret更新整个域列表都会导致无法预测的结果。 该列表可能包括未被真正阻止的域，并且这些域的操作在主渠道中很重要。 您需要时刻保持警惕并用手编辑生成的文件。 第三，我厌倦了“拖延”具有成千上万个赌场之类的大量域名，而这根本是不需要的。 随着时间的流逝，我意识到我只需要一小部分受阻资源。 <br><br> 因此，一年来，我一直在使用略微修改的解锁方法，对此我完全满意： <br><br><ul><li> 简单易用（配置后）。 </li><li> 完全控制您需要解锁的资源。 </li><li> 处理器资源和路由器RAM的最低要求。 </li><li> 绕过锁时，可广泛涵盖细微差别。 </li></ul><br> 重要的是要注意，我的选项不适用于需要解锁成千上万个域的情况。 因为当路由器启动时，将解析给定列表中的每个域。 列表中的域越多，许多要解锁的ipset的初始化时间就越长。 <br><br> 绕过锁的基础是相同的-Tor网络。 它的使用是由于两个简单的因素-免费的，而且与任何VPN服务不同，Tor在俄罗斯被阻止的可能性接近于零。  Tor是从中到下在俄罗斯贩毒的基础。 锁定Tor将导致寻找新的市场工具并降低匿名性，这将需要成功启动地方执法机构的工作。 最终，这就像病毒一样，将开始对上层链接产生负面影响。 鉴于有关高级政府官员与全球向俄罗斯贩毒的关系的最新惊人消息，Tor在俄罗斯的封锁只是一个禁忌，尽管这是微不足道的。 无论是分配给该机构多少亿美元，罗斯科姆纳佐尔都没有，俄罗斯没有一个法院可以“自上而下”地封锁Tor。 即使俄罗斯只是简直是被毒品淹死（任何小学生都知道要怎么做，而且甚至在30分钟后，在拥有1万人口的任何城市中，实际上都有可能免费获得任何毒品），这甚至都不会令任何人感到惊讶或恐吓任何人。无论如何-这种邪恶的生活真理）。 在当前模式下，阻止Tor网络的概率低于阻止冬宫博物馆遗址的概率。 <br><br> 给出的说明很容易适用于带有OpenWrt的路由器。 同样，小的更改使使用OpenVPN轻松替换Tor成为可能。 <br><br><a name="con11"></a><h1> 配置后如何管理旁路锁？ </h1><br> 一切都非常简单。 您有文件/opt/etc/unblock.txt-一个简单的列表可以解锁。 您可以解锁域，IP地址，地址范围或CIDR。 一行-一个元素。 允许使用空行，并且可以在行的开头使用＃字符来忽略。 <br><br><div class="spoiler">  <b class="spoiler_title">这是我的个人档案的一个例子</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br> 编辑此文件后，您只需执行命令即可应用新配置： <br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br> 来自unblock.txt的所有资源都被解锁，而无需重新启动路由器。 <br><br><a name="con12"></a><h1> 工作原理 </h1><br><ul><li> 初始化路由器会创建一组空的ipset IP地址，称为unblock。 </li><li> 将具有目的地的所有数据包从取消阻止重定向到Tor服务的规则已添加到防火墙。 </li><li>  Tor服务以透明代理模式启动。 </li><li> 启动特殊脚本unblock_ipset.sh，该脚本解析unblock.txt中的所有域，并将其IP地址添加到unblock集中。 该文件的IP地址，范围和CIDR也被添加为取消阻止。 </li><li>  Dnsmasq将使用附加配置文件unblock.dnsmasq启动，该文件指示解析时将unblock.txt中的域IP地址添加到unblock集中。 </li><li>  cron以一定的频率运行unblock_ipset.sh以部分补偿细微差别的可能情况。 </li><li> 如有必要，如果提供商过滤DNS，则unblock.txt中的所有域（只有它们）都将通过dnscrypt-proxy进行解析。 </li></ul><br><a name="con2"></a><h1> 配置Padavan路由器 </h1><br> 您必须具有安装了Padavan固件和已配置Entware软件包管理器的路由器。 在Windows上，您可以使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PuTTY</a>客户端通过SSH连接到路由器。 <br><br> 确保您使用的是Entware，而不是旧版Entware-ng。 查看/ opt / var / opkg-lists文件夹的内容。 将会有一个entware或entware-ng文件。 在第二种情况下，您需要将路由器的Padavan固件更新到最新版本，然后重新安装Entware软件包管理器。 然后，才按照分步说明进行操作。 <br><br> 如评论所示，主要是那些最初配置不正确（即未加载init.d脚本的人）在路由器内部存储器中的用户。 如果您拥有小米Mi路由器3或3G，并且不确定Entware在内存中是否正常运行（自动启动），则只需重新设置所有内容即可。 服用PROMETHEUS。 更新脚本（1）。 更新源代码（2）。 收集并刷新最新固件（4）。 重置固件设置（NVRAM和文件存储）-高级&gt;管理&gt;设置。 在路由器上配置Internet访问并启用SSH。 在PROMETHEUS固件&gt; RWFS格式中执行。 在“ R / W”部分中，选择“高级&gt;管理&gt;设置&gt;挂载文件系统&gt; UBIFS”。 重新启动路由器。 内部存储器中所有当前的Entware启动脚本将被自动注册，并且一切将像时钟一样工作。 <br><br> 为了进行测试，我使用了流行的小米路由器3G（内部存储器中安装了软件）和最新的固件-32a93db。 甚至在传说中的婴儿WT3020 AD / F / H上，一切都可以用，只要$ 10。 <br><br><img src="https://habrastorage.org/webt/th/kf/2k/thkf2kvtt2rhtnbxvmx0qri7dsk.jpeg"><br><br><h3>  1.在路由器上安装必要的软件 </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron</code> </pre> <br>  <b>mc-</b>午夜指挥官文件管理器。 仅由于方便的mcedit编辑器，才需要它。 如果您习惯于使用其他文本编辑器，则无法安装mc。 <br>  <b>tor</b> -Tor服务。 <br>  <b>tor-geoip</b> -Tor的geo-IP数据库。 <br>  <b>bind-dig</b> -DNS客户端（nslookup和主机的类似物）。 <br>  <b>cron-</b>任务计划程序。 <br><cut></cut><br><h3>  2.初始化ipset，创建多个解锁IP地址（start_script.sh） </h3><br> 连接必要的模块，并在路由器启动时创建一个名称为<b>unblock</b>的空地址集。 为此，请在编辑器中打开<b>/etc/storage/start_script.sh</b>文件： <br><br><pre> <code class="bash hljs">mcedit /etc/storage/start_script.sh</code> </pre> <br> 在末尾添加： <br><br><pre> <code class="bash hljs">modprobe ip_set modprobe ip_set_hash_ip modprobe ip_set_hash_net modprobe ip_set_bitmap_ip modprobe ip_set_list_set modprobe xt_set ipset create unblock <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br> 要从缓冲区粘贴，请使用Shift +插入，保存-F2，退出-F10。 <br><br><img src="https://habrastorage.org/webt/tr/zp/cq/trzpcqqnadbonhsb0x3ebe7ltpo.png"><br><br> 如果需要，可以通过路由器的Web界面-“高级”&gt;“个性化”&gt;“脚本”&gt;“在初始化路由器之前运行”来编辑start_script.sh文件。 编辑后，单击“应用”。 <br><br><img src="https://habrastorage.org/webt/yr/aa/8q/yraa8qgcfwu-vesrp3wvvne2vui.png"><br><br><h3>  3. Tor设置 </h3><br> 删除Tor配置文件的内容： <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br> 打开Tor配置文件： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs">User admin PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br> 如有必要，将<b>192.168.0.1</b>替换为路由器（LAN）的内部地址。 简要配置说明： <br><br><ul><li> 不包括输出节点：俄罗斯，乌克兰，亚美尼亚吉尔吉斯斯坦，白俄罗斯。 </li><li> 将透明代理挂到地址192.168.0.1，端口9141。 </li><li> 拒绝成为出口点。 </li></ul><br><h3>  4.绕过锁定的域列表（不仅是）（unblock.txt） </h3><br>  unblock.txt是一个简单的列表，可供解锁。 您可以解锁域，IP地址，范围或CIDR。 一行-一个元素。 空行（包括空格和制表符）将被忽略。 您可以在行的开头使用＃字符来忽略它。 <br><br> 创建文件<b>/opt/etc/unblock.txt</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br> 每行可以包含一个域名，IP地址，范围或CIDR。 您可以使用＃字符在行上注释。 <br><br><div class="spoiler">  <b class="spoiler_title">这是我的个人档案的一个例子</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5.一个脚本，用于填充给定域列表的一组未阻止IP地址（unblock_ipset.sh） </h3><br> 创建脚本<b>/opt/bin/unblock_ipset.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br> 该脚本非常简单，这就是其工作的本质。。。我们正在等待google.com域解析正常工作（如果未完成，则路由器启动时将无法填充很多解除阻止的状态，因为路由器仍处于初始化过程中）。 我们阅读了unblock.txt文件中的行。 读取行会自动删除开头和结尾的空格和制表符。 跳过空行。 跳过以＃字符开头的行。 我们正在寻找CIDR。 如果找到CIDR，则将其添加为取消阻止。 我们正在寻找字符串中的范围。 如果找到，则将其添加为取消阻止。 我们正在寻找字符串中的IP地址。 如果找到IP，则将其添加为取消阻止。 让我们通过挖掘来解决一条线。 结果的所有IP地址都将添加为取消阻止。 <br><br><h3>  6.一个脚本，用于从给定的域列表中生成其他dnsmasq配置文件（unblock_dnsmasq.sh） </h3><br> 创建脚本<b>/opt/bin/unblock_dnsmasq.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br> 该脚本非常简单，这就是其工作的本质。...我们依次从/opt/etc/unblock.txt中读取各行。 读取行会自动删除开头和结尾的空格和制表符。 跳过空行。 跳过以＃开头的行。 我们跳过包含IP地址（IP，范围，CIDR）的行，即 我们只对带有域名的字符串感兴趣。 在文件/opt/etc/unblock.dnsmasq中，添加“ ipset = / domain_name / unblock”形式的行。 这意味着在确定特定域的IP地址之后，它们将被自动添加到解锁集。 <br><br> 确保运行脚本以生成unblock.dnsmasq文件： <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br> 验证是否创建了unblock.dnsmasq文件： <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7.编辑域列表后手动强制更新系统的脚本（unblock_update.sh） </h3><br> 创建脚本<b>/opt/bin/unblock_update.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh restart_dhcpd sleep 3 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8.启动路由器时自动填充一组解锁的脚本（S99unblock） </h3><br> 创建脚本<b>/opt/etc/init.d/S99unblock</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3>  9.将目标数据包从取消阻止转发到Tor（post_iptables_script.sh） </h3><br> 在编辑器中打开文件<b>/etc/storage/post_iptables_script.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /etc/storage/post_iptables_script.sh</code> </pre> <br> 在末尾添加： <br><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i br0 -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> <br><img src="https://habrastorage.org/webt/af/u2/dl/afu2dld3v0nrhtjwfekvo6i-wsi.png"><br><br> 如果需要，您可以通过路由器的网络界面-“高级”&gt;“个性化”&gt;“脚本”&gt;“重启防火墙规则后运行”来编辑post_iptables_script.sh文件。 编辑后，单击“应用”。 <br><br><img src="https://habrastorage.org/webt/pv/be/ot/pvbeotspo0xhzrukgp3dgvu5aws.png"><br><br> 您可以添加（这是可选的）到同一文件，以将对外部端口53的所有请求重定向到您自己。 这是必需的，以便本地网络上的客户端不使用第三方DNS服务。 请求将通过常规DNS服务器。 <br><br><pre> <code class="bash hljs">iptables -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 iptables -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1</code> </pre> <br> 如有必要，将<b>192.168.0.1</b>替换为路由器（LAN）的内部地址。 <br><br><h3>  10.将其他配置文件连接到dnsmasq </h3><br> 我们需要将创建的unblock.dnsmasq文件连接到dnsmasq。 为此，请在编辑器中打开文件<b>/etc/storage/dnsmasq/dnsmasq.conf</b> ： <br><br><pre> <code class="bash hljs">mcedit /etc/storage/dnsmasq/dnsmasq.conf</code> </pre> <br> 在末尾添加： <br><br><pre> <code class="bash hljs">conf-file=/opt/etc/unblock.dnsmasq</code> </pre> <br> 如果需要（这是可选的），可以添加其他服务器以提高分辨率和可靠性： <br><br><pre> <code class="bash hljs">server=8.8.8.8</code> </pre> <br> 如果需要，您可以通过路由器的网络界面-“高级”&gt;“局域网”&gt;“ DHCP服务器”&gt;“用户配置文件dnsmasq.conf”来编辑dnsmasq.conf文件。 编辑后，单击“应用”。 <br><br><img src="https://habrastorage.org/webt/x0/ar/4c/x0ar4cm6v9pgsluqabh74qck-s0.png"><br><br><h3>  11.向cron添加任务以定期更新取消阻止集的内容 </h3><br> 万一程序/设备使用其自己的解析方法并且域IP地址已更改，这是额外的保险。 您所需要做的就是以所需的频率运行unblock_ipset.sh脚本。 例如，我们每天早上6点启动。 <br><br> 在cron配置文件中用admin替换根名称： <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/root/admin/g'</span></span> /opt/etc/crontab</code> </pre> <br> 在编辑器中打开文件<b>/ opt / etc / crontab</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br> 在末尾添加： <br><br><pre> <code class="bash hljs">00 06 * * * admin /opt/bin/unblock_ipset.sh</code> </pre> <br> 如果愿意，可以注释掉所有其他模板任务。 这是您的crontab文件的外观： <br><br><img src="https://habrastorage.org/webt/hf/lb/fc/hflbfcv04lpvzlrjmehoc3l51ts.png"><br><br><h3>  12.重新启动路由器 </h3><br> 运行命令： <br><br><pre> <code class="bash hljs">reboot</code> </pre> <br> 重新启动后，在浏览器中打开check.torproject.org网站（应将其添加到unblock.txt）。 如果您正确地完成了所有操作，则将看到“祝贺您。 该浏览器配置为使用Tor。 <br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con3"></a><h1> 使用Keenetic OS配置路由器 </h1><br> 您必须已经配置了Entware Package Manager（OPKG）的Keenetic / Zyxel路由器。 例如，这是一些支持Entware的路由器的列表：Keenetic II，Keenetic III，Extra，Extra II，Giga II，Giga III，Omni，Omni II，Viva，Ultra，Ultra II，Omni（KN-1410），Extra（KN -1710），Giga（KN-1010），Ultra（KN-1810），Viva（KN-1910），DSL（KN-2010），Duo（KN-2110）。 可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>找到配置Entware的说明（最多10分）。 <br><br> 如果以前（固件版本低于2.07）已经添加了Entware支持，则请确保您<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用的是过时的Entware-ng</a> 。 <br><br> 确保启用“ Netfilter子系统内核模块”-“常规设置”&gt;“更改组件集”。 如果不在可用列表中，请尝试首先安装IPv6协议组件。 如果之后没有出现，请尝试不使用它，但是很有可能您将无法通过范围和CIDR进行解锁（因为将不支持哈希：网络集）。 <br><br><img src="https://habrastorage.org/webt/vv/dh/hi/vvdhhirhcktuefrgbxh3fkx5i0i.png"><br><br> 为了进行测试，我使用了Keenetic Ultra（KN-1810）和最新固件-2.14.C.0.0-4。 <br><br>  <u>重要说明。</u>  <u>您将不得不禁用系统中的常规DNS服务器，我们将改用dnsmasq。</u>  <u>您将失去为客户端单独分配DNS服务（Yandex.DNS / SkyDNS / AdGuard DNS）的能力，但是如果需要，可以通过dnsmasq设置在全局范围内使用它们。</u> <br><br><h3>  1.在路由器上安装必要的软件 </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron dnsmasq-full ipset iptables</code> </pre> <br>  <b>mc-</b>午夜指挥官文件管理器。 仅由于方便的mcedit编辑器，才需要它。 如果您习惯于使用其他文本编辑器，则无法安装mc。 <br>  <b>tor</b> -Tor服务。 <br>  <b>tor-geoip</b> -Tor的geo-IP数据库。 <br>  <b>bind-dig</b> -DNS客户端（nslookup和主机的类似物）。 <br>  <b>cron-</b>任务计划程序。 <br>  <b>dnsmasq-full</b> -DNS服务器。 <br>  <b>ipset和iptables</b>是<b>ipset和iptables</b>控制台实用程序（它们可能已经在系统上，并且不需要，为安全起见，我添加了它们）。 <br><br><h3>  2.初始化ipset，创建多个解锁IP地址（100-ipset.sh） </h3><br> 检查您的路由器系统是否支持大量的hash：net（事实证明，并非所有Keenetic路由器都具有）： <br><br><pre> <code class="bash hljs">ipset create <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br> 如果团队未给出任何错误或消息，则表示有支持，请按照说明进行操作。 否则，以下脚本中存在错误（错误），您需要将<b>hash：net</b>替换为<b>hash：ip</b> 。 在这种情况下，您将失去解锁范围和CIDR的能力。 <br><br> 路由器启动时，创建一个空的地址集，称为<b>unblock</b> 。 为此，请创建文件<b>/opt/etc/ndm/fs.d/100-ipset.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 ipset create unblock hash:net -exist exit 0</span></span></code> </pre> <br> 要从缓冲区粘贴，请使用Shift +插入，保存-F2，退出-F10。 <br><br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br><h3>  3. Tor设置 </h3><br> 删除Tor配置文件的内容： <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br> 打开Tor配置文件： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs">User root PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br> 如有必要，将<b>192.168.0.1</b>替换为路由器（LAN）的内部地址。 简要配置说明： <br><br><ul><li> 不包括输出节点：俄罗斯，乌克兰，亚美尼亚吉尔吉斯斯坦，白俄罗斯。 </li><li> 将透明代理挂到地址192.168.0.1，端口9141。 </li><li> 拒绝成为出口点。 </li></ul><br><h3>  4.绕过锁定的域列表（不仅是）（unblock.txt） </h3><br>  unblock.txt是一个简单的列表，可供解锁。 您可以解锁域，IP地址，范围或CIDR。 一行-一个元素。 空行（包括空格和制表符）将被忽略。 您可以在行的开头使用＃字符来忽略它。 <br><br> 创建文件<b>/opt/etc/unblock.txt</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br> 每行可以包含一个域名，IP地址，范围或CIDR。 您可以使用＃字符在行上注释。 <br><br><div class="spoiler">  <b class="spoiler_title">这是我的个人档案的一个例子</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5.一个脚本，用于填充给定域列表的一组未阻止IP地址（unblock_ipset.sh） </h3><br> 创建脚本<b>/opt/bin/unblock_ipset.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br> 该脚本非常简单，这就是其工作的本质。。。我们正在等待google.com域解析正常工作（如果未完成，则路由器启动时将无法填充很多解除阻止的状态，因为路由器仍处于初始化过程中）。 我们阅读了unblock.txt文件中的行。 读取行会自动删除开头和结尾的空格和制表符。 跳过空行。 跳过以＃字符开头的行。 我们正在寻找CIDR。 如果找到CIDR，则将其添加为取消阻止。 我们正在寻找字符串中的范围。 如果找到，则将其添加为取消阻止。 我们正在寻找字符串中的IP地址。 如果找到IP，则将其添加为取消阻止。 让我们通过挖掘来解决一条线。 结果的所有IP地址都将添加为取消阻止。 <br><br><h3>  6.一个脚本，用于从给定的域列表中生成其他dnsmasq配置文件（unblock_dnsmasq.sh） </h3><br> 创建脚本<b>/opt/bin/unblock_dnsmasq.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br> 该脚本非常简单。 我们依次从/opt/etc/unblock.txt中读取行。 读取行会自动删除开头和结尾的空格和制表符。 跳过空行。 跳过以＃开头的行。 跳过包含IP地址（IP或CIDR）的行，即 我们只对带有域名的字符串感兴趣。 在文件/opt/etc/unblock.dnsmasq中，添加“ ipset = / domain_name / unblock”形式的行。 这意味着在确定特定域的IP地址之后，它们将被自动添加到解锁集。 <br><br> 确保运行脚本以生成unblock.dnsmasq文件： <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br> 验证是否创建了unblock.dnsmasq文件： <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7.编辑域列表后手动强制更新系统的脚本（unblock_update.sh） </h3><br> 创建脚本<b>/opt/bin/unblock_update.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh /opt/etc/init.d/S56dnsmasq restart /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8.启动路由器时自动填充一组解锁的脚本（S99unblock） </h3><br> 创建脚本<b>/opt/etc/init.d/S99unblock</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br> 赋予执行权： <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3>  9.将目标数据包从unblock转发到Tor（100-redirect.sh） </h3><br> 为此，请创建文件<b>/opt/etc/ndm/netfilter.d/100-redirect.sh</b> ： <br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br> 粘贴（Shift +插入）内容： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$type" == "ip6tables" ] &amp;&amp; exit 0 if [ -z "$(iptables-save 2&gt;/dev/null | grep unblock)" ]; then ipset create unblock hash:net -exist iptables -w -t nat -A PREROUTING -i br0 -p tcp -m set --match-set unblock dst -j REDIRECT --to-port 9141 fi exit 0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果在步骤2中使用了</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash：ip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash：net</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则将hash：net替换为hash：ip。实际上，我们还重复了从2个步骤创建一组解锁的功能。如果fs.d中的脚本尚未开始运行，并且netfilter.d脚本已在运行，则这对于安全性是必需的。没关系，如果早先已经创建了unblock，该命令将被忽略。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以添加（这是可选的）到同一文件，以将对外部端口53的所有请求重定向到您自己。这是为了防止本地网络上的客户端使用第三方DNS服务。请求将通过常规DNS服务器。在最后一个出口之前，添加：</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "udp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "tcp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如有必要，将</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替换</font><font style="vertical-align: inherit;">为路由器（LAN）的内部地址。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">赋予执行权：</font></font><br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10.配置dnsmasq并将附加的配置文件附加到dnsmasq </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 删除dnsmasq配置文件的内容： </font></font><br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 打开dnsmasq配置文件： </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 粘贴（Shift +插入）内容： </font></font><br><br><pre> <code class="bash hljs">user=nobody bogus-priv no-negcache clear-on-reload <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dynamic listen-address=192.168.0.1 listen-address=127.0.0.1 min-port=4096 cache-size=1536 expand-hosts <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-async conf-file=/opt/etc/unblock.dnsmasq server=8.8.8.8</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如有必要，将</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替换</font><font style="vertical-align: inherit;">为路由器（LAN）的内部地址。</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 11.向cron添加任务以定期更新取消阻止集的内容 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">万一程序/设备使用其自己的解析方法并且域IP地址已更改，这是额外的保险。</font><font style="vertical-align: inherit;">您所需要做的就是以所需的频率运行unblock_ipset.sh脚本。</font><font style="vertical-align: inherit;">例如，我们每天早上6点启动。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在编辑器中打开文件</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ opt / etc / crontab</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在末尾添加： </font></font><br><br><pre> <code class="bash hljs">00 06 * * * root /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果愿意，可以注释掉所有其他模板任务。</font><font style="vertical-align: inherit;">这是您的crontab文件的外观：</font></font><br><br><img src="https://habrastorage.org/webt/le/y5/sl/ley5slcvjfvs-9odj9air9qdd8s.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12.禁用常规DNS服务器并重新启动路由器 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keenetic Router CLI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（如果将“ SSH服务器”组件添加到系统，则端口23用于Telnet，端口22用于SSH）​​。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行命令：</font></font><br><br><pre> <code class="bash hljs">opkg dns-override system configuration save system reboot</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">固件内置的DNS服务器将关闭，而将使用Entware的dnsmasq代替。</font><font style="vertical-align: inherit;">路由器在启动时检查是否已安装opt文件夹（是否有USB闪存驱动器/带有Entware的驱动器）。</font><font style="vertical-align: inherit;">如果存在，则不使用常规DNS服务器。</font><font style="vertical-align: inherit;">如果没有，请使用。</font></font>即<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">卸下闪存驱动器并重新启动路由器，一切将像以前一样（设置之前）为您工作。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新启动后，在浏览器中打开check.torproject.org网站（应将其添加到unblock.txt）。</font><font style="vertical-align: inherit;">如果您正确地完成了所有操作，则将看到“祝贺您。</font><font style="vertical-align: inherit;">该浏览器配置为使用Tor。</font></font><br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con31"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 配置后诊断错误的基本方法 </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果通过站点check.torproject.org的检查（应将其添加到unblock.txt）通过了，但是提供商的存根继续打开了其他资源（或没有打开），则提供商很可能会干扰DNS流量，替换答案-您您需要执行其他绕过DNS查询过滤的操作。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果在配置后某些操作无法正常工作，请使用简单命令确定问题步骤。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示取消阻止集的内容：</font></font><br><br><pre> <code class="bash hljs">ipset list unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果系统报告没有这样的设置，则错误是在步骤2中，或者您没有在系统中启用Netfilter模块（对于Keenetic）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果结果为空，则unblock_ipset.sh脚本不起作用，而该脚本又应由S99unblock启动脚本启动。手动运行此unblock_ipset.sh脚本。如果设置已满，则错误将在步骤8进行。如果无法执行脚本（很有可能正在等待google.com解析），则错误可能在步骤10或6处在DNS服务器一侧。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请检查iptables中的重定向：</font></font><br><br><pre> <code class="bash hljs">iptables-save 2&gt;/dev/null | grep unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果不存在，则错误发生在步骤9。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果所有站点都无法正常工作，即 </font><font style="vertical-align: inherit;">DNS无法正常工作，错误可能在第6或第10阶段出现。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果</font><font style="vertical-align: inherit;">在第9阶段，则错误。</font><font style="vertical-align: inherit;">如果unblock.txt中的所有站点均不工作（超过超时），但其他所有站点都工作，则问题出在Tor端，错误在阶段3</font></font><br><br><br><a name="con4"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 额外绕过提供商过滤DNS查询的方法 </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果提供商通过替换对阻塞资源的响应来干扰DNS流量，则很容易解决。</font><font style="vertical-align: inherit;">为此，我们将使用dnscrypt-proxy。</font><font style="vertical-align: inherit;">如果您希望并有经验，可以轻松地用stubby（基于TLS的DNS）替换dnscrypt。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt仅用于unblock.txt中列出的域。</font><font style="vertical-align: inherit;">所有其他查询将通过常规DNS服务器。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您确定您的提供者不会过滤DNS查询，则您不需要执行此其他配置。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您应该已经配置了上述锁的旁路。</font><font style="vertical-align: inherit;">Padavan和Keenetic OS的以下设置相同。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在路由器上安装其他软件：</font></font><br><br><pre> <code class="bash hljs">opkg update opkg install dnscrypt-proxy2</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 打开dnscrypt-proxy配置文件： </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnscrypt-proxy.toml</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 找到listen_addresses，fallback_resolver，缓存参数并进行更改： </font></font><br><br><pre> <code class="bash hljs">listen_addresses = [<span class="hljs-string"><span class="hljs-string">'127.0.0.1:9153'</span></span>] fallback_resolver = <span class="hljs-string"><span class="hljs-string">'77.88.8.8:1253'</span></span> cache = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">77.88.8.8:1253是具有非标准端口的Yandex DNS服务器地址。</font><font style="vertical-align: inherit;">如果dnscrypt-proxy有任何问题，它是一个备份。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行dnscrypt-proxy：</font></font><br><br><pre> <code class="bash hljs">/opt/etc/init.d/S09dnscrypt-proxy2 start</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 确保dnscrypt-proxy正常工作（您应该在响应中看到IP地址列表）： </font></font><br><br><pre> <code class="bash hljs">dig +short google.com @localhost -p 9153</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在编辑器中打开脚本</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_ipset.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 将内容替换为： </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost -p 9153) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost -p 9153 | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们做了一个小的更改-现在解析不使用常规的DNS服务器，而是使用端口9153的dnscrypt-proxy </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在编辑器中打开</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_dnsmasq.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本</font><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 将内容替换为： </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq echo "server=/$line/127.0.0.1#9153" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们做了一个小的更改-现在在生成unblock.dnsmasq文件时，添加了其他行，例如“ server = / domain_name / 127.0.0.1＃9153”。</font><font style="vertical-align: inherit;">这意味着从列表中解析域将通过dnscrypt-proxy进行。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行unblock_update.sh：</font></font><br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br> 做完了<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有复杂的设置都在后面。</font><font style="vertical-align: inherit;">现在，仅在必要时编辑unblock.txt列表，添加或删除要解锁的域或IP地址，然后激活使用unblock_update.sh命令进行的更改。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新04/01/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">通常在文章上会出现一些带有典型问题的个人信息。</font><font style="vertical-align: inherit;">我将在这里回答最常见的问题。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何提供.onion域区域网站？</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在torc中添加：</font></font><br><pre> <code class="bash hljs">VirtualAddrNetwork 10.254.0.0/16 DNSPort 127.0.0.1:9053 AutomapHostsOnResolve 1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 要访问洋葱区域的所有域，请添加到dnsmasq.conf： </font></font><br><pre> <code class="bash hljs">server=/onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/onion/unblock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 如果您不想打开对洋葱区域的所有域的访问权，而只希望对某些域的访问权，请在dnsmasq.conf中添加以下条目： </font></font><br><pre> <code class="bash hljs">server=/rutorc6mqdinc4cz.onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/rutorc6mqdinc4cz.onion/unblock server=/nnmclub5toro7u65.onion/127.0.0.1#9053 ipset=/nnmclub5toro7u65.onion/unblock server=/flibustahezeous3.onion/127.0.0.1#9053 ipset=/flibustahezeous3.onion/unblock</span></span></code> </pre> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何绕过路由器上运行的VPN服务器的客户端的锁？</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在torrc中，将行替换为TransPort：</font></font><br><pre> <code class="bash hljs">TransPort 0.0.0.0:9141</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 添加具有必要接口（INTERFACE-VPN网络接口）的其他重定向： </font></font><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i  -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN428992/">https://habr.com/ru/post/zh-CN428992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN428982/index.html">如何在ARM上编写D</a></li>
<li><a href="../zh-CN428984/index.html">朱莉娅和动力系统的相像</a></li>
<li><a href="../zh-CN428986/index.html">在哈尔科夫举行的ThinkJava Conference＃8</a></li>
<li><a href="../zh-CN428988/index.html">大自然的秘诀-多云的夜灯</a></li>
<li><a href="../zh-CN428990/index.html">使用RouteComposer的UIViewControllers的配置示例</a></li>
<li><a href="../zh-CN428994/index.html">使用Corutin和翻新版在Android中联网</a></li>
<li><a href="../zh-CN428996/index.html">Habrahabr上的匿名圣诞老人俱乐部2018-2019</a></li>
<li><a href="../zh-CN428998/index.html">如何在React中使用实验性Profiler的新功能</a></li>
<li><a href="../zh-CN429000/index.html">为什么比尔·盖茨以2330亿美元发明厕所</a></li>
<li><a href="../zh-CN429006/index.html">中国：“世界组装车间”并不像看起来那么简单</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>