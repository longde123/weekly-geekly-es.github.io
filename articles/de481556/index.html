<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤹🏻 🤞🏾 👦🏼 PostgreSQL-Task-Warteschlange 🙍🏿 🗽 🧓🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Warteschlangen werden verwendet, um die Verarbeitung des Aufgabenflusses zu organisieren. Sie werden für die Anhäufung und Verteilung von Aufgaben unt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL-Task-Warteschlange</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481556/"><p><img src="https://habrastorage.org/webt/rd/7-/dy/rd7-dyen1bqq_ekj5_halnmlndy.jpeg" alt="Elefantenschlange - pixabay.com"></p><br><p>  Warteschlangen werden verwendet, um die Verarbeitung des Aufgabenflusses zu organisieren.  Sie werden für die Anhäufung und Verteilung von Aufgaben unter den ausübenden Künstlern benötigt.  Warteschlangen können auch zusätzliche Anforderungen für die Bearbeitung von Aufgaben enthalten: Zustellgarantie, einmalige Garantie, Priorisierung usw. </p><br><p>  In der Regel werden vorgefertigte Message Queue-Systeme verwendet (MQ - Message Queue). Manchmal müssen Sie jedoch eine Ad-hoc-Warteschlange oder eine spezialisierte Warteschlange organisieren (z. B. eine Prioritätswarteschlange und ein verzögerter Neustart von Aufgaben, die aufgrund von Ausnahmen nicht verarbeitet wurden).  Die Erstellung solcher Warteschlangen wird nachstehend erörtert. </p><br><h2 id="ogranicheniya-primenimosti">  Anwendbarkeitsbeschränkungen </h2><br><p>  Die vorgeschlagenen Lösungen sind für den Fluss ähnlicher Aufgaben ausgelegt.  Sie eignen sich nicht zum Organisieren von Pub / Sub oder Messaging zwischen lose gekoppelten Systemen und Komponenten. </p><br><p>  Eine Warteschlange über einer relationalen Datenbank eignet sich gut für kleine und mittlere Lasten (Hunderttausende von Aufgaben pro Tag, Zehn- bis Hunderttausende von Performern). Für große Threads ist es jedoch besser, eine spezielle Lösung zu verwenden. </p><br><h2 id="sut-metoda-v-pyati-slovah">  Das Wesen der Methode in fünf Worten </h2><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span></code> </pre> <a name="habracut"></a><br><h1 id="bazovaya-ochered">  Basislinie </h1><br><p>  Der Einfachheit halber werden nachfolgend nur eindeutige Aufgabenidentifizierer in der Tabelle gespeichert.  Das Hinzufügen einer Art von Nutzlast sollte nicht schwierig sein. </p><br><p>  Die Tabelle für die einfachste Warteschlange enthält die Aufgabe selbst und ihren Status: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 -  ); create index task__status__idx on task (status);</span></span></code> </pre> <br><p>  Aufgabe hinzufügen: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> conflict (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span>;</code> </pre> <br><p>  Die folgende Aufgabe erhalten: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> <br><p>  Aufgabenerfüllung: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h1 id="ochered-s-prioritetami">  Prioritätswarteschlange </h1><br><p>  Im einfachen Fall hat die Task- <code>id</code> Priorität.  Nur die Anforderung für die nächste Aufgabe wird geändert - die Sortierbedingungsreihenfolge <code>order by id</code> mit der erforderlichen Reihenfolge der Verarbeitungsaufgaben wird hinzugefügt.  Sie müssen auch einen zusammengesetzten Index nach <code>(status, id)</code> erstellen. </p><br><p>  Oder es wird vorrangig eine separate Spalte hinzugefügt: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 -  ); create index task__status__priority__idx on task (status, priority);</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Aufgabe hinzufügen:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> conflict (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Die folgende Aufgabe erhalten:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><p>  In der hervorgehobenen Spalte können Sie die Priorität der Aufgabe im laufenden Betrieb ändern. </p><br><h1 id="ochered-s-povtorom-upavshih-zadach">  Warteschlange mit einer Wiederholung der "gefallenen" Aufgaben </h1><br><p>  Während der Ausführung der Aufgabe kann ein Fehler oder eine Ausnahme auftreten.  In solchen Fällen muss die Aufgabe erneut in die Warteschlange gestellt werden.  Manchmal ist es dennoch erforderlich, den Zeitpunkt der wiederholten Ausführung um einige Zeit zu verschieben, z. B. wenn die Ausnahme auf die vorübergehende Nichtverfügbarkeit eines Dienstes eines Drittanbieters zurückzuführen ist. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 - , 3 - , 4 -   (  ) attempt integer not null default 0, delayed_to timestamp null, error_text text null ); create index task__status__delayed_to__idx on task (status, delayed_to);</span></span></code> </pre> <br><p>  Wie Sie sehen, wurde die Liste der Status erweitert und neue Spalten hinzugefügt: </p><br><ul><li>  <code>attempt</code> - Anzahl der Versuche;  Erforderlich, um eine Entscheidung über die Notwendigkeit eines erneuten Versuchs zu treffen (die Anzahl der Versuche zu begrenzen) und eine Verzögerung vor dem erneuten Versuch auszuwählen (z. B. wird jeder nachfolgende Versuch um <code>10 * attempt</code> Versuchminuten verzögert). </li><li>  <code>delayed_to</code> - Zeit des nächsten Versuchs, die Aufgabe abzuschließen; </li><li>  <code>error_text</code> - Fehlertext. </li></ul><br><p>  Der Fehlertext wird zum Gruppieren nach Fehlertyp benötigt. </p><br><p>  Ein Beispiel.  Das Überwachungssystem meldet, dass sich Tausende von Aufgaben mit dem Status "Fehler" in der Warteschlange angesammelt haben.  Wir erfüllen den Wunsch: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> error_text, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>;</code> </pre> <br><p>  Einzelheiten finden Sie in den Protokollen der ausübenden Künstler.  Korrigieren Sie die Situation, die den Fehler verursacht hat (falls möglich).  Bei Bedarf beschleunigen wir den Neustart von Tasks, indem wir den Status auf 0 setzen oder den Zeitpunkt des nächsten Versuchs verschieben. </p><br><div class="spoiler">  <b class="spoiler_title">Die folgende neue Aufgabe bekommen:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Die folgende Aufgabe steht aufgrund eines Fehlers aus:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> delayed_to &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Erfolgreicher Abschluss der Aufgabe:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Die Aufgabe ist fehlgeschlagen, es wird eine Wiederholung in (5 * Anzahl Versuche) Minuten durchgeführt:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, delayed_to = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> + make_interval(mins =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> * attempt), error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Die Aufgabe wurde mit einem schwerwiegenden Fehler abgeschlossen. Es wird nicht wiederholt:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><p>  Die Anforderung für die nächste Task ist zweigeteilt, damit das DBMS einen effektiven Abfrageplan für die Prioritätswarteschlange erstellen kann.  Eine Auswahlbedingung mit <code>or</code> kann bei der Sortierung nach sehr schief gehen. </p><br><h1 id="sbor-metrik">  Metrics-Auflistung </h1><br><p>  Fügen Sie die folgenden Attribute hinzu: </p><br><ul><li>  Erstellungszeit der Aufgabe; </li><li>  Aufgabenwechselzeit; </li><li>  Start- und Endzeit der Aufgabe. </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 - , 3 - , 4 -   (  ) attempt integer not null default 0, begin_time timestamp null, end_time timestamp null, delayed_to timestamp null, error_text text null, created timestamp not null default localtimestamp, updated timestamp not null default localtimestamp ); create index task__status__delayed_to__idx on task (status, delayed_to); create index task__updated__idx on task (updated);</span></span></code> </pre> <br><p>  Wir berücksichtigen die hinzugefügten Spalten in allen Abfragen. </p><br><div class="spoiler">  <b class="spoiler_title">Die folgende neue Aufgabe bekommen:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, begin_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, end_time = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Die folgende Aufgabe steht aufgrund eines Fehlers aus:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> delayed_to &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, begin_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, end_time = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Erfolgreicher Abschluss der Aufgabe:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Die Aufgabe ist fehlgeschlagen, es wird eine Wiederholung in (5 * Anzahl Versuche) Minuten durchgeführt:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> + make_interval(mins =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> * attempt), error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Die Aufgabe wurde mit einem schwerwiegenden Fehler abgeschlossen. Es wird nicht wiederholt:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><h3 id="primery-dlya-chego-eto-mozhet-byt-nuzhno">  Beispiele, warum dies erforderlich sein könnte </h3><br><p>  Suchen und starten Sie baumelnde Aufgaben neu: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, error_text = <span class="hljs-string"><span class="hljs-string">'hanged'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>;</code> </pre> <br><p>  Alte Aufgaben entfernen: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'30 days'</span></span>;</code> </pre> <br><p>  Statistiken zum Abschließen von Aufgaben: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'hour'</span></span>, end_time), <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(end_time - begin_time), <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(end_time - begin_time) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> end_time &gt;= <span class="hljs-string"><span class="hljs-string">'2019-12-16'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h1 id="povtornyy-zapusk-ranee-vypolnennyh-zadach">  Starten Sie zuvor erledigte Aufgaben neu </h1><br><p>  Wenn ein Dokument beispielsweise aktualisiert wird, müssen Sie es für die Volltextsuche neu indizieren. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, task_updated_at <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> localtimstamp, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 - , 3 - , 4 -   (  ) begin_time timestamp null, end_time timestamp null, delayed_to timestamp null, error_text text null, created timestamp not null default localtimestamp, updated timestamp not null default localtimestamp );</span></span></code> </pre> <br><p>  Hier wird die Spalte <code>task_updated_at</code> für die <code>task_updated_at</code> hinzugefügt, das <code>created</code> Feld kann jedoch verwendet werden. </p><br><p>  Hinzufügen oder Aktualisieren (Neustarten) einer Aufgabe: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, task_updated_at) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> conflict (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> task_updated_at = excluded.task_updated_at, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task_updated_at &lt; excluded.task_updated_at;</code> </pre> <br><p>  Was ist hier los?  Eine Aufgabe wird "neu", wenn sie gerade nicht erledigt wird. </p><br><p>  Die Anforderung zum Abschließen der Aufgabe prüft auch, ob sie während der Ausführung geändert wurde. </p><br><p>  Anforderungen für die nächste Aufgabe sind dieselben wie in der Warteschlange zum Sammeln von Metriken. </p><br><p>  Erfolgreicher Abschluss der Aufgabe: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> begin_time &gt;= <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  Die Beendigung der Aufgabe mit einem Fehler: abhängig von der Aufgabe.  Sie können den Neustart bedingungslos verzögern und den Status beim Aktualisieren auf "neu" setzen. </p><br><h1 id="pipeline">  Pipeline </h1><br><p>  Die Aufgabe durchläuft mehrere Stufen.  Sie können für jede Stufe eine eigene Warteschlange erstellen.  Oder Sie fügen der Tabelle die entsprechende Spalte hinzu. </p><br><p>  Ein Beispiel, das auf der Basiswarteschlange basiert, um den Code nicht zu überladen.  Alle zuvor beschriebenen Änderungen können problemlos auf diese Warteschlange angewendet werden. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, stage <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> task__stage__status__idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> task (stage, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span>);</code> </pre> <br><p>  Die folgende Aufgabe zu einem bestimmten Zeitpunkt ausführen: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> stage = $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> <br><p>  Abschluss der Aufgabe mit dem Übergang in die angegebene Phase: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> stage = $<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  Oder Übergang zur nächsten Stufe in der Reihenfolge: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> stage = stage + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h1 id="zadachi-po-raspisaniyu">  Geplante Aufgaben </h1><br><p>  Dies ist eine Variation der Wiederholungswarteschlange. </p><br><p>  Jede Aufgabe kann einen eigenen Zeitplan haben (in der einfachsten Version die Häufigkeit des Starts). </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">period</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-comment"><span class="hljs-comment">--     status integer not null default 0, -- 0 - , 1 -   next_run_time timestamp not null default localtimestamp ); create index task__status__next_run_time__idx on task (status, next_run_time);</span></span></code> </pre> <br><p>  Aufgabe hinzufügen: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">period</span></span>, next_run_time) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>, $<span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre> <br><p>  Die folgende Aufgabe erhalten: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> next_run_time &lt;= <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> <br><p>  Abschluss der Aufgabe und Planung des nächsten Laufs: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, next_run_time = next_run_time + make_interval(secs =&gt; <span class="hljs-keyword"><span class="hljs-keyword">period</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><h1 id="vmesto-zaklyucheniya">  Anstelle einer Schlussfolgerung </h1><br><p>  Das Erstellen einer speziellen Task-Warteschlange mit RDBMS-Tools ist nicht kompliziert. </p><br><p>  Die "selbstgemachte" Warteschlange wird antworten <del>  sogar die wildesten </del>  praktisch jede geschäftliche / Domain-Anforderung. </p><br><p>  Nun, wir sollten nicht vergessen, dass die Warteschlange wie jede andere Datenbank eine sorgfältige Optimierung des Servers, der Abfragen und der Indizes erfordert. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481556/">https://habr.com/ru/post/de481556/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481546/index.html">Die Geschichte des Mikroprozessors und des Personalcomputers: 1947-1974</a></li>
<li><a href="../de481548/index.html">Symbol.iterator in Javascript</a></li>
<li><a href="../de481550/index.html">Inmarsat: Empfang und Dekodierung eines Satellitensignals zu Hause</a></li>
<li><a href="../de481552/index.html">PGConf.Russia 2020 erscheint in Kürze</a></li>
<li><a href="../de481554/index.html">Wie gehe ich durch den Online-Master of Science in Informatik, und für wen passt dies möglicherweise nicht?</a></li>
<li><a href="../de481560/index.html">Die Verdauung von frischen Materialien aus der Welt des Frontends für die letzte Woche Nr. 394 (15. - 22. Dezember 2019)</a></li>
<li><a href="../de481562/index.html">Himbeer Pi 4 Hitzetest</a></li>
<li><a href="../de481564/index.html">PHP Digest Nr. 170 (9. - 23. Dezember 2019)</a></li>
<li><a href="../de481566/index.html">Bunte Adress-LEDs für das neue Jahr ohne Programmieren und Löten</a></li>
<li><a href="../de481568/index.html">Digitale Veranstaltungen in Moskau vom 23. bis 29. Dezember</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>