<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥ üë©üèæ‚Äçüíº üñêüèø N√≥s nos esfor√ßamos ao m√°ximo: da ORM √† an√°lise de bytecode üéå üç≠ üë¶üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como voc√™ sabe, um programador real deve fazer tr√™s coisas em sua vida: criar sua pr√≥pria linguagem de programa√ß√£o, escrever seu pr√≥prio sistema opera...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>N√≥s nos esfor√ßamos ao m√°ximo: da ORM √† an√°lise de bytecode</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409043/"><p>  Como voc√™ sabe, um programador real deve fazer tr√™s coisas em sua vida: criar sua pr√≥pria linguagem de programa√ß√£o, escrever seu pr√≥prio sistema operacional e criar seu pr√≥prio ORM.  E se eu escrevi o idioma h√° muito tempo (talvez eu lhe diga outra hora) e o sistema operacional ainda esteja √† frente, quero falar sobre o ORM agora.  Para ser mais preciso, n√£o se trata nem da pr√≥pria ORM, mas da implementa√ß√£o de um recurso pequeno, local e, ao que parece, completamente simples. </p><br><p> Juntos, percorreremos todo o caminho, desde a alegria de encontrar uma solu√ß√£o simples at√© a amargura da consci√™ncia de sua fragilidade e incorre√ß√£o.  Do uso de uma API exclusivamente p√∫blica a hacks sujos.  De "quase sem reflex√£o" a "at√© os joelhos no interpretador de c√≥digo de bytes". </p><br><p>  Quem se importa com a an√°lise do bytecode, com quais dificuldades ele est√° enfrentando e com que resultado incr√≠vel voc√™ pode obter no final das contas, bem-vindo ao gato. </p><a name="habracut"></a><br><h3 id="soderzhanie">  Conte√∫do </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a> - Como tudo come√ßou. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2-4</a> - No caminho para o bytecode. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">5</a> - Quem √© o bytecode. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">6</a> - A pr√≥pria an√°lise.  Foi por causa deste cap√≠tulo que tudo foi concebido e estava nele a pr√≥pria coragem. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">7</a> - O que mais pode ser terminado.  Sonhos, sonhos ... <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Posf√°cio</a> - Posf√°cio. </p><br><p>  <em>UPD: Imediatamente ap√≥s a publica√ß√£o, as partes 6-8 foram perdidas (por uma quest√£o de que tudo foi iniciado).</em>  <em>Fixed.</em> </p><br><a name="1"></a><br><h3 id="chast-pervaya-problema">  Parte I  O problema </h3><br><p>  Imagine que temos um esquema simples.  H√° um cliente, ele tem v√°rias contas.  Um deles √© o padr√£o.  Al√©m disso, um cliente pode ter v√°rios cart√µes SIM e cada cart√£o SIM pode ser definido explicitamente ou um cliente padr√£o pode ser usado. </p><br><p><img src="https://habrastorage.org/webt/dh/io/ag/dhioagv6hwl7cmpls9cuh2a_dyq.png"></p><br><p>  Aqui est√° como este modelo √© descrito em nosso c√≥digo (omitindo getters / setters / construtores / ...). </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"DEFAULTACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account defaultAccount; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long balance; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; } <span class="hljs-meta"><span class="hljs-meta">@JdbcEntity</span></span>(table = <span class="hljs-string"><span class="hljs-string">"CARD"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String msisdn; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; }</code> </pre> <br><p>  No pr√≥prio ORM, temos um requisito para a aus√™ncia de proxies (precisamos criar uma inst√¢ncia dessa classe espec√≠fica) e uma √∫nica solicita√ß√£o.  Assim, aqui est√° o que o sql √© enviado ao banco de dados ao tentar obter um mapa. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.id <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, CARD.msisdn msisdn, ACCOUNT_2.id ACCOUNT_2_id, ACCOUNT_2.balance ACCOUNT_2_balance, CLIENT_3.id CLIENT_3_id, CLIENT_3.name CLIENT_3_name, CLIENT_1.id CLIENT_1_id, CLIENT_1.name CLIENT_1_name, ACCOUNT_4.id ACCOUNT_4_id, ACCOUNT_4.balance ACCOUNT_4_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = CLIENT_1.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = ACCOUNT_2.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> CLIENT_3 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ACCOUNT_2.CLIENT = CLIENT_3.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> ACCOUNT_4 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CLIENT_1.DEFAULTACCOUNT = ACCOUNT_4.id;</code> </pre> <br><p>  Opa  O cliente e a conta s√£o duplicados.  √â verdade que, se voc√™ pensar bem, isso √© compreens√≠vel - afinal, a estrutura n√£o sabe que o cliente do cart√£o e o cliente da conta do cart√£o s√£o o mesmo cliente.  E a solicita√ß√£o precisa ser gerada estaticamente e apenas uma (lembre-se da restri√ß√£o √† exclusividade da solicita√ß√£o?). </p><br><p>  A prop√≥sito, exatamente pelo mesmo motivo, n√£o existem campos <code>Card.client.defaultAccount.client</code> e <code>Card.client.defaultAccount.client</code> aqui.  S√≥ sabemos que <code>client</code> e <code>client.defaultAccount.client</code> sempre correspondem.  E a estrutura n√£o sabe, para ele, esse √© um elo arbitr√°rio.  E o que fazer nesses casos n√£o √© muito claro.  Eu conhe√ßo 3 op√ß√µes: </p><br><ol><li>  Descreva explicitamente invariantes em anota√ß√µes. </li><li>  Fa√ßa consultas recursivas ( <code>with recursive</code> / <code>connect by</code> ). </li><li>  Para marcar. </li></ol><br><p>  Adivinhe qual op√ß√£o escolhemos?  Certo.  Como resultado, todos os campos recursivos n√£o s√£o preenchidos agora e sempre h√° nulos. </p><br><p>  Mas se voc√™ olhar de perto, poder√° ver o segundo problema por tr√°s da duplica√ß√£o, e √© muito pior.  O que n√≥s quer√≠amos?  N√∫mero do cart√£o e saldo.  O que voc√™ recebeu?  4 jun√ß√µes e 10 colunas.  E essa coisa est√° crescendo exponencialmente!  Bem, isto √©  realmente temos uma situa√ß√£o em que, primeiro, por quest√µes de beleza e integridade, descrevemos completamente o modelo em anota√ß√µes e, em seguida, <strong>por 5 campos</strong> , uma solicita√ß√£o de <strong>15 jun√ß√µes e 150 colunas</strong> .  E, neste momento, torna-se realmente assustador. </p><br><a name="2"></a><br><h3 id="chast-vtoraya-rabochee-no-neudobnoe-reshenie">  Parte Dois  Uma solu√ß√£o funcional, mas inconveniente </h3><br><p>  Uma solu√ß√£o simples implora imediatamente.  Somente os alto-falantes que ser√£o usados ‚Äã‚Äãdevem ser arrastados!  F√°cil de dizer.  A op√ß√£o mais √≥bvia (escrever a sele√ß√£o com as m√£os), cairemos imediatamente.  Bem, n√£o ent√£o, descrevemos o modelo para n√£o us√°-lo.  H√° muito tempo, um m√©todo especial foi criado - o <code>partialGet</code> .  Diferentemente de <code>get</code> simples, aceita <code>List&lt;String&gt;</code> - os nomes dos campos a serem preenchidos.  Para fazer isso, voc√™ deve primeiro registrar aliases nas tabelas </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"ACCOUNT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"a"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>, sqlTableAlias = <span class="hljs-string"><span class="hljs-string">"c"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>  E depois aproveite o resultado. </p><br><pre> <code class="java hljs">List&lt;String&gt; requiredColumns = asList(<span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); String query = cardMapper.getSelectSQL(requiredColumns, DatabaseType.ORACLE); System.out.println(query);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> CARD.msisdn msisdn, c_a.balance c_a_balance, a.balance a_balance <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> CARD <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.ACCOUNT = a.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLIENT</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CARD.CLIENT = c.id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACCOUNT</span></span> c_a <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.DEFAULTACCOUNT = c_a.id;</code> </pre> <br><p>  E tudo parece estar bem, mas, de fato, n√£o.  Veja como ser√° usado no c√≥digo real. </p><br><pre> <code class="java hljs">Card card = cardDAO.partialGet(cardId, <span class="hljs-string"><span class="hljs-string">"msisdn"</span></span>, <span class="hljs-string"><span class="hljs-string">"c_a_balance"</span></span>, <span class="hljs-string"><span class="hljs-string">"a_balance"</span></span>); ... ... ...    ... ... ... <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> clientId = card.getClient().getId();<span class="hljs-comment"><span class="hljs-comment">//, NPE.  , id    ?!</span></span></code> </pre> <br><p>  E agora voc√™ pode usar o parcialGet apenas se a dist√¢ncia entre ele e o resultado for de apenas algumas linhas.  Mas se o resultado for longe ou, se Deus o permitir, for passado dentro de algum m√©todo, j√° √© extremamente dif√≠cil entender quais campos s√£o preenchidos e quais n√£o s√£o.  Al√©m disso, se o NPE aconteceu em algum lugar, voc√™ ainda precisa entender se ele realmente retornou do banco de dados nulo ou se simplesmente n√£o preenchemos esse campo.  Em suma, muito pouco confi√°vel. </p><br><p>  Voc√™ pode, √© claro, apenas escrever outro objeto com seu mapeamento especificamente para a solicita√ß√£o ou at√© selecionar completamente a coisa toda com as m√£os e mont√°-la em alguma <code>Tuple</code> .  Na verdade, na realidade agora, na maioria dos lugares, fazemos exatamente isso.  Mas ainda assim eu gostaria de n√£o escrever sele√ß√µes com as m√£os e n√£o duplicar o mapeamento. </p><br><a name="3"></a><br><h3 id="chast-tretya-udobnoe-no-nerabochee-reshenie">  Parte tr√™s.  Uma solu√ß√£o conveniente, mas inoperante. </h3><br><p>  Se voc√™ pensa um pouco mais, logo a resposta vem √† minha mente - voc√™ precisa usar interfaces.  Ent√£o apenas declare </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MsisdnAndBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMsisdn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  E use </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, ...);</code> </pre> <br><p>  E isso √© tudo.  N√£o chame nada extra.  Al√©m disso, com a transi√ß√£o para Kotlin / ten / lomb, mesmo esse tipo terr√≠vel pode ser eliminado.  Mas aqui o ponto mais importante ainda √© omitido.  Quais argumentos devem ser passados ‚Äã‚Äãpara o <code>partialGet</code> ?  Tangas, como antes, n√£o parecem mais, porque o risco √© grande demais para cometer erros e escrever os campos errados.  E eu quero que voc√™ seja capaz de alguma forma </p><br><pre> <code class="java hljs">MsisdnAndBalance card = cardDAO.partialGet(cardId, MsisdnAndBalance.class);</code> </pre> <br><p>  Ou ainda melhor no Kotlin atrav√©s de gen√©ricos reificados </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> card = cardDAO.paritalGet&lt;MsisdnAndBalance&gt;(cardId)</code> </pre> <br><p>  Ehh, um erro.  Na verdade, toda a hist√≥ria adicional √© precisamente a implementa√ß√£o dessa op√ß√£o. </p><br><a name="4"></a><br><h3 id="chast-chetvertaya-na-puti-k-baytkodu">  Parte Quatro  No caminho para o bytecode </h3><br><p>  O principal problema √© que os m√©todos v√™m da interface e as anota√ß√µes est√£o acima dos campos.  E precisamos encontrar esses mesmos campos por m√©todos.  O primeiro e mais √≥bvio pensamento √© usar a conven√ß√£o padr√£o do Java Bean.  E para propriedades triviais, isso at√© funciona.  Mas acontece muito inst√°vel.  Por exemplo, vale a pena renomear um m√©todo em uma interface (atrav√©s da refatora√ß√£o ideol√≥gica), pois tudo instantaneamente desmorona.  A id√©ia √© inteligente o suficiente para renomear m√©todos nas classes de implementa√ß√£o, mas n√£o o suficiente para entender que era um getter e voc√™ precisa renomear o pr√≥prio campo.  E uma solu√ß√£o semelhante leva √† duplica√ß√£o de campos.  Por exemplo, se eu precisar do <code>getClientId()</code> na minha interface, n√£o ser√° poss√≠vel implement√°-lo da √∫nica maneira correta </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  E eu tenho que duplicar campos.  E no <code>Client</code> arraste <code>id</code> e <code>clientId</code> , e no mapa ao lado do cliente explicitamente <code>clientId</code> .  E certifique-se de que tudo isso n√£o saia.  Al√©m disso, tamb√©m quero que getters com l√≥gica n√£o trivial funcionem, por exemplo </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasBalance</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Account account; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> account.getBalance(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getDefaultAccount().getBalance(); } }</code> </pre> <br><p>  Portanto, a op√ß√£o de pesquisar por nome n√£o √© mais necess√°ria, voc√™ precisa de algo mais complicado. </p><br><p>  A pr√≥xima op√ß√£o foi completamente insana e n√£o me deixou muito tempo na cabe√ßa, mas, para completar a hist√≥ria, tamb√©m a descreverei.  No est√°gio de an√°lise, podemos criar uma entidade vazia e simplesmente revezar na escrita de alguns valores nos campos; depois disso, obtemos os getters e observamos que ele mudou o que eles retornam ou n√£o.  Portanto, veremos que, a partir do registro no campo de <code>name</code> , o valor de <code>getClientId</code> n√£o muda, mas a partir da <code>id</code> do registro - ele muda.  Al√©m disso, a situa√ß√£o em que getters e campos de diferentes tipos (como <code>isActive() = i_active != 0</code> ) s√£o automaticamente suportados aqui.  Mas h√° pelo menos tr√™s problemas s√©rios (talvez mais, mas n√£o pensei mais). </p><br><ol><li>  O requisito √≥bvio para a ess√™ncia desse algoritmo √© retornar o valor "mesmo" do getter se o campo "correspondente" n√£o tiver sido alterado.  "Um e o mesmo" - do ponto de vista do operador de compara√ß√£o que escolhemos.  <code>==</code> obviamente n√£o pode ser (caso contr√°rio, <code>getAsInt() = Integer.parseInt(strField))</code> deixar√° de funcionar <code>getAsInt() = Integer.parseInt(strField))</code> .  Permanece igual.  Portanto, se o getter retornar algum tipo de entidade do usu√°rio gerada pelos campos em cada chamada, ele dever√° ter uma substitui√ß√£o de <code>equals</code> . </li><li>  Mapeamentos de compacta√ß√£o.  Como no exemplo com <code>int -&gt; boolean</code> acima.  Se verificarmos os valores 0 e 1, veremos uma mudan√ßa.  Mas se aos 40 e 42, ambas as vezes nos tornamos realidade. </li><li>  Pode haver conversores complexos em getters que dependem de certos invariantes nos campos (por exemplo, um formato de string especial).  E em nossos dados gerados eles lan√ßam exce√ß√µes. </li></ol><br><p>  Portanto, em geral, a op√ß√£o tamb√©m n√£o est√° funcionando. </p><br><p>  No processo de discutir a coisa toda, eu jocosamente pronunciei a frase "bem, nafig, √© mais f√°cil ver o bytecode, tudo est√° escrito l√°".  Naquela √©poca, eu nem percebi que essa id√©ia me engoliria e at√© onde tudo iria. </p><br><a name="5"></a><br><h3 id="chast-pyataya-chto-takoe-baytkod-i-kak-on-rabotaet">  Parte Cinco  O que √© bytecode e como funciona </h3><br><p> <code>new #4, dup, invokespecial #5, areturn</code> <br>  Se voc√™ entender o que est√° escrito aqui e o que esse c√≥digo faz, poder√° pular para a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pr√≥xima</a> parte. </p><br><p>  <em>Isen√ß√£o de responsabilidade 1.</em> Infelizmente, para entender a hist√≥ria adicional, voc√™ precisa de pelo menos um entendimento b√°sico da apar√™ncia do bytecode Java, ent√£o escreverei alguns par√°grafos sobre isso.  De forma alguma finja estar completo. </p><br><p>  <em>Isen√ß√£o 2.</em> Ser√° exclusivamente sobre o corpo dos m√©todos.  Nem sobre o pool constante, nem sobre a estrutura da classe como um todo, nem sobre as pr√≥prias declara√ß√µes do m√©todo, direi uma palavra. </p><br><p>  A principal coisa que voc√™ precisa entender sobre o bytecode √© o montador da m√°quina virtual de pilha Java.  Isso significa que os argumentos para as instru√ß√µes s√£o retirados da pilha e os valores de retorno das instru√ß√µes s√£o empurrados de volta para a pilha.  Deste ponto de vista, podemos dizer que o bytecode est√° escrito em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">nota√ß√£o polonesa reversa</a> .  Al√©m da pilha, o m√©todo tamb√©m possui uma matriz de vari√°veis ‚Äã‚Äãlocais.  Ao inserir o m√©todo, <code>this</code> e todos os argumentos deste m√©todo s√£o gravados nele e as vari√°veis ‚Äã‚Äãlocais s√£o armazenadas l√° durante a execu√ß√£o.  Aqui est√° um exemplo simples. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateAndReturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> baz, String str)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) baz; result += str.length(); bar = result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br><p>  Vou escrever coment√°rios no formato </p><br><pre> <code class="plaintext hljs"># [(&lt;local_variable_index&gt;:&lt;actual_value&gt;)*], [(&lt;value_on_stack&gt;)*]</code> </pre> <br><p>  Topo da pilha √† esquerda. </p><br><pre> <code class="plaintext hljs">public int updateAndReturn(long, java.lang.String); Code: # [0:this, 1:long baz, 3:str], () 0: lload_1 # [0:this, 1:long baz, 3:str], (long baz) 1: l2i # [0:this, 1:long baz, 3:str], (int baz) 2: istore 4 # [0:this, 1:long baz, 3:str, 4:int baz], () 4: iload 4 # [0:this, 1:long baz, 3:str, 4:int baz], (int baz) 6: aload_3 # [0:this, 1:long baz, 3:str, 4:int baz], (str, int baz) 7: invokevirtual #2 // Method java/lang/String.length:()I # [0:this, 1:long baz, 3:str, 4:int baz], (length(str), int baz) 10: iadd # [0:this, 1:long baz, 3:str, 4:int baz], (length(str) + int baz) 11: istore 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], () 13: aload_0 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (this) 14: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz, this) 16: putfield #3 // Field bar:I # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (),     bar 19: iload 4 # [0:this, 1:long baz, 3:str, 4:length(str) + int baz], (length(str) + int baz) 21: ireturn #  int   ,      </code> </pre> <br><p>  H√° muitas instru√ß√µes.  A lista completa precisa ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">consultada</a> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">sexto cap√≠tulo da JVMS</a> , na Wikipedia h√° uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">breve recontagem</a> .  Um grande n√∫mero de instru√ß√µes se duplicam para tipos diferentes (por exemplo, <code>iload</code> para int e <code>lload</code> por muito tempo).  Al√©m disso, para trabalhar com as 4 primeiras vari√°veis ‚Äã‚Äãlocais, suas instru√ß√µes s√£o destacadas (por exemplo, existe <code>lload_1</code> e n√£o leva argumentos, mas apenas <code>lload</code> , o n√∫mero da vari√°vel local ser√° <code>lload</code> como argumento. No exemplo acima, h√° um <code>iload</code> semelhante). </p><br><p>  Globalmente, estaremos interessados ‚Äã‚Äãnos seguintes grupos de instru√ß√µes: </p><br><ol><li>  <code>*load*</code> , <code>*store*</code> - l√™ / grava uma vari√°vel local </li><li>  <code>*aload</code> , <code>*astore</code> - l√™ / escreve um elemento da matriz por √≠ndice </li><li>  <code>getfield</code> , <code>putfield</code> - campo de leitura / grava√ß√£o </li><li>  <code>getstatic</code> , <code>putstatic</code> - campo est√°tico de leitura / grava√ß√£o </li><li>  <code>checkcast</code> - convertido entre tipos de objetos.  Precisa porque  valores digitados est√£o na pilha e em vari√°veis ‚Äã‚Äãlocais.  Por exemplo, acima foi l2i para o elenco long -&gt; int. </li><li>  <code>invoke*</code> - chamada de m√©todo </li><li>  <code>*return</code> - retorna o valor e sai do m√©todo </li></ol><br><a name="6"></a><br><h3 id="chast-shestaya-glavnaya">  Parte Seis  P√°gina inicial </h3><br><p>  Para aqueles que perderam uma introdu√ß√£o t√£o longa, assim como para se distrair do problema original e da raz√£o em termos da biblioteca, formulamos o problema com mais precis√£o. </p><br><blockquote>  √â necess√°rio ter uma inst√¢ncia <code>java.lang.reflect.Method</code> dispon√≠vel para obter uma lista de todos os campos n√£o est√°ticos (objetos atuais e todos os objetos aninhados) cujas leituras (direta ou transitivamente) estar√£o dentro desse m√©todo. </blockquote><p>  Por exemplo, para esse m√©todo </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>  Voc√™ precisa obter uma lista de dois campos: <code>account.balance</code> e <code>client.defaultAccount.balance</code> . </p><br><p>  Escreverei, se poss√≠vel, uma solu√ß√£o generalizada.  Mas em alguns lugares voc√™ ter√° que usar o conhecimento do problema original para resolver problemas insol√∫veis, no caso geral. </p><br><p>  Primeiro, voc√™ precisa obter o bytecode do corpo do m√©todo, mas n√£o pode fazer isso diretamente atrav√©s do Java.  Mas desde  Como o m√©todo existe originalmente em alguma classe, √© mais f√°cil obter a pr√≥pria classe.  Globalmente, conhe√ßo duas op√ß√µes: entrar no processo de carregamento de classe e interceptar o <code>byte[]</code> j√° lido <code>byte[]</code> l√°, ou simplesmente encontrar o arquivo <code>ClassName.class</code> no disco e l√™-lo.  A intercepta√ß√£o de carregamento no n√≠vel da biblioteca usual n√£o pode ser feita.  Voc√™ precisa conectar o javaagent ou usar o ClassLoader personalizado.  Em qualquer caso, s√£o necess√°rias etapas adicionais para configurar o jvm / application, e isso √© inconveniente.  Voc√™ pode fazer isso mais f√°cil.  Todas as classes "comuns" est√£o sempre no mesmo arquivo com a extens√£o ".class", cujo caminho √© o pacote de classes.  Sim, n√£o funcionar√° para encontrar classes adicionadas dinamicamente ou carregadas por algum carregador de classes personalizado, mas precisamos disso para o modelo jdbc, para que possamos dizer com confian√ßa que todas as classes ser√£o empacotadas da "maneira padr√£o" em jars.  Total: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); }</code> </pre> <br><p>  Viva, leia a matriz de bytes.  O que faremos com isso a seguir?  Em princ√≠pio, existem v√°rias bibliotecas em Java para leitura / grava√ß√£o de c√≥digo de c√≥digo, mas o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">ASM</a> √© geralmente usado para o trabalho de n√≠vel mais baixo.  Porque  ela √© aprimorada para alto desempenho e opera√ß√£o imediata, a API do visitante √© a principal - a ASM l√™ sequencialmente a classe e usa os m√©todos apropriados </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FieldVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, Object value)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{...} ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MethodVisitor mv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodVisitor mv)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mv = mv; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, Label label)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mv != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mv.visitJumpInsn(opcode, label); } } ... }</code> </pre> <br><p>  O usu√°rio √© convidado a redefinir os m√©todos de interesse para ele e a escrever sua pr√≥pria l√≥gica de an√°lise / transforma√ß√£o.  Separadamente, no exemplo do <code>MethodVisitor</code> , gostaria de chamar a aten√ß√£o para o fato de que todos os visitantes t√™m uma implementa√ß√£o padr√£o por meio da delega√ß√£o. </p><br><p>  Al√©m da API principal, tamb√©m h√° uma API de √°rvore pronta para uso.  Se a API principal for anal√≥gica do analisador SAX, a API da √°rvore ser√° anal√≥gica do DOM.  N√≥s temos um objeto dentro do qual todas as informa√ß√µes sobre a classe / m√©todo s√£o armazenadas e podemos analis√°-lo como quisermos com saltos para qualquer lugar.  De fato, essa API √© uma implementa√ß√£o <code>*Visitor</code> que, dentro dos m√©todos <code>visit*</code> , simplesmente armazena informa√ß√µes.  Quase todos os m√©todos s√£o parecidos com este: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitJumpInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Label label)</span></span></span><span class="hljs-function"> </span></span>{ instructions.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JumpInsnNode(opcode, getLabelNode(label))); } ... }</code> </pre> <br><p>  Agora, finalmente, podemos carregar o m√©todo para an√°lise. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      if (!name.equals(getterName) || !desc.equals(getterDesc)) return null; return new AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } private class AnalyzerMethodVisitor extends MethodVisitor { public AnalyzerMethodVisitor(int access, String name, String desc, String signature, String[] exceptions) { super(ASM6, new MethodNode(ASM6, access, name, desc, signature, exceptions)); } @Override public void visitEnd() { //     ,     MethodVisitor    if (methodNode != null) throw new IllegalStateException(); methodNode = (MethodNode) mv; } } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">M√©todo de leitura de c√≥digo completo.</b> <div class="spoiler_text"><p>  <code>MethodNode</code> n√£o <code>MethodNode</code> retornado diretamente, mas um wrapper com um par de ext.  campos porque  tamb√©m precisaremos deles mais tarde.  O ponto de entrada (e o √∫nico m√©todo p√∫blico) √© <code>readMethod(Method): MethodInfo</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodReader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode methodNode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalDeclaringClassName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> classAccess, MethodNode methodNode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internalDeclaringClassName = internalDeclaringClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classAccess = classAccess; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.methodNode = methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInternalDeclaringClassName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> internalDeclaringClassName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> classAccess; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MethodInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method)</span></span></span><span class="hljs-function"> </span></span>{ Class&lt;?&gt; clazz = method.getDeclaringClass(); String internalClassName = getInternalName(clazz); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream is = getClassFile(clazz)) { ClassReader cr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassReader(is); AnalyzerClassVisitor cv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerClassVisitor(internalClassName, method); cr.accept(cv, SKIP_DEBUG | SKIP_FRAMES); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodInfo(internalClassName, cv.getAccess(), cv.getMethodNode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;?&gt; clazz)</span></span></span><span class="hljs-function"> </span></span>{ String file = clazz.getName().replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">".class"</span></span>; ClassLoader cl = clazz.getClassLoader(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cl == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClassLoader.getSystemResourceAsStream(file); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cl.getResourceAsStream(file); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String className; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String getterDesc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MethodNode methodNode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> access; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerClassVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String internalClassName, Method getter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.className = internalClassName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterName = getter.getName(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getterDesc = getMethodDescriptor(getter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodNode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodNode; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String signature, String superName, String[] interfaces)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(className)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.access = access; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodVisitor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.equals(getterName) || !desc.equals(getterDesc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnalyzerMethodVisitor(access, name, desc, signature, exceptions); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodVisitor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzerMethodVisitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> access, String name, String desc, String signature, String[] exceptions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ASM6, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodNode(ASM6, access, name, desc, signature, exceptions)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); methodNode = (MethodNode) mv; } } } }</code> </pre> </div></div><br><p>  √â hora de fazer a an√°lise diretamente.  Como fazer isso?  O primeiro pensamento √© examinar todas <code>getfield</code> instru√ß√µes <code>getfield</code> .  Cada <code>getfield</code> diz estaticamente qual √© o campo e qual classe.  Pode ser considerado necess√°rio todos os campos de nossa classe aos quais houve acesso.  Mas, infelizmente, isso n√£o funciona.  O primeiro problema aqui √© que o excesso est√° sendo capturado. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> baz; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bar + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Foo().baz; } }</code> </pre> <br><p>  Com esse algoritmo, consideramos que o campo baz √© necess√°rio, embora, de fato, n√£o.  Mas esse problema ainda pode ser marcado.  Mas o que fazer com os m√©todos? </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClientId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HasClientId obj = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.getClientId(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } }</code> </pre> <br><p>  Se procurarmos por chamadas de m√©todo da mesma maneira que procuramos por campos de leitura, n√£o encontraremos <code>getClientId</code> .  Pois n√£o h√° chamada para <code>Client.getClientId</code> , mas apenas uma chamada para <code>HasClientId.getClientId</code> .  Obviamente, voc√™ pode considerar todos os m√©todos da classe atual, todas as suas superclasses e todas as interfaces a serem usadas, mas isso j√° √© demais.  Assim, voc√™ pode capturar acidentalmente o <code>toString</code> , e nele est√° uma lista de todos os campos em geral. </p><br><p>  Al√©m disso, queremos que as chamadas getter em objetos aninhados funcionem tamb√©m </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getId(); } }</code> </pre> <br><p>  E aqui a chamada para o m√©todo <code>Client.getId</code> n√£o se aplica √† classe <code>Account</code> . </p><br><p>  Com um forte desejo, voc√™ ainda pode pensar em hacks para casos especiais por algum tempo, mas rapidamente entende-se que "as coisas n√£o s√£o feitas dessa maneira" e voc√™ precisa monitorar completamente o fluxo de execu√ß√£o e movimenta√ß√£o de dados.        <code>getfield</code> ,      <code>this</code> ,   -   <code>this</code> .  Aqui est√° um exemplo: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.id + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Account().id; } }</code> </pre> <br><pre> <code class="plaintext hljs">class Account { public Client client; public long test(); Code: 0: aload_0 1: getfield #2 // Field client:LClient; 4: getfield #3 // Field Client.id:J 7: new #4 // class Account 10: dup 11: invokespecial #5 // Method "&lt;init&gt;":()V 14: getfield #6 // Field id:J 17: ladd 18: lreturn }</code> </pre> <br><ul><li> <code>1: getfield</code>              <code>this</code> ,    <code>aload_0</code> . </li><li> <code>4: getfield</code> ‚Äî       ,    <code>1: getfield</code> , , ,  <code>this</code> . </li><li> <code>14: getfield</code>   .  Porque    ,       ( <code>Account</code> ),     <code>this</code> ,    ,       <code>7: new</code> . </li></ul><br><p> ,        <code>Account.client.id</code> ,  <code>Account.id</code> ‚Äî .     ,    ,       . </p><br><p>      ‚Äî    ,    ,   <code>aload_0</code>  <code>getfield</code>         <code>this</code>  , ,        . , .   .     ‚Äî    !   -,    .     <code>MethodNode</code> ,    (  ).     , ..    (//)        . </p><br><p>     : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyzer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Interpreter&lt;V&gt; interpreter)</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Frame&lt;V&gt;[] analyze(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String owner, <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodNode m) {...} }</code> </pre> <br><p> <code>Analyzer</code>      (  <code>Frame</code> ,    )   .      ,    ,   ,  ,       //etc. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Interpreter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value1, V value2, V value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends V&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, V value, V expected)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(V v, V w)</span></span></span></span>; }</code> </pre> <br><p>  <code>V</code> ‚Äî   ,      ,    . <code>Analyzer</code>          ,    ,           ,      . , <code>getfield</code>      ‚Äî ,    ,     . ,   <code>unaryOperation(AbstractInsnNode insn, V value): V</code> ,                 .     <code>1: getfield</code>   <code>Value</code> ,     "  <code>client</code> ,  <code>Client</code>        ",   <code>14: getfield</code>  " ‚Äî  -  ,         ". </p><br><p>       <code>merge(V v, V w): V</code> .      ,        ,    .  Por exemplo: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Account acc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) acc = account; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> acc = client.getDefaultAccount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.getBalance(); }</code> </pre> <br><p>    <code>Account.getBalance()</code>     .  - .       .   ?         <code>merge</code> . </p><br><p>        ‚Äî  <code>SuperInterpreter extends Interpreter&lt;SuperValue&gt;</code> ?  Certo.    <code>SuperValue</code> .     ‚Äî       ,        .                ,           . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } }</code> </pre> <br><p>     <code>composite</code> .   ,     . ,  <code>String</code>   .         <code>String.length()</code> ,   ,       <code>name</code> ,   <code>name.value.length</code> . , <code>length</code> ‚Äî    ,   ,    <code>arraylength</code> .     ?  N√£o!          ‚Äî         . ,       ,     ,      . ,  <code>Date</code> , <code>String</code> , <code>Long</code> ,          . ,     ,      .     </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persion</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcColumn</span></span>(converter = CustomJsonConverter.class) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PassportInfo passportInfo; }</code> </pre> <br><p>     <code>PassportInfo</code>    .     ,  .  ,  <code>composite</code>    .       . </p><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ref</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Field&gt; path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> composite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Field&gt; path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> composite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.composite = composite; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Field&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> composite; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Ref ref = (Ref) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(path, ref.path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(path); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;[this]&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> + path.stream().map(Field::getName).collect(joining(<span class="hljs-string"><span class="hljs-string">"."</span></span>)) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Ref </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thisRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ref(emptyList(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childRef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ref parent, Field field, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parent.isComposite()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field))<span class="hljs-comment"><span class="hljs-comment">//    ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.add(field); return of(new Ref(path, configuration.isCompositeField(field))); } public static Optional&lt;Ref&gt; childRef(Ref parent, Ref child) { if (!parent.isComposite()) return empty(); if (child.path.stream().anyMatch(parent.path::contains))// ,   return empty(); List&lt;Field&gt; path = new ArrayList&lt;&gt;(parent.path); path.addAll(child.path); return of(new Ref(path, child.composite)); } }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Ref&gt; refs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Set&lt;Ref&gt; refs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(type); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refs = refs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Set&lt;Ref&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRefs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> refs; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.equals(o)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Value value = (Value) o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(refs, value.refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.hash(<span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.hashCode(), refs); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"("</span></span> + refs.stream().map(Object::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">","</span></span>)) + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typedValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Ref ref)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, singleton(ref)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, Value child)</span></span></span><span class="hljs-function"> </span></span>{ Type type = child.getType(); Set&lt;Ref&gt; fields = parent.refs.stream() .flatMap(p -&gt; child.refs.stream().map(c -&gt; childRef(p, c))) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Optional&lt;Value&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">childValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Value parent, FieldInsnNode childInsn, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ Type type = Type.getType(childInsn.desc); Field child = resolveField(childInsn); Set&lt;Ref&gt; fields = parent.refs.stream() .map(p -&gt; childRef(p, child, configuration)) .filter(Optional::isPresent) .map(Optional::get) .collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fields.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> of(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(type, fields)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;Value&gt; values)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Type&gt; types = values.stream().map(BasicValue::getType).distinct().collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (types.size() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { String typesAsString = types.stream().map(Type::toString).collect(joining(<span class="hljs-string"><span class="hljs-string">", "</span></span>, <span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + typesAsString); } Set&lt;Ref&gt; fields = values.stream().flatMap(v -&gt; v.refs.stream()).distinct().collect(toSet()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Value(types.get(<span class="hljs-number"><span class="hljs-number">0</span></span>), fields); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isComposite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value &amp;&amp; value.getType().getSort() == Type.OBJECT &amp;&amp; ((Value) value).refs.stream().anyMatch(Ref::isComposite); } }</code> </pre> </div></div><br><p>   ,    .  Vamos l√°! </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldsInterpreter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicInterpreter</span></span></span><span class="hljs-class"> </span></span>{</code> </pre> <br><p>       ,    <code>BasicInterpreter</code> .    <code>BasicValue</code> (    ,   <code>Value</code>  <code>extends BasicValue</code> )      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue UNINITIALIZED_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue INT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.INT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue FLOAT_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.FLOAT_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue LONG_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.LONG_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue DOUBLE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.DOUBLE_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue REFERENCE_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.getObjectType(<span class="hljs-string"><span class="hljs-string">"java/lang/Object"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BasicValue RETURNADDRESS_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(Type.VOID_TYPE); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Type type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BasicValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.type = type; } }</code> </pre> <br><p>         ( <code>(Value)basicValue</code> )  ,          ,     ( " <code>iconst</code>  ")  . </p><br><p>   <code>newValue</code> .       ,       ,  " ".   , <code>this</code>     <code>catch</code> .  ,     ,     .    <code>BasicInterpreter</code>  <code>BasicValue(actualType)</code>   <code>BasicValue.REFERENCE_VALUE</code> .       . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; type.getSort() == OBJECT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicValue(type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.newValue(type); }</code> </pre> <br><p>  entry point.      <code>this</code> . ,  - ,  ,   <code>this</code> ,     <code>BasicValue(actualType)</code> ,  <code>Value.typedValue(actualType, Ref.thisRef())</code> . ,     ,   <code>this</code>    <code>newValue</code> ,     .       , ..         ,   <code>this</code> .     <code>this</code>    . ,  . ,     <code>this</code>       0.       ,      .   ,            ,  .             . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wasUpdated || insn.getType() != VAR_INSN || ((VarInsnNode) insn).<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ALOAD: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typedValue(value.getType(), thisRef()); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ISTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DSTORE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ASTORE: wasUpdated = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.copyOperation(insn, value); }</code> </pre> <br><p>  .    .    ,   ,    ,   ‚Äî ,   .   ,    . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasicValue v, BasicValue w)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v.equals(w)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value || w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Objects.equals(v.getType(), w.getType())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v == UNINITIALIZED_VALUE || w == UNINITIALIZED_VALUE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UNINITIALIZED_VALUE; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not merge "</span></span> + v + <span class="hljs-string"><span class="hljs-string">" and "</span></span> + w); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value != w <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> w; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(asList((Value) v, (Value) w)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.merge(v, w); }</code> </pre> <br><p>    .      ""?         ?  Na verdade n√£o.          .        , ..       . ,      3 (       ): <code>putfield</code> , <code>putstatic</code> , <code>aastore</code> .    .     <code>putstatic</code> (   )    .     ,          .    <code>putfield</code>  <code>aastore</code> .   ,           ,      .   (  )              .            ,             . ,    ‚Äî      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>    ,        ( <code>ofNullable</code>    <code>Optional</code>  <code>client</code>      <code>value</code> ),         . .     . ,         - <code>ofNullable(client)</code> ,    - <code>map(Client::getId)</code> ,    . </p><br><p>        <code>putfield</code> , <code>putstatic</code>  <code>aastore</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == PUTFIELD &amp;&amp; Value.isComposite(value2)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value2 + <span class="hljs-string"><span class="hljs-string">" over putfield"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.binaryOperation(insn, value1, value2); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ternaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value1, BasicValue value2, BasicValue value3)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (insn.getOpcode() == AASTORE &amp;&amp; Value.isComposite(value3)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value3 + <span class="hljs-string"><span class="hljs-string">" over aastore"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.ternaryOperation(insn, value1, value2, value3); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PUTSTATIC: { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not trace "</span></span> + value + <span class="hljs-string"><span class="hljs-string">" over putstatic"</span></span>); } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>   .       <code>checkcast</code> .          :      .  ‚Äî    </p><br><pre> <code class="java hljs">Client client1 = ...; Object objClient = client1; Client client2 = (Client) objClient;</code> </pre> <br><p>         ,        .         ,   ,       <code>client1</code>  <code>objClient</code> ,   . ,   <code>checkcast</code>          . </p><br><p>     . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;?&gt; list; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trimToSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ((ArrayList&lt;?&gt;) list).trimToSize(); } }</code> </pre> <br><p>      .       ,      ,  ,     .  ,   ,         ,        ,    ,     .          ?  , !       .   ,          ,  ,              null/0/false.    .   ‚Äî   </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span>(localColumn = <span class="hljs-string"><span class="hljs-string">"CLIENT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client;</code> </pre> <br><p>    ,       , ORM      ,    .       <code>checkcast</code> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CHECKCAST: { Class&lt;?&gt; original = reflectClass(value.getType()); Type targetType = getObjectType(((TypeInsnNode) insn).desc); Class&lt;?&gt; afterCast = reflectClass(targetType); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (afterCast.isAssignableFrom(original)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"type specification not supported"</span></span>); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>     ‚Äî <code>getfield</code> .      ‚Äî   ? </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Foo child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Foo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Foo loopedRef = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ThreadLocalRandom.current().nextBoolean()) { loopedRef = loopedRef.child; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> loopedRef; } }</code> </pre> <br><p> ,        .     ? <code>child</code> , <code>child.child</code> , <code>child.child.child</code> ?  ? ,       .  ,        .       , </p><br><blockquote>           null. </blockquote><p>        child,       null, , ,     .        <code>Ref.childRef</code>  </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent.path.contains(field)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> empty();</code> </pre> <br><p>    .       ,    . </p><br><p>       "  ".          .   ,           . ,   ,       ( <code>@JdbcJoinedObject</code> ,  <code>@JdbcColumn</code> ),      ,    . ORM        . </p><br><p> ,   <code>getfield</code>           ,     .     ,   ,     ,      .  ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unaryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, BasicValue value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GETFIELD: { Optional&lt;Value&gt; optionalFieldValue = childValue((Value) value, (FieldInsnNode) insn, configuration); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!optionalFieldValue.isPresent()) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; Value fieldValue = optionalFieldValue.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configuration.isInterestingField(resolveField((FieldInsnNode) insn))) { context.addUsedField(fieldValue); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(fieldValue)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldValue; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } ... } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.unaryOperation(insn, value); }</code> </pre> <br><p>    .  ,    , .   ,    <code>invoke*</code> .         , ,   ,        .  , : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getClient().getId(); }</code> </pre> <br><p>  ,      ,     .           ,   .    .      ,          .    ?          .    .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JdbcJoinedObject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Client </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } }</code> </pre> <br><p>  <code>Account.client</code>          .   ,      .        .    ‚Äî        ,     . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Set&lt;Value&gt; usedFields; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Value returnedCompositeValue; }</code> </pre> <br><p>    ?  ,   .          .  , ..      (  ,   ‚Äî  ),   ,       <code>areturn</code> , ,   ,    <code>*return</code> .  <code>MethodNode</code> ( ,     Tree API)       .     .  ‚Äî          . ,             ?      .         . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnedCompositeValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Frame&lt;BasicValue&gt;[] frames, AbstractInsnNode[] insns)</span></span></span><span class="hljs-function"> </span></span>{ Set&lt;Value&gt; resultValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; insns.length; i++) { AbstractInsnNode insn = insns[i]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DRETURN: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ARETURN: BasicValue value = frames[i].getStack(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(value)) { resultValues.add((Value) value); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mergeValues(resultValues); }</code> </pre> <br><p>    <code>analyzeField</code>   </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Result </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyzeField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Method method, Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Modifier.isNative(method.getModifiers())) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not analyze native method "</span></span> + method); MethodInfo methodInfo = readMethod(method); MethodNode mn = methodInfo.getMethodNode(); String internalClassName = methodInfo.getInternalDeclaringClassName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> classAccess = methodInfo.getClassAccess(); Context context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(method, classAccess); FieldsInterpreter interpreter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldsInterpreter(context, configuration); Analyzer&lt;BasicValue&gt; analyzer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Analyzer&lt;&gt;(interpreter); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { analyzer.analyze(internalClassName, mn); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AnalyzerException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } Frame&lt;BasicValue&gt;[] frames = analyzer.getFrames(); AbstractInsnNode[] insns = mn.instructions.toArray(); Value returnedCompositeValue = getReturnedCompositeValue(frames, insns); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result(context.getUsedFields(), returnedCompositeValue); }</code> </pre> <br><p>   , -,     . <code>invoke*</code> .      5 : </p><br><ol><li> <code>invokespecial</code> ‚Äî      .    ,  ,   (     <code>super.call()</code> ). </li><li> <code>invokevirtual</code> ‚Äî     .          . ,        . </li><li> <code>invokeinterface</code> ‚Äî   ,   <code>invokevirtual</code> ,    ‚Äî      . </li><li> <code>invokestatic</code> ‚Äî    </li><li> <code>invokedynamic</code> ‚Äî  ,   7    JSR 292.          JVM,   <code>invokedynamic</code>       (     dynamic).   ,          (+  ),        .  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Invokedynamic:   ?</a>  . </li></ol><br><p>  ,      ,       ,      .  <code>invokedynamic</code>   ,   .  ,      ,       ,     (,       ),   <code>invokedynamic</code>  .   ,   ""  .  ,         <code>invokedynamic</code> ,      . </p><br><p>  . ,         .  ,        . ,      <code>this</code> ,     0? ,    - ,         <code>FieldsInterpreter</code>   <code>copyOperation</code>     .  ,    <code>MethodAnalyzer.analyzeFields</code>    "     <code>this</code> "  "      " ( <code>this</code> ‚Äî  ).     ,   .   ,   ,  .          ,               - .    ,         (- <code>Optional.ofNullable(client)</code> ).             . </p><br><p> , <code>invokestatic</code>   (..   ,  <code>this</code>   ).  <code>invokespecial</code> , <code>invokevirtual</code>  <code>invokeinterface</code> .  ,         .  ,      ,     jvm.  <code>invokespecial</code>  ,               ,     .    <code>invokevirtual</code>  <code>invokeinterface</code> .   ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">objectToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.toString(); }</code> </pre> <br><pre> <code class="plaintext hljs">public static java.lang.String objectToString(java.lang.Object); Code: 0: aload_0 1: invokevirtual #104 // Method java/lang/Object.toString:()Ljava/lang/String; 4: areturn</code> </pre> <br><p> , ,    ( )  . ,       ,    .            ?        <em>  ORM</em> .  ORM   ,            ,     .      <code>invokevirtual</code>  <code>invokeinterface</code>   . </p><br><p>  Viva!   .  O que vem a seguir?      ,        (         ,     <code>this</code>  ),     ( ,    )       .  ! </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BasicValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">naryOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractInsnNode insn, List&lt;? extends BasicValue&gt; values)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AnalyzerException </span></span>{ Method method = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Value methodThis = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (insn.getOpcode()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESPECIAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEVIRTUAL: {...} <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEINTERFACE: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Value.isComposite(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>))) { MethodInsnNode methodNode = (MethodInsnNode) insn; Class&lt;?&gt; objectClass = reflectClass(values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getType()); Method interfaceMethod = resolveInterfaceMethod(reflectClass(methodNode.owner), methodNode.name, getMethodType(methodNode.desc)); method = lookupInterfaceMethod(objectClass, interfaceMethod); methodThis = (Value) values.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); } List&lt;?&gt; badValues = values.stream().skip(<span class="hljs-number"><span class="hljs-number">1</span></span>).filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKESTATIC: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> INVOKEDYNAMIC: { List&lt;?&gt; badValues = values.stream().filter(Value::isComposite).collect(toList()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!badValues.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"could not pass "</span></span> + badValues + <span class="hljs-string"><span class="hljs-string">" as parameter"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { MethodAnalyzer.Result methodResult = analyzeFields(method, configuration); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Value usedField : methodResult.getUsedFields()) { childValue(methodThis, usedField).ifPresent(context::addUsedField); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodResult.getReturnedCompositeValue() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Optional&lt;Value&gt; returnedValue = childValue(methodThis, methodResult.getReturnedCompositeValue()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (returnedValue.isPresent()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnedValue.get(); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.naryOperation(insn, values); }</code> </pre> <br><p>         .    ,      .  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">  JVMS</a>      1  1.            .   ‚Äî    .  ,   ,        .   ,     ..     ,   -    ,       2  ‚Äî   .         ,   ,       .   ,   ‚Äî .    ,   <a href="" rel="nofollow">ResolutionUtil</a>  <a href="" rel="nofollow">LookupUtil</a> . </p><br><p> ! </p><br><a name="7"></a><br><h3 id="chast-sedmaya-chto-esche-mozhno-dodelat">  .     </h3><br><p>  ,   80%   20%     20%   80% . ,     ,    ,   ? </p><br><ul><li><p>        .          . </p><br></li><li><p>       .    (..        ),        . ,    .        ,      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.ofNullable(client).map(Client::getId).orElse(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><p>     <code>Optional</code> ,   <code>ofNullable</code>     <code>getClientId</code>  ,  ,      <code>value</code>    .  ,        <code>returnedCompositeValue</code> ‚Äî  ,   ,     . , ,        (  )               ,  .        -.          ,    ,    ,  "  <code>value</code>  <code>Optional@1234</code>  <code>Client@5678</code> "   . </p><br></li><li><p>  <code>invokedynamic</code> ,     .    indy      ,      .    ,          . ,     .  ,         invokedynamic.     .    . ,           <code>java.lang.invoke.LambdaMetafactory.metafactory</code> .    ,  ,   ,      .    <code>java.lang.invoke.StringConcatFactory.makeConcat/makeConcatWithConstants</code> .     .          <code>toString()</code> . , ,  ,  ,  .    ,     ,   ,  /-     .            jvm,      .    ,  ,  .             .    .   ,  ,               .          indy .    ?     indy    ,     ‚Äî <code>CallSite</code> .           . , ,    <code>LambdaMetafactory.metafactory</code>       <code>getValue</code> ,         .       <code>getValue</code> .     (  )  .  , , ,   stateless. ,    !    -    ,      .  <code>CallSite</code>   <code>ConstantCallSite</code> , <code>MutableCallSite</code>  <code>VolatileCallSite</code> .    mutable  volatile   ,       ,   <code>ConstantCallSite</code>  .         "-   ". ,  ,    .    ,         VM,       . </p><br></li></ul><br><a name="8"></a><br><h3 id="posleslovie">  Posf√°cio </h3><br><p> - ,   .   -  <code>partialGet</code>     . ,    .   ,   ,       ,         ,   " "   . </p><br><p>  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt409043/">https://habr.com/ru/post/pt409043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt409033/index.html">Superaglomerado oculto pode resolver o mist√©rio da Via L√°ctea</a></li>
<li><a href="../pt409035/index.html">Finalmente, lidamos com graus: a causa do acidente da Fragata</a></li>
<li><a href="../pt409037/index.html">Scanner 3D de nova gera√ß√£o EinScan-SE</a></li>
<li><a href="../pt409039/index.html">PocketBook-2017: lembre-se do ano passado e resuma-o</a></li>
<li><a href="../pt409041/index.html">A execu√ß√£o n√£o pode ser perdoada: lidamos com pontua√ß√£o em ingl√™s</a></li>
<li><a href="../pt409045/index.html">A conex√£o secreta da matem√°tica e da f√≠sica puras √© revelada</a></li>
<li><a href="../pt409047/index.html">Relan√ßamento da primeira etapa e c√°psula de carga usadas para a ISS. NASA n√£o se importa</a></li>
<li><a href="../pt409049/index.html">FDA aprova a primeira terapia gen√©tica direta para doen√ßas gen√©ticas</a></li>
<li><a href="../pt409051/index.html">Dmitry Muromtsev (ITMO) - sobre modelagem ontol√≥gica e forma√ß√£o de intelig√™ncia conversacional</a></li>
<li><a href="../pt409053/index.html">Lan√ßou um helic√≥ptero - conseguiu uma multa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>