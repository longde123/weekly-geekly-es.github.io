<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöá ‚ôäÔ∏è üíÑ GLSL: Center ou Centroid? Ou quando os shaders atacam üåµ üí™üèæ üë©üèª‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Modificando o shader para o pr√≥ximo jogo, encontrei um artefato desagrad√°vel que s√≥ se manifesta quando o hardware MSAA est√° ativado. Na captura de te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GLSL: Center ou Centroid? Ou quando os shaders atacam</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434046/">  Modificando o shader para o pr√≥ximo jogo, encontrei um artefato desagrad√°vel que s√≥ se manifesta quando o hardware MSAA est√° ativado.  Na captura de tela da paisagem, voc√™ pode ver alguns pixels brilhantes demais.  Os valores de cores em v√°rios deles eram t√£o grandes que, ap√≥s a flora√ß√£o, eles se transformaram em "fantasmas" multicoloridos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ta/gx/zy/tagxzyrj4t5z9godohkp1fgteya.png" alt="imagem"></div><br>  Trago √† sua aten√ß√£o a tradu√ß√£o de um artigo que explica em detalhes a raz√£o desse fen√¥meno e a maneira de lidar com ele. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/526/948/f51/526948f51e45bbb855518c2cdf292d0e.jpg" alt="imagem"></div><br>  <i>Figura 1 - Imagens corretas (esquerda) e incorretas (direita).</i>  <i>Preste aten√ß√£o na barra amarela na borda esquerda da imagem "incorreta".</i>  <i>Embora a vari√°vel myMixer varie de 0 a 1, de alguma forma vai al√©m desse intervalo na imagem "incorreta".</i> <br><br>  Considere um shader de fragmento simples com uma transforma√ß√£o n√£o linear simples: <br><br><pre><code class="plaintext hljs">smooth in float myMixer; //      . //  sqrt    . void main( void ) { const vec3 blue = vec3( 0.0, 0.0, 1.0 ); const vec3 yellow = vec3( 1.0, 1.0, 0.0 ); float a = sqrt( myMixer ); //    myMixer &lt; 0.0 vec3 color = mix( blue, yellow, a ); //   gl_FragColor = vec4( color, 1.0 ); }</code> </pre> <br>  De onde veio a faixa amarela √† esquerda na imagem incorreta?  Para entender melhor o que deu errado, vamos primeiro examinar um caso em que tudo funciona corretamente (quase) sempre. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83d/1fe/6fd/83d1fe6fdaaffaf185291655c0808542.png" alt="imagem"></div><br>  <i>Esta √© uma rasteriza√ß√£o cl√°ssica com uma amostra.</i>  <i>Os quadrados cinzentos s√£o pixels e os pontos amarelos s√£o os centros dos pixels localizados nas coordenadas da janela meio inteira (por padr√£o, as coordenadas do pixel inferior esquerdo em gl_FragCoord s√£o (0,5, 0,5) - <i>trans.</i> ).</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e5/854/0c1/3e58540c1bf747df60150e88d564d4a0.png" alt="imagem"></div><br>  <i>Na figura acima, a linha secante separa o meio espa√ßo do primitivo.</i>  <i>Acima e √† esquerda desta linha, a vari√°vel myMixer √© positiva, e abaixo e √† direita √© negativa.</i> <br><br>  A rasteriza√ß√£o cl√°ssica de uma amostra classifica os pixels de acordo com a associa√ß√£o primitiva e cria fragmentos apenas para pixels cujos centros est√£o dentro da primitiva.  Neste exemplo, seis fragmentos ser√£o produzidos, mostrados no canto superior esquerdo.  Os pixels marcados em cores suaves n√£o se enquadram no primitivo.  Fragmentos n√£o ser√£o gerados para eles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83f/b9b/37f/83fb9b37f2e978f18643f111af0e2eb8.png" alt="imagem"></div><br>  <i>Verde indica os pontos nos quais o sombreador do fragmento ser√° calculado.</i>  <i>O valor do myMixer ser√° calculado para o centro de cada pixel.</i>  <i>Observe que os pontos verdes est√£o acima e √† esquerda da linha; portanto, os valores do myMixer neles ser√£o positivos.</i>  <i>Todos os dados de entrada associados aos v√©rtices (vari√°veis ‚Äã‚Äãde entrada ou sa√≠da) tamb√©m ser√£o interpolados nesses pontos.</i> <br><br>  Nosso sombreador simples n√£o usa derivadas (expl√≠citas ou impl√≠citas, por exemplo, ao amostrar de uma textura com n√≠veis mip), mas as derivadas dFdx (horizontal) e dFdy (vertical) s√£o marcadas com setas.  Dentro do primitivo, eles s√£o razoavelmente bem definidos e regulares. <br><br>  Para resumir: em uma √∫nica sele√ß√£o, os fragmentos s√£o gerados <i>apenas</i> se o centro do pixel cair "dentro" da primitiva, os dados do fragmento s√£o calculados para o centro do pixel, a interpola√ß√£o de dados de v√©rtices e o c√°lculo de sombreamento s√£o realizados apenas dentro da primitiva.  Tudo est√° bom e "correto".  (Quase sempre. Por enquanto, vamos omitir as imprecis√µes de algumas derivadas nos pixels ao longo da borda do primitivo). <br><br>  Ent√£o, tudo √© (quase) excelente na rasteriza√ß√£o com uma sele√ß√£o.  Mas o que pode dar errado quando a multisampling est√° ativada? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/acc/eee/dc2/acceeedc234b34993f3e284dd6a2dd81.png" alt="imagem"></div><br>  <i>Essa √© uma rasteriza√ß√£o cl√°ssica de v√°rias amostras.</i>  <i>Quadrados cinza indicam pixels.</i>  <i>Pontos amarelos s√£o centros de pixel em coordenadas meio inteiras.</i>  <i>Nos pontos azuis, a amostragem ocorre.</i>  <i>Este exemplo mostra um diagrama simples de duas amostras rotacionadas.</i>  <i>Todos os argumentos podem ser generalizados para um n√∫mero arbitr√°rio de amostras.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f10/7f0/1bb/f107f01bb4df32a980543cb70e6b8e5c.png" alt="imagem"></div><br>  <i>A linha ainda separa o meio espa√ßo do primitivo.</i>  <i>Acima e √† esquerda, o valor do myMixer √© positivo.</i>  <i>Mais baixo e √† direita - negativo.</i> <br><br>  Ao rasterizar com multisampling, o classificador de pixels gerar√° um fragmento se <i>pelo menos uma</i> amostra de pixel cair dentro do primitivo. <br><br>  Neste exemplo, 10 fragmentos ser√£o gerados, mostrados no semiplano superior esquerdo.  Observe os quatro fragmentos adicionados ao longo da face, nos quais uma amostra cai dentro do primitivo, embora o centro esteja fora.  Os pixels fora do primitivo ainda est√£o marcados como escuros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f3e/842/b67/f3e842b67809ec9efe1c8e0ff837ee7c.png" alt="imagem"></div><br>  <i>O que acontecer√° ao calcular no centro do pixel?</i> <br><br>  O sombreador ser√° calculado em pontos verdes <i>e</i> vermelhos para cada um dos fragmentos.  Os dados associados ao myMixer s√£o calculados no centro de cada pixel.  Em pontos verdes, esses valores ser√£o positivos, pois est√£o acima e √† esquerda da borda.  Os pontos vermelhos est√£o fora do primitivo, porque os valores do myMixer neles s√£o negativos.  Nos pontos vermelhos, os dados associados s√£o extrapolados em vez de interpola√ß√£o. <br><br>  No nosso sombreador, os valores sqrt (myMixer) n√£o s√£o definidos com um myMixer negativo.  Mesmo quando os valores do myMixer registrados pelo shader de v√©rtice est√£o no intervalo de zero a um, no shader de fragmento, o myMixer pode ir al√©m desse intervalo devido √† extrapola√ß√£o.  Assim, com um myMixer negativo, o resultado do shader do fragmento n√£o √© definido. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8f4/31d/854/8f431d8540787d70ae2fb27aede04f9f.png" alt="imagem"></div><br>  <i>Ainda estamos considerando calcular o sombreador no centro dos pixels, as setas na figura mostram dFdx e dFdy.</i>  <i>Nos fragmentos internos do pol√≠gono, eles s√£o bem definidos, pois todos os c√°lculos s√£o feitos no centro dos pixels, localizados em intervalos iguais.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e02/f36/8fa/e02f368fae459f51896de647a98f23ab.png" alt="imagem"></div><br>  <i>O que acontecer√° ao calcular em outros pontos que n√£o os centros dos pixels?</i> <br><br>  Os pontos verdes s√£o os pontos nos quais o sombreador ser√° calculado.  O valor associado do myMixer √© calculado no <u>centr√≥ide de</u> cada pixel. <br><br>  O centr√≥ide de um pixel √© o centro de gravidade da interse√ß√£o do quadrado do pixel e o interior do primitivo.  Para um pixel totalmente coberto, o centr√≥ide √© o centro.  Para um pixel parcialmente coberto, o centr√≥ide geralmente √© diferente do centro. <br><br>  O padr√£o OpenGL permite que uma implementa√ß√£o selecione um ponto arbitr√°rio na interse√ß√£o de um primitivo e um pixel em vez de um centr√≥ide ideal.  Por exemplo, poderia ser um ponto de amostragem. <br><br>  Neste exemplo, se o centro estiver dentro da primitiva, os dados do v√©rtice ser√£o calculados para o centro.  Caso contr√°rio, eles s√£o computados em qualquer um dos pontos de amostra localizados dentro do primitivo.  Isso acontece por quatro pixels ao longo da borda.  Todos os pontos verdes ficam acima e √† esquerda da borda, portanto os valores neles s√£o sempre interpolados e nunca extrapolados. <br><br>  Por que nem sempre calcular o sombreador centr√≥ide?  Em geral, √© mais caro que a computa√ß√£o no centro.  No entanto, este n√£o √© o fator principal. <br><br>  √â tudo sobre derivativos de computa√ß√£o.  Preste aten√ß√£o nas setas entre os pontos verdes.  A dist√¢ncia entre eles n√£o √© a mesma para diferentes pares de pontos.  Al√©m disso, y n√£o √© constante para dFdx e x n√£o √© constante para dFdy.  <i>Os derivados s√£o menos precisos quando calculados em centr√≥ides</i> . <br><br>  Esse √© um compromisso e, portanto, o OpenGL, come√ßando com GLSL 1.20, oferece ao desenvolvedor do shader uma escolha entre o centro e o centr√≥ide usando o qualificador do centr√≥ide: <br><br><pre> <code class="plaintext hljs">centroid in float myMixer; //  centroid  smooth //      . //  sqrt    . void main( void ) { const vec3 blue = vec3( 0.0, 0.0, 1.0 ); const vec3 yellow = vec3( 1.0, 1.0, 0.0 ); float a = sqrt( myMixer ); //    myMixer &lt; 0.0 vec3 color = mix( blue, yellow, a ); //   gl_FragColor = vec4( color, 1.0 ); }</code> </pre><br>  Quando voc√™ deve usar o centr√≥ide? <br><br><ol><li>  Quando um valor extrapolado pode levar a resultados vagos.  Preste aten√ß√£o especial √†s fun√ß√µes internas, cuja descri√ß√£o diz "o resultado n√£o √© definido se ..." </li><li>  Quando um valor extrapolado √© usado com uma fun√ß√£o muito n√£o linear ou descont√≠nua.  Isso inclui a fun√ß√£o de etapa ou c√°lculo de alargamento, especialmente quando o expoente √© grande o suficiente. </li></ol><br>  Quando voc√™ n√£o deve usar um centr√≥ide? <br><br><ol><li>  Se voc√™ precisar de derivativos exatos.  As derivadas podem ser expl√≠citas (chamada dFdx) ou impl√≠citas, por exemplo, amostras de texturas com n√≠veis mip ou com filtragem anisotr√≥pica.  Na especifica√ß√£o GLSL, os derivados nos centr√≥ides s√£o considerados t√£o inutiliz√°veis ‚Äã‚Äãque s√£o declarados indefinidos.  Nesses casos, tente escrever: <br><br><pre> <code class="plaintext hljs">centroid in float myMixer; //  ! smooth in float myCenterMixer; //     .</code> </pre><br></li><li>  Se uma grade for renderizada, na qual a maioria dos limites das primitivas √© interna e sempre bem definida.  O exemplo mais simples √© uma faixa de 100 tri√¢ngulos (TRIANGLE_STRIP), na qual apenas o primeiro e o √∫ltimo tri√¢ngulos est√£o sujeitos a extrapola√ß√£o.  O qualificador do centr√≥ide resultar√° em interpola√ß√£o nesses dois tri√¢ngulos, com o custo de perda de precis√£o e continuidade nos 98 tri√¢ngulos restantes. </li><li>  Se voc√™ souber que os artefatos podem aparecer de uma fun√ß√£o indefinida, n√£o linear ou descont√≠nua, mas na pr√°tica esses artefatos acabam sendo quase invis√≠veis.  Se o sombreador <i>n√£o</i> atacar - n√£o conserte! </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434046/">https://habr.com/ru/post/pt434046/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434034/index.html">Bons tutoriais no YouTube</a></li>
<li><a href="../pt434036/index.html">Feliz e final - as caixas de correio nos dom√≠nios do portal Qip.ru foram movidas para o Yandex</a></li>
<li><a href="../pt434038/index.html">Vendas de ve√≠culos el√©tricos plug-in na China para novembro de 2018</a></li>
<li><a href="../pt434040/index.html">Resumo da ITMO University: fale sobre projetos universit√°rios, sucessos e realiza√ß√µes de nossos graduados</a></li>
<li><a href="../pt434044/index.html">Autentica√ß√£o de dois fatores (2FA) resistente a phishing</a></li>
<li><a href="../pt434048/index.html">Facebook desenvolve criptomoeda para WhatsApp</a></li>
<li><a href="../pt434050/index.html">Java Enterprise vs Android em 2019 - o que escolher para um iniciante?</a></li>
<li><a href="../pt434052/index.html">Confer√™ncia CHAP√âU PRETO. Como fazer um telefone espi√£o. Parte 1</a></li>
<li><a href="../pt434054/index.html">Confer√™ncia CHAP√âU PRETO. Como fazer um telefone espi√£o. Parte 2</a></li>
<li><a href="../pt434056/index.html">Voc√™ precisa saber onde colocar o zero</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>