<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìπ üë®üèº ü§±üèª Documenta√ß√£o haproxy de hist√≥rico errante ou o que procurar ao configur√°-lo üí© üë©üèø‚Äçüíª ü§ú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° novamente! 

 Na √∫ltima vez, conversamos sobre a escolha de uma ferramenta no Ostrovok.ru para solucionar o problema de proxy de um grande n√∫mero ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Documenta√ß√£o haproxy de hist√≥rico errante ou o que procurar ao configur√°-lo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/438966/">  Ol√° novamente! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Na √∫ltima vez,</a> conversamos sobre a escolha de uma ferramenta no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ostrovok.ru</a> para solucionar o problema de proxy de um grande n√∫mero de solicita√ß√µes para servi√ßos externos, sem colocar ningu√©m ao mesmo tempo.  O artigo terminou com uma sele√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Haproxy</a> .  Hoje vou compartilhar as nuances que tive que enfrentar ao usar esta solu√ß√£o. <br><br><img src="https://habrastorage.org/webt/ns/mz/sb/nsmzsbtu2c1rgib_avecisgyrlk.jpeg"><br><a name="habracut"></a><br><h3>  Configura√ß√£o Haproxy </h3><br>  A primeira dificuldade foi que a op√ß√£o <code>maxconn</code> √© diferente dependendo do contexto: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">maxconn (ajuste de desempenho);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">maxconn (op√ß√µes de liga√ß√£o);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">maxconn (op√ß√µes de servidor e servidor padr√£o).</a> </li></ul><br>  Por h√°bito, ajustei apenas a primeira op√ß√£o ( <code>performance tuning</code> ).  Aqui est√° o que a documenta√ß√£o diz sobre esta op√ß√£o: <br><blockquote>  Define o n√∫mero m√°ximo por processo de conex√µes simult√¢neas como &lt;n√∫mero&gt;.  Isso <br>  √© equivalente ao argumento da linha de comandos "-n".  Proxies deixar√£o de aceitar <br>  conex√µes quando esse limite √© atingido. <br></blockquote><br>  Parece que o que √© necess√°rio.  No entanto, quando me deparei com o fato de que novas conex√µes com o proxy n√£o foram imediatamente, comecei a ler a documenta√ß√£o com mais cuidado e j√° encontrei o segundo par√¢metro ( <code>bind options</code> ): <br><blockquote>  Limita os soquetes a esse n√∫mero de conex√µes simult√¢neas.  Estranho <br>  conex√µes permanecer√£o na lista de pend√™ncias do sistema at√© que uma conex√£o seja <br>  lan√ßado.  Se n√£o especificado, o limite ser√° o mesmo que o maxconn do frontend. <br></blockquote><br>  Ent√£o, <code>frontends maxconn</code> l√°, procure <code>frontends maxconn</code> : <br><blockquote>  Corrija o n√∫mero m√°ximo de conex√µes simult√¢neas em um frontend <br>  ... <br>  Por padr√£o, esse valor √© definido como 2000. <br></blockquote><br>  √ìtimo, o que voc√™ precisa.  Adicione √† configura√ß√£o: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 ... defaults mode http maxconn 524288</code> </pre><br>  A pr√≥xima piada foi que o Haproxy √© de rosca √∫nica.  Estou muito acostumado com o modelo no Nginx, ent√£o essa nuance sempre me deprimiu.  Mas n√£o se desespere - <i>Willy Tarreau</i> ( <i>desenvolvedor do Haproxy</i> ) entendeu o que estava fazendo, ent√£o acrescentou a op√ß√£o - <code>nbproc</code> . <br><br>  No entanto, diretamente na documenta√ß√£o, diz: <br><blockquote>  USANDO V√ÅRIOS PROCESSOS <br>  √â MAIS DIF√çCIL DE DEBUGAR E √â REALMENTE DESCOBERTA. <br></blockquote>  Esta op√ß√£o pode realmente causar dor de cabe√ßa nos casos, se voc√™ precisar: <br><br><ul><li>  limitar o n√∫mero de solicita√ß√µes / conex√µes com servidores (j√° que voc√™ j√° n√£o ter√° um processo com um contador, mas muitos processos e cada um ter√° seu pr√≥prio contador); </li><li>  Coletar estat√≠sticas do soquete de gerenciamento Haproxy </li><li>  ativar / desativar back-end atrav√©s do soquete de controle; </li><li>  ... talvez outra coisa.  ¬Ø \ _ („ÉÑ) _ / ¬Ø </li></ul><br>  No entanto, os deuses nos deram processadores com v√°rios n√∫cleos, ent√£o eu gostaria de us√°-los ao m√°ximo.  No meu caso, havia quatro n√∫cleos em dois n√∫cleos f√≠sicos.  Para o Haproxy, selecionei o primeiro n√∫cleo, e ficou assim: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">nbproc</span></span> 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3</code> </pre><br>  Usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cpu-map,</a> vinculamos os processos Haproxy a um n√∫cleo espec√≠fico.  O agendador do SO n√£o precisa mais pensar em onde planejar o Haproxy, mantendo assim a <code>content switch</code> fria e o cache da CPU quente. <br><br><h4>  Existem muitos buffers, mas n√£o no nosso caso </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tune.bufsize</a> - no nosso caso, n√£o era necess√°rio execut√°-lo, mas se voc√™ tiver erros com o c√≥digo <code>400 (Bad Request)</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">incorreta</a> <code>400 (Bad Request)</code> , provavelmente esse √© o seu caso. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiSXUFWACR07k5LHE11WCcDdhaAfQ#tune.">tune.http.cookielen</a> - se voc√™ distribuir cookies grandes para os usu√°rios, para evitar danos durante a transmiss√£o pela rede, pode fazer sentido aumentar esse buffer tamb√©m. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiSXUFWACR07k5LHE11WCcDdhaAfQ#tune.">tune.http.maxhdr</a> √© outra fonte poss√≠vel de 400 c√≥digos de resposta se voc√™ tiver muitos cabe√ßalhos. </li></ul><br><h4>  Agora considere as coisas de n√≠vel mais baixo </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tune.rcvbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tune.rcvbuf.server</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tune.sndbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tune.sndbuf.server</a> - a documenta√ß√£o diz o seguinte: <br><blockquote>  Normalmente, nunca deve ser definido, e o tamanho padr√£o (0) permite que o kernel ajuste automaticamente esse valor, dependendo da quantidade de mem√≥ria dispon√≠vel. <br></blockquote><br>  Mas, para mim, o √≥bvio √© melhor que o impl√≠cito, ent√£o forcei os valores dessas op√ß√µes a ter certeza de amanh√£. <br><br>  E outro par√¢metro que n√£o est√° relacionado aos buffers, mas muito importante √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tune.maxaccept</a> . <br><blockquote>  Define o n√∫mero m√°ximo de conex√µes consecutivas que um processo pode aceitar em um <br>  linha antes de mudar para outro trabalho.  No modo de processo √∫nico, n√∫meros mais altos <br>  oferece melhor desempenho com altas taxas de conex√£o.  No entanto, em processos m√∫ltiplos <br>  manter um pouco de justi√ßa entre os processos geralmente √© melhor <br>  aumentar o desempenho. <br></blockquote><br>  No nosso caso, muitas solicita√ß√µes de proxy s√£o geradas, ent√£o eu criei esse valor para aceitar mais solicita√ß√µes por vez.  No entanto, como diz a documenta√ß√£o, vale a pena testar se, no modo multithread, a carga √© distribu√≠da da maneira mais uniforme poss√≠vel entre os processos. <br><br>  Todos os par√¢metros juntos: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">tune</span></span>.bufsize 16384 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432</code> </pre><br><h4>  O que nunca acontece s√£o tempos limite.  O que far√≠amos sem eles? </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">timeout connect</a> - tempo para estabelecer uma conex√£o com o back-end.  Se a conex√£o com o back-end n√£o for muito boa, √© melhor desativ√°-la com esse tempo limite at√© que a rede volte ao normal. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">timeout client</a> - timeout para a transmiss√£o dos primeiros bytes de dados.  Ajuda a desconectar aqueles que fazem solicita√ß√µes "reservadas". </li></ul><br><div class="spoiler">  <b class="spoiler_title">Kulstory sobre o cliente HTTP no Go</b> <div class="spoiler_text">  O Go possui um cliente HTTP comum que pode manter um conjunto de conex√µes com servidores.  Ent√£o, aconteceu uma hist√≥ria interessante, na qual o tempo limite e o conjunto de conex√µes descritos acima no cliente HTTP participaram.  Uma vez que um desenvolvedor reclamou que ele periodicamente tem 408 erros de um proxy.  Examinamos o c√≥digo do cliente e vimos a seguinte l√≥gica: <br><br><ul><li>  Estamos tentando obter uma conex√£o estabelecida gratuita da piscina; </li><li>  se n√£o der certo, inicie a instala√ß√£o de uma nova conex√£o na goroutine; </li><li>  verifique a piscina novamente; </li><li>  se houver de gra√ßa na piscina - n√≥s a pegamos e colocamos a nova na piscina, se n√£o - use a nova. </li></ul><br>  J√° entendeu o que √© o sal? <br><br>  Se o cliente estabeleceu uma nova conex√£o, mas n√£o a usou, depois de cinco segundos o servidor a fecha e o caso termina.  O cliente captura isso apenas quando j√° obt√©m a conex√£o do pool e tenta us√°-la.  Vale a pena ter isso em mente. <br></div></div><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servidor de tempo limite</a> - o tempo m√°ximo para aguardar uma resposta do servidor. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">timeout client-fin</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">timeout server-fin</a> - aqui nos protegemos de conex√µes semi-fechadas para n√£o acumul√°-las na tabela do sistema operacional. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiSXUFWACR07k5LHE11WCcDdhaAfQ#timeout%20">timeout http-request</a> √© um dos tempos limite mais adequados.  Permite cortar clientes lentos que n√£o podem fazer uma solicita√ß√£o HTTP no tempo alocado para eles. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiSXUFWACR07k5LHE11WCcDdhaAfQ#timeout%20">tempo limite http-keep-alive</a> - especificamente no nosso caso, se uma conex√£o <code>keep-alive</code> travar sem solicita√ß√µes por mais de 50 segundos, provavelmente algo deu errado e a conex√£o pode ser fechada, liberando mem√≥ria para algo novo luz. </li></ul><br>  Todos os tempos limite juntos: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">defaults</span></span> mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s</code> </pre><br><h4>  Registo  Por que isso √© t√£o dif√≠cil? </h4><br>  Como escrevi anteriormente, na maioria das vezes nas minhas decis√µes uso o Nginx, portanto, sou estragado por sua sintaxe e pela simplicidade de modificar os formatos de log.  Eu gostei especialmente dos registros matadores de formato de recurso na forma de json e depois analis√°-los com qualquer biblioteca padr√£o. <br><br>  O que temos no Haproxy?  Existe uma oportunidade, apenas voc√™ pode escrever exclusivamente no syslog e a sintaxe da configura√ß√£o √© um pouco mais encapsulada. <br>  Vou dar um exemplo de configura√ß√£o com coment√°rios: <br><br><pre> <code class="apache hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,     ,    (   # error.log  nginx) log 127.0.0.1:2514 len 8192 local1 notice emerg #    -  access.log log 127.0.0.1:2514 len 8192 local7 info</span></span></code> </pre><br>  Dor particular √© causada por esses momentos: <br><ul><li>  nomes curtos de vari√°veis ‚Äã‚Äãe, especialmente, suas combina√ß√µes como% HU ou% fp </li><li>  o formato n√£o pode ser dividido em v√°rias linhas; portanto, voc√™ deve escrever um cal√ßado em uma linha.  dif√≠cil adicionar / remover itens novos / desnecess√°rios </li><li>  para que algumas vari√°veis ‚Äã‚Äãfuncionem, elas devem ser declaradas explicitamente atrav√©s do cabe√ßalho da solicita√ß√£o de captura </li></ul><br>  Como resultado, para obter algo interessante, voc√™ precisa ter apenas um cal√ßado assim: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">log</span></span>-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}'</code> </pre><br><h4>  Bem, ao que parece, pequenas coisas, mas bom </h4><br>  Descrevi o formato do log acima, mas n√£o t√£o simples.  Para depositar alguns elementos nele, como: <br><br><ul><li>  http_host </li><li>  http_referer, </li><li>  http_user_agent, </li></ul><br>  primeiro, voc√™ precisa capturar esses dados da solicita√ß√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">captura</a> ) e coloc√°-los em uma matriz de valores capturados. <br><br>  Aqui est√° um exemplo: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128</code> </pre><br>  Como resultado, agora podemos acessar os elementos que precisamos desta maneira: <br>  <code>%[capture.req.hdr(N)]</code> , em que N √© o n√∫mero de sequ√™ncia da defini√ß√£o do grupo de captura. <br>  No exemplo acima, o cabe√ßalho Host estar√° no n√∫mero 0 e o User Agent estar√° no n√∫mero 2. <br><br>  O Haproxy tem uma peculiaridade: resolve os endere√ßos DNS dos back-ends na inicializa√ß√£o e, se n√£o conseguir resolver nenhum dos endere√ßos, cai a morte dos corajosos. <br><br>  No nosso caso, isso n√£o √© muito conveniente, j√° que existem muitos back-ends, n√£o os gerenciamos e √© melhor obter o 503 do Haproxy do que todo o servidor proxy se recusar√° a iniciar por causa de um provedor.  A op√ß√£o a seguir nos ajuda com isso: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">init-addr</a> . <br><br>  Uma linha retirada diretamente da documenta√ß√£o nos permite passar por todos os m√©todos dispon√≠veis para resolver um endere√ßo e, no caso de um arquivo, adiar esse assunto para mais tarde e seguir em frente: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">default</span></span>-server init-addr last,libc,none</code> </pre> <br>  E, finalmente, o meu favorito: sele√ß√£o de back-end. <br>  A sintaxe da configura√ß√£o de sele√ß√£o de back-end do Haproxy √© familiar a todos: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">use_backend</span></span> &lt;backend1_name&gt; if &lt;condition1&gt; use_backend &lt;backend2_name&gt; if &lt;condition2&gt; default-backend &lt;backend3&gt;</code> </pre><br>  Mas, palavra certa, de alguma forma n√£o √© muito.  J√° descrevi todos os back-ends de maneira automatizada (consulte o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> ), tamb√©m seria poss√≠vel gerar <code>use_backend</code> aqui, os neg√≥cios ruins n√£o s√£o complicados, mas eu n√£o queria.  Como resultado, foi encontrada outra maneira: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 #   host_present      Host acl host_present hdr(host) -m len gt 0 #    ,     use_backend %[req.hdr(host),lower,field(1,'.')] if host_present #      ,    default_backend default backend default mode http server no_server 127.0.0.1:65535</code> </pre><br>  Assim, padronizamos os nomes de back-end e URLs pelos quais voc√™ pode acess√°-los. <br><br>  Bem, agora compilando os exemplos acima em um arquivo: <br><br><div class="spoiler">  <b class="spoiler_title">Vers√£o completa da configura√ß√£o</b> <div class="spoiler_text"><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 nbproc 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3 tune.bufsize 16384 tune.comp.maxlevel 1 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432 stats socket /run/haproxy.sock mode 600 level admin log /dev/stdout local0 debug defaults mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s default-server init-addr last,libc,none log 127.0.0.1:2514 len 8192 local1 notice emerg log 127.0.0.1:2514 len 8192 local7 info log-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}' frontend http bind *:80 http-request del-header X-Forwarded-For http-request del-header X-Forwarded-Port http-request del-header X-Forwarded-Proto capture request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 acl host_present hdr(host) -m len gt 0 use_backend %[req.hdr(host),lower,field(1,'.')] if host_present default_backend default backend default mode http server no_server 127.0.0.1:65535 resolvers dns hold valid 1s timeout retry 100ms nameserver dns1 127.0.0.1:53</code> </pre><br></div></div><br>  Obrigado a quem leu at√© o fim.  No entanto, isso n√£o √© tudo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Da pr√≥xima vez,</a> examinaremos as quest√µes de n√≠vel inferior relacionadas √† otimiza√ß√£o do pr√≥prio sistema, no qual o Haproxy funciona, para que ele e nosso sistema operacional se sintam confort√°veis ‚Äã‚Äãjuntos, e haja ferro suficiente para todos. <br><br>  At√© breve! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438966/">https://habr.com/ru/post/pt438966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438956/index.html">Magnetite nos dentes: sequenciamento de transcriptomas do tecido da radula do molusco concha</a></li>
<li><a href="../pt438958/index.html">A ILV confirmou a exist√™ncia de sua "esta√ß√£o espacial"</a></li>
<li><a href="../pt438960/index.html">Como desisti do Ruby em favor do Python enquanto trabalhava em um back-end</a></li>
<li><a href="../pt438962/index.html">Na maioria das vezes, uma perspectiva positiva para o futuro dos chips</a></li>
<li><a href="../pt438964/index.html">Quem est√° realmente por tr√°s das populares VPNs gratuitas?</a></li>
<li><a href="../pt438968/index.html">Marcando sapatos na R√∫ssia: o mercado n√£o est√° pronto, mas ter√° que funcionar</a></li>
<li><a href="../pt438970/index.html">Diz-se que Haskell √© uma linguagem para g√™nios e acad√™micos. Certo?</a></li>
<li><a href="../pt438972/index.html">O c√©rebro por dentro (visualiza√ß√£o da passagem do padr√£o atrav√©s do modelo de rede neural artificial)</a></li>
<li><a href="../pt438974/index.html">Realidade virtual ajuda a lidar com transtornos mentais</a></li>
<li><a href="../pt438976/index.html">O livro "Primavera. Todos os padr√µes de design ¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>