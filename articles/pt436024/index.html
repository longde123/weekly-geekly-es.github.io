<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëµ üë®üèæ‚ÄçüöÄ üçÉ Como n√£o jogar lixo em Java üßëüèø üôç üï¥üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° um equ√≠voco popular de que se voc√™ n√£o gostar da coleta de lixo, precisar√° escrever n√£o em Java, mas em C / C ++. Nos √∫ltimos tr√™s anos, escrevi c√≥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como n√£o jogar lixo em Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436024/"><p> H√° um equ√≠voco popular de que se voc√™ n√£o gostar da coleta de lixo, precisar√° escrever n√£o em Java, mas em C / C ++.  Nos √∫ltimos tr√™s anos, escrevi c√≥digo Java de baixa lat√™ncia para negocia√ß√£o de moedas e tive que evitar a cria√ß√£o de objetos desnecess√°rios de todas as formas.  Como resultado, eu formulei algumas regras simples para mim, como reduzir aloca√ß√µes em Java, se n√£o para zero, e depois para um m√≠nimo razo√°vel, sem recorrer ao gerenciamento manual de mem√≥ria.  Talvez tamb√©m seja √∫til para algu√©m da comunidade. </p><a name="habracut"></a><br><h2>  Por que evitar o lixo </h2><br><p>  Sobre o que √© o GC e como configur√°-lo, foi dito e escrito muito.  Mas, em √∫ltima an√°lise, n√£o importa como voc√™ configure o GC, o c√≥digo dessa maca funcionar√° abaixo do ideal.  Sempre h√° uma troca entre taxa de transfer√™ncia e lat√™ncia.  Torna-se imposs√≠vel melhorar um sem piorar o outro.  Como regra geral, a sobrecarga do GC √© medida estudando os logs - voc√™ pode entender deles em que momentos houve pausas e quanto tempo levaram.  No entanto, os logs do GC n√£o cont√™m todas as informa√ß√µes sobre essa sobrecarga.  O objeto criado pelo encadeamento √© automaticamente colocado no cache L1 do n√∫cleo do processador no qual o encadeamento est√° sendo executado.  Isso leva √† exclus√£o de outros dados potencialmente √∫teis.  Com um grande n√∫mero de aloca√ß√µes, dados √∫teis tamb√©m podem ser enviados para fora do cache L3.  Na pr√≥xima vez em que o encadeamento acessar esses dados, o cache de erros ocorrer√°, o que levar√° a atrasos na execu√ß√£o do programa.  Al√©m disso, como o cache L3 √© comum a todos os n√∫cleos do mesmo processador, um fluxo de lixo enviar√° dados e outros threads / aplicativos a partir do cache L3, e eles j√° encontrar√£o falhas de cache extremamente caras, mesmo que sejam escritas em C simples e n√£o crie lixo.  Nenhuma configura√ß√£o, nenhum coletor de lixo (nem o C4 nem o ZGC) ajudar√° a lidar com esse problema.  A √∫nica maneira de melhorar a situa√ß√£o como um todo n√£o √© criar objetos desnecess√°rios desnecessariamente.  O Java, diferentemente do C ++, n√£o possui um rico arsenal de mecanismos para trabalhar com mem√≥ria, mas, no entanto, existem v√°rias maneiras de minimizar as aloca√ß√µes.  Eles ser√£o discutidos. </p><br><div class="spoiler">  <b class="spoiler_title">Digress√£o l√≠rica</b> <div class="spoiler_text"><p>  Obviamente, voc√™ n√£o precisa escrever todo o c√≥digo sem lixo.  A quest√£o da linguagem Java √© que voc√™ pode simplificar bastante sua vida removendo apenas as principais fontes de lixo.  Voc√™ tamb√©m n√£o pode lidar com a recupera√ß√£o de mem√≥ria segura ao escrever algoritmos sem bloqueio.  Se algum c√≥digo for executado apenas uma vez na inicializa√ß√£o do aplicativo, ele poder√° alocar o quanto voc√™ quiser e n√£o ser√° assustador.  Bem, √© claro, a principal ferramenta de trabalho para se livrar do excesso de lixo √© o perfilador de aloca√ß√£o. </p></div></div><br><h2>  Usando tipos primitivos </h2><br><p> A coisa mais simples que pode ser feita em muitos casos √© usar tipos primitivos em vez de tipos de objetos.  A JVM possui diversas otimiza√ß√µes para minimizar a sobrecarga de tipos de objetos, como armazenar em cache pequenos valores de tipos inteiros e incluir classes simples.  Mas nem sempre vale a pena confiar nessas otimiza√ß√µes, porque elas podem n√£o funcionar: um valor inteiro pode n√£o ser armazenado em cache e o inlining pode n√£o ocorrer.  Al√©m disso, ao trabalhar com um inteiro condicional, somos for√ßados a seguir o link, o que potencialmente leva a uma falha no cache.  Al√©m disso, todos os objetos t√™m cabe√ßalhos que ocupam espa√ßo extra no cache, eliminando outros dados a partir da√≠.  Vamos assumir: um int primitivo leva 4 bytes.  O <code>Integer</code> objeto ocupa 16 bytes + o tamanho do link para esse n√∫mero inteiro √© de no m√≠nimo 4 bytes (no caso de oops compactado).  No total, verifica-se que <code>Integer</code> ocupa cinco (!) Vezes mais espa√ßo que <code>int</code> .  Portanto, √© melhor usar os tipos primitivos por conta pr√≥pria.  Vou dar alguns exemplos. </p><br><h3>  Exemplo 1. C√°lculos convencionais </h3><br><p>  Digamos que temos uma fun√ß√£o regular que conta apenas algo. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">Integer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer a, Integer b, Integer c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / c; }</code> </pre> <br><p>  √â prov√°vel que esse c√≥digo fique embutido (o m√©todo e as classes) e n√£o levar√° a aloca√ß√µes desnecess√°rias, mas voc√™ n√£o pode ter certeza disso.  Mesmo se isso acontecer, haver√° um problema com o fato de uma <code>NullPointerException</code> poder sair daqui.  De uma forma ou de outra, a JVM precisar√° inserir verifica√ß√µes <code>null</code> sob o cap√¥ ou entender de alguma forma a partir do contexto que <code>null</code> n√£o pode vir como argumento.  De qualquer forma, √© melhor escrever o mesmo c√≥digo nas primitivas. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / c; }</code> </pre> <br><h3>  Exemplo 2. Lambdas </h3><br><p>  √Äs vezes, os objetos s√£o criados sem o nosso conhecimento.  Por exemplo, se passarmos tipos primitivos para onde os tipos de objetos s√£o esperados.  Isso geralmente acontece ao usar express√µes lambda. <br>  Imagine que temos este c√≥digo: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Consumer&lt;Integer&gt; calculator)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = System.currentTimeMillis(); calculator.accept(x); }</code> </pre> <br><p>  Apesar de a vari√°vel x ser uma primitiva, ser√° criado um objeto do tipo Inteiro, que ser√° passado para a calculadora.  Para evitar isso, use <code>IntConsumer</code> vez de <code>Consumer&lt;Integer&gt;</code> : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IntConsumer calculator)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = System.currentTimeMillis(); calculator.accept(x); }</code> </pre> <br><p>  Esse c√≥digo n√£o levar√° mais √† cria√ß√£o de um objeto extra.  O Java.util.function possui todo um conjunto de interfaces padr√£o adaptadas para o uso de tipos primitivos: <code>DoubleSupplier</code> , <code>LongFunction</code> , etc.  Bem, se algo estiver faltando, voc√™ sempre poder√° adicionar a interface desejada com as primitivas.  Por exemplo, em vez de <code>BiConsumer&lt;Integer, Double&gt;</code> voc√™ pode usar uma interface caseira. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntDoubleConsumer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>; }</code> </pre> <br><h3>  Exemplo 3. Cole√ß√µes </h3><br><p>  O uso de um tipo primitivo pode ser dif√≠cil porque uma vari√°vel desse tipo est√° em uma cole√ß√£o.  Suponha que tenhamos alguma <code>List&lt;Integer&gt;</code> e queremos descobrir quais n√∫meros est√£o nela e calcular quantas vezes cada um dos n√∫meros √© repetido.  Para isso, usamos o <code>HashMap&lt;Integer, Integer&gt;</code> .  O c√≥digo fica assim: </p><br><pre> <code class="java hljs">List&lt;Integer&gt; numbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-comment"><span class="hljs-comment">// fill numbers somehow Map&lt;Integer, Integer&gt; counters = new HashMap&lt;&gt;(); for (Integer x : numbers) { counters.compute(x, (k, v) -&gt; v == null ? 1 : v + 1); }</span></span></code> </pre> <br><p>  Este c√≥digo est√° incorreto de v√°rias maneiras ao mesmo tempo.  Primeiro, ele usa uma estrutura de dados intermedi√°ria, o que provavelmente poderia ser feito sem.  Bem, ok, para simplificar, assumimos que essa lista ser√° necess√°ria mais tarde, ou seja,  voc√™ n√£o pode remov√™-lo completamente.  Em segundo lugar, o objeto <code>Integer</code> usado nos dois lugares, em vez do primitivo <code>int</code> .  Em terceiro lugar, existem muitas aloca√ß√µes no m√©todo de <code>compute</code> .  Quarto, um iterador √© alocado.  √â prov√°vel que essa aloca√ß√£o se torne inline, mas mesmo assim.  Como transformar esse c√≥digo em c√≥digo sem lixo?  Voc√™ s√≥ precisa usar a cole√ß√£o nas primitivas de alguma biblioteca de terceiros.  H√° v√°rias bibliotecas que cont√™m essas cole√ß√µes.  O seguinte peda√ßo de c√≥digo usa a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">agrona</a> . </p><br><pre> <code class="java hljs">IntArrayList numbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntArrayList(); <span class="hljs-comment"><span class="hljs-comment">// fill numbers somehow Int2IntCounterMap counters = new Int2IntCounterMap(0); for (int i = 0; i &lt; numbers.size(); i++) { counters.incrementAndGet(numbers.getInt(i)); }</span></span></code> </pre> <br><p>  Os objetos que s√£o criados aqui s√£o duas cole√ß√µes e dois <code>int[]</code> , localizados dentro dessas cole√ß√µes.  Ambas as cole√ß√µes podem ser reutilizadas chamando o m√©todo <code>clear()</code> nelas.  Usando cole√ß√µes em primitivas, n√£o complicamos nosso c√≥digo (e at√© o simplificamos removendo o m√©todo de computa√ß√£o com um lambda complexo dentro dele) e recebemos os seguintes b√¥nus adicionais em compara√ß√£o ao uso de cole√ß√µes padr√£o: </p><br><ol><li>  Aus√™ncia quase completa de aloca√ß√µes.  Se as cole√ß√µes forem reutilizadas, n√£o haver√° aloca√ß√µes. </li><li>  Economia significativa de mem√≥ria (o <code>IntArrayList</code> ocupa cerca de cinco vezes menos espa√ßo que o <code>ArrayList&lt;Integer&gt;</code> . Como j√° mencionado, nos preocupamos com o uso econ√¥mico de caches de processador, n√£o de RAM. </li><li>  Acesso serial √† mem√≥ria.  Muito j√° foi escrito sobre o assunto por que isso √© importante, ent√£o n√£o vou parar por a√≠.  Aqui est√£o alguns artigos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Martin Thompson</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ulrich Drepper</a> . </li></ol><br><p>  Outro pequeno coment√°rio sobre cole√ß√µes.  Pode ser que a cole√ß√£o contenha valores de tipos diferentes e, portanto, n√£o √© poss√≠vel substitu√≠-la por uma cole√ß√£o por primitivas.  Na minha opini√£o, isso √© um sinal de projeto inadequado da estrutura de dados ou do algoritmo como um todo.  Provavelmente, nesse caso, a aloca√ß√£o de objetos extras n√£o √© o principal problema. </p><br><h2>  Objetos mut√°veis </h2><br><p>  Mas e se os primitivos n√£o puderem ser dispensados?  Por exemplo, no caso em que o m√©todo que precisamos deve retornar v√°rios valores.  A resposta √© simples - use objetos mut√°veis. </p><br><div class="spoiler">  <b class="spoiler_title">Pequena digress√£o</b> <div class="spoiler_text"><p>  Algumas l√≠nguas enfatizam o uso de objetos imut√°veis, por exemplo, no Scala.  O principal argumento a seu favor √© que escrever c√≥digo multithread √© bastante simplificado.  No entanto, tamb√©m existem despesas gerais associadas √† aloca√ß√£o excessiva de lixo.  Se queremos evit√°-los, n√£o devemos criar objetos imut√°veis ‚Äã‚Äãde vida curta. </p></div></div><br><p>  Como √© na pr√°tica?  Suponha que precisamos calcular o quociente e o restante da divis√£o.  E para isso, usamos o seguinte c√≥digo. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntPair</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; } <span class="hljs-function"><span class="hljs-function">IntPair </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor)</span></span></span><span class="hljs-function"> </span></span>{ IntPair result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPair(); result.x = value / divisor; result.y = value % divisor; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  Como algu√©m pode se livrar da aloca√ß√£o neste caso?  √â isso mesmo, passe o <code>IntPair</code> como argumento e escreva o resultado l√°.  Nesse caso, voc√™ precisa escrever um javadoc detalhado e, melhor ainda, usar algum tipo de conven√ß√£o para nomes de vari√°veis, onde o resultado √© gravado.  Por exemplo, eles podem come√ßar com o prefixo out.  O c√≥digo sem lixo nesse caso ter√° a seguinte apar√™ncia: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor, IntPair outResult)</span></span></span><span class="hljs-function"> </span></span>{ outResult.x = value / divisor; outResult.y = value % divisor; }</code> </pre> <br><p>  Quero observar que o m√©todo de <code>divide</code> n√£o deve salvar um link para parear em qualquer lugar ou pass√°-lo a m√©todos que possam fazer isso; caso contr√°rio, podemos ter grandes problemas.  Como podemos ver, objetos mut√°veis ‚Äã‚Äãs√£o mais dif√≠ceis de usar do que tipos primitivos; portanto, se voc√™ pode usar primitivas, √© melhor faz√™-lo.  De fato, em nosso exemplo, transferimos o problema de alocar de dentro do m√©todo de divis√£o para o exterior.  Em todos os lugares em que chamamos esse m√©todo, precisaremos ter algum manequim <code>IntPair</code> , que passaremos para <code>divide</code> .  Frequentemente, o suficiente para armazenar esse manequim no campo <code>final</code> do objeto, de onde chamamos o m√©todo de <code>divide</code> .  Deixe-me dar um exemplo improv√°vel: suponha que nosso programa lida apenas com o recebimento de um fluxo de n√∫meros pela rede, os divide e envia o resultado para o mesmo soquete. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SocketListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IntPair pair = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPair(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BufferedReader in; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PrintWriter out; SocketListener(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Socket socket) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> IOException { in = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(socket.getInputStream())); out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter(socket.getOutputStream(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listenSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> divisor = in.read(); divide(value, divisor, pair); out.print(pair.x); out.print(pair.y); } } }</code> </pre> <br><p>  Por uma quest√£o de brevidade, n√£o escrevi c√≥digo ‚Äúextra‚Äù para tratamento de erros, encerramento correto do programa etc.  A id√©ia principal desse trecho de c√≥digo √© que o objeto <code>IntPair</code> que <code>IntPair</code> seja criado uma vez e armazenado no campo <code>final</code> . </p><br><h2>  Conjuntos de objetos </h2><br><p>  Quando usamos objetos mut√°veis, primeiro precisamos pegar um objeto vazio de algum lugar, depois gravar os dados que precisamos nele, us√°-lo em algum lugar e depois retornar o objeto "no lugar".  No exemplo acima, o objeto estava sempre "no lugar", ou seja,  no campo <code>final</code> .  Infelizmente, isso nem sempre √© poss√≠vel de forma simples.  Por exemplo, podemos n√£o saber com anteced√™ncia exatamente quantos objetos precisamos.  Nesse caso, os pools de objetos v√™m em nosso aux√≠lio.  Quando precisamos de um objeto vazio, o obtemos do pool de objetos e, quando deixa de ser necess√°rio, retornamos para ele.  Se n√£o houver objeto livre no pool, ele cria um novo objeto.  Na verdade, trata-se de um gerenciamento manual de mem√≥ria com todas as conseq√º√™ncias resultantes.  √â aconselh√°vel n√£o recorrer a esse m√©todo se for poss√≠vel usar os m√©todos anteriores.  O que poderia dar errado? </p><br><ul><li>  Podemos esquecer de retornar o objeto ao pool e, em seguida, o lixo ("vazamento de mem√≥ria") ser√° criado.  Esse √© um pequeno problema - o desempenho diminuir√° levemente, mas o GC funcionar√° e o programa continuar√° funcionando. </li><li>  Podemos devolver o objeto ao pool, mas salvar o link em algum lugar.  Depois, algu√©m obter√° o objeto do pool e, neste ponto do nosso programa, j√° haver√° dois links para o mesmo objeto.  Esse √© um problema cl√°ssico de uso ap√≥s livre.  √â dif√≠cil estrear porque  ao contr√°rio do C ++, o programa n√£o falha e continua <em>a</em> funcionar <em>incorretamente</em> . </li></ul><br><p>  Para reduzir a probabilidade de cometer os erros acima, voc√™ pode usar a constru√ß√£o padr√£o try-with-resources.  Pode ser assim: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Storage</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T object)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntPair</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutoCloseable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Storage&lt;IntPair&gt; STORAGE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageImpl(IntPair::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntPair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPair </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> STORAGE.get(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ STORAGE.dispose(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre> <br><p>  O m√©todo de divis√£o pode ficar assim: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">IntPair </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor)</span></span></span><span class="hljs-function"> </span></span>{ IntPair result = IntPair.create(); result.x = value / divisor; result.y = value % divisor; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  E o m√©todo <code>listenSocket</code> assim: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listenSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> divisor = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (IntPair pair = divide(value, divisor)) { out.print(pair.x); out.print(pair.y); } } }</code> </pre> <br><p>  No IDE, geralmente voc√™ pode configurar o destaque de todos os casos quando objetos <code>AutoCloseable</code> s√£o usados ‚Äã‚Äãfora do bloco try-with-resources.  Mas essa n√£o √© uma op√ß√£o absoluta, porque  o destaque no IDE pode ser desativado.  Portanto, existe outra maneira de garantir o retorno do objeto √† piscina - invers√£o de controle.  Vou dar um exemplo: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntPair</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutoCloseable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Storage&lt;IntPair&gt; STORAGE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageImpl(IntPair::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntPair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Consumer&lt;IntPair&gt; consumer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>(IntPair pair = STORAGE.get()) { consumer.accept(pair); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ STORAGE.dispose(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre> <br><p>  Nesse caso, basicamente n√£o podemos acessar o objeto da classe <code>IntPair</code> fora.  Infelizmente, esse m√©todo tamb√©m nem sempre funciona.  Por exemplo, ele n√£o funcionar√° se um thread obtiver objetos do pool e coloc√°-los em uma fila, e outro thread os remover√° da fila e retornar√° ao pool. </p><br><p>  Obviamente, se n√£o armazenarmos objetos gen√©ricos no pool, mas alguns objetos de biblioteca que n√£o implementam o <code>AutoCloseable</code> , a op√ß√£o try-with-resources tamb√©m n√£o funcionar√°. </p><br><p>  Um problema adicional aqui √© multithreading.  A implementa√ß√£o do pool de objetos deve ser muito r√°pida, o que √© bastante dif√≠cil de alcan√ßar.  Um pool lento pode causar mais danos ao desempenho do que benef√≠cios.  Por sua vez, a aloca√ß√£o de novos objetos no TLAB √© muito r√°pida, muito mais r√°pida que o malloc no C. Escrever um pool de objetos r√°pido √© um t√≥pico separado que eu n√£o gostaria de desenvolver agora.  S√≥ posso dizer que n√£o vi boas implementa√ß√µes "prontas". </p><br><h2>  Em vez de uma conclus√£o </h2><br><p>  Em resumo, a reutiliza√ß√£o de objetos com pools de objetos √© uma hemorr√≥ida grave.  Felizmente, quase sempre voc√™ pode ficar sem ele.  Minha experi√™ncia pessoal √© que o uso excessivo de pools de objetos sinaliza problemas com a arquitetura do aplicativo.  Como regra, uma inst√¢ncia do objeto armazenado em cache no campo <code>final</code> √© suficiente para n√≥s.  Mas mesmo isso √© exagero se for poss√≠vel usar tipos primitivos. </p><br><h2>  Atualiza√ß√£o: </h2><br><p>  Sim, lembrei-me de outra maneira para aqueles que n√£o t√™m medo de mudan√ßas bit a bit: agrupar v√°rios pequenos tipos primitivos em um grande.  Suponha que precisamos retornar duas <code>int</code> .  Nesse caso espec√≠fico, voc√™ n√£o pode usar o objeto <code>IntPair</code> , mas retornar um <code>long</code> , os primeiros 4 bytes nos quais corresponder√° ao primeiro <code>int</code> 'y, e os segundos 4 bytes ao segundo.  O c√≥digo pode ficar assim: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">combine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> right)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)left &lt;&lt; Integer.SIZE) | (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)right &amp; <span class="hljs-number"><span class="hljs-number">0xFFFFFFFFL</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(value &gt;&gt;&gt; Integer.SIZE); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = value / divisor; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = value % divisor; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> combine(left, right); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listenSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> divisor = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> xy = divide(value, divisor); out.print(getLeft(xy)); out.print(getRight(xy)); } }</code> </pre> <br><p>  √â claro que esses m√©todos precisam ser testados minuciosamente, porque √© muito f√°cil anot√°-los.  Mas ent√£o apenas use-o. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt436024/">https://habr.com/ru/post/pt436024/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt436012/index.html">Eu sou um idiota in√∫til, ent√£o quero sair do meu emprego: 10 perguntas para um desenvolvedor de software, um epis√≥dio piloto</a></li>
<li><a href="../pt436014/index.html">Modelos Matem√°ticos do Caos</a></li>
<li><a href="../pt436016/index.html">IVR de reconhecimento de voz do Asterisk - r√°pido, f√°cil e gratuito</a></li>
<li><a href="../pt436020/index.html">Magento 2: importando produtos de fontes externas</a></li>
<li><a href="../pt436022/index.html">Como desenvolvemos completamente o Librem 5 DevKit em software livre</a></li>
<li><a href="../pt436026/index.html">Info Desk: ‚ÄúInternet Archive‚Äù - hist√≥ria, miss√£o e projetos subsidi√°rios</a></li>
<li><a href="../pt436028/index.html">Uma introdu√ß√£o ao Kubernetes para usu√°rios do VMware. Parte 1. Teoria</a></li>
<li><a href="../pt436032/index.html">Tutorial Reagir Parte 9: Propriedades do componente</a></li>
<li><a href="../pt436036/index.html">Os pesquisadores de intelig√™ncia artificial podem confiar a ele um teste de seu trabalho?</a></li>
<li><a href="../pt436038/index.html">O som do sil√™ncio: quantos gadgets malucos s√£o necess√°rios para alcan√ßar um ambiente ideal para dormir?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>