<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÇ üèñÔ∏è üëΩ Google App Script, Mikrotik, Telegram und VPNBook haben begonnen, ein Quartett zu spielen üõ†Ô∏è üî¨ üö©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Heute im Programm: Wo sonst k√∂nnen Sie Google Apps Script anwenden, wenn die normalen Ideen vorbei sind. Automatisierung der Arbeit mit VPNBook durch ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Google App Script, Mikrotik, Telegram und VPNBook haben begonnen, ein Quartett zu spielen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475856/">  Heute im Programm: Wo sonst k√∂nnen Sie Google Apps Script anwenden, wenn die normalen Ideen vorbei sind.  Automatisierung der Arbeit mit VPNBook durch eine Reihe von Skripten in verschiedenen Sprachen, die ich nicht kenne.  Nedo-cURL von Mikrotik.  Telegramm durch einen Ort, um nicht in einem anderen zu sein, erlaubt Selbst√ºberwachung. <br><a name="habracut"></a><br><h3>  Teil 1. Ohne Titel </h3><br>  Vor einem Jahr schrieb ich einen Hinweis ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fast OCR, um ein VPNBook-Passwort zu erhalten. PHP + Mikrotik</a> ‚Äú dar√ºber, wie die automatische Passwortabfrage im Mikrotik-Router f√ºr den kostenlosen VPN-Zugang √ºber VPNBook eingerichtet wird.  Der Anfang der Geschichte ist da. <br><br>  Seitdem ist viel Wasser geflossen, in Russland haben sie die VPNBook-Site blockiert, aber nicht die √∂ffentlichen VPN-Server selbst, die darauf ver√∂ffentlicht werden.  Das PHP-Skript zum Dekodieren eines PNG-Bildes eines Kennworts in eine Textzeichenfolge sollte jetzt auch funktionieren, wenn es auf einem Server gestartet wird, dessen Datenverkehr nicht durch das Blockierungssystem geleitet wird.  Als ich vor einiger Zeit mit dem Google Apps Script (GAS) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">-Dienst script.google.com experimentierte</a> , entschied ich mich, das PHP-Skript auf einem externen Webserver aufzugeben und es teilweise oder vollst√§ndig durch ein GAS-Skript zu ersetzen, das als Web App (Webanwendung) ausgef√ºhrt wird.  Ich habe die Ausf√ºhrungsrichtlinien und die GAS-Einschr√§nkungen nicht verstanden, aber alles, was ich getan habe, funktioniert in einem kostenlosen Google-Konto und verlangt noch kein Geld.  Ich habe nicht das Ziel, Google Apps Script detailliert zu beschreiben.  GAS basiert auf der JavaScript-Sprache, Sie k√∂nnen JS-Bibliotheken von Drittanbietern verwenden, Sie k√∂nnen das Skript als Webanwendung ver√∂ffentlichen, die jedem ohne Autorisierung zur Verf√ºgung gestellt werden kann.  Die M√∂glichkeiten der aktuellen GAS-Implementierung reichten mir nicht aus, sodass ich nach L√∂sungen suchen musste. <br><br>  Zuerst habe ich beschlossen, einen Proxy f√ºr PNG-Bilder zu schreiben.  Das Web-Skript musste ein Passwort-Image von der VPNBook-Website anfordern (ich erinnere mich, dass das Passwort dort in PNG ver√∂ffentlicht wurde) und es dem Client geben, der dieses Skript zum Dekodieren aufrief.  So kommen Sie um das Schloss herum.  Hier traf die erste Einschr√§nkung von GAS ein.  Es stellt sich heraus, dass das Skript kein MIME-Bild / PNG rendern kann, sondern nur Textformate, JSON, TEXT, XML usw.  Aber es gab einen Weg, dies zu umgehen.  Sie k√∂nnen PNG in Base64 codieren und eine Textzeichenfolge an den Client zur√ºckgeben.  Es gibt √§hnliche Skripte im Internet, zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">techslides.com/image-proxy-with-google-app-scripts</a> .  Ich habe nur einen von ihnen vereinfacht.  Ich brauchte nur ein Bild und gab nur Base64-Strings aus.  Das Ergebnis ist ein Skript, das nur aus einer doGet-Funktion besteht - einem GET-Anforderungshandler, der als Antwort eine Zeichenfolge zur√ºckgibt. <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = UrlFetchApp.fetch(<span class="hljs-string"><span class="hljs-string">'https://www.vpnbook.com/password.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b64 = Utilities.base64Encode(response.getContent()); <span class="hljs-comment"><span class="hljs-comment">//var data = 'data:'+type+';base64,'+b64; return ContentService.createTextOutput(b64); }</span></span></code> </pre> <br>  Beispiel f√ºr eine Browserausgabe: <br><br><pre> <code class="plaintext hljs">iVBORw0KGgoAAAANSUhEUgAAAGQAAAANAQMAAABl11mFAAAABlBMVEX29vZMTExY89ZbAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAVUlEQVQImWNgIBrwSzCw/2ZgOADhSc5gYJCG8wxQedLdCcYFNXcgPHOZsxuSZxx7BuFZzsjdcJi34TBU5Y3cjc3IvM3McJ7kjNxtzDwwffwSIB7UTACt/h52C5DFqQAAAABJRU5ErkJggg==</code> </pre> <br>  Als n√§chstes kommt das PHP-Skript, das mit Resource Locking auf dem Server innerhalb der Zone platziert werden kann.  Es ist dem Skript aus dem vorherigen Artikel sehr √§hnlich, abgesehen von einer kleinen √Ñnderung der Parameter des cURL-Aufrufs.  Sie m√ºssen zulassen, dass cURL vor√ºbergehend √ºber HTTP / 1.1 verschoben wird, da  Wenn GAS aufgerufen wird, wird es von der Web-Skript-Adresse zu einer dynamischen tempor√§ren Adresse umgeleitet: <br><br><pre> <code class="php hljs">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Und Base64-Dekodierung: <br><br><pre> <code class="php hljs">$imgOCR = imagecreatefromstring(base64_decode($output));</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Skript selbst</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//   $wchar = 9; $hchar = 13; $strDict = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 '; $imgDict = imagecreatetruecolor(2 + strlen($strDict)* $wchar, $hchar); $bg = imagecolorallocate($imgDict, 0xF6, 0xF6, 0xF6); $textcolor = imagecolorallocate($imgDict, 0x4C, 0x4C, 0x4C); imagefill($imgDict, 0, 0, $bg); imagestring($imgDict, 5, 2, 0, $strDict, $textcolor); //  cURL $ch = curl_init(); //  url,      //curl_setopt($ch, CURLOPT_URL, 'https://www.vpnbook.com/password.php'); curl_setopt($ch, CURLOPT_URL, 'https://script.google.com/macros/s/AKfycbwYPfaZobtjbFv0mSYI8U4NIXPh1Sft_DkGH8QKgg/exec'); //  ,      string curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1); // also, this seems wise considering output is image. //   $output = curl_exec($ch); //  cURL curl_close($ch); // echo $output; $imgOCR = imagecreatefromstring(base64_decode($output)); //$imgOCR = imageCreateFromPng('password.png'); //      10  . 2 + 10*9 = 92 &lt; 100 $maxchar = floor((imagesx($imgOCR) - 2) / 9); $imgBox = imagecreatetruecolor($wchar, $hchar); $hashDict = Array(); //   for ($k = 0; $k &lt; strlen($strDict) ; $k++) { imagecopy($imgBox, $imgDict, 0, 0, 2 + $k * $wchar, 0, $wchar, $hchar); $hashStr = ""; for($y = 0; $y &lt; $hchar ; $y++) for($x = 0; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != 0xF6F6F6)? '1': '0'; $hashDict[$hashStr] = $strDict[$k]; } //     for ($k = 0; $k &lt; $maxchar ; $k++) { imagecopy($imgBox, $imgOCR, 0, 0, 2 + $k * $wchar, 0, $wchar, $hchar); $hashStr = ""; for($y = 0; $y &lt; $hchar ; $y++) for($x = 0; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != 0xF6F6F6)? '1': '0'; $tempchar = $hashDict[$hashStr]; if ($tempchar=='u' || $tempchar=='y') //    $tempchar = (mt_rand(0, 1))? 'u': 'y'; //$tempchar = (time() / 60 % 60 % 2)? 'u': 'y'; elseif ($tempchar==' ') break; print($tempchar); } /* header('Content-type: image/png'); imagepng($imgDict); */ //var_dump($hashDict); imagedestroy($imgDict); imagedestroy($imgOCR); imagedestroy($imgBox); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br></div></div><br>  Dieses PHP-Skript decodiert das PNG-Passwort und gibt es als Textzeichenfolge zur√ºck.  Weiter wie im ersten Artikel im Teil √ºber Mikrotik.  Der Router ermittelt das Passwort mit fetch. <br>  Das Ergebnis war ein solches Arbeitsschema von 2 Zwischendiensten vor Mikrotik. <br><br><h3>  Teil 2. Dr√ºcken Sie auf GAS.  Befreien Sie sich von PHP-Decoder-Skript </h3><br>  W√§hrend der Experimente mit GAS entstand die Idee, den Passwortdecoder in PHP ganz aufzugeben und in GAS umzuschreiben.  Und hier wurde ein gro√ües Problem entdeckt: Google-Skript verf√ºgt nicht √ºber PNG-Verarbeitungsfunktionen. Das einzige, was getan werden kann, ist, PNG in ein Byte-Array zu konvertieren.  Manipulationen mit Bildteilen und Pixeln waren ausgeschlossen.  Ich bin auf der Suche nach der JS-Bibliothek f√ºr die Arbeit mit PNG auf Github gestiegen und habe viele gefunden: PNG.js, UPNG.js, pngjs.  Einige unterst√ºtzen die 1-Bit-Farbtiefe eines PNG-Pixels (Bild mit Passwort) nicht.  Sie zogen verschiedene zlib-Komprimierungsbibliotheken mit.  Im Allgemeinen schien mir alles etwas umst√§ndlich zu sein, und ich beschloss, selbst einen primitiven Konverter nur f√ºr mein PNG-Bild in eine Bitmap mit der Funktion zu schreiben, auf Pixel √ºber XY-Koordinaten zuzugreifen.  Dann kam ein komplettes Eintauchen in das PNG-Format: Hex-Editor, Lesestandards, jede Menge Beschreibungen im Netzwerk.  Und schlie√ülich stie√ü ich auf den PNG-Abschnitt der IDAT-Datei, der mit zlib gepackt war und eine Reihe von Pixeln enthielt. <br><br>  Es wurde eine Funktion zum Entpacken von zlib ben√∂tigt, die nat√ºrlich nicht in GAS enthalten war.  √úberraschenderweise haben sie gzip / ungzip und zip / unzip, aber keine zlib.  Nachdem ich √ºber gzip gelesen hatte (die zweite Stufe des Eintauchens nach dem PNG-Format), kam ich zu dem Schluss, dass es nicht m√∂glich sein w√ºrde, ein ‚ÄûFahrrad‚Äú in Form eines gzip-Quasi-Archivs aus der IDAT-Sektion zusammenzustellen, obwohl hier und da ZLIB-Komprimierung verwendet wird.  Weil  Um ein g√ºltiges gzip-Archiv zu erstellen, m√ºssen Sie die L√§nge der entpackten Daten kennen, die ich nicht bekommen k√∂nnte, ohne sie zu entpacken :) Und mit der falschen L√§nge betrachtete GAS das Archiv als besch√§digt.  Am Ende habe ich mich an Github gewandt und eine gro√üartige L√∂sung gefunden: die Skriptbibliothek zlib.js f√ºr Google Apps (https://github.com/hinimub/zlib.js/blob/develop/README.en.md).  Das speziell f√ºr die Integration in GAS-Projekte durch Projektschl√ºsselbibliotheken vorbereitet wurde.  Dann begann das R√§tsel zu konvergieren.  Nach dem Schreiben der Dekomprimierung des Pixelarrays und der Funktion zum Zugreifen auf die Koordinaten des XY-Pixels konnte das Decoderskript von PHP nach GAS √ºbertragen werden. <br><br>  Separat berechnete Hash-Tabelle eines W√∂rterbuchs mit m√∂glichen Kennwortzeichen.  Dies ist eine einmalige Aktion, die ich in einem Drittanbieterprogramm durchgef√ºhrt habe (in LabVIEW, hallo, Kollegen).  Jedes Zeichen im Bild kann mit 8 Bit (ohne Einr√ºckung) x 10 Zeilen belegt werden.  Ein Byte reicht aus, um 8 Pixel einer Zeile eines Zeichens zu codieren.  Sie k√∂nnen eine Folge von Pixeln in einer ganzen Zahl (Byte) und das gesamte Zeichen als Folge von 10 Byte speichern.  Es werden 10 Hexadezimalzahlen pro Zeichen ausgegeben.  Als n√§chstes wiederholt der GAS-Decoder seinen PHP-Vorg√§nger. <br><br><div class="spoiler">  <b class="spoiler_title">Das Ergebnis ist ein Skript, das vollst√§ndig in GAS funktioniert.</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> 'A', 'FCC6C3C6FCC6C3C3C6FC': 'B', '3E63C1C0C0C0C0C1633E': 'C', 'FCC6C3C3C3C3C3C3C6FC': 'D', 'FEC0C0C0FCC0C0C0C0FE': 'E', 'FFC0C0C0FCC0C0C0C0C0': ‚ÄöF <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> '' C3C3C3C3FFC3C3C3C3C3 ':' H '' 7E18181818181818187E ':' I '' 1E666666466C38 ':' J '' C3C6CCD8F0F0D8CCC6C3 ':' K '' C0C0C0C0C0C0C0C0C0FE ':' L‚Äò, <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> 'C3E3F3F3DBDBCFC7C7C3': 'N', '3C66C3C3C3C3C3C3663C': 'O', 'FEC3C3C3FEC0C0C0C0C0': 'P', '3C66C3C3C3C3DBCF663D': 'Q', 'FEC3C3C3FEF8CCC6C3C3': 'R', ‚Äö7EC3C0C07E333C37E <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> 000B6DBDBDBDBDBDB ':' m '' 000DCE6C3C3C3C3C3 ':' n '' 0003C66C3C3C3663C ':' o '' 000DCE6C3C3C3E6DC ':' p '' 0003B67C3C3C3673B ':' q '' 000DE736060606060 ' <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> </pre> <br></div></div><br>  Das Skript implementiert nur die GET-Methode.  Wenn Sie eine GET-Anforderung f√ºr dieses als Web App ver√∂ffentlichte Skript ausf√ºhren, enth√§lt die Antwort sofort das dekodierte Kennwort in Form einer Zeichenfolge. <br><br><h3>  Teil 3. Mikrotik und vor√ºbergehend umgezogen 302 </h3><br>  Wir haben also ein Skript, das auf externen Web-App-Servern ausgef√ºhrt wird, das unabh√§ngig von Sperren ist und ein Nur-Text-Kennwort zur√ºckgibt.  Und es scheint, dass es nichts Einfacheres gibt, als es mit dem Abrufbefehl in RouterOS Mikrotik anzufordern.  Aber dann erwartete mich eine weitere √úberraschung.  Als Antwort auf die Anforderung (reale Adressen ge√§ndert) gibt der Abruf "302 Vor√ºbergehend verschoben" zur√ºck. <br><br><pre> <code class="bash hljs">[admin@MikroTik] /environment&gt; :put ([/tool fetch url=<span class="hljs-string"><span class="hljs-string">"https://script.google.com/macros/s/A.....A/exec"</span></span> http-method=get output=user as-value]-&gt;<span class="hljs-string"><span class="hljs-string">"data"</span></span>) failure: closing connection: &lt;302 Moved Temporarily <span class="hljs-string"><span class="hljs-string">"https://script.googleusercontent.com/macros/echo?user_content_key=....."</span></span>&gt; 173.194.222.138:443 (4) [admin@MikroTik] /environment&gt;</code> </pre> <br>  Zu Beginn des Artikels habe ich bereits dar√ºber geschrieben.  Beim Zugriff auf die persistente bekannte URL des Web App-Skripts leitet Google zu einer tempor√§ren URL weiter, die wiederum eine Antwort auf die Anforderung zur√ºckgibt.  Im Gegensatz zu PHP cURL wei√ü fetch RouterOS jedoch nicht, wie man Weiterleitungen durchl√§uft, sondern gibt einen Fehler zur√ºck.  Aber forum.mikrotik.com hat nicht sofort, aber es gab eine Problemumgehung.  Sie k√∂nnen die Standardabrufausgabe von der Konsole in eine Datei umleiten, indem Sie die asynchrone Ausf√ºhrung in einer separaten Task mit dem folgenden Befehl aufrufen: execute.  Sie k√∂nnen dann die Weiterleitungs-URL abrufen und bereits mit der neuen Adresse erneut abrufen.  Welches wird unten getan. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  . Moved Temporarily 302.  fetch  gasfetchout.txt :local jobid [:execute script={/tool fetch url="https://script.google.com/macros/s/A.....A/exec" output=user as-value} file=gasfetchout.txt] #    ,     :while ([:len [/system script job find .id=$jobid ]] &gt; 0) do={ delay 1s } #  gasfetchout.txt,  URL  :local fetchOut [/file get gasfetchout.txt contents] :local startURL [:find $fetchOut "http" -1] :local endURL [:find $fetchOut "\"&gt; " startURL] :local moveURL [:pick $fetchOut $startURL $endURL] :global VPNBookPass2 ([/tool fetch url=$moveURL output=user as-value]-&gt;"data")</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Hier finden Sie den vollst√§ndigen Text des Mikrotik-Skripts f√ºr die Arbeit mit der GAS-Web-App</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># VPNBookScript v4 :local VPNBookpIfName "pptp-out1" :local VPNBookServerAddresses {"PL226.vpnbook.com";"de4.vpnbook.com";"us1.vpnbook.com";"us2.vpnbook.com";"fr1.vpnbook.com ";"fr8.vpnbook.com ";"ca222.vpnbook.com ";"ca198.vpnbook.com"} :local VPNBookErr false :global VPNBookPass :global VPNBookRun :global VPNBookServerIndex :if ([:typeof $VPNBookServerIndex] != "num") do={:set VPNBookServerIndex 0} :if ([/interface pptp-client get $VPNBookpIfName running]) do={ :set VPNBookRun true } else { :if (!$VPNBookRun) do={ :set VPNBookServerIndex ($VPNBookServerIndex + 1) :if ($VPNBookServerIndex&gt;=[:len $VPNBookServerAddresses]) do={:set VPNBookServerIndex 0} } else { :set VPNBookRun false } :if (![/interface pptp-client get $VPNBookpIfName disabled]) do={/interface pptp-client set $VPNBookpIfName disabled=yes} # :do {:set VPNBookPass ([/tool fetch url="http://serv/vpnbookpass_googlescript.php" output=user as-value]-&gt;"data")} on-error={:set VPNBookErr true} :do { # First request with Moved Temporarily. Fetch out to gasfetchout.txt :local jobid [:execute script={/tool fetch url="https://script.google.com/macros/s/A.....g/exec" output=user as-value} file=gasfetchout.txt] # Wait end job :while ([:len [/system script job find .id=$jobid ]] &gt; 0) do={ delay 1s } # parse new URL for second fetch :local fetchOut [/file get gasfetchout.txt contents] :local startURL [:find $fetchOut "http" -1] :local endURL [:find $fetchOut "\"&gt; " startURL] :local moveURL [:pick $fetchOut $startURL $endURL] :set VPNBookPass ([/tool fetch url=$moveURL output=user as-value]-&gt;"data") } on-error={:set VPNBookErr true} :if (!$VPNBookErr) do={ :if ([/interface pptp-client get $VPNBookpIfName password] != $VPNBookPass) do={/interface pptp-client set $VPNBookpIfName password=$VPNBookPass} :if ([/interface pptp-client get $VPNBookpIfName connect-to] != $VPNBookServerAddresses-&gt;$VPNBookServerIndex) do={/interface pptp-client set $VPNBookpIfName connect-to=($VPNBookServerAddresses-&gt;$VPNBookServerIndex)} :log info "VPNBook: Attempt to connect to: $($VPNBookServerAddresses-&gt;$VPNBookServerIndex). Password: $VPNBookPass" /interface pptp-client set $VPNBookpIfName disabled=no } }</span></span></code> </pre> <br></div></div><br><h3>  Teil 4. Telegramm-GAS-Proxy </h3><br>  Ich beschloss, diesen Teil der n√§chsten Iteration der Integration des Telegrammdienstes in Mikrotik zu widmen.  Die Verwendung von GAS w√§re hier von rein akademischem Interesse, wenn nicht der Telegrammdienst, einschlie√ülich api.telegram.org, blockiert w√ºrde, √ºber den Bots mit dem Dienst arbeiten.  Die Idee wiederholt die Idee am Anfang des Artikels √ºber das Proxying der Anforderung von PNG-Bildern. <br>  In diesem Fall wird die GAS-Web-App auf Proxy-Anfragen von Mikrtotik an api.telegram.org geschrieben.  Als Grundlage nahm ich ein fertiges Skript von manzoorwanijk, WPTelegram Google Script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gist.github.com/manzoorwanijk/ee9ed032caedf2bb0c83dea73bc9a28e</a> .  Dieses Skript kann viele (aber nicht alle) Telegramm-API-Methoden als Proxy verwenden.  In args k√∂nnen Sie ein JSON-Objekt √ºbergeben, das die Anforderungsparameter enth√§lt, z. B. <code>{"chat_id":"123","text":"HelloWorld"}</code> .  F√ºr meine Aufgabe, Textnachrichten von RouterOS Mikrtotik zu senden, schien die Implementierung jedoch kompliziert und ich habe sie vereinfacht.  Letztendlich k√∂nnen Sie im Allgemeinen mehrere Web-App-Skripts schreiben, um verschiedene Telegramm-API-Methoden zu vertreten.  Hier ist meine Implementierung f√ºr die sendMessage-Methode.  Sie k√∂nnen dies weiter vereinfachen, indem Sie den Namen der aufgerufenen sendMessage-Methode und sogar bot_token und chat_id in den Hauptteil der requestHandler-Funktion einbetten. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ContentService.createTextOutput(requestHandler(e)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPost</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ContentService.createTextOutput(requestHandler(e)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.bot_token === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Bot token not provided'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.method === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Method name not provided'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.chat_id === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Chat id not provide'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.text === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Text not provide'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* if(typeof e.parameter.args !== 'undefined'){ var args = e.parameter.args; data.payload = JSON.parse(args); } */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.parameter.method === <span class="hljs-string"><span class="hljs-string">'sendMessage'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = { <span class="hljs-string"><span class="hljs-string">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"post"</span></span>, <span class="hljs-string"><span class="hljs-string">"muteHttpExceptions"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span> : <span class="hljs-string"><span class="hljs-string">'chat_id='</span></span> + e.parameter.chat_id + <span class="hljs-string"><span class="hljs-string">'&amp;text='</span></span> + e.parameter.text } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UrlFetchApp.fetch(<span class="hljs-string"><span class="hljs-string">'https://api.telegram.org/bot'</span></span> + e.parameter.bot_token + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + e.parameter.method, data).getContentText(); } }</code> </pre> <br>  Nach dem Ver√∂ffentlichen des Skripts in der Web App k√∂nnen Sie im GET-Browser eine Anforderung ausf√ºhren, um Folgendes zu √ºberpr√ºfen: <br><br><pre> <code class="plaintext hljs">https://script.google.com/macros/s/A.....A/exec?bot_token=3.....3&amp;method=sendMessage&amp;chat_id=2.....3&amp;text=testtext123</code> </pre> <br>  Oder in RouterOS POST Anfrage: <br><br><pre> <code class="bash hljs">:<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { /tool fetch url=(<span class="hljs-string"><span class="hljs-string">"https://script.google.com/macros/s/A.....A/exec"</span></span>) keep-result=no http-method=post http-data=(<span class="hljs-string"><span class="hljs-string">"bot_token=3.....3&amp;method=sendMessage&amp;chat_id=2.....3&amp;text=testtext123"</span></span>) } on-error={ }</code> </pre><br>  Die Anforderung wird in do-on-error eingeschlossen, da der erste Aufruf zum Abrufen, wie oben gezeigt, die Ausnahme "Vor√ºbergehend verschoben 302" ausl√∂st und das Skript ohne den On-Error-Handler an dieser Stelle stoppt.  Ein Aufruf zum Abrufen ohne Weiterleitung reicht aus, damit die Nachricht gesendet wird. Ein zweiter Aufruf zum Abrufen ist daher nicht erforderlich, wenn Sie das von der Telegramm-API zur√ºckgegebene JSON-Objekt nicht ben√∂tigen. <br><br><h3>  Teil 5. Schluss </h3><br>  Ich habe meine echten Anwendungen an die Schnittstelle von Google Apps Script mit anderen Diensten gebracht.  Sie k√∂nnen sich viel mehr einfallen lassen.  Schreiben Sie beispielsweise einen Telegramm-Bot in GAS, der mit einem VPNBook-Kennwort mit Caching-Anforderungen antwortet, um die Belastung des VPNBook (Cache-Dienst) zu verringern. Dies alles wird in einem GAS-Skript ausgef√ºhrt.  Sie k√∂nnen auf GAS ein Protokollierungssystem oder Sicherungskonfigurationen f√ºr Mikrtotik schreiben, die in Google Text &amp; Tabellen- und Google Sheets-Dateien gespeichert werden, und vieles mehr. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de475856/">https://habr.com/ru/post/de475856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de475840/index.html">Badoo Jira API Client: Magie in Jira in PHP</a></li>
<li><a href="../de475842/index.html">Aktions-URL & URI in SIP-Telefonen ersetzen oder √ºber Websockets verwalten?</a></li>
<li><a href="../de475848/index.html">Wie die Yandex.Market-Suche funktioniert und was passiert, wenn einer der Server abst√ºrzt</a></li>
<li><a href="../de475850/index.html">So starten Sie eine Karriere in der IT, wenn Sie noch keine Erfahrung haben</a></li>
<li><a href="../de475854/index.html">JDBC-Pools und effizientes File-Handling: Java mitap 3. Dezember in St. Petersburg</a></li>
<li><a href="../de475858/index.html">Unterhaltsame Krypto-Energie: Die Hitze des Bergbaus f√ºr den Menschen und die Hitze des Menschen f√ºr den Bergbau</a></li>
<li><a href="../de475860/index.html">Apache NiFi. 28. November im Deworkacy-H√∂rsaal</a></li>
<li><a href="../de475862/index.html">Schlechte Ratschl√§ge zur Einf√ºhrung von maschinellem Lernen in Unternehmen</a></li>
<li><a href="../de475866/index.html">Katzen, Flugzeuge, B√ºros und Stress</a></li>
<li><a href="../de475868/index.html">Intelligente Lampe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>