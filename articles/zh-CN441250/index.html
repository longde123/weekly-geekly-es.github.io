<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ€ ğŸ§‘ğŸ»â€ğŸ¤â€ğŸ§‘ğŸ» ğŸ¡ å¿«é€Ÿå…¥é—¨ï¼šGo + Apache Kafka + Redis ğŸ‘ ğŸ‘§ğŸ» ğŸ‘²ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ€è¿‘ï¼Œç”±äºå¿…è¦ï¼Œæˆ‘ä»”ç»†æ£€æŸ¥äº†Goå¼€å‘äººå‘˜çš„æ‰€æœ‰ç©ºç¼ºï¼Œå…¶ä¸­æœ‰ä¸€åŠï¼ˆè‡³å°‘ï¼‰æåˆ°äº†Apache Kafkaæ¶ˆæ¯å¤„ç†å¹³å°å’ŒRedis NoSQLæ•°æ®åº“ã€‚ å¥½å§ï¼Œå½“ç„¶ï¼Œæ¯ä¸ªäººéƒ½å¸Œæœ›å€™é€‰äººäº†è§£Dockerå’Œå…¶ä»–ç±»ä¼¼ä»–çš„äººã€‚ å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œæ‰€æœ‰è¿™äº›è¦æ±‚ï¼Œå·²ç»çœ‹è¿‡ç³»ç»Ÿå·¥ç¨‹å¸ˆçš„æ„è§ï¼Œä¼¼ä¹æœ‰äº›çç¢ã€‚ å¥½å§ï¼Œå®é™…ä¸Šï¼Œä¸€æ¡çº¿...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¿«é€Ÿå…¥é—¨ï¼šGo + Apache Kafka + Redis</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441250/"> æœ€è¿‘ï¼Œç”±äºå¿…è¦ï¼Œæˆ‘ä»”ç»†æ£€æŸ¥äº†Goå¼€å‘äººå‘˜çš„æ‰€æœ‰ç©ºç¼ºï¼Œå…¶ä¸­æœ‰ä¸€åŠï¼ˆè‡³å°‘ï¼‰æåˆ°äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Apache Kafka</a>æ¶ˆæ¯å¤„ç†å¹³å°å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Redis</a> NoSQLæ•°æ®åº“ã€‚ å¥½å§ï¼Œå½“ç„¶ï¼Œæ¯ä¸ªäººéƒ½å¸Œæœ›å€™é€‰äººäº†è§£Dockerå’Œå…¶ä»–ç±»ä¼¼ä»–çš„äººã€‚ å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œæ‰€æœ‰è¿™äº›è¦æ±‚ï¼Œå·²ç»çœ‹è¿‡ç³»ç»Ÿå·¥ç¨‹å¸ˆçš„æ„è§ï¼Œä¼¼ä¹æœ‰äº›çç¢ã€‚ å¥½å§ï¼Œå®é™…ä¸Šï¼Œä¸€æ¡çº¿ä¸å¦ä¸€æ¡çº¿æœ‰ä½•ä¸åŒï¼Ÿ å½“ç„¶ï¼ŒNoSQLæ•°æ®åº“çš„æƒ…å†µæ›´åŠ å¤šæ ·åŒ–ï¼Œä½†å®ƒä»¬ä¼¼ä¹æ¯”ä»»ä½•MS SQL Serveréƒ½æ›´ç®€å•ã€‚ å½“ç„¶ï¼Œæ‰€æœ‰è¿™ä¸€åˆ‡éƒ½æ˜¯æˆ‘ä¸ªäººåœ¨å“ˆå¸ƒé›·ï¼ˆHabÃ©ï¼‰ä¸Šå¤šæ¬¡æåˆ°çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é‚“å®-å…‹é²æ ¼æ•ˆåº”</a> ã€‚ <br> å› æ­¤ï¼Œç”±äºæ‰€æœ‰é›‡ä¸»éƒ½è¦æ±‚ï¼Œæœ‰å¿…è¦ç ”ç©¶è¿™äº›æŠ€æœ¯ã€‚ ä½†æ˜¯ä»å¤´åˆ°å°¾é˜…è¯»æ‰€æœ‰æ–‡æ¡£å¼€å§‹å¹¶ä¸æ˜¯å¾ˆæœ‰è¶£ã€‚ æˆ‘è®¤ä¸ºï¼Œé˜…è¯»ä»‹ç»ï¼Œåˆ¶ä½œå¯è¡Œçš„åŸå‹ï¼Œä¿®å¤é”™è¯¯ï¼Œé‡åˆ°é—®é¢˜ï¼Œè§£å†³é—®é¢˜ä¼šæ›´æœ‰æ•ˆç‡ã€‚ åœ¨äº†è§£äº†æ‰€æœ‰è¿™äº›å†…å®¹ä¹‹åï¼Œè¯·é˜…è¯»æ–‡æ¡£ï¼Œç”šè‡³å•ç‹¬é˜…è¯»ä¸€æœ¬ä¹¦ã€‚ <br><br><img src="https://habrastorage.org/webt/cn/q0/pd/cnq0pdshf1e8_dnfxpwrdkk46yc.jpeg"><br><br> é‚£äº›å¯¹åœ¨çŸ­æ—¶é—´å†…ç†Ÿæ‚‰è¿™äº›äº§å“çš„åŸºæœ¬åŠŸèƒ½æ„Ÿå…´è¶£çš„äººï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚ <br><a name="habracut"></a><br> åŸ¹è®­è®¡åˆ’å°†è€ƒè™‘æ•°å­—ã€‚ å®ƒå°†åŒ…æ‹¬ä¸€ä¸ªå¤§å‹æ•°å­—ç”Ÿæˆå™¨ï¼Œä¸€ä¸ªæ•°å­—å¤„ç†å™¨ï¼Œä¸€ä¸ªé˜Ÿåˆ—ï¼Œåˆ—å­˜å‚¨å’Œä¸€ä¸ªWebæœåŠ¡å™¨ã€‚ <br><br> åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå°†åº”ç”¨ä»¥ä¸‹è®¾è®¡æ¨¡å¼ï¼š <br><br><ul><li> è¾“é€æœº </li><li> å–·é›¾å™¨ï¼ˆ <a href="">æ‰‡å‡º</a> ï¼‰ </li><li> æ”¶é›†å™¨ï¼ˆ <a href="">æ‰‡å…¥</a> ï¼‰ </li></ul><br> ç³»ç»Ÿæ¶æ„å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><img src="https://habrastorage.org/webt/ns/sz/f2/nsszf2v5b5hozqdguchikxfugys.jpeg"><br><br> åœ¨å›¾ä¸­ï¼Œæ¤­åœ†å½¢è¡¨ç¤ºè¾“é€æœºçš„è®¾è®¡å›¾æ¡ˆã€‚ æˆ‘å°†æ›´è¯¦ç»†åœ°ä»‹ç»å®ƒã€‚ <br><br> æ¨¡æ¿â€œä¼ é€å¸¦â€å‡å®šä¿¡æ¯ä»¥æµçš„å½¢å¼å‡ºç°å¹¶åˆ†é˜¶æ®µè¿›è¡Œå¤„ç†ã€‚ é€šå¸¸ï¼Œæœ‰ä¸€äº›ç”Ÿæˆå™¨ï¼ˆä¿¡æ¯æºï¼‰å’Œä¸€ä¸ªæˆ–å¤šä¸ªå¤„ç†å™¨ï¼ˆä¿¡æ¯å¤„ç†å™¨ï¼‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”Ÿæˆå™¨å°†æ˜¯Goä¸Šçš„ç¨‹åºï¼Œè¯¥ç¨‹åºå°†éšæœºå¤§æ•°æ’é˜Ÿã€‚ å¤„ç†å™¨ï¼ˆå”¯ä¸€çš„å¤„ç†å™¨ï¼‰å°†æ˜¯ä¸€ä¸ªä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®å¹¶æ‰§è¡Œåˆ†è§£çš„ç¨‹åºã€‚ åœ¨çº¯Goä¸Šï¼Œä½¿ç”¨é€šé“ï¼ˆchanï¼‰éå¸¸å®¹æ˜“å®ç°æ­¤æ¨¡å¼ã€‚ ä¸Šé¢æœ‰ä¸€ä¸ªå¸¦æœ‰ç¤ºä¾‹çš„æŒ‡å‘æˆ‘çš„githubçš„é“¾æ¥ã€‚ åœ¨è¿™é‡Œï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°†æ‰®æ¼”é€šé“çš„è§’è‰²ã€‚ <br><br> æ‰‡å…¥-æ‰‡å‡ºæ¨¡æ¿é€šå¸¸ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”åº”ç”¨äºGoæ—¶ï¼Œæ„å‘³ç€ä½¿ç”¨goroutineå¹¶è¡Œè¿›è¡Œè®¡ç®—å¹¶è¡ŒåŒ–ï¼Œç„¶åæ±‡æ€»ç»“æœå¹¶å°†å…¶ä¼ è¾“åˆ°ä¸‹æ¸¸ã€‚ ä¸Šé¢ä¹Ÿæä¾›äº†ç¤ºä¾‹çš„é“¾æ¥ã€‚ å†æ¬¡ï¼Œé€šé“è¢«é˜Ÿåˆ—æ›¿æ¢ï¼Œgoroutinesä¿ç•™åœ¨åŸå¤„ã€‚ <br><br> ç°åœ¨è°ˆè°ˆApache Kafkaã€‚  Kafkaæ˜¯ä¸€ä¸ªå…·æœ‰å‡ºè‰²ç¾¤é›†å·¥å…·çš„æ¶ˆæ¯ç®¡ç†ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿä½¿ç”¨äº‹åŠ¡æ—¥å¿—ï¼ˆä¸RDBMSä¸­çš„æ—¥å¿—å®Œå…¨ä¸€æ ·ï¼‰æ¥å­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶æ”¯æŒé˜Ÿåˆ—æ¨¡å‹å’Œå‘å¸ƒè€…/è®¢é˜…è€…æ¨¡å‹ã€‚ åè€…æ˜¯é€šè¿‡é‚®ä»¶æ”¶ä»¶äººç»„å®ç°çš„ã€‚ æ¯æ¡æ¶ˆæ¯ä»…æ¥æ”¶è¯¥ç»„çš„ä¸€ä¸ªæˆå‘˜ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰ï¼Œä½†æ˜¯è¯¥æ¶ˆæ¯å°†è¢«ä¼ é€’åˆ°æ¯ä¸ªç»„ä¸€æ¬¡ã€‚ å¯ä»¥æœ‰è®¸å¤šè¿™æ ·çš„ç»„ï¼Œä»¥åŠæ¯ä¸ªç»„ä¸­çš„æ”¶ä»¶äººã€‚ <br><br> è¦ä½¿ç”¨Kafkaï¼Œæˆ‘å°†ä½¿ç”¨â€œ github.com/segmentio/kafka-goâ€è½¯ä»¶åŒ…ã€‚ <br> å¦ä¸€æ–¹é¢ï¼ŒRedisæ˜¯å†…å­˜ä¸­çš„é”®å€¼åˆ—æ•°æ®åº“ï¼Œå®ƒæ”¯æŒæ°¸ä¹…å­˜å‚¨æ•°æ®çš„åŠŸèƒ½ã€‚ é”®å’Œå€¼çš„ä¸»è¦æ•°æ®ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œä½†è¿˜æœ‰ä¸€äº›å…¶ä»–ç±»å‹ã€‚  Redisè¢«è®¤ä¸ºæ˜¯åŒç±»äº§å“ä¸­é€Ÿåº¦æœ€å¿«ï¼ˆæˆ–æœ€å¤šï¼‰çš„æ•°æ®åº“ä¹‹ä¸€ã€‚ æœ€å¥½å­˜å‚¨å„ç§ç»Ÿè®¡ä¿¡æ¯ï¼ŒæŒ‡æ ‡ï¼Œæ¶ˆæ¯æµç­‰ã€‚ <br> è¦ä½¿ç”¨Redisï¼Œæˆ‘å°†ä½¿ç”¨â€œ github.com/go-redis/redisâ€åŒ…ã€‚ <br><br> ç”±äºæœ¬æ–‡æ˜¯å¿«é€Ÿå…¥é—¨ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨DockerHubä¸­çš„ç°æˆæ˜ åƒä½¿ç”¨Dockeréƒ¨ç½²è¿™ä¸¤ä¸ªç³»ç»Ÿã€‚ æˆ‘åœ¨Windows 10ä¸Šçš„Linux VMï¼ˆç”±Docker VMè‡ªåŠ¨åˆ›å»ºï¼‰ä¸Šä»¥å®¹å™¨æ¨¡å¼ä½¿ç”¨docker-composeï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹docker-compose.ymlæ–‡ä»¶ï¼š <br><br><pre><code class="xml hljs">version: '2' services: zookeeper: image: wurstmeister/zookeeper ports: - "2181:2181" kafka: image: wurstmeister/kafka:latest ports: - "9092:9092" environment: KAFKA_ADVERTISED_HOST_NAME: 127.0.0.1 KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_CREATE_TOPICS: "Generated:1:1,Solved:1:1,Unsolved:1:1" KAFKA_DELETE_TOPIC_ENABLE: "true" volumes: - /var/run/docker.sock:/var/run/docker.sock redis: image: redis ports: - "6379:6379"</code> </pre> <br> ä¿å­˜æ­¤æ–‡ä»¶ï¼Œè½¬åˆ°æ–‡ä»¶ç›®å½•å¹¶æ‰§è¡Œï¼š <br><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br> åº”è¯¥ä¸‹è½½å¹¶å¯åŠ¨ä¸‰ä¸ªå®¹å™¨ï¼šKafkaï¼ˆé˜Ÿåˆ—ï¼‰ï¼ŒZookeeperï¼ˆKafkaçš„é…ç½®æœåŠ¡å™¨ï¼‰å’Œï¼ˆRedisï¼‰ã€‚ <br><br> æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š <br><br><pre> <code class="bash hljs">docker-compose ps</code> </pre> <br> åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š <br><br><pre> <code class="bash hljs">Name State Ports -------------------------------------------------------------------------------------- docker-compose_kafka_1 Up 0.0.0.0:9092-&gt;9092/tcp docker-compose_redis_1 Up 0.0.0.0:6379-&gt;6379/tcp docker-compose_zookeeper_1 Up 0.0.0.0:2181-&gt;2181/tcp, 22/tcp, 2888/tcp, 3888/tcp</code> </pre><br> æ ¹æ®ymlæ–‡ä»¶ï¼Œåº”è¯¥è‡ªåŠ¨åˆ›å»ºä¸‰ä¸ªé˜Ÿåˆ—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å®ƒä»¬ï¼š <br><br><pre> <code class="bash hljs">docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> kafka-container_kafka_1 /opt/kafka_2.12-2.1.0/bin/kafka-topics.sh --list --zookeeper zookeeper:2181</code> </pre> <br> åº”è¯¥æœ‰ç”Ÿæˆï¼Œå·²è§£å†³å’Œæœªè§£å†³çš„é˜Ÿåˆ—ï¼ˆä¸»é¢˜-ç”¨Kafkaè¡¨ç¤ºçš„ä¸»é¢˜ï¼‰ã€‚ <br><br>  <a href="">æ•°æ®ç”Ÿæˆå™¨</a>æ— é™éšæœºåœ°å°†æ•°å­—æ’é˜Ÿã€‚ å®ƒçš„ä»£ç éå¸¸ç®€å•ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯Generatedé˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„å­˜åœ¨ï¼š <br><br><pre> <code class="bash hljs">docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> kafka-container_kafka_1 /opt/kafka_2.12-2.1.0/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic Generated --from-beginning</code> </pre><br> æ¥ä¸‹æ¥æ˜¯<a href="">å¤„ç†å™¨</a> -åœ¨è¿™é‡Œæ‚¨åº”è¯¥æ³¨æ„å¹¶è¡Œå¤„ç†ä»¥ä¸‹ä»£ç å—ä¸­é˜Ÿåˆ—ä¸­çš„å€¼ï¼š <br><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wg sync.WaitGroup c := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">//counter for { //       15     ctx, cancel := context.WithTimeout(context.Background(), 15*time.Second) defer cancel() //      //    -     m, err := r.ReadMessage(ctx) if err != nil { fmt.Println("3") fmt.Println(err) break } wg.Add(1) //       10      goCtx, goCcancel := context.WithTimeout(context.Background(), 10*time.Millisecond) defer goCcancel() //     () go process(goCtx, c, &amp;wg, m) c++ } //     wg.Wait()</span></span></code> </pre> <br> ç”±äºä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡Œè¯»å–ä¼šé˜»æ­¢ç¨‹åºï¼Œå› æ­¤æˆ‘åˆ›å»ºäº†ä¸€ä¸ªè¶…æ—¶ä¸º15ç§’çš„context.Contextå¯¹è±¡ã€‚ å¦‚æœé˜Ÿåˆ—å¾ˆé•¿æ—¶é—´ä¸ºç©ºï¼Œåˆ™æ­¤è¶…æ—¶å°†ç»ˆæ­¢ç¨‹åºã€‚ <br><br> æ­¤å¤–ï¼Œå¯¹äºå°†å› å­åˆ†è§£çš„æ¯ä¸ªgorutinï¼Œè¿˜å°†è®¾ç½®æœ€å¤§å·¥ä½œæ—¶é—´ã€‚ æˆ‘å¸Œæœ›å°†èƒ½å¤Ÿåˆ†è§£çš„æ•°å­—å†™åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­ã€‚ å¹¶ä¸”åœ¨åˆ†é…çš„æ—¶é—´å†…æ— æ³•åˆ†è§£çš„æ•°å­—è¢«è½¬ç§»åˆ°å¦ä¸€ä¸ªæ•°æ®åº“ã€‚ <br><br> ä¸ºäº†ç¡®å®šå¤§æ¦‚çš„æ—¶é—´ï¼Œä½¿ç”¨äº†åŸºå‡†ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkFactorize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { ch := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> []<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> factors []<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; bN; i++ { num := <span class="hljs-number"><span class="hljs-number">2345678901234</span></span> <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> factorize(num, ch) factors = &lt;-ch b.Logf(<span class="hljs-string"><span class="hljs-string">"\n%d   %+v\n\n"</span></span>, num, factors) } }</code> </pre> <br>  Goä¸­çš„åŸºå‡†æµ‹è¯•ç§ç±»ç¹å¤šï¼Œå¹¶ä¸æµ‹è¯•ä¸€èµ·æ”¾ç½®åœ¨æ–‡ä»¶ä¸­ã€‚ åŸºäºæ­¤æµ‹é‡ï¼Œä¸ºéšæœºæ•°ç”Ÿæˆå™¨é€‰æ‹©äº†æœ€å¤§æ•°ã€‚ åœ¨æˆ‘çš„è®¡ç®—æœºä¸Šï¼Œéƒ¨åˆ†æ•°å­—æœ‰æ—¶é—´è€ƒè™‘ï¼Œè€Œéƒ¨åˆ†æ—¶é—´æ²¡æœ‰ã€‚ <br><br> é‚£äº›å¯åˆ†è§£çš„æ•°å­—å†™åœ¨DB No.0ä¸­ï¼Œæœªåˆ†è§£çš„æ•°å­—å†™åœ¨DB No.1ä¸­ã€‚ <br> åœ¨è¿™é‡Œæˆ‘å¿…é¡»è¯´ï¼Œåœ¨Redisä¸­æ²¡æœ‰å¤å…¸æ„ä¹‰ä¸Šçš„è¡¨ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒDBMSåŒ…å«16ä¸ªå¯ä¾›ç¨‹åºå‘˜ä½¿ç”¨çš„æ•°æ®åº“ã€‚ è¿™äº›åŸºæ•°çš„æ•°é‡ä¸åŒ-ä»0åˆ°15ã€‚ <br><br> ä½¿ç”¨ä¸Šä¸‹æ–‡å’Œselectè¯­å¥æä¾›äº†å¤„ç†å™¨ä¸­goroutineçš„æ—¶é—´é™åˆ¶ï¼š <br><br><pre> <code class="go hljs"> <span class="hljs-comment"><span class="hljs-comment">//   go factorize(n, outChan) var item data select { case factors = &lt;-outChan: { fmt.Printf("\ngoroutine #%d, input: %d, factors: %+v\n", counter, n, factors) item.Number = n item.Factors = factors err = storeSolved(item) if err != nil { fmt.Println("6") log.Fatal(err) } } case &lt;-ctx.Done(): { fmt.Printf("\ngoroutine #%d, input: %d, exited on context timeout\n", counter, n) err = storeUnsolved(n) if err != nil { fmt.Println("7") log.Fatal(err) } return nil } }</span></span></code> </pre> <br> è¿™æ˜¯Goä¸Šå¦ä¸€ç§å…¸å‹çš„å¼€å‘æŠ€å·§ã€‚ å…¶å«ä¹‰æ˜¯selectè¯­å¥éå†é€šé“å¹¶æ‰§è¡Œä¸ç¬¬ä¸€ä¸ªæ´»åŠ¨é€šé“ç›¸å¯¹åº”çš„ä»£ç ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œgoroutineä¼šå°†ç»“æœè¾“å‡ºåˆ°å…¶é€šé“ï¼Œæˆ–è€…è¶…æ—¶çš„ä¸Šä¸‹æ–‡é€šé“å°†å…³é—­ã€‚ é™¤äº†ä¸Šä¸‹æ–‡ä»¥å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»æ„é€šé“å……å½“ç®¡ç†å™¨å¹¶æä¾›goroutineçš„å¼ºåˆ¶ç»ˆæ­¢ã€‚ <br><br> ç”¨äºå†™å…¥æ•°æ®åº“çš„å­ä¾‹ç¨‹æ‰§è¡Œå‘½ä»¤ä»¥é€‰æ‹©æ‰€éœ€çš„æ•°æ®åº“ï¼ˆ0æˆ–1ï¼‰ï¼Œå¹¶ä¸ºå·²è§£æçš„æ•°å­—å†™æˆå½¢å¼ï¼ˆæ•°å­—-å› æ•°ï¼‰æˆ–ä¸ºæœªåˆ†è§£çš„æ•°å­—å†™æˆï¼ˆæ•°å­—-æ•°ï¼‰å½¢å¼çš„å¯¹ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storeSolved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(item data)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err error)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//    0 cmd := redis.NewStringCmd("select", 0) err = client.Process(cmd) b, err := json.Marshal(item.Factors) err = client.Set(strconv.Itoa(item.Number), string(b), 0).Err() return err }</span></span></code> </pre> <br> æœ€åä¸€éƒ¨åˆ†å°†æ˜¯<a href="">WebæœåŠ¡å™¨</a> ï¼Œå®ƒå°†ä»¥jsonçš„å½¢å¼æ˜¾ç¤ºåˆ†è§£å’Œæœªåˆ†è§£çš„æ•°å­—çš„åˆ—è¡¨ã€‚ ä»–å°†æœ‰ä¸¤ä¸ªç«¯ç‚¹ï¼š <br><br><pre> <code class="go hljs"> http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/solved"</span></span>, solvedHandler) http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/unsolved"</span></span>, unsolvedHandler)</code> </pre> <br> ä»Redisæ¥æ”¶æ•°æ®å¹¶ä»¥jsonå½¢å¼è¿”å›çš„httpè¯·æ±‚å¤„ç†ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">solvedHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { w.Header().Set(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>) w.Header().Set(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>) w.Header().Set(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Methods"</span></span>, <span class="hljs-string"><span class="hljs-string">"GET"</span></span>) w.Header().Set(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Headers"</span></span>, <span class="hljs-string"><span class="hljs-string">"Accept, Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization"</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   â„–0 -   cmd := redis.NewStringCmd("select", 0) err := client.Process(cmd) if err != nil { w.WriteHeader(http.StatusInternalServerError) return } //      keys := client.Keys("*") var solved []data var item data //          for _, key := range keys.Val() { item.Key = key val, err := client.Get(key).Result() if err != nil { w.WriteHeader(http.StatusInternalServerError) return } item.Val = val solved = append(solved, item) } //    JSON err = json.NewEncoder(w).Encode(solved) if err != nil { w.WriteHeader(http.StatusInternalServerError) return } }</span></span></code> </pre> <br> åœ¨ä»¥ä¸‹ä½ç½®çš„è¯·æ±‚ç»“æœï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">localhost /è§£å†³</a> <br><br><pre> <code class="json hljs">[{ <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: <span class="hljs-string"><span class="hljs-string">"1604388558816"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Val"</span></span>: <span class="hljs-string"><span class="hljs-string">"[1,2,3,227]"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: <span class="hljs-string"><span class="hljs-string">"545232916387"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Val"</span></span>: <span class="hljs-string"><span class="hljs-string">"[1,545232916387]"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: <span class="hljs-string"><span class="hljs-string">"1786301239076"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Val"</span></span>: <span class="hljs-string"><span class="hljs-string">"[1,2]"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: <span class="hljs-string"><span class="hljs-string">"698495534061"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Val"</span></span>: <span class="hljs-string"><span class="hljs-string">"[1,3,13,641,165331]"</span></span> }]</code> </pre> <br> ç°åœ¨ï¼Œæ‚¨å¯ä»¥æ·±å…¥ç ”ç©¶æ–‡æ¡£å’Œä¸“ä¸šæ–‡çŒ®ã€‚ å¸Œæœ›æœ¬æ–‡å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚ <br><br> æˆ‘è¦æ±‚ä¸“å®¶ä¸è¦å¤ªæ‡’æƒ°ï¼Œå¹¶æŒ‡å‡ºæˆ‘çš„é”™è¯¯ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN441250/">https://habr.com/ru/post/zh-CN441250/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN441238/index.html">ç¼–ç¨‹è‹±è¯­</a></li>
<li><a href="../zh-CN441240/index.html">ä»–ä»¬æ˜¯å¦åœ¨å¤§å‹å¼ºå­å¯¹æ’æœºä¸Šä¸¢å¤±äº†æ–°ç‰©ç†å­¦çš„è¯æ®ï¼Ÿ</a></li>
<li><a href="../zh-CN441242/index.html">é€šè®¯ç½‘ç»œç›‘æ§ä¸­å¿ƒï¼šRunetçš„æ–°çŠ¶æ€â€œé˜²å¾¡è€…â€</a></li>
<li><a href="../zh-CN441244/index.html">WinRaræ¼æ´ï¼ˆå·²å…³é—­19å¹´ï¼‰ï¼Œå¯è®©æ‚¨å°†è§£å‹ç¼©çš„æ–‡ä»¶æ”¾ç½®åœ¨ä»»ä½•ä½ç½®</a></li>
<li><a href="../zh-CN441248/index.html">ä¿„ç½—æ–¯åœ¨å…¨çƒSSLæ’åä¸­æ’åç¬¬9ä½ï¼Œé¢†å…ˆäºä¸­å›½ï¼Œä¸¹éº¦å’Œç‘å£«</a></li>
<li><a href="../zh-CN441252/index.html">â€œå£äº¤æ–‡ç« â€ï¼šç§‘å­¦å®¶å¤„ç†äº†109ä¸ªå°æ—¶çš„å£äº¤ï¼Œä»¥å¼€å‘å‡ºå¸å¼•æˆå‘˜çš„AI</a></li>
<li><a href="../zh-CN441254/index.html">ç ”è®¨ä¼šâ€œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä¸Kubernetesä¿æŒè”ç³»ä»¥åŠæˆ‘ä»¬ä»ä¸­è·å¾—ä»€ä¹ˆâ€ï¼Œ2æœˆ28æ—¥ï¼Œè«æ–¯ç§‘</a></li>
<li><a href="../zh-CN441258/index.html">åœ¨Linuxä¸Šä½¿ç”¨eBPFå’Œbpftraceçš„å…¨åŠŸèƒ½åŠ¨æ€è·Ÿè¸ª</a></li>
<li><a href="../zh-CN441260/index.html">ç¥ç»ç½‘ç»œå›¾å½¢å¦‚ä½•æä¾›å¸®åŠ©</a></li>
<li><a href="../zh-CN441262/index.html">ç®€å•å’Œé•¿æœŸçš„ä»»åŠ¡æ¯”çŸ­æœŸå’Œå¤æ‚çš„ä»»åŠ¡æ›´èƒ½æ·˜æ±°å€™é€‰äºº</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>