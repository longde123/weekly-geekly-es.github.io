<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕞 😔 🌀 Divida o Laravel em componentes ♨️ 🐄 👱🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Habr. Recentemente, tenho um projeto interessante em minhas mãos, que, apesar de sua simplicidade, exigia não usar nenhuma estrutura. Não se falava...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Divida o Laravel em componentes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475144/"><p> Oi Habr.  Recentemente, tenho um projeto interessante em minhas mãos, que, apesar de sua simplicidade, exigia não usar nenhuma estrutura.  Não se falava em pacotes, por isso foi decidido usar os componentes usuais do Laravel.  Se você precisar usar filas, Eloquent ou um contêiner - bem-vindo ao gato. </p><a name="habracut"></a><br><h2 id="o-prostote-deleniya-freymvorka-na-komponenty">  Sobre a simplicidade de dividir a estrutura em componentes </h2><br><p>  Começando com o Laravel 4, todos os componentes são pacotes separados, que em teoria podem ser criados para funcionar em qualquer projeto PHP.  No entanto, alguns componentes requerem personalização adicional, que na estrutura principal está oculta. </p><br><h2 id="komponenty">  Componentes </h2><br><h3 id="konteyner">  Container </h3><br><p> De todos os componentes em consideração, <code>illuminate/container</code> é o mais fácil de instalar e usar. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Container</span></span>\<span class="hljs-title"><span class="hljs-title">Container</span></span>; $container = Container::getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $container-&gt;make(Foo::class);</code> </pre> <br><p>  No entanto, chamar um método estático na classe <code>Container</code> toda vez que você usa um contêiner não é uma boa ideia.  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code> app()</code></a> está disponível na estrutura, que retornará a instância do contêiner global para nós; no entanto, precisamos criar uma manualmente. </p><br><p>  Crie um arquivo <code>helpers.php</code> para esses auxiliares e adicione-o na inicialização. </p><br><pre> <code class="plaintext hljs">"autoload": { "files": [ "src/helpers.php" ], "psr-4": { "YourApp\\": "src/" } }</code> </pre> <br><p>  Adicione o auxiliar <code>app()</code> ao arquivo. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Container</span></span>\<span class="hljs-title"><span class="hljs-title">Container</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! function_exists(<span class="hljs-string"><span class="hljs-string">'app'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">/** * Get the available container instance. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string|null $abstract * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $parameters * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed|\Illuminate\Container\Container */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($abstract = null, array $parameters = [])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_null($abstract)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Container::getInstance(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Container::getInstance()-&gt;make($abstract, $parameters); } }</code> </pre> <br><p>  Feito.  Você pode tentar usar um ajudante. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app(Foo::class);</code> </pre> <br><h3 id="query-builder-i-eloquent">  Criador de consultas e eloquente </h3><br><p>  Para usar o componente <code>illuminate/database</code> , usaremos <code>Capsule\Manager</code> , uma classe projetada para trabalhar com o construtor de consultas fora do Laravel. </p><br><p>  Vamos começar configurando uma conexão com o banco de dados.  É aconselhável realizar essa configuração no estágio de inicialização do seu aplicativo, imediatamente após conectar o <code>autoload.php</code> . </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>.<span class="hljs-string"><span class="hljs-string">'/../vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; $manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Manager; $manager-&gt;addConnection([ <span class="hljs-string"><span class="hljs-string">'driver'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'mysql'</span></span>, <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'database'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'database'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'charset'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>, <span class="hljs-string"><span class="hljs-string">'collation'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'utf8_unicode_ci'</span></span>, <span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, ]); <span class="hljs-comment"><span class="hljs-comment">//        Capsule. $manager-&gt;setAsGlobal();</span></span></code> </pre> <br><p>  Você pode começar com o construtor de consultas. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Manager::table(<span class="hljs-string"><span class="hljs-string">'orders'</span></span>)-&gt;get();</code> </pre> <br><p>  E o Eloquent? </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">YourApp</span></span>\<span class="hljs-title"><span class="hljs-title">Models</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Eloquent</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $fillable = [ <span class="hljs-string"><span class="hljs-string">'name'</span></span>, ]; }</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">YourApp</span></span>\<span class="hljs-title"><span class="hljs-title">Models</span></span>\<span class="hljs-title"><span class="hljs-title">Order</span></span>; Order::first();</code> </pre> <br><p>  A situação é mais complicada com as migrações - por um lado, há um Schema Builder no kit.  Por outro lado, não há mecanismo automático para iniciar migrações. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; Manager::schema()-&gt;create(<span class="hljs-string"><span class="hljs-string">'orders'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;bigIncrements(<span class="hljs-string"><span class="hljs-string">'id'</span></span>); $table-&gt;string(<span class="hljs-string"><span class="hljs-string">'name'</span></span>); $table-&gt;timestamps(); });</code> </pre> <br><p>  Para começar, basta executar o arquivo com a migração: <code>php migration.php</code> </p><br><h3 id="ocheredi">  Filas </h3><br><p>  As filas também têm sua própria <code>Capsule</code> , no entanto, os análogos da <code>queue:work</code> e <code>queue:listen</code> devem ser gravados manualmente. </p><br><p>  Vamos começar com a classe <code>Application</code> .  No Laravel, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">essa classe é</a> usada como uma instância global de contêiner, que, além dos métodos <code>Illuminate\Container\Container</code> , contém métodos auxiliares para trabalhar com a estrutura (versão atual, caminhos de armazenamento, recursos).  No entanto, nossa classe conterá apenas um método - <code>isDownForMaintenance</code> .  É necessário para o trabalho do trabalhador, pois determina o estado do aplicativo no momento. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">YourApp</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Container</span></span>\<span class="hljs-title"><span class="hljs-title">Container</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isDownForMaintenance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Em seguida, precisamos registrar o provedor de <code>illuminate/events</code> e vincular o <code>Illuminate\Contracts\Events\Dispatcher</code> ao alias de <code>events</code> . </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">YourApp</span></span>\<span class="hljs-title"><span class="hljs-title">Application</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Contracts</span></span>\<span class="hljs-title"><span class="hljs-title">Events</span></span>\<span class="hljs-title"><span class="hljs-title">Dispatcher</span></span>; $application = Application::getInstance(); $application-&gt;bind(Dispatcher::class, <span class="hljs-string"><span class="hljs-string">'events'</span></span>);</code> </pre> <br><p>  Agora você precisa criar a instância do <code>Capsule</code> e adicionar as configurações de conexão lá. </p><br><p>  <strong>Exemplo de configuração para o banco de dados</strong> </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">YourApp</span></span>\<span class="hljs-title"><span class="hljs-title">Application</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">DB</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">ConnectionResolver</span></span>; $container = Application::getInstance(); $queue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Manager($container); $queue-&gt;addConnection([ <span class="hljs-string"><span class="hljs-string">'driver'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'database'</span></span>, <span class="hljs-string"><span class="hljs-string">'table'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'jobs'</span></span>, <span class="hljs-string"><span class="hljs-string">'connection'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'queue'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, ], <span class="hljs-string"><span class="hljs-string">'default'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ,    Illuminate\Database\Capsule\Manager       $queue-&gt;setAsGlobal(); $connection = Capsule::schema()-&gt;getConnection(); $resolver = new ConnectionResolver(['default' =&gt; $connection]); $queue-&gt;getQueueManager()-&gt;addConnector('database', function () use ($resolver) { return new DatabaseConnector($resolver); });</span></span></code> </pre> <br><p>  <strong>Exemplo de configuração para Redis (requer <code>illuminate/redis</code> )</strong> </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Redis</span></span>\<span class="hljs-title"><span class="hljs-title">RedisManager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; $container-&gt;bind(<span class="hljs-string"><span class="hljs-string">'redis'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedisManager($container, <span class="hljs-string"><span class="hljs-string">'predis'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'default'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">6379</span></span>, <span class="hljs-string"><span class="hljs-string">'database'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, ] ]); }); $queue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Manager($container); $queue-&gt;addConnection([ <span class="hljs-string"><span class="hljs-string">'driver'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'redis'</span></span>, <span class="hljs-string"><span class="hljs-string">'connection'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'queue'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'default'</span></span>, ], <span class="hljs-string"><span class="hljs-string">'default'</span></span>); $queue-&gt;setAsGlobal();</code> </pre> <br><p>  A etapa final da configuração é adicionar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">manipulador de exceção</a> analógico. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Contracts</span></span>\<span class="hljs-title"><span class="hljs-title">Debug</span></span>\<span class="hljs-title"><span class="hljs-title">ExceptionHandler</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExceptionHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception $e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,  Exception     . // :   Sentry,    . } public function render($request, Exception $e) { //   } public function renderForConsole($output, Exception $e) { //  ,     -  } public function shouldReport(\Exception $e) { //      } } app()-&gt;bind('exception.handler', function () { return new Handler; });</span></span></code> </pre> <br><p>  Configuração de fila concluída.  Agora você pode começar a escrever na <code>queue:work</code> . </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>.<span class="hljs-string"><span class="hljs-string">'/bootstrap/bootstrap.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Worker</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">WorkerOptions</span></span>; $queueManager = Manager::getQueueManager(); $worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker($queueManager, app(<span class="hljs-string"><span class="hljs-string">'events'</span></span>), app(<span class="hljs-string"><span class="hljs-string">'exception.handler'</span></span>)); $worker-&gt;daemon(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WorkerOptions);</code> </pre> <br><p>  Agora, para iniciar um trabalhador de fila, basta escrever <code>php worker.php</code> . </p><br><p>  Se houver necessidade de usar a <code>queue:listen</code> , será necessário criar dois arquivos separados.  Um é um daemon que escuta a fila e executa um segundo arquivo em cada novo trabalho.  O segundo arquivo, por sua vez, atua como o executor da tarefa. </p><br><p>  <strong>worker.php</strong> </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>.<span class="hljs-string"><span class="hljs-string">'/bootstrap/bootstrap.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Listener</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">ListenerOptions</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,   " ",  Laravel  artisan,        work.php. // https://github.com/laravel/framework/blob/6.x/src/Illuminate/Queue/Listener.php#L72 define('ARTISAN_BINARY', 'work.php'); $worker = app(Listener::class, ['commandPath' =&gt; __DIR__]); $worker-&gt;setOutputHandler(function ($type, $line) { echo $line; }); $worker-&gt;listen('default', 'default', new ListenerOptions);</span></span></code> </pre> <br><p>  <strong>work.php</strong> </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'bootstrap/bootstrap.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Worker</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">WorkerOptions</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; $queueManager = Manager::getQueueManager(); $worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker($queueManager, app(<span class="hljs-string"><span class="hljs-string">'events'</span></span>), app(<span class="hljs-string"><span class="hljs-string">'exception.handler'</span></span>)); $worker-&gt;runNextJob(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-string"><span class="hljs-string">'default'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WorkerOptions);</code> </pre> <br><p>  Passamos a usar.  Todos os métodos podem ser visualizados na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API.</a> </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">Capsule</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; Manager::push(SomeJob::class);</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt475144/">https://habr.com/ru/post/pt475144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt475126/index.html">Moscow Node.js Meetup 10: arquitetura de aplicativos Node.js., Hot Reload in Node.js e um relatório secreto</a></li>
<li><a href="../pt475132/index.html">Hélice sem travamento em uma máquina CNC</a></li>
<li><a href="../pt475134/index.html">Outra maneira de fraude de alta tecnologia</a></li>
<li><a href="../pt475136/index.html">Machine Learning para sua caça plana. Parte 3: O impulso final</a></li>
<li><a href="../pt475142/index.html">Sono, relaxamento e música: como os atletas profissionais superam a fadiga e o que podemos fazer sobre isso</a></li>
<li><a href="../pt475146/index.html">A agonia ou a longa história de uma tentativa de recuperação de dados</a></li>
<li><a href="../pt475152/index.html">Hipocrisia google. PageSpeed ​​Insights</a></li>
<li><a href="../pt475154/index.html">Timelapse interno com o serviço de vigilância em nuvem IPEYE</a></li>
<li><a href="../pt475158/index.html">Playme P570 Mono Review: Curto e direto ao ponto</a></li>
<li><a href="../pt475162/index.html">Usando macro X no código C ++ moderno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>