<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçú üêÇ üôçüèª React Token Auth üëêüèΩ ‚õ∫Ô∏è üé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Problemm 


 L'autorisation est l'un des premiers probl√®mes rencontr√©s par les d√©veloppeurs lors du d√©marrage d'un nouveau projet. Et l'un des types d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>React Token Auth</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485764/"><p><img src="https://habrastorage.org/webt/v-/ss/kz/v-sskznfybocplele4iiabbdl44.png"></p><br><h2 id="problem">  Problemm </h2><br><p> L'autorisation est l'un des premiers probl√®mes rencontr√©s par les d√©veloppeurs lors du d√©marrage d'un nouveau projet.  Et l'un des types d'autorisation les plus courants (d'apr√®s mon exp√©rience) est l'autorisation bas√©e sur les jetons (g√©n√©ralement en utilisant JWT). </p><br><p>  De mon point de vue, cet article ressemble √† "ce que je voulais lire il y a deux semaines".  Mon objectif √©tait d'√©crire du code minimaliste et r√©utilisable avec une interface claire et simple.  J'avais les prochaines exigences pour ma mise en ≈ìuvre de la gestion d'authentification: </p><br><ul><li>  Les jetons doivent √™tre stock√©s dans le stockage local </li><li>  Les jetons doivent √™tre restaur√©s lors du rechargement de la page </li><li>  Le jeton d'acc√®s doit √™tre transmis dans les requ√™tes r√©seau </li><li>  Apr√®s l'expiration, le jeton d'acc√®s doit √™tre mis √† jour par un jeton d'actualisation si le dernier est pr√©sent√© </li><li>  Les composants React doivent avoir acc√®s aux informations d'authentification pour rendre l'interface utilisateur appropri√©e </li><li>  La solution doit √™tre faite avec du React pur (sans Redux, thunk, etc.) </li></ul><a name="habracut"></a><br><p>  Pour moi, l'une des questions les plus difficiles a √©t√©: </p><br><ul><li>  Comment synchroniser l'√©tat des composants React et les donn√©es de stockage local? </li><li>  Comment obtenir le jeton √† l'int√©rieur de la r√©cup√©ration sans le passer √† travers l'arborescence d'√©l√©ments compl√®te (surtout si nous voulons utiliser cette r√©cup√©ration dans les actions de thunk plus tard par exemple) </li></ul><br><p> Mais r√©solvons les probl√®mes √©tape par √©tape.  Premi√®rement, nous allons cr√©er un <code>token provider</code> de jetons pour stocker les jetons et offrir la possibilit√© d'√©couter les changements.  Apr√®s cela, nous allons cr√©er un <code>auth provider</code> , en fait entourer le <code>token provider</code> pour cr√©er des crochets pour les composants React, r√©cup√©rer des st√©ro√Ødes et quelques m√©thodes suppl√©mentaires.  Et √† la fin, nous verrons comment utiliser cette solution dans le projet. </p><br><h2 id="i-just-wanna-npm-install--and-go-production">  Je veux juste <code>npm install ...</code> et aller en production </h2><br><p>  J'ai d√©j√† rassembl√© le paquet qui contient tout ce qui est d√©crit ci-dessous (et un peu plus).  Il vous suffit de l'installer par la commande: </p><br><pre> <code class="plaintext hljs">npm install react-token-auth</code> </pre> <br><p>  Et suivez des exemples dans le r√©f√©rentiel GitHub <a href="https://github.com/obabichev/react-token-auth" rel="nofollow">react-token-auth</a> . </p><br><h2 id="solution">  Solution </h2><br><p>  Avant de r√©soudre le probl√®me, je ferai l'hypoth√®se que nous avons un backend qui retourne un objet avec des jetons d'acc√®s et de rafra√Æchissement.  Chaque jeton a un format <code>JWT</code> .  Un tel objet peut ressembler √†: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"accessToken"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"refreshToken"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span> }</code> </pre> <br><p>  En fait, la structure de l'objet jetons n'est pas critique pour nous.  Dans le cas le plus simple, il peut s'agir d'une cha√Æne avec un jeton d'acc√®s infini.  Mais nous voulons voir comment g√©rer une situation lorsque nous avons deux jetons, l'un d'eux peut expirer et le second peut √™tre utilis√© pour mettre √† jour le premier. </p><br><h3 id="jwt">  Jwt </h3><br><p>  Si vous ne savez pas quel est le jeton JWT, la meilleure option est d'aller sur <a href="https://jwt.io/" rel="nofollow">jwt.io</a> et de voir comment cela fonctionne.  Maintenant, il est important que le jeton JWT contienne des informations cod√©es (au format <code>Base64</code> ) sur l'utilisateur qui permettent de l'authentifier sur le serveur. </p><br><p>  Habituellement, le jeton JWT contient 3 parties divis√©es par des points et ressemble √†: </p><br><p> <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiSm9obiBEb2UiLCJpYXQiOjE1MTYyMzkwMjIsImV4cCI6MTUxNjIzOTAyMn0.yOZC0rjfSopcpJ-d3BWE8-BkoLR_SCqPdJpq8Wn-1Mc</code> </p> <br><p>  Si nous d√©codons la partie centrale ( <code>eyJu...Mn0</code> ) de ce jeton, nous obtiendrons le prochain JSON: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"John Doe"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iat"</span></span>: <span class="hljs-number"><span class="hljs-number">1516239022</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exp"</span></span>: <span class="hljs-number"><span class="hljs-number">1516239022</span></span> }</code> </pre> <br><p>  Avec ces informations, nous pourrons obtenir la date d'expiration du token. </p><br><h3 id="token-provider">  Fournisseur de jetons </h3><br><p>  Comme je l'ai mentionn√© pr√©c√©demment, notre premi√®re √©tape consiste √† cr√©er le fournisseur de jetons.  Le fournisseur de jetons travaillera directement avec le stockage local et toutes les modifications de jetons que nous effectuerons √† travers lui.  Cela nous permettra d'√©couter les changements de n'importe o√π et d'aviser imm√©diatement les auditeurs des changements (mais √† ce sujet un peu plus tard).  L'interface du fournisseur aura les m√©thodes suivantes: </p><br><ul><li>  <code>getToken()</code> pour obtenir le jeton actuel (il sera utilis√© lors de la r√©cup√©ration) </li><li>  <code>setToken()</code> pour d√©finir le jeton apr√®s la connexion, la d√©connexion ou l'enregistrement </li><li>  <code>isLoggedIn()</code> pour v√©rifier si l'utilisateur est connect√© </li><li>  <code>subscribe()</code> pour donner au fournisseur une fonction qui devrait √™tre appel√©e apr√®s tout changement de jeton </li><li>  <code>unsubscribe()</code> pour supprimer l'abonn√© </li></ul><br><p>  La fonction <code>createTokenProvider()</code> cr√©era une instance du fournisseur de jetons avec l'interface d√©crite: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> createTokenProvider = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* Implementation */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { getToken, isLoggedIn, setToken, subscribe, unsubscribe, }; };</code> </pre> <br><p>  Tout le code suivant doit se trouver dans la fonction createTokenProvider. </p><br><p>  Commen√ßons par cr√©er une variable pour stocker les jetons et restaurer les donn√©es du stockage local (pour √™tre s√ªr que la session ne sera pas perdue apr√®s le rechargement de la page): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> _token: { <span class="hljs-attr"><span class="hljs-attr">accessToken</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">refreshToken</span></span>: string } = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'REACT_TOKEN_AUTH'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>) || <span class="hljs-literal"><span class="hljs-literal">null</span></span>;</code> </pre> <br><p>  Nous devons maintenant cr√©er des fonctions suppl√©mentaires pour travailler avec les jetons JWT.  √Ä l'heure actuelle, le jeton JWT ressemble √† une cha√Æne magique, mais ce n'est pas grave de l'analyser et d'essayer d'extraire la date d'expiration.  La fonction <code>getExpirationDate()</code> prendra un jeton JWT comme param√®tre et renverra l'horodatage de la date d'expiration en cas de succ√®s (ou <code>null</code> en cas d'√©chec): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getExpirationDate = (jwtToken?: string): number | <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">null</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!jwtToken) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> jwt = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(atob(jwtToken.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>])); <span class="hljs-comment"><span class="hljs-comment">// multiply by 1000 to convert seconds into milliseconds return jwt &amp;&amp; jwt.exp &amp;&amp; jwt.exp * 1000 || null; };</span></span></code> </pre> <br><p>  Et une autre fonction util <code>isExpired()</code> pour v√©rifier si l'horodatage a expir√©.  Cette fonction renvoie true si l'horodatage d'expiration pr√©sent√© et s'il est inf√©rieur √† <code>Date.now()</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isExpired = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">exp?: number</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!exp) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() &gt; exp; };</code> </pre> <br><p>  Il est temps de cr√©er la premi√®re fonction de l'interface du fournisseur de jetons.  La fonction <code>getToken()</code> devrait retourner un jeton et le mettre √† jour si cela est n√©cessaire.  Cette fonction doit √™tre <code>async</code> car elle peut demander au r√©seau de mettre √† jour le jeton. </p><br><p>  En utilisant les fonctions cr√©√©es pr√©c√©demment, nous pouvons v√©rifier si les jetons d'acc√®s ont expir√© ou non ( <code>isExpired(getExpirationDate(_token.accessToken))</code> ).  Et dans le premier cas pour faire une demande de mise √† jour du jeton.  Apr√®s cela, nous pouvons enregistrer des jetons (avec la fonction <code>setToken()</code> pas encore impl√©ment√©e).  Et enfin, nous pouvons retourner le jeton d'acc√®s: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getToken = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_token) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isExpired(getExpirationDate(_token.accessToken))) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> updatedToken = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(<span class="hljs-string"><span class="hljs-string">'/update-token'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: _token.refreshToken }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> r.json()); setToken(updatedToken); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _token &amp;&amp; _token.accessToken; };</code> </pre> <br><p>  La fonction <code>isLoggedIn()</code> sera simple: elle renverra true si <code>_tokens</code> n'est pas <code>null</code> et ne v√©rifiera pas l'expiration du jeton d'acc√®s (dans ce cas, nous ne conna√Ætrons pas le jeton d'acc√®s d'expiration jusqu'√† ce que nous obtenions un √©chec lors de l'obtention du jeton, mais g√©n√©ralement c'est suffisant , et gardons la fonction isLoggedIn synchrone): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isLoggedIn = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !!_token; };</code> </pre> <br><p>  Je pense que c'est le bon moment pour cr√©er des fonctionnalit√©s de gestion des observateurs.  Nous allons impl√©menter quelque chose de similaire au <a href="https://en.wikipedia.org/wiki/Observer_pattern" rel="nofollow">mod√®le Observer</a> , et tout d'abord, cr√©erons un tableau pour stocker tous nos observateurs.  Nous nous attendons √† ce que chaque √©l√©ment de ce tableau soit la fonction que nous devrions appeler apr√®s chaque changement de jetons: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> observers: <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">isLogged: boolean</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; = [];</code> </pre> <br><p>  Nous pouvons maintenant cr√©er des m√©thodes <code>subscribe()</code> et <code>unsubscribe()</code> .  Le premier ajoutera un nouvel observateur au tableau cr√©√© un peu plus t√¥t, le second supprimera l'observateur de la liste. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> subscribe = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">observer: (isLogged: boolean</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) =&gt; { observers.push(observer); }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> unsubscribe = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">observer: (isLogged: boolean</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) =&gt; { observers = observers.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_observer</span></span></span><span class="hljs-function"> =&gt;</span></span> _observer !== observer); };</code> </pre> <br><p>  Vous pouvez d√©j√† voir depuis l'interface des fonctions <code>subscribe()</code> et <code>unsubscribe()</code> que nous enverrons aux observateurs uniquement si l'utilisateur est connect√©.  Mais en g√©n√©ral, vous pouvez envoyer tout ce que vous voulez (le token entier, le d√©lai d'expiration, etc ...).  Mais pour nos besoins, il suffira d'envoyer un drapeau bool√©en. </p><br><p>  Cr√©ons une petite fonction util <code>notify()</code> qui prendra ce drapeau et enverra √† tous les observateurs: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> notify = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isLogged = isLoggedIn(); observers.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">observer</span></span></span><span class="hljs-function"> =&gt;</span></span> observer(isLogged)); };</code> </pre> <br><p>  Et la derni√®re mais non la moindre fonction que nous devons impl√©menter est le <code>setToken()</code> .  Le but de cette fonction est d'enregistrer des jetons dans le stockage local (ou de nettoyer le stockage local si le jeton est vide) et d'informer les observateurs des modifications.  Donc, je vois le but, je vais au but. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> setToken = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">token: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _token</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (token) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'REACT_TOKEN_AUTH'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(token)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'REACT_TOKEN_AUTH'</span></span>); } _token = token; notify(); };</code> </pre> <br><p>  Soyez s√ªr, si vous en √™tes arriv√© √† ce point dans l'article et l'avez trouv√© utile, vous m'avez d√©j√† rendu plus heureux.  Ici, nous terminons avec le fournisseur de jetons.  Vous pouvez regarder votre code, jouer avec lui et v√©rifier qu'il fonctionne.  Dans la partie suivante, nous allons cr√©er des fonctionnalit√©s plus abstraites qui seront d√©j√† utiles dans n'importe quelle application React. </p><br><h3 id="auth-provider">  Fournisseur d'authentification </h3><br><p>  Cr√©ons une nouvelle classe d'objets que nous appellerons en tant que fournisseur Auth.  L'interface contiendra 4 m√©thodes: hook <code>useAuth()</code> pour obtenir un nouvel √©tat du composant React, <code>authFetch()</code> pour faire des requ√™tes au r√©seau avec le token r√©el et <code>login()</code> , les m√©thodes <code>setToken()</code> <code>logout()</code> qui proxy les appels √† la m√©thode <code>setToken()</code> du fournisseur de jetons (dans ce cas, nous n'aurons qu'un seul point d'entr√©e pour l'ensemble des fonctionnalit√©s cr√©√©es, et le reste du code n'aura pas √† conna√Ætre l'existence du fournisseur de jetons).  Comme pr√©c√©demment, nous partirons du cr√©ateur de la fonction: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> createAuthProvider = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* Implementation */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { useAuth, authFetch, login, logout } };</code> </pre> <br><p>  Tout d'abord, si nous voulons utiliser un fournisseur de jetons, nous devons en cr√©er une instance: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tokenProvider = createTokenProvider();</code> </pre> <br><p>  Les m√©thodes <code>login()</code> et <code>logout()</code> transmettent simplement le jeton au fournisseur de jetons.  J'ai s√©par√© ces m√©thodes uniquement pour une signification explicite (le fait de passer un jeton vide / nul supprime les donn√©es du stockage local): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> login: <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> tokenProvider.setToken = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newTokens</span></span></span><span class="hljs-function">) =&gt;</span></span> { tokenProvider.setToken(newTokens); }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> logout = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { tokenProvider.setToken(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); };</code> </pre> <br><p>  L'√©tape suivante est la fonction de r√©cup√©ration.  Selon mon id√©e, cette fonction devrait avoir exactement la m√™me interface que la r√©cup√©ration d'origine et retourner le m√™me format mais devrait injecter un jeton d'acc√®s √† chaque demande. </p><br><p>  La fonction d'extraction doit prendre deux arguments: demander des informations (g√©n√©ralement une URL) et demander init (un objet avec m√©thode, corps. En-t√™tes et ainsi de suite);  et renvoie la promesse de la r√©ponse: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> authFetch = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (input: RequestInfo, init?: RequestInit): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Response&gt; =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> token = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> tokenProvider.getToken(); init = init || {}; init.headers = { ...init.headers, <span class="hljs-attr"><span class="hljs-attr">Authorization</span></span>: <span class="hljs-string"><span class="hljs-string">`Bearer </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${token}</span></span></span><span class="hljs-string">`</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fetch(input, init); };</code> </pre> <br><p>  √Ä l'int√©rieur de la fonction, nous avons fait deux choses: pris un jeton du fournisseur de jetons par instruction <code>await tokenProvider.getToken();</code>  ( <code>getToken</code> contient d√©j√† la logique de mise √† jour du jeton apr√®s expiration) et d'injection de ce jeton dans l'en-t√™te d' <code>Authorization</code> par la ligne <code>Authorization: 'Bearer ${token}'</code> .  Apr√®s cela, nous retournons simplement fetch avec des arguments mis √† jour. </p><br><p>  Ainsi, nous pouvons d√©j√† utiliser le fournisseur d'authentification pour enregistrer les jetons et les utiliser depuis la r√©cup√©ration.  Le dernier probl√®me est que nous ne pouvons pas r√©agir aux changements de jetons de nos composants.  Il est temps de le r√©soudre. </p><br><p>  Comme je l'ai d√©j√† dit, nous allons cr√©er un hook <code>useAuth()</code> qui fournira des informations au composant est l'utilisateur connect√© ou non.  Pour ce faire, nous utiliserons hook <code>useState()</code> pour conserver ces informations.  Il est utile car toute modification de cet √©tat entra√Ænera un nouveau rendu des composants qui utilisent ce hook. </p><br><p>  Et nous avons d√©j√† tout pr√©par√© pour pouvoir √©couter les changements dans le stockage local.  Une mani√®re courante d'√©couter les modifications du syst√®me avec des hooks consiste √† utiliser le hook <code>useEffect()</code> .  Ce hook prend deux arguments: la fonction et la liste des d√©pendances.  La fonction sera d√©clench√©e apr√®s le premier appel de <code>useEffect</code> puis relanc√©e apr√®s toute modification dans la liste des d√©pendances.  Dans cette fonction, nous pouvons commencer √† √©couter les changements dans le stockage local.  Mais ce qui est important, nous pouvons revenir de cette fonction ... nouvelle fonction et, cette nouvelle fonction sera d√©clench√©e soit avant de relancer la premi√®re soit apr√®s le d√©montage du composant.  Dans la nouvelle fonction, nous pouvons arr√™ter d'√©couter les changements et React garantit que cette fonction sera d√©clench√©e (du moins si aucune exception ne se produit pendant ce processus).  Cela semble un peu compliqu√©, mais regardez le code: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> useAuth = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [isLogged, setIsLogged] = useState(tokenProvider.isLoggedIn()); useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> listener = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newIsLogged: boolean</span></span></span><span class="hljs-function">) =&gt;</span></span> { setIsLogged(newIsLogged); }; tokenProvider.subscribe(listener); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { tokenProvider.unsubscribe(listener); }; }, []); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [isLogged] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> isLogged]; };</code> </pre> <br><p>  Et c'est tout.  Nous venons de cr√©er un stockage d'authentification de jeton compact et r√©utilisable avec une API claire.  Dans la partie suivante, nous examinerons quelques exemples d'utilisation. </p><br><h2 id="usage">  Utilisation </h2><br><p>  Pour commencer √† utiliser ce que nous avons impl√©ment√© ci-dessus, nous devons cr√©er une instance du fournisseur d'authentification.  Cela nous donnera acc√®s aux fonctions <code>useAuth()</code> , <code>authFetch()</code> , <code>login()</code> , <code>logout()</code> li√©es au m√™me jeton dans le stockage local (en g√©n√©ral, rien ne vous emp√™che de cr√©er diff√©rentes instances de fournisseur d'authentification pour diff√©rents jetons, mais vous devrez param√©trer la cl√© que vous utilisez pour stocker les donn√©es dans le stockage local): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {useAuth, authFetch, login, logout} = createAuthProvider();</code> </pre> <br><h3 id="login-form">  Formulaire de connexion </h3><br><p>  Nous pouvons maintenant commencer √† utiliser les fonctions que nous avons obtenues.  Commen√ßons par le composant du formulaire de connexion.  Ce composant doit fournir des entr√©es pour les informations d'identification de l'utilisateur et l'enregistrer dans l'√©tat interne.  Lors de la soumission, nous devons envoyer une demande avec les informations d'identification pour obtenir des jetons et ici, nous pouvons utiliser la fonction <code>login()</code> pour stocker les jetons re√ßus: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LoginComponent = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [credentials, setCredentials] = useState({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> onChange = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{target: {name, value}}: ChangeEvent&lt;HTMLInputElement&gt;</span></span></span><span class="hljs-function">) =&gt;</span></span> { setCredentials({...credentials, [name]: value}) }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> onSubmit = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event?: React.FormEvent</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event) { event.preventDefault(); } fetch(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(credentials) }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> r.json()) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="hljs-function"> =&gt;</span></span> login(token)) }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;form onSubmit={onSubmit}&gt; &lt;input name="name" value={credentials.name} onChange={onChange}/&gt; &lt;input name="password" value={credentials.password} onChange={onChange}/&gt; &lt;/form&gt; };</code> </pre> <br><p>  Et c'est tout, c'est tout ce dont nous avons besoin pour stocker le jeton.  Apr√®s cela, lorsqu'un jeton est re√ßu, nous n'aurons pas besoin de d√©ployer des efforts suppl√©mentaires pour l'amener √† r√©cup√©rer ou dans des composants, car il est d√©j√† impl√©ment√© dans le fournisseur d'authentification. </p><br><p>  Le formulaire d'inscription est similaire, il n'y a que des diff√©rences dans le nombre et les noms des champs de saisie, donc je vais l'omettre ici. </p><br><h3 id="router">  Routeur </h3><br><p>  De plus, nous pouvons impl√©menter le routage √† l'aide du fournisseur d'authentification.  Supposons que nous avons deux packs de routes: un pour l'utilisateur enregistr√© et un pour non enregistr√©.  Pour les s√©parer, nous devons v√©rifier si nous avons un jeton dans le stockage local ou non, et ici nous pouvons utiliser le crochet <code>useAuth()</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Router = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [logged] = useAuth(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;BrowserRouter&gt; &lt;Switch&gt; {!logged &amp;&amp; &lt;&gt; &lt;Route path="/register" component={Register}/&gt; &lt;Route path="/login" component={Login}/&gt; &lt;Redirect to="/login"/&gt; &lt;/&gt;} {logged &amp;&amp; &lt;&gt; &lt;Route path="/dashboard" component={Dashboard} exact/&gt; &lt;Redirect to="/dashboard"/&gt; &lt;/&gt;} &lt;/Switch&gt; &lt;/BrowserRouter&gt;; };</code> </pre> <br><p>  Et la bonne chose qu'il sera restitu√© apr√®s toute modification du stockage local, en raison de <code>useAuth</code> a un abonnement √† ces modifications. </p><br><h3 id="fetch-requests">  R√©cup√©rer les demandes </h3><br><p>  Et puis nous pouvons obtenir des donn√©es prot√©g√©es par le jeton en utilisant <code>authFetch</code> .  Il a la m√™me interface que fetch, donc si vous utilisez d√©j√† fetch dans le code, vous pouvez simplement le remplacer par <code>authFetch</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Dashboard = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [posts, setPosts] = useState([]); useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { authFetch(<span class="hljs-string"><span class="hljs-string">'/posts'</span></span>) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> r.json()) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_posts</span></span></span><span class="hljs-function"> =&gt;</span></span> setPosts(_posts)) }, []); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {posts.map(post =&gt; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{post.id}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {post.message} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">)} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> };</code> </pre> <br><h2 id="summary">  R√©sum√© </h2><br><p>  Nous l'avons fait.  Ce fut un voyage int√©ressant, mais il a aussi la fin (peut-√™tre m√™me heureux). </p><br><p>  Nous avons commenc√© par comprendre les probl√®mes de stockage des jetons d'autorisation.  Ensuite, nous avons impl√©ment√© une solution et finalement regard√© les exemples de la fa√ßon dont elle pourrait √™tre utilis√©e dans l'application React. </p><br><p>  Comme je l'ai d√©j√† dit, vous pouvez trouver mon impl√©mentation sur GitHub dans la biblioth√®que.  Il r√©sout un probl√®me un peu plus g√©n√©rique et ne fait pas d'hypoth√®ses sur la structure de l'objet avec des jetons ou sur la fa√ßon de mettre √† jour le jeton, vous devrez donc fournir des arguments suppl√©mentaires.  Mais l'id√©e de la solution est la m√™me et le r√©f√©rentiel contient √©galement des instructions sur la fa√ßon de l'utiliser. </p><br><p>  Ici, je peux dire merci pour la lecture de l'article et j'esp√®re qu'il vous a √©t√© utile. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485764/">https://habr.com/ru/post/fr485764/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485742/index.html">Comment nous avons cr√©√© le r√©pertoire d'adresses de Rostelecom</a></li>
<li><a href="../fr485744/index.html">Intelligence - la capacit√© d'un objet √† adapter son comportement √† l'environnement afin de pr√©server (survivre)</a></li>
<li><a href="../fr485748/index.html">Cha√Ænage facultatif, union avec null et comment ils modifient notre approche de l'√©criture de code</a></li>
<li><a href="../fr485750/index.html">API pour lesquelles il vaut enfin la peine de passer de Java 8. Partie 1</a></li>
<li><a href="../fr485758/index.html">G√©ant modulaire avec contr√¥le en ligne, ainsi que des claviers textiles et tricot√©s Joe Paradiso</a></li>
<li><a href="../fr485768/index.html">Tendances Web 2020 √† essayer</a></li>
<li><a href="../fr485770/index.html">Pol√©mique incorrecte</a></li>
<li><a href="../fr485772/index.html">Du bureau au centre de donn√©es virtuel - comment nous sommes pass√©s √† la virtualisation</a></li>
<li><a href="../fr485776/index.html">Tout au long de la g√©ographie: navigation et t√¢ches g√©od√©siques dans diff√©rentes langues</a></li>
<li><a href="../fr485780/index.html">Robots, r√©sonateurs √† quartz, microcontr√¥leurs ... que fait Epson?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>