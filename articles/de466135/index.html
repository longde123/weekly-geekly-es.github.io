<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôä üë©üèº‚Äç‚öñÔ∏è üêÅ Megapack: Wie Factorio-Entwickler es geschafft haben, das 200-Spieler-Multiplayer-Problem zu l√∂sen üë©‚Äç‚ù§Ô∏è‚Äçüë® ü§öüèæ ü§∞üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Mai dieses Jahres nahm ich als Spieler am KatherineOfSky MMO-Event teil . Mir ist aufgefallen, dass alle paar Minuten, wenn die Anzahl der Spieler ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Megapack: Wie Factorio-Entwickler es geschafft haben, das 200-Spieler-Multiplayer-Problem zu l√∂sen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466135/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/35a/156/0b735a15617cf15740ddb733b0cff066.jpg" alt="Bild"></div><br>  Im Mai dieses Jahres nahm ich als Spieler am <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">KatherineOfSky MMO-Event teil</a> .  Mir ist aufgefallen, dass alle paar Minuten, wenn die Anzahl der Spieler eine bestimmte Anzahl erreicht, einige von ihnen ‚Äûabfallen‚Äú.  Zum Gl√ºck f√ºr Sie (aber nicht f√ºr mich) war ich einer der Spieler, die sich <b>jedes Mal</b> getrennt <b>haben</b> , auch wenn eine gute Verbindung bestand.  Ich nahm dies als pers√∂nliche Herausforderung und begann nach den Ursachen des Problems zu suchen.  Nach drei Wochen Debuggen, Testen und Beheben wurde der Fehler endg√ºltig behoben, aber diese Reise war nicht so einfach. <br><br>  Die Probleme von Multiplayer-Spielen sind sehr schwer zu finden.  Normalerweise treten sie unter sehr spezifischen Bedingungen von Netzwerkparametern und unter sehr spezifischen Bedingungen des Spiels auf (in diesem Fall der Anwesenheit von mehr als 200 Spielern).  Und selbst wenn es m√∂glich ist, das Problem zu reproduzieren, kann es nicht ordnungsgem√§√ü getestet werden, da das Einf√ºgen von Kontrollpunkten das Spiel stoppt, die Timer verwirrt und normalerweise zur Beendigung der Verbindung f√ºhrt, weil die Wartezeit √ºberschritten wird.  Aber dank der Sturheit und des wunderbaren Werkzeugs namens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ungeschickt gelang es</a> mir herauszufinden, was los war. <br><br>  Kurz gesagt: Aufgrund eines Fehlers und einer unvollst√§ndigen Implementierung der Simulation des Verz√∂gerungsstatus befindet sich der Client manchmal in einer Situation, in der er ein Netzwerkpaket in einem Taktzyklus senden muss, das aus den Aktionen des Spielers zur Auswahl von etwa 400 Spieleinheiten besteht (wir nennen es ein ‚ÄûMegapackage‚Äú).  Danach sollte der Server alle diese Eingabeaktionen nicht nur korrekt empfangen, sondern auch an alle anderen Clients senden.  Wenn Sie 200 Kunden haben, wird dies schnell zu einem Problem.  Der Kanal zum Server ist schnell verstopft, was zu Paketverlust und einer Kaskade von erneut angeforderten Paketen f√ºhrt.  Das Verschieben von Eingabeaktionen f√ºhrt dann dazu, dass noch mehr Kunden Megapackets senden und ihre Lawine noch st√§rker wird.  Erfolgreiche Kunden k√∂nnen sich erholen, der Rest f√§llt ab. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/a49/50e/f21a4950e42bd555a91ad923e5067ea6.jpg" alt="Bild"></div><br>  Das Problem war ziemlich grundlegend und ich habe 2 Wochen gebraucht, um es zu beheben.  Es ist ziemlich technisch, daher werde ich im Folgenden die saftigen technischen Details erl√§utern.  Aber zuerst m√ºssen Sie wissen, dass seit der Ver√∂ffentlichung der Version 0.17.54 am 4. Juni angesichts vor√ºbergehender Verbindungsprobleme der Mehrspielermodus stabiler geworden ist und das Verbergen von Verz√∂gerungen viel weniger fehlerhaft ist (weniger Bremsen und Teleportieren).  Au√üerdem habe ich die Art und Weise ge√§ndert, wie Verz√∂gerungen im Kampf versteckt werden, und ich hoffe, dass sie dadurch etwas reibungsloser werden. <br><br><h3>  Mehrbenutzer-Megapack - Technische Details </h3><br>  In einfachen Worten funktioniert der Multiplayer im Spiel wie folgt: Alle Clients simulieren den Status des Spiels und empfangen und senden nur die Eingaben des Spielers (sogenannte ‚ÄûEingabeaktionen‚Äú, <i>Eingabeaktionen</i> ).  Die Hauptaufgabe des Servers besteht darin, <i>Eingabeaktionen</i> zu √ºbertragen und zu steuern, dass alle Clients dieselben Aktionen in einem Zyklus ausf√ºhren.  Lesen Sie mehr dazu in der Post <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FFF-149</a> . <br><br>  Da der Server Entscheidungen dar√ºber treffen muss, welche Aktionen ausgef√ºhrt werden sollen, bewegen sich die Aktionen des Spielers auf diesem Pfad: Aktion des Spielers -&gt; Spielclient -&gt; Netzwerk -&gt; Server -&gt; Netzwerk -&gt; Spielclient.  Dies bedeutet, dass die Aktion jedes Spielers erst ausgef√ºhrt wird, nachdem er einen Hin- und R√ºckweg durch das Netzwerk gemacht hat.  Aus diesem Grund scheint das Spiel furchtbar langsam zu sein, so dass fast unmittelbar nach dem Erscheinen des Multiplayers im Spiel ein Mechanismus zum Verbergen von Verz√∂gerungen eingef√ºhrt wurde.  Das Ausblenden einer Verz√∂gerung imitiert die Eingabe eines Spielers, ohne die Aktionen anderer Spieler und Serverentscheidungen zu ber√ºcksichtigen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/2f/ui/8u2fuieagsu2fokkbdny-hxi1cc.png"></div><br>  Factorio hat einen Spielstatus namens Spielstatus - dies ist der vollst√§ndige Status der Karte, des Spielers, der Entit√§ten und aller anderen Elemente.  Es wird in allen Clients basierend auf den vom Server empfangenen Aktionen deterministisch simuliert.  Der Spielstatus ist heilig, und wenn er sich jemals vom Server oder einem anderen Client unterscheidet, erfolgt eine Desynchronisierung. <br><br>  Zus√§tzlich zum <i>Spielstatus</i> haben wir einen <i>Latenzstatus</i> .  Es enth√§lt eine kleine Teilmenge des Grundzustands.  <i>Der Latenzstatus ist</i> nicht heilig und zeigt lediglich ein Bild davon, wie der Status des Spiels in Zukunft aussehen wird, basierend auf den vom Spieler eingef√ºhrten <i>Eingabeaktionen</i> . <br><br>  Dazu speichern wir eine Kopie der erstellten <i>Eingabeaktionen</i> in der Verz√∂gerungswarteschlange. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gf/m4/bo/gfm4bo81-iluah40eus3cxjxvjm.png"></div><br>  Das hei√üt, am Ende des Prozesses auf der Client-Seite sieht das Bild ungef√§hr so ‚Äã‚Äãaus: <br><br><ol><li>  Wenden Sie die <i>Eingabeaktionen</i> aller Spieler auf den <i>Spielstatus an,</i> da diese Eingabeaktionen vom Server empfangen wurden. </li><li>  Wir entfernen alle <i>Eingabeaktionen</i> aus der Warteschlange der Verz√∂gerungen, die laut Server bereits auf den Spielstatus angewendet wurden. </li><li>  L√∂schen Sie den <i>Latenzstatus</i> und setzen Sie ihn zur√ºck, sodass er genauso aussieht wie der <i>Spielstatus</i> . </li><li>  Wenden Sie alle Aktionen aus der Verz√∂gerungswarteschlange auf den <i>Latenzstatus an</i> . </li><li>  Basierend auf den Daten aus Spielstatus und <i>Latenzstatus</i> rendern <i>wir</i> das Spiel f√ºr den Spieler. </li></ol><br>  All dies wiederholt sich in jedem Takt. <br><br>  Zu kompliziert?  Entspann dich nicht, das ist noch nicht alles.  Um die unzuverl√§ssigen Internetverbindungen auszugleichen, haben wir zwei Mechanismen geschaffen: <br><br><ul><li>  Verpasste Ticks: Wenn der Server entscheidet, dass die <i>Eingabeaktionen im Spieltakt ausgef√ºhrt</i> werden, wird er nicht warten, wenn er die <i>Eingabeaktionen</i> einiger Spieler nicht erh√§lt (z. B. aufgrund der erh√∂hten Verz√∂gerung), sondern diesem Client mitteilen, dass ich dies nicht ber√ºcksichtigt habe Ich werde versuchen, Ihre <i>Eingabeaktionen</i> zur n√§chsten Kennzahl hinzuzuf√ºgen. "  Dies geschieht, damit aufgrund von Problemen mit der Verbindung (oder mit dem Computer) eines Spielers die Kartenaktualisierung f√ºr alle anderen nicht langsamer wird.  Es ist erw√§hnenswert, dass <i>Eingabeaktionen</i> nicht ignoriert, sondern einfach verschoben werden. </li><li>  Roundtrip-Verz√∂gerung: Der Server versucht zu erraten, wie hoch die Roundtrip-Verz√∂gerung zwischen Client und Server f√ºr jeden Client ist.  Bei Bedarf bespricht er alle 5 Sekunden mit dem Client eine neue Verz√∂gerung (abh√§ngig davon, wie sich die Verbindung in der Vergangenheit verhalten hat) und erh√∂ht oder verringert dementsprechend die Verz√∂gerung beim Hin- und Her√ºbertragen von Daten. </li></ul><br>  Diese Mechanismen sind an sich recht einfach, aber wenn sie zusammen verwendet werden (was h√§ufig bei Verbindungsproblemen auftritt), wird die Logik des Codes schwierig zu verwalten und es gibt eine Reihe von Grenzf√§llen.  Wenn diese Mechanismen ins <i>Spiel kommen</i> , m√ºssen der Server und die Verz√∂gerungswarteschlange au√üerdem eine spezielle <i>Eingabeaktion</i> namens <i>StopMovementInTheNextTick</i> korrekt implementieren.  Aus diesem Grund l√§uft der Charakter bei Verbindungsproblemen nicht von alleine (z. B. unter dem Zug). <br><br>  Jetzt m√ºssen Sie Ihnen erkl√§ren, wie die Entit√§tsauswahl funktioniert.  Eine der Arten der √ºbergebenen <i>Eingabeaktion</i> ist die √Ñnderung des Status der Entit√§tsauswahl.  Es sagt jedem, √ºber welcher Entit√§t der Spieler schwebte.  Wie Sie verstehen, ist dies eine der h√§ufigsten Eingabeaktionen, die von Clients gesendet werden. Um Bandbreite zu sparen, haben wir sie so optimiert, dass sie so wenig Platz wie m√∂glich beansprucht.  Dies wird wie folgt implementiert: Bei der Auswahl jeder Entit√§t beh√§lt das Spiel anstelle der absoluten, hochpr√§zisen Koordinaten der Karte einen relativen Versatz mit geringem Strom gegen√ºber der vorherigen Auswahl bei.  Dies funktioniert gut, da die Mausauswahl normalerweise sehr nahe an der vorherigen Auswahl erfolgt.  Aus diesem Grund ergeben sich zwei wichtige Anforderungen: <i>Eingabeaktionen</i> d√ºrfen niemals √ºbersprungen und in der richtigen Reihenfolge ausgef√ºhrt werden.  Diese Anforderungen sind f√ºr den <i>Spielstatus</i> erf√ºllt.  Da es jedoch die Aufgabe des <i>Latenzzustands</i> ist, f√ºr den Spieler ‚Äûgut genug auszusehen‚Äú, sind sie im Zustand der Verz√∂gerungen nicht zufrieden.  <i>Der Latenzstatus</i> ber√ºcksichtigt nicht <a href="">viele Grenzf√§lle,</a> die mit √úberspringzyklen und sich √§ndernden Umlaufverz√∂gerungen verbunden sind. <br><br>  Sie k√∂nnen bereits erraten, wohin alles geht.  Schlie√ülich beginnen wir, die Ursachen des Megapackage-Problems zu erkennen.  Die Wurzel des Problems besteht darin, dass bei der Entscheidung, ob die Aktion der Auswahl√§nderung bestanden werden soll, die Entit√§tsauswahllogik auf dem <i>Latenzstatus</i> beruht und dieser Status nicht immer die richtigen Informationen enth√§lt.  Daher wird ein Megapaket wie folgt generiert: <br><br><ol><li>  Der Player hat ein Verbindungsproblem. </li><li>  Die Mechanismen zum √úberspringen von Uhren und zum Regulieren der Umlaufverz√∂gerung kommen ins Spiel. </li><li>  Verz√∂gerungen im Warteschlangenstatus ber√ºcksichtigen diese Mechanismen nicht.  Dies f√ºhrt dazu, dass einige Aktionen vorzeitig gel√∂scht oder in der falschen Reihenfolge ausgef√ºhrt werden, was zu einem falschen <i>Latenzstatus f√ºhrt</i> . </li><li>  Der Spieler hat ein Problem mit der Verbindung und simuliert, um den Server einzuholen, bis zu 400 Taktzyklen. </li><li>  In jedem Taktzyklus wird eine neue Aktion generiert, die die Auswahl einer Entit√§t √§ndert, und zum Senden an den Server vorbereitet. </li><li>  Der Client sendet ein Megapaket mit mehr als 400 √Ñnderungen bei der Auswahl der Entit√§ten an den Server (und bei anderen Aktionen: Der Zustand des Schie√üens, Gehens usw. litt ebenfalls unter diesem Problem). </li><li>  Der Server empf√§ngt 400 Eingabeaktionen.  Da er keine einzelne Eingabeaktion √ºberspringen darf, weist er alle Clients an, diese Aktionen auszuf√ºhren, und sendet sie √ºber das Netzwerk. </li></ol><br>  Die Ironie ist, dass ein Mechanismus zum Einsparen von Kanalbandbreite infolgedessen riesige Netzwerkpakete erzeugt hat. <br><br>  Wir haben dieses Problem gel√∂st, indem wir alle Grenzf√§lle der Aktualisierung und Unterst√ºtzung der Warteschlange f√ºr Verz√∂gerungen korrigiert haben.  Obwohl es eine Weile gedauert hat, hat es sich am Ende gelohnt, alles richtig zu implementieren und sich nicht auf schnelle Hacks zu verlassen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de466135/">https://habr.com/ru/post/de466135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de466113/index.html">Definieren der Textcodierung in PHP anstelle von mb_detect_encoding</a></li>
<li><a href="../de466121/index.html">Klangerzeugung auf AVR-Mikrocontrollern mithilfe der Wavetable-Methode mit Polyphonieunterst√ºtzung</a></li>
<li><a href="../de466123/index.html">Wachstum. Gewicht. Drei Nachbarn</a></li>
<li><a href="../de466127/index.html">KKW Kola oder am Reaktor stehen</a></li>
<li><a href="../de466129/index.html">Effizienz des Transports mit Benzin, Batterien und Wasserstoff</a></li>
<li><a href="../de466137/index.html">System.IO. Pipelines - ein wenig bekanntes Tool f√ºr Liebhaber hoher Leistung</a></li>
<li><a href="../de466139/index.html">Angewandte Technologie auf den Ruinen des Blockchain-Fiebers oder den praktischen Vorteilen der Ressourcenzuweisung</a></li>
<li><a href="../de466143/index.html">Wie haben wir Kartoncode oder die Scratch-Version des Brettspiels Golem Battle erstellt?</a></li>
<li><a href="../de466147/index.html">Reactive Data Display Manager. Einf√ºhrung</a></li>
<li><a href="../de466149/index.html">Erstellen eines Konnektorsymbols mit ‚Äûdynamischem‚Äú Text in OrCAD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>