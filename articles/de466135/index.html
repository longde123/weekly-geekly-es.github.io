<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙊 👩🏼‍⚖️ 🐁 Megapack: Wie Factorio-Entwickler es geschafft haben, das 200-Spieler-Multiplayer-Problem zu lösen 👩‍❤️‍👨 🤚🏾 🤰🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Mai dieses Jahres nahm ich als Spieler am KatherineOfSky MMO-Event teil . Mir ist aufgefallen, dass alle paar Minuten, wenn die Anzahl der Spieler ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Megapack: Wie Factorio-Entwickler es geschafft haben, das 200-Spieler-Multiplayer-Problem zu lösen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466135/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/35a/156/0b735a15617cf15740ddb733b0cff066.jpg" alt="Bild"></div><br>  Im Mai dieses Jahres nahm ich als Spieler am <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">KatherineOfSky MMO-Event teil</a> .  Mir ist aufgefallen, dass alle paar Minuten, wenn die Anzahl der Spieler eine bestimmte Anzahl erreicht, einige von ihnen „abfallen“.  Zum Glück für Sie (aber nicht für mich) war ich einer der Spieler, die sich <b>jedes Mal</b> getrennt <b>haben</b> , auch wenn eine gute Verbindung bestand.  Ich nahm dies als persönliche Herausforderung und begann nach den Ursachen des Problems zu suchen.  Nach drei Wochen Debuggen, Testen und Beheben wurde der Fehler endgültig behoben, aber diese Reise war nicht so einfach. <br><br>  Die Probleme von Multiplayer-Spielen sind sehr schwer zu finden.  Normalerweise treten sie unter sehr spezifischen Bedingungen von Netzwerkparametern und unter sehr spezifischen Bedingungen des Spiels auf (in diesem Fall der Anwesenheit von mehr als 200 Spielern).  Und selbst wenn es möglich ist, das Problem zu reproduzieren, kann es nicht ordnungsgemäß getestet werden, da das Einfügen von Kontrollpunkten das Spiel stoppt, die Timer verwirrt und normalerweise zur Beendigung der Verbindung führt, weil die Wartezeit überschritten wird.  Aber dank der Sturheit und des wunderbaren Werkzeugs namens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ungeschickt gelang es</a> mir herauszufinden, was los war. <br><br>  Kurz gesagt: Aufgrund eines Fehlers und einer unvollständigen Implementierung der Simulation des Verzögerungsstatus befindet sich der Client manchmal in einer Situation, in der er ein Netzwerkpaket in einem Taktzyklus senden muss, das aus den Aktionen des Spielers zur Auswahl von etwa 400 Spieleinheiten besteht (wir nennen es ein „Megapackage“).  Danach sollte der Server alle diese Eingabeaktionen nicht nur korrekt empfangen, sondern auch an alle anderen Clients senden.  Wenn Sie 200 Kunden haben, wird dies schnell zu einem Problem.  Der Kanal zum Server ist schnell verstopft, was zu Paketverlust und einer Kaskade von erneut angeforderten Paketen führt.  Das Verschieben von Eingabeaktionen führt dann dazu, dass noch mehr Kunden Megapackets senden und ihre Lawine noch stärker wird.  Erfolgreiche Kunden können sich erholen, der Rest fällt ab. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/a49/50e/f21a4950e42bd555a91ad923e5067ea6.jpg" alt="Bild"></div><br>  Das Problem war ziemlich grundlegend und ich habe 2 Wochen gebraucht, um es zu beheben.  Es ist ziemlich technisch, daher werde ich im Folgenden die saftigen technischen Details erläutern.  Aber zuerst müssen Sie wissen, dass seit der Veröffentlichung der Version 0.17.54 am 4. Juni angesichts vorübergehender Verbindungsprobleme der Mehrspielermodus stabiler geworden ist und das Verbergen von Verzögerungen viel weniger fehlerhaft ist (weniger Bremsen und Teleportieren).  Außerdem habe ich die Art und Weise geändert, wie Verzögerungen im Kampf versteckt werden, und ich hoffe, dass sie dadurch etwas reibungsloser werden. <br><br><h3>  Mehrbenutzer-Megapack - Technische Details </h3><br>  In einfachen Worten funktioniert der Multiplayer im Spiel wie folgt: Alle Clients simulieren den Status des Spiels und empfangen und senden nur die Eingaben des Spielers (sogenannte „Eingabeaktionen“, <i>Eingabeaktionen</i> ).  Die Hauptaufgabe des Servers besteht darin, <i>Eingabeaktionen</i> zu übertragen und zu steuern, dass alle Clients dieselben Aktionen in einem Zyklus ausführen.  Lesen Sie mehr dazu in der Post <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FFF-149</a> . <br><br>  Da der Server Entscheidungen darüber treffen muss, welche Aktionen ausgeführt werden sollen, bewegen sich die Aktionen des Spielers auf diesem Pfad: Aktion des Spielers -&gt; Spielclient -&gt; Netzwerk -&gt; Server -&gt; Netzwerk -&gt; Spielclient.  Dies bedeutet, dass die Aktion jedes Spielers erst ausgeführt wird, nachdem er einen Hin- und Rückweg durch das Netzwerk gemacht hat.  Aus diesem Grund scheint das Spiel furchtbar langsam zu sein, so dass fast unmittelbar nach dem Erscheinen des Multiplayers im Spiel ein Mechanismus zum Verbergen von Verzögerungen eingeführt wurde.  Das Ausblenden einer Verzögerung imitiert die Eingabe eines Spielers, ohne die Aktionen anderer Spieler und Serverentscheidungen zu berücksichtigen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/2f/ui/8u2fuieagsu2fokkbdny-hxi1cc.png"></div><br>  Factorio hat einen Spielstatus namens Spielstatus - dies ist der vollständige Status der Karte, des Spielers, der Entitäten und aller anderen Elemente.  Es wird in allen Clients basierend auf den vom Server empfangenen Aktionen deterministisch simuliert.  Der Spielstatus ist heilig, und wenn er sich jemals vom Server oder einem anderen Client unterscheidet, erfolgt eine Desynchronisierung. <br><br>  Zusätzlich zum <i>Spielstatus</i> haben wir einen <i>Latenzstatus</i> .  Es enthält eine kleine Teilmenge des Grundzustands.  <i>Der Latenzstatus ist</i> nicht heilig und zeigt lediglich ein Bild davon, wie der Status des Spiels in Zukunft aussehen wird, basierend auf den vom Spieler eingeführten <i>Eingabeaktionen</i> . <br><br>  Dazu speichern wir eine Kopie der erstellten <i>Eingabeaktionen</i> in der Verzögerungswarteschlange. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gf/m4/bo/gfm4bo81-iluah40eus3cxjxvjm.png"></div><br>  Das heißt, am Ende des Prozesses auf der Client-Seite sieht das Bild ungefähr so ​​aus: <br><br><ol><li>  Wenden Sie die <i>Eingabeaktionen</i> aller Spieler auf den <i>Spielstatus an,</i> da diese Eingabeaktionen vom Server empfangen wurden. </li><li>  Wir entfernen alle <i>Eingabeaktionen</i> aus der Warteschlange der Verzögerungen, die laut Server bereits auf den Spielstatus angewendet wurden. </li><li>  Löschen Sie den <i>Latenzstatus</i> und setzen Sie ihn zurück, sodass er genauso aussieht wie der <i>Spielstatus</i> . </li><li>  Wenden Sie alle Aktionen aus der Verzögerungswarteschlange auf den <i>Latenzstatus an</i> . </li><li>  Basierend auf den Daten aus Spielstatus und <i>Latenzstatus</i> rendern <i>wir</i> das Spiel für den Spieler. </li></ol><br>  All dies wiederholt sich in jedem Takt. <br><br>  Zu kompliziert?  Entspann dich nicht, das ist noch nicht alles.  Um die unzuverlässigen Internetverbindungen auszugleichen, haben wir zwei Mechanismen geschaffen: <br><br><ul><li>  Verpasste Ticks: Wenn der Server entscheidet, dass die <i>Eingabeaktionen im Spieltakt ausgeführt</i> werden, wird er nicht warten, wenn er die <i>Eingabeaktionen</i> einiger Spieler nicht erhält (z. B. aufgrund der erhöhten Verzögerung), sondern diesem Client mitteilen, dass ich dies nicht berücksichtigt habe Ich werde versuchen, Ihre <i>Eingabeaktionen</i> zur nächsten Kennzahl hinzuzufügen. "  Dies geschieht, damit aufgrund von Problemen mit der Verbindung (oder mit dem Computer) eines Spielers die Kartenaktualisierung für alle anderen nicht langsamer wird.  Es ist erwähnenswert, dass <i>Eingabeaktionen</i> nicht ignoriert, sondern einfach verschoben werden. </li><li>  Roundtrip-Verzögerung: Der Server versucht zu erraten, wie hoch die Roundtrip-Verzögerung zwischen Client und Server für jeden Client ist.  Bei Bedarf bespricht er alle 5 Sekunden mit dem Client eine neue Verzögerung (abhängig davon, wie sich die Verbindung in der Vergangenheit verhalten hat) und erhöht oder verringert dementsprechend die Verzögerung beim Hin- und Herübertragen von Daten. </li></ul><br>  Diese Mechanismen sind an sich recht einfach, aber wenn sie zusammen verwendet werden (was häufig bei Verbindungsproblemen auftritt), wird die Logik des Codes schwierig zu verwalten und es gibt eine Reihe von Grenzfällen.  Wenn diese Mechanismen ins <i>Spiel kommen</i> , müssen der Server und die Verzögerungswarteschlange außerdem eine spezielle <i>Eingabeaktion</i> namens <i>StopMovementInTheNextTick</i> korrekt implementieren.  Aus diesem Grund läuft der Charakter bei Verbindungsproblemen nicht von alleine (z. B. unter dem Zug). <br><br>  Jetzt müssen Sie Ihnen erklären, wie die Entitätsauswahl funktioniert.  Eine der Arten der übergebenen <i>Eingabeaktion</i> ist die Änderung des Status der Entitätsauswahl.  Es sagt jedem, über welcher Entität der Spieler schwebte.  Wie Sie verstehen, ist dies eine der häufigsten Eingabeaktionen, die von Clients gesendet werden. Um Bandbreite zu sparen, haben wir sie so optimiert, dass sie so wenig Platz wie möglich beansprucht.  Dies wird wie folgt implementiert: Bei der Auswahl jeder Entität behält das Spiel anstelle der absoluten, hochpräzisen Koordinaten der Karte einen relativen Versatz mit geringem Strom gegenüber der vorherigen Auswahl bei.  Dies funktioniert gut, da die Mausauswahl normalerweise sehr nahe an der vorherigen Auswahl erfolgt.  Aus diesem Grund ergeben sich zwei wichtige Anforderungen: <i>Eingabeaktionen</i> dürfen niemals übersprungen und in der richtigen Reihenfolge ausgeführt werden.  Diese Anforderungen sind für den <i>Spielstatus</i> erfüllt.  Da es jedoch die Aufgabe des <i>Latenzzustands</i> ist, für den Spieler „gut genug auszusehen“, sind sie im Zustand der Verzögerungen nicht zufrieden.  <i>Der Latenzstatus</i> berücksichtigt nicht <a href="">viele Grenzfälle,</a> die mit Überspringzyklen und sich ändernden Umlaufverzögerungen verbunden sind. <br><br>  Sie können bereits erraten, wohin alles geht.  Schließlich beginnen wir, die Ursachen des Megapackage-Problems zu erkennen.  Die Wurzel des Problems besteht darin, dass bei der Entscheidung, ob die Aktion der Auswahländerung bestanden werden soll, die Entitätsauswahllogik auf dem <i>Latenzstatus</i> beruht und dieser Status nicht immer die richtigen Informationen enthält.  Daher wird ein Megapaket wie folgt generiert: <br><br><ol><li>  Der Player hat ein Verbindungsproblem. </li><li>  Die Mechanismen zum Überspringen von Uhren und zum Regulieren der Umlaufverzögerung kommen ins Spiel. </li><li>  Verzögerungen im Warteschlangenstatus berücksichtigen diese Mechanismen nicht.  Dies führt dazu, dass einige Aktionen vorzeitig gelöscht oder in der falschen Reihenfolge ausgeführt werden, was zu einem falschen <i>Latenzstatus führt</i> . </li><li>  Der Spieler hat ein Problem mit der Verbindung und simuliert, um den Server einzuholen, bis zu 400 Taktzyklen. </li><li>  In jedem Taktzyklus wird eine neue Aktion generiert, die die Auswahl einer Entität ändert, und zum Senden an den Server vorbereitet. </li><li>  Der Client sendet ein Megapaket mit mehr als 400 Änderungen bei der Auswahl der Entitäten an den Server (und bei anderen Aktionen: Der Zustand des Schießens, Gehens usw. litt ebenfalls unter diesem Problem). </li><li>  Der Server empfängt 400 Eingabeaktionen.  Da er keine einzelne Eingabeaktion überspringen darf, weist er alle Clients an, diese Aktionen auszuführen, und sendet sie über das Netzwerk. </li></ol><br>  Die Ironie ist, dass ein Mechanismus zum Einsparen von Kanalbandbreite infolgedessen riesige Netzwerkpakete erzeugt hat. <br><br>  Wir haben dieses Problem gelöst, indem wir alle Grenzfälle der Aktualisierung und Unterstützung der Warteschlange für Verzögerungen korrigiert haben.  Obwohl es eine Weile gedauert hat, hat es sich am Ende gelohnt, alles richtig zu implementieren und sich nicht auf schnelle Hacks zu verlassen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de466135/">https://habr.com/ru/post/de466135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de466113/index.html">Definieren der Textcodierung in PHP anstelle von mb_detect_encoding</a></li>
<li><a href="../de466121/index.html">Klangerzeugung auf AVR-Mikrocontrollern mithilfe der Wavetable-Methode mit Polyphonieunterstützung</a></li>
<li><a href="../de466123/index.html">Wachstum. Gewicht. Drei Nachbarn</a></li>
<li><a href="../de466127/index.html">KKW Kola oder am Reaktor stehen</a></li>
<li><a href="../de466129/index.html">Effizienz des Transports mit Benzin, Batterien und Wasserstoff</a></li>
<li><a href="../de466137/index.html">System.IO. Pipelines - ein wenig bekanntes Tool für Liebhaber hoher Leistung</a></li>
<li><a href="../de466139/index.html">Angewandte Technologie auf den Ruinen des Blockchain-Fiebers oder den praktischen Vorteilen der Ressourcenzuweisung</a></li>
<li><a href="../de466143/index.html">Wie haben wir Kartoncode oder die Scratch-Version des Brettspiels Golem Battle erstellt?</a></li>
<li><a href="../de466147/index.html">Reactive Data Display Manager. Einführung</a></li>
<li><a href="../de466149/index.html">Erstellen eines Konnektorsymbols mit „dynamischem“ Text in OrCAD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>