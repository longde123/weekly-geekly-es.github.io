<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôåüèæ üò£ üë©üèª‚Äçüî¨ Servidor simulado para la automatizaci√≥n de pruebas m√≥viles üéì üà∂ üì®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mientras trabajaba en el √∫ltimo proyecto, me enfrent√© a probar una aplicaci√≥n m√≥vil conectada al nivel de l√≥gica de negocios con varios servicios de t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor simulado para la automatizaci√≥n de pruebas m√≥viles</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/maxilect/blog/430530/">  Mientras trabajaba en el √∫ltimo proyecto, me enfrent√© a probar una aplicaci√≥n m√≥vil conectada al nivel de l√≥gica de negocios con varios servicios de terceros.  Sin embargo, probar estos servicios no era parte de mi tarea, los problemas con su API bloquearon el trabajo de la aplicaci√≥n en s√≠ misma: las pruebas cayeron no debido a problemas en el interior, sino debido a la inoperancia de la API, incluso antes de llegar a la verificaci√≥n de la funcionalidad necesaria. <br><br>  Tradicionalmente, los soportes se utilizan para probar tales aplicaciones.  Pero no siempre funcionan normalmente, y esto interfiere con el trabajo.  Como soluci√≥n alternativa, utilic√© moki.  Quiero hablar sobre este camino espinoso hoy. <br><br><img src="https://habrastorage.org/webt/kn/uf/vw/knufvwqxahfwy6zkqxrkgeirrga.jpeg" alt="imagen"><br><a name="habracut"></a><br>  Para no tocar el c√≥digo de un proyecto real (bajo NDA), para mayor claridad, cre√© un cliente REST simple para Android, que permite enviar solicitudes HTTP (GET / POST) a una determinada direcci√≥n con los par√°metros que necesito.  Lo probaremos <br>  El c√≥digo de aplicaci√≥n del cliente, los despachadores y las pruebas se pueden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descargar desde GitLab</a> . <br><br><h2>  Cuales son las opciones? </h2><br>  Hubo dos enfoques para burlarse en mi caso: <br><br><ul><li>  implementar un servidor simulado en la nube o en una m√°quina remota (si estamos hablando de desarrollos confidenciales que no pueden llevarse a la nube); </li><li>  inicie el servidor simulado localmente, directamente en el tel√©fono en el que se est√° probando la aplicaci√≥n m√≥vil. </li></ul><br>  La primera opci√≥n no es muy diferente del banco de pruebas.  De hecho, es posible asignar una estaci√≥n de trabajo en la red para el servidor simulado, pero deber√° ser compatible, como cualquier banco de pruebas.  Y aqu√≠ es necesario encontrar las principales trampas de este enfoque.  La estaci√≥n de trabajo remota ha muerto, dej√≥ de responder, algo ha cambiado: debe monitorear, cambiar la configuraci√≥n, es decir  haga lo mismo que con el apoyo de un banco de pruebas regular.  No podemos corregir la situaci√≥n por nosotros mismos, y ciertamente tomar√° m√°s tiempo que cualquier manipulaci√≥n local.  Entonces, espec√≠ficamente en mi proyecto, fue m√°s conveniente aumentar el servidor simulado localmente. <br><br><h2>  Elegir un servidor simulado </h2><br>  Hay muchas herramientas diferentes.  Trat√© de trabajar con varios y en casi todos me encontr√© con ciertos problemas: <br><br><ul><li>  <b>Mock-server</b> , <b>wiremock</b> : dos servidores simulados que no podr√≠a ejecutar normalmente en Android.  Como todos los experimentos se llevaron a cabo como parte de un proyecto en vivo, el tiempo de elecci√≥n fue limitado.  Despu√©s de cavar con ellos un par de d√≠as, dej√© de intentarlo. </li><li>  <b>Restmock</b> es un contenedor sobre <b>okhttpmockwebserver</b> , que se discutir√° con m√°s detalle m√°s adelante.  Se ve√≠a bien, comenz√≥, pero el desarrollador de este contenedor ocult√≥ "bajo el cap√≥" la capacidad de establecer la direcci√≥n IP y el puerto del servidor simulado, y para m√≠ fue cr√≠tico.  Restmock comenz√≥ en alg√∫n puerto aleatorio.  Al hurgar en el c√≥digo, vi que cuando el servidor se inicializaba, el desarrollador usaba un m√©todo que configuraba el puerto al azar si no lo recib√≠a en la entrada.  En principio, uno podr√≠a heredar de este m√©todo, pero el problema estaba en el constructor privado.  Como resultado, rechac√© el envoltorio. </li><li>  <b>Okhttpmockwebserver</b> : despu√©s de probar diferentes herramientas, me detuve en el servidor simulado, que normalmente se juntaba y comenzaba localmente en el dispositivo. </li></ul><br><h2>  Analizamos el principio del trabajo. </h2><br>  La versi√≥n actual de okhttpmockwebserver le permite implementar varios escenarios de trabajo: <br><br><ul><li>  <b>Cola de respuestas</b> .  Las respuestas falsas del servidor se agregan a la cola FIFO.  No importa a qu√© API y qu√© ruta acceder√©, el servidor simulado se turnar√° para lanzar mensajes en esta cola. </li><li> <b>El despachador le</b> permite crear reglas que determinan qu√© respuesta dar.  Supongamos que una solicitud proviene de una URL que contiene una ruta, por ejemplo / get-login /.  En este servidor / get-login / simulacro y da una respuesta √∫nica y predefinida. </li><li>  <b>Verificador de solicitud</b> .  Seg√∫n el escenario anterior, puedo verificar las solicitudes que env√≠a la aplicaci√≥n (que en las condiciones dadas, una solicitud con ciertos par√°metros realmente se va).  Sin embargo, la respuesta no es importante, ya que est√° determinada por c√≥mo funciona la API.  Este script implementa el verificador de solicitud. </li></ul><br>  Considere cada uno de los escenarios con m√°s detalle. <br><br><h3>  Cola de respuesta </h3><br>  La implementaci√≥n m√°s simple del servidor simulado es la cola de respuesta.  Antes de la prueba, determino la direcci√≥n y el puerto donde se implementar√° el servidor simulado, as√≠ como el hecho de que funcionar√° seg√∫n el principio de una cola de mensajes: FIFO (primero en entrar, primero en salir). <br><br>  A continuaci√≥n, ejecute el servidor simulado. <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Before</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-class">() </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>)) mockServer.start(ip, port) } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queueTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>) returnFromResponseActivity() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>) returnFromResponseActivity() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>) returnFromResponseActivity() } }</code> </pre> <br>  Las pruebas se escriben utilizando el marco Espresso, dise√±ado para realizar acciones en aplicaciones m√≥viles.  En este ejemplo, selecciono los tipos de solicitud y los env√≠o por turno. <br>  Despu√©s de comenzar la prueba, el servidor simulado le da respuestas de acuerdo con la cola prescrita, y la prueba pasa sin errores. <br><br><h3>  Implementaci√≥n del despachador </h3><br>  Un despachador es un conjunto de reglas por las cuales opera un servidor simulado.  Por conveniencia, cre√© tres despachadores diferentes: SimpleDispatcher, OtherParamsDispatcher y ListingDispatcher. <br><br><h4>  Despachador simple </h4><br>  Okhttpmockwebserver proporciona la clase <code>Dispatcher()</code> para implementar el despachador.  Puede heredar de √©l anulando la funci√≥n de <code>dispatch</code> a su manera. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"GET"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) } }</code> </pre><br>  La l√≥gica en este ejemplo es simple: si llega un GET, devuelvo un mensaje de que se trata de una solicitud GET.  Si es POST, devuelvo un mensaje sobre la solicitud POST.  En otras situaciones, devuelvo una solicitud vac√≠a. <br><br>  <code>SimpleDispatcher</code> aparece en la prueba, un objeto de la clase <code>SimpleDispatcher</code> , que describ√≠ anteriormente.  Adem√°s, como en el ejemplo anterior, se lanza el servidor simulado, solo que esta vez se indica un tipo de regla para trabajar con este servidor simulado: el mismo despachador. <br><br>  Las fuentes de prueba con <code>SimpleDispatcher</code> se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en el repositorio</a> . <br><br><h4>  OtherParamsDispatcher </h4><br>  Al anular la funci√≥n de <code>dispatch</code> , puedo alejarme de otros par√°metros de solicitud para enviar respuestas: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OtherParamsDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> when { request.path.contains(<span class="hljs-string"><span class="hljs-string">"?queryKey=value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request with query parameter queryKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request with body parameter bodyKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.headers.toString().contains(<span class="hljs-string"><span class="hljs-string">"header: value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was some request with header equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ Wrong response }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } } }</code> </pre><br>  En este caso, demuestro varias opciones para las condiciones. <br><br>  En primer lugar, puede pasar par√°metros a la API en la barra de direcciones.  Por lo tanto, puedo poner una condici√≥n en la entrada de cualquier paquete en la ruta, por ejemplo, <code>‚Äú?queryKey=value‚Äù</code> . <br>  En segundo lugar, esta clase le permite acceder al cuerpo del cuerpo de las solicitudes POST o PUT.  Por ejemplo, puede usar <code>contains</code> ejecutando primero <code>toString()</code> .  En mi ejemplo, la condici√≥n se activa cuando <code>‚ÄúbodyKey‚Äù:‚Äùvalue‚Äù</code> una solicitud POST que contiene <code>‚ÄúbodyKey‚Äù:‚Äùvalue‚Äù</code> .  Del mismo modo, puedo validar el <code>header : value</code> la solicitud ( <code>header : value</code> ). <br><br>  Para ver ejemplos de pruebas, recomiendo consultar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el repositorio</a> . <br><br><h4>  ListingDispatcher </h4><br>  Si es necesario, puede implementar una l√≥gica m√°s compleja: ListingDispatcher.  Del mismo modo, anulo la funci√≥n de <code>dispatch</code> .  Sin embargo, ahora mismo en la clase configur√© el conjunto predeterminado de <code>stubsList</code> ( <code>stubsList</code> ) - mok para diferentes ocasiones. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stubsList: ArrayList&lt;RequestClass&gt; = defaultRequests() <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { stubsList.first { it.matcher(request.path, request.body.toString()) }.response() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: NoSuchElementException) { Log.e(<span class="hljs-string"><span class="hljs-string">"Unexisting request path ="</span></span>, request.path) MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">404</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultRequests</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: ArrayList&lt;RequestClass&gt; </span></span>{ val allStubs = ArrayList&lt;RequestClass&gt;() allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/get"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /get url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and body contains bodyParam:value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allStubs } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ stubsList.add(stub) } }</code> </pre><br>  Para hacer esto, cre√© una clase abierta <code>RequestClass</code> , todos los campos est√°n vac√≠os por defecto.  Para esta clase, defino una funci√≥n de <code>response</code> que crea un objeto <code>MockResponse</code> (que devuelve una respuesta 200 o alg√∫n otro texto de <code>responseText</code> ) y una funci√≥n de <code>matcher</code> que devuelve <code>true</code> o <code>false</code> . <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">open class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val path:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val query: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val body:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val responseText: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code: Int = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">200</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: MockResponse </span></span>= MockResponse() .setResponseCode(code) .setBody(responseText) <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(apiCall: String, apiBody: String)</span></span></span><span class="hljs-function">: Boolean </span></span>= apiCall.startsWith(path)&amp;&amp;apiCall.contains(query)&amp;&amp;apiBody.contains(body) }</code> </pre><br>  Como resultado, puedo construir combinaciones de condiciones m√°s complejas para los talones.  Este dise√±o me pareci√≥ m√°s flexible, aunque el principio en su n√∫cleo es muy simple. <br><br>  Pero, sobre todo en este enfoque, me gust√≥ poder sustituir algunos stubs sobre la marcha, si es necesario cambiar algo en la respuesta del servidor simulado en una prueba.  Al probar proyectos grandes, este problema surge con bastante frecuencia, por ejemplo, al verificar algunos escenarios espec√≠ficos. <br>  El reemplazo se puede hacer de la siguiente manera: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) }</code> </pre><br>  Con esta implementaci√≥n del despachador, las pruebas siguen siendo simples.  Tambi√©n inicio el servidor simulado, solo selecciono <code>ListingDispatcher</code> . <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcherTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dispatcher</span></span></span><span class="hljs-class"> </span></span>= ListingDispatcher() <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.setDispatcher(dispatcher) mockServer.start(ip, port) } . . . }</code> </pre><br>  Por el bien del experimento, reemplac√© el trozo con POST: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postReplacedStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyParam"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) replacePostStub() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, params = params) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br>  Para hacer esto, llam√≥ a la funci√≥n <code>replacePostStub</code> desde un <code>dispatcher</code> regular y agreg√≥ una nueva <code>response</code> . <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacePostStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.replaceMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br>  En la prueba anterior, verifico que el trozo ha sido reemplazado. <br>  Luego agregu√© un nuevo c√≥digo auxiliar, que no estaba predeterminado. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNewStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ addSomeStub() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/some_specific_url"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSomeStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.addMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/some_specific_url"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br><h3>  Verificador de solicitud </h3><br>  El √∫ltimo caso, el verificador de solicitudes, no proporciona espionaje, pero verifica las solicitudes enviadas por la aplicaci√≥n.  Para hacer esto, acabo de iniciar el servidor simulado implementando el despachador para que la aplicaci√≥n devuelva al menos algo. <br>  Al enviar una solicitud de una prueba, llega al servidor simulado.  A trav√©s de √©l, puedo acceder a los par√°metros de solicitud usando <code>takeRequest()</code> . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestVerifierTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyKey"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) val headers: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"header"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, headers = headers, params = params) val request = mockServer.takeRequest() assertEquals(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, request.method) assertEquals(<span class="hljs-string"><span class="hljs-string">"value"</span></span>, request.getHeader(<span class="hljs-string"><span class="hljs-string">"header"</span></span>)) assertTrue(request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>)) assertTrue(request.path.startsWith(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>)) }</code> </pre><br>  Arriba, mostr√© la prueba con un simple ejemplo.  Se puede usar exactamente el mismo enfoque para JSON complejo, incluso para verificar toda la estructura de la solicitud (puede comparar a nivel JSON o analizar JSON en objetos y verificar la igualdad a nivel de objeto). <br><br><h2>  Resumen </h2><br>  En general, me gust√≥ la herramienta (okhttpmockwebserver), y la uso en un proyecto grande.  Por supuesto, hay algunas peque√±as cosas que me gustar√≠a cambiar. <br>  Por ejemplo, no me gusta que deba llamar a la direcci√≥n local (localhost: 8080 en nuestro ejemplo) en las configuraciones de su aplicaci√≥n;  tal vez todav√≠a pueda encontrar una manera de configurar todo para que el servidor falso responda al intentar enviar una solicitud a cualquier direcci√≥n. <br>  Adem√°s, no tengo la capacidad de redirigir solicitudes, cuando el servidor simulado env√≠a una solicitud adicional, si no tiene un c√≥digo auxiliar adecuado para ello.  No existe tal enfoque en este servidor simulado.  Sin embargo, ni siquiera lleg√≥ a su implementaci√≥n, ya que en este momento el proyecto de "combate" no tiene esa tarea. <br><br>  Autor del art√≠culo: Ruslan Abdulin <br><br>  PD: publicamos nuestros art√≠culos en varios sitios de Runet.  Suscr√≠base a nuestras p√°ginas en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">VK</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FB</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Telegram-channel</a> para conocer todas nuestras publicaciones y otras noticias de Maxilect. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430530/">https://habr.com/ru/post/es430530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430520/index.html">Presentamos Spring Data MongoDB</a></li>
<li><a href="../es430522/index.html">¬øNecesitas una cultura corporativa en TI? Confesi√≥n del gerente de marca del estudio Krasnodar Plarium</a></li>
<li><a href="../es430524/index.html">Arquitectura de red neuronal</a></li>
<li><a href="../es430526/index.html">M√°quinas tragamonedas: de d√≥nde vinieron en la URSS y c√≥mo est√°n organizadas</a></li>
<li><a href="../es430528/index.html">Programaci√≥n con PyUSB 1.0</a></li>
<li><a href="../es430532/index.html">Seguridad en aplicaciones iOS</a></li>
<li><a href="../es430534/index.html">Crear una plantilla para Zabbix usando el SDK Trassir de DVR como ejemplo</a></li>
<li><a href="../es430536/index.html">Dise√±o de funciones de ventana sumadas en una unidad con un nivel dado de superposici√≥n</a></li>
<li><a href="../es430538/index.html">¬øLees Scaladoc para m√©todos de recolecci√≥n "obvios"? O por qu√© la pereza no siempre es buena</a></li>
<li><a href="../es430542/index.html">Seminario web abierto "Infraestructura como c√≥digo"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>