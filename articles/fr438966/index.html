<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèΩ ‚õé üò® Historique des errances de la documentation Haproxy, ou ce qu'il faut rechercher lors de sa configuration üå©Ô∏è üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üçá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour encore! 

 La derni√®re fois, nous avons parl√© de choisir un outil dans Ostrovok.ru pour r√©soudre le probl√®me de proxy d'un grand nombre de dem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Historique des errances de la documentation Haproxy, ou ce qu'il faut rechercher lors de sa configuration</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/438966/">  Bonjour encore! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La derni√®re fois,</a> nous avons parl√© de choisir un outil dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ostrovok.ru</a> pour r√©soudre le probl√®me de proxy d'un grand nombre de demandes vers des services externes, sans mettre personne en m√™me temps.  L'article s'est termin√© par une s√©lection de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Haproxy</a> .  Aujourd'hui, je partagerai les nuances auxquelles j'ai d√ª faire face lors de l'utilisation de cette solution. <br><br><img src="https://habrastorage.org/webt/ns/mz/sb/nsmzsbtu2c1rgib_avecisgyrlk.jpeg"><br><a name="habracut"></a><br><h3>  Configuration haproxy </h3><br>  La premi√®re difficult√© √©tait que l'option <code>maxconn</code> est diff√©rente selon le contexte: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">maxconn (optimisation des performances);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">maxconn (options de liaison);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">maxconn (options serveur et serveur par d√©faut).</a> </li></ul><br>  Par habitude, je n'ai r√©gl√© que la premi√®re option ( <code>performance tuning</code> ).  Voici ce que dit la documentation sur cette option: <br><blockquote>  D√©finit le nombre maximal de connexions simultan√©es par processus √† &lt;num√©ro&gt;.  Il <br>  est √©quivalent √† l'argument de ligne de commande "-n".  Les procurations cesseront d'accepter <br>  connexions lorsque cette limite est atteinte. <br></blockquote><br>  Il semblerait que ce qui est n√©cessaire.  Cependant, lorsque je suis tomb√© sur le fait que les nouvelles connexions au proxy ne se sont pas imm√©diatement d√©roul√©es, j'ai commenc√© √† lire la documentation plus attentivement, et l√† j'ai d√©j√† trouv√© le deuxi√®me param√®tre ( <code>bind options</code> ): <br><blockquote>  Limite les sockets √† ce nombre de connexions simultan√©es.  √âtranger <br>  les connexions resteront dans le carnet de commandes du syst√®me jusqu'√† ce qu'une connexion soit √©tablie. <br>  lib√©r√©.  Si non sp√©cifi√©, la limite sera la m√™me que le maxconn du frontend. <br></blockquote><br>  Alors, <code>frontends maxconn</code> y, puis recherchons les <code>frontends maxconn</code> : <br><blockquote>  Fixer le nombre maximum de connexions simultan√©es sur un frontend <br>  ... <br>  Par d√©faut, cette valeur est d√©finie sur 2000. <br></blockquote><br>  Super, ce dont vous avez besoin.  Ajoutez √† la configuration: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 ... defaults mode http maxconn 524288</code> </pre><br>  Le gag suivant √©tait que Haproxy est un thread unique.  Je suis tr√®s habitu√© au mod√®le de Nginx, donc cette nuance m'a toujours d√©prim√©.  Mais ne d√©sesp√©rez pas - <i>Willy Tarreau</i> ( <i>d√©veloppeur Haproxy</i> ) a compris ce qu'il faisait, il a donc ajout√© l'option - <code>nbproc</code> . <br><br>  Cependant, directement dans la documentation, il est dit: <br><blockquote>  UTILISATION DE PLUSIEURS PROCESSUS <br>  EST PLUS DIFFICILE √Ä D√âBOGIR ET EST VRAIMENT D√âCOURAG√â. <br></blockquote>  Cette option peut vraiment vous faire mal √† la t√™te si vous avez besoin de: <br><br><ul><li>  limiter le nombre de requ√™tes / connexions aux serveurs (puisque vous aurez d√©j√† non pas un processus avec un compteur, mais plusieurs processus, et chacun a son propre compteur); </li><li>  Collecter des statistiques √† partir du socket de gestion Haproxy </li><li>  activer / d√©sactiver les backends via la prise de contr√¥le; </li><li>  ... peut-√™tre autre chose.  ¬Ø \ _ („ÉÑ) _ / ¬Ø </li></ul><br>  N√©anmoins, les dieux nous ont donn√© des processeurs multic≈ìurs, donc je voudrais les utiliser au maximum.  Dans mon cas, il y avait quatre c≈ìurs dans deux c≈ìurs physiques.  Pour Haproxy, j'ai s√©lectionn√© le premier noyau, et il ressemblait √† ceci: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">nbproc</span></span> 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3</code> </pre><br>  En utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cpu-map,</a> nous lions les processus Haproxy √† un noyau sp√©cifique.  Le planificateur du syst√®me d'exploitation n'a plus besoin de penser √† l'endroit o√π planifier Haproxy, ce qui maintient le <code>content switch</code> frais et le cache du processeur au chaud. <br><br><h4>  Il existe de nombreux tampons, mais pas dans notre cas </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tune.bufsize</a> - dans notre cas, il n'√©tait pas n√©cessaire de l'ex√©cuter, mais si vous avez des erreurs avec le code <code>400 (Bad Request)</code> , alors c'est probablement votre cas. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhhYDXxhXdO6vh6F4FN8qwJm4ECKEA#tune.">tune.http.cookielen</a> - si vous distribuez de gros cookies aux utilisateurs, alors, afin d'√©viter des dommages lors de la transmission sur le r√©seau, il peut √™tre judicieux d'augmenter √©galement ce tampon. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhhYDXxhXdO6vh6F4FN8qwJm4ECKEA#tune.">tune.http.maxhdr</a> est une autre source possible de 400 codes de r√©ponse si vous avez trop d'en-t√™tes. </li></ul><br><h4>  Consid√©rez maintenant les choses de niveau inf√©rieur </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tune.rcvbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tune.rcvbuf.server</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tune.sndbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tune.sndbuf.server</a> - la documentation indique ce qui suit: <br><blockquote>  Il ne devrait normalement jamais √™tre d√©fini, et la taille par d√©faut (0) permet au noyau de r√©gler automatiquement cette valeur en fonction de la quantit√© de m√©moire disponible. <br></blockquote><br>  Mais pour moi, l'√©vidence est meilleure que l'implicite, j'ai donc forc√© les valeurs de ces options pour √™tre s√ªr de demain. <br><br>  Et un autre param√®tre qui n'est pas li√© aux tampons, mais tr√®s important est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tune.maxaccept</a> . <br><blockquote>  D√©finit le nombre maximal de connexions cons√©cutives qu'un processus peut accepter dans un <br>  ligne avant de passer √† un autre travail.  En mode process unique, des nombres plus √©lev√©s <br>  donner de meilleures performances √† des taux de connexion √©lev√©s.  Cependant en multi-processus <br>  modes, il est g√©n√©ralement pr√©f√©rable de garder un peu d‚Äô√©quit√© entre les processus <br>  augmenter les performances. <br></blockquote><br>  Dans notre cas, un grand nombre de demandes de proxy sont g√©n√©r√©es, j'ai donc augment√© cette valeur pour accepter plus de demandes √† la fois.  N√©anmoins, comme le dit la documentation, il vaut la peine de tester qu'en mode multi-thread la charge est r√©partie aussi uniform√©ment que possible entre les processus. <br><br>  Tous les param√®tres ensemble: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">tune</span></span>.bufsize 16384 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432</code> </pre><br><h4>  Ce qui n'arrive jamais, ce sont les temps morts.  Que ferions-nous sans eux? </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">timeout connect</a> - temps pour √©tablir une connexion avec le backend.  Si la connexion avec le backend n'est pas tr√®s bonne, il est pr√©f√©rable de la d√©sactiver d'ici ce d√©lai jusqu'√† ce que le r√©seau revienne √† la normale. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">timeout client</a> - timeout pour la transmission des premiers octets de donn√©es.  Cela permet de d√©connecter ceux qui font des demandes ¬´en r√©serve¬ª. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Kulstory sur le client HTTP dans Go</b> <div class="spoiler_text">  Go a un client HTTP r√©gulier qui a la capacit√© de conserver un pool de connexions aux serveurs.  Une histoire int√©ressante s'est donc produite, √† laquelle le d√©lai d'attente et le pool de connexions d√©crits ci-dessus dans le client HTTP ont pris part.  Une fois qu'un d√©veloppeur s'est plaint qu'il avait p√©riodiquement 408 erreurs d'un proxy.  Nous avons examin√© le code client et y avons vu la logique suivante: <br><br><ul><li>  Nous essayons de prendre une connexion √©tablie gratuitement √† partir de la piscine; </li><li>  si cela ne fonctionne pas, lancez l'installation d'une nouvelle connexion dans goroutine; </li><li>  v√©rifiez √† nouveau la piscine; </li><li>  s'il y en a dans la piscine - nous le prenons et mettons le nouveau dans la piscine, sinon - utilisez le nouveau. </li></ul><br>  Vous avez d√©j√† compris ce qu'est le sel? <br><br>  Si le client a √©tabli une nouvelle connexion mais ne l'a pas utilis√©e, le serveur la ferme au bout de cinq secondes et l'affaire est termin√©e.  Le client intercepte cela uniquement lorsqu'il obtient d√©j√† la connexion du pool et essaie de l'utiliser.  Il convient de garder cela √† l'esprit. <br></div></div><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">timeout server</a> - le temps maximum pour attendre une r√©ponse du serveur. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">timeout client-fin</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">timeout server-fin</a> - nous nous prot√©geons ici des connexions semi-ferm√©es afin de ne pas les accumuler dans la table du syst√®me d'exploitation. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhhYDXxhXdO6vh6F4FN8qwJm4ECKEA#timeout%20">timeout http-request</a> est l'un des d√©lais d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhhYDXxhXdO6vh6F4FN8qwJm4ECKEA#timeout%20">expiration</a> les plus appropri√©s.  Vous permet de couper les clients lents qui ne peuvent pas faire de demande HTTP dans le temps imparti pour eux. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhhYDXxhXdO6vh6F4FN8qwJm4ECKEA#timeout%20">timeout http-keep-alive</a> - sp√©cifiquement dans notre cas, si une connexion <code>keep-alive</code> se bloque sans demandes pendant plus de 50 secondes, alors tr√®s probablement quelque chose s'est mal pass√© et la connexion peut √™tre ferm√©e, lib√©rant ainsi de la m√©moire pour quelque chose de nouveau la lumi√®re. </li></ul><br>  Tous les temps morts ensemble: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">defaults</span></span> mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s</code> </pre><br><h4>  Journalisation  Pourquoi est-ce si difficile? </h4><br>  Comme je l'ai √©crit plus t√¥t, le plus souvent dans mes d√©cisions j'utilise Nginx, donc je suis g√¢t√© par sa syntaxe et la simplicit√© de modification des formats de journaux.  J'ai particuli√®rement aim√© la fonctionnalit√© killer - formater les journaux sous forme de json, puis les analyser avec n'importe quelle biblioth√®que standard. <br><br>  Qu'avons-nous chez Haproxy?  Il existe une telle opportunit√©, vous seul pouvez √©crire exclusivement dans syslog, et la syntaxe de configuration est l√©g√®rement plus enveloppante. <br>  Je vais vous donner un exemple de configuration avec des commentaires: <br><br><pre> <code class="apache hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,     ,    (   # error.log  nginx) log 127.0.0.1:2514 len 8192 local1 notice emerg #    -  access.log log 127.0.0.1:2514 len 8192 local7 info</span></span></code> </pre><br>  Une douleur particuli√®re est caus√©e par de tels moments: <br><ul><li>  noms de variables courts, et en particulier leurs combinaisons comme% HU ou% fp </li><li>  le format ne peut pas √™tre divis√© en plusieurs lignes, vous devez donc √©crire footcloth sur une seule ligne.  difficile d'ajouter / supprimer des √©l√©ments nouveaux / inutiles </li><li>  pour que certaines variables fonctionnent, elles doivent √™tre explicitement d√©clar√©es via l'en-t√™te de demande de capture </li></ul><br>  Par cons√©quent, pour obtenir quelque chose d'int√©ressant, vous devez avoir un tel couvre-pied: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">log</span></span>-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}'</code> </pre><br><h4>  Eh bien, il semblerait, de petites choses, mais sympa </h4><br>  J'ai d√©crit le format du journal ci-dessus, mais pas si simple.  Pour y d√©poser certains √©l√©ments, tels que: <br><br><ul><li>  http_host </li><li>  http_referer, </li><li>  http_user_agent, </li></ul><br>  vous devez d'abord capturer ces donn√©es √† partir de la demande ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">capture</a> ) et les placer dans un tableau de valeurs captur√©es. <br><br>  Voici un exemple: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128</code> </pre><br>  En cons√©quence, nous pouvons d√©sormais acc√©der aux √©l√©ments dont nous avons besoin de cette fa√ßon: <br>  <code>%[capture.req.hdr(N)]</code> , o√π N est le num√©ro de s√©quence de la d√©finition du groupe de capture. <br>  Dans l'exemple ci-dessus, l'en-t√™te Host sera au num√©ro 0 et le User-Agent sera au num√©ro 2. <br><br>  Haproxy a une particularit√©: il r√©sout les adresses DNS des backends au d√©marrage et, s'il ne peut r√©soudre aucune des adresses, tombe la mort du brave. <br><br>  Dans notre cas, ce n'est pas tr√®s pratique, car il y a beaucoup de backends, nous ne les g√©rons pas, et il vaut mieux obtenir 503 de Haproxy que l'ensemble du serveur proxy refusera de d√©marrer √† cause d'un seul fournisseur.  L'option suivante nous aide avec ceci: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">init-addr</a> . <br><br>  Une ligne tir√©e directement de la documentation nous permet de passer en revue toutes les m√©thodes disponibles pour r√©soudre une adresse et, dans le cas d'un fichier, de simplement reporter cette question √† plus tard et de continuer: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">default</span></span>-server init-addr last,libc,none</code> </pre> <br>  Et enfin, mon pr√©f√©r√©: la s√©lection du backend. <br>  La syntaxe de la configuration de s√©lection du backend Haproxy est connue de tous: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">use_backend</span></span> &lt;backend1_name&gt; if &lt;condition1&gt; use_backend &lt;backend2_name&gt; if &lt;condition2&gt; default-backend &lt;backend3&gt;</code> </pre><br>  Mais bon mot, ce n'est pas tr√®s bien.  J'ai d√©j√† d√©crit tous les backends de mani√®re automatis√©e (voir l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent</a> ), il serait possible de g√©n√©rer <code>use_backend</code> ici <code>use_backend</code> , la mauvaise affaire n'est pas d√©licate, mais je ne le voulais pas.  En cons√©quence, une autre m√©thode a √©t√© trouv√©e: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 #   host_present      Host acl host_present hdr(host) -m len gt 0 #    ,     use_backend %[req.hdr(host),lower,field(1,'.')] if host_present #      ,    default_backend default backend default mode http server no_server 127.0.0.1:65535</code> </pre><br>  Ainsi, nous avons normalis√© les noms des backends et des URL par lesquels vous pouvez y acc√©der. <br><br>  Eh bien, compilons maintenant √† partir des exemples ci-dessus dans un fichier: <br><br><div class="spoiler">  <b class="spoiler_title">Version compl√®te de la configuration</b> <div class="spoiler_text"><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 nbproc 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3 tune.bufsize 16384 tune.comp.maxlevel 1 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432 stats socket /run/haproxy.sock mode 600 level admin log /dev/stdout local0 debug defaults mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s default-server init-addr last,libc,none log 127.0.0.1:2514 len 8192 local1 notice emerg log 127.0.0.1:2514 len 8192 local7 info log-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}' frontend http bind *:80 http-request del-header X-Forwarded-For http-request del-header X-Forwarded-Port http-request del-header X-Forwarded-Proto capture request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 acl host_present hdr(host) -m len gt 0 use_backend %[req.hdr(host),lower,field(1,'.')] if host_present default_backend default backend default mode http server no_server 127.0.0.1:65535 resolvers dns hold valid 1s timeout retry 100ms nameserver dns1 127.0.0.1:53</code> </pre><br></div></div><br>  Merci √† ceux qui ont lu jusqu'au bout.  Mais ce n'est pas tout.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La prochaine fois,</a> nous examinerons les √©l√©ments de niveau inf√©rieur li√©s √† l'optimisation du syst√®me lui-m√™me, dans lequel Haproxy fonctionne, afin que lui et son syst√®me d'exploitation soient √† l'aise ensemble, et qu'il y ait suffisamment de fer pour tout le monde. <br><br>  A tr√®s bient√¥t! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438966/">https://habr.com/ru/post/fr438966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438956/index.html">Magn√©tite dans les dents: s√©quen√ßage des transcriptomes du tissu de la radula du mollusque coquille</a></li>
<li><a href="../fr438958/index.html">ILV a confirm√© l'existence de sa ¬´station spatiale¬ª</a></li>
<li><a href="../fr438960/index.html">Comment j'ai abandonn√© Ruby en faveur de Python tout en travaillant sur un backend</a></li>
<li><a href="../fr438962/index.html">Pour la plupart, des perspectives positives pour l'avenir des puces</a></li>
<li><a href="../fr438964/index.html">Qui est vraiment derri√®re les VPN gratuits populaires?</a></li>
<li><a href="../fr438968/index.html">Marquage des chaussures en Russie: le march√© n'est pas pr√™t, mais devra fonctionner</a></li>
<li><a href="../fr438970/index.html">Haskell serait une langue pour les g√©nies et les universitaires. Non?</a></li>
<li><a href="../fr438972/index.html">Le cerveau de l'int√©rieur (visualisation du passage du motif √† travers le mod√®le de r√©seau de neurones artificiels)</a></li>
<li><a href="../fr438974/index.html">La r√©alit√© virtuelle aide √† faire face aux troubles mentaux</a></li>
<li><a href="../fr438976/index.html">Le livre "Spring. Tous les mod√®les de conception ¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>