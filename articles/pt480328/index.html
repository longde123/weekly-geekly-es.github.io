<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÖ üë©üèª‚Äçüîß ü§≠ Como fazer amigos PyTorch e C ++. Usando o TorchScript üåø üìû üë®üèª‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° cerca de um ano, os desenvolvedores do PyTorch introduziram a comunidade TorchScript , uma ferramenta que permite criar uma solu√ß√£o alien√°vel a par...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como fazer amigos PyTorch e C ++. Usando o TorchScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ods/blog/480328/"><p> H√° cerca de um ano, os desenvolvedores do <strong>PyTorch</strong> introduziram a comunidade <strong>TorchScript</strong> , uma ferramenta que permite criar uma solu√ß√£o alien√°vel a partir de um pipeline em python com alguns cliques do mouse que podem ser incorporados em um sistema C ++.  Abaixo, compartilho a experi√™ncia de seu uso e tento descrever as armadilhas encontradas nesse caminho.  Darei especial aten√ß√£o √† implementa√ß√£o do projeto no Windows, porque, embora a pesquisa em ML geralmente seja feita no Ubuntu, a solu√ß√£o final √© frequentemente (de repente!) Necess√°ria nas "janelas". </p><br><p>  O c√≥digo de exemplo para exportar um modelo e um projeto C ++ usando o modelo pode ser encontrado no <a href="https://github.com/IlyaOvodov/TorchScriptTutorial">reposit√≥rio no GitHub</a> . </p><br><p> <a href="https://habr.com/ru/company/ods/blog/480328/"><img src="https://habrastorage.org/webt/3k/u1/ub/3ku1ubmzigl3j016ezncczdonqm.jpeg"></a> </p><a name="habracut"></a><br><a name="continue"></a><br><p>  Os desenvolvedores do PyTorch n√£o s√£o enganados.  A nova ferramenta realmente permite transformar um projeto de pesquisa no PyTorch em c√≥digo incorporado em um sistema C ++ em alguns dias √∫teis e com alguma habilidade mais rapidamente. </p><br><p>  O TorchScript apareceu no PyTorch vers√£o 1.0 e continua a evoluir e mudar.  Se a primeira vers√£o de um ano atr√°s era cheia de bugs e era mais experimental, a vers√£o atual 1.3, pelo menos no segundo ponto, √© visivelmente diferente: voc√™ n√£o pode mais cham√°-la de experimental, √© bastante adequada para uso pr√°tico.  Vou me concentrar nela. </p><br><p>  No cora√ß√£o do TorchScript est√° o seu pr√≥prio compilador independente (sem Python) de uma linguagem semelhante a python, al√©m de ferramentas para converter nele um programa escrito em Python e PyTorch, m√©todos para salvar e carregar os m√≥dulos resultantes e uma biblioteca para us√°-los em C ++.  Para funcionar, voc√™ precisar√° adicionar v√°rias DLLs ao projeto com um peso total de cerca de 70 MB (para Windows) para trabalhar na CPU e 300 MB na vers√£o da GPU.  O TorchScript suporta a maioria dos recursos do PyTorch e os principais recursos da linguagem python.  Mas bibliotecas de terceiros, como OpenCV ou NumPy, ter√£o que ser esquecidas.  Felizmente, muitas fun√ß√µes do NumPy t√™m um anal√≥gico no PyTorch. </p><br><h2 id="konvertiruem-payplayn-na-pytorch-model-na-torchscript">  Converter pipeline para o modelo PyTorch no TorchScript </h2><br><p>  O TorchScript oferece duas maneiras de converter o c√≥digo Python em seu formato interno: rastreamento e script (rastreamento e script).  Por que dois?  N√£o, √© claro, √© claro, que dois s√£o melhores que um ... </p><br><p><img src="https://habrastorage.org/webt/lh/xp/ww/lhxpwwynynljq2_sxj35jhpp9yc.jpeg"></p><br><p>  Mas, no caso desses m√©todos, verifica-se, como no aforismo conhecido, sobre os desvios da esquerda e da direita: ambos s√£o piores.  Bem, o mundo n√£o √© perfeito.  Apenas em uma situa√ß√£o espec√≠fica, voc√™ precisa escolher a que √© mais adequada. </p><br><p>  O m√©todo de rastreamento √© muito simples.  Uma amostra de dados √© obtida (geralmente inicializada por n√∫meros aleat√≥rios), enviada para a fun√ß√£o ou m√©todo da classe que nos interessa, e o PyTorch constr√≥i e armazena o gr√°fico de c√°lculo da mesma maneira que costuma fazer ao treinar uma rede neural.  Voila - o script est√° pronto: </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torchvision model = torchvision.models.resnet34(pretrained = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) model.eval() sample = torch.rand(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>) scripted_model = torch.jit.trace(model, sample)</code> </pre> <br><p>  O exemplo acima produz um objeto da classe ScriptModule.  Pode ser salvo </p><br><pre> <code class="python hljs">scripted_model.save(<span class="hljs-string"><span class="hljs-string">'my_script.pth'</span></span>)</code> </pre> <br><p>  e carregue-o <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">em um programa C ++</a> (mais sobre isso <a href="https://habr.com/ru/company/ods/blog/480328/">abaixo</a> ) ou no c√≥digo Python, em vez do objeto original: </p><br><div class="spoiler">  <b class="spoiler_title">Exemplo de c√≥digo Python usando um modelo salvo</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cv2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> torchvision.transforms <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Compose, ToTensor, Normalize transforms = Compose([ToTensor(), Normalize(mean=[<span class="hljs-number"><span class="hljs-number">0.485</span></span>, <span class="hljs-number"><span class="hljs-number">0.456</span></span>, <span class="hljs-number"><span class="hljs-number">0.406</span></span>], std=[<span class="hljs-number"><span class="hljs-number">0.229</span></span>, <span class="hljs-number"><span class="hljs-number">0.224</span></span>, <span class="hljs-number"><span class="hljs-number">0.225</span></span>])]) img = cv2.resize(cv2.imread(<span class="hljs-string"><span class="hljs-string">'pics/cat.jpg'</span></span>), (<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>)) img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB) x = transforms(img).unsqueeze(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment"># add batch dimension scripted_model = torch.jit.load('my_script.pth') y = scripted_model(x) print(y[0].argmax(), y[0][y[0].argmax()])</span></span></code> </pre> <br><pre> <code class="plaintext hljs">tensor(282) tensor(12.8130, grad_fn=&lt;SelectBackward&gt;)</code> </pre> </div></div><br><p>  O <code>ScriptModule</code> resultante pode aparecer em qualquer lugar onde <code>nn.Module</code> √© comumente usado. </p><br><p>  Da maneira descrita, √© poss√≠vel rastrear inst√¢ncias da classe e fun√ß√µes <code>nn.Module</code> (neste √∫ltimo caso, √© <code>torch._C.Function</code> uma inst√¢ncia da classe <code>torch._C.Function</code> ). </p><br><p>  Esse m√©todo (rastreamento) tem uma vantagem importante: dessa forma, voc√™ pode converter quase qualquer c√≥digo Python que n√£o use bibliotecas externas.  Mas h√° uma desvantagem igualmente importante: para quaisquer ramifica√ß√µes, apenas a ramifica√ß√£o executada nos dados de teste ser√° lembrada: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_abs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x.max() &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -x my_abs_traced = torch.jit.trace(my_abs, torch.tensor(<span class="hljs-number"><span class="hljs-number">0</span></span>)) print(my_abs_traced(torch.tensor(<span class="hljs-number"><span class="hljs-number">1</span></span>)), my_abs_traced(torch.tensor(<span class="hljs-number"><span class="hljs-number">-1</span></span>)))</code> </pre> <br><pre> <code class="plaintext hljs">c:\miniconda3\lib\site-packages\ipykernel_launcher.py:2: TracerWarning: Converting a tensor to a Python boolean might cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated as a constant in the future. This means that the trace might not generalize to other inputs! tensor(1) tensor(-1)</code> </pre> <br><p>  Opa!  Parece que n√£o √© isso que gostar√≠amos, certo?  √â bom que pelo menos uma mensagem de aviso (TracerWarning) seja emitida.  Vale a pena prestar aten√ß√£o a essas mensagens. </p><br><p>  Aqui o segundo m√©todo vem em nosso aux√≠lio - script: </p><br><pre> <code class="python hljs">my_abs_script = torch.jit.script(my_abs) print(my_abs_script(torch.tensor(<span class="hljs-number"><span class="hljs-number">1</span></span>)), my_abs_script(torch.tensor(<span class="hljs-number"><span class="hljs-number">-1</span></span>)))</code> </pre> <br><pre> <code class="plaintext hljs">tensor(1) tensor(1)</code> </pre> <br><p>  Viva, o resultado esperado √© recebido!  O script analisa recursivamente o c√≥digo Python e o converte em c√≥digo em sua pr√≥pria linguagem.  Na sa√≠da, tamb√©m obtemos a classe <code>ScriptModule</code> (para m√≥dulos) ou <code>torch._C.Function</code> (para fun√ß√µes).  Parece, aqui est√°, felicidade!  Mas surge outro problema: a linguagem interna do TorchScript √© fortemente tipada, diferentemente do Python.  O tipo de cada vari√°vel √© determinado pela primeira atribui√ß√£o, o tipo dos argumentos da fun√ß√£o por padr√£o √© <code>Tensor</code> .  Portanto, por exemplo, um padr√£o familiar </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> y = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x.max() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: y = x <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y my_func = torch.jit.script(my_func)</code> </pre> <br><p>  O rastreamento falhar√°. </p><br><div class="spoiler">  <b class="spoiler_title">Um erro de rastreamento se parece com isso</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">RuntimeError Traceback (most recent call last) &lt;ipython-input-9-25414183a687&gt; in &lt;module&gt;() ----&gt; 1 my_func = torch.jit.script(my_func) d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in script(obj, optimize, _frames_up, _rcb) 1224 if _rcb is None: 1225 _rcb = _gen_rcb(obj, _frames_up) -&gt; 1226 fn = torch._C._jit_script_compile(qualified_name, ast, _rcb, get_default_args(obj)) 1227 # Forward docstrings 1228 fn.__doc__ = obj.__doc__ RuntimeError: Variable 'y' previously has type None but is now being assigned to a value of type Tensor : at &lt;ipython-input-8-75677614fca6&gt;:4:8 def my_func(x): y = None if x.max() &gt; 0: y = x ~ &lt;--- HERE return y</code> </pre> </div></div><br><p>  Vale ressaltar que, embora ocorra um erro quando o <code>torch.jit.script</code> chamado, o local que o causou no c√≥digo com script tamb√©m √© indicado. </p><br><p>  Mesmo pontos ap√≥s constantes come√ßam a desempenhar um papel: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x.max() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: y = <span class="hljs-number"><span class="hljs-number">1.25</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: y = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y my_func = torch.jit.script(my_func)</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">vai dar um erro</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">RuntimeError Traceback (most recent call last) &lt;ipython-input-10-0a5f18586763&gt; in &lt;module&gt;() 5 y = 0 6 return y ----&gt; 7 my_func = torch.jit.script(my_func) d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in script(obj, optimize, _frames_up, _rcb) 1224 if _rcb is None: 1225 _rcb = _gen_rcb(obj, _frames_up) -&gt; 1226 fn = torch._C._jit_script_compile(qualified_name, ast, _rcb, get_default_args(obj)) 1227 # Forward docstrings 1228 fn.__doc__ = obj.__doc__ d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in _rcb(name) 1240 # closure rcb fails 1241 result = closure_rcb(name) -&gt; 1242 if result: 1243 return result 1244 return stack_rcb(name) RuntimeError: bool value of Tensor with more than one value is ambiguous</code> </pre> </div></div><br><p>  Porque √© necess√°rio escrever n√£o <code>0</code> , mas <code>0.</code> para que o tipo nos dois ramos seja o mesmo!  Mimado, voc√™ sabe, com seu python! </p><br><p>  Este √© apenas o come√ßo da lista de altera√ß√µes que voc√™ precisa fazer no c√≥digo python para que ele possa ser transformado com sucesso em um m√≥dulo TorchScript.  Vou listar os casos mais comuns em mais detalhes <a href="https://habr.com/ru/company/ods/blog/480328/">posteriormente</a> .  Em princ√≠pio, n√£o h√° ci√™ncia de foguetes aqui e seu c√≥digo pode ser corrigido de acordo.  Mas na maioria das vezes eu n√£o quero consertar m√≥dulos de terceiros, incluindo os padr√£o da <code>torchvision</code> , e, como de costume, eles geralmente n√£o s√£o adequados para scripts. </p><br><p>  Felizmente, ambas as tecnologias podem ser combinadas: o que est√° sendo roteirizado est√° sendo roteirizado e o que n√£o est√° sendo roteirizado √© o seguinte: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(torch.nn.Module)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> super(MyModule, self).__init__() self.resnet = torchvision.models.resnet34(pretrained = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-comment"><span class="hljs-comment">#       torch.jit.script(my_module) #    -   resnet34. #     self.resnet  ScriptModule. self.resnet.eval() # NB:     !  -  ! self.resnet = torch.jit.trace(self.resnet, torch.rand((1,3,224,224), dtype=torch.float)) def forward(self, x): if x.shape[2] &lt; 224 or x.shape[3] &lt; 224: return torch.tensor(0) else: return self.resnet(x) my_module = MyModule() my_module = torch.jit.script(my_module)</span></span></code> </pre> <br><p>  No exemplo acima, o rastreamento √© usado para incluir um m√≥dulo que n√£o √© pass√≠vel de script em um m√≥dulo em que n√£o h√° rastreamento e scripts suficientes.  Existe uma situa√ß√£o inversa.  Por exemplo, se precisarmos fazer upload de um modelo para o ONNX, o rastreamento ser√° usado.  Mas o modelo rastreado pode incluir fun√ß√µes do TorchScript, para que a l√≥gica que requer ramifica√ß√µes e loops possa ser implementada l√°!  Um exemplo √© fornecido na <a href="https://pytorch.org/docs/stable/onnx.html">documenta√ß√£o oficial do torch.onnx</a> . </p><br><p>  Os recursos fornecidos pelo PyTorch para a cria√ß√£o de m√≥dulos TorchScript s√£o descritos em mais detalhes na <a href="https://pytorch.org/docs/stable/jit.html">documenta√ß√£o oficial</a> e <code>torch.jit</code> .  Em particular, n√£o mencionei uma maneira conveniente de usar <code>torch.jit.trace</code> e <code>torch.jit.script</code> na forma de decoradores, sobre as peculiaridades da depura√ß√£o de c√≥digo de script.  Isso e muito mais est√° na documenta√ß√£o. </p><br><h2 id="anchorcppanchorvklyuchaem-model-v-proekt-na-c"><a name="cpp"></a>  Inclu√≠mos o modelo em um projeto C ++ </h2><br><p>  Infelizmente, a <a href="https://pytorch.org/tutorials/advanced/cpp_export.html">documenta√ß√£o oficial √©</a> limitada a exemplos do formul√°rio "adicione 2 tensores gerados usando <code>torch.ones</code> ".  Eu preparei um exemplo de <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">um projeto mais pr√≥ximo da realidade</a> que envia uma imagem do OpenCV para a rede neural e recebe os resultados na forma de um tensor de resposta, uma tupla de vari√°veis, uma imagem com resultados de segmenta√ß√£o. </p><br><p>  Para o exemplo funcionar, voc√™ precisa de scripts de classifica√ß√£o salvos usando ResNet34 e segmenta√ß√£o usando DeepLabV3.  Para preparar esses scripts, voc√™ precisa executar <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/blob/master/prepare_scripts.ipynb">este bloco de notas jupyter</a> . </p><br><p>  Precisamos da biblioteca <code>torchlib</code> .  Voc√™ pode obt√™-lo de v√°rias maneiras: </p><br><ol><li>  Se voc√™ j√° possui o PyTorch instalado usando a <code>pip install</code> , pode encontr√°-lo no diret√≥rio Python: <code>&lt;Miniconda3&gt;\Lib\site-packages\torch</code> ; </li><li>  Se voc√™ tiver o PyTorch compilado a partir do c√≥digo-fonte, ele estar√° l√°: <code>&lt;My Pytorch repo&gt;\build\lib.win-amd64-3.6\torch</code> ; </li><li>  Por fim, voc√™ pode baixar a <a href="https://pytorch.org/">biblioteca</a> separadamente do <a href="https://pytorch.org/">pytorch.org</a> escolhendo Idioma = C ++ e descompactar o arquivo. </li></ol><br><p>  O c√≥digo C ++ √© bastante simples.  √â necess√°rio: </p><br><ol><li>  Incluir arquivo de cabe√ßalho <br><pre> <code class="plaintext hljs">#include &lt;torch/script.h&gt;</code> </pre> </li><li>  Download do modelo <br><pre> <code class="plaintext hljs">torch::jit::script::Module module = torch::jit::load("../resnet34_infer.pth");</code> </pre> </li><li>  Preparar dados <br><pre> <code class="plaintext hljs">torch::Tensor tensor = torch::from_blob(img.data, { img.rows, img.cols, 3 }, torch::kByte);</code> </pre> </li><li>  Fun√ß√£o de <code>forward</code> chamada e resultado <br><pre> <code class="plaintext hljs">auto output = module.forward( { tensor } )</code> </pre> </li><li>  Obtenha dados do resultado.  Como fazer isso depende do que a rede neural retorna.  By the way, no caso geral, ele tamb√©m pode aceitar n√£o apenas uma imagem, portanto, √© melhor olhar <a href="">para o c√≥digo fonte de</a> todo o <a href="">exemplo</a> , existem op√ß√µes diferentes.  Por exemplo, para obter dados de um tensor unidimensional do tipo float: <br><pre> <code class="plaintext hljs">float* data = static_cast&lt;float*&gt;(output.toTensor().data_ptr());</code> </pre> </li><li>  H√° mais uma sutileza.  N√£o se esque√ßa de inserir o anal√≥gico <code>with torch.no_grad()</code> no c√≥digo para n√£o desperdi√ßar recursos no c√°lculo e armazenamento dos gradientes de que n√£o precisamos.  Infelizmente, este comando n√£o pode ser inclu√≠do no script, portanto, voc√™ deve adicion√°-lo ao c√≥digo C ++: <br><pre> <code class="plaintext hljs">torch::NoGradGuard no_grad;</code> </pre> </li></ol><br><p>  Como criar um projeto usando o CMake √© descrito no <a href="https://pytorch.org/tutorials/advanced/cpp_export.html">guia oficial</a> .  Mas o t√≥pico do projeto no Visual Studio n√£o √© divulgado l√°, ent√£o eu o descreverei com mais detalhes.  Voc√™ precisar√° ajustar manualmente as configura√ß√µes do projeto: </p><br><ol><li>  Eu testei no Visual Studio 2017. N√£o posso dizer sobre outras vers√µes. </li><li>  O conjunto de ferramentas v14.11 v141 deve estar instalado (marque a op√ß√£o <code>"VC++ 2017 version 15.4 v14.11 toolset"</code> no instalador do VS). </li><li>  A plataforma deve ser <code>x64</code> . </li><li>  Em <code>General ‚Üí Platform Toolset</code> <code>v141(Visual Studio 2017)</code> <code>General ‚Üí Platform Toolset</code> selecione <code>v141(Visual Studio 2017)</code> </li><li>  Em <code>C/C++ ‚Üí General ‚Üí Additional Include Directories</code> adicione <code>&lt;libtorch dir&gt;\include</code> </li><li>  No <code>Linker ‚Üí General ‚Üí Additional Library Directories</code> adicione <code>&lt;libtorch dir&gt;\lib</code> </li><li>  No <code>Linker ‚Üí Input ‚Üí Additional Dependencies</code> adicionais, adicione <code>torch.lib; c10.lib</code>  <code>torch.lib; c10.lib</code> .  Na Internet, eles escrevem que <code>caffe2.lib</code> ainda pode ser necess√°rio, e para a GPU e algo mais de <code>&lt;libtorch dir&gt;\lib</code> , mas na vers√£o atual, adicionar essas duas bibliotecas foi suficiente para mim.  Talvez essa seja uma informa√ß√£o desatualizada. </li><li>  Eles tamb√©m escrevem que voc√™ precisa definir <code>C/C++ ‚Üí Language ‚Üí Conformance Mode</code> = <code>No</code> , mas n√£o vi a diferen√ßa. </li></ol><br><p>  Al√©m disso, a vari√°vel <code>__cplusplus</code> N√ÉO deve ser declarada no projeto.  Tentativa de adicionar a <a href="https://docs.microsoft.com/ru-ru/cpp/build/reference/zc-cplusplus%3Fview%3Dvs-2017"><code>  /Zc:__cplusplus</code></a> resultar√° em erros de compila√ß√£o no arquivo <code>ivalue.h</code> . </p><br><p>  No <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/tree/master/cpp_proj">projeto em anexo,</a> as configura√ß√µes do caminho (n√£o apenas para o TorchLib, mas tamb√©m para o OpenCV e CUDA) s√£o <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/blob/master/cpp_proj/cpp_proj.props">transferidas</a> para o <a href="https://github.com/IlyaOvodov/TorchScriptTutorial/blob/master/cpp_proj/cpp_proj.props">arquivo props</a> , antes da montagem, √© necess√°rio registr√°-las l√° de acordo com a sua configura√ß√£o local.  Isso, de fato, √© tudo. </p><br><h2 id="anchortipsanchorchto-eschyo-sleduet-imet-v-vidu"><a name="tips"></a>  O que mais deve ter em mente </h2><br><p>  Se o processo descrito lhe pareceu muito simples, sua intui√ß√£o n√£o o enganou.  H√° v√°rias nuances que precisam ser consideradas para converter um modelo PyTorch escrito em Python em TorchScript.  Vou listar abaixo aqueles que tive que enfrentar.  Eu j√° mencionei alguns, mas repito para coletar tudo em um s√≥ lugar. </p><br><p><img src="https://habrastorage.org/webt/iv/xy/q-/ivxyq-lqqw8s1aqd_cy4t4uwj5i.jpeg"></p><br><ul><li>  O tipo de vari√°veis ‚Äã‚Äãtransmitidas para a fun√ß√£o √© Tensor por padr√£o.  Se em alguns casos (muito frequentes) isso for inaceit√°vel, voc√™ precisar√° declarar os tipos manualmente usando anota√ß√µes de tipo no estilo MyPy, algo como isto: </li></ul><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc_letter_statistics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, cls_preds: List[Tensor], cls_thresh: float)</span></span></span><span class="hljs-function">-&gt;Tuple[int, Tuple[Tensor, Tensor, Tensor]]</span></span></code> </pre> <br><p>  ou mais: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc_letter_statistics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, cls_preds, cls_thresh)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># type: (List[Tensor], float)-&gt;Tuple[int, Tuple[Tensor, Tensor, Tensor]]</span></span></code> </pre> <br><ul><li>  As vari√°veis ‚Äã‚Äãs√£o fortemente digitadas e o tipo, se n√£o especificado explicitamente, √© determinado pela primeira atribui√ß√£o.  Constru√ß√µes familiares da forma <code>x=[]; for ...: x.append(y)</code>  <code>x=[]; for ...: x.append(y)</code> ter√° que ser editado, porque  no momento da atribui√ß√£o <code>[]</code> compilador n√£o pode descobrir qual tipo estar√° na lista.  Portanto, voc√™ deve especificar o tipo explicitamente, por exemplo: </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> List x: List[float] = []</code> </pre> <br><p>  ou (outro "por exemplo") </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> torch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Tensor <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dict, Tuple, List x: Dict[int: Tuple[float, List[Tensor], List[List[int]]]] = {}</code> </pre> <br><ul><li>  No exemplo acima, s√£o os nomes que precisam ser importados, pois esses nomes s√£o costurados no c√≥digo do TorchScript.  Abordagem alternativa, aparentemente legal </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torch <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> typing x: typing.List[torch.Tensor] = []</code> </pre> <br><p>  resultar√° em um <em>construtor de tipo desconhecido digitando.</em> Erro de lista ao <em>criar</em> scripts </p><br><ul><li>  Outro design familiar do qual voc√™ precisa participar: </li></ul><br><pre> <code class="python hljs">x = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> smth: x = torch.tensor([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br><p>  Existem duas op√ß√µes.  Ou atribua o tensor as duas vezes (o fato de ter dimens√µes diferentes n√£o √© assustador): </p><br><pre> <code class="python hljs">x = torch.tensor(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> smth: x = torch.tensor([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br><p>  e n√£o se esque√ßa de procurar o que ir√° quebrar ap√≥s essa substitui√ß√£o.  Ou tente escrever honestamente: </p><br><pre> <code class="python hljs">x: Optional[Tensor] = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> smth: x = torch.tensor([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br><p>  mas com o uso adicional de <code>x</code> onde o tensor √© esperado, provavelmente obteremos um erro: <em>Esperava-se um valor do tipo 'Tensor' para o argumento 'x', mas encontrou o tipo 'Opcional [Tensor]'.</em> </p><br><ul><li><p>  N√£o esque√ßa de escrever, por exemplo, <code>x=0.</code> durante a primeira tarefa <code>x=0.</code>  em vez do habitual <code>x=0</code> , etc., se a vari√°vel <code>x</code> deve ser do tipo <code>float</code> . </p><br></li><li><p>  Se em algum lugar usamos a inicializa√ß√£o antiquada do tensor via <code>x = torch.Tensor(...)</code> , voc√™ ter√° que se separar e substitu√≠-lo por uma vers√£o mais nova por uma letra min√∫scula <code>x = torch.tensor(...)</code> .  Caso contr√°rio, durante o script, ele voar√°: <em>Desconhecido builtin op: aten :: Tensor.</em>  <em>Aqui est√£o algumas sugest√µes: aten :: tensor</em> .  Parece que eles at√© explicam qual √© o problema e fica claro o que precisa ser feito.  No entanto, √© claro se voc√™ j√° sabe a resposta correta. </p><br></li><li><p>  O c√≥digo √© roteirizado no contexto do m√≥dulo no qual <code>torch.jit.script</code> chamado.  Portanto, se em algum lugar, nas entranhas da classe ou fun√ß√£o com script, por exemplo, <code>math.pow</code> , voc√™ precisar√° adicionar <code>import math</code> ao m√≥dulo de compila√ß√£o.  E √© melhor criar um script para a classe em que √© declarada: usando o decorador <code>@torch.jit.script</code> ou declarando uma fun√ß√£o adicional ao lado, que faz dele o ScriptModule.  Caso contr√°rio, obteremos uma mensagem de erro <em>matem√°tico de valor indefinido</em> quando tentamos compilar uma classe a partir de um m√≥dulo no qual, aparentemente, a importa√ß√£o <code>math</code> foi feita. </p><br></li><li><p>  Se em algum lugar voc√™ tiver uma constru√ß√£o no formato <code>my_tensor[my_tensor &lt; 10] = 0</code> ou semelhante, voc√™ receber√° um erro enigm√°tico ao <code>my_tensor[my_tensor &lt; 10] = 0</code> scripts: </p><br><pre> <code class="plaintext hljs">*aten::index_put_(Tensor(a!) self, Tensor?[] indices, Tensor values, bool accumulate=False) -&gt; (Tensor(a!)):* *Expected a value of type 'Tensor' for argument 'values' but instead found type 'int'.* *aten::index_put_(Tensor(a!) self, Tensor[] indices, Tensor values, bool accumulate=False) -&gt; (Tensor(a!)):* *Expected a value of type 'List[Tensor]' for argument 'indices' but instead found type 'List[Optional[Tensor]]'.*</code> </pre> <br><p>  O que voc√™ precisa √© substituir o n√∫mero pelo tensor: <code>my_tensor[my_tensor &lt; 10] = torch.tensor(0.).to(my_tensor.device)</code> .  E n√£o se esque√ßa de a) sobre a correspond√™ncia dos tipos <code>my_tensor</code> e do tensor criado (neste caso, float) eb) sobre <code>.to(my_tensor.device)</code> .  Se voc√™ esquecer o segundo, tudo ser√° roteirizado, mas j√° no processo de trabalho com a GPU, voc√™ ficar√° chateado, que se parecer√° com as palavras enigm√°ticas <em>Erro CUDA: um acesso ilegal √† mem√≥ria foi encontrado</em> , sem indicar onde ocorreu o erro! </p><br></li><li><p>  N√£o esque√ßa que, por padr√£o, o <code>nn.Module</code> e, consequentemente, os modelos da torchvision s√£o criados no "modo de trem" (voc√™ n√£o vai acreditar, mas acontece que <a href="https://fooobar.com/questions/16769103/error-when-converting-pytorch-model-to-torchscript/25666033">existe esse modo</a> ).  Nesse caso, o Dropout e outros truques do modo de trem s√£o usados, que quebram o rastreio ou levam a resultados inadequados quando executados.  Lembre-se de chamar <code>model.eval()</code> antes de <code>model.eval()</code> scripts ou rastrear. </p><br></li><li><p>  Para fun√ß√µes e classes comuns, √© necess√°rio criar um script do tipo, para nn.Module - uma inst√¢ncia </p><br></li><li><p>  Tentativa em um m√©todo com script de acessar uma vari√°vel global </p><br></li></ul><br><pre> <code class="python hljs">cls_thresh = <span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(torch.nn.Module)</span></span></span><span class="hljs-class">:</span></span> ... x = r &lt; cls_thresh ...</code> </pre> <br><p>  resultar√° em um erro de script do formato <em>python. O valor do tipo 'float' n√£o pode ser usado como um valor</em> .  √â necess√°rio tornar a vari√°vel um atributo no construtor: </p><br><pre> <code class="python hljs">cls_thresh = <span class="hljs-number"><span class="hljs-number">0.3</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(torch.nn.Module)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ... self.cls_thresh = cls_thresh ... x = r &lt; self.cls_thresh ...</code> </pre> <br><ul><li>  Outra sutileza surge se o atributo de classe for usado como um par√¢metro de fatia: </li></ul><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FPN</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(nn.Module)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, block, num_blocks, num_layers =</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> ... self.num_layers = num_layers <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, x)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (p3, p4, p5, p6, p7)[:self.num_layers]</code> </pre> <br><p>  faz com que os <em>√≠ndices de fatia de tupla de</em> erro de script <em>devem ser constantes inteiras</em> .  √â necess√°rio indicar que o atributo num_layers √© constante e n√£o ser√° alterado: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FPN</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(nn.Module)</span></span></span><span class="hljs-class">:</span></span> num_layers: torch.jit.Final[int] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, block, num_blocks, num_layers =</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> ...</code> </pre> <br><ul><li>  Em alguns casos, onde o tensor costumava se encaixar normalmente, voc√™ precisa passar explicitamente o n√∫mero: </li></ul><br><pre> <code class="python hljs">xx1 = x1.clamp(min=x1[i])</code> </pre> <br><p>  gera um erro ao <em><code>Expected a value of type 'Optional[number]' for argument 'min' but instead found type 'Tensor'.</code></em> scripts <em><code>Expected a value of type 'Optional[number]' for argument 'min' but instead found type 'Tensor'.</code></em>  .  Bem, aqui a partir da mensagem de erro, est√° claro o que fazer: </p><br><pre> <code class="python hljs">xx1 = x1.clamp(min=x1[i].item())</code> </pre> <br><p>  Os problemas acima ocorrem ao rastrear.  √â por causa deles que geralmente n√£o √© poss√≠vel compilar solu√ß√µes prontas no TorchScript, e voc√™ precisa massagear o c√≥digo-fonte por um longo tempo (se o c√≥digo-fonte √© apropriado para editar) ou usar o rastreamento.  Mas o tra√ßo tem suas pr√≥prias nuances: </p><br><ul><li>  Constru√ß√µes do formul√°rio n√£o funcionam no rastreamento </li></ul><br><pre> <code class="plaintext hljs">tensor_a.to(tensor_b.device)</code> </pre> <br><p>  O dispositivo no qual o tensor √© carregado √© fixado no momento do rastreamento e n√£o muda durante a execu√ß√£o.  Esse problema pode ser superado parcialmente declarando o tensor um membro de <code>nn.Module</code> tipo <code>Parameter</code> .  Em seguida, ao carregar o modelo, ele ser√° inicializado no dispositivo especificado na fun√ß√£o <code>torch.jit.load</code> . </p><br><h2 id="epilog">  Ep√≠logo </h2><br><p>  Todos os itens acima, √© claro, criam problemas.  Mas o TorchScript permite combinar e enviar para a solu√ß√£o como um todo o modelo em si e o c√≥digo Python que fornece pr√© e p√≥s-processamento.  Sim, e o tempo para preparar a solu√ß√£o para a compila√ß√£o, apesar das dificuldades acima, √© incomparavelmente menor que o custo de cria√ß√£o de uma solu√ß√£o, mas aqui o PyTorch oferece grandes vantagens, portanto o jogo vale a pena. </p><br><p><img src="https://habrastorage.org/webt/v0/3m/qt/v03mqtayxdfh5be4ut3nrr0c86q.jpeg"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480328/">https://habr.com/ru/post/pt480328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480316/index.html">Como reduzir o consumo de m√≥dulos wifi em dez ou mais vezes</a></li>
<li><a href="../pt480318/index.html">Uma sele√ß√£o dos pr√≥ximos eventos gratuitos para desenvolvedores em Moscou # 3 (16 a 24 de dezembro)</a></li>
<li><a href="../pt480320/index.html">Dez anos de ONYX na R√∫ssia - como as tecnologias, os leitores e o mercado mudaram durante esse per√≠odo</a></li>
<li><a href="../pt480324/index.html">Implementa√ß√£o de tipo de string no CPython</a></li>
<li><a href="../pt480326/index.html">A F5 Networks Corporation envia cartas aos seus clientes informando-os sobre a situa√ß√£o atual com a NGINX</a></li>
<li><a href="../pt480330/index.html">Ferramenta ideal de avalia√ß√£o de funcion√°rios</a></li>
<li><a href="../pt480332/index.html">An√°lise dos dados da vota√ß√£o da blockchain de 2019 na Duma da cidade de Moscou</a></li>
<li><a href="../pt480334/index.html">QtQML / Painel de correla√ß√£o r√°pida</a></li>
<li><a href="../pt480338/index.html">Como funciona a renderiza√ß√£o de jogos em 3D: rasteriza√ß√£o e rastreamento de raios</a></li>
<li><a href="../pt480340/index.html">Eu me opus a um gerente incompetente e ele foi promovido</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>