<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¢ üåõ üìç Parlez de PostgreSQL. Entretien avec Alexei Lesovsky dans le podcast Zinc Prod. Premi√®re partie üßúüèΩ ‚õèÔ∏è üîÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="R√©cemment, nous avons invit√© Alexei Lesovsky de Data Egret √† diffuser Zinc Sale . La conversation s'est av√©r√©e int√©ressante et informative, je vous pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Parlez de PostgreSQL. Entretien avec Alexei Lesovsky dans le podcast Zinc Prod. Premi√®re partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485322/"><blockquote>  R√©cemment, nous avons invit√© Alexei Lesovsky de <a href="https://www.dataegret.ru/" rel="nofollow">Data Egret</a> √† diffuser <a href="https://soundcloud.com/znprod" rel="nofollow">Zinc Sale</a> .  La conversation s'est av√©r√©e int√©ressante et informative, je vous propose donc la transcription de ce num√©ro.  En raison du volume impressionnant, il √©tait n√©cessaire de diviser le texte en morceaux.  Si vous √™tes trop paresseux pour attendre la suite, vous pouvez simplement √©couter la version audio <a href="https://soundcloud.com/znprod/040-aleksey-lesovskiy-kak-vlyubit-v-sebya-postgres" rel="nofollow">ici</a> . </blockquote><p>  Bonjour √† tous, c'est le quaranti√®me num√©ro du podcast Zinc Prod, et Anton Okolelov, Nikita Vasilchenko et Oleg Gritsak sont des h√¥tes permanents avec nous dans le studio. </p><br><p>  <strong>Anton</strong> : Donc, aujourd'hui, nous avons un invit√©, Alexey Lesovsky.  Lesha, veuillez vous pr√©senter, qui vous √™tes, ce que vous faites, etc. </p><a name="habracut"></a><br><p> <strong>Alexei</strong> : Bonjour √† tous, je m'appelle Alexei Lesovsky, car Antokha m'a d√©j√† pr√©sent√©.  J'administre Postgres, je suis PostgreSQL DBA (administrateur de base de donn√©es), je travaille avec la connexion tous les jours, 7 jours par semaine, et j'administre les bases de donn√©es client.  Nous avons un bureau - c'est une soci√©t√© de conseil, elle est engag√©e dans l'administration, le support et le support.  Et des personnes tr√®s diff√©rentes viennent nous voir avec leurs bases de donn√©es, en r√®gle g√©n√©rale, ce sont des entreprises - petites, grandes, petites, toutes sortes de diff√©rentes - elles ont des probl√®mes avec la base de donn√©es, nous analysons ces probl√®mes et essayons de les r√©soudre.  En fait, nous r√©solvons les probl√®mes d'autres personnes, d'autres entreprises.  Quelque chose comme √ßa. </p><br><p>  Eh bien, pendant mon temps libre, j'aime faire diff√©rentes choses, marcher dans les bois, faire du snowboard, de la randonn√©e, boire de la bi√®re </p><br><p>  <strong>Anton</strong> : boire de la bi√®re fum√©e </p><br><p>  <strong>Nikita</strong> : avant la sortie, Lyokha parlait de bi√®re fum√©e </p><br><p>  <strong>Alexei</strong> : oui, la bi√®re fum√©e, il y a une d√©licieuse, je recommande.  Rauchbier Merzen. </p><br><p>  <strong>Anton</strong> : ok, dites-moi s'il vous pla√Æt, vous dbshnik, vous travaillez depuis longtemps, plusieurs ann√©es.  Est-ce difficile?  Ils vous appellent la nuit et vous demandent de r√©parer la base.  Je vous ai appel√© √† cinq heures du matin il y a environ un an ou demi. </p><br><p>  <strong>Alexei</strong> : oui, c'√©tait, c'√©tait une question. </p><br><p>  <strong>Anton</strong> : comment survivez-vous, dites-moi </p><br><p>  <strong>Alexey</strong> : √©coute, je travaille depuis 2014.  Jusqu'en 2014, j'ai travaill√© en tant qu'administrateur Linux dans le d√©veloppement web.  L'administrateur a beaucoup de choses, nous avions la virtualisation kvm, il y avait beaucoup de Linux, il y avait toutes sortes de Ruby-on-rails, nginxs, php, rails ... </p><br><p>  <strong>Oleg</strong> : Docker l'a d√©j√† √©t√©? </p><br><p>  <strong>Alexey</strong> : le docker vient de commencer, nous ne l'avons introduit nulle part dans la production, mais les tendances pour cela ont d√©j√† commenc√©. </p><br><p>  Et il y avait beaucoup de postgres dans notre bureau.  Ensuite, j'ai poursuivi un long rouble et j'ai d√©cid√© que je pouvais travailler sur deux emplois en m√™me temps.  Et il a commenc√© √† travailler en tant qu'administrateur √† distance dans un bureau de Moscou.  J'ai combin√© deux travaux, l√† seulement les bases de donn√©es √©taient administr√©es par Postgresql consulting.  Il y avait Max Boguk, Ilya Kosmodemyansky, et en tant qu'administrateur, j'ai commenc√© √† faire une partie des t√¢ches associ√©es √† l'ambassade.  Eh bien, c'est-√†-dire  J'ai commenc√© √† prendre tranquillement leur pain.  Et √† un moment donn√©, Max me dit ceci: √©coutez et laissez-vous aller travailler avec nous.  Vous quitterez tout votre travail, des emplois √† temps partiel, vous viendrez chez nous √† temps plein. </p><br><p>  Eh bien, j'ai accept√©, je n'ai pas h√©sit√©, en principe, on m'a offert un salaire comparable, et j'ai obtenu un emploi et j'ai commenc√© √† travailler √† domicile, et maintenant depuis 2014, il s'av√®re, je travaille depuis 5 ans, je travaille sp√©cifiquement avec le p√®re, eh bien, √† l'ancienne toutes sortes de th√®mes d'administration, je travaille avec eux par habitude.  C'est-√†-dire  si dans notre entreprise il y a un probl√®me avec quelque chose √† comprendre du c√¥t√© administrateur, ils me jettent, je comprends </p><br><p>  <strong>Anton</strong> : Mais en g√©n√©ral, est-il n√©cessaire de conna√Ætre ces trucs administratifs?  Ce n'est pas seulement l√†, la base est dans le vide, elle tourne quelque part, vous devez configurer le syst√®me d'exploitation, non? </p><br><p>  <strong>Alexey</strong> : oui, oui, c'est exactement parce qu'il d√©pend g√©n√©ralement largement des sous-syst√®mes du syst√®me d'exploitation, de la m√©moire virtuelle et de la gestion des disques, c'est-√†-dire  c'est comme si lui-m√™me n'exploitait pas directement les ressources, il comme s'il d√©chargeait tout ce travail sur le syst√®me d'exploitation, et qu'il g√®re lui-m√™me les E / S disque, la gestion des pages m√©moire, c'est tout, la commutation de processus, et en cons√©quence, si vous rencontrez un arr√™t de postgres, vous devez il y a aussi un petit hack dans le syst√®me d'exploitation, comment tout fonctionne l√†-bas et comment cela fonctionne √† l'interface avec postgres. </p><br><p>  Si, par exemple, vous comparez avec Oracle, Oracle a, par exemple, ses propres sous-syst√®mes qui fonctionnent avec des entr√©es-sorties, c'est-√†-dire  ils ont d√©pass√© le syst√®me d'exploitation, ils peuvent travailler directement avec le disque, mais dans Posgres ce n'est pas le cas, vous devez savoir comment le syst√®me d'exploitation fonctionne avec la base de donn√©es. </p><br><p>  <strong>Oleg</strong> : avez-vous d√ª prendre en charge les postgres sous Windows? </p><br><p>  <strong>Alexei</strong> : oui, je le devais, nous avons un client, ils sont avec Windows, nous avons servi une sorte de bureau de Saint-P√©tersbourg, nous avons fait un audit de la base de donn√©es pour eux.  Leur base √©tait sur Windows, c'√©tait g√©n√©ralement effrayant, nous nous sommes connect√©s √† un protocole via le protocole du terminal, Remote Desktop a ouvert, nous y avons lanc√© des choses li√©es √† l'enregistrement des performances.  Bref, c'√©tait difficile, effrayant, comment un terrible r√™ve est maintenant rappel√©.  Et maintenant, les clients sont pratiquement tous assis sur Linux.  Presque personne n'est sous Windows. </p><br><p>  <strong>Oleg</strong> : quelle est la principale douleur sur Postgre que tout le monde peut remarquer? </p><br><p>  <strong>Alexey</strong> : beaucoup de gens veulent un auto-filer et un multi-master.  Eh bien, multima√Ætre, bien s√ªr, une telle chose, inaccessible.  Mais tout le monde a travaill√© avec Galera (avec Mysql), et ils disent: pourquoi, nous voulons aussi un multimaster en cours. </p><br><p>  Eh bien, dans le progr√®s, il y a de telles choses, mais pas dans le noyau progressif lui-m√™me, il y a des choses qui mettent en ≈ìuvre le type de multi-master, mais qui n'ont pas encore √©t√© produites du tout.  Mais les gens veulent un multima√Ætre.  Et les gens veulent √©galement un fichier automatique.  Mais maintenant, Dieu merci Patroni est apparu, sur Patroni vous pouvez faire un auto-filer, les gens l'introduisent lentement.  Eh bien, en g√©n√©ral, de mon point de vue, Patroni est devenu la norme de facto.  De nombreuses grandes entreprises le mettent d√©j√† en ≈ìuvre.  Le m√™me Gitlab, ils ont r√©cemment fait des reportages, ils utilisent Patroni, ils sont contents de tout, tout le monde est content. </p><br><p>  <strong>Anton</strong> : √âcoutez, pouvez-vous nous dire en quelques mots ce que sont les m√©c√®nes pour les simples programmeurs?  Nous sommes principalement √† l'√©coute des chefs d'√©quipe et des programmeurs </p><br><p>  <strong>Nikita</strong> : attendez, puis-je vous tuer, et je demanderai encore plus aux non-programmeurs d'expliquer ce qu'est un multima√Ætre </p><br><p>  <strong>Alexei</strong> : regardez, imaginez maintenant, Antokha est un programmeur, il √©crit des applications, et l'application doit stocker ses donn√©es quelque part.  Il les met √† la base, √† l'ambassade.  √Ä un moment donn√©, la base de donn√©es se trouve sur un serveur, puis sur le serveur une fois - et a cess√© de fonctionner.  L'alimentation est grill√©e et l'application doit continuer √† fonctionner avec la base.  Et ici, l'option se pose que nous devons avoir une sorte de copie de la base de donn√©es et continuer √† travailler avec elle.  Et soit basculez vers elle, et id√©alement, ne faites aucune commutation pour que notre application connaisse cette deuxi√®me base et continue √† y √©crire. </p><br><p>  Il s'agit en fait d'un multima√Ætre, lorsque nous avons plusieurs n≈ìuds disponibles pour la lecture et l'√©criture, et notre application peut simultan√©ment travailler avec eux et √©crire des donn√©es sur l'un de ces n≈ìuds et lire des donn√©es √† partir de ces n≈ìuds, mais la nature est telle qu'elle pas tout √† fait id√©alement atteint, et il y a des avantages et des inconv√©nients, il y a des inconv√©nients, leurs propres cas d'utilisation pour l'utilisation du multima√Ætre.  L'exemple le plus courant est que vous ne pouvez pas √©crire les m√™mes donn√©es, relativement parlant, dans deux instances, par exemple, travailler avec la m√™me table, √©crire dans la m√™me table via deux serveurs, il y aura des conflits et ils doivent √™tre r√©solus, c'est un probl√®me il est donc n√©cessaire d'√©crire si nous √©crivons dans une table, alors nous n'√©crivons que via un seul serveur. </p><br><p>  <strong>Nikita</strong> : et cela est directement li√© au ventilateur automatique, oui, est-il connect√©? </p><br><p>  <strong>Alexei</strong> : oui, et cela est d√ª au voltigeur, ici, pour ainsi dire, l'un suit l'autre.  Si nous ne pouvons pas nous permettre un multima√Ætre, nous voulons une sorte de m√©canisme transparent qui fera passer le n≈ìud de rechange en mode ma√Ætre, c'est-√†-dire  nous avons une application, cela fonctionne, et d√®s que l'application est supprim√©e de la base de donn√©es, le d√©veloppeur ne veut pas changer les configurations de cette application et y indiquer la nouvelle adresse de base de donn√©es, red√©marrez l'application, surtout s'il y a beaucoup d'applications.  Je veux une sorte de m√©canisme transparent qui fonctionnera quelque part sous le capot, changera de base de donn√©es et notre application fonctionnera avec la m√™me adresse et continuera √† lire √† partir de cette base de donn√©es.  Pour ce faire, vous avez d√©j√† besoin d'un auto-filer qui bascule de mani√®re transparente le n≈ìud de rechange en mode assistant, et pour cela Patroni est juste utilis√© </p><br><p>  <strong>Anton</strong> : Patroni est-il un pur interrupteur ou une fourchette de postgres, une sorte d'add-on? </p><br><p>  <strong>Alexei</strong> : c'est pour ainsi dire un service distinct, un processus distinct qui s'ex√©cute sur un h√¥te avec une base de donn√©es.  Et il surveille l'√©tat du cluster post-cluster.  Deux objectifs sont poursuivis ici: le basculement automatique et la gestion des clusters.  Mais dans ce cas, nous obtenons un cluster distribu√©, mais nous avons plusieurs n≈ìuds dans le cluster, un ma√Ætre et plusieurs r√©pliques.  En cons√©quence, vous devez surveiller en permanence l'√©tat du cluster, voir en permanence si le ma√Ætre est vivant.  S'il est mort subitement - vous devez passer au r√¥le de "ma√Ætre" d'un autre serveur.  Et pour cela, il est utilis√©, en g√©n√©ral, il existe deux approches, comment prendre en charge ce cluster de vues, la repr√©sentation dans le cluster de la fa√ßon dont il devrait vivre √† l'heure actuelle.  Il existe une option lorsque chacun des n≈ìuds du cluster - ils se v√©rifient.  Et vous pouvez stocker cet √©tat √† l'ext√©rieur, c'est-√†-dire  En dehors du cluster.  Et juste Patroni utilise cette approche, il prend et stocke l'√©tat du cluster dans le troisi√®me syst√®me.  Il s'agit g√©n√©ralement d'une sorte de DCS (configuration du syst√®me de stockage distribu√©).  Il peut s'agir de etcd, consul ou kuberenetesovsky etcd.  C'est-√†-dire  en fonction de ce que l'infrastructure est.  Eh bien, Patroni enregistre simplement un √©tat de cluster dans ce syst√®me DCS et le met √† jour. </p><br><p>  Si soudainement l'un des n≈ìuds tombe en panne, un nouveau n≈ìud est s√©lectionn√©.  Si ce ma√Ætre, par exemple, est tomb√©, un nouveau ma√Ætre est s√©lectionn√© et cet √©tat est √† nouveau mis √† jour dans DCS.  Et ici, aux d√©pens de DCS, Patroni prend en charge la sant√© du cluster. </p><br><p>  <strong>Anton</strong> : Et si le r√©seau clignait entre Patroni et la base? </p><br><p>  <strong>Alexei</strong> : √âcoutez, il y a une base de donn√©es, c'est soit une sorte de serveur, soit, disons, dans les Kubernetes, √ßa peut √™tre une sorte de sous-marin.  Prenons un cas simple, disons que c'est un serveur.  Sur le m√™me serveur, nous avons une base de donn√©es en cours d'ex√©cution et sur le m√™me serveur, nous ex√©cutons l'agent Patroni.  C'est un processus l√©ger, ils travaillent sur le m√™me h√¥te et communiquent relativement sur localhost.  Notre r√©seau peut clignoter entre le r√©f√©rentiel DCS et l'h√¥te sur lequel la base et Patroni fonctionnent. </p><br><p>  Il peut y avoir diff√©rentes options.  Selon la gravit√© de ce clignotement du r√©seau.  Il arrive que s'il s'agissait d'un ma√Ætre et qu'il se soit av√©r√© isol√©, les autres n≈ìuds constateront que le ma√Ætre √©tait parti.  Ils s√©lectionneront simplement un nouveau ma√Ætre, et il verra l'ancien ma√Ætre qu'il est isol√©, et Patroni le red√©marrera en mode lecture seule.  Eh bien, pour qu'il n'y ait pas de cerveau divis√©.  C'est mauvais si notre application √©crit sur deux n≈ìuds en m√™me temps.  Ensuite, les d√©veloppeurs devront ratisser les donn√©es, et c'est un travail tr√®s difficile - collecter ces donn√©es sous une forme coh√©rente.  Par cons√©quent, le mandrin red√©marre simplement le n≈ìud en lecture seule et c'est tout, et cela fonctionne.  D√®s que le r√©seau sera r√©tabli, Patroni pourra atteindre DCS, ils coordonneront la vue du cluster plus loin et arriveront √† une sorte de solution convenue.  Tr√®s probablement, ce n≈ìud isol√©, qui √©tait un ancien ma√Ætre, se connectera en tant que r√©plique au nouveau ma√Ætre ... </p><br><p>  <strong>Anton</strong> .  Eh bien, en pratique, comment √ßa marche?  Y a-t-il des probl√®mes, des pi√®ges.  Pour qu'Oleg prenne et mette en ≈ìuvre, par exemple, Patroni, il doit prendre une d√©cision √† cet effet. </p><br><p>  <strong>Oleg</strong> .  Oui tout de suite </p><br><p>  <strong>Alexey</strong> .  Eh bien, nous utilisons Patroni avec des clients depuis l'ann√©e derni√®re.  Nous avons le premier client apparu √† mon avis en novembre 2018.  Et √† cette √©poque, nous n'avions pas une tr√®s bonne id√©e de la fa√ßon de travailler avec cela, mais pour l'ann√©e o√π nous avons travaill√©, en principe, tout nous convient.  Nous avons appris √† le cuisiner.  En principe, pour le rappeler, en g√©n√©ral, il n'a pas vraiment besoin de beaucoup d'√©tapes, litt√©ralement deux ou trois actions du c√¥t√© des postgres, du c√¥t√© des configurations de patron, et tout cela fonctionne plut√¥t bien. </p><br><p>  La pi√®ce est fiable.  C'est d'abord simple, il est √©crit en Python, il mange peu de m√©moire et fonctionne en principe de mani√®re fiable.  La seule chose dans l'infrastructure devrait √™tre ce DCS.  Mais en r√®gle g√©n√©rale, il est n√©cessaire soit Consul ou etcd.  Mais pour de nombreuses entreprises, cette chose est d√©j√† utilis√©e pour toutes sortes de d√©couvertes de services diff√©rentes, donc, en r√®gle g√©n√©rale, cela ne pose aucun probl√®me. </p><br><p>  Et quel genre de probl√®mes surviennent: le probl√®me le plus fondamental auquel les gens ne se sentent pas imm√©diatement est que nous pouvons perdre certaines des donn√©es avec le fichier automatique </p><br><p>  <strong>Oleg</strong> : √† cause du retard de r√©plication? </p><br><p>  <strong>Alexei</strong> : imaginez une situation o√π l'auto-filer se produit pendant la r√©plication, l'ancien ma√Ætre s'est d√©connect√©, mais nous y avons quand m√™me √©crit une partie des donn√©es.  Supposons qu'il y ait une sorte de retard de r√©plication, un nouveau ma√Ætre est s√©lectionn√© parmi d'autres r√©pliques.  Un nouveau ma√Ætre est lev√© et si Patroni est configur√© de mani√®re √† ce que le n≈ìud tomb√© soit automatiquement inclus dans le cluster, par exemple, le d√©marrage automatique des services est activ√©, puis lorsque l'ancien ma√Ætre monte, il voit qu'il n'est plus un ma√Ætre, il est derri√®re, il essaiera de se connecter au nouveau ma√Ætre et devenir son signal.  Et √† ce moment, il ex√©cute la commande pg_rewind. </p><br><p>  Cette commande rembobine le journal des transactions sur l'ancien n≈ìud (l'ancien ma√Ætre) jusqu'√† ce qu'il soit capable de se connecter au nouveau ma√Ætre, c'est-√†-dire que le journal des transactions est √©cras√©.  √Ä ce stade, nous pouvons perdre certaines donn√©es.  √Ä Patroni m√™me, il y a peu de protection, il y a quelques rebondissements qui permettent aux r√©pliques de ne pas participer aux √©lections avec un gros arri√©r√©.  Si, par exemple, toutes les r√©pliques ont un retard important, les √©lections ne seront tout simplement pas lanc√©es, puis l'intervention manuelle de l'administrateur est n√©cessaire pour que l'administrateur entre et d√©marre le fichier automatique √† la main.  Ou ils attendront tous que le vieux ma√Ætre se l√®ve.  Jusqu'√† ce que son travail soit restaur√©.  Et ils y seront d√©j√† connect√©s et continueront de l'attraper. </p><br><p>  Eh bien, c'est-√†-dire, dans Patroni, il existe des m√©canismes qui vous permettent de ne pas perdre de donn√©es, mais il y a un risque, vous devez donc soigneusement </p><br><p>  <strong>Anton</strong> : qu'en est-il de la r√©plication synchrone? </p><br><p>  <strong>Alexey</strong> : la r√©plication synchrone, vous voyez, lorsque nous utilisons la r√©plication synchrone, nous perdons des performances.  Tout le monde ne peut pas opter pour cette offre.  Mais si nous utilisons la r√©plication synchrone, le risque de perte de donn√©es est r√©duit.  Mais si nous utilisons plusieurs n≈ìuds, disons plus de deux, alors nous devons consid√©rer l'option lorsque nous avons un accident √† la fois sur le ma√Ætre et sur la r√©plique synchrone.  Et nous avons toujours une deuxi√®me r√©plique, et il peut s'av√©rer que nous pouvons la pi√©ger et perdre √† nouveau certaines donn√©es.  Diff√©rentes options sont possibles, elles doivent √™tre √©valu√©es, examin√©es et comprises si un tel comportement nous convient ou non. </p><br><p>  <strong>Anton</strong> : √©coute, juste deux serveurs √† tomber - c'est comme pr√©voir une invasion d'√©trangers </p><br><p>  <strong>Aleksey</strong> : et il y a un slammer sur la vieille femme </p><br><p>  <strong>Oleg</strong> : vous souvenez-vous du m√™me appel √† cinq heures du matin √† Lesha pour la derni√®re fois, √† quoi √©tait-il int√©ressant, Anton, et non pas que nous ayons imm√©diatement perdu deux bases? </p><br><p>  <strong>Anton</strong> : c'√©tait un facteur humain.  Eh bien oui, √ßa arrive. </p><br><p>  <strong>Alexey</strong> : au fait, je ne me souviens pas de la raison de l'appel </p><br><p>  <strong>Anton</strong> : nous y avons transf√©r√© deux serveurs, ils ont travaill√© en parall√®le, enregistr√© des donn√©es, √ßa n'a pas d'importance.  Et les syst√®mes pouvaient fonctionner sur un, mais l'un a √©t√© transf√©r√© vers un autre centre de donn√©es, sous tension.  Le deuxi√®me a √©t√© transport√© jusqu'√† pr√©sent, et l√† une sorte de c√¢blage a √©t√© touch√© au moment de l'installation, et l'ancien a √©galement √©t√© coup√© - ils ont m√©lang√© quelque chose.  En g√©n√©ral, nous deux serveurs sommes tomb√©s, avons commenc√© √† augmenter, et comme ils √©taient rigoureusement configur√©s pour l'enregistrement, ils avaient des points de contr√¥le tr√®s rares ou quelque chose comme √ßa.  √áa a commenc√© depuis longtemps, on ne comprenait pas ce qui se passait </p><br><p>  <strong>Oleg</strong> : cent concerts wal-logs </p><br><p>  <strong>Anton</strong> : nous ne comprenions pas ce qui se passait, pourquoi cela n'a pas commenc√©, et j'ai donc d√ª passer un appel.  Eh bien, en fait, il n'y avait rien de sp√©cial √† faire ... </p><br><p>  <strong>Alexei</strong> : eh bien, il y a la seule chose que nous avons probablement connect√©, nous avons regard√© que tout est en ordre </p><br><p>  <strong>Oleg</strong> : a confirm√© la mort du patient </p><br><p>  <strong>Anton</strong> : en fait, il fallait juste attendre, en gros. </p><br><p>  <strong>Alexey</strong> .  Oui, c'est un probl√®me connu.  Avec certains param√®tres, les points de contr√¥le sont longs.  Il y a un tel probl√®me. </p><br><p>  Mais en g√©n√©ral, si vous vous souvenez de cet appel de nuit, dans la pratique, nous appelons rarement la nuit, nous avons mis en place une automatisation sp√©ciale - en service, tout est comme il se doit, s√©lectionn√© selon un horaire sp√©cial.  Donc, si vous vous souvenez, peut-√™tre qu'une fois tous les six mois, quelqu'un appellera </p><br><p>  <strong>Oleg</strong> : tout de notre entreprise est probable </p><br><p>  <strong>Alexey</strong> : non, diff√©rent </p><br><p>  <strong>Anton</strong> : Oleg, appelle plus souvent </p><br><p>  <strong>Oleg</strong> : nous allons faire un basculement aujourd'hui, je vais probablement appeler </p><br><p>  <strong>Alexey</strong> : nous avons des gars, leur soir√©e se termine, ils vont juste travailler </p><br><p>  <strong>Anton</strong> : √©coute, Lech, tu as dit que Patroni avait des analogues.  En quoi diff√®rent-ils, quels sont </p><br><p>  <strong>Alexey</strong> : il y a essentiellement deux options, il y a repmgr, cette chose est apparue il y a longtemps, il y a environ 10 ans.  Il impl√©mente un m√©canisme lorsque les n≈ìuds d'un cluster post-gr√¢ce se v√©rifient mutuellement, qui est vivant, qui n'est pas vivant.  Mais √† mon avis ce n'est pas tr√®s, je n'aime pas vraiment ce sch√©ma de travail. </p><br><p>  Et il n'y a pas de filtre automatique pr√™t √† l'emploi, repmgr a √©t√© initialement affin√© sp√©cifiquement pour la gestion du cluster et pour la commutation manuelle, pour le basculement.  Et si vous souhaitez directement d√©poser automatiquement, vous devez installer les d√©mos repmgrd s√©par√©ment, et, il s'av√®re, le fichier automatique est d√©marr√© ici.  La chose est pratique, bonne, mais oui - nous n'avons pas de filtre automatique pr√™t √† l'emploi.  Vous devez le mettre s√©par√©ment.  En g√©n√©ral, la chose est bonne, pratique, dans le sens o√π elle est bien configurable, il est pratique de maintenir des clusters bas√©s sur des clusters.  Elle est tellement flexible, personnalisable.  Les r√©pliques peuvent √™tre vers√©es de diff√©rentes mani√®res.  Des sauvegardes, des r√©pliques aux autres, du ma√Ætre.  En bref, une chose si flexible, car 10 ans.  Et beaucoup de fonctionnalit√©s diff√©rentes y ont √©t√© int√©gr√©es, c'est tr√®s bien. </p><br><p>  Et une autre option est Stolon.  Il est apparu √† peu pr√®s en m√™me temps que Patroni, un peu plus tard.  Il est √©crit sur Go. </p><br><p>  Mais il a une architecture plus branch√©e.  Si vous ouvrez le site Web du projet, il y aura des photos et Stolon lui-m√™me se compose de plusieurs composants.  Il a des n≈ìuds de gardien qui fonctionnent avec des bases de donn√©es qui rel√®vent Postges.  Ensuite, il y a les soi-disant n≈ìuds Sentinel.  Ils surveillent l'√©tat du cluster, v√©rifient sa disponibilit√©, v√©rifient que les n≈ìuds sont vivants ou non vivants.  Ils g√®rent l'√©tat du cluster et le reconfigurent en cas de probl√®me. </p><br><p>  Et il y a ce qu'on appelle des n≈ìuds proxy, tout le trafic les traverse.  L'application client fonctionne avec des proxys.   -,  -   ,       .  C'est-√†-dire    .  ,   , Stolon     DCS,    consul, etcd.  -       . </p><br><p>    ,      -  ,    bare metal  ,  ,       - ,   .       .        (   -)    ,       ,       . </p><br><p>      ,     .      . ,           . ,         .     oltp-      .   Stolon    ,       . </p><br><p>     ,  6  8,    .     ,    ,  .   ,     ‚Äî wal_keep_segments ‚Äî   - ,   ,    , .      ,    -  . ,        .       .  C'est-√†-dire        ,    . , ,    .   ,     ‚Äî     .      . </p><br><p> <strong></strong> : , ,   -  Citus?   ,    . </p><br><p> <strong></strong> : Citus ‚Äî    . Citus   ,      CitusDB, -.       ,      ,     ,     </p><br><p> <strong></strong> :  ? </p><br><p> <strong></strong> :  ,  ,    .      .           ,  pg autofailover.       ,      .    ,      ,   . ,      ,        .    ,   ,  .    ,       ,        .  C'est-√†-dire         . </p><br><p> <strong></strong> :  Citus.    ,       ,          .   ‚Äî   ,    ... </p><br><p> <strong></strong> : , ,  </p><br><p> <strong></strong> : ,     ,           ,  ,   ,  </p><br><p> <strong></strong> :  ,     ,      .  ,   ,  ,   .     "in the wild"  .        ,    . </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un d√©chiffrement suppl√©mentaire du probl√®me sera publi√© sur Habr dans un proche avenir, mais pour l'instant abonnez-vous au podcast </font></font><a href="https://soundcloud.com/znprod" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zinc Prod</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , il y a beaucoup de choses int√©ressantes √† venir!</font></font></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485322/">https://habr.com/ru/post/fr485322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485300/index.html">D√©couverte d'une nouvelle √©pid√©mie de vers H2Miner exploitant Redis RCE</a></li>
<li><a href="../fr485304/index.html">Quelques astuces sur les √©l√©ments iframe</a></li>
<li><a href="../fr485312/index.html">DevOps pour applications mobiles</a></li>
<li><a href="../fr485316/index.html">Tous les SERP Google ressemblent d√©sormais √† des publicit√©s</a></li>
<li><a href="../fr485318/index.html">Ajout de beaut√© et d'interactivit√© aux ordinateurs portables Jupyter</a></li>
<li><a href="../fr485324/index.html">Multithreading dans les widgets Qt</a></li>
<li><a href="../fr485326/index.html">Cr√©ation de micro frontends √† l'aide d'√©l√©ments angulaires: guide du d√©butant</a></li>
<li><a href="../fr485328/index.html">Sp√©cifications sur les st√©ro√Ødes</a></li>
<li><a href="../fr485330/index.html">Comment battre au hasard sans √¢me dans les jeux roguelike</a></li>
<li><a href="../fr485334/index.html">Sondage de session</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>