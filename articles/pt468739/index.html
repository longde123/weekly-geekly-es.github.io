<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüé§ üßû üèåÔ∏è Fornecendo failover de armazenamento üíÖ üßëüèΩ ‚ôéÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Recentemente, foi realizado um webinar aberto "Fornecendo armazenamento tolerante a falhas" . Ele examinou quais problemas surgem no desi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fornecendo failover de armazenamento</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/468739/"><img src="https://habrastorage.org/webt/xb/zz/5e/xbzz5ehnjhdehz8jlxqrdnmvsve.jpeg"><br><br>  Ol√° pessoal!  Recentemente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">foi realizado</a> um webinar aberto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Fornecendo armazenamento tolerante a falhas"</a> .  Ele examinou quais problemas surgem no design das arquiteturas, por que a falha do servidor n√£o √© uma desculpa para travar um servidor e como reduzir ao m√≠nimo o tempo de inatividade.  O webinar foi organizado por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ivan Remen</a> , chefe de desenvolvimento de servidores do Citimobil e professor do curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"High</a> Load <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Architect"</a> . <br><br><hr><a name="habracut"></a><br><h3>  Por que se preocupar com a resili√™ncia de armazenamento? </h3><br>  Pensar na resili√™ncia do armazenamento escal√°vel e entender os problemas b√°sicos de armazenamento em cache deve estar <b>no est√°gio de inicializa√ß√£o</b> .  √â claro que, quando voc√™ cria uma inicializa√ß√£o, no in√≠cio voc√™ cria a vers√£o m√≠nima do produto.  Por√©m, quanto mais voc√™ cresce, mais rapidamente obt√©m produtividade, o que pode levar a uma parada completa dos neg√≥cios.  E se voc√™ receber dinheiro de investidores, √© claro que eles tamb√©m exigir√£o crescimento constante e novos recursos de neg√≥cios.  Para encontrar o equil√≠brio certo, voc√™ precisa escolher entre velocidade e qualidade.  Ao mesmo tempo, voc√™ n√£o pode sacrificar um ou outro, e se voc√™ sacrifica - ent√£o conscientemente e dentro de certos limites.  No entanto, n√£o existem receitas universais aqui, assim como solu√ß√µes ideais. <br><br><h3>  Descansamos contra a base da leitura </h3><br>  Este √© o primeiro cen√°rio.  Imagine que temos 1 servidor, cuja carga no processador ou no disco r√≠gido √© de 99%.  Nesse caso: <br><br><ul><li>  90% dos pedidos s√£o lidos; </li><li>  10% dos pedidos s√£o um registro. </li></ul><br>  A melhor solu√ß√£o nessa situa√ß√£o √© pensar em r√©plicas.  Porque  Esta √© a solu√ß√£o mais barata e f√°cil. <br><br><img src="https://habrastorage.org/webt/d9/ui/dz/d9uidzanwwt39qklkrm9xjq940q.jpeg"><br><br>  A replica√ß√£o √© classificada: <br><br>  1. Por sincroniza√ß√£o: <br><br><ul><li>  s√≠ncrona; </li><li>  ass√≠ncrono; </li><li>  semi-s√≠ncrona. </li></ul><br>  2. De acordo com dados port√°teis: <br><br><ul><li>  l√≥gico (baseado em linhas, baseado em instru√ß√µes, misto); </li><li>  f√≠sico. </li></ul><br>  3. Pelo n√∫mero de n√≥s por registro: <br><br><ul><li>  mestre / escravo; </li><li>  mestre / mestre. </li></ul><br>  4. Pelo iniciador: <br><br><ul><li>  puxar </li><li>  empurrar </li></ul><br>  E agora a <b>tarefa √© sobre um balde de √°gua</b> .  Imagine que temos MySQL e replica√ß√£o ass√≠ncrona de mestre-escravo.  A limpeza est√° ocorrendo no centro de distribui√ß√£o e, como resultado, o limpador trope√ßa e derrama um balde de √°gua no servidor com a base principal.  A automa√ß√£o alterna com √™xito um dos mais recentes escravos para o modo mestre.  E tudo continua a funcionar.  Onde est√° o problema? <br><br>  A resposta √© simples - perdemos transa√ß√µes que n√£o conseguimos replicar.  Consequentemente, a propriedade D do ACID √© violada. <br><br>  Agora vamos falar sobre como a replica√ß√£o ass√≠ncrona (MySQL) funciona: <br><br><ol><li>  registrar uma transa√ß√£o no mecanismo de armazenamento (InnoDB); </li><li>  registrar uma transa√ß√£o em um log bin√°rio; </li><li>  conclus√£o da transa√ß√£o no mecanismo de armazenamento; </li><li>  confirma√ß√£o de devolu√ß√£o ao cliente; </li><li>  transferir parte do log para a r√©plica; </li><li>  execu√ß√£o de uma transa√ß√£o em uma r√©plica (p. 1-3). </li></ol><br>  E agora a pergunta √©: o que precisa ser alterado nos par√°grafos acima para que nunca terminemos com replica√ß√£o? <br><br>  E apenas dois pontos precisam ser trocados: 4 e 5 ("transferindo parte do log para a r√©plica" e "retornando confirma√ß√£o ao cliente").  Assim, se o n√≥ principal desaparecer, sempre teremos um log de transa√ß√µes em algum lugar (ponto 2).  E se a transa√ß√£o for registrada no log bin√°rio, a transa√ß√£o tamb√©m acontecer√° em algum momento. <br><br>  Como resultado, obtemos replica√ß√£o semi-s√≠ncrona (MySQL), que funciona da seguinte maneira: <br><br><ol><li>  registrar uma transa√ß√£o no mecanismo de armazenamento (InnoDB); </li><li>  registrar uma transa√ß√£o em um log bin√°rio; </li><li>  conclus√£o da transa√ß√£o no mecanismo de armazenamento; </li><li>  transferir parte do log para a r√©plica; </li><li>  confirma√ß√£o de devolu√ß√£o ao cliente; </li><li>  execu√ß√£o de uma transa√ß√£o em uma r√©plica (p. 1-3). </li></ol><br><h3>  Sincroniza√ß√£o vs semi-sincroniza√ß√£o e async vs semi-sincroniza√ß√£o </h3><br>  Por alguma raz√£o, na R√∫ssia, a maioria das pessoas n√£o ouviu falar sobre replica√ß√£o semi-s√≠ncrona.  A prop√≥sito, √© bem implementado no PostgreSQL e n√£o muito no MySQL.  Leia mais sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , mas a tese pode ser formulada da seguinte maneira: <br><br><ul><li>  a replica√ß√£o semi-s√≠ncrona ainda est√° atrasada (mas n√£o tanto) quanto a ass√≠ncrona; </li><li>  n√≥s n√£o perdemos transa√ß√µes; </li><li>  basta levar os dados para apenas um escravo. </li></ul><br>  A prop√≥sito, a replica√ß√£o semi-s√≠ncrona √© usada no Facebook. <br><br><h3>  Descansamos contra a base recorde </h3><br>  Vamos falar sobre um problema diametralmente oposto quando temos: <br><br><ul><li>  90% dos pedidos - registro; </li><li>  10% dos pedidos s√£o lidos; </li><li>  1 servidor; </li><li>  carga - 99% (processador ou disco r√≠gido). </li></ul><br>  Fragmento conhecido vem em socorro aqui.  Mas agora vamos falar de outra coisa: <br><br><img src="https://habrastorage.org/webt/7n/5e/qe/7n5eqegsarbxaze3guvezyqdhuu.jpeg"><br><br>  Muitas vezes, nesses casos, eles come√ßam a usar o mestre-mestre.  No entanto, <b>isso n√£o ajuda nessa situa√ß√£o</b> .  Porque  √â simples: o registro no servidor n√£o fica menor.  Afinal, a replica√ß√£o implica que h√° dados em todos os n√≥s.  Com a replica√ß√£o baseada em instru√ß√µes, o SQL ser√° executado em TODOS os n√≥s.  C baseado em linha √© um pouco mais f√°cil, mas ainda caro.  E tamb√©m mestre-mestre tem problemas com conflitos. <br><br>  De fato, faz sentido usar master-master nas seguintes situa√ß√µes: <br><br><ul><li>  toler√¢ncia a falhas de grava√ß√£o (a id√©ia √© que voc√™ sempre grave em apenas um mestre).  Voc√™ pode implementar usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o endere√ßo IP virtual</a> ; </li><li>  sistemas distribu√≠dos geograficamente. </li></ul><br>  No entanto, lembre-se de que a replica√ß√£o mestre-mestre √© sempre dif√≠cil.  E muitas vezes mestre-mestre traz mais problemas do que resolve. <br><br><h3>  Sharding </h3><br>  J√° mencionamos sharding.  Em resumo, o sharding √© uma maneira infal√≠vel de escalar um registro.  A ideia √© distribuir dados entre servidores independentes (mas nem sempre).  Cada fragmento pode se replicar independentemente. <br><br>  <b>A primeira regra do sharding √© que os dados usados ‚Äã‚Äãjuntos devem estar no mesmo shard.</b>  A <code>sharding_key -&gt; shard_id</code> funciona <code>sharding_key -&gt; shard_id</code> .  Assim, <code>sharding_key</code> para os dados que s√£o usados ‚Äã‚Äãjuntos devem corresponder.  A primeira dificuldade √© que, se voc√™ escolher a chave <code>sharding_key</code> errada, ser√° muito dif√≠cil reorganizar tudo.  Em segundo lugar, se voc√™ tiver algum tipo de <code>sharding_key</code> , algumas solicita√ß√µes ser√£o muito dif√≠ceis de executar.  Por exemplo, voc√™ n√£o pode encontrar o valor m√©dio. <br><br>  Para demonstrar isso, vamos imaginar que temos dois shards com tr√™s valores em cada: (1; 2; 3) (0; 0; 500).  O valor m√©dio ser√° igual a (1 + 2 + 3 + 500) / 6 = 84.33333. <br><br>  Agora imagine que temos dois servidores independentes.  E recalcule o valor m√©dio separadamente para cada fragmento.  No primeiro deles, temos 2, no segundo - 166.66667.  E mesmo que calculemos a m√©dia desses valores, ainda obteremos um n√∫mero que ser√° diferente do correto: (2 + 166.66667) / 2 = 86.33334. <br><br>  Ou seja, a <b>m√©dia dos meios n√£o √© igual √† m√©dia de tudo:</b> <br><br><pre> <code class="plaintext hljs">avg(a, b, c, d) != avg(avg(a, b) + (avg(c, d))</code> </pre> <br>  Matem√°tica simples, mas √© importante lembrar. <br><br><h3>  Tarefa de sharding </h3><br>  Suponha que tenhamos um sistema de di√°logo em uma rede social.  S√≥ pode haver 2 pessoas em um di√°logo.  Todas as mensagens est√£o em uma tabela, na qual existe: <br><br><ul><li>  ID da mensagem </li><li>  ID do remetente </li><li>  ID do destinat√°rio </li><li>  texto da mensagem; </li><li>  data em que a mensagem foi enviada; </li><li>  algumas bandeiras. </li></ul><br>  Qual chave de sharding deve ser escolhida com base no fato de termos a primeira regra de sharding descrita acima? <br><br>  Existem v√°rias op√ß√µes para resolver esse problema cl√°ssico: <br><br><ul><li>  crc32 (id_src // id_dst); </li><li>  crc32 (1 // 2)! = crc32 (2 // 1); </li><li>  crc32 (de + a)% n; </li><li>  crc32 (min (de, para). max (de, para))% n. </li></ul><br><h3>  Caches </h3><br>  E algumas palavras sobre caches.  Podemos dizer que os <b>caches s√£o um antipadr√£o</b> , embora se possa argumentar com essa afirma√ß√£o (muitas pessoas gostam de usar caches).  Mas, em geral, os caches s√£o necess√°rios apenas para aumentar a taxa de resposta.  E eles n√£o podem ser configurados para suportar a carga. <br><br>  A conclus√£o √© simples - devemos viver em sil√™ncio, sem caches.  A √∫nica raz√£o pela qual eles podem ser necess√°rios √© exatamente pelo mesmo motivo pelo qual s√£o necess√°rios no processador: aumentar a velocidade de resposta.  Se o banco de dados n√£o suportar a carga como resultado do cache desaparecer, isso √© ruim.  Esse √© um padr√£o arquitetural extremamente malsucedido, portanto n√£o deve ser.  E quaisquer recursos que voc√™ tiver, um dia seu cache certamente cair√°, independentemente do que voc√™ fa√ßa. <br><br>  <b>Os problemas de cache s√£o:</b> <br><br><ul><li>  comece com um cache frio; </li><li>  problema de invalida√ß√£o de cache; </li><li>  consist√™ncia de cache. </li></ul><br>  Se voc√™ ainda usa caches, o hash consistente o ajudar√°.  Essa √© uma maneira de criar tabelas de hash distribu√≠das, nas quais a falha de um ou mais servidores de armazenamento n√£o leva √† necessidade de uma realoca√ß√£o completa de todas as chaves e valores armazenados.  No entanto, voc√™ pode ler mais sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><img src="https://habrastorage.org/webt/_t/qi/8o/_tqi8oaxuz7fbwad6wzmi8nf2o4.jpeg"><br><br>  Bem, obrigado por assistir!  Para n√£o perder nada da √∫ltima palestra, √© melhor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">assistir ao webinar inteiro</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468739/">https://habr.com/ru/post/pt468739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468729/index.html">Aplicamos a√ß√µes do github para IC e publica√ß√£o autom√°tica no npm</a></li>
<li><a href="../pt468731/index.html">Excelente Quantum Excellence FAQ por Scott Aaronson</a></li>
<li><a href="../pt468733/index.html">Aprenda o Bootstrap rapidamente com essas 10 dicas √∫teis</a></li>
<li><a href="../pt468735/index.html">Baixar musica VKontakte</a></li>
<li><a href="../pt468737/index.html">Resenha do livro: "Life 3.0. Ser homem na era da intelig√™ncia artificial ‚Äù</a></li>
<li><a href="../pt468741/index.html">Internet na cidade inteligente</a></li>
<li><a href="../pt468747/index.html">Como passei o ver√£o na VK</a></li>
<li><a href="../pt468749/index.html">Eventos do Android LiveData</a></li>
<li><a href="../pt468753/index.html">Dalt√¥nico - amigo do homem (o Minist√©rio da Sa√∫de n√£o est√° certo)</a></li>
<li><a href="../pt468757/index.html">Conex√£o MySQL ap√≥s o erro 1040: muitas conex√µes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>