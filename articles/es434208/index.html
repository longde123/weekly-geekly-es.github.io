<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüíª üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üë©üèæ‚Äçüè´ C√≥mo se salv√≥ nuestro viernes negro üåû üë®‚ÄçüöÄ ‚è©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anteriormente, hablamos sobre c√≥mo, a medida que crec√≠a la carga, abandonamos gradualmente el uso de Python en el back-end de servicios cr√≠ticos en la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo se salv√≥ nuestro viernes negro</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/434208/">  Anteriormente, hablamos sobre c√≥mo, a medida que crec√≠a la carga, abandonamos gradualmente el uso de Python en el back-end de servicios cr√≠ticos en la producci√≥n, reemplaz√°ndolo con Go.  Y hoy, yo, Denis Girko, l√≠der del equipo de desarrollo de Madmin, quiero compartir detalles: c√≥mo y por qu√© sucedi√≥ esto en el ejemplo de uno de los servicios m√°s importantes para nuestro negocio: calcular el precio teniendo en cuenta los descuentos en cupones. <br><br><img src="https://habrastorage.org/webt/8q/bo/y4/8qboy4stjrxnm432zasibweeyqe.jpeg"><br><a name="habracut"></a><br>  La mec√°nica de trabajar con cupones probablemente est√© representada por cualquiera que haya realizado al menos una vez compras en tiendas en l√≠nea.  En una p√°gina especial o directamente en la cesta, ingresa el n√∫mero de cup√≥n y los precios se vuelven a calcular de acuerdo con el descuento prometido.  El c√°lculo depende de qu√© tipo de descuento ofrece el cup√≥n: en porcentaje, en forma de una cantidad fija o usando algunas otras matem√°ticas (por ejemplo, adicionalmente tomamos en cuenta los puntos del programa de lealtad, las promociones de la tienda, los tipos de productos, etc.).  Naturalmente, el pedido ya se emite con nuevos precios. <br><br>  Las empresas est√°n encantadas con todos estos mecanismos de trabajar con los precios, pero queremos hablar sobre el servicio desde un punto de vista ligeramente diferente. <br><br><h2>  Como funciona </h2><br>  Para la fijaci√≥n de precios teniendo en cuenta todas estas dificultades en el backend, ahora tenemos un servicio por separado.  Sin embargo, no siempre fue independiente.  El servicio apareci√≥ uno o dos a√±os despu√©s del inicio de la tienda en l√≠nea, y para 2016 era parte de un gran monolito de Python que inclu√≠a una amplia variedad de componentes para la actividad de marketing (Madmin).  Se destac√≥ como un "bloque" independiente m√°s tarde, mientras se mov√≠a hacia la arquitectura de microservicios. <br><br>  Como suele ser el caso con los monolitos, Madmin fue modificado y correspondi√≥ parcialmente con una gran cantidad de desarrolladores.  Las bibliotecas de terceros se integraron all√≠, lo que simplific√≥ el desarrollo, pero a menudo no tuvo el mejor efecto en el rendimiento.  Sin embargo, en ese momento, no nos importaba realmente la resistencia a las cargas pesadas durante las ventas, ya que el servicio hizo un excelente trabajo.  Pero 2016 lo ha cambiado todo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e40/3a3/3e1/e403a33e16fea41905491776c8b0c26e.jpg"><br><br>  En los Estados Unidos, el "Viernes Negro" se conoce desde los a√±os 60 del siglo pasado.  En Rusia, comenz√≥ a lanzarse en la d√©cada de 2010, mientras que la acci√≥n tuvo que ser creada desde cero: el mercado no estaba listo para ello.  Sin embargo, los esfuerzos de los organizadores no fueron en vano, y con cada a√±o el tr√°fico de usuarios a nuestro sitio aument√≥ durante los d√≠as de ventas.  Y, por lo tanto, nuestra colisi√≥n con la carga, excesiva para esa versi√≥n del servicio de c√°lculo de precios, era solo cuesti√≥n de tiempo. <br><br><h2>  Black Friday 2016. Y nos quedamos dormidos </h2><br>  Dado que la idea de venta funcion√≥ en todo su potencial, el "Viernes Negro" difiere de cualquier otro d√≠a del a√±o en que a medianoche llega a la tienda una audiencia del sitio web aproximadamente semanal.  Este es un per√≠odo dif√≠cil para todos los servicios.  Incluso en aquellos de ellos que funcionan sin problemas durante todo el a√±o, a veces surgen problemas. <br><br>  Ahora nos estamos preparando para cada nuevo "Viernes Negro", imitando la carga esperada, pero en 2016 todav√≠a actuamos de manera diferente.  Al probar Madmin antes de un d√≠a importante, probamos la resistencia de carga utilizando escenarios de comportamiento del usuario en d√≠as regulares.  Al final result√≥ que, esta prueba no refleja la situaci√≥n real, porque en el "Viernes Negro" viene mucha gente con el mismo cup√≥n.  Como resultado, el servicio de c√°lculo de precios teniendo en cuenta este descuento, incapaz de hacer frente a una carga triple (en comparaci√≥n con los d√≠as normales), bloque√≥ la capacidad de atender a los clientes durante dos horas durante el pico m√°s caliente de la venta. <br><br>  El servicio "fue" una hora antes de la medianoche.  Todo comenz√≥ con una interrupci√≥n en la conexi√≥n a la base de datos (MySQL en ese momento), despu√©s de lo cual no todas las copias en ejecuci√≥n del servicio de c√°lculo de precios pudieron volver a conectarse.  Y aquellos que a√∫n estaban conectados no resistieron la carga y dejaron de responder, quedando atrapados en las cerraduras de la base. <br><br>  Por coincidencia, el joven permaneci√≥ de turno entonces, quien en el momento de la ca√≠da del servicio estaba en camino desde la oficina de su casa.  Solo pudo conectarse con el problema cuando lleg√≥ al lugar y llam√≥ a la "artiller√≠a pesada", el oficial de servicio de emergencia.  Juntos, normalizaron la situaci√≥n, sin embargo, solo despu√©s de dos horas. <br><br>  A medida que comenzaron los procedimientos, comenzaron a abrirse detalles sobre cu√°n sub√≥ptimo era el servicio.  Por ejemplo, result√≥ que para calcular un cup√≥n, se realizaron 28 consultas a la base de datos (no es sorprendente que todo funcionara con una utilizaci√≥n del 100% de la CPU).  Los usuarios mencionados anteriormente con el mismo cup√≥n del Black Friday no simplificaron la situaci√≥n, especialmente porque ten√≠amos un contador de aplicaciones para todos los cupones, por lo que cada uso aument√≥ la carga al referirse a este contador. <br><br>  El 2016 nos dio mucho que pensar, principalmente sobre c√≥mo ajustar nuestro trabajo con cupones y pruebas para que esta situaci√≥n no vuelva a suceder.  Y en n√∫meros que el viernes se describe mejor en esta imagen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75e/310/1fc/75e3101fca74fc4e8b220673619eaada.jpg"><br>  <i>Los resultados del Black Friday 2016</i> <br><br><h2>  Black Friday 2017. Nos est√°bamos preparando en serio, pero ... </h2><br>  Habiendo recibido una buena lecci√≥n, nos preparamos de antemano para el pr√≥ximo "Viernes Negro", despu√©s de haber reconstruido y optimizado seriamente el servicio.  Por ejemplo, finalmente creamos dos tipos de cupones: l√≠mite e ilimitado: para evitar bloqueos en el acceso simult√°neo a la base de datos, eliminamos la entrada a la base de datos del script para aplicar el cup√≥n popular.  Al mismo tiempo, 1‚Äì2 meses antes del Black Friday, cambiamos de MySQL a PostgreSQL en el servicio, lo que, junto con la optimizaci√≥n del c√≥digo, redujo el n√∫mero de llamadas a la base de datos de 28 a 4‚Äì5. Estas mejoras permitieron extender el servicio de prueba a los requisitos de SLA - respuesta en 3 segundos, percentil 95 a 600 RPS. <br><br>  Sin tener idea de cu√°nto nuestras mejoras aceleraron el trabajo de la versi√≥n anterior del servicio en producci√≥n, en ese momento se estaban preparando dos versiones de c√≥digo Python para el Black Friday a la vez: una versi√≥n existente altamente optimizada y un c√≥digo completamente nuevo escrito desde cero.  En producci√≥n, se lanz√≥ el segundo, que se prob√≥ antes de este d√≠a y esta noche.  Sin embargo, como result√≥ "en batalla", un poco poco probado. <br><br>  El d√≠a de "emergencia" con la llegada del flujo principal de clientes, la carga del servicio comenz√≥ a crecer exponencialmente.  Algunas solicitudes se procesaron hasta dos minutos.  Debido al largo procesamiento de algunas solicitudes, la carga sobre otros trabajadores creci√≥. <br><br>  Nuestra tarea principal era servir un tr√°fico tan valioso para los negocios.  Pero se hizo evidente que "fundir con hierro" no resuelve el problema y, en cualquier momento, el n√∫mero de trabajadores ocupados alcanzar√° el 100%.  Sin saber a qu√© nos enfrentamos exactamente, decidimos activar harakiri en uWSGI y simplemente concretar solicitudes largas (que se procesan durante m√°s de 6 segundos) para liberar recursos para los normales.  Y realmente ayud√≥ a resistir: los trabajadores comenzaron a ser liberados solo un par de minutos antes de estar completamente exhaustos. <br><br>  Un poco m√°s tarde, descubrimos la situaci√≥n ... Result√≥ que se trataba de pedidos con cestas muy grandes, de 40 a 100 productos, y con un cup√≥n espec√≠fico que ten√≠a restricciones en el rango.  Esta situaci√≥n fue mal resuelta por el nuevo c√≥digo.  Mostr√≥ un trabajo incorrecto con la matriz, que se convirti√≥ en una recursi√≥n infinita.  Es curioso que luego probamos un caso con cestas grandes, pero no en combinaci√≥n con un cup√≥n complicado.  Como soluci√≥n, simplemente cambiamos a una versi√≥n diferente del c√≥digo.  Es cierto que esto sucedi√≥ tres horas antes del final del Black Friday.  A partir de este momento, todas las cestas comenzaron a procesarse correctamente.  Y aunque completamos el plan de ventas en ese momento, evitamos problemas globales milagrosos debido a la carga cinco veces el d√≠a habitual. <br><br><h2>  Viernes negro 2018 </h2><br>  Para 2018, para los servicios altamente cargados que sirven al sitio, gradualmente comenzamos a implementar Go.  Dada la historia de los viernes negros anteriores, el servicio de c√°lculo de descuentos fue uno de los primeros candidatos para el procesamiento. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f2/257/86a/2f225786a88b927c087c904c36702203.jpg"><br><br>  Por supuesto, podr√≠amos guardar la versi√≥n de Python que ya fue "probada en la batalla", y antes del nuevo "Viernes Negro" podr√≠amos apagar bibliotecas pesadas y arrojar c√≥digo no √≥ptimo.  Sin embargo, Golang ya hab√≠a echado ra√≠ces en ese momento y parec√≠a m√°s prometedor. <br><br>  Cambiamos a un nuevo servicio este verano, as√≠ que antes de la pr√≥xima venta logramos probarlo bien, incluso en un perfil de carga creciente. <br><br>  Durante las pruebas, result√≥ que la debilidad en t√©rminos de altas cargas sigue siendo nuestra base.  Las transacciones demasiado largas llevaron al hecho de que seleccionamos el conjunto completo de conexiones, y las solicitudes se pusieron en cola.  As√≠ que tuvimos que rehacer un poco la l√≥gica de la aplicaci√≥n, reduciendo el uso de la base de datos al m√≠nimo (refiri√©ndose a ella solo cuando no hay nada que hacer sin ella) y almacenando en cach√© los directorios de la base de datos y los datos en cupones que son populares en el Black Friday. <br><br>  Es cierto que este a√±o nos equivocamos con los pron√≥sticos de carga hacia arriba: nos est√°bamos preparando para un crecimiento de 6-8 veces en los picos y logramos un buen trabajo de los servicios solo para tal volumen de solicitudes (cach√©s adicionales, funciones experimentales deshabilitadas por adelantado, simplificamos algunas cosas, implementamos nodos Kubernetes adicionales e incluso servidores de bases de datos para r√©plicas, que al final no fueron necesarias).  De hecho, el aumento en el inter√©s del usuario fue menor, por lo que todo sali√≥ como de costumbre.  El tiempo de respuesta del servicio no super√≥ los 50 ms en el percentil 95. <br><br>  Para nosotros, una de las caracter√≠sticas m√°s importantes es c√≥mo se escala la aplicaci√≥n cuando no hay suficientes recursos para una copia.  Go utiliza recursos de hardware de manera m√°s eficiente, por lo que con la misma carga necesita ejecutar menos copias (en √∫ltima instancia, atender m√°s solicitudes en los mismos recursos de hardware).  Este a√±o, en el pico de la venta, 16 instancias de la aplicaci√≥n estaban funcionando, que procesaron un promedio de 300 solicitudes por segundo con picos de hasta 400 solicitudes por segundo, que es aproximadamente dos veces mayor que la carga habitual.  Tenga en cuenta que el a√±o pasado, un servicio de Python requiri√≥ 102 instancias. <br><br>  Parece que el servicio en Go desde el primer enfoque cerr√≥ todas nuestras necesidades.  Pero Golang no es una "soluci√≥n √∫nica para todos los problemas".  No podr√≠a prescindir de algunas caracter√≠sticas.  Por ejemplo, tuvimos que limitar el n√∫mero de subprocesos que el servicio puede iniciar en el nodo multiprocesador Kubernetes, de modo que al escalarlo no interfiera con las aplicaciones "vecinas" en la producci√≥n (por defecto, Go no tiene l√≠mite en la cantidad de procesadores que necesitar√°).  Para hacer esto, configuramos GOMAXPROCS en todas las aplicaciones en Go.  Estaremos encantados de comentar lo √∫til que fue esto: en nuestro equipo esta fue solo una de las hip√≥tesis sobre c√≥mo lidiar con la degradaci√≥n de los "vecinos". <br><br>  Otra "configuraci√≥n" es la cantidad de conexiones que se mantienen como Keep-Alive.  Los clientes regulares de http y DB en Go por defecto solo tienen dos conexiones, por lo que si hay muchas solicitudes simult√°neas y necesita ahorrar en el tr√°fico de la configuraci√≥n de la conexi√≥n TCP, tiene sentido aumentar este valor configurando MaxIdleConnsPerHost y SetMaxIdleConns, respectivamente. <br><br>  Sin embargo, incluso con estos "giros" manuales, Golang nos proporcion√≥ un amplio margen de rendimiento para futuras ventas. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434208/">https://habr.com/ru/post/es434208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434196/index.html">3CX v16 Alpha 2 y planes para el nuevo a√±o</a></li>
<li><a href="../es434198/index.html">Elegir un modo operativo de servidor web basado en la experiencia personal</a></li>
<li><a href="../es434200/index.html">¬øEs el √≥xido tan terrible como est√° pintado?</a></li>
<li><a href="../es434202/index.html">4 secretos sobre c√≥mo no perder tu trabajo en ciencia de datos</a></li>
<li><a href="../es434206/index.html">Distribuidor de chorro ok.ru/music</a></li>
<li><a href="../es434210/index.html">An√°lisis del concurso de cuestionarios de Android del stand de HeadHunter en Mobius 2018 Mosc√∫</a></li>
<li><a href="../es434212/index.html">Torre Tesla ¬øQu√© sucede dentro y cerca de un rascacielos cuando cae un rayo?</a></li>
<li><a href="../es434214/index.html">Proxy din√°mico de Java: ¬øqu√© es y c√≥mo usarlo?</a></li>
<li><a href="../es434216/index.html">Ataques de fuerza bruta con Kali Linux</a></li>
<li><a href="../es434218/index.html">Simple Java clicker bot en el ejemplo del juego World of Warcraft 3.3.5a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>