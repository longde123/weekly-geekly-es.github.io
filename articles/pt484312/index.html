<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüî¨ üîù üèÇüèæ Armazenamento eficiente de centenas de milh√µes de arquivos pequenos. Solu√ß√£o Auto-Hospedada üë®üèº‚ÄçüöÄ üçè üòñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Caro comunidade, este artigo se concentrar√° no armazenamento e na entrega eficientes de centenas de milh√µes de arquivos pequenos. Neste est√°gio, √© pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Armazenamento eficiente de centenas de milh√µes de arquivos pequenos. Solu√ß√£o Auto-Hospedada</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484312/"><img src="https://habrastorage.org/webt/32/yq/2a/32yq2adas-fjtcztdzu7fhyhiss.png"><br><br>  Caro comunidade, este artigo se concentrar√° no armazenamento e na entrega eficientes de centenas de milh√µes de arquivos pequenos.  Neste est√°gio, √© proposta a solu√ß√£o final para sistemas de arquivos compat√≠veis com POSIX, com suporte total a bloqueios, incluindo os de cluster e mesmo sem muletas. <br><br>  Portanto, para esse fim, escrevi meu pr√≥prio servidor especializado. <br>  No decorrer desta tarefa, foi poss√≠vel resolver o problema principal, ao longo do caminho para economizar espa√ßo em disco e RAM, que nosso sistema de arquivos em cluster consumia sem piedade.  Na verdade, esse n√∫mero de arquivos √© prejudicial a qualquer sistema de arquivos em cluster. <a name="habracut"></a><br><br>  A ideia √© esta: <br><br>  Em palavras simples, os arquivos pequenos s√£o carregados pelo servidor, eles s√£o salvos diretamente no arquivo morto e tamb√©m s√£o lidos a partir dele, e arquivos grandes s√£o colocados nas proximidades.  Esquema: 1 pasta = 1 arquivo, no total, temos v√°rios milh√µes de arquivos com arquivos pequenos e n√£o v√°rias centenas de milh√µes de arquivos.  E tudo isso √© totalmente implementado, sem scripts e arquivos dobr√°veis ‚Äã‚Äãem arquivos tar / zip. <br><br>  Vou tentar encurtar, pe√ßo desculpas antecipadamente se o post ser√° amplo. <br><br>  Tudo come√ßou com o fato de que eu n√£o conseguia encontrar um servidor adequado no mundo que salvasse os dados recebidos via protocolo HTTP diretamente nos arquivos, para que n√£o houvesse desvantagens inerentes aos arquivos e reposit√≥rios de objetos comuns.  E o motivo da pesquisa foi um cluster de 10 servidores, que cresceu em larga escala, o Origin, no qual 250.000.000 de arquivos pequenos j√° haviam se acumulado, e a tend√™ncia de crescimento n√£o parava. <br><br>  <b>Quem n√£o gosta de ler artigos e um pouco de documenta√ß√£o √© mais f√°cil:</b> <br><br>  <a href="" rel="nofollow">aqui</a> e <a href="" rel="nofollow">aqui</a> . <br><br>  <b>Update</b>  <b>Removido o nginx da imagem do docker.</b> <br><br>  E janela de encaixe ao mesmo tempo: <br><pre><code class="bash hljs">docker run -d --restart=always -e bindaddr=127.0.0.1:9699 \ -e host=localhost -e root=/var/storage -v /var/storage:/var/storage --name wzd \ -p 80:9699 eltaline/wzd</code> </pre> <br>  Seguinte: <br><br>  <b>Update</b>  <b>Na vers√£o 1.1.0, o m√©todo de autentica√ß√£o HTTPS / POST / IP e assim por diante j√° apareceu.</b> <br><br>  Se houver muitos arquivos, s√£o necess√°rios recursos significativos e, mais ofensivamente, alguns deles s√£o desperdi√ßados.  Por exemplo, ao usar um sistema de arquivos em cluster (neste caso, MooseFS), um arquivo, independentemente do tamanho real, sempre leva pelo menos 64 KB.  Ou seja, para arquivos de 3, 10 ou 30 KB, √© necess√°rio 64 KB no disco.  Se um quarto de bilh√£o de arquivos, perdemos 2 a 10 terabytes.  N√£o ser√° poss√≠vel criar novos arquivos ad infinitum, pois h√° uma limita√ß√£o no pr√≥prio MooseFS: n√£o mais que 1 bilh√£o com uma r√©plica de cada arquivo. <br><br>  √Ä medida que o n√∫mero de arquivos aumenta, voc√™ precisa de muita RAM para metadados.  Despejos freq√ºentes de grandes metadados tamb√©m contribuem para o desgaste dos SSDs. <br><br>  <b>Servidor WZD.</b>  <b>Colocamos os discos em ordem.</b> <br><br>  O servidor est√° escrito em Go.  Primeiro de tudo, eu precisava reduzir o n√∫mero de arquivos.  Como fazer isso?  Devido ao arquivamento, mas neste caso sem compacta√ß√£o, j√° que meus arquivos s√£o s√≥lidos, imagens cortadas.  O BoltDB veio em socorro, que ainda precisava ser privado de falhas, isso se reflete na documenta√ß√£o. <br><br>  No total, em vez de um quarto de bilh√£o de arquivos, no meu caso, apenas 10 milh√µes de arquivos Bolt permaneceram.  Se eu tivesse a oportunidade de alterar a estrutura atual de preenchimento de arquivos de diret√≥rio, seria poss√≠vel reduzir para cerca de 1 milh√£o de arquivos. <br><br>  Todos os arquivos pequenos s√£o compactados nos arquivos Bolt, recebendo automaticamente os nomes dos diret√≥rios em que est√£o localizados e todos os arquivos grandes permanecem lado a lado com os arquivos; n√£o faz sentido empacot√°-los, isso √© personaliz√°vel.  Pequeno - arquivo, grande - deixa inalterado.  O servidor trabalha de forma transparente com ambos. <br><br>  <b>Arquitetura e recursos do servidor wZD.</b> <br><br><img src="https://habrastorage.org/webt/uu/yu/t1/uuyut1do539zyzy3qs9atm_h9xg.png"><br><br>  O servidor est√° executando Linux, BSD, Solaris e OSX.  Testei apenas a arquitetura AMD64 no Linux, mas ela tamb√©m deve ser adequada para ARM64, PPC64, MIPS64. <br><br>  <b>Principais recursos:</b> <br><br><ul><li>  Multithreading; </li><li>  Multi-servidor, oferecendo toler√¢ncia a falhas e balanceamento de carga; </li><li>  Transpar√™ncia m√°xima para o usu√°rio ou desenvolvedor; </li><li>  M√©todos HTTP suportados: GET, HEAD, PUT e DELETE; </li><li>  Gerenciamento do comportamento de leitura e escrita atrav√©s de cabe√ßalhos de clientes; </li><li>  Suporte para hosts virtuais personaliz√°veis; </li><li>  Suporte √† integridade dos dados CRC ao escrever / ler; </li><li>  Buffers semi-din√¢micos para consumo m√≠nimo de mem√≥ria e ajuste ideal do desempenho da rede; </li><li>  Compacta√ß√£o de dados atrasada </li><li>  Al√©m disso, um arquivador wZA multiencadeado √© oferecido para migra√ß√£o de arquivos sem interromper o servi√ßo. </li></ul><br>  <b>Experi√™ncia real:</b> <br><br>  Desenvolvi e testei o servidor e o arquivador de dados ativos por um longo tempo, agora ele opera com √™xito em um cluster que inclui 250.000.000 de arquivos pequenos (imagens) localizados em 15.000.000 de diret√≥rios em discos SATA separados.  Um cluster de 10 servidores √© um servidor Origin instalado atr√°s de uma rede CDN.  Para sua manuten√ß√£o, s√£o utilizados 2 servidores Nginx + 2 servidores wZD. <br><br>  Para aqueles que decidem usar esse servidor, faz sentido planejar a estrutura de diret√≥rios antes do uso, se aplic√°vel.  Fa√ßa imediatamente uma reserva de que o servidor n√£o foi projetado para enviar tudo para o arquivo 1 Bolt. <br><br>  <b>Teste de desempenho:</b> <br><br>  Quanto menor o tamanho do arquivo arquivado, mais rapidamente as opera√ß√µes GET e PUT s√£o executadas nele.  Compare o tempo total que o cliente HTTP grava nos arquivos regulares e nos arquivos Bolt e tamb√©m l√™.  Ele compara o trabalho com arquivos de 32 KB, 256 KB, 1024 KB, 4096 KB e 32768 KB. <br><br>  Ao trabalhar com arquivos Bolt, a integridade dos dados de cada arquivo √© verificada (o CRC √© usado), antes da grava√ß√£o e tamb√©m ap√≥s a grava√ß√£o, a leitura √© realizada em tempo real e recontada, isso naturalmente introduz atrasos, mas o principal √© a seguran√ßa dos dados. <br><br>  Realizei testes de desempenho em SSDs, pois em discos SATA, os testes n√£o mostram uma diferen√ßa clara. <br><br>  <b>Atualiza√ß√£o (v1.1.0), desempenho aprimorado em 5-25%.</b> <br><br>  <b>Gr√°ficos com base nos resultados do teste:</b> <br><br><img src="https://habrastorage.org/webt/mi/ok/np/mioknp3lbcmd6vd87l255wksyg0.png"><br><img src="https://habrastorage.org/webt/zz/7b/k_/zz7bk_uhudvy71kyrdk5qe6fulc.png"><br><br>  Como voc√™ pode ver, para arquivos pequenos, a diferen√ßa no tempo de leitura e grava√ß√£o entre arquivos arquivados e n√£o arquivados √© pequena. <br><br>  Obteremos uma imagem completamente diferente com o teste de leitura e grava√ß√£o de arquivos de 32 MB: <br><br><img src="https://habrastorage.org/webt/mo/br/xw/mobrxwox3c6o-kq3qjnj7vdaymu.png"><br><br>  A diferen√ßa hor√°ria entre os arquivos de leitura √© de 5 a 25 ms.  Com a grava√ß√£o, as coisas s√£o piores, a diferen√ßa √© de cerca de 150 ms.  Mas, neste caso, n√£o √© necess√°rio fazer upload de arquivos grandes, isso simplesmente n√£o faz sentido, eles podem viver separadamente dos arquivos. <br><br>  * Tecnicamente, este servidor tamb√©m pode ser usado para tarefas que requerem NoSQL. <br><br>  <b>M√©todos b√°sicos de trabalho com o servidor wZD:</b> <br><br>  Baixe o arquivo regular: <br><pre> <code class="bash hljs">curl -X PUT --data-binary @test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  Fazendo upload de um arquivo para o arquivo morto Bolt (se o par√¢metro do servidor fmaxsize n√£o for excedido, o que determina o tamanho m√°ximo do arquivo que pode ser inclu√≠do no arquivo morto, se for excedido, o arquivo ser√° carregado como de costume ao lado do arquivo morto): <br><pre> <code class="bash hljs">curl -X PUT -H <span class="hljs-string"><span class="hljs-string">"Archive: 1"</span></span> --data-binary @test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  Download de um arquivo (se houver arquivos com o mesmo nome no disco e no arquivo morto, durante o download, a prioridade padr√£o ser√° dada ao arquivo descompactado): <br><pre> <code class="bash hljs">curl -o test.jpg http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br>  Download de um arquivo do arquivo Bolt (for√ßado): <br><pre> <code class="bash hljs">curl -o test.jpg -H <span class="hljs-string"><span class="hljs-string">"FromArchive: 1"</span></span> http://localhost/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/test.jpg</code> </pre> <br><br>  Uma descri√ß√£o de outros m√©todos est√° na documenta√ß√£o. <br><br>  <a href="" rel="nofollow">Documenta√ß√£o WZD</a> <br>  <a href="" rel="nofollow">Documenta√ß√£o WZA</a> <br><br>  At√© agora, o servidor suporta apenas HTTP; ainda n√£o funciona com HTTPS.  O m√©todo POST tamb√©m n√£o √© suportado (ainda n√£o foi decidido se √© necess√°rio ou n√£o). <br><br>  Quem se aprofunda no c√≥digo-fonte encontrar√° um caramelo l√°, nem todo mundo adora, mas eu n√£o vinculei o c√≥digo principal √†s fun√ß√µes da estrutura da web, exceto o manipulador de interrup√ß√µes, para que no futuro eu possa reescrever rapidamente para quase qualquer mecanismo. <br><br>  <b>ToDo:</b> <br><br><ul><li>  Desenvolvimento de nosso pr√≥prio replicador e distribuidor + geo para a possibilidade de uso em grandes sistemas sem FSs de cluster (tudo para um adulto) </li><li>  A capacidade de reverter completamente os metadados de restaura√ß√£o quando eles s√£o completamente perdidos (se estiver usando um distribuidor) </li><li>  Protocolo nativo para a possibilidade de usar conex√µes e drivers de rede permanentes para diferentes linguagens de programa√ß√£o </li><li>  Recursos avan√ßados do uso do componente NoSQL </li><li>  Compress√µes de diferentes tipos (gzip, zstd, snappy) para arquivos ou valores dentro dos arquivos do Bolt e para arquivos comuns </li><li>  Criptografia de tipos diferentes para arquivos ou valores dentro dos arquivos do Bolt e para arquivos comuns </li><li>  Atraso na convers√£o de v√≠deo do servidor, incluindo GPU </li></ul><br>  Isso √© tudo, espero que este servidor seja √∫til para algu√©m, licen√ßa BSD-3, direitos autorais duplos, j√° que n√£o haveria uma empresa onde eu trabalho, tamb√©m n√£o escreveria um servidor.  Eu sou um desenvolvedor no singular.  Ficaria muito grato pelos bugs encontrados e solicita√ß√µes de recursos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484312/">https://habr.com/ru/post/pt484312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484300/index.html">PowerShell funcional com classes - n√£o um ox√≠moro, eu garanto</a></li>
<li><a href="../pt484302/index.html">Slurm DevOps - um melhor desempenho em 3 dias do que uma bela grua no futuro distante</a></li>
<li><a href="../pt484304/index.html">China adotou seu "Pacote Primavera"</a></li>
<li><a href="../pt484306/index.html">Aprendizagem pode ser uma revis√£o indecid√≠vel</a></li>
<li><a href="../pt484310/index.html">Biblioteca Webix JavaScript atrav√©s dos olhos de um iniciante. Parte 2. Trabalhar com Formul√°rios</a></li>
<li><a href="../pt484320/index.html">Criando um microsservi√ßo no Quarkus, Kotlin e Gradle</a></li>
<li><a href="../pt484326/index.html">Ir para Londres ou meu est√°gio na Jump Trading</a></li>
<li><a href="../pt484328/index.html">Paul Graham anuncia nova linguagem de programa√ß√£o Bel</a></li>
<li><a href="../pt484330/index.html">[Nginx] Como vencer o response_status = 0</a></li>
<li><a href="../pt484332/index.html">Concentre-se no gerenciamento de tarefas. Como fazemos nosso sistema de gest√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>