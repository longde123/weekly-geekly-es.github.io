<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯПЖ ЁЯЖО ЁЯСВЁЯП╛ Jsonnet рдкрд░ 100 рд▓рд╛рдЗрдиреЛрдВ рдореЗрдВ 100 gitlab рдиреМрдХрд░реА рдХрд╛ рд╡рд░реНрдгрди рдХреИрд╕реЗ рдХрд░реЗрдВ ЁЯЧУя╕П ЁЯХФ ЁЯПЗЁЯП┐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рддреИрдирд╛рддреА рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдХреА рдирд┐рд░рдВрддрд░рддрд╛ рдореЗрдВ, рдореИрдВ рдЖрдкрдХреЛ рдмрддрд╛рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ рдХрд┐ рдЖрдк рдЕрдкрдиреЗ .gitlab-ci.yml рдореЗрдВ рдиреМрдХрд░реА рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЛ рд╕рд░рд▓ рдмрдирд╛рди...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Jsonnet рдкрд░ 100 рд▓рд╛рдЗрдиреЛрдВ рдореЗрдВ 100 gitlab рдиреМрдХрд░реА рдХрд╛ рд╡рд░реНрдгрди рдХреИрд╕реЗ рдХрд░реЗрдВ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483626/"><p>  рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рддреИрдирд╛рддреА рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ <a href="https://habr.com/ru/post/481662/">рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ</a> рдХреА рдирд┐рд░рдВрддрд░рддрд╛ рдореЗрдВ, рдореИрдВ рдЖрдкрдХреЛ рдмрддрд╛рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ рдХрд┐ рдЖрдк рдЕрдкрдиреЗ <strong>.gitlab-ci.yml</strong> рдореЗрдВ рдиреМрдХрд░реА рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП Jsonnet рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><img align="right" src="https://habrastorage.org/getpro/habr/post_images/845/43b/ad8/84543bad823db8734ff27e0131902e5b.svg"><br><h4 id="dano">  Dano </h4><br><p>  рдПрдХ рдореЛрдиреЛрд░рдкрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ: </p><br><ul><li>  10 рдбреЙрдХрдлрд╛рдЗрд▓реНрд╕ </li><li>  30 рд╡рд░реНрдгрд┐рдд рддреИрдирд╛рддреА </li><li>  3 рд╡рд╛рддрд╛рд╡рд░рдг: <strong>devel</strong> , <strong>рдордВрдЪрди</strong> рдФрд░ <strong>рдЙрддреНрдкрд╛рджрди</strong> </li></ul><br><h4 id="zadacha">  рдХрд╛рд░реНрдп </h4><br><p>  рдПрдХ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ: </p><br><ul><li>  рдПрдХ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде рдПрдХ рдЬреАрдЖрдИрдЯреА рдЯреИрдЧ рдЬреЛрдбрд╝рдХрд░ рдбреЙрдХрд░реЛрдВ рдХреА рдЫрд╡рд┐рдпреЛрдВ рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред </li><li>  рдкреНрд░рддреНрдпреЗрдХ рдкрд░рд┐рдирд┐рдпреЛрдЬрди рдСрдкрд░реЗрд╢рди рдХреЛ рдкрд░реНрдпрд╛рд╡рд░рдг рд╢рд╛рдЦрд╛ рдореЗрдВ рдзрдХреЗрд▓рддреЗ рд╕рдордп рдФрд░ рдХреЗрд╡рд▓ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдмрджрд▓рдХрд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП </li><li>  рдкреНрд░рддреНрдпреЗрдХ рд╡рд╛рддрд╛рд╡рд░рдг рдХрд╛ рдЕрдкрдирд╛ рдПрдХ рдЕрд▓рдЧ рдЯреИрдЧ рд╣реИ, рдЬреЛ рдХреЗрд╡рд▓ рдЕрдкрдиреЗ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рддреИрдирд╛рддреА рдХрд░рддрд╛ рд╣реИред </li><li> рд╕рднреА рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рдкреНрд░рддреНрдпреЗрдХ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рддреИрдирд╛рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рд╣рдореЗрдВ рдЕрдкрд╡рд╛рдж рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред </li><li> рдХреБрдЫ рдкрд░рд┐рдирд┐рдпреЛрдЬрди git <strong><code>GIT_SUBMODULE_STRATEGY=normal</code></strong> рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рд╕реЗрдЯ рдЪрд░ <strong><code>GIT_SUBMODULE_STRATEGY=normal</code></strong> рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП </li></ul><br><p>  рдпрд╣ рд╕рдм рдмрддрд╛рддреЗ рд╣реБрдП рдпрд╣ рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдирд░рдХ рдХреА рддрд░рд╣ рд▓рдЧ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдо рдирд┐рд░рд╛рд╢рд╛ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ Jsonnet рдХреЗ рд╕рд╛рде рд╕рд╢рд╕реНрддреНрд░ рд╣рдо рдпрд╣ рдЖрд╕рд╛рдиреА рд╕реЗ рдФрд░ рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ рдХрд░реЗрдВрдЧреЗред </p><a name="habracut"></a><br><h4 id="reshenie">  рдирд┐рд░реНрдгрдп </h4><br><p>  <strong>gitlab-ci.yml</strong> рдореЗрдВ рдмрд╛рд░-рдмрд╛рд░ рдиреМрдХрд░рд┐рдпреЛрдВ рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреНрд╖рдорддрд╛рдПрдВ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк <strong>рдПрдХреНрд╕рдЯреЗрдВрдб</strong> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ <a href="https://docs.gitlab.com/ee/ci/yaml/" rel="nofollow">рд╢рд╛рдорд┐рд▓</a> рдХрд░ рд╕рдХрддреЗ <a href="https://docs.gitlab.com/ee/ci/yaml/" rel="nofollow">рд╣реИрдВ</a> , рд▓реЗрдХрд┐рди рдпрд╣ рдкреВрд░реНрдг-рд╡рд┐рдХрд╕рд┐рдд templating рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╣рдореЗрдВ рд╕рдмрд╕реЗ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдФрд░ рдХреБрд╢рд▓ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИред </p><br><p>  рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВ jsonnet рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рд╕реБрдЭрд╛рд╡ рджреЗрддрд╛ рд╣реВрдВ, рдЬреЛ рдЖрдкрдХреЛ рдХрд┐рд╕реА рднреА рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреЗ рд╕рдордп рдХреЛрдб рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рд╕реЗ рд▓рдЧрднрдЧ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЫреБрдЯрдХрд╛рд░рд╛ рдкрд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред </p><br><blockquote>  <strong>Jsonnet рдХреЗ</strong> рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ <strong>рд╕рдордп, рдореИрдВ</strong> рдЖрдкрдХреЗ рд╕рдВрдкрд╛рджрдХ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд▓рдЧрдЗрди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрддреНрдпрдзрд┐рдХ рд╕рд▓рд╛рд╣ рджреЗрддрд╛ <strong>рд╣реВрдВ</strong> <br><br>  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╡рд┐рдо рдХреЗ рд▓рд┐рдП рдПрдХ <strong>рд╡рд┐рдо-рдЬреЛрдВрд╕рдиреЗрдЯ рдкреНрд▓рдЧрдЗрди рд╣реИ</strong> рдЬреЛ рд╕рд┐рдВрдЯреИрдХреНрд╕ рд╣рд╛рдЗрд▓рд╛рдЗрдЯрд┐рдВрдЧ рдХреЛ рдЪрд╛рд▓реВ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╣рд░ рдмрд╛рд░ рдЗрд╕реЗ рд╕рд╣реЗрдЬреЗ рдЬрд╛рдиреЗ рдХреЗ рд╕рдордп <strong>рдЬреЛрдВрд╕рдиреЗрдЯ fmt рдХреЛ</strong> рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ (рдЗрд╕рдХреЗ рд▓рд┐рдП jsonnet рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ)ред </blockquote><br><p>  рдЖрдЗрдП рд╣рдорд╛рд░реА рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреА рд╕рдВрд░рдЪрдирд╛ рдХреЛ рджреЗрдЦреЗрдВ: </p><br><pre> <code class="plaintext hljs">. тФЬтФАтФА deploy тФВ  тФЬтФАтФА analyse тФВ  тФЬтФАтФА basin тФВ  тФЬтФАтФА brush тФВ  тФЬтФАтФА copper тФВ  тФЬтФАтФА dinner тФВ  тФЬтФАтФА dirty тФВ  тФЬтФАтФА drab тФВ  тФЬтФАтФА drunk тФВ  тФЬтФАтФА education тФВ  тФЬтФАтФА fanatical тФВ  тФЬтФАтФА faulty тФВ  тФЬтФАтФА guarantee тФВ  тФЬтФАтФА guitar тФВ  тФЬтФАтФА hall тФВ  тФЬтФАтФА harmonious тФВ  тФЬтФАтФА history тФВ  тФЬтФАтФА iron тФВ  тФЬтФАтФА maniacal тФВ  тФЬтФАтФА mist тФВ  тФЬтФАтФА nine тФВ  тФЬтФАтФА pleasant тФВ  тФЬтФАтФА polish тФВ  тФЬтФАтФА receipt тФВ  тФЬтФАтФА shop тФВ  тФЬтФАтФА smelly тФВ  тФЬтФАтФА solid тФВ  тФЬтФАтФА stroke тФВ  тФЬтФАтФА thunder тФВ  тФЬтФАтФА ultra тФВ  тФФтФАтФА yarn тФФтФАтФА dockerfiles тФЬтФАтФА dinner тФЬтФАтФА drunk тФЬтФАтФА fanatical тФЬтФАтФА guarantee тФЬтФАтФА guitar тФЬтФАтФА harmonious тФЬтФАтФА shop тФЬтФАтФА smelly тФЬтФАтФА thunder тФФтФАтФА yarn</code> </pre> <br><p>  <strong><a href="https://habr.com/ru/post/481662/">рдХрд╛рдЗрдХреЛ</a></strong> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ <strong><a href="https://habr.com/ru/post/481662/">рдбреЙрдХрд░реА</a></strong> рдЪрд┐рддреНрд░ рдмрдирд╛рдП <strong><a href="https://habr.com/ru/post/481662/">рдЬрд╛рдПрдВрдЧреЗ</a></strong> </p><br><p>  <strong><a href="https://habr.com/ru/post/481662/">рдХреНрдпреВрдмреЗрдХ</a></strong> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдкреНрд░рддреНрдпреЗрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рддреАрди рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкрд░рд┐рд╡реЗрд╢реЛрдВ рдХреЗ рд▓рд┐рдП рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдкреНрд░рджрд░реНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИ: </p><br><pre> <code class="plaintext hljs">qbec apply &lt;environment&gt; --root deploy/&lt;app&gt; --yes</code> </pre> <br><p>  рдЬрд╣рд╛рдВ: </p><br><ul><li>  <code>&lt;app&gt;</code> - рд╣рдорд╛рд░реЗ рдЖрд╡реЗрджрди рдХрд╛ рдирд╛рдо </li><li>  <code>&lt;environment&gt;</code> рд╣рдорд╛рд░реЗ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ: <strong>рдбреЗрд╡реЗрд▓</strong> , <strong>рд╕реНрдЯреЗрдЬ,</strong> рдпрд╛ <strong>рдареЗрд╕</strong> ред </li></ul><br><p>  рдЕрдВрдд рдореЗрдВ, рд╣рдорд╛рд░реА рдиреМрдХрд░рд┐рдпреЛрдВ рдХреЛ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрдирд╛ рдЪрд╛рд╣рд┐рдП: </p><br><p>  <strong>рд╡рд┐рдзрд╛рдирд╕рднрд╛:</strong> </p><br><pre> <code class="bash hljs">build:{{ image }}: stage: build tags: - build image: name: gcr.io/kaniko-project/executor:debug entrypoint: [<span class="hljs-string"><span class="hljs-string">""</span></span>] script: - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"{\"auths\":{\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CI_REGISTRY</span></span></span><span class="hljs-string">\":{\"username\":\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CI_REGISTRY_USER</span></span></span><span class="hljs-string">\",\"password\":\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CI_REGISTRY_PASSWORD</span></span></span><span class="hljs-string">\"}}}"</span></span> &gt; /kaniko/.docker/config.json - /kaniko/executor --context <span class="hljs-variable"><span class="hljs-variable">$CI_PROJECT_DIR</span></span> --dockerfile <span class="hljs-variable"><span class="hljs-variable">$CI_PROJECT_DIR</span></span>/dockerfiles/{{ image }}/Dockerfile --destination <span class="hljs-variable"><span class="hljs-variable">$CI_REGISTRY_IMAGE</span></span>/{{ image }}:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_TAG</span></span> only: refs: - tags</code> </pre> <br><p>  рдЬрд╣рд╛рдВ <code>{{ image }}</code> рдмрдЬрд╛рдп, <strong>dockerfiles</strong> рд╕реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдирд╛рдо рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ </p><br><p>  <strong>рдирд┐рдпреЛрдЬрд┐рдд рдХрд░реЗрдВ:</strong> </p><br><pre> <code class="bash hljs">deploy:{{ environment }}:{{ app }}: stage: deploy tags: - {{ environment }} script: - qbec apply {{ environment }} --root deploy/{{ app }} --force:k8s-context __incluster__ --<span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> --yes only: changes: - deploy/{{ app }}/**/* refs: - {{ environment }}</code> </pre> <br><p>  рдЬрд╣рд╛рдВ <code>{{ app }}</code> рдмрдЬрд╛рдп, <strong>рддреИрдирд╛рддреА</strong> рд╕реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдирд╛рдо рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, <br>  рдФрд░ <code>{{ environment }}</code> рдмрдЬрд╛рдп - рдЙрд╕ рдкрд░реНрдпрд╛рд╡рд░рдг рдХрд╛ рдирд╛рдо рдЬрд┐рд╕рдореЗрдВ рдЖрдк рддреИрдирд╛рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред </p><br><p>  рдЖрдЗрдП рдПрдХ рдЕрд▓рдЧ <strong>рдкрд░рд┐рд╡рд╛рдж / jobs.jsonnet</strong> рдореЗрдВ рд╡рд╕реНрддреБрдУрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд╣рдорд╛рд░реА рдиреМрдХрд░рд┐рдпреЛрдВ рдХреЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ </p><br><pre> <code class="javascript hljs">{ <span class="hljs-comment"><span class="hljs-comment">//    docker- dockerImage(name):: { tags: ['build'], stage: 'build', image: { name: 'gcr.io/kaniko-project/executor:debug-v0.15.0', entrypoint: [''], }, script: [ 'echo "{\\"auths\\":{\\"$CI_REGISTRY\\":{\\"username\\":\\"$CI_REGISTRY_USER\\",\\"password\\":\\"$CI_REGISTRY_PASSWORD\\"}}}" &gt; /kaniko/.docker/config.json', '/kaniko/executor --cache --context $CI_PROJECT_DIR/dockerfiles/' + name + ' --dockerfile $CI_PROJECT_DIR/dockerfiles/' + name + '/Dockerfile --destination $CI_REGISTRY_IMAGE/' + name + ':$CI_COMMIT_TAG --build-arg VERSION=$CI_COMMIT_TAG', ], }, //    qbec- qbecApp(name): { stage: 'deploy', script: [ 'qbec apply $CI_COMMIT_REF_NAME --root deploy/' + name + ' --force:k8s-context __incluster__ --wait --yes', ], only: { changes: [ 'deploy/' + name + '/**/*', ], }, }, }</span></span></code> </pre> <br><p>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдореИрдВрдиреЗ рдЬрд╛рдирдмреВрдЭрдХрд░ рд╣рдорд╛рд░реЗ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рдФрд░ рдЕрдзрд┐рдХ рд▓рдЪреАрд▓рд╛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд░реЗрдлреНрд╕ рдФрд░ <strong><code>tags</code></strong> рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ рдФрд░ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЖрдкрдХреЛ jsonnet рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ, рд╣рдо рдЙрдиреНрд╣реЗрдВ рдмрд╛рдж рдореЗрдВ рдореБрдЦреНрдп рдлрд╛рдЗрд▓ рд╕реЗ рдЬреЛрдбрд╝ рджреЗрдВрдЧреЗред </p><br><p>  рдЕрдм рд╣рдо рдЕрдкрдиреЗ <strong>.itlab-ci.jsonnet рдХрд╛</strong> рд╡рд░реНрдгрди рдХрд░реЗрдВрдЧреЗ: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    local jobs = import 'lib/jobs.libsonnet'; //    local ref(x) = { only+: { refs: [x] } }; local tag(x) = { tags: [x] }; local submodule(x) = { variables+: { GIT_SUBMODULE_STRATEGY: x } }; { // C docker- ['build:' + x]: jobs.dockerImage(x) + tag('build') + ref('tags') for x in [ 'dinner', 'drunk', 'fanatical', 'guarantee', 'guitar', 'harmonious', 'shop', 'smelly', 'thunder', 'yarn', ] } + { //         'prod' ['deploy:prod:' + x]: jobs.qbecApp(x) + tag('prod') + ref('prod') for x in [ 'dinner', 'hall', ] } + { //   git-submodule ['deploy:' + env + ':' + app]: jobs.qbecApp(app) + tag(env) + ref(env) + submodule('normal') for env in ['devel', 'stage', 'prod'] for app in [ 'brush', 'fanatical', 'history', 'shop', ] } + { //    ['deploy:' + env + ':' + app]: jobs.qbecApp(app) + tag(env) + ref(env) for env in ['devel', 'stage', 'prod'] for app in [ 'analyse', 'basin', 'copper', 'dirty', 'drab', 'drunk', 'education', 'faulty', 'guarantee', 'guitar', 'harmonious', 'iron', 'maniacal', 'mist', 'nine', 'pleasant', 'polish', 'receipt', 'smelly', 'solid', 'stroke', 'thunder', 'ultra', 'yarn', ] }</span></span></code> </pre> <br><p>  рдлрд╝рд╛рдЗрд▓ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ <strong>рд░реЗрдлрд░реА</strong> , <strong>рдЯреИрдЧ</strong> рдФрд░ <strong>рд╕рдмрдореЙрдбреНрдпреВрд▓ рдХрд╛рд░реНрдпреЛрдВ</strong> рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ, рд╡реЗ рдЖрдкрдХреЛ рдПрдХ рдУрд╡рд░рд░рд╛рдЗрдбрд┐рдВрдЧ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред </p><br><p>  рдереЛрдбрд╝реА рд╕реА рд╡реНрдпрд╛рдЦреНрдпрд╛: рдУрд╡рд░рд░рд╛рдЗрдб рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП <strong>"</strong> <strong><code>+:</code> " рдХреЗ</strong> рдмрдЬрд╛рдп <strong>" <code>+:</code> "</strong> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЖрдкрдХреЛ рдХрд┐рд╕реА рдореМрдЬреВрджрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдпрд╛ рд╕реВрдЪреА рдореЗрдВ рдПрдХ рдореВрд▓реНрдп рдЬреЛрдбрд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред </p><br><p>  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП <strong>" <code>:</code> "</strong> <strong>рд░реЗрдл рдХреЗ рд▓рд┐рдП</strong> : </p><br><pre> <code class="javascript hljs">local job = { <span class="hljs-attr"><span class="hljs-attr">script</span></span>: [<span class="hljs-string"><span class="hljs-string">'echo 123'</span></span>], <span class="hljs-attr"><span class="hljs-attr">only</span></span>: { <span class="hljs-attr"><span class="hljs-attr">refs</span></span>: [<span class="hljs-string"><span class="hljs-string">'tags'</span></span>] }, }; local ref(x) = { only+: { <span class="hljs-attr"><span class="hljs-attr">refs</span></span>: [x] } }; job + ref(<span class="hljs-string"><span class="hljs-string">'prod'</span></span>)</code> </pre> <br><p>  рд▓реМрдЯреЗрдЧрд╛: </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"only"</span></span>: { <span class="hljs-string"><span class="hljs-string">"refs"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"prod"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"script"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"echo 123"</span></span> ] }</code> </pre> <br><p>  рдФрд░ рдпрд╣рд╛рдБ <strong>refs рдХреЗ</strong> рд▓рд┐рдП <strong>" <code>+:</code> "</strong> рд╣реИ: </p><br><pre> <code class="javascript hljs">local job = { <span class="hljs-attr"><span class="hljs-attr">script</span></span>: [<span class="hljs-string"><span class="hljs-string">'echo 123'</span></span>], <span class="hljs-attr"><span class="hljs-attr">only</span></span>: { <span class="hljs-attr"><span class="hljs-attr">refs</span></span>: [<span class="hljs-string"><span class="hljs-string">'tags'</span></span>] }, }; local ref(x) = { only+: { refs+: [x] } }; job + ref(<span class="hljs-string"><span class="hljs-string">'prod'</span></span>)</code> </pre> <br><p>  рд▓реМрдЯреЗрдЧрд╛: </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"only"</span></span>: { <span class="hljs-string"><span class="hljs-string">"refs"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"prod"</span></span>, <span class="hljs-string"><span class="hljs-string">"tags"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"script"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"echo 123"</span></span> ] }</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, Jsonnet рдХреЗ рдЙрдкрдпреЛрдЧ рд╕реЗ рдЖрдк рдмрд╣реБрдд рд╣реА рдХреБрд╢рд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрдиреА рд╡рд╕реНрддреБрдУрдВ рдХрд╛ рд╡рд░реНрдгрди рдФрд░ рд╡рд┐рд▓рдп рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЖрдЙрдЯрдкреБрдЯ рдкрд░ рдЖрдкрдХреЛ рд╣рдореЗрд╢рд╛ рддреИрдпрд╛рд░ JSON рдорд┐рд▓рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рд╣рдо рддреБрд░рдВрдд рд╣рдорд╛рд░реА <strong>.itlab-ci.yml</strong> рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">jsonnet .gitlab-ci.jsonnet &gt; .gitlab-ci.yml</code> </pre> <br><p>  рд▓рд╛рдЗрдиреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># wc -l .gitlab-ci.jsonnet lib/jobs.libsonnet .gitlab-ci.yml 77 .gitlab-ci.jsonnet 24 lib/jobs.libsonnet 1710 .gitlab-ci.yml</span></span></code> </pre> <br><p>  рдореЗрд░реА рд░рд╛рдп рдореЗрдВ рдпрд╣ рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рд╣реИ! </p><br><p>  рдЖрдк рдЕрдзрд┐рдХ рдЙрджрд╛рд╣рд░рдг рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ рд╕реАрдзреЗ Jsonnet рдорд╣рд╕реВрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: <strong><a href="https://jsonnet.org/" rel="nofollow">jsonnet.org</a></strong> <br>  рдпрджрд┐ рдЖрдк, рдореЗрд░реА рддрд░рд╣, Jsonnet рдкрд╕рдВрдж рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЯреЗрд▓реАрдЧреНрд░рд╛рдо <strong><a href="https://t.me/jsonnet_ru" rel="nofollow">t.me/jsonnet_ru</a></strong> рдореЗрдВ рд╣рдорд╛рд░реЗ рд╕рдореВрд╣ рдореЗрдВ рд╢рд╛рдорд┐рд▓ <strong><a href="https://t.me/jsonnet_ru" rel="nofollow">рд╣реЛрдВ</a></strong> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi483626/">https://habr.com/ru/post/hi483626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi483610/index.html">рдПрдХ рдСрдЯреЛрдореЗрдЯрди рдПрдХ рдШрдЯрдирд╛ рд╣реИ?</a></li>
<li><a href="../hi483612/index.html">рдЯреЗрд╕реНрд▓рд╛ рдбреНрд░рд╛рдЗрд╡рд░ рдиреЗ рдСрдЯреЛрдкрд╛рдпрд▓рдЯ рдкрд░ рдбреНрд░рд╛рдЗрд╡рд┐рдВрдЧ рдХрд░рддреЗ рд╕рдордп рдЕрдкрдиреЗ рджрд╛рдБрдд рдмреНрд░рд╢ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬреБрд░реНрдорд╛рдирд╛ рд▓рдЧрд╛рдпрд╛</a></li>
<li><a href="../hi483614/index.html">рд░реЛрдмреЛрдЯрд┐рдХреНрд╕ рдХреНрд▓рдм рдореЗрдВ рдЪреЛрд░реА рд╕реЗ рдирд┐рдкрдЯрдиреЗ рдХреЗ рддрд░реАрдХреЗ</a></li>
<li><a href="../hi483616/index.html">рд▓реИрдХрдорд╕ рдкреНрд░реЛрдЬреЗрдХреНрдЯ: рдХреИрд╕реЗ рдХрдВрдкреНрдпреВрдЯрд░ рд╡рд┐рдЬрди рдЦреЛрдП рд╣реБрдП рд▓реЛрдЧреЛрдВ рдХреЛ рдмрдЪрд╛рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ</a></li>
<li><a href="../hi483624/index.html">Yandex.Taxi рд╕реЗ рдкреНрд░рддрд┐рдпреЛрдЧрд┐рддрд╛: рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдЪреИрдореНрдкрд┐рдпрдирд╢рд┐рдк рдХреЗ рдмреИрдХреЗрдВрдб рдЯреНрд░реИрдХ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</a></li>
<li><a href="../hi483628/index.html">OpenAPI v3 (рдЙрд░реНрдл рд╕реНрд╡реИрдЧрд░ 3) рд╕реЗ рдХреЛрдб рдЬрдирд░реЗрд╢рди рдЯрд╛рдЗрдкрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд▓рд┐рдП рдФрд░ рди рдХреЗрд╡рд▓</a></li>
<li><a href="../hi483630/index.html">рдПрдореНрдмрд░ рдЯрд╛рдЗрдореНрд╕ - рдЕрдВрдХ 130</a></li>
<li><a href="../hi483634/index.html">CSS рдореЗрдВ рдиреНрдпреВрдирддрдо рдФрд░ рдЕрдзрд┐рдХрддрдо рдЪреМрдбрд╝рд╛рдИ / рдКрдБрдЪрд╛рдИ рдЧреБрдг</a></li>
<li><a href="../hi483646/index.html">рд╣реИрдХ рдж рдмреЙрдХреНрд╕ - рдмрд┐рдЯрд▓реИрдм рд╡реЙрдХрдереНрд░реВред рдХрдордЬреЛрд░ рдЬреЗрдПрд╕ рдСрдмрдлрд┐рдХреЗрд╢рди, рдЬреАрдЖрдИрдЯреА рдФрд░ рд░рд┐рд╡рд░реНрд╕ рд╡рд┐рдВрдбреЛрдЬ рдПрдкреНрд▓рд┐рдХреЗрд╢рди</a></li>
<li><a href="../hi483648/index.html">рдЬреЙрд░реНрдЬрд┐рдпрд╛ рдореЗрдВ рдЖрдИрдЯреА-рд╡реНрдпрд╡рд╕рд╛рдп рдХреЗ рд▓рд┐рдП рдЕрдкрддрдЯреАрдп: рдЬреАрд╡рди рд╣реИрдХ рдФрд░ рдиреБрдХрд╕рд╛рди</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>