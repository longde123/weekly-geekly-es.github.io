<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÉüèæ ‚ö´Ô∏è üë∏üèª Konfigurieren Sie die vollst√§ndige und separate Sicherung und Wiederherstellung von Zimbra OSE ohne Verwendung von Zextras üå≥ üë®üèª‚Äçüíª üéûÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Wo soll ich anfangen? 
 Wo beginnt die Sicherung? Planung. Wenn Sie ein System sichern, m√ºssen Sie einen Sicherungsplan erstellen: Was genau, wie o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Konfigurieren Sie die vollst√§ndige und separate Sicherung und Wiederherstellung von Zimbra OSE ohne Verwendung von Zextras</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439728/"><img src="https://habrastorage.org/webt/tl/fg/oj/tlfgoj8_4wwdpcdcj5n8ndx2pu0.png" alt="Bild"><br><br><h3>  1. Wo soll ich anfangen? </h3><br>  Wo beginnt die Sicherung?  Planung.  Wenn Sie ein System sichern, m√ºssen Sie einen Sicherungsplan erstellen: Was genau, wie oft, wie lange muss gespeichert werden, ist gen√ºgend freier Speicherplatz vorhanden?  Aus den Antworten auf diese Fragen folgt die Antwort auf die Hauptfrage: Wie wird ein Backup erstellt? <br><br>  Wenn viel freier Speicherplatz vorhanden ist, k√∂nnen Sie die gesamte virtuelle Maschine speichern.  Erstellen Sie Backups mit demselben Veeam nach einem Zeitplan und denken Sie nicht an die Schwierigkeiten.  Aber f√ºr mich ist es eine Verschwendung, ich bin es gewohnt, alles so pr√§zise und wirtschaftlich wie m√∂glich zu machen.  Nat√ºrlich habe ich Veeam bereitgestellt, aber ich erstelle nur Sicherungskopien der Systeme, deren Bereitstellung √ºber Sicherungen f√ºr eine sehr lange Zeit entweder unm√∂glich oder problematisch ist. <br><br>  √úber die Skripte der Virtual Environment Management Tools werde ich einfach sinnvoll schweigen. <br><br>  Zimbra hat ein zmmailbox-Tool.  Und bei n√§herer Betrachtung seiner Funktionalit√§t wurde mir klar, dass es mehr als genug f√ºr mich sein w√ºrde.  Er kann Postf√§cher auch auf einem Live-System sichern und wiederherstellen.  Und ich mochte die M√∂glichkeit, kritische Postf√§cher getrennt von der Sicherung des gesamten Systems zu sichern.  Daher wird der von Sicherungen belegte Speicherplatz durch die Gr√∂√üe der archivierten Postf√§cher multipliziert mit der Anzahl der Tage der "Sicherungstiefe" und nicht durch das Volumen des gesamten Systems multipliziert mit der gleichen Anzahl von Tagen begrenzt.  Dar√ºber hinaus ist es im Fall von Zimbra √§u√üerst schwierig, eine Sicherung des gesamten Systems wiederherzustellen.  Es ist viel einfacher, eine virtuelle Maschine mit Veeam oder Tools zur Verwaltung virtueller Umgebungen (Hyper-V, ESXI, geben Sie ein, was Sie ben√∂tigen) direkt nach dem Einrichten des Systems zu kopieren und in das Regal zu stellen, damit Sie in einem kritischen Moment schnell eine nahezu schwerelose VM bereitstellen und hochladen k√∂nnen darin Backups von Boxen.  Meiner Meinung nach ist dies in jeder Hinsicht das kosteng√ºnstigste Szenario. <br><a name="habracut"></a><br><h3>  2. Die Quelldaten: </h3><br>  <i>Server-Betriebssystem</i> : CentOS 7 <br><br><div class="spoiler">  <b class="spoiler_title">√úber das Betriebssystem</b> <div class="spoiler_text">  Tats√§chlich liegt der Unterschied zwischen CentOS7 und jedem anderen System ausschlie√ülich in den Befehlen an den Server zum Installieren von Paketen und m√∂glicherweise im Speicherort einiger Dateien.  Die Arbeiten werden haupts√§chlich mit Zimbra-Cmdlets durchgef√ºhrt, so dass die Konfigurationsunterschiede minimal sind. </div></div><br>  <i>Zimbra Domain</i> : zimbramail.home.local <br>  <i>Benutzername und Passwort f√ºr den Zugriff auf den freigegebenen Ordner</i> : ZimbraBackUp / 123123 <br>  <i>Der Pfad zum freigegebenen Ordner</i> : \\ BackUpServer1 \ ZM \ <br>  <i>Der Pfad zum Montieren der B√§lle auf dem Zimbra-Host</i> : / mnt / ZM / <br><br><h3>  3. Setup </h3><br>  Also fangen wir an! <br><br>  Wir werden Backups auf einen Server unter Windows in einem freigegebenen Ordner schreiben.  Wenn Sie m√∂chten, k√∂nnen Sie Backups √ºberall zusammenf√ºhren, aber ich habe alles so konfiguriert, dass die meisten Backups in BackUpServer1.home.local geschrieben werden.  Also das: <br><br>  1) Wir erstellen in der Dom√§ne des Benutzers, um auf den freigegebenen Ordner auf diesem Server zuzugreifen, damit dieser auf dem Server Zimbramail.home.local bereitgestellt werden kann.  Benutzername ZimbraBackUp, Passwort, bedingt, 123123. <br><br>  2) Erstellen Sie auf dem BackUpServer1-Server das Verzeichnis \ ZM \ im Repository, geben Sie es frei und geben Sie dem ZimbraBackUp-Benutzer √Ñnderungsrechte.  Der Pfad zum Ball lautet: \\ BackUpServer1 \ ZM \ <br><br>  3) Montieren Sie den Ball auf dem Server Zimbramail.home.local.  Damit der Ordner automatisch bereitgestellt wird, m√ºssen Sie die Datei / etc / fstab reparieren, indem Sie die folgende Zeile hinzuf√ºgen: <br><br><pre><code class="bash hljs">//BackUpServer/ZM /mnt/ZM cifs user,uid=500,rw,suid,username=ZimbraBackUp,password=123123 0 0</code> </pre> <br>  Aber zuerst m√ºssen Sie √ºberpr√ºfen, ob die Halterung funktioniert: <br><br><pre> <code class="bash hljs">$ mount -t cifs //BackUpServer/ZM /mnt/ZM -o user=ZimbraBackUp,password=123123</code> </pre> <br>  Oft erscheint ein Fehler wie dieser: <br><br><pre> <code class="bash hljs">mount: wrong fs <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, bad option, bad superblock on //BackUpServer1/ZM/, missing codepage or helper program, or other error (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> several filesystems (eg nfs, cifs) you might need a /sbin/mount.&lt;<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>&gt; helper program) In some cases useful info is found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> syslog - try dmesg | tail or so.</code> </pre> <br>  Sie k√∂nnen das Problem beheben, indem Sie cifs-utils installieren: <br><br><pre> <code class="bash hljs">$ yum install cifs-utils</code> </pre> <br>  Nach dem Einstellen empfehle ich, den Server neu zu starten. <br><br>  4) Erstellen Sie 3 Skriptdateien: FullBackUp.sh HandBackUp.sh Restore.sh <br><br>  Die erste Datei wird verwendet, um automatisch geplante Sicherungen zu erstellen, die zweite f√ºr die M√∂glichkeit, einzelne Postf√§cher zu sichern oder einfach manuell "Was w√§re wenn" zu starten.  Und das dritte Skript ist die gleichzeitige Wiederherstellung einer oder aller Boxen.  Ich habe so viel wie m√∂glich versucht, die Arbeit von Skripten zu kommentieren und die Protokollierung vorzuschreiben. <br><br><div class="spoiler">  <b class="spoiler_title">Der Inhalt der Datei FullBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #    MPath="/mnt/ZM/Mounthly" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   MDay=$(date +%d) #   log="/mnt/ZM/BackUpLog.txt" echo -en "BackUp ALL MailBoxes started in $(date +%T)\n" &gt;&gt; $log #       if [ ! -d $Path ]; then #     echo "    ..." mkdir -p $Path if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "    ,      ..." fi #       if [ ! -d $Path/$CDate ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo #        echo "       ..." mkdir -p $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp CDate dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp CDate dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "    ,     ..." fi #     /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes #    if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi #       for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then #        echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "File $MBoxes clear\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "File $MBoxes can NOT be cleared\n" &gt;&gt; $log fi #      #      if [ ! -d $ArchPath ]; then #    echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log #         if [ "$MDay" = 1 ]; then #      if [ ! -d $MPath ]; then #     echo "    ..." mkdir -p $MPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Long saving dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Long saving dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else #  echo "    ,     ..." fi cp $ArchPath/$CDate.tgz $MPath/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive is copied in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT copied in $(date +%T)\n" &gt;&gt; $log fi echo "    ( 1 )..." # ,   ,   find $Path -atime +7 | xargs rm -d if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps files was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps files is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi #    ( 2 ) echo "     ( 2 )..." find $ArchPath -atime +61 | xargs rm -f if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps archives was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps archives is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi echo "BackUp job finished in $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Inhalt der HandBackUp.sh-Datei:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   log="/mnt/ZM/BackUpLog.txt" read -p "    (  ),  ALL      : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "BackUp started in $(date +%T)\n" &gt;&gt; $log #     echo "    ..." /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #       echo "      " for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done else MailBox="$A@$ZDomain" #    echo "   ..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then #   echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "  $MailBox ,  ..." echo -en "Required Mail Box $MailBox exist $(date +%T)\n" &gt;&gt; $log #      if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #    $MailBox /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi else #    -  echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo "  $MailBox  .   " echo -en "Required Mail Box $MailBox is not exist\n" &gt;&gt; $log exit fi fi read -p "      $MailBox? [N]: " F if [[ "$F" = "Y" || "$F" = "y" ]]; then #      if [ ! -d $ArchPath ]; then #     echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi #    echo "  ..." if [[ "$A" = "ALL" || "$A" = "all" ]]; then tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi else tar -czf $ArchPath/$MailBox.tar $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi fi else echo "   " echo -en "User decline archive creating\n" &gt;&gt; $log fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Der Inhalt der Datei Restore.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #   log="/mnt/ZM/RestoreLog.txt" read -p "  ,      02-09-2001: " Date if ! [ -d $Path/$Date ]; then echo "     ." echo -en "No BackUp file at $Date $(date +%T)\n" &gt; $log exit fi read -p "    (  ),  ALL        : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "Restore started in $(date +%T)\n" &gt;&gt; $log #     ls "$Path/$Date" &gt; $MBoxes for MailBox in $( cat $MBoxes); do #   echo "   $MailBox" Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist, creating Mail Box $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox  .   $MailBox..." #   Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   ." fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi done else #     MailBox="$A@$ZDomain" if [ -a $Path/$Date/$MailBox ]; then #   echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist $(date +%T)\n" &gt;&gt; $log echo " $MailBox  ." read -p "            ? [N]: " B if [[ "$B" = "Y" || "$B" = "y" ]]; then echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") #   if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   .   ..." exit fi else #   ,  .  echo "   .   " exit fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi else #     echo "    .   " echo -en "Required BackUp file is not exist\n" &gt;&gt; $log exit fi fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "Restore job complete in $(date +%T)\n" &gt;&gt; $log echo -en "____________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br>  Es gibt eine Subtilit√§t.  Wenn Sie Skriptdateien f√ºr Bash unter Windows erstellen und bearbeiten, wird beim Versuch, das Skript auszuf√ºhren, ein Fehler angezeigt: <b>/ bin / sh ^ M: fehlerhafter Interpreter: Keine solche Datei oder kein solches Verzeichnis</b> , zu dem unter Windows ausgef√ºhrte Editoren hinzugef√ºgt werden Das Ende der Zeile ist das Wagenr√ºcklaufzeichen "CR \ LF", das von Editoren unter Linux nicht angezeigt wird.  Aber dieses Symbol ist da und nicht verschwunden.  Um den Fehler zu beseitigen und die zus√§tzlichen Zeichen zu entfernen, gehen wir wie folgt vor: <br><br><pre> <code class="bash hljs">$ cat your-script.sh | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> &gt; corrected-your-script.sh</code> </pre> <br>  Nun, oder Sie k√∂nnen das Dienstprogramm dos2unix verwenden, m√ºssen es aber noch installieren: <br><br><pre> <code class="bash hljs">$ yum install dos2unix $ dos2unix your-script.sh</code> </pre> <br>  5) Wir machen die Skripte ausf√ºhrbar: <br><br><pre> <code class="bash hljs">$ chmod 0740 /opt/zimbra/BkUpRestScripts/FullBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/HandBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/Restore.sh</code> </pre> <br>  6) Ich empfehle, dass Sie Skripte mit Ihren H√§nden ausf√ºhren und pr√ºfen, ob sie funktionieren und wie sie funktionieren. <br><br>  7) Erstellen Sie in CRON eine Aufgabe f√ºr die t√§gliche Sicherung von Postf√§chern: <br><br><pre> <code class="bash hljs">10 0 * * * root /opt/zimbra/ BkUpRestScripts/FullBackUp.sh</code> </pre> <br>  8) Viel Spa√ü <br><br><h3>  4. Skripterstellung </h3><br>  Falls die Kommentare in den Skripten selbst nicht geholfen haben. <br><br><div class="spoiler">  <b class="spoiler_title">1) Skript FullBaclUp.sh:</b> <div class="spoiler_text">  Zu Beginn werden die Variablen bestimmt, welche f√ºr was verantwortlich sind - alles wird kommentiert. <br><br>  Im Folgenden wird √ºberpr√ºft, ob kein Verzeichnis f√ºr die Sicherung vorhanden ist. Wenn es nicht vorhanden ist, wird es erstellt.  Aus der Protokolldatei und dem Bildschirm (falls von Hand gestartet) wird der Erfolg oder Misserfolg beim Erstellen eines Verzeichnisses abgeleitet. <br><br>  Suchen Sie nach fehlendem Katalog mit dem heutigen Datum.  Wenn es nicht vorhanden ist, wird es erstellt, die Ausgabe auf dem Bildschirm und das Protokoll des Ergebnisses der Erstellung des Verzeichnisses werden ebenfalls generiert. <br><br>  Schreiben aller vorhandenen Zimbra-Postf√§cher in eine Datei.  Es wird f√ºr die sequentielle Reservierung jeder Box ben√∂tigt.  Zeigt das Ergebnis des Befehls an. <br><br>  Erstellen eines Backups f√ºr jedes Postfach aus der empfangenen Liste.  Mit der Ausgabe der Ausf√ºhrung auf den Bildschirm und in die Protokolldatei. <br><br>  L√∂schen einer Datei mit einer Liste von Feldern.  Da alle 3 Skripte mit dieser Datei arbeiten, ist es ratsam, sie nach jedem Lauf zu bereinigen, damit es keine √úberraschungen gibt.  Sie k√∂nnen es vor dem Start des Skripts bereinigen, aber es ist mir irgendwie vertrauter, nach Abschluss der Arbeit keine unn√∂tigen Daten zu speichern, sondern dasselbe vor und nach der Arbeit des Skripts zu tun, ist ein leichtes Ma√ü an Schizophrenie. <br><br>  Als n√§chstes folgt ein Block zum Erstellen eines komprimierten Archivs. <br><br>  √úberpr√ºfen Sie das Fehlen des Archivspeicherverzeichnisses, erstellen Sie es in Abwesenheit und zeigen Sie das Ergebnis der Erstellung auf dem Bildschirm und im Protokoll an <br><br>  Archivierung <br><br>  Check "ist heute nicht der erste Tag?"  Ich bevorzuge es, Backups f√ºr den ersten Tag aller Monate f√ºr eine lange Zeit zu speichern, das reicht mir, um zu arbeiten.  Es kann wochenlang gelagert werden, ist aber oft √ºberfl√ºssig.  Die Bedingung f√ºr das Speichern von Sicherungen f√ºr den gesamten Betriebszeitraum des Mailservers ist jedoch oben festgelegt, sodass sie f√ºr immer verf√ºgbar sind.  Wenn die Nummer die erste ist, wird das resultierende Archiv in ein separates "Mounthly" -Verzeichnis kopiert.  Und um es dort zu kopieren, m√ºssen Sie √ºberpr√ºfen, ob es ein solches Verzeichnis gibt, und wenn nicht, erstellen Sie es, das dem Bildschirm und der Protokolldatei gemeldet werden soll. <br><br>  Als n√§chstes wird der Speicher bereinigt - alle Backups, die √§lter als 2 Wochen sind, sowie Archive, die √§lter als 61 Tage sind, werden gel√∂scht.  Das Ergebnis des L√∂schvorgangs wird auf dem Bildschirm und in der Protokolldatei angezeigt. <br><br>  Danach schreibt das Skript die Abschlusszeit in die Protokolldatei und auf den Bildschirm und beendet seine Arbeit. </div></div><br><div class="spoiler">  <b class="spoiler_title">2) Skript HandBackUp.sh:</b> <div class="spoiler_text">  Zu Beginn werden auch Variablen definiert und kommentiert, warum sie ben√∂tigt werden. <br><br>  Als N√§chstes wird der Benutzer aufgefordert, den Namen des Postfachs einzugeben, das gesichert werden soll, ohne die Zimbra-Dom√§ne anzugeben.  (es steht in der Aufforderung zur Teilnahme) oder w√§hlen Sie eine Sicherung aller Postf√§cher aus, indem Sie ALLE oder alle schreiben. <br><br>  Wenn Sie alle Postf√§cher sichern m√∂chten, funktioniert das Skript fast genauso wie das erste oben aufgef√ºhrte, au√üer dass Sie nach dem Erstellen von Sicherungen f√ºr jedes Postfach gefragt werden: Muss ich sie archivieren? <br><br>  Wenn ein bestimmtes Postfach geschrieben wurde, wird seine Existenz in Zimbra √ºberpr√ºft.  Wenn ein Feld mit dem angegebenen Namen vorhanden ist, wird der Sicherungsvorgang dieses Felds gestartet, wobei die entsprechenden Informationen auf dem Bildschirm und in der Protokolldatei angezeigt werden.  Wenn das angegebene Feld nicht vorhanden ist, wird der Benutzer dar√ºber informiert und das Skript schlie√üt seine Arbeit ab. <br><br>  Nach Abschluss der Sicherung der Box werden Sie aufgefordert, die Kopie zu archivieren.  Wenn der Benutzer zustimmt, wird gepr√ºft, ob kein Verzeichnis zum Speichern des Archivs und weiter unten in der Liste vorhanden ist, wie im ersten Skript. <br><br>  Nach Abschluss der Archivierung wird die Datei mit der Liste der Postf√§cher gel√∂scht.  Nur f√ºr den Fall. <br><br>  Am Ende werden Informationen zur Abschlusszeit des Skripts auf dem Bildschirm und in der Protokolldatei angezeigt. </div></div><br><div class="spoiler">  <b class="spoiler_title">3) Script Restore.sh:</b> <div class="spoiler_text">  Wie in den vorherigen Dateien zuerst - die Definition von Variablen mit Kommentaren. <br><br>  Der Benutzer wird aufgefordert, das Datum der wiederherzustellenden Sicherung auszuw√§hlen.  Wenn das angegebene Datum nicht in den Sicherungen enthalten ist, wird das Skript beendet, indem dies gemeldet wird. <br><br>  Wenn Sicherungen f√ºr das angegebene Datum vorhanden sind, fordern Sie den Benutzer auf, den Namen des Felds einzugeben, das wiederhergestellt werden muss.  Um alle Boxen wiederherzustellen, m√ºssen Sie ALLE oder alle schreiben. <br><br>  Wenn die Option ALL ausgew√§hlt ist, erstellt das Skript eine Liste der Dateien im Sicherungsordner in der Datei und benachrichtigt Sie √ºber das Ergebnis der Erstellung. <br><br>  Als n√§chstes folgt eine schrittweise Wiederherstellung jeder Box.  √úberpr√ºfen Sie zun√§chst, ob im System ein K√§stchen vorhanden ist. Andernfalls wird es erstellt und dann wiederhergestellt.  Informationen zu jedem Vorgang werden in der Protokolldatei und auf dem Bildschirm angezeigt. <br><br>  Wenn ein bestimmtes Feld ausgew√§hlt ist, ist es fast dasselbe.  √úberpr√ºfen Sie, ob eine Datei mit dem angeforderten Namen vorhanden ist.  Ausgabe auf den Bildschirm und die Ergebnisprotokolldatei. <br><br>  √úberpr√ºfen, ob im System ein K√§stchen vorhanden ist.  Ausgabe auf den Bildschirm und die Ergebnisprotokolldatei. <br>  Die Aufforderung an den Benutzer, der Erstellung der Box zuzustimmen, wenn diese nicht im System vorhanden ist.  Ausgabe auf den Bildschirm und die Ergebnisprotokolldatei. <br><br>  Erstellen Sie eine Box, wenn dies vereinbart wurde.  Ausgabe auf den Bildschirm und die Ergebnisprotokolldatei. <br>  Postfachwiederherstellung.  Ausgabe auf den Bildschirm und die Ergebnisprotokolldatei. <br><br>  L√∂schen einer Datei mit einer Liste von Wiederherstellungsfeldern. <br><br>  Am Ende werden Informationen zur Abschlusszeit des Skripts auf dem Bildschirm und in der Protokolldatei angezeigt. </div></div><br><h3>  5. In Bezug auf die Wiederherstellung </h3><br>  Wenn Sie diese Skripte geringf√ºgig √§ndern, eignen sie sich gut zum Verschieben von E-Mails von Server zu Server, indem Sie einfach Postf√§cher mit allen Inhalten an einem neuen Ort erstellen.  Sie k√∂nnen das System auch von Grund auf wiederherstellen, wenn es aus irgendeinem Grund einfacher ist, den Zimbra-Server erneut zu starten, als zu versuchen, den alten wiederzubeleben.  Wie oben beschrieben, k√∂nnen Sie das Image der konfigurierten virtuellen Maschine speichern, indem Sie es bei Bedarf erweitern und mit allen Daten f√ºllen.  Der gleiche Algorithmus f√ºr den Wechsel von einem Zimbra-Server zu einem anderen.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Und es werden keine kostenpflichtigen Dienstprogramme wie Zextras ben√∂tigt. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Fazit </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im Allgemeinen sind die von mir geschriebenen Skripte nicht kompliziert. </font><font style="vertical-align: inherit;">Ja, es gibt viele Bedingungen in ihnen, weil ich versucht habe, so viele Probleme und Fehler wie m√∂glich in ihrer Arbeit vorherzusagen, aber ich habe auch versucht, das Skript so klar wie m√∂glich zu kommentieren. </font><font style="vertical-align: inherit;">H√∂chstwahrscheinlich funktionieren sie nicht f√ºr alle. </font><font style="vertical-align: inherit;">Vielleicht hat jemand diese Sicherungsmethode √ºberhaupt nicht. </font><font style="vertical-align: inherit;">Aber ich hoffe, viele werden es n√ºtzlich finden.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. PS: </font></font></h3><br>      ¬´  ¬´Zimbra¬ª ¬ª. ,  , LDAP-       AD, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> . <br>             AD  Zimbra OSE <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a> . <br><br>    ,        , -       ¬´  ¬ª,  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de439728/">https://habr.com/ru/post/de439728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de439718/index.html">Anwendungsentwicklung auf Elixir / Phoenix mit Docker</a></li>
<li><a href="../de439720/index.html">Einf√ºhrung in die Programmierung: Ein einfacher 3D-Shooter von Grund auf √ºber das Wochenende, Teil 2</a></li>
<li><a href="../de439722/index.html">Auswirkungen von SVG-Filtern. Teil 2. Gliederungstext mit feMorphology</a></li>
<li><a href="../de439724/index.html">√úberblick √ºber AI & ML-L√∂sungen im Jahr 2018 und Prognosen f√ºr 2019: Teil 2 - Tools und Bibliotheken, AutoML, RL, Ethik in AI</a></li>
<li><a href="../de439726/index.html">Lock-in: wahr oder fiktiv?</a></li>
<li><a href="../de439730/index.html">Organisation des Reduzierers durch eine Standardklasse</a></li>
<li><a href="../de439732/index.html">Lazarus - einfache Animation mit der TImageFragment-Komponente</a></li>
<li><a href="../de439734/index.html">Bereitstellung von Kubernetes auf dem Desktop in wenigen Minuten mit MicroK8s</a></li>
<li><a href="../de439736/index.html">IPSec VPN-Verbindung zwischen MikroTik und Kerio Control</a></li>
<li><a href="../de439738/index.html">Auf der Suche nach der Schaltfl√§che "Gut machen". Zyxel im Netzwerk kleiner und mittlerer Unternehmen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>