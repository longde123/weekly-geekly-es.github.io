<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí´ ü§∞üèº üè™ Optimizaci√≥n forzada de consultas PostgreSQL üë®‚Äçüë©‚Äçüëß‚Äçüëß üôà üëçüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© hacer cuando hay una aplicaci√≥n de c√≥digo cerrado que no accede a la base de datos de la manera m√°s √≥ptima? ¬øC√≥mo ajustar las consultas sin cambi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Optimizaci√≥n forzada de consultas PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432944/"> ¬øQu√© hacer cuando hay una aplicaci√≥n de c√≥digo cerrado que no accede a la base de datos de la manera m√°s √≥ptima?  ¬øC√≥mo ajustar las consultas sin cambiar la aplicaci√≥n, y posiblemente la base de datos en s√≠? <br><br>  Si no ha hecho tales preguntas, es un DBA muy exitoso y riguroso. <br><br>  Bueno, si me lo piden, d√©jenme compartir el sufrimiento y la experiencia. <br><a name="habracut"></a><br><h3>  Necesita almacenar m√°s datos o configurar una tarea </h3><br>  Puede desplazarse con seguridad por esta secci√≥n si el historial del problema no es interesante. <br><br>  Inicialmente, ten√≠amos un sistema propietario que analizaba sus datos de un formato cerrado en la base de datos PostgreSQL, desde donde le√≠amos, analiz√°bamos y proces√°bamos estos datos. <br><br>  Adem√°s, las herramientas de este sistema tambi√©n usaron esta base para ciertas operaciones, por lo que abandonarla y crear una copia con su estructura parec√≠a una idea in√∫til. <br><br>  De forma predeterminada, el sistema elimina autom√°ticamente los registros anteriores a una semana, por lo que no hubo problemas de rendimiento en el stand. <br><br>  Sin embargo, necesitamos almacenar datos mucho m√°s tiempo, siempre que haya suficiente espacio en el disco del servidor.  Bueno, es muy recomendable no perder el acceso a estos datos y seguir utilizando las herramientas integradas del sistema, incluso para datos antiguos. <br><br>  Por lo tanto, la decisi√≥n obvia fue realizar particiones y disparadores en las operaciones INSERT.  El enfoque es bastante simple y efectivo.  Los datos se insertan en las particiones necesarias, la eliminaci√≥n de registros antiguos est√° deshabilitada, todo parece estar bien. <br><br>  Hasta que pasaron un par de a√±os y los datos no se acumularon bien. <br><br>  Aqu√≠, "de repente" result√≥ que las solicitudes realizadas por las herramientas del sistema utilizado no limitan la selecci√≥n por fecha (o m√°s bien, no lo limitan al campo seg√∫n el cual se realiza la partici√≥n).  Es decir  Si estamos buscando algo, la b√∫squeda se realiza en todas las particiones.  Las operaciones de ACTUALIZACI√ìN tambi√©n comenzaron a disminuir: en condiciones solo se usaba un ID-shnik. <br><br>  Como resultado, la solicitud se ejecuta durante mucho tiempo, retira todas las dem√°s solicitudes, la carga est√° creciendo r√°pidamente. <br><br>  Por supuesto, lo primero que viene a la mente es contactar al desarrollador. <br><br>  Sin embargo, en la mayor√≠a de los casos, ya no est√° en la zona de acceso, o solicitar√° el costo de otro sistema para completar en varias l√≠neas. <br><br>  Por lo tanto, surgi√≥ la idea de que probablemente ya exista alg√∫n tipo de proxy que pueda ayudarnos. <br><br><h3>  Necesitamos un proxy </h3><br>  La b√∫squeda r√°pida en Google no encontr√≥ una respuesta clara a la pregunta de c√≥mo reescribir una consulta entrante al lado de PostgreSQL o alg√∫n software de terceros. <br><br>  Por lo tanto (bueno, solo por diversi√≥n tambi√©n, por supuesto), se escribi√≥ un software bastante simple que acepta conexiones de clientes y las env√≠a por proxy en PostgreSQL.  Al mismo tiempo, se leen las consultas SQL entrantes y, si es necesario, se reemplazan. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Compartir un enlace a github</a> <br><br>  Si bien no hice ning√∫n paquete binario, mis manos no llegaron.  Pero el montaje es bastante simple.  Todo est√° escrito en C ++ / Qt, porque  Llevo mucho tiempo escribiendo sobre esto ... <br><br>  La configuraci√≥n es bastante simple: <br><br>  Especifique qu√© interfaz y puerto escuchar: <br><br><pre><code class="plaintext hljs">listen_address=0.0.0.0 listen_port=5433</code> </pre> <br>  Obligamos al software negligente a conectarse a la direcci√≥n especificada en lugar de conectarse directamente al servidor PostgreSQL. <br><br>  Anotamos d√≥nde reenviar las conexiones (en este ejemplo, el proxy se encuentra en la misma m√°quina que el servidor PostgreSQL): <br><br><pre> <code class="plaintext hljs">dst_address=127.0.0.1 dst_port=5432</code> </pre> <br>  Establecemos una expresi√≥n regular para capturar la solicitud deseada: <br><br><pre> <code class="plaintext hljs">query = SELECT \* FROM tablename WHERE (.+)</code> </pre> <br>  Decimos que necesitamos reescribirlo: <br><br><pre> <code class="plaintext hljs">action = rewrite</code> </pre> <br>  Decimos c√≥mo reescribir: <br><br><pre> <code class="plaintext hljs">rewrite = SELECT * FROM tablename WHERE (col3 &gt;= '$(now-1M)') AND $(1)</code> </pre> <br>  En este ejemplo, agregamos un filtro a las condiciones de consulta por la columna con la fecha, lo que indica que solo estamos interesados ‚Äã‚Äãen los registros del √∫ltimo mes. <br><br>  Se podr√≠a escribir as√≠: <br><br><pre> <code class="plaintext hljs">rewrite = SELECT * FROM tablename WHERE (col3 &gt;= now() - interval '1 month') AND $(1)</code> </pre> <br>  Pero la solicitud no ser√° √≥ptima debido a la presencia de la funci√≥n now (); la b√∫squeda se seguir√° realizando en todas las particiones.  Para buscar solo en lo necesario, debe especificar un valor constante.  Por lo tanto, nuestro proxy sustituye la marca de tiempo con un turno de un mes en lugar de la construcci√≥n $ (ahora-1M). <br><br>  Resultado (del registro): <br><br><pre> <code class="plaintext hljs">ORIGINAL query: SELECT * FROM tablename WHERE id=1; MODIFIED query (rule 1): SELECT * FROM tablename WHERE (col3 &gt;= '2018-11-12 11:25:23.0+00') AND id=1;</code> </pre> <br>  Por lo tanto, es posible reemplazar, en principio, cualquier solicitud.  Las respuestas del servidor no cambian y se transmiten al cliente tal cual.  De esta manera, el retraso de transmisi√≥n se minimiza.  Adem√°s, la aplicaci√≥n generalmente espera una respuesta de cierto formato, por lo que no es deseable cambiar el conjunto de columnas en la solicitud y la respuesta. <br><br>  Tambi√©n es posible imprimir f√°cilmente todas las solicitudes de inter√©s en el registro: <br><br><pre> <code class="plaintext hljs">query = .+ action = log</code> </pre> <br>  El repositorio tiene una configuraci√≥n con ejemplos y una descripci√≥n m√°s detallada. <br><br>  Por cierto, es f√°cil determinar qu√© tan bien el desarrollador escribe correctamente para trabajar con la base de datos.  Por ejemplo, si ve una solicitud tan frecuentemente ejecutada, es hora de que alguien fume manuales. <br><br><pre> <code class="plaintext hljs">INSERT INTO tablename (col1, col2, col3) VALUES('value1', 1, '2018-12-31')</code> </pre> <br>  Deber√≠a ser as√≠: <br><br><pre> <code class="plaintext hljs">INSERT INTO tablename (col1, col2, col3) VALUES($1::varchar, $2::integer, $3::date)</code> </pre> <br>  Desafortunadamente, hasta ahora nuestro proxy no puede escribir de esta manera: / pero esto no es dif√≠cil de hacer.  Quiz√°s en el futuro sea posible reescribir la primera solicitud a la segunda. <br><br>  S√≠, el punto importante es que SSL a√∫n no es compatible, por lo que todas las conexiones de los clientes a los servidores proxy se realizar√°n sin cifrado. <br><br>  Estar√© encantado de comentar y comentar. <br><br>  Si hay un inter√©s activo de los usuarios, quiz√°s desarrolle m√°s el proyecto. <br><br>  Puede agregar trabajo con otras bases de datos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es432944/">https://habr.com/ru/post/es432944/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es432932/index.html">Ecosistema del mundo de compras digitales (para robar menos)</a></li>
<li><a href="../es432934/index.html">Levitaci√≥n f√°cilmente accesible en ultrasonido</a></li>
<li><a href="../es432936/index.html">Webinar Group-IB "SOC basado en inteligencia y ¬øes posible prescindir de √©l?"</a></li>
<li><a href="../es432940/index.html">50 tonos de ficha</a></li>
<li><a href="../es432942/index.html">Patrones de corutina y antipatrones en Kotlin</a></li>
<li><a href="../es432946/index.html">Unidad: trampas del desarrollo de juegos en 2D</a></li>
<li><a href="../es432948/index.html">Nubes inteligentes, empresas inteligentes: c√≥mo la IA transforma la industria de la computaci√≥n en la nube</a></li>
<li><a href="../es432954/index.html">Y de nuevo al espacio: c√≥mo visit√≥ el unicornio Stellarium</a></li>
<li><a href="../es432956/index.html">Monstruos de Id: c√≥mo se cre√≥ Doom</a></li>
<li><a href="../es432958/index.html">La nueva paradoja cu√°ntica aclara en qu√© caso nuestras ideas sobre la realidad resultan ser err√≥neas.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>