<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯМжя╕П ЁЯИВя╕П ЁЯСйЁЯП┐ рдореЗрд▓рдмреЙрдХреНрд╕ рдореЗрдВ рдПрдХ рд╕рд╛рдБрдк рдФрд░ F # рдХреНрдпрд╛ рдХрд░рддрд╛ рд╣реИ ЁЯП│я╕П ЁЯЫгя╕П ЁЯЪЦ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдпрд╣ рд╕рдм рдХреНрдпрд╛ рд╣реИ? 


 рдпрд╣ рд╕рдм рд╕рд╛рдВрдк рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИред рд╣рд░ рдХреЛрдИ рдпрд╛рдж рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рд╛рдВрдк рдХреНрдпрд╛ рд╣реИ: рдПрдХ рдЖрдпрддрд╛рдХрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдкрд░ рдПрдХ рд╕рд╛рдВрдк рдЪрд▓рддрд╛ рд╣реИред рднреЛрдЬрди рдкрд╛рддрд╛ рд╣реИ - рд▓рдВрдмрд╛рдИ рдореЗрдВ рдмрдврд╝рдд...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдореЗрд▓рдмреЙрдХреНрд╕ рдореЗрдВ рдПрдХ рд╕рд╛рдБрдк рдФрд░ F # рдХреНрдпрд╛ рдХрд░рддрд╛ рд╣реИ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424861/"><h4 id="o-chem-eto-vse">  рдпрд╣ рд╕рдм рдХреНрдпрд╛ рд╣реИ? </h4><br><p>  рдпрд╣ рд╕рдм рд╕рд╛рдВрдк рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИред  рд╣рд░ рдХреЛрдИ рдпрд╛рдж рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рд╛рдВрдк рдХреНрдпрд╛ рд╣реИ: рдПрдХ рдЖрдпрддрд╛рдХрд╛рд░ рдХреНрд╖реЗрддреНрд░ рдкрд░ рдПрдХ рд╕рд╛рдВрдк рдЪрд▓рддрд╛ рд╣реИред  рднреЛрдЬрди рдкрд╛рддрд╛ рд╣реИ - рд▓рдВрдмрд╛рдИ рдореЗрдВ рдмрдврд╝рддрд╛ рд╣реИ, рдЦреБрдж рдХреЛ рдпрд╛ рдЦреЗрдд рдХреЗ рдХрд┐рдирд╛рд░реЗ рдХреЛ рдкрд╛рддрд╛ рд╣реИ - рдорд░ рдЬрд╛рддрд╛ рд╣реИред  рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ рдХрдорд╛рдВрдб рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ: рдмрд╛рдПрдВ, рджрд╛рдПрдВ, рдКрдкрд░, рдиреАрдЪреЗред <br>  рдореИрдВрдиреЗ рдпрд╣рд╛рдБ рдХреБрдЫ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдЬреЛрдбрд╝рдиреЗ рдФрд░ рд╕рд╛рдБрдк рдХреЛ рдкреИрдЦрд╛рдиреЗ рд╕реЗ рднрд╛рдЧрдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ред  рдФрд░ рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдкрд░ рдпрд╣ рд╕рдм! </p><br><p> рдЗрд╕рд▓рд┐рдП, рдЖрдЬ рдореИрдВ рдорд╛рдирдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕реЗ <code>MailboxProcessor</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдореЙрдбрд▓ рдмрдирд╛рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдВрдк рдХреЗ рдЙрджрд╛рд╣рд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реВрдВрдЧрд╛, рдЬреЛ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдмрд┐рдВрджреБ рд╣реИрдВ, рдФрд░ рдЖрдк рдХреНрдпрд╛ рдЙрдореНрдореАрдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  рдпрд╣рд╛рдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рдХреЛрдб рд╕рд╣реА рдирд╣реАрдВ рд╣реИ, рдХреБрдЫ рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХрд╛ рдЙрд▓реНрд▓рдВрдШрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдмреЗрд╣рддрд░ рд▓рд┐рдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЖрдк рд╢реБрд░реБрдЖрддреА рд╣реИрдВ рдФрд░ рдореЗрд▓рдмреЙрдХреНрд╕ рд╕реЗ рдирд┐рдкрдЯрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ - рдореБрдЭреЗ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдпрд╣ рд▓реЗрдЦ рдЖрдкрдХреА рдорджрдж рдХрд░рддрд╛ рд╣реИред <br>  рдпрджрд┐ рдЖрдк рдореЗрд░реЗ рдмрд┐рдирд╛ рдореЗрд▓рдмреЙрдХреНрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рдм рдХреБрдЫ рдЬрд╛рдирддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдпрд╣рд╛рдБ рдмреЛрд░ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред </p><br><h4 id="pochemu-aktory">  рдЕрднрд┐рдиреЗрддрд╛ рдХреНрдпреЛрдВ? </h4><br><p>  рдЕрднреНрдпрд╛рд╕ рдХреЗ рд▓рд┐рдПред  рдореИрдВрдиреЗ рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреЗ рдореЙрдбрд▓ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрдврд╝рд╛, рд╡реАрдбрд┐рдпреЛ рджреЗрдЦрд╛, рдореБрдЭреЗ рд╕рдм рдХреБрдЫ рдкрд╕рдВрдж рдЖрдпрд╛, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рдЦреБрдж рдЗрд╕реЗ рдЖрдЬрдорд╛рдпрд╛ рдирд╣реАрдВред  рдЕрдм рдореИрдВрдиреЗ рдЗрд╕реЗ рдЖрдЬрдорд╛рдпрд╛ред <br>  рдЗрд╕ рддрдереНрдп рдХреЗ рдмрд╛рд╡рдЬреВрдж рдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдореИрдВрдиреЗ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдХреЗ рд▓рд┐рдП рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдХреЛ рдЪреБрдирд╛, рдЕрд╡рдзрд╛рд░рдгрд╛ рдмрд╣реБрдд рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЗрд╕ рдХрд╛рд░реНрдп рдкрд░ рдЧрд┐рд░ рдЧрдИред </p><br><h4 id="pochemu-mailboxprocessor-a-ne-naprimer-akkanet">  рдХреНрдпреЛрдВ MailboxProcessor, рдФрд░ рдирд╣реАрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, Akka.net? </h4><br><p>  рдореЗрд░реЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП, <code>MailboxProcessor</code> рдЧреМрд░реИрдпрд╛ рджреНрд╡рд╛рд░рд╛ рдХрдХреНрд╖реАрдп рд╕реНрдЯреЗрд╢рди рд╕реЗ рд╣реИ, <code>MailboxProcessor</code> рдмрд╣реБрдд рд╕рд░рд▓ рд╣реИ, рдФрд░ рдпрд╣ рдорд╛рдирдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдХрд┐рд╕реА рднреА рдкреИрдХреЗрдЬ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред </p><a name="habracut"></a><br><h4 id="o-meylboks-processorah-i-soputsvuyuschem-boylerpleyte">  рдореЗрд▓рдмреЙрдХреНрд╕ рдкреНрд░реЛрд╕реЗрд╕рд░ рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдмреЙрдпрд▓рд░рдкреНрд▓реЗрдЯ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ </h4><br><p>  рдмрд╛рдд рд╕рд░рд▓ рд╣реИред  рдореЗрд▓рдмреЙрдХреНрд╕ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╕рдВрджреЗрд╢ рд▓реВрдк рдФрд░ рдХреБрдЫ рд╕реНрдерд┐рддрд┐ рд╣реИред  рдЖрдкрдХрд╛ рд╕рдВрджреЗрд╢ рд▓реВрдк рдЖрдиреЗ рд╡рд╛рд▓реЗ рдирдП рд╕рдВрджреЗрд╢ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдЧрд╛ред </p><br><pre> <code class="hljs kotlin">let actor = MailboxProcessor.Start(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> inbox -&gt; // ,    //   . inbox --    MailboxProcessor let rec messageLoop oldState = async { //   let! msg = inbox.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">//    let newState = updateState oldState msg //      return! messageLoop newState } //       .    --     messageLoop (0,0) )</span></span></code> </pre> <br><p>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ <code>messageLoop</code> рдкреБрдирд░рд╛рд╡рд░реНрддреА рд╣реИ, рдФрд░ рдЕрдВрдд рдореЗрдВ рдЗрд╕реЗ рдлрд┐рд░ рд╕реЗ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЕрдиреНрдпрдерд╛ рдХреЗрд╡рд▓ рдПрдХ рд╕рдВрджреЗрд╢ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рдпрд╣ рдЕрднрд┐рдиреЗрддрд╛ рдорд░ рдЬрд╛рдПрдЧрд╛ред  <code>messageLoop</code> рднреА рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рд╣реИ, рдФрд░ рдЬрдм рдирдпрд╛ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдкреНрд░рддреНрдпреЗрдХ рдмрд╛рдж рдХреА рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рдХреА рдЬрд╛рддреА рд╣реИ: <code>let! msg = inbox.Receive()</code>  <code>let! msg = inbox.Receive()</code> ред <br>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╕рдВрдкреВрд░реНрдг рддрд╛рд░реНрдХрд┐рдХ рд▓реЛрдб <code>updateState</code> рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рдореЗрд▓рдмреЙрдХреНрд╕ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдХ рдирд┐рд░реНрдорд╛рддрд╛ рдлрд╝рдВрдХреНрд╢рди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рд╕реНрдЯреЗрдЯ рдЕрдкрдбреЗрдЯ рдлрд╝рдВрдХреНрд╢рди рдФрд░ рдПрдХ рд╢реВрдиреНрдп рд╕реНрдерд┐рддрд┐ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="hljs haskell">//   applyMessage       //      (fun inbox -&gt; ...) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buildActor applyMessage zeroState = <span class="hljs-type"><span class="hljs-type">MailboxProcessor</span></span>.<span class="hljs-type"><span class="hljs-type">Start</span></span>(fun inbox -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> loop state = async{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! msg = inbox.<span class="hljs-type"><span class="hljs-type">Receive</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> newState = applyMessage state msg return! loop newState } loop zeroState )</code> </pre><br><p>  рдХреВрд▓!  рдЕрдм рд╣рдореЗрдВ рд▓рдЧрд╛рддрд╛рд░ рдирд┐рдЧрд░рд╛рдиреА рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ рддрд╛рдХрд┐ <code>return! loop newState</code> рди рднреВрд▓реЗрдВ <code>return! loop newState</code>  <code>return! loop newState</code> ред  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ, рдПрдХ рдЕрднрд┐рдиреЗрддрд╛ рдПрдХ рд░рд╛рдЬреНрдп рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдм рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдЗрд╕ рд░рд╛рдЬреНрдп рдХреЛ рдмрд╛рд╣рд░ рд╕реЗ рдХреИрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдПред  рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рдореЗрд▓рдмреЙрдХреНрд╕ рдореЗрдВ рдПрдХ <code>PostAndReply</code> рд╡рд┐рдзрд┐ рд╣реЛрддреА рд╣реИ, рдЬреЛ рдПрдХ рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ <code>AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg</code> рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд▓реЗ рдЬрд╛рддреА рд╣реИред  рдкрд╣рд▓реЗ рддреЛ рдЗрд╕рдиреЗ рдореБрдЭреЗ рд╕реНрддреВрдк рдореЗрдВ рд▓реЗ рдЬрд╛рдпрд╛ - рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдпрд╣ рдХрд╛рд░реНрдп рдХрд╣рд╛рдВ рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рдПред  рд▓реЗрдХрд┐рди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд╕рдм рдХреБрдЫ рд╕рд░рд▓ рд╣реЛ рдЧрдпрд╛: рд╕рднреА рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдбреАрдпреВ рдХреЗ рдЖрд╡рд░рдг рдореЗрдВ рд▓рдкреЗрдЯрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдХреНрдпреЛрдВрдХрд┐ рдЕрдм рд╣рдо рдЕрдкрдиреЗ рдЕрднрд┐рдиреЗрддрд╛ рдкрд░ 2 рдСрдкрд░реЗрд╢рди рдХрд░рддреЗ рд╣реИрдВ: рд╕рдВрджреЗрд╢ рд╕реНрд╡рдпрдВ рднреЗрдЬреЗрдВ рдФрд░ рд╡рд░реНрддрдорд╛рди рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП рдкреВрдЫреЗрдВред  рдпрд╣рд╛рдБ рдпрд╣ рдХреИрд╕рд╛ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Mail&lt;_,_&gt;   ,  Post &amp; Get --  . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ F#       , /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   compare &amp; equals . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/         --   . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   [&lt;Struct&gt;] .       type Mail&lt;'msg, 'state&gt; = | Post of 'msg | Get of AsyncReplyChannel&lt;'state&gt;</span></span></code> </pre> <br><p>  рд╣рдорд╛рд░рд╛ рдирд┐рд░реНрдорд╛рдг рдХрд╛рд░реНрдп рдЕрдм рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="hljs erlang-repl">let buildActor applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec loop state = async{ let! msg = inbox.Receive() //    ,     // .    -- ,     //     . //     --      //    .      ! match msg with | Post msg -&gt; let newState = applyMessage state msg return! loop newState | Get channel -&gt; channel.Reply state return! loop state } loop zeroState )</code> </pre><br><p>  рдЕрдм, рдореЗрд▓рдмреЙрдХреНрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдЗрд╕ <code>Mail.Post</code> рдореЗрдВ рдЕрдкрдиреЗ рд╕рднреА рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд▓рдкреЗрдЯрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╣рд░ рдмрд╛рд░ рдЗрд╕реЗ рди рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП, рдЗрд╕реЗ рдЫреЛрдЯреЗ рдРрдк рдореЗрдВ рд▓рдкреЗрдЯрдирд╛ рдмреЗрд╣рддрд░ рд╣реИ: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span> Mailbox = let buildAgent applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state = async{ let! msg = inbox.Receive() match msg with | Post msg -&gt; let newState = applyMessage state msg <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> newState | Get channel -&gt; channel.Reply state <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state } <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> zeroState ) let post (agent: MailboxProcessor&lt;_&gt;) msg = Post msg |&gt; agent.Post let getState (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndReply Get let getStateAsync (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndAsyncReply Get <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   Single Case Discriminated Union. <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> MailboxProcessor   API.      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  ,  ,      <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   .       ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>        . type MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt; = MailAgent <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> address:string * mailbox:MailboxProcessor&lt;Mail&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt;&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     API with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>            let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.post <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> msg member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetState() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getState <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetStateAsync() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getStateAsync <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Address = let (MailAgent (address, _)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> address member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = let (MailAgent (_, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> (this:&gt;IDisposable).Dispose() interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose()</code> </pre> <br><p>  рдореИрдВ рдЖрдкрдХреЛ рдмрддрд╛рдКрдВрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ <code>address:string</code> рдереЛрдбрд╝рд╛ рдмрд╛рдж рдореЗрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдм рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдмреЙрдпрд▓рд░рдкреНрд▓реЗрдЯ рддреИрдпрд╛рд░ рд╣реИред </p><br><h4 id="sobstvenno-zmeyka">  рджрд░рдЕрд╕рд▓, рд╕рд╛рдВрдк </h4><br><p>  рд╕рд╛рдВрдк рдореЗрдВ рдПрдХ рд╕рд╛рдВрдк рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреА рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛, рдПрдХ рдХреНрд╖реЗрддреНрд░ рдФрд░ рдЕрдЧрд▓реЗ рдлреНрд░реЗрдо рдХреЗ рд▓рд┐рдП рдПрдХ рдирд┐рдпрдорд┐рдд рд╕рдВрдХреНрд░рдордг рд╣реЛрддрд╛ рд╣реИред <br>  рдпрд╣рд╛рдВ рдпрд╣ рд╕рдм рдПрдХ рд╕рд╛рде рд╣реИ рдФрд░ рд╣рдорд╛рд░реЗ рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреЛ рдореБрд╕реНрдХреБрд░рд╛рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИред <br>  рдореЗрд░рд╛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд▓реЗрдЖрдЙрдЯ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдерд╛: </p><br><ul><li>  рдПрдХ рдЯрд╛рдЗрдорд░ рдХреЗ рд╕рд╛рде рдЕрднрд┐рдиреЗрддрд╛ред  рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдкреНрд░рд╛рд░рдВрдн / рд░реЛрдХ / рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИред  рдкреНрд░рддреНрдпреЗрдХ n рдорд┐рд▓реАрд╕реЗрдХрдВрдб, <code>Flush</code> рдПрдХреНрдЯрд░ рдХреЛ рдПрдХ <code>Flush</code> рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИред  рднрдВрдбрд╛рд░ рдкреНрд░рдгрд╛рд▓реАред рдПрдХ рд░рд╛рдЬреНрдп рдХреЗ рд░реВрдк рдореЗрдВ </li><li>  рдЕрднрд┐рдиреЗрддрд╛ рджрд▓ред  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ <code>Move Up/Down/Left/Right</code> , <code>AddPerk Speed/Attack</code> (рд╣рд╛рдВ, рдореЗрд░рд╛ рд╕рд╛рдВрдк рдЬрд▓реНрджреА рд╕реЗ рдХреНрд░реЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЦрд▓рдирд╛рдпрдХ рдкрд░ рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИ) рдФрд░ рдЯрд╛рдЗрдорд░ рд╕реЗ <code>Flush</code> ред  рдпрд╣ рдПрдХ рд░рд╛рдЬреНрдп рдХреЗ рд░реВрдк рдореЗрдВ рдЖрджреЗрд╢реЛрдВ рдХреА рдПрдХ рд╕реВрдЪреА рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдПрдХ рдлреНрд▓рд╢ рдХреЗ рд╕рд╛рде рдпрд╣ рд╕реВрдЪреА рд░реАрд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред </li><li>  рдЕрднрд┐рдиреЗрддрд╛ рдПрдХ рд╕рд╛рдВрдк рд╣реИред  рдпрд╣ рд╕рд╛рдВрдк рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ - рднрддреНрддреЛрдВ, рд▓рдВрдмрд╛рдИ, рджрд┐рд╢рд╛, рдЭреБрдХрддрд╛ рд╣реИ рдФрд░ рдирд┐рд░реНрджреЗрд╢рд╛рдВрдХред <br>  рдпрд╣ рдХрдорд╛рдВрдбреНрд╕ рдХреЗ рдЕрднрд┐рдиреЗрддрд╛ рдХреА рд╕реВрдЪреА, <code>Tick</code> рд╕рдВрджреЗрд╢ (рд╕рд╛рдВрдк рдХреЛ 1 рд╕реЗрд▓ рдХреЛ рдЖрдЧреЗ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП) рдФрд░ <code>GrowUp</code> рдХреЗ рдорд┐рд▓рдиреЗ рдкрд░ рдХреНрд╖реЗрддреНрд░ рдХреЗ рдЕрднрд┐рдиреЗрддрд╛ рдХреЗ рдЙрддреНрдкрд╛рдж рд╕реЗ рд╕рдВрджреЗрд╢ рдХреЛ <code>GrowUp</code> рдХрд░рддрд╛ рд╣реИред </li><li>  рдХреНрд╖реЗрддреНрд░ рдХрд╛ рдЕрднрд┐рдиреЗрддрд╛ред  рдпрд╣ рдХреЛрд╢рд┐рдХрд╛рдУрдВ рдХрд╛ рдПрдХ рдирдХреНрд╢рд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рдПрдХ рд╕рдВрджреЗрд╢ рдореЗрдВ рд╕рд╛рдВрдк рдХреА рд╕реНрдерд┐рддрд┐ рд▓реЗрддрд╛ рд╣реИ рдФрд░ рдореМрдЬреВрджрд╛ рддрд╕реНрд╡реАрд░ рдкрд░ рдирд┐рд░реНрджреЗрд╢рд╛рдВрдХ рдЦреАрдВрдЪрддрд╛ рд╣реИред  рдпрд╣ <code>GrowUp</code> рд╕реНрдиреЗрдХ рдЕрднрд┐рдиреЗрддрд╛ рдФрд░ <code>Stop</code> рдХрдорд╛рдВрдб рдХреЛ рдЯрд╛рдЗрдорд░ рднреА рднреЗрдЬрддрд╛ рд╣реИред </li></ul><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдЗрддрдиреА рдХрдо рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рд╕рдВрд╕реНрдерд╛рдУрдВ рдХреЗ рд╕рд╛рде, рд╕рдВрджреЗрд╢ рдорд╛рдирдЪрд┐рддреНрд░ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЧреИрд░-рддреБрдЪреНрдЫ рд╣реИред  рдФрд░ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЗрд╕ рд╕реНрддрд░ рдкрд░ рдХрдард┐рдирд╛рдЗрдпрд╛рдВ рдЙрддреНрдкрдиреНрди рд╣реБрдИрдВ: рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдПрдл # рдЪрдХреНрд░реАрдп рдирд┐рд░реНрднрд░рддрд╛ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИред  рдХреЛрдб рдХреА рд╡рд░реНрддрдорд╛рди рдкрдВрдХреНрддрд┐ рдореЗрдВ, рдЖрдк рдХреЗрд╡рд▓ рдКрдкрд░ рд▓рд┐рдЦреЗ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рдлрд╛рдЗрд▓реЛрдВ рдкрд░ рднреА рдпрд╣реА рд▓рд╛рдЧреВ рд╣реЛрддрд╛ рд╣реИред  рдпрд╣ рдмрдЧ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реИ, рдФрд░ рдореИрдВ рдЗрд╕реЗ рдмрд╣реБрдд рдкрд╕рдВрдж рдХрд░рддрд╛ рд╣реВрдВ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдХреЛрдб рдХреЛ рд╕рд╛рдл рд░рдЦрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЬрдм рдбрд┐рдЬрд╛рдЗрди рджреНрд╡рд╛рд░рд╛ рдЪрдХреНрд░реАрдп рд▓рд┐рдВрдХ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рддреЛ рдХреНрдпрд╛ рдХрд░рдирд╛ рд╣реИ?  рдмреЗрд╢рдХ, рдЖрдк <code>rec namespace</code> рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ - рдФрд░ рдлрд┐рд░ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░ рдЖрдк рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рд╣рд░ рдЪреАрдЬ рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдореИрдВрдиреЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдерд╛ред <br>  рдХреЛрдб рдЧрдбрд╝рдмрдбрд╝ рдХрд░рдиреЗ рдХреА рдЙрдореНрдореАрдж рд╣реИ, рд▓реЗрдХрд┐рди рддрдм рдпрд╣ рдПрдХрдорд╛рддреНрд░ рд╡рд┐рдХрд▓реНрдк рдХреА рддрд░рд╣ рд▓рдЧ рд░рд╣рд╛ рдерд╛ред  рдФрд░ рдЗрд╕рдиреЗ рдХрд╛рдо рдХрд┐рдпрд╛ред </p><br><h4 id="problema-vneshnego-mira">  рдмрд╛рд╣рд░реА рджреБрдирд┐рдпрд╛ рдХреА рд╕рдорд╕реНрдпрд╛ </h4><br><p>  рдЬрдм рддрдХ рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреА рдкреВрд░реА рдкреНрд░рдгрд╛рд▓реА рдмрд╛рд╣рд░реА рджреБрдирд┐рдпрд╛ рд╕реЗ рдЕрд▓рдЧ рд╣реЛ рдЬрд╛рддреА рдереА, рддрдм рддрдХ рд╕рдм рдХреБрдЫ рдХрд╛рдо рдХрд░рддрд╛ рдерд╛, рдФрд░ рдореИрдВрдиреЗ рдХрдВрд╕реЛрд▓ рдореЗрдВ рдХреЗрд╡рд▓ рдбрд┐рдмреЗрдЯ рдФрд░ рдкреНрд░рджрд░реНрд╢рд┐рдд рд▓рд╛рдЗрдиреЛрдВ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ред  рдЬрдм <code>updateUI</code> рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд░реНрднрд░рддрд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рдЖрдпрд╛, рдЬрд┐рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдЯрд┐рдХ рдХреЗ рд▓рд┐рдП рдлрд┐рд░ рд╕реЗ рддреИрдпрд╛рд░ рдХрд░рдирд╛ рдерд╛, рддреЛ рдореИрдВ рд╡рд░реНрддрдорд╛рди рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрд╛ред  рди рддреЛ рдмрджрд╕реВрд░рдд рдФрд░ рди рд╣реА рд╕реБрдВрджрд░ - рдХреЛрдИ рд░рд╛рд╕реНрддрд╛ рдирд╣реАрдВред  рдФрд░ рдлрд┐рд░ рдореБрдЭреЗ рдЕрдХреНрдХреВ рдХреА рдпрд╛рдж рдЖрдИ - рдЖрдЦрд┐рд░рдХрд╛рд░, рдЖрдк рд░рд╛рд╕реНрддреЗ рдореЗрдВ рд╣реА рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреЛ рдкреИрджрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдореЗрд░реЗ рдкрд╛рд╕ рдореЗрд░реЗ рд╕рднреА рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХрд╛ рд╕рдВрдХрд▓рди рдЪрд░рдг рдореЗрдВ рд╡рд░реНрдгрди рд╣реИред <br>  рд╕рдорд╛рдзрд╛рди рд╕реНрдкрд╖реНрдЯ рд╣реИ - akku рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ!  рдирд╣реАрдВ, рдмреЗрд╢рдХ, рдЕрдХреНрдХрд╛ рдЕрднреА рднреА рдУрд╡рд░рдХрд┐рд▓ рд╣реИ, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рд╡рд╣рд╛рдВ рд╕реЗ рдХреБрдЫ рдмрд┐рдВрджреБрдУрдВ рдХреЛ рдЪрд╛рдЯрдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ - рдЕрд░реНрдерд╛рддреН, рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреА рдПрдХ рдкреНрд░рдгрд╛рд▓реА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рд╕рдореЗрдВ рдЖрдк рдирдП рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреЛ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкрддреЗ рдкрд░ рдореМрдЬреВрджрд╛ рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреЛ рдХреНрд╡реЗрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br>  рдЪреВрдВрдХрд┐ рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреЛ рдЕрдм рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рд░рдирдЯрд╛рдЗрдо рдореЗрдВ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╕реАрдзреЗ рд▓рд┐рдВрдХ рдХреЗ рдмрдЬрд╛рдп рдкрддреЗ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЖрдкрдХреЛ рдПрдХ рдкрд░рд┐рджреГрд╢реНрдп рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдЬрд╣рд╛рдВ рдкрддрд╛ рдХрд╣реАрдВ рдирд╣реАрдВ рджрд┐рдЦрддрд╛ рд╣реИ рдФрд░ рдЕрднрд┐рдиреЗрддрд╛ рд╡рд╣рд╛рдВ рдирд╣реАрдВ рд╣реИред  рдЙрд╕реА acca рдХреЗ рдЙрджрд╛рд╣рд░рдг рдХреЗ рдмрд╛рдж, рдореИрдВрдиреЗ рдореГрдд рдЕрдХреНрд╖рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдмреЙрдХреНрд╕ рдЬреЛрдбрд╝рд╛, рдФрд░ рдореИрдВрдиреЗ рдЗрд╕реЗ рдЕрдкрдиреЗ рдкрд╕рдВрджреАрджрд╛ DUs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Agent&lt;_,_&gt; --  ,   ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ,      . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      ,    --    Box (mailagent), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   ,   , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       Deadbox.      MailAgent,  . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>           . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    --    . type Agent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; = | Box <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; | DeadBox <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> string * MailAgent&lt;string * obj, Map&lt;string,obj list&gt;&gt; with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box box -&gt; box.Post msg | DeadBox (address, deadbox) -&gt; (address, box msg) |&gt; deadbox.Post interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box agent -&gt; agent.Dispose() | DeadBox (_,agent) -&gt; agent.Dispose()</code> </pre> <br><p>  рдФрд░ рд╕рд┐рд╕реНрдЯрдо рдЦреБрдж рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .     --    . type MailboxNetwork() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      .   ! [&lt;DefaultValue&gt;] val mutable agentRegister: ConcurrentDictionary&lt;string, obj&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister &lt;- ConcurrentDictionary&lt;string, obj&gt;() <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    Map --     let deadLettersFn deadLetters (address:string, msg:obj) = printfn <span class="hljs-string"><span class="hljs-string">"Deadletter: %s-%A"</span></span> address msg match Map.tryFind address deadLetters with <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   | None -&gt; Map.add address [msg] deadLetters <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   --   | Some letters -&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --      Map.remove address deadLetters |&gt; Map.add address (msg::letters) let deadLettersAgent() = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"deadLetters"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Map.empty |&gt; Mailbox.buildAgent deadLettersFn)</span></span></span><span class="hljs-function"> |&gt; MailAgent member this.DeadLetters = deadLettersAgent</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> // -     ,      member this.Box&lt;'message,'state&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address)</span></span></span><span class="hljs-function"> = match this.agentRegister.TryGetValue address with | </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, agent)</span></span></span><span class="hljs-function"> when </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(agent :? MailAgent&lt;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'message,'</span></span></span></span><span class="hljs-function"><span class="hljs-params">state&gt;)</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   let agent = agent :?&gt; MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message, '</span></span>state&gt; Box agent | _ -&gt; DeadBox (address, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DeadLetters) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --    member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox address = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryRemove(address) |&gt; ignore member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.RespawnBox (agent: MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'a,'</span></span>b&gt;) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox agent.Address <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryAdd (agent.Address, agent) |&gt; ignore interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> agent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.Values <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> match agent with | :? IDisposable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> agent -&gt; agent.Dispose() | _ -&gt; ()</code> </pre> <br><p>  рдпрд╣ рд╡рд╣ рдЬрдЧрд╣ рд╣реИ рдЬрд╣рд╛рдБ рдПрдХ рд╣реА <code>address:string</code> , рдЬрд┐рд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореИрдВрдиреЗ рдКрдкрд░ рд▓рд┐рдЦрд╛ рдерд╛, рдХрд╛рдо рдЖрдпрд╛ред  рдФрд░ рдлрд┐рд░ рд╕реЗ рдпрд╣ рдХрд╛рдо рдХрд┐рдпрд╛, рдмрд╛рд╣рд░реА рдирд┐рд░реНрднрд░рддрд╛ рдЕрдм рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЖрд╕рд╛рди рдерд╛ рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХрд╛рд░реНрдпреЛрдВ рдиреЗ рдЕрдм рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреА рдкреНрд░рдгрд╛рд▓реА рдХреЛ рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд▓рд┐рдпрд╛ рдФрд░ рд╡рд╣рд╛рдВ рд╕реЗ рдЖрд╡рд╢реНрдпрдХ рдкрддреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП: </p><br><pre> <code class="hljs haskell"> //    - (  )   - <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) //    message loop           <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> []</code> </pre><br><h4 id="medlenno">  рдзреАрд░реЗ-рдзреАрд░реЗ </h4><br><p>  рд╕реНрдкрд╖реНрдЯ рдХрд╛рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП, рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреЗ рджреМрд░рд╛рди, рдореИрдВрдиреЗ рдЧреЗрдо рдХреЛ рдХрдо рдЧрддрд┐ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛: рдЯрд┐рдХ рдХреЗ рдмреАрдЪ рдХреА рджреЗрд░реА 500 рдорд┐рд▓реАрд╕реЗрдХрдВрдб рд╕реЗ рдЕрдзрд┐рдХ рдереАред  рдпрджрд┐ рдЖрдкрдиреЗ рджреЗрд░реА рдХреЛ 200 рддрдХ рдХрдо рдХрд░ рджрд┐рдпрд╛, рддреЛ рд╕рдВрджреЗрд╢ рджреЗрд░ рд╕реЗ рдЖрдиреЗ рд▓рдЧреЗ, рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдЯреАрдореЛрдВ рдиреЗ рджреЗрд░реА рд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛, рдЬрд┐рд╕рдиреЗ рдкреВрд░рд╛ рдЦреЗрд▓ рдмрд┐рдЧрд╛рдбрд╝ рджрд┐рдпрд╛ред  рдорд░рд╣рдо рдореЗрдВ рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдордХреНрдЦреА рддрдереНрдп рдпрд╣ рдерд╛ рдХрд┐ рдЯрд╛рдЗрдорд░ рдХреЛ рдХрдИ рдмрд╛рд░ рдиреБрдХрд╕рд╛рди рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рд╕реНрдЯреЙрдк рдХрдорд╛рдВрдб рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖред  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рдкреНрд░рдХрдЯ рдирд╣реАрдВ рд╣реБрдЖ, рд▓реЗрдХрд┐рди рдлрд┐рд░ рднреА, рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХрд╛ рдмрдЧ рдерд╛ред <br>  рдЕрдкреНрд░рд┐рдп рд╕рддреНрдп рдпрд╣ рдерд╛ рдХрд┐ рдЕрднрд┐рдиреЗрддрд╛ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд░реВрдк рд╕реЗ рдорд╣рд╛рди рд╣реИрдВ, рд▓реЗрдХрд┐рди рдкреНрд░рддреНрдпрдХреНрд╖ рд╡рд┐рдзрд┐ рдХреЙрд▓ рдмрд╣реБрдд рддреЗрдЬ рд╣реИрдВред  рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рддрдереНрдп рдХреЗ рдмрд╛рд╡рдЬреВрдж рдХрд┐ рдХреЛрдб рдХреЛ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░рдиреЗ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рд╕рд╛рдВрдк рдХреЛ рдПрдХ рдЕрд▓рдЧ рдЕрднрд┐рдиреЗрддрд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдирд╛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдерд╛, рдореБрдЭреЗ рдЗрд╕ рд╡рд┐рдЪрд╛рд░ рдХреЛ рдЧрддрд┐ рдХреЗ рдирд╛рдо рдкрд░ рдЫреЛрдбрд╝рдирд╛ рдкрдбрд╝рд╛, рдХреНрдпреЛрдВрдХрд┐ рдЦреЗрд▓ рдХреА 1 рдШрдбрд╝реА рдХреЗ рд▓рд┐рдП рд╕рдВрджреЗрд╢ рдмрд╣реБрдд рддреАрд╡реНрд░ рдерд╛: </p><br><ol><li>  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реАрдзреЗ рдХрдорд╛рдВрдб рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рдПрдХ рдЕрдирд┐рдпрдВрддреНрд░рд┐рдд рд╕рдВрдЦреНрдпрд╛ рднреЗрдЬрддрд╛ рд╣реИред </li><li>  рдЯрд╛рдЗрдорд░ рдЯреАрдо рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рдПрдХ рдЯрд┐рдХ рднреЗрдЬрддрд╛ рд╣реИ рдФрд░, рдПрдХ рд╢реБрд░реБрдЖрддреА рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ, рд╕рд╛рдВрдк рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рднреА, рддрд╛рдХрд┐ рд╡рд╣ рд╕рд╛рдВрдк рдХреЛ рдЕрдЧрд▓реЗ рд╕реЗрд▓ рдореЗрдВ рд▓реЗ рдЬрд╛рдП </li><li>  рдХрдорд╛рдВрдб рдЕрднрд┐рдиреЗрддрд╛ рд╕рд╛рдВрдк рдХреЗ рд▓рд┐рдП рдХрдорд╛рдВрдб рдХреА рдПрдХ рд╕реВрдЪреА рднреЗрдЬрддрд╛ рд╣реИ рдЬрдм рдЯрд╛рдЗрдорд░ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╕рдВрджреЗрд╢ рдЖрддрд╛ рд╣реИред </li><li>  рд╕рд╛рдБрдк рдЕрднрд┐рдиреЗрддрд╛, 2 рдКрдкрд░реА рд╕рдВрджреЗрд╢реЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЕрдкрдиреЗ рд░рд╛рдЬреНрдп рдХреЛ рдЕрджреНрдпрддрди рдХрд░рддрд╛ рд╣реИ, рд░рд╛рдЬреНрдп рдХреЛ рдХреНрд╖реЗрддреНрд░ рдЕрднрд┐рдиреЗрддрд╛ рдХреЗ рдкрд╛рд╕ рднреЗрдЬрддрд╛ рд╣реИред </li><li>  рдХреНрд╖реЗрддреНрд░ рдЕрднрд┐рдиреЗрддрд╛ рд╕рдм рдХреБрдЫ redrawsред  рдЕрдЧрд░ рд╕рд╛рдВрдк рдХреЛ рдЦрд╛рдирд╛ рдорд┐рд▓ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рд╕рд╛рдВрдк рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рдПрдХ <code>GrowUp</code> рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рд╡рд╣ рдирдП рд░рд╛рдЬреНрдп рдХреЛ рдлрд╝реАрд▓реНрдб рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рд╡рд╛рдкрд╕ рднреЗрдЬ рджреЗрддрд╛ рд╣реИред </li></ol><br><p>  рдФрд░ рдЗрд╕ рд╕рдм рдХреЗ рд▓рд┐рдП 1 рдШрдбрд╝реА рдХрд╛ рдЪрдХреНрд░ рд╣реИ, рдЬреЛ рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИ, <code>MailboxProcessor</code> рдХреЗ рдЖрдВрддреЛрдВ рдореЗрдВ рд╕рд┐рдВрдХреНрд░рдирд╛рдЗрдЬрд╝реЗрд╢рди рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрддреЗ рд╣реБрдПред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╡рд░реНрддрдорд╛рди рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ, рдЯрд╛рдЗрдорд░ рдЕрдЧрд▓реЗ рд╕рдВрджреЗрд╢ рдХреЛ рд╣рд░ n рдорд┐рд▓реАрд╕реЗрдХреЗрдВрдб рдкрд░ рднреЗрдЬрддрд╛ рд╣реИ, рдЪрд╛рд╣реЗ рдХреБрдЫ рднреА рд╣реЛ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рд╣рдо 1 рдмрд╛рд░ рдорд╛рдк рдореЗрдВ рдирд╣реАрдВ рдЖрдП, рддреЛ рд╕рдВрджреЗрд╢ рдЬрдорд╛ рд╣реЛрдиреЗ рд▓рдЧрддреЗ рд╣реИрдВ, рдФрд░ рд╕реНрдерд┐рддрд┐ рдмрд┐рдЧрдбрд╝ рдЬрд╛рддреА рд╣реИред  рдЗрд╕ рд╡рд┐рд╢реЗрд╖ рдЙрдкрд╛рдп рдХреЛ "рд╕реНрдЯреНрд░реЗрдЪ" рдХрд░рдирд╛ рдЬреНрдпрд╛рджрд╛ рдмреЗрд╣рддрд░ рд╣реЛрдЧрд╛, рдЬреЛ рдХреБрдЫ рднреА рдЬрдорд╛ рд╣реБрдЖ рд╣реИ рдЙрд╕реЗ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░реЗрдВ рдФрд░ рдЖрдЧреЗ рдмрдврд╝реЗрдВред </p><br><h4 id="finalnaya-versiya">  рдЕрдВрддрд┐рдо рд╕рдВрд╕реНрдХрд░рдг </h4><br><p>  рдЬрд╛рд╣рд┐рд░ рд╣реИ, рд╕рдВрджреЗрд╢ рдпреЛрдЬрдирд╛ рдХреЛ рд╕рд░рд▓ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬрдмрдХрд┐ рдХреЛрдб рдХреЛ рдпрдерд╛рд╕рдВрднрд╡ рд╕рд░рд▓ рдФрд░ рд╕реБрд▓рдн рдЫреЛрдбрд╝рдирд╛ рдмрд╣реБрдд рд╣реА рд╡рд╛рдВрдЫрдиреАрдп рд╣реИ - рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдмреЛрд▓рдирд╛, рдореИрдВ 1 рджреЗрд╡ рдЕрднрд┐рдиреЗрддрд╛ рдореЗрдВ рд╕рдм рдХреБрдЫ рдирд╣реАрдВ рдЫреЛрдбрд╝рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ, рдФрд░ рдлрд┐рд░ рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдореЗрдВ рдмрд╣реБрдд рд╕рдордЭрджрд╛рд░реА рдирд╣реАрдВ рд╣реИред <br>  рдЗрд╕рд▓рд┐рдП, рдЕрднрд┐рдиреЗрддрд╛рдУрдВ рдХреА рдореЗрд░реА рд╕реВрдЪреА рдХреЛ рджреЗрдЦрддреЗ рд╣реБрдП, рдореБрдЭреЗ рдПрд╣рд╕рд╛рд╕ рд╣реБрдЖ рдХрд┐ рдкрд╣рд▓реЗ рдПрдХ рд╕рд╛рдБрдк рдЕрднрд┐рдиреЗрддрд╛ рдХрд╛ рдмрд▓рд┐рджрд╛рди рдХрд░рдирд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╣реИред  рдПрдХ рдЯрд╛рдЗрдорд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдореЗрдВ рдЙрдиреНрд╣реЗрдВ рд╕рдВрдЪрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЖрджреЗрд╢реЛрдВ рдХреЗ рдПрдХ рдмрдлрд░ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдХреЗрд╡рд▓ рдПрдХ рдмрд╛рд░ рдкреНрд░рддрд┐ рдмреАрдЯ рдореЗрдВ рдбрд╛рд▓реЗрдВ, рдФрд░ рд╕рд╛рдВрдк рдХреЛ рдПрдХ рдЕрд▓рдЧ рдЕрднрд┐рдиреЗрддрд╛ рдореЗрдВ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЙрджреНрджреЗрд╢реНрдп рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдпрд╣ рд╕рд┐рд░реНрдл рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдлреАрд▓реНрдб рдПрдХреНрдЯрд░ рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рд░рдЦрдиреЗ рд╕реЗ рдмрд┐рдирд╛ рджреЗрд░реА рдХреЗ <code>GrowUp</code> рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ред  рд╕рд╛рдВрдк рдХреЗ рд▓рд┐рдП <code>Tick</code> рд╕рдВрджреЗрд╢ рднреА рдмрд╣реБрдд рдорд╛рдпрдиреЗ рдирд╣реАрдВ рд░рдЦрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЬрдм рд╣рдореЗрдВ рдЯреАрдо рдЕрднрд┐рдиреЗрддрд╛ рд╕реЗ рд╕рдВрджреЗрд╢ рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдорддрд▓рдм рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╣реИ рдХрд┐ рдПрдХ рдирдпрд╛ рд╣рд░рд╛ рд╣реБрдЖ рд╣реИред  рд╡рд┐рд▓рдВрдм рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдмреАрдЯ рдХреЗ рдЦрд┐рдВрдЪрд╛рд╡ рдХреЛ рдЬреЛрдбрд╝рддреЗ рд╣реБрдП, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдмрджрд▓рд╛рд╡ рд╣реИрдВ: </p><br><ol><li>  рд╣рдо <code>Tick</code> рдФрд░ <code>GrowUp</code> рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд╣рдЯрд╛ рджреЗрдВред </li><li>  рд╣рдо рд╕рд╛рдБрдк рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рдХреНрд╖реЗрддреНрд░ рдХреЗ рдЕрднрд┐рдиреЗрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд░рдЦрддреЗ рд╣реИрдВ - рд╡рд╣ рдЕрдм рдЗрди рд░рд╛рдЬреНрдпреЛрдВ рдХреЗ "рдЯреЗрдкрд▓рд╛" рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдЧрд╛ред </li><li>  рд╣рдо рдЯрд╛рдЗрдорд░ рдЕрднрд┐рдиреЗрддрд╛ рд╕реЗ <code>System.Timers.Timer</code> рдХреЛ рд╣рдЯрд╛ рджреЗрддреЗ рд╣реИрдВред  рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рдХрд╛рд░реНрдп рдХреА рдпреЛрдЬрдирд╛ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рд╣реЛрдЧреА: <code>Start</code> рдХрдорд╛рдВрдб рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдпрд╣ <code>Flush</code> рдХрдорд╛рдВрдб рдЕрднрд┐рдиреЗрддрд╛ <code>Flush</code> рднреЗрдЬрддрд╛ рд╣реИред  рд╡рд╣ рдлрд╝реАрд▓реНрдб + рд╕реНрдиреЗрдХ рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рдЖрджреЗрд╢реЛрдВ рдХреА рдПрдХ рд╕реВрдЪреА рднреЗрдЬрддрд╛ рд╣реИ, рдЕрдВрддрд┐рдо рдЕрднрд┐рдиреЗрддрд╛ рдпрд╣ рд╕рдм рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЯрд╛рдЗрдорд░ рдХреЛ рдПрдХ <code>Next</code> рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрд╕рд╕реЗ рдПрдХ рдирдИ рдЯрд┐рдХ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЯрд╛рдЗрдорд░, <code>Next</code> рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдХреЗ <code>Next</code> <code>Thread.Sleep(delay)</code> рдЗрдВрддрдЬрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкреВрд░реЗ рд╕рд░реНрдХрд▓ рдХреЛ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред  рд╕рдм рдХреБрдЫ рд╕рд░рд▓ рд╣реИред </li></ol><br><p>  рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рджреЗрдирд╛ред </p><br><ul><li>  рдкрд┐рдЫрд▓реЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ, 500 рдПрдордПрд╕ рдиреНрдпреВрдирддрдо рд╕реНрд╡реАрдХрд╛рд░реНрдп рджреЗрд░реА рдереАред  рд╡рд░реНрддрдорд╛рди рджреЗрд░реА рдореЗрдВ, рдЖрдк рдЗрд╕реЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ - рддреИрдпрд╛рд░ рд╣реЛрдиреЗ рдкрд░ рдлрд╝реАрд▓реНрдб рдЕрднрд┐рдиреЗрддрд╛ рдХреЛ рдПрдХ рдирдП рдмреАрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред  рдкрд┐рдЫрд▓реЗ рдЙрдкрд╛рдпреЛрдВ рд╕реЗ рдХрдЪреНрдЪреЗ рд╕рдВрджреЗрд╢ рдПрдХрддреНрд░ рдХрд░рдирд╛ рдЕрдм рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИред </li><li>  рдореИрд╕реЗрдЬрд┐рдВрдЧ рдореИрдк рдмрд╣реБрдд рд╕рд░рд▓ рд╣реИ - рдПрдХ рдЬрдЯрд┐рд▓ рдЧреНрд░рд╛рдл рдХреЗ рдмрдЬрд╛рдп, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╕рдмрд╕реЗ рд╕рд░рд▓ рд▓реВрдк рд╣реИред </li><li>  рдЗрд╕ рд╕рд░рд▓реАрдХрд░рдг рдиреЗ рдмрдЧ рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрдм рдиреБрдХрд╕рд╛рди рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдЯрд╛рдЗрдорд░ рдХреЛ рдХрдИ рдмрд╛рд░ <code>Stop</code> рдорд┐рд▓рд╛ред </li><li>  рд╕рдВрджреЗрд╢реЛрдВ рдХреА рд╕реВрдЪреА рдХрдо рдХрд░ рджреА рдЧрдИ рд╣реИред  рдХрдо рдХреЛрдб - рдХрдо рдмреБрд░рд╛рдИ! </li></ul><br><p>  рдпрд╣ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="hljs haskell"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] commandAddress = <span class="hljs-string"><span class="hljs-string">"command"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] timerAddress = <span class="hljs-string"><span class="hljs-string">"timer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] gameAddress = <span class="hljs-string"><span class="hljs-string">"game"</span></span> // -     <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">CommandMessage</span></span>, <span class="hljs-type"><span class="hljs-type">Command</span></span> list&gt;(commandAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">TimerCommand</span></span>, <span class="hljs-type"><span class="hljs-type">TimerState</span></span>&gt;(timerAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) updateUi gameState cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent = timerAgent mailboxNetwork //    match gameState.gameFrame with //     | <span class="hljs-type"><span class="hljs-type">Frame</span></span> field -&gt; //       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameState = <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Next</span></span> //    updateUi gameState //     gameState // ! | <span class="hljs-type"><span class="hljs-type">End</span></span> (<span class="hljs-type"><span class="hljs-type">Win</span></span> _) -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd //        | _ -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Stop</span></span> //     gameState // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands //       | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> //     [] // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) (state: <span class="hljs-type"><span class="hljs-type">TimerState</span></span>) cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent = commandAgent mailboxNetwork match cmd with | <span class="hljs-type"><span class="hljs-type">Start</span></span> -&gt; commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; {state with active = true} | <span class="hljs-type"><span class="hljs-type">Next</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //    ,     <span class="hljs-type"><span class="hljs-type">Threading</span></span>.<span class="hljs-type"><span class="hljs-type">Thread</span></span>.<span class="hljs-type"><span class="hljs-type">Sleep</span></span>(state.delay) commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; state | <span class="hljs-type"><span class="hljs-type">Stop</span></span> -&gt; printfn <span class="hljs-string"><span class="hljs-string">"Stop received"</span></span>; { state with active = false } | <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //     <span class="hljs-comment"><span class="hljs-comment">--   commandAgent.Post Flush { state with active = not state.active } | SetDelay delay -&gt; Threading.Thread.Sleep(delay) if state.active then commandAgent.Post Flush {state with delay = delay}</span></span></code> </pre> <br><h4 id="ssylki">  рд╕рдВрджрд░реНрдн </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдореЗрд▓рдмреЙрдХреНрд╕ рдХрд╛ рдкрд░рд┐рдЪрдп</a> </li><li>  <a href="">рд╕рдмрд╕реЗ рдЙрддреНрд╕реБрдХ рдХреЗ рд▓рд┐рдП рдореЗрд▓рдмреЙрдХреНрд╕ рд╕реНрд░реЛрдд</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЕрднрд┐рдиреЗрддрд╛ рдореЙрдбрд▓ рдХреЗ рд▓рд┐рдП рд╕реНрд░реЛрдд рдХреЛрдб</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi424861/">https://habr.com/ru/post/hi424861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi424851/index.html">рдЖрдИрдЯреА рдХреЛ рдХрд╛рдо рдкрд░ рд░рдЦрдиреЗ рдореЗрдВ рдХреНрдпрд╛ рдЧрд▓рдд рд╣реИ?</a></li>
<li><a href="../hi424853/index.html">рдПрдХ рджреГрд╢реНрдп рдирд┐рдпрдВрддреНрд░рдХ рдХреА рдХрд╣рд╛рдиреА рдЬреЛ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рджрд┐рдЦрд╛рдирд╛ рдЪрд╛рд╣рддреА рдереА</a></li>
<li><a href="../hi424855/index.html">рдорд╢реАрди рд▓рд░реНрдирд┐рдВрдЧ: рдПрдХ рдХрдорд░реЗ рдХреЗ рд╣рд╛рдереА рдХреЗ рд╕рд╛рде рд╣рд╛рдерд╛рдкрд╛рдИ</a></li>
<li><a href="../hi424857/index.html">CloudFlare рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб SNI рд╕рдорд░реНрдерди</a></li>
<li><a href="../hi424859/index.html">1602 рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдХреЗ рд╕рд╛рде рд╕рдмрд╕реЗ рд╕рд░рд▓ Arduino рдЦреЗрд▓ - рднрд╛рдЧ # 1</a></li>
<li><a href="../hi424865/index.html">рдкреНрд░рд╛рдердорд┐рдХ рдбрд┐рдЬрд╛рдЗрди рдХрдг рдХреА рдЦреЛрдЬ рдХреА</a></li>
<li><a href="../hi424867/index.html">рдЦрд░реЛрдВрдЪ рд╕реЗ рд╣реЗрдХреНрд╕рд╛рдкреЙрдб рд╡рд┐рдХрд╛рд╕ (рднрд╛рдЧ 1) - рдбрд┐рдЬрд╛рдЗрди</a></li>
<li><a href="../hi424869/index.html">рдирдП iOS 12 рдлреАрдЪрд░ рдиреЗ рдореБрдЭреЗ рдХреИрд╕реЗ рдпрд╛рдж рджрд┐рд▓рд╛рдпрд╛ рдХрд┐ рдпрд╣ рдареАрдХ рд╣реЛрдиреЗ рдХрд╛ рд╕рдордп рд╣реИ</a></li>
<li><a href="../hi424871/index.html">рдПрд▓реЛрди рдорд╕реНрдХ рдФрд░ рдЯреЗрд╕реНрд▓рд╛ рдиреЗ рдЕрдореЗрд░рд┐рдХреА рдкреНрд░рддрд┐рднреВрддрд┐ рдФрд░ рд╡рд┐рдирд┐рдордп рдЖрдпреЛрдЧ рдХреЗ рд╕рд╛рде рдореБрдХрджрдореЗрдмрд╛рдЬреА рдХрд╛ рдирд┐рдкрдЯрд╛рд░рд╛ рдХрд┐рдпрд╛</a></li>
<li><a href="../hi424873/index.html">.NET рдореЗрдВ HttpClient рдХреЗ рдиреБрдХрд╕рд╛рди</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>