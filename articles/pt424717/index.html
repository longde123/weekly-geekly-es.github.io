<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôâ ‚ô•Ô∏è ü§∂üèª Fazendo backup de um grande n√∫mero de projetos da web heterog√™neos üßìüèº üì∞ üéª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parece que o t√≥pico est√° hackeado - muito foi dito e escrito sobre backup, portanto, n√£o h√° nada para reinventar a roda, apenas pegue e fa√ßa. No entan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fazendo backup de um grande n√∫mero de projetos da web heterog√™neos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/424717/"><p>  Parece que o t√≥pico est√° hackeado - muito foi dito e escrito sobre backup, portanto, n√£o h√° nada para reinventar a roda, apenas pegue e fa√ßa.  No entanto, toda vez que o administrador do sistema de um projeto da Web enfrenta a tarefa de configurar backups, para muitos ele fica no ar com um grande ponto de interroga√ß√£o.  Como coletar o backup de dados corretamente?  Onde armazenar backups?  Como fornecer o n√≠vel necess√°rio de armazenamento retrospectivo de c√≥pias?  Como unificar o processo de backup para todo o zool√≥gico de v√°rios softwares? </p><br><p><img src="https://habrastorage.org/webt/xk/rn/7r/xkrn7rrnask1pgpv4uvrby6tnrc.jpeg"></p><a name="habracut"></a><br><p>  Por n√≥s mesmos, resolvemos esse problema pela primeira vez em 2011. Em seguida, nos sentamos e escrevemos nossos scripts de backup.  Ao longo dos anos, usamos apenas eles, e eles forneceram um processo confi√°vel para coletar e sincronizar backups de projetos da web de nossos clientes.  Os backups foram armazenados em nosso ou em algum outro armazenamento externo, com a possibilidade de ajuste para um projeto espec√≠fico. </p><br><p>  Devo dizer que esses scripts funcionaram ao m√°ximo.  Por√©m, quanto mais crescemos, mais t√≠nhamos projetos diversos com diferentes softwares e reposit√≥rios externos que nossos scripts n√£o suportavam.  Por exemplo, n√£o t√≠nhamos suporte para Redis e os backups quentes do MySQL e PostgreSQL que apareceram mais tarde.  O processo de backup n√£o foi monitorado, havia apenas alertas por email. </p><br><p>  Outro problema foi o processo de suporte.  Ao longo dos anos, nossos scripts compactos cresceram e se transformaram em um enorme monstro estranho.  E quando nos reunimos e lan√ßamos uma nova vers√£o, valeu a pena o esfor√ßo de lan√ßar a atualiza√ß√£o para a parte dos clientes que usavam a vers√£o anterior com algum tipo de personaliza√ß√£o. </p><br><p>  Como resultado, no in√≠cio deste ano, tomamos uma decis√£o forte: substituir nossos scripts de backup antigos por algo mais moderno.  Portanto, no in√≠cio, nos sentamos e escrevemos toda a lista de desejos para uma nova solu√ß√£o.  Aconteceu aproximadamente o seguinte: </p><br><ul><li>  Fa√ßa backup dos dados do software usado com mais freq√º√™ncia: <br><ul><li>  Arquivos (c√≥pia discreta e incremental) </li><li>  MySQL (backups frios / quentes) </li><li>  PostgreSQL (backups frios / quentes) </li><li>  Mongodb </li><li>  Redis </li></ul></li><li>  Armazene backups em reposit√≥rios populares: <br><ul><li>  Local </li><li>  FTP </li><li>  Ssh </li><li>  SMB </li><li>  Nfs </li><li>  Webdav </li><li>  S3 </li></ul></li><li>  Receba alertas em caso de problemas durante o processo de backup </li><li>  Possui um √∫nico arquivo de configura√ß√£o que permite gerenciar backups centralmente </li><li>  Adicione suporte para novo software conectando m√≥dulos externos </li><li>  Especifique op√ß√µes extras para coletar despejos </li><li>  Ter a capacidade de restaurar backups por meios regulares </li><li>  F√°cil configura√ß√£o inicial </li></ul><br><h1 id="analiziruem-imeyuschiesya-resheniya">  Analisamos as solu√ß√µes dispon√≠veis </h1><br><p>  Analisamos as solu√ß√µes de c√≥digo aberto que j√° existem: </p><br><ul><li>  Bacula e seus garfos, por exemplo, Bareos </li><li>  Amanda </li><li>  Borg </li><li>  Duplicidade </li><li>  Duplicidade </li><li>  Rsnapshot </li><li>  Rdiff-backup </li></ul><br><p>  Mas cada um deles tinha suas desvantagens.  Por exemplo, o Bacula est√° sobrecarregado com fun√ß√µes que n√£o precisamos, a configura√ß√£o inicial √© uma tarefa bastante trabalhosa devido √† grande quantidade de trabalho manual (por exemplo, para escrever / procurar scripts de backup de banco de dados) e, para recuperar c√≥pias, √© necess√°rio usar utilit√°rios especiais, etc. </p><br><p>  No final, chegamos a duas conclus√µes importantes: </p><br><ol><li> Nenhuma das solu√ß√µes existentes nos convinha totalmente; </li><li>  Parece que n√≥s mesmos tivemos experi√™ncia e insanidade suficientes para come√ßar a escrever nossa decis√£o. </li></ol><br><p>  Ent√£o n√≥s fizemos. </p><br><h1 id="rozhdenie-nxs-backup">  O nascimento do nxs-backup </h1><br><p>  O Python foi escolhido como a linguagem para implementa√ß√£o - √© f√°cil de escrever e manter, flex√≠vel e conveniente.  Decidiu-se descrever os arquivos de configura√ß√£o no formato yaml. </p><br><p>  Para a conveni√™ncia de oferecer suporte e adicionar backups de novo software, foi escolhida uma arquitetura modular onde o processo de coleta de backups de cada software espec√≠fico (por exemplo, MySQL) √© descrito em um m√≥dulo separado. </p><br><h2 id="podderzhka-faylov-bd-i-udalyonnyh-hranilisch">  Suporte para arquivos, bancos de dados e armazenamento remoto </h2><br><p>  Atualmente, os seguintes tipos de backups de arquivos, bancos de dados e reposit√≥rios remotos s√£o suportados: </p><br><p>  DB: </p><br><ul><li>  MySQL (backups a quente / frio) </li><li>  PostgreSQL (backups a quente / frio) </li><li>  Redis </li><li>  Mongodb </li></ul><br><p>  Arquivos: </p><br><ul><li>  C√≥pia discreta </li><li>  C√≥pia incremental </li></ul><br><p>  Reposit√≥rios remotos: </p><br><ul><li>  Local </li><li>  S3 </li><li>  SMB </li><li>  Nfs </li><li>  FTP </li><li>  Ssh </li><li>  Webdav </li></ul><br><h2 id="diskretnoe-rezervnoe-kopirovanie">  Backup discreto </h2><br><p>  Para tarefas diferentes, backups discretos ou incrementais s√£o adequados; portanto, eles implementaram os dois tipos.  Voc√™ pode especificar qual m√©todo usar no n√≠vel de arquivos e diret√≥rios individuais. </p><br><p>  Para c√≥pias discretas (arquivos e bancos de dados), voc√™ pode definir uma retrospectiva no formato de dias / semanas / meses. </p><br><h2 id="inkrementnoe-rezervnoe-kopirovanie">  Backup incremental </h2><br><p>  C√≥pias incrementais de arquivos s√£o feitas da seguinte maneira: <br><img src="https://habrastorage.org/webt/c7/wk/ss/c7wksse4j_mxjkgdffptngpglkw.jpeg"></p><br><p>  No in√≠cio do ano, um backup completo ser√° realizado.  Em seguida, no in√≠cio de cada m√™s - uma c√≥pia mensal incremental em rela√ß√£o √† anual.  Dentro da menstrua√ß√£o - decadal incremental em rela√ß√£o ao mensal.  Dentro de cada dia incremental de dez dias em rela√ß√£o ao per√≠odo de dez dias. </p><br><p>  Note-se que, embora haja alguns problemas ao trabalhar com diret√≥rios que cont√™m um grande n√∫mero de subdiret√≥rios (dezenas de milhares).  Nesses casos, a cole√ß√£o de c√≥pias √© significativamente mais lenta e pode levar mais de um dia.  Estamos tratando ativamente dessa lacuna. </p><br><h2 id="vosstanavlivaemsya-iz-inkrementnyh-bekapov">  N√≥s nos recuperamos de backups incrementais </h2><br><p>  N√£o h√° problemas com a recupera√ß√£o de backups discretos - basta fazer uma c√≥pia para a data necess√°ria e implant√°-la com o tar do console habitual.  C√≥pias incrementais s√£o um pouco mais complicadas.  Para recuperar, por exemplo, em 24 de julho de 2018, voc√™ deve fazer o seguinte: </p><br><ol><li>  Expanda um backup de um ano, mesmo que, no nosso caso, comece em 1 de janeiro de 2018 (na pr√°tica, pode ser qualquer data, dependendo de quando foi decidido implementar backups incrementais) </li><li>  Role nele um backup mensal para julho </li><li>  Enrole o backup da d√©cada de 21 de julho </li><li>  Acumule backup di√°rio para 24 de julho </li></ol><br><p>  Ao mesmo tempo, para completar 2 a 4 pontos, adicione a op√ß√£o -G ao comando tar, indicando assim que √© um backup incremental.  Obviamente, esse n√£o √© o processo mais r√°pido, mas quando voc√™ considera que n√£o √© t√£o necess√°rio recuperar-se de backups e que a rela√ß√£o custo-benef√≠cio √© importante, esse esquema acaba sendo bastante eficaz. </p><br><h2 id="isklyucheniya">  Exce√ß√µes </h2><br><p>  Freq√ºentemente, voc√™ precisa excluir arquivos ou diret√≥rios individuais dos backups, por exemplo, diret√≥rios com cache.  Isso pode ser feito especificando as regras de exce√ß√£o apropriadas: </p><br><div class="spoiler">  <b class="spoiler_title">exemplo de arquivo de configura√ß√£o</b> <div class="spoiler_text"><pre><code class="hljs ruby">- <span class="hljs-symbol"><span class="hljs-symbol">target:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/*/data</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ excludes: - exclude1/exclude</span></span>_file - exclude2 - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/exclude_3</span></span></code> </pre> </div></div><br><h2 id="rotaciya-bekapov">  Rota√ß√£o de backup </h2><br><p>  Em nossos scripts antigos, a rota√ß√£o foi implementada para que a c√≥pia antiga fosse exclu√≠da somente depois que a nova fosse montada com √™xito.  Isso levou a problemas em projetos nos quais o espa√ßo para backups, em princ√≠pio, foi alocado exatamente para uma c√≥pia - uma c√≥pia nova n√£o p√¥de ser coletada l√° devido √† falta de espa√ßo. </p><br><p>  Na nova implementa√ß√£o, decidimos mudar essa abordagem: primeiro exclua a antiga e depois colete uma nova c√≥pia.  E o processo de coleta de backups deve ser monitorado para descobrir quaisquer problemas. </p><br><p>  Para backups discretos, um arquivo morto √© considerado uma c√≥pia antiga que vai al√©m do esquema de armazenamento especificado no formato dias / semanas / meses.  No caso de backups incrementais, os backups s√£o armazenados por padr√£o por um ano, e as c√≥pias antigas s√£o exclu√≠das no in√≠cio de cada m√™s, enquanto os arquivos do mesmo m√™s do ano passado s√£o considerados backups antigos.  Por exemplo, antes de coletar um backup mensal em 1¬∫ de agosto de 2018, o sistema verificar√° se h√° backups para agosto de 2017 e, se houver, os excluir√°.  Isso permite o uso ideal do espa√ßo em disco. </p><br><h2 id="logirovanie">  Registo </h2><br><p>  Em qualquer processo, e especialmente nos backups, √© importante manter-se a par e descobrir se algo deu errado.  O sistema mant√©m um registro de seu trabalho e captura o resultado de cada etapa: in√≠cio / parada de fundos, in√≠cio / fim de uma tarefa espec√≠fica, resultado da coleta de uma c√≥pia em um diret√≥rio tempor√°rio, resultado da c√≥pia / movimenta√ß√£o de uma c√≥pia de um diret√≥rio tempor√°rio para um local permanente, o resultado da rota√ß√£o de backup etc. .. </p><br><p>  Os eventos s√£o divididos em 2 n√≠veis: </p><br><ul><li>  <em>Info</em> : n√≠vel de informa√ß√£o - o v√¥o √© normal, a pr√≥xima etapa foi conclu√≠da com √™xito, uma entrada de informa√ß√µes correspondente √© feita no log </li><li>  <em>Erro</em> : n√≠vel de erro - algo deu errado, o est√°gio seguinte falhou, um registro de erro correspondente √© feito no log </li></ul><br><h2 id="e-mail-notifikacii">  Notifica√ß√µes por email </h2><br><p>  No final da cole√ß√£o de backup, o sistema pode enviar notifica√ß√µes por email. </p><br><p>  2 listas de destinat√°rios s√£o suportadas: </p><br><ul><li>  <em>Administradores</em> s√£o aqueles que atendem ao servidor.  Eles recebem apenas notifica√ß√µes de erros; n√£o est√£o interessados ‚Äã‚Äãem notifica√ß√µes de opera√ß√µes bem-sucedidas </li><li>  <em>Usu√°rios corporativos</em> - no nosso caso, esses s√£o clientes que √†s vezes desejam receber notifica√ß√µes para garantir que tudo esteja bem com os backups.  Ou, inversamente, na verdade n√£o.  Eles podem optar por receber um log completo ou apenas um log com erros. </li></ul><br><h2 id="struktura-konfiguracionnyh-faylov">  Estrutura do arquivo de configura√ß√£o </h2><br><p>  A estrutura dos arquivos de configura√ß√£o √© a seguinte: </p><br><div class="spoiler">  <b class="spoiler_title">exemplo de estrutura</b> <div class="spoiler_text"><pre> <code class="bash hljs">/etc/nxs-backup ‚îú‚îÄ‚îÄ conf.d ‚îÇ ‚îú‚îÄ‚îÄ desc_files_local.conf ‚îÇ ‚îú‚îÄ‚îÄ external_clickhouse_local.conf ‚îÇ ‚îú‚îÄ‚îÄ inc_files_smb.conf ‚îÇ ‚îú‚îÄ‚îÄ mongodb_nfs.conf ‚îÇ ‚îú‚îÄ‚îÄ mysql_s3.conf ‚îÇ ‚îú‚îÄ‚îÄ mysql_xtradb_scp.conf ‚îÇ ‚îú‚îÄ‚îÄ postgresql_ftp.conf ‚îÇ ‚îú‚îÄ‚îÄ postgresql_hot_webdav.conf ‚îÇ ‚îî‚îÄ‚îÄ redis_local_ftp.conf ‚îî‚îÄ‚îÄ nxs-backup.conf</code> </pre> </div></div><br><p>  Aqui <em>/etc/nxs-backup/nxs-backup.conf</em> √© o principal arquivo de configura√ß√£o no qual as configura√ß√µes globais s√£o indicadas: </p><br><div class="spoiler">  <b class="spoiler_title">arquivo de configura√ß√£o</b> <div class="spoiler_text"><pre> <code class="hljs sql">main: server_name: SERVER_NAME admin_mail: project-tech@nixys.ru client_mail: - '' mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@domain.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file_name: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/nxs-backup.log jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> </div></div><br><p>  A matriz de tarefas (tarefas) cont√©m uma lista de tarefas (tarefas), que s√£o uma descri√ß√£o do que exatamente fazer backup, onde armazenar e em que quantidade.  Como regra, eles s√£o movidos para arquivos separados (um arquivo por trabalho), que s√£o conectados via include no arquivo de configura√ß√£o principal. </p><br><p>  Eles tamb√©m cuidaram de otimizar o processo de prepara√ß√£o desses arquivos o m√°ximo poss√≠vel e escreveram um gerador simples.  Portanto, o administrador n√£o precisa gastar tempo procurando o modelo de configura√ß√£o para algum servi√ßo, por exemplo, MySQL, mas simplesmente execute o comando: </p><br><pre> <code class="bash hljs">nxs-backup generate --storage <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scp --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> mysql --path /etc/nxs-backup/conf.d/mysql_local_scp.conf</code> </pre> <br><p>  A sa√≠da gera o arquivo <em>/etc/nxs-backup/conf.d/mysql_local_scp.conf</em> : </p><br><div class="spoiler">  <b class="spoiler_title">Conte√∫do do arquivo</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: PROJECT-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: <span class="hljs-string"><span class="hljs-string">''</span></span> db_port: <span class="hljs-string"><span class="hljs-string">''</span></span> socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: <span class="hljs-string"><span class="hljs-string">''</span></span> db_password: <span class="hljs-string"><span class="hljs-string">''</span></span> auth_file: <span class="hljs-string"><span class="hljs-string">''</span></span> target: - all excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: scp <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> host: <span class="hljs-string"><span class="hljs-string">''</span></span> port: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> path_to_key: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> </div></div><br><p>  No qual resta apenas substituir alguns valores necess√°rios. </p><br><p>  Vamos dar um exemplo.  Suponha que em nosso servidor no diret√≥rio / var / www haja dois sites da loja online 1C-Bitrix (bitrix-1.ru, bitrix-2.ru), cada um dos quais trabalhe com seu pr√≥prio banco de dados em diferentes inst√¢ncias do MySQL (porta 3306 para bitrix_1_db e porta 3307 para bitrix_2_db). </p><br><p>  A estrutura do arquivo de um projeto t√≠pico do Bitrix √© aproximadamente a seguinte: </p><br><pre> <code class="bash hljs">‚îú‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ bitrix ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ admin ‚îÇ ‚îú‚îÄ‚îÄ backup ‚îÇ ‚îú‚îÄ‚îÄ cache ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ managed_cache ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ stack_cache ‚îÇ ‚îî‚îÄ‚îÄ .. ‚îú‚îÄ‚îÄ upload ‚îî‚îÄ‚îÄ ...</code> </pre> <br><p>  Como regra, o diret√≥rio de <em>upload</em> pesa muito e cresce apenas com o tempo, portanto, o backup √© feito de forma incremental.  Todos os outros diret√≥rios s√£o discretos, com exce√ß√£o dos diret√≥rios com cache e backups coletados pelas ferramentas nativas do Bitrix.  Deixe o esquema de armazenamento de backup desses dois sites ser o mesmo, enquanto as c√≥pias dos arquivos devem ser armazenadas localmente e no armazenamento ftp remoto, e o banco de dados deve ser armazenado apenas no armazenamento smb remoto. </p><br><p>  Os arquivos de configura√ß√£o resultantes para essa configura√ß√£o ter√£o a seguinte apar√™ncia: </p><br><div class="spoiler">  <b class="spoiler_title">bitrix-desc-files.conf (arquivo de configura√ß√£o com descri√ß√£o da tarefa para backup discreto)</b> <div class="spoiler_text"><pre> <code class="hljs powershell"> - job: Bitrix<span class="hljs-literal"><span class="hljs-literal">-desc</span></span><span class="hljs-literal"><span class="hljs-literal">-files</span></span> type: desc_files tmp_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump_tmp sources: - target: - /var/www/*/ excludes: - bitrix/backup - bitrix/cache - bitrix/managed_cache - bitrix/stack_cache - upload gzip: yes storages: - storage: local enable: yes backup_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span> - storage: ftp enable: yes backup_dir: /nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/databases/mysql/dump host: ftp_host user: ftp_usr password: ftp_usr_pass store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-inc-files.conf (arquivo de configura√ß√£o com descri√ß√£o da tarefa para backup incremental)</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript"> - job: Bitrix-inc-files type: inc_files sources: - target: - <span class="hljs-regexp"><span class="hljs-regexp">/var/www/</span></span>*<span class="hljs-regexp"><span class="hljs-regexp">/upload/</span></span> gzip: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> storages: - storage: ftp enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /nxs-backup/files/inc host: ftp_host user: ftp_usr password: ftp_usr_pass - storage: local enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /var/nxs-backup/files/inc</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-mysql.conf (arquivo de configura√ß√£o com descri√ß√£o da tarefa para backups do MySQL)</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: Bitrix-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3306</span></span> db_user: bitrux_usr_1 db_password: password_1 target: - bitrix_1_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3307</span></span> db_user: bitrix_usr_2 db_password: password_2 target: - bitrix_2_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: smb <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump host: smb_host port: smb_port <span class="hljs-keyword"><span class="hljs-keyword">share</span></span>: smb_share_name <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: smb_usr <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: smb_usr_pass <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><h2 id="parametry-dlya-zapuska-sbora-bekapov">  Op√ß√µes para come√ßar a coletar backups </h2><br><p>  No exemplo anterior, preparamos arquivos de configura√ß√£o de tarefas para coletar backups de todos os elementos de uma s√≥ vez: arquivos (discretos e incrementais), dois bancos de dados e armazen√°-los em armazenamentos locais e externos (ftp, smb). </p><br><p>  Resta executar a coisa toda.  O lan√ßamento √© realizado pelo comando: </p><br><pre> <code class="bash hljs">nxs-backup start <span class="hljs-variable"><span class="hljs-variable">$JOB_NAME</span></span> -c <span class="hljs-variable"><span class="hljs-variable">$PATH_TO_MAIN_CONFIG</span></span></code> </pre> <br><p>  Existem v√°rios nomes de trabalhos reservados: </p><br><ul><li>  <strong>files</strong> - execu√ß√£o arbitr√°ria de todos os <em>trabalhos</em> com os tipos <em>desc_files</em> , <em>inc_files</em> (ou seja, em ess√™ncia, apenas o <em>backup dos</em> arquivos √© <em>feito</em> ) </li><li>  <strong>bancos de dados</strong> - executando aleatoriamente todos os trabalhos com os tipos <em>mysql</em> , <em>mysql_xtradb</em> , <em>postgresql</em> , <em>postgresql_hot</em> , <em>mongodb</em> , <em>redis</em> (ou seja, fa√ßa backup apenas do banco de dados) </li><li>  <strong>external</strong> - executando aleatoriamente todos os trabalhos com o tipo <em>externo</em> (executando apenas scripts personalizados adicionais, mais sobre isso abaixo) </li><li>  <strong>all</strong> - imita√ß√£o de executar o comando um por um com <em>arquivos de</em> trabalho, <em>bancos de dados</em> , <em>externos</em> (valor padr√£o) </li></ul><br><p>  Como precisamos obter backups de dados dos arquivos e do banco de dados ao mesmo tempo (ou com uma diferen√ßa m√≠nima) na sa√≠da, √© recomend√°vel executar o nxs-backup com o job <strong>all</strong> , o que garantir√° a execu√ß√£o consistente do job descrito (Bitrix-desc- arquivos, Bitrix-inc_files, Bitrix-mysql). </p><br><p>  Ou seja, um ponto importante - os backups n√£o ser√£o coletados em paralelo, mas sequencialmente, um ap√≥s o outro, com uma diferen√ßa de tempo m√≠nima.  Al√©m disso, na pr√≥xima partida, o pr√≥prio software verifica o processo em execu√ß√£o no sistema e, se for detectado, encerrar√° automaticamente seu trabalho com a marca correspondente no log.  Essa abordagem reduz significativamente a carga no sistema.  Menos - os backups de elementos individuais s√£o coletados n√£o de uma s√≥ vez, mas com alguma diferen√ßa de hor√°rio.  Mas enquanto nossa pr√°tica mostra que isso n√£o √© cr√≠tico. </p><br><h2 id="vneshnie-moduli">  M√≥dulos externos </h2><br><p>  Como mencionado acima, gra√ßas √† arquitetura modular, os recursos do sistema podem ser expandidos usando m√≥dulos de usu√°rio adicionais que interagem com o sistema por meio de uma interface especial.  O objetivo √© poder, no futuro, adicionar suporte para backups de novos softwares sem a necessidade de reescrever o nxs-backup. </p><br><div class="spoiler">  <b class="spoiler_title">exemplo de arquivo de configura√ß√£o</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: TEST-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">''</span></span> storages: ‚Ä¶.</code> </pre> </div></div><br><p>  Aten√ß√£o especial deve ser dada √† chave <strong>dump_cmd</strong> , em que o valor √© o comando completo para executar um script externo.  Al√©m disso, ap√≥s a conclus√£o deste comando, espera-se que: </p><br><ul><li>  Um arquivo pronto de dados de software ser√° coletado </li><li>  Os dados ser√£o enviados para stdout no formato json, no formato: <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"full_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"ABS_PATH_TO_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"basename"</span></span>: <span class="hljs-string"><span class="hljs-string">"BASENAME_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTERNSION_OF_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gzip"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>/<span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><ul><li>  Nesse caso, as chaves <em>basename</em> , <em>extension</em> , <em>gzip s√£o</em> necess√°rias exclusivamente para a forma√ß√£o do nome do backup final. </li></ul></li><li>  No caso de conclus√£o bem-sucedida do script, o c√≥digo de retorno deve ser 0 e qualquer outro em caso de problemas. </li></ul><br><p>  Por exemplo, suponha que tenhamos um script para criar o instant√¢neo etcd <em>/etc/nxs-backup-ext/etcd.py</em> : </p><br><div class="spoiler">  <b class="spoiler_title">c√≥digo de script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env python3 # -*- coding: utf-8 -*- import json import os import subprocess import sys import tarfile def archive(snapshot_path): abs_tmp_path = '%s.tar' %(snapshot_path) with tarfile.open(abs_tmp_path, 'w:') as tar: tar.add(snapshot_path) os.unlink(snapshot_path) return abs_tmp_path def exec_cmd(cmdline): data_dict = {} current_process = subprocess.Popen([cmdline], stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True, executable='/bin/bash') data = current_process.communicate() data_dict['stdout'] = data[0][0:-1].decode('utf-8') data_dict['stderr'] = data[1][0:-1].decode('utf-8') data_dict['code'] = current_process.returncode return data_dict def main(): snapshot_path = "/var/backups/snapshot.db" dump_cmd = "ETCDCTL_API=3 etcdctl --cacert=/etc/ssl/etcd/ssl/ca.pem --cert=/etc/ssl/etcd/ssl/member-node1.pem"+\ " --key=/etc/ssl/etcd/ssl/member-node1-key.pem --endpoints 'https://127.0.0.1:2379' snapshot save %s" %snapshot_path command = exec_cmd(dump_cmd) result_code = command['code'] if result_code: sys.stderr.write(command['stderr']) else: try: new_path = archive(snapshot_path) except tarfile.TarError as e: sys.exit(1) else: result_dict = { "full_path": new_path, "basename": "etcd", "extension": "tar", "gzip": False } print(json.dumps(result_dict)) sys.exit(result_code) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p>  A configura√ß√£o para executar este script √© a seguinte: </p><br><div class="spoiler">  <b class="spoiler_title">arquivo de configura√ß√£o</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: etcd-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">'/etc/nxs-backup-ext/etcd.py'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /var/nxs-backup/<span class="hljs-keyword"><span class="hljs-keyword">external</span></span>/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><p>  Nesse caso, o programa ao executar o trabalho <em>etcd-external</em> : </p><br><ul><li>  Execute o script <em>/etc/nxs-backup-ext/etcd.py</em> sem par√¢metros </li><li>  Ap√≥s a conclus√£o do script, ele verificar√° o c√≥digo de conclus√£o e a disponibilidade dos dados necess√°rios no stdout </li><li>  Se todas as verifica√ß√µes forem bem-sucedidas, o mesmo mecanismo ser√° usado nos m√≥dulos j√° incorporados, em que o valor da chave full_path √© usado como tmp_path.  Caso contr√°rio, ele concluir√° esta tarefa com a marca correspondente no log. </li></ul><br><h1 id="podderzhka-i-obnovlenie">  Suporte e atualiza√ß√£o </h1><br><p>  O processo de desenvolvimento e suporte do novo sistema de backup foi implementado com todos os c√¢nones do CI / CD.  Chega de atualiza√ß√µes e edi√ß√µes de script nos servidores de batalha.  Todas as altera√ß√µes passam pelo nosso reposit√≥rio central do git no Gitlab, onde o conjunto de novas vers√µes dos pacotes deb / rpm √© registrado no pipeline, que √© ent√£o carregado nos nossos reposit√≥rios deb / rpm.  E depois disso, atrav√©s do gerenciador de pacotes, eles s√£o entregues aos servidores do cliente final. </p><br><h1 id="kak-skachat-nxs-backup">  Como baixar nxs-backup? </h1><br><p>  Criamos o projeto de c√≥digo aberto nxs-backup.  Qualquer um pode fazer o download e us√°-lo para organizar o processo de backup em seus projetos, bem como modificar de acordo com suas necessidades, escrever m√≥dulos externos. </p><br><p>  O c√≥digo fonte do nxs-backup pode ser baixado do reposit√≥rio do Github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste link</a> .  H√° tamb√©m instru√ß√µes de instala√ß√£o e configura√ß√£o. </p><br><p>  Tamb√©m preparamos uma imagem do Docker e a publicamos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DockerHub</a> . </p><br><p>  Se voc√™ tiver d√∫vidas durante o processo de configura√ß√£o ou uso, escreva-nos.  Ajudaremos a entender e finalizar as instru√ß√µes. </p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  Em um futuro pr√≥ximo, implementaremos a seguinte funcionalidade: </p><br><ul><li>  Monitorando a integra√ß√£o </li><li>  Criptografia de backup </li><li>  Interface baseada na Web para gerenciar configura√ß√µes de backup </li><li>  Implementando backups usando nxs-backup </li><li>  E muito mais </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt424717/">https://habr.com/ru/post/pt424717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt424701/index.html">Hist√≥rias fict√≠cias de TI sobre impostores e por que essas pr√°ticas obscuras apareceram em entrevistas</a></li>
<li><a href="../pt424703/index.html">E novamente sobre despersonaliza√ß√£o</a></li>
<li><a href="../pt424709/index.html">Obras-primas da constru√ß√£o mundial da coluna: 225 W RMS por 28.000 rublos</a></li>
<li><a href="../pt424711/index.html">Do hidrogel ao intestino do porco: materiais incomuns em rob√≥tica</a></li>
<li><a href="../pt424713/index.html">Toda a verdade sobre o RTOS. Artigo 12. Servi√ßos para trabalhar com tarefas</a></li>
<li><a href="../pt424723/index.html">Semin√°rios on-line na sexta-feira da Skillbox: √∫teis para iniciantes e muito mais</a></li>
<li><a href="../pt424725/index.html">Sobre o Oracle JDK 11+ (licenciamento e distribui√ß√£o)</a></li>
<li><a href="../pt424729/index.html">Por que o compilador transformou meu loop condicional em um infinito?</a></li>
<li><a href="../pt424731/index.html">Hist√≥rico de suporte t√©cnico quente ou Por que o AutoCAD exclui objetos proxy?</a></li>
<li><a href="../pt424733/index.html">P√≠lula azul STM32F103 como PLC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>