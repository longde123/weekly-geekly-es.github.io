<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧜 📗 🥝 Uso de cargadores de arranque firmados para evitar la protección de arranque seguro UEFI 🌌 💏 👇🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Versión rusa de este artículo. 
 Introduccion  El firmware de las placas base de las computadoras modernas funciona de acuerdo con la especificación U...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uso de cargadores de arranque firmados para evitar la protección de arranque seguro UEFI</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446072/">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Versión rusa de este artículo.</a> <br><h2>  Introduccion </h2> El firmware de las placas base de las computadoras modernas funciona de acuerdo con la especificación <abbr title="Interfaz de firmware extensible unificada, reemplazo de BIOS">UEFI</abbr> , y desde 2013 son compatibles con la tecnología de autenticación de los programas descargados y los controladores de arranque seguro, que está diseñada para proteger la computadora de los <abbr title="El gestor de arranque malicioso que modifica el gestor de arranque real del sistema operativo, infecta los archivos del sistema antes de que arranque el sistema operativo.">kits</abbr> de <abbr title="El gestor de arranque malicioso que modifica el gestor de arranque real del sistema operativo, infecta los archivos del sistema antes de que arranque el sistema operativo.">arranque</abbr> .  Secure Boot bloquea la ejecución de código de programa no firmado o no confiable: archivos .efi de programas y cargadores de arranque de sistemas operativos, firmware de equipos adicionales (tarjetas de video OPROM, adaptadores de red). <br>  Secure Boot se puede deshabilitar en cualquier placa base de la tienda, pero un requisito físico para cambiar su configuración es una presencia física en la computadora.  Debe ingresar a la configuración de UEFI cuando se inicia la computadora, y solo entonces será posible desactivar la tecnología o cambiar su configuración. <br><br>  La mayoría de las placas base solo vienen con claves de Microsoft como confiables, por lo que los creadores del software de arranque se ven obligados a contactar a Microsoft para la firma de los gestores de arranque, someterse a un procedimiento de auditoría y justificar la necesidad de una firma global de su archivo si desean que la unidad o la unidad flash se ejecuten innecesariamente deshabilite el Arranque seguro o agregue manualmente su clave en cada computadora. <br>  Microsoft tiene que firmar gestores de arranque para desarrolladores de distribuciones de Linux, hipervisores, discos de arranque antivirus y programas de recuperación de computadoras. <br><br>  Quería hacer una unidad flash USB de arranque con varios programas de recuperación de computadora que arrancaran sin deshabilitar el Arranque seguro.  Veamos cómo se puede implementar esto. <a name="habracut"></a><br><br><h2>  Descargadores firmados del gestor de arranque </h2>  Entonces, para arrancar Linux con Secure Boot habilitado, necesita un gestor de arranque firmado.  Microsoft ha prohibido la firma de software con licencia bajo GPLv3 debido a la prohibición de la <abbr title="La práctica de crear sistemas de hardware y software para los cuales el software tiene una licencia copyleft, pero el hardware no permite ejecutar una versión modificada del software (por ejemplo, mediante firma digital). El nombre proviene de los decodificadores TiVo que utilizan esta práctica.">tivoización por las</abbr> reglas de la licencia, por lo que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GRUB no podrá firmar</a> . <br>  En respuesta, la Fundación Linux lanzó <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PreLoader</a> , y Matthew Garrett escribió <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">shim</a> : pequeños cargadores de arranque que verifican la firma o el hash del próximo archivo de descarga.  PreLoader y shim no usan certificados <abbr title="Almacén de certificados de confianza en la placa base">UEFI db</abbr> , pero contienen una base de datos de hashes permitidos (PreLoader) o certificados (shim) dentro de ellos mismos. <br>  Ambos programas, además de descargar automáticamente archivos confiables, le permiten descargar cualquier archivo previamente no confiable en el modo de arranque seguro, pero requieren la presencia física del usuario: al primer inicio, debe seleccionar el certificado agregado o el archivo hash en la interfaz gráfica, después de lo cual los datos se ingresan en una variable NVRAM especial una placa base que no está disponible para cambio desde un sistema operativo cargado.  Los archivos se vuelven confiables solo para estos precargadores, y no para el Arranque seguro en general, y de todos modos no puede ejecutarlos sin Precargador / shim. <br><br><img src="https://habrastorage.org/webt/8v/fh/ut/8vfhut0fieoez9092xlirmoxndk.png" alt="Acciones requeridas para ejecutar un programa no confiable a través de shim."><br>  <i>Acciones requeridas al iniciar un programa no confiable por primera vez a través de shim.</i> <br><br>  Todas las distribuciones populares de Linux actuales usan shim, debido a la compatibilidad con certificados, lo que facilita la actualización del siguiente gestor de arranque sin la necesidad de interacción del usuario.  Normalmente, shim se usa para ejecutar GRUB2, el gestor de arranque más popular en Linux. <br><br><h2>  GRUB2 </h2>  Para evitar que los atacantes hagan negocios en silencio con la ayuda de un gestor de arranque firmado de algún kit de distribución, Red Hat creó parches para GRUB2 que bloquean las funciones "peligrosas" cuando se activó el arranque seguro: insmod / rmmod, appleloader, linux (reemplazado por linuxefi), multiboot, xnu, memrw, iorw.  El módulo de cargador de cadena, que carga archivos arbitrarios .efi, se complementó con su propio cargador .efi (PE), sin usar los comandos UEFI LoadImage / StartImage, así como el código de validación de los archivos descargados a través de shim, de modo que la capacidad de descargar archivos sea confiable para shim pero no confiable en términos de UEFI.  Por qué hicieron exactamente eso no está claro;  UEFI le permite redefinir (enganchar) la función de verificar las imágenes descargadas, así es como funciona PreLoader, y Shim tiene <a href="">esa función</a> , pero está deshabilitada de forma predeterminada. <br><br>  De una forma u otra, el uso de un GRUB firmado de alguna distribución de Linux fallará.  Hay dos formas de crear una unidad flash USB de arranque universal que no requiera agregar las claves de cada archivo descargado a las de confianza: <br><br><ul><li>  Usando un GRUB modificado que descarga archivos EFI por sí mismo, sin verificar una firma digital y sin bloquear módulos; </li><li>  Usando su propio precargador (segundo) anulando las funciones de verificación de firma digital UEFI (EFI_SECURITY_ARCH_PROTOCOL.FileAuthenticationState, EFI_SECURITY2_ARCH_PROTOCOL.FileAuthentication) </li></ul><br>  La segunda opción es preferible: los programas descargados no confiables también podrán descargar programas no confiables (por ejemplo, puede descargar archivos a través de UEFI Shell), y en la primera versión, solo GRUB puede descargar todo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Modificamos PreLoader</a> , eliminando el código adicional y permitiendo el lanzamiento de cualquier archivo. <br><br>  Total, la arquitectura de la unidad flash es la siguiente: <br><pre><code class="plaintext hljs">______ ______ ______ ╱│ │ ╱│ │ ╱│ │ /_│ │ → /_│ │ → /_│ │ │ │ → │ │ → │ │ │ EFI │ → │ EFI │ → │ EFI │ │_______│ │_______│ │_______│ BOOTX64.efi grubx64.efi grubx64_real.efi (shim) (FileAuthentication (GRUB2) override) ↓↓↓ ↑ ↑ ______ ↑ ╱│ │ ║ /_│ │ ║ │ │ ═══════════╝ │ EFI │ │_______│ MokManager.efi (Key enrolling tool)</code> </pre> <br><br>  Entonces había <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><u>Super</u> UEFIinSecureBoot Disk</a> . <br><blockquote>  Super UEFIinSecureBoot Disk: una imagen de disco con el gestor de arranque GRUB2, diseñado para ejecutar convenientemente programas efi y sistemas operativos sin firmar en el modo UEFI Secure Boot. <br><br>  El disco se puede usar como base para crear una unidad USB con utilidades de recuperación de la computadora, para lanzar varias distribuciones en vivo de Linux y WinPE, arrancando desde la red, sin deshabilitar el Arranque seguro en la configuración de la placa base, lo que puede ser conveniente al dar servicio a las computadoras de otras personas o empresas computadoras portátiles, por ejemplo, con una contraseña establecida para cambiar la configuración de UEFI. <br><br>  La imagen consta de tres componentes: un precargador shim de Fedora (firmado con una clave de Microsoft preinstalada en la gran mayoría de las placas base y portátiles), un precargador modificado de Linux Foundation PreLoader (para deshabilitar la verificación de firma al cargar archivos .efi) y un cargador de arranque GRUB2 modificado. <br><br>  Durante el primer arranque de un disco en una computadora con Secure Boot, debe seleccionar un certificado a través del menú MokManager (se inicia automáticamente), después de lo cual el gestor de arranque funcionará como si Secure Boot estuviera apagado: GRUB carga cualquier archivo .efi o kernel de Linux sin firmar, programas EFI descargados puede ejecutar otros programas y controladores con una firma faltante o no confiable. <br><br>  Para demostrar la operatividad, la imagen contiene Super Grub Disk (secuencias de comandos para buscar y cargar los sistemas operativos instalados, incluso si su cargador de arranque está dañado), GRUB Live ISO Multiboot (secuencias de comandos para el conveniente arranque de Linux LiveCD directamente desde ISO, sin desempaquetado y procesamiento preliminares), Uno Archivo Linux (kernel e initrd en un archivo, para recuperación del sistema) y varias utilidades UEFI. <br><br>  El disco es compatible con UEFI sin arranque seguro, así como con computadoras más antiguas con BIOS. </blockquote><br><br><h2>  Descargadores firmados </h2>  Me preguntaba si era posible evitar de alguna manera la necesidad de agregar una clave a través de una cuña en el primer inicio.  ¿Quizás hay algunos descargadores firmados que le permiten hacer más de lo que esperaban los autores? <br>  Al final resultó que hay tales cargadores.  Uno de ellos se usa en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kaspersky Rescue Disk 18</a> , un disco de arranque con software antivirus.  GRUB desde el disco le permite cargar módulos (comando insmod), mientras que los módulos en GRUB le permiten cargar código ejecutable regular.  El precargador de disco es nativo. <br><br>  Por supuesto, solo porque GRUB del disco no carga código no confiable.  Es necesario modificar el módulo del cargador de cadena para que GRUB no use las funciones UEFI LoadImage / StartImage, sino que cargue de forma independiente el archivo .efi en la memoria, realice la reubicación, encuentre el punto de entrada y lo siga.  Afortunadamente, casi todo el código necesario está en el repositorio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GRUB con soporte de Red Hat Secure Boot</a> , el único problema: no hay código de análisis de encabezado <abbr title="Ejecutable portátil, el formato utilizado para archivos .exe y .efi.">PE</abbr> , el encabezado analiza y devuelve shim, en respuesta a una llamada de función a través de un protocolo especial.  Esto se puede solucionar fácilmente transfiriendo el código apropiado de shim o PreLoader a GRUB. <br><br>  Así que hubo un disco UEFIinSecureBoot <u>silencioso</u> .  La arquitectura de disco resultante es la siguiente: <br><pre> <code class="plaintext hljs"> ______ ______ ______ ╱│ │ ╱│ │ ╱│ │ /_│ │ /_│ │ → /_│ │ │ │ │ │ → │ │ │ EFI │ │ EFI │ → │ EFI │ │_______│ │_______│ │_______│ BOOTX64.efi grubx64.efi grubx64_real.efi (Kaspersky (FileAuthentication (GRUB2) Loader) override) ↓↓↓ ↑ ↑ ______ ↑ ╱│ │ ║ /_│ │ ║ │ │ ═══════════╝ │ EFI │ │_______│ fde_ld.efi + custom chain.mod (Kaspersky GRUB2)</code> </pre> <br><br><h2>  Conclusión </h2>  En este artículo, descubrimos que no hay suficientes cargadores de arranque confiables firmados con una clave de Microsoft que permita trabajar en modo de arranque seguro. <br>  Utilizando los archivos firmados de Kaspersky Rescue Disk, logramos una descarga "silenciosa" de cualquier archivo .efi no confiable con Secure Boot habilitado, sin la necesidad de agregar un certificado a UEFI db o shim MOK. <br>  Estos archivos se pueden usar tanto para buenas obras (para descargar desde unidades flash USB) como para malas (para instalar bootkits sin el conocimiento del propietario de la computadora). <br>  Supongo que el certificado de Kaspersky no durará mucho y se agregará a la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lista global de certificados UEFI revocados</a> , que se instalarán en computadoras que ejecutan Windows 10 a través de Windows Update, lo que interrumpirá la carga de Kaspersky Rescue Disk 18 y Silent UEFIinSecureBoot Disk.  Veamos qué tan pronto sucederá esto. <br><br>  Descargue Super UEFIinSecureBoot Disk: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/ValdikSS/Super-UEFIinSecureBoot-Disk</a> <br>  Descargue Silent UEFIinSecureBoot Disk en la red <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ZeroNet Git Center</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://127.0.0.1:43110/1KVD7PxZVke1iq4DKb4LNwuiHS4UzEAdAv/</a> <br><br><div class="spoiler">  <b class="spoiler_title">Sobre ZeroNet</b> <div class="spoiler_text">  ZeroNet es un sistema muy poderoso para crear sitios web y servicios dinámicos distribuidos descentralizados.  Al visitar un recurso, el usuario comienza a descargarlo y distribuirlo, como en BitTorrent.  Al mismo tiempo, es posible crear recursos completos: blogs con comentarios, foros, alojamiento de videos, sitios wiki, chats, correo electrónico, git. <br>  ZeroNet separa los conceptos de código y datos del sitio: los datos del usuario se almacenan en archivos .json, y cuando se sincronizan, se importan a la base de datos sqlite del sitio con un esquema estandarizado, que le permite hacer cosas impresionantes: búsqueda de texto local en todos los sitios abiertos en milisegundos, automático Análogo de RSS en tiempo real para todos los sitios a la vez. <br>  Sistema de autenticación y autorización estandarizado (similar a OAuth), soporte para trabajar detrás de NAT y a través de Tor. <br>  ZeroNet es muy rápido, fácil de usar, tiene una interfaz moderna y características pequeñas pero muy convenientes, como el cambio global de temas de día / noche en los sitios. <br><br>  Considero que ZeroNet es un sistema muy subestimado, y publico intencionalmente la versión Silenciosa solo en ZeroNet Git, para atraer a nuevos usuarios. </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/446072/">https://habr.com/ru/post/446072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446058/index.html">Cómo construir SDN - Ocho herramientas de código abierto</a></li>
<li><a href="../446060/index.html">Síntesis de sueños de alto peso molecular.</a></li>
<li><a href="../446062/index.html">Quo vadis. Prohibiciones para desarrolladores en Google Play</a></li>
<li><a href="../446064/index.html">Experto: la actualización de software no ayudará al matrimonio en el planeador de Boeing</a></li>
<li><a href="../446066/index.html">Desarrollamos la teoría de algoritmos como un proyecto de código abierto.</a></li>
<li><a href="../446074/index.html">Cómo dividimos el desarrollo en equipos (y nos olvidamos de los sprints sin fin y los stand-ups inútiles)</a></li>
<li><a href="../446076/index.html">QlikView. Formato condicional "Me gusta en Excel"</a></li>
<li><a href="../446078/index.html">"Sonido": debate sobre un podcast sobre tecnología de audio</a></li>
<li><a href="../446080/index.html">En los Estados Unidos, el tribunal recomendó prohibir la importación de ciertos modelos de iPhone debido a la violación de las patentes de Qualcomm Apple</a></li>
<li><a href="../446082/index.html">El cuento de los medios anillos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>