<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌍 🐪 👨‍👩‍👦 Antrian Tugas PostgreSQL 🔤 🧝🏿 🗣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antrian digunakan untuk mengatur pemrosesan alur tugas. Mereka dibutuhkan untuk akumulasi dan distribusi tugas di antara para pemain. Antrian juga dap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Antrian Tugas PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481556/"><p><img src="https://habrastorage.org/webt/rd/7-/dy/rd7-dyen1bqq_ekj5_halnmlndy.jpeg" alt="Antrian Gajah - pixabay.com"></p><br><p>  Antrian digunakan untuk mengatur pemrosesan alur tugas.  Mereka dibutuhkan untuk akumulasi dan distribusi tugas di antara para pemain.  Antrian juga dapat memberikan persyaratan tambahan untuk tugas pemrosesan: jaminan pengiriman, jaminan satu kali, penentuan prioritas, dll. </p><br><p>  Sebagai aturan, sistem antrian pesan siap pakai digunakan (MQ - antrian pesan), tetapi kadang-kadang Anda perlu mengatur antrian ad hoc atau yang khusus (misalnya, antrian prioritas dan keterlambatan memulai kembali tugas yang tidak diproses karena pengecualian).  Pembuatan antrian seperti itu akan dibahas di bawah ini. </p><br><h2 id="ogranicheniya-primenimosti">  Keterbatasan Penerapan </h2><br><p>  Solusi yang diusulkan dirancang untuk menangani aliran tugas serupa.  Mereka tidak cocok untuk mengatur pub / sub atau pesan antara sistem dan komponen yang digabungkan secara longgar. </p><br><p>  Antrian di atas basis data relasional bekerja dengan baik untuk beban kecil dan menengah (ratusan ribu tugas per hari, puluhan hingga ratusan pemain), tetapi untuk utas besar lebih baik menggunakan solusi khusus. </p><br><h2 id="sut-metoda-v-pyati-slovah">  Esensi metode dalam lima kata </h2><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span></code> </pre> <a name="habracut"></a><br><h1 id="bazovaya-ochered">  Garis dasar </h1><br><p>  Untuk mempermudah, selanjutnya hanya pengidentifikasi tugas unik yang akan disimpan dalam tabel.  Menambahkan semacam muatan seharusnya tidak sulit. </p><br><p>  Tabel untuk antrian paling sederhana berisi tugas itu sendiri dan statusnya: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 -  ); create index task__status__idx on task (status);</span></span></code> </pre> <br><p>  Menambahkan tugas: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> conflict (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span>;</code> </pre> <br><p>  Mendapatkan tugas berikut: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> <br><p>  Penyelesaian tugas: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h1 id="ochered-s-prioritetami">  Antrian Prioritas </h1><br><p>  Dalam kasus sederhana, <code>id</code> tugas adalah prioritasnya.  Hanya permintaan untuk tugas selanjutnya yang diubah - syarat kondisi pengurutan <code>order by id</code> dengan urutan tugas pemrosesan yang diperlukan ditambahkan.  Anda juga perlu membuat indeks gabungan berdasarkan <code>(status, id)</code> . </p><br><p>  Atau, untuk prioritas, kolom terpisah ditambahkan: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 -  ); create index task__status__priority__idx on task (status, priority);</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Menambahkan tugas:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> conflict (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mendapatkan tugas berikut:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><p>  Kolom yang disorot memungkinkan Anda mengubah prioritas tugas dengan cepat. </p><br><h1 id="ochered-s-povtorom-upavshih-zadach">  Antri dengan pengulangan tugas "jatuh" </h1><br><p>  Kesalahan atau pengecualian dapat terjadi selama pelaksanaan tugas.  Dalam kasus seperti itu, tugas harus antri lagi.  Kadang-kadang masih perlu menunda waktu pelaksanaannya yang berulang untuk beberapa waktu, misalnya, jika pengecualian disebabkan oleh tidak tersedianya sementara layanan pihak ketiga. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 - , 3 - , 4 -   (  ) attempt integer not null default 0, delayed_to timestamp null, error_text text null ); create index task__status__delayed_to__idx on task (status, delayed_to);</span></span></code> </pre> <br><p>  Seperti yang Anda lihat, daftar status telah diperluas dan kolom baru telah ditambahkan: </p><br><ul><li>  <code>attempt</code> - jumlah upaya;  diperlukan untuk membuat keputusan tentang perlunya mencoba lagi (membatasi jumlah upaya) dan memilih penundaan sebelum mencoba lagi (misalnya, setiap upaya berikutnya ditunda oleh <code>10 * attempt</code> menit <code>10 * attempt</code> ); </li><li>  <code>delayed_to</code> - waktu upaya berikutnya untuk menyelesaikan tugas; </li><li>  <code>error_text</code> - teks kesalahan. </li></ul><br><p>  Teks kesalahan diperlukan untuk dikelompokkan berdasarkan jenis kesalahan. </p><br><p>  Sebuah contoh  Sistem pemantauan melaporkan bahwa ribuan tugas dengan status "kesalahan" telah terakumulasi dalam antrian.  Kami memenuhi permintaan: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> error_text, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>;</code> </pre> <br><p>  Untuk detailnya, buka log para pelaku.  Perbaiki situasi yang menyebabkan kesalahan (jika mungkin).  Jika perlu, kami mempercepat mulai ulang tugas dengan mengatur status ke 0 atau dengan menggeser waktu upaya berikutnya. </p><br><div class="spoiler">  <b class="spoiler_title">Dapatkan tugas baru berikut:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mendapatkan tugas berikut yang tertunda karena kesalahan:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> delayed_to &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Berhasil menyelesaikan tugas:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Tugas gagal, akan ada pengulangan dalam (5 * jumlah upaya) menit:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, delayed_to = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> + make_interval(mins =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> * attempt), error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Tugas selesai dengan kesalahan fatal, tidak akan ada coba lagi:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><p>  Permintaan untuk tugas selanjutnya dibagi menjadi dua sehingga DBMS dapat membangun rencana kueri yang efektif untuk antrian prioritas.  Kondisi pemilihan dengan <code>or</code> bisa salah dengan <code>order by</code> sortir. </p><br><h1 id="sbor-metrik">  Koleksi metrik </h1><br><p>  Tambahkan atribut berikut: </p><br><ul><li>  waktu pembuatan tugas; </li><li>  waktu tugas berubah; </li><li>  memulai dan mengakhiri waktu tugas. </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 - , 3 - , 4 -   (  ) attempt integer not null default 0, begin_time timestamp null, end_time timestamp null, delayed_to timestamp null, error_text text null, created timestamp not null default localtimestamp, updated timestamp not null default localtimestamp ); create index task__status__delayed_to__idx on task (status, delayed_to); create index task__updated__idx on task (updated);</span></span></code> </pre> <br><p>  Kami mempertimbangkan kolom yang ditambahkan di semua kueri. </p><br><div class="spoiler">  <b class="spoiler_title">Dapatkan tugas baru berikut:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, begin_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, end_time = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mendapatkan tugas berikut yang tertunda karena kesalahan:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> delayed_to &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, attempt = attempt + <span class="hljs-number"><span class="hljs-number">1</span></span>, begin_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, end_time = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Berhasil menyelesaikan tugas:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Tugas gagal, akan ada pengulangan dalam (5 * jumlah upaya) menit:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> + make_interval(mins =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> * attempt), error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Tugas selesai dengan kesalahan fatal, tidak akan ada coba lagi:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = $<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><h3 id="primery-dlya-chego-eto-mozhet-byt-nuzhno">  Contoh mengapa ini mungkin diperlukan </h3><br><p>  Cari dan mulai kembali tugas yang menggantung: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, error_text = <span class="hljs-string"><span class="hljs-string">'hanged'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 hour'</span></span>;</code> </pre> <br><p>  Menghapus tugas lama: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'30 days'</span></span>;</code> </pre> <br><p>  Statistik untuk menyelesaikan tugas: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> date_trunc(<span class="hljs-string"><span class="hljs-string">'hour'</span></span>, end_time), <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*), <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(end_time - begin_time), <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(end_time - begin_time) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> end_time &gt;= <span class="hljs-string"><span class="hljs-string">'2019-12-16'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h1 id="povtornyy-zapusk-ranee-vypolnennyh-zadach">  Mulai ulang tugas yang sudah diselesaikan sebelumnya </h1><br><p>  Misalnya, dokumen diperbarui, Anda perlu mengindeks ulang untuk pencarian teks lengkap. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, task_updated_at <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> localtimstamp, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- 0 - , 1 -  , 2 - , 3 - , 4 -   (  ) begin_time timestamp null, end_time timestamp null, delayed_to timestamp null, error_text text null, created timestamp not null default localtimestamp, updated timestamp not null default localtimestamp );</span></span></code> </pre> <br><p>  Di sini, kolom <code>task_updated_at</code> ditambahkan untuk waktu pembaruan tugas, tetapi bidang yang <code>created</code> dapat digunakan. </p><br><p>  Menambah atau memperbarui (memulai kembali) tugas: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, task_updated_at) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> conflict (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> task_updated_at = excluded.task_updated_at, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task_updated_at &lt; excluded.task_updated_at;</code> </pre> <br><p>  Apa yang sedang terjadi di sini.  Suatu tugas menjadi "baru" jika tidak selesai sekarang. </p><br><p>  Permintaan untuk menyelesaikan tugas juga akan memeriksa apakah itu diubah selama eksekusi. </p><br><p>  Permintaan untuk tugas berikutnya sama seperti dalam antrian untuk mengumpulkan metrik. </p><br><p>  Berhasil menyelesaikan tugas: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> begin_time &gt;= <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, end_time = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span>, delayed_to = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, error_text = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  Penyelesaian tugas dengan kesalahan: tergantung pada tugas.  Anda dapat membuat penundaan tanpa syarat dalam memulai kembali, Anda dapat mengatur status ke "baru" saat memperbarui. </p><br><h1 id="pipeline">  Saluran pipa </h1><br><p>  Tugas melewati beberapa tahap.  Anda dapat membuat antrian terpisah untuk setiap tahap.  Atau Anda bisa menambahkan kolom yang sesuai ke tabel. </p><br><p>  Contoh berdasarkan antrian dasar agar tidak mengacaukan kode.  Semua modifikasi yang dijelaskan sebelumnya dapat diterapkan ke antrian ini tanpa masalah. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, stage <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> task__stage__status__idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> task (stage, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span>);</code> </pre> <br><p>  Mendapatkan tugas berikut pada tahap tertentu: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> stage = $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> <br><p>  Penyelesaian tugas dengan transisi ke tahap yang ditunjukkan: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> stage = $<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  Atau transisi ke tahap selanjutnya secara berurutan: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> stage = stage + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h1 id="zadachi-po-raspisaniyu">  Tugas Terjadwal </h1><br><p>  Ini adalah variasi dari antrian ulang. </p><br><p>  Setiap tugas dapat memiliki jadwal sendiri (dalam versi paling sederhana, frekuensi peluncuran). </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> task ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">period</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-comment"><span class="hljs-comment">--     status integer not null default 0, -- 0 - , 1 -   next_run_time timestamp not null default localtimestamp ); create index task__status__next_run_time__idx on task (status, next_run_time);</span></span></code> </pre> <br><p>  Menambahkan tugas: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> task (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">period</span></span>, next_run_time) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>, $<span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre> <br><p>  Mendapatkan tugas berikut: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> next_run_time &lt;= <span class="hljs-keyword"><span class="hljs-keyword">localtimestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> next_task <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> task.id = next_task.id <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> task.id;</code> </pre> <br><p>  Menyelesaikan tugas dan merencanakan proses selanjutnya: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, next_run_time = next_run_time + make_interval(secs =&gt; <span class="hljs-keyword"><span class="hljs-keyword">period</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = $<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><h1 id="vmesto-zaklyucheniya">  Alih-alih sebuah kesimpulan </h1><br><p>  Tidak ada yang rumit dalam membuat antrian tugas khusus menggunakan alat RDBMS. </p><br><p>  Antrian "buatan sendiri" akan merespons <del>  bahkan yang paling liar </del>  hampir semua persyaratan bisnis / domain. </p><br><p>  Yah, kita tidak boleh lupa bahwa, seperti basis data lainnya, antrian memerlukan penyetelan server, kueri, dan indeks secara bijaksana. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id481556/">https://habr.com/ru/post/id481556/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id481546/index.html">Sejarah mikroprosesor dan komputer pribadi: 1947-1974</a></li>
<li><a href="../id481548/index.html">Symbol.iterator dalam Javascript</a></li>
<li><a href="../id481550/index.html">Inmarsat: menerima dan mendekode sinyal satelit di rumah</a></li>
<li><a href="../id481552/index.html">PGConf.Russia 2020 Segera Hadir</a></li>
<li><a href="../id481554/index.html">Bagaimana cara saya menempuh Master Online Sains dalam Ilmu Komputer, dan kepada siapa ini mungkin tidak cocok</a></li>
<li><a href="../id481560/index.html">Intisari bahan-bahan segar dari dunia front-end untuk minggu terakhir No. 394 (15 - 22 Desember 2019)</a></li>
<li><a href="../id481562/index.html">Tes panas Raspberry Pi 4</a></li>
<li><a href="../id481564/index.html">PHP Digest No. 170 (9-23 Desember 2019)</a></li>
<li><a href="../id481566/index.html">LED alamat berwarna-warni untuk tahun baru tanpa pemrograman dan solder</a></li>
<li><a href="../id481568/index.html">Acara digital di Moskow dari 23 hingga 29 Desember</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>