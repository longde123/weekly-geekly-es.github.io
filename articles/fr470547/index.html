<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♦️ 👇🏻 👶🏾 Celery taskcls: nouveau décorateur, nouvelles fonctionnalités 👍🏽 👷🏼 👙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vais vous raconter l'histoire de mon épuisement professionnel. 


 Il se trouve que je déteste les tapis roulants de routine. J'ai p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Celery taskcls: nouveau décorateur, nouvelles fonctionnalités</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470547/"><p>  Bonjour, Habr!  Je vais vous raconter l'histoire de mon épuisement professionnel. </p><br><p> Il se trouve que je déteste les tapis roulants de routine.  J'ai plusieurs projets utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Celery</a> .  Chaque fois qu'une tâche devient plus compliquée que <code>2 + 2 = 5</code> , le modèle de solution est réduit à créer une classe qui exécute la tâche et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une fonction de</a> démarrage avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">laquelle</a> Celery est capable de travailler - un passe-partout.  Dans cet article, je vais vous dire comment j'ai eu du mal avec un passe-partout et ce qui en est sorti. </p><br><p><img src="https://habrastorage.org/webt/b_/v-/mv/b_v-mvdmndd1go5p_fjosdlpe5c.png" alt="Le logo"></p><a name="habracut"></a><br><h1 id="otpravnaya-tochka">  Point de départ </h1><br><p>  Considérez la tâche ordinaire du céleri.  Il existe une classe qui exécute la tâche et une fonction de démarrage qui instancie la classe et démarre l'une de ses méthodes, dans laquelle toute la logique de la tâche est implémentée et la gestion des erreurs est héritée: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyTask</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">( FirstMixin, SecondMixin, ThirdMixin, )</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = self.do_something() response = self.remote_call(data) parsed = self.parser(response) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.process(parsed) @app.task(bind=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, arg1, arg2)</span></span></span><span class="hljs-function">:</span></span> instance = MyTask( celery_task=self, arg1=arg1, arg2=arg2, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance.full_task()</code> </pre> <br><p>  Dans le même temps, la méthode <code>full_task</code> comprend un appel à <code>main</code> , mais elle traite également la gestion des erreurs, la journalisation et d'autres absurdités qui ne sont pas directement liées à la tâche principale. </p><br><h1 id="ideya-taskklassa">  Idée de classe de tâches </h1><br><p>  À la racine de la classe de tâches se trouve une idée simple: dans la classe de base, vous pouvez définir une méthode de la classe de <code>task</code> , y implémenter le comportement de la fonction de démarrage, puis hériter: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTask</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> kwargs.items(): setattr(self, key, value) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">full_task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.main() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: self.celery_task.retry(countdown=<span class="hljs-number"><span class="hljs-number">30</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, task, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self = cls( celery_task=celery_task, **kwargs, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.full_task()</code> </pre> <br><p>  Tout l'ennui auxiliaire collecté dans la classe de base.  Nous ne lui reviendrons plus.  Nous réalisons la logique de la tâche: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.taskcls(bind=True) class MyTask( BaseTask, FirstMixin, SecondMixin, ThirdMixin, ): def main(self): data = self.do_something() response = self.remote_call(data) parsed = self.parser(response) return self.process(parsed)</span></span></code> </pre> <br><p>  Plus de balle, beaucoup mieux.  Mais qu'en est-il du point d'entrée? </p><br><pre> <code class="python hljs">MyTask.task.delay(...)</code> </pre> <br><p>  <code>MyTask.task</code> a toutes les méthodes de tâche habituelles: <code>delay</code> , <code>apply_async</code> et, d'une manière générale, c'est le cas. </p><br><p>  Maintenant, les arguments du décorateur.  Il est particulièrement amusant de faire glisser <code>bind = True</code> dans chaque tâche.  Est-il possible de passer des arguments par défaut via une classe de base? </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTask</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaTask</span></span></span><span class="hljs-class">:</span></span> bind = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> kwargs.items(): setattr(self, key, value) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">full_task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.main() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: self.celery_task.retry(countdown=<span class="hljs-number"><span class="hljs-number">30</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, task, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self = cls( celery_task=celery_task, **kwargs, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.full_task()</code> </pre> <br><p>  La classe <code>MetaTask</code> imbriquée contient des arguments par défaut et sera disponible pour toutes les classes enfants.  Fait intéressant, il peut également être hérité: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseHasTimeout</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseTask)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaTask</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseTask.MetaTask)</span></span></span><span class="hljs-class">:</span></span> timeout = <span class="hljs-number"><span class="hljs-number">42</span></span></code> </pre> <br><p>  Les arguments transmis au décorateur <code>@app.taskcls</code> ont la priorité la plus élevée: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.taskcls(timeout=20) class MyTask( BaseHasTimeout, FirstMixin, SecondMixin, ThirdMixin, ): def main(self): ...</span></span></code> </pre> <br><p>  Par conséquent, le délai d'expiration de la tâche sera de 20. </p><br><h1 id="vyhod-za-ramki">  Aller au-delà </h1><br><p>  Dans les applications Web, il est souvent nécessaire de démarrer une tâche à partir de la vue.  En cas d'adhérence élevée, la vue et la tâche peuvent être combinées: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseViewTask</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Somehow init View class manually self = cls(...) return self.celery() @app.taskcls class MyView( BaseViewTask, FirstMixin, SecondMixin, ThirdMixin, APIView, ): queryset = MyModel.objects.all() def get_some_data(self, *args, **kwargs): # common methed return self.queryset.filtert(...) def get(self, request): data = self.get_some_data(request.field) # used in request handling return Response(json.dumps(data)) def post(self, request): self.task.delay(...) return Response(status=201) def celery(self): data = self.get_some_data(...) # also used in background task return self.do_something(data)</span></span></code> </pre> <br><p>  Soit dit en passant, pour éviter la collision de noms, la classe imbriquée est appelée <code>MetaTask</code> , pas <code>Meta</code> , comme dans django. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Cette fonctionnalité est attendue dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Celery 4.5</a> .  Cependant, j'ai également préparé un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">package</a> qui vous permet d'essayer le décorateur de tâches aujourd'hui.  L'idée du package est que lorsque vous mettez à niveau Celery vers la version 4.5, vous pouvez supprimer son importation sans modifier une seule ligne de code. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470547/">https://habr.com/ru/post/fr470547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470531/index.html">Le neurophysiologue discute du projet Neuralink et parle du travail du cerveau «sur les doigts»</a></li>
<li><a href="../fr470535/index.html">Façons de créer des graphiques à barres à l'aide de Python</a></li>
<li><a href="../fr470537/index.html">Nouveau package de validation pour React sur Mobx @ quantumart / mobx-form-validation-kit</a></li>
<li><a href="../fr470541/index.html">Principes de base de l'utilisation de Neo4j dans un navigateur</a></li>
<li><a href="../fr470543/index.html">Comment nous avons mis la gestion des infrastructures sur Terraform - et commencé à vivre</a></li>
<li><a href="../fr470549/index.html">TSMC espère suivre la loi de Moore pour les décennies à venir</a></li>
<li><a href="../fr470553/index.html">Intégrale d'Euler-Poisson. Détails sur les méthodes de calcul</a></li>
<li><a href="../fr470555/index.html">Revue Joker 2019: Planet Parade, ou ce qui nous attend</a></li>
<li><a href="../fr470557/index.html">Contrôle de la lumière: un nouveau type d'éléments optiques à base de métamatériaux</a></li>
<li><a href="../fr470559/index.html">Comment supprimer les avis négatifs et repousser une attaque contre la réputation: expérience personnelle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>