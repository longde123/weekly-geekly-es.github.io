<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë° ‚è© üå•Ô∏è Contourner les verrous ILV avec DNSTap et BGP üôåüèæ üë±üèø üéñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le sujet est assez flou, je sais. Par exemple, il existe un excellent article , mais seule la partie IP de la liste de blocage y est prise en compte. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Contourner les verrous ILV avec DNSTap et BGP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467547/"><p><img src="https://habrastorage.org/webt/zg/if/qq/zgifqqqqol7bai9dlh3_e-3cgn8.png"></p><br><p>  Le sujet est assez flou, je sais.  Par exemple, il existe un excellent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> , mais seule la partie IP de la liste de blocage y est prise en compte.  Nous ajouterons √©galement des domaines. </p><br><p>  √âtant donn√© que les tribunaux et l'ILV bloquent tout √† droite et √† gauche, et les fournisseurs s'efforcent de ne pas tomber sous le coup des amendes inflig√©es par ¬´Revizorro¬ª - les pertes associ√©es aux √©cluses sont assez importantes.  Oui, et parmi les sites bloqu√©s "l√©galement" il y en a de nombreux utiles (bonjour, rutracker) </p><br><p> Je vis en dehors de la juridiction de l'ILV, mais mes parents, parents et amis sont rest√©s √† la maison.  Il a donc √©t√© d√©cid√© de trouver un moyen de contourner les verrous qui soit facile pour ceux qui sont loin de l'informatique, de pr√©f√©rence sans leur participation. </p><br><p>  Dans cet article, je ne d√©crirai pas les choses de base du r√©seau par √©tapes, mais d√©crirai les principes g√©n√©raux de la fa√ßon dont ce sch√©ma peut √™tre mis en ≈ìuvre.  La connaissance du fonctionnement du r√©seau en g√©n√©ral et de Linux en particulier est donc indispensable. </p><a name="habracut"></a><br><h1 id="tipy-blokirovok">  Types de serrures </h1><br><p>  Commen√ßons par actualiser ce qui est bloqu√©. </p><br><p>  Il existe plusieurs types de verrous dans le XML pagin√© d'ILV: </p><br><ul><li>  IP </li><li>  Domaine </li><li>  URL </li></ul><br><p>  Pour simplifier, nous les r√©duirons √† deux: IP et domaine, et nous retirerons simplement le domaine du blocage d'URL (plus pr√©cis√©ment, nous l'avons d√©j√† fait pour nous). </p><br><p>  De bonnes personnes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Roskomsvoboda ont</a> mis en ≈ìuvre une merveilleuse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API</a> gr√¢ce √† laquelle nous pouvons obtenir ce dont nous avons besoin: </p><br><ul><li>  IP: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://api.reserve-rbl.ru/api/v2/ips/json</a> </li><li>  Domaines: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://api.reserve-rbl.ru/api/v2/domains/json</a> </li></ul><br><h1 id="dostup-k-zablokirovannym-saytam">  Acc√©der aux sites bloqu√©s </h1><br><p>  Pour ce faire, nous avons besoin de petits VPS √©trangers, de pr√©f√©rence avec un trafic illimit√© - il y en a beaucoup de 3 √† 5 dollars.  Vous devez le prendre dans un proche √©tranger pour que le ping ne soit pas tr√®s grand, mais encore une fois, tenez compte du fait qu'Internet et la g√©ographie ne co√Øncident pas toujours.  Et comme il n'y a pas de SLA pour 5 dollars, il est pr√©f√©rable de prendre 2 pi√®ces ou plus aupr√®s de diff√©rents fournisseurs pour la tol√©rance aux pannes. </p><br><p>  Ensuite, nous devons configurer le tunnel chiffr√© du routeur client au VPS.  J'utilise Wireguard comme le plus rapide et le plus facile √† configurer depuis  J'ai √©galement des routeurs clients bas√©s sur Linux ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">APU2</a> ou quelque chose sur OpenWRT).  Dans le cas de certains Mikrotik / Cisco, vous pouvez utiliser des protocoles disponibles sur eux comme OpenVPN et GRE-over-IPSEC. </p><br><h1 id="identifikaciya-i-perenapravlenie-interesuyuschego-traffika">  Identification et r√©orientation du trafic d'int√©r√™t </h1><br><p>  Vous pouvez, bien entendu, terminer compl√®tement tout le trafic Internet via l'√©tranger.  Mais, tr√®s probablement, la vitesse de travail avec le contenu local en souffrira grandement.  De plus, les exigences de bande passante sur le VPS seront beaucoup plus √©lev√©es. </p><br><p>  Par cons√©quent, nous devrons en quelque sorte allouer le trafic aux sites bloqu√©s et l'envoyer de mani√®re s√©lective au tunnel.  M√™me si une partie du trafic ¬´suppl√©mentaire¬ª y arrive, c'est encore mieux que de tout conduire dans un tunnel. </p><br><p>  Pour g√©rer le trafic, nous utiliserons le protocole BGP et annoncerons les itin√©raires vers les r√©seaux n√©cessaires de notre VPS aux clients.  En tant que d√©mon BGP, prenons BIRD, comme l'un des plus fonctionnels et pratiques. </p><br><h3 id="ip">  IP </h3><br><p>  Avec le blocage IP, tout est clair: nous annon√ßons juste toutes les IP bloqu√©es avec VPS.  Le probl√®me est qu'il y a environ 600 000 sous-r√©seaux dans la liste fournie par l'API, et la grande majorit√© d'entre eux sont des h√¥tes / 32.  Un tel nombre de routes peut √™tre d√©routant pour les routeurs clients faibles. </p><br><p>  Par cons√©quent, il a √©t√© d√©cid√© de r√©sumer au r√©seau / 24 lors du traitement de la liste s'il y a 2 h√¥tes ou plus.  Ainsi, le nombre de routes a √©t√© r√©duit √† environ 100 000.  Le script pour cela sera le prochain. </p><br><h3 id="domeny">  Domaines </h3><br><p>  C'est plus compliqu√© et il y a plusieurs fa√ßons.  Par exemple, vous pouvez mettre Squid transparent sur chaque routeur client et effectuer l'interception HTTP et le peeping dans la n√©gociation TLS afin d'obtenir l'URL demand√©e dans le premier cas et le domaine de SNI dans le second. </p><br><p>  Mais en raison de tous les nouveaux TLS1.3 + eSNI, l'analyse HTTPS devient de moins en moins r√©elle chaque jour.  Et l'infrastructure c√¥t√© client devient plus compliqu√©e - vous devrez utiliser au moins OpenWRT. </p><br><p>  Par cons√©quent, j'ai d√©cid√© de prendre le chemin de l'interception des r√©ponses aux requ√™tes DNS.  Ici aussi, tout DNS sur TLS / HTTPS commence √† planer au-dessus de nos t√™tes, mais nous pouvons (pour l'instant) contr√¥ler cette partie sur le client - le d√©sactiver ou utiliser notre propre serveur pour DoT / DoH. </p><br><h4 id="kak-perehvatyvat-dns">  Comment intercepter DNS? </h4><br><p>  Il peut √©galement y avoir plusieurs approches. </p><br><ul><li>  Interception du trafic DNS via PCAP ou NFLOG <br>  Ces deux m√©thodes d'interception sont impl√©ment√©es dans l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sidmat</a> .  Mais il n'a pas √©t√© pris en charge depuis longtemps et la fonctionnalit√© est tr√®s primitive, vous devez donc y √©crire une liaison de toute fa√ßon. </li><li>  Analyse du journal du serveur DNS <br>  Malheureusement, les r√©curseurs que je connais ne savent pas comment enregistrer les r√©ponses, mais seulement les demandes.  En principe, cela est logique, car contrairement aux demandes, les r√©ponses ont une structure complexe et il est difficile de les √©crire sous forme de texte. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DNSTap</a> <br>  Heureusement, beaucoup d'entre eux prennent d√©j√† en charge DNSTap √† ces fins. </li></ul><br><h4 id="chto-takoe-dnstap">  Qu'est-ce que DNSTap? </h4><br><p><img src="https://habrastorage.org/webt/gc/4g/qs/gc4gqsppif5ypkbf06ok0oihll4.png"></p><br><p>  Il s'agit d'un protocole client-serveur bas√© sur des tampons de protocole et des flux de trames pour le transfert d'un serveur DNS vers un collecteur de requ√™tes et de r√©ponses DNS structur√©es.  En substance, le serveur DNS transmet des m√©tadonn√©es de demandes et de r√©ponses (type de message, IP client / serveur, etc.) ainsi que des messages DNS complets sous la forme (binaire) dans laquelle il travaille avec eux sur le r√©seau. </p><br><p>  Il est important de comprendre que dans le paradigme DNSTap, le serveur DNS agit en tant que client et le collecteur en tant que serveur.  Autrement dit, le serveur DNS se connecte au collecteur, et non l'inverse. </p><br><p>  Aujourd'hui, DNSTap est pris en charge par tous les serveurs DNS populaires.  Mais, par exemple, BIND dans de nombreuses distributions (comme Ubuntu LTS) est souvent construit pour une raison quelconque sans son support.  Donc, nous ne prendrons pas la peine de reconstruire, mais prenons un r√©cursif plus l√©ger et plus rapide - Non consolid√©. </p><br><h4 id="chem-lovit-dnstap">  Comment attraper DNSTap? </h4><br><p>  Il existe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">certain nombre d'</a> utilitaires CLI pour travailler avec un flux d'√©v√©nements DNSTap, mais ils ne fonctionnent pas bien pour notre t√¢che.  J'ai donc d√©cid√© d'inventer mon propre v√©lo qui fera tout ce qu'il faut: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>dnstap-bgp</strong></a> </p><br><p>  Algorithme de fonctionnement: </p><br><ul><li>  Une fois lanc√©, il charge une liste de domaines √† partir d'un fichier texte, les inverse (habr.com -&gt; com.habr), exclut les lignes bris√©es, les doublons et les sous-domaines (c'est-√†-dire si habr.com et www.habr.com sont dans la liste - il sera charg√© seulement le premier) et construit un arbre de pr√©fixes pour une recherche rapide sur cette liste </li><li>  Agissant comme un serveur DNSTap, il attend une connexion du serveur DNS.  En principe, il prend en charge les sockets UNIX et TCP, mais les serveurs DNS que je connais ne peuvent utiliser que les sockets UNIX </li><li>  Les paquets DNSTap entrants sont d'abord d√©s√©rialis√©s dans la structure Protobuf, puis le message DNS binaire lui-m√™me, situ√© dans l'un des champs Protobuf, est analys√© au niveau des enregistrements DNS RR </li><li>  V√©rifie si l'h√¥te demand√© (ou son domaine parent) est dans la liste charg√©e; sinon, la r√©ponse est ignor√©e </li><li>  Seuls A / AAAA / CNAME RR sont s√©lectionn√©s dans la r√©ponse et les adresses IPv4 / IPv6 correspondantes en sont extraites </li><li>  Les adresses IP sont mises en cache avec des TTL personnalis√©s et publi√©es aupr√®s de tous les homologues BGP configur√©s </li><li>  D√®s r√©ception d'une r√©ponse indiquant une IP d√©j√† mise en cache - son TTL est mis √† jour </li><li>  Apr√®s l'expiration de TTL, l'enregistrement est supprim√© du cache et des annonces BGP </li></ul><br><p>  Fonctionnalit√© suppl√©mentaire: </p><br><ul><li>  Relire la liste des domaines par SIGHUP </li><li>  Synchronisation du cache avec d'autres instances <strong>dnstap-bgp</strong> via HTTP / JSON </li><li>  Duplication du cache sur le disque (dans la base de donn√©es BoltDB) pour restaurer son contenu apr√®s un red√©marrage </li><li>  Prise en charge du basculement vers un autre espace de noms de r√©seau (pourquoi cela sera d√©crit ci-dessous) </li><li>  Prise en charge IPv6 </li></ul><br><p>  Limitations: </p><br><ul><li>  Domaines IDN non encore pris en charge </li><li>  Peu de param√®tres BGP </li></ul><br><p>  J'ai compil√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des</a> packages <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RPM et DEB</a> pour une installation facile.  Devrait fonctionner sur tous les OS relativement r√©cents avec systemd, comme  ils n'ont pas de d√©pendances. </p><br><h1 id="shema">  Sch√©ma </h1><br><p>  Commen√ßons donc √† assembler tous les composants ensemble.  En cons√©quence, nous devrions obtenir quelque chose comme cette topologie de r√©seau: <br><img src="https://habrastorage.org/webt/cm/ks/uo/cmksuol_njfgyjznmlf3oj6u94m.png"></p><br><p>  La logique du travail, je pense, ressort clairement du diagramme: </p><br><ul><li>  Le client a notre serveur configur√© comme DNS, et les requ√™tes DNS doivent √©galement passer par le VPN.  Cela est n√©cessaire pour que le fournisseur ne puisse pas utiliser l'interception DNS pour bloquer. </li><li>  Lorsque le site est ouvert, le client envoie une requ√™te DNS de la forme "Quelles sont les adresses IP de xxx.org?" </li><li>  <strong>Unbound</strong> r√©sout xxx.org (ou le prend du cache) et envoie une r√©ponse au client ¬´xxx.org a telle ou telle IP¬ª, la dupliquant en parall√®le via DNSTap </li><li>  <strong>dnstap-bgp</strong> annonce ces adresses dans <strong>BIRD</strong> par BGP si le domaine est dans la liste des bloqu√©s </li><li> <strong>BIRD</strong> annonce la route vers ces adresses IP avec le routeur <code>next-hop self</code> client du tron√ßon suivant </li><li>  Les paquets suivants du client vers ces IP passent par le tunnel </li></ul><br><p>  Sur le serveur, pour les routes vers les sites bloqu√©s, j'ai une table s√©par√©e √† l'int√©rieur de BIRD et elle ne croise pas avec le syst√®me d'exploitation. </p><br><p>  Il y a un inconv√©nient √† ce sch√©ma: le premier paquet SYN du client aura tr√®s probablement le temps de passer par le fournisseur national depuis  l'itin√©raire n'est pas annonc√© instantan√©ment.  Et ici, les options sont possibles en fonction de la fa√ßon dont le fournisseur effectue le verrouillage.  S'il laisse simplement tomber le trafic, il n'y a pas de probl√®me.  Et s'il le redirige vers un DPI, alors (th√©oriquement) des effets sp√©ciaux sont possibles. </p><br><p>  Des miracles sont √©galement possibles avec des clients qui n'observent pas DNS TTL, ce qui peut conduire le client √† utiliser des entr√©es obsol√®tes de leur cache pourri au lieu de demander Non li√©. </p><br><p>  En pratique, ni le premier ni le second ne m'ont pos√© de probl√®me, mais votre kilom√©trage peut varier. </p><br><h2 id="nastroyka-servera">  Configuration du serveur </h2><br><p>  Pour faciliter le roulement, j'ai √©crit un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√¥le pour Ansible</a> .  Il peut configurer √† la fois des serveurs et des clients Linux (con√ßus pour les distributions bas√©es sur deb).  Tous les param√®tres sont assez √©vidents et sont d√©finis dans l' <em>inventaire.yml</em> .  Ce r√¥le est supprim√© de mon grand livre de jeu, il peut donc contenir des erreurs - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les demandes de tirage sont les</a> bienvenues :) </p><br><p>  Passons en revue les principaux composants. </p><br><h3 id="bgp">  BGP </h3><br><p>  Lors du lancement de deux d√©mons BGP sur le m√™me h√¥te, un probl√®me fondamental se pose: BIRD ne souhaite pas augmenter l'homologation BGP avec un h√¥te local (ou avec une interface locale).  Du mot du tout.  Googler et lire des listes de diffusion n'a pas aid√©, ils pr√©tendent que c'est par conception.  Il y a peut-√™tre un moyen, mais je ne l'ai pas trouv√©. </p><br><p>  Vous pouvez essayer un autre d√©mon BGP, mais j'aime BIRD et il est utilis√© partout avec moi, je ne veux pas produire d'entit√©s. </p><br><p>  Par cons√©quent, j'ai cach√© dnstap-bgp √† l'int√©rieur de l'espace de noms du r√©seau, qui est connect√© √† la racine via l'interface veth: c'est comme un tuyau dont les extr√©mit√©s d√©passent dans diff√©rents espaces de noms.  √Ä chacune de ces extr√©mit√©s, nous suspendons des adresses IP p2p priv√©es qui ne sortent pas de l'h√¥te, elles peuvent donc √™tre n'importe lesquelles.  Il s'agit du m√™me m√©canisme que celui utilis√© pour acc√©der aux processus √† l'int√©rieur du Docker <em>bien</em> - <em>aim√©</em> et d'autres conteneurs. </p><br><p>  Pour cela, un <a href="">script a</a> √©t√© √©crit et dans dnstap-bgp la fonctionnalit√© d√©crite ci-dessus pour se glisser par les cheveux dans un autre espace de noms a √©t√© ajout√©e.  Pour cette raison, il doit √™tre ex√©cut√© en tant que root ou renvoy√© au binaire CAP_SYS_ADMIN via la commande setcap. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple de script pour cr√©er un espace de noms</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash NS="dtap" IP="/sbin/ip" IPNS="$IP netns exec $NS $IP" IF_R="veth-$NS-r" IF_NS="veth-$NS-ns" IP_R="192.168.149.1" IP_NS="192.168.149.2" /bin/systemctl stop dnstap-bgp || true $IP netns del $NS &gt; /dev/null 2&gt;&amp;1 $IP netns add $NS $IP link add $IF_R type veth peer name $IF_NS $IP link set $IF_NS netns $NS $IP addr add $IP_R remote $IP_NS dev $IF_R $IP link set $IF_R up $IPNS addr add $IP_NS remote $IP_R dev $IF_NS $IPNS link set $IF_NS up /bin/systemctl start dnstap-bgp</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">dnstap-bgp.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">namespace = "dtap" domains = "/var/cache/rkn_domains.txt" ttl = "168h" [dnstap] listen = "/tmp/dnstap.sock" perm = "0666" [bgp] as = 65000 routerid = "192.168.149.2" peers = [ "192.168.149.1", ]</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bird.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">router id 192.168.1.1; table rkn; # Clients protocol bgp bgp_client1 { table rkn; local as 65000; neighbor 192.168.1.2 as 65000; direct; bfd on; next hop self; graceful restart; graceful restart time 60; export all; import none; } # DNSTap-BGP protocol bgp bgp_dnstap { table rkn; local as 65000; neighbor 192.168.149.2 as 65000; direct; passive on; rr client; import all; export none; } # Static routes list protocol static static_rkn { table rkn; include "rkn_routes.list"; import all; export none; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">rkn_routes.list</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">route 3.226.79.85/32 via "ens3"; route 18.236.189.0/24 via "ens3"; route 3.224.21.0/24 via "ens3"; ...</code> </pre> </div></div><br><h3 id="dns">  DNS </h3><br><p>  Par d√©faut, dans Ubuntu, le binaire Unbound est bloqu√© par le profil AppArmor, ce qui l'emp√™che de se connecter √† n'importe quel socket DNSTap.  Vous pouvez soit supprimer ce profil, soit le d√©sactiver: </p><br><pre> <code class="plaintext hljs"># cd /etc/apparmor.d/disable &amp;&amp; ln -s ../usr.sbin.unbound . # apparmor_parser -R /etc/apparmor.d/usr.sbin.unbound</code> </pre> <br><p>  Cela devrait probablement √™tre ajout√© au playbook.  Il est id√©al, bien s√ªr, de corriger le profil et d'accorder les droits n√©cessaires, mais j'√©tais trop paresseux. </p><br><div class="spoiler">  <b class="spoiler_title">unbound.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">server: chroot: "" port: 53 interface: 0.0.0.0 root-hints: "/var/lib/unbound/named.root" auto-trust-anchor-file: "/var/lib/unbound/root.key" access-control: 192.168.0.0/16 allow remote-control: control-enable: yes control-use-cert: no dnstap: dnstap-enable: yes dnstap-socket-path: "/tmp/dnstap.sock" dnstap-send-identity: no dnstap-send-version: no dnstap-log-client-response-messages: yes</code> </pre> </div></div><br><h3 id="skachivanie-i-obrabotka-spiskov">  T√©l√©chargement et traitement des listes </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Script de t√©l√©chargement et de traitement d'une liste d'adresses IP</a> <br>  Il t√©l√©charge la liste, r√©sume avant le pr√©fixe <em>pfx</em> .  Dans <em>dont_add</em> et <em>dont_summarize,</em> vous pouvez dire √† IP et aux r√©seaux de sauter ou de ne pas r√©sumer.  J'en avais besoin parce que  mon sous-r√©seau VPS √©tait dans la liste de blocage :) </p><br><p>  Le plus dr√¥le, c'est que l'API RosKomSvoboda bloque les demandes avec l'agent utilisateur Python par d√©faut.  On dirait qu'un script kiddy l'a compris.  Par cons√©quent, nous le changeons en Firelis. </p><br><p>  Jusqu'√† pr√©sent, cela ne fonctionne qu'avec IPv4 car  IPv6 est petit, mais il sera facile √† corriger.  Sauf s'il est n√©cessaire d'utiliser √©galement bird6. </p><br><div class="spoiler">  <b class="spoiler_title">rkn.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import json, urllib.request, ipaddress as ipa url = 'https://api.reserve-rbl.ru/api/v2/ips/json' pfx = '24' dont_summarize = { # ipa.IPv4Network('1.1.1.0/24'), } dont_add = { # ipa.IPv4Address('1.1.1.1'), } req = urllib.request.Request( url, data=None, headers={ 'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36' } ) f = urllib.request.urlopen(req) ips = json.loads(f.read().decode('utf-8')) prefix32 = ipa.IPv4Address('255.255.255.255') r = {} for i in ips: ip = ipa.ip_network(i) if not isinstance(ip, ipa.IPv4Network): continue addr = ip.network_address if addr in dont_add: continue m = ip.netmask if m != prefix32: r[m] = [addr, 1] continue sn = ipa.IPv4Network(str(addr) + '/' + pfx, strict=False) if sn in dont_summarize: tgt = addr else: tgt = sn if not sn in r: r[tgt] = [addr, 1] else: r[tgt][1] += 1 o = [] for n, v in r.items(): if v[1] == 1: o.append(str(v[0]) + '/32') else: o.append(n) for k in o: print(k)</span></span></code> </pre> </div></div><br><p>  <a href="">Script √† mettre √† jour</a> <br>  √áa commence √† ma couronne une fois par jour, √ßa vaut peut-√™tre la peine de la tirer toutes les 4 heures, parce que  c'est, √† mon avis, la p√©riode de mise √† jour qu'ILV exige des fournisseurs.  De plus, il existe d'autres serrures suppl√©mentaires urgentes qui peuvent voler plus rapidement. </p><br><p>  Fait ce qui suit: </p><br><ul><li>  Ex√©cute le premier script et met √† jour la liste de routes ( <code>rkn_routes.list</code> ) pour BIRD </li><li>  Recharger BIRD </li><li>  Met √† jour et nettoie la liste des domaines pour dnstap-bgp </li><li>  Relocaliser dnstap-bgp </li></ul><br><div class="spoiler">  <b class="spoiler_title">rkn_update.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ROUTES="/etc/bird/rkn_routes.list" DOMAINS="/var/cache/rkn_domains.txt" # Get &amp; summarize routes /opt/rkn.py | sed 's/\(.*\)/route \1 via "ens3";/' &gt; $ROUTES.new if [ $? -ne 0 ]; then rm -f $ROUTES.new echo "Unable to download RKN routes" exit 1 fi if [ -e $ROUTES ]; then mv $ROUTES $ROUTES.old fi mv $ROUTES.new $ROUTES /bin/systemctl try-reload-or-restart bird # Get domains curl -s https://api.reserve-rbl.ru/api/v2/domains/json -o - | jq -r '.[]' | sed 's/^\*\.//' | sort | uniq &gt; $DOMAINS.new if [ $? -ne 0 ]; then rm -f $DOMAINS.new echo "Unable to download RKN domains" exit 1 fi if [ -e $DOMAINS ]; then mv $DOMAINS $DOMAINS.old fi mv $DOMAINS.new $DOMAINS /bin/systemctl try-reload-or-restart dnstap-bgp</span></span></code> </pre> </div></div><br><p>  Ils ont √©t√© √©crits sans trop r√©fl√©chir, donc si vous voyez ce qui peut √™tre am√©lior√©, allez-y. </p><br><h2 id="nastroyka-klienta">  Configuration du client </h2><br><p>  Ici, je vais donner des exemples de routeurs Linux, mais dans le cas de Mikrotik / Cisco, cela devrait √™tre encore plus simple. </p><br><p>  Tout d'abord, configurez BIRD: </p><br><div class="spoiler">  <b class="spoiler_title">bird.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">router id 192.168.1.2; table rkn; protocol device { scan time 10; }; # Servers protocol bgp bgp_server1 { table rkn; local as 65000; neighbor 192.168.1.1 as 65000; direct; bfd on; next hop self; graceful restart; graceful restart time 60; rr client; export none; import all; } protocol kernel { table rkn; kernel table 222; scan time 10; export all; import none; }</code> </pre> </div></div><br><p>  Ainsi, nous synchroniserons les routes re√ßues de BGP avec la table de routage du noyau num√©ro 222. </p><br><p>  Apr√®s cela, il suffit de demander au noyau de regarder cette plaque avant de regarder la valeur par d√©faut: </p><br><pre> <code class="plaintext hljs"># ip rule add from all pref 256 lookup 222 # ip rule 0: from all lookup local 256: from all lookup 222 32766: from all lookup main 32767: from all lookup default</code> </pre> <br><p>  Il ne reste plus qu'√† configurer DHCP sur le routeur pour distribuer l'adresse IP du tunnel du serveur en DNS et le sch√©ma est pr√™t. </p><br><h1 id="nedostatki">  Inconv√©nients </h1><br><p>  Avec l'algorithme actuel de cr√©ation et de traitement d'une liste de domaines, <code>youtube.com</code> et ses CDN y tombent. </p><br><p>  Et cela conduit au fait que toutes les vid√©os passeront par le VPN, ce qui peut obstruer la cha√Æne enti√®re.  Il vaut peut-√™tre la peine de compiler une liste des domaines d'exception populaires qui sont bloqu√©s dans l'ILV pour le moment.  Et sautez-les pendant l'analyse. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  La m√©thode d√©crite vous permet de contourner presque tous les verrous que les fournisseurs impl√©mentent actuellement. </p><br><p>  En principe, <em>dnstap-bgp</em> peut √™tre utilis√© √† toute autre fin n√©cessitant un certain niveau de contr√¥le du trafic bas√© sur un nom de domaine.  Gardez √† l'esprit que de nos jours, un millier de sites peuvent s'accrocher √† la m√™me adresse IP (pour certains Cloudflare, par exemple), donc cette m√©thode a une pr√©cision plut√¥t faible. </p><br><p>  Mais pour les besoins de contournement des verrous, cela suffit. </p><br><p>  Les ajouts, les modifications et les qu√™tes de tir sont les bienvenus! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467547/">https://habr.com/ru/post/fr467547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467531/index.html">Machine √† √©tats r√©actifs</a></li>
<li><a href="../fr467533/index.html">√âcouter du bruit informationnel: de la musique et des vid√©os que personne n'aurait d√ª trouver</a></li>
<li><a href="../fr467539/index.html">Forum CA / B vot√© contre le raccourcissement des certificats SSL √† 397 jours</a></li>
<li><a href="../fr467543/index.html">Ssh-chat, partie 2</a></li>
<li><a href="../fr467545/index.html">ShIoTiny: une horloge sans ressort ni temps r√©el et comment travailler avec</a></li>
<li><a href="../fr467549/index.html">SpaceX pr√©voit de d√©ployer un r√©seau Internet par satellite plus t√¥t que pr√©vu</a></li>
<li><a href="../fr467551/index.html">Frontend Weekly Digest (9-15 septembre 2019)</a></li>
<li><a href="../fr467555/index.html">Connaissez-vous bien CSS? (+ mini-test)</a></li>
<li><a href="../fr467557/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 380 (8-15 septembre 2019)</a></li>
<li><a href="../fr467559/index.html">√âv√©nements num√©riques √† Moscou du 16 au 22 septembre</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>