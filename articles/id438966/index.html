<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☁️ 🦓 👩🏿‍🤝‍👨🏽 Dokumentasi Haproxy mengembara sejarah, atau apa yang harus dicari saat mengonfigurasinya 📨 🚲 👼🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo lagi! 

 Terakhir kali, kami berbicara tentang memilih alat di Ostrovok.ru untuk memecahkan masalah proksi sejumlah besar permintaan ke layanan e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dokumentasi Haproxy mengembara sejarah, atau apa yang harus dicari saat mengonfigurasinya</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/438966/">  Halo lagi! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Terakhir kali,</a> kami berbicara tentang memilih alat di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ostrovok.ru</a> untuk memecahkan masalah proksi sejumlah besar permintaan ke layanan eksternal, tanpa menempatkan siapa pun pada saat yang bersamaan.  Artikel itu berakhir dengan pilihan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Haproxy</a> .  Hari ini saya akan membagikan nuansa yang harus saya hadapi ketika menggunakan solusi ini. <br><br><img src="https://habrastorage.org/webt/ns/mz/sb/nsmzsbtu2c1rgib_avecisgyrlk.jpeg"><br><a name="habracut"></a><br><h3>  Konfigurasi Haproxy </h3><br>  Kesulitan pertama adalah bahwa opsi <code>maxconn</code> berbeda tergantung pada konteksnya: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">maxconn (tuning kinerja);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">maxconn (opsi bind);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">maxconn (opsi server dan server default).</a> </li></ul><br>  Karena kebiasaan, saya hanya menyetel opsi pertama ( <code>performance tuning</code> ).  Inilah yang dikatakan dokumentasi tentang opsi ini: <br><blockquote>  Tetapkan jumlah maksimum per-proses koneksi konkuren ke &lt;nomor&gt;.  Ini <br>  setara dengan argumen baris perintah "-n".  Proxy akan berhenti menerima <br>  koneksi saat batas ini tercapai. <br></blockquote><br>  Tampaknya apa yang dibutuhkan.  Namun, ketika saya menemukan fakta bahwa koneksi baru ke proxy tidak langsung pergi, saya mulai membaca dokumentasi lebih hati-hati, dan di sana saya sudah menemukan parameter kedua ( <code>bind options</code> ): <br><blockquote>  Batasi soket untuk jumlah koneksi bersamaan ini.  Ekstra <br>  koneksi akan tetap berada dalam jaminan sistem sampai koneksi tercapai <br>  dilepaskan.  Jika tidak ditentukan, batasnya akan sama dengan maxconn frontend. <br></blockquote><br>  Jadi, <code>frontends maxconn</code> pergi, lalu cari <code>frontends maxconn</code> : <br><blockquote>  Perbaiki jumlah maksimum koneksi konkuren di frontend <br>  ... <br>  Secara default, nilai ini diatur ke 2000. <br></blockquote><br>  Bagus, apa yang kamu butuhkan.  Tambahkan ke konfigurasi: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 ... defaults mode http maxconn 524288</code> </pre><br>  Gag berikutnya adalah bahwa Haproxy adalah single-threaded.  Saya sangat terbiasa dengan model di Nginx, jadi nuansa ini selalu membuat saya depresi.  Tapi jangan putus asa - <i>Willy Tarreau</i> ( <i>pengembang Haproxy</i> ) mengerti apa yang dia lakukan, jadi dia menambahkan opsi - <code>nbproc</code> . <br><br>  Namun, langsung dalam dokumentasi tertulis: <br><blockquote>  MENGGUNAKAN PROSES GANDA <br>  LEBIH KERAS UNTUK MENGUNDANG DAN BENAR-BENAR TIDAK DIKUTIP. <br></blockquote>  Opsi ini benar-benar dapat menyebabkan sakit kepala jika Anda membutuhkan: <br><br><ul><li>  batasi jumlah permintaan / koneksi ke server (karena Anda tidak akan memiliki satu proses dengan satu penghitung, tetapi banyak proses, dan masing-masing memiliki penghitungnya sendiri); </li><li>  Kumpulkan statistik dari soket manajemen Haproxy </li><li>  mengaktifkan / menonaktifkan backend melalui soket kontrol; </li><li>  ... mungkin sesuatu yang lain.  ¯ \ _ (ツ) _ / ¯ </li></ul><br>  Namun demikian, para dewa memberi kami prosesor multi-core, jadi saya ingin menggunakannya secara maksimal.  Dalam kasus saya, ada empat core dalam dua core fisik.  Untuk Haproxy, saya memilih inti pertama, dan itu terlihat seperti ini: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">nbproc</span></span> 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3</code> </pre><br>  Menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">cpu-map,</a> kami mengikat proses Haproxy ke inti tertentu.  Penjadwal OS tidak perlu lagi memikirkan di mana harus merencanakan Haproxy, sehingga menjaga <code>content switch</code> tetap dingin, dan cache cpu tetap hangat. <br><br><h4>  Ada banyak buffer, tetapi tidak dalam kasus kami </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tune.bufsize</a> - dalam kasus kami itu tidak perlu untuk menjalankannya, tetapi jika Anda memiliki kesalahan dengan kode <code>400 (Bad Request)</code> , maka ini mungkin kasus Anda. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhjWg_BFxqRZv8FGJLpKFhY2IRVWcQ#tune.">tune.http.cookielen</a> - jika Anda mendistribusikan cookie besar kepada pengguna, maka, untuk menghindari kerusakan selama transmisi melalui jaringan, mungkin masuk akal untuk meningkatkan buffer ini juga. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhjWg_BFxqRZv8FGJLpKFhY2IRVWcQ#tune.">tune.http.maxhdr</a> adalah sumber lain yang mungkin dari 400 kode respons jika Anda memiliki terlalu banyak header. </li></ul><br><h4>  Sekarang pertimbangkan hal-hal tingkat yang lebih rendah </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tune.rcvbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tune.rcvbuf.server</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tune.sndbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tune.sndbuf.server</a> - dokumentasi mengatakan yang berikut: <br><blockquote>  Seharusnya tidak pernah diatur, dan ukuran default (0) memungkinkan kernel autotune nilai ini tergantung pada jumlah memori yang tersedia. <br></blockquote><br>  Tetapi bagi saya, yang jelas lebih baik daripada yang implisit, jadi saya memaksakan nilai-nilai opsi ini untuk memastikan hari esok. <br><br>  Dan parameter lain yang tidak terkait dengan buffer, tetapi cukup penting adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tune.maxaccept</a> . <br><blockquote>  Mengatur jumlah maksimum koneksi berturut-turut yang mungkin diterima oleh suatu proses dalam a <br>  baris sebelum beralih ke pekerjaan lain.  Dalam mode proses tunggal, angka yang lebih tinggi <br>  memberikan kinerja yang lebih baik pada tingkat koneksi yang tinggi.  Namun dalam multi-proses <br>  mode, menjaga sedikit keadilan antara proses umumnya lebih baik <br>  meningkatkan kinerja. <br></blockquote><br>  Dalam kasus kami, cukup banyak permintaan proxy yang dihasilkan, jadi saya menaikkan nilai ini untuk menerima lebih banyak permintaan sekaligus.  Namun demikian, seperti yang dikatakan dalam dokumentasi, layak untuk diuji bahwa dalam mode multi-thread, beban didistribusikan secara merata di antara proses. <br><br>  Semua parameter bersama-sama: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">tune</span></span>.bufsize 16384 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432</code> </pre><br><h4>  Yang tidak pernah terjadi adalah waktu habis.  Apa yang akan kita lakukan tanpa mereka? </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">timeout connect</a> - time untuk membuat koneksi dengan backend.  Jika koneksi dengan backend tidak terlalu baik, maka lebih baik untuk menonaktifkannya dengan batas waktu ini sampai jaringan kembali normal. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">timeout client</a> - timeout untuk pengiriman byte data pertama.  Ini membantu untuk memutuskan koneksi mereka yang membuat permintaan "dalam cadangan". </li></ul><br><div class="spoiler">  <b class="spoiler_title">Kulstory tentang klien HTTP di Go</b> <div class="spoiler_text">  Go memiliki klien HTTP reguler yang memiliki kemampuan menjaga kumpulan koneksi ke server.  Jadi satu cerita menarik terjadi, di mana batas waktu dan koneksi yang dijelaskan di atas dalam klien HTTP ikut serta.  Setelah pengembang mengeluh bahwa ia secara berkala memiliki 408 kesalahan dari proxy.  Kami melihat ke dalam kode klien dan melihat logika berikut di sana: <br><br><ul><li>  Kami mencoba untuk mengambil koneksi mapan gratis dari kolam; </li><li>  jika tidak berhasil, mulai instalasi koneksi baru di goroutine; </li><li>  periksa lagi kolam; </li><li>  jika ada gratis di kolam renang - kami ambil, dan masukkan yang baru ke kolam, jika tidak - gunakan yang baru. </li></ul><br>  Sudah mengerti apa garamnya? <br><br>  Jika klien telah membuat koneksi baru, tetapi belum menggunakannya, maka setelah lima detik server menutupnya, dan kasing berakhir.  Klien menangkap ini hanya ketika sudah mendapatkan koneksi dari kolam dan mencoba menggunakannya.  Patut diingat hal ini. <br></div></div><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">server batas waktu</a> - waktu maksimum untuk menunggu respons dari server. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">timeout client-fin</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">timeout server-fin</a> - di sini kami melindungi diri dari koneksi setengah tertutup agar tidak menumpuknya di tabel sistem operasi. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhjWg_BFxqRZv8FGJLpKFhY2IRVWcQ#timeout%20">timeout http-request</a> adalah salah satu timeout yang paling cocok.  Memungkinkan Anda memangkas klien yang lambat yang tidak dapat membuat permintaan HTTP dalam waktu yang ditentukan untuk mereka. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhjWg_BFxqRZv8FGJLpKFhY2IRVWcQ#timeout%20">timeout http-keep-hidup</a> - khususnya dalam kasus kami, jika koneksi <code>keep-alive</code> hang tanpa permintaan selama lebih dari 50 detik, maka kemungkinan besar ada sesuatu yang salah dan koneksi dapat ditutup, sehingga membebaskan memori untuk sesuatu yang baru cahaya. </li></ul><br>  Semua batas waktu bersama: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">defaults</span></span> mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s</code> </pre><br><h4>  Penebangan  Mengapa begitu sulit? </h4><br>  Seperti yang saya tulis sebelumnya, paling sering dalam keputusan saya, saya menggunakan Nginx, karena itu saya dimanjakan oleh sintaks dan kesederhanaan memodifikasi format log.  Saya terutama menyukai fitur pembunuh - format log dalam bentuk json, kemudian menguraikannya dengan pustaka standar apa pun. <br><br>  Apa yang kita miliki di Haproxy?  Ada peluang seperti itu, hanya Anda yang dapat menulis secara eksklusif di syslog, dan sintaks konfigurasi sedikit lebih terbungkus. <br>  Saya akan memberi Anda contoh konfigurasi dengan komentar: <br><br><pre> <code class="apache hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,     ,    (   # error.log  nginx) log 127.0.0.1:2514 len 8192 local1 notice emerg #    -  access.log log 127.0.0.1:2514 len 8192 local7 info</span></span></code> </pre><br>  Nyeri tertentu disebabkan oleh saat-saat seperti: <br><ul><li>  nama variabel pendek, dan terutama kombinasinya seperti% HU atau% fp </li><li>  format tidak dapat dibagi menjadi beberapa baris, jadi Anda harus menulis alas kaki dalam satu baris.  sulit untuk menambah / menghapus item baru / tidak perlu </li><li>  Agar beberapa variabel berfungsi, mereka harus secara eksplisit dinyatakan melalui tajuk permintaan tangkap </li></ul><br>  Alhasil, untuk mendapatkan sesuatu yang menarik, Anda harus menggunakan alas kaki seperti itu: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">log</span></span>-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}'</code> </pre><br><h4>  Sepertinya hal-hal kecil, tapi menyenangkan </h4><br>  Saya menggambarkan format log di atas, tetapi tidak begitu sederhana.  Untuk menyetor beberapa elemen di dalamnya, seperti: <br><br><ul><li>  http_host </li><li>  http_referer, </li><li>  http_user_agent, </li></ul><br>  pertama Anda perlu mengambil data ini dari permintaan ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">capture</a> ) dan memasukkannya ke dalam array nilai yang ditangkap. <br><br>  Berikut ini sebuah contoh: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128</code> </pre><br>  Akibatnya, kita sekarang dapat mengakses elemen yang kita butuhkan dengan cara ini: <br>  <code>%[capture.req.hdr(N)]</code> , di mana N adalah nomor urut dari definisi grup tangkap. <br>  Dalam contoh di atas, header Host akan berada di nomor 0, dan User-Agent akan berada di nomor 2. <br><br>  Haproxy memiliki kekhasan: ia menyelesaikan alamat DNS dari backend pada saat startup dan, jika tidak dapat menyelesaikan salah satu alamat, jatuh kematian si pemberani. <br><br>  Dalam kasus kami, ini sangat tidak nyaman, karena ada banyak backend, kami tidak mengelolanya, dan lebih baik mendapatkan 503 dari Haproxy daripada seluruh server proxy akan menolak untuk memulai karena satu penyedia.  Opsi berikut membantu kami dengan ini: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">init-addr</a> . <br><br>  Baris yang diambil langsung dari dokumentasi memungkinkan kami untuk menelusuri semua metode yang tersedia untuk menyelesaikan alamat dan, dalam kasus file, tunda saja masalah ini hingga nanti dan lanjutkan: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">default</span></span>-server init-addr last,libc,none</code> </pre> <br>  Dan akhirnya, favorit saya: seleksi backend. <br>  Sintaks untuk konfigurasi pemilihan backend Haproxy akrab bagi semua orang: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">use_backend</span></span> &lt;backend1_name&gt; if &lt;condition1&gt; use_backend &lt;backend2_name&gt; if &lt;condition2&gt; default-backend &lt;backend3&gt;</code> </pre><br>  Tapi, kata yang tepat, itu entah bagaimana tidak terlalu.  Saya telah menjelaskan semua backend dengan cara otomatis (lihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel sebelumnya</a> ), akan mungkin untuk menghasilkan <code>use_backend</code> sini <code>use_backend</code> , bisnis yang buruk tidak rumit, tetapi saya tidak mau.  Akibatnya, cara lain ditemukan: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 #   host_present      Host acl host_present hdr(host) -m len gt 0 #    ,     use_backend %[req.hdr(host),lower,field(1,'.')] if host_present #      ,    default_backend default backend default mode http server no_server 127.0.0.1:65535</code> </pre><br>  Dengan demikian, kami menstandarkan nama backend dan url yang dengannya Anda dapat melihatnya. <br><br>  Nah, sekarang kompilasi dari contoh di atas menjadi satu file: <br><br><div class="spoiler">  <b class="spoiler_title">Versi lengkap konfigurasi</b> <div class="spoiler_text"><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 nbproc 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3 tune.bufsize 16384 tune.comp.maxlevel 1 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432 stats socket /run/haproxy.sock mode 600 level admin log /dev/stdout local0 debug defaults mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s default-server init-addr last,libc,none log 127.0.0.1:2514 len 8192 local1 notice emerg log 127.0.0.1:2514 len 8192 local7 info log-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}' frontend http bind *:80 http-request del-header X-Forwarded-For http-request del-header X-Forwarded-Port http-request del-header X-Forwarded-Proto capture request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 acl host_present hdr(host) -m len gt 0 use_backend %[req.hdr(host),lower,field(1,'.')] if host_present default_backend default backend default mode http server no_server 127.0.0.1:65535 resolvers dns hold valid 1s timeout retry 100ms nameserver dns1 127.0.0.1:53</code> </pre><br></div></div><br>  Terima kasih kepada mereka yang membaca sampai akhir.  Namun, ini belum semuanya.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Lain kali,</a> kita akan melihat hal-hal tingkat rendah terkait dengan mengoptimalkan sistem itu sendiri, di mana Haproxy bekerja, sehingga ia dan sistem operasi kami merasa nyaman bersama, dan ada cukup zat besi untuk semua orang. <br><br>  Sampai ketemu lagi! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id438966/">https://habr.com/ru/post/id438966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id438956/index.html">Magnetitis pada gigi: pengurutan transkriptom dari jaringan shell moluska radula</a></li>
<li><a href="../id438958/index.html">ILV mengkonfirmasi keberadaan "stasiun luar angkasa" -nya</a></li>
<li><a href="../id438960/index.html">Bagaimana saya menyerah Ruby demi Python saat mengerjakan backend</a></li>
<li><a href="../id438962/index.html">Sebagian besar, pandangan positif untuk masa depan chip</a></li>
<li><a href="../id438964/index.html">Siapa yang benar-benar di belakang VPN gratis yang populer?</a></li>
<li><a href="../id438968/index.html">Menandai sepatu di Rusia: Pasar belum siap, tetapi harus bekerja</a></li>
<li><a href="../id438970/index.html">Haskell dikatakan sebagai bahasa bagi para genius dan akademisi. Benar?</a></li>
<li><a href="../id438972/index.html">Otak dari dalam (visualisasi bagian dari pola melalui model jaringan saraf tiruan)</a></li>
<li><a href="../id438974/index.html">Realitas Virtual Membantu Menangani Gangguan Mental</a></li>
<li><a href="../id438976/index.html">Buku "Spring. Semua pola desain »</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>