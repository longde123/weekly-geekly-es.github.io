<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèø üßúüèº üéÜ TCP vs UDP ou l'avenir des protocoles r√©seau üí™üèª üßìüèæ üè∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avant chaque service g√©n√©rant au moins 1 Mb / s de trafic Internet, la question se pose: ¬´Comment? sur TCP ou sur UDP? " Dans les domaines d'applicati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TCP vs UDP ou l'avenir des protocoles r√©seau</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/461829/">  Avant chaque service g√©n√©rant au moins 1 Mb / s de trafic Internet, la question se pose: ¬´Comment?  sur TCP ou sur UDP? "  Dans les domaines d'application, y compris les plateformes de livraison, les pr√©f√©rences et les traditions de prise de telles d√©cisions se sont d√©j√† d√©velopp√©es. <br><br>  En th√©orie, si, par exemple, une fois qu'un d√©veloppeur paresseux n'essayait pas de d√©ployer son ML en Python (parce qu'il le savait seulement), le monde n'aurait probablement jamais √©t√© rempli d'un tel amour pour le langage m√©prisable des ¬´encodeurs super-Java¬ª.  Et aujourd'hui, les faiblesses de ce langage dans le contexte pass√© d'application lui conf√®rent sans condition la primaut√© dans le d√©ploiement et le lancement de nombreux A / B miniers. <br><br>  Vous pouvez comparer beaucoup: ARM avec Intel, iOS et Android et Mortal Kombat avec Injustice.  Et courez dans un holivar spatial, revenons donc au sujet de la livraison d'√©normes volumes de contenu multiformat. <br><br>  Il y a dix ans, tout le monde √©tait absolument s√ªr que l'UDP √©tait une livraison non garantie.  Si vous avez besoin d'un protocole fiable, c'est TCP.  Et contrairement √† la tradition dans cet article, nous comparerons des choses apparemment incomparables comme TCP et UDP. <br><br><img src="https://habrastorage.org/webt/p5/tk/9z/p5tk9z_pumv5hmxly_ob3rvdikg.jpeg"><br>  <i>Attention, sous la coupe 99 illustrations et sch√©mas et tous importants.</i> <br><a name="habracut"></a><br>  La comparaison est effectu√©e par le responsable du d√©veloppement des plateformes Vid√©o et Cassette chez OK <b>Alexander Tobol</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">alatobol</a> ).  Les services de vid√©o et de flux d'actualit√©s sur le r√©seau social OK - exclusivement sur le contenu et sa diffusion sur toutes les plateformes clientes existantes dans des conditions r√©seau mauvaises ou excellentes, et la question de savoir comment le diffuser - via TCP ou UDP - est crucial. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/aXYJlizk3CQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  TCP contre UDP.  Th√©orie minimale </h2><br>  Pour arriver √† la comparaison, nous avons besoin d'une petite th√©orie de base. <br><br><img src="https://habrastorage.org/webt/fd/2q/ko/fd2qkoeptll1vmmm0ptkscrhu9i.jpeg"><br><br>  Que savons-nous des r√©seaux IP?  Le flux de donn√©es que vous envoyez est divis√© en paquets, une sorte de bo√Æte noire remet ces paquets au client.  Le client collecte des paquets et re√ßoit un flux de donn√©es.  Habituellement, tout cela est transparent et il n'est pas n√©cessaire de penser √† ce qui se trouve aux niveaux inf√©rieurs. <br><br><img src="https://habrastorage.org/webt/dj/6r/xm/dj6rxmcr3xayjlmfnblkxet-1le.jpeg"><br><br>  Le diagramme montre la pile TCP / IP et UDP / IP.  En bas, il y a des paquets Ethernet, des paquets IP et, au niveau du syst√®me d'exploitation, il y a TCP et UDP.  TCP et UDP dans cette pile ne sont pas tr√®s diff√©rents l'un de l'autre.  Ils sont encapsul√©s dans des paquets IP et les applications peuvent les utiliser.  Pour voir les diff√©rences, vous devez regarder √† l'int√©rieur des paquets TCP et UDP. <br><br><img src="https://habrastorage.org/webt/mz/pr/lt/mzprltftvytepznp_xufo63xb0g.jpeg"><br><br>  L√† et il y a des ports.  Mais <strong>dans UDP, il n'y a qu'une somme de contr√¥le</strong> - la longueur du paquet, ce protocole est aussi simple que possible.  Et dans TCP, il y a beaucoup de donn√©es qui indiquent clairement la fen√™tre, l'accus√© de r√©ception, la s√©quence, les paquets, etc.  De toute √©vidence, <strong>TCP est plus complexe</strong> . <br><br><blockquote>  En termes tr√®s approximatifs, TCP est un protocole de livraison fiable et UDP n'est pas fiable. </blockquote><br>  Et pourtant, malgr√© la pr√©tendue non-fiabilit√© de l'UDP, nous d√©terminerons s'il est possible de fournir des donn√©es plus rapidement et plus fiables qu'avec TCP.  Essayons de regarder le r√©seau de l'int√©rieur et de comprendre comment il fonctionne.  En cours de route, nous aborderons les questions suivantes: <br><br><ul><li>  pourquoi comparer TCP ou ce qui ne va pas avec lui; </li><li>  avec quoi et sur quoi comparer TCP; </li><li>  ce que Google a fait et quelle d√©cision il a prise; </li><li>  ce que l'avenir des protocoles r√©seau nous attend. </li></ul><br>  Cet article n'aura pas de th√©orie: les niveaux et mod√®les OSI, les mod√®les math√©matiques complexes, bien que tout puisse √™tre compt√© √† travers eux.  Nous analyserons au maximum comment toucher le r√©seau non pas en th√©orie, mais de nos propres mains. <br><br><h2>  Pourquoi comparer TCP ou ce qui ne va pas </h2><br>  TCP a √©t√© invent√© en 1974 et 20 ans plus tard, quand je suis all√© √† l'√©cole, j'ai achet√© des cartes Internet, effac√© le code et appel√© quelque part.  De plus, si vous appelez de 2 nuits √† 7 heures du matin, Internet √©tait gratuit, mais il √©tait difficile de passer. <br><br>  Vingt autres ann√©es se sont √©coul√©es et les utilisateurs des r√©seaux sans fil mobiles ont commenc√© √† pr√©valoir sur les utilisateurs ¬´c√¢bl√©s¬ª, tandis que TCP n'a pas chang√© conceptuellement. <br><br><blockquote>  Le monde mobile a gagn√©, les protocoles sans fil sont apparus et TCP est rest√© inchang√©. </blockquote><br>  Aujourd'hui, 80% des utilisateurs utilisent le Wi-Fi ou un r√©seau sans fil 3G-4G. <br><br><img src="https://habrastorage.org/webt/mw/a9/u4/mwa9u4ew7v6e1uevlbgrvf2jlrw.jpeg"><br><br>  Dans les r√©seaux sans fil, il y a: <br><br><ul><li>  perte de paquets - environ 0,6% des paquets que nous envoyons sont perdus en cours de route; </li><li>  r√©organisation - le r√©arrangement des paquets dans des lieux, dans la vie r√©elle est un ph√©nom√®ne assez rare, mais cela se produit dans 0,2% des cas; </li><li>  gigue - lorsque les paquets sont envoy√©s uniform√©ment et arrivent dans les files d'attente avec un retard d'environ 50 ms. </li></ul><br>  TCP vous cache avec succ√®s toutes ces fonctionnalit√©s de transfert de donn√©es dans des r√©seaux h√©t√©rog√®nes, et vous n'avez pas besoin de plonger √† l'int√©rieur. <br><br>  Ci-dessous sur la carte est le d√©bit de donn√©es TCP moyen en Russie.  Si vous supprimez la partie ouest, il est clair que la vitesse est mesur√©e plus en kilobits qu'en m√©gabits. <br><br><img src="https://habrastorage.org/webt/ck/a4/y5/cka4y5puk4gyorr-uaq2xcdtuom.jpeg"><br><br>  C'est, en moyenne, pour nos utilisateurs (hors partie ouest de la Russie): d√©bit 1,1 Mbps, perte de paquets de 0,6%, RTT (aller-retour) de l'ordre de 200 ms. <br><br><h3>  Comment calculer RTT </h3><br>  Quand j'ai vu la moyenne de 200 ms, j'ai pens√© qu'il y avait une erreur dans les statistiques, et j'ai d√©cid√© de mesurer le RTT √† nos serveurs dans le MSC d'une mani√®re alternative en utilisant RIPE Atlas.  Il s'agit d'un syst√®me de collecte de donn√©es sur l'√©tat d'Internet.  La sonde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RIPE Atlas</a> est disponible gratuitement. <br><br><img src="https://habrastorage.org/webt/za/rj/3g/zarj3gndghr0wnxs4yqt_odm68a.jpeg"><br><br>  L'essentiel est que vous le connectiez √† votre Internet domestique et que vous collectiez le ¬´karma¬ª.  Elle travaille pendant des jours, certaines personnes r√©pondent √† certaines de ses demandes.  Ensuite, vous pouvez d√©finir vous-m√™me diverses t√¢ches.  Un exemple d'une telle t√¢che: prendre accidentellement 30 points sur Internet et demander √† mesurer RTT, c'est-√†-dire ex√©cuter la commande ping sur le site Web Odnoklassniki. <br><br><img src="https://habrastorage.org/webt/kb/qa/5k/kbqa5k7sgl6wt5modhjfpa2fg00.jpeg"><br><br>  Curieusement, parmi les points al√©atoires, il y en a beaucoup qui ont un ping de 200 √† 300 ms. <br><br>  Dans l'ensemble, <strong>les r√©seaux sans fil sont populaires et instables</strong> (bien que ce dernier soit g√©n√©ralement ignor√©, car on pense que TCP peut g√©rer cela): <br><br><ul><li>  Plus de 80% des utilisateurs utilisent Internet sans fil; </li><li>  Les param√®tres des r√©seaux sans fil changent dynamiquement en fonction, par exemple, du fait que l'utilisateur a tourn√© le coin; </li><li>  Les r√©seaux sans fil ont des taux √©lev√©s de perte de paquets, de gigue, de r√©organisation; </li><li>  Canal asym√©trique fixe, changement d'adresse IP. </li></ul><br><h3>  La consommation de contenu d√©pend de la vitesse d'Internet </h3><br>  C'est tr√®s facile √† v√©rifier - il y a beaucoup de statistiques.  J'ai pris des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">statistiques</a> sur la vid√©o, qui disent que plus la vitesse d'Internet dans le pays est √©lev√©e, plus les utilisateurs regardent la vid√©o. <br><br><img src="https://habrastorage.org/webt/de/6q/_r/de6q_ruks-vpbgoo4yt5vokfkno.jpeg"><br><br>  Selon ces statistiques, la Russie dispose d'un Internet assez rapide, mais selon nos donn√©es internes, la vitesse moyenne est l√©g√®rement inf√©rieure. <br><br>  En faveur du fait que la vitesse d'Internet dans son ensemble est insuffisante, il indique que tous les cr√©ateurs de grandes applications, de r√©seaux sociaux, de services vid√©o, etc. optimisent leurs services pour travailler dans un mauvais r√©seau.  Apr√®s 10 Ko de donn√©es re√ßues, vous pouvez voir un minimum d'informations dans la bande, et √† une vitesse de 500 Ko, vous pouvez regarder la vid√©o. <br><br><h3>  Comment acc√©l√©rer le chargement </h3><br>  Dans le processus de d√©veloppement de la plate-forme vid√©o, nous avons r√©alis√© que TCP n'est pas tr√®s efficace dans les r√©seaux sans fil.  Comment en √™tes-vous arriv√© √† cette conclusion? <br><br>  Nous avons d√©cid√© d'acc√©l√©rer le t√©l√©chargement et avons fait le tour suivant. <br><br><img src="https://habrastorage.org/webt/n2/gg/xf/n2ggxfu9tzoskihc7itlm28j7ui.jpeg"><br><br>  Nous avons t√©l√©charg√© la vid√©o du client sur le serveur en plusieurs flux, c'est-√†-dire que 40 Mo sont divis√©s en 4 parties de 10 Mo et charg√©s en parall√®le.  Nous l'avons d√©marr√© sur Android et avons obtenu qu'il se charge en parall√®le plus rapidement que dans une connexion ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©mo</a> dans le rapport).  La chose la plus int√©ressante est que lorsque nous avons d√©ploy√© des t√©l√©chargements parall√®les en production, nous avons vu que dans certaines r√©gions, la vitesse de t√©l√©chargement a augment√© de 3 fois! <br><br><blockquote>  Quatre connexions TCP peuvent effectivement t√©l√©charger des donn√©es sur le serveur 3 fois plus rapidement. </blockquote><br>  Nous avons donc augment√© la vitesse de t√©l√©chargement de la vid√©o et conclu que le t√©l√©chargement devait √™tre parall√©lis√©. <br><br><h3>  TCP dans les r√©seaux instables </h3><br>  Un effet incroyable avec le parall√©lisme peut √™tre touch√©.  Il suffit de prendre un compteur de vitesse pour recevoir / envoyer des donn√©es (par exemple, Speed ‚Äã‚ÄãTest) et un modulateur de trafic (par exemple, conditionneur de liaison r√©seau, si vous avez un Mac) Nous limitons le r√©seau √† 1 Mbps pour les t√©l√©chargements et t√©l√©chargements et commen√ßons √† augmenter la perte de paquets. <br><br><img src="https://habrastorage.org/webt/lk/ki/j8/lkkij8appdgsvglvlp1rdt3em7s.jpeg"><br><br>  Le tableau montre le RTT et les pertes.  On peut voir que dans le cas d'une perte de 0%, le r√©seau est utilis√© √† 100%. <br><br>  √Ä la prochaine it√©ration, nous augmentons la perte de paquets de 5% et nous voyons que le r√©seau n'est utilis√© que par 74%.  Cela semble correct - avec une perte de paquets de 5%, 26% du r√©seau est perdu.  Mais si vous augmentez √©galement le ping, alors <strong>moins de la moiti√© du canal</strong> restera. <br><br><blockquote>  Si le canal pr√©sente un RTT √©lev√© et une perte de paquets importante, une connexion TCP n'utilise pas compl√®tement le r√©seau. </blockquote><br>  Une autre astuce montre que si vous commencez √† utiliser des connexions TCP parall√®les (vous pouvez simplement ex√©cuter plusieurs tests de vitesse en m√™me temps), vous pouvez voir la croissance inverse de l'utilisation des canaux. <br><br><img src="https://habrastorage.org/webt/co/n7/v_/con7v_t-dxmnrsxe6e0kkakbnwm.jpeg"><br><br>  Avec une augmentation du nombre de connexions TCP parall√®les, l'utilisation du r√©seau devient presque √©gale au d√©bit, moins le pourcentage de pertes. <br><br>  Ainsi, il s'est av√©r√©: <br><br><ul><li>  Les r√©seaux mobiles sans fil ont gagn√© et sont instables. </li><li>  TCP n'utilise pas pleinement le canal dans les r√©seaux instables. </li><li>  La consommation de contenu d√©pend de la vitesse d'Internet: plus la vitesse d'Internet est √©lev√©e, plus les utilisateurs regardent, et nous aimons vraiment nos utilisateurs et voulons qu'ils regardent plus. </li></ul><br>  De toute √©vidence, vous devez vous d√©placer quelque part et envisager des alternatives √† TCP. <br><br><h2>  TCP vs non TCP </h2><br>  Comment comparer le chaud?  Il y a deux options. <br><br>  La premi√®re option - au niveau IP, il y a TCP et UDP, nous pouvons nous permettre un autre protocole d'en haut.  √âvidemment, si vous d√©marrez votre propre protocole en parall√®le avec TCP et UDP, le pare-feu, Brandmauer, les routeurs et le reste du monde impliqu√©s dans la livraison de paquets ne le sauront pas.  Par cons√©quent, vous devrez attendre des ann√©es lorsque tout l'√©quipement est mis √† jour et commence √† travailler avec le nouveau protocole. <br><br>  La deuxi√®me option consiste √† cr√©er votre propre protocole de livraison de donn√©es fiable sur UDP non fiable.  √âvidemment, vous pouvez attendre longtemps avant que Linux, Android et iOS ajoutent un nouveau protocole √† votre noyau, vous devez donc couper le protocole dans l'espace utilisateur. <br><br>  Cette solution semble int√©ressante, nous l'appellerons le protocole UDP self-made.  Pour commencer √† le d√©velopper, vous n'avez besoin de rien de sp√©cial: ouvrez simplement le socket UDP et envoyez les donn√©es. <br><br><img src="https://habrastorage.org/webt/zy/zt/sn/zyztsnsutwgufcqwlhxb6qslhpg.jpeg"><br><br>  Nous allons le d√©velopper tout en √©tudiant le fonctionnement du r√©seau. <br><br><h2>  TCP vs UDP autodidacte </h2><br>  Eh bien, et sur quoi comparer? <br><br>  Les r√©seaux sont diff√©rents: <br><br><ul><li>  Avec la congestion, lorsqu'il y a beaucoup de paquets et que certains d'entre eux tombent en raison de la congestion des canaux ou des √©quipements. </li><li>  Haut d√©bit avec un aller-retour important (par exemple, lorsque le serveur est relativement √©loign√©). </li><li>  √âtrange - lorsque rien ne semble se produire sur le r√©seau, mais que les paquets disparaissent toujours simplement parce que le point d'acc√®s Wi-Fi est derri√®re le mur. </li></ul><br>  Vous pouvez toujours toucher vous-m√™me les profils r√©seau: s√©lectionnez l'un ou l'autre profil sur votre t√©l√©phone et ex√©cutez le test de vitesse. <br><br><img src="https://habrastorage.org/webt/v1/0j/-p/v10j-p8absukvs6s4jn2ntd8qau.jpeg"><br><br>  En plus des profils de r√©seau, vous devez √©galement d√©terminer le profil de consommation de trafic.  Voici ceux que nous avons utilis√©s: <br><br><img src="https://habrastorage.org/webt/3k/dc/fb/3kdcfbeyhjpduwbumk1n1iz2-c0.jpeg"><br><br>  √âtant donn√© que je suis responsable de la vid√©o et du flux, les profils sont appropri√©s: <br><br><ul><li>  Vid√©o de profil, lorsque vous vous connectez et diffusez tel ou tel contenu.  La vitesse de connexion augmente, comme dans le graphique sup√©rieur.  Conditions requises pour ce protocole: faible latence et adaptation du d√©bit binaire. </li><li>  Option d'affichage sur bande: chargement de donn√©es impulsionnelles, requ√™tes en arri√®re-plan, temps d'arr√™t  Conditions requises pour ce protocole: les donn√©es re√ßues sont multiplex√©es et hi√©rarchis√©es, la priorit√© du contenu utilisateur est sup√©rieure aux processus d'arri√®re-plan, il y a annulation du t√©l√©chargement. </li></ul><br>  Bien s√ªr, vous devez comparer les protocoles sur le HTTP le plus populaire. <br><br><h3>  HTTP 1.1 et HTTP 2.0 </h3><br>  La pile standard des ann√©es 2000 ressemblait √† HTTP 1.1 en plus de SSL.  La pile moderne est HTTP 2.0, TLS 1.3 et tout en haut de TCP. <br><br><img src="https://habrastorage.org/webt/k9/yp/ng/k9ypngmth9i_4m8pqzx5n-kipf0.jpeg"><br><br>  La principale diff√©rence est que HTTP 1.1 utilise un pool limit√© de connexions dans le navigateur √† un domaine, ils cr√©ent donc un domaine distinct pour les images, les donn√©es, etc.  HTTP 2.0 offre une connexion multiplex√©e dans laquelle toutes ces donn√©es sont transmises. <br><br><img src="https://habrastorage.org/webt/uo/aj/uu/uoajuubf2yfz_femlhzhvq6buty.jpeg"><br><br>  HTTP 1.1 fonctionne comme ceci: faire une demande, obtenir des donn√©es, faire une demande, obtenir des donn√©es. <br><br><img src="https://habrastorage.org/webt/1y/nv/xd/1ynvxdxpfkluduputf3szhfi75a.jpeg"><br><br>  Habituellement, un navigateur ou une application mobile est une puce, c'est-√†-dire une connexion pour recevoir des images, des donn√©es par API, et vous ex√©cutez simultan√©ment une demande d'image, d'API, de vid√©o, etc. <br><br><img src="https://habrastorage.org/webt/cn/ub/kl/cnubklsdxjrcuwpamcckap5_uu8.jpeg"><br><br>  Le principal probl√®me est la concurrence.  Vous n'avez aucun contr√¥le sur les demandes soumises.  Vous comprenez que l'utilisateur n'a plus besoin de l'image qu'il a feuillet√©e, mais qu'il ne peut rien faire. <br><br><blockquote>  Avec HTTP 1.1, vous obtenez toujours ce que vous avez demand√©, il est difficile d'annuler le t√©l√©chargement. </blockquote><br>  La seule prise socket possible est de fermer la connexion.  Ensuite, nous verrons pourquoi c'est mauvais. <br><br><h3>  Diff√©rences dans HTTP 2.0 </h3><br>  HTTP 2.0 r√©sout ces probl√®mes: <br><br><ul><li>  binaire, compression d'en-t√™te; </li><li>  multiplexage de donn√©es; </li><li>  priorisation; </li><li>  annuler le t√©l√©chargement; </li><li>  pouss√©e du serveur </li></ul><br>  Examinons des points plus importants pour nous. <br><br><img src="https://habrastorage.org/webt/tb/nl/ur/tbnlurtfdzcqaxpy6_hgcphtye0.jpeg"><br><br>  Demandez une image et une API.  L'image est imm√©diatement donn√©e, l'API pr√©par√©e apr√®s un certain temps.  L'API a √©t√© donn√©e - l'image a √©t√© donn√©e √† la fin.  Tout cela se passe de mani√®re transparente.  <strong>Le contenu hautement prioritaire est t√©l√©charg√© plus t√¥t.</strong> <br><br><img src="https://habrastorage.org/webt/gw/ws/wp/gwwswpducmtjv2huz9jprbhwpha.jpeg"><br><br>  <strong>La pouss√©e du serveur</strong> est une telle chose lorsque vous avez demand√© quelque chose de sp√©cifique comme une API, mais m√™me √† la charge sur les images clientes ont √©t√© mises en cache qui seraient certainement n√©cessaires pour afficher, par exemple, une bande. <br><br>  Il existe √©galement une commande de <strong>r√©initialisation du flux</strong> que le navigateur ex√©cute lui-m√™me si vous passez d'une page √† l'autre, etc.  Pour un client mobile, avec son aide, vous pouvez refuser de recevoir des donn√©es sans perdre la connexion. <br><br>  Ainsi, nous comparerons TCP sur diff√©rents: <br><br><ul><li>  Profils r√©seau: Wi-Fi, 3G, LTE. </li><li>  Profils de consommation: streaming (vid√©o), multiplexage et priorisation avec annulation du t√©l√©chargement (HTTP / 2) pour recevoir le contenu de la bande. </li></ul><br><h3>  Mod√®le sans perte </h3><br>  Commen√ßons la comparaison avec un r√©seau simple dans lequel il n'y a que deux param√®tres: le temps d'aller-retour et la bande passante. <br><br>  <b>RTT</b> est ping, le temps de rotation d'un paquet, la r√©ception de l'accus√© de r√©ception ou le temps d'√©cho de r√©ponse. <br><br>  Pour mesurer la <b>bande passante</b> - <b>bande passante</b> r√©seau - nous envoyons un paquet de paquets et comptons le nombre de paquets transmis √† un certain intervalle de temps. <br><br><img src="https://habrastorage.org/webt/6r/du/2l/6rdu2lwrhgztjekbwsfgvtuwdec.jpeg"><br><br>  Puisque nous travaillons avec des protocoles fiables, bien s√ªr, il y a un accus√© de r√©ception - nous envoyons des paquets et recevons une confirmation de r√©ception. <br><br><h3>  Le probl√®me de l'Internet lent </h3><br>  √Ä l'aube du d√©veloppement de notre service vid√©o en 2013, mon ami est all√© en Californie et a d√©cid√© de regarder une nouvelle s√©rie de sa s√©rie pr√©f√©r√©e sur Odnoklassniki.  Il avait un RTT de 250 ms, une parfaite Wi-Fi 400 Mbps sur le campus de Google, il voulait voir la nouvelle s√©rie en FullHD. <br><br>  Pensez-vous qu'il a pu regarder la vid√©o?  La r√©ponse d√©pend de la configuration du tampon d'envoi / recv sur nos serveurs. <br><br><img src="https://habrastorage.org/webt/qf/sk/qj/qfskqjvyygm-klersirdlmfdreo.jpeg"><br><br>  Puisque nous avons un protocole avec accus√© de r√©ception, toutes les donn√©es qui n'ont pas re√ßu de confirmation de livraison sont stock√©es dans un tampon.  Si le tampon d'envoi est limit√© √† 128 Ko, alors ces 128 Ko sont inf√©rieurs √† ceux du RTT, nous ne pouvons pas envoyer.  Ainsi, de notre r√©seau √† 400 Mbit / s, il reste 4 Mbit / s.  Cela ne suffit pas pour regarder des vid√©os en ligne en FullHD. <br><br>  Ensuite, j'ai remont√© la taille du tampon et regard√© comment la vitesse de sortie d'un segment vid√©o change vraiment en fonction du changement de taille du tampon.  Faites imm√©diatement une r√©servation que le tampon recv a √©t√© automatiquement r√©gl√©, c.-√†-d.  ce que le serveur a envoy√©, le client peut toujours l'accepter. <br><br><img src="https://habrastorage.org/webt/vj/yi/ef/vjyiefcatf55inm_ka-0b1vpake.jpeg"><br><br><blockquote>  Une recette TCP √©vidente: si vous transmettez des donn√©es √† grande vitesse sur de longues distances, vous devez augmenter la m√©moire tampon d'envoi. </blockquote><br>  Tout semble aller bien.  Vous pouvez acc√©der au service fast.com, qui mesure la vitesse de votre Internet vers les serveurs Netflix.  Du bureau, j'ai eu une vitesse de 210 Mbps.  Et puis, gr√¢ce √† Net Shaper, j'ai d√©fini les conditions de la t√¢che et je suis retourn√© sur ce site.  Magique - j'ai exactement 4 Mbps. <br><br><img src="https://habrastorage.org/webt/xx/sl/nr/xxslnr1m5syfgyludnghfp7d6yw.jpeg"><br><br>  Peu importe comment je le tord, Netflix n'a pas r√©ussi √† obtenir un tampon sup√©rieur √† 128 Ko. <br><br><h3>  Taille du tampon </h3><br>  Afin de d√©terminer la taille de tampon optimale, vous devez comprendre ce que sont les paquets √† la vol√©e. <br><br><img src="https://habrastorage.org/webt/cl/ym/ws/clymwsmlyixceklwgevvv00izru.jpeg"><br><br>  Il existe un √©tat du r√©seau: <br><br><ul><li>  les paquets 1 et 2 ont d√©j√† √©t√© envoy√©s, une confirmation a √©t√© re√ßue pour eux; </li><li>  les paquets 3, 4, 5, 6 ont √©t√© envoy√©s, mais le r√©sultat de la livraison est inconnu (paquets √† la vol√©e); </li><li>  d'autres paquets sont dans la file d'attente. </li></ul><br><img src="https://habrastorage.org/webt/if/oh/m0/ifohm0lal6uotlodse6vrehnoqc.jpeg"><br><br>  Si le nombre de paquets √† la vol√©e est √©gal √† la taille du tampon, alors il n'est pas assez grand.  Dans ce cas, le r√©seau est affam√©, pas enti√®rement utilis√©. <br><br>  La situation inverse est possible - le tampon est trop grand.  Dans ce cas, le tampon gonfle.  Pourquoi est-ce mauvais? <br><br><img src="https://habrastorage.org/webt/m1/4y/fk/m14yfka8426esfgz8a8xeglxko4.jpeg"><br><br>  Si nous parlons de multiplexage de donn√©es et envoyons plusieurs demandes en m√™me temps, par exemple, des images dans la m√™me connexion et la m√™me API, alors lorsque toute l'image √©norme en m√©gaoctets est entr√©e dans le tampon, et que nous essayons de remplir √©galement l'API haute priorit√©, le tampon gonfle.  Vous devez attendre tr√®s longtemps lorsque l'image dispara√Æt. <br><br>  Une solution simple consiste √† ajuster automatiquement la taille du tampon.  Maintenant, il est disponible sur de nombreux clients et fonctionne quelque chose comme √ßa. <br><br><img src="https://habrastorage.org/webt/pm/dj/rj/pmdjrjtekrknmzgogzn6bzkgplq.jpeg"><br><br>  Si beaucoup de paquets peuvent √™tre envoy√©s maintenant, le tampon augmente, le transfert de donn√©es s'acc√©l√®re, la taille du tampon augmente, tout semble bien se passer. <br><br>  Mais il y a un probl√®me.  Si le tampon a augment√©, il ne peut pas √™tre r√©duit aussi facilement.  C'est une t√¢che plus difficile.  Si la vitesse s'affaisse, le m√™me gonflement du tampon se produit.  Le tampon est assez grand et plein, nous devons attendre que toutes les donn√©es soient envoy√©es au client. <br><br>  Si nous √©crivons notre propre protocole UDP, alors tout est tr√®s simple - nous avons acc√®s au tampon. <br><br><img src="https://habrastorage.org/webt/ow/lz/5m/owlz5m0em5dqvtz3ni14pgc3khm.jpeg"><br><br>  Si TCP dans de telles situations ajoute simplement des donn√©es √† la fin et que vous ne pouvez rien faire, alors dans un protocole personnalis√©, vous pouvez mettre des donn√©es, par exemple, en avant, imm√©diatement apr√®s les paquets √† la vol√©e. <br><br>  Et si l'annulation arrive, et le client dit que cette image n'est plus n√©cessaire, il a besoin des donn√©es API, il a fait d√©filer le contenu plus loin, vous pouvez jeter tout cela hors du tampon et envoyer celui souhait√©. <br><br>  Comment cela se fait-il?  Il est connu que pour restaurer des paquets, g√©rer la livraison, recevoir des accus√©s de r√©ception, vous avez besoin de certains sequence_id de paquets.  Sequence_id nous sommes √©crits uniquement pour les paquets √† la vol√©e, c'est-√†-dire que nous ne les √©mettons que lorsque nous envoyons des paquets.  Tout le reste dans le tampon peut √™tre d√©plac√© comme nous le souhaitons jusqu'√† ce que les paquets soient partis. <br><br>  <strong>Conclusion:</strong> le buffer TCP doit √™tre correctement configur√©, rattraper l'√©quilibre pour ne pas abouter au r√©seau et ne pas gonfler le buffer.  Pour votre propre protocole UDP, tout est simple - cela peut √™tre contr√¥l√©. <br><br><h3>  Mod√®le de r√©seau avec perte </h3><br>  On passe √† un niveau sup√©rieur, le r√©seau devient un peu plus compliqu√©, la perte de paquets y appara√Æt.  Pour les r√©seaux mobiles, c'est une situation courante.  Certains des paquets envoy√©s n'atteignent pas le client.  L'algorithme de r√©cup√©ration de retransmission standard fonctionne comme ceci: <br><br><img src="https://habrastorage.org/webt/tg/z7/tv/tgz7tvr6zchscr49onnqepvjvje.jpeg"><br><br>  Envoie des paquets, car chaque paquet re√ßoit un accus√© de r√©ception.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le d√©lai de retransmission (RTO) est √©gal √† RTT plus certaines constantes, il n'y a pas de confirmation, le paquet est envoy√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revenons √† la courbe d'inefficacit√© TCP lorsque seulement 5% des paquets sont perdus et que l'utilisation du r√©seau est de 50%. </font></font><br><br><img src="https://habrastorage.org/webt/ob/vi/qf/obviqfawoiesuiex2yqf_idbvei.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec une retransmission qui envoie simplement des paquets, nous ne devrions pas observer un tel probl√®me. </font><font style="vertical-align: inherit;">Pour comprendre les raisons, vous devez comprendre ce qu'est le contr√¥le de la congestion.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Contr√¥le de la congestion </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il est souvent confondu avec le contr√¥le de flux, alors pensez aux deux. </font></font><br><br><img src="https://habrastorage.org/webt/bc/3k/g9/bc3kg9sb5k5sppttampxxaeaypu.jpeg"><br><br><ul><li> <b>Flow control</b> ‚Äî      .  ,           ,      .    flow control  recv window,      .  flow control ‚Äî  back pressure  ,    -    . </li><li>  <b>congestion control</b>   .  ,   ‚Äî    . </li></ul><br><img src="https://habrastorage.org/webt/mf/b5/9d/mfb59d5xp1ph_irk_rhkckjpbew.jpeg"><br><br>   ,     :  ,    ,    ,      .        ,     congestion control. <br><br>    TCP window. <br><br><img src="https://habrastorage.org/webt/tj/u0/9s/tju09sic8asow88ehlwsuyfjj6q.jpeg"><br><br>     flow control  congestion control,       . <br><br>  Exemples: <br><br><ul><li>  TCP window = 1,       :  acknowledgement,     .. </li><li>  TCP window = 4,       ,  acknowledgement   . </li></ul><br>    ,    .  initial window  TCP = 10. <br><br><img src="https://habrastorage.org/webt/ar/jf/ja/arjfjayzxewtfl-iulsna677qa0.jpeg"><br><br>    ,  ,        . <br><br>     ? <br><br><img src="https://habrastorage.org/webt/yj/ck/_t/yjck_tpkuuze0pjmkdb5mhfrlri.jpeg"><br><br><ul><li>    ,    .     ,      . </li><li>      :   , acknowledgements   . </li><li>            -    , acknowledgements      ( ). </li></ul><br>       . <br><br><img src="https://habrastorage.org/webt/jp/6c/di/jp6cdirmtiqosalz9vw-mvkjkei.jpeg"><br><br>   ,    ,   .     :     ,     ..    ,      .   congestion control,  TCP window,    ,    . <br><br><img src="https://habrastorage.org/webt/__/w0/zg/__w0zgqdiycta2u7yla0svmhof4.jpeg"><br><br>     congestion control,   ,   ‚Äî   .      packet loss ‚Äî  ,   .        ,   ,         ‚Äî    ,    . <br><br> ,  TCP , ,   congestion control   loss-.    congestion control  loss delay,     ,   . <br><br><img src="https://habrastorage.org/webt/44/no/5k/44no5kuc601zfx2h8dm_kwoqete.jpeg"><br><br> : <br><br><ul><li> <b>Cubic</b> ‚Äî  Congestion Control  Linux 2.6.        :   ‚Äî  . </li><li> <b>BBR</b> ‚Äî   Congestion Control,    Google  2016 .   . </li></ul><br><h3> BBR Congestion Control </h3><br>   Cubic  BBR   feedback. <br><br><img src="https://habrastorage.org/webt/7u/5z/zr/7u5zzrcv5cr3eyywvi0ui75qxr8.jpeg"><br><br>       ,      ‚Äî   acknowledgement       .   : <br><br><ul><li> BBR ,    ,    ,    . </li><li> Cubic        . </li></ul><br>  Vous trouverez ci-dessous un graphique du d√©lai en fonction du temps de connexion, qui montre ce qui se passe sur diff√©rents contr√¥les de congestion. <br><br><img src="https://habrastorage.org/webt/xn/l5/c_/xnl5c_gfgpby_vchj-lt5ftptta.jpeg"><br><br>  Le BBR d√©tecte d'abord le temps d'aller-retour, envoie de plus en plus de paquets, puis se rend compte que le tampon est obstru√© et entre en mode de fonctionnement avec un d√©lai minimum. <br><br>  Cubic fonctionne de mani√®re agressive - il d√©borde la totalit√© du tampon, et lorsque le tampon d√©borde et la perte de paquets se produit, cubic r√©duit la fen√™tre. <br><br>  Il semble qu'avec l'aide de BBR, il serait possible de r√©soudre tous les probl√®mes, mais il y a de la <strong>gigue</strong> sur les r√©seaux - les paquets sont parfois retard√©s, parfois regroup√©s en paquets.  Vous les envoyez avec une certaine fr√©quence, et ils viennent en groupes.  Pire encore, lorsque vous recevez des accus√©s de r√©ception de retour vers ces packages, et ils "jitter" en quelque sorte. <br><br>  Puisque j'ai promis que tout pourrait √™tre touch√© √† la main, nous ping, par exemple, le site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++</a> , regardons ping et consid√©rons la gigue entre les packages. <br><br><img src="https://habrastorage.org/webt/be/pu/fj/bepufjz6mtygfhqppfkeyvi3phq.jpeg"><br><br>  On peut voir que les paquets arrivent de mani√®re in√©gale, la gigue moyenne est d'environ 50 ms.  Naturellement, BBR peut se tromper. <br><br>  BBR est bon car il fait la distinction entre: une perte de congestion r√©elle, une perte de paquets due √† des d√©bordements de tampon de p√©riph√©rique et une perte al√©atoire due √† un r√©seau sans fil m√©diocre.  Mais cela ne fonctionne pas bien en cas de gigue √©lev√©e.  Comment puis-je l'aider? <br><br><h3>  Comment am√©liorer le contr√¥le de la congestion </h3><br>  En fait, TCP n'a pas assez d'informations en accus√© de r√©ception, il n'a que les paquets qu'il a vus.  Il y a √©galement un accus√© de r√©ception s√©lectif, qui indique quels paquets sont confirm√©s, lesquels ne sont pas encore arriv√©s.  Mais cette information n'est pas suffisante. <br><br><img src="https://habrastorage.org/webt/fs/9j/gm/fs9jgmfd67brdk7wynu6sqjprk8.jpeg"><br><br>  Si vous avez la possibilit√© de gonfler l'accus√© de r√©ception, vous pouvez toujours √©conomiser tout le temps - non seulement en envoyant ces paquets, mais √©galement en arrivant chez le client.  C'est, en fait, sur le serveur pour collecter le client de gigue. <br><br>  Pourquoi est-il g√©n√©ralement efficace de gonfler la reconnaissance?  Parce que les r√©seaux mobiles sont asym√©triques.  Par exemple, g√©n√©ralement avec 3G ou LTE, 70% de la bande passante est allou√©e pour le t√©l√©chargement de donn√©es et 30% pour le t√©l√©chargement.  L'√©metteur commute: upload - download, upload - download, et vous ne l'affectez en aucune fa√ßon.  Si vous ne d√©chargez rien, c'est tout simplement inactif.  Par cons√©quent, si vous avez des id√©es int√©ressantes, augmentez la reconnaissance, ne soyez pas timide - ce n'est pas un probl√®me. <br><br><img src="https://habrastorage.org/webt/cv/0t/gd/cv0tgdq9vzirpmrvzx4optqe0ik.jpeg"><br><br>  Un exemple de la fa√ßon dont vous pouvez utiliser un accus√© de r√©ception pour diviser la gigue en envoi et la gigue √† recevoir, et les suivre s√©par√©ment.  Ensuite, nous devenons plus flexibles et nous comprenons quand une perte de congestion s'est produite et quand une perte al√©atoire s'est produite.  Par exemple, vous pouvez comprendre la quantit√© de gigue dans chaque direction et configurer plus pr√©cis√©ment la fen√™tre. <br><br><img src="https://habrastorage.org/webt/ti/qj/zk/tiqjzkihljlcb2pn2oj-wdlbmkq.jpeg"><br><br><h3>  Quel contr√¥le de congestion choisir </h3><br>  Les camarades de classe sont un grand r√©seau avec beaucoup de trafic diff√©rent: vid√©o, API, photos.  Et il existe des statistiques dont le contr√¥le de la congestion est pr√©f√©rable. <br><br>  BBR est toujours efficace pour la vid√©o car il r√©duit les retards.  Dans d'autres cas, Cubic est g√©n√©ralement utilis√© - il convient aux photographies.  Mais il existe d'autres options. <br><br><img src="https://habrastorage.org/webt/9m/ea/gd/9meagdum2m9dvmtn4eeawrmbtay.jpeg"><br><br>  Il existe des dizaines d'options de contr√¥le de congestion diff√©rentes.  Afin de choisir le meilleur, vous pouvez collecter des statistiques sur le client et essayer l'un ou l'autre contr√¥le de congestion pour diff√©rents types de profils de charge. <br><br>  Par exemple, c'est l'effet du d√©marrage de BBR sur une vid√©o. <br><br><img src="https://habrastorage.org/webt/hy/h8/dh/hyh8dhiugrgtyl6vgaozjzitnxq.jpeg"><br><br>  Nous avons r√©ussi √† augmenter s√©rieusement la profondeur de visionnage.  Google dit qu'ils ont environ 10% de m√©moire tampon en moins dans le lecteur lors de l'utilisation de BBR. <br><br>  G√©nial, mais qu'en est-il de nos clients? <br><br><img src="https://habrastorage.org/webt/np/m1/uy/npm1uywvt78qoudkof3mkebqrj8.jpeg"><br><br>  Les clients sont un peu lents, ils ont tous Cubic et vous ne pouvez pas l‚Äôinfluencer.  Mais √ßa va, parfois vous pouvez parall√©liser des donn√©es, et ce sera bien. <br><br>  <strong>Conclusions sur le contr√¥le de la congestion:</strong> <br><br><ul><li>  BBR est toujours bon pour la vid√©o. </li><li>  Dans d'autres cas, si nous utilisons notre propre protocole UDP, vous pouvez prendre le contr√¥le de la congestion avec vous. </li><li>  D'un point de vue TCP, vous ne pouvez utiliser que le contr√¥le de congestion, qui se trouve dans le noyau.  Si vous souhaitez impl√©menter votre contr√¥le de congestion dans le noyau, vous devez vous conformer √† la sp√©cification TCP.  Il est impossible de gonfler la reconnaissance, d'apporter des modifications, car elles ne sont tout simplement pas sur le client. </li></ul><br><blockquote>  Si vous faites votre protocole UDP, vous avez beaucoup plus de libert√© en termes de contr√¥le de congestion. </blockquote><br><h3>  Multiplexage et priorisation </h3><br>  C'est une nouvelle tendance, tout le monde le fait maintenant.  Quels sont les probl√®mes?  Si nous utilisons TCP, tout le monde (ou presque) conna√Æt s√ªrement la situation de blocage en t√™te de ligne. <br><br><img src="https://habrastorage.org/webt/zv/rt/6t/zvrt6t3igpnzn4vea3lgdw7vb1e.jpeg"><br><br>  Plusieurs demandes sont multiplex√©es sur une seule connexion TCP.  Nous les avons envoy√©s au r√©seau, mais un paquet manquait.  Une connexion TCP retransmettra ce paquet; elle retransmettra dans un temps proche de RTT ou plus.  Pour le moment, nous ne pourrons rien obtenir, bien que le tampon TCP contienne des donn√©es d'une autre demande qui est compl√®tement pr√™te √† √™tre r√©cup√©r√©e. <br><br><blockquote>  Il s'av√®re que le multiplexage sur TCP, si vous utilisez HTTP 2.0, n'est pas toujours efficace sur les mauvais r√©seaux. </blockquote><br>  Le probl√®me suivant est le gonflement du tampon. <br><br><img src="https://habrastorage.org/webt/fy/zh/rw/fyzhrwlr4mmtdgxwhp-mxfa9k-y.jpeg"><br><br>  Lorsqu'une image est envoy√©e au client, la m√©moire tampon augmente.  Nous l'envoyons depuis longtemps, puis une demande d'API appara√Æt, et elle ne peut en aucun cas √™tre prioris√©e.  Dans de tels cas, la hi√©rarchisation TCP ne fonctionne pas. <br><br>  Ainsi, si une perte de paquets se produit, il y a un blocage en t√™te de ligne et lorsque le client a un d√©bit binaire variable (et cela arrive souvent avec les clients mobiles), l'effet tampon tampon appara√Æt.  Par cons√©quent, ni le multiplexage, ni la priorisation, ni la pouss√©e du serveur, ni tout le reste ne fonctionne, car nous avons soit des tampons, soit le client attend quelque chose. <br><br>  Si nous faisons notre propre multiplexage, nous pouvons y mettre diverses donn√©es. <br><br><img src="https://habrastorage.org/webt/_g/er/5g/_ger5gqpdxllo3-p1eo7ytzupce.jpeg"><br><br>  Ce n'est pas difficile, ajoutez simplement des paquets avec des nombres dans le tampon.  √Ä la vol√©e - ne touchez pas √† ce qui a d√©j√† √©t√© envoy√©, mais ce qui n'a pas encore √©t√© envoy√© peut √™tre r√©organis√©.  Cela ressemble √† ceci. <br><br><img src="https://habrastorage.org/webt/9g/_v/xr/9g_vxrrlkavxucnmocy3kggc-f8.jpeg"><br><br>  Ils ont envoy√© des photos, les ont divis√©s en paquets, sont venus une demande d'API prioritaire: ils l'ont ins√©r√©e, ont envoy√© la photo.  M√™me s'il manque un paquet, nous pouvons obtenir une demande d'API pr√™te √† l'emploi √† partir du tampon, il est de haute priorit√© et atteindra rapidement le client.  Dans TCP, par d√©finition, le transfert de donn√©es en continu n'est pas possible. <br><br><h3>  √âtablir une connexion </h3><br>  Si nous profilons notre application, nous verrons que la plupart du temps, le r√©seau est inactif au d√©but de l'application, car la connexion est d'abord √©tablie avant l'API, puis nous obtenons les donn√©es, puis la connexion est √©tablie avant les images, ces donn√©es sont t√©l√©charg√©es, etc.  Cela se produit toujours - le r√©seau est utilis√© par des pics. <br><br><img src="https://habrastorage.org/webt/14/cn/ck/14cnckztbu1v-otwf__j9dqzahu.jpeg"><br><br>  Pour y faire face, voyons comment la connexion est √©tablie. <br><br><img src="https://habrastorage.org/webt/ca/eb/ij/caebijcqzlqj0h5soblnfudqedo.jpeg"><br><br>  Le premier est de r√©soudre le DNS - nous ne pouvons rien y faire.  Ensuite, √©tablissez une connexion TCP, √©tablissez une connexion s√©curis√©e, puis ex√©cutez la demande et recevez une r√©ponse.  La chose la plus int√©ressante est qu'une partie du travail effectu√© par le serveur lorsqu'il r√©pond √† une demande prend g√©n√©ralement moins de temps que l'√©tablissement d'une connexion. <br><br>  Maintenant, il est tr√®s √† la mode de mesurer les nombres de latence pour la m√©moire, pour les disques, pour autre chose.  Vous pouvez les mesurer pour un r√©seau 3G, 4G et voir combien de temps il faut dans le pire des cas pour √©tablir une connexion TCP avec TLS. <br><br><img src="https://habrastorage.org/webt/qe/ux/1p/qeux1p7brp9mvpxeptinhubywmc.jpeg"><br><br>  Et cela peut prendre quelques secondes!  M√™me sur 4G jusqu'√† 700 ms est √©galement significatif.  Mais TCP n'a pas pu vivre aussi facilement pendant tout ce temps. <br><br>  La connexion est bas√©e sur l'algorithme de prise de <strong>contact TCP √† 3 voies de base</strong> .  Faites syn, syn + ack, puis corrigez la demande plus tard (√† gauche dans le diagramme). <br><br><img src="https://habrastorage.org/webt/ty/mj/-a/tymj-amfsa1c4j8sirtaspnvq1o.jpeg"><br><br>  Il y a <strong>TCP Fast Open</strong> (√† droite).  Si vous avez d√©j√† fait une poign√©e de main avec ce serveur, il y a un cookie, vous pouvez envoyer votre demande imm√©diatement pour z√©ro-RTT.  Pour l'utiliser, vous devez cr√©er un socket, faire envoyer √† () les premi√®res donn√©es, dire que vous voulez FASTOPEN. <br><br><img src="https://habrastorage.org/webt/ab/kl/b9/abklb93dq3g__tw2rihxrhagkl8.jpeg"><br><br>  Nginx peut faire tout cela - allumez-le, tout fonctionnera (ou allumez-le dans le noyau). <br><br><h2>  TLS </h2><br>  V√©rifions que TLS est mauvais. <br><br>  J'ai √† nouveau d√©fini net shaper pendant 200 ms, j'ai fait un ping sur google.com et j'ai vu que RTT = 220 est mon shaper RTT + RTT.  Ensuite, j'ai fait une demande via HTTP et HTTPS.  J'ai d√©couvert que via HTTP, il est possible d'obtenir une r√©ponse pendant RTT, c'est-√†-dire que TFO fonctionne pour Google depuis mon ordinateur.  Pour HTTPS, cela a pris plus de temps. <br><br><img src="https://habrastorage.org/webt/po/hl/kj/pohlkjs39dl7kk3rp5kzbxrwsna.jpeg"><br><br>  Il s'agit d'une surcharge TLS courante qui n√©cessite une messagerie pour √©tablir une connexion s√©curis√©e. <br><br><img src="https://habrastorage.org/webt/zf/j2/qn/zfj2qndcohpiok8cqpc82kiun3s.jpeg"><br><br>  Pour ce faire, ils ont pens√© pour nous, a ajout√© TLS 1.3.  Il est √©galement facile √† inclure dans nginx. <br><br><img src="https://habrastorage.org/webt/m5/eo/i0/m5eoi0z5a2rzb4hthqlbjchxhyi.jpeg"><br><br>  Tout semble fonctionner.  Mais voyons ce qu'il y a sur nos clients mobiles qui profitent de tout cela. <br><br><h3>  Quoi de neuf avec les clients </h3><br>  TCP Fast Open est une bonne chose.  Selon les statistiques. <br><br><img src="https://habrastorage.org/webt/pq/yy/l8/pqyyl89jhtoulpwalg61q8pqbnw.jpeg"><br><br>  Il existe de nombreux articles qui disent que l'√©tablissement d'une connexion est garanti pour passer 10% plus rapidement.  Mais sur Android 8.1.0 (j'ai regard√© divers appareils), personne n'a TFO.  Sur Android 9, j'ai vu TFO sur l'√©mulateur, mais pas sur de vrais appareils.  IOS est un peu mieux.  Ici vous pouvez le voir: <br><br><pre><code class="plaintext hljs">sysctl -a | grep fast net.ipv4.tcp_fastopen = 0</code> </pre> <br>  Pourquoi est-ce arriv√©?  TCP Fast Open a √©t√© propos√© en 2014, maintenant c'est d√©j√† un standard, il est support√© sous Linux et tout est super.  Mais il y a un tel probl√®me que la prise de contact TFO a commenc√© √† s'effondrer dans certains r√©seaux.  En effet, certains fournisseurs (ou certains p√©riph√©riques) sont habitu√©s √† inspecter TCP, √† faire leurs optimisations, et ne s'attendaient pas √† ce qu'il y ait une prise de contact TFO.  Par cons√©quent, sa mise en ≈ìuvre a pris tellement de temps, et jusqu'√† pr√©sent, les clients mobiles ne l'incluent pas par d√©faut, au moins Android. <br><br>  Avec TLS 1.3, qui nous promet, la configuration de la connexion sans RTT est encore meilleure.  Je n'ai trouv√© aucun appareil Android sur lequel cela fonctionnerait.  Par cons√©quent, Facebook a cr√©√© la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fizz</a> .  Il y a quelques mois, il est devenu disponible en open source, vous pouvez le faire glisser avec vous et utiliser TLS 1.3.  Il s'av√®re que m√™me la s√©curit√© doit √™tre entra√Æn√©e, rien n'appara√Æt au c≈ìur de cela. <br><br><img src="https://habrastorage.org/webt/07/qm/kf/07qmkfwywo3llz5nrrh04kg3a_o.jpeg"><br><br>  Le diagramme montre l'utilisation de diff√©rentes versions d'Android par nos clients mobiles.  V 9.x est un peu - o√π TFO peut appara√Ætre, et TLS1.3 ne se trouve nulle part ailleurs. <br><br>  <strong>Conclusions sur l'√©tablissement d'une connexion:</strong> <br><br><ul><li>  TFO n'est pas disponible pour 95% des appareils. </li><li>  TLS1.3 doit √™tre apport√© avec lui-m√™me. </li><li>  Si vous devez r√©p√©ter cela dans UDP, transf√©rez tout cela vers UDP et r√©p√©tez. </li></ul><br><img src="https://habrastorage.org/webt/n2/tj/v1/n2tjv1g-04l2jfghy_6--uqaqjc.jpeg"><br><br>  Il s'est av√©r√© que 97% des connexions cr√©√©es utilisent la cl√© existante, c'est-√†-dire que 97% sont cr√©√©s pour z√©ro RTT et seulement 3% sont nouveaux.  La cl√© est stock√©e sur l'appareil pendant un certain temps. <br><br>  TCP ne peut pas s'en vanter.  Dans un maximum de 5% des cas, si vous faites tout correctement, vous pourrez obtenir le vrai z√©ro-RTT dont tout le monde parle maintenant. <br><br><h2>  Changement d'adresse IP </h2><br>  Souvent, lorsque vous quittez votre domicile, votre t√©l√©phone passe du Wi-Fi √† la 4G. <br><br><blockquote>  TCP fonctionne comme ceci: l'adresse IP a chang√© - la connexion a √©chou√©. </blockquote><br><img src="https://habrastorage.org/webt/km/nu/u8/kmnuu8dtr8jeipuzx4bhpfezuwm.jpeg"><br><br>  Si vous √©crivez votre protocole UDP, c'est tr√®s simple, en impl√©mentant un ID de connexion (CUID) dans chaque paquet, vous pouvez l'identifier, m√™me s'il provient d'une adresse IP diff√©rente. <br><br><img src="https://habrastorage.org/webt/xu/ga/r_/xugar_l9pbltv6419btnrimfhv8.jpeg"><br><br>  Il est clair que vous devez vous assurer qu'il a la bonne cl√©, que tout est d√©chiffr√©, etc.  Mais en principe, vous pouvez commencer √† r√©pondre √† cette adresse, cela ne posera aucun probl√®me. <br><br><blockquote>  Dans TCP, la migration IP est une chose impossible. </blockquote><br>  Si vous faites votre UDP, et que vous √™tes arriv√© sur le m√™me serveur, vous devez faire un peu de magie, inclure le CID dans chaque paquet, et vous pourrez utiliser la connexion √©tablie lors du changement d'adresse IP. <br><br><h2>  R√©utilisation des connexions </h2><br>  Tout le monde dit que vous devez r√©utiliser les connexions car les connexions co√ªtent tr√®s cher. <br><br><img src="https://habrastorage.org/webt/8-/lr/ot/8-lrot44ac9mwo6m7ue_ksezk0g.jpeg"><br><br>  Mais il y a des pi√®ges √† r√©utiliser les compos√©s. <br><br><img src="https://habrastorage.org/webt/_n/aa/z3/_naaz3uac-hwdd7uikndioiupry.jpeg"><br><br>  Tr√®s probablement, beaucoup de gens se souviennent (sinon, voyez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ) que tout le monde n'a pas d'adresse publique, mais il y a NAT, qui stocke g√©n√©ralement le mappage pendant un certain temps sur le routeur domestique.  Pour TCP, la quantit√© √† stocker est claire, mais pour UDP, elle n'est pas claire.  NAT fonctionne sur un timeout, si vous mesurez soigneusement ce timeout, nous obtenons que dans environ 15-30 secondes, plus de 50% des connexions commenceront √† √©chouer. <br><br>  √áa va - nous allons faire un paquet de ping-pong pendant 15 s.  Pour les cas o√π la connexion est toujours interrompue, il y a la migration IP, qui vous permet √† moindre co√ªt de changer le port sur le routeur. <br><br><img src="https://habrastorage.org/webt/7g/mu/bf/7gmubflfj-yenwqvgiqbkc8toa8.jpeg"><br><br><h2>  Stimulation du paquet </h2><br>  C'est une chose tr√®s importante si vous faites votre protocole UDP. <br><br><img src="https://habrastorage.org/webt/cf/d5/97/cfd597jt4v7uopygyyu-dfsx_8s.jpeg"><br><br>  Si c'est tr√®s simple, plus vous envoyez des paquets en continu au r√©seau, plus la probabilit√© de perte de paquets est grande.  Si vous filtrez les paquets, la perte de paquets sera plus faible. <br><br>  Il existe de nombreuses th√©ories diff√©rentes sur la fa√ßon dont cela fonctionne, mais j'aime celle-ci. <br><br><img src="https://habrastorage.org/webt/75/79/xl/7579xlvo70vmotoqjjp3zmmplr8.jpeg"><br><br>  Trois connexions sont cr√©√©es en m√™me temps.  Vous avez la soi-disant fen√™tre initiale - 10 packages cr√©√©s en m√™me temps.  Bien s√ªr, la bande passante pourrait ne pas √™tre suffisante √† ce stade.  Mais si vous les distribuez soigneusement, les s√©parez, alors tout ira bien, comme sur la bonne figure. <br><br>  Ainsi, si vous d√©finissez un d√©bit uniforme pour l'envoi de paquets, les affinez, la probabilit√© qu'il y ait un d√©passement de m√©moire tampon unique devient plus faible.  Ce n'est pas prouv√©, mais th√©oriquement cela se passe comme √ßa. <br><br><img src="https://habrastorage.org/webt/vw/mg/vw/vwmgvw6oyq3v_yaliklp4ilnocm.jpeg"><br><br>  Lorsque vous devez couper des paquets (faire du rythme): <br><br><ul><li>  Lorsque vous cr√©ez une fen√™tre. </li><li>  Lorsque vous agrandissez la fen√™tre, par exemple, il est recommand√© d'ajouter autant de paquets que possible pour RTT / 2.  Cela ne d√©gradera pas le d√©lai de livraison, mais r√©duira la perte de paquets. </li><li>  En cas de perte de congestion, pour r√©duire la fen√™tre, vous devez √©taler encore plus les paquets.  4/5 RTT est une figure s√©lectionn√©e empiriquement. </li></ul><br><h2>  MTU </h2><br>  Lorsque vous √©crivez votre protocole UDP, n'oubliez pas de vous souvenir de MTU.  MTU est la taille des donn√©es que vous pouvez transmettre. <br><br><img src="https://habrastorage.org/webt/c2/7_/ow/c27_ow36h5amg3d4zkskjph_ama.jpeg"><br><br>  Nous envoyons des paquets du serveur au client, par exemple, avec une taille de 1500. S'il y a un routeur sur le chemin qui ne prend pas en charge cette taille MTU, il le fragmentera.  Le seul probl√®me de fragmentation est que si un paquet est perdu, les deux seront perdus et tout cela devra √™tre retransmis.  Par cons√©quent, TCP a un algorithme pour d√©terminer MTU - PMTU. <br><br><img src="https://habrastorage.org/webt/je/gs/ks/jegskszkwrb3pm2nghgfpplez8o.jpeg"><br><br>  Chaque routeur regarde le MTU de son interface, l'envoie √† un client, l'autre l'envoie √† son client, tout le monde sait combien de MTU ils ont sur le client.  Ensuite, la fragmentation est interdite par l'indicateur et des paquets de taille MTU sont envoy√©s.  Si √† ce moment quelqu'un √† l'int√©rieur du r√©seau se rend compte qu'il a moins de MTU, alors via ICMP il dira: "D√©sol√©, le paquet a √©t√© perdu car une fragmentation est n√©cessaire" et indiquera la taille du MTU.  Nous changerons cette taille et continuerons √† exp√©dier.  Dans le pire des cas, notre petit frais g√©n√©raux est RTT / 2.  C'est en TCP. <br><br><img src="https://habrastorage.org/webt/vl/br/fo/vlbrfo8a7p80neysmtjguosakww.jpeg"><br><br>  Si dans UDP vous ne voulez pas vous emb√™ter avec ICMP, vous pouvez faire ce qui suit: autoriser la fragmentation lors de l'envoi de donn√©es normales.  Autrement dit, pour envoyer des paquets fragment√©s - laissez-les fonctionner.  Et en parall√®le pour d√©marrer un processus qui interdit la fragmentation, une recherche binaire s√©lectionnera le MTU optimal, auquel nous irons ensuite.  Ce n'est pas enti√®rement efficace, car au d√©but, le MTU semble se r√©chauffer. <br><br>  Une option plus d√©licate consiste √† examiner la distribution de MTU parmi les clients mobiles. <br><br><img src="https://habrastorage.org/webt/ie/a5/w8/iea5w8h3msrkprfxpgfhb2nkjyu.jpeg"><br><br>  De tous les clients, nous avons envoy√© des paquets de diff√©rentes tailles avec l'interdiction de la fragmentation.  Autrement dit, si le paquet n'atteint pas, il tombera et le plus petit MTU devrait atteindre 100%.  Mais il y a une petite perte de paquets, il y a donc deux diapositives sur le graphique: <br><br><ol><li>  1350 octets - au lieu de 98%, nous recevons 95% de livraison imm√©diatement. </li><li>  1500 octets - MTU, apr√®s quoi d√©j√† 80% des clients ne recevront pas de tels paquets. </li></ol><br><blockquote>  En fait, nous pouvons dire ceci: nous n√©gligeons 1-2% de nos clients, les laissons vivre sur des packages fragment√©s.  Mais nous partirons imm√©diatement de ce dont nous avons besoin - c'est √† partir de 1350. </blockquote><br><h2>  Correction d'erreurs (SACK, NACK, FEC) </h2><br>  Si vous effectuez votre protocole, vous devez corriger les erreurs.  Si le paquet est manquant (c'est normal pour les r√©seaux sans fil), il doit √™tre restaur√©. <br><br>  Dans le cas le plus simple (plus de d√©tails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ), il y a un relais via Retransmit Time Out (RTO).  Si le paquet est manquant, attendez l'heure de retransmission et renvoyez-le. <br><br>  L'algorithme suivant est la <b>retransmission rapide</b> .  Ce sont tous des algorithmes TCP, mais ils peuvent √™tre facilement port√©s vers UDP. <br><br><img src="https://habrastorage.org/webt/hm/s1/ee/hms1eey-ntpj2x0piswhxc4e5fa.jpeg"><br><br>  Lorsque le paquet est parti, nous continuons d'envoyer - il y a une transmission d'autres paquets.  √Ä ce moment, le serveur dit qu'il a re√ßu le prochain paquet, mais il n'y en avait pas de pr√©c√©dent.  Pour ce faire, il √©met un accus√© de r√©ception d√©licat, qui est √©gal au num√©ro de package + 1, et d√©finit l'indicateur d'ack en double.  Il envoie ces duk ack ainsi, et le troisi√®me, nous comprenons g√©n√©ralement que le paquet a disparu et nous le renvoyons. <br><br>  Que voulez-vous faire d'autre de classe, ce qui n'est pas dans TCP et ce qu'ils proposent de faire dans UDP est la <b>correction d'erreur directe</b> . <br><br><img src="https://habrastorage.org/webt/ex/_u/gg/ex_uggyt0-4ntdgzy-vn7hvmyzg.jpeg"><br><br>  Il semble que si nous savons que des packages peuvent √™tre perdus, nous pouvons prendre un ensemble de packages, y ajouter un package XOR et r√©soudre le probl√®me sans retransmissions suppl√©mentaires imm√©diatement sur le client lors de la r√©ception de donn√©es.  Mais il y a un probl√®me si plusieurs packages disparaissent.  Il semble que cela peut √™tre r√©solu gr√¢ce √† la protection de la parit√©, Reed-Solomon, etc. <br><br>  Nous l'avons essay√© de cette fa√ßon, il s'est av√©r√© qu'en fait les paquets disparaissent en paquets. <br><br><img src="https://habrastorage.org/webt/fg/qo/jj/fgqojj1gas9pgutyyyzkla_m5ze.jpeg"><br><br>  L'√©cart de paquet moyen s'est av√©r√© √™tre de 6. Il s'agit d'un √©cart de paquet tr√®s g√™nant - vous avez besoin de beaucoup de codes de correction d'erreur.  Dans le m√™me temps, il y a une sorte de pic √† 11 - je ne sais pas pourquoi, mais les paquets disparaissent parfois en paquets de 11.  En raison de cet √©cart de paquets, cela ne fonctionne pas. <br><br>  Google a √©galement essay√©, tout le monde r√™ve de FEC, mais jusqu'√† pr√©sent, personne n'a travaill√©. <br><br>  Il existe une autre option lorsque la FEC peut vous aider. <br><br><img src="https://habrastorage.org/webt/d9/tb/tw/d9tbtwafxbt_t08_j9wvarw5icc.jpeg"><br><br>  En plus de la retransmission via Retransmit Time Out, Fast Retransmit, il existe √©galement une <strong>sonde de perte de queue</strong> .  C'est une telle chose lorsque vous envoyez des donn√©es, et la queue est partie.  Autrement dit, vous avez envoy√© une partie des donn√©es, envoy√© le cinqui√®me paquet - il est arriv√©.  Ensuite, les paquets ont commenc√© √† dispara√Ætre, par exemple, en raison de la d√©faillance du r√©seau.  Les paquets disparaissent, disparaissent et vous avez re√ßu un accus√© de r√©ception uniquement pour le cinqui√®me paquet. <br><br>  Pour comprendre si ces donn√©es ont atteint, apr√®s un certain temps, vous commencez √† faire TLP (sonde de perte de queue), demandez si la fin est re√ßue.  Le fait est que le transfert de donn√©es est termin√© et que vous n'envoyez rien, alors la retransmission rapide ne fonctionnera pas.  Pour r√©soudre ce probl√®me, effectuez un TLP. <br><br>  Vous pouvez ajouter FEC aux TLP.  Vous pouvez regarder tous les paquets qui ne sont pas arriv√©s, compter la parit√© sur eux et envoyer des TLP avec un paquet de parit√©. <br><br>  Tout cela est cool, cela semble fonctionner.  Mais il y a un tel probl√®me. <br><br><img src="https://habrastorage.org/webt/pt/y5/qm/pty5qmye2nqwrocxnp3fv5-gll4.jpeg"><br><br>  Nous avons collect√© des statistiques et il s'est av√©r√© que 98% des erreurs sont r√©par√©es par Fast Retransmit.  Le reste est r√©par√© via Retransmit Time Out et moins de 1% via TLP.  Si vous corrigez quelque chose d'autre FEC, il sera inf√©rieur √† 0,5%. <br><br><blockquote>  TCP ne prend pas en charge FEC.  En UDP, ce n'est pas difficile √† faire, mais dans le cas g√©n√©ral, les algorithmes de r√©cup√©ration TCP standard suffisent. </blockquote><br><h2>  Performances </h2><br>  Il serait possible de ne pas nuire aux performances en comparant TCP avec UDP. <br><br>  TCP est un protocole tr√®s ancien avec beaucoup d'optimisations diff√©rentes, par exemple LSO (d√©chargement de gros segments) et zerocopy.  Maintenant, pour UDP, tout n'est pas disponible.  Par cons√©quent, les performances UDP ne sont que de 20% par rapport √† TCP √† partir des m√™mes serveurs.  Mais il existe d√©j√† des solutions toutes faites ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UDP GSO</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">zerocopy</a> ) qui permettent √† Linux de supporter cela. <br><br>  Le principal probl√®me de prise en charge de l'optimisation pour la z√©rocopie et le LSO est que la stimulation est perdue. <br><br><img src="https://habrastorage.org/webt/qu/6i/th/qu6ith66mowy_jm9iznjsstsadm.jpeg"><br><br><h2>  Temps de commercialisation ou ce qui a tu√© TCP </h2><br>  R√©cemment, lorsque les r√©seaux sans fil mobiles sont devenus populaires, de nombreuses normes TCP diff√©rentes sont apparues: TLP, TFO, nouveau contr√¥le de congestion, RACK, BBR et plus encore. <br><br><img src="https://habrastorage.org/webt/nq/lx/5a/nqlx5a_sq5zzvi2au81ulptczew.jpeg"><br><br><blockquote>  Mais le principal probl√®me est que beaucoup d'entre eux ne sont pas mis en ≈ìuvre, car TCP serait ossifi√©.  Dans de nombreux cas, les op√©rateurs regardent les paquets TCP et s'attendent √† voir ce qu'ils attendent.  Par cons√©quent, il est tr√®s difficile de changer. </blockquote><br>  De plus, les clients mobiles sont mis √† jour depuis longtemps et nous ne pouvons pas fournir ces mises √† jour.  Si vous regardez quelles sont les derni√®res mises √† jour r√©centes disponibles sur le client et ce qui se trouve sur le serveur, vous pouvez dire qu'il n'y a presque rien sur le client. <br><br><img src="https://habrastorage.org/webt/au/57/iw/au57iwnkvrjzkvrpo2osdo7f49e.jpeg"><br><br>  Par cons√©quent, la d√©cision d'√©crire un protocole dans l'espace utilisateur, au moins tant que vous accumulez toutes ces fonctionnalit√©s, ne semble pas si mauvaise. <br><br><img src="https://habrastorage.org/webt/6i/o6/po/6io6poew2qopzofy3vbflm3-5a8.jpeg"><br><br>  Avec TCP, les fonctionnalit√©s √©voluent depuis des ann√©es.  Pour votre protocole UDP, vous pouvez mettre √† jour la version litt√©ralement en une seule mise √† jour du client et du serveur.  Mais vous devrez ajouter la n√©gociation de version. <br><br><h2>  TCP vs UDP autodidacte.  Combats finaux </h2><br><img src="https://habrastorage.org/webt/fx/q6/ct/fxq6ctnz94vaf7pfr7jmrcbz7lu.jpeg"><br><br><ul><li>  Send / recv buffer: un tampon mutable peut √™tre fait pour votre protocole, il y aura des probl√®mes avec le ballonnement du tampon avec TCP. </li><li>  Contr√¥le de congestion, vous pouvez utiliser l'existant.  Chez UDP, il y en a. </li><li>  Le nouveau contr√¥le d'encombrement est difficile √† ajouter √† TCP, car vous devez modifier l'accus√© de r√©ception, vous ne pouvez pas le faire sur le client. </li><li>  Le multiplexage est un probl√®me critique.  Le blocage en t√™te de ligne se produit, lorsque vous perdez un paquet, vous ne pouvez pas multiplexer vers TCP.  Par cons√©quent, HTTP2.0 sur TCP ne devrait pas augmenter s√©rieusement. </li><li>  Les cas o√π vous pouvez obtenir une configuration de connexion pour 0-RTT en TCP sont extr√™mement rares, de l'ordre de 5% et de l'ordre de 97% pour l'UDP self-made. </li></ul><br><img src="https://habrastorage.org/webt/4f/_f/oe/4f_foen6zvxf5mexl8p6jfu2izm.jpeg"><br><br><ul><li>  La migration IP n'est pas une fonctionnalit√© aussi importante, mais dans le cas d'abonnements complexes et de l'√©tat de stockage sur le serveur, elle est absolument n√©cessaire, mais elle n'est pas impl√©ment√©e dans TCP. </li><li>  La dissociation de Nat n'est pas en faveur de l'UDP.  Dans ce cas, UDP a souvent besoin de faire des paquets de ping-pong. </li><li>  La stimulation de paquets dans UDP est simple, bien qu'il n'y ait pas d'optimisation, dans TCP cette option ne fonctionne pas. </li><li>  MTU et correction d'erreur sont tous deux comparables. </li><li>  La vitesse de TCP, bien s√ªr, est plus rapide que UDP maintenant, si vous distribuez une tonne de trafic.  Mais alors certaines optimisations prennent beaucoup de temps √† livrer. </li></ul><br>  Si vous collectez tous les √©l√©ments les plus importants, alors UDP, plus probablement, a plus d'avantages que d'inconv√©nients. <br><br><img src="https://habrastorage.org/webt/p4/7k/ys/p47kysilkuqtb-x-zc0cwhigeoe.jpeg"><br><br>  <b>Choisissez UDP!</b> <br><br><h2>  Test UDP self-made sur les utilisateurs </h2><br>  Nous avons mis en place un banc d'essai. <br><br><img src="https://habrastorage.org/webt/rh/er/ec/rherec8kewip9-ycek5qimdgvuw.jpeg"><br><br>  Il existe un client sur TCP et UDP.  Nous avons normalis√© le trafic via net shaper, envoy√© √† Internet et au serveur.  Un service d'API REST, le second avec UDP.  Et UDP va vers la m√™me API REST dans le m√™me centre de donn√©es pour v√©rifier les donn√©es.  Nous avons collect√© diff√©rents profils de nos clients mobiles et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lanc√© le test</a> . <br><br><img src="https://habrastorage.org/webt/sy/rf/nf/syrfnflhcgpr13bngr1y7cv5fle.jpeg"><br><br>  En mesurant la moyenne sur le portail, nous avons vu que nous pouvions r√©duire le temps d'appel de l'API de 10%, les images de 7%.  L'activit√© des utilisateurs n'a augment√© que de 1%, mais nous n'abandonnons pas, nous pensons que ce sera mieux. <br><br><img src="https://habrastorage.org/webt/o9/wr/bj/o9wrbjk45dk58yjji6t8boe9-xw.jpeg"><br><br>  En termes de charges, nous avons maintenant environ 10 millions d'utilisateurs sur notre UDP self-made, un trafic jusqu'√† 80 Gb / s, 6 millions de paquets par seconde et 20 serveurs tous servent cela. <br><br><h2>  Liste de contr√¥le UDP <br></h2><br>  Si vous √©crivez votre protocole, vous avez besoin d'une liste de contr√¥le: <br><br><ul><li>  Stimulation </li><li>  D√©couverte du MTU. </li><li>  <strong>Corrections de bugs requises</strong> . </li><li>  Contr√¥le de flux et contr√¥le de congestion. </li><li>  En option, vous pouvez prendre en charge la migration IP, TLP est facile. </li></ul><br>  N'oubliez pas que les canaux sont asym√©triques et que pendant que vous recevez des donn√©es du serveur, votre t√©l√©chargement peut √™tre inactif, essayez de l'utiliser. <br><br><h2>  QUIC </h2><br>  Il serait malhonn√™te de dire que Google ne l'a pas fait. <br><br><img src="https://habrastorage.org/webt/z0/b9/-v/z0b9-v9kmmobln4nv2yado-rble.jpeg"><br><br>  Il existe un protocole QUIC que Google a impl√©ment√© sous HTTP 2.0, qui prend en charge √† peu pr√®s la m√™me chose. <br><br><h3>  Pourquoi QUIC n'est pas si rapide </h3><br>  Quand QUIC est sorti, il y avait beaucoup de haine √† propos du fait que Google dit que tout fonctionne plus vite, et "je l'ai mesur√© √† la maison sur un ordinateur - √ßa marche plus lentement." <br><br><img src="https://habrastorage.org/webt/db/5a/vd/db5avdtu1zaito8ntcmg-hdvwy8.jpeg"><br><br>  Cet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article a un</a> tas d'images et de mesures. <br><br>  Eh bien, il s'av√®re que nous avons fait tout cela en vain, les gens ont-ils mesur√© pour nous?  Il existe de r√©elles mesures √† domicile, m√™me avec des exemples de code. <br><br><img src="https://habrastorage.org/webt/id/wr/39/idwr39saesks74hbadevlunieua.jpeg"><br><br>  En fait, il n'y aura aucune am√©lioration tant que vous ne parall√©liserez pas les demandes, ne travaillerez pas sur des r√©seaux r√©els et jusqu'√† ce que les pertes de paquets soient divis√©es en perte de congestion et perte al√©atoire.  Nous avons besoin d'une v√©ritable √©mulation d'un vrai r√©seau. <br><br>  Mais il y a un point positif, disent-ils, QUIC n'est ni meilleur ni pire.  Ainsi, dans des r√©seaux parfaits, QUIC fonctionne bien. <br><br><h2>  Le futur </h2><br>  Google a r√©cemment nomm√© HTTP 2.0 au-dessus de QUIC HTTP 3, √† ne pas confondre, car HTTP 2.0 pourrait √™tre au-dessus de TCP et au-dessus de QUIC.  Maintenant, c'est HTTP 3. <br><br><img src="https://habrastorage.org/webt/go/ra/z4/goraz4ktgsje7ankwyipapzeow0.jpeg"><br><br>  Il y avait aussi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google QUIC</a> - c'est QUIC, qui est impl√©ment√© dans Chrome, et iQUIC - un QUIC standardis√©.  Le QUIC standardis√© n'a √©t√© impl√©ment√© nulle part, les serveurs iQUIC standard n'ont pas pris de contact avec Google QUIC.  Maintenant, ils promettent de r√©soudre ce probl√®me, et bient√¥t il sera disponible. <br><br><h3>  QUIC est partout </h3><br>  Si vous ne croyez toujours pas que TCP est mort, je vous dirai que lorsque vous utilisez Chrome, Android et bient√¥t iOS et que vous allez sur Google, YouTube, etc., vous utilisez QUIC et UDP ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prooflink</a> ). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">QUIC c'est maintenant</a> : <br><br><ul><li>  1,9% de tous les sites Web; </li><li>  12% de tout le trafic; </li><li>  30% du trafic vid√©o sur les r√©seaux mobiles. </li></ul><br>  Comment v√©rifier que vous utilisez QUIC si vous n'y croyez pas?  Ouvrez dans Chrome Wireshark.  Je cherchais iQUIC, je ne l'ai trouv√© nulle part, mais GQUIC arrive. <br><br><img src="https://habrastorage.org/webt/t_/8v/9q/t_8v9qsq9jcgbjkf9vqqr67vw7k.jpeg"><br><br>  Vous pouvez √©galement aller en ligne dans votre navigateur et √©galement voir ce que GQUIC est l√†. <br><br><img src="https://habrastorage.org/webt/av/ko/p5/avkop5nphmxm6ee3rqc2hi23wzu.jpeg"><br><br><h3>  Un peu plus d'avenir </h3><br>  Multipath nous attend bient√¥t. <br><br><img src="https://habrastorage.org/webt/d8/bi/wo/d8biwobqjbdjqdn8g-wb7gegka0.jpeg"><br><br>  Lorsque vous avez un client mobile disposant √† la fois du Wi-Fi et de la 3G, vous pouvez utiliser les deux canaux.  Multipath TCP est en cours de d√©veloppement et sera bient√¥t disponible dans le noyau Linux.  √âvidemment, cela n'atteindra pas les clients bient√¥t, je pense que cela peut √™tre fait sur UDP beaucoup plus rapidement. <br><br><img src="https://habrastorage.org/webt/pb/7o/yt/pb7oytnkrhutg6qtqlwq0jf3p4o.jpeg"><br><br>  √âtant donn√© que nous effectuons beaucoup de traductions de 3 To chacune, nous utilisons tr√®s souvent des technologies telles que la distribution CDN et p2p, lorsque le m√™me contenu doit √™tre fourni √† de nombreux utilisateurs √† travers le monde. <br><br>  En IPv6, il existe une multidiffusion avec UDP, qui permettra de livrer des paquets √† plusieurs utilisateurs abonn√©s √† la fois.  Par cons√©quent, je pense que les technologies CDN et p2p ne seront pas n√©cessaires dans un avenir proche si nous livrons tout le contenu en utilisant la multidiffusion sur IPv6. <br><br><h2>  Conclusions </h2><br>  J'esp√®re que vous comprenez: <br><br><ul><li>  Comment le r√©seau fonctionne vraiment et que TCP peut √™tre r√©p√©t√© sur UDP et mieux fait. </li><li>  Ce TCP n'est pas si mal si vous le configurez correctement, mais il a vraiment abandonn√© et ne se d√©veloppe presque plus. </li><li>  Ne faites pas confiance aux ennemis de UDP qui disent qu'ils ne travailleront pas dans l'espace utilisateur.  Tous ces probl√®mes peuvent √™tre r√©solus.  Essayez-le - c'est le futur proche. </li><li>  Si vous ne le croyez pas, vous pouvez et devez toucher le r√©seau avec vos mains.  J'ai montr√© comment presque tout peut √™tre v√©rifi√©. </li></ul><br>  Vous avez tout lu et compris quoi ensuite? <br><br><ul><li>  Configurez le protocole (TCP, UDP - peu importe) pour la situation (profil r√©seau + profil de charge). </li><li>  Utilisez les recettes TCP que je vous ai dites: TFO, tampon d'envoi / recv, TLS1.3, CC ... </li><li>  Faites vos protocoles UDP si vous avez les ressources. </li><li>  Si vous avez fait votre UDP, v√©rifiez dans la liste de contr√¥le UDP que vous avez fait tout ce dont vous avez besoin.  Oublier tout non-sens comme la stimulation, cela ne fonctionnera pas. </li></ul><br>  Si vous n'avez pas les ressources, pr√©parez votre infrastructure pour QUIC.  T√¥t ou tard, il viendra vers vous. <br><br><blockquote>  Nous d√©terminons l'avenir.  Nous d√©cidons quels protocoles utiliser.  Si vous voulez utiliser QUIC - utilisez-le, si vous voulez votre UDP ou restez sur TCP - d√©cidez de l'avenir vous-m√™me. </blockquote><br><h3>  Liens utiles </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Millions d'appels vid√©o par jour ou ¬´Appelle maman!¬ª</a>  . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nous √©crivons notre protocole sur UDP</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Podcast sur l'optimisation du r√©seau</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Augmentez la vitesse de transfert de donn√©es dans les mauvais r√©seaux</a> . </li></ul><br><blockquote>  Jusqu'au 7 septembre, vous pouvez toujours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">soumettre une demande</a> pour Moscou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++</a> et partager comment vous pr√©parez vos services pour des charges √©lev√©es.  Mais le programme se remplit d√©j√† progressivement, d'apr√®s Odnoklassniki, des rapports ont √©t√© re√ßus sur la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nouvelle architecture du</a> graphique d'amis, sur l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">optimisation du service de cadeaux</a> pour des charges √©lev√©es et sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce qu'il faut faire</a> si vous avez tout optimis√© et que les donn√©es n'atteignent pas l'utilisateur assez rapidement. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461829/">https://habr.com/ru/post/fr461829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461817/index.html">CMake et C ++ - fr√®res pour toujours</a></li>
<li><a href="../fr461819/index.html">Pourquoi la conception d'un site Web simple est meilleure scientifiquement</a></li>
<li><a href="../fr461821/index.html">Une nouvelle immunoth√©rapie a √©limin√© toutes les tumeurs chez une femme atteinte d'un cancer du sein m√©tastatique</a></li>
<li><a href="../fr461823/index.html">Quatre r√®gles am√©lior√©es pour la conception de logiciels</a></li>
<li><a href="../fr461827/index.html">D√©veloppement d'applications hybrides PHP / Go √† l'aide de RoadRunner</a></li>
<li><a href="../fr461831/index.html">StealthWatch: d√©ploiement et personnalisation. 2e partie</a></li>
<li><a href="../fr461833/index.html">Ne vous perdez pas dans trois pins: une repr√©sentation √©gocentrique de l'environnement</a></li>
<li><a href="../fr461835/index.html">Comment les diagrammes de Gantt simplifient et renforcent la gestion de projet</a></li>
<li><a href="../fr461841/index.html">PVS-Studio a examin√© le moteur de puces de Red Dead Redemption</a></li>
<li><a href="../fr461845/index.html">Les investissements en bourse comme moyen de pr√©server les finances: 3 m√©thodes de travail</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>