<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèõÔ∏è üêÖ üë©üèº‚Äçüé® Como e por que escrevemos um servi√ßo escal√°vel altamente carregado para 1C: Enterprise: Java, PostgreSQL, Hazelcast üõ∂ ü§û üëéüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, falaremos sobre como e por que desenvolvemos o Sistema de Intera√ß√£o - um mecanismo que transfere informa√ß√µes entre aplicativos clientes ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como e por que escrevemos um servi√ßo escal√°vel altamente carregado para 1C: Enterprise: Java, PostgreSQL, Hazelcast</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/1c/blog/422903/">  Neste artigo, falaremos sobre como e por que desenvolvemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o Sistema de Intera√ß√£o</a> - um mecanismo que transfere informa√ß√µes entre aplicativos clientes e servidores 1C: Enterprise - desde a defini√ß√£o da tarefa at√© a reflex√£o sobre os detalhes da arquitetura e implementa√ß√£o. <br><br>  O Sistema de Intera√ß√£o (doravante denominado CB) √© um sistema de mensagens distribu√≠do e tolerante a falhas com entrega garantida.  O SV foi projetado como um servi√ßo altamente carregado com alta escalabilidade e est√° dispon√≠vel tanto como um servi√ßo on-line (fornecido pela 1C) quanto como um produto de circula√ß√£o que pode ser implantado nas capacidades de seu servidor. <br><br>  O CB usa o armazenamento distribu√≠do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hazelcast</a> e o mecanismo de pesquisa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Elasticsearch</a> .  Tamb√©m falaremos sobre Java e como dimensionamos o PostgreSQL horizontalmente. <br><img src="https://habrastorage.org/webt/gh/nq/sq/ghnqsqdgkb0i4ze_7ig8blrfilk.png" alt="imagem"><br><a name="habracut"></a><br><br><h2>  Declara√ß√£o do problema </h2><br>  Para esclarecer por que criamos o Sistema de Intera√ß√£o, vou falar um pouco sobre como o desenvolvimento de aplicativos de neg√≥cios na 1C funciona. <br><br>  Para come√ßar, um pouco sobre n√≥s para aqueles que ainda n√£o sabem o que estamos fazendo :) Estamos criando a plataforma de tecnologia 1C: Enterprise.  A plataforma inclui uma ferramenta para o desenvolvimento de aplicativos de neg√≥cios, bem como o tempo de execu√ß√£o, que permite que os aplicativos de neg√≥cios funcionem em um ambiente de plataforma cruzada. <br><br><h3>  Paradigma de desenvolvimento cliente-servidor </h3><br>  Aplicativos de neg√≥cios criados no 1C: Enterprise operam na arquitetura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cliente-servidor de</a> tr√™s n√≠veis ‚ÄúDBMS - application server - client‚Äù.  O c√≥digo do aplicativo escrito no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">idioma incorporado 1C</a> pode ser executado no servidor de aplicativos ou no cliente.  Todo o trabalho com objetos de aplicativo (diret√≥rios, documentos etc.), al√©m da leitura e grava√ß√£o no banco de dados, √© realizado apenas no servidor.  A funcionalidade dos formul√°rios e da interface de comando tamb√©m √© implementada no servidor.  O cliente recebe, abre e exibe formul√°rios, "comunica" com o usu√°rio (avisos, perguntas ...), pequenos c√°lculos em formul√°rios que exigem uma rea√ß√£o r√°pida (por exemplo, multiplicando o pre√ßo pela quantidade), trabalhando com arquivos locais, trabalhando com equipamentos. <br><br>  No c√≥digo do aplicativo, os cabe√ßalhos dos procedimentos e fun√ß√µes devem indicar explicitamente onde o c√≥digo ser√° executado - usando as diretivas &amp; No Cliente / &amp; No Servidor (&amp; AtClient / &amp; AtServer na vers√£o em ingl√™s).  Os desenvolvedores do 1C v√£o me corrigir agora, dizendo que existem realmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais</a> diretivas, mas para n√≥s isso n√£o √© essencial agora. <br><br>  O c√≥digo do servidor pode ser chamado do c√≥digo do cliente, mas o c√≥digo do cliente n√£o pode ser chamado do c√≥digo do servidor.  Essa √© uma limita√ß√£o fundamental que fizemos por v√°rias raz√µes.  Em particular, porque o c√≥digo do servidor deve ser gravado para que seja executado igualmente, independentemente de onde for chamado - do cliente ou do servidor.  E, no caso de chamar o c√≥digo do servidor de outro c√≥digo, o cliente est√° ausente.  E porque durante a execu√ß√£o do c√≥digo do servidor, o cliente que o causou poderia fechar, sair do aplicativo e o servidor n√£o teria para quem ligar. <br><br><img src="https://habrastorage.org/webt/3e/pb/eh/3epbeh_fc7t4yipr5halnamtbmg.png" alt="imagem"><br>  <b>O c√≥digo que processa o clique do bot√£o: a chamada de procedimento do servidor do cliente funcionar√°, a chamada de procedimento do cliente do servidor n√£o</b> <br><br>  Isso significa que, se queremos enviar alguma mensagem para o aplicativo cliente do servidor, por exemplo, que a forma√ß√£o de um relat√≥rio de "reprodu√ß√£o longa" terminou e o relat√≥rio pode ser visualizado, n√£o temos esse m√©todo.  Temos que fazer truques, por exemplo, do c√≥digo do cliente para pesquisar periodicamente o servidor.  Mas essa abordagem carrega o sistema com chamadas desnecess√°rias e, na verdade, n√£o parece muito elegante. <br><br>  Al√©m disso, tamb√©m √© necess√°rio, por exemplo, quando uma chamada telef√¥nica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SIP</a> chegar, notificar o aplicativo cliente sobre o assunto, para que, pelo n√∫mero do chamador, ele o encontre no banco de dados da contraparte e mostre as informa√ß√µes do usu√°rio sobre a contraparte que est√° chamando.  Ou, por exemplo, ap√≥s o recebimento do pedido no armaz√©m, notifique o aplicativo do cliente sobre isso.  Em geral, existem muitos casos em que esse mecanismo seria √∫til. <br><br><h3>  Realmente estadiamento </h3><br>  Crie um mecanismo do sistema de mensagens.  R√°pido, confi√°vel, com entrega garantida, com a capacidade de procurar mensagens de forma flex√≠vel.  Com base no mecanismo, implemente um messenger (mensagens, chamadas de v√≠deo) que funcione dentro dos aplicativos 1C. <br><br>  Projete um sistema escal√°vel horizontalmente.  O aumento da carga deve ser fechado aumentando o n√∫mero de n√≥s. <br><br><h2>  Implementa√ß√£o </h2><br>  Decidimos n√£o incorporar a parte do servidor do SV diretamente na plataforma 1C: Enterprise, mas implement√°-la como um produto separado, cuja API pode ser chamada a partir do c√≥digo do aplicativo 1C.  Isso foi feito por v√°rias raz√µes, a principal delas foi possibilitar o interc√¢mbio de mensagens entre diferentes aplicativos 1C (por exemplo, entre a Administra√ß√£o de Com√©rcio e a Contabilidade).  Aplicativos diferentes da 1C podem ser executados em diferentes vers√µes da plataforma 1C: Enterprise, em diferentes servidores etc.  Em tais condi√ß√µes, a implementa√ß√£o do CB como um produto separado localizado ‚Äúao lado‚Äù das instala√ß√µes da 1C √© a solu√ß√£o ideal. <br><br>  Ent√£o, decidimos fazer o CB como um produto separado.  Para pequenas empresas, recomendamos o uso do servidor CB instalado em nossa nuvem (wss: //1cdialog.com) para evitar a sobrecarga associada √† instala√ß√£o e configura√ß√£o do servidor localmente.  Grandes clientes, no entanto, podem achar apropriado instalar seu pr√≥prio servidor CB em suas instala√ß√µes.  Usamos uma abordagem semelhante em nosso produto SaaS baseado na nuvem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1cFresh</a> - ele √© lan√ßado como um produto de circula√ß√£o para instala√ß√£o pelos clientes e tamb√©m √© implantado em nossa nuvem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://1cfresh.com/</a> . <br><br><h3>  App </h3><br>  Para balanceamento de carga e toler√¢ncia a falhas, implantaremos n√£o um aplicativo Java, mas v√°rios, colocaremos um balanceador de carga na frente deles.  Se voc√™ precisar transferir uma mensagem de n√≥ para n√≥ - use a publica√ß√£o / assinatura no Hazelcast. <br><br>  Comunica√ß√£o do cliente com o servidor - por websocket.  √â adequado para sistemas em tempo real. <br><br><h3>  Cache distribu√≠do </h3><br>  Escolha entre Redis, Hazelcast e Ehcache.  No quintal de 2015.  Redis acaba de lan√ßar um novo cluster (muito novo, assustador), h√° um Sentinel com v√°rias restri√ß√µes.  O Ehcache n√£o sabe como montar em um cluster (essa funcionalidade apareceu mais tarde).  Decidimos tentar com o Hazelcast 3.4. <br>  Hazelcast est√° indo para o cluster fora da caixa.  No modo de n√≥ √∫nico, n√£o √© muito √∫til e pode apenas caber como cache - n√£o sabe como despejar dados no disco, perdeu um √∫nico n√≥ - perdeu dados.  Implementamos v√°rios Hazelcasts entre os quais fazemos backup de dados cr√≠ticos.  O cache n√£o √© de backup - n√£o √© uma pena. <br><br>  Para n√≥s, Hazelcast √©: <br><br><ul><li>  Reposit√≥rio de sess√µes do usu√°rio.  Cada vez que o acesso ao banco de dados para uma sess√£o √© muito longo, colocamos todas as sess√µes no Hazelcast. </li><li>  Cache.  Procurando um perfil de usu√°rio - verifique o cache.  Escreveu uma nova mensagem - coloque-a no cache. </li><li>  T√≥picos para comunicar inst√¢ncias de aplicativos.  Noda gera um evento e o coloca no t√≥pico Hazelcast.  Outros n√≥s de aplicativos inscritos neste t√≥pico recebem e processam o evento. </li><li>  Bloqueios de cluster.  Por exemplo, criamos uma discuss√£o sobre uma chave exclusiva (debate-singleton na estrutura do banco de dados 1C): </li></ul><br><pre><code class="java hljs">conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); doInClusterLock(<span class="hljs-string"><span class="hljs-string">""</span></span>, () -&gt; { conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); createChannel(<span class="hljs-string"><span class="hljs-string">""</span></span>); });</code> </pre> <br>  Verificado se n√£o h√° canal.  Eles pegaram a fechadura, conferiram novamente, criaram.  Se voc√™ n√£o verificar o bloqueio depois de tom√°-lo, h√° uma chance de que outro segmento naquele momento tamb√©m tenha verificado e tentar√° criar a mesma discuss√£o - mas ela j√° existe.  √â imposs√≠vel fazer o bloqueio atrav√©s do java Lock sincronizado ou usual.  Atrav√©s da base - lentamente, e a base √© uma pena, atrav√©s do Hazelcast - do que voc√™ precisa. <br><br><h3>  Escolhendo um DBMS </h3><br>  Temos uma experi√™ncia extensa e bem-sucedida trabalhando com o PostgreSQL e colaborando com os desenvolvedores deste DBMS. <br><br>  O PostgreSQL n√£o √© f√°cil com um cluster - ele possui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XL</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XC</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Citus</a> , mas, em geral, eles n√£o s√£o noSQL, que s√£o escalon√°veis.  O NoSQL n√£o era considerado o reposit√≥rio principal; bastava usarmos o Hazelcast, com o qual n√£o t√≠nhamos trabalhado antes. <br><br>  Como voc√™ precisa dimensionar um banco de dados relacional, isso significa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fragmenta√ß√£o</a> .  Como voc√™ sabe, ao compartilhar, dividimos o banco de dados em partes separadas, para que cada uma delas possa ser movida para um servidor separado. <br><br>  A primeira vers√£o do nosso sharding implicava na capacidade de distribuir cada uma das tabelas do nosso aplicativo para diferentes servidores em diferentes propor√ß√µes.  H√° muitas mensagens no servidor A - por favor, vamos transferir parte desta tabela para o servidor B. Essa solu√ß√£o acabou de gritar sobre otimiza√ß√£o prematura, por isso decidimos nos limitar a uma abordagem de v√°rios locat√°rios. <br><br>  Voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ler</a> sobre v√°rios inquilinos, por exemplo, no site do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Citus Data</a> . <br><br>  No SV, existem conceitos de aplicativo e assinante.  Um aplicativo √© uma instala√ß√£o espec√≠fica de um aplicativo comercial, como ERP ou Contabilidade, com seus usu√°rios e dados corporativos.  Um assinante √© uma organiza√ß√£o ou um indiv√≠duo em nome de quem o aplicativo est√° registrado no servidor CB.  Um assinante pode registrar v√°rios aplicativos, e esses aplicativos podem trocar mensagens entre si.  O assinante tamb√©m se tornou o inquilino em nosso sistema.  Mensagens de v√°rios assinantes podem estar em uma base f√≠sica;  se percebermos que algum assinante come√ßou a gerar muito tr√°fego - n√≥s o levamos para uma base f√≠sica separada (ou mesmo para um servidor de banco de dados separado). <br><br>  Temos um banco de dados principal onde uma tabela de roteamento com informa√ß√µes sobre a localiza√ß√£o de todos os bancos de dados de assinantes √© armazenada. <br><br><img src="https://habrastorage.org/webt/yf/3k/bo/yf3kboqvabg3ljf791sdlpn0zay.png" alt="imagem"><br><br>  Para que o banco de dados principal n√£o seja um gargalo, mantemos a tabela de roteamento (e outros dados solicitados com freq√º√™ncia) no cache. <br><br>  Se o banco de dados do assinante come√ßar a ficar mais lento, n√≥s o dividiremos em parti√ß√µes internas.  Em outros projetos, usamos pg_pathman para particionar tabelas grandes. <br><br>  Como perder mensagens do usu√°rio √© ruim, suportamos nossos bancos de dados com r√©plicas.  A combina√ß√£o de r√©plicas s√≠ncronas e ass√≠ncronas permite que voc√™ esteja seguro em caso de perda do banco de dados principal.  A perda de mensagens ocorrer√° apenas em caso de falha simult√¢nea do banco de dados principal e de sua r√©plica s√≠ncrona. <br><br>  Se a r√©plica s√≠ncrona for perdida, a r√©plica ass√≠ncrona se tornar√° s√≠ncrona. <br>  Se o banco de dados principal for perdido, a r√©plica s√≠ncrona se tornar√° o banco de dados principal, a r√©plica ass√≠ncrona se tornar√° a r√©plica s√≠ncrona. <br><br><h3>  Elasticsearch para pesquisa </h3><br>  Como, entre outras coisas, o CB tamb√©m √© um mensageiro, aqui voc√™ precisa de uma pesquisa r√°pida, conveniente e flex√≠vel, levando em considera√ß√£o a morfologia, por correspond√™ncias imprecisas.  Decidimos n√£o reinventar a roda e usar o mecanismo de pesquisa gratuito Elasticsearch, baseado na biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lucene</a> .  Tamb√©m implantamos o Elasticsearch em um cluster (mestre - dados - dados) para eliminar problemas em caso de falha dos n√≥s do aplicativo. <br><br>  No github, encontramos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plugin da morfologia russa</a> para o Elasticsearch e o usamos.  No √≠ndice Elasticsearch, armazenamos as ra√≠zes das palavras (definidas pelo plug-in) e N-gramas.  √Ä medida que o usu√°rio digita o texto a pesquisar, procuramos o texto digitado entre os N-gramas.  Quando armazenada no √≠ndice, a palavra "textos" ser√° dividida nos seguintes N gramas: <br><br>  [aqueles, tecnologia, tex, texto, textos, ek, eks, ekst, eksts, ks, kst, kst, st, st, voc√™,], <br><br>  E tamb√©m a raiz da palavra "texto" ser√° salva.  Essa abordagem permite pesquisar no in√≠cio, no meio e no final da palavra. <br><br><h2>  Quadro geral </h2><br><img src="https://habrastorage.org/webt/wo/w3/ke/wow3ke8dq1cqrb_ujsjm4uhevfm.png" alt="imagem"><br>  Repetindo a imagem desde o in√≠cio do artigo, mas com explica√ß√µes: <br><br><ul><li>  Balanceador de Internet;  temos nginx, pode ser qualquer um. </li><li>  Inst√¢ncias de aplicativos Java se comunicam atrav√©s do Hazelcast. </li><li>  Para trabalhar com um soquete da Web, usamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Netty</a> . </li><li>  O aplicativo Java escrito em Java 8 consiste em pacotes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">configur√°veis ‚Äã‚ÄãOSGi</a> .  Os planos - migra√ß√£o para Java 10 e transi√ß√£o para m√≥dulos. </li></ul><br><h2>  Desenvolvimento e teste </h2><br>  No processo de desenvolvimento e teste do CB, encontramos v√°rios recursos interessantes dos produtos usados ‚Äã‚Äãpor n√≥s. <br><br><h3>  Teste de carga e vazamentos de mem√≥ria </h3><br>  A libera√ß√£o de cada libera√ß√£o do CB √© um teste de estresse.  Foi bem sucedido quando: <br><br><ul><li>  O teste funcionou por v√°rios dias e n√£o houve nega√ß√£o de servi√ßo </li><li>  O tempo de resposta para as principais opera√ß√µes n√£o excedeu um limite confort√°vel </li><li>  A degrada√ß√£o do desempenho em compara√ß√£o com a vers√£o anterior n√£o √© superior a 10% </li></ul><br>  Enchemos a base de testes com dados - para isso, obtemos informa√ß√µes sobre o assinante mais ativo do servidor de produ√ß√£o, multiplicamos seus n√∫meros por 5 (o n√∫mero de mensagens, discuss√µes, usu√°rios) e, por isso, testamos. <br><br>  Realizamos testes de carga do sistema de intera√ß√£o em tr√™s configura√ß√µes: <br><br><ol><li>  Teste de estresse </li><li>  Apenas conex√µes </li><li>  Registro de Assinante </li></ol><br>  Durante o teste de estresse, iniciamos v√°rias centenas de threads e eles carregam o sistema sem parar: escreva mensagens, crie discuss√µes, obtenha uma lista de mensagens.  Simulamos as a√ß√µes de usu√°rios comuns (obtenha uma lista das minhas mensagens n√£o lidas, escreva para algu√©m) e solu√ß√µes de software (transfira um pacote de uma configura√ß√£o diferente, processe a notifica√ß√£o). <br><br>  Por exemplo, isso faz parte do teste de estresse: <br><br><ul><li>  O usu√°rio efetua login. <br><ul><li>  Solicita discuss√µes n√£o lidas </li><li>  50% de chance de ler mensagens </li><li>  Com 50% de probabilidade, escreve mensagens </li><li>  Pr√≥ximo usu√°rio: <br><ul><li>  Com 20% de probabilidade, cria uma nova discuss√£o. </li><li>  Seleciona aleatoriamente qualquer uma de suas discuss√µes </li><li>  Vai para dentro </li><li>  Solicita mensagens, perfis de usu√°rio </li><li>  Cria cinco mensagens endere√ßadas a usu√°rios aleat√≥rios a partir desta discuss√£o. </li><li>  Fora de discuss√£o </li><li>  Repete 20 vezes </li><li>  Desconecta-se, volta ao in√≠cio do script </li></ul><br></li><li>  O bot de bate-papo entra no sistema (emula a troca de mensagens do c√≥digo de solu√ß√µes aplicadas) <br><br><ul><li>  Com 50% de probabilidade, cria um novo canal para troca de dados (discuss√£o especial) </li><li>  Com uma probabilidade de 50%, escreve uma mensagem em qualquer um dos canais existentes </li></ul><br></li></ul><br></li></ul><br>  O cen√°rio "Somente conex√µes" apareceu por um motivo.  Existe uma situa√ß√£o: os usu√°rios conectaram o sistema, mas ainda n√£o se envolveram.  Cada usu√°rio de manh√£ √†s 09:00 liga o computador, estabelece uma conex√£o com o servidor e fica silencioso.  Esses caras s√£o perigosos, existem muitos deles - dos pacotes eles s√≥ t√™m PING / PONG, mas mant√™m a conex√£o com o servidor (eles n√£o conseguem) - mas de repente uma nova mensagem).  O teste reproduz a situa√ß√£o quando, em meia hora, um grande n√∫mero desses usu√°rios tenta efetuar login no sistema.  Parece um teste de estresse, mas se concentra precisamente nesta primeira entrada - para que n√£o haja falhas (uma pessoa n√£o usa o sistema, mas j√° est√° caindo - √© dif√≠cil encontrar algo pior). <br><br>  O cen√°rio de registro do assinante √© origin√°rio do primeiro lan√ßamento.  Realizamos um teste de estresse e t√≠nhamos certeza de que o sistema n√£o fica lento na correspond√™ncia.  Mas os usu√°rios foram e o registro come√ßou a cair em um tempo limite.  Ao se registrar, usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">/ dev / random</a> , que est√° vinculado √† entropia do sistema.  O servidor n√£o conseguiu acumular entropia suficiente e congelou por dezenas de segundos ao solicitar um novo SecureRandom.  Existem v√°rias maneiras de sair dessa situa√ß√£o, por exemplo: alterne para o menos seguro / dev / urandom, coloque um quadro especial que gere entropia, gere n√∫meros aleat√≥rios antecipadamente e armazene no pool.  Encerramos temporariamente o problema com um pool, mas desde ent√£o executamos um teste separado para registrar novos assinantes. <br><br>  Como gerador de carga, usamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JMeter</a> .  Ele n√£o sabe trabalhar com um soquete da Web; √© necess√°rio um plug-in.  O primeiro nos resultados de pesquisa para "jmeter websocket" s√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigos com BlazeMeter</a> , que recomendam um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug-in de Maciej Zaleski</a> . <br><br>  Com ele, decidimos come√ßar. <br><br>  Quase imediatamente ap√≥s o in√≠cio de testes s√©rios, descobrimos que vazamentos de mem√≥ria come√ßaram no JMeter. <br><br>  O plugin √© uma grande hist√≥ria separada, com 176 estrelas e 132 garfos no github.  O pr√≥prio autor n√£o se comprometeu com ele desde 2015 (o levamos em 2015, ent√£o isso n√£o levantou suspeitas), v√°rios problemas do github sobre vazamentos de mem√≥ria, 7 solicita√ß√µes de recebimento n√£o fechadas. <br>  Se voc√™ decidir realizar testes de carga com este plug-in, preste aten√ß√£o √†s seguintes discuss√µes: <br><br><ol><li>  Em um ambiente multithread, o LinkedList usual foi usado; como resultado, eles receberam o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NPE</a> em tempo de execu√ß√£o.  √â resolvido alternando para ConcurrentLinkedDeque ou por blocos sincronizados.  Eles escolheram a primeira op√ß√£o para eles mesmos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/43</a> ). </li><li>  O vazamento de mem√≥ria, a desconex√£o n√£o exclui as informa√ß√µes de conex√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/44</a> ). </li><li>  No modo de streaming (quando o soquete da Web n√£o fecha no final da amostra, mas √© usado mais adiante no plano), os padr√µes de Resposta ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/19</a> ) n√£o funcionam. </li></ol><br>  Este √© um daqueles no github.  O que fizemos: <br><br><ol><li>  Eles pegaram o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">garfo Elyran Kogan</a> (@elyrank) - os problemas 1 e 3 foram corrigidos </li><li>  Problema resolvido 2 </li><li>  Pont√£o atualizado de 9.2.14 a 9.3.12 </li><li>  SimpleDateFormat embrulhado em ThreadLocal;  SimpleDateFormat n√£o √© seguro para threads, o que levou ao tempo de execu√ß√£o do NPE </li><li>  Eliminado mais um vazamento de mem√≥ria (a conex√£o foi fechada incorretamente quando desconectada) </li></ol><br>  E ainda assim flui! <br><br>  A mem√≥ria come√ßou a terminar n√£o em um dia, mas em dois.  N√£o havia absolutamente tempo, eles decidiram executar menos threads, mas com quatro agentes.  Isso deveria ter sido suficiente por pelo menos uma semana. <br><br>  Dois dias se passaram ... <br><br>  Agora a mem√≥ria come√ßou a se esgotar no Hazelcast.  Ficou evidente nos logs que, ap√≥s alguns dias de teste, o Hazelcast come√ßa a reclamar de falta de mem√≥ria e, ap√≥s algum tempo, o cluster se desfaz e os n√≥s continuam morrendo individualmente.  Conectamos o JVisualVM ao hazelcast e vimos uma ‚Äúserra ascendente‚Äù - ele ligava regularmente para GC, mas n√£o conseguia limpar sua mem√≥ria. <br><br><img src="https://habrastorage.org/webt/ha/uc/5y/hauc5ydqebpmxtfirqalulaandi.png" alt="imagem"><br><br>  Aconteceu que no hazelcast 3.4, ao remover map / multiMap (map.destroy ()), a mem√≥ria n√£o √© completamente liberada: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/hazelcast/hazelcast/issues/6317</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/hazelcast/hazelcast/issues/4888</a> <br><br>  Agora o bug foi corrigido na vers√£o 3.5, mas foi um problema.  Criamos um novo multiMap com nomes din√¢micos e exclu√≠dos de acordo com nossa l√≥gica.  O c√≥digo tinha algo parecido com isto: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.put(auth.getUserId(), auth); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.remove(auth.getUserId(), auth); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessions.size() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sessions.destroy(); } }</code> </pre> <br>  Ligue para: <br><br><pre> <code class="java hljs">service.join(auth1, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>); service.join(auth2, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>);</code> </pre> <br>  O multiMap foi criado para cada assinatura e exclu√≠do quando n√£o era necess√°rio.  Decidimos que iniciaremos o Map &lt;String, Set&gt;, a chave ser√° o nome da assinatura e os valores ser√£o os identificadores das sess√µes (das quais voc√™ poder√° obter os IDs do usu√°rio, se necess√°rio). <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ addValueToMap(sub, auth.getSessionId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ removeValueFromMap(sub, auth.getSessionId()); }</code> </pre> <br>  Gr√°ficos endireitados. <br><br><img src="https://habrastorage.org/webt/li/_z/ai/li_zaiochcpbgvviybycfvzslz4.png" alt="imagem"><br><br><h4>  O que mais aprendemos sobre o teste de estresse </h4><br><ol><li>  O JSR223 precisa ser gravado no cache de compila√ß√£o groovy e ativado - isso √© muito mais r√°pido.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link</a> </li><li>  Os gr√°ficos Jmeter-Plugins s√£o mais f√°ceis de entender do que o padr√£o.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link</a> </li></ol><br><br><h3>  Sobre nossa experi√™ncia com Hazelcast </h3><br>  O Hazelcast era um produto novo para n√≥s. Come√ßamos a trabalhar com ele a partir da vers√£o 3.4.1, agora nosso servidor de produ√ß√£o possui a vers√£o 3.9.2 (no momento da reda√ß√£o deste artigo, a vers√£o mais recente do Hazelcast √© a 3.10). <br><br><h4>  Gera√ß√£o de ID </h4><br>  Come√ßamos com identificadores inteiros.  Vamos imaginar que precisamos de outro Long para uma nova entidade.  A sequ√™ncia n√£o se encaixa no banco de dados, as tabelas participam do sharding - acontece que h√° um ID da mensagem = 1 no DB1 e um ID da mensagem = 1 no DB2, voc√™ n√£o pode colocar esse ID no Elasticsearch, no Hazelcast, mas o pior √© se voc√™ deseja reduzir os dados de dois bancos de dados em um (por exemplo, decidir que um banco de dados √© suficiente para esses assinantes).  Voc√™ pode criar v√°rios AtomicLongs no Hazelcast e manter o contador l√°; o desempenho da obten√ß√£o de um novo ID √© incrementAndGet mais o tempo para uma solicita√ß√£o no Hazelcast.  Mas h√° algo mais ideal no Hazelcast - FlakeIdGenerator.  Cada cliente recebe um intervalo de ID no contato, por exemplo, o primeiro de 1 a 10.000, o segundo de 10.001 a 20.000 e assim por diante.  Agora o cliente pode emitir novos identificadores de forma independente at√© o intervalo emitido para ele terminar.  Funciona rapidamente, mas quando voc√™ reinicia o aplicativo (e o cliente Hazelcast), uma nova sequ√™ncia come√ßa - da√≠ as lacunas etc.  Al√©m disso, os desenvolvedores n√£o sabem muito bem por que os IDs s√£o inteiros, mas s√£o t√£o diferentes.  Todos n√≥s pesamos e mudamos para UUIDs. <br><br>  A prop√≥sito, para quem quer ser como o Twitter, existe uma biblioteca do Snowcast - essa √© uma implementa√ß√£o do Snowflake sobre o Hazelcast.  Voc√™ pode v√™-lo aqui: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/noctarius/snowcast</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/twitter/snowflake</a> <br><br>  Mas n√£o alcan√ßamos as m√£os dela. <br><br><h4>  TransactionalMap.replace </h4><br>  Outra surpresa: TransactionalMap.replace n√£o est√° funcionando.  Aqui est√° um teste: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap_putsAndGetsInsideTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).put(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>); context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>, <span class="hljs-string"><span class="hljs-string">"newValue"</span></span>); String value = (String) context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).get(<span class="hljs-string"><span class="hljs-string">"key"</span></span>); assertEquals(<span class="hljs-string"><span class="hljs-string">"newValue"</span></span>, value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); } Expected : newValue Actual : oldValue</code> </pre> <br>  Eu tive que escrever minha substitui√ß√£o usando getForUpdate: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> &lt;K,V&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String mapName, K key, V oldValue, V newValue)</span></span></span><span class="hljs-function"> </span></span>{ TransactionalTaskContext context = HazelcastTransactionContextHolder.getContext(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a transactional map"</span></span>); TransactionalMap&lt;K, V&gt; map = context.getMap(mapName); V value = map.getForUpdate(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldValue.equals(value)) { map.put(key, newValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a not transactional map"</span></span>); IMap&lt;K, V&gt; map = hazelcastInstance.getMap(mapName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.replace(key, oldValue, newValue); }</code> </pre> <br>  Teste n√£o apenas estruturas de dados regulares, mas tamb√©m suas vers√µes transacionais.  Acontece que o IMap funciona, mas o TransactionalMap se foi. <br><br><h4>  Anexe novo JAR sem tempo de inatividade </h4><br>  Primeiro, decidimos gravar objetos de nossas aulas no Hazelcast.  Por exemplo, temos uma classe Application, queremos salvar e ler.  Salvar: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); map.set(id, application);</code> </pre> <br>  Lemos: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.get(id);</code> </pre> <br>  Tudo funciona.  Decidimos criar um √≠ndice no Hazelcast para procur√°-lo: <br><br><pre> <code class="java hljs">map.addIndex(<span class="hljs-string"><span class="hljs-string">"subscriberId"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre> <br>  E ao escrever uma nova entidade, eles come√ßaram a receber uma ClassNotFoundException.  O Hazelcast tentou suplementar o √≠ndice, mas n√£o sabia nada sobre a nossa classe e queria que ele tivesse um JAR com essa classe.  Fizemos isso, tudo funcionou, mas apareceu um novo problema: como atualizar o JAR sem parar o cluster completamente?  O Hazelcast n√£o pega o novo JAR durante uma atualiza√ß√£o em n√≠vel de pod.  Nesse momento, decidimos que poder√≠amos viver muito bem sem pesquisar por √≠ndice.  Afinal, se voc√™ usar o Hazelcast como um armazenamento de valor-chave, tudo funcionar√°?  Na verdade n√£o.  Aqui, novamente, o comportamento diferente do IMap e do TransactionalMap.  Onde o IMap n√£o importa, o TransactionalMap gera um erro. <br><br>  IMap  N√≥s escrevemos 5000 objetos, lemos.  Tudo √© esperado. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get5000</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); UUID subscriberId = UUID.randomUUID(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5000</span></span>; i++) { UUID id = UUID.randomUUID(); String title = RandomStringUtils.random(<span class="hljs-number"><span class="hljs-number">5</span></span>); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, title, subscriberId); map.set(id, application); Application retrieved = map.get(id); assertEquals(id, retrieved.getId()); } }</code> </pre> <br>  E n√£o funciona na transa√ß√£o, obtemos uma ClassNotFoundException: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_transaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); UUID subscriberId = UUID.randomUUID(); UUID id = UUID.randomUUID(); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, <span class="hljs-string"><span class="hljs-string">"qwer"</span></span>, subscriberId); map.set(id, application); Application retrievedOutside = map.get(id); assertEquals(id, retrievedOutside.getId()); hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { TransactionalMap&lt;UUID, Application&gt; transactionalMap = context.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); Application retrievedInside = transactionalMap.get(id); assertEquals(id, retrievedInside.getId()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); }</code> </pre> <br>  Em 3.8, o mecanismo de implanta√ß√£o de classe de usu√°rio apareceu.  Voc√™ pode atribuir um n√≥ principal e atualizar o arquivo JAR nele. <br><br>  Agora, mudamos completamente a abordagem: a serializamos em JSON e a salvamos no Hazelcast.  O Hazelcast n√£o precisa conhecer a estrutura de nossas classes, mas podemos atualizar sem tempo de inatividade.  O controle de vers√£o dos objetos de dom√≠nio √© controlado pelo aplicativo.  Vers√µes diferentes do aplicativo podem ser iniciadas ao mesmo tempo, e √© poss√≠vel que um novo aplicativo grave objetos com novos campos, mas o antigo n√£o conhece esses campos.  E, ao mesmo tempo, o novo aplicativo l√™ objetos registrados pelo aplicativo antigo, nos quais n√£o h√° novos campos.  Lidamos com essas situa√ß√µes dentro do aplicativo, mas, por simplicidade, n√£o alteramos nem exclu√≠mos campos, apenas estendemos as classes adicionando novos campos. <br><br><h3>  Como fornecemos alto desempenho </h3><br><h4>  Quatro viagens ao Hazelcast - boas, duas ao banco de dados - ruins </h4><br>  Acessar dados no cache √© sempre melhor do que no banco de dados, mas voc√™ n√£o deseja armazenar registros n√£o reclamados.  A decis√£o sobre o que armazenar em cache, adiamos para o √∫ltimo est√°gio de desenvolvimento.  Quando a nova funcionalidade √© codificada, ativamos o PostgreSQL para registrar todas as consultas (log_min_duration_statement para 0) e executar o teste de carga por 20 minutos.Usando logs coletados, utilit√°rios como pgFouine e pgBadger podem criar relat√≥rios anal√≠ticos.  Nos relat√≥rios, procuramos principalmente consultas lentas e frequentes.  Para consultas lentas, criamos um plano de execu√ß√£o (EXPLAIN) e avaliamos se essa consulta pode ser acelerada.  Solicita√ß√µes frequentes para os mesmos dados de entrada s√£o bem armazenadas em cache.  Tentamos manter as solicita√ß√µes "planas", uma tabela por solicita√ß√£o. <br><br><h2>  Opera√ß√£o </h2><br>  O SV como servi√ßo on-line foi lan√ßado na primavera de 2017, e um produto SV separado foi lan√ßado em novembro de 2017 (naquele momento, no status beta). <br><br>  Em mais de um ano de opera√ß√£o, n√£o ocorreram problemas graves na opera√ß√£o do servi√ßo online da CB.  Monitoramos o servi√ßo online atrav√©s do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Zabbix</a> , coletamos e implantamos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bamboo</a> . <br><br>  O kit de distribui√ß√£o do servidor CB √© entregue na forma de pacotes nativos: RPM, DEB, MSI.  Al√©m disso, para Windows, fornecemos um √∫nico instalador na forma de um EXE, que instala o servidor Hazelcast e Elasticsearch em uma m√°quina.  Inicialmente, chamamos essa vers√£o da instala√ß√£o de "demo", mas agora ficou claro que esta √© a op√ß√£o de implanta√ß√£o mais popular. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt422903/">https://habr.com/ru/post/pt422903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt422893/index.html">Guia do Node.js, parte 1: informa√ß√µes gerais e introdu√ß√£o</a></li>
<li><a href="../pt422895/index.html">Google quer matar URLs</a></li>
<li><a href="../pt422897/index.html">Ruim, mas meu: como escrever CSS realmente horr√≠vel</a></li>
<li><a href="../pt422899/index.html">Sob supervis√£o vigilante: como monitorar tarifas hoster e manter o cat√°logo VPS atualizado</a></li>
<li><a href="../pt422901/index.html">Um monitor de freq√º√™ncia card√≠aca para Putin, ou o que √© um Ritmer</a></li>
<li><a href="../pt422905/index.html">Mas voc√™ diz que Ceph ... ele √© t√£o bom?</a></li>
<li><a href="../pt422907/index.html">Refer√™ncia r√°pida do aspirador de p√≥ 2018</a></li>
<li><a href="../pt422909/index.html">Os 10 v√≠deos retro talk mais populares do 404 Festival</a></li>
<li><a href="../pt422915/index.html">Estou procurando um idoso sem escrit√≥rio e cookies: como organizamos uma pesquisa por funcion√°rios 100% remotos</a></li>
<li><a href="../pt422917/index.html">N√£o tenho boca, mas tenho que gritar. Reflex√µes sobre IA e √©tica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>