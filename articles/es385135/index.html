<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåó üóëÔ∏è üëá Hidropon√≠a en el alf√©izar de una ventana o C ++ 11 en microcontroladores AVR üö° üÜé üï£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El proyecto no contiene Arduino.
 
 
 Originalmente, se supon√≠a que este proyecto ten√≠a un aspecto diferente: una estructura monumental que consiste e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hidropon√≠a en el alf√©izar de una ventana o C ++ 11 en microcontroladores AVR</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/385135/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El proyecto no contiene Arduino.</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/911/af2/659/911af265948b47c6933b93c9ff846e34.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Originalmente, se supon√≠a que este proyecto ten√≠a un aspecto diferente: una estructura monumental que consiste en un pedestal con latas y bombas, un acuario montado en √©l y un oasis de tomate en la parte superior. Se plane√≥ una cascada en el para√≠so de un oasis de tomate, y se forman peces en el acuario, cuyo principal requisito era la capacidad de comer a los habitantes no planificados del acuario y mantener limpio el vidrio; Los principales candidatos son Somiki y Gourami. Como habr√°s adivinado, mi lema es "la pereza es el motor del progreso" (y qu√© puedes hacer para no limpiar el acuario y no regar los tomates).</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablemente se habr√≠a erigido un monumento a este lema si a√∫n no se hubiera derrumbado en la etapa de coordinaci√≥n de bosquejos con su esposa. No se inspir√≥ en la idea de hacer de esta bandura la decoraci√≥n principal de la sala de estar, e incluso la cascada no la convenci√≥ de esto. Pero la idea de un sistema aut√≥nomo, una simbiosis de biolog√≠a y electr√≥nica, no quer√≠a salir volando de mi cabeza, y el proyecto se redujo al tama√±o de una maceta: la acuapon√≠a se convirti√≥ en hidropon√≠a, se salvaron vidas de peces.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea principal de la hidropon√≠a es el uso de una soluci√≥n acuosa de nutrientes en lugar de tierra. Esto permite un orden de magnitud para acelerar el crecimiento de las plantas. Sin embargo, uno no puede simplemente bajar las ra√≠ces al agua: necesitan ox√≠geno, sin el cual comenzar√°n a morir. A este respecto, hay opciones: soplar agua constantemente con un compresor, como en un acuario, o peri√≥dicamente inundar las ra√≠ces con una soluci√≥n nutritiva y drenarla despu√©s de un tiempo. La primera opci√≥n tiene un inconveniente: el zumbido constante del compresor. La segunda opci√≥n tiene una ventaja: la mayor√≠a de las ra√≠ces est√°n en el aire, respirando activamente, y el efecto de acelerar el crecimiento deber√≠a ser a√∫n mayor. Adem√°s, se sumergen en un sustrato de gr√°nulos porosos especiales que retienen la humedad. La elecci√≥n era obvia, tom√© la segunda opci√≥n como base.En el caso de los peces, el sistema podr√≠a estar casi completamente cerrado: las secreciones de peces son procesadas por bacterias especiales en un biofiltro, el producto procesado se alimenta a las plantas, una capa de arena filtra el agua y el agua limpia se devuelve al acuario. En un caso ideal, el alimento se espolvorea ocasionalmente en un alimentador autom√°tico y los tomates se juntan de los arbustos. Pero no creci√≥ juntos, tal vez sea para mejor, qui√©n sabe c√≥mo terminar√≠a el pedido por correo de una cepa de las bacterias necesarias.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, el dispositivo de la planta de tomate tom√≥ contornos. </font><font style="vertical-align: inherit;">Dos recipientes: el inferior con agua, el superior con un sustrato y una planta. </font><font style="vertical-align: inherit;">Para inundaciones usaremos una peque√±a bomba china con un motor DC, para drenaje utilizaremos un sif√≥n autom√°tico. </font><font style="vertical-align: inherit;">El principio de funcionamiento del sif√≥n en el video:</font></font><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/5wZ9PQepQYI%3Ffeature%3Doembed&amp;usg=ALkJrhhE9Wn4qJewggmxeOYpr0qWbTtHKg" frameborder="0" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hidropon√≠a con un sif√≥n similar:</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/ZHaiVhVZ3kM%3Ffeature%3Doembed&amp;usg=ALkJrhjeYWTCNwrQLlBcSHQU_X0cQvx7xw" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El cerebro del dispositivo es el microcontrolador ATMEGA328P (simplemente porque el placer estaba a la mano). Sus tareas incluyen gestionar las inundaciones y descargas de acuerdo con un cronograma, monitorear el nivel de agua en el tanque y se√±alar su falta, controlar la iluminaci√≥n de la planta (queremos tener una cierta longitud m√≠nima de luz del d√≠a; cuando la luz natural termina, la iluminaci√≥n artificial se enciende gradualmente), una interfaz de usuario para ver El estado, la gesti√≥n y la configuraci√≥n de toda esta econom√≠a. Obviamente, esto requiere alg√∫n tipo de soluci√≥n para el sensor de nivel de agua, sensores de luz, un reloj en tiempo real y alg√∫n tipo de terminal de usuario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de describir los detalles, una lista de recursos del proyecto: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede ver fotos del resultado y el proceso de fabricaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Video corto:</font></font><br>
<br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/C_qit2_2rrY%3Ffeature%3Doembed&amp;usg=ALkJrhjD_gzP7yRMTrBxi0qeBMU4_hQgEA" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El proyecto est√° disponible en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All√≠, en los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lanzamientos, se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> presenta </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">un</font></a><font style="vertical-align: inherit;"> archivo con el proyecto de pieza electr√≥nica en KiCAD y los proyectos de campanas y silbatos de dise√±o en SolidWorks (se adjuntan archivos STL para imprimir).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caracter√≠sticas del ensamblaje de firmware</font></font></b><div class="spoiler_text">      ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>    ¬´ ¬ª.    ,   , ,        USB    AVR (,   ,    ,     ,      ),               .  -    ,     ,    'ADK_ROOT'     ,        'scons'.<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esquema de la parte electr√≥nica: </font></font><br>
<br>
<img src="https://habrastorage.org/files/cfc/96b/dad/cfc96bdad51648caa640d661ac6ffc40.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
m√°s detalles, una descripci√≥n de las trampas y un poco de c√≥digo. </font><font style="vertical-align: inherit;">Descripci√≥n de los problemas de software </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al final</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Quiz√°s alguien est√© interesado en ver un nuevo ejemplo de trabajo con I2C, un valcoder, un m√≥dulo RTC y una pantalla gr√°fica. </font><font style="vertical-align: inherit;">Todo el c√≥digo en el proyecto fue escrito "desde cero" sin usar soluciones de terceros (porque puedo).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor de nivel de agua</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tema m√°s delicado se decidi√≥ primero. Hab√≠a, por supuesto, una variante de alg√∫n tipo de flotador para que, por ejemplo, moviera el riel en el que se aplicaba el c√≥digo Gray y se leyeran los sensores √≥pticos. Pero realmente no parec√≠a confiable. La b√∫squeda en eBay no dio resultado: hubo interruptores de flotador (se alcanz√≥ o no el nivel deseado), o electrodos sumergidos y lecturas basadas en la conductividad del medio, pero esto se observ√≥ de inmediato, ya que la composici√≥n del agua cambiar√≠a constantemente junto con la conductividad de los fertilizantes agregados y la disoluci√≥n. impurezas del sustrato. Como resultado, surgi√≥ la idea de utilizar un tel√©metro ultras√≥nico, uno de los que generalmente se colocan en diferentes robots. Seg√∫n lo planeado, el sensor se coloca en la tapa del tanque y la se√±al se refleja directamente desde la superficie del agua. Se compr√≥ HC-SR04 (la elecci√≥n del valor m√°s peque√±o de la distancia m√≠nima de trabajo, tiene 2 cm),y el concepto fue revisado en un balde de agua. Result√≥ que funcionaba por s√≠ mismo (exist√≠a el temor de que no hubiera un reflejo normal de la superficie del agua, o que no hubiera suficiente directividad del haz y hubiera reflejos no deseados de las paredes del tanque). Por cierto, el tel√©metro tambi√©n era una opci√≥n de respaldo, pero infrarrojo. En la superficie del agua se supon√≠a que arrojar√≠a un flotador con un reflector. El √∫nico problema es su distancia m√≠nima de trabajo de 10 cm (de los que encontr√©), que ya es un poco demasiado para las dimensiones dadas.En la superficie del agua se supon√≠a que arrojar√≠a un flotador con un reflector. El √∫nico problema es su distancia m√≠nima de trabajo de 10 cm (de los que encontr√©), que ya es un poco demasiado para las dimensiones dadas.En la superficie del agua se supon√≠a que arrojar√≠a un flotador con un reflector. El √∫nico problema es su distancia m√≠nima de trabajo de 10 cm (de los que encontr√©), que ya es un poco demasiado para las dimensiones dadas.</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee1/7ac/b85/ee17acb8500c4a94b65014c08d3df694.jpg"><br>
<img src="https://habrastorage.org/files/cd2/558/d46/cd2558d46164418f95b883a60c20c213.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n los resultados del proyecto, este enfoque est√° funcionando y se puede utilizar en la pr√°ctica, no se notaron problemas. Vale la pena tomar medidas para aislar la placa de la humedad (sellado en el estuche). Esos son solo los sensores que permanecen abiertos, tal vez a√∫n se da la vuelta.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La interfaz del sensor es simple: se env√≠a un pulso a la entrada de activaci√≥n, que activa una se√±al de eco. Se genera un pulso en la salida de eco, cuya longitud es igual al tiempo desde el comienzo de la radiaci√≥n hasta la aceptaci√≥n de la se√±al de eco reflejada. Al medir la longitud del pulso, conocer la velocidad del sonido y el hecho de que la se√±al va al objeto y viceversa, puede calcular la distancia. En el proyecto, esto se implementa en la clase LevelGauge. Para medir la longitud del pulso, se utiliza la capacidad de hardware de la "captura de entrada" MK AVR. En este caso, el temporizador de hardware se restablece en el borde ascendente del pulso, y en el valor descendente del temporizador, el hardware se almacena en el registro ICR1 y se genera una interrupci√≥n. Por lo tanto, es posible medir la duraci√≥n del pulso con suficiente precisi√≥n y un consumo m√≠nimo de tiempo de procesador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso con este modelo del sensor, se not√≥ una falla: cuando se aplic√≥ la energ√≠a, la l√≠nea de eco permaneci√≥ constantemente activa. </font><font style="vertical-align: inherit;">Pas√≥ por alto aplicando un pulso al gatillo y esperando hasta que pasara el primer ciclo de localizaci√≥n del eco.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iluminar desde el fondo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La retroiluminaci√≥n est√° compuesta por tres LED de agarre. </font><font style="vertical-align: inherit;">Dobl√© el marco triangular del perfil de aluminio, pegu√© los LED con epoxi. </font><font style="vertical-align: inherit;">Ped√≠ un estabilizador de corriente chino a 700mA para poder. </font><font style="vertical-align: inherit;">Alrededor de tres voltios caen en cada diodo, el estabilizador requiere una diferencia entre los voltajes de entrada y salida de al menos dos voltios, e iba a alimentar todo el wunderwafer desde una fuente de alimentaci√≥n de 12 voltios. </font><font style="vertical-align: inherit;">Desde aqu√≠ es f√°cil calcular por qu√© exactamente tres LED.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los diodos son de color blanco c√°lido. Me pareci√≥ natural, el espectro solar y todo eso. Pero como descubr√≠ m√°s tarde, despu√©s de ordenarlos, las plantas generalmente usan una combinaci√≥n de rojo y azul. Por lo que yo entiendo, toda la cuesti√≥n es solo de eficiencia. Si tiene una granja grande con iluminaci√≥n las 24 horas, le interesa que toda la energ√≠a gastada se gaste para siempre. Bajo iluminaci√≥n blanca, las hojas verdes reflejar√°n el componente verde, una parte significativa de la energ√≠a gastada en iluminaci√≥n se desperdiciar√°.</font></font><br>
<br>
<img src="https://habrastorage.org/files/b75/39b/561/b7539b5610cf43039f95a393567ce5ce.jpg"><br>
<img src="https://habrastorage.org/files/6e3/a21/084/6e3a2108427a44518658b276d5affe3c.JPG"><br>
<img src="https://habrastorage.org/files/1af/253/8d1/1af2538d188c4dfe962d915a09bb2fba.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una caracter√≠stica importante del estabilizador es la presencia de una entrada para la regulaci√≥n PWM, que uso para ajustar el brillo. Aqu√≠ hay otro rastrillo chino. En primer lugar, result√≥ ser solo una funci√≥n de encendido / apagado actual. Es decir, esperaba que la corriente de salida no se modulara, y su valor depender√≠a del ciclo de trabajo de la se√±al PWM, pero la corriente simplemente repiti√≥ los pulsos en la entrada de control. Pero esto no es tan malo, otra emboscada fue que el regulador reacciona de manera inadecuada a PWM con una frecuencia bastante alta. Tuve que bajarlo a 300Hz, en el que funcion√≥ m√°s o menos normalmente. La se√±al PWM es generada por el microcontrolador en el hardware utilizando uno de los temporizadores.</font></font><br>
<br>
<img src="https://habrastorage.org/files/fde/4a1/3d6/fde4a13d69f04e909fe2fafbcb526ed4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra parte importante del conjunto de retroiluminaci√≥n son los sensores de luz. Los fototransistores fueron seleccionados en este papel. Y s√≠, hay dos: uno encima de los LED para medir la luz natural, el segundo debajo de los LED para proporcionar informaci√≥n. Es cierto que la funcionalidad de extensi√≥n autom√°tica de la luz del d√≠a a√∫n no se ha implementado, como lo fue en el verano, y no era necesaria (y la motivaci√≥n es un asunto serio). Se supuso que tan pronto como el primer sensor detecta una disminuci√≥n en el nivel de iluminaci√≥n (y el tiempo asignado para las horas de luz a√∫n no ha expirado), la luz se regula para que el segundo sensor produzca un nivel correspondiente a la iluminaci√≥n deseada. Para hacer esto, debe implementar un controlador PID simple en el c√≥digo. Pero mientras est√° en la interfaz, solo puede ver las lecturas actuales del sensor y enrollar manualmente el brillo de la luz de fondo deseada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presta atenci√≥n a la conexi√≥n de los sensores. </font><font style="vertical-align: inherit;">Cada uno de ellos tiene dos rangos fijos, que se seleccionan conectando a cero la resistencia correspondiente. </font><font style="vertical-align: inherit;">El pie del microcontrolador, conectado a la segunda resistencia, en este momento se transfiere a un estado de alta resistencia. </font><font style="vertical-align: inherit;">Puede encender ambas resistencias simult√°neamente, luego habr√° tres rangos de medici√≥n fijos. </font><font style="vertical-align: inherit;">La se√±al de las resistencias del emisor se pasa a trav√©s de un circuito RC para filtrar los pulsos de modulaci√≥n: la luz de los LED pulsa junto con la se√±al PWM en el regulador de corriente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bomba</font></font></h4><br>
<img src="https://habrastorage.org/files/a13/933/895/a13933895d9f4546a4ab7e54e87c056b.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El equipo chino m√°s barato, con motor de corriente continua. </font><font style="vertical-align: inherit;">Las emboscadas, por supuesto, est√°n disponibles. </font><font style="vertical-align: inherit;">A pesar de que dice 12V, no funciona durante mucho tiempo a este voltaje. </font><font style="vertical-align: inherit;">Uno se quem√≥ antes del montaje de la estructura. </font><font style="vertical-align: inherit;">El esquema proporciona PWM para ello, la potencia m√°xima se configura en la interfaz, en la pr√°ctica no se estableci√≥ por encima del 70%. </font><font style="vertical-align: inherit;">Ya a este nivel, a√∫lla salvajemente en el trabajo, pero la mayor√≠a de las veces trabaja a una potencia mucho menor, alrededor del 30% y retumba en silencio. </font><font style="vertical-align: inherit;">Sobre sus modos de funcionamiento a continuaci√≥n, en la descripci√≥n de la l√≥gica de las inundaciones. </font><font style="vertical-align: inherit;">El condensador m√°s grande (C8 en el diagrama) debe colocarse m√°s cerca del circuito de alimentaci√≥n de la bomba, de lo contrario habr√° una gran interferencia en todo el circuito (en la pr√°ctica, result√≥ que el regulador de corriente para los LED es m√°s sensible a ellos, comienza la m√∫sica ligera).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reloj en tiempo real</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hab√≠a una idea loca de usar los recursos del microcontrolador para estos fines. El generador de reloj de cuarzo tiene una precisi√≥n bastante buena, en otro proyecto este enfoque funcion√≥ bien. Pero el problema es que absolutamente todos los temporizadores de hardware ya se tomaron para otros fines. No hab√≠a m√°s remedio que encontrar el m√≥dulo RTC externo. Elogie a los chinos, est√°n all√≠ y son baratos. </font></font><br>
<br>
<img src="https://habrastorage.org/files/16f/8e2/404/16f8e24047b9445f969a1d1e9333b4bc.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El m√≥dulo basado en el DS3231 tiene una interfaz I2C, su propia fuente de alimentaci√≥n redundante: el tiempo no fallar√° con el apag√≥n. Hay una salida de meandro en varias frecuencias fijas: 1 kHz, 4 kHz y 8 kHz. Esto fue muy √∫til para las se√±ales de audio; de nuevo, no es necesario cargar la MCU y no hab√≠a temporizadores libres para esto. La EEPROM de 32Kbit es una ventaja, pero no se usa en este proyecto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sorprendentemente, es muy preciso: en unos meses perdi√≥ su fuerza durante varios segundos. </font><font style="vertical-align: inherit;">Afirm√≥ que tiene en cuenta la influencia de la temperatura en la frecuencia del generador, y aparentemente esto funciona. </font><font style="vertical-align: inherit;">Sin embargo, si el tiempo pasa, existe la posibilidad de correcci√≥n de frecuencia de software. </font><font style="vertical-align: inherit;">Las lecturas del sensor de temperatura est√°n disponibles, y en este proyecto se muestran en la interfaz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clase Rtc es responsable de trabajar con este m√≥dulo en el c√≥digo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace tiempo que quer√≠a hacer algo con una pantalla gr√°fica. </font><font style="vertical-align: inherit;">La b√∫squeda del m√°s barato con la interfaz I2C le dio esta opci√≥n.</font></font><br>
<br>
<img src="https://habrastorage.org/files/629/1fb/ecc/6291fbeccac04dfe854f3a3e45b2a2a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pantalla OLED monocrom√°tica de 128x64 p√≠xeles basada en el popular controlador SSD1306. Al elegir, debe mirar detenidamente la descripci√≥n: el mismo chip admite otras interfaces, excepto I2C, y hay opciones sin √©l. O escriben que es universal, tambi√©n es compatible con I2C, pero en realidad ser√° necesario modificar ligeramente la placa reorganizando los valores nulos a otros sitios. Por lo tanto, si planea usar I2C, es mejor elegir uno donde solo se muestre I2C en la placa, habr√° menos problemas con una placa que no tiene casi ninguna documentaci√≥n (documentaci√≥n solo para el chip). Esta versi√≥n funciona desde 5V, la placa tiene un regulador de 3.3V requerido para el controlador. Me encontr√© con cr√≠ticas que en algunas versiones pueden no serlo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La pantalla est√° generalmente satisfecha. Solo not√© una caracter√≠stica desagradable: el brillo de una fila de p√≠xeles depende de cu√°ntos p√≠xeles se iluminen. Cuanto m√°s iluminado, menor es el brillo. El contraste entre las l√≠neas puede ser notable si se alternan √°reas completamente llenas con algunos elementos estrechos en la pantalla. Pero en la pr√°ctica, esto no es visible en mis fotos y no es sorprendente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador se puede configurar para operar en varios modos de visualizaci√≥n del contenido de la memoria de la pantalla en una matriz de p√≠xeles. Fue m√°s conveniente para m√≠ cuando cada byte se mapea en una columna vertical de ocho p√≠xeles de altura, y las columnas van horizontalmente de izquierda a derecha, llenando la pantalla con l√≠neas de ocho p√≠xeles de altura. En este modo, es m√°s conveniente dibujar texto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A menudo, se practica un enfoque en el que la memoria de visualizaci√≥n se duplica en la RAM MCU: primero, todas las acciones con la imagen se realizan en RAM, y luego todos los p√≠xeles modificados se copian en la memoria de visualizaci√≥n. En este proyecto, este enfoque no se utiliza para ahorrar recursos. Todos los lugares modificados se vuelven a dibujar inmediatamente en la memoria de la pantalla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se sugiere en los comentarios, las pantallas OLED se desvanecen con el tiempo. Tambi√©n sospech√© esto (recordando qu√© es el protector de pantalla), y proporcion√© que la pantalla se apagara despu√©s de unos minutos despu√©s de la √∫ltima actividad en los controles. Se enciende al girar o presionar el codificador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el c√≥digo, el trabajo con la pantalla se implementa en la clase Display. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Valkoder:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee6/a1e/6b5/ee6a1e6b5921493bb395675e2805f2c6.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi opini√≥n, el valcoder es la mejor opci√≥n de control para dispositivos que tienen al menos alguna interfaz de usuario. Es compacto y muy c√≥modo. Es conveniente para ellos hojear y seleccionar elementos del men√∫, cambiar los valores de cualquier par√°metro, cambiar de modo, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para conectar, se requieren tres patas de entrada del microcontrolador. Uno para el bot√≥n (puede presionar la manija), dos para el propio valcoder. Hay una se√±al de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo gris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del codificador </font><font style="vertical-align: inherit;">. En cada paso de giro, un bit cambia en dos l√≠neas. La secuencia determina la direcci√≥n de rotaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo parece ser simple, pero, aparentemente, los desarrolladores no siempre pueden ofrecer soporte de alta calidad para dicho dispositivo. Por ejemplo, en mi impresora 3D hay una placa RAMPS y una placa con pantalla y est√° conectado exactamente el mismo codificador. El firmware de Marlin funciona con √©l, pero la experiencia de usarlo es muy mala, no hay sensaci√≥n de confiabilidad, cuando hace clic en la perilla al girarla, la interfaz a menudo se detiene en el elemento de men√∫ o valor de par√°metro incorrecto en el que se esperaba. Con una rotaci√≥n r√°pida, parece que se saltan los clics. En alg√∫n momento, el cambio no comienza durante los clics, pero en alg√∫n punto intermedio es muy desagradable. S√≠, qu√© es Marlin, a veces tengo la misma sensaci√≥n sobre el sistema multimedia incorporado en el autom√≥vil. En este sentido, algunos consejos (y, por supuesto, mire el c√≥digo en la vecindad de la clase RotEnc).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, un punto bastante obvio para cualquiera que conecte cualquier bot√≥n al microcontrolador: debe lidiar con el rebote. Este codificador mec√°nico y sus l√≠neas de se√±al son, de hecho, los mismos botones, y tambi√©n tienen un parloteo. Primero, filtramos la conversaci√≥n, luego procesamos la secuencia de estados de las l√≠neas de se√±al. Puede haber valcoders con sensores √≥pticos, ya depende de los esquemas de procesamiento de se√±al de ellos. Si las patas de un fototransistor se sacan directamente, entonces puede sonar all√≠ con una rotaci√≥n lenta, pero si hay alg√∫n esquema de procesamiento que introduzca hist√©resis, entonces no se requiere la supresi√≥n de software. Pero tales dispositivos son m√°s caros y rara vez se usan en dispositivos aficionados, los m√°s comunes son mec√°nicos, unos pocos d√≥lares por grupo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En segundo lugar, un punto un poco menos obvio, probablemente uno de aquellos en los que Marlin se quem√≥: el mango tiene posiciones estables durante la rotaci√≥n: clics (clics). Este modelo tiene cuatro pasos de una secuencia de c√≥digo para cada clic. Por lo tanto, debe responder a los clics y no a los pasos de la secuencia. Y lo m√°s importante es sincronizar con posiciones estables. Muchos simplemente ingresan la constante STEPS_PER_CLICK y, por ejemplo, responden a cada cuarto paso. Pero el problema es que la se√±al no es perfecta, las secuencias pueden no ser del todo correctas. Con una cierta ortograf√≠a, el c√≥digo puede "extraviarse", como resultado, cada cuarto paso se obtendr√° en alg√∫n lugar en el medio del clic, lo que ser√° inc√≥modo para el usuario. Al mismo tiempo, la posici√≥n fija del controlador para un modelo particular corresponde a un valor de c√≥digo fijo,debe estar unido a √©l.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tercer lugar, una vez m√°s, un punto bastante obvio para los desarrolladores m√°s o menos experimentados de sistemas de microcontroladores: use interrupciones de hardware para cambiar el estado de las l√≠neas de entrada. </font><font style="vertical-align: inherit;">Como m√≠nimo, habr√° menos riesgo de "perder" los pasos de la secuencia. </font><font style="vertical-align: inherit;">Pero en general, como saben, las interrupciones son nuestro todo. </font><font style="vertical-align: inherit;">La MCU debe dormir siempre que sea posible, despertando solo con interrupciones, ya sea desde la periferia exterior o desde un temporizador para realizar una tarea retrasada. </font><font style="vertical-align: inherit;">Estos son los principios del buen dise√±o de la arquitectura del sistema.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dise√±o en su conjunto</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√° hecho de materiales improvisados ‚Äã‚Äãy varias partes impresas en una impresora 3D de ABS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El principio de funcionamiento del sif√≥n se ilustra en el video de arriba. Para m√≠, es un tubo externo de PVC y un tubo interno con un embudo al final. Para el sif√≥n cl√°sico, se requiere otra rodilla, pero ya era dif√≠cil hacerlo constructivamente para m√≠. Cuando se encontraron problemas con el drenaje, se peg√≥ un peque√±o ba√±o en la pared del tanque inferior, en el que se sumergi√≥ el extremo del tubo interior, y se cre√≥ resistencia al drenaje, para que el sif√≥n pudiera funcionar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Result√≥ que el ABS es un material muy hidr√≥fobo. El agua literalmente no se desborda; incluso tuve que rehacer el embudo del sif√≥n. Vale la pena considerar esta propiedad, es imposible crear algunos sistemas hidr√°ulicos en miniatura (por ejemplo, quer√≠a hacer superficies de gu√≠a en el embudo del sif√≥n, para torcer el agua, para mejorar la respuesta del sif√≥n. ‚Äã‚ÄãPero con tales dimensiones e hidrofobicidad del ABS esto no tiene sentido) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n intent√© primero pegar todo junto con una pistola de pegamento caliente. No funciona, al principio todo parec√≠a mantenerse firme, pero despu√©s de unos d√≠as se cay√≥. La mejor opci√≥n es Asia Central. Los detalles, incluso bajo el agua, se mantienen apretados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El mayor error de c√°lculo en el dise√±o son los contenedores transparentes. Olvid√© por completo el hecho de que el agua florece a la luz. Tuve que envolverlo con material opaco. Bueno, peri√≥dicamente puede agregar permanganato de potasio para la desinfecci√≥n, esto no parece da√±ar las plantas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo de inundaci√≥n es el siguiente: primero se enciende la bomba a baja potencia y llena silenciosamente todo el tanque superior. El proceso es monitoreado por un sensor de nivel. Cuando el agua comienza a desbordarse a trav√©s del embudo del sif√≥n, la disminuci√≥n del nivel en el tanque inferior se detiene, lo cual es detectado por el sensor. Un peque√±o flujo creado a baja potencia no es suficiente para activar un sif√≥n. La bomba se detiene, se recuerda el volumen bombeado al tanque superior. Las ra√≠ces se mantienen en la soluci√≥n durante varios minutos, despu√©s de lo cual la bomba se enciende nuevamente. Primero, a baja potencia, hasta que el agua llegue al embudo nuevamente (durante el tiempo de inactividad, baja m√°s debido al efecto del sif√≥n), y cuando se alcanza el nivel del embudo, la bomba comienza a aumentar la potencia, proporcionando un flujo suficiente para que el sif√≥n funcione. Se garantiza que el flujo a trav√©s del sif√≥n ser√° mayor que el flujo de la bomba,Como resultado, el nivel en el tanque inferior comienza a aumentar, el sensor lo detecta y la bomba se detiene.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los ciclos de inundaci√≥n comienzan peri√≥dicamente, a intervalos fijos y configurables, desde el amanecer hasta el anochecer. </font><font style="vertical-align: inherit;">Seg√∫n el plan, se supon√≠a que el amanecer deb√≠a ser fijado por el sensor de luz, y la duraci√≥n de la luz del d√≠a, si era necesario, se extend√≠a al valor establecido, pero hasta entonces las manos no lo hab√≠an alcanzado. </font><font style="vertical-align: inherit;">El tiempo del amanecer se establece simplemente en la configuraci√≥n.</font></font><br>
<br>
<a name="cpp11"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øY d√≥nde est√° C ++ 11?</font></font></h4><br>
<a name="cpp11"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiz√°s alguien dudar√° de que C ++ 11 pueda ser √∫til en la programaci√≥n de microcontroladores (entre aquellos que generalmente saben que los microcontroladores se pueden programar en C ++). </font><font style="vertical-align: inherit;">Tratar√© de dar ejemplos espec√≠ficos de los beneficios de C ++ 11 en esta √°rea (adem√°s de obvias cosas agradables como constexpr, override, default, etc.).</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Colocaci√≥n de recursos de cadena</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mucha gente sabe que la RAM en los microcontroladores es un recurso muy limitado. Esto puede ser un problema si su aplicaci√≥n, por ejemplo, tiene una interfaz de usuario y su programa usa una cantidad bastante grande de l√≠neas. Si en el c√≥digo escribir algo como</font></font><br>
<pre><code class="cpp hljs">PromptUser(<span class="hljs-string">"Are you sure you want to format SD-card?"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
entonces la l√≠nea pasada en los argumentos se colocar√° en la secci√≥n de datos inicializados (en adelante, el comportamiento del compilador GCC para la plataforma AVR), es decir, en el √°rea RAM, que al inicio (antes de llamar a la funci√≥n principal) se inicializa desde la memoria flash del programa. La funci√≥n PromptUser () pasar√° un puntero a la ubicaci√≥n deseada en la RAM. Si utiliza un enfoque similar en todo el programa, la RAM terminar√° bastante r√°pido (en el ATMEGA328P utilizado en este proyecto es de solo 2 kilobytes, y esto tambi√©n es para BSS, mont√≥n y pila). Para evitar esta limitaci√≥n, funciones como PromptUser () aprenden a trabajar no con punteros a RAM, sino con punteros a una regi√≥n en la memoria flash del programa. Puede leer desde all√≠ solo con la ayuda de instrucciones especiales, que, por ejemplo, en avr-libc est√°n envueltas en funciones de la familia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_read_ [byte | word | dword | ...]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, la cadena debe colocarse primero en una variable equipada con el atributo PROGMEM, que le dice al compilador que debe colocarse en la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memoria del programa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;<font></font>
PromptUser(prompt);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es inconveniente si desea declarar todas las l√≠neas de forma centralizada. </font><font style="vertical-align: inherit;">Luego, primero debe declarar su declaraci√≥n en el archivo de encabezado:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> prompt[] PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y en un archivo .cpp separado, defina:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duplicaci√≥n de c√≥digo, lo que no es bueno y muy inconveniente cuando hay muchas de esas l√≠neas. </font><font style="vertical-align: inherit;">S√≠, esto se puede eludir haciendo una macro complicada e incluyendo el archivo de encabezado en un archivo .cpp separado, en el que la macro se expandir√° a la definici√≥n, mientras que en otros contextos se expandir√° a la declaraci√≥n. </font><font style="vertical-align: inherit;">Pero con C ++ 11 hay una opci√≥n m√°s limpia si usa la inicializaci√≥n de los miembros de la clase al declarar. </font><font style="vertical-align: inherit;">En el archivo de encabezado, declare la clase con las l√≠neas:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_STR(__name, __text) \
    const char __name[sizeof(__text)] = __text;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Strings</span> {</span>
<span class="hljs-keyword">public</span>:<font></font>
    DEF_STR(Prompt, <span class="hljs-string">"Are you sure you want to format SD-card?"</span>)<font></font>
    DEF_STR(OtherString, <span class="hljs-string">"..."</span>)<font></font>
    ‚Ä¶<font></font>
} __attribute__((packed));<font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Strings strings PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el archivo .cpp:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> Strings strings PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora todas las l√≠neas se declaran en un solo lugar, se colocan en la memoria del programa, y ‚Äã‚Äãpuede acceder a ellas de esta manera:</font></font><br>
<pre><code class="cpp hljs">PromptUser(strings.prompt);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este proyecto, se utiliza un enfoque basado en el mismo principio para determinar mapas de bits: varias im√°genes que se muestran en una pantalla gr√°fica.</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/** Bitmap descriptor. */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Bitmap</span> {</span>
    <span class="hljs-comment">/** Pointer to data array if in data memory. Offset of data array relatively
     * to Bitmaps class instance start address if in program memory.
     */</span>
    <span class="hljs-keyword">const</span> u8 *data;
    <span class="hljs-comment">/** Number of pages in the bitmap. */</span><font></font>
    u8 numPages,<font></font>
    <span class="hljs-comment">/** Number of columns in the bitmap. */</span><font></font>
       numColumns;<font></font>
} __PACKED;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;u8... data&gt;
<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> u8
<span class="hljs-title">Bitmap_NumDataBytes</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">sizeof</span>...(data);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/** Define bitmap.
 * @param __name Name for accessing.
 * @param __numPages Number of pages in the bitmap. Number of columns defined as
 *      total number of data bytes divided by number of pages.
 * @param __VA_ARGS__ Data bytes.
 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_BITMAP(__name, __numPages, ...) \
    const u8 __CONCAT(__name, __data__) \
        [Bitmap_NumDataBytes<span class="hljs-meta-string">&lt;__VA_ARGS__&gt;()] = { __VA_ARGS__ }; \</span></span>
    <span class="hljs-keyword">const</span> Bitmap __name { \
        <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">const</span> u8 *&gt;(OFFSETOF(Bitmaps, __CONCAT(__name, __data__))), \<font></font>
        __numPages, \<font></font>
        <span class="hljs-keyword">sizeof</span>(__CONCAT(__name, __data__)) / __numPages};<font></font>
<font></font>
<span class="hljs-comment">/** Global bitmaps repository. Stored in program memory. */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bitmaps</span> {</span>
<span class="hljs-keyword">public</span>:<font></font>
<font></font>
    <span class="hljs-comment">/** Thermometer icon. */</span>
    DEF_BITMAP(Thermometer, <span class="hljs-number">1</span>,
        <span class="hljs-number">0b01101010</span>,
        <span class="hljs-number">0b10011110</span>,
        <span class="hljs-number">0b10000001</span>,
        <span class="hljs-number">0b10011110</span>,
        <span class="hljs-number">0b01101010</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-comment">/** Sun icon. */</span>
    DEF_BITMAP(Sun, <span class="hljs-number">1</span>,
        <span class="hljs-number">0b00100100</span>,
        <span class="hljs-number">0b00011000</span>,
        <span class="hljs-number">0b10100101</span>,
        <span class="hljs-number">0b01000010</span>,
        <span class="hljs-number">0b01000010</span>,
        <span class="hljs-number">0b10100101</span>,
        <span class="hljs-number">0b00011000</span>,
        <span class="hljs-number">0b00100100</span><font></font>
    )<font></font>
    ...<font></font>
};<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Bitmaps bitmaps PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diferencia es que, adem√°s de los datos de la imagen en s√≠, tambi√©n es necesario colocar atributos (tama√±os de imagen). </font><font style="vertical-align: inherit;">Cada byte define una columna de ocho p√≠xeles. </font><font style="vertical-align: inherit;">Las columnas pueden llenar una o m√°s filas; su n√∫mero se indica mediante el segundo par√°metro despu√©s del nombre. </font><font style="vertical-align: inherit;">Resulta que la altura de los mapas de bits debe ser un m√∫ltiplo de ocho para un ancho arbitrario, lo cual es bastante aceptable para este proyecto.</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Literales binarios</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es posible que ya haya notado que los mapas de bits en el ejemplo anterior usan literales binarios para determinar. </font><font style="vertical-align: inherit;">Esto es realmente muy conveniente: puede editar mapas de bits simples directamente en el c√≥digo, especialmente si el editor permite resaltarlos. </font><font style="vertical-align: inherit;">Por ejemplo, las definiciones de caracteres de fuente en el archivo font.h:</font></font><br>
<br>
<img src="https://habrastorage.org/files/8f4/a54/0c9/8f4a540c9a8a42ff9315c8d4cd307d93.png"><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plantillas variadas</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donde entonces sin ellos entonces. </font><font style="vertical-align: inherit;">Bueno, por ejemplo, los comandos para el controlador de pantalla pueden tener una longitud de uno a varios bytes. </font><font style="vertical-align: inherit;">Enviado con el siguiente c√≥digo:</font></font><br>
<br>
<pre><code class="cpp hljs">SendCommand(Command::DISPLAY_ON);<font></font>
SendCommand(Command::SET_COM_PINS, COM_PINS | COM_PINS_ALTERNATIVE);<font></font>
SendCommand(Command::SET_COLUMN_ADDRESS, curVp.minCol, curVp.maxCol);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conveniente, ¬øno es as√≠?</font></font><br>
<pre><code class="cpp hljs">    <span class="hljs-comment">/** Queue command sending.
     * @param bytes Up to MAX_CMD_SIZE bytes of command data.
     */</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;
    <span class="hljs-function"><span class="hljs-keyword">void</span>
    <span class="hljs-title">SendCommand</span><span class="hljs-params">(TByte... bytes)</span>
    </span>{<font></font>
        cmdSize = <span class="hljs-keyword">sizeof</span>...(bytes);<font></font>
        controlSent = <span class="hljs-literal">false</span>;<font></font>
        cmdInProgress = <span class="hljs-literal">true</span>;<font></font>
        SetCmdByte(<span class="hljs-keyword">sizeof</span>...(bytes) - <span class="hljs-number">1</span>, bytes...);<font></font>
        i2cBus.RequestTransfer(DISPLAY_ADDRESS, <span class="hljs-literal">true</span>,<font></font>
                               CommandTransferHandler);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span> idx, u8 byte, TByte... bytes)</span>
    </span>{<font></font>
        cmdBuf[idx] = byte;<font></font>
        SetCmdByte(idx - <span class="hljs-number">1</span>, bytes...);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, u8 byte)</span>
    </span>{<font></font>
        cmdBuf[<span class="hljs-number">0</span>] = byte;<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo variant.h describe una clase que se asemeja vagamente a boost :: variant usando plantillas variadic. Se utiliza para organizar p√°ginas de interfaz de usuario. El punto es nuevamente en el ahorro de memoria: donde la administraci√≥n din√°mica de la memoria es un lujo inadmisible, debe esquivar (aunque 2K todav√≠a es mucho, no puede esquivarlo, pero en la misma l√≠nea ATMEGA su tama√±o alcanza 512 bytes, y cada byte por cuenta). En mi interfaz, se muestra una p√°gina en la pantalla en cualquier momento. En consecuencia, para todas las p√°ginas puede usar la misma memoria, lo que se llama uni√≥n en C. Para las clases en C ++, esto generalmente se llama variante. A diferencia de la uni√≥n, debemos recordar llamar al destructor del contenido anterior antes de llamar al constructor del nuevo.</font></font><br>
<br>
<pre><code class="cpp hljs">    Variant&lt;MainPage,<font></font>
            Menu,<font></font>
            LinearValueSelector,<font></font>
            TimeSelector&gt; curPage;<font></font>
    ...<font></font>
    <span class="hljs-comment">/** Get type code for the specified page class. */</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TPage</span>&gt;
    <span class="hljs-title">static</span> <span class="hljs-title">constexpr</span> <span class="hljs-title">u8</span>
    <span class="hljs-title">GetPageTypeCode</span>()
    {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">decltype</span>(curPage)::GetTypeCode&lt;TPage&gt;();<font></font>
    }<font></font>
...<font></font>
curPage.Engage(nextPageTypeCode, page);<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la compilaci√≥n, los binutils de GCC y GNU se utilizan para la plataforma AVR (en Ubuntu hay un paquete listo para usar gcc-avr). </font><font style="vertical-align: inherit;">Los detalles del proceso de montaje se dieron anteriormente. </font><font style="vertical-align: inherit;">Los par√°metros para el compilador se parecen a esto (se omiten los detalles y las inclusiones espec√≠ficas del proyecto): </font><font style="vertical-align: inherit;">
Enlace: </font><font style="vertical-align: inherit;">
Convierta la secci√≥n de c√≥digo a formato hexadecimal: </font><font style="vertical-align: inherit;">
Cree una imagen EEPROM: </font><font style="vertical-align: inherit;">
Firmware para el microcontrolador: </font><font style="vertical-align: inherit;">
PS Los primeros tomates ya estaban maduros y no sab√≠an muy bien. </font><font style="vertical-align: inherit;">Aparentemente, no les gust√≥ algo en la dieta. </font><font style="vertical-align: inherit;">Probablemente tenga que cambiar la cultura.</font></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/lighting.cpp.o -c -fno-exceptions -fno-rtti -std=c++1y -Wall -Werror -Wextra -ggdb3 -Os -mcall-prologues -mmcu=atmega328p -fshort-wchar -fshort-enums src/firmware/cpu/lighting.cpp<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/cpu -mmcu=atmega328p build/native-debug/src/firmware/cpu/adc.cpp.o build/native-debug/src/firmware/cpu/application.cpp.o ‚Ä¶<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .text -j .data -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_rom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .eeprom --change-section-lma .eeprom=0 -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_eeprom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avrdude -p atmega328p -c avrisp2 -P /dev/avrisp -U flash:w:build/native-debug/src/firmware/cpu/cpu_rom.hex:i<br>
</code><br>
<br><font style="vertical-align: inherit;"></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es385135/">https://habr.com/ru/post/es385135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es385121/index.html">Surrealismo algor√≠tmico: una gu√≠a para el comercio de alta frecuencia por 900 millones de microsegundos. Parte 1</a></li>
<li><a href="../es385123/index.html">–°—Ç–∞–Ω—Ü–∏—è New Horizons –ø—Ä–∏—Å–ª–∞–ª–∞ —Å–Ω–∏–º–æ–∫ –º–∞–ª–æ–≥–æ —Å–ø—É—Ç–Ω–∏–∫–∞ –ü–ª—É—Ç–æ–Ω–∞ –°—Ç–∏–∫—Å–∞</a></li>
<li><a href="../es385125/index.html">Reddit eligi√≥ qu√© foto ir√° a la luna en 2017</a></li>
<li><a href="../es385129/index.html">Sensor de iluminaci√≥n inal√°mbrico CR2450</a></li>
<li><a href="../es385131/index.html">Tranquilo en la noche, simplemente no duermas PC: ir en silencio</a></li>
<li><a href="../es385137/index.html">Movimiento de desmantelamiento de la cartelera urbana global</a></li>
<li><a href="../es385139/index.html">Robots Tesla Motors</a></li>
<li><a href="../es385141/index.html">Cannybots: robots para ense√±ar a los ni√±os a programar</a></li>
<li><a href="../es385145/index.html">Una selecci√≥n de rastreadores donde puedes cambiar las correas</a></li>
<li><a href="../es385147/index.html">–†–æ–±–æ—Ç—ã –º–æ–≥—É—Ç —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—Ö–æ–¥–æ–≤ –¥–µ—à–µ–≤–ª–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>