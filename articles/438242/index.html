<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶ç üèúÔ∏è üßìüèº Comprime la lista de direcciones IP de la mejor manera üò≠ ‚òùüèº ‚úãüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una vez que le√≠ en Habr un art√≠culo sobre la configuraci√≥n de BGP en un enrutador. Las instrucciones de all√≠ se pueden usar para configurar el enrutad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comprime la lista de direcciones IP de la mejor manera</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/438242/"><img src="https://habrastorage.org/webt/xb/cm/03/xbcm03j6a2yijqkxhzatkxq6xbw.jpeg"><br><br>  Una vez que le√≠ en Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo</a> sobre la configuraci√≥n de BGP en un enrutador.  Las instrucciones de all√≠ se pueden usar para configurar el enrutador dom√©stico de modo que el tr√°fico a direcciones IP espec√≠ficas pase por otro canal.  Sin embargo, hay un problema: la lista de direcciones IP puede ser muy grande. <br><br>  Adem√°s de las redes de la lista, las subredes comunes m√°s grandes de las redes vecinas se agregan a este gr√°fico.  Siga leyendo para saber por qu√© esto es necesario. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/fh/pf/er/fhpfer-kqivtgto-agnozn9wpos.png"><br>  <i>Parec√≠a un √°rbol de red de Roskomnadzor en mayo de 2018.</i> <br><br>  Primero, intent√© agregar la lista completa a trav√©s de / ip route add a mi MikroTik hAP ac lite: el enrutador se qued√≥ sin espacio en disco.  Luego cargu√© todas las direcciones en la memoria a trav√©s de BGP: el enrutador funcion√≥ un poco y se colg√≥.  Se hizo evidente que la lista necesitaba ser recortada. <br><br>  El <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> menciona la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utilidad</a> network-list-parser de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Unsacrificed</a> .  Ella hace lo que necesito, pero la vi despu√©s de que empec√© a inventar mi bicicleta.  Luego lo termin√© por inter√©s, porque lo que hice funciona mejor, aunque mucho m√°s lento. <br><br>  Entonces, la declaraci√≥n del problema: debe escribir un script que tome una lista de direcciones IP y redes como entrada y la acorte al tama√±o especificado.  En este caso, la nueva lista debe cubrir todas las direcciones de la anterior, y el n√∫mero de nuevas direcciones que se deben agregar debe ser m√≠nimo. <br><br>  Comencemos construyendo un gr√°fico de todas las redes de origen (lo que est√° en la imagen de arriba).  El nodo ra√≠z ser√° la red 0.0.0.0/0.  Al agregar una nueva subred A, encontramos la subred B en el √°rbol para que A y B est√©n en la subred C y el tama√±o de la subred C sea m√≠nimo (m√°scara m√°xima).  En otras palabras, el n√∫mero de bits comunes de subredes A y B debe ser m√°ximo.  Agregamos esta subred com√∫n al √°rbol, y dentro transferimos las subredes A y B. Quiz√°s esto se pueda llamar un √°rbol binario. <br><br>  Por ejemplo, cree un √°rbol de dos subredes (192.168.0.1/32 y 192.168.33.0/24): <br><br><img src="https://habrastorage.org/webt/5d/ts/tx/5dtstx3shvofo6npuytk5n0kcto.png"><br><br>  Consigue el √°rbol: <br><br><img src="https://habrastorage.org/webt/la/5b/ej/la5bejewneridokbs_-fkahmz1y.png"><br><br>  Si agregamos, digamos, la red 192.168.150.150/32, entonces el √°rbol se ver√° as√≠: <br><br><img src="https://habrastorage.org/webt/-r/yp/om/-rypomiatbn-l5hlfq86wzcgal8.png"><br><br>  Naranja indica subredes comunes agregadas durante la construcci√≥n del √°rbol.  Son estas subredes comunes las que "colapsar√°n" para reducir el tama√±o de la lista.  Por ejemplo, si contrae el nodo 192.168.0.0/16, reduciremos el tama√±o de la lista de redes en 2 (hab√≠a 3 redes de la lista original, se convirti√≥ en 1), pero al mismo tiempo cubrimos adicionalmente 65536-1-1-256 = 65278 direcciones IP, que No incluido en nuestra lista original. <br><br>  Es conveniente que cada nodo calcule el "coeficiente de beneficio del colapso", mostrando el n√∫mero de direcciones IP que se agregar√°n adicionalmente a cada una de las entradas eliminadas de la lista: <br><br><pre><code class="plaintext hljs">weight_reversed = net_extra_ip_volume / (in_list_records_count - 1)</code> </pre> <br>  Usaremos weight = 1 / weight_reversed, como  Es m√°s conveniente.  Es curioso que el peso puede ser igual al infinito si, por ejemplo, hay dos redes / 32 en la lista, que juntas forman una red grande / 31. <br><br>  Por lo tanto, cuanto mayor es el peso, m√°s rentable es colapsar dicha red. <br><br>  Ahora puede calcular el peso de todos los nodos en la red, ordenar los nodos por peso y colapsar las subredes hasta que obtengamos el tama√±o de la lista que necesitamos.  Sin embargo, hay una dificultad: en el momento en que colapsamos una red, los pesos de todas las redes principales cambian. <br><br>  Por ejemplo, tenemos un √°rbol con pesos calculados: <br><br><img src="https://habrastorage.org/webt/mn/wd/60/mnwd60e30yeamoqjg3veobslqcc.png"><br><br>  Vamos a colapsar la subred 192.168.0.0/30: <br><br><img src="https://habrastorage.org/webt/3q/zf/tm/3qzftmtvi-ctpw9_ebniki7cvkm.png"><br><br>  El peso del nodo padre ha disminuido.  Si hay nodos en el √°rbol con un peso mayor que 0.166, entonces lo siguiente deber√≠a colapsarse. <br><br>  Como resultado, la lista debe comprimirse de forma recursiva.  El algoritmo es algo como esto: <br><br><ol><li>  Calculamos los pesos para todos los nodos. </li><li>  Para cada nodo, almacene el peso m√°ximo del nodo hijo (Wmax). </li><li>  Resulta que Wmax del nodo ra√≠z es el peso m√°ximo del nodo en todo el √°rbol (puede haber varios nodos con un peso igual a Wmax). </li><li>  Comprima recursivamente todas las redes con un peso igual a Wmax del nodo ra√≠z.  En este caso, recalculamos el peso.  Regresamos al nodo ra√≠z. </li><li>  La Wm√°x del nodo ra√≠z ha disminuido: realizamos el paso 4 hasta obtener el tama√±o deseado de la lista de redes. </li></ol><br>  Lo m√°s interesante es observar el algoritmo en movimiento.  Aqu√≠ hay un ejemplo para una lista de redes: <br><br> <code>192.168.0.1 <br> 192.168.0.2 <br> 192.168.0.8/29 <br> 192.168.150.1 <br> 192.168.150.2 <br> 192.168.150.8/29 <br> 192.168.20.1 <br> 192.168.20.2 <br> 192.168.20.3 <br> 192.168.20.4 <br> 192.168.20.5 <br> 192.168.20.6 <br> 192.168.20.7</code> <br> <br>  Aqu√≠, las subredes 192.168.0.0/24 y 192.168.150.0/24 tienen una estructura id√©ntica; es mejor ver c√≥mo el algoritmo salta de una rama a otra durante la compresi√≥n.  Agreg√≥ la subred 192.168.20.0/24 para mostrar que a veces es m√°s rentable comprimir la red principal que la red secundaria.  Preste atenci√≥n a la subred 192.168.20.0/30: despu√©s de llenar el √°rbol, su peso es menor que el de la subred principal. <br><br>  Relleno de √°rbol: <br><br><img src="https://habrastorage.org/webt/db/7y/od/db7yodt6w5mvgq_rvxxoe5k4lq8.gif"><br><br>  Aqu√≠ la fuente negra es la red real de la lista original.  Amarillo - redes agregadas.  El azul es el peso del nodo.  El rojo es la red actual.  El rosa es una red colapsada. <br><br>  Compresi√≥n <br><br><img src="https://habrastorage.org/webt/wp/wr/0j/wpwr0j57ms67jp4xdpmhzjkpnpy.gif"><br><br>  Hubo una idea para acelerar el algoritmo de colapso de la red: para esto no es necesario colapsar solo las redes con un peso m√°ximo en cada iteraci√≥n.  Puede preseleccionar el valor del peso, lo que nos dar√° una lista del tama√±o deseado.  Puede seleccionar por b√∫squeda binaria, es decir  comprimir con un peso determinado y ver qu√© tama√±o de la lista se obtiene en la salida.  Es cierto, para esto necesitas el doble de memoria y reescribir el c√≥digo, simplemente no lo pude conseguir. <br><br>  Ahora queda por comparar con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">network-list-parser</a> del art√≠culo sobre BGP. <br><br>  Ventajas de mi gui√≥n: <br><br><ol><li>  Configuraci√≥n m√°s conveniente: solo especifique el tama√±o requerido de la lista de redes, y la salida ser√° una lista de exactamente ese tama√±o.  Network-list-parser tiene muchos identificadores, y necesita encontrar una combinaci√≥n de ellos. </li><li>  La relaci√≥n de compresi√≥n se adapta a la lista original.  Si eliminamos algunas redes de la lista, obtendremos menos direcciones adicionales, si agregamos m√°s.  En este caso, el tama√±o de la lista resultante ser√° constante.  Puede elegir el tama√±o m√°ximo que puede manejar el enrutador y no preocuparse de que la lista se vuelva demasiado grande en alg√∫n momento. </li><li>  La lista resultante contiene el m√≠nimo n√∫mero posible de redes adicionales.  En la lista de prueba de GitHub, mi algoritmo proporcion√≥ 718479 direcciones IP adicionales y un analizador de listas de red: 798761. <b>La diferencia es solo del 10%</b> . <br><br><div class="spoiler">  <b class="spoiler_title">¬øC√≥mo calcul√© esto?</b>  <b class="spoiler_title">Viendo</b> <div class="spoiler_text">  1. Lanzamiento <br><br><pre> <code class="plaintext hljs"> ./network-list-parser-darwin-386-1.2.bin -src-file real_net_list_example.txt -dst-file parsed.txt -aggregation-max-fake-ips 0 -intensive-aggregation-min-prefix 31 2&gt;&amp;1</code> </pre> <br>  y obtenemos una lista limpia sin basura y parcialmente reducida.  Comparar√© la calidad de compresi√≥n de parsed.txt.  (sin este paso, hubo problemas al evaluar cu√°ntas IP falsas agrega network-list-parser). <br><br>  2. Lanzamiento <br><br><pre> <code class="plaintext hljs">./network-list-parser-darwin-386-1.2.bin -src-file parsed.txt -dst-file parsed1.txt 2&gt;&amp;1</code> </pre> <br>  y obtenemos una lista comprimida, mira la salida, est√° la l√≠nea "Agregar 7.3% de cobertura de IP (798761)". <br><br>  El archivo parsed1.txt tiene 16649 entradas. <br><br>  3. Lanzamiento <br><br>  python3 minimice_net_list.py parsed.txt 16649. <br>  Vemos la l√≠nea ### no ips reales: 718479. <br></div></div><br></li></ol><br>  Solo veo un inconveniente del script resultante: funciona durante mucho tiempo y requiere mucha memoria.  En mi MacBook, la lista se presiona durante 5 segundos.  En frambuesa: <b>un minuto y medio</b> .  Con RyPy3 en Mac, es m√°s r√°pido, no pude poner PyPy3 en Raspberry.  Network-list-parser vuela de un lado a otro. <br><br>  En general, tiene sentido usar este esquema solo para perfeccionistas, ya que  Es poco probable que todos los dem√°s gasten tantos recursos inform√°ticos por el 10% de las redes guardadas.  Bueno, un poco m√°s conveniente, s√≠. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace al proyecto en GitHub</a> <br><br>  Corre as√≠: <br><br><pre> <code class="plaintext hljs">python3 minimize_net_list.py real_net_list_example.txt 30000 | grep -v ### &gt; result.txt</code> </pre> <br>  Eso, de hecho, es todo. <br><br>  <b>UPD</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Pochemuk</a> en los comentarios indic√≥ un error al calcular el peso, lo arregl√© y ahora, al comprimir la misma lista del ejemplo con la misma configuraci√≥n, se agregan 624925 direcciones IP que no est√°n en la lista original.  Esto ya es un <b>22% mejor</b> que cuando se procesa network-list-parser <br>  Nuevo c√≥digo en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/phoenix-mstu/net_list_minimizer/tree/untested</a> branch no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">probado</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/438242/">https://habr.com/ru/post/438242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../438230/index.html">Traducci√≥n "Prepare sus aplicaciones para los requisitos de 64 bits"</a></li>
<li><a href="../438234/index.html">Resumen de eventos de TI de febrero</a></li>
<li><a href="../438236/index.html">Confluencia para una base de conocimiento p√∫blico: cambiar el dise√±o y configurar la separaci√≥n de idiomas</a></li>
<li><a href="../438238/index.html">Como dise√±ador, me niego a llamar a las personas "usuarios"</a></li>
<li><a href="../438240/index.html">Pruebas de carga de CPU y SSD de servidores de nube: compare Selectel, Servidores, MCS e I. Cloud</a></li>
<li><a href="../438244/index.html">Nos ocupamos de las regulaciones criptogr√°ficas rusas ... usando el ejemplo del arresto de un narcotraficante</a></li>
<li><a href="../438248/index.html">GitHub Action Life</a></li>
<li><a href="../438250/index.html">La ignorancia de los principios de seguridad de la informaci√≥n no exime</a></li>
<li><a href="../438252/index.html">¬øPor qu√© no despeg√≥ el portal inmobiliario? Parte 1</a></li>
<li><a href="../438254/index.html">Eclipse lanza GlassFish 5.1 para Java EE 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>