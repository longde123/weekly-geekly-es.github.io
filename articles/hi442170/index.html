<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯСиЁЯП┐тАНЁЯМ╛ тЭФ ЁЯСМЁЯП╛ рд╣рдо Postgres рдореЗрдВ рдПрдХ рдкреВрд░реНрдг-рдкрд╛рда рдЦреЛрдЬ рддреИрдпрд╛рд░ рдХрд░ рд░рд╣реЗ рд╣реИрдВред рднрд╛рдЧ 1 тЩЯя╕П ЁЯШб ЁЯСиЁЯП╛тАНтЪЦя╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдпреБрдкреАрдбреАред рднрд╛рдЧ реи 


 рдпрд╣ рд▓реЗрдЦ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬреЗрдХреНрдпреВ рдореЗрдВ рдкреВрд░реНрдг-рдкрд╛рда рдЦреЛрдЬ рдХреЛ рдмреЗрд╣рддрд░ рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдкрд░ рд▓реЗрдЦреЛрдВ рдХреА рдПрдХ рдЫреЛрдЯреА рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╣реИред рдореБрдЭреЗ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдХрд╛...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рд╣рдо Postgres рдореЗрдВ рдПрдХ рдкреВрд░реНрдг-рдкрд╛рда рдЦреЛрдЬ рддреИрдпрд╛рд░ рдХрд░ рд░рд╣реЗ рд╣реИрдВред рднрд╛рдЧ 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442170/"><p>  <strong>рдпреБрдкреАрдбреАред</strong>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рднрд╛рдЧ реи</a> </p><br><p>  рдпрд╣ рд▓реЗрдЦ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдЬреЗрдХреНрдпреВ рдореЗрдВ рдкреВрд░реНрдг-рдкрд╛рда рдЦреЛрдЬ рдХреЛ <em>рдмреЗрд╣рддрд░ рдврдВрдЧ рд╕реЗ</em> рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдкрд░ рд▓реЗрдЦреЛрдВ рдХреА рдПрдХ рдЫреЛрдЯреА рд╢реНрд░реГрдВрдЦрд▓рд╛ рд╣реИред  рдореБрдЭреЗ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдХрд╛рдо рдкрд░ рдЗрд╕реА рддрд░рд╣ рдХреА рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдирд╛ рдкрдбрд╝рд╛ - рдФрд░ рдореБрдЭреЗ рдЗрд╕ рд╡рд┐рд╖рдп рдкрд░ рдХрдо рд╕реЗ рдХрдо рдХреБрдЫ рд╕рдордЭрджрд╛рд░ рд╕рд╛рдордЧреНрд░реА рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдкрд░ рдмрд╣реБрдд рдЖрд╢реНрдЪрд░реНрдп рд╣реБрдЖред  рдХрдЯ рдХреЗ рддрд╣рдд рд▓рдбрд╝рдиреЗ рдХрд╛ рдореЗрд░рд╛ рдЕрдиреБрднрд╡ред </p><a name="habracut"></a><br><h2 id="zavyazka">  рдЯрд╛рдИ </h2><br><p>  рдореИрдВ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдмрдбрд╝реА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реВрдВ рдЬрд┐рд╕рдореЗрдВ рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдкрд░ рдПрдХ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдЦреЛрдЬ рд╣реИред  рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ ~ 3.6 рдЬреАрдмреА рдХреА рдХреБрд▓ рдорд╛рддреНрд░рд╛ рдХреЗ рд╕рд╛рде ~ 500 рд╣рдЬрд╛рд░ рджрд╕реНрддрд╛рд╡реЗрдЬ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред  рдЦреЛрдЬ рдХрд╛ рд╕рд╛рд░ рдпрд╣ рд╣реИ: рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдРрд╕реЗ рдлреЙрд░реНрдо рдХреЛ рднрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреЗ рдлрд╝реАрд▓реНрдбреНрд╕ рдХреЗ рд╕рд╛рде-рд╕рд╛рде рдПрдХ рдкреВрд░реНрдг-рдкрд╛рда рдХреНрд╡реЗрд░реА рдФрд░ рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред </p><br><p>  рд╕реНрдлрд┐рдВрдХреНрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЦреЛрдЬ рдХрд╛рд░реНрдп (рдпрд╛ рдмрд▓реНрдХрд┐, рдХрд╛рдо рдХрд┐рдпрд╛) рдФрд░ рдмрд╣реБрдд рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд┐рдпрд╛ред  рдореБрдЦреНрдп рд╕рдорд╕реНрдпрд╛рдПрдВ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдереАрдВ: </p><br><ol><li>  рдЗрдВрдбреЗрдХреНрд╕рд┐рдВрдЧ рдиреЗ рд▓рдЧрднрдЧ 8 рдЬреАрдмреА рд░реИрдо рдХреА рдЦрдкрдд рдХреАред  8 рдЬреАрдмреА рд░реИрдо рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд░ рдкрд░, рдпрд╣ рдПрдХ рд╕рдорд╕реНрдпрд╛ рд╣реИред  рдореЗрдореЛрд░реА рдХреА рдЕрджрд▓рд╛-рдмрджрд▓реА рд╣реБрдИ, рдЗрд╕рдиреЗ <em>рднрдпрд╛рдирдХ</em> рдкреНрд░рджрд░реНрд╢рди рдХрд┐рдпрд╛ред </li><li>  рд╕реВрдЪрдХрд╛рдВрдХ рд▓рдЧрднрдЧ 40 рдорд┐рдирдЯ рдореЗрдВ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ред  рдЦреЛрдЬ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреА рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рд░рддрд╛ рдХрд╛ рдХреЛрдИ рд╕рд╡рд╛рд▓ рд╣реА рдирд╣реАрдВ рдерд╛, рджрд┐рди рдореЗрдВ рдПрдХ рдмрд╛рд░ рдЕрдиреБрдХреНрд░рдордг рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред </li><li> рдЦреЛрдЬ рдиреЗ <em>рд▓рдВрдмреЗ рд╕рдордп рддрдХ</em> рдХрд╛рдо рдХрд┐рдпрд╛ред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд▓рдВрдмреЗ рд╕рдордп рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд┐рдП рдЧрдП рдереЗ, рдЬреЛ рдмрдбрд╝реА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЗ рдЕрдиреБрд░реВрдк рдереЗ: рдмрдбрд╝реА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдЖрдИрдбреА-рд╢рдиреАрдХреНрд╕ рдХреЛ рд╕реНрдлрд┐рдВрдХреНрд╕ рд╕реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдерд╛, рдФрд░ рдмреИрдХрдПрдВрдб рдкрд░ рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХрддрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХреНрд░рдордмрджреНрдз рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред </li></ol><br><p>  рдЗрди рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЗ рдХрд╛рд░рдг, рдХрд╛рд░реНрдп рдЙрддреНрдкрдиреНрди рд╣реБрдЖ - рдкреВрд░реНрдг-рдкрд╛рда рдЦреЛрдЬ рдХреЛ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред  рдЗрд╕ рдХрд╛рд░реНрдп рдХреЗ рджреЛ рд╕рдорд╛рдзрд╛рди рд╣реИрдВ: </p><br><ol><li>  рдЯрд╛рдЗрдЯреЗрди рд╕реНрдлрд┐рдВрдХреНрд╕: рдПрдХ рд░реАрдпрд▓рдЯрд╛рдЗрдо рдЗрдВрдбреЗрдХреНрд╕ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ, рдЗрдВрдбреЗрдХреНрд╕ рдореЗрдВ рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╕реНрдЯреЛрд░ рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБред </li><li>  рдмрд┐рд▓реНрдЯ-рдЗрди FTS PostgreSQL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред </li></ol><br><p>  рджреВрд╕рд░реЗ рд╕рдорд╛рдзрд╛рди рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ рдЧрдпрд╛ рдерд╛: рдЗрд╕ рддрд░рд╣ рдЖрдк рдореВрд▓ рд░реВрдк рд╕реЗ рд╕реВрдЪрдХрд╛рдВрдХ рдХреЗ рдСрдЯреЛ-рдЕрдкрдбреЗрдЯ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рджреЛ рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдмреАрдЪ <em>рд▓рдВрдмреЗ</em> рд╕рдВрдЪрд╛рд░ рд╕реЗ рдЫреБрдЯрдХрд╛рд░рд╛ рдкрд╛ <em>рд╕рдХрддреЗ</em> рд╣реИрдВ рдФрд░ рджреЛ рдХреЗ рдмрдЬрд╛рдп рдПрдХ рд╕реЗрд╡рд╛ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  рдпрд╣ рдПрдХ рдЕрдЪреНрдЫрд╛ рд╕рдорд╛рдзрд╛рди рдкреНрд░рддреАрдд рд╣реЛрдЧрд╛ред  рд▓реЗрдХрд┐рди рд╕рдорд╕реНрдпрд╛рдПрдВ рдЖрдЧреЗ рд░рд╣реАрдВред </p><br><p>  рдЪрд▓рд┐рдП рд╢реБрд░реВ рд╕реЗ рд╣реА рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред </p><br><h2 id="naivno-ispolzuem-polnotekstovyy-poisk">  рд╣рдо рднреЛрд▓реЗрдкрди рд╕реЗ рдкреВрд░реНрдг-рдкрд╛рда рдЦреЛрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ </h2><br><p> рдЬреИрд╕рд╛ рдХрд┐ рдкреНрд░рд▓реЗрдЦрди рдХрд╣рддрд╛ рд╣реИ, рдкреВрд░реНрдг-рдкрд╛рда рдЦреЛрдЬреЛрдВ рдХреЛ <code>tsvector</code> рдФрд░ <code>tsquery</code> рдХреЗ рдЙрдкрдпреЛрдЧ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред  рдкрд╣рд▓рд╛ рдПрдХ рдЦреЛрдЬ-рдЕрдиреБрдХреВрд▓рд┐рдд рд░реВрдк рдореЗрдВ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХрд╛ рдкрд╛рда рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рджреВрд╕рд░рд╛ рдПрдХ рдкреВрд░реНрдг-рдкрд╛рда рдХреНрд╡реЗрд░реА рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИред </p><br><p>  PostgreSQL рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рд╡рд╣рд╛рдБ <code>to_tsvector</code> , <code>plainto_tsquery</code> , <code>to_tsquery</code> ред  рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рд░реИрдВрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <code>ts_rank</code> ред  рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рд╣рдЬ рд╣реИ рдФрд░ рд╡реЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкреНрд░рд▓реЗрдЦрди</a> рдореЗрдВ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╡рд░реНрдгрд┐рдд рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЙрдирдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рд╡рд┐рд╡рд░рдг рдкрд░ рдзреНрдпрд╛рди рдирд╣реАрдВ рджреЗрддреЗ рд╣реИрдВред </p><br><p>  рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реА рдПрдХ рдкрд╛рд░рдВрдкрд░рд┐рдХ рдЦреЛрдЬ рдХреНрд╡реЗрд░реА рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрд╛рдИ рджреЗрдЧреА: </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, ts_rank(to_tsvector("document_text"), plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_document <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> to_tsvector("document_text") @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ts_rank(to_tsvector("document_text"), plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><p>  рд╣рдордиреЗ рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЗ рдЖрдИрдбреА-рдПрд╕ рдХреЛ рдХрд╛рдЯ рджрд┐рдпрд╛, рдЬрд┐рд╕рдореЗрдВ "рдХреНрд╡реЗрд░реА" рд╢рдмреНрдж рд╣реИ, рдФрд░ рдЙрдиреНрд╣реЗрдВ рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХрддрд╛ рдХреЗ рдЕрд╡рд░реЛрд╣реА рдХреНрд░рдо рдореЗрдВ рдХреНрд░рдордмрджреНрдз рдХрд┐рдпрд╛ред  рд╕рдм рдХреБрдЫ рдареАрдХ рд▓рдЧ рд░рд╣рд╛ рд╣реИ?  рдирд╣реАрдВред </p><br><p>  рдКрдкрд░ рджрд┐рдП рдЧрдП рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЗ рдХрдИ рдиреБрдХрд╕рд╛рди рд╣реИрдВ: </p><br><ol><li>  рд╣рдо рдЦреЛрдЬ рдХреЗ рд▓рд┐рдП рд╕реВрдЪрдХрд╛рдВрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред </li><li>  Ts_vector рдлрд╝рдВрдХреНрд╢рди рддрд╛рд▓рд┐рдХрд╛ рдХреА рдкреНрд░рддреНрдпреЗрдХ рдкрдВрдХреНрддрд┐ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред </li><li>  Ts_rank рдлрд╝рдВрдХреНрд╢рди рдХреЛ рддрд╛рд▓рд┐рдХрд╛ рдХреА рдкреНрд░рддреНрдпреЗрдХ рдкрдВрдХреНрддрд┐ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред </li></ol><br><p>  рдпрд╣ рд╕рдм рдЗрд╕ рддрдереНрдп рдХреА рдУрд░ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЦреЛрдЬ <em>рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ</em> рд▓рдВрдмрд╛ рд╕рдордп рд▓реЗрддреА рд╣реИред  рдпреБрджреНрдзрдХ рдЖрдзрд╛рд░ рдкрд░ рдкрд░рд┐рдгрд╛рдо рджреЗрдЦреЗрдВ: </p><br><pre> <code class="plaintext hljs">Gather Merge (actual time=420289.477..420313.969 rows=58742 loops=1) Workers Planned: 2 Workers Launched: 2 -&gt; Sort (actual time=420266.150..420267.935 rows=19581 loops=3) Sort Key: (ts_rank(to_tsvector(document_text), plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 2278kB -&gt; Parallel Seq Scan on documents_document (actual time=65.454..420235.446 rows=19581 loops=3) Filter: (to_tsvector(document_text) @@ plainto_tsquery(''::text)) Rows Removed by Filter: 140636 Planning time: 3.706 ms Execution time: 420315.895 ms</code> </pre> <br><p>  420 рд╕реЗрдХрдВрдб!  рдПрдХ рдирд┐рд╡реЗрджрди рдХреЗ рд▓рд┐рдП! </p><br><p>  рдЖрдзрд╛рд░ рднреА рдкреНрд░рдкрддреНрд░ рдХреА рдмрд╣реБрдд рд╕рд╛рд░реА vorings рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ <code>[54000] word is too long to be indexed</code> ред  рдЪрд┐рдВрддрд╛ рдХреА рдХреЛрдИ рдмрд╛рдд рдирд╣реАрдВ рд╣реИред  рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ рдореЗрд░реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ WYSIWYG рд╕рдВрдкрд╛рджрдХ рдореЗрдВ рдмрдирд╛рдП рдЧрдП рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рд╣реИрдВред  рдЗрд╕рдореЗрдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ <code>&amp;nbsp;</code>  рдЬрд╣рд╛рдВ рднреА рд╕рдВрднрд╡ рд╣реЛ, рдФрд░ рдПрдХ рдкрдВрдХреНрддрд┐ рдореЗрдВ 54 рд╣рдЬрд╛рд░ рд╣реИрдВред  рдЗрд╕ рд▓рдВрдмрд╛рдИ рдХреЗ рд╢рдмреНрджреЛрдВ рдХреЛ рдирдЬрд░рдЕрдВрджрд╛рдЬ рдХрд░ рджреЗрддрд╛ рд╣реИ рдФрд░ рдПрдХ рдРрд╕реА рд╡реЙрд░реНрдбрд┐рдВрдЧ рд▓рд┐рдЦрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЕрдХреНрд╖рдо рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред </p><br><p>  рд╣рдо рдиреЛрдЯ рдХрд┐рдП рдЧрдП рд╕рднреА рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдФрд░ рдЦреЛрдЬ рдХреЛ рдЧрддрд┐ рджреЗрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВрдЧреЗред </p><br><h2 id="naivno-optimiziruem-poisk">  рд╣рдо рднреЛрд▓реЗрдкрди рд╕реЗ рдЦреЛрдЬ рдХреЛ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд░рддреЗ рд╣реИрдВ </h2><br><p>  рд╣рдо рдореБрдХрд╛рдмрд▓рд╛ рдмреЗрд╕ рдХреЗ рд╕рд╛рде рдирд╣реАрдВ рдЦреЗрд▓реЗрдВрдЧреЗ, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ - рд╣рдо рдПрдХ рдЯреЗрд╕реНрдЯ рдмреЗрд╕ рдмрдирд╛рдПрдВрдЧреЗред  рдЗрд╕рдореЗрдВ ~ 12 рд╣рдЬрд╛рд░ рджрд╕реНрддрд╛рд╡реЗрдЬ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред  рдЙрджрд╛рд╣рд░рдг рд╕реЗ рдЕрдиреБрд░реЛрдз рдХреЛ рд╡рд╣рд╛рдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ ~ 35 рд╕реЗрдХрдВрдбред  рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд░реВрдк рд╕реЗ рд▓рдВрдмрд╛! </p><br><div class="spoiler">  <b class="spoiler_title">рдкрд░рд┐рдгрд╛рдо рджреЗрдЦреЗрдВ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Sort (actual time=35431.874..35432.208 rows=3593 loops=1) Sort Key: (ts_rank(to_tsvector(document_text), plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 377kB -&gt; Seq Scan on documents_document (actual time=8.470..35429.261 rows=3593 loops=1) Filter: (to_tsvector(document_text) @@ plainto_tsquery(''::text)) Rows Removed by Filter: 9190 Planning time: 0.200 ms Execution time: 35432.294 ms</code> </pre> </div></div><br><h3 id="indeks">  рд╕реВрдЪреА </h3><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдЖрдкрдХреЛ рдПрдХ рд╕реВрдЪрдХрд╛рдВрдХ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛: рдПрдХ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рд╕реВрдЪрдХрд╛рдВрдХред </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_gin_document <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> documents_document <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gin (to_tsvector(<span class="hljs-string"><span class="hljs-string">'russian'</span></span>, "document_text"));</code> </pre> <br><p>  рдЗрд╕ рддрд░рд╣ рдХреЗ рд╕реВрдЪрдХрд╛рдВрдХ рдХреЛ рд▓рдВрдмреЗ рд╕рдордп рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ - рдпрд╣ рдкрд░реАрдХреНрд╖рдг рдХреЗ рдЖрдзрд╛рд░ рдкрд░ ~ 26 рд╕реЗрдХрдВрдб рд▓рдЧ рдЧрдпрд╛ред  рдЙрд╕реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдЧреБрдЬрд░рдиреЗ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рд░рд┐рдХреЙрд░реНрдб рдХреЗ рд▓рд┐рдП to_tsvector рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдпрджреНрдпрдкрд┐ рдпрд╣ рдЕрднреА рднреА рдЦреЛрдЬ рдХреЛ 12 рд╕реЗрдХрдВрдб рддрдХ рдЧрддрд┐ рджреЗрддрд╛ рд╣реИ, рдлрд┐рд░ рднреА рдпрд╣ рдЕрдХреНрд╖рдореНрдп рд░реВрдк рд╕реЗ рд▓рдВрдмрд╛ рд╣реИ! </p><br><div class="spoiler">  <b class="spoiler_title">рдкрд░рд┐рдгрд╛рдо рджреЗрдЦреЗрдВ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Sort (actual time=12213.943..12214.327 rows=3593 loops=1) Sort Key: (ts_rank(to_tsvector('russian'::regconfig, document_text), plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 377kB -&gt; Bitmap Heap Scan on documents_document (actual time=3.849..12212.248 rows=3593 loops=1) Recheck Cond: (to_tsvector('russian'::regconfig, document_text) @@ plainto_tsquery(''::text)) Heap Blocks: exact=946 -&gt; Bitmap Index Scan on idx_gin_document (actual time=0.427..0.427 rows=3593 loops=1) Index Cond: (to_tsvector('russian'::regconfig, document_text) @@ plainto_tsquery(''::text)) Planning time: 0.109 ms Execution time: 12214.452 ms</code> </pre> </div></div><br><h3 id="mnogokratnyy-vyzov-to_tsvector">  рдмрд╛рд░-рдмрд╛рд░ рдХреЙрд▓ <code>to_tsvector</code> </h3><br><p>  рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ <code>tsvector</code> рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдбреЗрдЯрд╛ рдмрджрд▓рддреЗ рд╕рдордп, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдЖрдкрдХреЛ рдЗрд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ - рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЯреНрд░рд┐рдЧрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ, рдмреИрдХрдПрдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред </p><br><p>  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рджреЛ рддрд░реАрдХреЗ рд╣реИрдВ: </p><br><ol><li>  рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдХреЗ рд╕рд╛рде рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдЯрд╛рдЗрдк <code>tsvector</code> рдХрд╛ рдПрдХ рд╕реНрддрдВрдн рдЬреЛрдбрд╝реЗрдВред </li><li>  рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреА рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдПрдХ-рд╕реЗ-рдПрдХ рд╕рдВрдЪрд╛рд░ рдХреЗ рд╕рд╛рде рдПрдХ рдЕрд▓рдЧ рддрд╛рд▓рд┐рдХрд╛ рдмрдирд╛рдПрдВ, рдФрд░ рд╡рд╣рд╛рдВ рд╡реИрдХреНрдЯрд░ рд╕реНрдЯреЛрд░ рдХрд░реЗрдВред </li></ol><br><p>  рдкрд╣рд▓реЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЗ рдлрд╛рдпрджреЗ: рдЦреЛрдЬ рдореЗрдВ join-s рдХреА рдХрдореАред <br>  рджреВрд╕рд░реЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЗ рдлрд╛рдпрджреЗ: рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЗ рд╕рд╛рде рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рдбреЗрдЯрд╛ рдХреА рдХрдореА, рдпрд╣ рдкрд╣рд▓реЗ рдХреА рддрд░рд╣ рд╣реА рдЖрдХрд╛рд░ рд░рд╣рддрд╛ рд╣реИред  рдмреИрдХрдЕрдк рдХреЗ рд╕рд╛рде, рдЖрдкрдХреЛ <code>tsvector</code> рдкрд░ рд╕рдордп рдФрд░ рд╕реНрдерд╛рди рдмрд░реНрдмрд╛рдж рдирд╣реАрдВ рдХрд░рдирд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдЖрдкрдХреЛ рдмреИрдХрдЕрдк рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред </p><br><p>  рджреЛрдиреЛрдВ рдпрд╛рддреНрд░рд╛рдПрдВ рдЗрд╕ рддрдереНрдп рдХреА рдУрд░ рд▓реЗ рдЬрд╛рддреА рд╣реИрдВ рдХрд┐ рдбрд┐рд╕реНрдХ рдкрд░ рдбреЗрдЯрд╛ рджреЛрдЧреБрдирд╛ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ: рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдФрд░ рдЙрдирдХреЗ рд╡реИрдХреНрдЯрд░ рдХреЗ рдЧреНрд░рдВрде рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВред </p><br><p>  рдореИрдВрдиреЗ рдЕрдкрдиреЗ рд▓рд┐рдП рджреВрд╕рд░рд╛ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдЪреБрдирд╛, рдЗрд╕рдХреЗ рдлрд╛рдпрджреЗ рдореЗрд░реЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИрдВред </p><br><div class="spoiler">  <b class="spoiler_title">рд╕реВрдЪрдХрд╛рдВрдХ рдирд┐рд░реНрдорд╛рдг</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_gin_document <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gin ("document_text");</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">рдирдИ рдЦреЛрдЬ рдХреНрд╡реЗрд░реА</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> documents_document.id, ts_rank("text", plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_document <span class="hljs-keyword"><span class="hljs-keyword">LEFT JOIN</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> documents_document.id = documents_documentvector.document_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> "text" @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ts_rank("text", plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> </div></div><br><p>  рд▓рд┐рдВрдХ рдХреА рдЧрдИ рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдбреЗрдЯрд╛ рдЬреЛрдбрд╝реЗрдВ рдФрд░ рдПрдХ рдЗрдВрдбреЗрдХреНрд╕ рдмрдирд╛рдПрдВред  рдбреЗрдЯрд╛ рдХреЛ рдкрд░реАрдХреНрд╖рдг рдХреЗ рдЖрдзрд╛рд░ рдкрд░ 24 рд╕реЗрдХрдВрдб рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛, рдФрд░ рдПрдХ рдЗрдВрдбреЗрдХреНрд╕ рдмрдирд╛рдиреЗ рдореЗрдВ рдХреЗрд╡рд▓ <em>2.7 рд╕реЗрдХрдВрдб рдХрд╛ рд╕рдордп рд▓рдЧрд╛</em> ред  рдЗрдВрдбреЗрдХреНрд╕ рдФрд░ рдбреЗрдЯрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛, рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ, рдХрд╛рдлреА рддреЗрдЬреА рдирд╣реАрдВ рдЖрдИ, рд▓реЗрдХрд┐рди рдЗрдВрдбреЗрдХреНрд╕ рдХреЛ рдЕрдм <em>рдмрд╣реБрдд</em> рдЬрд▓реНрджреА рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><p>  рдФрд░ рдХрд┐рддрдиреА рдмрд╛рд░ рдЦреЛрдЬ рддреЗрдЬ рд╣реБрдИ рд╣реИ? </p><br><pre> <code class="plaintext hljs">Sort (actual time=48.147..48.432 rows=3593 loops=1) Sort Key: (ts_rank(documents_documentvector.text, plainto_tsquery(''::text))) DESC Sort Method: quicksort Memory: 377kB -&gt; Hash Join (actual time=2.281..47.389 rows=3593 loops=1) Hash Cond: (documents_document.id = documents_documentvector.document_id) -&gt; Seq Scan on documents_document (actual time=0.003..2.190 rows=12783 loops=1) -&gt; Hash (actual time=2.252..2.252 rows=3593 loops=1) Buckets: 4096 Batches: 1 Memory Usage: 543kB -&gt; Bitmap Heap Scan on documents_documentvector (actual time=0.465..1.641 rows=3593 loops=1) Recheck Cond: (text @@ plainto_tsquery(''::text)) Heap Blocks: exact=577 -&gt; Bitmap Index Scan on idx_gin_document (actual time=0.404..0.404 rows=3593 loops=1) Index Cond: (text @@ plainto_tsquery(''::text)) Planning time: 0.410 ms Execution time: 48.573 ms</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">рдЬреБрдбрд╝рдиреЗ рдХреЗ рдмрд┐рдирд╛ рдореЗрдЯреНрд░рд┐рдХреНрд╕</b> <div class="spoiler_text"><p>  рдкреНрд░рд╢реНрди: </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, ts_rank("text", plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rank <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> "text" @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rank;</code> </pre> <br><p>  рдкрд░рд┐рдгрд╛рдо: </p><br><pre>  рд╕реЙрд░реНрдЯ (рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп = 44.339..44.487 рдкрдВрдХреНрддрд┐рдпрд╛рдБ = 3593 рд▓реВрдк = 1)
   рд╕реЙрд░реНрдЯ рдХреА: (ts_rank (рдЯреЗрдХреНрд╕реНрдЯ, plainto_tsquery ('рдХреНрд╡реЗрд░реА' :: рдЯреЗрдХреНрд╕реНрдЯ)))
   рд╕реЙрд░реНрдЯ рд╡рд┐рдзрд┐: Quicksort рдореЗрдореЛрд░реА: 265kB
   -&gt; рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдкрд░ рдмрд┐рдЯрдореИрдк рд╣реА рд╕реНрдХреИрди рдХрд░реЗрдВ_рдирд┐рд░реНрджреЗрд╢рдХ (рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп = 0.692..43.682 рдкрдВрдХреНрддрд┐рдпрд╛рдБ = 3593 рд▓реВрдк = 1)
         Recheck Cond: (рдЯреЗрдХреНрд╕реНрдЯ @@ plainto_tsquery ('рдХреНрд╡реЗрд░реА' :: рдЯреЗрдХреНрд╕реНрдЯ))
         рдвреЗрд░ рдмреНрд▓реЙрдХ: рд╕рдЯреАрдХ = 577
         -&gt; idx_gin_document рдкрд░ рдмрд┐рдЯрдореИрдк рдЗрдВрдбреЗрдХреНрд╕ рд╕реНрдХреИрди (рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп = 0.577..0.577 рдкрдВрдХреНрддрд┐рдпрд╛рдБ = 3593 рд▓реВрдк = 1)
               рд╕реВрдЪрдХрд╛рдВрдХ рдХрдВрдбреЛрдо: (рдкрд╛рда @@ plainto_tsquery ('рдХреНрд╡реЗрд░реА' :: рдкрд╛рда))
 рдпреЛрдЬрдирд╛ рд╕рдордп: 0.182 рдПрдордПрд╕
 рдирд┐рд╖реНрдкрд╛рджрди рд╕рдордп: 44.610 рдПрдордПрд╕
</pre></div></div><br><p>  рдпрдХреАрди рдирд╣реАрдВ рд╣реЛрддрд╛!  рдФрд░ рдпрд╣ рд╢рд╛рдорд┐рд▓ рд╣реЛрдиреЗ рдФрд░ <code>ts_rank</code> рдмрд╛рд╡рдЬреВрдж рд╣реИред  рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХрд╛рдлреА рд╕реНрд╡реАрдХрд╛рд░реНрдп рдкрд░рд┐рдгрд╛рдо рд╣реИ, рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕рдордп рдЦреЛрдЬ рджреНрд╡рд╛рд░рд╛ рдирд╣реАрдВ, рдмрд▓реНрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ <code>ts_rank</code> рд▓рд┐рдП <code>ts_rank</code> рдХреА рдЧрдгрдирд╛ рджреНрд╡рд╛рд░рд╛ <code>ts_rank</code> рдЬрд╛рдПрдЧрд╛ред </p><br><h3 id="mnogokratnyy-vyzov-ts_rank">  <code>ts_rank</code> рдПрдХрд╛рдзрд┐рдХ рдХреЙрд▓ </h3><br><p>  рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рд╣рдордиреЗ рдЕрдкрдиреА рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╣рд▓ рдХрд░ рд▓рд┐рдпрд╛ рд╣реИ, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗред  44 рдорд┐рд▓реАрд╕реЗрдХрдВрдб рдПрдХ рд╕рднреНрдп рдиреЗрддреГрддреНрд╡ рд╕рдордп рд╣реИред  рд╕реБрдЦрдж рдЕрдВрдд рдХрд░реАрдм рд▓рдЧрддрд╛ рд╣реИ?  рд╡рд╣рд╛рдБ рдпрд╣ рдерд╛! </p><br><p>  <code>ts_rank</code> рдмрд┐рдирд╛ рдПрдХ рд╣реА рдХреНрд╡реЗрд░реА рдЪрд▓рд╛рдПрдБ рдФрд░ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреА рддреБрд▓рдирд╛ рдХрд░реЗрдВред </p><br><div class="spoiler">  <b class="spoiler_title">Ts_rank рдХреЗ рдмрд┐рдирд╛</b> <div class="spoiler_text"><p>  рдкреНрд░рд╢реНрди: </p><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> document_id, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rank <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> documents_documentvector <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> "text" @@ plainto_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rank;</code> </pre> <br><p>  рдкрд░рд┐рдгрд╛рдо: </p><br><pre> <code class="plaintext hljs">Bitmap Heap Scan on documents_documentvector (actual time=0.503..1.609 rows=3593 loops=1) Recheck Cond: (text @@ plainto_tsquery(''::text)) Heap Blocks: exact=577 -&gt; Bitmap Index Scan on idx_gin_document (actual time=0.439..0.439 rows=3593 loops=1) Index Cond: (text @@ plainto_tsquery(''::text)) Planning time: 0.147 ms Execution time: 1.715 ms</code> </pre> </div></div><br><p>  1.7 рдПрдордПрд╕!  рддреАрд╕ рдЧреБрдирд╛ рддреЗрдЬ!  рдПрдХ рдореБрдХрд╛рдмрд▓рд╛ рдЖрдзрд╛рд░ рдХреЗ рд▓рд┐рдП, рдкрд░рд┐рдгрд╛рдо ~ 150 рдПрдордПрд╕ рдФрд░ 1.5 рд╕реЗрдХрдВрдб рд╣реИрдВред  рдХрд┐рд╕реА рднреА рдорд╛рдорд▓реЗ рдореЗрдВ рдЕрдВрддрд░ рдкрд░рд┐рдорд╛рдг рдХрд╛ рдПрдХ рдХреНрд░рдо рд╣реИ, рдФрд░ 1.5 рд╕реЗрдХрдВрдб рд╡рд╣ рд╕рдордп рдирд╣реАрдВ рд╣реИ рдЬреЛ рдЖрдк рдЖрдзрд╛рд░ рд╕реЗ рдЙрддреНрддрд░ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред  рдХреНрдпрд╛ рдХрд░реЗрдВ? </p><br><p>  рдЖрдк рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХрддрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЫрдВрдЯрдиреА рдмрдВрдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ; рдЖрдк рдЧрд┐рдирддреА рдХреЗ рд▓рд┐рдП рд▓рд╛рдЗрдиреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдХрдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рд╕рднреА <code>ts_rank</code> рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЗ рд▓рд┐рдП <code>ts_rank</code> рдЧрдгрдирд╛ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП, рдЕрдиреНрдпрдерд╛ рдЙрдиреНрд╣реЗрдВ рд╕реЙрд░реНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)ред </p><br><p>  рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдХреБрдЫ рд╕реНрдерд╛рдиреЛрдВ рдкрд░, рд╕рдмрд╕реЗ рд▓рдЧрд╛рддрд╛рд░ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдХреИрд╢ рдХрд░рдиреЗ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИ (рдФрд░, рддрджрдиреБрд╕рд╛рд░, рдХреЙрд▓ ts_rank)ред  рд▓реЗрдХрд┐рди рдореИрдВ рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЛ рдкрд╕рдВрдж рдирд╣реАрдВ рдХрд░рддрд╛: рд╕рд╣реА рдкреНрд░рд╢реНрдиреЛрдВ рдХрд╛ рд╕рд╣реА рдЪрдпрди рдХрд░рдирд╛ рдХрд╛рдлреА рдХрдард┐рди рд╣реИ, рдФрд░ рдЧрд▓рдд рдкреНрд░рд╢реНрдиреЛрдВ рдкрд░ рдЦреЛрдЬ рдЕрднреА рднреА рдзреАрдореА рд╣реЛрдЧреАред </p><br><p>  рдореБрдЭреЗ рдмрд╣реБрдд рдкрд╕рдВрдж рд╣реИ рдХрд┐ рд╕реВрдЪрдХрд╛рдВрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж рдбреЗрдЯрд╛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХреНрд░рдордмрджреНрдз рд░реВрдк рдореЗрдВ рдЖрдпрд╛, рдЬреИрд╕рд╛ рдХрд┐ рд╕реНрдлрд┐рдВрдХреНрд╕ рдХрд░рддрд╛ рд╣реИред  рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, PostgreSQL рдореЗрдВ рдмреЙрдХреНрд╕ рд╕реЗ рдХреБрдЫ рднреА рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><p>  рд▓реЗрдХрд┐рди рд╣рдо рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рдереЗ - рдЖрд░рдпреВрдПрдо рдЗрдВрдбреЗрдХреНрд╕ рдРрд╕рд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╡рд┐рд╡рд░рдг рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЗрд╕рдХреЗ рд▓реЗрдЦрдХреЛрдВ</a> рдХреА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкреНрд░рд╕реНрддреБрддрд┐ рдореЗрдВ</a> ред  рдпрд╣ рдЕрдиреБрд░реЛрдз рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдирдХрд╛рд░реА рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЖрдкрдХреЛ рд╕реАрдзреЗ рддрдерд╛рдХрдерд┐рдд рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  <code>tsvector</code> рдФрд░ <code>tsquery</code> рдмреАрдЪ "рджреВрд░реА" рдФрд░ рд╕реВрдЪрдХрд╛рдВрдХ рдХреЛ рд╕реНрдХреИрди рдХрд░рдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдПрдХ рд╣рд▓ рдХрд┐рдпрд╛ рд╣реБрдЖ рдкрд░рд┐рдгрд╛рдоред </p><br><p>  рд▓реЗрдХрд┐рди рдПрдХ рдЬреАрдЖрдИрдПрди рдлреЗрдВрдХрдирд╛ рдФрд░ рдЖрд░рдпреВрдПрдо рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рдЕрднреА рдЗрд╕рдХреЗ рд▓рд╛рдпрдХ рдирд╣реАрдВ рд╣реИред  рдЗрд╕рдореЗрдВ рдЖрд╡реЗрджрди рдХреЗ minuses, pluses рдФрд░ рд╕реАрдорд╛рдПрдВ рд╣реИрдВ - рдореИрдВ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдЧрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рд▓рд┐рдЦреВрдВрдЧрд╛ред </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi442170/">https://habr.com/ru/post/hi442170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi442158/index.html">рд╣реАрд░реЛ III - 20 рд╕рд╛рд▓ рдкреБрд░рд╛рдирд╛ рд╣реИ</a></li>
<li><a href="../hi442162/index.html">STM32 рддреЗрдЬреА рд╕реЗ рд╢реБрд░реВред рднрд╛рдЧ 1 рд╕реЙрдлреНрдЯрд╡реЗрдпрд░, рд╕рд╛рдордЧреНрд░реА, рдШрди рдПрдордПрдХреНрд╕</a></li>
<li><a href="../hi442164/index.html">Roskomnadzor рдиреЗ рдЧреИрд░-рдЕрдиреБрдкрд╛рд▓рди рдХреЗ рд▓рд┐рдП рдлреЗрд╕рдмреБрдХ рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХреА рдпреЛрдЬрдирд╛ рдмрдирд╛рдИ</a></li>
<li><a href="../hi442166/index.html">рдорд┐рдиреНрд╕реНрдХ рдХреА рд╡реИрдХрд▓реНрдкрд┐рдХ рдореЗрдЯреНрд░реЛ рдпреЛрдЬрдирд╛</a></li>
<li><a href="../hi442168/index.html">рд╣рд╛рдмрд░рд╛ рдореЗрдЧрд╛рд░реЗрдЯрд┐рдВрдЧ: 12 рд╡рд░реНрд╖реЛрдВ рдХреЗ рд▓рд┐рдП рд╣рдмрд░ рдХрд╛ рд╕рд░реНрд╡рд╢реНрд░реЗрд╖реНрда рд▓реЗрдЦ рдФрд░ рдЖрдБрдХрдбрд╝реЗред рднрд╛рдЧ 2/2</a></li>
<li><a href="../hi442176/index.html">рдХреИрдВрд╕рд░ рдХреЛ рдирд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рдЯреА-рд▓рд┐рдореНрдлреЛрд╕рд╛рдЗрдЯреЛрдВ рдХреА рдПрдХ рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рд╕реЗрдирд╛ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi442178/index.html">рд╣рд╛рдерд╛рдкрд╛рдИ - рдПрдХ рдорд╢реАрди рдЬреЛ рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдореЗрдВ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреА рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдареАрдХ рдХрд░ рд╕рдХрддреА рд╣реИ</a></li>
<li><a href="../hi442180/index.html">рд╣рдо рдореБрдлреНрдд рдореЗрдВ "рд▓реЛрд╣рд╛" рджреЗрддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi442182/index.html">рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдХрдХреНрд╖: рд╕рдВрдпреБрдХреНрдд рд░рд╛рдЬреНрдп рдЕрдореЗрд░рд┐рдХрд╛ рдореЗрдВ рдлреЗрд╕рдмреБрдХ рдордзреНрдпрд╕реНрдереЛрдВ рдХрд╛ рдЧреБрдкреНрдд рдЬреАрд╡рди</a></li>
<li><a href="../hi442184/index.html">рд╣реИрдХрд┐рдВрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдСрдЯреЛ рдСрдЯреЛред рд╡рд░реНрдЪреБрдЕрд▓ рдбреИрд╢рдмреЛрд░реНрдб</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>