<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍✈️ 🛃 🎽 TabPy untuk bekerja dengan data di ClickHouse dari Tableau 🙌🏽 👩‍🏭 💇🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Membangun komunikasi antara merek dan orang adalah apa yang kami di Dentsu Aegis Network lakukan setiap hari, dan analisis data merupakan bagian integ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TabPy untuk bekerja dengan data di ClickHouse dari Tableau</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dentsuaegisnetworkrussia/blog/477864/">  Membangun komunikasi antara merek dan orang adalah apa yang kami di Dentsu Aegis Network lakukan setiap hari, dan analisis data merupakan bagian integral dari pekerjaan ini.  Dalam beberapa kasus, proses ini tidak memerlukan ilmu data (meskipun kami memilikinya), maka kami menggunakan platform <a href="https://en.wikipedia.org/wiki/Tableau_Software">Tableau</a> BI.  Tujuan utamanya adalah untuk memberikan antarmuka yang nyaman bagi karyawan dan pelanggan kami untuk mengonsumsi data tanpa menulis skrip, kueri SQL, dll. <br><br>  Pada artikel ini, kami akan menjelaskan bagaimana kami berhasil menyelesaikan masalah Tableau berinteraksi dengan <a href="https://ru.wikipedia.org/wiki/ClickHouse">ClickHouse</a> . <br><a name="habracut"></a><br><h3>  Pernyataan umum masalah </h3><br>  Kami menghadapi tantangan klasik.  Kami punya banyak orang.  Mereka suka buah.  Beberapa orang menyukai satu buah, beberapa menyukai semua buah, dan sisanya dapat menyukai kombinasi buah apa pun. <br><img src="https://habrastorage.org/webt/lb/wp/om/lbwpomzrluk4hed_uihmxiko_xy.png" alt="gambar"><br>  Jadi, perlu untuk memungkinkan pengguna di dashboard yang dibangun di Tableau untuk secara acak memilih beberapa buah dan melihat berapa banyak orang menyukai setidaknya satu buah dari set.  Tentu saja, kami tidak memiliki buah, tetapi orang-orang nyata, hanya saja pada "buah" lebih mudah untuk memahami masalahnya. <br><br>  Jumlah data dalam kasus kami cukup besar.  Ada 13 ribu "buah" yang berbeda.  "Buah" paling populer memiliki hampir 34 juta penggemar.  Rata-rata, 450 ribu orang saling mencintai “buah”.  Total pecinta buah - 282 juta. <br><br><h3>  Solusi dahi pertama </h3><br>  Kebetulan data untuk tugas ini kami miliki di <a href="https://ru.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a> (PG) dan di ClickHouse (CH).  Di PG ada tabel referensi tentang "buah-buahan", di CH - meja besar dengan struktur: pengidentifikasi "buah" dan pengidentifikasi orang yang menyukai "buah" ini.  Tidak ada konektor asli untuk CH di Tableau, dan saya masih tidak ingin mentransfer data di suatu tempat, karena ini akan membutuhkan pengerjaan ulang yang serius dari sistem yang ada. <br><br>  Kami mencoba menghubungkan Tableau ke CH menggunakan driver ODBC dan melihat apa yang terjadi. <br><br><ul><li>  Tidak semua driver ODBC sama-sama bermanfaat.  Kami memerlukan versi tertentu di mana bagian yang diperlukan dari fungsi berfungsi, tetapi tidak ada jaminan bahwa sisanya akan berfungsi jika Anda tiba-tiba membutuhkannya. </li><li>  Kami tidak dapat menarik semua data ke ekstrak Tableau, karena itu 13.000 * 450.000 = 5.850.000.000 catatan. </li></ul><br>  Selanjutnya, kami memutuskan untuk menggunakan sampel di dalam kueri ke database CH, yaitu, untuk membuat estimasi jumlah pecinta dari kombinasi "buah" yang dipilih tidak pada semua orang, tetapi pada sampel lima persen untuk membuat ekstrak lebih kecil.  Selain itu, kami segera membuat penggabung dalam mengambil dari CH dengan direktori "buah" PG untuk mendapatkan nama "buah".  Ini membantu - ekstrak kami dapat dihasilkan dalam 5 jam. <br><br>  Kami perlu memperbarui data di dasbor sekali sehari, jadi 5 jam memperbarui ekstrak tampaknya baik-baik saja - kami akan memperbarui di malam hari.  Tetapi di masa depan kita akan membutuhkan kapasitas tambahan: harus ada lebih banyak "buah-buahan", sehingga jumlah dan ukuran kelompok orang yang persimpangan kita perlu hitung juga harus meningkat.  Karena itu, pembaruan ekstrak yang lama sama sekali bukan pilihan kami. <br><br>  Selain itu, ada masalah lain karena pengambilan sampel.  Kebetulan di bagian dashboard yang berbeda angkanya, yang seharusnya bertepatan, berbeda di negara kita.  Ini disebabkan oleh fakta bahwa di satu tempat kami menghitung jumlah pecinta satu buah secara akurat, dan sebagian dengan kombinasi buah-buahan - tidak akurat.  Kami maupun pengguna kami tidak menyukai hasil ini. <br><br>  Kemudian kami memutuskan untuk tidak membuat ekstrak sama sekali.  Untuk menghindari memuat sejumlah besar data, kami membagi dataset dan menggunakan koneksi langsung untuk CH.  Di antara set data, koneksi dibuat menggunakan fungsionalitas hubungan Tableau Edit bawaan.  Sumber data PG dibuat primer dan dihubungkan ke CH sebagai sekunder, menggunakan pengidentifikasi "buah" yang ada di kedua tabel. <br><br>  Dengan demikian, kami dapat memfilter sumber data sekunder menggunakan primer (Pencampuran data).  Tapi kami mengharapkan kegagalan, karena setelah membuang filter dari satu sumber data ke yang lain, kami harus menggunakan fungsi penghitungan orang di subset yang dihasilkan (COUNTD), dan pencampuran data memiliki batasan yang tidak memungkinkan untuk dilakukan.  Fungsi seperti itu secara langsung dengan koneksi data seperti itu pada prinsipnya tidak bekerja. <br><br>  Ada solusi yang membantu menghindari batasan Tableau ini, tetapi dapat digunakan pada kumpulan data yang relatif kecil, yang jelas tidak demikian dalam kasus kami. <br><br>  Setelah itu, kami mencoba opsi lain.  Kumpulan data masih terbagi dan menggunakan koneksi langsung untuk CH.  Di sini, filter dari dataset dengan deskripsi "buah" ke dataset dengan penggemar "buah" dilemparkan ke dalam Tableau menggunakan aksi set.  Tetapi opsi ini pada akhirnya tidak cocok karena UI yang tidak nyaman.  Alih-alih filter yang akrab bagi pengguna, pengguna harus melihat seluruh daftar dan memilih "buah-buahan" melalui cntrl + klik, sedangkan fungsi yang berlaku tidak ada ketika semua nilai yang dipilih diterapkan sekaligus. <br><br>  Akibatnya, setelah semua upaya kami, kami harus kembali ke opsi dengan ekstrak dan pengambilan sampel, sangat lambat dan hanya memberikan jawaban perkiraan. <br><br><img src="https://habrastorage.org/webt/uh/5a/ie/uh5aiemfrjzz8f1wmeu54eg-flm.png" alt="gambar"><br><br><h3>  Solusi ditemukan </h3><br>  Jelas, kami tidak perlu menarik semua data ke ekstrak Tableau.  Pengguna tidak nyaman untuk melihat semua data sekaligus - jumlah orang yang menyukai semua "buah".  Dia membutuhkan satu set rata-rata 10 buah.  Sangat disayangkan Tableau tidak tahu bagaimana melakukan ini. <br><br>  Ada orang-orang di tim kami yang menulis dengan Python.  Oleh karena itu, kami memutuskan dalam pencarian kami untuk bergerak ke arah ini dan menemukan <a href="https://github.com/tableau/TabPy">TabPy</a> . <br><br>  TabPy adalah layanan web yang memungkinkan Anda untuk mendapatkan hasil mengeksekusi skrip Python di dalam penetapan biaya di Tableau. <br><br>  Cara kerjanya: <br><br><ol><li>  Tableau berinteraksi dengan TabPy dan, pada gilirannya, dengan Python menggunakan apa yang disebut dengan Script Functions.  Script Functions berisi skrip Python itu sendiri, tipe data hasil yang diperlukan, dan argumen yang kami sampaikan ke fungsi ini.  Dalam kasus kami, argumennya adalah pengidentifikasi "buah-buahan", jumlah pecinta yang ingin kami hitung. </li><li>  TabPy mengonversi teks Fungsi Skrip yang diterima ke skrip dan meneruskannya ke penerjemah.  Koneksi ke pangkalan CH didaftarkan oleh kami di dalam skrip. </li><li>  Selanjutnya, TabPy mengembalikan hasil dari skrip yang dieksekusi kembali ke Tableau. </li></ol><br><br><img src="https://habrastorage.org/webt/a9/me/qi/a9meqia3hjlrx1niaje_fb5lfww.png" alt="gambar"><br><br>  Dalam Fungsi Skrip, argumen selalu dilewatkan sebagai array, hasilnya juga dikembalikan oleh array. <br><br>  Tidak semuanya langsung bekerja.  Hal utama yang kami mengerti: menulis skrip Python langsung di bidang terhitung di Tableau bukanlah ide yang baik.  Karena dua alasan: <br><br><ol><li>  Di dalam Fungsi Script, terkadang sulit untuk menggunakan sintaks Python yang sudah dikenal.  Misalnya, beberapa penawaran tidak diterima. </li><li>  Berpikir tentang dukungan di masa depan untuk dasbor, kami menyadari bahwa jika kami perlu mengubah skrip, maka setiap kali kami harus mengubahnya di buku Tableau itu sendiri.  Dan ini jelas bukan cara terbaik, karena kami melakukan yang terbaik untuk menghindari dukungan manual untuk dasbor. </li></ol><br>  Oleh karena itu, kami menggunakan hal lain - <a href="">Klien TabPy</a> . <br><br>  TabPy Client adalah pustaka yang memungkinkan Anda untuk mempublikasikan skrip Python di server TabPy dan kemudian memanggil mereka di dalam Tableau.  Saat menggunakannya, alih-alih menulis skrip di dalam Tableau, kami memanggil file .py di server TabPy menggunakan parameter yang ditentukan di dalamnya, meneruskan argumen ke sana, dan menjalankannya. <br><br>  Pendekatan ini memecahkan masalah kami menggunakan TabPy dan Tableau.  Script ditulis dan diuji dalam lingkungan pengembangan yang sudah dikenal dan disimpan secara terpisah dari buku, yang sekarang tidak memerlukan dukungan manual. <br><br>  Untuk menyelesaikan masalah khusus kami, kami harus melakukan yang berikut. <br>  Pada awalnya kami mencoba menyelesaikannya tanpa menggunakan TabPy Client.  Dalam hal ini, bidang Perhitungan bentuk berikut ini dibuat di dalam Tableau: <br><div class="scrollable-table"><table><tbody><tr><td>  JIKA PERTAMA () == 0 <br>  MAKA <br>  SCRIPT_INT (" <br>  dari clickhouse_driver, impor Klien <br>  client = Client (host = host_name, database = database_name, user = user_name, kata sandi = kata sandi) <br><br>  ----- script_text ----- <br><br>  ", SUM ([orang]), ATTR ([fruits_id])) <br>  Akhir </td></tr></tbody></table></div>  Itu berhasil, tetapi ada masalah yang dijelaskan di atas.  Ketika kami menemukan TabPy Client, kami menyadari bahwa dengan membagi bidang Perhitungan dan skrip itu sendiri, kami mendapatkan sistem yang lebih nyaman dan benar.  Begini tampilannya bidang dan file .py dengan skrip: <br><div class="scrollable-table"><table><tbody><tr><td>  Bidang perhitungan </td><td>  SCRIPT_INT (" <br>  return tabpy.query ('people_count_test', _ arg1, _arg2) ['response'] <br>  ", SUM ([orang]), ATTR ([fruits_id])) </td></tr><tr><td>  File saya </td><td>  dari clickhouse_driver, impor Klien <br>  impor tabpy_client <br>  connection = tabpy_client.Client ('http: // localhost: 9004 /') <br>  def unique_people_count (orang, fruits_id): <br>  client = Client (host = host_name, database = database_name, user = user_name, kata sandi = kata sandi) <br><br>  ----- script_text ----- <br><br>  connection.deploy ('people_count_test', unique_people_count, 'comment', override = True) </td></tr></tbody></table></div>  Di sini Anda dapat melihat bahwa 'people_count_test' adalah pengidentifikasi untuk Klien TabPy, karena itu jelas skrip mana yang harus dijalankan dalam bidang Perhitungan ini. <br><br>  Dan pada akhirnya, pendekatan inilah yang benar-benar memuaskan kami. <br><br><img src="https://habrastorage.org/webt/ef/_k/g3/ef_kg3lc57jwo3zktnbxivckhro.png" alt="gambar"><br><br><h3>  Ringkasan </h3><br>  Pengguna puas karena mereka dapat secara sewenang-wenang memilih kombinasi "buah-buahan" dan dengan cepat mendapatkan jumlah penggemar setidaknya satu dari mereka, dan angka-angka di berbagai bagian dasbor adalah sama. <br><br>  Pengembang BI senang bahwa Anda dapat bekerja dengan ClickHouse dari Tableau, tanpa harus terhubung secara langsung. <br><br>  Tableau Server kami senang bahwa Anda tidak perlu membuat ekstrak besar di malam hari. <br><br>  Secara umum, TabPy memberi pengembang BI lebih banyak kebebasan untuk bekerja dengan data ketika Tableau tidak memiliki solusi yang sesuai.  Misalnya, untuk menanamkan model sains data secara langsung di Tableau, tapi itu cerita lain sama sekali ... <br><br>  Artikel ini ditulis bersama dengan rekan-rekan saya Dimitri Shcherbenko ( <a href="https://habr.com/ru/users/dima_vs/" class="user_link">dima_vs</a> ) dan Sukhoveev Ivan ( <a href="https://habr.com/ru/users/suho_v/" class="user_link">suho_v</a> ) R&amp;D Dentsu Aegis Network Russia. <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id477864/">https://habr.com/ru/post/id477864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id477852/index.html">Kemunafikan tidak beracun</a></li>
<li><a href="../id477856/index.html">Akselerator flash PCI-E dari 800GB hingga 6.4TB: dari awal hingga akhir di PC / server biasa</a></li>
<li><a href="../id477858/index.html">Pekerjaan di luar meja: proyek apa yang benar-benar terungkap setelah pra-akselerasi?</a></li>
<li><a href="../id477860/index.html">Bagaimana layanan basis data dikelola diatur dalam Yandex. Cloud</a></li>
<li><a href="../id477862/index.html">Jadi itu mungkin? Sains dan TI dalam satu konferensi</a></li>
<li><a href="../id477866/index.html">Seminar: Solusi IT hibrid untuk bisnis. 5 Desember, St. Petersburg</a></li>
<li><a href="../id477870/index.html">Dasbor Grafana untuk sistem bir BeerTender</a></li>
<li><a href="../id477872/index.html">c.tech: Data Sense # 4 rilis Tahun Baru</a></li>
<li><a href="../id477874/index.html">CDN dinamis untuk streaming WebRTC dengan latensi rendah dan transkoding</a></li>
<li><a href="../id477876/index.html">CDN Dinamis untuk Streaming WebRTC Latensi Rendah dengan Transkoding</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>