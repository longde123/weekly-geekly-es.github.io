<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî¨ üóíÔ∏è üöß GitLab pour le projet de livraison continue sur les technologies InterSystems: conteneurs üíáüèª ü§∏üèæ üÜö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article est la suite d'un article sur l'organisation des processus d' int√©gration continue / livraison continue qui automatisent l'assemblage, les...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GitLab pour le projet de livraison continue sur les technologies InterSystems: conteneurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/intersystems/blog/420749/"><p>  Cet article est la suite d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> sur l'organisation des processus d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">int√©gration continue</a> / livraison continue qui automatisent l'assemblage, les tests et la livraison des applications applicables aux solutions bas√©es sur la plate-forme InterSystems. </p><br><p>  Consid√©rez des sujets tels que: </p><br><ul><li>  Conteneurs 101 </li><li>  Conteneurs √† diff√©rentes √©tapes du cycle de d√©veloppement logiciel </li><li>  Livraison continue avec conteneurs <a name="habracut"></a></li></ul><br><h1 id="konteynery-101">  Conteneurs 101 </h1><br><p>  Beaucoup d'articles et de livres ont √©t√© √©crits sur les conteneurs et la conteneurisation, je vais donc faire ici une petite introduction, qui ne pr√©tend cependant pas √™tre d√©finitive.  Commen√ßons donc. </p><br><p>  Les conteneurs, techniquement, sont une m√©thode de virtualisation dans laquelle le noyau du syst√®me d'exploitation prend en charge plusieurs instances isol√©es d'espace utilisateur (conteneurs), au lieu d'une.  Cela ressemble visuellement √† ceci: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/114/c21/985/114c21985549c134bf91685e2b15d1d3.jpg" alt="Docker vs VM"></p><br><p>  Il est important de noter que les conteneurs ne sont pas des machines virtuelles, voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bon article</a> sur leurs diff√©rences. </p><br><h2 id="preimuschestva-konteynerov">  Avantages du conteneur </h2><br><p>  L'utilisation de conteneurs pr√©sente plusieurs avantages: </p><br><ul><li>  La portabilit√© </li><li>  Efficacit√© </li><li>  L'isolement </li><li>  L√©g√®ret√© </li><li>  Immuabilit√© </li></ul><br><h3 id="portativnost">  La portabilit√© </h3><br><p>  Le conteneur contient l'application ainsi que toutes les d√©pendances.  Cela facilite l'ex√©cution des applications dans divers environnements, tels que les serveurs physiques, les machines virtuelles, les environnements de test et les environnements de produits, et les clouds. </p><br><p>  De plus, la portabilit√© consiste dans le fait qu'apr√®s que l'image Docker est assembl√©e et qu'elle fonctionne correctement, elle fonctionnera n'importe o√π si Docker y fonctionne, c'est-√†-dire  sur les serveurs Windows, Linux et MacOS. </p><br><h3 id="effektivnost">  Efficacit√© </h3><br><p>  Lorsque vous travaillez avec des applications de machine virtuelle, avez-vous vraiment besoin de processus OS, de programmes syst√®me, etc.?  En r√®gle g√©n√©rale, non, seul le processus de votre candidature est int√©ressant.  Les conteneurs offrent exactement cela: seuls les processus qui sont clairement n√©cessaires sont lanc√©s dans le conteneur, et rien de plus.  √âtant donn√© que les conteneurs ne n√©cessitent pas de syst√®me d'exploitation distinct, ils utilisent moins de ressources.  Une machine virtuelle prend souvent plusieurs gigaoctets, tandis qu'un conteneur peut √™tre aussi petit que quelques m√©gaoctets, ce qui vous permet d'ex√©cuter beaucoup plus de conteneurs que les machines virtuelles sur un seul serveur. </p><br><p> √âtant donn√© que les conteneurs ont un niveau d'utilisation du serveur plus √©lev√©, moins de mat√©riel est requis, ce qui entra√Æne des co√ªts inf√©rieurs. </p><br><h3 id="izolyaciya">  L'isolement </h3><br><p>  Les conteneurs isolent l'application de tous les autres processus et bien que plusieurs conteneurs puissent s'ex√©cuter sur le m√™me serveur, ils peuvent √™tre compl√®tement ind√©pendants les uns des autres.  Toute interaction entre conteneurs doit √™tre explicitement d√©clar√©e.  Si un conteneur tombe en panne, cela n'affecte pas les autres conteneurs et peut √™tre red√©marr√© rapidement.  La s√©curit√© est √©galement renforc√©e par cet isolement.  Par exemple, l'exploitation d'une vuln√©rabilit√© de serveur Web sur un h√¥te peut donner √† un attaquant un acc√®s √† l'int√©gralit√© du serveur, mais dans le cas d'un conteneur, un attaquant n'aura acc√®s qu'au conteneur du serveur Web. </p><br><h3 id="lyogkost">  L√©g√®ret√© </h3><br><p>  √âtant donn√© que les conteneurs ne n√©cessitent pas de syst√®me d'exploitation distinct, ils peuvent √™tre d√©marr√©s, arr√™t√©s ou red√©marr√©s en quelques secondes, ce qui acc√©l√©rera tous les processus associ√©s, y compris les processus d'int√©gration continue.  Vous pouvez commencer √† d√©velopper plus rapidement et ne pas perdre de temps √† configurer votre environnement. </p><br><h3 id="neizmennost-immutability">  Immuabilit√© </h3><br><p>  L'infrastructure immuable se compose de composants immuables qui sont remplac√©s pour chaque d√©ploiement et non mis √† jour.  La coh√©rence r√©duit les incoh√©rences et vous permet de r√©pliquer et de vous d√©placer facilement et rapidement entre les diff√©rents √©tats de votre application.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Plus sur l'immuabilit√©</a> . </p><br><h2 id="novye-vozmozhnosti">  De nouvelles fonctionnalit√©s </h2><br><p>  Tous ces avantages vous permettent de g√©rer votre infrastructure et vos applications d'une mani√®re nouvelle. </p><br><h3 id="orkestraciya">  Orchestration </h3><br><p>  Les machines virtuelles et les serveurs au fil du temps acqui√®rent souvent une "personnalit√©", ce qui entra√Æne de nombreuses surprises g√©n√©ralement d√©sagr√©ables √† l'avenir.  Une solution √† ce probl√®me est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Infrastructure as a Code</a> (IoC) - gestion de l'infrastructure √† l'aide d'un mod√®le descriptif utilisant un syst√®me de contr√¥le de version. </p><br><p>  Lors de l'utilisation d'IoC, l'√©quipe de d√©ploiement d'environnement apporte toujours l'environnement cible √† la m√™me configuration, quel que soit l'√©tat initial de l'environnement.  Ceci est r√©alis√© en configurant automatiquement un environnement existant ou en recr√©ant l'environnement √† partir de z√©ro. </p><br><p>  √Ä l'aide d'IoC, les d√©veloppeurs apportent des modifications √† la description de l'environnement.  Par la suite, l'environnement cible est modifi√© dans un nouvel √©tat.  Si vous devez apporter des modifications mercredi, sa description est modifi√©e. </p><br><p>  Tout cela est beaucoup plus facile √† faire avec des conteneurs.  L'arr√™t du conteneur et le d√©marrage d'un nouveau prend quelques secondes, et l'allocation d'une nouvelle machine virtuelle prend quelques minutes. </p><br><h3 id="masshtabirovanie">  Mise √† l'√©chelle </h3><br><p>  Les outils d'orchestration peuvent √©galement fournir une mise √† l'√©chelle horizontale en fonction de la charge actuelle.  Il est possible d'ex√©cuter autant de conteneurs que n√©cessaire et de faire √©voluer l'application en cons√©quence.  Tout cela r√©duit √©galement le co√ªt de l'application. </p><br><h1 id="konteynery-na-raznyh-etapah-zhiznennogo-cikla-po">  Conteneurs √† diff√©rentes √©tapes du cycle de vie du logiciel </h1><br><p>  Tenez compte des avantages des conteneurs √† diff√©rentes √©tapes du cycle de vie du logiciel. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/639/58e/062/63958e06271594a0c8fbe5a8e8785ca7.png" alt="Cycle de vie du logiciel"></p><br><h2 id="razrabotka">  D√©veloppement </h2><br><p> L'avantage le plus important est la facilit√© de d√©marrage du d√©veloppement.  Apr√®s avoir <a href="">install√© Docker</a> , il suffit d'ex√©cuter deux commandes: <code>docker pull</code> pour charger l'image et <code>docker run</code> pour la d√©marrer.  Toutes les d√©pendances sont d√©j√† r√©solues au stade de la cr√©ation de l'application. </p><br><h2 id="otladka">  D√©bogage </h2><br><p>  Tous les environnements sont coh√©rents et leurs d√©finitions existent; en outre, il est facile de d√©ployer l'environnement n√©cessaire.  Il suffit de faire <code>docker pull</code> le conteneur d'int√©r√™t et l'ex√©cuter. </p><br><h2 id="testirovanie--qa">  Test / QA </h2><br><p>  En cas d'erreur, l'environnement du probl√®me et les conditions de reproduction de l'erreur peuvent √™tre transf√©r√©s avec le conteneur.  Tous les changements d'infrastructure sont ¬´document√©s¬ª.  Le nombre de variables diminue - versions de biblioth√®ques, frameworks, OS ... Il est possible d'ex√©cuter plusieurs conteneurs pour parall√©liser les tests. </p><br><h2 id="dostavka">  La livraison </h2><br><p>  L'utilisation de conteneurs vous permet de cr√©er une seule fois, en plus d'utiliser des conteneurs, vous avez besoin d'un haut niveau d'automatisation des processus d'assemblage et de d√©ploiement.  La livraison en conteneur d'une application peut √™tre plus s√ªre en raison d'une isolation suppl√©mentaire. </p><br><h1 id="continuous-delivery">  Livraison continue </h1><br><p>  Passons de la th√©orie √† la pratique.  Voici une vue g√©n√©rale de notre solution d'automatisation d'assemblage et de livraison: </p><br><p><img src="https://habrastorage.org/webt/yv/dn/qc/yvdnqcgyrlswgft4-zhnm-2mabc.png" alt="CD"></p><br><p>  On distingue trois √©tapes principales: </p><br><ul><li>  Assemblage </li><li>  La livraison </li><li>  Lancement </li></ul><br><h2 id="sborka">  Assemblage </h2><br><p>  Dans l'article pr√©c√©dent, l'assemblage √©tait incr√©mentiel - nous avons consid√©r√© la diff√©rence entre l'environnement actuel et la nouvelle base de code et chang√© notre environnement afin qu'il corresponde √† la nouvelle base de code.  Avec les conteneurs, chaque assemblage est complet.  Le r√©sultat de la construction est une image Docker qui peut √™tre ex√©cut√©e n'importe o√π. </p><br><h2 id="dostavka-1">  La livraison </h2><br><p>  Une fois notre image compil√©e et test√©e, elle est t√©l√©charg√©e dans le Docker Registry, une application sp√©cialis√©e pour l'h√©bergement de l'image Docker.  L√†, il peut remplacer l'image pr√©c√©dente par le m√™me nom (tag).  Par exemple, en raison d'un nouveau commit dans la branche master, nous avons assembl√© une nouvelle image ( <code>MyProject/MyApp:master</code> ), et si les tests sont r√©ussis, nous pouvons mettre √† jour l'image dans le Docker Registry et tous ceux qui t√©l√©chargent <code>MyProject/MyApp:master</code> obtiendront une nouvelle version. </p><br><h2 id="zapusk">  Lancement </h2><br><p>  Enfin, l'image doit √™tre d√©marr√©e.  Un syst√®me de CD, tel que GitLab, peut g√©rer cela directement ou avec l'aide d'un orchestrateur sp√©cialis√©, mais le processus est g√©n√©ralement le m√™me - certaines images sont lanc√©es, les performances sont p√©riodiquement v√©rifi√©es et mises √† jour si une nouvelle version devient disponible. </p><br><p>  Consultez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">webinaire</a> expliquant ces √©tapes. </p><br><p>  Alternativement, en termes de commit: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ced/48d/84c/ced48d84c0a2213b3bd9c2bda109146e.png"></p><br><p>  Dans notre configuration de livraison continue, nous: </p><br><ul><li>  Valider le code dans le r√©f√©rentiel GitLab </li><li>  Nous collectons l'image </li><li>  Le tester </li><li>  Publiez une nouvelle image dans notre Docker Registry </li><li>  Mettre √† jour l'ancien conteneur vers la nouvelle version √† partir du registre Docker </li></ul><br><p>  Pour cela, nous avons besoin de: </p><br><ul><li>  Docker </li><li>  Registre Docker </li><li>  Domaine enregistr√© (facultatif, mais souhaitable) </li><li>  Outils GUI (facultatif) </li></ul><br><h3 id="docker">  Docker </h3><br><p>  Tout d'abord, nous devons d√©marrer Docker.  Je recommanderais de commencer avec un seul serveur avec une version courante de Linux, comme Ubuntu, RHEL ou Suse.  Je ne recommande pas de commencer avec des distributions telles que CoreOS, RancherOS, etc. - elles ne sont pas destin√©es aux d√©butants.  <a href="">N'oubliez pas de basculer le pilote de stockage sur devicemapper</a> . </p><br><p>  Si nous parlons de d√©ploiements √† grande √©chelle, puis en utilisant des outils d'orchestration tels que Kubernetes, Rancher ou Swarm, vous pouvez automatiser la plupart des t√¢ches, mais nous n'en discuterons pas (du moins dans le cadre de cet article). </p><br><h3 id="docker-registry">  Registre Docker </h3><br><p>  Il s'agit du premier conteneur que nous devons ex√©cuter, c'est une application autonome qui nous permet de stocker et de distribuer des images Docker.  Vous devez utiliser le Docker Registry si vous voulez: </p><br><ul><li>  Contr√¥lez o√π vos images sont stock√©es </li><li>  Poss√©der un serveur de distribution d'images </li><li>  Int√©grer le stockage et la distribution d'images dans le processus de d√©veloppement </li></ul><br><p>  Voici la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> sur le lancement et la configuration de Docker Registry. </p><br><h3 id="podklyuchenie-docker-registry-i-gitlab">  Connectez Docker Registry et GitLab </h3><br><p>  Pour connecter le Docker Registry √† GitLab, vous devez ex√©cuter le Docker Registry avec la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prise en charge HTTPS</a> .  J'utilise Let's Encrypt pour obtenir des certificats, et j'ai suivi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette instruction</a> pour obtenir un certificat.  Apr√®s avoir v√©rifi√© que le registre Docker est accessible via HTTPS (vous pouvez le v√©rifier dans le navigateur), suivez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ces instructions</a> pour connecter le registre Docker √† GitLab.  Ces instructions varient en fonction de votre installation de GitLab et de la configuration dont vous avez besoin.  Dans mon cas, la configuration consistait √† ajouter le certificat et la cl√© Docker Registry √† <code>/etc/gitlab/ssl</code> , et ces lignes √† <code>/etc/gitlab/gitlab.rb</code> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">registry_external_url</span></span> <span class="hljs-string"><span class="hljs-string">'https://docker.domain.com'</span></span> gitlab_rails [<span class="hljs-string"><span class="hljs-string">'registry_api_url'</span></span>] = <span class="hljs-string"><span class="hljs-string">"https://docker.domain.com"</span></span></code> </pre> <br><p>  Apr√®s avoir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">reconfigur√© GitLab</a> , un nouvel onglet du Registre est apparu, qui fournit des informations sur la fa√ßon de nommer correctement les images cr√©√©es afin qu'elles apparaissent ici. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a54/6b0/f85/a546b0f853ab022249ef03232927461d.png"></p><br><h3 id="domen">  Domaine </h3><br><p>  Dans notre configuration de livraison continue, nous cr√©erons automatiquement une image pour chaque branche, et si l'image r√©ussit les tests, elle est publi√©e dans le Docker Registry et d√©marre automatiquement, donc notre application sera automatiquement d√©ploy√©e depuis toutes les branches, par exemple: </p><br><ul><li>  Branches de <code>&lt;featureName&gt;.docker.domain.com</code> multiples sur <code>&lt;featureName&gt;.docker.domain.com</code> </li><li>  Testez la version sur <code>master.docker.domain.com</code> </li><li>  Version d' <code>preprod.docker.domain.com</code> sur <code>preprod.docker.domain.com</code> </li><li>  Version du produit sur <code>prod.docker.domain.com</code> </li></ul><br><p>  Pour ce faire, nous avons besoin d'un nom de domaine et d'un enregistrement DNS g√©n√©rique qui redirige les demandes vers <code>* .docker.domain.com</code> vers l'adresse IP de <code>docker.domain.com</code> .  Alternativement, vous pouvez utiliser diff√©rents ports. </p><br><h3 id="nginx">  Nginx </h3><br><p>  √âtant donn√© que nous avons plusieurs environnements, nous devons rediriger automatiquement les demandes vers des sous-domaines vers le conteneur appropri√©.  Pour cela, nous pouvons utiliser Nginx comme proxy inverse.  Voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guide</a> . </p><br><h3 id="gui-instrumenty">  Outils GUI </h3><br><p>  Pour commencer √† travailler avec des conteneurs, vous pouvez utiliser la ligne de commande ou l'une des interfaces graphiques.  Il en existe de nombreux disponibles, par exemple: </p><br><ul><li>  Rancher </li><li>  Microbadger </li><li>  Portainer </li><li>  Docker ui simple </li><li>  ... </li></ul><br><p>  Ils vous permettent de cr√©er des conteneurs et de les g√©rer √† partir de l'interface graphique au lieu de l'interface CLI.  Voici √† quoi ressemble Rancher: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/574/485/d9c/574485d9c01d464510f79097f6b823b4.png" alt="Rancher"></p><br><h3 id="gitlab-runner">  Gitlab runner </h3><br><p>  Comme pr√©c√©demment, pour ex√©cuter des scripts sur d'autres serveurs, nous devons installer le runner GitLab.  Cette question est d√©crite en d√©tail dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent</a> . </p><br><p>  Notez que vous devez utiliser le shell ex√©cuteur, pas le Docker.  Executor Docker est utilis√© lorsque vous avez besoin de quelque chose de l'int√©rieur de l'image, par exemple, lors de la cr√©ation d'une application Android dans un conteneur java, et que vous n'avez besoin que d'apk.  Dans notre cas, l'artefact est le conteneur entier, et cela n√©cessite l'ex√©cuteur Shell. </p><br><h1 id="konfiguraciya-continuous-delivery">  Configuration de livraison continue </h1><br><p>  Maintenant que tous les composants n√©cessaires sont configur√©s, vous pouvez commencer √† cr√©er une configuration de livraison continue. </p><br><h2 id="sborka-1">  Assemblage </h2><br><p>  Tout d'abord, nous devons assembler une image. </p><br><p>  Notre code, comme toujours, est stock√© dans le r√©f√©rentiel, la configuration du CD dans <code>gitlab-ci.yml</code> , mais en plus (pour am√©liorer la s√©curit√©) nous allons stocker plusieurs fichiers li√©s √† l'image sur le serveur de build. </p><br><h3 id="gitlabxml">  Gitlab.xml </h3><br><p>  Contient un code de rappel pour CD.  Il a √©t√© d√©velopp√© dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent</a> et est disponible sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> .  Il s'agit d'une petite biblioth√®que pour t√©l√©charger du code, ex√©cuter divers rappels et tester le code.  Il est pr√©f√©rable d'utiliser des sous-modules git pour inclure ce projet ou quelque chose de similaire dans votre r√©f√©rentiel.  Les sous-modules sont meilleurs car il est plus facile de les maintenir √† jour.  Une autre alternative consiste √† cr√©er une version sur GitLab et √† la t√©l√©charger √† l'aide de la commande ADD d√©j√† au moment de la construction. </p><br><h3 id="iriskey">  iris.key </h3><br><p>  Cl√© de licence.  Il peut √™tre charg√© lors de l'assemblage du conteneur, et non stock√© sur le serveur.  Il n'est pas s√ªr de stocker la cl√© dans le r√©f√©rentiel.  Vous pouvez obtenir une cl√© d'essai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">au WRC</a> ou essayer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InterSystems IRIS Experience</a> . </p><br><h3 id="pwdtxt">  pwd.txt </h3><br><p>  Fichier contenant le mot de passe par d√©faut.  Encore une fois, le stockage du mot de passe dans le r√©f√©rentiel est plut√¥t dangereux. </p><br><h3 id="load_ciscript">  load_ci.script </h3><br><p>  Un script qui: </p><br><ul><li>  Comprend l' <a href="">authentification du syst√®me d'exploitation</a> dans InterSystems IRIS </li><li>  Charge GitLab.xml </li><li>  Initialise les param√®tres de rappel GitLab </li><li>  Charge le code </li></ul><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ##Class(Security.System).Get(<span class="hljs-string"><span class="hljs-string">"SYSTEM"</span></span>,.Properties) write:(<span class="hljs-string"><span class="hljs-string">'sc) $System.Status.GetErrorText(sc) set AutheEnabled = Properties("AutheEnabled") set AutheEnabled = $ZBOOLEAN(+AutheEnabled,16,7) set Properties("AutheEnabled") = AutheEnabled set sc = ##Class(Security.System).Modify("SYSTEM",.Properties) write:('</span></span>sc) $System.Status.GetErrorText(sc) zn <span class="hljs-string"><span class="hljs-string">"USER"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(%SYSTEM.OBJ).Load(##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(%File).ManagerDirectory() _ <span class="hljs-string"><span class="hljs-string">"GitLab.xml"</span></span>,<span class="hljs-string"><span class="hljs-string">"cdk"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.Settings).setSetting(<span class="hljs-string"><span class="hljs-string">"hooks"</span></span>, <span class="hljs-string"><span class="hljs-string">"MyApp/Hooks/"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.Settings).setSetting(<span class="hljs-string"><span class="hljs-string">"tests"</span></span>, <span class="hljs-string"><span class="hljs-string">"MyApp/Tests/"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.GitLab).load() halt</code> </pre> <br><p>  Notez que la premi√®re ligne est intentionnellement laiss√©e en blanc.  Si ce script initial est toujours le m√™me, vous pouvez simplement l'enregistrer dans le r√©f√©rentiel. </p><br><h2 id="gitlab-ciyml">  gitlab-ci.yml </h2><br><p>  Passons maintenant √† la configuration de livraison continue: </p><br><pre> <code class="hljs bash">build image: stage: build tags: - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script: - cp -r /InterSystems/mount ci - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ci - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'SuperUser'</span></span> | cat - pwd.txt load_ci.script &gt; temp.txt - mv temp.txt load_ci.script - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. - docker build --build-arg CI_PROJECT_DIR=<span class="hljs-variable"><span class="hljs-variable">$CI_PROJECT_DIR</span></span> -t docker.domain.com/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/docker:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> .</code> </pre> <br><p>  Que se passe-t-il ici? </p><br><p>  Tout d'abord, √©tant donn√© que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le processus d'assemblage d'images</a> ne peut acc√©der qu'aux sous-r√©pertoires du r√©pertoire de base - dans notre cas, le r√©pertoire racine du r√©f√©rentiel, vous devez copier le r√©pertoire "secret" (qui contient <code>GitLab.xml</code> , <code>iris.key</code> , <code>pwd.txt</code> et <code>load_ci.skript</code> ) pour r√©f√©rentiel clon√©. </p><br><p>  De plus, un utilisateur / mot de passe est requis pour acc√©der au terminal, nous les ajouterons donc √† <code>load_ci.script</code> (pour cela nous avons besoin d'une ligne vide au d√©but de <code>load_ci.script</code> ). </p><br><p>  Enfin, nous cr√©ons une image Docker et la <code>docker.domain.com/test/docker:$CI_COMMIT_REF_NAME</code> : <code>docker.domain.com/test/docker:$CI_COMMIT_REF_NAME</code> </p><br><p>  o√π <code>$CI_COMMIT_REF_NAME</code> est le nom de la branche.  Remarque: la premi√®re partie de la balise image doit correspondre au nom du r√©f√©rentiel dans GitLab afin qu'il puisse √™tre vu sur l'onglet Registre (des instructions plus compl√®tes pour un balisage correct sont disponibles ici). </p><br><h3 id="dockerfile">  Dockerfile </h3><br><p>  Docker Image est cr√©√©e √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dockerfile</a> , la voici: </p><br><pre> <code class="hljs mel">FROM docker.intersystems.com/intersystems/iris:<span class="hljs-number"><span class="hljs-number">2018.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.613</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> ENV SRC_DIR=/tmp/src ENV CI_DIR=$SRC_DIR/ci ENV CI_PROJECT_DIR=$SRC_DIR COPY ./ $SRC_DIR RUN cp $CI_DIR/iris.key $ISC_PACKAGE_INSTALLDIR/mgr/ \ &amp;&amp; cp $CI_DIR/GitLab.xml $ISC_PACKAGE_INSTALLDIR/mgr/ \ &amp;&amp; $ISC_PACKAGE_INSTALLDIR/dev/Cloud/ICM/changePassword.sh $CI_DIR/<span class="hljs-keyword"><span class="hljs-keyword">pwd</span></span>.txt \ &amp;&amp; iris start $ISC_PACKAGE_INSTANCENAME \ &amp;&amp; irissession $ISC_PACKAGE_INSTANCENAME -U%SYS &lt; $CI_DIR/load_ci.script \ &amp;&amp; iris stop $ISC_PACKAGE_INSTANCENAME quietly</code> </pre> <br><p>  Les actions suivantes sont effectu√©es: </p><br><ul><li>  Nous prenons l'image d'InterSystems IRIS comme base.  Il devrait se trouver dans votre Docker Registry.  Si vous n'avez jamais travaill√© avec Docker auparavant, essayez <a href="">First Look: Docker</a> , qui d√©crit comment obtenir une image IRIS InterSystems, l'ajouter au registre Docker et la lancer manuellement. </li><li>  Tout d'abord, copiez notre r√©f√©rentiel (et le r√©pertoire "secret") √† l'int√©rieur du conteneur. </li><li>  Copiez la cl√© de licence et <code>GitLab.xml</code> dans le r√©pertoire <code>mgr</code> . </li><li>  Remplacez le mot de passe par la valeur de <code>pwd.txt</code> .  Notez que <code>pwd.txt</code> est supprim√© lors de cette op√©ration. </li><li>  D√©marre InterSystems IRIS. </li><li>  Le <code>load_ci.script</code> est <code>load_ci.script</code> . </li><li>  InterSystems IRIS s'arr√™te. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Voici un journal de construction partiel</b> <div class="spoiler_text"><pre> <code class="hljs perl">Running with gitlab-runner <span class="hljs-number"><span class="hljs-number">10.6</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> (a3543a27) on docker <span class="hljs-number"><span class="hljs-number">7</span></span>b21e0c4 Using Shell executor... Running on docker... Fetching changes... Removing ci/ Removing temp.txt HEAD is now at <span class="hljs-number"><span class="hljs-number">5</span></span>ef9904 Build load_ci.script From http:<span class="hljs-regexp"><span class="hljs-regexp">//gitlab</span></span>.eduard.win/test/docker <span class="hljs-number"><span class="hljs-number">5</span></span>ef9904..<span class="hljs-number"><span class="hljs-number">9753</span></span>a8d master -&gt; origin/master Checking out <span class="hljs-number"><span class="hljs-number">9753</span></span>a8db as master... Skipping Git submodules setup $ cp -r /InterSystems/mount ci $ cd ci $ echo <span class="hljs-string"><span class="hljs-string">'SuperUser'</span></span> | cat - pwd.txt load_ci.script &gt; temp.txt $ mv temp.txt load_ci.script $ cd .. $ docker build --build-arg CI_PROJECT_DIR=$CI_PROJECT_DIR -t docker.eduard.win/test/docker:$CI_COMMIT_REF_NAME . Sending build context to Docker daemon <span class="hljs-number"><span class="hljs-number">401.4</span></span>kB Step <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : FROM docker.intersystems.com/intersystems/iris:<span class="hljs-number"><span class="hljs-number">2018.1</span></span>.<span class="hljs-number"><span class="hljs-number">1.613</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> ---&gt; cd2e53e7f85<span class="hljs-number"><span class="hljs-number">0</span></span> Step <span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV SRC_DIR=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/src</span></span> ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">68</span></span>ba1cb00aff Step <span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV CI_DIR=$SRC_DIR/ci ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">6784</span></span>c34a9ee6 Step <span class="hljs-number"><span class="hljs-number">4</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV CI_PROJECT_DIR=$SRC_DIR ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">3757</span></span>fa88a28a Step <span class="hljs-number"><span class="hljs-number">5</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : COPY ./ $SRC_DIR ---&gt; <span class="hljs-number"><span class="hljs-number">5515</span></span>e13741b<span class="hljs-number"><span class="hljs-number">0</span></span> Step <span class="hljs-number"><span class="hljs-number">6</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : RUN cp $CI_DIR/iris.key $ISC_PACKAGE_INSTALLDIR/mgr/ &amp;&amp; cp $CI_DIR/GitLab.xml $ISC_PACKAGE_INSTALLDIR/mgr/ &amp;&amp; $ISC_PACKAGE_INSTALLDIR/dev/Cloud/ICM/changePassword.sh $CI_DIR/pwd.txt &amp;&amp; iris start $ISC_PACKAGE_INSTANCENAME &amp;&amp; irissession $ISC_PACKAGE_INSTANCENAME -U%SYS &lt; $CI_DIR/load_ci.script &amp;&amp; iris stop $ISC_PACKAGE_INSTANCENAME quietly ---&gt; Running in <span class="hljs-number"><span class="hljs-number">86526183</span></span>cf7c . Waited <span class="hljs-number"><span class="hljs-number">1</span></span> seconds <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> InterSystems IRIS to start This copy of InterSystems IRIS has been licensed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> exclusively by: ISC Internal Container Sharding Copyright (c) <span class="hljs-number"><span class="hljs-number">1986</span></span>-<span class="hljs-number"><span class="hljs-number">2018</span></span> by InterSystems Corporation Any other <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> is a violation of your license agreement %SYS&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> %SYS&gt; Using <span class="hljs-string"><span class="hljs-string">'iris.cpf'</span></span> configuration file This copy of InterSystems IRIS has been licensed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> exclusively by: ISC Internal Container Sharding Copyright (c) <span class="hljs-number"><span class="hljs-number">1986</span></span>-<span class="hljs-number"><span class="hljs-number">2018</span></span> by InterSystems Corporation Any other <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> is a violation of your license agreement <span class="hljs-number"><span class="hljs-number">1</span></span> alert(<span class="hljs-keyword"><span class="hljs-keyword">s</span></span>) during startup. See messages.log <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Starting IRIS Node: <span class="hljs-number"><span class="hljs-number">39702</span></span>b122ab6, Instance: IRIS Username: Password: Load started on <span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> Loading file /usr/irissys/mgr/GitLab.xml as xml Load finished successfully. USER&gt; USER&gt; [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.017</span></span>] Running init hooks: before [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.017</span></span>] Importing hooks dir /tmp/src/MyApp/Hooks/ [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.374</span></span>] Executing hook class: MyApp.Hooks.Global [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.375</span></span>] Executing hook class: MyApp.Hooks.Local [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.375</span></span>] Importing dir /tmp/src/ Loading file /tmp/src/MyApp/Tests/TestSuite.cls as udl Compilation started on <span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> with qualifiers <span class="hljs-string"><span class="hljs-string">'c'</span></span> Compilation finished successfully in <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">194</span></span>s. Load finished successfully. [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.876</span></span>] Running init hooks: after [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.878</span></span>] Executing hook class: MyApp.Hooks.Local [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.921</span></span>] Executing hook class: MyApp.Hooks.Global Removing intermediate container <span class="hljs-number"><span class="hljs-number">39702</span></span>b122ab6 ---&gt; dea6b2123165 [Warning] One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more build-args [CI_PROJECT_DIR] were <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> consumed Successfully built dea6b2123165 Successfully tagged docker.domain.com/test/docker:master Job succeeded</code> </pre> </div></div><br><h2 id="zapusk-1">  Lancement </h2><br><p>  Nous avons une image, ex√©cutez-la.  Dans le cas des branches de fonctionnalit√©s, vous pouvez simplement d√©truire l'ancien conteneur et en d√©marrer un nouveau.  Dans le cas de l'environnement du produit, nous pouvons d'abord d√©marrer le conteneur temporaire et remplacer le conteneur moyen si les tests r√©ussissent. </p><br><p>  Tout d'abord, le script pour supprimer l'ancien conteneur. </p><br><pre> <code class="hljs ruby">destroy <span class="hljs-symbol"><span class="hljs-symbol">old:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">stage:</span></span> destroy <span class="hljs-symbol"><span class="hljs-symbol">tags:</span></span> - test <span class="hljs-symbol"><span class="hljs-symbol">script:</span></span> - docker stop iris-$CI_COMMIT_REF_NAME <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> - docker rm -f iris-$CI_COMMIT_REF_NAME <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  Ce script d√©truit le conteneur en cours d'ex√©cution et r√©ussit toujours (par d√©faut, Docker renvoie une erreur lorsqu'il essaie d'arr√™ter / supprimer un conteneur inexistant). </p><br><p>  Apr√®s cela, nous lan√ßons un nouveau conteneur et l'enregistrons en tant qu'environnement. </p><br><pre> <code class="hljs powershell">run image: stage: run environment: name: <span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> url: http://<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span>.docker.eduard.win/index.html tags: - test script: - docker run <span class="hljs-literal"><span class="hljs-literal">-d</span></span> -<span class="hljs-literal"><span class="hljs-literal">-expose</span></span> <span class="hljs-number"><span class="hljs-number">52773</span></span> -<span class="hljs-literal"><span class="hljs-literal">-volume</span></span> /InterSystems/durable/<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG:</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> -<span class="hljs-literal"><span class="hljs-literal">-env</span></span> ISC_DATA_DIRECTORY=/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/sys -<span class="hljs-literal"><span class="hljs-literal">-env</span></span> VIRTUAL_HOST=<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span>.docker.eduard.win -<span class="hljs-literal"><span class="hljs-literal">-name</span></span> iris-<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> docker.eduard.win/test/docker:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> -<span class="hljs-literal"><span class="hljs-literal">-log</span></span> <span class="hljs-variable"><span class="hljs-variable">$ISC_PACKAGE_INSTALLDIR</span></span>/mgr/messages.log</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le conteneur Nginx</a> redirige automatiquement les demandes √† l'aide de la <code>VIRTUAL_HOST</code> environnement <code>VIRTUAL_HOST</code> vers le port sp√©cifi√© - dans ce cas 52773. </p><br><p>  Puisqu'il est n√©cessaire de stocker certaines donn√©es (mots de passe,% SYS, donn√©es d'application) sur l'h√¥te dans InterSystems IRIS, il existe une fonctionnalit√© <a href="">% SYS durable</a> qui vous permet de stocker des donn√©es sur l'h√¥te telles que: </p><br><ul><li>  <code>iris.cpf</code> est le fichier de configuration principal. </li><li>  Le <code>/csp</code> avec les fichiers d'application Web. </li><li>  <code>/httpd/httpd.conf</code> avec la configuration du serveur Apache priv√©. </li><li>  Le r√©pertoire <code>/mgr</code> dans lequel sont stock√©s: <br><ul><li>  Bases de donn√©es <code>IRISSYS</code> , <code>IRISTEMP</code> , <code>IRISAUDIT</code> , <code>IRIS</code> , <code>USER</code> . </li><li>  <code>IRIS.WIJ</code> . </li><li>  Annuaire <code>/journal</code> stockant des magazines. </li><li>  Le r√©pertoire <code>/temp</code> pour les fichiers temporaires. </li><li>  Journaux <code>messages.log</code> , <code>journal.log</code> , <code>SystemMonitor.log</code> . </li></ul></li></ul><br><p>  Pour activer Durable% SYS, l'argument <code>volume</code> est sp√©cifi√© qui <code>ISC_DATA_DIRECTORY</code> r√©pertoire h√¥te et la variable <code>ISC_DATA_DIRECTORY</code> d√©finit le r√©pertoire de stockage des fichiers Durable% SYS.  Ce r√©pertoire ne devrait pas exister, il sera cr√©√© automatiquement. </p><br><p>  Ainsi, l'architecture de notre application conteneuris√©e est la suivante: </p><br><p><img src="https://habrastorage.org/webt/61/0q/ze/610qzezlqdilphfkapj5vac9t84.png" alt="architecture d'application conteneuris√©e"></p><br><p>  Pour construire une telle application, nous devons au moins cr√©er une base de donn√©es suppl√©mentaire (pour enregistrer le code de l'application) et cr√©er son mappage dans la zone d'application.  J'ai utilis√© la port√©e <code>USER</code> pour stocker les donn√©es d'application, car cette port√©e a √©t√© ajout√©e √† Durable% SYS par d√©faut.  Le code d'application est stock√© dans un conteneur afin de pouvoir √™tre mis √† jour. </p><br><p>  Sur la base de ce qui pr√©c√®de, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">% Installer</a> devrait: </p><br><ul><li>  Cr√©er une zone / base de donn√©es <code>APP</code> </li><li>  T√©l√©chargez le code dans la zone <code>APP</code> </li><li>  Cr√©ez des classes de cartographie de notre application dans la zone <code>USER</code> </li><li>  Effectuer une autre configuration (j'ai cr√©√© une application Web CSP et une application Web REST) </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code% installateur</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> { Parameter Namespace = "APP"; /// See <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zsetup+<span class="hljs-number"><span class="hljs-number">1</span></span>^MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> XData Install [ XMLNamespace = INSTALLER ] { &lt;Manifest&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Creating namespace ${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;Namespace <span class="hljs-type"><span class="hljs-type">Name</span></span>="${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="yes" Code="${Namespace}" Ensemble="" Data="IRISTEMP"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>="${Namespace}" Dir="/usr/irissys/mgr/${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="yes" MountRequired="true" Resource="%DB_${Namespace}" PublicPermissions="RW" MountAtStartup="true"/&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Import</span></span> File="${Dir}Form" Recurse="1" Flags="cdk" IgnoreErrors="1" /&gt; &lt;/Namespace&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="End Creating namespace ${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Mapping to USER" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;Namespace <span class="hljs-type"><span class="hljs-type">Name</span></span>="USER" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="no" Code="USER" Data="USER" Ensemble="0"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Mapping Form package to USER namespace" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;ClassMapping <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>="${Namespace}" Package="Form"/&gt; &lt;RoutineMapping <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>="${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Routines</span></span>="Form" /&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;CSPApplication Url="/" Directory="${Dir}client" AuthenticationMethods="64" IsNamespaceDefault="false" <span class="hljs-keyword"><span class="hljs-keyword">Grant</span></span>="%ALL" Recurse="1" /&gt; &lt;/Namespace&gt; &lt;/Manifest&gt; } /// This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> generator whose code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> XGL. /// Main setup <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> /// <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Namespace")="TEMP3" /// <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Global</span></span>).setup(.vars) ClassMethod setup(ByRef pVars, pLogLevel <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, pInstaller <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Installer.Installer) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status [ CodeMode = objectgenerator, <span class="hljs-type"><span class="hljs-type">Internal</span></span> ] { Quit ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%Installer.Manifest).%Generate(%compiledclass, %code, "Install") } /// Entry <span class="hljs-type"><span class="hljs-type">point</span></span> ClassMethod onAfter() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { try { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> "START INSTALLER",! <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Namespace") = ..#Namespace <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Dir") = ..getDir() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ..setup(.vars) <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> !,$<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Status.GetErrorText(sc),! <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ..createWebApp() } catch ex { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ex.AsStatus() <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> !,$<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Status.GetErrorText(sc),! } quit sc } /// Modify web app REST ClassMethod createWebApp(appName <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String = "/forms") <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>:$e(appName)<span class="hljs-string"><span class="hljs-string">'="/" appName = "/" _ appName #dim sc As %Status = $$$OK new $namespace set $namespace = "%SYS" if '</span></span>##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Applications).<span class="hljs-keyword"><span class="hljs-keyword">Exists</span></span>(appName) { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("AutheEnabled") = $$<span class="bash"><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$AutheUnauthenticated</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> props(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"NameSpace"</span></span></span><span class="bash">) = </span><span class="hljs-string"><span class="bash"><span class="hljs-string">"USER"</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> props(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"IsNameSpaceDefault"</span></span></span><span class="bash">) = $$</span></span>$<span class="hljs-keyword"><span class="hljs-keyword">NO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("DispatchClass") = "Form.REST.Main" <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("MatchRoles")=":" _ $$<span class="bash"><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$AllRoleName</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> sc = </span><span class="hljs-comment"><span class="bash"><span class="hljs-comment">##class(Security.Applications).Create(appName, .props) } quit sc } ClassMethod getDir() [ CodeMode = expression ] { ##class(%File).NormalizeDirectory($system.Util.GetEnviron("CI_PROJECT_DIR")) } }</span></span></span></span></code> </pre> </div></div><br><p>  Je note que pour cr√©er une base de donn√©es non sur l'h√¥te, j'utilise le r√©pertoire <code>/usr/irissys/mgr</code> , car l'appel <code>##class(%File).ManagerDirectory()</code> renvoie le chemin d'acc√®s au r√©pertoire pour Durable% SYS. </p><br><h2 id="testy">  Les tests </h2><br><p>  Ex√©cutez maintenant les tests. </p><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">test</span></span> image: stage: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> tags: - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script: - docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> iris-<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> irissession iris -U USER <span class="hljs-string"><span class="hljs-string">"##class(isc.git.GitLab).test()"</span></span></code> </pre> <br><h2 id="dostavka-2">  La livraison </h2><br><p>  Les tests sont pass√©s, nous publierons notre image dans le Docker Registry. </p><br><pre> <code class="hljs pgsql">publish image: stage: publish tags: - test script: - docker <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> docker.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com -u <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> -p pass - docker push docker.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com/test/docker:$CI_COMMIT_REF_NAME</code> </pre> <br><p>  Le login / mot de passe peut √™tre transmis √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">variables secr√®tes</a> . </p><br><p>  Maintenant, l'image est affich√©e sur GitLab. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/064/0b3/56f/0640b356f33ea72491c91d55399a4670.png"></p><br><p>  Et d'autres d√©veloppeurs peuvent le t√©l√©charger depuis le Docker Registry.  Dans l'onglet Environnements, tous nos environnements sont disponibles pour la visualisation: </p><br><h1 id="vyvody">  Conclusions </h1><br><p>  Cette s√©rie d'articles traite des approches courantes de l'int√©gration continue.  L'automatisation de l'assemblage, des tests et de la livraison de votre application sur les plateformes InterSystems est possible et facile √† mettre en ≈ìuvre. </p><br><p>  L'utilisation des technologies de conteneurisation aidera √† optimiser les processus de d√©veloppement et de d√©ploiement d'applications.  L'√©limination des incoh√©rences entre les environnements facilite les tests et le d√©bogage.  L'orchestration vous permet de cr√©er des applications √©volutives. </p><br><h1 id="ssylki">  Les r√©f√©rences </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article pr√©c√©dent</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">S√©rie communautaire InterSystems</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Code</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Code Github</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420749/">https://habr.com/ru/post/fr420749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420731/index.html">Zabbix sur les st√©ro√Ødes: comment fonctionne la plate-forme de surveillance unifi√©e de Sbertech</a></li>
<li><a href="../fr420735/index.html">Nous vous invitons √† la finale du marathon Find Yourself in Digital au bureau du groupe Mail.Ru</a></li>
<li><a href="../fr420737/index.html">Mini AI Cup 2 ou presque AgarIO - ce qui pourrait √™tre fait pour gagner</a></li>
<li><a href="../fr420739/index.html">La bo√Æte est toujours dans la poign√©e: pourquoi en 2018 vous devez encore apprendre les langues vous-m√™me</a></li>
<li><a href="../fr420741/index.html">Aide-m√©moire pour les programmeurs ou "nous allons google pour vous"</a></li>
<li><a href="../fr420753/index.html">Frontend de microservice - une approche moderne de la s√©paration du front</a></li>
<li><a href="../fr420757/index.html">Concours de programmation: commerce (r√©sultats)</a></li>
<li><a href="../fr420761/index.html">TypeScript 3.0</a></li>
<li><a href="../fr420763/index.html">KDD 2018, deuxi√®me jour, ateliers</a></li>
<li><a href="../fr420765/index.html">Impressions du PDA Gemini. R√©colteuse √† double amor√ßage de poche ou jouet inutile?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>