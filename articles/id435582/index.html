<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖐🏼 👨🏽‍🎨 🤶🏾 Bagaimana cara menambahkan indeks pada sistem yang dimuat 24/7 tanpa downtime? 🍑 🆚 😠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Teman-teman, pada akhir Januari, kami akan memulai kursus baru yang disebut "Pengembang MS SQL Server ". Untuk mengantisipasi peluncurannya, kami memi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana cara menambahkan indeks pada sistem yang dimuat 24/7 tanpa downtime?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/435582/">  <i>Teman-teman, pada akhir Januari, kami akan memulai kursus baru yang disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Pengembang MS SQL Server</a> ".</i>  <i>Untuk mengantisipasi peluncurannya, kami meminta guru kursus, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kristina Kucherova</a> , untuk menyiapkan artikel penulis.</i>  <i>Artikel ini akan berguna bagi Anda jika Anda memiliki tabel yang sangat populer di prod dengan akses 24/7 dan tiba-tiba Anda menyadari bahwa Anda sangat perlu menambahkan indeks dan tidak merusak apa pun dalam proses.</i> <br><br>  Jadi apa yang harus dilakukan?  Metode CREATE INDEX WITH WITH (ONLINE = ON) tradisional tidak cocok untuk Anda, karena, misalnya, menyebabkan crash sistem dan serangan jantung DBA Anda, semua puncak memantau waktu respons sistem Anda dan, jika meningkat, mereka mendatangi Anda dan DBA Anda untuk berbicara tentang angka-angka kompensasi Anda untuk pekerjaan yang berlebihan. <br><br>  Skrip dan teknik yang dijelaskan digunakan pada sistem dengan beban permintaan 400 ribu per menit, versi SQL Server 2012 dan 2016 (Enterprise). <br><br>  Ada dua pendekatan yang sangat berbeda untuk membuat indeks, yang digunakan tergantung pada ukuran tabel. <br><br><h3>  Kasus No. 1. Meja kecil tapi sangat populer </h3><br>  Sebuah tabel berisi 50 ribu catatan (kecil), tetapi sangat populer (beberapa ribu hit per menit).  Anda memerlukan indeks baru dan downtime minimal dan mengunci di atas meja. <br>  Dalam aplikasi, semua akses ke database hanya melalui prosedur. <br><br>  Jika kesalahan terjadi, aplikasi akan mencoba kembali mengakses tabel. <br><br><img src="https://habrastorage.org/webt/0b/7k/oj/0b7kojuvqjl6d_ty__et9g3wgiu.png"><br><a name="habracut"></a><br>  Apa masalah menerapkan indeks ini secara sederhana, Anda bertanya?  Dengan kalimat WITH ONLINE = ON (ya, kami beruntung, dan yang ini Enterprise). <br><br>  Faktanya adalah bahwa dengan akses aktif seperti itu, perlu beberapa waktu untuk mendapatkan kunci (bahkan yang minimum diperlukan dengan opsi Online = ON).  Dalam proses menunggu, permintaan baru antri, antrian bertambah, CPU bertambah, DBA berkeringat dan menyipit dengan gugup ke arah pengembang, sementara pada grafik pemantauan aplikasi, waktu respons Anda mulai meningkat dengan lancar, tetapi tak terhindarkan.  Wakil Presiden Engeneering Anda dengan senang hati tertarik pada apakah, karena peningkatan waktu respons ini, akan ada semacam downtime sistem, bahwa pada akhir tahun ketersediaan aplikasi akan diperkirakan bukan 5 sembilan (99.999), tetapi lebih rendah?  Dan kemudian perusahaan memiliki kontrak, kewajiban, dan denda besar jika ketersediaan berkurang, dan, tentu saja, kita tidak akan melupakan kehilangan reputasi. <br><br>  Apa yang telah kita lakukan untuk menghindari situasi yang tidak menguntungkan ini? <br>  Sistem masih membutuhkan indeks. <br>  Mereka mengambil hak dari semua orang kecuali sesi saat ini di tabel ini. <br>  Terapkan indeks. <br><br>  Ya, solusinya memiliki minus: setiap orang yang beralih ke tabel dalam detik ini akan menerima Access Denied.  Jika aplikasi Anda biasanya menangani situasi seperti itu dan mengulangi permintaan ke database, maka Anda harus melihat lebih dekat opsi ini.  Dalam kasus proyek kami, metode ini bekerja dengan baik.  Sekali lagi, Anda dapat menghapus ONLINE = ON dengan aman, karena kami tahu bahwa hanya sesi yang akan memiliki akses ke tabel selama pembuatan indeks. <br><br>  Kode untuk menerapkan indeks: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IX_Users_Email_Status <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] ([Email],[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2]</code> </pre> <br>  Jadwal waktu tanggapan dan persentase kesalahan selama pengujian di bawah beban. <br><br><img src="https://habrastorage.org/webt/h_/nd/ug/h_ndugyc0hybrm5-bps5pmxinuo.png" alt="gambar"><br><br>  Metode ini dapat diterapkan jika, seperti dalam kasus yang dijelaskan, Anda memiliki tabel kecil, dan Anda tahu bahwa tanpa memuat indeks akan dibuat dalam hitungan detik (atau dalam waktu yang dapat diterima untuk Anda).  Pada saat yang sama, seperti yang Anda lihat dari grafik di atas, waktu respons aplikasi tidak akan meningkat, meskipun dapat dilihat bahwa tingkat kesalahan dalam hitungan detik tanpa akses ke tabel lebih tinggi. <br><br><h3>  Kasus No. 2. Meja besar </h3><br>  Jika Anda memiliki tabel besar dan Anda perlu mengubah indeks di atasnya, maka seringkali cara paling mudah untuk menjual adalah dengan membuat tabel di sebelahnya dengan indeks yang benar dan secara bertahap mentransfer data ke tabel baru. <br><br>  Ada 2 cara: <br><br><ol><li>  Jika Anda memiliki prosedur khusus untuk mengubah tabel, Anda cukup mengubah kode prosedur sehingga data baru dimasukkan hanya ke dalam tabel baru, penghapusan dari keduanya, pembaruan juga berlaku untuk keduanya, dan pemilihan dilakukan dari dua tabel dengan UNION ALL. </li><li>  Jika Anda memiliki banyak bagian kode yang berbeda di mana Anda dapat mengubah data dalam tabel, maka ada dua trik populer: lihat dengan pemicu atau tulis ulang semua bagian kode untuk memasukkan data ke dalam tabel baru, hapus dari keduanya dan perbarui kedua tabel.  Tampilan dengan pemicu adalah opsi saat Anda membuat tampilan dengan dua tabel dan menamainya, mengubah nama tabel Anda saat ini menjadi TableOld, dan melihat ke Tabel.  Maka Anda secara otomatis mendapatkan semua panggilan tabel ke tampilan, di sini dengan mengganti nama mungkin juga ada masalah, karena SchemaLock diperlukan, tetapi mengganti nama lewat sangat cepat. </li></ol><br>  Versi yang sedikit lebih mendetail tentang penulisan ulang panggilan ke tabel baru: <br><br><ol><li>  Anda memiliki tabel Pesanan, buat tabel OrdersNew baru dengan skema yang sama, tetapi dengan indeks yang diinginkan.  Pada saat yang sama, jika Anda menggunakan Indentity, maka Anda perlu mengatur nilai identitas pertama di tabel baru agar sama dengan nilai maksimum di tabel lama + langkah perubahan atau celah yang Anda mampu untuk menyimpang dari nilai maksimum dalam Pesanan. </li><li>  Buat OrdersView, di dalamnya ada pilihan dari UNI Pemesanan SEMUA Pesanan Baru </li><li>  Ubah semua prosedur / panggilan untuk memilih data dari tampilan, masukkan ke OrdersNew, hapus dan modifikasi kedua tabel. </li><li>  Migrasikan data dari tabel lama ke yang baru, misalnya, seperti ini: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowcount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">4999</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @batchsize; WHILE @rowcount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> TOP (@batchsize) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Orders <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> deleted.Id ,deleted.Column1 ,deleted.Column2 ,deleted.Column3 <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.OrdersNew (<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> ,Column1 ,Column2 ,Column3); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@ROWCOUNT; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ERROR_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorNumber, ERROR_MESSAGE() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorMessage; THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre><br></li><li>  Kembalikan semua prosedur ke versi sebelum migrasi - dengan satu tabel.  Ini dapat dilakukan melalui alter atau melalui penghapusan dan pembuatan prosedur (maka jangan lupa tentang haknya), dan Anda dapat mengubah nama tabel baru menjadi Pesanan, menghapus tabel dan tampilan kosong. </li></ol><br>  Pada langkah 2, dimungkinkan, jika pemuatan memungkinkan, untuk mengubah nama Pesanan tabel utama -&gt; OrdersOld, dan OrdersView -&gt; Pesanan dan tampilan itu sendiri ke OrdersOld UNION ALL Orders Baru, maka Anda tidak perlu mengubah semua tempat di mana ada pilihan dari tabel. <br><br>  Saat memindahkan blok dari satu tabel ke tabel lainnya, data akan terfragmentasi. <br>  Jika tabel yang diubah secara aktif digunakan untuk membaca, tetapi data di dalamnya jarang berubah, Anda dapat kembali menggunakan pemicu - tulis salinan semua perubahan ke tabel ke-3 - transfer data dari tabel melalui bcp out dan bcp in (atau bulk insert) ke tabel baru , buat indeks di atasnya setelah transfer data dan kemudian terapkan perubahan dari tabel dengan log perubahan - dan alihkan satu tabel ke yang lain - yang sekarang, ganti nama ke TableOld, dan yang baru dari TableNew to Table. <br><br>  Probabilitas kesalahan dalam situasi ini sedikit lebih tinggi, jadi uji penerapan perubahan dan berbagai kasus switching dalam kasus ini. <br><br>  Opsi yang dijelaskan bukan satu-satunya.  Mereka digunakan oleh saya pada database SQL Server yang banyak dimuat dan tidak menimbulkan masalah selama aplikasi, yang menyenangkan tim DBA kami.  Memantul seperti itu biasanya tidak diperlukan untuk pangkalan dengan mode pemuatan yang lebih tenang, saat Anda dapat dengan aman menerapkan perubahan pada jam-jam dengan aktivitas yang paling sedikit.  Pengguna proyek yang menggunakan pendekatan yang dijelaskan ini berlokasi di AS dan Eropa dan secara aktif menggunakan aplikasi pada hari kerja dan akhir pekan, dan tabel di mana perubahan diterapkan digunakan secara konstan dalam pekerjaan.  Lebih banyak objek "lebih tenang" biasanya dimodifikasi oleh skrip otomatis yang dihasilkan melalui Redgate Toolkit setelah skrip ditinjau oleh pengembang dan salah satu dari DBA. <br><br>  <i>Baik untuk semua!</i>  <i>Bagikan komentar jika Anda menggunakan metode ini atau jelaskan metode Anda!</i>  <i>Kami juga mengundang Anda ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pelajaran terbuka</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">hari terbuka</a> kursus baru kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Pengembang MS SQL Server"</a></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id435582/">https://habr.com/ru/post/id435582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id435572/index.html">Anycubic i3 Mega: pembuatan ulang kualitas Prusa i3</a></li>
<li><a href="../id435574/index.html">Bagaimana cara kerja zig?</a></li>
<li><a href="../id435576/index.html">1C, tidak sakit</a></li>
<li><a href="../id435578/index.html">Spacewalk untuk Natal</a></li>
<li><a href="../id435580/index.html">Layanan Java, Spring, Kurento dan Media</a></li>
<li><a href="../id435584/index.html">Slush 2018. Hari Pertama, Hari Kedua</a></li>
<li><a href="../id435586/index.html">Seni perdukunan atau firmware khusus untuk Olinuxino. Kernel dan Ubuntu Bagian 3</a></li>
<li><a href="../id435588/index.html">Promosi aplikasi seluler dengan pengalaman nyata dalam jumlah</a></li>
<li><a href="../id435590/index.html">Peramalan Lagi, Bagian 1</a></li>
<li><a href="../id435592/index.html">Azores: cadangan flora terakhir di tengah Samudra Atlantik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>