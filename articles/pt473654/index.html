<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåæ üßëüèæ üåª PHP Composer: Corrija depend√™ncias sem dor ü¶à ü•¢ ü•ù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Muitos de voc√™s provavelmente j√° se depararam com uma situa√ß√£o em que h√° um bug ou n√£o a funcionalidade necess√°ria na biblioteca ou estrutura que voc√™...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP Composer: Corrija depend√™ncias sem dor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/473654/"><p>  Muitos de voc√™s provavelmente j√° se depararam com uma situa√ß√£o em que h√° um bug ou n√£o a funcionalidade necess√°ria na biblioteca ou estrutura que voc√™ usa.  Suponha que voc√™ n√£o tenha pregui√ßa e formou uma solicita√ß√£o de recebimento.  Mas eles n√£o o aceitar√£o imediatamente, e o pr√≥ximo lan√ßamento do produto em geral pode ocorrer em um ano. </p><br><p><img src="https://habrastorage.org/webt/jv/ys/9h/jvys9h_dh2zmefozo_xhrosiipo.jpeg" alt="PHP Composer: Corrija depend√™ncias sem dor"></p><br><p>  O que fazer se voc√™ precisar urgentemente rolar a corre√ß√£o para o produto?  A solu√ß√£o √≥bvia √© usar uma bifurca√ß√£o de uma biblioteca ou estrutura.  No entanto, nem tudo √© simples com garfos.  Usar a heran√ßa para substituir a funcionalidade que precisa ser alterada nem sempre √© poss√≠vel e geralmente requer grandes altera√ß√µes.  Plug-ins para o Composer que podem corrigir depend√™ncias s√£o √∫teis. </p><br><p>  Neste artigo, falarei mais sobre por que os garfos s√£o inconvenientes e tamb√©m considerarei dois plugins para o Composer para corre√ß√£o de depend√™ncias: como eles diferem, como us√°-los e quais s√£o suas vantagens.  Se voc√™ encontrou problemas semelhantes ou est√° apenas se perguntando, seja bem-vindo ao gato. <a name="habracut"></a></p><br><p> O problema √© mais convenientemente considerado com um exemplo.  Digamos que queremos alterar algo na biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cobertura de c√≥digo PHP</a> , que √© usada na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estrutura de</a> teste do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHPUnit</a> para medir o n√≠vel de cobertura do c√≥digo pelos testes.  Suponha que desejamos corrigir algo como isto na vers√£o <code>myFix.patch</code> (arquivo <code>myFix.patch</code> ): </p><br><pre> <code class="diff hljs">diff --git a/src/CodeCoverage.php b/src/CodeCoverage.php index 2c92ae2..514171e 100644 --- a/src/CodeCoverage.php +++ b/src/CodeCoverage.php @@ -190,6 +190,7 @@ public function filter(): Filter */ public function getData(bool $raw = false): array { + // for example some changes here if (!$raw &amp;&amp; $this-&gt;addUncoveredFilesFromWhitelist) { $this-&gt;addUncoveredFilesFromWhitelist(); }</code> </pre> <br><p>  Vamos criar nossa biblioteca de exemplos.  Seja <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">php-compositor-patches-example</a> .  Os detalhes aqui n√£o s√£o muito importantes, mas caso voc√™ decida ver qual √© a biblioteca, trago a sa√≠da do console para o spoiler. </p><br><div class="spoiler">  <b class="spoiler_title">Texto oculto</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ git clone git@github.com:mougrim/php-composer-patches-example.git   ¬´php-composer-patches-example¬ª‚Ä¶ remote: Enumerating objects: 3, done. remote: Counting objects: 100% (3/3), done. remote: Compressing objects: 100% (2/2), done. remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0  : 100% (3/3), . $ cd php-composer-patches-example/ $ $ composer.phar init --name=mougrim/php-composer-patches-example --description="It's an example for article with using forks and patches for changing dependencies" --author='Mougrim &lt;rinat@mougrim.ru&gt;' --type=library --require='phpunit/phpunit:^8.4.2' --license=MIT --homepage='https://github.com/mougrim/php-composer-patches-example' Welcome to the Composer config generator This command will guide you through creating your composer.json config. Package name (&lt;vendor&gt;/&lt;name&gt;) [mougrim/php-composer-patches-example]: Description [It's an example for article with using forks and patches for changing dependencies]: Author [Mougrim &lt;rinat@mougrim.ru&gt;, n to skip]: Minimum Stability []: Package Type (eg library, project, metapackage, composer-plugin) [library]: License [MIT]: Define your dependencies. Would you like to define your dev dependencies (require-dev) interactively [yes]? no { "name": "mougrim/php-composer-patches-example", "description": "It's an example for article with using forks and patches for changing dependencies", "type": "library", "homepage": "https://github.com/mougrim/php-composer-patches-example", "require": { "phpunit/phpunit": "^8.4.2" }, "license": "MIT", "authors": [ { "name": "Mougrim", "email": "rinat@mougrim.ru" } ] } Do you confirm generation [yes]? yes Would you like to install dependencies now [yes]? yes Loading composer repositories with package information Updating dependencies (including require-dev) Package operations: 29 installs, 0 updates, 0 removals - Installing sebastian/version (2.0.1): Loading from cache - Installing sebastian/type (1.1.3): Loading from cache - Installing sebastian/resource-operations (2.0.1): Loading from cache - Installing sebastian/recursion-context (3.0.0): Loading from cache - Installing sebastian/object-reflector (1.1.1): Loading from cache - Installing sebastian/object-enumerator (3.0.3): Loading from cache - Installing sebastian/global-state (3.0.0): Loading from cache - Installing sebastian/exporter (3.1.2): Loading from cache - Installing sebastian/environment (4.2.2): Loading from cache - Installing sebastian/diff (3.0.2): Loading from cache - Installing sebastian/comparator (3.0.2): Loading from cache - Installing phpunit/php-timer (2.1.2): Loading from cache - Installing phpunit/php-text-template (1.2.1): Loading from cache - Installing phpunit/php-file-iterator (2.0.2): Loading from cache - Installing theseer/tokenizer (1.1.3): Loading from cache - Installing sebastian/code-unit-reverse-lookup (1.0.1): Loading from cache - Installing phpunit/php-token-stream (3.1.1): Loading from cache - Installing phpunit/php-code-coverage (7.0.8): Loading from cache - Installing doctrine/instantiator (1.2.0): Loading from cache - Installing symfony/polyfill-ctype (v1.12.0): Loading from cache - Installing webmozart/assert (1.5.0): Loading from cache - Installing phpdocumentor/reflection-common (2.0.0): Loading from cache - Installing phpdocumentor/type-resolver (1.0.1): Loading from cache - Installing phpdocumentor/reflection-docblock (4.3.2): Loading from cache - Installing phpspec/prophecy (1.9.0): Loading from cache - Installing phar-io/version (2.0.1): Loading from cache - Installing phar-io/manifest (1.0.3): Loading from cache - Installing myclabs/deep-copy (1.9.3): Loading from cache - Installing phpunit/phpunit (8.4.2): Loading from cache sebastian/global-state suggests installing ext-uopz (*) phpunit/phpunit suggests installing phpunit/php-invoker (^2.0.0) phpunit/phpunit suggests installing ext-soap (*) Writing lock file Generating autoload files $ $ echo 'vendor/' &gt; .gitignore $ echo 'composer.lock' &gt;&gt; .gitignore $ git add .gitignore composer.json $ $ git commit --gpg-sign --message='Init composer' [master ce800ae] Init composer 2 files changed, 18 insertions(+) create mode 100644 .gitignore create mode 100644 composer.json $ git push origin master  : 4, . Delta compression using up to 4 threads.  : 100% (3/3), .  : 100% (4/4), 1.21 KiB | 1.21 MiB/s, . Total 4 (delta 0), reused 0 (delta 0) To github.com:mougrim/php-composer-patches-example.git f31c342..ce800ae master -&gt; master</code> </pre> </div></div><br><h2 id="chto-ne-tak-s-forkom-zavisimosti">  O que h√° de errado com um garfo do v√≠cio </h2><br><p>  Vamos ver como ocorre a depend√™ncia do fork.  Vamos tentar bifurcar a cobertura do c√≥digo PHP. </p><br><ol><li>  Vamos para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a p√°gina de cobertura de c√≥digo PHP no GitHub</a> . </li><li>  Pressione o bot√£o Fork <img src="https://habrastorage.org/webt/qj/ff/ta/qjfftaa4kurvcfu91mlrvr2twie.png" alt="Bot√£o de garfo">  (nota: voc√™ ter√° seu garfo, substitua mougrim pelo seu nome de usu√°rio). </li><li>  Clone o garfo: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:mougrim/php-code-coverage.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-code-coverage</code> </pre> </li><li>  V√° para a vers√£o que queremos corrigir: <br><pre> <code class="bash hljs">git checkout 7.0.8</code> </pre> </li><li>  Crie uma ramifica√ß√£o para corre√ß√£o: <br><pre> <code class="bash hljs">git checkout -b 7.0.8-myFix</code> </pre> </li><li>  Fazemos as altera√ß√µes necess√°rias, confirmamos, pressionamos: <br><pre> <code class="bash hljs">git apply ../myFix.patch git add src/CodeCoverage.php git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'My fix'</span></span> git push -u origin 7.0.8-myFix</code> </pre> </li><li>  Adicione fork como reposit√≥rio em composer.json para nossa biblioteca (isso √© necess√°rio para que, ao conectar o <code>phpunit/php-code-coverage</code> , n√£o o pacote original esteja conectado, mas o fork): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout -b useFork composer.phar config repositories.phpunit/php-code-coverage vcs https://github.com/mougrim/php-code-coverage.git</code> </pre> </li><li>  Altere a vers√£o da depend√™ncia para brunch: <br><pre> <code class="bash hljs">composer.phar require phpunit/php-code-coverage <span class="hljs-string"><span class="hljs-string">'dev-7.0.8-myFix'</span></span></code> </pre> </li></ol><br><p>  Mas, na verdade, √© ainda mais complicado: o Composer diz que a instala√ß√£o √© imposs√≠vel, pois o <code>phpunit/phpunit</code> requer a <code>phpunit/php-code-coverage</code> <code>^7.0.7</code> e, para o nosso projeto, requer <code>dev-7.0.8-myFix</code> : </p><br><pre> <code class="plaintext hljs">$ composer.phar require phpunit/php-code-coverage 'dev-7.0.8-myFix' ./composer.json has been updated Loading composer repositories with package information Updating dependencies (including require-dev) Your requirements could not be resolved to an installable set of packages. Problem 1 - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - Can only install one of: phpunit/php-code-coverage[7.0.x-dev, dev-7.0.8-myFix]. - Installation request for phpunit/php-code-coverage dev-7.0.8-myFix -&gt; satisfiable by phpunit/php-code-coverage[dev-7.0.8-myFix]. - Installation request for phpunit/phpunit ^8.4.2 -&gt; satisfiable by phpunit/phpunit[8.4.2]. Installation failed, reverting ./composer.json to its original content.</code> </pre> <br><p>  O que fazer sobre isso?  Existem quatro op√ß√µes: </p><br><ol><li>  Al√©m da <code>phpunit/php-code-coverage</code> o PHPUnit e escreva a vers√£o <code>dev-7.0.8-myFix</code> para a depend√™ncia <code>phpunit/php-code-coverage</code> .  Esse caminho √© bastante complicado em termos de suporte e, quanto mais complicado, mais bibliotecas dependem da <code>phpunit/php-code-coverage</code> do <code>phpunit/php-code-coverage</code> . </li><li>  Use o <a href="">alias</a> ao conectar o <code>phpunit/php-code-coverage</code> .  Mas os aliases n√£o s√£o extra√≠dos das depend√™ncias, o que significa que eles sempre precisam ser gravados manualmente. </li><li>  Fa√ßa a <code>phpunit/php-code-coverage</code> no seu fork, para que a tag <code>7.0.8</code> a outro commit.  Isso √© pelo menos n√£o √≥bvio, mas no m√°ximo - no Git, √© inconveniente trabalhar com tags que se referem a diferentes commits com o mesmo nome em diferentes reposit√≥rios remotos. </li><li>  Na <code>phpunit/php-code-coverage</code> seu fork <code>phpunit/php-code-coverage</code> use a tag de libera√ß√£o alfa, por exemplo <code>7.0.8-a+myFix</code> (pode haver colis√µes com libera√ß√µes alfa da biblioteca de origem). </li></ol><br><p>  Todas as op√ß√µes t√™m suas desvantagens.  Tamb√©m tentei usar uma tag como <code>7.0.8.1</code> , mas o Composer n√£o aceita essas tags. </p><br><p>  A segunda e quarta op√ß√µes parecem o menor dos males.  Pelo n√∫mero de a√ß√µes, elas s√£o aproximadamente iguais, neste artigo consideraremos apenas uma - a quarta.  Crie uma tag de libera√ß√£o alfa: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-code-coverage git tag 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix git push origin 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example composer.phar require phpunit/php-code-coverage <span class="hljs-string"><span class="hljs-string">'7.0.8-a+myFix'</span></span> git add composer.json git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use fork'</span></span> git push -u origin useFork</code> </pre> <br><p>  Digamos que queremos usar nossa biblioteca <code>mougrim/php-composer-patches-example</code> em um projeto que depende do <code>phpunit/phpunit</code> .  Aqui, n√£o se pode prescindir do xamanismo, voc√™ precisar√° especificar novamente o reposit√≥rio <code>https://github.com/mougrim/php-code-coverage.git</code> para <code>phpunit/php-code-coverage</code> , bem como indicar explicitamente a depend√™ncia da <code>phpunit/php-code-coverage</code> do <code>phpunit/php-code-coverage</code> vers√£o <code>7.0.8-a+myFix</code> (caso contr√°rio, a instala√ß√£o n√£o ser√° bem-sucedida): </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project/ composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span> composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar config repositories.phpunit/php-code-coverage vcs https://github.com/mougrim/php-code-coverage.git composer.phar require phpunit/php-code-coverage 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix composer.phar require mougrim/php-composer-patches-example dev-useFork</code> </pre> <br><p>  Observe que o php-composer-patches-example est√° conectado como um reposit√≥rio, pois esse reposit√≥rio √© apenas um exemplo e, portanto, n√£o foi adicionado ao Packagist.  No seu caso, √© mais prov√°vel que esta etapa seja ignorada. </p><br><p>  Para resumir o uso de garfos. </p><br><p>  As vantagens desta abordagem: </p><br><ul><li>  N√£o √© necess√°rio instalar plugins para o Composer. </li></ul><br><p>  Contras desta abordagem: </p><br><ul><li>  se voc√™ usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>roave/security-advisories</code></a> , n√£o ver√° informa√ß√µes de que a vers√£o da depend√™ncia que voc√™ bifurcou e modificou cont√©m uma vulnerabilidade; </li><li>  quando uma nova vers√£o da depend√™ncia sair, a hist√≥ria da bifurca√ß√£o ter√° que ser repetida novamente; </li><li>  se voc√™ deseja corrigir uma depend√™ncia de depend√™ncia, como no exemplo considerado, o <code>dev-*</code> n√£o funcionar√° para isso e voc√™ dever√° shamanize com vers√µes ou bifurca√ß√£o para depend√™ncias conflitantes; </li><li>  se houver projetos que dependem da sua biblioteca, voc√™ n√£o precisar√° instalar a biblioteca no projeto da maneira mais √≥bvia e conveniente; </li><li>  se houver projetos que dependem da sua biblioteca, para eles a <code>phpunit/php-code-coverage</code> ser√° estritamente corrigida, o que nem sempre √© aceit√°vel; </li><li>  Al√©m disso, se os projetos dos pontos acima j√° bifurcaram a Cobertura de c√≥digo PHP por algum outro motivo, tudo se tornar√° ainda mais complicado. </li></ul><br><p>  Eu acho que voc√™ j√° percebeu que bifurcar o v√≠cio n√£o √© uma boa id√©ia. </p><br><h2 id="ispolzovanie-cweaganscomposer-patches">  Usando cweagans / compositor-patches </h2><br><p>  Mais uma vez, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>cweagans/composer-patches</code></a> dores e sofrendo com o uso de garfos, me deparei com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>cweagans/composer-patches</code></a> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP Digest No. 101</a> (a prop√≥sito, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">pronskiy tem um</a> blog √∫til, recomendo assinar).  Este √© um plugin para o omposer, que permite aplicar patches √†s depend√™ncias.  Depois de ler a descri√ß√£o, pensei que era exatamente isso que voc√™ precisava. </p><br><p>  Como usar cweagans / compositor-patches: </p><br><ol><li>  Clone a cobertura do c√≥digo PHP: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-code-coverage git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:sebastianbergmann/php-code-coverage.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-code-coverage</code> </pre> </li><li>  V√° para a vers√£o que queremos corrigir: <br><pre> <code class="bash hljs">git checkout 7.0.8</code> </pre> </li><li>  N√≥s fazemos as altera√ß√µes necess√°rias. </li><li>  Crie um patch: <br><pre> <code class="bash hljs">mkdir -p ../php-composer-patches-example/patches/phpunit/php-code-coverage git diff HEAD &gt; ../php-composer-patches-example/patches/phpunit/php-code-coverage/myFix.patch</code> </pre> </li><li>  Em nosso projeto, conectamos <code>cweagans/composer-patches</code> : <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout master composer.phar update git checkout -b cweagansComposerPatches composer.phar require cweagans/composer-patches <span class="hljs-string"><span class="hljs-string">'^1.6.7'</span></span></code> </pre> </li><li>  Para configurar <code>cweagans/composer-patches</code> adicione o seguinte a <code>composer.json</code> (voc√™ pode especificar v√°rios patches para um pacote): <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"preferred-install"</span></span>: <span class="hljs-string"><span class="hljs-string">"source"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"patches"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"phpunit/php-code-coverage"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"My fix description"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix.patch"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"enable-patching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> </li><li>  Atualize depend√™ncias: <br><pre> <code class="bash hljs">composer.phar update</code> </pre> </li><li>  Se algo der errado, isso pode ser visto na sa√≠da do comando anterior, mas por precau√ß√£o, voc√™ pode verificar se nossas altera√ß√µes foram aplicadas: <br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> </li><li>  Confirme e envie o resultado: <br><pre> <code class="bash hljs">git add composer.json patches/phpunit/php-code-coverage/myFix.patch git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use cweagans/composer-patches'</span></span> git push -u origin cweagansComposerPatches</code> </pre> </li></ol><br><p>  Garantimos que, ao instalar nossa biblioteca no projeto, o patch tamb√©m se aplique. </p><br><p>  Crie um projeto: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-project mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span></code> </pre> <br><p>  Adicione as seguintes linhas ao <code>composer.json</code> : </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"enable-patching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><p>  Instale <code>mougrim/php-composer-patches-example</code> : </p><br><pre> <code class="bash hljs">composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar require mougrim/php-composer-patches-example dev-cweagansComposerPatches</code> </pre> <br><p>  Parece que, ao conectar o pacote, deveria ter havido uma tentativa de aplicar o patch, mas n√£o. <br>  Atualizamos os pacotes para que o patch se aplique, mas isso n√£o acontece: </p><br><pre> <code class="plaintext hljs">$ composer.phar update Removing package phpunit/php-code-coverage so that it can be re-installed and re-patched. - Removing phpunit/php-code-coverage (7.0.8) Loading composer repositories with package information Updating dependencies (including require-dev) Package operations: 1 install, 0 updates, 0 removals No patches supplied. Gathering patches for dependencies. This might take a minute. - Installing phpunit/php-code-coverage (7.0.8): Loading from cache - Applying patches for phpunit/php-code-coverage patches/phpunit/php-code-coverage/myFix.patch (My fix description) Could not apply patch! Skipping. The error was: The "patches/phpunit/php-code-coverage/myFix.patch" file could not be downloaded: failed to open stream: No such file or directory Writing lock file Generating autoload files</code> </pre> <br><p>  Depois de vasculhar um rastreador de erros, descobri que um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">patch baseado em arquivo n√£o √© resolvido no</a> bug de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">depend√™ncias</a> .  Acontece que voc√™ deve especificar o URL antes do patch (o que significa baix√°-lo de algum lugar) ou especificar o caminho para o patch manualmente em cada projeto em que voc√™ instala uma depend√™ncia que requer patches. </p><br><p>  Para resumir o uso de <code>cweagans/composer-patches</code> . </p><br><p>  As vantagens desta abordagem: </p><br><ul><li>  o plugin tem uma comunidade; </li><li>  <code>roave/security-advisories</code> n√£o param de funcionar; </li><li>  quando uma nova vers√£o da depend√™ncia √© lan√ßada, se o patch for aplicado com √™xito, ser√° suficiente garantir que tudo funcione com a nova vers√£o (para vers√µes menores, com uma alta probabilidade de que funcione por si s√≥, para vers√µes principais tamb√©m √© prov√°vel que nada precise ser feito); </li><li>  se existem projetos que dependem da sua biblioteca, para eles a vers√£o da <code>phpunit/php-code-coverage</code> do <code>phpunit/php-code-coverage</code> n√£o ser√° estritamente corrigida; </li><li>  Al√©m disso, no caso do par√°grafo acima, esse projeto poder√° aplicar seus patches na Cobertura de C√≥digo PHP. </li></ul><br><p>  Contras: </p><br><ul><li>  Este √© um plugin para o Composer, o que significa que, ao atualizar o Composer, ele pode ser quebrado; </li><li>  <code>enable-patching=true</code> deve ser especificado para que os patches sejam aplicados a partir de depend√™ncias; </li><li>  o mantenedor do projeto principal n√£o tem muito tempo para lidar com isso; portanto, como regra geral, ele aceita solicita√ß√µes de recebimento, mas n√£o desenvolve o projeto particularmente (por exemplo, ele tinha id√©ias para a segunda vers√£o da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tarefa</a> , mas pouco mudou depois de tr√™s anos); </li><li>  existe um erro de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">patches baseados em arquivo que n√£o √© resolvido em depend√™ncias</a> , o que √© inconveniente e est√° pendurado na lista de pend√™ncias h√° tr√™s anos; </li><li>  Voc√™ n√£o pode usar patches diferentes para diferentes vers√µes de depend√™ncias. </li></ul><br><p>  O √∫ltimo ponto se tornou uma barreira para mim.  Primeiro, fiz uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">solicita√ß√£o de recurso</a> .  O mantenedor escreveu que n√£o queria adicionar esse recurso ao c√≥digo principal, mas na segunda vers√£o seria poss√≠vel escrever um plug-in (sim, um plug-in para o plug-in do Composer).  As perspectivas para a segunda vers√£o eram vagas, ent√£o decidi procurar alternativas.  Entre a pequena lista, n√£o encontrei um plugin compat√≠vel. </p><br><p>  Como n√£o queria entrar no c√≥digo do plug-in, decidi fazer uma bifurca√ß√£o - com certeza algu√©m j√° encontrou o problema e o resolveu. </p><br><h2 id="ispolzovanie-vaimo-composer-patches">  Usando patches do Vaimo Composer </h2><br><p>  Na maioria dos garfos, n√£o houve diferen√ßas em rela√ß√£o ao original (por que eles ainda bifurcam?).  Parte dos garfos foi feita para solicita√ß√µes pull, que j√° foram mescladas com a biblioteca principal.  No entanto, havia um candidato interessante que estava resolvendo meu problema - o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vaimo Composer Patches</a> .  Naquela √©poca, ainda estava emoldurado como garfo, mas seu mantenedor, ao que parecia, n√£o faria solicita√ß√µes de recebimento.  Entre outras coisas, por exemplo, ele j√° mudou o nome do pacote para <code>vaimo/composer-patches</code> .  Mas havia um problema: os problemas eram desativados, ou seja, n√£o havia nenhum feedback do autor.  Al√©m disso, o plugin n√£o estava hospedado no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Packagist</a> . </p><br><p>  Um garfo t√£o bom n√£o deve ser perdido em uma pilha de outros garfos in√∫teis.  Portanto, entrei em contato com o autor com uma solicita√ß√£o para ativar problemas e adicionar um pacote ao Packagist.  Depois de quase um m√™s, o autor respondeu e fez tudo isso.  :) </p><br><p>  O uso do <code>vaimo/composer-patches</code> n√£o <code>vaimo/composer-patches</code> diferente do uso do plug-in anterior, mas voc√™ pode especificar patches diferentes para vers√µes diferentes. </p><br><ol><li>  Estamos <code>cweagans/composer-patches</code> nossa biblioteca (√© necess√°rio excluir a pasta do <code>vendor</code> , pois os plugins <code>cweagans/composer-patches</code> e <code>vaimo/composer-patches</code> n√£o <code>vaimo/composer-patches</code> muito compat√≠veis entre si): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout master rm -rf vendor/ composer.phar update</code> </pre> </li><li>  Realizamos os pontos 1-4 da se√ß√£o anterior. </li><li>  Em nosso projeto, conectamos o <code>vaimo/composer-patches</code> : <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout -b vaimoComposerPatches composer.phar require vaimo/composer-patches <span class="hljs-string"><span class="hljs-string">'^4.20.2'</span></span></code> </pre> </li><li>  Para configurar o <code>vaimo/composer-patches</code> adicione o seguinte a <code>composer.json</code> (a documenta√ß√£o pode ser vista <a href="">aqui</a> ): <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"patches"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"phpunit/php-code-coverage"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"My fix description"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"&lt; 7.0.0"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix-leagcy.patch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"&gt;= 7.0.0"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix.patch"</span></span> } } } } }</code> </pre> </li><li>  Atualize depend√™ncias: <br><pre> <code class="bash hljs">composer.phar update</code> </pre> </li><li>  Se algo der errado, isso pode ser visto na sa√≠da do comando anterior, mas por precau√ß√£o, voc√™ pode garantir que nossas altera√ß√µes sejam aplicadas: <br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> </li><li>  Confirme e envie o resultado: <br><pre> <code class="bash hljs">git add composer.json patches/phpunit/php-code-coverage/myFix.patch git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use vaimo/composer-patches'</span></span> git push -u origin vaimoComposerPatches</code> </pre> </li></ol><br><p>  Garantimos que, ao instalar nossa biblioteca no projeto, o patch tamb√©m se aplique. </p><br><p>  Crie um projeto e instale o <code>mougrim/php-composer-patches-example</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-project mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span> composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar require mougrim/php-composer-patches-example dev-vaimoComposerPatches</code> </pre> <br><p>  Por precau√ß√£o, voc√™ pode garantir que nossas altera√ß√µes foram aplicadas: </p><br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> <br><p>  Para resumir o uso de <code>vaimo/composer-patches</code> . </p><br><p>  As vantagens deste plugin s√£o quase as mesmas que as anteriores, mas tamb√©m incluem o seguinte: </p><br><ul><li>  o mantenedor est√° desenvolvendo ativamente o plug-in e j√° lan√ßou a quarta vers√£o principal; </li><li>  n√£o h√° necessidade de prescrever nada adicionalmente para que os patches das depend√™ncias sejam aplicados; </li><li>  Voc√™ pode usar patches diferentes para diferentes vers√µes de depend√™ncias; </li><li>  o plug-in tem muitas configura√ß√µes; portanto, se a funcionalidade descrita no artigo n√£o for suficiente para voc√™, consulte a documenta√ß√£o - talvez o recurso necess√°rio j√° esteja implementado. </li></ul><br><p>  Contras: </p><br><ul><li>  como o anterior, este √© um plugin para o Composer, o que significa que, ao atualizar o Composer, ele pode se quebrar; </li><li>  ao contr√°rio do plug-in anterior, esta comunidade tem menos. </li></ul><br><h2 id="vyvody">  Conclus√µes </h2><br><p>  Para resumir: </p><br><ul><li>  usar garfos de pacotes para pequenas corre√ß√µes √© inconveniente; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>cweagans/composer-patches</code></a> √© um bom plugin, mas se desenvolve mal, por isso n√£o o recomendo; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Vaimo Composer Patches</a> √© um excelente plug-in que resolve bem o problema de corrigir depend√™ncias e tamb√©m possui v√°rias configura√ß√µes; </li><li>  O Vaimo Composer Patches possui uma pequena comunidade, mas espero que este artigo a aumente; </li><li>  se forem necess√°rias muitas altera√ß√µes na depend√™ncia, pode ser mais f√°cil recorrer a um fork for√ßado (mantenha o fork independente da depend√™ncia original). </li></ul><br><p>  Tamb√©m tirei uma conclus√£o indireta: se algum tipo de depend√™ncia n√£o fornecer a funcionalidade necess√°ria, poder√° haver garfos que implementaram essa funcionalidade e muito mais. </p><br><p>  No Badoo, usamos o Vaimo Composer Patches em dois casos: </p><br><ul><li>  no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SoftMocks</a> para corrigir a cobertura do PHPUnit e do c√≥digo PHP; </li><li>  no reposit√≥rio interno da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">corre√ß√£o</a> Webmozart <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Assert</a> para compatibilidade com o SoftMocks como uma corre√ß√£o tempor√°ria (enquanto o SoftMocks n√£o suporta constru√ß√µes <code>array_map(array('static', 'valueToString')</code> ). </li></ul><br><p>  Rinat Akhmadeev, Sr.  Desenvolvedor PHP </p><br><p>  <strong>UPD1</strong> : Obrigado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">BoShurik</a> pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> para os <a href="">aliases</a> .  Foi adicionado um artigo sobre aliases ao artigo. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473654/">https://habr.com/ru/post/pt473654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473640/index.html">P√¥r-do-sol de grande volume de dados</a></li>
<li><a href="../pt473642/index.html">Cribble Crabble Gradle: Auto Build Magic</a></li>
<li><a href="../pt473646/index.html">Hackathon em uma pequena empresa: como organizar sem descarregar um trem de recursos</a></li>
<li><a href="../pt473648/index.html">O cavalo est√° morto - cry: transi√ß√£o de tslint para eslint</a></li>
<li><a href="../pt473652/index.html">Criando uma API REST com Node.js e um Banco de Dados Oracle. Parte 5</a></li>
<li><a href="../pt473656/index.html">Experi√™ncia com o Hugo Static Site Generator</a></li>
<li><a href="../pt473658/index.html">Lidando com bugs no Go 1.13</a></li>
<li><a href="../pt473660/index.html">Arcade Reverse Engineering: Record Michael Jordan no NBA Jam</a></li>
<li><a href="../pt473664/index.html">Experi√™ncia de aprendizado em primeira m√£o. Yandex.Practicum - Analista de dados</a></li>
<li><a href="../pt473666/index.html">Como escritor de fic√ß√£o cient√≠fica, Arthur Clark quase fechou a revista Tech - Youth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>