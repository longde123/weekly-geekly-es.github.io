<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòØ üö¥üèΩ üêé ESP32 + Arduino Core + FreeRTOS + Blynk = casa com o in√≠cio da mente ü§¶üèø üôèüèΩ üßíüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Objetivos do projeto 


 De alguma forma, acabei construindo minha casa, um esqueleto. No meu luxo, n√£o h√° g√°s e n√£o √© esperado em um futuro pr√≥ximo; ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ESP32 + Arduino Core + FreeRTOS + Blynk = casa com o in√≠cio da mente</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479156/"><h2 id="celi-proekta">  Objetivos do projeto </h2><br><p> De alguma forma, acabei construindo minha casa, um esqueleto.  No meu luxo, n√£o h√° g√°s e n√£o √© esperado em um futuro pr√≥ximo; portanto, escolhi um esqueleto - tudo o resto, para mim, seria muito caro aquecer com eletricidade.  Bem, tamb√©m porque √© uma das tecnologias mais baratas. <br>  Ok, joguei canos pela casa, desliguei as baterias, uma caldeira, parecia quente, mas algo estava errado. </p><br><p>  Depois de me ouvir, percebi que esse sapo n√£o me agrada, que enquanto n√£o estou em casa (12 a 16 horas por dia), o aquecimento funciona.  E pode n√£o funcionar, ligue apenas antes da chegada, pois o esqueleto tem uma ligeira in√©rcia e permite aumentar rapidamente a temperatura.  A mesma situa√ß√£o quando em algum lugar por um longo tempo para sair de casa.  Bem, em geral, correr, girar a manivela da caldeira com mudan√ßas de temperatura na rua de alguma forma n√£o √© kosher. </p><a name="habracut"></a><br><p>  Ficou claro que, sem automa√ß√£o, em nenhum lugar a caldeira √© a mais simples, mas possui contatos para conectar um rel√© de controle externo.  Claro, voc√™ poderia comprar imediatamente uma caldeira com todas as fun√ß√µes necess√°rias, mas, para mim, essas caldeiras s√£o de alguma forma desumanas.  Al√©m disso, eu queria me agachar com o c√©rebro, fazer xixi na alma, aprender um pouco de C, embora na vers√£o do arduino. </p><br><p>  Na verdade, sobre os requisitos: </p><br><ul><li>  controle de temperatura do ponto de ajuste </li><li>  controle da temperatura do l√≠quido de refrigera√ß√£o, dependendo da temperatura externa ou manualmente </li><li>  fusos hor√°rios com configura√ß√µes diferentes, mais frios de dia e mais quentes de noite </li><li>  modo autom√°tico, com transi√ß√£o autom√°tica dia-noite </li><li>  modo manual, sem transi√ß√µes autom√°ticas, para o fim de semana </li><li>  modo n√£o autom√°tico, onde voc√™ pode definir manualmente qualquer temperatura do l√≠quido de refrigera√ß√£o e ligar / desligar a caldeira </li><li>  controle de aquecimento localmente, a partir de bot√µes e tela e atrav√©s do site / aplicativo m√≥vel </li></ul><br><p>  Foi no come√ßo e depois sofri e acrescentei: </p><br><ul><li>  controle de l√¢mpadas de rua (refletor LED) </li><li>  sistema de alarme baseado em sensor de movimento, sirene e poste </li><li>  medi√ß√£o da energia consumida pela caldeira por dia / m√™s / ano + para cada m√™s do ano </li><li>  modo de alarme apenas piscando lentamente uma l√¢mpada </li><li>  modo de sinaliza√ß√£o piscando rapidamente uma l√¢mpada e bipes curtos de uma sirene </li><li>  modo de sinaliza√ß√£o piscando rapidamente uma l√¢mpada e uivos constantes de uma sirene </li></ul><br><p>  O objetivo deste artigo √© compartilhar experi√™ncias, descrever algo em russo que n√£o consegui encontrar na Internet.  Acho que este artigo ser√° √∫til para iniciantes em Arduino que j√° est√£o um pouco familiarizados com programa√ß√£o, como  coisas absolutamente b√°sicas que n√£o descrevi.  Tentei escrever o c√≥digo o mais claro poss√≠vel, espero ter conseguido. </p><br><h2 id="chto-bylo-v-nachale">  O que estava no come√ßo </h2><br><p>  Inicialmente, o projeto foi implementado em um monte selvagem de Arduino Nano + ESP8266, mas o ESP n√£o √© um escudo, mas um dispositivo separado.  Porque  Sim, porque eu j√° tinha tudo isso, mas n√£o havia dinheiro da palavra, ent√£o n√£o queria comprar ferro novo em princ√≠pio.  Por que o ESP n√£o √© como um escudo?  Agora nem me lembro. </p><br><p>  O Arduino conduziu todos os processos porque possu√≠a a quantidade necess√°ria de GPIO, e o ESP enviou todos os dados ao servidor Blynk, porque conhecia a Internet e n√£o possu√≠a GPIO suficiente.  Eles se conectaram atrav√©s do UART e enviaram JSON com dados um para o outro.  O esquema √© incomum, mas funcionou por um ano quase sem queixas.  <a href="https://github.com/abashind/HomeHeater">Qualquer pessoa</a> interessada pode ver o <a href="https://github.com/abashind/HomeHeater">codec</a> . </p><br><p>  Farei uma reserva imediatamente, n√£o era muito habilidoso na √©poca (e at√© agora gostaria de fazer melhor), portanto, √© melhor que mulheres gr√°vidas e crian√ßas n√£o assistam.  Al√©m disso, tudo foi escrito no IDE do Arduino, n√£o ser√° lembrado √† noite, o que √© bastante limitado em termos de refatora√ß√£o, tudo √© muito primitivo l√°. </p><br><h2 id="zhelezo">  Ferro </h2><br><p>  Assim, um ano se passou, as finan√ßas autorizadas a comprar o ESP32 devkit v1, que possui GPIO suficiente, podem acessar a Internet e geralmente um super controlador.  Al√©m das piadas, gostei muito dela no final do trabalho. </p><br><p>  Lista de ferro: </p><br><ul><li>  ESP32 devkit v1 noname China </li><li>  3 sensores de temperatura DS18B20, temperatura interna, externa e temperatura do l√≠quido de refrigera√ß√£o nos tubos </li><li>  bloco de 4 rel√©s </li><li>  sensor pir HC-SR501 </li></ul><br><p>  N√£o vou desenhar um esquema, acho que tudo ficar√° claro nas macros com os nomes dos pinos. </p><br><h2 id="pochemu-freertos-i-arduino-core">  Por que FreeRTOS e Arduino Core </h2><br><p>  Muitas bibliotecas est√£o escritas no Arduino, em particular o mesmo Blynk, para que voc√™ n√£o se afaste do Arduino Core. </p><br><p>  FreeRTOS porque permite organizar o trabalho de um pequeno peda√ßo de ferro semelhante ao trabalho de um controlador industrial completo.  Cada tarefa pode ser movida para sua pr√≥pria tarefa, parada, iniciada, criada quando necess√°rio, exclu√≠da - tudo isso √© muito mais flex√≠vel do que escrever uma longa porcaria de c√≥digo Arduino, quando no final tudo √© feito por sua vez na fun√ß√£o loop. </p><br><p>  Ao usar o FreeRTOS, cada tarefa ser√° executada em um hor√°rio estritamente especificado, se apenas a energia do processador for suficiente.  Pelo contr√°rio, no Arduino, todo o c√≥digo √© executado em uma fun√ß√£o, em um thread, se algo diminuir, o restante das tarefas ser√° atrasado.  Isso √© especialmente percept√≠vel ao gerenciar processos r√°pidos. Neste projeto, esse piscar de lanterna e o bipe da sirene ser√£o discutidos abaixo. </p><br><h2 id="pro-logiku">  Sobre l√≥gica </h2><br><h3 id="pro-freertos-taski">  Sobre as tarefas do FreeRTOS </h3><br><p>  ‚Üí Link para <a href="https://github.com/abashind/home_auto_2019">todo o codec do projeto</a> </p><br><p>  Portanto, ao usar o FreeRTOS, a fun√ß√£o de configura√ß√£o desempenha o papel da fun√ß√£o principal, o ponto de entrada para o aplicativo, as tarefas do FreeRTOS (a seguir designadas) s√£o criadas nele, a fun√ß√£o de loop n√£o pode ser usada. </p><br><p>  Considere uma pequena tarefa para calcular a temperatura do l√≠quido de refrigera√ß√£o: </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate_water_temp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pvParameters)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (heating_mode == <span class="hljs-number"><span class="hljs-number">3</span></span>) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-20</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-20</span></span> &amp;&amp; temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-25</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-25</span></span> &amp;&amp; temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-30</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">70</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-30</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">85</span></span>; } vTaskDelay(<span class="hljs-number"><span class="hljs-number">1000</span></span> / portTICK_RATE_MS); } }</code> </pre> <br><p>  √â declarada como uma fun√ß√£o que deve levar _void <code>pvParameters</code> , um loop sem fim √© organizado dentro da fun√ß√£o, usei <code>while (true)</code> . </p><br><p>  Um c√°lculo simples de temperatura √© <code>vTaskDelay(1000 / portTICK_RATE_MS)</code> (se o modo operacional permitir) e a tarefa √© sacrificada pelo <code>vTaskDelay(1000 / portTICK_RATE_MS)</code> por 1 segundo.  Nesse modo, ele n√£o consome tempo da CPU, as vari√°veis ‚Äã‚Äãcom as quais a tarefa trabalhou, em outras palavras, o contexto, s√£o armazenadas na pilha para tir√°-las de l√° quando chegar a hora. </p><br><p>  A pr√≥xima tarefa deve ser criada na instala√ß√£o.  Isso √© feito chamando o m√©todo <code>xTaskCreate</code> : </p><br><p> <code>xTaskCreate(calculate_water_temp, "calculate_water_temp", 2048, NULL, 1, NULL);</code> </p> <br><p>  Existem muitos argumentos, mas para n√≥s, <em>calcule_aqu_tempo_√°gua</em> √© significativo - o nome da fun√ß√£o que cont√©m o c√≥digo da tarefa e 2048 √© o tamanho da pilha em bytes. </p><br><p>  O tamanho da pilha inicialmente definiu todos como 1024 bytes, ent√£o calculei o m√©todo desejado digitando: se o controlador come√ßar a cair com um estouro de pilha (como pode ser visto na sa√≠da em uart), apenas aumentei o tamanho da pilha em 2 vezes, se n√£o ajudou, em 2 vezes e assim at√© que funcione.  Obviamente, isso n√£o economiza muito mem√≥ria, mas o ESP32 possui o suficiente, no meu caso, voc√™ n√£o poderia se preocupar com isso. </p><br><p>  Voc√™ tamb√©m pode especificar um identificador para tarefa - um identificador com o qual voc√™ pode controlar a tarefa ap√≥s a cria√ß√£o, por exemplo - excluir.  Este √© o √∫ltimo NULL no exemplo.  Um identificador √© criado assim: </p><br><p> <code>TaskHandle_t slow_blink_handle;</code> </p> <br><p>  Em seguida, ao criar uma tarefa, um ponteiro para o <code>xTaskCreate</code> passado para o par√¢metro xTaskCreate: </p><br><p> <code>xTaskCreate(outside_lamp_blinks, "outside_lamp_blynk", 10000, (void *)1000, 1, &amp;slow_blink_handle);</code> </p> <br><p>  E se queremos remover a tarefa, fazemos o seguinte: </p><br><p> <code>vTaskDelete(slow_blink_handle);</code> </p> <br><p>  Como isso √© usado pode ser visto no c√≥digo da <code>panic_control</code> panic_control. </p><br><h3 id="pro-freertos-myuteksy">  FreeRTOS Mutex Pros </h3><br><p>  O Mutex √© usado para eliminar conflitos entre tarefas ao acessar recursos como uart, wifi etc.  No meu caso, eu precisava de mutexes para wifi e acesso √† mem√≥ria flash. </p><br><p>  Crie um link para o mutex: </p><br><p> <code>SemaphoreHandle_t wifi_mutex;</code> </p> <br><p>  Na <code>setup</code> crie um mutex: </p><br><p> <code>wifi_mutex = xSemaphoreCreateMutex();</code> </p> <br><p>  Al√©m disso, quando precisamos acessar o recurso de tarefa, ele recebe o mutex, permitindo que o restante das tarefas saiba que o recurso est√° ocupado e n√£o h√° necessidade de tentar trabalhar com ele: </p><br><p> <code>xSemaphoreTake(wifi_mutex, portMAX_DELAY);</code> </p> <br><p>  <code>portMAX_DELAY</code> - aguarde indefinidamente at√© que o recurso e o mutex sejam liberados por outras tarefas, todo esse tempo a tarefa ser√° suspensa. </p><br><p>  Depois de trabalhar com o recurso, fornecemos o mutex para que outros possam us√°-lo: </p><br><p> <code>xSemaphoreGive(wifi_mutex);</code> </p> <br><p>  Voc√™ pode ver o c√≥digo em mais <code>send_data_to_blynk</code> na <code>send_data_to_blynk</code> send_data_to_blynk. </p><br><p>  Na pr√°tica, o n√£o uso de mutexes n√£o era percept√≠vel durante a opera√ß√£o do controlador, mas durante a depura√ß√£o JTAG, os erros desapareciam constantemente e desapareciam ap√≥s o uso dos mutexes. </p><br><h3 id="kratkoe-opisanie-tasok">  Breve descri√ß√£o do tasok </h3><br><p>  <code>get_temps</code> - recebendo temperatura dos sensores, a cada 30 segundos, mais frequentemente, n√£o √© necess√°rio. <br>  <code>get_time_task</code> - obt√©m tempo dos servidores NTP.  Anteriormente, chegou a hora do m√≥dulo RTC DS3231, mas ele come√ßou a falhar ap√≥s um ano de trabalho, ent√£o decidi me livrar dele.  Decidi que isso n√£o tem consequ√™ncias especiais, principalmente o tempo afeta a mudan√ßa do fuso hor√°rio do aquecimento - dia ou noite.  Se a Internet desaparecer durante a opera√ß√£o do controlador, o hor√°rio simplesmente congelar√°, o fuso hor√°rio permanecer√° o mesmo.  Se o controlador desligar e depois de ligar n√£o houver Internet, o hor√°rio ser√° sempre 0:00:00 - modo de aquecimento √† noite. <br>  <code>calculate_water_temp</code> - considerado acima. <br>  <code>detect_pir_move</code> - recebendo um sinal de movimento do sensor HC-SR501.  O sensor forma uma unidade l√≥gica + 3.3V quando o movimento √© detectado, o qual √© detectado usando <code>digitalRead</code> , a prop√≥sito, o pino de detec√ß√£o desse sensor deve ser puxado para GND - <code>pinMode(pir_pin, INPUT_PULLDOWN);</code> <br>  <code>heating_control</code> - alternando os modos de aquecimento. <br>  <code>out_lamp_control</code> - controle de uma l√¢mpada de rua. <br>  <code>panic_control</code> - controla a sirene e o foco quando o movimento √© detectado.  Para criar o efeito de sirenes e luzes piscantes, s√£o usadas tarefas separadas, <code>siren_beeps</code> e <code>siren_beeps</code> .  Ao usar o FreeRTOS, o piscar e o bipe funcionam perfeitamente, exatamente nos intervalos definidos, outras tarefas n√£o afetam seu trabalho, porque  eles vivem em fluxos separados.  O FreeRTOS garante que o c√≥digo na tarefa seja executado no hor√°rio especificado.  Ao implementar essas fun√ß√µes no <code>loop</code> tudo funcionou n√£o t√£o bem, porque  influenciado pela execu√ß√£o de outro c√≥digo. <br>  <code>guard_control</code> - controle dos modos de guarda. <br>  <code>send_data_to_blynk</code> - envia dados para o aplicativo Blynk. <br>  <code>run_blynk</code> - tarefa para iniciar o <code>Blynk.run()</code> conforme exigido pelo manual para o uso do Blynk.  Pelo que entendi, isso √© necess√°rio para obter dados do aplicativo para o controlador.  Em geral, <code>Blynk.run()</code> deve estar em um <code>loop</code> , mas eu basicamente n√£o queria colocar nada l√° e a tornava uma tarefa separada. <br>  <code>write_setting_to_pref</code> - grave configura√ß√µes e modos de opera√ß√£o para captur√°-los ap√≥s uma reinicializa√ß√£o.  Sobre pref ser√° descrito abaixo. <br>  <code>count_heated_hours</code> - contando o tempo de opera√ß√£o da caldeira.  Fiz isso com simplicidade, se a caldeira estiver ligada no momento do in√≠cio da tarefa (uma vez a cada 30 segundos), na mem√≥ria flash o valor da chave desejada √© aumentado em um. <br>  <code>send_heated_hours_to_app</code> - nesta tarefa, os valores s√£o extra√≠dos e multiplicados por 0,00833 (1/120 horas), as horas recebidas de opera√ß√£o da caldeira s√£o enviadas para o aplicativo Blynk. <br>  <code>feed_watchdog</code> - alimenta o Watchdog.  Eu tive que escrever watchdog, porque  uma vez a cada poucos dias, o controlador pode congelar.  O que est√° conectado n√£o √© claro, pode haver algum tipo de interfer√™ncia na fonte de alimenta√ß√£o, mas o uso do watchdog resolve esse problema.  Watchdog timer por 10 segundos, tudo bem se o controlador n√£o estiver dispon√≠vel por 10 segundos. <br>  <code>heart_beat</code> - tarefa com um pulso.  Quando passo no controlador, quero saber se ele funciona bem.  Porque  na minha placa n√£o h√° LED embutido, tive que usar o UART LED - instalar <code>Serial.begin(9600);</code>  e escreva uma sequ√™ncia longa no UART.  Funciona muito bem. </p><br><h3 id="esp32-nvs-wear-leveling">  Nivelamento de desgaste ESP32 NVS </h3><br><p>  <em>As descri√ß√µes a seguir s√£o bastante grosseiras, literalmente nos dedos, apenas para transmitir a ess√™ncia do problema.</em>  <em><a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html">Mais detalhes</a></em> </p><br><p>  O Arduino usa mem√≥ria EEPROM para armazenar dados em mem√≥ria n√£o vol√°til.  Essa √© uma pequena mem√≥ria na qual cada byte pode ser gravado e apagado separadamente, enquanto a mem√≥ria flash √© apagada apenas por setores. </p><br><p>  N√£o h√° EEPROM no ESP32, mas geralmente h√° 4 Mb de mem√≥ria flash na qual voc√™ pode criar parti√ß√µes para o firmware do controlador ou para armazenar dados do usu√°rio.  As se√ß√µes para dados do usu√°rio s√£o de v√°rios tipos - NVS, FATFS, SPIFFS.  Ele deve ser selecionado com base no tipo de dado destinado √† grava√ß√£o. </p><br><p>  Porque  todos os dados que est√£o sendo escritos neste projeto s√£o do tipo Int, escolhi NVS - Non-Volitile Storage.  Esse tipo de parti√ß√£o √© adequado para armazenar dados pequenos, geralmente substitu√≠veis.  Para entender o porqu√™, voc√™ deve aprofundar um pouco a organiza√ß√£o do NVS. </p><br><p>  Como a EEPROM e o FLASH, existem restri√ß√µes na substitui√ß√£o de dados, os bytes na EEPROM podem ser substitu√≠dos de 100.000 a 1.000.000 de vezes e o setor FLASH √© o mesmo.  Se gravarmos dados uma vez por segundo, obteremos 60 segundos x 60 minutos x 24 horas = 86.400 vezes / dia.  Ou seja, nesse modo, o byte durar√° 11 dias, o que √© um pouco.  Ap√≥s o qual o byte ficar√° indispon√≠vel para escrita e leitura. </p><br><p>  Para amenizar esse problema, as fun√ß√µes <code>update()</code> <code>put()</code> da biblioteca EEPROM do Arduino gravam dados apenas quando s√£o alteradas.  Ou seja, voc√™ pode escrever a cada segundo algumas configura√ß√µes e c√≥digos de modo que mudam muito raramente. </p><br><p>  O NVS usa um m√©todo diferente de controlar o nivelamento do desgaste.  Como mencionado acima, os dados no setor flash podem ser gravados em partes, mas somente o setor inteiro pode ser apagado.  Portanto, a grava√ß√£o de dados no NVS √© realizada em um tipo de di√°rio, este di√°rio √© dividido em p√°ginas, que s√£o colocadas em um setor da mem√≥ria flash.  Os dados s√£o gravados em pares de chave: valor.  De fato, √© ainda mais f√°cil do que com a EEPROM, porque  trabalhar com um nome significativo √© mais f√°cil do que com um endere√ßo na mem√≥ria.  <strong>Upd:</strong> o tamanho da chave n√£o ultrapassa 15 caracteres! </p><br><p>  Se voc√™ primeiro escrever o valor <code>1</code> na tecla <code>somekey</code> tecla e depois escrever o valor <code>2</code> na mesma chave, o primeiro valor n√£o ser√° exclu√≠do, ser√° marcado apenas como exclu√≠do (Apagado) e uma nova entrada ser√° adicionada ao log: </p><br><p><img src="https://habrastorage.org/webt/pw/ri/of/pwriofnineuwy7bmctgzcngiqrk.jpeg"></p><br><p>  Se voc√™ tentar ler os dados com <code>somekey</code> √∫ltimo valor dessa chave ser√° retornado.  Porque  Como o log √© comum, os valores das diferentes chaves s√£o armazenados pr√≥ximos um do outro √† medida que s√£o gravados. </p><br><p>  A p√°gina tem um status Vazio - vazio, sem entradas, dados ativos est√£o sendo gravados no momento, Cheio - est√° cheio, voc√™ n√£o pode gravar nele.  Assim que a p√°gina fica sem espa√ßo, ela √© de <br>  Ativo vai para Cheio e a pr√≥xima p√°gina Vazia se torna Ativa. </p><br><p><img src="https://habrastorage.org/webt/6q/lz/ym/6qlzymofwdhy9ah2x-ekgpd23tq.jpeg"></p><br><p>  Tanto quanto eu entendi na documenta√ß√£o no site da Espressif e em v√°rios f√≥runs, a limpeza de p√°ginas come√ßa quando as p√°ginas gratuitas chegam ao fim.  Para ser mais preciso, de acordo <a href="">com isso</a> , o apagamento ocorrer√° quando restar apenas 1 p√°gina gr√°tis. </p><br><p>  Se a p√°gina precisar ser limpa, os registros atuais (N√£o Apagados) ser√£o movidos para outra p√°gina e a p√°gina ser√° substitu√≠da. </p><br><p>  Assim, a opera√ß√£o de grava√ß√£o e apagamento para cada p√°gina espec√≠fica √© bastante rara, quanto mais p√°ginas - com menos frequ√™ncia.  Com base nisso, aumentei o tamanho da parti√ß√£o NVS para 1 MB. Na minha taxa de grava√ß√£o, isso √© suficiente por 170 anos, o que geralmente √© suficiente.  O redimensionamento da se√ß√£o NVS ser√° o pr√≥ximo. </p><br><p>  Para um trabalho conveniente com o NVS, o ESP32 para Arduino Core possui uma √∫til biblioteca de Prefer√™ncias escrita, como trabalhar com ele est√° <a href="">aqui</a> . </p><br><h3 id="nemnogo-o-visualgdb">  Um pouco sobre o VisualGDB </h3><br><p>  Assim que comecei a trabalhar com o Arduino IDE, fiquei imediatamente surpreso com a funcionalidade miser√°vel em compara√ß√£o com o Visual Studio.  Eles dizem que o VS tamb√©m n√£o √© uma fonte, embora me convenha, mas escrever algo com mais de 50 linhas no IDE do Arduino √© dolorosamente doloroso e dolorosamente longo.  Assim, surgiu a quest√£o de escolher um IDE para o desenvolvimento.  Porque  Estou familiarizado com o VS, estabeleci-me no <a href="https://visualgdb.com/tutorials/arduino/esp32/">VisualGDB</a> . </p><br><p>  Ap√≥s o IDE do Arduino, o desenvolvimento do ESP32 √© simplesmente um ref√∫gio.  Qual √© a transi√ß√£o para a defini√ß√£o, a busca por chamadas no projeto e a capacidade de renomear a vari√°vel. </p><br><h3 id="izmenenie-tablicy-razdelov-esp32-pri-rabote-s-visualgdb">  Alterando a tabela de parti√ß√£o ESP32 com o VisualGDB </h3><br><p>  Como mencionado acima, a tabela pode ser alterada com a parti√ß√£o ESP32; consideraremos como isso pode ser feito. <br>  A tabela √© editada como um arquivo CSV, por padr√£o, o VisualGDB grava a seguinte tabela: </p><br><pre> <code class="plaintext hljs">Name, Type, SubType, Offset, Size, Flags nvs, data, nvs, 0x9000, 0x5000, otadata, data, ota, 0xe000, 0x2000, app0, app, ota_0, 0x10000, 0x140000, app1, app, ota_1, 0x150000,0x140000, spiffs, data, spiffs, 0x290000,0x170000,</code> </pre> <br><p>  Aqui vemos uma se√ß√£o no NVS, duas se√ß√µes para aplicativos e mais algumas se√ß√µes.  Das nuances, √© poss√≠vel notar que o app0 (seu aplicativo) deve sempre ser gravado no deslocamento 0x10000, iniciando no endere√ßo zero, caso contr√°rio, o carregador de inicializa√ß√£o n√£o o detectar√°.  Al√©m disso, as compensa√ß√µes devem ser selecionadas para que as se√ß√µes n√£o se "sobreponham".  A tabela de parti√ß√£o em si √© gravada no deslocamento 0x8000.  Como voc√™ pode ver, o tamanho do NVS neste caso √© 0x5000 - 20KB, o que n√£o √© muito. </p><br><p>  Modifiquei a tabela de parti√ß√£o da seguinte maneira: </p><br><pre> <code class="plaintext hljs">Name, Type, SubType, Offset, Size, Flags app0, app, ota_0, 0x10000, 0x140000, nvs, data, nvs, , 1M, otadata, data, ota, , 0x2000, spiffs, data, spiffs, , 0x170000,</code> </pre><br><p>  N√£o se esque√ßa de adicionar uma grade antes de Name; se voc√™ usar esta tabela, precisar√° que esta linha seja considerada um coment√°rio. </p><br><p>  Como voc√™ pode ver, o tamanho do NVS √© aumentado para 1 MB.  Se voc√™ n√£o especificar compensa√ß√µes, a se√ß√£o come√ßar√° imediatamente ap√≥s a anterior, portanto, basta indicar o deslocamento apenas para app0.  Os arquivos CSV podem ser editados no bloco de notas como txt e altere a permiss√£o para csv para o arquivo salvo. </p><br><p>  Em seguida, a tabela de parti√ß√£o deve ser convertida em um bin√°rio, porque  entra no controlador neste formul√°rio.  Para fazer isso, execute o conversor: <br>  <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\tools\gen_esp32part.exe part_table_name.csv part_table_name.bin</code> .  O primeiro par√¢metro √© o seu CSV, o segundo par√¢metro √© o bin√°rio de sa√≠da. </p><br><p>  O bin√°rio resultante deve ser colocado em <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\tools\partitions\part_table_name.csv</code> , ap√≥s o qual √© necess√°rio especificar que foi ele quem foi levado para criar a solu√ß√£o e nenhuma tabela de parti√ß√£o padr√£o.  Voc√™ pode fazer isso escrevendo o nome da sua tabela no arquivo <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\boards.txt</code> .  No meu caso, este √© <code>esp32doit-devkit-v1.build.partitions=part_table_name</code> <br>  Ap√≥s essas manipula√ß√µes, o VisualGDB ao criar o aplicativo pegar√° exatamente sua tabela de parti√ß√µes e a colocar√° em <br>  <code>~project_folder_path\Output\board_name\Debug\project_name.ino.partitions.bin</code> , de onde ele j√° ser√° despejado no quadro. </p><br><h3 id="jtag-otladchik-cjmc-ft232h">  Depurador JTAG CJMC-FT232H </h3><br><p>  At√© onde eu sei, este √© o depurador mais barato que pode funcionar com o ESP32, custou-me cerca de 600 rublos, existem muitos no Aliexpress. </p><br><p><img src="https://habrastorage.org/webt/gn/cu/gm/gncugmqpjnb1hbmj630nnegxjgq.jpeg"></p><br><p>  Quando voc√™ conecta o depurador, o Windows instala nele drivers inadequados que precisam ser alterados usando o programa Zadig, tudo √© simples l√°, n√£o vou descrev√™-lo. </p><br><p>  Ele se conecta ao ESP32 devkit-v1 da seguinte maneira: <br>  FT232H - ESP32 <br>  AD0 - GPIO13 <br>  AD1 - GPIO12 <br>  AD2 - GPIO15 <br>  AD3 - GPIO14 <br>  Em seguida, em <code>Project -&gt; VisualGDB Project Properties</code> √© necess√°rio fazer as seguintes configura√ß√µes: </p><br><p><img src="https://habrastorage.org/webt/eg/oi/7b/egoi7bhrpkjaprfvyz-jd9puccw.jpeg"></p><br><p>  Depois clique em Teste.  √Äs vezes, acontece que a conex√£o n√£o √© estabelecida na primeira vez, o processo parece congelar e √© necess√°rio interromper e repetir o teste.  Se tudo estiver em ordem, o processo de teste da conex√£o leva cerca de 5 segundos. </p><br><p>  Normalmente, montei o projeto e o carreguei via USB para o pr√≥prio ESP32 (n√£o pelo depurador), ap√≥s o qual comecei a depura√ß√£o usando <code>Debug -&gt; Attach to Running Embedded Firmware</code> .  No c√≥digo, voc√™ pode definir pontos de interrup√ß√£o, examinar os valores das vari√°veis ‚Äã‚Äãno momento da quebra e, na janela <code>Debug -&gt; Windows -&gt; Threads</code> , √© poss√≠vel ver em qual c√≥digo do FreeRTOS o c√≥digo parou, o que √© √∫til se ocorrer um erro durante a depura√ß√£o.  Essas fun√ß√µes do depurador foram suficientes para eu trabalhar confortavelmente. <br>  Quando comecei a trabalhar com o NVS, a depura√ß√£o era constantemente interrompida por erros obscuros.  Pelo que entendi, isso ocorre porque o depurador precisa criar algo como um despejo na se√ß√£o NVS padr√£o, mas neste momento o NVS j√° est√° sendo usado pelo controlador.  Obviamente, isso pode ser contornado com a cria√ß√£o de 2 parti√ß√µes NVS, uma com o nome padr√£o para depura√ß√£o e a outra para suas pr√≥prias necessidades.  Mas n√£o havia nada complicado l√°, no c√≥digo adicionado, funcionou pela primeira vez, ent√£o eu n√£o o verifiquei. </p><br><h3 id="glyuki-esp32">  Falhas ESP32 </h3><br><p>  Como qualquer dispositivo com o Aliexpress, minha placa ESP32 tinha a sua, mas n√£o foi descrita em nenhum lugar.  Quando ela chegou, alimentei alguns perif√©ricos que trabalhavam no I2C a partir da placa, mas depois de algum tempo, a placa come√ßou a reiniciar se algum equipamento em uso ou mesmo um capacitor estivesse conectado √† perna de + 5V.  Por que isso √© completamente incompreens√≠vel. </p><br><p>  Agora, alimento a placa da carga chinesa 0.7A, os sensores ds18b20 do p√© da placa 3.3V e o rel√© e o sensor de movimento de outra carga de 2A.  Obviamente, o p√© GND da placa est√° conectado aos pinos GND do restante do ferro.  Barato e alegre √© a nossa op√ß√£o. </p><br><h3 id="o-rezultatah-proekta">  Sobre os resultados do projeto </h3><br><p>  Tive a oportunidade de controlar com flexibilidade o aquecimento da casa, economizando dinheiro e suor ganhos.  No momento, se o aquecimento mantiver 23 graus o dia todo a -5 - -7 fora, ser√° algo em torno de 11 horas de opera√ß√£o da caldeira.  Se durante o dia para manter 20 graus e quente para 23 apenas √† noite, ent√£o j√° s√£o 9 horas de opera√ß√£o da caldeira.  A capacidade da caldeira √© de 6 kW, com um pre√ßo atual de quilowatts de 2,2 rublos, ou seja, cerca de 26,4 rublos por dia.  A dura√ß√£o da esta√ß√£o de aquecimento em nossa √°rea √© de 200 dias, a temperatura m√©dia na esta√ß√£o de aquecimento √© de apenas cerca de -5 graus.  Assim, obtemos cerca de 5000r de economia para a esta√ß√£o de aquecimento. </p><br><p>  O custo do equipamento n√£o excede 2000r, ou seja, os custos ser√£o repelidos em alguns meses, sem mencionar o fato de que um sistema pronto dessa automa√ß√£o custaria pelo menos 20.000r.  Outra coisa √© que passei cerca de uma semana de puro tempo de trabalho escrevendo firmware e depura√ß√£o, mas, no decorrer do trabalho, por exemplo, finalmente percebi o que os ponteiros est√£o em C ++ e tive muitas outras experi√™ncias (por exemplo, a experi√™ncia de muitas horas de depura√ß√£o de falhas incompreens√≠veis).  E √© dif√≠cil superestimar a experi√™ncia, como voc√™ sabe. </p><br><p>  Capturas de tela do aplicativo m√≥vel Blynk: </p><br><p><img src="https://habrastorage.org/webt/f8/a-/57/f8a-57tioype-tcgmjmodpagpwa.jpeg"></p><br><p><img src="https://habrastorage.org/webt/ez/3a/o3/ez3ao3_ht2lgjsbf9jvv_xcoksc.jpeg"></p><br><p><img src="https://habrastorage.org/webt/xi/xv/f-/xixvf-6pvrnw-2trm_toszimwrm.jpeg"></p><br><p>  Obviamente, o c√≥digo no projeto n√£o √© uma obra-prima, mas eu o escrevi nas condi√ß√µes de falta de tempo e concentrei-me principalmente na legibilidade.  Simplesmente n√£o h√° tempo para refatorar.  Em geral, tenho muitas desculpas por que meu c√≥digo √© t√£o assustador, mas esse √© o meu favorito, por isso vou me debru√ßar sobre ele, n√£o vou aprofundar o assunto. </p><br><p>  Se meu rabisco ajudar algu√©m, ficarei sinceramente feliz.  Ficarei feliz em quaisquer coment√°rios e sugest√µes. </p><br><div class="spoiler">  <b class="spoiler_title">Lista de refer√™ncias</b> <div class="spoiler_text"><ol><li>  <a href="http://microsin.net/programming/ARM/freertos-part1.html">http://microsin.net/programming/ARM/freertos-part1.html</a> </li><li>  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html">https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html</a> </li><li>  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/partition-tables.html">https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/partition-tables.html</a> </li><li>  <a href="https://docs.blynk.cc/">https://docs.blynk.cc/</a> </li></ol><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt479156/">https://habr.com/ru/post/pt479156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt479144/index.html">Preciso registrar minha marca</a></li>
<li><a href="../pt479146/index.html">Compara√ß√£o de ferramentas de desvio \ VPN</a></li>
<li><a href="../pt479150/index.html">Rob√¥s agr√≠colas est√£o avan√ßando</a></li>
<li><a href="../pt479152/index.html">Reagir e Vue sem npm e cria</a></li>
<li><a href="../pt479154/index.html">Ainda uma luta ou o suficiente?</a></li>
<li><a href="../pt479158/index.html">7 princ√≠pios fundamentais da ITIL</a></li>
<li><a href="../pt479162/index.html">Auroras nos planetas do sistema solar</a></li>
<li><a href="../pt479164/index.html">O que √© EEG e por que √© necess√°rio</a></li>
<li><a href="../pt479166/index.html">Escrevendo seu m√≥dulo expirationd limitado para tarantool</a></li>
<li><a href="../pt479168/index.html">Como criar uma API RESTful na plataforma Symfony 5 + API para um projeto MODX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>