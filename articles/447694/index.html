<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçç ‚ôÄÔ∏è üêâ Configuraci√≥n del sistema distribuido compilado ü§∞üèæ ü¶Ö üß¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me gustar√≠a contarles un mecanismo interesante para trabajar con una configuraci√≥n de sistema distribuido. La configuraci√≥n se presenta directamente e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configuraci√≥n del sistema distribuido compilado</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/primetalk/blog/447694/"><p>  Me gustar√≠a contarles un mecanismo interesante para trabajar con una configuraci√≥n de sistema distribuido.  La configuraci√≥n se presenta directamente en un lenguaje compilado (Scala) utilizando tipos seguros.  En esta publicaci√≥n, se analiza un ejemplo de dicha configuraci√≥n y se consideran varios aspectos de la introducci√≥n de una configuraci√≥n compilada en el proceso de desarrollo general. </p><br><p><img src="https://habrastorage.org/webt/71/bl/ax/71blaxtldz-ia4yftyebaxbam7c.png" alt="Configuraci√≥n del ciclo de vida"></p><br><p>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ingles</a> ) </p><a name="habracut"></a><br><h3 id="vvedenie">  Introduccion </h3><br><p>  La construcci√≥n de un sistema distribuido confiable implica que todos los nodos usan la configuraci√≥n correcta, sincronizada con otros nodos.  Por lo general, las tecnolog√≠as DevOps (terraform, ansible o algo as√≠) se utilizan para generar autom√°ticamente archivos de configuraci√≥n (a menudo propios para cada nodo).  Tambi√©n nos gustar√≠a asegurarnos de que todos los nodos interactuantes usen protocolos id√©nticos (incluida la misma versi√≥n).  De lo contrario, la incompatibilidad se integrar√° en nuestro sistema distribuido.  En el mundo JVM, una consecuencia de este requisito es la necesidad de usar la misma versi√≥n de una biblioteca que contiene mensajes de protocolo en todas partes. </p><br><p>  ¬øQu√© pasa con las pruebas de sistema distribuido?  Por supuesto, suponemos que se proporcionan pruebas unitarias para todos los componentes antes de pasar a las pruebas de integraci√≥n.  (Para que podamos extrapolar los resultados de la prueba al tiempo de ejecuci√≥n, tambi√©n debemos proporcionar un conjunto id√©ntico de bibliotecas en la etapa de prueba y en tiempo de ejecuci√≥n). </p><br><p>  Cuando se trabaja con pruebas de integraci√≥n, a menudo es m√°s f√°cil en todas partes usar un √∫nico classpath en todos los nodos.  Solo tendremos que asegurarnos de que el mismo classpath est√© involucrado en el tiempo de ejecuci√≥n.  (A pesar de que es bastante posible ejecutar diferentes nodos con diferentes classpaths, esto lleva a la complicaci√≥n de toda la configuraci√≥n y a dificultades con las pruebas de implementaci√≥n e integraci√≥n). Como parte de esta publicaci√≥n, asumimos que se utilizar√° el mismo classpath en todos los nodos. </p><br><p>  La configuraci√≥n evoluciona con la aplicaci√≥n.  Para identificar las diversas etapas de la evoluci√≥n de los programas, utilizamos versiones.  Parece l√≥gico identificar tambi√©n diferentes versiones de las configuraciones.  Y la configuraci√≥n en s√≠ misma debe colocarse en el sistema de control de versiones.  Si solo hay una configuraci√≥n en producci√≥n, entonces podemos usar el n√∫mero de versi√≥n.  Si se utilizan muchas instancias de producci√≥n, entonces necesitamos varias <br>  ramas de configuraci√≥n y una etiqueta adicional adem√°s de la versi√≥n (por ejemplo, el nombre de la rama).  Por lo tanto, podemos identificar de forma √∫nica la configuraci√≥n exacta.  Cada identificador de configuraci√≥n corresponde √∫nicamente a una determinada combinaci√≥n de nodos distribuidos, puertos, recursos externos, versiones de biblioteca.  En el marco de esta publicaci√≥n, procederemos del hecho de que solo hay una rama, y ‚Äã‚Äãpodemos identificar la configuraci√≥n de la manera habitual usando tres n√∫meros separados por un punto (1.2.3). </p><br><p>  En entornos modernos, los archivos de configuraci√≥n se crean de forma manual muy raramente.  M√°s a menudo se generan durante la implementaci√≥n y ya no se tocan (para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no romper nada</a> ).  Surge una pregunta l√≥gica, ¬øpor qu√© seguimos usando un formato de texto para almacenar la configuraci√≥n?  Una alternativa completamente viable es la capacidad de usar c√≥digo regular para la configuraci√≥n y obtener beneficios de las comprobaciones en tiempo de compilaci√≥n. </p><br><p>  En esta publicaci√≥n, solo estamos explorando la idea de representar una configuraci√≥n dentro de un artefacto compilado. </p><br><h3 id="kompiliruemaya-konfiguraciya">  Configuraci√≥n compilada </h3><br><p>  Esta secci√≥n describe un ejemplo de una configuraci√≥n compilada est√°tica.  Se implementan dos servicios simples: el servicio de eco y el servicio de eco del cliente.  En base a estos dos servicios, se ensamblan dos versiones del sistema.  En una realizaci√≥n, ambos servicios est√°n ubicados en el mismo nodo, en otra realizaci√≥n, en nodos diferentes. </p><br><p> Por lo general, un sistema distribuido contiene varios nodos.  Los nodos se pueden identificar utilizando valores de alg√∫n tipo <code>NodeId</code> : </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Backend</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Frontend</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span></span></code> </pre> <br><p>  o </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">hostName: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  o incluso </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span></code> </pre> <br><p>  Los nodos juegan varios roles, los servicios se inician en ellos y las comunicaciones TCP / HTTP se pueden establecer entre ellos. </p><br><p>  Para describir las comunicaciones TCP, necesitamos al menos un n√∫mero de puerto.  Tambi√©n nos gustar√≠a reflejar el protocolo que es compatible con este puerto para garantizar que tanto el cliente como el servidor usen el mismo protocolo.  Describiremos la conexi√≥n usando esta clase: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TcpEndPoint</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Protocol</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">node: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">NodeId</span></span></span></span><span class="hljs-class"><span class="hljs-params">, port: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Port</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Protocol</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  donde <code>Port</code> es solo un entero <code>Int</code> con un rango de valores v√°lidos: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortNumber</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Refined</span></span>[<span class="hljs-type"><span class="hljs-type">Int</span></span>, <span class="hljs-type"><span class="hljs-type">Closed</span></span>[_0, <span class="hljs-type"><span class="hljs-type">W</span></span>.`<span class="hljs-number"><span class="hljs-number">65535</span></span>`.<span class="hljs-type"><span class="hljs-type">T</span></span>]]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Tipos refinados</b> <div class="spoiler_text"><p>  Ver biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">refinada</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mi</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe</a> .  En resumen, la biblioteca le permite agregar restricciones que se verifican en tiempo de compilaci√≥n a los tipos.  En este caso, los valores de n√∫mero de puerto v√°lidos son n√∫meros enteros de 16 bits.  Para una configuraci√≥n compilada, el uso de la biblioteca refinada es opcional, pero puede mejorar la capacidad del compilador para verificar la configuraci√≥n. </p></div></div><br><p>  Para los protocolos HTTP (REST), adem√°s del n√∫mero de puerto, tambi√©n podemos necesitar una ruta al servicio: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UrlPathPrefix</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Refined</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">MatchesRegex</span></span>[<span class="hljs-type"><span class="hljs-type">W</span></span>.`<span class="hljs-string"><span class="hljs-string">"[a-zA-Z_0-9/]*"</span></span>`.<span class="hljs-type"><span class="hljs-type">T</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortWithPrefix</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Protocol</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">portNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">PortNumber</span></span></span></span><span class="hljs-class"><span class="hljs-params">, pathPrefix: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">UrlPathPrefix</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Tipos fantasma</b> <div class="spoiler_text"><p>  Para identificar el protocolo en la etapa de compilaci√≥n, usamos un par√°metro de tipo que no se usa dentro de la clase.  Esta decisi√≥n se debe al hecho de que en tiempo de ejecuci√≥n no utilizamos una instancia de protocolo, pero nos gustar√≠a que el compilador verifique la compatibilidad del protocolo.  Gracias al protocolo, no podremos transferir el servicio inadecuado como una dependencia. </p></div></div><br><p>  Un protocolo com√∫n es la API REST con serializaci√≥n Json: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonHttpRestProtocol</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMessage</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResponseMessage</span></span></span><span class="hljs-class">]</span></span></code> </pre> <br><p>  donde <code>RequestMessage</code> es el tipo de solicitud, <code>ResponseMessage</code> es el tipo de respuesta. <br>  Por supuesto, puede usar otras descripciones de protocolos que brinden la precisi√≥n que requerimos. </p><br><p>  Para los fines de esta publicaci√≥n, utilizaremos una versi√≥n simplificada del protocolo: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleHttpGetRest</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMessage</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResponseMessage</span></span></span><span class="hljs-class">]</span></span></code> </pre> <br><p>  Aqu√≠, la solicitud es una cadena agregada a la url, y la respuesta es la cadena devuelta en el cuerpo de la respuesta HTTP. </p><br><p>  La configuraci√≥n del servicio se describe por el nombre del servicio, los puertos y las dependencias.  Estos elementos se pueden representar en Scala de varias maneras (por ejemplo, <code>HList</code> , tipos de datos algebraicos).  Para los fines de esta publicaci√≥n, utilizaremos el patr√≥n de pastel y representaremos los m√≥dulos usando los <code>trait</code> .  (Cake Pattern no es un elemento necesario del enfoque descrito. Es solo una de las posibles implementaciones). </p><br><p>  Las dependencias entre servicios se pueden representar como m√©todos que devuelven <code>EndPoint</code> puertos de <code>EndPoint</code> de otros nodos: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoProtocol</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>= <span class="hljs-type"><span class="hljs-type">SimpleHttpGetRest</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>, <span class="hljs-type"><span class="hljs-type">A</span></span>] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8081</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoPort</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortWithPrefix</span></span>[<span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] = <span class="hljs-type"><span class="hljs-type">PortWithPrefix</span></span>[<span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]](portNumber, <span class="hljs-string"><span class="hljs-string">"echo"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoService</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">HttpSimpleGetEndPoint</span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>, <span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] = providedSimpleService(echoPort) }</code> </pre> <br><p>  Para crear un servicio de eco, solo un n√∫mero de puerto y una indicaci√≥n de que este puerto admite el protocolo de eco son suficientes.  No pudimos indicar un puerto espec√≠fico, porque  los rasgos le permiten declarar m√©todos sin implementaci√≥n (m√©todos abstractos).  En este caso, al crear una configuraci√≥n espec√≠fica, el compilador requerir√° que proporcionemos una implementaci√≥n de m√©todo abstracto y proporcionemos un n√∫mero de puerto.  Como implementamos el m√©todo, al crear una configuraci√≥n espec√≠fica, no podemos especificar otro puerto.  Se usar√° el valor predeterminado. </p><br><p>  En la configuraci√≥n del cliente, declaramos una dependencia en el servicio echo: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMessage</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pollInterval</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">FiniteDuration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoServiceDependency</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">HttpSimpleGetEndPoint</span></span>[_, <span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] }</code> </pre> <br><p>  La dependencia es del mismo tipo que el servicio exportado <code>echoService</code> .  En particular, en el cliente echo necesitamos el mismo protocolo.  Por lo tanto, al conectar los dos servicios, podemos estar seguros de que todo funcionar√° correctamente. </p><br><div class="spoiler">  <b class="spoiler_title">Implementaci√≥n del servicio</b> <div class="spoiler_text"><p>  Para iniciar y detener el servicio, se requiere una funci√≥n.  (La capacidad de detener el servicio es cr√≠tica para las pruebas). Nuevamente, hay varias opciones para implementar esta funci√≥n (por ejemplo, podr√≠amos usar clases de tipo basadas en el tipo de configuraci√≥n).  Para los fines de esta publicaci√≥n, utilizaremos el patr√≥n de pastel.  Representaremos el servicio usando la clase <code>cats.Resource</code> , porque  En esta clase, ya se proporcionan los medios para la liberaci√≥n segura y segura de recursos en caso de problemas.  Para obtener el recurso, necesitamos proporcionar una configuraci√≥n y un contexto de tiempo de ejecuci√≥n listo.  La funci√≥n para iniciar el servicio puede tener la siguiente forma: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResourceReader</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">] </span></span>= <span class="hljs-type"><span class="hljs-type">Reader</span></span>[<span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Resource</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">A</span></span>]] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> implicit resolver: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">AddressResolver</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], timer: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Timer</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], contextShift: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ContextShift</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], ec: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ExecutionContext</span></span></span></span><span class="hljs-class"><span class="hljs-params">, applicative: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Applicative</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span>: <span class="hljs-type"><span class="hljs-type">ResourceReader</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>] }</code> </pre> <br><p>  donde </p><br><ul><li>  <code>Config</code> - tipo de configuraci√≥n para este servicio </li><li>  <code>AddressResolver</code> : un objeto de tiempo de ejecuci√≥n que le permite encontrar las direcciones de otros nodos (ver m√°s abajo) </li></ul><br><p>  y otros tipos de la biblioteca de <code>cats</code> : </p><br><ul><li>  <code>F[_]</code> - tipo de efecto (en el caso m√°s simple, <code>F[A]</code> puede ser simplemente una funci√≥n <code>() =&gt; A</code> En esta publicaci√≥n usaremos <code>cats.IO</code> ) </li><li>  <code>Reader[A,B]</code> : m√°s o menos sin√≥nimo de la funci√≥n <code>A =&gt; B</code> </li><li>  <code>cats.Resource</code> : un recurso que se puede obtener y liberar </li><li>  <code>Timer</code> : temporizador (le permite quedarse dormido por un tiempo y medir intervalos de tiempo) </li><li>  <code>ContextShift</code> - an√°logo de <code>ExecutionContext</code> </li><li>  <code>Applicative</code> : una clase de tipo de efecto que le permite combinar efectos individuales (casi una m√≥nada).  En aplicaciones m√°s complejas, parece mejor usar <code>Monad</code> / <code>ConcurrentEffect</code> . </li></ul><br><p>  Usando esta firma de funci√≥n, podemos implementar varios servicios.  Por ejemplo, un servicio que no hace nada: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">&lt;</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Any</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resource</span></span></span></span>(...): <span class="hljs-type"><span class="hljs-type">ResourceReader</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>] = <span class="hljs-type"><span class="hljs-type">Reader</span></span>(_ =&gt; <span class="hljs-type"><span class="hljs-type">Resource</span></span>.pure[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>](())) }</code> </pre> </div></div><br><p>  (Consulte el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≥digo fuente</a> para otros servicios: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servicio</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">echo</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cliente echo</a> <br>  y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">controladores de por vida</a> ). </p><br><p>  Un nodo es un objeto que puede iniciar varios servicios (el patr√≥n de pastel garantiza el inicio de la cadena de recursos): </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleNodeImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoServiceService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">EchoClientConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">FiniteDurationLifecycleConfig</span></span> }</code> </pre> <br><p>  Tenga en cuenta que indicamos el tipo exacto de configuraci√≥n que se requiere para este nodo.  Si olvidamos especificar uno de los tipos de configuraci√≥n requeridos por un servicio separado, habr√° un error de compilaci√≥n.  Adem√°s, no podremos iniciar el nodo si no proporcionamos alg√∫n objeto del tipo apropiado con todos los datos necesarios. </p><br><div class="spoiler">  <b class="spoiler_title">Resoluci√≥n de nombre de host</b> <div class="spoiler_text"><p>  Para conectarnos a un host remoto, necesitamos una direcci√≥n IP real.  Es posible que la direcci√≥n se conozca m√°s tarde que el resto de la configuraci√≥n.  Por lo tanto, necesitamos una funci√≥n que asigne el identificador de nodo a la direcci√≥n: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeAddress</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodeId</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">host: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Uri</span></span></span></span><span class="hljs-class"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Host</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddressResolver</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolve</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>](nodeId: <span class="hljs-type"><span class="hljs-type">NodeId</span></span>): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">NodeAddress</span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>]] }</code> </pre> <br><p>  Puede ofrecer varias formas de implementar dicha funci√≥n: </p><br><ol><li>  Si conocemos las direcciones antes de la implementaci√≥n, entonces podemos generar un c√≥digo Scala con <br>  direcciones y luego comenzar el montaje.  Esto compilar√° y ejecutar√° las pruebas. <br>  En este caso, la funci√≥n se conocer√° est√°ticamente y se puede representar en el c√≥digo como una visualizaci√≥n de mapa <code>Map[NodeId, NodeAddress]</code> . </li><li>  En algunos casos, una direcci√≥n v√°lida se conoce solo despu√©s de que se inicia el nodo. <br>  En este caso, podemos implementar un "servicio de descubrimiento" (descubrimiento), que se ejecuta antes que los otros nodos y todos los nodos se registrar√°n en este servicio y solicitar√°n las direcciones de otros nodos. </li><li>  Si podemos modificar <code>/etc/hosts</code> , entonces podemos usar nombres de host predefinidos (como <code>my-project-main-node</code> y <code>echo-backend</code> ) y solo vincular estos nombres <br>  con direcciones IP durante la implementaci√≥n. </li></ol><br><p>  En el marco de esta publicaci√≥n, no consideraremos estos casos con m√°s detalle.  Para nuestro <br>  En un ejemplo de juguete, todos los nodos tendr√°n una direcci√≥n IP: <code>127.0.0.1</code> . </p></div></div><br><p>  A continuaci√≥n, consideramos dos opciones para un sistema distribuido: </p><br><ol><li>  Colocaci√≥n de todos los servicios en un nodo. </li><li>  Y la ubicaci√≥n del servicio de eco y el cliente de eco en diferentes nodos. </li></ol><br><p>  Configuraci√≥n para un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">solo nodo</a> : </p><br><div class="spoiler">  <b class="spoiler_title">Configuraci√≥n de nodo √∫nico</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleNodeConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">single</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configuration</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nodeId</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span> <span class="hljs-comment"><span class="hljs-comment">/** Type safe service port specification. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8088</span></span> <span class="hljs-comment"><span class="hljs-comment">// configuration of client /** We'll use the service provided by the same host. */ def echoServiceDependency = echoService override def testMessage: UrlPathElement = "hello" def pollInterval: FiniteDuration = 1.second // lifecycle controller configuration def lifetime: FiniteDuration = 10500.milliseconds // additional 0.5 seconds so that there are 10 requests, not 9. }</span></span></code> </pre> </div></div><br><p>  El objeto implementa la configuraci√≥n tanto del cliente como del servidor.  La configuraci√≥n de la vida √∫til tambi√©n se utiliza para finalizar el programa despu√©s de una <code>lifetime</code> .  (Ctrl-C tambi√©n funciona y libera todos los recursos correctamente). </p><br><p>  El mismo conjunto de rasgos de configuraci√≥n e implementaciones se puede utilizar para crear un sistema que consta de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dos nodos separados</a> : </p><br><div class="spoiler">  <b class="spoiler_title">Configuraci√≥n para dos nodos</b> <div class="spoiler_text"><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeServerConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SigTermLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">NodeIdImpl</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nodeId</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">NodeServer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8080</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeClientConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// NB! dependency specification def echoServiceDependency = NodeServerConfig.echoService def pollInterval: FiniteDuration = 1.second def lifetime: FiniteDuration = 10500.milliseconds // additional 0.5 seconds so that there are 10 request, not 9. def testMessage: String = "dolly" }</span></span></code> </pre> </div></div><br><p>  Importante!  Observe c√≥mo se realiza el enlace del servicio.  Indicamos el servicio implementado por un nodo como la implementaci√≥n del m√©todo de dependencia de otro nodo.  El compilador verifica el tipo de dependencia, porque  contiene el tipo de protocolo.  Cuando se inicia, la dependencia contendr√° el identificador correcto del nodo de destino.  Gracias a este esquema, indicamos el n√∫mero de puerto exactamente una vez y siempre garantizamos que se refieren al puerto correcto. </p><br><div class="spoiler">  <b class="spoiler_title">Implementaci√≥n de dos nodos del sistema.</b> <div class="spoiler_text"><p>  Para esta configuraci√≥n, utilizamos la misma implementaci√≥n de servicio sin cambios.  La √∫nica diferencia es que ahora tenemos dos objetos que implementan diferentes conjuntos de servicios: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwoJvmNodeServerImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoServiceService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SigIntLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">SigTermLifecycleConfig</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwoJvmNodeClientImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoClientConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">FiniteDurationLifecycleConfig</span></span> }</code> </pre> <br><p>  El primer nodo implementa el servidor y solo necesita la configuraci√≥n del servidor.  El segundo nodo lo implementa el cliente y utiliza otra parte de la configuraci√≥n.  Ambos nodos tambi√©n necesitan administrar el tiempo de vida.  El nodo del servidor se ejecuta indefinidamente hasta que <code>SIGTERM</code> lo detiene y el nodo del cliente termina despu√©s de un tiempo.  Ver la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aplicaci√≥n de lanzamiento</a> . </p></div></div><br><h4 id="obschiy-process-razrabotki">  Proceso de desarrollo general </h4><br><p>  Veamos c√≥mo este enfoque de configuraci√≥n afecta el proceso de desarrollo general. </p><br><p>  La configuraci√≥n se compilar√° junto con el resto del c√≥digo y se generar√° un artefacto (.jar).  Aparentemente, tiene sentido colocar la configuraci√≥n en un artefacto separado.  Esto se debe al hecho de que podemos tener muchas configuraciones basadas en el mismo c√≥digo.  Nuevamente, puede generar artefactos que corresponden a diferentes ramas de configuraci√≥n.  Junto con la configuraci√≥n, se preservan las dependencias de versiones espec√≠ficas de las bibliotecas y estas versiones se conservan para siempre, siempre que decidamos implementar esta versi√≥n de la configuraci√≥n. </p><br><p>  Cualquier cambio de configuraci√≥n se convierte en un cambio de c√≥digo.  Y por lo tanto, cada uno de estos <br>  El cambio estar√° cubierto por el proceso habitual de garant√≠a de calidad: </p><br><p>  Un ticket en el bugtracker -&gt; PR -&gt; review -&gt; fusionarse con las ramas correspondientes -&gt; <br>  integraci√≥n -&gt; despliegue </p><br><p>  Las principales consecuencias de implementar una configuraci√≥n compilada: </p><br><ol><li><p>  La configuraci√≥n se coordinar√° en todos los nodos del sistema distribuido.  Debido al hecho de que todos los nodos reciben la misma configuraci√≥n de una sola fuente. </p><br></li><li><p>  Es problem√°tico cambiar la configuraci√≥n en solo uno de los nodos.  Por lo tanto, la "deriva de configuraci√≥n" es poco probable. </p><br></li><li><p>  Se hace m√°s dif√≠cil hacer peque√±os cambios de configuraci√≥n. </p><br></li><li><p>  La mayor√≠a de los cambios de configuraci√≥n ocurrir√°n como parte del proceso de desarrollo general y ser√°n revisados. </p><br></li></ol><br><p>  ¬øNecesito un repositorio separado para almacenar la configuraci√≥n de producci√≥n?  Dicha configuraci√≥n puede contener contrase√±as y otra informaci√≥n secreta, cuyo acceso nos gustar√≠a restringir.  En base a esto, parece tener sentido almacenar la configuraci√≥n final en un repositorio separado.  Puede dividir la configuraci√≥n en dos partes: una que contiene la configuraci√≥n de configuraci√≥n p√∫blica y la otra que contiene la configuraci√≥n de acceso restringido.  Esto permitir√° que la mayor√≠a de los desarrolladores tengan acceso a par√°metros comunes.  Esta separaci√≥n es f√°cil de lograr utilizando rasgos intermedios que contienen valores predeterminados. </p><br><h3 id="vozmozhnye-variacii">  Posibles variaciones </h3><br><p>  Intentemos comparar la configuraci√≥n compilada con algunas alternativas comunes: </p><br><ol><li>  Un archivo de texto en la m√°quina de destino. </li><li>  Almacenamiento centralizado de valor clave ( <code>etcd</code> / <code>zookeeper</code> ). </li><li>  Componentes de proceso que se pueden reconfigurar / reiniciar sin reiniciar el proceso. </li><li>  Almacenamiento de la configuraci√≥n fuera del control de artefactos y versiones. </li></ol><br><p>  Los archivos de texto proporcionan una flexibilidad significativa en t√©rminos de peque√±os cambios.  El administrador del sistema puede ir al nodo remoto, realizar cambios en los archivos correspondientes y reiniciar el servicio.  Sin embargo, para sistemas grandes, tal flexibilidad puede ser indeseable.  De los cambios realizados no hay rastros en otros sistemas.  Nadie revisa los cambios.  Es dif√≠cil establecer qui√©n realiz√≥ los cambios y por qu√© motivo.  Los cambios no se prueban.  Si el sistema est√° distribuido, el administrador puede olvidarse de hacer el cambio correspondiente en otros nodos. </p><br><p>  (Tambi√©n se debe tener en cuenta que el uso de una configuraci√≥n compilada no bloquea la posibilidad de usar archivos de texto en el futuro. Ser√° suficiente agregar un analizador y validador que proporcione el mismo tipo de <code>Config</code> como salida, y puede usar archivos de texto. De inmediato se deduce que la complejidad del sistema con la configuraci√≥n compilada es algo menos que la complejidad de un sistema que usa archivos de texto, porque los archivos de texto requieren c√≥digo adicional). </p><br><p>  El almacenamiento centralizado de valores clave es un buen mecanismo para distribuir metapar√°metros de una aplicaci√≥n distribuida.  Deber√≠amos decidir qu√© par√°metros de configuraci√≥n son y cu√°les son solo datos.  Supongamos que tenemos una funci√≥n <code>C =&gt; A =&gt; B</code> , con los par√°metros <code>C</code> rara vez cambiando, y los datos <code>A</code> menudo.  En este caso, podemos decir que <code>C</code> son los par√°metros de configuraci√≥n y <code>A</code> son los datos.  Parece que los par√°metros de configuraci√≥n difieren de los datos en que generalmente cambian con menos frecuencia que los datos.  Adem√°s, los datos generalmente provienen de una fuente (del usuario) y los par√°metros de configuraci√≥n de otra (del administrador del sistema). </p><br><p>  Si los par√°metros que cambian raramente necesitan actualizarse sin reiniciar el programa, esto a menudo puede llevar a una complicaci√≥n del programa, porque tendremos que entregar de alguna manera los par√°metros, almacenar, analizar y verificar, procesar valores incorrectos.  Por lo tanto, desde el punto de vista de reducir la complejidad del programa, tiene sentido reducir la cantidad de par√°metros que pueden cambiar durante el programa (o no admitir dichos par√°metros). </p><br><p>  Desde el punto de vista de esta publicaci√≥n, distinguiremos entre par√°metros est√°ticos y din√°micos.  Si la l√≥gica del servicio requiere cambiar los par√°metros durante el programa, llamaremos din√°micos a dichos par√°metros.  De lo contrario, los par√°metros son est√°ticos y se pueden configurar mediante una configuraci√≥n compilada.  Para la reconfiguraci√≥n din√°mica, es posible que necesitemos un mecanismo para reiniciar partes del programa con nuevos par√°metros, similar a c√≥mo se reinician los procesos del sistema operativo.  (En nuestra opini√≥n, es recomendable evitar la reconfiguraci√≥n en tiempo real, ya que la complejidad del sistema aumenta. Si es posible, es mejor utilizar las capacidades est√°ndar del sistema operativo para reiniciar los procesos). </p><br><p>  Un aspecto importante del uso de una configuraci√≥n est√°tica que obliga a las personas a considerar la reconfiguraci√≥n din√°mica es el tiempo que tarda el sistema en reiniciarse despu√©s de una actualizaci√≥n de la configuraci√≥n (tiempo de inactividad).  De hecho, si necesitamos hacer cambios en la configuraci√≥n est√°tica, tendremos que reiniciar el sistema para que los nuevos valores surtan efecto.  El problema del tiempo de inactividad tiene una gravedad diferente para diferentes sistemas.  En algunos casos, puede programar un reinicio en un momento en que la carga sea m√≠nima.  Si desea proporcionar un servicio continuo, puede implementar las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"conexiones de drenaje" (drenaje de conexi√≥n de AWS ELB)</a> .  Al mismo tiempo, cuando necesitamos reiniciar el sistema, lanzamos una instancia paralela de este sistema, cambiamos el balanceador y esperamos hasta que se completen las conexiones anteriores.  Despu√©s de que se hayan completado todas las conexiones anteriores, apagamos la instancia del sistema anterior. </p><br><p>  Consideremos ahora el problema de almacenar la configuraci√≥n dentro o fuera del artefacto.  Si almacenamos la configuraci√≥n dentro del artefacto, al menos tuvimos la oportunidad durante el ensamblaje del artefacto para asegurarnos de que la configuraci√≥n fuera correcta.  Si la configuraci√≥n est√° fuera del artefacto controlado, es dif√≠cil rastrear qui√©n y por qu√© realiz√≥ cambios en este archivo.  ¬øQu√© tan importante es esto?  En nuestra opini√≥n, para muchos sistemas de producci√≥n es importante tener una configuraci√≥n estable y de alta calidad. </p><br><p>  La versi√≥n del artefacto le permite determinar cu√°ndo se cre√≥, qu√© valores contiene, qu√© funciones est√°n habilitadas / deshabilitadas, qui√©n es responsable de cualquier cambio en la configuraci√≥n.  Por supuesto, almacenar la configuraci√≥n dentro del artefacto requiere algo de esfuerzo, por lo que debe tomar una decisi√≥n informada. </p><br><h3 id="za-i-protiv">  Los pros y contras </h3><br><p>  Me gustar√≠a hacer hincapi√© en los pros y los contras de la tecnolog√≠a propuesta. </p><br><h4 id="preimuschestva">  Los beneficios </h4><br><p>  La siguiente es una lista de las caracter√≠sticas principales de una configuraci√≥n de sistema distribuido compilado: </p><br><ol><li>  Comprobaci√≥n de configuraci√≥n est√°tica.  Le permite estar seguro de que <br>  La configuraci√≥n es correcta. </li><li>   .         .   Scala      ,   . ,    <br> trait'    ,     ,    val',    (DRY)    .        ( <code>Seq</code> , <code>Map</code> ,  ). </li><li> DSL.  Scala    ,   DSL.        ,         , ,           .  , ,     . </li><li>     .    ,           ,       ,    ,   .        ,          .       ,       . </li><li>    .    ,    ,        . </li><li>   .          ,     . </li><li>  .     ,      .     . (  ,     ,     ,     ,     -.)       ‚Äî    .  , ,    ,       ,    . </li><li>  .          ,         .   , ,        .                .        .       ,       production'. </li><li> .    ,            .  ,           ,    ‚Äî   .      production- . </li><li>  Pruebas     mock-,     ,   . </li><li>  .                  .  , , ,     . </li></ol><br><h4 id="nedostatki-i-ogranicheniya">    </h4><br><p>               .    : </p><br><ol><li>  .       production',    .        .          .           . </li><li>  .  ,      ,        . </li><li> .      ,     ,    .    /      . </li><li>   .   DevOps    .             . </li><li>    .               (CI/CD).      . </li></ol><br><p>       ,      : </p><br><ol><li>      ,    ,        .    ,    Cake Pattern'     , , <code>HList</code>     (case class')   . </li><li>     ,     : ( <code>package</code> , <code>import</code> ,  ; <code>override def</code> '  ,    ).    ,    DSL.  ,    (, XML),       . </li><li>            . </li></ol><br><h3 id="zaklyuchenie">  Conclusi√≥n </h3><br><p>                  Scala.                 xml-   .   ,      Scala,          (  Kotlin, C#, Swift, ...).         , ,  ,    ,    ,   . </p><br><p> ,      .       . </p><br><p>     : </p><br><ol><li>         . </li><li>   DSL        . </li><li>         . ,       ,  (1)      ; (2)       . </li></ol><br><h3 id="blagodarnosti">  </h3><br><p>     ,          . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447694/">https://habr.com/ru/post/447694/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447682/index.html">Centro de datos espaciales: 24 horas antes del lanzamiento</a></li>
<li><a href="../447684/index.html">C√≥mo mostrar los valores de la empresa en una oficina (sin carteles ni lemas)</a></li>
<li><a href="../447686/index.html">Un par√°metro muy importante de las l√°mparas LED, que pocas personas conocen</a></li>
<li><a href="../447688/index.html">A la pregunta sobre bitset</a></li>
<li><a href="../447690/index.html">Configuraci√≥n compilable de un sistema distribuido</a></li>
<li><a href="../447696/index.html">¬øPor qu√© las ciudades se oponen a Amazon Go, las primeras tiendas sin efectivo?</a></li>
<li><a href="../447698/index.html">Red Hogwarts: acad√©mico sin diploma</a></li>
<li><a href="../447700/index.html">La flexibilidad emocional es la clave del crecimiento personal.</a></li>
<li><a href="../447702/index.html">El c√≠rculo matem√°tico ideal no existe.</a></li>
<li><a href="../447704/index.html">Climbing Elbrus - Reconocimiento en batalla. Parte t√©cnica 1. Registros, pilas y otros detalles t√©cnicos.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>