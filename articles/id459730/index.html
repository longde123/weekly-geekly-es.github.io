<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôÇÔ∏è üë©üèº‚Äç‚öñÔ∏è ‚úâÔ∏è Porting Qt ke STM32 üéÆ üë©üèº‚Äçüè≠ üòë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang Kami dalam proyek Embox meluncurkan Qt pada STM32F7-Discovery dan ingin mengetahuinya. Sebelumnya, kami sudah memberi tahu bagaimana kam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Porting Qt ke STM32</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/459730/"><img src="https://habrastorage.org/webt/qt/lf/ek/qtlfekuzcrawgi0xxsc93ct4p60.png" align="right" width="320">  Selamat siang  Kami dalam proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Embox</a> meluncurkan Qt pada STM32F7-Discovery dan ingin mengetahuinya.  Sebelumnya, kami sudah memberi tahu bagaimana kami berhasil meluncurkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">OpenCV</a> . <br><br>  Qt adalah kerangka kerja lintas-platform yang tidak hanya mencakup komponen grafis, tetapi juga hal-hal seperti QtNetwork, sekumpulan kelas untuk bekerja dengan database, Qt untuk Otomasi (termasuk penerapan IoT), dan banyak lagi.  Pengembang tim Qt telah meramalkan penggunaan Qt dalam embedded system, sehingga pustaka-pustaka tersebut terkonfigurasi dengan cukup baik.  Namun, hingga saat ini, beberapa orang berpikir untuk mengirim Qt ke mikrokontroler, mungkin karena tugas ini terlihat rumit - Qt besar, MCU kecil. <br><a name="habracut"></a><br>  Di sisi lain, saat ini ada mikrokontroler yang dirancang untuk bekerja dengan multimedia dan lebih unggul dari Pentium pertama.  Sekitar setahun yang lalu, sebuah posting muncul di blog Qt.  Pengembang membuat port Qt di bawah RTEMS, dan meluncurkan contoh dengan widget di beberapa papan yang menjalankan stm32f7.  Itu membuat kami tertarik.  Itu terlihat, dan pengembang sendiri menulis tentang ini bahwa Qt memperlambat STM32F7-Discovery.  Kami bertanya-tanya apakah kami dapat menjalankan Qt di bawah Embox, dan tidak hanya menggambar widget, tetapi memulai animasinya. <br><br>  Embt telah porting Qt 4.8 untuk waktu yang lama, jadi kami memutuskan untuk mencobanya.  Kami memilih aplikasi moveblocks - contoh animasi kenyal. <br><br><div class="spoiler">  <b class="spoiler_title">Kunci gerak Qt pada QEMU</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ce/fk/c9/cefkc9i71yjrn8_c2lgggnnbvvo.gif"><br></div></div><br>  Untuk memulai, kami mengkonfigurasi Qt, jika mungkin, dengan set komponen minimum yang diperlukan untuk mendukung animasi.  Untuk ini ada opsi "-qconfig minimal, kecil, sedang ...".  Ini termasuk file konfigurasi dari Qt dengan banyak makro - apa yang harus diaktifkan / dinonaktifkan.  Setelah opsi ini, tambahkan flag lain ke konfigurasi jika kita ingin menonaktifkan yang lain.  Ini adalah contoh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">konfigurasi</a> kami. <br><br>  Agar Qt berfungsi, Anda perlu menambahkan lapisan kompatibilitas OS.  Salah satu caranya adalah dengan mengimplementasikan QPA (Qt Platform Abstraction).  Dasarnya adalah plugin fb_base siap pakai sebagai bagian dari Qt, atas dasar mana QPA untuk Linux bekerja.  Hasilnya adalah plugin emboxfb kecil yang menyediakan framebuffer Embox Qt, dan kemudian menggambar di sana tanpa bantuan. <br><br><div class="spoiler">  <b class="spoiler_title">Beginilah tampilan pembuatan plugin</b> <div class="spoiler_text"><pre><code class="cpp hljs">QEmboxFbIntegration::QEmboxFbIntegration() : fontDb(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QGenericUnixFontDatabase()) { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fb_var_screeninfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vinfo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fb_fix_screeninfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">finfo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *fbPath = <span class="hljs-string"><span class="hljs-string">"/dev/fb0"</span></span>; fbFd = open(fbPath, O_RDWR); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fbPath &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error open framebuffer %s"</span></span>, fbPath); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ioctl(fbFd, FBIOGET_FSCREENINFO, &amp;finfo) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error ioctl framebuffer %s"</span></span>, fbPath); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ioctl(fbFd, FBIOGET_VSCREENINFO, &amp;vinfo) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error ioctl framebuffer %s"</span></span>, fbPath); } fbWidth = vinfo.xres; fbHeight = vinfo.yres; fbBytesPerLine = finfo.line_length; fbSize = fbBytesPerLine * fbHeight; fbFormat = vinfo.fmt; fbData = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)mmap(<span class="hljs-number"><span class="hljs-number">0</span></span>, fbSize, PROT_READ | PROT_WRITE, MAP_SHARED, fbFd, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fbData == MAP_FAILED) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error mmap framebuffer %s"</span></span>, fbPath); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fbData || !fbSize) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Wrong framebuffer: base = %p,"</span></span> <span class="hljs-string"><span class="hljs-string">"size=%d"</span></span>, fbData, fbSize); } mPrimaryScreen = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QEmboxFbScreen(fbData, fbWidth, fbHeight, fbBytesPerLine, emboxFbFormatToQImageFormat(fbFormat)); mPrimaryScreen-&gt;setPhysicalSize(QSize(fbWidth, fbHeight)); mScreens.append(mPrimaryScreen); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;printFbInfo(); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Dan di sini gambarnya akan terlihat</b> <div class="spoiler_text"><pre> <code class="cpp hljs">QRegion QEmboxFbScreen::doRedraw() { QVector&lt;QRect&gt; rects; QRegion touched = QFbScreen::doRedraw(); DPRINTF(<span class="hljs-string"><span class="hljs-string">"QEmboxFbScreen::doRedraw\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!compositePainter) { compositePainter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QPainter(mFbScreenImage); } rects = touched.rects(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; rects.size(); i++) { compositePainter-&gt;drawImage(rects[i], *mScreenImage, rects[i]); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> touched; }</code> </pre><br></div></div><br>  Akibatnya, dengan optimasi yang disertakan dari kompiler untuk ukuran memori -Os, gambar perpustakaan ternyata menjadi 3,5 MB, yang tentu saja tidak cocok dengan memori utama STM32F746.  Seperti yang sudah kami tulis di artikel kami yang lain tentang OpenCV, forum ini memiliki: <br><br><ul><li>  ROM 1 MB </li><li>  RAM 320 Kb </li><li>  8 MB SDRAM </li><li>  QSPI 16 MB </li></ul><br>  Karena dukungan untuk mengeksekusi kode dari QSPI telah ditambahkan untuk OpenCV, kami memutuskan untuk memulai dengan memuat seluruh gambar Qtox c Embox ke dalam QSPI.  Dan hore, semuanya hampir segera dimulai dari QSPI!  Tetapi seperti halnya OpenCV, ternyata terlalu lambat. <br><br><img src="https://habrastorage.org/webt/oj/f-/y9/ojf-y9zfsv_h5nca9qm209f1hxi.gif"><br><br>  Oleh karena itu, kami memutuskan untuk melakukan ini - pertama-tama salin gambar ke QSPI, kemudian muat ke SDRAM dan jalankan dari sana.  Dari SDRAM sedikit lebih cepat, tetapi masih jauh dari QEMU. <br><br><img src="https://habrastorage.org/webt/nb/qx/0z/nbqx0z83ec4in7fdv0sdpauksbk.gif"><br><br>  Berikutnya adalah ide untuk memasukkan floating point - karena Qt melakukan beberapa perhitungan koordinat kotak dalam animasi.  Mereka mencobanya, tetapi mereka tidak mendapatkan akselerasi yang terlihat, meskipun pengembang Qt mengklaim dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> bahwa FPU memberikan peningkatan signifikan dalam kecepatan untuk "menyeret animasi" pada layar sentuh.  Mungkin kunci gerak memiliki perhitungan floating point yang jauh lebih sedikit, dan ini tergantung pada contoh spesifik. <br><br>  Ide yang paling efektif adalah mentransfer framebuffer dari SDRAM ke memori internal.  Untuk ini, kami tidak memiliki ukuran layar 480x272, tetapi 272x272.  Kami juga mengurangi kedalaman warna dari A8R8G8B8 ke R5G6B5, sehingga mengurangi ukuran satu piksel dari 4 menjadi 2 byte.  Kami mendapat ukuran framebuffer 272 * 272 * 2 = 147968 byte.  Ini memberi akselerasi yang signifikan, mungkin yang paling mencolok, animasinya menjadi hampir mulus. <br><br>  Optimasi terakhir adalah eksekusi kode Embox dari RAM, dan Qt dari SDRAM.  Untuk melakukan ini, kita pertama-tama, seperti biasa, menghubungkan Embox secara statis bersama dengan Qt, tetapi kami menempatkan segmen teks, rodata, data, dan pustaka bss di QSPI, sehingga nanti kami dapat menyalinnya ke SDRAM. <br><br><pre> <code class="cpp hljs">section (qt_text, SDRAM, QSPI) phdr (qt_text, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">5</span></span>)) section (qt_rodata, SDRAM, QSPI) phdr (qt_rodata, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">5</span></span>)) section (qt_data, SDRAM, QSPI) phdr (qt_data, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">6</span></span>)) section (qt_bss, SDRAM, QSPI) phdr (qt_bss, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">6</span></span>))</code> </pre><br>  Karena eksekusi kode, Embox dari ROM juga menerima akselerasi nyata.  Hasilnya, animasi ternyata cukup lancar: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/_BpWQCtW02M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Sudah di bagian paling akhir, saat menyiapkan artikel dan mencoba berbagai konfigurasi Embox, ternyata Qt moveblocks berfungsi dengan baik dari QSPI dengan framebuffer di SDRAM, dan ukuran framebuffer adalah hambatan!  Rupanya, untuk mengatasi "slideshow" awal, akselerasi 2 kali sudah cukup karena pengurangan dangkal ukuran framebuffer.  Tetapi itu tidak mungkin untuk mencapai hasil seperti itu dengan hanya mentransfer kode Embox ke berbagai memori cepat (akselerasi diperoleh bukan oleh 2, tetapi sekitar 1,5 kali). <br><br><h3>  Cara mencobanya sendiri </h3><br>  Jika Anda memiliki STM32F7-Discovery, Anda dapat menjalankan Qt di bawah Embox sendiri.  Anda dapat membaca bagaimana melakukan ini di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">wiki</a> kami. <br><br><h3>  Kesimpulan </h3><br>  Sebagai hasilnya, kami berhasil meluncurkan Qt!  Kompleksitas tugas, menurut pendapat kami, agak berlebihan.  Secara alami, Anda perlu mempertimbangkan secara spesifik mikrokontroler dan secara umum memahami arsitektur sistem komputasi.  Hasil optimasi menunjukkan fakta yang terkenal bahwa hambatan dalam sistem komputasi bukan prosesor, tetapi memori. <br><br>  Tahun ini kami akan berpartisipasi dalam festival <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">TechTrain</a> .  Di sana kami akan memberi tahu lebih detail dan menunjukkan Qt, OpenCV pada mikrokontroler dan pencapaian kami lainnya. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id459730/">https://habr.com/ru/post/id459730/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id459716/index.html">Beberapa aspek mengoptimalkan kueri LINQ di C # .NET untuk MS SQL Server</a></li>
<li><a href="../id459718/index.html">10 tips untuk merevisi kode yang tidak Anda sukai</a></li>
<li><a href="../id459722/index.html">Apa yang dimiliki oleh pengembangan tim dan pendakian gunung</a></li>
<li><a href="../id459726/index.html">7 buah yang pasti tidak perlu Anda lakukan saat membuka klub robotika. Di sini tidak perlu dilakukan</a></li>
<li><a href="../id459728/index.html">Smartphone dengan mudah: Ulasan ZTE Red Magic 3</a></li>
<li><a href="../id459732/index.html">Cara memilih lisensi Open Source untuk kerangka kerja RAD di GitHub</a></li>
<li><a href="../id459734/index.html">Asap menguji kandidat rilis dengan autotest dalam 15 menit</a></li>
<li><a href="../id459739/index.html">Mengapa Mozilla disebut "penjahat utama Internet"?</a></li>
<li><a href="../id459741/index.html">Menulis aplikasi multibahasa di React Native</a></li>
<li><a href="../id459743/index.html">Kelompok mastermind untuk pengusaha, bukan konferensi dan pelatihan: pengalaman saya</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>