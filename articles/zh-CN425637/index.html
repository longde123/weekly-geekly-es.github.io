<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾 🙇🏻 ◻️ SSH连接建立算法 ❗️ 🛕 🎟️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="（根据Vindicar ， Karroplan和其他habro社区成员的建议，更改了“ SSH协议操作算法”一词的标题） 

 在定期阅读有关SSH的文章时，我注意到他们的作者有时不知道该协议如何工作。 在大多数情况下，他们仅限于考虑密钥生成主题并描述主要命令的选项。 即使是经验丰富的系统管理员，在...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SSH连接建立算法</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425637/"> <i>（根据<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Vindicar</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Karroplan</a>和其他habro社区成员的建议，更改了“ SSH协议操作算法”一词的标题）</i> <br><br> 在定期阅读有关SSH的文章时，我注意到他们的作者有时不知道该协议如何工作。 在大多数情况下，他们仅限于考虑密钥生成主题并描述主要命令的选项。 即使是经验丰富的系统管理员，在讨论SSH问题时也会经常胡说八道，以各种方式发表意见：使用客户端的公共SSH密钥加密传输的数据并使用私钥解密，或者：在传输过程中使用RSA算法加密数据。 <br><br> 我将尝试使SSH协议的操作更为清晰，同时考虑RSA算法和用户授权密钥的作用... <br><br><img src="https://habrastorage.org/webt/nh/ea/cr/nheacr1id9mw1cn3-bqnkuibjom.png" alt="图片"><br><a name="habracut"></a><br>  SSH协议算法可分为三个级别，每个级别位于上一个级别之上：传输（打开安全通道），身份验证，连接。 为了图片的完整性，我还将添加一个网络连接设置级别，尽管该级别正式低于SSH。 <br><br><h4>  1.建立一个TCP连接 </h4><br> 我不会详细讨论TCP / IP堆栈的原理，因为该主题在Runet中有很好的记录。 如有必要，您可以轻松找到信息。 <br><br> 此时，客户端通过服务器配置文件/ etc / ssh / sshd_config中的Port选项（默认值：22）指定的TCP端口连接到服务器。 <br><br><h4>  2.打开安全通道 </h4><br>  <b>2.1身份交换</b> <br><br> 在建立TCP连接之后，客户端和服务器（以下称为当事方）交换SSH协议的版本以及确定协议兼容性和选择操作算法所需的其他支持数据。 <br><br>  <b>2.2算法选择：密钥交换，加密，压缩等</b> <br><br> 使用SSH时，使用了很多算法，其中一些算法用于加密，第二种算法用于密钥交换，第三种算法用于压缩传输的数据，等等。 在此步骤中，各方将彼此发送受支持算法的列表，每个列表顶部的算法具有最高优先级。 然后，将获得的列表中的算法与系统中可用的算法进行比较，并选择每个列表中匹配的第一个算法。 <br><br> 可以使用以下命令查看可用的客户端密钥交换算法（用于获取会话密钥）的列表： <br><br><pre><code class="bash hljs">ssh -Q kex</code> </pre> <br> 系统中可用的对称算法列表（用于通道加密）： <br><br><pre> <code class="bash hljs">ssh -Q cipher</code> </pre> <br> 客户端授权密钥类型的列表： <br><br><pre> <code class="bash hljs">ssh -Q key-cert</code> </pre> <br>  <i>通过备注<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">onix74</a>更新：</i> <br> 该出版物中使用的所有命令都与Ubuntu 18.04 LTS的OpenSSH版本7.6相关。 <br><br>  <b>2.3获取会话加密密钥</b> <br><br> 根据算法的版本，获取会话密钥的过程可能会有所不同，但总的来说，它可以归结为以下几点： <br><br><ul><li> 服务器根据第2.2条中双方之间的协议，将其密钥发送给客户端（DSA，RSA等）。 </li><li> 如果客户端第一次连接到该服务器（如客户端上的/home/username/.ssh/known_hosts文件中缺少条目所示），则将询问用户信任服务器密钥。 如果以前已经与该服务器建立了连接，则客户端会将发送的密钥与/home/username/.ssh/known_hosts中记录的密钥进行比较。 如果密钥不匹配，则用户将收到有关可能的黑客尝试的警告。 但是，如果使用StrictHostKeyChecking选项调用ssh，则可以跳过此检查： <br><pre> <code class="bash hljs">ssh -o StrictHostKeyChecking=no username@servername</code> </pre> 另外，如果用户需要删除旧服务器密钥（例如，当确定服务器上的密钥已更改时），则使用以下命令： <br><pre> <code class="bash hljs">ssh-keygen -R servername</code> </pre> <br></li><li> 一旦客户端使用Diffie-Hellman算法的一种实现方式（版本在2.2节中定义）确定了对服务器密钥的信任，客户端和服务器就会生成一个会话密钥，该会话密钥将用于对称通道加密。 <br></li></ul><br> 会话密钥是在通道的整个生命周期内专门创建的，并在关闭连接时被销毁。 <br><br><h4>  3.客户端身份验证 </h4><br> 直到现在，当客户端和服务器建立了用于加密数据传输的通道时，它们才可以使用密码或密钥进行身份验证。 <br><br> 一般而言，密钥身份验证按以下方式进行： <br><br><ul><li> 客户端向服务器发送用户名（用户名）及其公钥。 </li><li> 服务器检查文件/home/username/.ssh/authorized_keys中是否有客户端发送的公钥。 如果找到了公钥，则服务器会生成一个随机数，并使用客户端的公钥对其进行加密，然后将结果发送给客户端。 </li><li> 客户端使用其私钥解密消息，然后将结果发送到服务器。 </li><li> 服务器检查结果是否与最初使用客户端的公钥加密的数字匹配，如果匹配，则认为身份验证成功。 </li></ul><br><h4>  4.连接级别 </h4><br> 完成上述所有过程后，用户就有机会将命令发送到服务器或复制文件。 <br><br> 在此级别上，提供了：通道的乘法（通过将多个通道合并为一个通道来操作多个通道到一台服务器的能力），隧道化等。 <br><br><h2> 从理论到实践 </h2><br> 好吧，现在，我认为，读者有一个完全合乎逻辑的问题：为什么您需要了解SSH协议的所有这些细节，如果在日常工作中对密钥创建命令（ssh-keygen）有足够的了解，打开终端会话（ssh），文件传输（ SCP）？ <br><br> 作为答案，我们可以回想一下将标准SSH端口更改为其他端口的话题，这经常成为Habr上的holivar ... <br><br> 在我自己的实践中，我不会回想起一台服务器每天都不会在端口22上监听外部网络的情况。 在SSH在标准端口上为您工作的情况下（并且不受任何保护），即使仅通过密钥进行身份验证并且没有密码猜测令人恐惧，但由于来自不诚实客户端的不断说谎的请求，服务器仍然被迫做很多无用的工作：建立TCP连接，选择算法，生成会话密钥，发送身份验证请求，编写日志文件。 <br><br> 如果第22个端口上没有任何内容，或者该端口使用iptables（或诸如fail2ban之类的附件）进行了保护，则攻击者将在建立TCP连接的阶段放弃。 <br><br> 最有趣的描述看起来像一张桌子* <br><table><tbody><tr><th> 构型 </th><th> 骇客机会 </th><th> 洪水损失** </th></tr><tr><td>  22端口 <br> 密码授权， <br> 没有保护 </td><td> 高 </td><td> 高 </td></tr><tr><td>  22端口 <br> 关键授权， <br> 没有保护 </td><td> 平均*** </td><td> 高 </td></tr><tr><td>  22端口 <br> 关键授权， <br> 基于失败授权尝试的限制进行保护 </td><td> 低 </td><td> 中**** </td></tr><tr><td> 非标口 <br> 密码授权， <br> 没有保护 </td><td> 高 </td><td> 低 </td></tr><tr><td> 非标口 <br> 关键授权， <br> 没有保护 </td><td> 平均*** </td><td> 低 </td></tr><tr><td> 非标口 <br> 关键授权， <br> 基于失败授权尝试的限制进行保护 </td><td> 低 </td><td> 低 </td></tr></tbody></table><br>  *-参数值（高，中，低）本质上是相对的，仅用于比较指标。 <br>  **-这意味着服务器用于处理通常流向端口22的大量请求的资源消耗（处理器，磁盘，网络通道等）。 <br>  ***-如果使用RSA密钥进行授权是很困难的，但是无限次的授权尝试使这成为可能。 <br>  ****-授权尝试的次数是有限的，但是服务器仍然必须从大量入侵者那里进行处理。 <br><br><h2> 附加材料 </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SSH来源</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SSH协议规范</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Diffie-Hellman算法</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RSA算法</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SSH如何出现在端口22上</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">.ssh / known_hosts文件中写的内容</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">给SSH用户的备忘录</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN425637/">https://habr.com/ru/post/zh-CN425637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN425627/index.html">用于服务开发的IaaS：谁以及为什么切换到虚拟基础架构</a></li>
<li><a href="../zh-CN425629/index.html">我们如何通过遥控器制作棋盘游戏</a></li>
<li><a href="../zh-CN425631/index.html">社交网络“ Vkontakte”谈到了如何以及为何提供用户数据</a></li>
<li><a href="../zh-CN425633/index.html">大众+微软=舒适的互联网技术</a></li>
<li><a href="../zh-CN425635/index.html">上周第333期（2018年10月1日至7日）来自前端世界的新鲜材料摘要</a></li>
<li><a href="../zh-CN425641/index.html">加拿大城市居民已经开发了公交车而非汽车的“优步服务”</a></li>
<li><a href="../zh-CN425643/index.html">10月8日至14日在莫斯科举行的数字活动</a></li>
<li><a href="../zh-CN425645/index.html">SpaceX和SAOCOM-1A新任务。 完成</a></li>
<li><a href="../zh-CN425647/index.html">UI测试：以不同的分辨率检查系统</a></li>
<li><a href="../zh-CN425649/index.html">性虐待，戈尔和Drupal开发者的追求</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>