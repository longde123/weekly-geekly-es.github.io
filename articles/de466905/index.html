<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘´ğŸ» ğŸ• ğŸŒŠ Zur Frage des U-Boot ğŸŒ“ ğŸ‘©ğŸ¼â€ğŸ“ ğŸ¤›</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Finden Sie einen Grund fÃ¼r alles und Sie werden viel verstehen. 
 Als ich kÃ¼rzlich den U-Boot-Code im Teil der SPI-Implementierung betrachtete, stieÃŸ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Zur Frage des U-Boot</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466905/"><h3>  Finden Sie einen Grund fÃ¼r alles und Sie werden viel verstehen. </h3><br>  Als ich kÃ¼rzlich den U-Boot-Code im Teil der SPI-Implementierung betrachtete, stieÃŸ ich auf ein Makro, um die Liste der verfÃ¼gbaren GerÃ¤te zu umgehen, das mich nach mehreren ÃœbergÃ¤ngen auf das Makro container_of zurÃ¼cksetzte.  Der Makrotext selbst war vorhanden, und mit ein wenig Erstaunen sah ich, dass er sich etwas von der Version unterschied, die ich zuvor gesehen hatte.  Eine kleine Untersuchung wurde durchgefÃ¼hrt, die zu interessanten Ergebnissen fÃ¼hrte. <br><a name="habracut"></a><br>  Das Makro selbst ist seit langem bekannt und lÃ¶st ein etwas seltsames Problem: Wir haben einen Zeiger auf ein Feld einer Struktur (ptr), wir kennen den Typ der Struktur (Typ) und den Namen des Feldes (Mitglied) und wir mÃ¼ssen einen Zeiger auf die Struktur als Ganzes erhalten.  Ich verstehe nicht wirklich, wie eine solche Aufgabe aussehen kÃ¶nnte, vielleicht wollten die Autoren "etwas Seltsames", aber sobald die Aufgabe festgelegt ist, muss sie gelÃ¶st werden.  Die LÃ¶sung ist bekannt: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> container_of(ptr, type, member) \ ((type *)((char *)(ptr)-offsetof(type,member)))</span></span></code> </pre> <br>  Alles ist transparent und klar, aber die entdeckte Implementierung war etwas komplizierter: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> container_of(ptr, type, member) ({ \ const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \ (type *)( (char *)__mptr - offsetof(type,member) );})</span></span></code> </pre> <br>  Die zweite Zeile ist fast identisch mit der ersten LÃ¶sung, aber was macht die erste Zeile des Makros?  Nein, was es tut, ist nur verstÃ¤ndlich: Es erstellt einen konstanten lokalen Zeiger auf das Strukturfeld und weist ihm den Wert des Makroparameters zu - einen Zeiger auf das Feld.  Aber warum dies getan wird, ist unklar. <br><br>  Eine offensichtliche Ãœberlegung bezÃ¼glich des Zwecks der ersten Zeile besteht darin, den ersten Parameter des Makros zu Ã¼berprÃ¼fen, ob es sich tatsÃ¤chlich um einen Zeiger auf ein Strukturfeld im Stil handelt: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *x = (X)</code> </pre> <br>  was in diesem Fall eine etwas abstruse Form annimmt: <br><br><pre> <code class="cpp hljs">typeof( ((type *)<span class="hljs-number"><span class="hljs-number">0</span></span>)-&gt;member ) *__mptr = (ptr)</code> </pre> <br>  da der fÃ¼r die ÃœberprÃ¼fung erforderliche Typ im laufenden Betrieb erstellt werden muss. <br><br>  Okay, stimmen wir zu, die Sache ist nÃ¼tzlich, aber ich musste den resultierenden Zeiger in der zweiten Zeile verwenden, um Compiler-Warnungen zu vermeiden. <br><br>  Aber warum der Konstanzmodifikator - das Makro sollte auch ohne diesen Zusatz gut funktionieren (ich habe es sofort versucht und es hat funktioniert).  Die Autoren konnten es nicht versehentlich sagen. <br><br><div class="spoiler">  <b class="spoiler_title">Es ist nicht notwendig, dort nachzuschauen</b> <div class="spoiler_text">  Ich muss zugeben, dass sie mich zur Antwort aufgefordert haben, ich selbst habe es nicht erraten. </div></div><br>  Es stellt sich heraus, dass dieser Modifikator einfach notwendig ist, wenn wir versuchen, die Adresse der konstanten Struktur herauszufinden, da in diesem Fall der Compiler eine <code>invalid conversion from 'const xxx*' to `xxx*'</code> . <br><br>  Es ist interessant, dass die Konstanz des Feldes selbst innerhalb einer gewÃ¶hnlichen Struktur nicht nur keinen Zwang in einem Makro erfordert, sondern auch die Notwendigkeit einer konstanten Struktur beseitigt, dh eines Ausdrucks wie: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> next; }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ss1</span></span></span><span class="hljs-class"> = {</span></span><span class="hljs-number"><span class="hljs-number">314</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>}; container_of(&amp;(ss1.next),struct s1,next);</code> </pre> <br>  Kompiliert ohne Fehler und ohne Modifikator im Makrotext und den Ausdruck: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s1</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> next; }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ss1</span></span></span><span class="hljs-class"> = {</span></span><span class="hljs-number"><span class="hljs-number">314</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>}; container_of(&amp;(ss1.next),struct s1,next);</code> </pre> <br>  es ist erforderlich. <br><br>  FÃ¼r die Leser von Habr, die den Standard der Sprache gut kennen, werden meine Entdeckungen im Stil von â€Danke, KapitÃ¤nâ€œ lÃ¤cherlich erscheinen, aber fÃ¼r den Rest mÃ¶gen sie interessant sein. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de466905/">https://habr.com/ru/post/de466905/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de466881/index.html">Ivan Shamatov: wie man Geld schreibt</a></li>
<li><a href="../de466887/index.html">Nur Teilung oder wie man eine mathematische Theorie erstellt und 400.000 Dollar damit verdient</a></li>
<li><a href="../de466889/index.html">Status der baltischen Domainzone fÃ¼r August 2019</a></li>
<li><a href="../de466899/index.html">Warum alles fallen lassen und jetzt Swift und Kotlin lernen?</a></li>
<li><a href="../de466903/index.html">PrÃ¤sentieren Sie immer Ihre Arbeit</a></li>
<li><a href="../de466907/index.html">5G und WiFi 6: Wenn zwei Netzwerktechnologien besser sind als eine</a></li>
<li><a href="../de466911/index.html">Das US-Gericht hat das Scraping von Websites vollstÃ¤ndig legalisiert und die technische Behinderung verboten</a></li>
<li><a href="../de466915/index.html">So machen Sie SFINAE schlank und zuverlÃ¤ssig</a></li>
<li><a href="../de466917/index.html">Wenn der HTTP-Standard nicht ausreicht. Mikronaut begehen</a></li>
<li><a href="../de466921/index.html">5 Probleme eines Serviceunternehmens und deren LÃ¶sung mithilfe der Automatisierungsplattform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>