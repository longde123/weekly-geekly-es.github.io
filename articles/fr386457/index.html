<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïµüèæ üëÉüèº ü§≤ Impl√©mentation de mon syst√®me domotique üë©‚Äçüëß‚Äçüëß üôÜüèø üç¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendant longtemps j'ai lu des articles sur Habr√© sur les syst√®mes domotiques, je voulais d√©crire ce sur quoi je travaille depuis plus de 2 ans. Pour m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Impl√©mentation de mon syst√®me domotique</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/386457/"><img src="https://habrastorage.org/files/ea9/62e/a6d/ea962ea6d63c4af99f2a68e426d88fa5.jpg" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pendant longtemps j'ai lu des articles sur Habr√© sur les syst√®mes domotiques, je voulais d√©crire ce sur quoi je travaille depuis plus de 2 ans. Pour mieux comprendre ma situation, vous devez faire une petite introduction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a trois ans, ma famille et moi avons d√©m√©nag√© dans un nouvel appartement de trois pi√®ces (67,5 m2), bien que techniquement l'appartement soit bien s√ªr ancien - Staline, une maison construite en 1946. C√¢blage en aluminium √† deux fils avec des morceaux de c√¢ble toronn√© en cuivre de 1 mm¬≤ √† certains endroits. La r√©vision √©tait en avance, j'ai d√©cid√© de tout faire moi-m√™me et j'ai commenc√© par un remplacement complet du c√¢blage. Ils ont achet√© 700 m de c√¢ble d'alimentation pour l'√©clairage et des prises de 1,5 et 2,5 m¬≤, une baie √† paire torsad√©e, un peu de c√¢ble coaxial pour les antennes de t√©l√©vision (juste au cas o√π). Pourquoi tant et ce qui est arriv√© - je demande un chat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©cid√© de faire le c√¢blage tout de suite, √† savoir: sans bo√Ætiers de distribution, de chaque point le c√¢ble va au blindage (√† l'exception des prises, qui peuvent √™tre dans un groupe de 2-3 points, le c√¢ble va au blindage de l'extr√™me, les autres sont reli√©s par une boucle) - t. e. de chaque interrupteur son propre c√¢ble au blindage, de chaque point d'√©clairage son propre c√¢ble au blindage, pr√®s des prises le long d'une paire de points rj-45, juste au cas o√π. Bien s√ªr, il existe de nombreux c√¢bles. Quelque part, il est pos√© dans le sol conform√©ment √† toutes les r√®gles du PUE, comme, par exemple, dans la p√©pini√®re: </font></font><br>
<br>
<img src="https://habrastorage.org/files/09e/071/732/09e0717328cb46a0b0df95701ac88122.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque part - au plafond, par exemple, vue de la porte de la chambre:</font></font><br>
<br>
<img src="https://habrastorage.org/files/f0f/f50/510/f0ff505103224720825920b62b9da86c.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous mettons tous les c√¢bles dans le couloir en un seul endroit o√π le bouclier sera situ√©, et ils peuvent √™tre commut√©s entre eux comme vous le souhaitez. M√™me si vous devez changer le sch√©ma de connexion √† l'avenir, cela ne prendra pas beaucoup de temps et vous n'aurez pas √† g√¢cher la r√©paration. Et bien s√ªr, de nombreuses prises ont √©t√© faites pour toutes les occasions - au total environ 90 points pour tout l'appartement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemblait le ¬´bouclier¬ª temporaire pendant les exp√©riences: un </font></font><br>
<br>
<img src="https://habrastorage.org/files/1e4/0bd/131/1e40bd1311d2412686170c0ae8619274.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
spectacle terrible, mais tout fonctionnait et sous cette forme ce monstre a v√©cu plusieurs mois. Un beau jour, les √©toiles se sont form√©es avec succ√®s et le bouclier a √©t√© refait par d√©cision volontaire. Cela a pris 3 jours sur un escalier branlant sous le plafond (et les plafonds dans le stalin 3m), mais √ßa valait le coup. Voici √† quoi le tableau de bord a commenc√© √† ressembler apr√®s cela: </font></font><br>
<br>
<img src="https://habrastorage.org/files/34b/2e4/1e9/34b2e41e94a54217bad80ce53d2e0e45.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et la vue g√©n√©rale:</font></font><br>
<br>
<img src="https://habrastorage.org/files/054/e15/85e/054e1585eeb74b7ebe62e3fcd946e1a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est loin de la forme finale du blindage, il n'y a toujours pas assez de RCD, il y a 3 fois moins de disjoncteurs que n√©cessaire, il n'y a pas de relais d'impulsion - mais il y a des lignes non d√©connectables, tous les c√¢bles sont connect√©s aux bornes, il y a au moins une sorte de s√©lectivit√© du disjoncteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que vous avez une id√©e approximative de ce avec quoi je devais travailler, vous pouvez commencer √† d√©crire les ¬´cerveaux¬ª du syst√®me. Sans plus tarder, j'ai pris Arduino comme base, d'autant plus que j'avais d√©j√† 2 cartes Freeduino, 2 blindages Ethernet et un blindage moteur que j'avais achet√© bien avant. √âgalement command√© aupr√®s des Chinois plusieurs modules relais de 4 pi√®ces chacun. Et j'ai aussi trouv√©, sur les conseils d'un des articles sur Habr√© √† Ob, des interrupteurs dans lesquels des ressorts sp√©ciaux pouvaient √™tre ins√©r√©s et ils se transformaient en interrupteurs sans fixation. Il est temps d'√©crire du code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, je suis √©troitement li√© aux ordinateurs dans la vie. Il a termin√© le tapis de fourrure, sur lequel il n'a tout simplement pas √©crit - pascal, c #, c ++, 1c, php, javascript - vous pouvez toujours en √©num√©rer beaucoup. La derni√®re fois que je travaille dans le domaine du d√©veloppement web, je m'occupe √©galement de la t√©l√©phonie ip. Par cons√©quent, trouver un algorithme est simple, mais avec l'√©lectronique ¬´pour vous¬ª, je sais et je sais des choses simples, et quand il s'agit de quelque chose de plus compliqu√© - microcontr√¥leurs, fusibles, rebond de contact - c'est plus difficile. Mais ce ne sont pas les dieux qui br√ªlent les pots, les yeux ont peur, mais les mains le font. J'ai d√©cid√© de tout simplifier. J'alimente la terre de l'arduino √† l'entr√©e de l'interrupteur, je connecte les sorties de l'interrupteur aux broches analogiques de l'arduino (bien que cela soit possible en num√©rique, ce n'est pas important). Je connecte les broches de l'arduino avec les broches du module relais. Techniquement, tout est pr√™t, lorsque vous appuyez sur l'interrupteur, l'arduino voit la valeur LOW sur la broche souhait√©e et d√©finit la LOW sur la broche connect√©e au module de relais.√âtant donn√© que tous les c√¢bles des points de l'appartement arrivent aux bornes - la connexion n'a pas pris beaucoup de temps.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour lutter contre le rebond des contacts, apr√®s avoir √©tudi√© le sujet sur Internet, la biblioth√®que Bounce2 a √©t√© s√©lectionn√©e. En g√©n√©ral, j'ai d'abord voulu √©crire un code universel afin qu'il puisse √™tre utilis√© avec au moins 2 commutateurs, au moins 22. C'est cette t√¢che qui a constitu√© la base de tout l'algorithme. Eh bien, maintenant des mots au code. Je ne t√©l√©chargerai pas enti√®rement tout le code; les liens vers le github seront √† la fin de l'article. Je ne montrerai que des moments importants, de mon point de vue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, d√©clarer des biblioth√®ques et des variables:</font></font><br>
<br>
<pre><code class="hljs apache"><span class="hljs-comment">#include &lt;Bounce2.h&gt;</span>
<span class="hljs-comment">#include &lt;EEPROM.h&gt;</span><font></font>
<font></font>
<span class="hljs-attribute">const</span> byte cnt = <span class="hljs-number">8</span>;
<span class="hljs-attribute">const</span> byte pin_cnt = <span class="hljs-number">19</span>;<font></font>
<font></font>
<span class="hljs-attribute">int</span> pins[] = {<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>};
<span class="hljs-attribute">int</span> leds[] = {<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>};<font></font>
<font></font>
<span class="hljs-attribute">byte</span> init_leds[cnt] ;
<span class="hljs-attribute">byte</span> init_buttons[cnt];
<span class="hljs-attribute">int</span> button_states[cnt];
<span class="hljs-attribute">Bounce</span> debouncers[cnt];
<span class="hljs-attribute">unsigned</span> long buttonPressTimeStamps[cnt];
<span class="hljs-attribute">boolean</span> changed[cnt];
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le point est: il suffit d'augmenter la constante avec le nombre de lampes / interrupteurs et d'enregistrer de nouvelles associations dans les tableaux - et c'est tout, une nouvelle lampe ou interrupteur sera ajout√©. </font><font style="vertical-align: inherit;">En m√™me temps, la structure du code permet √† un commutateur de contr√¥ler plusieurs appareils √† la fois. </font><font style="vertical-align: inherit;">Ou plusieurs interrupteurs pour contr√¥ler imm√©diatement une lampe. </font><font style="vertical-align: inherit;">De plus, pour chaque commutateur, sa propre instance de l'objet Bounce est cr√©√©e pour l'anti-rebond. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fonction de configuration, tous les tableaux sont initialis√©s, tandis que l'√©tat des luminaires est stock√© dans une m√©moire non volatile, de sorte que lorsqu'une panne de courant ou un red√©marrage se produit, tout s'allume de la m√™me mani√®re qu'avant la panne.</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    <font></font>
    byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = LOW ;<font></font>
    }<span class="hljs-keyword">else</span>{<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = HIGH ;<font></font>
    }<font></font>
    init_buttons[<span class="hljs-built_in">i</span>] = HIGH;<font></font>
    buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    changed[<span class="hljs-built_in">i</span>] = <span class="hljs-built_in">false</span>;<font></font>
<font></font>
    debouncers[<span class="hljs-built_in">i</span>] = Bounce();<font></font>
<font></font>
    pinMode(pins[<span class="hljs-built_in">i</span>], INPUT);<font></font>
    pinMode(leds[<span class="hljs-built_in">i</span>], OUTPUT);<font></font>
    <font></font>
    digitalWrite(pins[<span class="hljs-built_in">i</span>], init_buttons[<span class="hljs-built_in">i</span>]);<font></font>
    digitalWrite(leds[<span class="hljs-built_in">i</span>], init_leds[<span class="hljs-built_in">i</span>]);<font></font>
    <font></font>
    debouncers[<span class="hljs-built_in">i</span>].attach( pins[<span class="hljs-built_in">i</span>] );<font></font>
    debouncers[<span class="hljs-built_in">i</span>].interval(<span class="hljs-number">5</span>);<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne dirai rien du premier cycle, nous y reviendrons un peu plus tard. </font><font style="vertical-align: inherit;">Et le plus int√©ressant commence dans le corps du cycle principal.</font></font><br>
<br>
<pre><code class="hljs matlab">void loop(){
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>){<font></font>
    byte dvalue = EEPROM.read(pins[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(dvalue!=<span class="hljs-number">11</span>) {<font></font>
      changed[<span class="hljs-built_in">i</span>] = debouncers[<span class="hljs-built_in">i</span>].update();<font></font>
      <font></font>
      <span class="hljs-keyword">if</span> ( changed[<span class="hljs-built_in">i</span>] ) {<font></font>
        int value = debouncers[<span class="hljs-built_in">i</span>].read();
        <span class="hljs-keyword">if</span> ( value == HIGH) {<font></font>
         button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;   <font></font>
        } <span class="hljs-keyword">else</span> {
           <span class="hljs-keyword">if</span> (<span class="hljs-built_in">i</span> &gt; <span class="hljs-number">0</span> and pins[<span class="hljs-built_in">i</span>] == pins[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]) {<font></font>
             byte prev_value = EEPROM.read(leds[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]);<font></font>
                            <font></font>
             <span class="hljs-keyword">if</span>(prev_value == <span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<font></font>
           } <span class="hljs-keyword">else</span> {               <font></font>
             byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
             <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<font></font>
           }<font></font>
                 <font></font>
           button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">1</span>;<font></font>
           buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = millis();     <font></font>
        }<font></font>
      }<font></font>
   <font></font>
      <span class="hljs-keyword">if</span> ( button_states[<span class="hljs-built_in">i</span>] == <span class="hljs-number">1</span> ) {
        <span class="hljs-keyword">if</span> ( millis() - buttonPressTimeStamps[<span class="hljs-built_in">i</span>] &gt;= <span class="hljs-number">200</span> ) {<font></font>
            button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">2</span>;<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  delay( <span class="hljs-number">10</span> );<font></font>
} <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors des tests des premi√®res versions de l'algorithme, il a √©t√© constat√© que les enfants (et j'en ai trois, les gar√ßons) aimaient vraiment cliquer sur les interrupteurs. </font><font style="vertical-align: inherit;">Par cons√©quent, il √©tait n√©cessaire de pouvoir d√©sactiver certains commutateurs afin que le contr√¥leur ne leur r√©ponde pas. </font><font style="vertical-align: inherit;">L'option la plus √©vidente est de simplement retirer les broches n√©cessaires de la carte, mais c'est faux et sans int√©r√™t. </font><font style="vertical-align: inherit;">Par cons√©quent, les drapeaux sont √©galement √©crits dans la m√©moire non volatile indiquant si le commutateur est ouvert ou non. </font><font style="vertical-align: inherit;">Ceci est initialis√© avec cette boucle:</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et v√©rifi√© ici:</font></font><br>
<br>
<pre><code class="hljs lisp">  for(<span class="hljs-name">byte</span> i=0<span class="hljs-comment">; i&lt;cnt; i=i+1){</span>
    byte dvalue = EEPROM.read(<span class="hljs-name">pins</span>[i])<span class="hljs-comment">;</span>
    if(<span class="hljs-name">dvalue!=11</span>) {<font></font>
    ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©j√† √† ce stade, des interrupteurs locaux sur les murs ont commenc√© √† fonctionner. Mais une maison intelligente ne serait pas intelligente sans interface. Comme je m'occupe du d√©veloppement web, il a √©t√© d√©cid√© de faire une interface web. C'est l√† que les blindages Ethernet sont utiles. Malheureusement, je n'ai pas pu trouver les sources des premi√®res versions de programmes qui utilisent des blindages Ethernet pour le contr√¥le √† distance. J'essaierai de chercher dans les sauvegardes, peut-√™tre qu'elles sont l√†. Mais le sens √©tait primitif √† la honte. Chaque contr√¥leur a sa propre adresse IP. Un serveur Web montait sur l'arduino, qui analysait les demandes GET et allumait ou √©teignait la lampe correspondante en fonction du num√©ro de port. Il existe de nombreux exemples de ce type sur Internet. Pour l'interface Web, un serveur a √©t√© construit sur la carte m√®re avec Intel Atom int√©gr√©, Ubuntu Server 14.02 a √©t√© install√©, l'ensemble LAMP standard a √©t√© install√©,une interface simple y est √©crite. Toutes les sources seront √©galement √† la fin de l'article. Pour le moment, cela ressemble √† ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/files/7ba/5b2/d4c/7ba5b2d4c95c48f0ac3873cef3c76b23.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, une lampe dans la cuisine est allum√©e et l'interrupteur responsable est verrouill√©. La gestion est m√©ga-simple - cliquez simplement sur l'√©l√©ment souhait√© et son √©tat change.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et tout serait super, sinon pour un ¬´mais¬ª. Les blindages Ethernet √©taient constamment suspendus. Non, le contr√¥le local des commutateurs fonctionnait toujours comme une horloge. Mais le contr√¥le √† distance de l'interface Web est tomb√© en permanence. Si la direction a travaill√© pendant une journ√©e, c'√©tait excellent. Mais le plus souvent, le bouclier s'est accroch√© quelques heures seulement apr√®s le red√©marrage. Ce que je n‚Äôai pas fait, c‚Äô√©tait d‚Äôessayer de g√©rer les chiens de garde, mais mes planches ne l‚Äôont pas soutenu. J'ai command√© en Chine et remplac√© les boucliers par d'autres - sur en28j60 - √ßa s'est am√©lior√©, mais ils ont toujours raccroch√© p√©riodiquement. J'ai ajout√© un module de relais au contr√¥leur, j'ai aliment√© les cartes Arduino par des contacts normalement ferm√©s, et l'une des cartes Arduino a tir√© le relais avec une certaine fr√©quence et l'alimentation a √©t√© coup√©e, puis il a √©t√© r√©tabli - cependant, cela n'a pas toujours fonctionn√© et il a clignot√© au moment du red√©marrage. lumi√®re allum√©e,m√™me pendant quelques secondes, mais n√©anmoins. Voici √† quoi ressemblait le contr√¥leur √† ce stade:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ab0/71d/eb3/ab071deb30a94677a261c5378a809124.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis il a √©t√© d√©cid√© d'abandonner compl√®tement les boucliers Ethernet. J'ai commenc√© √† chercher d'autres fonctionnalit√©s de gestion √† distance. J'ai essay√© de connecter des arduins directement au serveur et d'envoyer des commandes via Serial.read () / Serial.print () - cela a fonctionn√© une fois sur deux, la stabilit√© n'a pas √©t√© atteinte car la carte a red√©marr√© √† chaque fois qu'elle √©tait accessible √† partir d'un script sur le serveur. J'ai beaucoup lu sur ces erreurs, je viens de r√©aliser qu'il √©tait connect√© au DTR, quelque part ils ont √©crit que vous pouvez initialiser le port avec d'autres drapeaux, ont donn√© des exemples qui ne fonctionnaient pas pour moi. Apr√®s un certain temps, je suis tomb√© sur un article sur la fabrication d'un adaptateur USB-I2C √† partir d'un programmeur USBAsp. J'ai d√©cid√© - pourquoi pas? J'ai command√© deux de ces programmeurs aux Chinois - et j'ai attendu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y a une semaine, mon colis est arriv√©. </font><font style="vertical-align: inherit;">Un programmeur a √©t√© flash√© avec le micrologiciel USB minuscule i2c et je me suis de nouveau assis pour r√©√©crire le code. </font><font style="vertical-align: inherit;">Ici, les fonctionnalit√©s du protocole ont commenc√© √† appara√Ætre. </font><font style="vertical-align: inherit;">Bien s√ªr, le serveur √©tait le ma√Ætre et toutes les cartes Arduino √©taient des esclaves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code doit r√©soudre les t√¢ches suivantes: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - signaler l'√©tat du port demand√©; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - changer l'√©tat du port demand√©; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - √©teignez ou allumez toutes les lumi√®res. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et j'ai rencontr√© un probl√®me. </font><font style="vertical-align: inherit;">Je peux utiliser les commandes standard de la suite i2c-tools pour communiquer avec les cartes Arduino. </font><font style="vertical-align: inherit;">C'est une √©quipe</font></font><br>
<br>
<pre><code class="bash hljs">i2cget -y &lt; &gt; &lt;&gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et</font></font><br>
<br>
<pre><code class="bash hljs">i2cset -y &lt; &gt; &lt;&gt; 0x00 &lt;byte &gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble que, √† en juger par l'homme, vous pourriez passer le mot valeur, mais cela n'a pas fonctionn√© pour moi, ou je me suis tromp√© quelque part. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me est que, tout d'abord, si je dois changer l'√©tat d'un certain port, je dois d'abord transmettre le num√©ro de la commande responsable de cette op√©ration, puis le num√©ro de port. </font><font style="vertical-align: inherit;">J'ai m√™me essay√© de le faire, d'envoyer 2 commandes et, dans le code, de les collecter √† leur tour - mais c'√©tait moche et irrationnel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probl√®me num√©ro deux - Arduino ne peut pas r√©pondre √† quelque chose au moment o√π elle re√ßoit les donn√©es. </font><font style="vertical-align: inherit;">Il existe deux m√©thodes de la biblioth√®que Wire: onReceive () lorsque les donn√©es sont re√ßues du ma√Ætre et onRequest () lorsque les donn√©es sont demand√©es par le ma√Ætre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai donc fait ceci: le serveur web a 6 commandes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "1" - obtenir l'√©tat de toutes les lumi√®res</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "2" - obtenir l'√©tat de blocage de tous les commutateurs</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "5" - allumer le monde entier</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "6" - √©teindre le monde entier</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
une commande form√©e comme suit: un nombre d√©cimal de la forme suivante &lt;centaines (1 ou 2) - allumer la lampe ou verrouiller l'interrupteur&gt; &lt;num√©ro de port (de 0 √† 99)&gt;; </font><font style="vertical-align: inherit;">par exemple, 105 - port du commutateur 5, 213 - verrouillage du port du commutateur 13. </font><font style="vertical-align: inherit;">Cette commande est traduite en hexad√©cimal et transmise √† l'arduino, qui effectue les transformations inverses et comprend ce qui doit √™tre fait. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi cela ressemble du c√¥t√© serveur:</font></font><br>
<br>
<pre><code class="php hljs">  ...
  <span class="hljs-keyword">if</span> ($action == <span class="hljs-number">3</span>)<font></font>
     $val_hex = dechex(intval($port) + <span class="hljs-number">100</span>);
  <span class="hljs-keyword">else</span>
     $val_hex = dechex(intval($port) + <span class="hljs-number">200</span>);<font></font>
  <font></font>
  exec(<span class="hljs-string">"sudo i2cset -y 7 $addr 0x00 0x$val_hex"</span>, $output);<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et du c√¥t√© de l'arduino:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">receiveEvent</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> howMany</span>)</span> {
  <span class="hljs-keyword">byte</span> bytes = Wire.available();
  <span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">1</span>; i &lt;= bytes; i=i+<span class="hljs-number">1</span>) {<font></font>
    x = Wire.read();<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (x == <span class="hljs-number">1</span> or x == <span class="hljs-number">2</span> or x == <span class="hljs-number">5</span> or x == <span class="hljs-number">6</span>) {<font></font>
    do_action(x, <span class="hljs-number">0</span>);<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> ( x &gt; <span class="hljs-number">200</span>) {<font></font>
      do_action (<span class="hljs-number">4</span>, x - <span class="hljs-number">200</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      do_action (<span class="hljs-number">3</span>, x - <span class="hljs-number">100</span>);<font></font>
    }<font></font>
  }  <font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble assez primitif, mais cela fonctionne. </font><font style="vertical-align: inherit;">Le deuxi√®me probl√®me est r√©solu comme suit. </font><font style="vertical-align: inherit;">Voici la fonction do_action:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">do_action</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span> command, <span class="hljs-keyword">byte</span> port</span>)</span> {
  <span class="hljs-keyword">byte</span> <span class="hljs-keyword">value</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">byte</span> dvalue = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">switch</span> (command) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">1</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">2</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
      <span class="hljs-keyword">value</span> = EEPROM.read(port);
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
        digitalWrite(port, HIGH);<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        digitalWrite(port, LOW);<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<font></font>
      dvalue = EEPROM.read(port);<font></font>
      <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], LOW);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], HIGH);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">10</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:<font></font>
      <font></font>
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec les √©quipes 3-6, tout est clair, mais les √©quipes 1 ou 2 peuvent √™tre d√©crites plus en d√©tail. </font><font style="vertical-align: inherit;">Le serveur envoie d'abord la commande souhait√©e, et lorsque l'arduino re√ßoit la commande 1 ou 2, les drapeaux sont initialis√©s:</font></font><br>
<br>
<pre><code class="hljs nginx">  <span class="hljs-attribute">start_request</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attribute">request_type</span> = <span class="hljs-number">1</span>;
  <span class="hljs-attribute">current_port</span> = <span class="hljs-number">0</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis le serveur commence √† envoyer des requ√™tes √† l'arduino autant de fois que les ports qu'il souhaite interroger. </font><font style="vertical-align: inherit;">C√¥t√© serveur:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">$address, $action, $cnt</span>) </span>{<font></font>
	exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
	$tmp = @$output[<span class="hljs-number">0</span>];
	<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
		exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
	}<font></font>
	$str = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">1</span>; $i &lt;= $cnt; $i++) {<font></font>
		exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];
		<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
			exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
			$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($tmp) {
			<span class="hljs-keyword">if</span> (strpos($tmp,<span class="hljs-string">"1"</span>)!==<span class="hljs-literal">false</span>)<font></font>
				$str .= <span class="hljs-string">"1"</span>;
			<span class="hljs-keyword">else</span>
				$str .= <span class="hljs-string">"0"</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">unset</span>($output);
		<span class="hljs-keyword">unset</span>($tmp);<font></font>
	}<font></font>
			<font></font>
	<span class="hljs-keyword">return</span> $str;<font></font>
}<font></font>
<font></font>
$str = <span class="hljs-keyword">array</span>();<font></font>
$c = <span class="hljs-number">1</span>;
<span class="hljs-keyword">while</span> ($c &lt;= $tryes) {<font></font>
	$tmp = get_data($addr, $action, $cnt);<font></font>
	<font></font>
	<span class="hljs-keyword">if</span> (strlen($tmp) == $cnt)<font></font>
		$str[] = $tmp;<font></font>
	<font></font>
	$c++;<font></font>
}<font></font>
<font></font>
$new_array = array_count_values($str);<font></font>
<font></font>
asort($new_array);<font></font>
<font></font>
$res = <span class="hljs-string">""</span>;<font></font>
$max = <span class="hljs-number">0</span>;
<span class="hljs-keyword">foreach</span> ($new_array <span class="hljs-keyword">AS</span> $key=&gt;$val) {
	<span class="hljs-keyword">if</span> ($val &gt;= $max) {<font></font>
		$res = $key;<font></font>
		$max = $val;<font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">return</span> preg_split(<span class="hljs-string">'//'</span>, $res, <span class="hljs-number">-1</span>, PREG_SPLIT_NO_EMPTY);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En un mot - nous faisons plusieurs tentatives ($ tryes&gt; 3) pour interroger l'arduino, nous obtenons une ligne compos√©e de 0 ou 1. Partout avec n'importe quelle commande, nous regardons la r√©ponse, s'il y a le mot Erreur - cela signifie qu'il y a eu des erreurs pendant le transfert et vous devez r√©p√©ter le transfert . </font><font style="vertical-align: inherit;">Plusieurs tentatives ont √©t√© faites pour garantir l'exactitude de la cha√Æne transmise, le tableau est r√©duit par cha√Æne en utilisant la m√©thode array_count_values ‚Äã‚Äã($ str); </font><font style="vertical-align: inherit;">et √† la fin, nous obtenons un tableau avec le nombre d'occurrences des m√™mes lignes, nous donnons la ligne que nous avons re√ßue le plus de Arduino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Du c√¥t√© d'arduino, tout est plus simple:</font></font><br>
<br>
<pre><code class="hljs pgsql"><span class="hljs-type">void</span> requestEvent() {
  <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">1</span>) {<font></font>
    byte <span class="hljs-keyword">value</span> = EEPROM.<span class="hljs-keyword">read</span>(leds[current_port]);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
    <font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">2</span>) {<font></font>
    byte dvalue = EEPROM.<span class="hljs-keyword">read</span>(pins[current_port]);
    <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
<font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de la page Web contient les contr√¥les:</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d3"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d4"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d5"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d6"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 6);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x423"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_lyuda"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x424"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_anton"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x425"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d15"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d14"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d16"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d17"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4212"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 12);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4213"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 13);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4214"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4215"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4216"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4217"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, j'indique explicitement l'adresse de la carte √† laquelle j'ai besoin d'acc√©der et le num√©ro de port. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh oui, le contr√¥leur ressemble √† ceci maintenant:</font></font><br>
<br>
<img src="https://habrastorage.org/files/05d/20e/6f0/05d20e6f0e8747bc940f202e2606fd2a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que tout a √©t√© install√©, tout a commenc√© la premi√®re fois. Et le lendemain, un effet incompr√©hensible s'est produit: si vous allumez toutes les lumi√®res de la chambre, toute la lumi√®re de la chambre commence √† clignoter toutes les 2 √† 3 secondes. J'ai pass√© toute la nuit √† choisir le code; il n'y avait pas un tel montant sur le banc d'essai, donc le probl√®me n'est pas dans le code. J'ai fouill√© dans un tas de forums, dans une toge sur l'un d'eux, j'ai trouv√© une description d'un sympt√¥me similaire, v√©rifi√© ma supposition - et le probl√®me a disparu. Et le fait est que j'ai aliment√© les trois arduins √† partir d'une alimentation √©lectrique d'ordinateur, 12V, et que le vieil affranchi a tranquillement mang√© et n'a pas bourdonn√©, et arduino uno v3 ne pouvait pas, et quand tous les relais ont √©t√© allum√©s, le r√©gulateur de puissance a √©t√© chauff√© de telle sorte que C'√©tait impossible √† toucher. R√©duit la tension d'alimentation √† 5V 2A - et cela a fonctionn√© comme il se doit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a beaucoup de plans, nous devons terminer la r√©paration dans l'appartement, le couloir et la salle de bain avec les toilettes sont en ligne, dans mes r√™ves, je veux contr√¥ler le chauffe-eau et chaque sortie, car maintenant je peux accrocher n'importe quelle quantit√© d'arduin sur le bus I2C et chacun fera sa propre chose. </font><font style="vertical-align: inherit;">Il est √©galement pr√©vu d'ajouter des relais d'impulsions au rail DIN afin que les modules de relais ne contr√¥lent que ces relais d'impulsions, et d√©j√† la charge enti√®re passe par ces derniers. </font><font style="vertical-align: inherit;">Parce qu'il existe de s√©rieux doutes sur la fiabilit√© des modules relais chinois. </font><font style="vertical-align: inherit;">Mais c'est tout √† l'avenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme promis, liens vers github: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface Web</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sketchy </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour arduino</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr386457/">https://habr.com/ru/post/fr386457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr386443/index.html">La technologie moderne √©limine le ronflement: le syst√®me Nora non invasif</a></li>
<li><a href="../fr386447/index.html">Le service Location Magic suivra la position de votre appareil sans GPS</a></li>
<li><a href="../fr386449/index.html">29 $ pour des instructions sur la construction d'une table de transformateur</a></li>
<li><a href="../fr386451/index.html">Interaction optimale avec les montres intelligentes: bracelet SHIFT</a></li>
<li><a href="../fr386455/index.html">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç—ã</a></li>
<li><a href="../fr386459/index.html">Un vieil ami vaut mieux que deux nouveaux. G√©n√©rateur de paysage. Partie 1</a></li>
<li><a href="../fr386461/index.html">–°–ø—É—Ç–Ω–∏–∫ –ú–∞—Ä—Å–∞ –§–æ–±–æ—Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞–∑—Ä—É—à–∞–µ—Ç—Å—è –ø–æ–¥ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ–º –ø—Ä–∏–ª–∏–≤–Ω—ã—Ö —Å–∏–ª</a></li>
<li><a href="../fr386463/index.html">Sortir de l'ombre: comment naissent de nouveaux √©changes</a></li>
<li><a href="../fr386465/index.html">Num√©risation et impression 3D en pal√©ontologie. Continuation</a></li>
<li><a href="../fr386467/index.html">Blizzard poursuit les d√©veloppeurs de robots pour violation de droit d'auteur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>