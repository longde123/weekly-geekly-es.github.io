<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕵🏾 👃🏼 🤲 Implémentation de mon système domotique 👩‍👧‍👧 🙆🏿 🍢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendant longtemps j'ai lu des articles sur Habré sur les systèmes domotiques, je voulais décrire ce sur quoi je travaille depuis plus de 2 ans. Pour m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implémentation de mon système domotique</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/386457/"><img src="https://habrastorage.org/files/ea9/62e/a6d/ea962ea6d63c4af99f2a68e426d88fa5.jpg" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pendant longtemps j'ai lu des articles sur Habré sur les systèmes domotiques, je voulais décrire ce sur quoi je travaille depuis plus de 2 ans. Pour mieux comprendre ma situation, vous devez faire une petite introduction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a trois ans, ma famille et moi avons déménagé dans un nouvel appartement de trois pièces (67,5 m2), bien que techniquement l'appartement soit bien sûr ancien - Staline, une maison construite en 1946. Câblage en aluminium à deux fils avec des morceaux de câble toronné en cuivre de 1 mm² à certains endroits. La révision était en avance, j'ai décidé de tout faire moi-même et j'ai commencé par un remplacement complet du câblage. Ils ont acheté 700 m de câble d'alimentation pour l'éclairage et des prises de 1,5 et 2,5 m², une baie à paire torsadée, un peu de câble coaxial pour les antennes de télévision (juste au cas où). Pourquoi tant et ce qui est arrivé - je demande un chat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai décidé de faire le câblage tout de suite, à savoir: sans boîtiers de distribution, de chaque point le câble va au blindage (à l'exception des prises, qui peuvent être dans un groupe de 2-3 points, le câble va au blindage de l'extrême, les autres sont reliés par une boucle) - t. e. de chaque interrupteur son propre câble au blindage, de chaque point d'éclairage son propre câble au blindage, près des prises le long d'une paire de points rj-45, juste au cas où. Bien sûr, il existe de nombreux câbles. Quelque part, il est posé dans le sol conformément à toutes les règles du PUE, comme, par exemple, dans la pépinière: </font></font><br>
<br>
<img src="https://habrastorage.org/files/09e/071/732/09e0717328cb46a0b0df95701ac88122.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque part - au plafond, par exemple, vue de la porte de la chambre:</font></font><br>
<br>
<img src="https://habrastorage.org/files/f0f/f50/510/f0ff505103224720825920b62b9da86c.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, nous mettons tous les câbles dans le couloir en un seul endroit où le bouclier sera situé, et ils peuvent être commutés entre eux comme vous le souhaitez. Même si vous devez changer le schéma de connexion à l'avenir, cela ne prendra pas beaucoup de temps et vous n'aurez pas à gâcher la réparation. Et bien sûr, de nombreuses prises ont été faites pour toutes les occasions - au total environ 90 points pour tout l'appartement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici à quoi ressemblait le «bouclier» temporaire pendant les expériences: un </font></font><br>
<br>
<img src="https://habrastorage.org/files/1e4/0bd/131/1e40bd1311d2412686170c0ae8619274.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
spectacle terrible, mais tout fonctionnait et sous cette forme ce monstre a vécu plusieurs mois. Un beau jour, les étoiles se sont formées avec succès et le bouclier a été refait par décision volontaire. Cela a pris 3 jours sur un escalier branlant sous le plafond (et les plafonds dans le stalin 3m), mais ça valait le coup. Voici à quoi le tableau de bord a commencé à ressembler après cela: </font></font><br>
<br>
<img src="https://habrastorage.org/files/34b/2e4/1e9/34b2e41e94a54217bad80ce53d2e0e45.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et la vue générale:</font></font><br>
<br>
<img src="https://habrastorage.org/files/054/e15/85e/054e1585eeb74b7ebe62e3fcd946e1a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est loin de la forme finale du blindage, il n'y a toujours pas assez de RCD, il y a 3 fois moins de disjoncteurs que nécessaire, il n'y a pas de relais d'impulsion - mais il y a des lignes non déconnectables, tous les câbles sont connectés aux bornes, il y a au moins une sorte de sélectivité du disjoncteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que vous avez une idée approximative de ce avec quoi je devais travailler, vous pouvez commencer à décrire les «cerveaux» du système. Sans plus tarder, j'ai pris Arduino comme base, d'autant plus que j'avais déjà 2 cartes Freeduino, 2 blindages Ethernet et un blindage moteur que j'avais acheté bien avant. Également commandé auprès des Chinois plusieurs modules relais de 4 pièces chacun. Et j'ai aussi trouvé, sur les conseils d'un des articles sur Habré à Ob, des interrupteurs dans lesquels des ressorts spéciaux pouvaient être insérés et ils se transformaient en interrupteurs sans fixation. Il est temps d'écrire du code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, je suis étroitement lié aux ordinateurs dans la vie. Il a terminé le tapis de fourrure, sur lequel il n'a tout simplement pas écrit - pascal, c #, c ++, 1c, php, javascript - vous pouvez toujours en énumérer beaucoup. La dernière fois que je travaille dans le domaine du développement web, je m'occupe également de la téléphonie ip. Par conséquent, trouver un algorithme est simple, mais avec l'électronique «pour vous», je sais et je sais des choses simples, et quand il s'agit de quelque chose de plus compliqué - microcontrôleurs, fusibles, rebond de contact - c'est plus difficile. Mais ce ne sont pas les dieux qui brûlent les pots, les yeux ont peur, mais les mains le font. J'ai décidé de tout simplifier. J'alimente la terre de l'arduino à l'entrée de l'interrupteur, je connecte les sorties de l'interrupteur aux broches analogiques de l'arduino (bien que cela soit possible en numérique, ce n'est pas important). Je connecte les broches de l'arduino avec les broches du module relais. Techniquement, tout est prêt, lorsque vous appuyez sur l'interrupteur, l'arduino voit la valeur LOW sur la broche souhaitée et définit la LOW sur la broche connectée au module de relais.Étant donné que tous les câbles des points de l'appartement arrivent aux bornes - la connexion n'a pas pris beaucoup de temps.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour lutter contre le rebond des contacts, après avoir étudié le sujet sur Internet, la bibliothèque Bounce2 a été sélectionnée. En général, j'ai d'abord voulu écrire un code universel afin qu'il puisse être utilisé avec au moins 2 commutateurs, au moins 22. C'est cette tâche qui a constitué la base de tout l'algorithme. Eh bien, maintenant des mots au code. Je ne téléchargerai pas entièrement tout le code; les liens vers le github seront à la fin de l'article. Je ne montrerai que des moments importants, de mon point de vue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, déclarer des bibliothèques et des variables:</font></font><br>
<br>
<pre><code class="hljs apache"><span class="hljs-comment">#include &lt;Bounce2.h&gt;</span>
<span class="hljs-comment">#include &lt;EEPROM.h&gt;</span><font></font>
<font></font>
<span class="hljs-attribute">const</span> byte cnt = <span class="hljs-number">8</span>;
<span class="hljs-attribute">const</span> byte pin_cnt = <span class="hljs-number">19</span>;<font></font>
<font></font>
<span class="hljs-attribute">int</span> pins[] = {<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>};
<span class="hljs-attribute">int</span> leds[] = {<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>};<font></font>
<font></font>
<span class="hljs-attribute">byte</span> init_leds[cnt] ;
<span class="hljs-attribute">byte</span> init_buttons[cnt];
<span class="hljs-attribute">int</span> button_states[cnt];
<span class="hljs-attribute">Bounce</span> debouncers[cnt];
<span class="hljs-attribute">unsigned</span> long buttonPressTimeStamps[cnt];
<span class="hljs-attribute">boolean</span> changed[cnt];
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le point est: il suffit d'augmenter la constante avec le nombre de lampes / interrupteurs et d'enregistrer de nouvelles associations dans les tableaux - et c'est tout, une nouvelle lampe ou interrupteur sera ajouté. </font><font style="vertical-align: inherit;">En même temps, la structure du code permet à un commutateur de contrôler plusieurs appareils à la fois. </font><font style="vertical-align: inherit;">Ou plusieurs interrupteurs pour contrôler immédiatement une lampe. </font><font style="vertical-align: inherit;">De plus, pour chaque commutateur, sa propre instance de l'objet Bounce est créée pour l'anti-rebond. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fonction de configuration, tous les tableaux sont initialisés, tandis que l'état des luminaires est stocké dans une mémoire non volatile, de sorte que lorsqu'une panne de courant ou un redémarrage se produit, tout s'allume de la même manière qu'avant la panne.</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    <font></font>
    byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = LOW ;<font></font>
    }<span class="hljs-keyword">else</span>{<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = HIGH ;<font></font>
    }<font></font>
    init_buttons[<span class="hljs-built_in">i</span>] = HIGH;<font></font>
    buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    changed[<span class="hljs-built_in">i</span>] = <span class="hljs-built_in">false</span>;<font></font>
<font></font>
    debouncers[<span class="hljs-built_in">i</span>] = Bounce();<font></font>
<font></font>
    pinMode(pins[<span class="hljs-built_in">i</span>], INPUT);<font></font>
    pinMode(leds[<span class="hljs-built_in">i</span>], OUTPUT);<font></font>
    <font></font>
    digitalWrite(pins[<span class="hljs-built_in">i</span>], init_buttons[<span class="hljs-built_in">i</span>]);<font></font>
    digitalWrite(leds[<span class="hljs-built_in">i</span>], init_leds[<span class="hljs-built_in">i</span>]);<font></font>
    <font></font>
    debouncers[<span class="hljs-built_in">i</span>].attach( pins[<span class="hljs-built_in">i</span>] );<font></font>
    debouncers[<span class="hljs-built_in">i</span>].interval(<span class="hljs-number">5</span>);<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne dirai rien du premier cycle, nous y reviendrons un peu plus tard. </font><font style="vertical-align: inherit;">Et le plus intéressant commence dans le corps du cycle principal.</font></font><br>
<br>
<pre><code class="hljs matlab">void loop(){
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>){<font></font>
    byte dvalue = EEPROM.read(pins[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(dvalue!=<span class="hljs-number">11</span>) {<font></font>
      changed[<span class="hljs-built_in">i</span>] = debouncers[<span class="hljs-built_in">i</span>].update();<font></font>
      <font></font>
      <span class="hljs-keyword">if</span> ( changed[<span class="hljs-built_in">i</span>] ) {<font></font>
        int value = debouncers[<span class="hljs-built_in">i</span>].read();
        <span class="hljs-keyword">if</span> ( value == HIGH) {<font></font>
         button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;   <font></font>
        } <span class="hljs-keyword">else</span> {
           <span class="hljs-keyword">if</span> (<span class="hljs-built_in">i</span> &gt; <span class="hljs-number">0</span> and pins[<span class="hljs-built_in">i</span>] == pins[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]) {<font></font>
             byte prev_value = EEPROM.read(leds[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]);<font></font>
                            <font></font>
             <span class="hljs-keyword">if</span>(prev_value == <span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<font></font>
           } <span class="hljs-keyword">else</span> {               <font></font>
             byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
             <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<font></font>
           }<font></font>
                 <font></font>
           button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">1</span>;<font></font>
           buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = millis();     <font></font>
        }<font></font>
      }<font></font>
   <font></font>
      <span class="hljs-keyword">if</span> ( button_states[<span class="hljs-built_in">i</span>] == <span class="hljs-number">1</span> ) {
        <span class="hljs-keyword">if</span> ( millis() - buttonPressTimeStamps[<span class="hljs-built_in">i</span>] &gt;= <span class="hljs-number">200</span> ) {<font></font>
            button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">2</span>;<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  delay( <span class="hljs-number">10</span> );<font></font>
} <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors des tests des premières versions de l'algorithme, il a été constaté que les enfants (et j'en ai trois, les garçons) aimaient vraiment cliquer sur les interrupteurs. </font><font style="vertical-align: inherit;">Par conséquent, il était nécessaire de pouvoir désactiver certains commutateurs afin que le contrôleur ne leur réponde pas. </font><font style="vertical-align: inherit;">L'option la plus évidente est de simplement retirer les broches nécessaires de la carte, mais c'est faux et sans intérêt. </font><font style="vertical-align: inherit;">Par conséquent, les drapeaux sont également écrits dans la mémoire non volatile indiquant si le commutateur est ouvert ou non. </font><font style="vertical-align: inherit;">Ceci est initialisé avec cette boucle:</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et vérifié ici:</font></font><br>
<br>
<pre><code class="hljs lisp">  for(<span class="hljs-name">byte</span> i=0<span class="hljs-comment">; i&lt;cnt; i=i+1){</span>
    byte dvalue = EEPROM.read(<span class="hljs-name">pins</span>[i])<span class="hljs-comment">;</span>
    if(<span class="hljs-name">dvalue!=11</span>) {<font></font>
    ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Déjà à ce stade, des interrupteurs locaux sur les murs ont commencé à fonctionner. Mais une maison intelligente ne serait pas intelligente sans interface. Comme je m'occupe du développement web, il a été décidé de faire une interface web. C'est là que les blindages Ethernet sont utiles. Malheureusement, je n'ai pas pu trouver les sources des premières versions de programmes qui utilisent des blindages Ethernet pour le contrôle à distance. J'essaierai de chercher dans les sauvegardes, peut-être qu'elles sont là. Mais le sens était primitif à la honte. Chaque contrôleur a sa propre adresse IP. Un serveur Web montait sur l'arduino, qui analysait les demandes GET et allumait ou éteignait la lampe correspondante en fonction du numéro de port. Il existe de nombreux exemples de ce type sur Internet. Pour l'interface Web, un serveur a été construit sur la carte mère avec Intel Atom intégré, Ubuntu Server 14.02 a été installé, l'ensemble LAMP standard a été installé,une interface simple y est écrite. Toutes les sources seront également à la fin de l'article. Pour le moment, cela ressemble à ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/files/7ba/5b2/d4c/7ba5b2d4c95c48f0ac3873cef3c76b23.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, une lampe dans la cuisine est allumée et l'interrupteur responsable est verrouillé. La gestion est méga-simple - cliquez simplement sur l'élément souhaité et son état change.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et tout serait super, sinon pour un «mais». Les blindages Ethernet étaient constamment suspendus. Non, le contrôle local des commutateurs fonctionnait toujours comme une horloge. Mais le contrôle à distance de l'interface Web est tombé en permanence. Si la direction a travaillé pendant une journée, c'était excellent. Mais le plus souvent, le bouclier s'est accroché quelques heures seulement après le redémarrage. Ce que je n’ai pas fait, c’était d’essayer de gérer les chiens de garde, mais mes planches ne l’ont pas soutenu. J'ai commandé en Chine et remplacé les boucliers par d'autres - sur en28j60 - ça s'est amélioré, mais ils ont toujours raccroché périodiquement. J'ai ajouté un module de relais au contrôleur, j'ai alimenté les cartes Arduino par des contacts normalement fermés, et l'une des cartes Arduino a tiré le relais avec une certaine fréquence et l'alimentation a été coupée, puis il a été rétabli - cependant, cela n'a pas toujours fonctionné et il a clignoté au moment du redémarrage. lumière allumée,même pendant quelques secondes, mais néanmoins. Voici à quoi ressemblait le contrôleur à ce stade:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ab0/71d/eb3/ab071deb30a94677a261c5378a809124.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis il a été décidé d'abandonner complètement les boucliers Ethernet. J'ai commencé à chercher d'autres fonctionnalités de gestion à distance. J'ai essayé de connecter des arduins directement au serveur et d'envoyer des commandes via Serial.read () / Serial.print () - cela a fonctionné une fois sur deux, la stabilité n'a pas été atteinte car la carte a redémarré à chaque fois qu'elle était accessible à partir d'un script sur le serveur. J'ai beaucoup lu sur ces erreurs, je viens de réaliser qu'il était connecté au DTR, quelque part ils ont écrit que vous pouvez initialiser le port avec d'autres drapeaux, ont donné des exemples qui ne fonctionnaient pas pour moi. Après un certain temps, je suis tombé sur un article sur la fabrication d'un adaptateur USB-I2C à partir d'un programmeur USBAsp. J'ai décidé - pourquoi pas? J'ai commandé deux de ces programmeurs aux Chinois - et j'ai attendu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y a une semaine, mon colis est arrivé. </font><font style="vertical-align: inherit;">Un programmeur a été flashé avec le micrologiciel USB minuscule i2c et je me suis de nouveau assis pour réécrire le code. </font><font style="vertical-align: inherit;">Ici, les fonctionnalités du protocole ont commencé à apparaître. </font><font style="vertical-align: inherit;">Bien sûr, le serveur était le maître et toutes les cartes Arduino étaient des esclaves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code doit résoudre les tâches suivantes: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - signaler l'état du port demandé; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - changer l'état du port demandé; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - éteignez ou allumez toutes les lumières. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et j'ai rencontré un problème. </font><font style="vertical-align: inherit;">Je peux utiliser les commandes standard de la suite i2c-tools pour communiquer avec les cartes Arduino. </font><font style="vertical-align: inherit;">C'est une équipe</font></font><br>
<br>
<pre><code class="bash hljs">i2cget -y &lt; &gt; &lt;&gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et</font></font><br>
<br>
<pre><code class="bash hljs">i2cset -y &lt; &gt; &lt;&gt; 0x00 &lt;byte &gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble que, à en juger par l'homme, vous pourriez passer le mot valeur, mais cela n'a pas fonctionné pour moi, ou je me suis trompé quelque part. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème est que, tout d'abord, si je dois changer l'état d'un certain port, je dois d'abord transmettre le numéro de la commande responsable de cette opération, puis le numéro de port. </font><font style="vertical-align: inherit;">J'ai même essayé de le faire, d'envoyer 2 commandes et, dans le code, de les collecter à leur tour - mais c'était moche et irrationnel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Problème numéro deux - Arduino ne peut pas répondre à quelque chose au moment où elle reçoit les données. </font><font style="vertical-align: inherit;">Il existe deux méthodes de la bibliothèque Wire: onReceive () lorsque les données sont reçues du maître et onRequest () lorsque les données sont demandées par le maître. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai donc fait ceci: le serveur web a 6 commandes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "1" - obtenir l'état de toutes les lumières</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "2" - obtenir l'état de blocage de tous les commutateurs</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "5" - allumer le monde entier</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande "6" - éteindre le monde entier</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
une commande formée comme suit: un nombre décimal de la forme suivante &lt;centaines (1 ou 2) - allumer la lampe ou verrouiller l'interrupteur&gt; &lt;numéro de port (de 0 à 99)&gt;; </font><font style="vertical-align: inherit;">par exemple, 105 - port du commutateur 5, 213 - verrouillage du port du commutateur 13. </font><font style="vertical-align: inherit;">Cette commande est traduite en hexadécimal et transmise à l'arduino, qui effectue les transformations inverses et comprend ce qui doit être fait. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici à quoi cela ressemble du côté serveur:</font></font><br>
<br>
<pre><code class="php hljs">  ...
  <span class="hljs-keyword">if</span> ($action == <span class="hljs-number">3</span>)<font></font>
     $val_hex = dechex(intval($port) + <span class="hljs-number">100</span>);
  <span class="hljs-keyword">else</span>
     $val_hex = dechex(intval($port) + <span class="hljs-number">200</span>);<font></font>
  <font></font>
  exec(<span class="hljs-string">"sudo i2cset -y 7 $addr 0x00 0x$val_hex"</span>, $output);<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et du côté de l'arduino:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">receiveEvent</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> howMany</span>)</span> {
  <span class="hljs-keyword">byte</span> bytes = Wire.available();
  <span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">1</span>; i &lt;= bytes; i=i+<span class="hljs-number">1</span>) {<font></font>
    x = Wire.read();<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (x == <span class="hljs-number">1</span> or x == <span class="hljs-number">2</span> or x == <span class="hljs-number">5</span> or x == <span class="hljs-number">6</span>) {<font></font>
    do_action(x, <span class="hljs-number">0</span>);<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> ( x &gt; <span class="hljs-number">200</span>) {<font></font>
      do_action (<span class="hljs-number">4</span>, x - <span class="hljs-number">200</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      do_action (<span class="hljs-number">3</span>, x - <span class="hljs-number">100</span>);<font></font>
    }<font></font>
  }  <font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble assez primitif, mais cela fonctionne. </font><font style="vertical-align: inherit;">Le deuxième problème est résolu comme suit. </font><font style="vertical-align: inherit;">Voici la fonction do_action:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">do_action</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span> command, <span class="hljs-keyword">byte</span> port</span>)</span> {
  <span class="hljs-keyword">byte</span> <span class="hljs-keyword">value</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">byte</span> dvalue = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">switch</span> (command) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">1</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">2</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
      <span class="hljs-keyword">value</span> = EEPROM.read(port);
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
        digitalWrite(port, HIGH);<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        digitalWrite(port, LOW);<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<font></font>
      dvalue = EEPROM.read(port);<font></font>
      <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], LOW);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], HIGH);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">10</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:<font></font>
      <font></font>
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec les équipes 3-6, tout est clair, mais les équipes 1 ou 2 peuvent être décrites plus en détail. </font><font style="vertical-align: inherit;">Le serveur envoie d'abord la commande souhaitée, et lorsque l'arduino reçoit la commande 1 ou 2, les drapeaux sont initialisés:</font></font><br>
<br>
<pre><code class="hljs nginx">  <span class="hljs-attribute">start_request</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attribute">request_type</span> = <span class="hljs-number">1</span>;
  <span class="hljs-attribute">current_port</span> = <span class="hljs-number">0</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis le serveur commence à envoyer des requêtes à l'arduino autant de fois que les ports qu'il souhaite interroger. </font><font style="vertical-align: inherit;">Côté serveur:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">$address, $action, $cnt</span>) </span>{<font></font>
	exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
	$tmp = @$output[<span class="hljs-number">0</span>];
	<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
		exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
	}<font></font>
	$str = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">1</span>; $i &lt;= $cnt; $i++) {<font></font>
		exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];
		<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
			exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
			$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($tmp) {
			<span class="hljs-keyword">if</span> (strpos($tmp,<span class="hljs-string">"1"</span>)!==<span class="hljs-literal">false</span>)<font></font>
				$str .= <span class="hljs-string">"1"</span>;
			<span class="hljs-keyword">else</span>
				$str .= <span class="hljs-string">"0"</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">unset</span>($output);
		<span class="hljs-keyword">unset</span>($tmp);<font></font>
	}<font></font>
			<font></font>
	<span class="hljs-keyword">return</span> $str;<font></font>
}<font></font>
<font></font>
$str = <span class="hljs-keyword">array</span>();<font></font>
$c = <span class="hljs-number">1</span>;
<span class="hljs-keyword">while</span> ($c &lt;= $tryes) {<font></font>
	$tmp = get_data($addr, $action, $cnt);<font></font>
	<font></font>
	<span class="hljs-keyword">if</span> (strlen($tmp) == $cnt)<font></font>
		$str[] = $tmp;<font></font>
	<font></font>
	$c++;<font></font>
}<font></font>
<font></font>
$new_array = array_count_values($str);<font></font>
<font></font>
asort($new_array);<font></font>
<font></font>
$res = <span class="hljs-string">""</span>;<font></font>
$max = <span class="hljs-number">0</span>;
<span class="hljs-keyword">foreach</span> ($new_array <span class="hljs-keyword">AS</span> $key=&gt;$val) {
	<span class="hljs-keyword">if</span> ($val &gt;= $max) {<font></font>
		$res = $key;<font></font>
		$max = $val;<font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">return</span> preg_split(<span class="hljs-string">'//'</span>, $res, <span class="hljs-number">-1</span>, PREG_SPLIT_NO_EMPTY);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En un mot - nous faisons plusieurs tentatives ($ tryes&gt; 3) pour interroger l'arduino, nous obtenons une ligne composée de 0 ou 1. Partout avec n'importe quelle commande, nous regardons la réponse, s'il y a le mot Erreur - cela signifie qu'il y a eu des erreurs pendant le transfert et vous devez répéter le transfert . </font><font style="vertical-align: inherit;">Plusieurs tentatives ont été faites pour garantir l'exactitude de la chaîne transmise, le tableau est réduit par chaîne en utilisant la méthode array_count_values ​​($ str); </font><font style="vertical-align: inherit;">et à la fin, nous obtenons un tableau avec le nombre d'occurrences des mêmes lignes, nous donnons la ligne que nous avons reçue le plus de Arduino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Du côté d'arduino, tout est plus simple:</font></font><br>
<br>
<pre><code class="hljs pgsql"><span class="hljs-type">void</span> requestEvent() {
  <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">1</span>) {<font></font>
    byte <span class="hljs-keyword">value</span> = EEPROM.<span class="hljs-keyword">read</span>(leds[current_port]);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
    <font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">2</span>) {<font></font>
    byte dvalue = EEPROM.<span class="hljs-keyword">read</span>(pins[current_port]);
    <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
<font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de la page Web contient les contrôles:</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d3"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d4"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d5"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d6"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 6);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x423"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_lyuda"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x424"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_anton"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x425"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d15"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d14"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d16"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d17"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4212"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 12);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4213"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 13);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4214"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4215"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4216"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4217"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, j'indique explicitement l'adresse de la carte à laquelle j'ai besoin d'accéder et le numéro de port. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh oui, le contrôleur ressemble à ceci maintenant:</font></font><br>
<br>
<img src="https://habrastorage.org/files/05d/20e/6f0/05d20e6f0e8747bc940f202e2606fd2a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que tout a été installé, tout a commencé la première fois. Et le lendemain, un effet incompréhensible s'est produit: si vous allumez toutes les lumières de la chambre, toute la lumière de la chambre commence à clignoter toutes les 2 à 3 secondes. J'ai passé toute la nuit à choisir le code; il n'y avait pas un tel montant sur le banc d'essai, donc le problème n'est pas dans le code. J'ai fouillé dans un tas de forums, dans une toge sur l'un d'eux, j'ai trouvé une description d'un symptôme similaire, vérifié ma supposition - et le problème a disparu. Et le fait est que j'ai alimenté les trois arduins à partir d'une alimentation électrique d'ordinateur, 12V, et que le vieil affranchi a tranquillement mangé et n'a pas bourdonné, et arduino uno v3 ne pouvait pas, et quand tous les relais ont été allumés, le régulateur de puissance a été chauffé de telle sorte que C'était impossible à toucher. Réduit la tension d'alimentation à 5V 2A - et cela a fonctionné comme il se doit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a beaucoup de plans, nous devons terminer la réparation dans l'appartement, le couloir et la salle de bain avec les toilettes sont en ligne, dans mes rêves, je veux contrôler le chauffe-eau et chaque sortie, car maintenant je peux accrocher n'importe quelle quantité d'arduin sur le bus I2C et chacun fera sa propre chose. </font><font style="vertical-align: inherit;">Il est également prévu d'ajouter des relais d'impulsions au rail DIN afin que les modules de relais ne contrôlent que ces relais d'impulsions, et déjà la charge entière passe par ces derniers. </font><font style="vertical-align: inherit;">Parce qu'il existe de sérieux doutes sur la fiabilité des modules relais chinois. </font><font style="vertical-align: inherit;">Mais c'est tout à l'avenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme promis, liens vers github: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface Web</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sketchy </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour arduino</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr386457/">https://habr.com/ru/post/fr386457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr386443/index.html">La technologie moderne élimine le ronflement: le système Nora non invasif</a></li>
<li><a href="../fr386447/index.html">Le service Location Magic suivra la position de votre appareil sans GPS</a></li>
<li><a href="../fr386449/index.html">29 $ pour des instructions sur la construction d'une table de transformateur</a></li>
<li><a href="../fr386451/index.html">Interaction optimale avec les montres intelligentes: bracelet SHIFT</a></li>
<li><a href="../fr386455/index.html">Предложен вычислительный критерий определения планеты</a></li>
<li><a href="../fr386459/index.html">Un vieil ami vaut mieux que deux nouveaux. Générateur de paysage. Partie 1</a></li>
<li><a href="../fr386461/index.html">Спутник Марса Фобос постепенно разрушается под воздействием приливных сил</a></li>
<li><a href="../fr386463/index.html">Sortir de l'ombre: comment naissent de nouveaux échanges</a></li>
<li><a href="../fr386465/index.html">Numérisation et impression 3D en paléontologie. Continuation</a></li>
<li><a href="../fr386467/index.html">Blizzard poursuit les développeurs de robots pour violation de droit d'auteur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>