<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤ üõçÔ∏è üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Nous √©crivons le proxy Reverse socks5 sur PowerShell. Partie 1 ‚ô†Ô∏è üóìÔ∏è üêÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'histoire de la recherche et du d√©veloppement en 3 parties. Partie 1 - recherche. 
 Il existe de nombreux h√™tres - encore plus d'avantages. 

 √ânonc√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous √©crivons le proxy Reverse socks5 sur PowerShell. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453870/">  L'histoire de la recherche et du d√©veloppement en 3 parties.  Partie 1 - recherche. <br>  Il existe de nombreux h√™tres - encore plus d'avantages. <br><br><h3>  √ânonc√© du probl√®me </h3><br>  Lors de la conduite de pentests et de campagnes RedTeam, il n'est pas toujours possible d'utiliser les moyens habituels des clients, tels que VPN, RDP, Citrix, etc.  comme un correctif pour entrer dans le r√©seau interne.  Quelque part, un VPN ordinaire fonctionne selon MFA et un jeton de fer est utilis√© comme deuxi√®me facteur, quelque part il est s√©v√®rement surveill√© et notre entr√©e VPN devient imm√©diatement visible, comme on dit - avec toutes les cons√©quences, mais quelque part il n'y a tout simplement pas de tels moyens. <br><br>  Dans de tels cas, doivent constamment faire ce que l'on appelle les ¬´tunnels inverses¬ª - les connexions du r√©seau interne √† une ressource externe ou au serveur que nous contr√¥lons.  √Ä l'int√©rieur d'un tel tunnel, nous pouvons d√©j√† travailler avec les ressources internes des clients. <br><br>  Il existe plusieurs vari√©t√©s de tels tunnels inverses.  Le plus c√©l√®bre d'entre eux, bien s√ªr, est Meterpreter.  Les tunnels SSH avec redirection de port inverse sont √©galement tr√®s demand√©s par les masses de pirates.  Il existe de nombreux outils de tunneling inverse et beaucoup d'entre eux sont bien √©tudi√©s et d√©crits. <br><br>  Bien entendu, les d√©veloppeurs de solutions de protection ne sont pas en reste et d√©tectent activement de telles actions. <br><br>  Par exemple, les sessions MSF sont d√©tect√©es avec succ√®s par les IPS modernes de Cisco ou de Positive Tech, et le tunnel SSH invers√© peut √™tre d√©tect√© par presque tout pare-feu plus ou moins normal. <br><br>  Par cons√©quent, afin de passer inaper√ßu dans une bonne campagne RedTeam, nous devons construire un tunnel inverse avec des moyens non standard et nous adapter le plus possible au mode r√©el du r√©seau. <br><br>  Essayons de trouver ou d'inventer quelque chose de similaire. <br><a name="habracut"></a><br>  Avant d'inventer quelque chose, vous devez comprendre quel r√©sultat nous voulons atteindre, quelles fonctions notre d√©veloppement doit remplir.  Quelles seront les exigences pour le tunnel afin que nous puissions travailler en mode furtif maximum? <br><br>  Il est clair que pour chaque cas, ces exigences peuvent diff√©rer consid√©rablement, mais l'exp√©rience nous permet de distinguer les principales: <br><br><ul><li>  travailler sur OS Windows-7-10.  √âtant donn√© que la plupart des r√©seaux d'entreprise utilisent Windows; </li><li>  le client se connecte au serveur via SSL pour √©viter une √©coute stupide en utilisant ips; </li><li>  lors de la connexion, le client doit prendre en charge le fonctionnement via un serveur proxy avec autorisation, comme  De nombreuses entreprises acc√®dent √† Internet via un proxy.  En fait, la machine cliente n'en sait peut-√™tre m√™me rien et le proxy est utilis√© en mode transparent.  Mais nous devons √©tablir une telle fonctionnalit√©; </li><li>  la partie client doit √™tre concise et portable; <br>  Il est clair que pour travailler √† l'int√©rieur du r√©seau du client sur la machine cliente, vous pouvez installer OpenVPN et cr√©er un tunnel √† part enti√®re vers votre serveur (car les clients openvpn peuvent fonctionner via des proxys).  Mais, d'une part, cela ne fonctionne pas toujours, car nous ne sommes peut-√™tre pas des administrateurs locaux, et d'autre part, cela fera tellement de bruit qu'un SIEM ou un HIPS d√©cents ¬´nous frapperont¬ª imm√©diatement.  Id√©alement, notre client devrait √™tre une soi-disant commande en ligne, par exemple, de nombreux shells bash sont impl√©ment√©s et ex√©cutent la ligne de commande, par exemple, lors de l'ex√©cution de commandes √† partir d'une macro de mot. </li><li>  notre tunnel doit √™tre multithread et prendre en charge de nombreuses connexions en m√™me temps; </li><li>  la connexion client-serveur doit avoir une sorte d'autorisation pour que le tunnel soit √©tabli uniquement pour notre client, et non pour tous ceux qui viennent sur notre serveur √† l'adresse et au port sp√©cifi√©s.  Id√©alement, pour les ¬´utilisateurs tiers¬ª, une page de destination avec des sceaux ou des sujets professionnels li√©s au domaine source devrait s'ouvrir. <br>  Par exemple, si le client est une organisation m√©dicale, alors pour l'administrateur de la s√©curit√© de l'information qui a d√©cid√© de v√©rifier la ressource que l'employ√© de la clinique a utilis√©e, une page avec des produits pharmaceutiques, un wikipedia avec une description du diagnostic, ou un blog du Dr Komarovsky, etc. devrait s'ouvrir. </li></ul><br><h3>  Analyse des outils existants </h3><br>  Avant d'inventer votre v√©lo, vous devez analyser les v√©los existants et comprendre si nous en avons vraiment besoin et, probablement, non seulement nous avons pens√© √† la n√©cessit√© d'un tel v√©lo fonctionnel. <br><br>  La recherche sur Internet (nous semblons √™tre d'accord avec Google), ainsi que la recherche dans le github pour les mots cl√©s "chaussettes invers√©es", n'ont pas donn√© beaucoup de r√©sultats.  Fondamentalement, tout se r√©sume √† la construction de tunnels ssh avec redirection de port inverse et tout ce qui y est connect√©.  En plus des tunnels SSH, plusieurs solutions peuvent √™tre distingu√©es: <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/klsecservices/rpivot</a></b> <br>  Une impl√©mentation de longue date du tunnel inverse des gars de Kaspersky Lab.  Par son nom, il est clair √† quoi sert ce script.  Mis en ≈ìuvre en Python 2.7, le tunnel fonctionne en mode texte clair (comme il est √† la mode de dire maintenant - bonjour √† ILV) <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/tonyseek/rsocks</a></b> <br>  Une autre impl√©mentation de python est √©galement en texte clair, mais il y a plus d'options.  Il est √©crit sous forme de module et il existe une API pour int√©grer la solution dans vos projets. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/llkat/rsockstun</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/mis-team/rsockstun</a></b> <br>  Le premier lien est la version initiale de l'impl√©mentation de Sox invers√© sur le Golang (non pris en charge par le d√©veloppeur). <br><br>  Le deuxi√®me lien est d√©j√† notre r√©vision avec des puces suppl√©mentaires, √©galement sur le golang.  Dans notre version, nous avons impl√©ment√© SSL, travaill√© via un proxy avec l'autorisation NTLM, l'autorisation client, une page de destination avec un mot de passe incorrect (ou plut√¥t une redirection vers une page de destination), le mode multi-thread (c'est-√†-dire que plusieurs personnes peuvent travailler avec le tunnel en m√™me temps) , un syst√®me de ping client pour savoir s'il est vivant ou non. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/jun7th/tsocks</a></b> <br>  Impl√©mentation Reverse Sox de nos ¬´amis chinois¬ª en python.  L√† pour le paresseux et "immortel" se trouve le binar pr√™t √† l'emploi (exe), assembl√© par les Chinois et pr√™t √† l'emploi.  Ici, seul le dieu chinois sait qu'il peut y avoir plus que la fonctionnalit√© principale de ce binaire, alors utilisez-le √† vos risques et p√©rils. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/securesocketfunneling/ssf</a></b> <br>  Un projet C ++ assez int√©ressant pour impl√©menter des chaussettes invers√©es et plus  En plus du tunnel inverse, il peut faire une redirection de port, cr√©er un shell de commande, etc. <br><br>  <b>Msf meterpreter</b> <br>  Ici, comme on dit, aucun commentaire.  Tous les hackers plus ou moins √©duqu√©s connaissent tr√®s bien cette chose et comprennent avec quelle facilit√© elle peut √™tre d√©tect√©e par un √©quipement de protection. <br><br>  Tous les outils ci-dessus fonctionnent sur une technologie similaire: sur une machine √† l'int√©rieur du r√©seau, un module binaire ex√©cutable pr√©-pr√©par√© est lanc√©, qui √©tablit une connexion √† un serveur externe.  Le serveur d√©marre le serveur SOCKS4 / 5, qui accepte les connexions et les traduit au client. <br><br>  L'inconv√©nient de tous les outils ci-dessus est que Python ou Golang est requis sur la machine cliente (avez-vous souvent vu Python install√© sur des machines, par exemple, des chefs d'entreprise ou des employ√©s de bureau?), Ou vous devez faire glisser un binaire pr√©-assembl√© sur cette machine (en fait python et le script dans une bouteille) et ex√©cutez ce binaire d√©j√† l√†.  Et le t√©l√©chargement d'exe avec son lancement ult√©rieur est √©galement la signature d'un antivirus local ou HIPS. <br><br>  En g√©n√©ral, la conclusion se sugg√®re - nous avons besoin d'une solution sur PowerShell.  Maintenant, les tomates vont nous voler - disent-ils PowerShell - tout est battu, il est surveill√©, bloqu√©, etc.  etc.  En fait - pas partout.  Nous d√©clarons de mani√®re responsable.  Soit dit en passant, il existe de nombreuses fa√ßons de contourner les verrous (ici encore la phrase √† la mode √† propos de bonjour √† l'ILV :)), √† partir du renommage stupide de powershell.exe -&gt; cmdd.exe et se terminant par powerdll, etc. <br><br><h3>  Commencez √† inventer </h3><br>  Il est clair que nous allons d'abord google et ... nous ne trouverons rien sur ce sujet (si quelqu'un a trouv√©, jetez des liens vers les commentaires).  Il n'y a qu'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">impl√©mentation de</a> Socks5 sur PowerShell, mais c'est le Sox ¬´direct¬ª habituel, qui a un certain nombre d'inconv√©nients (nous en parlerons plus tard).  Vous pouvez, bien s√ªr, le transformer en marche arri√®re avec un coup de poignet, mais ce ne sera qu'un Sox √† filetage unique, ce qui n'est pas exactement ce dont nous avons besoin. <br><br>  Donc, nous n'avons rien trouv√© de pr√™t, il nous reste donc √† inventer notre v√©lo.  Nous prendrons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notre d√©veloppement de</a> chaussettes invers√©es sur le golang comme base de notre v√©lo, et nous mettrons en ≈ìuvre le client pour celui-ci sur PowerShell. <br><br>  <b>RSocksTun</b> <br><br>  Alors, comment fonctionne rsockstun? <br><br>  Au c≈ìur du travail de RsocksTun (ci-apr√®s d√©nomm√© rs) se trouvent deux composants logiciels - Yamux et Socks5 server.  Le serveur Socks5 est un socks5 local r√©gulier, il s'ex√©cute sur le client.  Et le multiplexage des connexions (rappelez-vous du multithreading?) Est fourni √† l'aide de yamux ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">encore un autre multiplexeur</a> ).  Ce sch√©ma vous permet d'ex√©cuter plusieurs serveurs client socks5 et de leur distribuer des connexions externes, en les transf√©rant via une seule connexion TCP (presque comme dans meterpreter) du client vers le serveur, r√©alisant ainsi le mode multi-thread, sans lequel nous ne pouvons tout simplement pas travailler pleinement en interne r√©seau. <br><br>  L'essence de yamux est qu'il introduit un niveau r√©seau suppl√©mentaire de flux, le r√©alisant comme un en-t√™te de 12 octets pour chaque paquet.  (Ici, nous utilisons intentionnellement le mot ¬´stream¬ª, pas un stream, afin de ne pas confondre le lecteur avec le thread de programme ¬´thread¬ª - ce concept que nous utiliserons √©galement dans cet article).  √Ä l'int√©rieur de l'en-t√™te yamux contient le num√©ro de flux, les drapeaux pour d√©finir / terminer le flux, le nombre d'octets transf√©r√©s, la taille de la fen√™tre de transfert. <br><br><img src="https://habrastorage.org/webt/ga/go/we/gagowe129appe4mb67fwca2rumi.jpeg"><br><br>  En plus d'installer / compl√©ter le flux, yamux impl√©mente un m√©canisme keepalive qui vous permet de surveiller la sant√© du canal de communication install√©.  Le m√©canisme des messages keeplive est configur√© lors de la cr√©ation d'une session Yamux.  En fait, √† partir des param√®tres, il n'y a que deux param√®tres: activer / d√©sactiver et la fr√©quence d'envoi des paquets en quelques secondes.  Le serveur yamux peut envoyer des messages keepalive, donc le client yamux le peut.  Lors de la r√©ception d'un message keepalive, le correspondant distant est oblig√© d'y r√©pondre en envoyant exactement le m√™me identifiant de message (en fait un num√©ro) qu'il a re√ßu.  En g√©n√©ral, keepalive est le m√™me ping, uniquement pour yamux. <br><br>  L'ensemble de la technique de fonctionnement du multiplexeur est d√©taill√©: types de paquets, drapeaux d'installation et de terminaison, m√©canisme de transfert de donn√©es est d√©crit dans <a href="">la sp√©cification</a> yamux. <br><br><h3>  Conclusion de la premi√®re partie </h3><br>  Ainsi, dans la premi√®re partie de l'article, nous nous sommes familiaris√©s avec certains outils d'organisation des tunnels inverses, avons examin√© leurs avantages et leurs inconv√©nients, √©tudi√© le m√©canisme de fonctionnement du multiplexeur Yamux et d√©crit les exigences de base du module PowerShell nouvellement cr√©√©.  Dans la partie suivante, nous d√©velopperons le module lui-m√™me, pratiquement, √† partir de z√©ro.  √Ä suivre.  Ne changez pas :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453870/">https://habr.com/ru/post/fr453870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453860/index.html">AMD pr√©sente ses nouveaux processeurs 7 nm personnalis√©s Ryzen de troisi√®me g√©n√©ration</a></li>
<li><a href="../fr453862/index.html">Pourquoi vous devriez utiliser pathlib</a></li>
<li><a href="../fr453864/index.html">Utiliser une souris et un clavier sur des consoles, c'est tricher?</a></li>
<li><a href="../fr453866/index.html">Demande d'API avec React Hooks, HOC ou Render Prop</a></li>
<li><a href="../fr453868/index.html">Mini interrupteur tactile avec panneau en verre sur nRF52832</a></li>
<li><a href="../fr453872/index.html">Restauration de photos √† l'aide de r√©seaux de neurones</a></li>
<li><a href="../fr453874/index.html">De la roulette russe au LOTO s√©curis√©: comment prot√©ger le personnel du centre de donn√©es</a></li>
<li><a href="../fr453876/index.html">Comme dans Yandex.Practicum, le front desync a gagn√©: un num√©ro acrobatique avec Redux-Saga, postMessage et Jupyter</a></li>
<li><a href="../fr453882/index.html">Un excellent guide sur le m√©tier d'architecte de solutions (+ liste de liens utiles)</a></li>
<li><a href="../fr453884/index.html">Remplacement de la cam√©ra HYIP ou du reflex num√©rique?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>