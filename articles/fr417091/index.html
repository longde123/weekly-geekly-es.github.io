<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ≥Ô∏è ‚ùî üë©üèª‚Äç‚öñÔ∏è Cr√©ez un shader d'eau de dessin anim√© pour le Web. 3e partie üëãüèæ üôåüèø üòä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans la deuxi√®me partie, nous avons examin√© les lignes de flottabilit√© et de mousse. Dans cette derni√®re partie, nous appliquons la distorsion sous-ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ez un shader d'eau de dessin anim√© pour le Web. 3e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417091/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bbd/a8e/0b0/bbda8e0b0fe175450f789f2a7ec94304.gif" alt="image"></div><br>  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">deuxi√®me partie,</a> nous avons examin√© les lignes de flottabilit√© et de mousse.  Dans cette derni√®re partie, nous appliquons la distorsion sous-marine comme effet de post-traitement. <br><br><h2>  Effets de r√©fraction et de post-traitement </h2><br>  Notre objectif est de transmettre visuellement la r√©fraction de la lumi√®re dans l'eau.  Nous avons d√©j√† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">expliqu√©</a> comment cr√©er ce type de distorsion dans un fragment shader pour une sc√®ne 2D.  Ici, la seule diff√©rence est que nous devons comprendre quelle zone de l'√©cran est sous l'eau et lui appliquer uniquement de la distorsion. <br><br><h3>  Post-traitement </h3><br>  Dans le cas g√©n√©ral, l'effet de post-traitement est tout effet appliqu√© √† la sc√®ne enti√®re apr√®s son rendu, par exemple des nuances de couleur ou l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">effet d'un ancien √©cran CRT</a> .  Au lieu de rendre la sc√®ne directement √† l'√©cran, nous la rendons d'abord dans le tampon ou la texture, puis, en passant la sc√®ne √† travers notre shader, nous la rendons √† l'√©cran. <br><a name="habracut"></a><br>  Dans PlayCanvas, vous pouvez personnaliser cet effet de post-traitement en cr√©ant un nouveau script.  Appelons-le <strong>Refraction.js</strong> et copions ce mod√®le dedans comme un blanc: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//---------------   ------------------------// pc.extend(pc, function () { //  -      var RefractionPostEffect = function (graphicsDevice, vs, fs, buffer) { var fragmentShader = "precision " + graphicsDevice.precision + " float;\n"; fragmentShader = fragmentShader + fs; //      this.shader = new pc.Shader(graphicsDevice, { attributes: { aPosition: pc.SEMANTIC_POSITION }, vshader: vs, fshader: fs }); this.buffer = buffer; }; //      pc.PostEffect RefractionPostEffect = pc.inherits(RefractionPostEffect, pc.PostEffect); RefractionPostEffect.prototype = pc.extend(RefractionPostEffect.prototype, { //      render, //    ,    , //       render: function (inputTarget, outputTarget, rect) { var device = this.device; var scope = device.scope; //       .  ,     scope.resolve("uColorBuffer").setValue(inputTarget.colorBuffer); //       .       . //          pc.drawFullscreenQuad(device, outputTarget, this.vertexBuffer, this.shader, rect); } }); return { RefractionPostEffect: RefractionPostEffect }; }()); //---------------  ------------------------// var Refraction = pc.createScript('refraction'); Refraction.attributes.add('vs', { type: 'asset', assetType: 'shader', title: 'Vertex Shader' }); Refraction.attributes.add('fs', { type: 'asset', assetType: 'shader', title: 'Fragment Shader' }); //  initialize       Refraction.prototype.initialize = function() { var effect = new pc.RefractionPostEffect(this.app.graphicsDevice, this.vs.resource, this.fs.resource); //     postEffects var queue = this.entity.camera.postEffects; queue.addEffect(effect); this.effect = effect; //       this.savedVS = this.vs.resource; this.savedFS = this.fs.resource; }; Refraction.prototype.update = function(){ if(this.savedFS != this.fs.resource || this.savedVS != this.vs.resource){ this.swap(this); } }; Refraction.prototype.swap = function(old){ this.entity.camera.postEffects.removeEffect(old.effect); this.initialize(); };</span></span></code> </pre> <br>  Ceci est similaire √† un script standard, mais nous d√©finissons une classe <code>RefractionPostEffect</code> qui peut √™tre appliqu√©e √† la cam√©ra.  Pour le rendu, il a besoin de vertex et de fragment shaders.  Les attributs sont d√©j√† configur√©s, cr√©ons donc <strong>Refraction.frag</strong> avec le contenu suivant: <br><br><pre> <code class="javascript hljs">precision highp float; uniform sampler2D uColorBuffer; varying vec2 vUv0; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> main() { vec4 color = texture2D(uColorBuffer, vUv0); gl_FragColor = color; }</code> </pre> <br>  Et <strong>Refraction.vert</strong> avec un vertex shader de base: <br><br><pre> <code class="javascript hljs">attribute vec2 aPosition; varying vec2 vUv0; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> main(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { gl_Position = vec4(aPosition, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>); vUv0 = (aPosition.xy + <span class="hljs-number"><span class="hljs-number">1.0</span></span>) * <span class="hljs-number"><span class="hljs-number">0.5</span></span>; }</code> </pre> <br>  Attachez maintenant le script <strong>Refraction.js</strong> √† la cam√©ra et attribuez les attributs appropri√©s aux shaders.  Lorsque vous d√©marrez le jeu, vous verrez la sc√®ne de la m√™me mani√®re qu'auparavant.  Il s'agit d'un post-effet vide qui restitue simplement la sc√®ne.  Pour nous assurer que cela fonctionne, essayons de donner √† la sc√®ne une teinte rouge. <br><br>  Au lieu de simplement renvoyer la couleur √† Refraction.frag, essayez de d√©finir le composant rouge sur 1.0, ce qui devrait donner √† l'image l'image ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/981/b78/937/981b78937b536280aeacdb3ef8c33897.png"></div><br><h3>  Shader de distorsion </h3><br>  Pour cr√©er une distorsion anim√©e, nous devons ajouter une variable de temps uniforme, nous allons donc la cr√©er √† l'int√©rieur de ce constructeur post-effet dans Refraction.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RefractionPostEffect = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">graphicsDevice, vs, fs</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fragmentShader = <span class="hljs-string"><span class="hljs-string">"precision "</span></span> + graphicsDevice.precision + <span class="hljs-string"><span class="hljs-string">" float;\n"</span></span>; fragmentShader = fragmentShader + fs; <span class="hljs-comment"><span class="hljs-comment">//       this.shader = new pc.Shader(graphicsDevice, { attributes: { aPosition: pc.SEMANTIC_POSITION }, vshader: vs, fshader: fs }); // &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;    this.time = 0; };</span></span></code> </pre> <br>  Maintenant √† l'int√©rieur de la fonction de rendu, nous la passons √† notre shader pour l'augmenter: <br><br><pre> <code class="javascript hljs">RefractionPostEffect.prototype = pc.extend(RefractionPostEffect.prototype, { <span class="hljs-comment"><span class="hljs-comment">//      render, //      , //       render: function (inputTarget, outputTarget, rect) { var device = this.device; var scope = device.scope; //       .  ,     scope.resolve("uColorBuffer").setValue(inputTarget.colorBuffer); /// &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;    uniform-  scope.resolve("uTime").setValue(this.time); this.time += 0.1; //       .       . //          pc.drawFullscreenQuad(device, outputTarget, this.vertexBuffer, this.shader, rect); } });</span></span></code> </pre> <br>  Maintenant, nous pouvons utiliser le m√™me code de shader du didacticiel sur la distorsion de l'eau, transformant notre shader de fragment complet en ce qui suit: <br><br><pre> <code class="javascript hljs">precision highp float; uniform sampler2D uColorBuffer; uniform float uTime; varying vec2 vUv0; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> main() { vec2 pos = vUv0; float X = pos.x*<span class="hljs-number"><span class="hljs-number">15.</span></span>+uTime*<span class="hljs-number"><span class="hljs-number">0.5</span></span>; float Y = pos.y*<span class="hljs-number"><span class="hljs-number">15.</span></span>+uTime*<span class="hljs-number"><span class="hljs-number">0.5</span></span>; pos.y += cos(X+Y)*<span class="hljs-number"><span class="hljs-number">0.01</span></span>*cos(Y); pos.x += sin(XY)*<span class="hljs-number"><span class="hljs-number">0.01</span></span>*sin(Y); vec4 color = texture2D(uColorBuffer, pos); gl_FragColor = color; }</code> </pre> <br>  Si tout est fait correctement, alors l'image enti√®re devrait ressembler √† compl√®tement sous l'eau. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bbd/a8e/0b0/bbda8e0b0fe175450f789f2a7ec94304.gif"></div><br><blockquote>  <em>T√¢che 1: assurez-vous que la distorsion ne s'applique qu'au bas de l'√©cran.</em> </blockquote><br><h3>  Masques de cam√©ra </h3><br>  Nous avons presque fini.  Il nous reste √† appliquer cet effet de distorsion √† la partie sous-marine de l'√©cran.  La fa√ßon la plus simple √† laquelle j'ai pens√© est de restituer la sc√®ne avec la surface de l'eau rendue en blanc uni, comme le montre la figure ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/41e/06f/284/41e06f284290afbf768f6f615360c8bf.png"></div><br>  Il restituera la texture que nous utilisons comme masque.  Ensuite, nous transf√©rerons cette texture dans notre shader de r√©fraction, ce qui ne d√©formera le pixel de l'image finie que lorsque le pixel correspondant dans le masque sera blanc. <br><br>  Ajoutons un attribut bool√©en √† la surface de l'eau pour savoir s'il est utilis√© comme masque.  Ajoutez ce qui suit √† Water.js: <br><br><pre> <code class="javascript hljs">Water.attributes.add(<span class="hljs-string"><span class="hljs-string">'isMask'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">type</span></span>:<span class="hljs-string"><span class="hljs-string">'boolean'</span></span>,<span class="hljs-attr"><span class="hljs-attr">title</span></span>:<span class="hljs-string"><span class="hljs-string">"Is Mask?"</span></span>});</code> </pre> <br>  Ensuite, comme d'habitude, nous pouvons le passer au shader en utilisant <code>material.setParameter('isMask',this.isMask);</code>  .  D√©clarez-le ensuite dans Water.frag et coloriez le pixel en blanc si l'attribut est vrai. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    uniform uniform bool isMask; //      ,    //    true if(isMask){ color = vec4(1.0); }</span></span></code> </pre> <br>  Assurez-vous que cela fonctionne en activant la propri√©t√© ¬´Is Mask?¬ª.  dans l'√©diteur et red√©marrer le jeu.  Il devrait √™tre blanc, comme dans l'image ci-dessus. <br><br>  Maintenant, pour restituer la sc√®ne, nous avons besoin d'une deuxi√®me cam√©ra.  Cr√©ez une nouvelle cam√©ra dans l'√©diteur et appelez-la <strong>CameraMask</strong> .  Nous dupliquons √©galement l'entit√© Water dans l'√©diteur et <strong>nommons le WaterMask en</strong> double.  Assurez-vous que l'entit√© "L'eau est un masque?"  est faux et WaterMask est vrai. <br><br>  Pour commander le rendu d'une nouvelle cam√©ra sur une texture plut√¥t que sur un √©cran, cr√©ez un nouveau script <strong>CameraMask.js</strong> et attachez-le √† la nouvelle cam√©ra.  Nous cr√©ons un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">RenderTarget</a> pour capturer la sortie de cette cam√©ra: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  initialize       CameraMask.prototype.initialize = function() { //  512x512x24-      var colorBuffer = new pc.Texture(this.app.graphicsDevice, { width: 512, height: 512, format: pc.PIXELFORMAT_R8_G8_B8, autoMipmap: true }); colorBuffer.minFilter = pc.FILTER_LINEAR; colorBuffer.magFilter = pc.FILTER_LINEAR; var renderTarget = new pc.RenderTarget(this.app.graphicsDevice, colorBuffer, { depth: true }); this.entity.camera.renderTarget = renderTarget; };</span></span></code> </pre> <br>  Maintenant, apr√®s avoir lanc√© l'application, vous verrez que cette cam√©ra ne s'affiche plus √† l'√©cran.  Nous pouvons obtenir la sortie de son rendu cible dans <strong>Refraction.js</strong> comme suit: <br><br><pre> <code class="javascript hljs">Refraction.prototype.initialize = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cameraMask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.app.root.findByName(<span class="hljs-string"><span class="hljs-string">'CameraMask'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> maskBuffer = cameraMask.camera.renderTarget.colorBuffer; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> effect = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> pc.RefractionPostEffect(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.app.graphicsDevice, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.vs.resource, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fs.resource, maskBuffer); <span class="hljs-comment"><span class="hljs-comment">// ... //     ,    };</span></span></code> </pre> <br>  Notez que je passe cette texture de masque comme argument au constructeur post-effet.  Nous devons cr√©er un lien vers celui-ci dans notre constructeur, il ressemblera √† ceci: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">////       var RefractionPostEffect = function (graphicsDevice, vs, fs, buffer) { var fragmentShader = "precision " + graphicsDevice.precision + " float;\n"; fragmentShader = fragmentShader + fs; //       this.shader = new pc.Shader(graphicsDevice, { attributes: { aPosition: pc.SEMANTIC_POSITION }, vshader: vs, fshader: fs }); this.time = 0; //// &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;    this.buffer = buffer; };</span></span></code> </pre> <br>  Enfin, dans la fonction de rendu, nous passons le tampon √† notre shader: <br><br><pre> <code class="javascript hljs">scope.resolve(<span class="hljs-string"><span class="hljs-string">"uMaskBuffer"</span></span>).setValue(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.buffer);</code> </pre> <br>  Maintenant, pour m'assurer que tout cela fonctionne, je vous le laisse comme t√¢che. <br><br><blockquote>  T√¢che 2: restituez le uMaskBuffer √† l'√©cran pour vous assurer qu'il s'agit bien de la sortie de la deuxi√®me cam√©ra. </blockquote><br>  Les √©l√©ments suivants doivent √™tre pris en compte: le rendu cible est configur√© dans l'initialisation du script CameraMask.js et il doit √™tre pr√™t au moment de l'appel de Refraction.js.  Si les scripts fonctionnent diff√©remment, nous obtenons une erreur.  Pour vous assurer qu'ils fonctionnent dans le bon ordre, faites glisser CameraMask en haut de la liste d'entit√©s dans l'√©diteur, comme indiqu√© ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d8/093/747/2d80937472cd112108f303959c35d4c1.png"></div><br>  La deuxi√®me cam√©ra doit toujours avoir la m√™me vue que la cam√©ra d'origine, nous devons donc toujours suivre la position et la rotation du script CameraMask.js dans la mise √† jour: <br><br><pre> <code class="javascript hljs">CameraMask.prototype.update = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dt</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pos = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CameraToFollow.getPosition(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rot = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CameraToFollow.getRotation(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entity.setPosition(pos.x,pos.y,pos.z); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entity.setRotation(rot); };</code> </pre> <br>  Dans l'initialisation, d√©finissez <code>CameraToFollow</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CameraToFollow = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.app.root.findByName(<span class="hljs-string"><span class="hljs-string">'Camera'</span></span>);</code> </pre> <br><h3>  Masques d'√©cr√™tage </h3><br>  Les deux cam√©ras rendent maintenant la m√™me chose.  Nous voulons que la cam√©ra masque rende tout sauf l'eau r√©elle, et la vraie cam√©ra rende tout sauf l'eau masque. <br><br>  Pour ce faire, nous pouvons utiliser le masque d'√©cr√™tage de la cam√©ra.  Il fonctionne de mani√®re similaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">aux masques anti-collision</a> .  Un objet sera d√©coup√© (c'est-√†-dire non rendu) si le r√©sultat d'un <code>AND</code> du bit entre son masque et le masque de la cam√©ra est 1. <br><br>  Supposons que Water a le bit 2, WaterMask a le bit 3. Tous les bits sauf 3 doivent √™tre d√©finis pour une cam√©ra r√©elle et tous les bits sauf 2 pour une cam√©ra masque. La fa√ßon la plus simple de dire ¬´tous les bits sauf N¬ª est la suivante fa√ßon: <br><br><pre> <code class="javascript hljs">~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; N) &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  En savoir plus sur les op√©rations au niveau du bit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">ici</a> . <br><br>  Pour configurer les masques d'√©cr√™tage de cam√©ra, nous pouvons ins√©rer ce qui suit au bas de l'initialisation du script <strong>CameraMask.js</strong> : <br><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//   ,  2 this.entity.camera.camera.cullingMask &amp;= ~(1 &lt;&lt; 2) &gt;&gt;&gt; 0; //   ,  3 this.CameraToFollow.camera.camera.cullingMask &amp;= ~(1 &lt;&lt; 3) &gt;&gt;&gt; 0; //      ,   : // console.log((this.CameraToFollow.camera.camera.cullingMask &gt;&gt;&gt; 0).toString(2));</span></span></code> </pre> <br>  Maintenant, dans Water.js, nous allons d√©finir le bit 2 du masque du maillage Water, et sa version de masque sur le bit 3: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      initialize  Water.js //    var bit = this.isMask ? 3 : 2; meshInstance.mask = 0; meshInstance.mask |= (1 &lt;&lt; bit);</span></span></code> </pre> <br>  Maintenant, une esp√®ce sera avec de l'eau claire et la seconde avec de l'eau blanche solide.  L'image de gauche montre la vue de la cam√©ra d'origine et √† droite la vue de la cam√©ra de masque. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d55/e1b/271/d55e1b271351df16edab549ca065837f.png"></div><br><h3>  Application de masque </h3><br>  Et maintenant la derni√®re √©tape!  Nous savons que les zones sous-marines sont marqu√©es de pixels blancs.  Nous avons juste besoin de v√©rifier si nous sommes dans un pixel blanc, et sinon, d√©sactivez la distorsion dans <strong>Refraction.frag</strong> : <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,      vec4 maskColor = texture2D(uMaskBuffer, pos); vec4 maskColor2 = texture2D(uMaskBuffer, vUv0); //     ? if(maskColor != vec4(1.0) || maskColor2 != vec4(1.0)){ //      pos = vUv0; }</span></span></code> </pre> <br>  Et cela devrait r√©soudre notre probl√®me! <br><br>  <em>Il convient √©galement de noter que, puisque la texture du masque est initialis√©e au d√©marrage, lorsque vous redimensionnez la fen√™tre au moment de l'ex√©cution, elle ne correspondra plus √† la taille de l'√©cran.</em> <br><br><h3>  Lissage </h3><br>  Vous remarquerez peut-√™tre que les bords de la sc√®ne sont maintenant un peu nets.  Cela est arriv√© car apr√®s avoir appliqu√© le post-effet, nous avons perdu le lissage. <br><br>  Nous pouvons appliquer un lissage suppl√©mentaire au-dessus de notre effet comme un autre post-effet.  Heureusement, il existe une autre variable dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">magasin PlayCanvas</a> que nous pouvons utiliser.  Acc√©dez √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">page des actifs de script</a> , cliquez sur le gros bouton de t√©l√©chargement vert et s√©lectionnez votre projet dans la liste qui appara√Æt.  Le script appara√Ætra √† la racine de la fen√™tre Actifs sous le nom <strong>posteffect-fxaa.js</strong> .  Attachez-le simplement √† l'entit√© Appareil photo et votre sc√®ne commencera √† para√Ætre beaucoup mieux! <br><br><h2>  R√©flexions en conclusion </h2><br>  Si vous arrivez ici, vous pouvez vous f√©liciter!  Dans ce didacticiel, nous avons couvert plusieurs techniques.  Vous devez maintenant vous sentir en confiance lorsque vous travaillez avec des vertex shaders, le rendu dans les textures, l'application d'effets de post-traitement, l'√©cr√™tage s√©lectif d'objets, l'utilisation du tampon de profondeur et le travail avec le m√©lange et la transparence.  Bien que nous ayons impl√©ment√© tout cela dans PlayCanvas, vous pouvez rencontrer tous ces concepts g√©n√©raux de l'infographie sous une forme ou une autre sur n'importe quelle plate-forme. <br><br>  Toutes ces techniques sont √©galement applicables √† de nombreux autres effets.  Une application particuli√®rement int√©ressante trouv√©e pour les vertex shaders, que j'ai trouv√©e dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">rapport sur le graphique Abzu</a> , o√π les d√©veloppeurs expliquent comment ils ont utilis√© les vertex shaders pour animer efficacement des dizaines de milliers de poissons √† l'√©cran. <br><br>  Maintenant, vous avez un bel effet d'eau que vous pouvez appliquer dans vos jeux!  Vous pouvez le personnaliser et ajouter vos propres d√©tails.  Beaucoup plus peut √™tre fait avec de l'eau (je n'ai m√™me pas mentionn√© de types de reflets).  Voici quelques id√©es. <br><br><h4>  Ondes sonores </h4><br>  Au lieu d'animer simplement les vagues avec une combinaison de cosinus et de sinus, vous pouvez √©chantillonner la texture de sorte que les vagues semblent un peu plus naturelles et moins pr√©visibles. <br><br><h4>  Traces dynamiques de mousse </h4><br>  Au lieu de lignes d'eau compl√®tement statiques √† la surface, vous pouvez dessiner dans la texture lorsque vous d√©placez des objets pour cr√©er des traces dynamiques de mousse.  Cela peut √™tre fait de diff√©rentes mani√®res, de sorte que cette t√¢che en soi peut devenir un projet. <br><br><h2>  Code source </h2><br>  Le projet PlayCanvas termin√© peut √™tre trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">ici</a> .  Notre r√©f√©rentiel poss√®de √©galement un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="external">port de projet sous Three.js</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417091/">https://habr.com/ru/post/fr417091/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417081/index.html">Nord, volont√©, espoir, pays sans fronti√®res, ou comment les projets sont r√©alis√©s dans des conditions sib√©riennes s√©v√®res</a></li>
<li><a href="../fr417083/index.html">Fortes charges de la Coupe du monde 2018</a></li>
<li><a href="../fr417085/index.html">Les navigateurs coupent le son dans votre application WebRTC. Arr√™te quoi?</a></li>
<li><a href="../fr417087/index.html">HPE Digitize 2018: √©v√©nement et diffusion en direct</a></li>
<li><a href="../fr417089/index.html">Ordinateur quantique: un photon pour tout gouverner</a></li>
<li><a href="../fr417093/index.html">Interrupteurs tactiles avec Modbus: pourquoi sont-ils n√©cessaires et comment les appliquer dans un appartement intelligent</a></li>
<li><a href="../fr417097/index.html">M√©taprogrammation JavaScript</a></li>
<li><a href="../fr417099/index.html">Comment ai-je √©crit la biblioth√®que C ++ 11 standard ou pourquoi boost est si effrayant. Chapitre 2</a></li>
<li><a href="../fr417101/index.html">D√©finition de pr√™t - ce que nous avons oubli√© de dire</a></li>
<li><a href="../fr417103/index.html">Spark SQL. Un peu sur l'optimiseur de requ√™tes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>