<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèôÔ∏è üë®üèΩ‚Äçüéì ü§úüèø Hitachi meurt dur, bash et techno-n√©crophilie ü§±üèæ ‚úåüèª ‚òÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Attention: la solution d√©crite dans cet article n'est pas professionnelle, elle a peut-√™tre √©t√© cr√©√©e sur la base d'une mauvaise compr√©hension de la s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hitachi meurt dur, bash et techno-n√©crophilie</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481952/"><p>  Attention: la solution d√©crite dans cet article n'est pas professionnelle, elle a peut-√™tre √©t√© cr√©√©e sur la base d'une mauvaise compr√©hension de la structure et des principes de fonctionnement des disques durs.  La r√©p√©tition des √©tapes ci-dessus peut endommager l'√©quipement. </p><br><p>  R√©cemment, je suis tomb√© sur un <a href="https://habr.com/ru/post/443612/">article</a> sur l'utilisation de vieux disques durs avec de mauvais blocs et j'ai pens√© que mon exp√©rience pourrait √©galement √™tre int√©ressante pour quelqu'un. </p><br><p>  Une fois, des connaissances m'ont demand√© d'aider √† g√©rer un ordinateur portable sur lequel elles ne pouvaient pas r√©installer Windows.  L'ordinateur portable, √† en juger par l'apparence, a eu une vie difficile: fissures dans le bo√Ætier, coins bossel√©s, supports cass√©s.  Il est clair que le probl√®me est l'endommagement du disque dur √† la suite de nombreux coups, ce qui a √©galement √©t√© confirm√© par smart: plus de 200 op√©rations de capteur G, 500 d√©comptes de secteur r√©affect√©s et il y a toujours en attente de courant.  Eh bien, les gens, bien s√ªr, j'ai install√© le SSD et copi√© les informations de leur vis dans l'image avec la commande: </p><br><pre><code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/sdb of=/media/hddimages/ht320.img bs=409600 conv=noerror,notrunc,sync</code> </pre> <br><p><a name="habracut"></a>  Les param√®tres "conv = noerror, notrunc, sync" sont n√©cessaires pour qu'en cas d'erreur de lecture de certains secteurs, des z√©ros soient √©crits √† ces adresses dans le fichier de sortie, et les donn√©es soient √©crites √† leur place sans biais. </p><br><p>  Il arrive que lors de la lecture en gros blocs (400 Ko), le disque ne lit pas le bloc entier, et les plus petits ne lisent pas seulement 1 secteur.  Les secteurs ici sont de 4 ko, donc apr√®s le premier passage de dd, s'il y avait des erreurs de lecture, j'essaye de relire ces sections en blocs de 4 ko: </p><br><pre> <code class="bash hljs">n=&lt;&gt;;dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/sdb of=/media/hddimages/ht320.img bs=4096 conv=noerror,notrunc,sync skip=<span class="hljs-variable"><span class="hljs-variable">$n</span></span> seek=<span class="hljs-variable"><span class="hljs-variable">$n</span></span> count=100</code> </pre> <br><p>  Les param√®tres de saut et de recherche sont n√©cessaires pour que la lecture et l'√©criture commencent par le m√™me retrait √† partir du d√©but du disque.  L'indentation elle-m√™me est tir√©e de la sortie de la premi√®re ex√©cution dd, uniquement pour correspondre √† la taille du bloc, multipliez le nombre par 100. </p><br><p>  Parfois, lors de l'acc√®s √† des secteurs d√©fectueux, les disques g√®lent pendant longtemps, √† tel point que seule la reconnexion √† l'alimentation aide et il y a environ 5 ans, un complexe mat√©riel-logiciel (avec m√™me un microcontr√¥leur) a √©t√© cr√©√© pour automatiser la lecture des mauvais disques avec une reconnexion automatique de l'alimentation en cas de trop un long manque de r√©ponse.  C'√©tait int√©ressant et permis, en connectant le disque dur et en entrant la commande, apr√®s 10 jours d'obtenir l'image la plus compl√®te.  Mais le h√©ros exp√©rimental de l'article n'a pas tenu bon, il n'√©tait donc pas n√©cessaire d'obtenir la b√©quille lourde d√©crite. </p><br><p>  Donc, le disque a √©t√© consid√©r√©, j'ai mont√© toutes les sections de l'image via losetup avec les d√©calages du d√©but des partitions de fdisk, multipli√©s par la taille du bloc logique en MBR - 512 octets, je copie toutes les donn√©es aux personnes sur un nouveau SSD.  Si le disque n'√©tait pas mont√© ou que de nombreux fichiers ne pouvaient pas √™tre lus, j'ouvrirais l'image avec R-Studio et la restaurerais √† travers elle, mais √† partir de l'image elle-m√™me. </p><br><p>  Mais le disque, bien qu'il soit battu, est dommage √† jeter, alors j'ai d√©cid√© de le r√©animer.  Th√©oriquement, le contr√¥leur de disque marque les secteurs comme endommag√©s et r√©affecte les secteurs de sauvegarde √† leurs adresses en cas de tentatives r√©p√©t√©es infructueuses d'√©criture ou d'erreurs de lecture irr√©cup√©rables (√† l'aide d'ECC). </p><br><p>  J'essaie d'abord d'essuyer le disque (dd if = / dev / zero ...) et de lire ensuite: la vitesse est √©galement instable, le disque se fige et parfois des erreurs d'entr√©e / sortie se produisent, mais dans la puce, le nombre de relocks et de suspensions augmente.  Apr√®s plusieurs cycles, la puce n'a pas beaucoup chang√©, les suspensions ne se sont pas d√©plac√©es et des blocages avec des erreurs se produisent √† chaque fois aux m√™mes endroits ou tr√®s proches.  J'essaie de remapper manuellement de force avec la commande "hdparm --make-bad-sector", mais cela ne fonctionne pas sur ce mod√®le et je me rends compte que l'effacement-lecture, ainsi que l'√©criture-lecture, ne sera pas en mesure d'afficher tous les probl√®mes.  En effet, si un bit endommag√©, quel que soit ce qu'il a essay√© d'y √©crire, est plus susceptible de se lire comme "1", alors lors de l'√©criture, "1", la lecture suivante se fera sans erreur, mais lors de l'√©criture d'un mod√®le diff√©rent, il peut il y a suffisamment d'incoh√©rences pour que l'ECC √©choue et qu'une erreur de lecture irr√©parable se produise, et apr√®s plusieurs de ces cas, le secteur a re√ßu le statut "Mauvais".  Soit dit en passant, la valeur enregistr√©e peut √™tre si superpos√©e √† la distribution des bits endommag√©s qu'une valeur incorrecte de lecture satisfera m√™me l'ECC.  Par cons√©quent, pour maximiser l'identification de tous les secteurs d√©fectueux, vous devez g√©n√©rer un mod√®le relativement al√©atoire, l'√©crire sur le disque, lire et comparer la valeur.  Il existe √©galement des secteurs instables, qui changent leurs valeurs progressivement au fil du temps ou apr√®s traitement de ses voisins. </p><br><p>  Compte tenu de tout ce qui pr√©c√®de, j'ai d√©cid√© de mettre en ≈ìuvre la strat√©gie suivante dans un script bash: </p><br><ul><li>  nous g√©n√©rons un mod√®le al√©atoire et consid√©rons la somme de contr√¥le pour cela; </li><li>  nous lisons intelligemment; </li><li>  √©crire un disque en z√©ros; </li><li>  lire le disque; </li><li>  nous √©crivons un disque de fa√ßon al√©atoire en lisant le bloc qui vient d'√™tre enregistr√© et en comparant sa somme de contr√¥le; </li><li>  nous lisons le disque apr√®s l'enregistrement complet, en v√©rifiant les sommes de contr√¥le de chaque bloc; </li><li>  nous lisons intelligemment; </li><li>  auto-test; </li><li>  goto 1. </li></ul><br><p>  Nous continuons ainsi jusqu'√† ce que les secteurs mal lus et les erreurs d'E / S cessent de se produire ou jusqu'√† ce que la vis soit compl√®tement recouverte.  Soit dit en passant, comment fonctionne l'autotest pour ce mod√®le de disque, je ne peux pas imaginer;  Je ne sais pas combien de temps diff√®re de short'a (bien que probablement long avec toute la surface, et court - en se concentrant sur les statistiques pr√©c√©demment collect√©es, comme avec le formatage: complet et rapide).  J'esp√®re que cela encourage la vis √† prendre en compte les exp√©riences r√©centes et √† remapper les mauvais secteurs. </p><br><p>  Quand j'ai fini d'√©crire le script bash, je l'ai ex√©cut√© et v√©rifi√© les r√©sultats le lendemain - j'ai vu que la v√©rification fonctionne tr√®s lentement, tandis que la charge du processeur n'atteint 60% sur aucun c≈ìur.  Cela m'a fait jouer avec la taille du bloc, tester diff√©rents algorithmes de hachage pour les sommes de contr√¥le, essayer la v√©rification directe des diff√©rences et ne pas comparer les sommes de contr√¥le, mais je n'ai pas pu atteindre des vitesses de traitement sup√©rieures √† 12 m√©gaoctets par seconde.  En cons√©quence, je me suis arr√™t√© √† comparer des blocs de 400 Ko avec diff, et je ne calcule les sommes de contr√¥le qu'en cas de non-correspondance uniquement pour l'analyse ult√©rieure du journal. </p><br><div class="spoiler">  <b class="spoiler_title">Le script s'est av√©r√© comme ceci:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #    hddtest.sh diskdev logfile [blocksize] diskdev="$1"; test_log="$2"; #"~/work/hdd/test.log" blsz="${409600:-$3}"; n="1"; sizebyte=`fdisk -l "$diskdev"|grep "Disk $diskdev:"|cut -d" " -f5`; let sizebl=$sizebyte/$blsz; #"781428" for 320GB while true;do echo "starting iteration $n"; dd if=/dev/urandom of=fil bs="$blsz" count=1; md5ok=`md5sum fil|cut -d" " -f1`; cp fil fil_"$n"; echo "random pattern md5sum $md5ok"&gt;&gt;"$test_log"; smartctl -A "$diskdev"&gt;&gt;"$test_log"; echo "filling disk with zeroes"&gt;&gt;"$test_log"; dd if=/dev/zero of="$diskdev" bs="$blsz"; #count="$sizebl"; echo "disk is wiped fully"&gt;&gt;"$test_log"; dd of=/dev/null if="$diskdev" bs="$blsz"; # count="$sizebl"; echo "writing disk with fil-pattern"&gt;&gt;"$test_log"; i="0"; while [ "$i" -le "$sizebl" ]; do #echo "writing fil: $i "&gt;&gt;"$test_log"; dd if=fil of="$diskdev" bs="$blsz" seek="$i"; dd if=/dev/null of=tst; dd if="$diskdev" bs="$blsz" of=tst skip="$i" count=1 conv=notrunc,noerror,sync; #md5tst=`md5sum tst|cut -d" " -f1`; verf=`diff -s fil tst|sed 's/.* //g'`; if [ "$verf" != "identical" ]; #if [ "$md5ok" != "$md5tst" ]; then md5tst=`md5sum tst|cut -d" " -f1`; echo "$i : md5 $md5tst is not ok"&gt;&gt;"$test_log"; cp tst tst_"$n"_"$i"; fi; let i="$i"+1; done; echo "test of full writed with fil-pattern disk"&gt;&gt;"$test_log"; i="0"; while [ "$i" -le "$sizebl" ]; do #echo "after writing test: $i"&gt;&gt;"$test_log"; dd if=/dev/null of=tst; dd if="$diskdev" bs="$blsz" of=tst skip="$i" count=1 conv=notrunc,noerror,sync; #md5tst=`md5sum tst|cut -d" " -f1`; verf=`diff -s fil tst|sed 's/.* //g'`; if [ "$verf" != "identical" ]; #if [ "$md5ok" != "$md5tst" ]; then md5tst=`md5sum tst|cut -d" " -f1`; echo "$i : md5 $md5tst is not ok"&gt;&gt;"$test_log"; cp tst tst_"$n"_"$i"; fi; let i="$i"+1; done; smartctl -A "$diskdev" &gt;&gt;"$test_log"; smartctl -t long "$diskdev"&gt;&gt;"$test_log"; sleep 5000; #smartctl -t short "$diskdev"&gt;&gt;"$test_log"; #sleep 240; let n="$n"+1; done</span></span></code> </pre></div></div><br><p>  Comme les journaux l'ont montr√© apr√®s l'ex√©cution r√©p√©t√©e du script, tous les secteurs d√©fectueux se trouvaient dans les 13 premiers Go du disque, il y avait plusieurs "foyers" de d√©faite (probablement, lorsque la t√™te a frapp√©, la surface a √©t√© ray√©e et ray√©e).  Pour les 15 derni√®res ex√©cutions, le disque n'a pas vu de secteurs en attente, tout a d√©j√† √©t√© remapp√©, mais quelque part au milieu du 13e gigaoctet, un bloc ou des blocs non loin de lui ont √©t√© lus de mani√®re incorrecte √† diff√©rentes adresses.  De plus, un bloc peut √™tre consid√©r√© comme incorrect pendant 2 cycles cons√©cutifs, puis 2 fois correctement et encore incorrectement.  Donc, attraper les 10 derniers secteurs d√©fectueux a √©t√© une longue op√©ration.  Au total, 1268 secteurs ont √©t√© remapp√©s!  Et √† la fin, une surprise m'attendait: lorsque tout fonctionnait d√©j√† de mani√®re stable, apr√®s le prochain autotest, le param√®tre Nombre de secteurs r√©affect√©s devenait "0" et seuls le Nombre d'√©v√©nements r√©affect√©s et les enregistrements des 5 derni√®res erreurs (avec adresse et heure √† partir de commencer √† travailler) stock√© dans le journal. </p><br><p>  Malgr√© le fonctionnement stable, j'ai n√©anmoins d√©cid√© de minimiser l'interaction avec la zone endommag√©e afin de ne pas blesser la t√™te sur d'√©ventuelles irr√©gularit√©s dans des endroits avec une surface endommag√©e des plaques, et je ne voulais pas faire confiance aux secteurs locaux √† long terme.  Je viens de reculer un peu avec une marge et j'ai cr√©√© une partition commen√ßant par le 15e gigaoctet.  Et, comme le temps l'a montr√©, le disque se sent plut√¥t bien et fonctionne de mani√®re stable dans un ordinateur portable portable depuis 10 mois. </p><br><p>  Bien qu'il soit impossible de faire enti√®rement confiance au disque restaur√© et que la faisabilit√© √©conomique de l'entreprise soit douteuse, le r√©sultat n'est parfois qu'un ajout agr√©able √† la bonne voie. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481952/">https://habr.com/ru/post/fr481952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481942/index.html">Retour vers le futur: quel jeu moderne a √©t√© pr√©sent√© en 2010</a></li>
<li><a href="../fr481944/index.html">Qu'est-ce qui d√©termine la position du site sur la page de recherche?</a></li>
<li><a href="../fr481946/index.html">M√©thodes de communication dans les √©quipes Microsoft: canaux vs chats</a></li>
<li><a href="../fr481948/index.html">Comment cr√©er un robot virtuel?</a></li>
<li><a href="../fr481950/index.html">Tutoriel: Boot de printemps r√©actif</a></li>
<li><a href="../fr481954/index.html">Comment et pourquoi puis-je pirater la VR</a></li>
<li><a href="../fr481956/index.html">√Ä la recherche du programmeur manquant. Qu√™te du nouvel an</a></li>
<li><a href="../fr481958/index.html">Quand √™tes-vous signataire dans mail.ru ou comment traverser un tank T-34 avec une interface mail</a></li>
<li><a href="../fr481960/index.html">2. Pile √©lastique: analyse des journaux de s√©curit√©. Logstash</a></li>
<li><a href="../fr481964/index.html">Comment organiser une sortie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>