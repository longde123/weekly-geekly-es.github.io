<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïê ‚ôøÔ∏è üßÄ Utiliser asyncio pour cr√©er des pilotes de p√©riph√©riques asynchrones sur MicroPython v.1.12 üìä üíå ‚ôëÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En √©tudiant les possibilit√©s de MicroPython √† ses fins, je suis tomb√© sur l'une des impl√©mentations de la biblioth√®que asyncio et, apr√®s une br√®ve cor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utiliser asyncio pour cr√©er des pilotes de p√©riph√©riques asynchrones sur MicroPython v.1.12</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484472/"> <i>En √©tudiant les possibilit√©s de <b>MicroPython</b> √† ses fins, je suis tomb√© sur l'une des impl√©mentations de la biblioth√®que <b>asyncio</b> et, apr√®s une br√®ve correspondance avec <b>Piter Hinch</b> , l'auteur de la biblioth√®que, j'ai r√©alis√© que je devais comprendre plus profond√©ment les principes, les concepts de base et les erreurs typiques d'utilisation des m√©thodes de programmation asynchrones.</i>  <i>De plus, la section pour d√©butants est juste pour moi.</i> <br><br>  Ce guide est destin√© aux utilisateurs ayant diff√©rents niveaux d'exp√©rience avec <i><b>asyncio</b></i> , y compris une section sp√©ciale pour les d√©butants. <br><a name="habracut"></a><br>  <b>Table des mati√®res</b> <br>  <b>0. Introduction</b> <br>  0.1 <i><b>.___</b></i> Installer <i><b>uasyncio</b></i> sur un appareil vide (mat√©riel) <br>  <b>1. Planification de l'ex√©cution conjointe du programme</b> <br>  1.1 .___ Modules <br>  <b>2. biblioth√®que <i>uasyncio</i></b> <br>  2.1 .___ Structure du programme: cycle de traitement des √©v√©nements <br>  2.2 .___ Coroutines <br>  2.2.1 .______ Mise en file d'attente des <i>coroutines pour participer √† la planification</i> <br>  2.2.2 .______ <i>D√©marrage d'un <i>rappel de</i> fonction ( <i>rappel</i> )</i> <br>  2.2.3 .______ <i>Notes: les coroutines comme m√©thodes apparent√©es.</i>  <i>Les valeurs de retour.</i> <br>  2.3 .___ Retards <br>  <b>3. La synchronisation et ses classes</b> <br>  3.1 .___ Lock <i><b>Lock</b></i> <br>  3.1.1 .______ <i>Verrous et d√©lais</i> <br>  3.2 .___ <i><b>√âv√©nement</b></i> <br>  3.2.1 .______ <i>Valeur de l'</i> √©v√©nement <br>  3.3 .___ Barri√®re <i><b>Barri√®re</b></i> <br>  3.4 .___ <i><b>S√©maphore</b></i> <br>  3.4.1 .______ <i>S√©maphore limit√©</i> <br>  3.5 .___ File d' <i><b>attente</b></i> File d' <i><b>attente</b></i> <br>  3.6 .___ Autres classes de synchronisation <br>  <b>4. D√©veloppement de classe pour <i>asyncio</i></b> <br>  4.1 .___ Classes utilisant <i>wait</i> <br>  4.1.1 .______ <i>Utilisation dans les gestionnaires de contexte</i> <br>  4.1.2 .______ Attendre <i>dans la coroutine</i> <br>  4.2 .___ It√©rateurs asynchrones <br>  4.3 .___ Gestionnaires de contexte asynchrones <br>  <b>5. Exceptions aux d√©lais d'attente et en raison des annulations de t√¢ches</b> <br>  5.1 .___ Exceptions <br>  5.2 .___ Exceptions en raison de d√©lais d'attente et en raison de l'annulation de t√¢ches <br>  5.2.1 .______ <i>Annuler les t√¢ches</i> <br>  5.2.2 .______ <i>Coroutines avec timeouts</i> <br>  <b>6. Interaction avec les p√©riph√©riques mat√©riels</b> <br>  6.1 .___ Probl√®mes de synchronisation <br>  6.2 .___ Dispositifs d'interrogation avec coroutines <br>  6.3 .___ Utilisation du moteur de streaming <br>  6.3.1 .______ <i>Exemple de pilote UART</i> <br>  6.4 .___ D√©veloppement de pilotes pour un p√©riph√©rique de streaming <br>  6.5 <i>.___</i> Exemple complet: pilote <i>aremote.py</i> pour r√©cepteur de t√©l√©commande infrarouge. <br>  6.6 .___ Driver pour capteur de temp√©rature et d'humidit√© HTU21D. <br>  <b>7. Trucs et astuces</b> <br>  7.1 .___ Le programme se bloque <br>  7.2 <b><i>.___ uasyncio</i></b> enregistre l'√©tat <br>  7.3 .___ Collecte des ordures <br>  7.4 .___ Test <br>  7.5 .___ Erreur courante.  Cela peut √™tre difficile √† trouver. <br>  7.6 .___ Programmation √† l'aide de sockets ( <i>sockets</i> ) <br>  7.6.1 .______ Probl√®mes <i>WiFi</i> <br>  7.7 .___ Arguments du constructeur de la boucle d'√©v√©nement <br>  <b>8. Notes pour les d√©butants</b> <br>  8.1 .___ Probl√®me 1: boucles d'√©v√©nements <br>  8.2 .___ Probl√®me 2: m√©thodes de verrouillage <br>  8.3 <b><i>.___</i></b> L'approche <b><i>uasyncio</i></b> <br>  8.4 <b><i>.___</i></b> Planification dans <b><i>uasyncio</i></b> <br>  8.5 .___ Pourquoi une planification collaborative et non bas√©e sur les <i>threads</i> ( <i>_thread</i> )? <br>  8.6 .___ Interaction <br>  8.7 .___ <i>Interrogation</i> <br><br>  <b>0. Introduction</b> <br><br>  La plupart de ce document suppose une certaine familiarit√© avec la programmation asynchrone.  Pour les d√©butants, une introduction peut √™tre trouv√©e dans la section 7. <br><br>  La biblioth√®que <i><b>uasyncio</b></i> pour <b>MicroPython</b> comprend un sous-ensemble de la biblioth√®que <b><i>asyncio</i></b> <b>Python</b> et est destin√©e √† √™tre utilis√©e sur les microcontr√¥leurs.  En tant que tel, il prend une petite quantit√© de RAM et est configur√© pour changer rapidement de contexte avec une allocation de RAM nulle. <br><br>  Ce document d√©crit l'utilisation de <i><b>uasyncio</b></i> en mettant l'accent sur la cr√©ation de pilotes pour les p√©riph√©riques mat√©riels. <br><br>  L'objectif est de concevoir les pilotes pour que l'application continue de fonctionner pendant que le pilote attend une r√©ponse de l'appareil.  Dans le m√™me temps, l'application reste sensible aux autres √©v√©nements et √† l'interaction de l'utilisateur. <br><br>  Un autre domaine d'application important d' <b><i>Asyncio</i></b> est la programmation r√©seau: sur Internet, vous pouvez trouver suffisamment d'informations sur ce sujet. <br><br>  Notez que <b>MicroPython est</b> bas√© sur <b>Python 3.4</b> avec les modules compl√©mentaires <b>Python 3.5</b> minimum.  Sauf comme d√©taill√© ci-dessous, les fonctions des versions <b><i>asyncio</i></b> ant√©rieures √† 3.4 ne sont pas prises en charge.  Ce document d√©finit les fonctionnalit√©s prises en charge dans ce sous-ensemble. <br><br>  Le but de ce guide est d'introduire un style de programmation compatible avec <b>CPython V3.5</b> et sup√©rieur. <br><br>  <b>0.1 Installer <b><i>uasyncio</i></b> sur un appareil vide (mat√©riel)</b> <br><br>  Il est recommand√© d'utiliser le firmware <b>MicroPython V1.11</b> ou version ult√©rieure.  Sur de nombreuses plates-formes, l'installation n'est pas requise, car <b><i>uasyncio¬Æ est</i></b> d√©j√† compil√© dans l'assemblage.  Pour v√©rifier, tapez simplement REPL <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio</code> </pre> <br>  Les instructions suivantes couvrent les cas o√π les modules ne sont pas pr√©install√©s.  Les <b><i>files d'attente</i></b> et les modules de <b><i>synchronisation</i></b> sont facultatifs, mais sont n√©cessaires pour ex√©cuter les exemples donn√©s ici. <br><br>  <b>Appareil connect√© √† Internet</b> <br><br>  Sur un appareil connect√© √† Internet et ex√©cutant le micrologiciel V1.11 ou version ult√©rieure, vous pouvez effectuer l'installation √† l'aide de la version <i>int√©gr√©e upip</i> .  Assurez-vous que l'appareil est connect√© √† votre r√©seau: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> upip upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio'</span></span> ) upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio.synchro'</span></span> ) upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio.queues'</span></span> )</code> </pre><br>  Les messages d'erreur de <i>upip</i> ne <i>sont</i> pas tr√®s utiles.  Si vous obtenez une erreur incompr√©hensible, v√©rifiez √† nouveau la connexion Internet. <br><br>  <b>Mat√©riel sans connexion Internet ( <i>micropip</i> )</b> <br><br>  Si le p√©riph√©rique <b>n'a</b> pas de connexion Internet (par exemple, <b>Pyboard V1.x</b> ), le moyen le plus simple consiste √† d√©marrer l'installation de <i>micropip.py</i> sur l'ordinateur dans le r√©pertoire de votre choix, puis √† copier la structure de r√©pertoires r√©sultante sur le p√©riph√©rique cible.  L'utilitaire <i>micropip.py</i> s'ex√©cute sur <b>Python 3.2</b> ou version ult√©rieure et s'ex√©cute sur Linux, Windows et OSX.  Plus d'informations peuvent √™tre trouv√©es <a href="https://github.com/peterhinch/micropython-samples/tree/master/micropip" rel="nofollow">ici</a> . <br><br>  Appel typique: <br><br><pre> <code class="python hljs">$ micropip.py install -p ~/rats micropython-uasyncio $ micropip.py install -p ~/rats micropython-uasyncio.synchro $ micropip.py install -p ~/rats micropython-uasyncio.queues</code> </pre><br>  <b>Un appareil sans connexion Internet (source de copie)</b> <br><br>  Si vous n'utilisez pas <i>micropip.py</i> , les fichiers doivent √™tre copi√©s √† partir de la source.  Les instructions suivantes d√©crivent comment copier le nombre minimum de fichiers sur le p√©riph√©rique cible, ainsi que le cas o√π <b><i>uasyncio</i></b> doit √™tre compress√© dans un assemblage compil√© sous forme de bytecode pour r√©duire l'espace occup√©.  Pour la derni√®re version compatible avec le firmware officiel, les fichiers doivent √™tre copi√©s depuis le site officiel de <a href="http://github.com/micropython/micropython-lib" rel="nofollow">micropython-lib</a> . <br><br>  Clonez la biblioth√®que sur l'ordinateur avec la commande <br><br><pre> <code class="python hljs">$ git clone https://github.com/micropython/micropython-lib.git</code> </pre><br>  Sur le p√©riph√©rique cible, cr√©ez le r√©pertoire <b><i>uasyncio</i></b> (facultatif dans le r√©pertoire lib) et copiez-y les fichiers suivants: <br><br>  <b>‚Ä¢ uasyncio / uasyncio / __ init__.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.core / uasyncio / core.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.synchro / uasyncio / synchro.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.queues / uasyncio / queues.py</b> <b><br></b> <br><br>  Ces modules <b><i>uasyncio</i></b> peuvent √™tre compress√©s en bytecode en pla√ßant le r√©pertoire <b><i>uasyncio</i></b> et son contenu dans le port du r√©pertoire <i>modules</i> et en recompilant le contenu. <br><br>  <b>1. Planification conjointe</b> <br><br>  La technique d'ex√©cution conjointe de plusieurs t√¢ches est largement utilis√©e dans les syst√®mes embarqu√©s, qui offre moins de frais g√©n√©raux que la planification de thread ( <b>_thread</b> ), √©vitant de nombreux pi√®ges associ√©s aux threads vraiment asynchrones. <br><br>  <b>1.1 Modules</b> <br><br>  Voici une liste de modules pouvant s'ex√©cuter sur le p√©riph√©rique cible. <br><br>  <b><u>Biblioth√®ques</u></b> <br><br>  1. <b><i>asyn.py</i></b> fournit les primitives de synchronisation <i><b>Lock, Event, Barrier, Semaphore, BoundedSemaphore, Condition</b></i> .  Prend en charge l'annulation des t√¢ches via les classes <i><b>NamedTask</b></i> et <i><b>Cancellable</b></i> . <br><br>  2. <b><i>aswitch.py</i></b> Repr√©sente des classes pour l'appariement des commutateurs et des boutons, ainsi qu'un objet programme avec possibilit√© de retard r√©p√©t√©.  Les boutons sont une g√©n√©ralisation des commutateurs qui fournissent un √©tat logique plut√¥t que physique, ainsi que des √©v√©nements d√©clench√©s par une double et longue pression. <br><br>  <b>Programmes de d√©monstration</b> <br><br>  Les deux premiers sont les plus utiles car ils donnent des r√©sultats visibles lors de l'acc√®s au <b>mat√©riel Pyboard</b> . <br><br><ol><li>  <b><i>aledflash.py</i></b> Clignote quatre indicateurs <b>Pyboard de</b> mani√®re asynchrone pendant 10 secondes.  La d√©monstration la plus simple de <b>uasyncio</b> .  Importez-le pour ex√©cuter. </li><li>  <b><i>apoll.py</i></b> Pilote de <b><i>p√©riph√©rique</i></b> pour l'acc√©l√©rom√®tre <b>Pyboard</b> .  Montre l'utilisation de coroutines pour interroger un p√©riph√©rique.  Fonctionne pendant 20 s.  Importez-le pour ex√©cuter.  N√©cessite <b>Pyboard V1.x.</b> </li><li>  <b><i>astests.py Programmes de</i></b> test / d√©mo pour le module <b><i>aswitch</i></b> . </li><li>  <b><i>asyn_demos.py D√©mos</i></b> simples d'annulation de t√¢ches. </li><li>  <b><i>roundrobin.py</i></b> D√©monstration de la planification circulaire.  √âgalement la r√©f√©rence en mati√®re de planification des performances. </li><li>  <b><i>attendantable.py</i></b> D√©monstration d'une classe avec une attente.  Une fa√ßon d'impl√©menter un pilote de p√©riph√©rique qui interroge une interface. </li><li>  <b><i>chain.py</i></b> Copi√© √† partir de la documentation <b>Python</b> .  D√©monstration de la cha√Æne Coroutine. </li><li>  <b><i>aqtest.py</i></b> D√©monstration de la classe <b><i>Queue</i></b> de la biblioth√®que <i><b>uasyncio</b></i> . </li><li>  <b><i>aremote.py</i></b> Exemple de pilote de p√©riph√©rique pour le protocole NEC IR. </li><li>  <b><i>auart.py</i></b> D√©monstration du streaming d'entr√©e-sortie via <b>Pyboard UART</b> . </li><li>  <b><i>auart_hd.py</i></b> Utilisation de <b>Pyboard UART</b> pour communiquer avec un p√©riph√©rique √† l'aide du protocole semi-duplex.  Convient aux appareils, par exemple, en utilisant le jeu de commandes du modem AT. </li><li>  <b><i>iorw.py</i></b> D√©monstration d'un p√©riph√©rique de lecture / √©criture √† l'aide d'E / <b><i>S</i></b> en streaming. </li></ol><br>  <b>Programmes de test</b> <br><br><ol><li>  <b><i>asyntest.py</i></b> Teste les classes de synchronisation dans <b><i>asyn.py.</i></b> </li><li>  <b><i>cantest.py</i></b> Tests d'annulation d'emploi. </li></ol><br>  <b>Utilitaire</b> <br><br>  1. <b><i>check_async_code.py</i></b> L'utilitaire est √©crit en <b>Python3</b> pour d√©tecter des erreurs de codage sp√©cifiques qui peuvent √™tre difficiles √† trouver.  Voir section 7.5. <br><br>  <b>Contr√¥le</b> <br><br>  Le r√©pertoire <a href="" rel="nofollow"><i>benchmarks</i></a> contient des scripts pour v√©rifier et caract√©riser le <i><b>planificateur uasyncio</b></i> . <br><br><cut></cut><br>  <b>2. biblioth√®que <i>uasyncio</i></b> <br><br>  Le concept <i>asyncio est</i> bas√© sur l'organisation de la planification de l'ex√©cution conjointe de plusieurs t√¢ches, qui dans ce document sont appel√©es <b>coroutines</b> . <br><br>  <b>2.1 Structure du programme: boucle d'√©v√©nement</b> <br><br>  Prenons l'exemple suivant: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> : count + = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( count ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#  1 loop = asyncio.get_event_loop () loop.create_task ( bar ()) #     loop.run_forever ()</span></span></code> </pre><br>  L'ex√©cution du programme continue jusqu'√† <i>ce</i> que <i>loop.run_forever soit appel√©</i> .  √Ä ce stade, l'ex√©cution est contr√¥l√©e par le planificateur.  La ligne apr√®s <i>loop.run_forever</i> ne sera jamais ex√©cut√©e.  Le planificateur ex√©cute le code √† <i>barres</i> car il a √©t√© mis en file d'attente dans le <i>planificateur loop.create_task</i> .  Dans cet exemple trivial, il n'y a qu'une seule <i>barre de</i> coroutine.  S'il y en avait d'autres, le planificateur les ex√©cuterait pendant les p√©riodes o√π la <i>barre</i> √©tait en pause. <br><br>  La plupart des applications int√©gr√©es ont une boucle d'√©v√©nements continue.  Une boucle d'√©v√©nement peut √©galement √™tre d√©marr√©e d'une mani√®re qui permet l'ach√®vement √† l'aide de la m√©thode de boucle d'√©v√©nement <i>run_until_complete</i> ;  Il est principalement utilis√© dans les tests.  Des exemples peuvent √™tre trouv√©s dans le module <a href="https://github.com/peterhinch/micropython-async/blob/master/astests.py" rel="nofollow"><b><i>astests.py</i></b></a> . <br><br>  Une instance de boucle d'√©v√©nement est un objet unique cr√©√© par le premier appel √† <i>asyncio.get_event_loop ()</i> avec deux arguments entiers facultatifs qui indiquent le nombre de coroutines dans les deux files d'attente - le d√©but et l'attente.  En r√®gle g√©n√©rale, les deux arguments auront la m√™me valeur, √©gale au moins au nombre de coroutines ex√©cut√©es simultan√©ment dans l'application.  Habituellement, la valeur par d√©faut de 16 est suffisante. Si des valeurs non par d√©faut sont utilis√©es, voir Arguments du constructeur de la boucle d'√©v√©nements (section 7.7.). <br><br>  Si la coroutine a besoin d'appeler la m√©thode de boucle d'√©v√©nements (g√©n√©ralement <i>create_task</i> ), l'appel de <i>asyncio.get_event_loop ()</i> (sans arguments) la renverra effectivement. <br><br>  <b>2.2 Coroutines</b> <br><br>  Une coroutine est cr√©√©e comme suit: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( delay_secs )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> )</code> </pre><br>  Une coroutine peut autoriser le lancement d'autres coroutines √† l'aide de l'instruction <i>wait</i> .  Une coroutine doit contenir au moins une instruction d' <i>attente</i> .  Cela provoque l'ex√©cution de la coroutine avant la fin, avant que l'ex√©cution ne passe √† l'instruction suivante.  Prenons un exemple: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( <span class="hljs-number"><span class="hljs-number">0</span></span> )</code> </pre><br>  La premi√®re ligne entra√Æne une pause du code pendant un certain temps, tandis que d'autres coroutines utilisent ce temps pour leur ex√©cution.  Un retard de 0 provoque l'ex√©cution de toutes les coroutines en attente dans un ordre cyclique jusqu'√† l'ex√©cution de la ligne suivante.  Voir l'exemple de <i><b>roundrobin.py</b></i> . <br><br>  <b>2.2.1.</b>  <b>File d'attente pour planifier une coroutine</b> <br><br><ul><li>  <i>EventLoop.create_task</i> Argument: Coroutine √† ex√©cuter.  Le planificateur met la coroutine en file d'attente pour d√©marrer d√®s que possible.  L'appel <i>create_task</i> revient imm√©diatement.  La coroutine dans l'argument est sp√©cifi√©e en utilisant la syntaxe de l'appel de fonction avec les arguments n√©cessaires. </li><li>  <i>EventLoop.run_until_complete</i> Argument: Coroutine √† ex√©cuter.  Le planificateur met la coroutine en file d'attente pour d√©marrer d√®s que possible.  La coroutine dans l'argument est sp√©cifi√©e en utilisant la syntaxe de l'appel de fonction avec les arguments n√©cessaires.  L'appel <i>un_until_complete</i> revient lorsque la coroutine est termin√©e: cette m√©thode fournit un moyen de quitter le planificateur. </li><li>  <i>en attente</i> Argument: coroutine √† ex√©cuter, sp√©cifi√©e √† l'aide de la syntaxe d'appel de fonction.  D√©marre une coroutine d√®s que possible.  La coroutine en attente est bloqu√©e jusqu'√† ce que l'une des coroutines attendues se termine. </li></ul><br>  Ce qui pr√©c√®de est compatible avec <b>CPython</b> .  D' <b><i>autres</i></b> m√©thodes <b><i>uasyncio sont</i></b> d√©crites dans les notes (section 2.2.3.). <br><br>  <b>2.2.2 D√©marrage de la fonction de rappel</b> <br><br>  Les rappels doivent √™tre <b>des</b> fonctions <b>Python</b> con√ßues pour s'ex√©cuter dans un court laps de temps.  Cela est d√ª au fait que les coroutines ne pourront pas fonctionner pendant toute la dur√©e de l'ex√©cution d'une telle fonction. <br><br>  Les <b><i>m√©thodes de</i></b> classe <b><i>EventLoop</i></b> suivantes utilisent des rappels: <br><br><ol><li>  <i>call_soon</i> - appelez d√®s que possible.  Args: <i>callback</i> callback √† ex√©cuter, <i>* args</i> tout argument positionnel peut √™tre suivi d'une virgule. </li><li>  <i>call_later</i> - appel apr√®s un d√©lai en secondes.  Args: <i>d√©lai, rappel, * arguments</i> </li><li>  <i>call_later_ms</i> - appel apr√®s un d√©lai en ms.  Args: <i>d√©lai, rappel, * arguments</i> . </li></ol><br><pre> <code class="python hljs">loop = asyncio.get_event_loop () loop.call_soon ( foo , <span class="hljs-number"><span class="hljs-number">5</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#    'foo'      5. loop.call_later ( 2 , foo , 5 ) #   2 . loop.call_later_ms ( 50 , foo , 5 ) #   50 . loop.run_forever ()</span></span></code> </pre><br>  <b>2.2.3 Remarques</b> <br><br>  Une coroutine peut contenir une instruction de <i>retour</i> avec des valeurs de retour arbitraires.  Pour obtenir cette valeur: <br><br><pre> <code class="python hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> my_coro ()</code> </pre><br>  Une coroutine peut √™tre limit√©e par des m√©thodes et doit contenir au moins une instruction d' <i>attente</i> . <br><br>  <b>2.3 Retards</b> <br><br>  Il existe deux options pour organiser les retards dans les coroutines.  Pour des retards plus longs et dans les cas o√π la dur√©e n'a pas besoin d'√™tre pr√©cise, vous pouvez utiliser: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( delay_secs , delay_ms )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms ( delay_ms )</code> </pre><br>  Pendant de tels retards, le planificateur ex√©cutera d'autres coroutines.  Cela peut introduire une incertitude temporelle, car la coroutine appelante ne sera lanc√©e que lorsque celle en cours d'ex√©cution est ex√©cut√©e.  Le d√©lai d√©pend du d√©veloppeur de l'application, mais il sera probablement de l'ordre de dizaines ou centaines de ms;  ceci est discut√© plus loin dans l'interaction avec les p√©riph√©riques mat√©riels (section 6). <br><br>  Des retards tr√®s pr√©cis peuvent √™tre effectu√©s en utilisant les fonctions <i>utime</i> - <i>sleep_ms</i> et <i>sleep_us</i> .  Ils conviennent mieux aux courts retards, car le planificateur ne pourra pas ex√©cuter d'autres coroutines pendant que le retard est en cours. <br><br>  <b>3. synchronisation</b> <br><br>  Il est souvent n√©cessaire d'assurer la synchronisation entre les coroutines.  Un exemple courant consiste √† √©viter les ¬´conditions de concurrence¬ª lorsque plusieurs coroutines n√©cessitent simultan√©ment l'acc√®s √† la m√™me ressource.  Un exemple est fourni dans <b><i>astests.py</i></b> et est discut√© dans la <a href="" rel="nofollow">documentation</a> .  Un autre danger est ¬´l'√©treinte de la mort¬ª, lorsque chaque coroutine attend l'ach√®vement de l'autre. <br><br>  Dans les applications simples, la synchronisation peut √™tre r√©alis√©e √† l'aide d'indicateurs globaux ou de variables associ√©es.  Une approche plus √©l√©gante consiste √† utiliser des classes de synchronisation.  Le module <b><i>asyn.py</i></b> propose des impl√©mentations ¬´micro¬ª des classes <i><b>Event, Barrier, Semaphore</b></i> et <i><b>Conditios</b></i> , destin√©es √† √™tre utilis√©es uniquement avec <b><i>asyncio</i></b> .  Ils ne sont pas orient√©s thread et ne doivent pas √™tre utilis√©s avec le module <b><i>_thread</i></b> ou le gestionnaire d'interruption, sauf indication contraire.  La classe <i><b>Lock</b></i> est √©galement impl√©ment√©e, ce qui est une alternative √† l'impl√©mentation officielle. <br><br>  Un autre probl√®me de synchronisation se pose avec les producteurs et les consommateurs de coroutine.  Un producteur de coroutine g√©n√®re des donn√©es qu'un consommateur de coroutine utilise.  Pour ce faire, <b><i>asyncio</i></b> fournit la classe <i><b>Queue</b></i> .  Le producteur de coroutine place les donn√©es dans la file d'attente, tandis que le consommateur de coroutine attend sa fin (avec d'autres op√©rations planifi√©es √† temps).  La classe <i><b>Queue</b></i> fournit des garanties pour supprimer les √©l√©ments dans l'ordre dans lequel ils ont √©t√© re√ßus.  Vous pouvez √©galement utiliser la classe <i><b>Barri√®re</b></i> si la coroutine de producteur doit attendre que la coroutine de consommateur soit pr√™te √† acc√©der aux donn√©es. <br><br>  Un bref aper√ßu des classes est donn√© ci-dessous.  Plus de d√©tails dans la <a href="" rel="nofollow">documentation compl√®te</a> . <br><br>  <b>3.1 <a href="" rel="nofollow"><i>Verrou</i></a></b> <br><br>  <i><b>Lock</b></i> garantit un acc√®s unique √† une ressource partag√©e.  L'exemple de code suivant cr√©e une instance de la classe de <i>verrouillage</i> <b><i>Lock</i></b> qui est transmise √† tous les clients qui souhaitent acc√©der √† la ressource partag√©e.  Chaque coroutine essaie de capturer le verrou, suspendant l'ex√©cution jusqu'√† ce qu'il r√©ussisse: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> uasyncio.synchro <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Lock <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, lock)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> lock.acquire() print(<span class="hljs-string"><span class="hljs-string">"Acquired lock in task"</span></span>, i) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0.5</span></span>) lock.release() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">killer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>) loop = asyncio.get_event_loop() lock = Lock() <span class="hljs-comment"><span class="hljs-comment"># The global Lock instance loop.create_task(task(1, lock)) loop.create_task(task(2, lock)) loop.create_task(task(3, lock)) loop.run_until_complete(killer()) #  10s</span></span></code> </pre><br>  <b>3.1.1.Lock et timeouts</b> <br><br>  Au moment de la r√©daction (5 janvier 2018), le d√©veloppement de la classe <i><b>uasycio</b></i> <i>Lock</i> <i><b>n'√©tait</b></i> pas officiellement termin√©.  Si la coroutine a un <u>d√©lai d'attente (section 5.2.2.)</u> , Lors de l'attente d'un verrouillage lorsqu'elle est d√©clench√©e, le d√©lai d'attente sera inefficace.  Il ne recevra pas une <i>TimeoutError</i> jusqu'√† ce qu'il re√ßoive un verrou.  Il en va de m√™me pour l'annulation d'une t√¢che. <br><br>  Le module <b><i>asyn.py</i></b> propose la classe <a href="" rel="nofollow"><b><i>Lock</i></b></a> , qui fonctionne dans ces situations.  Cette impl√©mentation de la classe est moins efficace que la classe officielle, mais prend en charge des interfaces suppl√©mentaires selon la version de <b>CPython</b> , y compris l'utilisation du gestionnaire de contexte. <br><br>  <b>3.2 √âv√©nement</b> <br><br>  <b><i>L'√©v√©nement</i></b> cr√©e une occasion pour une ou plusieurs coroutines de faire une pause, tandis qu'un autre donne un signal sur leur poursuite.  Une instance d' <b>Event</b> devient disponible pour toutes les coroutines qui l'utilisent: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn event = asyn.Event ()</code> </pre><br>  Une coroutine attend un √©v√©nement en d√©clarant un <i>√©v√©nement</i> <i>wait</i> , apr√®s quoi l'ex√©cution s'interrompt jusqu'√† ce que d'autres coroutines d√©clarent <i>event.set ()</i> .  <a href="" rel="nofollow">Information compl√®te</a> . <br><br>  Un probl√®me peut survenir si <i>event.set ()</i> est √©mis dans une construction en boucle;  le code doit attendre que tous les objets en attente aient acc√®s √† l'√©v√©nement avant de le red√©finir.  Dans le cas o√π un <b>coro</b> attend un √©v√©nement, cela peut √™tre r√©alis√© en recevant un √©v√©nement <b>coro</b> effa√ßant l'√©v√©nement: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventwait</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> event event.clear()</code> </pre><br>  La coroutine qui d√©clenche l'√©v√©nement v√©rifie qu'il a √©t√© trait√©: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> : <span class="hljs-comment"><span class="hljs-comment">#   - while event.is_set (): await asyncio.sleep ( 1 ) # ,  coro   event.set ()</span></span></code> </pre><br>  Dans le cas o√π plusieurs <b>coros</b> attendent la synchronisation d'un √©v√©nement, le probl√®me peut √™tre r√©solu en utilisant l'√©v√©nement de confirmation.  Chaque <b>coro a</b> besoin d'un √©v√©nement distinct. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventwait</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  , ack_event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> event ack_event.set ()</code> </pre><br>  Un exemple de ceci est donn√© dans la fonction <i><b>event_test</b></i> dans <i><b>asyntest.py</b></i> .  C'est lourd Dans la plupart des cas - m√™me avec un <b>coro en</b> attente - la classe <b>Barri√®re</b> , pr√©sent√©e ci-dessous, offre une approche plus simple. <br>  Un √©v√©nement peut √©galement fournir un moyen de communication entre le gestionnaire d'interruption et le <b>coro</b> .  Le gestionnaire g√®re le mat√©riel et d√©finit l'√©v√©nement, qui est v√©rifi√© par <b>coro</b> d√©j√† en mode normal. <br><br>  <b>3.2.1 Valeurs d'√©v√©nement</b> <br><br>  La m√©thode <i>event.set ()</i> peut prendre une valeur de donn√©es facultative de n'importe quel type.  <b>Coro</b> , en attente d'un √©v√©nement, peut l'obtenir avec <i>event.value ()</i> .  Notez que <i>event.clear ()</i> sera d√©fini sur <i>Aucun</i> .  Une utilisation typique de ceci pour le r√©glage de <i>coro de</i> l'√©v√©nement est d'√©mettre <i>event.set (utime.ticks_ms ())</i> .  Tout <b>coro en</b> attente d'un √©v√©nement peut d√©terminer le retard qui s'est produit, par exemple, pour compenser cela. <br><br>  <b>3.3 <a href="" rel="nofollow"><i>Barri√®re</i></a></b> <br><br>  Il existe deux utilisations pour la classe <b><i>Barri√®re</i></b> . <br><br>  Tout d'abord, il peut suspendre une coroutine jusqu'√† ce qu'une ou plusieurs autres coroutines soient termin√©es. <br><br>  Deuxi√®mement, il permet √† plusieurs coroutines de se rencontrer √† un certain point.  Par exemple, un producteur et un consommateur peuvent se synchroniser au point o√π le producteur a des donn√©es et le consommateur est pr√™t √† les utiliser.  Au moment de l'ex√©cution, la <b>barri√®re</b> peut √©mettre un rappel suppl√©mentaire avant la suppression de la barri√®re et tous les √©v√©nements en attente peuvent se poursuivre. <br><br>  Le rappel peut √™tre une fonction ou une coroutine.  Dans la plupart des applications, la fonction sera tr√®s probablement utilis√©e: elle peut √™tre garantie d'√™tre ex√©cut√©e avant la fin, avant que la barri√®re ne soit supprim√©e. <br><br>  Un exemple est la fonction <i><b>barri√®re_test</b></i> dans <i><b>asyntest.py</b></i> .  Dans l'extrait de code de ce programme: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span><span class="hljs-function">:</span></span> print(text) barrier = asyn.Barrier(<span class="hljs-number"><span class="hljs-number">3</span></span>, callback, (<span class="hljs-string"><span class="hljs-string">'Synch'</span></span>,)) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>): print(<span class="hljs-string"><span class="hljs-string">'{} '</span></span>.format(i), end=<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> barrier</code> </pre> <br>  plusieurs instances de la coroutine de <i>rapport</i> impriment leur r√©sultat et s'arr√™tent jusqu'√† ce que d'autres instances soient √©galement termin√©es et attendent que la <b>barri√®re</b> continue.  √Ä ce stade, un rappel est en cours.  √Ä la fin, la coroutine d'origine reprend. <br><br>  <b>3.4 S√©maphore</b> <br><br>  Le s√©maphore limite le nombre de coroutines pouvant acc√©der √† la ressource.  Il peut √™tre utilis√© pour limiter le nombre d'instances d'une coroutine particuli√®re pouvant s'ex√©cuter simultan√©ment.  Cela se fait √† l'aide d'un compteur d'acc√®s, qui est initialis√© par le constructeur et r√©duit √† chaque fois que la coroutine re√ßoit un s√©maphore. <br><br>  La fa√ßon la plus simple de l'utiliser dans un gestionnaire de contexte: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn sema = asyn.Semaphore(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sema)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> sema: <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre><br>  Un exemple est la fonction <i><b>semaphore_test</b></i> dans <i><b>asyntest.py</b></i> . <br><br>  <b>3.4.1 S√©maphore ( <a href="" rel="nofollow"><i>limit√©</i></a> )</b> <br><br>  Elle fonctionne de mani√®re similaire √† la classe <i><b>Semaphore</b></i> , sauf que si la m√©thode de <i>lib√©ration</i> fait d√©passer le compteur d'acc√®s de sa valeur initiale, une <i>ValueError est</i> d√©finie. <br><br>  <b>3.5 File d'attente</b> <br><br>  La classe <i><b>Queue</b></i> est maintenue par le <i><b>uasycio</b></i> officiel et l'exemple de programme <i><b>aqtest.py</b></i> montre son utilisation.  La file d'attente est cr√©√©e comme suit: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> uasyncio.queues <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue q = Queue ()</code> </pre><br>  Une coroutine de fabricant typique peut fonctionner comme suit: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">producer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(q)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> slow_process() <span class="hljs-comment"><span class="hljs-comment">#       await q.put(result) #  ,       </span></span></code> </pre><br>  et la coroutine de consommation peut fonctionner comme suit: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consumer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(q)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span>(q.get()) <span class="hljs-comment"><span class="hljs-comment"># ,  q  print('Result was {}'.format(result))</span></span></code> </pre><br>  La classe <i><b>Queue</b></i> fournit des fonctionnalit√©s suppl√©mentaires importantes lorsque la taille des files d'attente peut √™tre limit√©e et que l'√©tat peut √™tre interrog√©.  Le comportement avec une file d'attente vide (si la taille est limit√©e) et le comportement avec une file d'attente pleine peuvent √™tre contr√¥l√©s.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La documentation √† ce sujet se trouve dans le code. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.6 Autres classes de synchronisation</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La biblioth√®que </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fournit une micro impl√©mentation de certaines des autres fonctionnalit√©s de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La classe </font></font><a href="" rel="nofollow"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition</font></font></i></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet √† une coroutine de notifier les autres coroutines en attente sur une ressource verrouill√©e. Apr√®s avoir re√ßu la notification, ils auront acc√®s √† la ressource et se d√©verrouilleront √† leur tour. Une coroutine de notification peut limiter le nombre de coroutines √† notifier. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La classe </font></font><a href="" rel="nofollow"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gather</font></font></i></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous permet d'ex√©cuter une liste de coroutines. A l'issue de ce dernier, une liste de r√©sultats vous sera retourn√©e. Cette impl√©mentation "micro" utilise une syntaxe diff√©rente. Des d√©lais d'attente peuvent √™tre appliqu√©s √† n'importe laquelle des coroutines.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 D√©veloppement de classes pour </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncio</font></font></i></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dans le cadre du d√©veloppement de pilotes de p√©riph√©riques, l'objectif est de s'assurer qu'ils fonctionnent sans blocage. Un pilote de coroutine doit s'assurer que les autres coroutines sont ex√©cut√©es pendant que le pilote attend que le p√©riph√©rique effectue des op√©rations mat√©rielles. Par exemple, une t√¢che en attente de donn√©es arrivant dans UART ou un utilisateur appuyant sur un bouton doit permettre la planification d'autres √©v√©nements jusqu'√† ce que l'√©v√©nement se produise. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1 Classes utilisant l' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attente d'</font></font></i></b> <font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;"> attente Une </font></b><b><i><font style="vertical-align: inherit;">coroutine</font></i></b></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut suspendre l'ex√©cution en attendant un objet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython, une</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendue</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> personnalis√©e </font><font style="vertical-align: inherit;">est cr√©√©e en impl√©mentant la m√©thode sp√©ciale </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que le g√©n√©rateur retourne. </font><font style="vertical-align: inherit;">La classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendue est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilis√©e comme suit:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>): print(<span class="hljs-string"><span class="hljs-string">'__await__ called'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     return 42 __iter__ = __await__ # .   async def bar(): foo = Foo() # Foo - awaitable  print('waiting for foo') res = await foo #   print('done', res) loop = asyncio.get_event_loop() loop.run_until_complete(bar())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l' heure actuelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas en </font><font style="vertical-align: inherit;">charge </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="http://github.com/micropython/micropython/issues/2678" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">num√©ro 2678</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) et pour que </font><font style="vertical-align: inherit;">la solution soit utilis√©e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__iter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La cha√Æne </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__iter__ = __await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fournit la portabilit√© entre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les exemples de code, voir les classes d' </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©v√©nements, barri√®re, r√©vocable, Condition</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1.1 Utilisation dans les gestionnaires de contexte</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Les objets attendus peuvent √™tre utilis√©s dans les gestionnaires de contexte synchrones ou asynchrones, en fournissant les m√©thodes sp√©ciales n√©cessaires. </font><font style="vertical-align: inherit;">Syntaxe:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> awaitable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a: <span class="hljs-comment"><span class="hljs-comment">#  'as'   #    async with awaitable as a: #    (.) #  -</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour ce faire, le </font><font style="vertical-align: inherit;">g√©n√©rateur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> doit retourner lui- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√™me</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ceci est pass√© √† n'importe quelle variable dans la </font><font style="vertical-align: inherit;">clause </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et permet √©galement aux m√©thodes sp√©ciales de fonctionner. Voir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.Condition</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyntest.condition_test</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o√π la classe </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilise </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attend</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et peut √™tre utilis√©e dans un gestionnaire de contexte synchrone. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1.2 coroutine Attendent en</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> langage </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√©cessite </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est la fonction g√©n√©ratrice. Dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython, les</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> g√©n√©rateurs et les coroutines sont identiques, donc la solution est d'utiliser le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendement de coro (args)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le but de ce guide est de proposer du code portable vers </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython 3.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou version ult√©rieure. Dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython, les</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> g√©n√©rateurs et les coroutines ont une signification diff√©rente. En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython, une</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coroutine a une </font><font style="vertical-align: inherit;">m√©thode sp√©ciale </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que le g√©n√©rateur r√©cup√®re. C'est portable:</font></font><br><br><pre> <code class="python hljs">up = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-comment"><span class="hljs-comment">#   MicroPython? try: import uasyncio as asyncio up = True #    sys.implementation.name except ImportError: import asyncio async def times_two(n): # Coro   await asyncio.sleep(1) return 2 * n class Foo(): def __await__(self): res = 1 for n in range(5): print('__await__ called') if up: # MicroPython res = yield from times_two(res) else: # CPython res = yield from times_two(res).__await__() return res __iter__ = __await__ async def bar(): foo = Foo() # foo is awaitable print('waiting for foo') res = await foo #   print('done', res) loop = asyncio.get_event_loop() loop.run_until_complete(bar())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notez que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__, le rendement de asyncio.sleep (1) est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> autoris√© par </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Je ne comprends toujours pas comment cela est r√©alis√©. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.2 It√©rateurs</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asynchrones </font><b><font style="vertical-align: inherit;">Les it√©rateurs</font></b><font style="vertical-align: inherit;"> asynchrones fournissent un moyen de renvoyer une s√©quence finie ou infinie de valeurs et peuvent √™tre utilis√©s comme moyen de r√©cup√©rer des √©l√©ments de donn√©es s√©quentiels lorsqu'ils proviennent d'un p√©riph√©rique en lecture seule. </font><font style="vertical-align: inherit;">Un it√©rateur asynchrone appelle du code asynchrone dans sa m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suivante</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La classe doit r√©pondre aux exigences suivantes:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il a une m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aiter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©finie dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et renvoyant un it√©rateur asynchrone.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il a une m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__anext__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est elle-m√™me une coroutine - c'est-√†-dire d√©finie via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et contenant au moins une instruction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pour arr√™ter l'it√©ration, elle doit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©clencher</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> une </font><font style="vertical-align: inherit;">exception </font><i><font style="vertical-align: inherit;">StopAsyncIteration</font></i><font style="vertical-align: inherit;"> .</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les valeurs en s√©rie sont r√©cup√©r√©es en utilisant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async pour</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comme indiqu√© ci-dessous:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncIterable</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.data = (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) self.index = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__aiter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__anext__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.fetch_data() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> StopAsyncIteration <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0.1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     if self.index &gt;= len(self.data): return None x = self.data[self.index] self.index += 1 return x async def run(): ai = AsyncIterable() async for x in ai: print(x)</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.3 Gestionnaires de contexte asynchrones Les</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classes peuvent √™tre con√ßues pour prendre en charge les gestionnaires de contexte asynchrones qui ont des proc√©dures d'entr√©e et de sortie qui sont des co-programmes. Un exemple est la classe de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verrouillage</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©crite ci-dessus. Il poss√®de la coroutine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aenter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est logiquement requise pour un fonctionnement asynchrone. Pour prendre en charge le protocole asynchrone du gestionnaire de contexte, sa </font><font style="vertical-align: inherit;">m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aexit__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> doit √©galement √™tre une coroutine, ce qui est obtenu en incluant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attend asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ces classes sont accessibles depuis une coroutine avec la syntaxe suivante:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( lock )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lock: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( ¬´ bar ¬ª )</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme c'est le cas avec les gestionnaires de contexte classiques, la m√©thode de sortie est garantie d'√™tre appel√©e lorsque le gestionnaire de contexte termine son travail, comme d'habitude, et par le biais d'une exception. Pour atteindre cet objectif, des m√©thodes sp√©ciales </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aenter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aexit__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont </font><i><font style="vertical-align: inherit;">utilis√©es</font></i><font style="vertical-align: inherit;"> et doivent √™tre d√©finies comme des coroutines attendant une autre coroutine ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objet </font><i><font style="vertical-align: inherit;">attendu</font></i><font style="vertical-align: inherit;"> . Cet exemple est tir√© de la classe </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lock</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__aenter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.acquire() <span class="hljs-comment"><span class="hljs-comment"># a coro    async def return self async def __aexit__(self, *args): self.release() #   await asyncio.sleep_ms(0)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async avec</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contient une clause </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as variable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la variable obtient la valeur renvoy√©e par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aenter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour garantir un comportement correct, le micrologiciel doit √™tre V1.9.10 ou version ult√©rieure. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Exceptions aux d√©lais d'expiration et en raison de l'annulation de t√¢ches</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ces sujets sont li√©s: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inclut l'annulation de t√¢ches et l'application d'un d√©lai d'expiration √† une t√¢che, lan√ßant une exception pour la t√¢che d'une mani√®re sp√©ciale. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1 Exceptions</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si une exception se produit dans une coroutine, elle doit √™tre trait√©e soit dans cette coroutine, soit dans une coroutine en attente de son ach√®vement. Cela garantit que l'exception ne s'applique pas au planificateur. Si une exception se produit, le planificateur cesse de fonctionner en transmettant l'exception au code que le planificateur a d√©marr√©. Par cons√©quent, pour √©viter l'arr√™t du planificateur, la coroutine lanc√©e avec </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop.create_task ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> doit intercepter toutes les exceptions √† l'int√©rieur. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utiliser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">close</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour </font><i><font style="vertical-align: inherit;">lever une</font></i><font style="vertical-align: inherit;"> exception dans une coroutine est d√©raisonnable. Cela d√©truit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , provoquant le d√©marrage et √©ventuellement la </font><b><font style="vertical-align: inherit;">sortie de</font></b><font style="vertical-align: inherit;"> la coroutine lorsqu'elle se trouve encore dans la file d'attente d'ex√©cution.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'exemple ci-dessus illustre cette situation. S'il est autoris√© √† fonctionner jusqu'√† la fin, il fonctionne comme pr√©vu.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) print(<span class="hljs-string"><span class="hljs-string">'About to throw exception.'</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> foo() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ZeroDivisionError: print(<span class="hljs-string"><span class="hljs-string">'foo  -   0'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># ! raise #     . except KeyboardInterrupt: print('foo was interrupted by ctrl-c') #   ! raise async def shutdown(): print('Shutdown is running.') #     await asyncio.sleep(1) print('done') loop = asyncio.get_event_loop() try: loop.run_until_complete(bar()) except ZeroDivisionError: loop.run_until_complete(shutdown()) except KeyboardInterrupt: print('Keyboard interrupt at loop level.') loop.run_until_complete(shutdown())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cependant, l'√©mission d'une interruption de clavier entra√Æne l'exception dans la boucle d'√©v√©nements. En effet, l'ex√©cution de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio.sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est pass√©e √† la boucle d'√©v√©nements. Par cons√©quent, les applications qui n√©cessitent un code clair en r√©ponse √† une interruption du clavier doivent intercepter une exception au niveau de la boucle d'√©v√©nements. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2 Annulation et timeouts</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comme mentionn√© ci-dessus, ces fonctions fonctionnent en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lan√ßant une</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exception pour la t√¢che d'une mani√®re sp√©ciale en utilisant la m√©thode sp√©ciale </font><b><font style="vertical-align: inherit;">MicroPython</font></b><font style="vertical-align: inherit;"> coroutine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pend_throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le fonctionnement d√©pend de la version. Dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v.2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel </font><b><font style="vertical-align: inherit;">, une</font></b><font style="vertical-align: inherit;"> exception n'est pas trait√©e jusqu'√† la prochaine t√¢che planifi√©e. Cela impose un d√©lai si la t√¢che attend le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sommeil</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entr√©e-sortie </font><font style="vertical-align: inherit;">Les d√©lais d'attente peuvent d√©passer leur p√©riode nominale. </font><font style="vertical-align: inherit;">La t√¢che d'annulation d'autres t√¢ches ne peut pas d√©terminer quand l'annulation est termin√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe actuellement une solution de contournement et deux solutions.</font></font><br><br><ul><li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la biblioth√®que </font><b><font style="vertical-align: inherit;">asyn</font></b><font style="vertical-align: inherit;"> offre un moyen d'attendre l'annulation des t√¢ches ou des groupes de t√¢ches. </font><font style="vertical-align: inherit;">Voir Annuler un travail (section 5.2.1.).</font></font></li><li> <a href="http://github.com/pfalcon/pycopy-lib" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La biblioth√®que Paul Sokolovsky</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fournit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais cela n√©cessite son firmware </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pycopy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li> <a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biblioth√®que</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet</font><font style="vertical-align: inherit;">r√©soudre ce probl√®me dans</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (de mani√®re moins √©l√©gante) et</font><font style="vertical-align: inherit;">cours</font><font style="vertical-align: inherit;">ex√©cution firmware officiel.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La hi√©rarchie des exceptions utilis√©e ici est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exception-CanceledError-TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.1 Annulation d'un travail </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> propose une fonction d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">annulation (coro)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cela fonctionne en lan√ßant une exception pour utiliser la coroutine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pend_throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il fonctionne √©galement avec les coroutines imbriqu√©es. L'utilisation est la suivante:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def bar(loop): foo_instance = foo() #   coro loop.create_task(foo_instance) # code omitted asyncio.cancel(foo_instance)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si cet exemple est ex√©cut√© sous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lorsque les </font><font style="vertical-align: inherit;">probl√®mes de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barre </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'annulent,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il ne prendra effet qu'au prochain </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> programm√© </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> et il </font><font style="vertical-align: inherit;">peut </font><font style="vertical-align: inherit;">y </font><font style="vertical-align: inherit;">avoir un retard pouvant aller jusqu'√† 10 secondes </font><font style="vertical-align: inherit;">lorsque </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> annul√© </font><font style="vertical-align: inherit;">. Une autre source de retard se produira si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attend les E / S. Partout o√π le retard se produit, le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne pourra pas d√©terminer si le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo a √©t√©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> annul√©. Cela compte dans certains cas d'utilisation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de l'utilisation des </font><b><font style="vertical-align: inherit;">biblioth√®ques </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paul Sokolovsky</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io, il</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suffit d'utiliser sleep (0):</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def bar(loop): foo_instance = foo() #   coro loop.create_task(foo_instance) #    asyncio.cancel(foo_instance) await asyncio.sleep(0) #   </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela fonctionnera √©galement dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (et tout </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coroutine en attente </font><font style="vertical-align: inherit;">) n'est jamais </font><font style="vertical-align: inherit;">revenu en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">veille</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et n'a pas attendu les E / S. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un comportement qui peut surprendre les imprudents se produit lorsqu'une coroutine ex√©cut√©e par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_task</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et en mode veille </font><font style="vertical-align: inherit;">est cens√©e s'annuler </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Consid√©rez cet extrait:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def foo_runner(foo_instance): await foo_instance print('   ') async def bar(loop): foo_instance = foo() loop.create_task(foo_runner(foo_instance)) #    asyncio.cancel(foo_instance)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est annul√©, il est supprim√© de la file d'attente du planificateur; </font><font style="vertical-align: inherit;">car il manque une </font><font style="vertical-align: inherit;">instruction de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retour</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la proc√©dure d'appel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo_runner</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne reprend jamais. </font><font style="vertical-align: inherit;">Il est recommand√© de toujours intercepter l'exception dans la port√©e la plus externe de la fonction √† annuler:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> my_coro <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.CancelledError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans ce cas, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_coro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'a pas besoin d'attraper l'exception, car il sera propag√© sur le canal appelant et captur√© √† cet </font><i><font style="vertical-align: inherit;">endroit</font></i><font style="vertical-align: inherit;"> .</font></font><br><br>  Remarque<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est interdit d'utiliser les </font><font style="vertical-align: inherit;">m√©thodes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">close</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> des coroutines lorsque les coroutines sont utilis√©es en dehors du planificateur. Cela sape le planificateur, for√ßant la coroutine √† ex√©cuter du code, m√™me s'il n'est pas planifi√©. Cela peut avoir des cons√©quences ind√©sirables. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.2 Coroutines avec Timeouts</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©lais d' </font><font style="vertical-align: inherit;">attente mis en </font><font style="vertical-align: inherit;">oeuvre en </font><font style="vertical-align: inherit;">utilisant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©thodes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.wait_for ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.wait_for_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ils prennent la coroutine et la latence en secondes ou ms, respectivement, comme arguments. Si le d√©lai expire, une </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sera </font><i><font style="vertical-align: inherit;">lanc√©e</font></i><font style="vertical-align: inherit;"> dans la coroutine √† l'aide de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pend_throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cette exception doit √™tre intercept√©e par l'utilisateur ou par l'appelant. </font><font style="vertical-align: inherit;">Cela est n√©cessaire pour la raison d√©crite ci-dessus: si le d√©lai expire, il est annul√©. </font><font style="vertical-align: inherit;">√Ä moins que l'erreur ne soit intercept√©e et renvoy√©e, la seule fa√ßon pour l'appelant de continuer est d'attraper l'exception elle-m√™me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque l'exception a √©t√© intercept√©e par la coroutine, j'ai eu des √©checs peu clairs si l'exception n'a pas √©t√© intercept√©e dans la port√©e externe, comme indiqu√© ci-dessous:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forever</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Starting'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">300</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Got here'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.TimeoutError: print(<span class="hljs-string"><span class="hljs-string">'Got timeout'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># And return async def foo(): await asyncio.wait_for(forever(), 5) await asyncio.sleep(2) loop = asyncio.get_event_loop() loop.run_until_complete(foo())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alternativement, vous pouvez intercepter la fonction appelante: </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forever</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Starting'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">300</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Got here'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.wait_for(forever(), <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.TimeoutError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> print(<span class="hljs-string"><span class="hljs-string">'Timeout elapsed.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) loop = asyncio.get_event_loop() loop.run_until_complete(foo())</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela ne s'applique pas aux </font><b><font style="vertical-align: inherit;">biblioth√®ques </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paul Sokolovsky</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la coroutine d√©marre, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendez asyncio.sleep (t)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , avec un long retard t, la coroutine ne red√©marrera pas avant l'expiration de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si le d√©lai d'attente s'est √©coul√© avant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fin du </font><i><font style="vertical-align: inherit;">sommeil</font></i><font style="vertical-align: inherit;"> , une </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreur TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se </font><i><font style="vertical-align: inherit;">produit</font></i><font style="vertical-align: inherit;"> lorsque la coroutine est recharg√©e - c'est-√†-dire quand </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expire </font><font style="vertical-align: inherit;">. En temps r√©el et du point de vue de l'appelant, sa r√©ponse </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sera retard√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si cela est important pour l'application, cr√©ez un long d√©lai en attendant un court dans la boucle. Coroutine</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prend cela en charge. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 Interaction avec l'√©quipement</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La base de l'interaction entre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et les √©v√©nements asynchrones externes est l'interrogation. Le mat√©riel n√©cessitant une r√©ponse rapide peut utiliser une interruption. Mais l'interaction entre la routine d'interruption (ISR) et la coroutine utilisateur sera bas√©e sur des sondages. Par exemple, un ISR peut appeler </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou d√©finir un indicateur global, tandis qu'une coroutine en attente d'un r√©sultat interroge un objet chaque fois qu'une demande est planifi√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'interrogation peut √™tre r√©alis√©e de deux mani√®res, explicite ou implicite. Ce dernier se fait √† l'aide d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E / S de flux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un m√©canisme, qui est un syst√®me con√ßu pour les appareils de streaming tels que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sockets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans le sondage explicite le plus simple, le code suivant peut consister:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_my_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> my_flag <span class="hljs-comment"><span class="hljs-comment">#   ISR while True: if my_flag: my_flag = False # service the device await asyncio.sleep(0)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au lieu d'un indicateur global, vous pouvez utiliser une variable d'instance de la classe </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou une instance d'une classe qui utilise </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Une enqu√™te explicite est discut√©e ci-dessous. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'interrogation implicite consiste √† d√©velopper un pilote qui agira comme un p√©riph√©rique d'E / S de streaming, tel qu'un </font><i><font style="vertical-align: inherit;">socket </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font><i><font style="vertical-align: inherit;">Stream I / O</font></i><font style="vertical-align: inherit;"> , qui interroge les p√©riph√©riques √† l'aide du syst√®me </font><b><font style="vertical-align: inherit;">Python </font></b><i><font style="vertical-align: inherit;">select.poll</font></i><font style="vertical-align: inherit;"> : puisque l'interrogation est effectu√©e en C, elle est plus rapide et plus efficace que sondage explicite. L'utilisation d'E / S de flux est discut√©e dans la section 6.3.</font></font><i><font style="vertical-align: inherit;"></font></i> <i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En raison de son efficacit√©, l'interrogation implicite donne un avantage aux pilotes de p√©riph√©riques d'E / S les plus rapides: des pilotes de streaming peuvent √™tre cr√©√©s pour de nombreux p√©riph√©riques qui ne sont g√©n√©ralement pas consid√©r√©s comme des p√©riph√©riques de streaming. Ceci est discut√© plus en d√©tail dans la section 6.4. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.1 Probl√®mes de synchronisation</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les sondages explicites et implicites reposent actuellement sur une planification cyclique. Supposons que les E / S fonctionnent simultan√©ment avec N coroutines personnalis√©es, chacune fonctionnant avec un retard nul. Lorsque les E / S sont servies, elles seront interrog√©es d√®s que toutes les op√©rations utilisateur sont planifi√©es. Le d√©lai estim√© doit √™tre pris en compte lors de la conception. Les canaux d'E / S peuvent n√©cessiter une mise en m√©moire tampon, avec un √©quipement de maintenance ISR en temps r√©el √† partir des tampons et des coroutines, remplissant ou lib√©rant les tampons plus lentement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il faut aussi consid√©rer la possibilit√© d'aller au-del√†: c'est le cas lorsque quelque chose interrog√© par la coroutine se produit plus d'une fois avant qu'il ne soit effectivement planifi√© par la coroutine.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un autre probl√®me de synchronisation est la pr√©cision de la latence. Si la coroutine √©met</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms ( t ) <span class="hljs-comment"><span class="hljs-comment">#  </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le planificateur garantit que l'ex√©cution sera suspendue pendant au moins t ms. Le retard r√©el peut √™tre sup√©rieur √† t, ce qui d√©pend de la charge actuelle du syst√®me. Si √† ce moment d'autres coroutines attendent la fin des d√©lais non nuls, la prochaine ligne sera imm√©diatement programm√©e pour ex√©cution. Mais si d'autres coroutines sont √©galement en attente d'ex√©cution (soit parce qu'elles ont √©mis un d√©lai nul, soit parce que leur d√©lai a √©galement expir√©), elles peuvent √™tre programm√©es pour s'ex√©cuter plus t√¥t. Cela introduit une incertitude de synchronisation dans les fonctions </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La pire valeur pour ce d√©bordement peut √™tre calcul√©e en additionnant les valeurs d'ex√©cution de toutes ces coroutines pour d√©terminer le temps de transmission le plus d√©favorable au planificateur.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> version </font><b><font style="vertical-align: inherit;">fast_io</font></b><font style="vertical-align: inherit;"> de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans ce contexte fournit un moyen de garantir que les E / S de streaming seront interrog√©es √† chaque it√©ration du planificateur. Nous esp√©rons que l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel </font><font style="vertical-align: inherit;">acceptera les amendements pertinents en temps </font><b><font style="vertical-align: inherit;">voulu</font></b><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.2 Interroger des appareils √† l'aide de coroutines</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il s'agit d'une approche simple qui convient le mieux aux appareils pouvant √™tre interrog√©s √† une vitesse relativement faible. Cela est principalement d√ª au fait que l'interrogation avec un intervalle d'interrogation court (ou nul) peut conduire au fait que la coroutine consomme plus de temps processeur que ce qui est souhaitable pour tomber dans l'intervalle. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'exemple </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apoll.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> illustre cette approche en interrogeant l'acc√©l√©rom√®tre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec un intervalle de 100 ms. Il effectue un filtrage simple pour ignorer le bruit et imprime un message toutes les deux secondes si aucun mouvement ne se produit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'exemple </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aswitch.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fournit des pilotes pour les commutateurs et les p√©riph√©riques bouton. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de pilote pour un p√©riph√©rique capable de lire et d'√©crire est illustr√© ci-dessous. Pour faciliter les tests, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> UART 4 ‚Äã‚Äã√©mule un p√©riph√©rique conditionnel. Le pilote impl√©mente la classe </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecordOrientedUart</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dans lequel les donn√©es sont fournies dans des enregistrements de longueur variable compos√©s d'instances d'octets. L'objet ajoute un d√©limiteur avant d'envoyer et met en m√©moire tampon les donn√©es entrantes jusqu'√† ce qu'un d√©limiteur ajout√© soit re√ßu. C'est juste une d√©mo et une mani√®re inefficace d'utiliser UART par rapport √† l'entr√©e / sortie en streaming. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afin de d√©montrer le transfert asynchrone, nous supposons que le p√©riph√©rique √©mul√© a un moyen de v√©rifier que le transfert est termin√© et que l'application nous oblige √† attendre. Aucune des hypoth√®ses n'est vraie dans cet exemple, mais le code la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simule en attendant asyncio.sleep (0.1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour commencer, n'oubliez pas de connecter les sorties du </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> X1 et X2 (UART Txd et Rxd)</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UART <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecordOrientedUart</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> DELIMITER = <span class="hljs-string"><span class="hljs-string">b'\0'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.uart = UART(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">9600</span></span>) self.data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Not __await__ issue #2678 data = b'' while not data.endswith(self.DELIMITER): yield from asyncio.sleep(0) # ,  : while not self.uart.any(): yield from asyncio.sleep(0) # timing may mean this is never called data = b''.join((data, self.uart.read(self.uart.any()))) self.data = data async def send_record(self, data): data = b''.join((data, self.DELIMITER)) self.uart.write(data) await self._send_complete() #          #        await asyncio.sleep(0) async def _send_complete(self): await asyncio.sleep(0.1) def read_record(self): # Synchronous: await the object before calling return self.data[0:-1] # Discard delimiter async def run(): foo = RecordOrientedUart() rx_data = b'' await foo.send_record(b'A line of text.') for _ in range(20): await foo #  coros       foo rx_data = foo.read_record() print('Got: {}'.format(rx_data)) await foo.send_record(rx_data) rx_data = b'' loop = asyncio.get_event_loop() loop.run_until_complete(run())</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.3 Utilisation du m√©canisme de streaming ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L'exemple illustre l'entr√©e-sortie simultan√©e sur un UART du microprocesseur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour commencer, connectez les sorties du </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> X1 et X2 (UART Txd et Rxd)</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UART uart = UART(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">9600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sender</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> swriter = asyncio.StreamWriter(uart, {}) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> swriter.awrite(<span class="hljs-string"><span class="hljs-string">'Hello uart\n'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> sreader = asyncio.StreamReader(uart) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> sreader.readline() print(<span class="hljs-string"><span class="hljs-string">'Received'</span></span>, res) loop = asyncio.get_event_loop() loop.create_task(sender()) loop.create_task(receiver()) loop.run_forever()</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code pris en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">charge</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se trouve dans </font><i><font style="vertical-align: inherit;">__init__.py</font></i><font style="vertical-align: inherit;"> dans la </font><font style="vertical-align: inherit;">biblioth√®que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le m√©canisme fonctionne car le pilote de p√©riph√©rique (√©crit en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) impl√©mente les m√©thodes suivantes: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl, read, readline</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Section 6.4: √âcrire un pilote de p√©riph√©rique de streaming r√©v√®le des d√©tails sur la fa√ßon dont ces pilotes peuvent √™tre √©crits en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'UART peut recevoir des donn√©es √† tout moment. Le m√©canisme d'E / S de streaming v√©rifie les caract√®res entrants en attente chaque fois que le planificateur prend le contr√¥le. Lorsque la coroutine est en cours d'ex√©cution, la routine d'interruption met en m√©moire tampon les caract√®res entrants; ils seront supprim√©s lorsque la coroutine fera place au planificateur. Par cons√©quent, les applications UART doivent √™tre con√ßues de mani√®re √† ce que les coroutines minimisent le temps entre les transferts vers le planificateur afin d'√©viter les d√©passements de tampon et la perte de donn√©es. Cela peut √™tre am√©lior√© en utilisant un tampon de lecture UART plus grand ou un d√©bit de donn√©es inf√©rieur. Alternativement, le contr√¥le de flux mat√©riel fournira une solution si la source de donn√©es le prend en charge. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.3.1 Exemple de pilote UART</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> programme </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auart_hd.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">illustre une m√©thode de communication avec un p√©riph√©rique semi-duplex, tel qu'un p√©riph√©rique r√©pondant √† l'ensemble de commandes du modem AT. Le semi-duplex signifie que l'appareil n'envoie jamais de donn√©es non sollicit√©es: ses transferts sont toujours effectu√©s en r√©ponse √† une commande re√ßue du ma√Ætre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'appareil est √©mul√© en ex√©cutant un test sur un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec deux connexions c√¢bl√©es. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le p√©riph√©rique √©mul√© (tr√®s simplifi√©) r√©pond √† n'importe quelle commande en envoyant quatre lignes de donn√©es avec une pause entre chacune pour simuler un traitement lent.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'assistant envoie une commande, mais ne sait pas √† l'avance combien de lignes de donn√©es seront renvoy√©es. Il d√©marre un temporisateur de red√©marrage qui red√©marre chaque fois qu'une ligne est re√ßue. Lorsque le temporisateur expire, il est suppos√© que le p√©riph√©rique a termin√© la transmission et une liste des lignes re√ßues est renvoy√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un cas de d√©faillance de p√©riph√©rique est √©galement d√©montr√©, ce qui est obtenu en sautant une transmission avant d'attendre une r√©ponse. Apr√®s le d√©lai d'attente, une liste vide est renvoy√©e. Voir les commentaires de code pour plus de d√©tails. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.4 D√©veloppement de pilotes en </font><font style="vertical-align: inherit;">continu ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) unit√©</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d'entr√©e de courant / m√©canisme de sortie ( </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flux E / S</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) pour commander le fonctionnement des dispositifs d' </font><font style="vertical-align: inherit;">E / S en </font><font style="vertical-align: inherit;">continu tels que les </font><font style="vertical-align: inherit;">UART et les </font><font style="vertical-align: inherit;">douilles ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Le m√©canisme peut √™tre utilis√© par les pilotes de tout p√©riph√©rique r√©guli√®rement interrog√© en d√©l√©guant au planificateur qui utilise </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , interrogeant l'√©tat de pr√©paration de tous les p√©riph√©riques de la file d'attente. C'est plus efficace que d'effectuer plusieurs op√©rations de coroutine, dont chacune interroge le p√©riph√©rique, en partie parce que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est √©crit en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et aussi parce que la coroutine qui effectue l'interrogation est retard√©e jusqu'√† ce que l'objet interrog√© retourne un √©tat pr√™t. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un pilote de p√©riph√©rique capable de prendre en charge le m√©canisme d'entr√©e / sortie de streaming doit de pr√©f√©rence prendre en charge les m√©thodes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader, StreamWriter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Un p√©riph√©rique lisible doit fournir au moins l'une des m√©thodes suivantes. Veuillez noter qu'il s'agit de m√©thodes synchrones. La m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (voir ci-dessous) garantit qu'ils ne sont appel√©s que lorsque les donn√©es sont disponibles. Les m√©thodes doivent √™tre renvoy√©es le plus rapidement possible, en utilisant autant de donn√©es que possible. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readline ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Retourne autant de caract√®res que possible, jusqu'√† n'importe quel caract√®re de nouvelle ligne. Obligatoire si vous utilisez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.readline () </font></font></i> <br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read (n)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Renvoyez autant de caract√®res que possible, mais pas plus de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Obligatoire si vous utilisez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.read ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.readexactly ()</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le pilote cr√©√© doit fournir la m√©thode synchrone suivante avec retour imm√©diat: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©crire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec les arguments </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf, off, sz</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O√π: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le tampon d'√©criture. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - d√©cal√© vers le tampon du premier caract√®re √† √©crire. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sz</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le nombre de caract√®res requis pour √©crire. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La valeur de retour</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le nombre de caract√®res r√©ellement √©crits (peut-√™tre 1 si l'appareil est lent). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> garantit qu'elle ne sera appel√©e que lorsque l'appareil est pr√™t √† recevoir des donn√©es.</font></font><br><cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les appareils doivent fournir une m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui interroge l'√©quipement pour d√©terminer son √©tat de disponibilit√©. </font><font style="vertical-align: inherit;">Un exemple typique pour un pilote de lecture / √©criture:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL_WR = const(<span class="hljs-number"><span class="hljs-number">4</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyIO</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    def ioctl(self, req, arg): # see ports/stm32/uart.c ret = MP_STREAM_ERROR if req == MP_STREAM_POLL: ret = 0 if arg &amp; MP_STREAM_POLL_RD: if hardware_has_at_least_one_char_to_read: ret |= MP_STREAM_POLL_RD if arg &amp; MP_STREAM_POLL_WR: if hardware_can_accept_at_least_one_write_character: ret |= MP_STREAM_POLL_WR return ret</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici une description du </font><font style="vertical-align: inherit;">d√©lai d'attente de la </font><font style="vertical-align: inherit;">classe </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MillisecTimer</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> utime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MillisecTimer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.end = <span class="hljs-number"><span class="hljs-number">0</span></span> self.sreader = asyncio.StreamReader(self) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.sreader.readline() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ms)</span></span></span><span class="hljs-function">:</span></span> self.end = utime.ticks_add(utime.ticks_ms(), ms) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, arg)</span></span></span><span class="hljs-function">:</span></span> ret = MP_STREAM_ERROR <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req == MP_STREAM_POLL: ret = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg &amp; MP_STREAM_POLL_RD: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> utime.ticks_diff(utime.ticks_ms(), self.end) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: ret |= MP_STREAM_POLL_RD <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui peut √™tre utilis√© comme suit: </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_test</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( n )</span></span></span><span class="hljs-function">:</span></span> timer = ms_timer.MillisecTimer () <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> timer ( <span class="hljs-number"><span class="hljs-number">30</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#  30 </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par rapport √† </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> une telle impl√©mentation n'offre aucun avantage par rapport √† l' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attente asyncio.sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L'utilisation de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fournit des retards significativement plus pr√©cis dans le mod√®le d'utilisation normal, lorsque les coroutines s'attendent √† un retard nul. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez utiliser la planification des E / S pour associer un √©v√©nement √† un rappel. C'est plus efficace que le cycle d'interrogation, car l'interrogation n'est pas planifi√©e tant que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'est pas </font><font style="vertical-align: inherit;">pr√™t. Ensuite, un rappel est ex√©cut√© lorsque le rappel change d'√©tat.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PinCall</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, pin, *, cb_rise=None, cbr_args=</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">, cb_fall=None, cbf_args=</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self.pin = pin self.cb_rise = cb_rise self.cbr_args = cbr_args self.cb_fall = cb_fall self.cbf_args = cbf_args self.pinval = pin.value() self.sreader = asyncio.StreamReader(self) loop = asyncio.get_event_loop() loop.create_task(self.run()) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.sreader.read(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, _)</span></span></span><span class="hljs-function">:</span></span> v = self.pinval <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.cb_rise <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.cb_rise(*self.cbr_args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.cb_fall <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.cb_fall(*self.cbf_args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, arg)</span></span></span><span class="hljs-function">:</span></span> ret = MP_STREAM_ERROR <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req == MP_STREAM_POLL: ret = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg &amp; MP_STREAM_POLL_RD: v = self.pin.value() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v != self.pinval: self.pinval = v ret = MP_STREAM_POLL_RD <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et encore une fois - sur l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel </font><b><font style="vertical-align: inherit;">, le</font></b><font style="vertical-align: inherit;"> retard peut √™tre √©lev√©. Selon la conception de l'application, la version </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut √™tre plus efficace. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©mo iorw.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> illustre un exemple complet. Veuillez noter qu'au moment de la r√©daction de l'article dans l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel, </font><font style="vertical-align: inherit;">il y a une erreur qui </font></font><a href="http://github.com/micropython/pull/3836" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne fonctionne pas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il y a deux solutions. La solution consiste √† √©crire deux pilotes distincts, l'un en lecture seule et l'autre en √©criture seule. La seconde consiste √† utiliser </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui r√©sout ce probl√®me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel </font><b><font style="vertical-align: inherit;">, les</font></b><font style="vertical-align: inherit;"> entr√©es / sorties sont pr√©vues assez </font></font><a href="http://github.com/micropython/micropython/issues/2664" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rarement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.5 Exemple complet: aremote.py</font></font></b> <br><br> <a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le pilote est</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con√ßu pour recevoir / d√©coder les signaux d'une t√©l√©commande infrarouge. Le pilote</font></font><a href="http://github.com/peterhinch/micropython-async/blob/master/nec_ir/aremote.py" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aremote.py lui-m√™me</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Les notes suivantes sont importantes concernant l'utilisation de</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'interruption sur le contact enregistre l'heure du changement d'√©tat (en microsecondes) et d√©finit l'√©v√©nement, sautant l'heure √† laquelle le premier changement d'√©tat s'est produit. La coroutine attend un √©v√©nement, signale la dur√©e du paquet de donn√©es, puis d√©code les donn√©es stock√©es avant d'appeler le rappel sp√©cifi√© par l'utilisateur.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le passage du temps √† une instance d'</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©v√©nement</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet √† la coroutine de compenser tout</font><font style="vertical-align: inherit;">retard</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asynchrone</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lors de la d√©finition de la p√©riode de retard.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6.6 Capteur environnemental HTU21D</font></font></b> <br><br> <a href="http://github.com/peterhinch/micropython-async/blob/master/nec_ir/aremote.py" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pilote de puce HTU21D fournit des mesures pr√©cises de temp√©rature et d'humidit√©.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La puce a besoin d'environ 120 ms pour recevoir les deux √©l√©ments de donn√©es. Le pilote fonctionne de mani√®re asynchrone, initiant la r√©ception et l'utilisation de l'</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attente asyncio.sleep (t)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avant de lire les donn√©es, met √† jour les variables de temp√©rature et d'humidit√©, accessibles √† tout moment, ce qui permet de lancer d'autres coroutines pendant que le pilote de la puce est en cours d'ex√©cution.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. Trucs et astuces </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1 Le programme se bloque Le gel</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se produit g√©n√©ralement parce que la t√¢che est bloqu√©e sans concession: cela entra√Ænera le gel de l'ensemble du syst√®me. Lors du d√©veloppement, il est utile d'avoir une coroutine qui allume p√©riodiquement la LED int√©gr√©e. Cela confirme que le planificateur est toujours en cours d'ex√©cution.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2 uasyncio enregistre l'√©tat</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lors du d√©marrage de programmes utilisant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans REPL, effectuez une r√©initialisation </font><font style="vertical-align: inherit;">logicielle </font><font style="vertical-align: inherit;">(ctrl-D) entre les d√©marrages. Du fait que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conserve son √©tat entre les d√©marrages, un comportement impr√©visible peut se produire au prochain d√©marrage. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3 Collecte des ordures</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vous pouvez ex√©cuter une coroutine en sp√©cifiant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'abord gc d'importation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs">gc.collect () gc.treshold ( gc.mem_free () // <span class="hljs-number"><span class="hljs-number">4</span></span> + gc.mem_alloc ())</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le but de ceci est discut√© </font></font><a href="http://docs.micropython.org/en/latest/reference/constrained.html" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la section tas. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4 Test</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il est conseill√© de s'assurer que le pilote de p√©riph√©rique garde le contr√¥le si n√©cessaire, ce qui peut √™tre fait en ex√©cutant une ou plusieurs copies de coroutines fictives qui d√©marrent le cycle d'impression des messages et en v√©rifiant qu'il s'ex√©cute pendant les p√©riodes o√π le pilote est en mode veille:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Roundrobin '</span></span>, n) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä titre d'exemple du type de danger pouvant survenir, dans l'exemple ci-dessus, la </font><font style="vertical-align: inherit;">m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecordOrientedUart </font></font></i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__ a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©t√© initialement √©crite comme </font><i><font style="vertical-align: inherit;">suit</font></i><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.endswith(self.DELIMITER): <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.uart.any(): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) data = <span class="hljs-string"><span class="hljs-string">b''</span></span>.join((data, self.uart.read(self.uart.any()))) self.data = data</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cons√©quence, l'ex√©cution est √©tir√©e jusqu'√† ce que l'enregistrement entier soit re√ßu, ainsi que le fait que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uart.any ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoie toujours un nombre diff√©rent de z√©ro de caract√®res re√ßus. Au moment de l'appel, tous les caract√®res peuvent d√©j√† √™tre re√ßus. Cette situation peut √™tre r√©solue √† l'aide d'une boucle externe:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.endswith(self.DELIMITER): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment"># ,  : while not self.uart.any(): yield from asyncio.sleep(0) #        data = b''.join((data, self.uart.read(self.uart.any()))) self.data = data</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il convient de noter que cette erreur n'aurait pas √©t√© √©vidente si les donn√©es avaient √©t√© envoy√©es √† l'UART √† une vitesse inf√©rieure, plut√¥t que d'utiliser un test de r√©troaction. Bienvenue aux joies de la programmation en temps r√©el. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5 Erreur commune</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si une fonction ou une m√©thode est d√©finie par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ensuite appel√©e comme s'il s'agissait d'un appel r√©gulier (synchrone), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython n'affiche</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas de message d'erreur. C'est par conception. Cela conduit g√©n√©ralement au fait que le programme ne fonctionne pas correctement en silence:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># code loop.create_task(foo) #  1 1: foo     foo() #  2: .</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai une </font></font><a href="http://github.com/micropython-lib/pull/292" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suggestion</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui sugg√®re de corriger la situation dans l'option 1 en utilisant </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le module </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">check_async_code.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> essaie de d√©tecter les cas d'utilisation douteuse de coroutines. Il est √©crit en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et est con√ßu pour fonctionner sur un PC. Utilis√© dans des scripts √©crits conform√©ment aux directives d√©crites dans ce guide avec des coroutines d√©clar√©es utilisant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le module prend un argument, le chemin d'acc√®s au fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> source </font><font style="vertical-align: inherit;">(ou --help).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veuillez noter qu'il est quelque peu grossier et est destin√© √† √™tre utilis√© dans un fichier syntaxiquement correct, qui ne d√©marre pas par d√©faut. </font><font style="vertical-align: inherit;">Utilisez un outil, tel que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylint,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour la v√©rification g√©n√©rale de la syntaxe ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylint</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'a actuellement pas cette erreur). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le script produit des faux positifs. </font><font style="vertical-align: inherit;">Selon le plan, les coroutines sont des objets de premier niveau; elles peuvent √™tre transf√©r√©es vers des fonctions et stock√©es dans des structures de donn√©es. </font><font style="vertical-align: inherit;">Selon la logique du programme, vous pouvez enregistrer la fonction ou le r√©sultat de son ex√©cution. </font><font style="vertical-align: inherit;">Le script ne peut pas d√©terminer l'intention. </font><font style="vertical-align: inherit;">Il vise √† ignorer les cas qui semblent corrects lors de l'identification d'autres cas √† consid√©rer. </font><font style="vertical-align: inherit;">Supposons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o√π la coroutine est d√©clar√©e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><br><pre> <code class="python hljs">loop.run_until_complete(foo()) <span class="hljs-comment"><span class="hljs-comment">#   bar(foo) #     ,      bar(foo()) z = (foo,) z = (foo(),) foo() #  :   .</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je le trouve utile tel quel, mais les am√©liorations sont toujours les bienvenues. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6 Programmation avec prises ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prises</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il existe deux approches de </font><font style="vertical-align: inherit;">base pour la </font><font style="vertical-align: inherit;">programmation des </font><font style="vertical-align: inherit;">prises </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par d√©faut, les sockets sont bloqu√©s jusqu'√† la fin de l'op√©ration de lecture ou d'√©criture sp√©cifi√©e. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prend en charge le verrouillage de socket √† l'aide de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select.poll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour emp√™cher le planificateur de les bloquer. Dans la plupart des cas, ce m√©canisme est plus simple √† utiliser. Un exemple de code client et serveur se trouve dans le r√©pertoire </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">client_server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Userver</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilise l'application </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select.poll en</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interrogeant explicitement le socket du serveur.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les sockets client l'utilisent implicitement dans le sens o√π le moteur de streaming </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilise directement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veuillez noter que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.getaddrinfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est actuellement bloqu√©. Le temps dans l'exemple de code sera minimal, mais si une recherche DNS est requise, la p√©riode de blocage peut √™tre importante. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une deuxi√®me approche de la programmation des sockets consiste √† utiliser des sockets non bloquants. Cela ajoute de la complexit√©, mais est n√©cessaire dans certaines applications, surtout si la connexion se fait via WiFi (voir ci-dessous). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au moment d'√©crire ces lignes (mars 2019), le support TLS pour les sockets non bloquants √©tait en cours de d√©veloppement. Son statut exact est inconnu (pour moi).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisation de prises non bloquantes n√©cessite une certaine attention aux d√©tails. Si des lectures non bloquantes se produisent en raison de la latence du serveur, il n'y a aucune garantie que toutes (ou certaines) des donn√©es demand√©es seront retourn√©es. De m√™me, les entr√©es peuvent ne pas se terminer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par cons√©quent, les m√©thodes de lecture et d'√©criture asynchrones doivent effectuer de mani√®re it√©rative une op√©ration non bloquante jusqu'√† ce que les donn√©es requises soient lues ou √©crites. En pratique, un d√©lai d'attente peut √™tre n√©cessaire pour faire face aux pannes de serveur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une autre complication est que le port ESP32 avait des probl√®mes qui n√©cessitaient des effractions assez d√©sagr√©ables pour un fonctionnement sans erreur. Je n'ai pas v√©rifi√© si c'est toujours le cas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module </font></font><a href="" rel="nofollow"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sock_nonblock.py</font></font></b></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">illustre les m√©thodes requises. Ce n'est pas une d√©monstration de travail et les d√©cisions sont susceptibles de d√©pendre de l'application. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.1 Probl√®mes avec le WiFi</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le m√©canisme de streaming </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio n'est</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas la meilleure option pour d√©tecter les pannes WiFi. J'ai trouv√© n√©cessaire d'utiliser des sockets non bloquants pour fournir un fonctionnement √† s√©curit√© int√©gr√©e et reconnecter le client en cas de panne. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">document</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©crit les probl√®mes que j'ai rencontr√©s dans les applications WiFi qui gardent les sockets ouverts pendant de longues p√©riodes et d√©crit la solution. </font></font><br><br> <a href="http://guthub.com/peterhinch/micropython-mqtt" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pltcm</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offre un client MQTT asynchrone robuste qui assure l'int√©grit√© des messages lors des pannes WiFi. Une simple liaison s√©rie en duplex int√©gral asynchrone entre un client sans fil et un serveur c√¢bl√© avec livraison garantie des messages est d√©crite. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.7 Arguments du constructeur de la boucle d'√©v√©nements</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une petite erreur peut se produire si vous devez cr√©er une boucle d'√©v√©nements avec des valeurs qui diff√®rent des valeurs par d√©faut. Une telle boucle doit √™tre d√©clar√©e avant d'ex√©cuter tout autre code utilisant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> car ces valeurs peuvent √™tre requises dans ce code. Sinon, le code sera initialis√© avec des valeurs par d√©faut:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> some_module bar = some_module.Bar() <span class="hljs-comment"><span class="hljs-comment">#   get_event_loop() #     loop = asyncio.get_event_loop(runq_len=40, waitq_len=40)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtant donn√© que l'importation d'un module peut ex√©cuter du code, le moyen le plus s√ªr consiste √† instancier une boucle d'√©v√©nements imm√©diatement apr√®s l'importation d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio loop = asyncio.get_event_loop(runq_len=<span class="hljs-number"><span class="hljs-number">40</span></span>, waitq_len=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> some_module bar = some_module.Bar() <span class="hljs-comment"><span class="hljs-comment"># get_event_loop()   </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de l'√©criture de modules √† utiliser par d'autres programmes, je pr√©f√®re √©viter d'ex√©cuter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code </font><b><font style="vertical-align: inherit;">uasyncio</font></b><font style="vertical-align: inherit;"> lors de l'importation. </font><font style="vertical-align: inherit;">Ecrivez des fonctions et des m√©thodes pour attendre une boucle d'√©v√©nement comme argument. </font><font style="vertical-align: inherit;">Assurez-vous ensuite que seules les applications de niveau sup√©rieur appellent </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_event_loop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> my_module <span class="hljs-comment"><span class="hljs-comment">#      loop = asyncio.get_event_loop(runq_len=40, waitq_len=40) bar = my_module.Bar(loop)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette question est discut√©e </font></font><a href="http://github.com/micropython/micropython-lib/issues/295" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 notes pour les d√©butants</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ces notes sont destin√©es aux d√©butants en code asynchrone et commencent par une description des probl√®mes que les planificateurs tentent de r√©soudre, ainsi que donner un aper√ßu de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> approche </font><b><font style="vertical-align: inherit;">uasyncio des</font></b><font style="vertical-align: inherit;"> solutions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La section 8.5 pr√©sente les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avantages relatifs des</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> modules </font><b><font style="vertical-align: inherit;">uasyncio</font></b><font style="vertical-align: inherit;"> et _ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ainsi que les raisons pour lesquelles vous pr√©f√©rerez peut-√™tre utiliser les coroutines </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio avec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> une planification proactive (_thread). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.1 Probl√®me 1: boucles d'√©v√©nements</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une application de firmware typique fonctionne en continu et doit en m√™me temps r√©pondre √† des √©v√©nements externes, qui peuvent inclure un changement de tension sur l'ADC, l'apparition d'une interruption mat√©rielle, ou un symbole re√ßu dans l'UART, ou des donn√©es disponibles sur la prise. Ces √©v√©nements se produisent de mani√®re asynchrone et le code doit pouvoir r√©pondre quel que soit l'ordre dans lequel ils se produisent. De plus, des t√¢ches en fonction du temps peuvent √™tre n√©cessaires, telles que des voyants clignotants. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fa√ßon √©vidente de le faire est d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utiliser la boucle d'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©v√©nements </font><b><font style="vertical-align: inherit;">uasycio</font></b><font style="vertical-align: inherit;"> . Cet exemple n'est pas un code pratique, mais sert √† illustrer la forme g√©n√©rale de la boucle d'√©v√©nements.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> led_1_time = <span class="hljs-number"><span class="hljs-number">0</span></span> led_1_period = <span class="hljs-number"><span class="hljs-number">20</span></span> led_2_time = <span class="hljs-number"><span class="hljs-number">0</span></span> led_2_period = <span class="hljs-number"><span class="hljs-number">30</span></span> switch_state = switch.state() <span class="hljs-comment"><span class="hljs-comment">#    while True: time_now = utime.time() if time_now &gt;= led_1_time: #  LED #1 led1.toggle() led_1_time = time_now + led_1_period if time_now &gt;= led_2_time: #  LED #2 led2.toggle() led_2_time = time_now + led_2_period #    LEDs if switch.value() != switch_state: switch_state = switch.value() #  - if uart.any(): #    UART</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une telle boucle fonctionne pour des exemples simples, mais √† mesure que le nombre d'√©v√©nements augmente, le code devient rapidement lourd. Ils violent √©galement les principes de la programmation orient√©e objet en combinant la plupart de la logique du programme en un seul endroit, plut√¥t que de lier le code √† un objet contr√¥l√©. Nous voulons d√©velopper une classe pour une LED clignotante qui peut √™tre ins√©r√©e dans un module et import√©e. L'approche OOP du clignotement des LED peut ressembler √† ceci:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LED_flashable</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, led_no)</span></span></span><span class="hljs-function">:</span></span> self.led = pyb.LED(led_no) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, period)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: self.led.toggle() <span class="hljs-comment"><span class="hljs-comment"># -     period, #         </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le planificateur dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous permet de cr√©er de telles classes. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.2 Probl√®me 2: m√©thodes de blocage</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Supposons que vous ayez besoin de lire un certain nombre d'octets √† partir d'un socket. Si vous appelez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.read (n)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec une socket bloquante par d√©faut, il "bloquera" (c'est-√†-dire qu'il ne pourra pas se terminer) jusqu'√† ce que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> octets </font><font style="vertical-align: inherit;">soient re√ßus </font><font style="vertical-align: inherit;">. Pendant cette p√©riode, l'application ne r√©pondra pas aux autres √©v√©nements. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l'aide du socket </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> non bloquant </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> vous pouvez √©crire une m√©thode de lecture asynchrone. Une t√¢che qui n√©cessite des donn√©es sera (n√©cessairement) bloqu√©e jusqu'√† leur r√©ception, mais d'autres t√¢ches seront effectu√©es pendant cette p√©riode, ce qui permettra √† l'application de rester r√©active.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.3. Approches Uasyncio</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La classe suivante a une LED qui peut √™tre allum√©e et √©teinte, et vous pouvez √©galement clignoter √† n'importe quelle vitesse. L'instance </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED_async</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilise la m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui peut √™tre utilis√©e pour un fonctionnement continu. Le comportement des LED peut √™tre contr√¥l√© √† l'aide des m√©thodes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on (), off ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash (secs)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LED_async</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, led_no)</span></span></span><span class="hljs-function">:</span></span> self.led = pyb.LED(led_no) self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span> loop = asyncio.get_event_loop() loop.create_task(self.run()) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.rate &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.led.toggle() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(int(<span class="hljs-number"><span class="hljs-number">500</span></span> / self.rate)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, rate)</span></span></span><span class="hljs-function">:</span></span> self.rate = rate <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.led.on() self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">off</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.led.off() self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il convient de noter que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on (), off ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont des m√©thodes synchrones ordinaires. Ils modifient le comportement de la LED, mais reviennent imm√©diatement. Le clignotement se produit "en arri√®re-plan". Ceci est expliqu√© en d√©tail dans la section suivante. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La classe respecte le principe OOP, qui consiste √† stocker dans la classe la logique associ√©e au dispositif. Dans le m√™me temps, l'utilisation de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> garantit que l'application peut r√©pondre √† d'autres √©v√©nements pendant que le voyant clignote. Le programme ci-dessous clignote avec quatre LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† diff√©rentes fr√©quences, et r√©pond √©galement au bouton USR, qui le compl√®te.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> led_async <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LED_async <span class="hljs-comment"><span class="hljs-comment"># ,   async def killer(): # ,      sw = pyb.Switch() while not sw.value(): await asyncio.sleep_ms(100) leds = [LED_async(n) for n in range(1, 4)] for n, led in enumerate(leds): led.flash(0.7 + n/4) loop = asyncio.get_event_loop() loop.run_until_complete(killer())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contrairement au premier exemple de boucle d'√©v√©nement, la logique associ√©e au commutateur est dans une fonction distincte de la fonctionnalit√© de la LED. </font><font style="vertical-align: inherit;">Faites attention au code utilis√© pour d√©marrer le planificateur:</font></font><br><br><pre> <code class="python hljs">loop = asyncio.get_event_loop() loop.run_until_complete(killer()) <span class="hljs-comment"><span class="hljs-comment">#    #       killer (), #   .</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.4 Planification dans uasyncio </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python 3.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prennent en charge le concept d'une fonction asynchrone, √©galement appel√©e coroutine ou t√¢che. </font><font style="vertical-align: inherit;">Une coroutine doit inclure au moins une instruction d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10</span></span>): print(<span class="hljs-string"><span class="hljs-string">'Hello world.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette fonction imprime un message dix fois √† des intervalles d'une seconde. Pendant que la fonction est suspendue en pr√©vision d'un retard, le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">planificateur asyncio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> effectuera d'autres t√¢ches, cr√©ant l'illusion de les ex√©cuter simultan√©ment. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsqu'un probl√®me de coroutine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attend asyncio.sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attend asyncio.sleep (), la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t√¢che en cours est suspendue et plac√©e dans une file d'attente qui est ordonn√©e par le temps et l'ex√©cution passe √† la t√¢che en haut de la file d'attente. La file d'attente est con√ßue de telle sorte que, m√™me si le mode veille sp√©cifi√© est z√©ro, d'autres t√¢ches pertinentes seront ex√©cut√©es jusqu'√† la reprise du courant. Il s'agit d'une planification ¬´honn√™te circulaire¬ª. Il est courant d'ex√©cuter des </font><i><font style="vertical-align: inherit;">boucles asyncio.sleep (0) en attente</font></i><font style="vertical-align: inherit;"> .</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin que la t√¢che ne retarde pas l'ex√©cution. </font><font style="vertical-align: inherit;">Ce qui suit est une boucle d'occupation en attente d'une autre t√¢che pour d√©finir la variable d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicateur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> global </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">H√©las, il monopolise le processeur, emp√™chant le lancement d'autres coroutines:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bad_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> flag <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> flag: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment">#  flag = False #    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le probl√®me ici est que jusqu'√† ce que la boucle </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flagis False passe le</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contr√¥le au planificateur, aucune autre t√¢che ne sera d√©marr√©e. </font><font style="vertical-align: inherit;">La bonne approche:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">good_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> flag <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> flag: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  flag = False #    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour la m√™me raison, il est incorrect de d√©finir des retards, par exemple, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utime.sleep (1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> car il bloque les autres t√¢ches pendant 1 s; il est plus correct d'utiliser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendre asyncio.sleep (1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veuillez noter que les retards g√©n√©r√©s par les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©thodes uasyncio </font></font></b> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep_ms</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peuvent en fait d√©passer la </font><i><font style="vertical-align: inherit;">dur√©e</font></i><font style="vertical-align: inherit;"> sp√©cifi√©e. Cela est d√ª au fait que d'autres t√¢ches seront effectu√©es pendant le retard. Apr√®s la p√©riode de retard avant l' </font><font style="vertical-align: inherit;">ex√©cution reprend jusqu'√† ce que la t√¢che en </font><font style="vertical-align: inherit;">cours d' </font><font style="vertical-align: inherit;">ex√©cution ne donnera pas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">await</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou quittes. Une coroutine bien √©lev√©e d√©clarera toujours </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† intervalles r√©guliers. Lorsqu'un d√©lai exact est requis, en particulier s'il est inf√©rieur √† quelques ms, il peut √™tre n√©cessaire d'utiliser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utime.sleep_us (us)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.5 Pourquoi une planification collaborative et non bas√©e sur les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">threads</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><i><font style="vertical-align: inherit;">_thread</font></i><font style="vertical-align: inherit;"> )?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La r√©action initiale des d√©butants √† l'id√©e de co-planification des coroutines est souvent d√©cevante. La planification du streaming est s√ªrement mieux? Pourquoi devrais-je explicitement donner le contr√¥le de la mani√®re si la machine virtuelle Python peut le faire pour moi? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En mati√®re de syst√®mes embarqu√©s, le mod√®le de collaboration pr√©sente deux avantages.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le premier est l√©ger. Il est possible d'avoir un grand nombre de coroutines, car contrairement aux threads planifi√©s, les coroutines suspendues prennent moins de place. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®mement, cela √©vite certains des probl√®mes subtils associ√©s √† la planification du streaming. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En pratique, le multit√¢che collaboratif est largement utilis√©, en particulier dans les applications d'interface utilisateur. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour d√©fendre le mod√®le de planification du streaming, je vais montrer un avantage: si quelqu'un √©crit</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range ( <span class="hljs-number"><span class="hljs-number">1000000</span></span> ): <span class="hljs-comment"><span class="hljs-comment">#  - </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il ne bloquera pas d'autres t√¢ches. Le mod√®le de collaboration suppose que la boucle doit explicitement donner au contr√¥le de chaque t√¢che un certain nombre d'it√©rations, par exemple, mettre du code dans une coroutine et √©mettre p√©riodiquement en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendant asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√©las, cet avantage est p√¢le par rapport aux inconv√©nients. Certains d'entre eux sont d√©crits dans la documentation pour l'√©criture des </font></font><a href="http://docs.micropython.org/en/latest/reference/isr_rules.html" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gestionnaires d'interruption.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dans un mod√®le de planification de streaming, chaque thread peut interrompre tout autre thread, modifiant les donn√©es qui peuvent √™tre utilis√©es dans d'autres threads. En r√®gle g√©n√©rale, il est beaucoup plus facile de trouver et de corriger un verrou qui se produit en raison d'une erreur qui ne donne pas de r√©sultat que la d√©tection d'erreurs parfois tr√®s subtiles et rarement rencontr√©es qui peuvent se produire dans du code √©crit dans le cadre d'un mod√®le avec planification en streaming. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autrement dit, si vous √©crivez une coroutine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous pouvez √™tre s√ªr que les variables ne seront pas soudainement modifi√©es par une autre coroutine: votre coroutine a le contr√¥le total jusqu'√† ce qu'elle </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retourne attend asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gardez √† l'esprit que les gestionnaires d'interruption sont pr√©ventifs. Cela s'applique aux interruptions mat√©rielles et logicielles qui peuvent se produire n'importe o√π dans votre code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une discussion √©loquente sur les probl√®mes de planification du streaming peut √™tre trouv√©e </font></font><a href="http://glyph.twistedmatrix.com/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.6 Interaction</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dans les applications non triviales, les coroutines doivent interagir. Des m√©thodes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conventionnelles peuvent √™tre utilis√©es </font><font style="vertical-align: inherit;">. Il s'agit notamment d'utiliser des variables globales ou de d√©clarer des coroutines comme m√©thodes d'objet: elles peuvent partager des variables d'instance. Alternativement, un objet mutable peut √™tre pass√© comme argument √† une coroutine.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le mod√®le de planification de la diffusion en continu n√©cessite des sp√©cialistes pour garantir que les classes fournissent une connexion s√©curis√©e; </font><font style="vertical-align: inherit;">dans un mod√®le de collaboration, cela est rarement n√©cessaire. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.7. </font><font style="vertical-align: inherit;">Sondage ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Polling</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Certains p√©riph√©rique mat√©riel tel qu'un acc√©l√©rom√®tre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ne prend pas en </font><font style="vertical-align: inherit;">charge les </font><font style="vertical-align: inherit;">interruptions, et doit donc √™tre interrog√© ( √† </font><font style="vertical-align: inherit;">savoir v√©rifi√© p√©riodiquement). </font><font style="vertical-align: inherit;">L'interrogation peut √©galement √™tre utilis√©e conjointement avec des gestionnaires d'interruption: le gestionnaire d'interruption maintient l'√©quipement et d√©finit un indicateur. </font><font style="vertical-align: inherit;">La coroutine interroge le drapeau - s'il est d√©fini, les donn√©es sont trait√©es et le drapeau est r√©initialis√©. </font><font style="vertical-align: inherit;">La meilleure approche consiste √† utiliser la classe </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484472/">https://habr.com/ru/post/fr484472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484462/index.html">Scraping Github: recherche de "secrets" √† d√©velopper</a></li>
<li><a href="../fr484464/index.html">Ventes de motos japonaises, comment tout cela se passe</a></li>
<li><a href="../fr484466/index.html">Les promesses JavaScript courantes sont importantes pour tout le monde</a></li>
<li><a href="../fr484468/index.html">La culture d'entreprise rouge est le principal probl√®me des entreprises russes (partie 2)</a></li>
<li><a href="../fr484470/index.html">Extensions extensibles en JavaScript</a></li>
<li><a href="../fr484480/index.html">La capitalisation des 5 plus grandes entreprises technologiques am√©ricaines a d√©pass√© les 5 billions de dollars</a></li>
<li><a href="../fr484482/index.html">Un petit programme √©ducatif sur le traitement de l'eau</a></li>
<li><a href="../fr484484/index.html">Ubuntu n'est pas le meilleur Linux de bureau</a></li>
<li><a href="../fr484486/index.html">Un ordinateur qui refuse de mourir</a></li>
<li><a href="../fr484488/index.html">√Ä quel point un syst√®me quantique est-il d√©routant? La r√©ponse n'est peut-√™tre pas calculable.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>