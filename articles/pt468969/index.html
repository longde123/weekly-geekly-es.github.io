<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¥üèΩ ‚è´ üí™üèª Crie usu√°rios do Google a partir do PowerShell via API ‚è∞ üî™ üë©üèæ‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi 

 Este artigo descreve como o PowerShell interage com a API do Google para manipular os usu√°rios do G Suite. 

 Na organiza√ß√£o, usamos v√°rios serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crie usu√°rios do Google a partir do PowerShell via API</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468969/">  Oi <br><br>  Este artigo descreve como o PowerShell interage com a API do Google para manipular os usu√°rios do G Suite. <br><br>  Na organiza√ß√£o, usamos v√°rios servi√ßos internos e em nuvem.  Na maioria das vezes, a autoriza√ß√£o neles se resume ao Google ou ao Active Directory, entre os quais n√£o podemos manter uma r√©plica, respectivamente, quando um novo funcion√°rio √© liberado, voc√™ precisa criar / ativar uma conta nesses dois sistemas.  Para automatizar o processo, decidimos escrever um script que coleta informa√ß√µes e as envia para os dois servi√ßos. <br><a name="habracut"></a><br><h3>  <font color="#5D8DDF">Entrar</font> </h3><br>  Ao compor os requisitos, decidimos usar pessoas reais como administradores para autoriza√ß√£o, simplificando a an√°lise de a√ß√µes em caso de mudan√ßas maci√ßas acidentais ou intencionais. <br><br>  As APIs do Google usam o protocolo OAuth 2.0 para autentica√ß√£o e autoriza√ß√£o.  Casos de uso e uma descri√ß√£o mais detalhada podem ser encontrados aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Uso do OAuth 2.0 para acessar APIs do Google</a> . <br><br>  Eu escolhi o script usado para autoriza√ß√£o em aplicativos da √°rea de trabalho.  H√° tamb√©m uma op√ß√£o para usar uma conta de servi√ßo que n√£o requer movimentos desnecess√°rios do usu√°rio. <br><br>  A imagem abaixo √© uma descri√ß√£o esquem√°tica do cen√°rio selecionado na p√°gina do Google. <br><br><img src="https://habrastorage.org/webt/wx/sp/rw/wxsprwm-uqyd1koa-2xx4sgjkku.png"><br><br><ol><li>  Primeiro, enviamos o usu√°rio para a p√°gina de autentica√ß√£o na conta do Google, indicando os par√¢metros GET: <br><ul><li>  ID do aplicativo </li><li>  √°reas √†s quais o aplicativo precisa acessar </li><li>  endere√ßo para o qual o usu√°rio ser√° redirecionado ap√≥s a conclus√£o do procedimento </li><li>  a maneira como atualizaremos o token </li><li>  c√≥digo de verifica√ß√£o </li><li>  formato de transmiss√£o do c√≥digo de verifica√ß√£o </li></ul><br></li><li>  Ap√≥s a conclus√£o da autoriza√ß√£o, o usu√°rio ser√° redirecionado para a p√°gina especificada na primeira solicita√ß√£o, com um c√≥digo de erro ou autoriza√ß√£o transmitido pelos par√¢metros GET </li><li>  O aplicativo (script) precisar√° obter esses par√¢metros e, se o c√≥digo for recebido, execute a seguinte solicita√ß√£o de tokens </li><li>  Se a solicita√ß√£o estiver correta, a API do Google retornar√°: <br><br><ul><li>  Token de acesso com o qual podemos fazer solicita√ß√µes </li><li>  Validade deste token </li><li>  Atualize o token necess√°rio para atualizar o token do Access. </li></ul></li></ol><br>  Primeiro, voc√™ precisa acessar o console da API do Google: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Credenciais - Google API Console</a> , selecione o aplicativo desejado e crie o identificador OAuth do cliente na se√ß√£o Credenciais.  No mesmo local (ou posterior, nas propriedades do identificador criado), voc√™ precisa especificar os endere√ßos para os quais o redirecionamento √© permitido.  No nosso caso, haver√° v√°rias entradas de host local com portas diferentes (veja abaixo). <br><br>  Para facilitar a leitura do algoritmo de script, voc√™ pode gerar as primeiras etapas em uma fun√ß√£o separada que retornar√° o Access e atualizar√° os tokens para o aplicativo: <br><br><pre><code class="cs hljs">$client_secret = <span class="hljs-string"><span class="hljs-string">'Our Client Secret'</span></span> $client_id = <span class="hljs-string"><span class="hljs-string">'Our Client ID'</span></span> function Get-GoogleAuthToken { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-not [System.Net.HttpListener]::IsSupported) { <span class="hljs-string"><span class="hljs-string">"HttpListener is not supported."</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span> } $codeverifier = -<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ((<span class="hljs-number"><span class="hljs-number">65.</span></span><span class="hljs-number"><span class="hljs-number">.90</span></span>) + (<span class="hljs-number"><span class="hljs-number">97.</span></span><span class="hljs-number"><span class="hljs-number">.122</span></span>) + (<span class="hljs-number"><span class="hljs-number">48.</span></span><span class="hljs-number"><span class="hljs-number">.57</span></span>) + <span class="hljs-number"><span class="hljs-number">45</span></span> + <span class="hljs-number"><span class="hljs-number">46</span></span> + <span class="hljs-number"><span class="hljs-number">95</span></span> + <span class="hljs-number"><span class="hljs-number">126</span></span> |Get-Random -Count <span class="hljs-number"><span class="hljs-number">60</span></span>| % {[<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>]$_}) $hasher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> System.Security.Cryptography.SHA256Managed $hashByteArray = $hasher.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($codeverifier)) $base64 = ((([System.Convert]::ToBase64String($hashByteArray)).replace(<span class="hljs-string"><span class="hljs-string">'='</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'+'</span></span>,<span class="hljs-string"><span class="hljs-string">'-'</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'/'</span></span>,<span class="hljs-string"><span class="hljs-string">'_'</span></span>) $ports = @(<span class="hljs-number"><span class="hljs-number">10600</span></span>,<span class="hljs-number"><span class="hljs-number">15084</span></span>,<span class="hljs-number"><span class="hljs-number">39700</span></span>,<span class="hljs-number"><span class="hljs-number">42847</span></span>,<span class="hljs-number"><span class="hljs-number">65387</span></span>,<span class="hljs-number"><span class="hljs-number">32079</span></span>) $port = $ports[(<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-random -Minimum <span class="hljs-number"><span class="hljs-number">0</span></span> -maximum <span class="hljs-number"><span class="hljs-number">5</span></span>)] Write-Host <span class="hljs-string"><span class="hljs-string">"Start browser..."</span></span> Start-Process <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/v2/auth?code_challenge_method=S256&amp;code_challenge=$base64&amp;access_type=offline&amp;client_id=$client_id&amp;redirect_uri=http://localhost:$port&amp;response_type=code&amp;scope=https://www.googleapis.com/auth/admin.directory.user https://www.googleapis.com/auth/admin.directory.group"</span></span> $listener = New-Object System.Net.HttpListener $listener.Prefixes.Add(<span class="hljs-string"><span class="hljs-string">"http://localhost:"</span></span>+$port+<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {$listener.Start()} <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-string"><span class="hljs-string">"Unable to start listener."</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (($code -eq $<span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { $context = $listener.GetContext() Write-Host <span class="hljs-string"><span class="hljs-string">"Connection accepted"</span></span> -f <span class="hljs-string"><span class="hljs-string">'mag'</span></span> $url = $context.Request.RawUrl $code = $url.split(<span class="hljs-string"><span class="hljs-string">'?'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($url.split(<span class="hljs-string"><span class="hljs-string">'?'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] -eq <span class="hljs-string"><span class="hljs-string">'error'</span></span>) { Write-Host <span class="hljs-string"><span class="hljs-string">"Error!"</span></span>$code -f <span class="hljs-string"><span class="hljs-string">'red'</span></span> $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>+$code) $context.Response.ContentLength64 = $buffer.Length $context.Response.OutputStream.Write($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, $buffer.Length) $context.Response.OutputStream.Close() $listener.Stop() exit <span class="hljs-number"><span class="hljs-number">1</span></span> } $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"Now you can close this browser tab."</span></span>) $context.Response.ContentLength64 = $buffer.Length $context.Response.OutputStream.Write($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, $buffer.Length) $context.Response.OutputStream.Close() $listener.Stop() } Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span> -Body @{ code = $code client_id = $client_id client_secret = $client_secret redirect_uri = <span class="hljs-string"><span class="hljs-string">'http://localhost:'</span></span>+$port grant_type = <span class="hljs-string"><span class="hljs-string">'authorization_code'</span></span> code_verifier = $codeverifier } $code = $<span class="hljs-literal"><span class="hljs-literal">null</span></span></code> </pre> <br>  Definimos o ID do cliente e o Segredo do cliente obtidos nas propriedades do identificador de cliente OAuth, e o verificador de c√≥digo √© uma sequ√™ncia de 43 a 128 caracteres, que deve ser gerada aleatoriamente a partir de caracteres n√£o reservados: [AZ] / [az] / [0-9 ] / "-" / "."  / "_" / "~". <br><br>  Al√©m disso, este c√≥digo ser√° retransmitido.  Elimina a vulnerabilidade na qual um invasor pode interceptar uma resposta que retornou um redirecionamento ap√≥s a autoriza√ß√£o do usu√°rio. <br>  Voc√™ pode enviar o verificador de c√≥digo na solicita√ß√£o atual de forma clara (o que o torna in√∫til - isso √© adequado apenas para sistemas que n√£o suportam SHA256) ou criando um hash SHA256 que precisa ser codificado em BASE64Url (difere de Base64 em dois caracteres da tabela) e exclui o caractere fim de linha: =. <br><br>  Em seguida, precisamos come√ßar a ouvir http na m√°quina local para obter uma resposta ap√≥s a autoriza√ß√£o, que retornar√° como um redirecionamento. <br><br>  As tarefas administrativas s√£o executadas em um servidor especial, n√£o podemos excluir a possibilidade de v√°rios administradores executarem o script ao mesmo tempo, portanto ele selecionar√° aleatoriamente uma porta para o usu√°rio atual, mas especifiquei portas predefinidas, porque  eles tamb√©m devem ser adicionados como confi√°veis ‚Äã‚Äãno console da API. <br><br>  <i>access_type = offline</i> significa que o aplicativo pode atualizar o token expirado independentemente, sem intera√ß√£o do usu√°rio com o navegador, <br>  <i>response_type = code</i> define o formato de como o c√≥digo retornar√° (consultando o antigo m√©todo de autoriza√ß√£o quando o usu√°rio copiou o c√≥digo do navegador para o script), <br>  <i>scope</i> indica o <i>escopo</i> e o tipo de acesso.  Eles devem ser separados por espa√ßos ou% 20 (de acordo com a codifica√ß√£o de URL).  Uma lista de √°reas de acesso com tipos pode ser vista aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escopos OAuth 2.0 para APIs do Google</a> . <br><br>  Depois de receber o c√≥digo de autoriza√ß√£o, o aplicativo retornar√° uma mensagem de fechamento para o navegador, parar√° de ouvir a porta e enviar√° uma solicita√ß√£o POST para receber o token.  Indicamos nele o ID e o segredo anteriormente definidos da API do console, o endere√ßo para o qual o usu√°rio ser√° redirecionado e o grant_type de acordo com a especifica√ß√£o do protocolo. <br><br>  Em resposta, obteremos um token do Access, sua dura√ß√£o em segundos e um token de atualiza√ß√£o, com o qual podemos atualizar o token do Access. <br><br>  O aplicativo deve armazenar tokens em um local seguro e com uma vida √∫til longa, portanto, at√© revogar o acesso obtido, o token de atualiza√ß√£o n√£o retornar√° ao aplicativo.  No final, adicionei uma solicita√ß√£o para revogar o token, se o aplicativo n√£o tiver sido conclu√≠do com √™xito e o token de atualiza√ß√£o n√£o retornar, ele iniciar√° o procedimento novamente (consideramos inseguro armazenar tokens localmente no terminal, mas n√£o queremos complicar a criptografia ou abrir frequentemente o navegador). <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $token_result = Get-GoogleAuthToken $token = $token_result.<span class="hljs-function"><span class="hljs-function">access_token </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$token_result.refresh_token -eq $</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { Write-Host (<span class="hljs-string"><span class="hljs-string">"Session is not destroyed. Revoking token..."</span></span>) Invoke-WebRequest -Uri (<span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/revoke?token="</span></span>+$token) } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($token_result.refresh_token -eq $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) $refresh_token = $token_result.refresh_token $minute = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:mm}"</span></span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Minute)<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($minute -lt <span class="hljs-number"><span class="hljs-number">0</span></span>) {$minute += <span class="hljs-number"><span class="hljs-number">60</span></span>} elseif ($minute -gt <span class="hljs-number"><span class="hljs-number">59</span></span>) {$minute -=<span class="hljs-number"><span class="hljs-number">60</span></span>} $token_expire = @{ hour = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:hh}"</span></span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Hour) minute = $minute }</code> </pre><br>  Como voc√™ deve ter notado, ao invocar um token, Invoke-WebRequest √© usado.  Ao contr√°rio de Invoke-RestMethod, ele n√£o retorna os dados recebidos em um formato conveniente para uso e mostra o status da solicita√ß√£o. <br><br>  Em seguida, o script solicitar√° que voc√™ digite o nome e o sobrenome do usu√°rio, gerando um nome de usu√°rio + email. <br><br><h3>  <font color="#5D8DDF">Inqu√©ritos</font> </h3><br>  A seguir, ser√£o apresentadas as solicita√ß√µes - primeiro, voc√™ precisa verificar se o usu√°rio j√° existe com esse login para obter uma decis√£o de formar um novo ou ativar o atual. <br><br>  Decidi implementar todas as solicita√ß√µes no formato de uma √∫nica fun√ß√£o com uma sele√ß√£o usando o switch: <br><br><pre> <code class="cs hljs">function GoogleQuery { param ( $type, $query ) <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($type) { <span class="hljs-string"><span class="hljs-string">"SearchAccount"</span></span> { Return Invoke-RestMethod -Method Get -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body @{ domain = <span class="hljs-string"><span class="hljs-string">'rocketguys.com'</span></span> query = <span class="hljs-string"><span class="hljs-string">"email:$query"</span></span> } } <span class="hljs-string"><span class="hljs-string">"UpdateAccount"</span></span> { $body = @{ name = @{ givenName = $query[<span class="hljs-string"><span class="hljs-string">'givenName'</span></span>] familyName = $query[<span class="hljs-string"><span class="hljs-string">'familyName'</span></span>] } suspended = <span class="hljs-string"><span class="hljs-string">'false'</span></span> password = $query[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] changePasswordAtNextLogin = <span class="hljs-string"><span class="hljs-string">'true'</span></span> phones = @(@{ primary = <span class="hljs-string"><span class="hljs-string">'true'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = $query[<span class="hljs-string"><span class="hljs-string">'phone'</span></span>] type = <span class="hljs-string"><span class="hljs-string">"mobile"</span></span> }) orgUnitPath = $query[<span class="hljs-string"><span class="hljs-string">'orgunit'</span></span>] } Return Invoke-RestMethod -Method Put -Uri (<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users/"</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]) -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-string"><span class="hljs-string">"CreateAccount"</span></span> { $body = @{ primaryEmail = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] name = @{ givenName = $query[<span class="hljs-string"><span class="hljs-string">'givenName'</span></span>] familyName = $query[<span class="hljs-string"><span class="hljs-string">'familyName'</span></span>] } suspended = <span class="hljs-string"><span class="hljs-string">'false'</span></span> password = $query[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] changePasswordAtNextLogin = <span class="hljs-string"><span class="hljs-string">'true'</span></span> phones = @(@{ primary = <span class="hljs-string"><span class="hljs-string">'true'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = $query[<span class="hljs-string"><span class="hljs-string">'phone'</span></span>] type = <span class="hljs-string"><span class="hljs-string">"mobile"</span></span> }) orgUnitPath = $query[<span class="hljs-string"><span class="hljs-string">'orgunit'</span></span>] } Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-string"><span class="hljs-string">"AddMember"</span></span> { $body = @{ userKey = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] } $ifrequest = Invoke-RestMethod -Method Get -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body $body $array = @() <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $ifrequest.groups) {$array += $<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>.email} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($array -notcontains $query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]) { $body = @{ email = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] role = <span class="hljs-string"><span class="hljs-string">"MEMBER"</span></span> } Return Invoke-RestMethod -Method Post -Uri (<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups/"</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]+<span class="hljs-string"><span class="hljs-string">"/members"</span></span>) -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Return ($query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]+<span class="hljs-string"><span class="hljs-string">" now is a member of "</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]) } } } }</code> </pre> <br>  Em cada solicita√ß√£o, voc√™ precisa enviar um cabe√ßalho de autoriza√ß√£o contendo o tipo de token e o pr√≥prio token de acesso.  No momento, o tipo de token √© sempre Portador.  Porque  precisamos verificar se o token n√£o expirou e atualiz√°-lo ap√≥s uma hora a partir do momento em que foi emitido, indiquei uma solicita√ß√£o para outra fun√ß√£o que retorna um token do Access.  O mesmo trecho de c√≥digo est√° no in√≠cio do script ao receber o primeiro token do Access: <br><br><pre> <code class="cs hljs">function Get-GoogleToken { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((Get-date).Hour -gt $token_expire.hour) -or (((Get-date).Hour -ge $token_expire.hour) -and ((Get-date).Minute -gt $token_expire.minute))) { Write-Host <span class="hljs-string"><span class="hljs-string">"Token Expired. Refreshing..."</span></span> $request = (Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span> -ContentType <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span> -Body @{ client_id = $client_id client_secret = $client_secret refresh_token = $refresh_token grant_type = <span class="hljs-string"><span class="hljs-string">'refresh_token'</span></span> }) $token = $request.access_token $minute = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:mm}"</span></span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Minute)<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($minute -lt <span class="hljs-number"><span class="hljs-number">0</span></span>) {$minute += <span class="hljs-number"><span class="hljs-number">60</span></span>} elseif ($minute -gt <span class="hljs-number"><span class="hljs-number">59</span></span>) {$minute -=<span class="hljs-number"><span class="hljs-number">60</span></span>} $script:token_expire = @{ hour = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:hh}"</span></span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Hour) minute = $minute } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $token }</code> </pre> <br>  Verificando a exist√™ncia do login: <br><br><pre> <code class="cs hljs">function Check_Google { $query = (GoogleQuery <span class="hljs-string"><span class="hljs-string">'SearchAccount'</span></span> $username) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($query.users -ne $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $user = $query.users[<span class="hljs-number"><span class="hljs-number">0</span></span>] Write-Host $user.name.fullName<span class="hljs-string"><span class="hljs-string">' - '</span></span>$user.PrimaryEmail<span class="hljs-string"><span class="hljs-string">' - suspended: '</span></span>$user.Suspended $GAresult = $user } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($GAresult) { $<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = $GAresult } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {$<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = <span class="hljs-string"><span class="hljs-string">'gg'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }</code> </pre> <br>  Solicita√ß√£o de email: $ query solicitar√° √† API que procure o usu√°rio com este email, incluindo aliases.  Voc√™ tamb√©m pode usar curinga: <i>=,:,: {PREFIX} *</i> . <br><br>  Para obter dados, o m√©todo de solicita√ß√£o GET √© usado, para inserir dados (criar uma conta ou adicionar um membro a um grupo) - POST, atualizar dados existentes - PUT, excluir uma entrada (por exemplo, um participante de um grupo) - DELETE. <br><br>  O script tamb√©m solicitar√° um n√∫mero de telefone (uma sequ√™ncia inv√°lida) e o incluir√° em um grupo de distribui√ß√£o regional.  Ele decide qual unidade organizacional o usu√°rio deve ter com base na UO do Active Directory selecionada e criar√° uma senha: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $phone = Read-Host <span class="hljs-string"><span class="hljs-string">"   +7"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (-not $phone) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $moscow = Read-Host <span class="hljs-string"><span class="hljs-string">"  ? (y/n) "</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (-not (($moscow -eq <span class="hljs-string"><span class="hljs-string">'y'</span></span>) -or ($moscow -eq <span class="hljs-string"><span class="hljs-string">'n'</span></span>))) $orgunit = <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($OU -like <span class="hljs-string"><span class="hljs-string">"*OU=Delivery,OU=Users,OU=ROOT,DC=rocket,DC=local"</span></span>) { Write-host <span class="hljs-string"><span class="hljs-string">"   /Team delivery"</span></span> $orgunit = <span class="hljs-string"><span class="hljs-string">"/Team delivery"</span></span> } $Password = -<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ( <span class="hljs-number"><span class="hljs-number">48.</span></span><span class="hljs-number"><span class="hljs-number">.57</span></span> + <span class="hljs-number"><span class="hljs-number">65.</span></span><span class="hljs-number"><span class="hljs-number">.90</span></span> + <span class="hljs-number"><span class="hljs-number">97.</span></span><span class="hljs-number"><span class="hljs-number">.122</span></span> | Get-Random -Count <span class="hljs-number"><span class="hljs-number">12</span></span> | % {[<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>]$_})+<span class="hljs-string"><span class="hljs-string">"*Ba"</span></span></code> </pre><br>  E ent√£o come√ßa a manipular a conta: <br><br><pre> <code class="cs hljs">$query = @{ email = $email givenName = $firstname familyName = $lastname password = $password phone = $phone orgunit = $orgunit } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($GMailExist) { Write-Host <span class="hljs-string"><span class="hljs-string">"  "</span></span> -<span class="hljs-function"><span class="hljs-function">f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mag</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GoogleQuery </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'UpdateAccount'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> $query</span></span></span><span class="hljs-function">) | fl write-host "      $Username  Google." } else</span></span> { Write-Host <span class="hljs-string"><span class="hljs-string">"  "</span></span> -<span class="hljs-function"><span class="hljs-function">f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mag</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GoogleQuery </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'CreateAccount'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> $query</span></span></span><span class="hljs-function">) | fl } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$moscow -eq </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"y"</span></span></span></span></span><span class="hljs-function">)</span></span>{ write-host <span class="hljs-string"><span class="hljs-string">"   moscowoffice"</span></span> $query = @{ groupkey = <span class="hljs-string"><span class="hljs-string">'moscowoffice@rocketguys.com'</span></span> email = $email } (GoogleQuery <span class="hljs-string"><span class="hljs-string">'AddMember'</span></span> $query) | fl }</code> </pre><br>  As fun√ß√µes de atualiza√ß√£o e cria√ß√£o de uma conta t√™m a mesma sintaxe, nem todos os campos adicionais s√£o necess√°rios. Na se√ß√£o com n√∫meros de telefone, √© necess√°rio especificar uma matriz que possa conter de um registro com um n√∫mero e seu tipo. <br><br>  Para n√£o ocorrer um erro ao adicionar um usu√°rio a um grupo, primeiro podemos verificar se ele j√° est√° nesse grupo recebendo uma lista de membros ou composi√ß√£o do grupo do pr√≥prio usu√°rio. <br><br>  <b>Uma solicita√ß√£o para a composi√ß√£o de grupos de um usu√°rio espec√≠fico n√£o ser√° recursiva e mostrar√° apenas associa√ß√£o direta.</b>  A inclus√£o do usu√°rio no grupo pai, no qual o grupo subsidi√°rio do qual o usu√°rio √© membro, j√° √© bem-sucedida. <br><br><h3>  <font color="#5D8DDF">Conclus√£o</font> </h3><br>  Resta enviar ao usu√°rio a senha da nova conta.  Fazemos isso por SMS e enviamos informa√ß√µes gerais com instru√ß√µes e login para correio pessoal, que, juntamente com o n√∫mero de telefone, foi fornecido pelo departamento de sele√ß√£o de pessoal.  Como alternativa, voc√™ pode economizar dinheiro e enviar uma senha para um bate-papo secreto por telegrama, que tamb√©m pode ser considerado o segundo fator (os macbooks ser√£o uma exce√ß√£o). <br><br>  Obrigado por ler at√© o fim.  Ficarei feliz em ver sugest√µes para melhorar o estilo de reda√ß√£o dos artigos e desejo que voc√™ consiga menos erros ao escrever scripts =) <br><br>  Lista de links que podem ser √∫teis em termos tem√°ticos ou apenas responder √†s suas perguntas: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OAuth 2.0 para aplicativos para dispositivos m√≥veis e computadores</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usando o OAuth 2.0 para aplicativos de servidor Web</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Chave de prova para troca de c√≥digo por clientes p√∫blicos do OAuth</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gere letras aleat√≥rias com o PowerShell</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tabela e Descri√ß√£o ASCII</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PowerShell: Obtendo o valor do hash para uma string</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Codificar / Decodificar Base64Url</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Codifica√ß√£o Base64 vs codifica√ß√£o Base64url</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Invoke-RestMethod no PowerShell 5.1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">N√£o obtendo token de atualiza√ß√£o, embora access_type esteja offline na etapa 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sobre operadores de compara√ß√£o</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API do diret√≥rio: contas de usu√°rio</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Procurar usu√°rios</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API do Diret√≥rio: Grupos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tratamento de erros para Invoke-RestMethod - Powershell</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468969/">https://habr.com/ru/post/pt468969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468957/index.html">Gera√ß√£o c√≠clica de masmorras no exemplo de Inexplorado</a></li>
<li><a href="../pt468959/index.html">Gerenciamento de depend√™ncias no projeto de v√°rios m√≥dulos no granizo</a></li>
<li><a href="../pt468961/index.html">Como se livrar da rotina na vida por US $ 560? Ou como viver, n√£o viver</a></li>
<li><a href="../pt468963/index.html">Backup, parte a pedido dos leitores: vis√£o geral do UrBackup, BackupPC, AMANDA</a></li>
<li><a href="../pt468967/index.html">"Tecnologia" de obten√ß√£o de equa√ß√µes de din√¢mica de TAU. E por que a Identifica√ß√£o do sistema √© p√©ssima e a "f√≠sica honesta" governa</a></li>
<li><a href="../pt468971/index.html">Escrevendo em Java para Nintendo DS</a></li>
<li><a href="../pt468973/index.html">Rede neural para classifica√ß√£o de imagens de sat√©lite usando o Tensorflow em Python</a></li>
<li><a href="../pt468989/index.html">Mercado UEBA morre - vida longa UEBA</a></li>
<li><a href="../pt468991/index.html">Personagens modulares de sprites e suas anima√ß√µes</a></li>
<li><a href="../pt468993/index.html">Oculus Quest se conecta a um PC e v√™ as m√£os</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>