<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÇüèæ üöè üö´ [Tradu√ß√£o] Como Graal - Java JVM JVM Compiler funciona üíÖüèΩ üöµüèæ üíáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Apresento a voc√™ a tradu√ß√£o do artigo " Entendendo como o Graal funciona - um compilador Java JIT escrito em Java ". 
 1. Introdu√ß√£o 


 Uma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Tradu√ß√£o] Como Graal - Java JVM JVM Compiler funciona</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419637/"><p> Ol√° Habr!  Apresento a voc√™ a tradu√ß√£o do artigo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Entendendo como o Graal funciona - um compilador Java JIT escrito em Java</a> ". </p><br><h2 id="vvedenie">  1. Introdu√ß√£o </h2><br><p>  Uma das raz√µes pelas quais me tornei um pesquisador em linguagens de programa√ß√£o √© que, em uma grande comunidade de pessoas envolvidas em tecnologia da computa√ß√£o, quase todo mundo usa linguagens de programa√ß√£o, e muitas est√£o interessadas em como elas funcionam.  Quando me deparei com programa√ß√£o quando crian√ßa e me familiarizei com uma linguagem de programa√ß√£o, a primeira coisa que eu queria saber era como ela funciona, e a primeira coisa que eu queria fazer era criar minha pr√≥pria linguagem. </p><br><p>  Nesta apresenta√ß√£o, mostrarei alguns dos mecanismos de trabalho da linguagem que todos voc√™s usam - Java.  A peculiaridade √© que usarei um projeto chamado <em>Graal</em> , que implementa o conceito de <em>Java em Java</em> . </p><a name="habracut"></a><br><p>  Graal √© apenas um dos componentes no trabalho de Java - √© um compilador <em>just-in-time</em> .  Essa √© a parte da JVM que converte o bytecode Java em c√≥digo de m√°quina durante a execu√ß√£o do programa e √© um dos fatores que garantem o alto desempenho da plataforma.  Parece-me tamb√©m que o que a maioria das pessoas considera uma das partes mais complexas e vagas da JVM, que est√° al√©m de sua compreens√£o.  Alterar esta opini√£o √© o objetivo deste discurso. </p><br><p>  Se voc√™ souber o que √© uma JVM;  geralmente entender o que significam os termos <em>bytecode</em> e <em>c√≥digo de m√°quina</em> ;  e capaz de ler c√≥digo escrito em Java, espero que seja suficiente para entender o material apresentado. </p><br><p>  Come√ßarei discutindo por que podemos querer um novo compilador JIT para a JVM escrito em Java e, depois disso, mostrarei que n√£o h√° nada mais especial nisso, como voc√™ pode pensar, dividindo a tarefa em montagem, uso e demonstra√ß√£o do compilador que seu c√≥digo √© o mesmo que em qualquer outro aplicativo. </p><br><p>  Vou abordar um pouco a teoria e depois mostrarei como ela √© aplicada durante todo o processo de compila√ß√£o, do bytecode ao c√≥digo da m√°quina.  Tamb√©m mostrarei alguns detalhes e, no final, falaremos sobre os benef√≠cios desse recurso, al√©m de implementar o <em>Java em Java</em> por si s√≥. </p><br><p>  Usarei as capturas de tela do c√≥digo no Eclipse, em vez de inici√°-las durante a apresenta√ß√£o, para evitar os problemas inevit√°veis ‚Äã‚Äãda codifica√ß√£o ao vivo. </p><br><h2 id="chto-takoe-jit-kompilyator">  O que √© um compilador JIT? </h2><br><p>  Tenho certeza de que muitos de voc√™s sabem o que √© um compilador JIT, mas ainda vou tocar no b√°sico para que ningu√©m fique sentado aqui com medo de fazer essa pergunta principal. </p><br><p> Quando voc√™ executa o comando <code>javac</code> ou <em>compile-on-save</em> no IDE, seu programa Java compila do c√≥digo Java para o bytecode da JVM, que √© a representa√ß√£o bin√°ria do programa.  √â mais compacto e simples que o c√≥digo-fonte Java.  No entanto, o processador comum do seu laptop ou servidor n√£o pode apenas executar o bytecode da JVM. </p><br><p>  Para a opera√ß√£o do seu programa, a JVM interpreta esse bytecode.  Os int√©rpretes geralmente s√£o muito mais lentos que o c√≥digo da m√°quina em execu√ß√£o no processador.  Por esse motivo, a JVM, enquanto o programa est√° em execu√ß√£o, pode iniciar outro compilador que converte seu bytecode em c√≥digo de m√°quina, que o processador j√° pode executar. </p><br><p>  Esse compilador, geralmente muito mais sofisticado que o <code>javac</code> , realiza otimiza√ß√µes complexas para produzir c√≥digo de m√°quina de alta qualidade como resultado. </p><br><h2 id="zachem-pisat-jit-kompilyator-na-java">  Por que escrever um compilador JIT em Java? </h2><br><p>  At√© o momento, uma implementa√ß√£o da JVM chamada <em>OpenJDK</em> inclui dois compiladores JIT principais.  O compilador do cliente, conhecido como <em>C1</em> , foi projetado para opera√ß√£o mais r√°pida, mas, ao mesmo tempo, produz c√≥digo menos otimizado.  O compilador do servidor, conhecido como <em>opto</em> ou <em>C2</em> , requer um pouco mais de tempo para trabalhar, mas produz um c√≥digo mais otimizado. </p><br><p>  A id√©ia era que o compilador cliente fosse mais adequado para aplicativos de desktop, onde longas pausas no compilador JIT eram indesej√°veis ‚Äã‚Äãe o compilador de servidor para aplicativos de servidor de reprodu√ß√£o prolongada, o que poderia levar mais tempo compilando. </p><br><p>  Hoje eles podem ser combinados para que o c√≥digo seja compilado primeiro por C1 e, em seguida, se ele continuar sendo intensamente executado e fizer sentido gastar mais tempo, - C2.  Isso √© chamado de <em>compila√ß√£o em camadas</em> . </p><br><p>  Vamos falar do C2, o compilador de servidores que realiza mais otimiza√ß√µes. </p><br><p>  Podemos clonar o OpenJDK a partir do espelho no <em>GitHub</em> ou simplesmente abrir a √°rvore do projeto no site. </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dmlloyd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openjdk.git</span></span></code> </pre> <br><p>  O c√≥digo C2 est√° em <em>openjdk / hotspot / src / share / vm / opto</em> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/c2.png" alt="C√≥digo Fonte C2"></p><br><p>  Primeiro de tudo, vale a pena notar que C2 √© escrito em <em>C ++</em> .  Obviamente, isso n√£o √© algo ruim, mas h√° certas desvantagens.  C ++ √© uma linguagem insegura.  Isso significa que erros no C ++ podem travar a VM.  A raz√£o para isso √© provavelmente a idade do c√≥digo, mas o c√≥digo C2 C ++ se tornou muito dif√≠cil de manter e desenvolver. </p><br><p>  Uma das principais figuras por tr√°s do compilador C2, Cliff Click, disse que nunca mais escreveria VM novamente em C ++, e ouvimos a equipe da JVM do <em>Twitter</em> dizer que C2 est√° estagnado e precisa ser substitu√≠do por uma raz√£o dificuldades de maior desenvolvimento. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-1.jpeg" alt="Apresenta√ß√£o Cliff Click"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-2.png" alt="O que Cliff Click n√£o quer fazer novamente"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.youtube.com/watch?v=Hqw57GJSrac</a> </p><br><p>  Ent√£o, voltando √† pergunta, o que √© isso em Java que pode ajudar a resolver esses problemas?  A mesma coisa que d√° para escrever um programa em Java em vez de C ++.  Provavelmente, isso √© seguran√ßa (exce√ß√µes em vez de falhas, nenhum vazamento de mem√≥ria real ou ponteiros <em>oscilantes</em> ), bons <em>ajudantes</em> (depuradores, <em>criadores de</em> perfil e ferramentas como <em>VisualVM</em> ), bom suporte a IDE etc. </p><br><p>  Voc√™ pode pensar: <em>Como escrever algo como um compilador Java JIT?</em>  e que isso s√≥ √© poss√≠vel em uma linguagem de programa√ß√£o de sistema de baixo n√≠vel, como C ++.  Nesta apresenta√ß√£o, espero convenc√™-lo de que isso n√£o √© de todo!  Essencialmente, o compilador JIT deve apenas aceitar o bytecode da JVM e fornecer o c√≥digo da m√°quina - voc√™ fornece <code>byte[]</code> na entrada e tamb√©m deseja recuperar o <code>byte[]</code> .  √â preciso muito trabalho complexo para fazer isso, mas n√£o afeta o n√≠vel do sistema e, portanto, n√£o requer uma linguagem de <em>sistema</em> como C ou C ++. </p><br><h2 id="nastroyka-graal">  Configura√ß√£o Graal </h2><br><p>  A primeira coisa que precisamos √© o Java 9. A interface Graal usada, chamada <em>JVMCI,</em> foi adicionada ao Java como parte da <em>Interface do Compilador JVM JEP 243 no n√≠vel Java</em> e a primeira vers√£o que o inclui √© Java 9. Eu uso <em>9 + 181</em> .  No caso de quaisquer requisitos especiais, existem portas (backports) para Java 8. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> export JAVA_HOME=`pwd`/jdk9 <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=<span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> java <span class="hljs-literal"><span class="hljs-literal">-version</span></span> java version <span class="hljs-string"><span class="hljs-string">"9"</span></span> Java(TM) SE Runtime Environment (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>) Java HotSpot(TM) <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-Bit</span></span> Server VM (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>, mixed mode)</code> </pre> <br><p>  A pr√≥xima coisa que precisamos √© de um sistema de constru√ß√£o chamado <code>mx</code> .  √â um pouco como <em>Maven</em> ou <em>Gradle</em> , mas provavelmente voc√™ n√£o o escolheria para o seu aplicativo.  Ele implementa certas funcionalidades para dar suporte a alguns casos de uso complexos, mas a usaremos apenas para montagens simples. </p><br><p>  Voc√™ pode clonar <code>mx</code> com o GitHub.  Estou usando o commit <code>#7353064</code> .  Agora basta adicionar o execut√°vel ao caminho. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/mx.git <span class="hljs-variable"><span class="hljs-variable">$</span></span> cd mx; git checkout <span class="hljs-number"><span class="hljs-number">7353064</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=`pwd`/mx:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  Agora precisamos clonar o pr√≥prio Graal.  Estou usando uma distribui√ß√£o chamada <em>GraalVM</em> vers√£o <em>0.28.2</em> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/graal.git -<span class="hljs-literal"><span class="hljs-literal">-branch</span></span> vm<span class="hljs-literal"><span class="hljs-literal">-enterprise</span></span><span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span></code> </pre> <br><p>  Este reposit√≥rio cont√©m outros projetos nos quais n√£o estamos interessados, ent√£o apenas acessamos o subprojeto do <em>compilador</em> , que √© o compilador Graal JIT, e o compilamos usando <code>mx</code> . </p><br><pre> <code class="hljs ruby">$ cd graal/compiler $ mx build</code> </pre> <br><p>  Para trabalhar com o c√≥digo Graal, usarei o <em>Eclipse IDE</em> .  Estou usando o Eclipse 4.7.1.  <code>mx</code> pode gerar arquivos de projeto Eclipse para n√≥s. </p><br><pre> <code class="hljs ruby">$ mx eclipseinit</code> </pre> <br><p>  Para abrir o diret√≥rio <em>graal</em> como uma √°rea de <em>trabalho,</em> √© necess√°rio executar os <em>arquivos, Importar ..., Geral, Projetos existentes</em> e selecionar o diret√≥rio <em>graal novamente</em> .  Se voc√™ n√£o executou o Eclipse no Java 9, tamb√©m pode ser necess√°rio anexar as fontes JDK. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/eclipse.png" alt="Graal em eclipse"></p><br><p>  Bom  Agora que tudo est√° pronto, vamos ver como funciona.  Vamos usar esse c√≥digo muito simples. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { workload(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  Primeiro, compilamos esse c√≥digo <code>javac</code> e, em seguida, executamos a JVM.  Primeiro, mostrarei como o compilador C2 JIT padr√£o funciona.  Para fazer isso, especificaremos v√°rios sinalizadores: <code>-XX:+PrintCompilation</code> , necess√°rio para a JVM gravar um log ao compilar um m√©todo, e <code>-XX:CompileOnly=Demo::workload</code> , para que apenas esse m√©todo seja compilado.  Caso contr√°rio, muita informa√ß√£o ser√° exibida e a JVM ser√° mais inteligente do que precisamos e otimizar√° o c√≥digo que queremos ver. </p><br><pre> <code class="hljs ruby">$ javac Demo.java $ java \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>+PrintCompilation \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">113</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><p>  N√£o explicarei isso em detalhes, mas direi apenas que essa √© uma sa√≠da de log que mostra que o m√©todo da <code>workload</code> foi compilado. </p><br><p>  Agora, como compilador JIT da nossa JVM Java 9, usamos o Graal rec√©m compilado.  Para fazer isso, adicione mais alguns sinalizadores. </p><br><p>  <code>--module-path=...</code> e <code>--upgrade-module-path=...</code> adicionam Graal ao <em>caminho</em> do <em>m√≥dulo</em> .  Deixe-me lembr√°-lo de que o <em>caminho do m√≥dulo</em> apareceu no Java 9 como parte do sistema de m√≥dulos <em>Jigsaw</em> e, para nossos prop√≥sitos, podemos consider√°-lo por analogia com o <em>caminho de classe</em> . </p><br><p>  Precisamos do <code>-XX:+UnlockExperimentalVMOptions</code> devido ao fato de a JVMCI (a interface usada pelo Graal) nesta vers√£o ser um recurso experimental. </p><br><p>  O sinalizador <code>-XX:+EnableJVMCI</code> necess√°rio para dizer que queremos usar a JVMCI e <code>-XX:+UseJVMCICompiler</code> - para ativar e instalar um novo compilador JIT. </p><br><p>  Para n√£o complicar o exemplo e, em vez de usar C1 em conjunto com a JVMCI, tenha apenas o compilador JVMCI, especifique o sinalizador <code>-XX:-TieredCompilation</code> , que desativar√° a compila√ß√£o por etapas. </p><br><p>  Como antes, especificamos os sinalizadores <code>-XX:+PrintCompilation</code> e <code>-XX:CompileOnly=Demo::workload</code> . </p><br><p>  Como no exemplo anterior, vemos que um m√©todo foi compilado.  Mas, desta vez, para compila√ß√£o, usamos o Graal montado.  Por enquanto, apenas aceite minha palavra. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">583</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><h2 id="interfeys-kompilyatora-jvm">  Interface do Compilador JVM </h2><br><p>  Voc√™ n√£o acha que fizemos algo bastante incomum?  Temos uma JVM instalada e substitu√≠mos o compilador JIT pelo novo compilado sem alterar nada na pr√≥pria JVM.  Esse recurso √© fornecido por uma nova interface da JVM chamada JVMCI, a <em>interface do compilador</em> da <em>JVM</em> , que, como eu disse acima, era o <em>JEP 243</em> e veio no Java 9. </p><br><p>  A ideia √© semelhante a algumas outras tecnologias JVM existentes. </p><br><p>  Talvez voc√™ j√° tenha encontrado um processamento de c√≥digo-fonte adicional em <code>javac</code> usando a <em>API de processamento de anota√ß√£o Java</em> .  Esse mecanismo torna poss√≠vel identificar anota√ß√µes e o modelo de c√≥digo-fonte no qual elas s√£o usadas e criar novos arquivos com base nelas. </p><br><p>  Al√©m disso, voc√™ pode ter utilizado processamento de bytecode adicional na JVM usando <em>agentes Java</em> .  Esse mecanismo permite modificar o bytecode Java interceptando-o no momento da inicializa√ß√£o. </p><br><p>  A ideia da JVMCI √© semelhante.  Permite conectar seu pr√≥prio compilador Java JIT, escrito em Java. </p><br><p>  Agora, quero dizer algumas palavras sobre como mostrarei o c√≥digo durante esta apresenta√ß√£o.  Primeiro, para entender a ideia, mostrarei alguns identificadores e l√≥gicos simplificados na forma de texto nos slides, depois mudarei para as capturas de tela do Eclipse e mostrarei o c√≥digo real, que pode ser um pouco mais complicado, mas a ideia principal permanecer√° a mesma.  A parte principal desta apresenta√ß√£o pretende mostrar que √© realmente poss√≠vel trabalhar com o c√≥digo real do projeto e, portanto, n√£o quero ocult√°-lo, embora possa ser um pouco complicado. </p><br><p>  A partir de agora, come√ßo a dissipar a opini√£o de que o compilador JIT √© muito complicado. </p><br><p>  O que o compilador JIT aceita para entrada?  Ele aceita o bytecode do m√©todo a ser compilado.  E o bytecode, como o nome sugere, √© apenas uma matriz de bytes. </p><br><p>  O que o compilador JIT produz como resultado?  Ele fornece o c√≥digo da m√°quina do m√©todo.  O c√≥digo da m√°quina tamb√©m √© apenas uma matriz de bytes. </p><br><p>  Como resultado, a interface que deve ser implementada ao gravar um novo compilador JIT para incorpor√°-lo na JVM ser√° algo parecido com isto. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] compileMethod(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode); }</code> </pre> <br><p>  Portanto, se voc√™ n√£o conseguia imaginar como o Java pode fazer algo t√£o baixo quanto a compila√ß√£o JIT no c√≥digo da m√°quina, agora voc√™ pode ver que esse n√£o √© um trabalho de baixo n√≠vel.  Certo?  Esta √© apenas uma fun√ß√£o de <code>byte[]</code> para <code>byte[]</code> . </p><br><p>  Na realidade, tudo √© um pouco mais complicado.  Apenas o bytecode n√£o √© suficiente - tamb√©m precisamos de mais informa√ß√µes, como o n√∫mero de vari√°veis ‚Äã‚Äãlocais, o tamanho da pilha necess√°rio e as informa√ß√µes coletadas pelo profiler int√©rprete para entender como o c√≥digo √© realmente executado.  Portanto, imagine a entrada na forma de <code>CompilationRequest</code> , que nos informar√° sobre o <code>JavaMethod</code> que precisa ser compilado e fornecer√° todas as informa√ß√µes necess√°rias. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilationRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaMethod</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCode(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... }</code> </pre> <br><p>  Al√©m disso, a interface n√£o requer o retorno do c√≥digo compilado.  Em vez disso, outra API √© usada para instalar o c√≥digo da m√°quina na JVM. </p><br><pre> <code class="java hljs">HotSpot.installCode(targetCode);</code> </pre> <br><p>  Agora, para escrever um novo compilador JIT para a JVM, voc√™ s√≥ precisa implementar essa interface.  <code>installCode</code> informa√ß√µes sobre o m√©todo que precisa ser compilado e devemos compil√°-lo no c√≥digo da m√°quina e chamar <code>installCode</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ HotSpot.installCode(...); } }</code> </pre> <br><p>  Vamos mudar para o IDE Eclipse com Graal e dar uma olhada em algumas interfaces e classes reais.  Como mencionado anteriormente, eles ser√£o um pouco mais complicados, mas n√£o muito. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/jvmci-compiler-interface.png" alt="JVMCICompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-1.png" alt="HotSpotGraalCompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-2.png" alt="compileMethod"></p><br><p>  Agora, quero mostrar que podemos fazer altera√ß√µes no Graal e us√°-las imediatamente no Java 9. Adicionarei uma nova mensagem de log que ser√° exibida ao compilar o m√©todo usando o Graal.  Inclua-o no m√©todo de interface implementado, chamado pela JVMCI. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Going to compile "</span></span> + request.getMethod().getName()); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-3.png" alt="Compila√ß√£o"></p><br><p>  Por enquanto, desative o log de compila√ß√£o no HotSpot.  Agora podemos ver nossa mensagem da vers√£o modificada do compilador. </p><br><pre> <code class="java hljs">$ java \ --<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ --upgrade-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ -XX:+UnlockExperimentalVMOptions \ -XX:+EnableJVMCI \ -XX:+UseJVMCICompiler \ -XX:-TieredCompilation \ -XX:CompileOnly=Demo::workload \ Demo Going to compile workload</code> </pre> <br><p>  Se voc√™ tentar repetir isso sozinho, notar√° que nem precisa executar nosso sistema de compila√ß√£o - <code>mx build</code> .  Chega, normal para o Eclipse, <em>compile ao salvar</em> .  E certamente n√£o precisamos reconstruir a pr√≥pria JVM.  Simplesmente incorporamos o compilador modificado na JVM existente. </p><br><h2 id="graf-graal">  Count Graal </h2><br><p>  Bem, sabemos que Graal converte um <code>byte[]</code> em outro <code>byte[]</code> .  Agora vamos falar sobre a teoria e estruturas de dados que ele usa, porque  eles s√£o um pouco incomuns, mesmo para o compilador. </p><br><p>  Essencialmente, o compilador lida com seu programa.  Para isso, o programa deve ser apresentado na forma de algum tipo de estrutura de dados.  Uma op√ß√£o √© bytecode e listas de instru√ß√µes semelhantes, mas elas n√£o s√£o muito expressivas. </p><br><p>  Em vez disso, Graal usa um gr√°fico para representar seu programa.  Se usarmos um operador de adi√ß√£o simples que resume duas vari√°veis ‚Äã‚Äãlocais, o gr√°fico incluir√° um n√≥ para carregar cada vari√°vel, um n√≥ para a soma e duas arestas que mostram que o resultado do carregamento das vari√°veis ‚Äã‚Äãlocais √© inserido no operador de adi√ß√£o. </p><br><p>  √Äs vezes, isso √© chamado de <em>gr√°fico de depend√™ncia do programa</em> . </p><br><p>  Tendo uma express√£o da forma <code>x + y</code> obtemos n√≥s para as vari√°veis ‚Äã‚Äãlocais <code>y</code> , e um n√≥ de sua soma. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/data-graph.png" alt="Gr√°fico de fluxo de dados"></p><br><p>  As bordas azuis neste gr√°fico mostram a dire√ß√£o do fluxo de dados da leitura de vari√°veis ‚Äã‚Äãlocais para a soma. </p><br><p>  Al√©m disso, podemos usar arestas para refletir a ordem de execu√ß√£o do programa.  Se, em vez de ler vari√°veis ‚Äã‚Äãlocais, chamarmos m√©todos, precisamos lembrar a ordem da chamada e n√£o poderemos reorganiz√°-los (sem conhecer o c√≥digo interno).  Para fazer isso, existem arestas adicionais que definem essa ordem.  Eles s√£o mostrados em vermelho. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/control-graph.png" alt="Gr√°fico de fluxo de controle"></p><br><p>  Portanto, o gr√°fico Graal, de fato, √© dois gr√°ficos combinados em um.  Os n√≥s s√£o os mesmos, mas algumas arestas indicam a dire√ß√£o do fluxo de dados, enquanto outras mostram a transfer√™ncia de controle entre eles. </p><br><p>  Para ver o gr√°fico Graal, voc√™ pode usar uma ferramenta chamada <em>IdealGraphVisualiser</em> ou <em>IGV</em> .  A inicializa√ß√£o √© realizada usando o <code>mx igv</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/igv.png" alt="IdealGraphVisualiser"></p><br><p>  Depois disso, execute a JVM com o sinalizador <code>-Dgraal.Dump</code> . </p><br><p>  Um fluxo de dados simples pode ser visto escrevendo uma express√£o simples. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average.png" alt="Media aritm√©tica igv"></p><br><p>  Voc√™ pode ver como os par√¢metros <code>0</code> ( <code>P(0</code> ) e <code>1</code> ( <code>P(1)</code> ) v√£o para a entrada da opera√ß√£o de adi√ß√£o, que, juntamente com a constante <code>2</code> ( <code>C(2)</code> ), vai para a entrada da opera√ß√£o de divis√£o, ap√≥s a qual esse valor √© retornado. </p><br><p>  Para analisar um fluxo mais complexo de dados e controle, introduzimos um ciclo. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; values.length; n++) { sum += values[n]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum / values.length; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop.png" alt="M√≠dia aritm√©tica igv com ciclo"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop-detail.png" alt="IGV m√©dio aritm√©tico detalhado com loop"></p><br><p>  Nesse caso, temos n√≥s do in√≠cio e do fim do loop, lendo os elementos da matriz e lendo o comprimento da matriz.  Como antes, as linhas azuis indicam a dire√ß√£o do fluxo de dados e as linhas vermelhas indicam o fluxo de controle. </p><br><p>  Agora voc√™ pode ver por que essa estrutura de dados √†s vezes √© chamada de <em>mar de n√≥s</em> ou <em>sopa de n√≥s</em> . </p><br><p>  Quero dizer que o C2 usa uma estrutura de dados muito semelhante e, de fato, foi o C2 que popularizou a id√©ia de um compilador de um <em>mar de n√≥s</em> , portanto isso n√£o √© uma inova√ß√£o do Graal. </p><br><p>  N√£o mostrarei o processo de constru√ß√£o deste gr√°fico at√© a pr√≥xima parte da apresenta√ß√£o, mas quando o Graal recebe o programa nesse formato, a otimiza√ß√£o e a compila√ß√£o s√£o realizadas modificando essa estrutura de dados.  E essa √© uma das raz√µes pelas quais escrever um compilador JIT em Java faz sentido.  Java √© uma linguagem orientada a objetos e um gr√°fico √© uma cole√ß√£o de objetos conectados por arestas na forma de links. </p><br><h2 id="ot-baytkoda-k-mashinnomu-kodu">  Do bytecode ao c√≥digo da m√°quina </h2><br><p>  Vamos ver como essas id√©ias se parecem na pr√°tica e seguir algumas etapas do processo de compila√ß√£o. </p><br><h3 id="poluchenie-baytkoda">  Obtendo o Bytecode </h3><br><p>  A compila√ß√£o come√ßa com o bytecode.  Vamos voltar ao nosso pequeno exemplo de soma. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><p>  N√≥s produziremos o bytecode recebido na entrada imediatamente antes do in√≠cio da compila√ß√£o. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(request.getMethod().getName() + <span class="hljs-string"><span class="hljs-string">" bytecode: "</span></span> + Arrays.toString(request.getMethod().getCode())); ... } }</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">workload</span></span> bytecode: [<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>]</code> </pre> <br><p>  Como voc√™ pode ver, a entrada para o compilador √© bytecode. </p><br><h3 id="parser-baytkoda-i-postroitel-grafa">  Analisador de Bytecode e Construtor de Gr√°ficos </h3><br><p>  <em>O construtor</em> , percebendo essa matriz de bytes como o bytecode da JVM, a converte em um gr√°fico Graal.  Essa √© uma esp√©cie de <em>interpreta√ß√£o abstrata</em> - o construtor interpreta o bytecode Java, mas, em vez de passar valores, manipula as extremidades livres das arestas e as conecta gradualmente. </p><br><p>  Vamos aproveitar o fato de o Graal ser escrito em Java e ver como ele funciona usando as ferramentas de navega√ß√£o do Eclipse.  Sabemos que em nosso exemplo h√° um n√≥ de adi√ß√£o, ent√£o vamos descobrir onde ele √© criado. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-1.png" alt="Addnode"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-2.png" alt="Pesquisar chamadas AddNode.create"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-3.png" alt="Analisador"></p><br><p>  Pode-se ver que eles s√£o criados pelo analisador de bytecode, e isso nos levou ao <code>IADD</code> processamento da <code>IADD</code> ( <code>96</code> , que vimos na matriz de entrada impressa). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genArithmeticOp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaKind kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode)</span></span></span><span class="hljs-function"> </span></span>{ ValueNode y = frameState.pop(kind); ValueNode x = frameState.pop(kind); ValueNode v; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (opcode) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LADD: v = genIntegerAdd(x, y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... } frameState.push(kind, append(v)); }</code> </pre> <br><p>  Eu disse acima que esta √© uma interpreta√ß√£o abstrata, porque  tudo isso √© muito semelhante a um int√©rprete de bytecode.  Se fosse um int√©rprete de JVM real, ele retiraria dois valores da pilha, executaria a adi√ß√£o e retornaria o resultado.  Nesse caso, removemos dois n√≥s da pilha que, quando o programa √© iniciado, ser√£o c√°lculos, adicionamos, que √© o resultado da soma, um novo n√≥ para adi√ß√£o e o colocamos na pilha. </p><br><p>  Assim, o gr√°fico √© constru√≠do Graal. </p><br><h3 id="poluchenie-mashinnogo-koda">  Obtendo o c√≥digo da m√°quina </h3><br><p>  Para converter um gr√°fico Graal em c√≥digo de m√°quina, voc√™ precisa gerar bytes para todos os seus n√≥s.  Isso √© feito separadamente para cada n√≥, chamando seu m√©todo <code>generate</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Generator gen)</span></span></span><span class="hljs-function"> </span></span>{ gen.emitAdd(a, b); }</code> </pre> <br><p>  Repito, aqui trabalhamos com um n√≠vel muito alto de abstra√ß√£o.  Temos uma classe com a qual emitimos instru√ß√µes de c√≥digo de m√°quina sem entrar em detalhes de como isso funciona. </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os detalhes s√£o </font></font><code>emitAdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um pouco complexos e abstratos, porque os operadores aritm√©ticos exigem codifica√ß√£o para muitas combina√ß√µes diferentes de operandos, mas, ao mesmo tempo, podem compartilhar a maior parte de seu c√≥digo. </font><font style="vertical-align: inherit;">Portanto, vou simplificar um pouco mais o programa.</font></font></p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nesse caso, a instru√ß√£o de incremento ser√° usada e mostrarei como fica no assembler. </font></font></p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Register dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> encode = prefixAndEncode(dst.encoding); emitByte(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); emitByte(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> | encode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emitByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ data.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/incl.png" alt="Instru√ß√µes de montagem no assembler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-byte.png" alt="Sa√≠da em bytes"></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode ver que o resultado s√£o os bytes adicionados ao padr√£o </font></font><code>ByteBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- apenas criando uma matriz de bytes.</font></font></p><br><h3 id="vyhodnoy-mashinnyy-kod"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sa√≠da do c√≥digo da m√°quina </font></font></h3><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vejamos o c√≥digo da m√°quina de sa√≠da da mesma maneira que fizemos com o bytecode de entrada anterior - adicione uma lista dos bytes no local da instala√ß√£o. </font></font></p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... System.err.println(method.getName() + <span class="hljs-string"><span class="hljs-string">" machine code: "</span></span> + Arrays.toString(result.getTargetCode())); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/machine-code.png" alt="C√≥digo da m√°quina de impress√£o"></p><br><p>           .    HotSpot.     .     OpenJDK, , -,     JVM,      . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cd openjdk/hotspot/src/share/tools/hsdis <span class="hljs-variable"><span class="hljs-variable">$</span></span> curl <span class="hljs-literal"><span class="hljs-literal">-O</span></span> http://ftp.heanet.ie/mirrors/gnu/binutils/binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> tar <span class="hljs-literal"><span class="hljs-literal">-xzf</span></span> binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> make BINUTILS=binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span> ARCH=amd64 CFLAGS=<span class="hljs-literal"><span class="hljs-literal">-Wno</span></span><span class="hljs-literal"><span class="hljs-literal">-error</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> cp build/macosx<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>/hsdis<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.dylib ../../../../../..</code> </pre> <br><p>      : <code>-XX:+UnlockDiagnosticVMOptions</code>  <code>-XX:+PrintAssembly</code> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockDiagnosticVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintAssembly \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo</code> </pre> <br><p>             . </p><br><pre> <code class="hljs perl">workload machine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] ... <span class="hljs-number"><span class="hljs-number">0x000000010f71cda0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda5</span></span>: add %edx,%esi ;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0xcba8da9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x0000000102b74006 ; {poll_return} 0x000000010f71cdaf: vzeroupper 0x000000010f71cdb2: retq</span></span></code> </pre> <br><p> .  ,           .    <code>generate</code>   ,         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddNode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... gen.emitSub(op1, op2, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// changed from emitAdd } }</span></span></code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-add.png" alt="Emiss√£o da instru√ß√£o AddNode"></p><br><p>    ,  ,      ,      . </p><br><pre> <code class="hljs perl">workload mechine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] <span class="hljs-number"><span class="hljs-number">0x0000000107f451a0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a5</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function">,%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function"> </span></span>;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0x1db81a9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x000000010618d006 ; {poll_return} 0x0000000107f451af: vzeroupper 0x0000000107f451b2: retq</span></span></code> </pre> <br><p> ,   ? Graal     ;         ;       ;    .  ,       Graal. </p><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>] ‚Üí [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">...</span></span>]</code> </pre> <br><h2 id="optimizaciya">  </h2><br><p>  ,     ,        .       Graal  ,    . </p><br><p> <em> </em> ‚Äî          .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graph graph)</span></span></span></span>; }</code> </pre> <br><h3 id="kanonikalizaciya-canonicalisation">  (canonicalisation) </h3><br><p> <em></em>      .       ,       ,      <em> </em> ( <em>constant folding</em> )   . </p><br><p>       ‚Äî       <code>canonical</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> ,  ,    ,      .                  ‚Äî    .    <code>-(-x)</code>  <code>x</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NegateNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> NegateNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((NegateNode) value).getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/negate-node.png" alt="findSynonym no NegateNode"></p><br><p>       Graal   . ,       . </p><br><p>           Java,       <code>canonical</code> . </p><br><h3 id="global-value-numbering"> Global value numbering </h3><br><p> <em>Global value numbering (GVN)</em> ‚Äî       .    <code>a + b</code>    ,   ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) * (a + b); }</code> </pre> <br><p> Graal     .   ‚Äî        .   GVN         .        <em>hash map</em>  ,  ,  . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn.png" alt="Numera√ß√£o de valor global"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-1.png" alt="Gr√°fico de numera√ß√£o de valor global"></p><br><p>    ,   <em></em> ‚Äî  ,      ,     -  .  ,  ,  ,       ,      ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getA() + getB()) * (getA() + getB()); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-2.png" alt="Um gr√°fico que n√£o pode ser um valor global numerado"></p><br><h3 id="ukrupnenie-blokirovok-lock-coarsening">   (lock coarsening) </h3><br><p>     .               <em></em> . ,     ,      ,   <em></em> ( <em>inlining</em> ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } }</code> </pre> <br><p>   ,   , , , . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; monitor.exit(); monitor.enter(); counter++; monitor.exit(); }</code> </pre> <br><p>                    .    <em> </em> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; counter++; monitor.exit(); }</code> </pre> <br><p>  Graal       <code>LockEliminationPhase</code> .   <code>run</code>      ,         .  ,        ,           . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StructuredGraph graph)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (monitorExitNode monitorExitNode : graph.getNodes(MonitorExitNode.class)) { FixedNode next = monitorExitNode.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> monitorEnterNode) { AccessmonitorNode monitorEnterNode = (AccessmonitorNode) next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monitorEnterNode.object() ## monitorExitNode.object()) { monitorExitNode.remove(); monitorEnterNode.remove(); } } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination.png" alt="Simplifica√ß√£o de bloqueio"></p><br><p>            , , ,      ,          <code>2</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter += <span class="hljs-number"><span class="hljs-number">2</span></span>; monitor.exit(); }</code> </pre> <br><p>    IGV   .  ,   ,       \   ,  , ,        <code>2</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-before.png" alt="Simplifique os bloqueios para"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-after.png" alt="Simplifique os bloqueios ap√≥s"></p><br><h2 id="ne-zatronutye-prakticheskie-aspekty">     </h2><br><p>   Graal   ,  ,      ,          . , , ,          . </p><br><p>       Graal   ,  , ,         ,    ,  ,    . </p><br><h3 id="naznachenie-registrov">   </h3><br><p>    Graal      ,   ,  .        ?          ,      ? </p><br><p> ,  ,    .      .       ,      , ,   ,    .        ,  ,  ,             , ,  . </p><br><p>        <em> </em> ( <em>register allocation</em> ). Graal ,    JIT-,    ‚Äî <em>  </em> ( <em>linear scan algorithm</em> ). </p><br><h3 id="dispetcherizaciya">  </h3><br><p>    ,     ,   ,        -    ,         . </p><br><p> ,       ,   , ,         (..     ),        . ,    ,     . </p><br><p>    <em> </em> ( <em>graph scheduling</em> ).       .       ,          .       ,      , ,        . </p><br><p>                ,     . </p><br><h2 id="v-kakih-sluchayah-ispolzovat-graal">     Graal? </h2><br><p>        , ,   , Graal ‚Äî   ,       <em>Oracle</em> .      ,    Graal? </p><br><h3 id="kompilyator-nizhnego-urovnya-final-tier-compiler">    (final-tier compiler) </h3><br><p> C  JVMCI Graal    <em>  </em>  HotSpot ‚Äî ,     .     (   HotSpot)   Graal    ,    . </p><br><p> <em>Twitter</em>       Graal   ,    Java 9           .       : <code>-XX:+UseJVMCICompiler</code>  . </p><br><p>    JVMCI   ,      Graal   JVM.    (deploy) -  JVM,      Graal.      Java-,   Graal,       JVM. </p><br><p>  OpenJDK   <em>Metropolis</em>       JVM   Java. Graal        . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/metropolis.png" alt="Projeto Metropolis"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://cr.openjdk.java.net/\~jrose/metropolis/Metropolis-Proposal.html</a> </p><br><h3 id="polzovatelskie-optimizacii">   </h3><br><p> Graal    .    Graal   JVM,     Graal   .           ,  Graal       . ,     -     ,    ,                 JNI. </p><br><p> Charles Nutter      <em>JRuby</em>         Graal       Ruby. ,        - . </p><br><h3 id="aot-ahead-of-time-kompilyaciya"> AOT (ahead-of-time)  </h3><br><p> Graal ‚Äî    Java. JVMCI  ,  Graal,    ,     ,    Graal     .  ,     Graal    ,     JIT-. </p><br><p>     JIT-  AOT-      ,  Graal     .       AOT   Graal. </p><br><p> Java 9              JIT-,     .        JVM,          . </p><br><p> AOT Java 9     Graal,       Linux.            ,  ,            . </p><br><p>    . <em>SubstrateVM</em> ‚Äî  AOT-,   Java-    JVM  . ,     - (statically linked)  .    JVM  ,         .     SubstrateVM  Graal.          ( <em>just-in-time</em> ) SubstrateVM, ,   Graal  .   Graal AOT-  . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> javac Hello.java <span class="hljs-variable"><span class="hljs-variable">$</span></span> graalvm<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span>/bin/native<span class="hljs-literal"><span class="hljs-literal">-image</span></span> Hello classlist: <span class="hljs-number"><span class="hljs-number">966.44</span></span> ms (cap): <span class="hljs-number"><span class="hljs-number">804.46</span></span> ms setup: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">514.31</span></span> ms (typeflow): <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">580.70</span></span> ms (objects): <span class="hljs-number"><span class="hljs-number">719.04</span></span> ms (features): <span class="hljs-number"><span class="hljs-number">16.27</span></span> ms analysis: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">422.58</span></span> ms universe: <span class="hljs-number"><span class="hljs-number">262.09</span></span> ms (parse): <span class="hljs-number"><span class="hljs-number">528.44</span></span> ms (inline): <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">259.94</span></span> ms (compile): <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">716.20</span></span> ms compile: <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">817.97</span></span> ms image: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">070.29</span></span> ms debuginfo: <span class="hljs-number"><span class="hljs-number">672.64</span></span> ms write: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">797.45</span></span> ms [<span class="hljs-type"><span class="hljs-type">total</span></span>]: <span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">907.56</span></span> ms <span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-literal"><span class="hljs-literal">-lh</span></span> hello <span class="hljs-literal"><span class="hljs-literal">-rwxr</span></span><span class="hljs-literal"><span class="hljs-literal">-xr</span></span><span class="hljs-literal"><span class="hljs-literal">-x</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> chrisseaton staff <span class="hljs-number"><span class="hljs-number">6.6</span></span>M <span class="hljs-number"><span class="hljs-number">4</span></span> Oct <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> hello <span class="hljs-variable"><span class="hljs-variable">$</span></span> file ./hello ./hellojava: Mach<span class="hljs-literal"><span class="hljs-literal">-O</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-bit</span></span> executable x86_64 <span class="hljs-variable"><span class="hljs-variable">$</span></span> time ./hello Hello! real <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">010</span></span>s user <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s</code> </pre> <br><h3 id="truffle"> Truffle </h3><br><p>     Graal      <em>Truffle</em> . Truffle ‚Äî         JVM. </p><br><p>  ,   JVM,  ,   JIT-   (,    ,   ,  JIT- JVM    ,        ). Truffle    ‚Äî       ,   ,  Truffle, ,              <em> </em> ( <em>partial evaluation</em> ). </p><br><p>         ,             <em> </em> ( <em>inlining</em> )  <em> </em> ( <em>constant folding</em> )      . Graal       ,  Truffle       . </p><br><p>       Graal ‚Äî  Truffle.       Ruby,   <em>TruffleRuby</em>    Truffle , , Graal. TruffleRuby ‚Äî     Ruby,   10   , ,  ,        . </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/graalvm/truffleruby</a> </p><br><h2 id="vyvody">  Conclus√µes </h2><br><p>  ,      ,   ,   JIT- Java         . JIT-   ,          , , -           . ,  ,   .   JIT-    ,   <code>byte[]</code>  JVM  <code>byte[]</code>  . </p><br><p>  ,       Java.           ,   C++. </p><br><p> Java- Graal   - .   ,    ,            . </p><br><p>          .        ,        Eclipse     .           (definitions),     ..    . </p><br><p>          JIT      JIT- JVM,   <em>JITWatch</em> ,   ,        Graal     ,   . ,   ,  -       ,     Graal     JVM.         IDE,       <em>hello-world</em> . </p><br><p>         SubstrateVM  Truffle,   Graal,     ,     Java  .     ,   Graal    Java.  ,    ,   -  <em>LLVM</em> ,    , ,   ,     . </p><br><p> , ,       Graal      JVM.  Porque JVMCI   Java 9, Graal      ,  ,    Java-. </p><br><p> Graal ‚Äî        .    ,      Graal.    ,      ! </p><br><hr><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">More information about TruffleRuby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Low Overhead Polling For Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Top 10 Things To Do With GraalVM</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ruby Objects as C Structs and Vice Versa</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Understanding How Graal Works ‚Äî a Java JIT Compiler Written in Java</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Flip-Flops ‚Äî the 1-in-10-million operator</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Deoptimizing Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Very High Performance C Extensions For JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Optimising Small Data Structures in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pushing Pixels with JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tracing With Zero Overhead in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">How Method Dispatch Works in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A Truffle/Graal High Performance Backend for JRuby</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt419637/">https://habr.com/ru/post/pt419637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt419623/index.html">"ELA": como criamos imagens de intelig√™ncia artificial</a></li>
<li><a href="../pt419625/index.html">Vis√£o geral dos meus recursos favoritos do PHP7</a></li>
<li><a href="../pt419627/index.html">Estamos √† procura de palestrantes no Moscow Data Science Major</a></li>
<li><a href="../pt419633/index.html">Agora, todas as principais listas de certificados raiz s√£o confi√°veis ‚Äã‚Äãpelo Let's Encrypt</a></li>
<li><a href="../pt419635/index.html">Lan√ßamento da vers√£o est√°vel do Dart 2.0 e Dart Web Platform</a></li>
<li><a href="../pt419641/index.html">Criando uma AI simples de C # no Unity</a></li>
<li><a href="../pt419643/index.html">Confer√™ncia de Engenharia de Software EPAM de Minsk: Realize</a></li>
<li><a href="../pt419647/index.html">Semin√°rio ‚ÄúBlack Friday em e-commerce. Segredos de sobreviv√™ncia, 16 de agosto de Moscou</a></li>
<li><a href="../pt419649/index.html">Um pouco sobre gatos ou qual CAT escolhemos para podcasts de sincroniza√ß√£o</a></li>
<li><a href="../pt419651/index.html">Nem GA nem YM. Como criamos nosso pr√≥prio fluxo de cliques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>