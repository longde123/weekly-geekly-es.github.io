<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôéÔ∏è üéΩ üîñ La fonction non reconnue ralentit le programme 5 fois üì¥ üé¥ üì´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ralentissement de Windows, partie 3: arr√™t du processus 



 L'auteur est engag√© dans l'optimisation des performances de Chrome chez Google - env. tra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La fonction non reconnue ralentit le programme 5 fois</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432076/"> <b>Ralentissement de Windows, partie 3: arr√™t du processus</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b55/8f1/93c/b558f193cbc015bf35b2b068ff1c8e65.jpg"><br><br>  <font color="gray">L'auteur est engag√© dans l'optimisation des performances de Chrome chez Google - env.</font>  <font color="gray">trans.</font> <br><br>  √Ä l'√©t√© 2017, j'ai eu des probl√®mes avec les performances de Windows.  L'arr√™t du processus a √©t√© lent, s√©rialis√© et a bloqu√© la file d'attente d'entr√©e du syst√®me, ce qui a provoqu√© plusieurs blocages du curseur de la souris lors de l'assemblage de Chrome.  La raison principale √©tait qu'√† la fin des processus, Windows passait beaucoup de temps √† rechercher des objets GDI, tout en maintenant la section critique de l'utilisateur global du syst√®me32.  J'en ai parl√© dans l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Processeur 24 c≈ìurs, mais je ne peux pas d√©placer le curseur"</a> . <br><br>  Microsoft a corrig√© le bogue et je suis retourn√© √† mon entreprise, mais il s'est av√©r√© que le bogue √©tait de retour.  Il y avait des plaintes concernant la lenteur du fonctionnement des tests LLVM, avec des blocages d'entr√©e fr√©quents. <br><br>  Mais en fait, le bug n'est pas revenu.  La raison en √©tait un changement dans notre code. <br><a name="habracut"></a><br><h1>  Num√©ro 2017 </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/dcd/5f4/417/dcd5f4417f6d878a47d7d3c292a9304a.png" align="left">  Chaque processus Windows contient plusieurs descripteurs d'objet GDI standard.  Pour les processus qui ne font rien avec les graphiques, ces descripteurs sont g√©n√©ralement NULL.  √Ä la fin du processus, Windows appelle certaines fonctions pour ces descripteurs, m√™me si elles sont NULL.  Peu importait - les fonctionnalit√©s fonctionnaient rapidement - jusqu'√† la sortie de Windows 10 Anniversary Edition, dans laquelle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">certaines modifications de s√©curit√© rendaient ces fonctionnalit√©s lentes</a> .  Pendant le fonctionnement, ils d√©tenaient le m√™me verrou que celui utilis√© pour les √©v√©nements d'entr√©e.  Lorsqu'un grand nombre de processus se terminent en m√™me temps, chacun fait plusieurs appels √† la fonction lente qui d√©tient ce verrou critique, ce qui conduit finalement √† bloquer l'entr√©e de l'utilisateur et √† bloquer le curseur. <br><br>  Le correctif de Microsoft ne devait pas appeler ces fonctions pour les processus sans objets GDI.  Je ne connais pas les d√©tails, mais je pense que le patch Microsoft √©tait quelque chose comme √ßa: <br><br> <code>+ if (IsGUIProcess()) <br> + NtGdiCloseProcess(); <br> ‚Äì NtGdiCloseProcess();</code> <br> <br>  Autrement dit, ignorez simplement le nettoyage GDI si le processus n'est pas un processus GUI / GDI. <br><br>  √âtant donn√© que les compilateurs et autres processus que nous cr√©ons et terminons rapidement n'utilisaient pas d'objets GDI, ce correctif s'est av√©r√© suffisant pour corriger le gel de l'interface utilisateur. <br><br><h1>  Num√©ro 2018 </h1><br>  Il s'est av√©r√© que les processus sont tr√®s facilement attribu√©s √† certains objets GDI standard.  Si votre processus charge gdi32.dll, vous recevrez automatiquement des objets GDI (DC, surfaces, r√©gions, pinceaux, polices, etc.), que vous en ayez besoin ou non (notez que ces objets GDI standard ne sont pas affich√©s dans le Gestionnaire des t√¢ches parmi les objets GDI du processus). <br><br>  Mais cela ne devrait pas √™tre un probl√®me.  Je veux dire, pourquoi le compilateur chargerait-il gdi32.dll?  Eh bien, il s'est av√©r√© que si vous chargez user32.dll, shell32.dll, ole32.dll ou de nombreuses autres DLL, vous obtiendrez automatiquement en plus gdi32.dll (avec les objets GDI standard susmentionn√©s).  Et il est tr√®s facile de t√©l√©charger accidentellement une de ces biblioth√®ques. <br><br>  Tests LLVM lors du chargement de chaque processus appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CommandLineToArgvW</a> (shell32.dll), et parfois appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SHGetKnownFolderPath</a> (√©galement shell32.dll) Ces appels √©taient suffisants pour extraire gdi32.dll et g√©n√©rer ces objets GDI standard effrayants.  √âtant donn√© que la suite de tests LLVM g√©n√®re <i>autant</i> de processus, elle finit par s√©rialiser √† la fin des processus, provoquant d'√©normes retards et gels d'entr√©e, bien pires que ceux de 2017. <br><br>  Mais cette fois, nous connaissions le principal probl√®me du blocage, nous avons donc imm√©diatement su quoi faire. <br><br>  Tout d'abord, nous nous sommes d√©barrass√©s de l'appel de <i>CommandLineToArgvW</i> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en analysant manuellement la ligne de commande</a> .  Apr√®s cela, la suite de tests LLVM a rarement appel√© une fonction √† partir d'une DLL probl√©matique.  Mais nous savions √† l'avance que cela n'affecterait en rien les performances.  La raison en √©tait que m√™me l'appel <i>conditionnel</i> restant √©tait suffisant pour toujours tirer shell32.dll, qui √† son tour tirait gdi32.dll, qui cr√©e des objets GDI standard. <br><br>  Le deuxi√®me correctif √©tait le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chargement retard√© de shell32.dll</a> .  Un chargement retard√© signifie que la biblioth√®que se charge √† la demande - lorsque la fonction est appel√©e - au lieu de se charger au d√©marrage du processus.  Cela signifiait que shell32.dll et gdi32.dll se chargeraient rarement et pas toujours. <br><br>  Apr√®s cela, la suite de tests LLVM a commenc√© √† fonctionner <i>cinq fois</i> plus rapidement - en une minute au lieu de cinq.  Et plus aucune souris ne se bloque sur les machines de d√©veloppement, pour que les employ√©s puissent travailler normalement lors de l'ex√©cution des tests.  C'est une acc√©l√©ration folle pour un changement aussi modeste, et l'auteur des correctifs √©tait si reconnaissant pour mon enqu√™te qu'il m'a propos√© une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prime d'entreprise</a> . <br><br>  Parfois, les plus petits changements ont les plus grandes cons√©quences.  Vous avez juste besoin de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">savoir o√π composer le ¬´z√©ro¬ª</a> . <br><br><h1>  Chemin d'ex√©cution non accept√© </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/83d/1a9/e86/83d1a9e868d112a30dd4c37ea0caa9cb.jpg" align="left" width="350">  Il convient de r√©p√©ter que nous avons pr√™t√© attention au code qui <i>ne s'est pas ex√©cut√©</i> - et cela a √©t√© un changement cl√©.  Si vous disposez d'un outil de ligne de commande qui n'acc√®de pas √† gdi32.dll, l'ajout de code avec un appel de fonction <i>conditionnelle</i> ralentira le processus plusieurs fois si gdi32.dll est charg√©.  Dans l'exemple ci-dessous, <i>CommandLineToArgvW n'est</i> jamais appel√©, mais m√™me une simple pr√©sence dans le code (sans d√©lai d'appel) affecte n√©gativement les performances: <br><br><pre> <code class="plaintext hljs">int main(int argc, char* argv[]) { if (argc &lt; 0) { CommandLineToArgvW(nullptr, nullptr); // shell32.dll, pulls in gdi32.dll } }</code> </pre> <br>  Alors oui, la suppression d'un appel de fonction, m√™me si le code n'est jamais ex√©cut√©, peut √™tre suffisante pour am√©liorer consid√©rablement les performances dans certains cas. <br><br><h1>  Reproduction de pathologie </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/8ab/f3f/4aa/8abf3f4aac933be4fe7cdb400727b049.png" align="left">  Lorsque j'ai enqu√™t√© sur l'erreur initiale, j'ai √©crit un programme ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ProcessCreateTests</a> ) qui a cr√©√© 1000 processus puis les a tous tu√©s en parall√®le.  Cela a reproduit le gel, et lorsque Microsoft a corrig√© l'erreur, j'ai utilis√© un programme de test pour v√©rifier le correctif: voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o</a> .  Apr√®s la r√©incarnation du bogue, j'ai chang√© mon programme en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ajoutant l'option -user32</a> , qui charge user32.dll pour chacun des milliers de processus de test.  Comme pr√©vu, le temps d'ex√©cution de tous les processus de test augmente consid√©rablement avec cette option, et il est facile de d√©tecter les blocages du curseur de la souris.  Le temps de cr√©ation de processus augmente √©galement avec l'option -user32, mais il n'y a aucune suspension de curseur pendant la cr√©ation de processus.  Vous pouvez utiliser ce programme et voir √† quel point le probl√®me peut √™tre grave.  Voici quelques r√©sultats typiques de mon ordinateur portable √† quatre c≈ìurs / huit fils apr√®s une semaine de disponibilit√©.  L'option -user32 augmente le temps pour tout, mais le verrouillage <i>UserCrit</i> sur les processus se termine de mani√®re particuli√®rement dramatique: <br><br> <code>&gt; ProcessCreatetests.exe <br> Process creation took 2.448 s (2.448 ms per process). <br> Lock blocked for 0.008 s total, maximum was 0.001 s. <br> <br> Process destruction took 0.801 s (0.801 ms per process). <br> Lock blocked for 0.004 s total, maximum was 0.001 s. <br> <br> &gt; ProcessCreatetests.exe -user32 <br> Testing with 1000 descendant processes with user32.dll loaded. <br> Process creation took 3.154 s (3.154 ms per process). <br> Lock blocked for 0.032 s total, maximum was 0.007 s. <br> <br> Process destruction took 2.240 s (2.240 ms per process). <br> Lock blocked for 1.991 s total, maximum was 0.864 s.</code> <br> <br><h1>  Creuser plus profond√©ment juste pour le plaisir </h1><br>  J'ai pens√© √† certaines m√©thodes ETW qui peuvent √™tre utilis√©es pour √©tudier le probl√®me plus en d√©tail et j'ai d√©j√† commenc√© √† les √©crire.  Mais je suis tomb√© sur un comportement aussi inexplicable, que j'ai d√©cid√© de consacrer un article s√©par√©.  Qu'il suffise de dire que dans ce cas, Windows se comporte encore plus √©trangement. <br><br>  Autres articles de la s√©rie: <br><br><ul><li>  Ralentir Windows, partie 0: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©c√©l√©ration arbitraire de VirtualAlloc</a> </li><li>  Ralentir Windows, partie 1: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">acc√®s aux fichiers</a> </li><li>  Ralentissement de Windows, partie 2: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cr√©ation de processus</a> </li><li>  Ralentir Windows, partie 3: ce </li></ul><br><h1>  Litt√©rature </h1><br><ul><li>  Premier rapport de suspension de l'interface utilisateur: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Processeur 24 c≈ìurs, mais je ne peux pas d√©placer le curseur"</a> </li><li>  L'article suivant, qui permet de comprendre le probl√®me: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Que fait * Windows * tout en maintenant ce verrou"</a> </li><li>  Un article sur <i>un autre</i> bloc d'interface utilisateur en raison de l'interaction entre Gmail, les travailleurs ASLR v8, les politiques d'allocation de m√©moire CFG et la lenteur de l'analyse WMI: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"CPU 24 c≈ìurs, mais je ne peux pas taper un e-mail"</a> </li><li>  Le compilateur chargeant gdi32.dll semble √©trange, mais il est encore plus √©trange que le compilateur charge mshtml.dll, ce que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">VC ++ faisait dans certains cas</a> </li><li>  Parfois, des semaines de recherche conduisent √† des changements mineurs mais critiques, comme indiqu√© dans l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Savoir o√π composer z√©ro¬ª</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o</a> montrant l'utilisation de ProcessCreateTests et ETW pour v√©rifier une correction de bogue </li><li>  Premier changement pour LLVM par l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analyse de ligne de commande manuelle</a> </li><li>  Deuxi√®me correctif pour LLVM utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le d√©lai de chargement shell32.dll</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432076/">https://habr.com/ru/post/fr432076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432064/index.html">Comment √©chapper aux "li√®vres". Instruction UV</a></li>
<li><a href="../fr432068/index.html">Comment faciliter l'√©tude de l'anglais: 5 services utiles</a></li>
<li><a href="../fr432070/index.html">En bref sur les cha√Ænes redux-saga</a></li>
<li><a href="../fr432072/index.html">Trois types de fuites de m√©moire</a></li>
<li><a href="../fr432074/index.html">Comment les joueurs d√©chirent le tissu de r√©alit√© Spelunky avec des fusils de chasse</a></li>
<li><a href="../fr432078/index.html">Trafic au bout du tunnel ou DNS dans le pentest</a></li>
<li><a href="../fr432080/index.html">Id√©es fausses des joueurs lors de l'√©valuation des risques. Contr√¥le du g√©n√©rateur de nombres al√©atoires en d√©veloppement</a></li>
<li><a href="../fr432082/index.html">Microsoft AI Chatbot lance une collection de v√™tements en Chine</a></li>
<li><a href="../fr432084/index.html">Comment nous avons organis√© une comp√©tition par √©quipes entre les travailleurs de la production (comme en URSS)</a></li>
<li><a href="../fr432086/index.html">Impression 3D √† l'√©cole internationale du nom de M.V. Lomonosov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>