<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Ü©Ô∏è üòß ü§ï Bonsai: mecanismo wiki da fam√≠lia üíø ‚ò™Ô∏è ‚ûñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introdu√ß√£o l√≠rica 
 Uma noite, colocando as coisas em ordem em um arm√°rio na parede, tropecei em uma grande caixa de papel√£o. Ela sobreviveu a duas re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bonsai: mecanismo wiki da fam√≠lia</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438622/"><h4>  Introdu√ß√£o l√≠rica </h4><br>  Uma noite, colocando as coisas em ordem em um arm√°rio na parede, tropecei em uma grande caixa de papel√£o.  Ela sobreviveu a duas realoca√ß√µes e n√£o abriu por tantos anos que eu esqueci completamente o que estava armazenado nela.  Aconteceu que havia fotos - em √°lbuns, envelopes de uma loja, e algumas eram exatamente assim. <br><br>  Muitas fotografias foram tiradas h√° mais de setenta anos.  Um deles era av√¥ - em seus anos de estudante, ainda jovem e bonito, em √≥culos absolutamente <i>destrutivos</i> .  "Uau, meu av√¥ usava roupas hipster mesmo antes de se tornar popular", pensei e sorri involuntariamente.  Eu o reconheci imediatamente, mas depois foram as fotos de pessoas das quais n√£o me lembro nada.  Nas caracter√≠sticas faciais, voc√™ pode adivinhar vagamente o relacionamento - e √© isso. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/030/417/94a/03041794abba8a11f5c660bb249ec9fb.png"><br><br>  Quando eu tinha quinze anos, minha av√≥ mostrou repetidamente esses cart√µes e falou sobre aqueles que est√£o retratados neles.  Infelizmente, o valor de tais hist√≥rias √© entendido apenas quando n√£o h√° ningu√©m para lhes contar.  Naquela √©poca, era absolutamente desinteressante para mim, pela d√©cima vez, ouvir algumas hist√≥rias musgosas sobre os anos anteriores √† guerra, acenei e passei os ouvidos.  Agora, de repente, percebendo completamente que parte da hist√≥ria da minha fam√≠lia estava irremediavelmente perdida, tive a ideia de sistematizar e preservar o que restava. <br><br>  A solu√ß√£o ideal para armazenar dados da fam√≠lia me pareceu um h√≠brido de um mecanismo wiki e um √°lbum de fotos.  N√£o havia solu√ß√µes adequadas prontas, ent√£o tive que escrever as minhas.  √â chamado de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bonsai</a> e √© de c√≥digo aberto sob a licen√ßa MIT.  Depois, haver√° uma hist√≥ria sobre como ela √© organizada e como us√°-la, bem como a hist√≥ria de seu desenvolvimento e um pouco de <i>DRAMA</i> . <a name="habracut"></a><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b82/efe/8e3/b82efe8e382a652be0aa4882f500dff5.jpg"><br><br><h4>  Outra bicicleta? </h4><br>  Hoje, existem muitas ferramentas que permitem criar √°rvores geneal√≥gicas e catalogar informa√ß√µes sobre parentes.  Eles s√£o condicionalmente divididos em duas grandes categorias - servi√ßos online e aplicativos de desktop. <br><br>  No caso de um aplicativo de desktop, o banco de dados geralmente √© armazenado como um arquivo em disco.  Voc√™ abre o aplicativo e o reabastece no modo de usu√°rio √∫nico.  Se necess√°rio, os dados podem ser exportados para backup ou transfer√™ncia para outro sistema (por exemplo, no formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GEDCOM</a> ).  Entre os que eu assisti, os mais agrad√°veis ‚Äã‚Äãde usar pareciam o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gramps</a> (gratuito) e a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√Årvore da Vida</a> dom√©stica (requer uma compra √∫nica). <br><br>  O lado oposto do espectro s√£o os servi√ßos da web.  Eles armazenam seus dados em servidores remotos e cobram uma taxa de uso peri√≥dica.  Como este √© um produto comercial com uma base centralizada e boa monetiza√ß√£o, os servi√ßos desse plano oferecem a oportunidade, por exemplo, de procurar parentes perdidos por teste de DNA ou registros de arquivo. <br><br>  Os pr√≥s e contras de ambas as op√ß√µes s√£o bastante √≥bvios.  No primeiro caso, voc√™ armazena o banco de dados localmente e controla totalmente o acesso a ele e a cria√ß√£o de backups.  Se o aplicativo for de c√≥digo aberto, se necess√°rio, voc√™ poder√° adicionar funcionalidades adicionais a ele.  No entanto, ser√° dif√≠cil trabalhar com esse banco de dados em conjunto ou visualizar dados de outro dispositivo.  No segundo, pelo contr√°rio, o acesso √© de qualquer dispositivo, mas voc√™ fornece seus dados a terceiros e espera pela dec√™ncia deles.  Na hist√≥ria da minha fam√≠lia, n√£o h√° segredos desacreditadores e terr√≠veis; no entanto, ainda considero essas informa√ß√µes puramente pessoais e, em princ√≠pio, n√£o quero que mais ningu√©m as armazene ou analise. <br><br>  Dadas as defici√™ncias de ambas as abordagens, podemos formular uma lista de requisitos para o mecanismo "ideal": <br><br><ol><li>  Aplicativo da Web hospedado em seu pr√≥prio servidor </li><li>  Criando artigos sobre pessoas, animais de estima√ß√£o, lugares, eventos etc.  como um wiki </li><li>  Download de m√≠dia </li><li>  Marcas de pessoas em fotos e v√≠deos </li><li>  Constru√ß√£o autom√°tica de √°rvore geneal√≥gica </li><li>  Calend√°rio com todas as datas importantes. </li><li>  Ferramentas para co-edi√ß√£o e preenchimento </li></ol><br>  Para ser honesto, consegui encontrar v√°rios projetos com uma implementa√ß√£o auto-hospedada, mas eles estavam em um estado deplor√°vel: a apar√™ncia congelou em meados dos anos 2000, n√£o havia um conjunto completo da funcionalidade necess√°ria e eu n√£o queria me aprofundar nos scripts herdados do PHP.  Al√©m disso, o projeto anterior para animais de estima√ß√£o havia terminado e havia um desejo de assumir algo novo. <br><br>  A regra de ouro diz: <i>se voc√™ quer fazer o bem - fa√ßa voc√™ mesmo!</i> <br><br>  As tecnologias utilizadas foram selecionadas de acordo com tr√™s crit√©rios: minha experi√™ncia com elas, popularidade e sem abertura.  Aqui est√° o resultado: <br><br><ul><li>  <b>Rantime</b> : .NET Core 2.1 </li><li>  <b>Back</b> - <b>end</b> : ASP.NET Core MVC </li><li>  <b>Banco de Dados</b> : PostgreSQL </li><li>  <b>L√≥gica de front-end</b> : parcialmente Vue, parcialmente jQuery. </li><li>  <b>Estilos de front-end</b> : Bootstrap + Sass </li></ul><br>  As fun√ß√µes de suporte incluem Elasticsearch para pesquisa de texto completo e ffmpeg para tirar capturas de tela do v√≠deo. <br><br><h4>  Esquema de dados </h4><br>  Os principais objetos no banco de dados do Bonsai s√£o uma <i>p√°gina</i> e um <i>arquivo de m√≠dia</i> .  Eles s√£o conectados por um relacionamento muitos-para-muitos atrav√©s de <i>marcas</i> .  Uma tag pode ter um t√≠tulo sem um link - por exemplo, se voc√™ precisar marcar algu√©m em uma foto, mas n√£o houver informa√ß√µes em uma p√°gina inteira sobre ela. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b7/c75/f0c/8b7c75f0c97b58cee523f9984000e37f.png"><br><br>  Al√©m do texto livre, a p√°gina pode conter <i>fatos</i> inseridos em campos especiais no painel do administrador.  Fatos adicionais s√£o calculados com base nos fatos: por exemplo, se voc√™ indicar a data de nascimento da pessoa, ela ser√° marcada no calend√°rio e a p√°gina dele mostrar√° a idade atual (ou expectativa de vida, se a data da morte tamb√©m for indicada), o sexo pode ser usado para determinar o nome correto do relacionamento ("pai ‚ÄùOu‚Äú m√£e ‚Äùem vez dos‚Äú pais ‚Äùcomuns) e assim por diante.  Os fatos s√£o armazenados no banco de dados como um documento JSON. <br><br>  Existem cinco tipos de p√°ginas para escolher: pessoa, animal de estima√ß√£o, evento, local e assim por diante.  A lista de fatos dispon√≠veis depende do tipo de p√°gina: por exemplo, "educa√ß√£o" √© relevante apenas para uma pessoa, "data de nascimento" - para uma pessoa e um animal e "endere√ßo" - apenas para um local. <br><br>  As p√°ginas s√£o interconectadas por <i>relacionamentos</i> : "pai", "c√¥njuge", "amigo", "propriet√°rio", "residente" e muitos outros.  Alguns relacionamentos podem ser limitados no tempo (c√¥njuge, propriet√°rio, residente), outros s√£o considerados permanentes. <br><br>  Quando voc√™ salva qualquer p√°gina ou relacionamento, o modelo resultante √© verificado quanto √† consist√™ncia.  Por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">os anos de vida dos c√¥njuges devem se sobrepor</a> , uma pessoa n√£o pode ter mais de um pai biol√≥gico de cada sexo e voc√™ tamb√©m n√£o pode se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tornar seu pr√≥prio pai</a> .  Casamentos do mesmo sexo, no entanto, s√£o permitidos. <br><br>  A edi√ß√£o de uma p√°gina, arquivo de m√≠dia ou relacionamento salva a <i>altera√ß√£o</i> no banco de dados.  Isso permite salvar o hist√≥rico de edi√ß√µes e revert√™-las, se necess√°rio. <br><br><h4>  Relacionamento </h4><br>  Parentesco √© um dos conceitos mais antigos da sociedade.  J√° no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">idioma pr√©-indo-europeu,</a> havia muitos nomes para eles, que, de uma forma ligeiramente modificada, migraram para os idiomas modernos de v√°rios grupos: a palavra "m√£e" ser√° entendida por russo, ingl√™s e chin√™s. <br><br>  Existem muitas op√ß√µes para o parentesco, mas as b√°sicas s√£o tr√™s: <i>pai</i> , <i>filho</i> e <i>c√¥njuge</i> .  Eles permitem que voc√™ construa um gr√°fico direcionado da fam√≠lia em que esses relacionamentos s√£o arestas e as pessoas s√£o n√≥s.  Nesta coluna, voc√™ pode expressar qualquer outro relacionamento, conhecendo o caminho entre os participantes e seu sexo: por exemplo, para identificar o av√¥ de algu√©m, voc√™ deve primeiro encontrar o pai (qualquer g√™nero) e, em seguida, o pai desse pai (masculino) e assim por diante. <br><br>  No painel de administra√ß√£o do Bonsai, voc√™ pode inserir as rela√ß√µes desses tr√™s tipos b√°sicos.  O oposto ser√° criado automaticamente para cada relacionamento - pai para filho, c√¥njuge para c√¥njuge, propriet√°rio para animal de estima√ß√£o.  Todos os relacionamentos adicionais s√£o calculados pelo mecanismo e mostrados na barra lateral na p√°gina: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/242/d23/4a4/242d234a49a7c7a75788e384d82b8950.png"><br><br>  Para calcular o relacionamento, √© utilizado um percurso de gr√°fico elementar e os nomes dos relacionamentos s√£o definidos na forma de uma DSL especial: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RelationDefinition[] ParentRelations = { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Parent:m"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Parent:f"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Parent Child:m"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Parent Child:f"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Parent Parent:m"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Parent Parent:f"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) };</code> </pre> <br>  Mesmo uma pessoa pode ter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">muitos</a> parentes diretos.  O bonsai divide os links nos seguintes grupos: <br><br><ol><li>  <b>A rela√ß√£o sangu√≠nea mais pr√≥xima</b> √© a fam√≠lia na qual a pessoa cresceu: m√£e e pai, av√≥s, irm√£os e irm√£s.  Se voc√™ olhar para o gr√°fico, este √© o caminho 1-2 etapas acima e 1 lateralmente. </li><li>  <b>Fam√≠lia pr√≥pria</b> : um grupo para cada c√¥njuge e filhos dele.  Isso tamb√©m inclui os parentes do c√¥njuge - sogra, cunhado e similares. </li><li>  <b>Outros</b> : parentes mais distantes (netos, tios, tias) e la√ßos de n√£o parentesco (amigos, colegas). </li></ol><br>  √Äs vezes, uma maneira de determinar a associa√ß√£o ao grupo n√£o √© suficiente.  Os dados podem estar incompletos, mas ainda precisam ser exibidos da maneira mais adequada poss√≠vel.  Considere o seguinte gr√°fico de irm√£o: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a2a/47a/9c7/a2a47a9c749012092d863bcb52c399bf.png"><br><br>  Como vemos, duas esposas (Vera e Galina) e um filho (Boris) s√£o indicados para Alexander, mas n√£o sabemos qual das esposas √© a m√£e da crian√ßa - talvez esse seja algum tipo de terceira mulher, mas ela ainda n√£o foi adicionada.  Para tais casos, podem ser indicados v√°rios caminhos que deveriam existir ou n√£o, e s√£o marcados com os sinais <code>+</code> e <code>-</code> respectivamente: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Spouse Child+Child"</span></span>, <span class="hljs-string"><span class="hljs-string">"||"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Spouse Child-Child:m"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RelationDefinition(<span class="hljs-string"><span class="hljs-string">"Spouse Child-Child:f"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)</code> </pre><br><h4>  √Årvore geneal√≥gica </h4><br>  Qualquer mecanismo de genealogia decente deve ser capaz de construir uma √°rvore geneal√≥gica.  Essa √© a maneira mais visual de mostrar informa√ß√µes gerais sobre as pessoas e seus relacionamentos familiares.  Os dados s√£o armazenados no banco de dados na forma de um gr√°fico direcionado e, em teoria, deve ser f√°cil de visualizar.  Na pr√°tica, foi com a exibi√ß√£o da √°rvore que a maioria das dificuldades surgiu. <br><br>  Aqui est√£o alguns exemplos de como as √°rvores geneal√≥gicas podem se parecer: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eab/d88/aad/eabd88aadfe933595863249db8a269d5.png"><br><br>  √Årvore geneal√≥gica de Targaryenov.  Muito compacto, porque √© feito √† m√£o.  Gerar essa √°rvore a partir de dados arbitr√°rios ser√° extremamente dif√≠cil automaticamente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9bd/be7/d2d/9bdbe7d2dd44d9ade8a9906e4b93fdd5.png"><br><br>  Deuses gregos.  A representa√ß√£o gr√°fica √© gerada a partir de uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sintaxe de remarca√ß√£o especial</a> , na qual voc√™ ainda precisa organizar manualmente todos os blocos e desenhar os links entre eles.  Um pouco como a arte ASCII. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d2/6d7/11b/7d26d711b2ca68ac6f9b0f364fe30f3a.png"><br><br>  Apresenta√ß√£o de uma √°rvore na forma de um diagrama semicircular.  Facilmente gerado automaticamente, mas leva em considera√ß√£o apenas ancestrais diretos. <br><br>  Eu olhei atrav√©s de muitas op√ß√µes.  O mais esteticamente agrad√°vel foi no site MyHeritage: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/42b/0e9/73b/42b0e973bd48a5faaab3ee06758358d9.png"><br><br>  A renderiza√ß√£o dessa √°rvore pode ser dividida em tr√™s etapas condicionais: obter dados do banco de dados, organizar blocos / linhas de conex√£o e exibi-los diretamente na p√°gina.  Se tudo era trivial com o primeiro e o terceiro passo, no segundo eu tropecei. <br><br>  As tentativas de lan√ßar uma solu√ß√£o feita √†s pressas terminaram em um completo fiasco.  Um arranjo competente de elementos gr√°ficos √© uma √°rea t√£o complexa que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">s√£o escritas disserta√ß√µes</a> e os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">componentes acabados</a> s√£o como um apartamento em Moscou.  Ok, voc√™ n√£o ser√° capaz de se escrever, mas certamente existem solu√ß√µes gratuitas decentes? <br><br>  A maioria das minhas esperan√ßas estava na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca D3.js.</a>  Talvez essa seja a primeira coisa que vem √† mente se voc√™ precisar desenhar um gr√°fico ou gr√°fico em uma p√°gina da web.  Infelizmente, entre mais de trezentos (!) Exemplos no wiki, n√£o havia um mais ou menos semelhante a uma √°rvore no MyHeritage. <br><br>  O pr√≥ximo passo foi mergulhar nas bibliotecas que n√£o estavam envolvidas na renderiza√ß√£o, mas no c√°lculo da organiza√ß√£o ideal dos elementos no gr√°fico.  A maioria deles oferece o chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">layout Force</a> .  Essa √© uma abordagem muito simples, baseada em f√≥rmulas f√≠sicas: os n√≥s do gr√°fico s√£o representados por corpos el√°sticos e as linhas de conex√£o s√£o representadas por molas.  Ele pode ser facilmente reconhecido por sua anima√ß√£o caracter√≠stica - o gr√°fico parece "se endireitar" em movimento, e esse n√£o √© um recurso adicional, mas uma consequ√™ncia inevit√°vel da natureza da simula√ß√£o do algoritmo.  A abordagem de layout de for√ßa √© boa para visualizar dados sem uma hierarquia clara (por exemplo, conex√µes em redes sociais), mas a √°rvore geneal√≥gica neste formul√°rio parece falho. <br><br>  Outra op√ß√£o considerada √© a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Graphviz</a> .  O resultado de seu trabalho pode ser facilmente reconhecido pelas setas caracter√≠sticas.  Uma linguagem especial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DOT √©</a> usada para descrever o gr√°fico.  Os casos de teste parecem ainda mais ou menos, mas surgem problemas com dados reais: as setas "se quebram" e se conectam em √¢ngulos estranhos, o gr√°fico aumenta e voc√™ n√£o pode ajust√°-lo e contorn√°-lo. <br><br>  Como n√£o encontrei uma solu√ß√£o adequada por conta pr√≥pria, decidi solicit√°-la como freelancer e, ent√£o, o pr√≥prio <i>DRAMA</i> come√ßou. <br><br>  O pedido foi feito na manh√£ de 22 de outubro e, em uma hora, recebeu v√°rias respostas.  Um dos entrevistados se chamava Vladislav;  ele enviou um exemplo de solu√ß√£o semelhante e prometeu concluir a tarefa em <i>um dia</i> .  Essa velocidade parecia suspeita para mim, mas eu esperava a experi√™ncia dele e, para mim mesmo, dei ao sujeito um erro de uma semana.  Nos primeiros dias, Vladislav fez perguntas adicionais, nunca deixando de me surpreender com uma profunda imers√£o no projeto e uma atitude atenta aos detalhes, e ent√£o ele desapareceu.  Ele acordou em 1¬∫ de novembro, pediu desculpas pelo desaparecimento for√ßado por motivos familiares e enviou um link com uma vers√£o beta que parecia bastante semelhante ao que ele queria, se n√£o fosse o n√≥ nas linhas de conex√£o no centro: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/79e/402/bda/79e402bda04af7142d02273b7969ff1c.png"><br><br>  O desaparecimento do artista √© sempre um sinal de alerta, mas voc√™ nunca sabe, acontece alguma coisa, porque ele fez alguma coisa.  Deixe ele continuar!  Enviei um pr√©-pagamento e comecei a esperar por melhorias.  Depois de alguns dias, Vladislav escreveu que n√£o poderia resolver o problema e desapareceu novamente - desta vez por tr√™s semanas.  Durante esse per√≠odo, ele n√£o fez nada e se recusou a devolver o adiantamento, porque "a tarefa foi realmente realizada por um <i>ex-amigo est√∫pido</i> que o decepcionou e n√£o devolve o dinheiro".  Depois de algumas perguntas esclarecedoras, o infeliz delegador parou de tentar se desculpar e calou a boca.  Ent√£o agora n√≥s vivemos - periodicamente eu o lembro da d√≠vida e, em resposta, ele envia uma captura de tela do aplicativo banc√°rio - eles dizem: "n√£o h√° dinheiro, mas assim que - imediatamente."  Desejo ao Vladislav sucesso nos neg√≥cios e fique rico mais r√°pido! <br><br>  <i>Jogou a crian√ßa - sem karma!</i> <br><br>  Perder dinheiro n√£o era t√£o chato, mas um m√™s se passou, e a tarefa n√£o saiu do papel, e agora n√£o havia lugar para esperar ajuda.  Antes de tudo, fiquei com raiva de mim mesmo: segui o caminho de menor resist√™ncia, violei a <i>regra de ouro</i> - e aqui est√° o resultado.  Cheio de raiva justa, sentei-me novamente para estudar bibliotecas para desenhar gr√°ficos e - eis que eis!  - de repente encontrou exatamente o que voc√™ precisa. <br><br>  A biblioteca foi denominada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Eclipse Layout Kernel</a> , abreviado ELK.  Como voc√™ pode imaginar, ele √© usado para exibir diagramas no Eclipse IDE, mas tamb√©m pode ser usado de forma aut√¥noma.  Em geral, ele √© escrito em Java, mas h√° uma transmiss√£o de vers√£o em JS.  Sim, o c√≥digo dela √© um <a href="">pesadelo</a> e pesa um megabyte e meio, mas essas defici√™ncias podem ser perdoadas pelo fato de <i>funcionar</i> e fazer exatamente a coisa certa.  A interface √© elementar: n√≥s, arestas e configura√ß√µes s√£o transmitidas para a entrada e, na sa√≠da, obtemos as coordenadas.  Voc√™ pode desenhar uma √°rvore usando-as de qualquer maneira conveniente: escolhi o SVG para conectar linhas e divs com posicionamento absoluto para blocos. <br><br>  A integra√ß√£o da biblioteca e a sele√ß√£o de configura√ß√µes ideais levaram duas noites de for√ßa.  Isso, √© claro, n√£o √© "um dia", como prometeu meu infeliz e arrogante freelancer, mas bem pr√≥ximo.  Como resultado, o Bonsai conseguiu exibir a √°rvore aproximadamente desta forma: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/57a/f67/bdc/57af67bdcd299bb1f995aa73e09d0fd5.png"><br><br>  Agora, o √∫nico problema que resta √© o tempo de processamento.  O ELK usa um algoritmo iterativo: voc√™ pode se aproximar do posicionamento ideal gastando tempo extra.  Em uma √°rvore de 20 a 30 elementos, um bom resultado requer cerca de 5 segundos.  Por esse motivo, uma p√°gina com uma √°rvore √© aberta todas as vezes por muito tempo e rapidamente come√ßa a incomodar.  Na pr√≥xima vers√£o, o c√°lculo ser√° transferido para o back-end, para que possa ser feito uma vez ao alterar a p√°gina e o cache. <br><br><h4>  Pesquisa de texto completo </h4><br>  Um sistema para armazenar informa√ß√µes textuais seria in√∫til sem a pesquisa conveniente de texto completo.  O Bonsai usa o banco de dados PostgreSQL, ent√£o a primeira coisa que decidi foi verificar o que ele poderia oferecer imediatamente.  Outra decep√ß√£o: <code>tsvector</code> lida com palavras comuns, mas se recusa a procurar a coisa mais importante - nomes e sobrenomes: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> to_tsvector(<span class="hljs-string"><span class="hljs-string">''</span></span>) @@ to_tsquery(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-comment"><span class="hljs-comment">-- true to_tsvector('') @@ to_tsquery(''), -- false to_tsvector('') @@ to_tsquery(''), -- false to_tsvector('') @@ to_tsquery(''), -- false to_tsvector('  ') @@ to_tsquery('') -- false</span></span></code> </pre><br>  Os trigramas tamb√©m n√£o deram nada de bom.  No final, decidi por uma op√ß√£o bastante esperada: ElasticSearch + <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Morfologia Russa</a> .  Acabou sendo muito inconveniente trabalhar com ele no .NET, no entanto, ele lida com a busca de cinco s√≥lidos com seu nome completo. <br><br><h4>  Imperfei√ß√£o Consciente </h4><br>  Ao trabalhar em um projeto, ocorriam situa√ß√µes regularmente quando um <i>perfeccionista interno</i> ficava furioso com a solu√ß√£o escolhida.  A √°rea de assunto √© bastante fora do padr√£o e as ‚Äúboas maneiras‚Äù geralmente aceitas nem sempre funcionam. <br><br>  Por exemplo, o que acontece quando abrimos qualquer p√°gina? <br><br><ol><li>  O texto da p√°gina √© compilado do Markdown para o HTML.  Se o texto contiver links para outras p√°ginas e arquivos de m√≠dia, voc√™ precisar√° acessar o banco de dados para obter mais informa√ß√µes. </li><li>  Os fatos s√£o desserializados a partir do JSON no qual est√£o armazenados no banco de dados, no modelo de visualiza√ß√£o. </li><li>  Os relacionamentos s√£o determinados.  Para fazer isso, no banco de dados de longa data, √© necess√°rio obter o <i>gr√°fico de conex√£o inteiro</i> e encontrar n√≥s nele de acordo com uma lista de caminhos conhecida anteriormente. </li></ol><br>  √Ä primeira vista, isso parece uma opera√ß√£o terrivelmente dif√≠cil, mas, na verdade, n√£o √© por causa da quantidade relativamente pequena de dados.  Quantos parentes voc√™ consegue se lembrar e querer escrever?  Tente recont√°-los por interesse e verifique que ser√° muito dif√≠cil discar pelo menos cem.  E quantas pessoas querem dar acesso?  Mesmo um n√∫mero astronomicamente grande para uma fam√≠lia √© de mil pessoas!  Pelos padr√µes dos bancos de dados modernos, continua sendo rid√≠culo. <br><br>  Obviamente, o modelo de exibi√ß√£o de p√°gina compilado ainda √© armazenado em cache na primeira vez em que √© aberto e reutilizado nos modelos subsequentes, principalmente porque era muito f√°cil de implementar.  A regra de invalida√ß√£o de cache para altera√ß√µes no painel de administra√ß√£o tamb√©m √© adotada da maneira mais simples poss√≠vel: se alterarmos apenas o texto e alguns fatos <i>locais</i> (lista de idiomas, tipo sangu√≠neo, cor do cabelo etc.), basta redefinir esta p√°gina espec√≠fica.  Com qualquer outra altera√ß√£o - nome da p√°gina, data de nascimento ou sexo, adi√ß√£o ou altera√ß√£o de qualquer conex√£o - o cache √© <i>completamente</i> redefinido.  Sim, essa n√£o √© a maneira mais inteligente de limpar.  Sim, com certeza, voc√™ poderia escrever um algoritmo complexo que redefiniria apenas o que voc√™ precisa - mas, para este projeto, isso n√£o justificaria os custos. <br><br>  O projeto n√£o suporta localiza√ß√£o e altera√ß√£o de apar√™ncia, a autoriza√ß√£o funciona no OAuth no Facebook \ Google e o painel de administra√ß√£o √© feito nos formul√°rios usuais, e n√£o em alguma estrutura do SPA baseada na √∫ltima moda.  Tudo isso <i>poderia ser</i> realizado ou aprimorado, mas n√£o teria resolvido nenhum problema e, portanto, o tempo seria desperdi√ßado. <br><br><h4>  Ansioso pelo futuro </h4><br>  Outro motivo pelo qual n√£o faz sentido investir na complexidade do dispositivo do mecanismo √© a natureza ef√™mera da implementa√ß√£o em compara√ß√£o com os dados que ele armazena.  Apenas pense por um momento: a web em sua forma atual existe h√° quase vinte anos e a hist√≥ria da fam√≠lia existe <i>h√° s√©culos</i> .  Ningu√©m ainda resolveu esse problema simplesmente porque o pr√≥prio setor de tecnologia da informa√ß√£o existe muito menos.  O que pode ser feito? <br><br>  O mecanismo ter√° que ser reescrito regularmente do zero - assim como h√° milhares de anos, os monges t√™m se esfor√ßado para copiar textos de livros em ru√≠nas para novos.  A √∫nica diferen√ßa √© que o livro pode ficar cem anos com o manuseio e a aplica√ß√£o adequados - com a for√ßa de 15 a 20 anos.  Espero que daqui a vinte anos ainda seja capaz de fazer isso sozinho, mas em outros vinte anos meus filhos ou netos ter√£o que faz√™-lo.  Gostaria de deix√°-los uma fonte simples, compreens√≠vel e documentada. <br><br>  Nos primeiros est√°gios do design, eu queria incorporar uma certa linguagem semelhante ao SQL no mecanismo, com a ajuda de obter respostas para perguntas espec√≠ficas: "qual √© a porcentagem de meus ancestrais com olhos azuis", "quando Ivan comprou o primeiro carro" e assim por diante.  Essa ideia teve que ser abandonada, porque exigiria, em vez do texto simples, inserir todas as informa√ß√µes de uma certa forma formalizada, e apenas uma descri√ß√£o desse tipo levaria anos.  Por outro lado, o entendimento da linguagem natural est√° ganhando for√ßa.  N√£o ficarei surpreso se, em dez ou dois anos, for poss√≠vel solicitar √† Siri que leia o texto para voc√™, siga os links e, como resultado, apresente um extrato dos fatos.  Gente, empurre! <br><br><h4>  Como tentar? </h4><br>  Infelizmente, n√£o posso fornecer um link para a demonstra√ß√£o final: n√£o h√° servidor que resista ao efeito habra.  Mas existem algumas capturas de tela visuais (as imagens s√£o clic√°veis). <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/161/06a/0d0/16106a0d0a093a140c5095b472f847b5.png"></a> <a href="" rel="nofollow"><img src="https://habrastorage.org/getpro/habr/post_images/92e/c5b/798/92ec5b798673b928cf0e7ad6755bbc0d.png"></a> <a href="" rel="nofollow"><img src="https://habrastorage.org/getpro/habr/post_images/350/041/c9d/350041c9d3943b630474931f60f794bf.png"></a> <br><br>  Se o Bonsai lhe pareceu √∫til e voc√™ deseja execut√°-lo, o c√≥digo-fonte pode ser baixado no Github: <br><br>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/impworks/bonsai</a></strong> <br><br>  Instru√ß√µes de instala√ß√£o detalhadas s√£o fornecidas no Leia-me.  Voc√™ precisar√° disso: <br><br><ol><li>  .NET Core 2.1 ou superior </li><li>  PostgreSQL 10+ </li><li>  ElasticSearch 5.xe plugin de morfologia russa </li><li>  Facebook ou Google app para autoriza√ß√£o oAuth </li></ol><br>  Ap√≥s o primeiro lan√ßamento, v√°rias p√°ginas e fotos de teste s√£o criadas no banco de dados.  Para produ√ß√£o, esse comportamento n√£o √© necess√°rio e √© desabilitado pelo sinalizador nas configura√ß√µes. <br><br>  H√° apenas um m√™s, lancei minha pr√≥pria inst√¢ncia e comecei a execut√°-la, obtendo dados reais.  Alguma rugosidade √© encontrada, mas, caso contr√°rio, estou completamente satisfeito com o resultado.  Agora o projeto ser√° gradualmente desenvolvido e finalizado.  As principais tarefas s√£o acelerar a exibi√ß√£o da √°rvore, permitir o download de documentos na forma de PDF e adicionar um ajuste fino dos direitos de acesso.  Seria bom melhorar a usabilidade do painel de administra√ß√£o em alguns lugares ou reconhecer automaticamente os rostos na foto - <i>mas isso n√£o √© exato</i> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438622/">https://habr.com/ru/post/pt438622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438606/index.html">Degrada√ß√£o graciosa. Relat√≥rio Yandex.Taxi</a></li>
<li><a href="../pt438610/index.html">Templates Figma responsivos: Criando um componente de design flex√≠vel para navega√ß√£o m√≥vel iOS</a></li>
<li><a href="../pt438614/index.html">O que √© uma anima√ß√£o ociosa de qualidade? Os desenvolvedores compartilham seus exemplos favoritos.</a></li>
<li><a href="../pt438618/index.html">Fazendo um projetor a laser de texto DIY</a></li>
<li><a href="../pt438620/index.html">Meu caminho como desenvolvedor de jogos iniciante</a></li>
<li><a href="../pt438624/index.html">N√≥s programamos o interruptor atrav√©s da passagem. MicroPython em esp8266 (sonoff) com OTA. Parte 1</a></li>
<li><a href="../pt438626/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel # 284 (28 de janeiro a 3 de fevereiro)</a></li>
<li><a href="../pt438628/index.html">Notifica√ß√£o de status de altera√ß√£o do componente SharedState</a></li>
<li><a href="../pt438630/index.html">Google+ Sic tr√¢nsito gloria mundi ...</a></li>
<li><a href="../pt438632/index.html">Hardcore 2D RPG Gamedev Diaries, vol.0 - INTRO, ou "Como eu cheguei aqui"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>