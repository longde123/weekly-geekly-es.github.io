<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòû üßú üò∂ Travailler avec nRF51822 en utilisant ST-Link et Clion + OpenOCD üéá üìº üõÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, communaut√© Habr! 


 Le temps est donc venu pour les √©tudiants des universit√©s techniques. Il est donc temps pour les projets domestiques et ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Travailler avec nRF51822 en utilisant ST-Link et Clion + OpenOCD</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439148/"><p>  Bonjour, communaut√© Habr! </p><br><p>  Le temps est donc venu pour les √©tudiants des universit√©s techniques.  Il est donc temps pour les projets domestiques et de conqu√©rir de nouveaux sommets de la technologie micro√©lectronique.  Aujourd'hui, je vais parler de mes recherches avec des cartes bas√©es sur la puce NRF51822, qui est un module Bluetooth quelque peu d√©pass√© de Nordic Semiconductor.  Cette soci√©t√© est c√©l√®bre pour ses modules radio √† faible consommation de courant et la puce NRF51822 ne fait pas exception. <a name="habracut"></a>  Mais nous ne serons pas distraits du sujet.  Parlons de fer. </p><br><h1 id="sozdanie-otladochnogo-stenda">  Cr√©ation d'un stand de d√©bogage </h1><br><p>  En octobre, des cartes <strong>yj-14015-nrf51822</strong> ont √©t√© command√©es pour des exp√©riences avec Bluetoth.  C'√©tait une mauvaise id√©e d'acheter des cartes sans c√¢blage aux connecteurs √† broches pour les fils standard pour les amateurs d'√©lectronique. </p><br><div class="spoiler">  <b class="spoiler_title">yj-14015-nrf51822</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/y3/ng/mv/y3ngmvstxvcodfs_8v77tznew4c.jpeg" alt="yj-14015-nrf51822"></p></div></div><br><p>  La distance entre les contacts inf√©rieure √† 1 mm a cr√©√© de grandes difficult√©s pour moi, une personne avec une exp√©rience de soudage extr√™mement modeste.  Les sorties sur la carte n'√©taient pas con√ßues pour √™tre soud√©es aux fils et √©taient faciles √† d√©tacher.  Ce sort est arriv√© √† la seule alimentation VDD.  Mais avec l‚Äôaide des efforts du voisin, il a √©t√© possible de souder le fil √† la sortie du condensateur de la carte.  Ensemble, les sorties GND, SWDIO, SWCLK et certaines autres sorties GPIO ont √©t√© soud√©es.  Le r√©sultat est quelque chose d'apparence similaire √† Frankenstein: </p><br><div class="spoiler">  <b class="spoiler_title">Planche soud√©e</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/iq/vi/3c/iqvi3c2ya0c0rtg1glk2eetijnm.jpeg" alt="Planche soud√©e"></p></div></div><br><p>  Nous allons d√©boguer et flasher notre appareil en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ST-Link V2.</a> Le sch√©ma de connexion est extr√™mement simple et logique: </p><br><table><thead><tr><th>  ST-Link V2 </th><th>  nrf51822 </th></tr></thead><tbody><tr><td>  3,3 V </td><td>  Vdd </td></tr><tr><td>  GND </td><td>  GND </td></tr><tr><td>  SWDIO </td><td>  SWDIO </td></tr><tr><td>  SWDCLK </td><td>  SCLK </td></tr></tbody></table><br><p>  Contrairement √† Frankenstein, une seule d√©charge de courant n'√©tait pas suffisante pour relancer ce module.  Tout d'abord, j'ai essay√© de lire la m√©moire nrf51822 en utilisant l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilitaire STM32 ST-LINK</a> .  Avec quelques mises en garde, cela fonctionnait avec les cartes STM32, mais pas avec nrf.  Sur ce point, mon travail avec le conseil d'administration s'est temporairement arr√™t√©.  Un peu plus tard, j'ai trouv√© l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article 1</a> et l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article 2</a> sur l'utilisation du nrf51822.  Il contenait des liens vers le SDK et une description d√©taill√©e de l'organisation de la m√©moire nrf.  L'auteur des articles a utilis√© le d√©bogueur JLink plus cher, contrairement √† nous.  Les solutions bon march√© sont tr√®s importantes si vous √™tes un √©tudiant pauvre :). </p><br><h1 id="izuchenie-sdk">  SDK d'apprentissage </h1><br><p>  Si vous souhaitez utiliser la fonctionnalit√© Bluetooth, <del>  ce qui est assez logique pour une puce bluetooth, </del>  vous devrez mettre le "softdevice" au d√©but de la m√©moire programmable nrf5.  Il se pr√©sente sous la forme d'un firmware et contient des fonctionnalit√©s Bluetooth.  Le reste de la m√©moire est √©crit dans votre firmware.  √Ä partir de l√†, vous pouvez appeler les proc√©dures du softdevice pour configurer le bluetooth. </p><br><p>  Il existe plusieurs p√©riph√©riques logiciels diff√©rents.  Pour nrf51, vous pouvez utiliser s110 (pour les applications serveur) et s130 (pour les applications serveur et client).  Pour comprendre la compatibilit√© des versions du SDK et du softdevice, il <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">existe une matrice de compatibilit√©</a> .  On peut voir que les SDK jusqu'√† la version 12.3.0 conviennent √† notre carte.  Mais nous nous arr√™terons sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SDK 10.0.0</a> depuis  Il prend en charge s110 et s130. </p><br><h1 id="nastroyka-openocd">  Configurer OpenOCD </h1><br><p>  Dans les exemples du SDK et dans les articles, l'utilitaire nrfjprog est utilis√© pour le firmware via JLink, et nous devons flasher via ST-Link V2.  Au lieu de cela, nous utiliserons le programme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenOCD</a> , <a href="">t√©l√©chargeable pour Windows</a> .  Il vous permet de flasher et de d√©boguer <del>  tuevu huchu </del>  un grand nombre de cartes et de microcircuits diff√©rents.  Il existe une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">configuration</a> pour la puce nrf51.  Pour forcer OpenOCD √† flasher notre carte, il est n√©cessaire d'ex√©cuter la commande du format pr√©sent√© ci-dessous (apr√®s avoir ajout√© le dossier OpenOCD / bin √† Path).  Vous pouvez en savoir plus sur les commandes OpenOCD dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . </p><br><pre><code class="plaintext hljs">openocd -f interface/stlink.cfg -f target/nrf51.cfg -c init -c "reset halt" ^ -c "nrf51 mass_erase 0" -c "flash write_image &lt;PATH_TO_HEX&gt; &lt;OFFSET&gt;" ^ -c reset -c exit</code> </pre> <br><p>  Le diable, comme toujours, est dans les d√©tails: </p><br><ul><li>  "reset halt" envoie une commande de r√©initialisation de la puce et arr√™te l'appareil.  Dans cet √©tat, le firmware peut √™tre effac√© / √©crit </li><li>  "nrf51 mass_erase 0" permet d'√©crire dans la section bootloader et efface toute la m√©moire programmable du microcircuit (cela aidera √† √©viter une erreur de t√©l√©chargement du firmware dans certains cas) </li><li>  au lieu de &lt;PATH_TO_HEX&gt;, vous devez remplacer le chemin d'acc√®s au fichier hex </li><li>  &lt;OFFSET&gt; d√©finit le d√©calage de l'adresse d'√©criture du firmware.  Ce param√®tre est utile si vous souhaitez flasher votre firmware s√©par√©ment de softdevice.  Si vous souhaitez √©crire le firmware √† partir du d√©but de la m√©moire (√† partir de l'adresse 0x0), vous pouvez ignorer ce param√®tre </li><li>  reset r√©initialise la puce pour qu'elle fonctionne avec le nouveau firmware </li></ul><br><p>  Le SDK comprend des fichiers hexad√©cimaux pour le p√©riph√©rique logiciel.  Pour remplir s130 sur la carte, vous pouvez utiliser la s√©quence de commandes suivante: </p><br><pre> <code class="plaintext hljs">set file=&lt;nRF5_SDK&gt;/components/softdevice/s130/hex/s130_nrf51_1.0.0_softdevice.hex openocd -f interface/stlink.cfg -f target/nrf51.cfg -c init -c "reset halt" ^ -c "nrf51 mass_erase 0" -c "flash write_image %file%" -c reset -c exit</code> </pre> <br><p>  Ensuite, vous pouvez t√©l√©charger notre firmware.  Il est important que vous supprimiez le "nrf51 mass_erase 0" afin que le softdevice n'efface pas.  Et n'oubliez pas non plus le d√©calage.  Pour s130, le d√©calage est 0x1c000 et pour s110, il est 0x18000.  Ces valeurs peuvent √™tre trouv√©es dans les sp√©cifications pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s130</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s110</a> . </p><br><pre> <code class="plaintext hljs">set file=&lt;PATH_TO_HEX&gt; openocd -f interface/stlink.cfg -f target/nrf51.cfg -c init -c "reset halt" ^ -c "flash write_image %file% 0x1c000" -c reset -c exit</code> </pre> <br><p>  Maintenant, dans la m√©moire du programme nrf51822 devrait se trouver le firmware du softdevice et le n√¥tre.  Pour les tests, j'ai utilis√© un exemple du dossier &lt;nRF5_SDK&gt; / examples / ble_peripheral / ble_app_beacon et une application Android appel√©e "nRF Connect".  Apr√®s avoir ex√©cut√© les commandes, j'ai commenc√© √† voir un p√©riph√©rique appel√© nRF.  C'est ce que nous recherchions. </p><br><h1 id="nastroyka-proekta-clion">  Mise en place d'un projet CLion </h1><br><p>  Le SDK nrf51 contient des exemples bas√©s sur des makefiles.  Pour travailler avec CLion, il est n√©cessaire de d√©crire l'assembly du projet √† l'aide des fichiers CMake.  Google a montr√© que le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet CMake pour nrf51 est</a> d√©j√† sur le github.  Il a √©t√© √©crit pour √™tre utilis√© avec le SDK 12.XX. Pour cette raison, certains chemins de fichiers pour notre SDK 10.0.0 se sont r√©v√©l√©s incorrects.  De plus, l'utilitaire nrfjprog est √©galement utilis√© dans le projet.  Par cons√©quent, j'ai d√ª bricoler les param√®tres du projet et r√©√©crire les cibles du micrologiciel √† l'aide d'OpenOCD.  Le r√©sultat de mon travail se trouve sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> .  Le fichier Lisezmoi d√©crit les instructions de configuration d'un projet et de d√©bogage dans CLion. </p><br><h1 id="ps">  PS </h1><br><p>  De nombreux d√©tails techniques li√©s aux fonctionnalit√©s du nrf51822 ont √©chapp√© √† mon r√©cit.  J'esp√®re qu'un jour je comblerai les lacunes en ajoutant un article ou en √©crivant un nouveau. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439148/">https://habr.com/ru/post/fr439148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439132/index.html">Une vieillesse inoubliable</a></li>
<li><a href="../fr439136/index.html">Quelle est la diff√©rence entre la 4G et la 5G?</a></li>
<li><a href="../fr439138/index.html">Utilisation des rappels dans React</a></li>
<li><a href="../fr439140/index.html">Message important sur les invitations de profil</a></li>
<li><a href="../fr439142/index.html">Mod√®les de maturit√© de conception</a></li>
<li><a href="../fr439150/index.html">Qui devrait payer les frais de transaction</a></li>
<li><a href="../fr439152/index.html">Salaires en informatique au second semestre 2018: selon le calculateur de salaire "My Circle"</a></li>
<li><a href="../fr439154/index.html">Comment vivent les pigistes: conception de la couverture du livre, production de son propre sac √† dos et voyages</a></li>
<li><a href="../fr439156/index.html">t1ha = hachage positif rapide</a></li>
<li><a href="../fr439158/index.html">DataArt lance un service gratuit d'am√©lioration du CV de canards CV</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>