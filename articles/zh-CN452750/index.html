<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤰 🥫 👩‍🎓 OpenLiteSpeed内部和外部的Nextcloud：配置反向代理 👨🏾‍🎤 🤾🏾 🚩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="如何在内部网络上的Nextcloud中将OpenLiteSpeed配置为反向代理？ 


 令人惊讶的是，在Habré上搜索OpenLiteSpeed不会产生任何结果！ 我急于纠正这种不公正，因为LSWS是值得使用的Web服务器。 我爱他的速度和时尚的Web管理界面： 





 尽管OpenLi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OpenLiteSpeed内部和外部的Nextcloud：配置反向代理</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452750/"><h3> 如何在内部网络上的Nextcloud中将OpenLiteSpeed配置为反向代理？ </h3><br><p> 令人惊讶的是，在Habré上搜索OpenLiteSpeed不会产生任何结果！ 我急于纠正这种不公正，因为LSWS是值得使用的Web服务器。 我爱他的速度和时尚的Web管理界面： </p><br><p><img src="https://habrastorage.org/webt/ex/pr/ai/expraidfnnddzqcw-222w5tbbto.png" alt="图片"></p><br><p> 尽管OpenLiteSpeed作为WordPress的“加速器”而闻名，但在今天的文章中，我将展示其相当具体的应用程序。 即反向代理请求（反向代理）。 您说为此使用nginx更常见吗？ 我会同意的。 但是爱LSWS确实伤害了我们！ </p><br><p> 代理好，但是在哪里？ 同样出色的服务是Nextcloud。 我们使用Nextcloud来创建私有的“文件共享云”。 对于每个客户端，我们使用Nextcloud分配一个单独的VM，并且不想“暴露”它们。 相反，我们通过通用的反向代理来代理请求。 该解决方案使您能够： </p><br><ol><li> 从Internet上删除存储客户端数据的服务器，然后 </li><li> 保存IP地址。 </li></ol><br><p> 该方案如下所示： </p><br><p><img src="https://habrastorage.org/webt/pt/iw/dk/ptiwdkww_5xiebu_7rzjk1q_nn4.png" alt="图片"></p><br><p> 显然，该方案得到了简化，因为 组织Web服务基础结构不是本文的主题。 </p><br><p> 同样在本文中，我将省略非claudaud的安装和基本配置，尤其是因为在Habré上有专门针对此主题的材料。 但是我一定会显示设置，没有这些设置，Nextcloud将无法用于代理。 </p><a name="habracut"></a><br><p> 给定：Nextcloud安装在主机1上，并配置为通过http（无SSL）工作，它只有一个本地网络接口和一个“灰色” IP地址172.16.22.110。 </p><br><p> 我们将在主机2上配置OpenLiteSpeed。它有两个接口，一个是外部接口（在Internet上查看），另一个是内部接口，其网络上的IP地址为172.16.22.0/24。 </p><br><p>  DNS名称cloud.connect.link指向主机2外部接口的IP地址 </p><br><p> 任务：通过链接“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://cloud.connect.link</a> ”（SSL）从Internet到达内部网络上的Nextcloud。 </p><br><ul><li> 在Ubuntu 18.04.2。上安装OpenLiteSpeed </li></ul><br><p> 添加存储库： </p><br><blockquote>  wget -O- <a href="">http:</a> //rpms.litespeedtech.com/debian/enable_lst_debain_repo.sh | sudo bash <br>  sudo apt-get更新 </blockquote><p> 设置，运行： </p><br><blockquote>  sudo apt-get install openlitespeed <br>  sudo / usr / local / lsws / bin / lswsctrl开始 </blockquote><br><ul><li> 最小化防火墙。 <br><blockquote> 须藤UFW允许SSH <br>  sudo ufw默认允许传出 <br>  sudo ufw默认拒绝传入 <br>  sudo ufw允许http <br> 须藤ufw允许https <br>  sudo ufw允许从<em>管理主机</em>到任何端口7080 <br>  sudo ufw启用 <br></blockquote></li><li> 将OpenLiteSpeed设置为反向代理。 <br> 为virtualhost创建目录。 <br><blockquote>  cd / usr /本地/ lsws / <br> 须藤mkdirc cloud.connect.link <br>  cd cloud.connect.link/ <br>  sudo mkdir {conf，html，logs} <br>  sudo chown lsadm：lsadm ./conf/ <br></blockquote></li></ul><br><p> 从LSWS Web界面配置虚拟主机。 <br> 开启网址管理<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://cloud.connect.link:7080</a> <br> 默认登录名/密码：admin / 123456 </p><br><p><img src="https://habrastorage.org/webt/cw/1w/he/cw1whegtkiqtmeolcucdy5poqci.png" alt="图片"></p><br><p> 添加虚拟主机（“虚拟主机”&gt;“添加”）。 </p><br><p> 添加时，将出现错误消息-没有配置文件。 这是正常现象，可通过单击“单击以创建”来解决。 </p><br><p><img src="https://habrastorage.org/webt/yo/_0/-p/yo_0-p7xc0c80x4bdaswadf1fpg.png" alt="图片"></p><br><p> 在“常规”选项卡中，指定“文档根目录”（尽管不需要它，但没有它，配置将不会生效）。 域名（如果未指定）将从虚拟主机名中获取，我们将其命名为域名。 </p><br><p><img src="https://habrastorage.org/webt/eo/7j/m_/eo7jm_yuk5x5plv6cimesnxxbso.png" alt="图片"></p><br><p> 现在是时候记住我们不仅有一个Web服务器，而且还有一个反向代理。 以下设置将告诉LSWS代理什么以及在哪里代理。 在虚拟主机的设置中，打开“外部应用程序”选项卡并添加新的应用程序，例如Web服务器： </p><br><p><img src="https://habrastorage.org/webt/ls/_k/9q/ls_k9qnq-b83jduewm-euwucaku.png" alt="图片"></p><br><p> 注明姓名和地址。 可以任意指定名称，但是必须记住它，在后续步骤中很有用。 该地址是Nextcloud驻留在内部网络上的位置： </p><br><p><img src="https://habrastorage.org/webt/lc/aj/ah/lcajahhbytgrbchjugfl5nz0hoq.png" alt="图片"></p><br><p> 在虚拟主机的相同设置中，打开“上下文”选项卡并创建“代理”类型的新上下文： </p><br><p><img src="https://habrastorage.org/webt/mj/mq/yg/mjmqyg_hy4gsxza_dcjb-sc1ldu.png" alt="图片"></p><br><p> 指定参数：URI = /，Web服务器= nextcloud_1（上一步的名称） </p><br><p><img src="https://habrastorage.org/webt/km/e_/x9/kme_x90yobopk29vt86fymdc7uu.png" alt="图片"></p><br><p> 重新启动LSWS。 只需单击一下Web界面，即可完成奇迹！  （世袭鼠标载体在对我说话） </p><br><p><img src="https://habrastorage.org/webt/qw/vr/bl/qwvrblflsbimg6ya16ay29m_pus.png" alt="图片"></p><br><p><img src="https://habrastorage.org/webt/1f/z_/p5/1fz_p5uigm1ef5sdx3vrvptniic.png" alt="图片"></p><br><ul><li> 我们放入证书，配置https。 <br> 我们将省略<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">获取证书</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">过程</a> ，同意我们已经拥有该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">证书</a> ，并使用/etc/letsencrypt/live/cloud.connect.link目录中的密钥。 </li></ul><br><p> 创建一个“侦听器”（侦听器&gt;添加），将其命名为“ https”。 我们将其指向端口443，并注意它将是安全的： </p><br><p><img src="https://habrastorage.org/webt/ou/1q/mf/ou1qmfazgmggv1wwo1alxxtpxl8.png" alt="图片"></p><br><p> 在“ SSL”选项卡中，指定密钥和证书的路径： </p><br><p><img src="https://habrastorage.org/webt/tr/xg/c0/trxgc0tcpnnca9f53yvvpk2_5hq.png" alt="图片"></p><br><p> 已经创建了一个“侦听器”，现在在“虚拟主机映射”部分中，将虚拟主机添加到其中： </p><br><p><img src="https://habrastorage.org/webt/-0/y9/2b/-0y92bbvfhdefzynyjuoipouwea.png" alt="图片"></p><br><p> 如果LSWS仅代理一项服务，则可以完成配置。 但是我们计划使用它根据域名将请求传输到不同的“机构”。 并且所有域都将拥有自己的证书。 因此，您需要转到virtualhost配置，然后再次在SSL选项卡中指定其密钥和证书。 将来，必须为每个新的虚拟主机执行此操作。 </p><br><p><img src="https://habrastorage.org/webt/us/ap/7z/usap7zccpjkyyko7llyawrkkz7g.png" alt="图片"></p><br><p> 仍然需要配置url重写，以便将HTTP请求发送到https。 </p><br><p>  <i>（顺便说一句，什么时候结束？默认情况下浏览器和其他软件应该转到https，并在必要时手动进行no-SSL转发）。</i> <br> 启用启用重写并编写重写规则： </p><br><blockquote>  RewriteCond％{SERVER_PORT} 80 <br>  RewriteRule ^（。*）$ <a href="">Https：//％{SERVER_NAME}％{REQUEST_URI</a> } [R = 301，L] </blockquote><p><img src="https://habrastorage.org/webt/ki/rn/xq/kirnxqm_dendpov7gniojwnsk7q.png" alt="图片"></p><br><p> 由于发生奇怪的误解，因此无法在通常的正常重启过程中应用重写规则。 因此，重新启动LSWS并不好，但是粗鲁而有效： </p><br><blockquote>  sudo systemctl重新启动lsws.service </blockquote><p> 使服务器侦听第80个端口，然后创建另一个侦听器。 让我们将其命名为http，指定第80个端口，它将不安全： </p><br><p><img src="https://habrastorage.org/webt/k3/za/ji/k3zajihurrtkg4ddc8eabk_njuq.png" alt="图片"></p><br><p> 通过类似于https侦听器设置，让我们将虚拟主机附加到它。 </p><br><p> 现在，LSWS将侦听第80个端口并将请求从该端口发送到443，从而重写该url。 <br> 总之，我建议降低LSWS日志记录级别，该级别默认情况下设置为“调试”。 在这种模式下，原木以闪电般的速度繁殖！ 在大多数情况下，警告等级就足够了。 转到服务器配置&gt;日志： </p><br><p><img src="https://habrastorage.org/webt/c5/cb/pl/c5cbplov4zgqtonzcw8x6bb0poy.png" alt="图片"></p><br><p> 这样就完成了OpenLiteSpeed作为反向代理的配置。 再次我们重新启动LSWS，单击链接<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://cloud.connect.link</a>并查看： </p><br><p><img src="https://habrastorage.org/webt/nn/vo/_d/nnvo_dsr_qk_pzkv0j6xoixedve.png" alt="图片"></p><br><p> 为了让Nextcloud进入我们，您需要将cloud.connect.link域添加到受信任域列表中。 去编辑config.php。 我在安装Ubuntu时自动安装了Nextcloud，配置位于此处：/ var / snap / nextcloud / current / nextcloud / config。 </p><br><p> 在trusted_domains密钥上，添加“ cloud.connect.link”参数： </p><br><blockquote>  'trusted_domains'=&gt; <br> 数组（ <br>  0 =&gt;'172.16.22.110'， <br>  1 =&gt;'cloud.connect.link'， <br>  ）， </blockquote><p><img src="https://habrastorage.org/webt/ow/62/kd/ow62kdr0pbvhfqgcrj-04yvicfi.png" alt="图片"></p><br><p> 此外，在同一配置中，您必须指定我们代理的IP地址。 我提请您注意必须指定对Nextcloud服务器可见的地址的事实。  IP本地接口LSWS。 没有此步骤，Nextcloud Web界面将起作用，但是未授权应用程序。 </p><br><blockquote>  'trusted_proxies'=&gt; <br> 数组（ <br>  0 =&gt;'172.16.22.100'， <br>  ）， </blockquote><p> 好了，之后我们可以进入授权界面： </p><br><p><img src="https://habrastorage.org/webt/ln/wk/ty/lnwktyhkca3giakan3fqnk0v7ji.png" alt="图片"></p><br><p> 问题解决了！ 现在，每个客户端可以安全地使用其个人URL中的“文件云”，带有文件的服务器与Internet分离，将来的客户端将获得相同的信息，并且不会影响其他IP地址。 <br> 此外，您可以使用反向代理来传递静态内容，但是对于Nextcloud，这不会显着提高速度。 因此，这是可选的和可选的。 </p><br><p> 很高兴分享这个故事，希望有人能对您有所帮助。 如果您知道解决问题的更优雅有效的方法，我将不胜感激！ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN452750/">https://habr.com/ru/post/zh-CN452750/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN452740/index.html">机器学习数据集的选择</a></li>
<li><a href="../zh-CN452742/index.html">设置混合应用程序的自动测试</a></li>
<li><a href="../zh-CN452744/index.html">没有自由职业者的交流，是否有充裕的生活？</a></li>
<li><a href="../zh-CN452746/index.html">《 R.沉浸在大数据中的编程艺术》一书</a></li>
<li><a href="../zh-CN452748/index.html">NGINX开发现代应用程序的原理。 第一部分</a></li>
<li><a href="../zh-CN452752/index.html">自制BigData。 第1部分。AWS集群上的Spark流实践</a></li>
<li><a href="../zh-CN452754/index.html">19％的最受欢迎的Docker映像没有root密码</a></li>
<li><a href="../zh-CN452756/index.html">在Unity中创建塔防：敌人</a></li>
<li><a href="../zh-CN452760/index.html">维生素D。喝还是不喝，这就是问题所在。 （或关于我如何通过了未按规定进行分析的故事）</a></li>
<li><a href="../zh-CN452762/index.html">MVCC-7。 自动清洁</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>