<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßñüèæ üëõ üë®üèø‚Äçüöí Comment les logiciels malveillants √©chappent aux sandbox avec Visual Basic üë©üèº‚Äçüéì üëßüèø üé∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque jour au JSOC CERT, nous rencontrons des √©v√©nements de diff√©rents bacs √† sable qui fonctionnent dans le cadre des solutions AntiAPT de nos clien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment les logiciels malveillants √©chappent aux sandbox avec Visual Basic</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/473086/">  Chaque jour au JSOC CERT, nous rencontrons des √©v√©nements de diff√©rents bacs √† sable qui fonctionnent dans le cadre des solutions AntiAPT de nos clients et laissons passer des milliers de fichiers provenant du trafic Web et e-mail.  Il convient de noter que les syst√®mes Sandbox modernes dans leur d√©veloppement sont all√©s beaucoup plus loin que la simple interception des appels syst√®me en mode noyau et des fonctions API en mode utilisateur.  De plus en plus, ils utilisent leur propre hyperviseur, un syst√®me pour √©muler l'activit√© des utilisateurs, une instrumentation dynamique, le hachage et le clustering sur des sections de code, l'analyse de la couverture du code, etc.  Une telle vari√©t√© de technologies cr√©e l'illusion que si un fichier ne fonctionne pas dans le bac √† sable et ne montre pas son ¬´vrai visage¬ª, il s'agit probablement d'APT ou d'une technologie innovante pour d√©tecter un environnement virtuel, dont la communaut√© de l'IB n'est pas encore au courant.  Mais ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sc/cl/os/scclosmhrxygm1sxytg94as3z_i.jpeg"></div><a name="habracut"></a><br>  Comme nous ne connaissons pas les caract√©ristiques internes du travail des bacs √† sable commerciaux, nous v√©rifions dans certains cas - analysons manuellement les √©chantillons qui ont r√©ussi le test.  R√©cemment, nous avons constat√© √† plusieurs reprises que certains sandbox commerciaux (pour des raisons objectives, nous ne pouvons pas dire lesquels) n'ont pas d√©tect√© certains fichiers malveillants lors de l'analyse dynamique, et si l'analyseur statique √©tait √©galement silencieux, le fichier a √©t√© ignor√©. <br><br>  L'analyse du bac √† sable a r√©ussi √† contourner des familles de logiciels malveillants bien connus comme Pony, Loki et Hawkeye.  Une seule chose les a unis - ils √©taient couverts par un packer √©crit en Visual Basic. <br><br>  √âtant donn√© que ces familles HPE n'ont depuis longtemps rien de nouveau, le verdict ¬´positif¬ª du bac √† sable est tr√®s d√©primant.  Par cons√©quent, nous avons d√©cid√© de d√©crire le principe g√©n√©ral de fonctionnement de ce packer et les observations que nous avons faites au fil du temps. <br>  Le sch√©ma g√©n√©ral du travail de l‚Äôemballeur est conditionnellement divis√© en 4 √©tapes et est illustr√© dans le diagramme ci-dessous. <br><br><img src="https://habrastorage.org/webt/fk/c9/of/fkc9of6pras7-cd55luw1l1mpai.jpeg"><br><br>  Le point d'entr√©e d'un fichier malveillant semble typique des applications Visual Basic: <br><br><img src="https://habrastorage.org/webt/vj/ia/he/vjiaheueiyapa2swzf8_cqrwzka.jpeg"><br><br>  Nous avons rencontr√© diff√©rentes options pour ce packer, et le code VB Wrapper a chang√© fr√©quemment, mais la t√¢che effectu√©e est rest√©e la m√™me: transf√©rer le contr√¥le vers le code Stage 1. Dans les exemples pr√©c√©dents, le contr√¥le √©tait transf√©r√© √† l'aide des fonctions API de la classe Enum * (par exemple, EnumWindows, EnumCalendarInfo, etc.). e) pour lequel l'adresse √âtape 1 du code a √©t√© indiqu√©e comme param√®tre.  R√©cemment, nous observons que le contr√¥le est transf√©r√© directement. <br><br><h2>  √âtape 1 </h2><br>  La direction re√ßoit le code √âtape 1. Ce code n'est pas chiffr√©, mais est obscurci.  Les m√©thodes d'obfuscation varient d'un √©chantillon √† l'autre, mais l'algorithme de fonctionnement g√©n√©ral ne change pas: <br><br><ol><li>  Un cycle avec de nombreuses instructions (y compris les ordures) qui g√©n√®re la cl√© n√©cessaire pour d√©coder le code de l'√©tape 2.  La particularit√© de ce morceau de code est qu'il n'y a pas de fonctions Sleep, mais en raison du grand nombre d'it√©rations, son ex√©cution prend en moyenne 1-2 minutes. </li><li>  D√©chiffrement (XOR r√©gulier) et transfert de contr√¥le au code Stage 2. </li></ol><br>  La capture d'√©cran ci-dessous montre des exemples de m√©thodes d'obscurcissement utilis√©es: <br><br><img src="https://habrastorage.org/webt/--/p-/xl/--p-xlue_skm9loofz_wj3tmeic.jpeg"><br><br><h2>  2 √©tages </h2><br>  La t√¢che principale du code de l'√©tape 2 est de v√©rifier l'environnement et de mettre en ≈ìuvre des m√©thodes anti-d√©bogage.  Certaines parties du code sont chiffr√©es (d√©chiffr√©es avant ex√©cution, puis chiffr√©es √† nouveau avec le m√™me algorithme XOR), ce qui rend la d√©tection difficile par signatures.  Apr√®s d√©chiffrement, les caract√©ristiques sont visibles, selon lesquelles le code de l'√©tape 2 peut √™tre reconnu par une analyse manuelle. <br><br><img src="https://habrastorage.org/webt/eb/n8/oq/ebn8oqw9vqcysrl-c98pdfdrdjq.jpeg"><br><br>  La liste des v√©rifications est assez grande et diff√®re selon les diff√©rentes versions du packer, nous allons donc donner plusieurs m√©thodes qui ont √©t√© trouv√©es dans toutes les versions, avec des captures d'√©cran, et √† la fin, nous listons la liste enti√®re dans le tableau. <br><br><h4>  1) GetTickCount + Sleep </h4><br>  L'horodatage actuel est pris, Sleep est appel√© pendant 2 secondes, apr√®s quoi un autre horodatage est imm√©diatement pris. <br><br>  Apr√®s cela, la diff√©rence entre les notes est v√©rifi√©e (si 2 secondes se sont r√©ellement √©coul√©es). <br><br><img src="https://habrastorage.org/webt/mp/ip/pj/mpippjhsogyg_uvk0eikkuehm_w.jpeg"><br><br><h4>  2) SetErrorMode </h4><br>  V√©rifie le bon fonctionnement de l'appel de l'API SetErrorMode.  La fonction est appel√©e deux fois de suite avec les param√®tres 0x800 et 0x0, apr√®s quoi le r√©sultat du deuxi√®me appel est v√©rifi√©: il doit √™tre √©gal √† 0x800. <br><br><img src="https://habrastorage.org/webt/gp/kr/vx/gpkrvxff7l4irukw4oqifs6ai4a.jpeg"><br><br><h4>  3) SetLastError </h4><br>  Tout d'abord, SetLastError est appel√©e avec le param√®tre 0x5, apr√®s quoi il est v√©rifi√© que la valeur du dernier code d'erreur dans le TEB est correctement d√©finie (c'est-√†-dire qu'il s'agit de 0x5). <br><br><img src="https://habrastorage.org/webt/3k/am/vh/3kamvhsb_z6nw8tlchtlcuhxa0q.jpeg"><br><br><h4>  4) V√©rification du mouvement du curseur </h4><br>  Le code entre dans une boucle sans fin en attendant que la souris bouge. <br><br><img src="https://habrastorage.org/webt/aq/1w/wo/aq1wwopzjhbmihs8mxnmmkcxoma.jpeg"><br><br><h4>  5) DbgBreakPoint et DbgUiRemoteBreakin </h4><br>  Ces fonctions sont modifi√©es pour emp√™cher le d√©bogueur de se connecter au processus. <br><br><img src="https://habrastorage.org/webt/aw/we/qd/awweqdnasj4ztgfjk1bdv-lcfw4.jpeg"><br><table border="1"><tbody><tr><td><p>  Technique <br></p><br></td><td><p>  Commentaire <br></p><br></td></tr><tr><td><p>  GetTickCount + Sleep <br></p><br></td><td><p>  V√©rification des horodatages <br></p><br></td></tr><tr><td><p>  SetErrorMode <br></p><br></td><td><p>  V√©rification de la fonction correcte <br></p><br></td></tr><tr><td><p>  SetLastError <br></p><br></td><td><p>  V√©rifier que la fonction fonctionne correctement <br></p><br></td></tr><tr><td><p>  GetCursorPos <br></p><br></td><td><p>  V√©rifier le mouvement du curseur <br></p><br></td></tr><tr><td><p>  Dbgbreakpoint <br></p><br></td><td><p>  Modification de fonction pour emp√™cher la connexion du d√©bogueur <br></p><br></td></tr><tr><td><p>  DbgUiRemoteBreakin <br></p><br></td><td><p>  Modification de fonction pour emp√™cher la connexion du d√©bogueur <br></p><br></td></tr><tr><td><p>  Suppression du crochet <br></p><br></td><td><p>  Les 5 premiers octets de fonctions sont restaur√©s dans ntdll.dll en cas de hooks <br></p><br></td></tr><tr><td><p>  NtSetInformationThread <br></p><br></td><td><p>  Param√®tre 0x11 (ThreadHideFromDebugger) <br></p><br></td></tr><tr><td><p>  GetThreadContext + check DR <br></p><br></td><td><p>  Les registres de d√©bogage DR0-DR3, DR6, DR7 sont v√©rifi√©s. <br></p><br></td></tr><tr><td><p>  V√©rifier les points d'arr√™t <br></p><br></td><td><p>  Les instructions INT3 (0xCC), int 3 (0xCD 0x03) et ud2 (0x0F 0x0B) au d√©but de certaines fonctions sont v√©rifi√©es <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x0) <br></p><br></td><td><p>  Les registres EAX, ECX, EDX sont v√©rifi√©s <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x40000000) <br></p><br></td><td><p>  Les registres EAX, ECX, EDX sont v√©rifi√©s <br></p><br></td></tr><tr><td><p>  cpuid (EAX = 0x1) <br></p><br></td><td><p>  31e bit ECX v√©rifi√© <br></p><br></td></tr><tr><td><p>  PEB (BeingDebugged) <br></p><br></td><td><p>  V√©rifie la valeur 0x1 <br></p><br></td></tr><tr><td><p>  PEB (NtGlobalFlag) <br></p><br></td><td><p>  Valeur v√©rifi√©e 0x70 <br></p><br></td></tr><tr><td><p>  NtQueryInformationProcess <br></p><br></td><td><p>  Appel√© avec des indicateurs ProcessDebugPort (0x7), ProcessDebugFlags (0x1F), ProcessDebugObjectHandle (0x1E) <br></p><br></td></tr><tr><td><p>  V√©rification du nom du processus <br></p><br></td><td><p>  Les cha√Ænes ¬´sample¬ª, ¬´sandbox¬ª, ¬´virus¬ª, ¬´malware¬ª, ¬´self¬ª sont v√©rifi√©es <br></p><br></td></tr></tbody></table><br>  Si toutes les techniques de l'√©tape 2 sont termin√©es, la ligne de commande est v√©rifi√©e pour la conformit√© avec le format sp√©cial.  Si la v√©rification √©choue, les actions suivantes sont effectu√©es: <br><br>  1) La fonction CreateProcess est appel√©e avec l'indicateur CREATE_SUSPENDED pour red√©marrer le processus en cours.  Dans ce cas, la ligne de commande a le format requis. <br>  2) √Ä l'aide des fonctions GetContextThread et SetContextThread, le point d'entr√©e est chang√© en un nouveau, qui se trouve dans le code de l'√©tape 1. <br>  3) R√©p√©tez les √©tapes 1 et 2 (y compris un cycle long et toutes les v√©rifications).  Cette fois, la v√©rification de la ligne de commande a r√©ussi et le processus passe √† l'√©tape suivante. <br><br><h2>  3 √©tages </h2><br>  √Ä ce stade, le corps du virus principal est d√©chiffr√© et la technique de processus creux est ex√©cut√©e sur le processus en cours, apr√®s quoi le contr√¥le est transf√©r√© au point d'entr√©e du virus principal. <br><br><h2>  Le√ßon apprise </h2><br>  Nous ne pouvons pas dire exactement ce qui cause tel ou tel bac √† sable dans ce cas, mais je veux croire que la possibilit√© d'utiliser les techniques d√©crites dans l'article par des logiciels malveillants a √©t√© pr√©vue depuis longtemps par les fournisseurs, et le probl√®me r√©side uniquement dans le long d√©lai de la premi√®re √©tape du travail de l'emballeur. . <br><br>  Malgr√© le fait que les bacs √† sable modernes sont pour la plupart positionn√©s dans le cadre de syst√®mes de protection contre les attaques APT, nos observations sugg√®rent que m√™me des familles malveillantes bien connues de la communaut√© p√©n√®trent dans l'infrastructure avec une constance enviable.  Puisqu'il n'y a aucune garantie que l'√©chantillon qui a contourn√© le bac √† sable n'aura pas quelques techniques de contournement antivirus dans son arsenal, vous ne pouvez pas compter uniquement sur ce tas de solutions de protection.  Dans de tels cas, un processus de surveillance correctement construit, y compris les √©v√©nements de s√©curit√© des informations des h√¥tes finaux, peut garantir une r√©ponse rapide et minimiser les dommages potentiels. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473086/">https://habr.com/ru/post/fr473086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473072/index.html">Comment Gazpromneft cr√©e un parcours num√©rique pour une entreprise cliente</a></li>
<li><a href="../fr473074/index.html">Qu'est-ce que l'APS et pourquoi il ne "fait pas un plan de production comme nous le voulons ..."</a></li>
<li><a href="../fr473078/index.html">G√©rez facilement les configurations de microservices avec microconfig.io</a></li>
<li><a href="../fr473082/index.html">Comment nous √©crivons des microservices et pourquoi nous ne le faisons pas rapidement</a></li>
<li><a href="../fr473084/index.html">¬´Ivan¬ª est une profession de chat bot. Ou des exp√©riences cr√©atives avec des assistants virtuels</a></li>
<li><a href="../fr473088/index.html">Le mythe de la liquidit√© sur le march√© du p√©trole et de l'or des utilisateurs du sous-sol</a></li>
<li><a href="../fr473090/index.html">PocketBook 632 et 632 Aqua Review - Petits lecteurs phares de 6 pouces avec encre E</a></li>
<li><a href="../fr473092/index.html">AMA avec Habr, # 13: nouvelles importantes pour les utilisateurs et les entreprises</a></li>
<li><a href="../fr473096/index.html">Structures de donn√©es avanc√©es. Premi√®re partie: graphique acyclique directionnel</a></li>
<li><a href="../fr473108/index.html">Composants agulaires en angulaire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>