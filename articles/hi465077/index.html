<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯФТ ЁЯУ╜я╕П ЁЯЪ╢ЁЯП╜ Unsafe.AsSpan: Span <T> рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХреЛ рдХреИрд╕реЗ рдмрджрд▓реЗрдВ? ЁЯС╢ЁЯП╗ ЁЯХЯ ЁЯЦРЁЯП┐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C# рдПрдХ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд░реВрдк рд╕реЗ рд▓рдЪреАрд▓реА рднрд╛рд╖рд╛ рд╣реИред рдЙрд╕ рдкрд░ рдЖрдк рди рдХреЗрд╡рд▓ рдмреИрдХрдПрдВрдб рдпрд╛ рдбреЗрд╕реНрдХрдЯреЙрдк рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВред рдореИрдВ рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП C# рдХрд╛ рдЙрдкрдпреЛ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unsafe.AsSpan: Span <T> рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХреЛ рдХреИрд╕реЗ рдмрджрд▓реЗрдВ?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465077/"><p><img src="https://habrastorage.org/webt/3f/dh/ia/3fdhia5h25mpjbabeocnlygdd1c.png"></p><br><p> <code>C#</code> рдПрдХ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд░реВрдк рд╕реЗ рд▓рдЪреАрд▓реА рднрд╛рд╖рд╛ рд╣реИред  рдЙрд╕ рдкрд░ рдЖрдк рди рдХреЗрд╡рд▓ рдмреИрдХрдПрдВрдб рдпрд╛ рдбреЗрд╕реНрдХрдЯреЙрдк рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВред  рдореИрдВ рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <code>C#</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ, рдЬреЛ рднрд╛рд╖рд╛ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рдЙрдкрдХрд░рдгреЛрдВ рдкрд░ рдХреБрдЫ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред  рд╣рд╛рд▓рд╛рдБрдХрд┐ <code>netcore</code> <code>netstandard2.0</code> рдПрдЬреЗрдВрдбрд╛ рдкрд░ рд╣реИ (рдпрд╣ рдорд╛рдирддреЗ рд╣реБрдП рдХрд┐ <code>netstandard2.0</code> рдмрд╛рдж рджреЛрдиреЛрдВ рднрд╛рд╖рд╛рдУрдВ рдФрд░ рд░рдирдЯрд╛рдЗрдо рдХреА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЕрдзрд┐рдХрд╛рдВрд╢</a> рд╕реБрд╡рд┐рдзрд╛рдПрдБ <code>netframework</code> рдХреЛ <code>netframework</code> рдирд╣реАрдВ <code>netframework</code> ), рдореИрдВ рд╡рд┐рд░рд╛рд╕рдд рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рдЬрд╛рд░реА рд░рдЦрддрд╛ рд╣реВрдВред </p><br><p>  рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ, рдореИрдВ рдПрдХ рдЧреИрд░-рд╕реНрдкрд╖реНрдЯ (рд▓реЗрдХрд┐рди рд╢рд╛рдпрдж рд╡рд╛рдВрдЫрд┐рдд?) <code>Span&lt;T&gt;</code> рдЖрд╡реЗрджрди рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рддрд╛ рд╣реВрдВ <code>Span&lt;T&gt;</code> рдФрд░ <code>clr</code> рдХреА рдмрд╛рд░реАрдХрд┐рдпреЛрдВ рдХреЗ рдХрд╛рд░рдг <code>netframework</code> рдФрд░ <code>netframework</code> рдореЗрдВ <code>Span&lt;T&gt;</code> рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рдмреАрдЪ рдХрд╛ рдЕрдВрддрд░ред </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">рдЕрд╕реНрд╡реАрдХрд░рдг рез</b> <div class="spoiler_text"><p>  рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдХреЛрдб рд╕реНрдирд┐рдкреЗрдЯ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рджреБрдирд┐рдпрд╛ рдХреА рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕рд╛рдзрди рдирд╣реАрдВ рд╣реИрдВред </p><br><p>  рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рд╕рдорд╛рдзрд╛рди (рджреВрд░ рдХреА рдХреМрдбрд╝реА?) рд╕рдорд╕реНрдпрд╛ рдмрд▓реНрдХрд┐ рдПрдХ рд╕рдмреВрдд рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛ рд╣реИред <br>  рдХрд┐рд╕реА рднреА рдорд╛рдорд▓реЗ рдореЗрдВ, рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рдЗрд╕реЗ рд▓рд╛рдЧреВ рдХрд░рдХреЗ, рдЖрдк рдЗрд╕реЗ рдЕрдкрдиреЗ рдЬреЛрдЦрд┐рдо рдФрд░ рдЬреЛрдЦрд┐рдо рдкрд░ рдХрд░рддреЗ рд╣реИрдВред </p></div></div><br><div class="spoiler">  <b class="spoiler_title">рдЕрд╕реНрд╡реАрдХрд░рдг реи</b> <div class="spoiler_text"><p>  рдореБрдЭреЗ рдкреВрд░рд╛ рдпрдХреАрди рд╣реИ рдХрд┐ рдХрд╣реАрдВ рди рдХрд╣реАрдВ, рдХрд┐рд╕реА рди рдХрд┐рд╕реА рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ <strong>рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк</strong> рд╕реЗ рдШреБрдЯрдиреЗ рдореЗрдВ рдХрд┐рд╕реА рдХреЛ рдЧреЛрд▓реА рдорд╛рд░ <strong>рджреЗрдЧрд╛</strong> ред </p><br><p>  <code>C#</code> рдореЗрдВ рдЯрд╛рдЗрдк рд╕реЗрдлреНрдЯреА рдХреЗ рдХрд╛рд░рдг рдХреБрдЫ рднреА рдЕрдЪреНрдЫрд╛ рд╣реЛрдиреЗ <code>C#</code> рд╕рдВрднрд╛рд╡рдирд╛ рдирд╣реАрдВ рд╣реИред </p><br><p>  рд╕реНрдкрд╖реНрдЯ рдХрд╛рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рд╕рднреА рд╕рдВрднрд╛рд╡рд┐рдд рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЗрд╕ рдХреЛрдб рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдирд╣реАрдВ рдХрд┐рдпрд╛, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдкрд░рд┐рдгрд╛рдо рдЖрд╢рд╛рдЬрдирдХ рджрд┐рдЦрддреЗ рд╣реИрдВред </p></div></div><br><h1 id="a-zachem-mne-voobsche-spant">  рдореБрдЭреЗ <code>Span&lt;T&gt;</code> рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреНрдпреЛрдВ рд╣реИ? </h1><br><p>  Spen рдЖрдкрдХреЛ рдЕрдзрд┐рдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд░реВрдк рдореЗрдВ <code>unmanaged</code> рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд░рдгрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЖрд╡рд╢реНрдпрдХ рдЖрд╡рдВрдЯрди рдХреА рд╕рдВрдЦреНрдпрд╛ рдХрдо рд╣реЛ рдЬрд╛рддреА рд╣реИред  рдЗрд╕ рддрдереНрдп рдХреЗ рдмрд╛рд╡рдЬреВрдж рдХрд┐ <code>BCL</code> <code>netframework</code> рдореЗрдВ рд╕реНрдкреИрди рдХрд╛ рд╕рдорд░реНрдерди рд▓рдЧрднрдЧ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрдиреБрдкрд╕реНрдерд┐рдд рд╣реИ, <code>System.Memory</code> , <code>System.Buffers</code> рдФрд░ <code>System.Runtime.CompilerServices.Unsafe</code> рдХрд╛ <code>System.Memory</code> рдХрд░рдХреЗ рдХрдИ рдЙрдкрдХрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред <br>  рдореЗрд░реА рд╡рд┐рд░рд╛рд╕рдд рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рд╕реНрдкреИрди рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реАрдорд┐рдд рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдореИрдВрдиреЗ рдЙрдиреНрд╣реЗрдВ рдПрдХ рд╕реНрдкрд╖реНрдЯ рдЙрдкрдпреЛрдЧ рдкрд╛рдпрд╛, рдЬрдмрдХрд┐ рдкреНрд░рдХрд╛рд░ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдкрд░ рдереВрдХрдирд╛ред <br>  рдпрд╣ рдЖрд╡реЗрджрди рдХреНрдпрд╛ рд╣реИ?  рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рдореИрдВ рдПрдХ рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рдЙрдкрдХрд░рдг рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реВрдВред  рдпреЗ рдЫрд╡рд┐рдпрд╛рдВ рд╣реИрдВ, рдЬреЛ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ, <code>T[]</code> рдХреА рдПрдХ рд╕рд░рдгреА рд╣реИрдВ, рдЬрд╣рд╛рдВ <code>T</code> , <code>unmanaged</code> рдЖрджрд┐рдо рдкреНрд░рдХрд╛рд░реЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП <code>Int32</code> (рдЙрд░реНрдл <code>int</code> )ред  рдЗрди рдЫрд╡рд┐рдпреЛрдВ рдХреЛ рдбрд┐рд╕реНрдХ рдкрд░ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХреНрд░рдордмрджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореБрдЭреЗ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд░реВрдк рд╕реЗ рдЕрд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╡рд┐рд░рд╛рд╕рдд рдкреНрд░рд╛рд░реВрдк</a> рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ <a href="">1981</a> рдореЗрдВ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рддрдм рд╕реЗ рдереЛрдбрд╝рд╛ рдмрджрд▓ рдЧрдпрд╛ рд╣реИред  рдЗрд╕ рдкреНрд░рд╛рд░реВрдк рдХреА рдореБрдЦреНрдп рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдмрд┐рдЧрдЗрдВрдбрд┐рдпрди</a> ред  рдЗрд╕ рдкреНрд░рдХрд╛рд░, <code>T[]</code> рдПрдХ рдЕрд╕рдореНрдкреАрдбрд┐рдд рд╕рд░рдгреА рдХреЛ рд▓рд┐рдЦрдиреЗ (рдпрд╛ рдкрдврд╝рдиреЗ) рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдкреНрд░рддреНрдпреЗрдХ рддрддреНрд╡ рдХреА рд╕рдорд╛рдкреНрддрд┐ рдХреЛ рдмрджрд▓рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рддреБрдЪреНрдЫ рдХрд╛рд░реНрдпред <br>  рдХреБрдЫ рд╕реНрдкрд╖реНрдЯ рд╕рдорд╛рдзрд╛рди рдХреНрдпрд╛ рд╣реИрдВ? </p><br><ol><li>  рд╣рдо рд╕рд░рдгреА <code>T[]</code> рдкрд░ рдкреБрдирд░рд╛рд╡реГрддрд┐ рдХрд░рддреЗ рд╣реИрдВ, <code>BitConverter.GetBytes(T)</code> рдХреЙрд▓ рдХрд░реЗрдВ, рдЗрди рдХреБрдЫ рдмрд╛рдЗрдЯреНрд╕ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░реЗрдВ, рд▓рдХреНрд╖реНрдп рд╕рд░рдгреА рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВред </li><li>  рд╣рдо рд╕рд░рдгреА <code>T[]</code> рдкрд░ рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рдХрд░рддреЗ рд╣реИрдВ, <code>new byte[] {(byte)((x &amp; 0xFF00) &gt;&gt; 8), (byte)(x &amp; 0x00FF)};</code>  (рдбрдмрд▓-рдмрд╛рдЗрдЯ рдкреНрд░рдХрд╛рд░ рдкрд░ рдХрд╛рдо рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП), рд▓рдХреНрд╖реНрдп рд╕рд░рдгреА рдкрд░ рд▓рд┐рдЦреЗрдВред </li><li>  <sup>*</sup> рд▓реЗрдХрд┐рди <code>T[]</code> рдПрдХ рд╕рд░рдгреА рд╣реИ?  рддрддреНрд╡ рдПрдХ рдкрдВрдХреНрддрд┐ рдореЗрдВ рд╣реИрдВ, рд╣реИ рдирд╛?  рддреЛ рдЖрдк рд╕рднреА рддрд░рд╣ рд╕реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <code>Buffer.BlockCopy(intArray, 0, byteArray, 0, intArray.Length * sizeof(int));</code>  ред  рд╡рд┐рдзрд┐ рд╕рд░рдгреА рдХреЛ рдЪреЗрдХрд┐рдВрдЧ рдкреНрд░рдХрд╛рд░ рдХреА рдЕрдирджреЗрдЦреА рдХрд░ рд╕рд░рдгреА рдХреЛ рдХреЙрдкреА рдХрд░рддреА рд╣реИред  рдпрд╣ рдХреЗрд╡рд▓ рд╕реАрдорд╛рдУрдВ рдФрд░ рдЖрд╡рдВрдЯрди рдХреЛ рдпрд╛рдж рдирд╣реАрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред  рд╣рдо рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдмрд╛рдЗрдЯреНрд╕ рдХреЛ рдорд┐рд▓рд╛рддреЗ рд╣реИрдВред </li><li>  <sup>*</sup> рд╡реЗ рдХрд╣рддреЗ рд╣реИрдВ рдХрд┐ <code>C#</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><code>(C++)++</code></a> ред  рдЗрд╕рд▓рд┐рдП, рд╕рдХреНрд╖рдо <code>/unsafe</code> , <code>fixed(int* p = &amp;intArr[0]) byte* bPtr = (byte*)p;</code>  рдФрд░ рдЕрдм рдЖрдк рд╕реНрд░реЛрдд рд╕рд░рдгреА рдХреЗ рдмрд╛рдЗрдЯ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХреЗ рдЪрд╛рд░реЛрдВ рдУрд░ рджреМрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ, рдордХреНрдЦреА рдкрд░ рдзреАрд░рдЬ рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдкреВрд░реА рдирдИ рдмрд╛рдЗрдЯ рд╕рд░рдгреА рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдП рдмрд┐рдирд╛ рдбрд┐рд╕реНрдХ ( <code>stackalloc byte[]</code> рдпрд╛ <code>ArrayPool&lt;byte&gt;.Shared</code> ) рдХреЛ рдЗрдВрдЯрд░рдореАрдбрд┐рдПрдЯ рдмрдлрд░ рдХреЗ рд▓рд┐рдП рдмреНрд▓реЙрдХ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВред </li></ol><br><p>  рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдмрд┐рдВрджреБ <strong>4</strong> рдЖрдкрдХреЛ рд╕рднреА рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди <code>unsafe</code> рд╕рдВрджрд░реНрдн рдФрд░ рд╕рдВрдХреЗрдд рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рд╕реНрдкрд╖реНрдЯ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рддрд░рд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрд▓рдЧ рд╣реИред  рдлрд┐рд░ <code>Span&lt;T&gt;</code> рд╣рдорд╛рд░реА рд╕рд╣рд╛рдпрддрд╛ рдХреЗ рд▓рд┐рдП рдЖрддрд╛ рд╣реИред </p><br><h1 id="spant"> <code>Span&lt;T&gt;</code> </h1> <br><p>  <code>Span&lt;T&gt;</code> рдХреЛ рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ рд╕реНрдореГрддрд┐ рдмрд┐рдВрджреБрдУрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдХрд░рдг рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬреИрд╕реЗ рдХрд┐ рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд╛рдо рдХрд░рдирд╛, рд╕реНрдореГрддрд┐ рдореЗрдВ рд╕рд░рдгреА рдХреЛ "рдареАрдХ" рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рдирд╛ред  рд╕рд░рдгреА рд╕реАрдорд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЗрд╕ рддрд░рд╣ рдХреЗ <code>GC</code> рд╕рд╛рд╡рдзрд╛рди рд╕реВрдЪрдХред  рд╕рдм рдХреБрдЫ рдареАрдХ рдФрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИред <br>  рдПрдХ рдмрд╛рдд рд▓реЗрдХрд┐рди - <code>System.Runtime.CompilerServices.Unsafe</code> рдХреА рд╕рдВрдкрддреНрддрд┐ рдХреЗ рдмрд╛рд╡рдЬреВрдж, <code>Span&lt;T&gt;</code> рдЯрд╛рдЗрдк <code>T</code> рд▓рд┐рдП рдХрд┐рд╕реА рдХреЛ рдирд╣реАрдВ <code>T</code>  рдпрд╣ рджреЗрдЦрддреЗ рд╣реБрдП рдХрд┐ рд╕реНрдкреИрди рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реВрдк рд╕реЗ <sup>1</sup> + рд▓рдВрдмрд╛рдИ рд╕реВрдЪрдХ рд╣реИ, рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рддреЗ рд╣реИрдВ, рдЗрд╕реЗ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреНрд░рдХрд╛рд░ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд▓рдВрдмрд╛рдИ рдХреЛ рдкреБрдирд░реНрдЧрдгрдирд╛ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдирдпрд╛ рд╕реНрдкреИрди рдмрдирд╛рддреЗ рд╣реИрдВ?  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ <code>public Span&lt;T&gt;(void* pointer, int length)</code> ред <br>  рдЖрдЗрдП рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдкрд░реАрдХреНрд╖рдг рд▓рд┐рдЦреЗрдВ: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; span</span></span></span><span class="hljs-function">)</span></span> {<span class="hljs-comment"><span class="hljs-comment">/*   endianess */</span></span>} Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] {<span class="hljs-number"><span class="hljs-number">123</span></span>}; Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; y = DangerousCast&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(x); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">123</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>]); Flip(y); Assert.AreNotEqual(<span class="hljs-number"><span class="hljs-number">123</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>]); Flip(y); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">123</span></span>, x[<span class="hljs-number"><span class="hljs-number">0</span></span>]); }</code> </pre> <br><p>  рдореЗрд░реЗ рд╕реЗ рдЕрдзрд┐рдХ рдЙрдиреНрдирдд рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ рддреБрд░рдВрдд рдорд╣рд╕реВрд╕ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдпрд╣рд╛рдВ рдХреНрдпрд╛ рдЧрд▓рдд рд╣реИред  рдХреНрдпрд╛ рдкрд░реАрдХреНрд╖рд╛ рдореЗрдВ рдлреЗрд▓ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗ?  рдЙрддреНрддрд░, рдЬреИрд╕рд╛ рдХрд┐ рдЖрдорддреМрд░ рдкрд░ рд╣реЛрддрд╛ рд╣реИ, <strong>рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ</strong> ред <br>  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд░рдирдЯрд╛рдЗрдо рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред  <code>netframework</code> рдкрд░, рдкрд░реАрдХреНрд╖рдг <em>рдХреЛ</em> рдХрд╛рдо <em>рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП</em> , рд▓реЗрдХрд┐рди <code>netframework</code> рдкрд░, рдпрд╣ рдХреИрд╕реЗ <code>netframework</code> ред <br>  рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ, рдпрджрд┐ рдЖрдк рдХреБрдЫ рдирд┐рдмрдВрдзреЛрдВ рдХреЛ рд╣рдЯрд╛рддреЗ рд╣реИрдВ, рддреЛ рдкрд░реАрдХреНрд╖рдг 100% рдорд╛рдорд▓реЛрдВ рдореЗрдВ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рдо рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рджреЗрддрд╛ рд╣реИред <br>  рдЪрд▓реЛ рдареАрдХ рд╣реИред </p><br><p>  <sup>1</sup> рдореИрдВ <em>рдЧрд▓рдд рдерд╛</em> ред </p><br><h1 id="pravilnyy-otvet-zavisit">  рд╕рд╣реА рдЙрддреНрддрд░: рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ </h1><br><p>  рдкрд░рд┐рдгрд╛рдо <em>рдирд┐рд░реНрднрд░</em> рдХреНрдпреЛрдВ рдХрд░рддрд╛ рд╣реИ? <br>  рдЖрдЗрдП рд╕рднреА рдЕрдирд╛рд╡рд╢реНрдпрдХ рд╣рдЯрд╛ рджреЗрдВ рдФрд░ рдпрд╣рд╛рдВ рдЗрд╕ рддрд░рд╣ рдХрд╛ рдХреЛрдб рд▓рд┐рдЦреЗрдВ: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; Check(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] {<span class="hljs-number"><span class="hljs-number">999</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">-100</span></span>}; Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; y = As&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">@"FRAMEWORK_NAME"</span></span>); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y); Console.WriteLine(); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x, <span class="hljs-string"><span class="hljs-string">"Span&lt;int&gt; [0]"</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y, <span class="hljs-string"><span class="hljs-string">"Span&lt;byte&gt;[0]"</span></span>); Console.WriteLine(); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Offset&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"Span&lt;int&gt; [0] offset by size_t"</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Offset&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">"Span&lt;byte&gt;[0] offset by size_t"</span></span>); Console.WriteLine(); GC.Collect(<span class="hljs-number"><span class="hljs-number">0</span></span>, GCCollectionMode.Forced, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x, <span class="hljs-string"><span class="hljs-string">"Span&lt;int&gt; [0] after GC"</span></span>); Write&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y, <span class="hljs-string"><span class="hljs-string">"Span&lt;byte&gt;[0] after GC"</span></span>); Console.WriteLine(); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> x); Write(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> y); }</code> </pre> <br><p>  <code>Write&lt;T, U&gt;</code> рд╡рд┐рдзрд┐ рдЯрд╛рдЗрдк <code>T</code> рдХреА рдЕрд╡рдзрд┐ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ, рдкрд╣рд▓реЗ рддрддреНрд╡ рдХрд╛ рдкрддрд╛ рдкрдврд╝рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕ рд╕реВрдЪрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЯрд╛рдЗрдк <code>U</code> рдХрд╛ рдПрдХ рддрддреНрд╡ рдкрдврд╝рддрд╛ рд╣реИред  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, <code>Write&lt;int, int&gt;(ref x)</code> рдореЗрдореЛрд░реА рдореЗрдВ рдПрдбреНрд░реЗрд╕ + рдирдВрдмрд░ 999 рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд░реЗрдЧрд╛ред <br>  рд╕рд╛рдорд╛рдиреНрдп <code>Write</code> рдПрдХ рд╕рд░рдгреА рдкреНрд░рд┐рдВрдЯред <br>  рдЕрдм <code>As&lt;,&gt;</code> рд╡рд┐рдзрд┐ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> Span&lt;U&gt; As&lt;T, U&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Span&lt;T&gt; span) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> U : unmanaged { <span class="hljs-keyword"><span class="hljs-keyword">fixed</span></span>(T* ptr = span) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Span&lt;U&gt;(ptr, span.Length * Unsafe.SizeOf&lt;T&gt;() / Unsafe.SizeOf&lt;U&gt;()); }</code> </pre> <br><p>  <code>C#</code> рд╕рд┐рдВрдЯреИрдХреНрд╕ рдЕрдм рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ <code>Span&lt;T&gt;.GetPinnableReference()</code> рд╡рд┐рдзрд┐ рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдЗрд╕ рдирд┐рд╢реНрдЪрд┐рдд-рд░рд╛рдЬреНрдп рд░рд┐рдХреЙрд░реНрдб рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред <br>  рдЗрд╕ рд╡рд┐рдзрд┐ рдХреЛ <code>x64</code> рдореЛрдб рдореЗрдВ <code>netframework4.8</code> рдкрд░ рдЪрд▓рд╛рдПрдБред  рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рд╣реЛрддрд╛ рд╣реИ: </p><br><pre> <code class="plaintext hljs">LEGACY [ 999, 123, 11, -100 ] [ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ] 0x|00|00|02|8C|00|00|2F|B0 999 Span&lt;int&gt; [0] 0x|00|00|02|8C|00|00|2F|B0 999 Span&lt;byte&gt;[0] 0x|00|00|02|8C|00|00|2F|B8 11 Span&lt;int&gt; [0] offset by size_t 0x|00|00|02|8C|00|00|2F|B8 11 Span&lt;byte&gt;[0] offset by size_t 0x|00|00|02|8C|00|00|2B|18 999 Span&lt;int&gt; [0] after GC 0x|00|00|02|8C|00|00|2F|B0 6750318 Span&lt;byte&gt;[0] after GC [ 999, 123, 11, -100 ] [ 110, 0, 103, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ]</code> </pre> <br><p>  рдкреНрд░рд╛рд░рдВрдн рдореЗрдВ, рджреЛрдиреЛрдВ рд╕реНрдкреИрди (рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЗ рдмрд╛рд╡рдЬреВрдж) рд╕рдорд╛рди рд░реВрдк рд╕реЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ <code>Span&lt;byte&gt;</code> , рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдореВрд▓ рд╕рд░рдгреА рдХреЗ рдмрд╛рдЗрдЯ-рд╡реНрдпреВ рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддрд╛ рд╣реИред  рдЖрдкрдХреЛ рдХреНрдпрд╛ рдЪрд╛рд╣рд┐рдП <br>  рдареАрдХ рд╣реИ, рдЪрд▓реЛ рд╕реНрдкреИрди рдХреА рд╢реБрд░реБрдЖрдд рдХреЛ рдПрдХ <code>IntPtr</code> (рдпрд╛ <code>x64</code> рдкрд░ <code>2 X int</code> ) рдХреЗ рдЖрдХрд╛рд░ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ рдФрд░ рдкрдврд╝реЗрдВред  рд╣рдореЗрдВ рд╕рд░рдгреА рдХрд╛ рддреАрд╕рд░рд╛ рддрддреНрд╡ рдФрд░ рд╕рд╣реА рдкрддрд╛ рдорд┐рд▓рддрд╛ рд╣реИред  рдФрд░ рдлрд┐рд░ рд╣рдо рдХрдЪрд░рд╛ рдЗрдХрдЯреНрдард╛ рдХрд░реЗрдВрдЧреЗ ... </p><br><pre> <code class="plaintext hljs">GC.Collect(0, GCCollectionMode.Forced, true, true);</code> </pre> <br><p>  рдЗрд╕ рд╡рд┐рдзрд┐ рдореЗрдВ рдЕрдВрддрд┐рдо рдзреНрд╡рдЬ <code>GC</code> рдвреЗрд░ <code>GC</code> рдХреЙрдореНрдкреИрдХреНрдЯ <code>GC</code> рдХрд╣рддрд╛ рд╣реИред  <code>GC.Collect</code> рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж <code>GC.Collect</code> <code>GC</code> рдореВрд▓ рд╕реНрдерд╛рдиреАрдп рд╕рд░рдгреА рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред  <code>Span&lt;int&gt;</code> рдЗрди рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдорд╛рд░рд╛ <code>Span&lt;byte&gt;</code> рдкреБрд░рд╛рдиреЗ рдкрддреЗ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдЕрдм рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╣реИред  рдПрдХ рдмрд╛рд░ рдореЗрдВ рдЕрдкрдиреЗ рдЖрдк рдХреЛ рдЕрдкрдиреЗ рд╕рднреА рдШреБрдЯрдиреЛрдВ рдХреЛ рд╢реВрдЯ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рд╢рд╛рдирджрд╛рд░ рддрд░реАрдХрд╛! </p><br><p>  рдЕрдм рд╣рдо <code>netcore3.0.100-preview8</code> рдкрд░ рдХреЙрд▓ рдХрд┐рдП рдЧрдП рд╕рдЯреАрдХ рд╕рдорд╛рди рдХреЛрдб рдЯреБрдХрдбрд╝реЗ рдХреЗ рдкрд░рд┐рдгрд╛рдо рдХреЛ <code>netcore3.0.100-preview8</code> ред </p><br><pre> <code class="plaintext hljs">CORE [ 999, 123, 11, -100 ] [ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ] 0x|00|00|01|F2|8F|BD|C6|90 999 Span&lt;int&gt; [0] 0x|00|00|01|F2|8F|BD|C6|90 999 Span&lt;byte&gt;[0] 0x|00|00|01|F2|8F|BD|C6|98 11 Span&lt;int&gt; [0] offset by size_t 0x|00|00|01|F2|8F|BD|C6|98 11 Span&lt;byte&gt;[0] offset by size_t 0x|00|00|01|F2|8F|BD|BF|38 999 Span&lt;int&gt; [0] after GC 0x|00|00|01|F2|8F|BD|BF|38 999 Span&lt;byte&gt;[0] after GC [ 999, 123, 11, -100 ] [ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ]</code> </pre> <br><p>  рд╕рдм рдХреБрдЫ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рддрдХ тАЛтАЛрдореИрдВ рджреЗрдЦ рд╕рдХрддрд╛ рд╣реВрдВред  рд╕рдВрдШрдирди рдХреЗ рдмрд╛рдж, рджреЛрдиреЛрдВ рд╢реБрдХреНрд░рд╛рдгреБ рдЕрдкрдиреЗ рд╕реВрдЪрдХ рдХреЛ рдмрджрд▓рддреЗ рд╣реИрдВред  рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛!  рд▓реЗрдХрд┐рди рдЕрдм рдЗрд╕реЗ рдПрдХ рд╡рд┐рд░рд╛рд╕рдд рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рдХреИрд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛ рдЬрд╛рдП? </p><br><h1 id="jit-intrinsic">  рдЬрд┐рдд рдЖрдВрддрд░рд┐рдХ </h1><br><p>  рдореИрдВ рдмрд┐рд▓реНрдХреБрд▓ рднреВрд▓ рдЧрдпрд╛ рдХрд┐ рд╕реНрдкреИрди рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдерди рдХреЛ <a href="">рдЖрдВрддрд░рд┐рдХ рд░реВрдк</a> рд╕реЗ <code>netcore</code> рдореЗрдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ <a href="">рд╣реИ</a> ред  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, <code>netcore</code> рдПрдХ рд╕рд░рдгреА рдХреЗ рдЯреБрдХрдбрд╝реЗ рддрдХ рднреА рдЖрдВрддрд░рд┐рдХ рдкреЙрдЗрдВрдЯрд░реНрд╕ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ <code>GC</code> рд▓реЗ рдЬрд╛рдиреЗ рдкрд░ рд▓рд┐рдВрдХ рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред  <code>netframework</code> , <code>netframework</code> рдХрд╛ <code>nuget</code> рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдПрдХ рдмреИрд╕рд╛рдЦреА рд╣реИред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рджреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╕реНрдкреИрди рд╣реИрдВ: рдПрдХ рдПрд░реЗ рд╕реЗ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХреЗ рд▓рд┐рдВрдХ рдХреЛ рдЯреНрд░реИрдХ рдХрд░рддрд╛ рд╣реИ, рджреВрд╕рд░рд╛ рдкреЙрдЗрдВрдЯрд░ рд╕реЗ рдФрд░ рдЗрд╕рдХрд╛ рдХреЛрдИ рдЕрдВрджрд╛рдЬрд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдпрд╣ рдХрд┐рд╕ рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИред  рдореВрд▓ рд╕рд░рдгреА рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╕реНрдкреИрди рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдирд╛ рдЬрд╛рд░реА рд░рд╣рддрд╛ рд╣реИ рдХрд┐ рдкреЙрдЗрдВрдЯрд░ рдЕрдкрдиреЗ рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдореЗрдВ рдХрд╣рд╛рдВ рд╕реЗ рдЧреБрдЬрд░рд╛ рд╣реИред  рддреБрд▓рдирд╛ рдХреЗ рд▓рд┐рдП, рдпрд╣ <code>netcore</code> рдореЗрдВ рдЕрд╡рдзрд┐ рдХрд╛ рдПрдХ <em>рдЙрджрд╛рд╣рд░рдг</em> рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╣реИ: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Span&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ByReference&lt;T&gt; _pointer; <span class="hljs-comment"><span class="hljs-comment">//  -   private readonly int _length; }</span></span></code> </pre> <br><p>  рдФрд░ <code>netframework</code> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Span&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Pinnable&lt;T&gt; _pinnable; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IntPtr _byteOffset; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _length; }</code> </pre> <br><p>  <code>_pinnable</code> рдореЗрдВ рд╕рд░рдгреА рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдВрджрд░реНрдн рд╣реЛрддрд╛ рд╣реИ, рдпрджрд┐ рдХрд┐рд╕реА рдХреЛ рдирд┐рд░реНрдорд╛рдгрдХрд░реНрддрд╛ рдХреЛ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, <code>_byteOffset</code> рдореЗрдВ рдПрдХ рдмрджрд▓рд╛рд╡ рд╣реЛрддрд╛ рд╣реИ (рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдкреВрд░реЗ рд╕рд░рдгреА рдореЗрдВ рдХреБрдЫ рдЧреИрд░-рд╢реВрдиреНрдп рдкрд╛рд░реА рд╣реИ рдЬрд┐рд╕ рддрд░рд╣ рд╕реЗ рд╕рд░рдгреА рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ рджрд░реНрд╢рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, <em>рд╢рд╛рдпрдж</em> )ред  рдпрджрд┐ рдЖрдк рдирд┐рд░реНрдорд╛рддрд╛ рдХреЛ <code>void*</code> рдкреЙрдЗрдВрдЯрд░ рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдХреЗрд╡рд▓ рдПрдХ рдирд┐рд░рдкреЗрдХреНрд╖ <code>_byteOffset</code> рдкрд░рд┐рд╡рд░реНрддрд┐рдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред  рд╕реНрдкреИрди рдХреЛ рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рддрдВрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рд╕рднреА рдЙрджрд╛рд╣рд░рдг рд╡рд┐рдзрд┐рдпрд╛рдБ рд╢рд░реНрддреЛрдВ рдХреЗ рд╕рд╛рде рд▓рд╛рдЬрд┐рдореА рд╣реИрдВ рдЬреИрд╕реЗ <code>if(_pinnable is null) {/*    */} else {/*    _pinnable */}</code> ред  рдРрд╕реА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдХреНрдпрд╛ рдХрд░реЗрдВ? </p><br><h1 id="kak-delat-ne-stoit-no-ya-vse-zhe-sdelal">  рдпрд╣ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ рдпрд╣ рдЗрд╕рдХреЗ рд▓рд╛рдпрдХ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рдЕрднреА рднреА рдХрд┐рдпрд╛ рд╣реИ </h1><br><p>  рдпрд╣ рдЦрдВрдб <code>netframework</code> рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рд╡рд┐рднрд┐рдиреНрди рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрдиреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдкрд┐рдд рд╣реИ, рдЬреЛ <code>Span&lt;T&gt; -&gt; Span&lt;U&gt;</code> рдХреЛ рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рд▓рд┐рдВрдХ рд░рдЦрддреЗ рд╣реБрдП <code>netframework</code> рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред <br>  <strong>рдореИрдВ рдЖрдкрдХреЛ рдЪреЗрддрд╛рд╡рдиреА рджреЗрддрд╛ рд╣реВрдВ: рдпрд╣ рд╕рдВрднрд╡рддрдГ рдореМрд▓рд┐рдХ рддреНрд░реБрдЯрд┐рдпреЛрдВ рдФрд░ рдЕрдВрдд рдореЗрдВ рдПрдХ рдЕрдкрд░рд┐рднрд╛рд╖рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЗ рд╕рд╛рде рдЕрд╕рд╛рдорд╛рдиреНрдп рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдХрд╛ рдПрдХ рдХреНрд╖реЗрддреНрд░ рд╣реИ</strong> </p><br><h2 id="metod-1-naivnyy">  рд╡рд┐рдзрд┐ 1: Naive </h2><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЙрджрд╛рд╣рд░рдг рд╕реЗ рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ, рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХрд╛ рд░реВрдкрд╛рдВрддрд░рдг <code>netframework</code> рдкрд░ рд╡рд╛рдВрдЫрд┐рдд рдкрд░рд┐рдгрд╛рдо рдирд╣реАрдВ рджреЗрдЧрд╛ред  рд╣рдореЗрдВ <code>_pinnable</code> value рдЪрд╛рд╣рд┐рдПред  рдареАрдХ рд╣реИ, рд╣рдо рдирд┐рдЬреА рдХреНрд╖реЗрддреНрд░реЛрдВ (рдмрд╣реБрдд рдмреБрд░рд╛ рдФрд░ рд╣рдореЗрд╢рд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ) рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рдХрд░ рдкреНрд░рддрд┐рдмрд┐рдВрдм рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░реЗрдВрдЧреЗ, рд╣рдо рдЗрд╕реЗ рдПрдХ рдирдИ рд╕реНрдкреИрди рдореЗрдВ рд▓рд┐рдЦреЗрдВрдЧреЗ, рд╣рдо рдЦреБрд╢ рд╣реЛрдВрдЧреЗред  рдХреЗрд╡рд▓ рдПрдХ <em>рдЫреЛрдЯреА рд╕реА</em> рд╕рдорд╕реНрдпрд╛ рд╣реИ: рд╕реНрдкреИрди рдПрдХ <code>ref struct</code> , рдпрд╣ рди рддреЛ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рддрд░реНрдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рди рд╣реА рдЗрд╕реЗ рдХрд┐рд╕реА <code>object</code> рдореЗрдВ рдкреИрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдкреНрд░рддрд┐рдмрд┐рдВрдм рдХреЗ рдорд╛рдирдХ рддрд░реАрдХреЛрдВ рдХреЛ рд╕реНрдкреИрди рдХреЛ рд╕рдВрджрд░реНрдн рдкреНрд░рдХрд╛рд░ рдореЗрдВ рдзрдХреЗрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдпрд╛ рджреВрд╕рд░реЗ рддрд░реАрдХреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред  рдореБрдЭреЗ рдПрдХ рд╕рд░рд▓ рддрд░реАрдХрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ (рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдирд┐рдЬреА рдХреНрд╖реЗрддреНрд░реЛрдВ рдкрд░ рдкреНрд░рддрд┐рдмрд┐рдВрдм рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рддреЗ рд╣реБрдП)ред </p><br><h2 id="metod-2-we-need-to-go-deeper">  рд╡рд┐рдзрд┐ 2: рд╣рдореЗрдВ рдЧрд╣рд░рд╛рдИ рддрдХ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ </h2><br><p>  рдореЗрд░реЗ ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">[1]</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">[реи]</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">[рей]</a> ) рд╕реЗ рдкрд╣рд▓реЗ рд╣реА рд╕рдм рдХреБрдЫ рд╣реЛ рдЪреБрдХрд╛ рд╣реИред  рд╕реНрдкреЗрди рдПрдХ рд╕рдВрд░рдЪрдирд╛ рд╣реИ, <code>T</code> рдкрд░рд╡рд╛рд╣ рдХрд┐рдП рдмрд┐рдирд╛ <code>T</code> рддреАрди рдлрд╝реАрд▓реНрдб рдореЗрдореЛрд░реА рдХреА рд╕рдорд╛рди рдорд╛рддреНрд░рд╛ ( <em>рд╕рдорд╛рди рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдкрд░</em> ) <em>рдкрд░</em> рдХрдмреНрдЬрд╛ рдХрд░ рд▓реЗрддреЗ рд╣реИрдВред  рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдЕрдЧрд░ <code>[FieldOffset(0)]</code> ?  рдЬрд▓реНрджреА рд╕реЗ рдирд╣реАрдВ рдХрд╣рд╛ред </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Exchange&lt;T, U&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> U : unmanaged { [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;T&gt; Span_1; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;U&gt; Span_2; }</code> </pre> <br><p>  рд▓реЗрдХрд┐рди рдЬрдм рдЖрдк рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ (рдпрд╛ рдмрд▓реНрдХрд┐, рдЬрдм рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ), рддреЛ <code>TypeLoadException</code> рдорд┐рд▓рддреА <code>TypeLoadException</code> - рдПрдХ рдЬреЗрдиреЗрд░рд┐рдХ <code>LayoutKind.Explicit</code> рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред <code>LayoutKind.Explicit</code> ред  рдареАрдХ рд╣реИ, рдХреЛрдИ рдмрд╛рдд рдирд╣реАрдВ, рдЪрд▓реЛ рдореБрд╢реНрдХрд┐рд▓ рд░рд╛рд╕реНрддреЗ рдкрд░ рдЪрд▓рддреЗ рд╣реИрдВ: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Exchange { [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; ByteSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">sbyte</span></span>&gt; SByteSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt; UShortSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>&gt; ShortSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>&gt; UIntSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; IntSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>&gt; ULongSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; LongSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt; FloatSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt; DoubleSpan; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; CharSpan; }</code> </pre> <br><p>  рдЕрдм рдЖрдк рдпрд╣ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Span&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">As2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; span</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exchange = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exchange() { IntSpan = span }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exchange.ByteSpan; }</code> </pre> <br><p>  рд╡рд┐рдзрд┐ рдХреЗрд╡рд▓ рдПрдХ рд╕рдорд╕реНрдпрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреА рд╣реИ - <code>_length</code> рдХреНрд╖реЗрддреНрд░ <code>_length</code> рдирдХрд▓ рдХреА рдЬрд╛рддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЬрдм <code>int</code> -&gt; <code>byte</code> рдХрд╛рд╕реНрдЯрд┐рдВрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдмрд╛рдЗрдЯ рд╕реНрдкреИрди рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рд░рдгреА рд╕реЗ 4 рдЧреБрдирд╛ рдЫреЛрдЯрд╛ рд╣реЛрддрд╛ рд╣реИред <br>  рдХреЛрдИ рд╕рдорд╕реНрдпрд╛ рдирд╣реАрдВ: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Raw { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Pinnable; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IntPtr Pointer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Length; } [StructLayout(LayoutKind.Explicit)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Exchange { <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Raw RawView; }</code> </pre> <br><p>  рдЕрдм <code>RawView</code> рдорд╛рдзреНрдпрдо рд╕реЗ рдЖрдк рдкреНрд░рддреНрдпреЗрдХ рд╡реНрдпрдХреНрддрд┐рдЧрдд рд╕реНрдкреИрди рдлрд╝реАрд▓реНрдб рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВред </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Span&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">As2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; span</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exchange = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exchange() { IntSpan = span }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exchange2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exchange() { RawView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Raw() { Pinnable = exchange.RawView.Pinnable, Pointer = exchange.RawView.Pointer, Length = exchange.RawView.Length * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exchange2.ByteSpan; }</code> </pre> <br><p>  рдФрд░ рдпрд╣ <strong>рд╡реИрд╕реЗ</strong> рд╣реА рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, <strong>рдЬреИрд╕реЗ рдХрд┐</strong> рдЕрдЧрд░ рдЖрдк рдЧрдВрджреЗ рдЪрд╛рд▓реЛрдВ рдХреЗ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХреЛ рдирдЬрд░рдЕрдВрджрд╛рдЬ рдХрд░рддреЗ рд╣реИрдВред  рдорд╛рдЗрдирд╕ - рдХрдирд╡рд░реНрдЯрд░ рдХрд╛ рд╕рд╛рдорд╛рдиреНрдп рд╕рдВрд╕реНрдХрд░рдг рдирд╣реАрдВ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЖрдкрдХреЛ рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдкреНрд░рдХрд╛рд░реЛрдВ рд╕реЗ рд╕рдВрддреЛрд╖ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред </p><br><h2 id="metod-3-bezumnyy">  рд╡рд┐рдзрд┐ 3: рдкрд╛рдЧрд▓ </h2><br><p>  рдХрд┐рд╕реА рднреА рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдХреА рддрд░рд╣, рдореБрдЭреЗ рдЪреАрдЬреЛрдВ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдирд╛ рдкрд╕рдВрдж рд╣реИред  рдХрд┐рд╕реА рднреА рдкреНрд░рдХрд╛рд░ рдХреЗ <code>unmanaged</code> рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдХрдиреНрд╡рд░реНрдЯрд░реНрд╕ рд▓рд┐рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдиреЗ рдореБрдЭреЗ рдЦреБрд╢ рдирд╣реАрдВ рдХрд┐рдпрд╛ред  рдХреНрдпрд╛ рд╕рдорд╛рдзрд╛рди рдкреЗрд╢ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ?  рдпрд╣ рд╕рд╣реА рд╣реИ, <em>рдЖрдкрдХреЗ рд▓рд┐рдП</em> рдХреЛрдб рд▓рд┐рдЦрдиреЗ рдХреЗ <em>рд▓рд┐рдП</em> <code>CLR</code> рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред </p><br><p>  рдЗрд╕реЗ рдХреИрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдП?  рдЕрд▓рдЧ-рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╣реИрдВ, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓реЗрдЦ рд╣реИрдВ</a> ред  рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддреА рд╣реИ: <br>  рдПрдХ рдмрд┐рд▓реНрдб рдмрд┐рд▓реНрдбрд░ рдмрдирд╛рдПрдВ -&gt; рдПрдХ рдореЙрдбреНрдпреВрд▓ рдмрд┐рд▓реНрдбрд░ рдмрдирд╛рдПрдВ -&gt; рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд░реЗрдВ -&gt; {рдлреАрд▓реНрдбреНрд╕, рдореЗрдердбреНрд╕, рдЖрджрд┐} -&gt; рдЖрдЙрдЯрдкреБрдЯ рдкрд░ рд╣рдореЗрдВ <code>Type</code> рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдорд┐рд▓рддрд╛ рд╣реИред <br>  рдпрд╣ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдкреНрд░рдХрд╛рд░ рдХреНрдпрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдпрд╣ рдПрдХ <code>ref struct</code> ), рд╣рдо <code>ildasm</code> рдкреНрд░рдХрд╛рд░ рдХреЗ рдХрд┐рд╕реА рднреА рдЙрдкрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред  рдореЗрд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ <strong>рдбреЙрдЯрдкреЗрдХ</strong> рдерд╛ред <br>  рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдмрд┐рд▓реНрдбрд░ рдмрдирд╛рдирд╛ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeBuilder = _mBuilder.DefineType(<span class="hljs-string"><span class="hljs-string">$"Generated_</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-string"><span class="hljs-subst">(T).Name}</span></span></span><span class="hljs-string">"</span></span>, TypeAttributes.Public | TypeAttributes.Sealed | TypeAttributes.ExplicitLayout <span class="hljs-comment"><span class="hljs-comment">// &lt;-    | TypeAttributes.AnsiClass | TypeAttributes.BeforeFieldInit, typeof(ValueType));</span></span></code> </pre> <br><p>  рдЕрдм рдЦреЗрддред  рдЪреВрдБрдХрд┐ рд╣рдо <code>Span&lt;T&gt;</code> рдХреЛ <code>Span&lt;U&gt;</code> рд╕реАрдзреЗ рдХреЙрдкреА рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рд▓рдВрдмрд╛рдИ рдореЗрдВ рдЕрдВрддрд░ рдХреЗ рдХрд╛рд░рдг, рд╣рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдХрд╛рд╕реНрдЯ рдХреЗ рджреЛ рдкреНрд░рдХрд╛рд░ рдмрдирд╛рдиреЗ рд╣реЛрдВрдЧреЗ </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Generated_Int32 { [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Span&lt;Int32&gt; Span; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Raw Raw; }</code> </pre> <br><p>  рдпрд╣рд╛рдВ <code>Raw</code> рд╣рдо рдЕрдкрдиреЗ рд╣рд╛рдереЛрдВ рд╕реЗ рдШреЛрд╖рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  <code>IsByRefLikeAttribute</code> рдмрд╛рд░реЗ рдореЗрдВ рдордд рднреВрд▓рдирд╛ред  рдЦреЗрддреЛрдВ рдХреЗ рд╕рд╛рде, рд╕рдм рдХреБрдЫ рд╕рд░рд▓ рд╣реИ: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spanField = typeBuilder.DefineField(<span class="hljs-string"><span class="hljs-string">"Span"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Span&lt;T&gt;), FieldAttributes.Private); spanField.SetOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rawField = typeBuilder.DefineField(<span class="hljs-string"><span class="hljs-string">"Raw"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Raw), FieldAttributes.Private); rawField.SetOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><p>  рдмрд╕ рдЗрддрдирд╛ рд╣реА, рд╕рдмрд╕реЗ рд╕рд░рд▓ рдкреНрд░рдХрд╛рд░ рддреИрдпрд╛рд░ рд╣реИред  рдЕрдм рдЕрд╕реЗрдВрдмрд▓реА рдореЙрдбреНрдпреВрд▓ рдХреЛ рдХреИрд╢ рдХрд░реЗрдВред  рдХрд╕реНрдЯрдо рдкреНрд░рдХрд╛рд░ рдХреИрд╢реНрдб рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╢рдмреНрджрдХреЛрд╢ рдореЗрдВ ( <code>T -&gt; Generated_{nameof(T)}</code> )ред  рд╣рдо рдПрдХ рд░реИрдкрд░ рдмрдирд╛рддреЗ рд╣реИрдВ рдЬреЛ рджреЛ рдкреНрд░рдХрд╛рд░ рдХреЗ <code>TIn</code> рдФрд░ <code>TOut</code> рдЕрдиреБрд╕рд╛рд░ рджреЛ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╕рд╣рд╛рдпрдХ рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рд╕реНрдкреИрди рдкрд░ рдЖрд╡рд╢реНрдпрдХ рд╕рдВрдЪрд╛рд▓рди рдХрд░рддрд╛ рд╣реИред  рдПрдХ рд╣реИ рд▓реЗрдХрд┐рди  рдкреНрд░рддрд┐рдмрд┐рдВрдм рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╕реНрдкреИрди (рдпрд╛ рдЕрдиреНрдп <code>ref struct</code> ) рдкрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд▓рдЧрднрдЧ рдЕрд╕рдВрднрд╡ рд╣реИред  <em>рдпрд╛ рдореБрдЭреЗ рдХреЛрдИ рд╕рд░рд▓ рдЙрдкрд╛рдп рдирд╣реАрдВ рдорд┐рд▓рд╛</em> ред  рдХреИрд╕реЗ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ? </p><br><h2 id="delegates-to-the-rescue">  рдмрдЪрд╛рд╡ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдирд┐рдзрд┐ </h2><br><p>  рдкрд░рд╛рд╡рд░реНрддрди рд╡рд┐рдзрд┐ рдЖрдорддреМрд░ рдкрд░ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддреА рд╣реИ: </p><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodInfo mi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] otherArgs</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><p>  рд╡реЗ рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдирд╣реАрдВ рд░рдЦрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдмреЙрдХреНрд╕рд┐рдВрдЧ (= рдкреИрдХреЗрдЬрд┐рдВрдЧ) рдЖрдкрдХреЛ рд╕реНрд╡реАрдХрд╛рд░реНрдп рд╣реИ, рддреЛ рдХреЛрдИ рд╕рдорд╕реНрдпрд╛ рдирд╣реАрдВ рд╣реИред <br>  рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, <code>@this</code> рдФрд░ <code>otherArgs</code> рдореЗрдВ рдПрдХ <code>ref struct</code> рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬреЛ рдореБрдЭреЗ рдирд╣реАрдВ рдорд┐рд▓ рд╕рдХрд╛ред <br>  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рд╕рд░рд▓ рддрд░реАрдХрд╛ рд╣реИред  рдЖрдЗрдП рдХрд▓реНрдкрдирд╛ рдХрд░реЗрдВ рдХрд┐ рдПрдХ рдкреНрд░рдХрд╛рд░ рдореЗрдВ рдЧреЗрдЯреНрдЯрд░ рдФрд░ рд╕реЗрдЯрд░ рд╡рд┐рдзрд┐рдпрд╛рдВ рд╣реИрдВ (рдЧреБрдг рдирд╣реАрдВ, рд▓реЗрдХрд┐рди рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд╕рд░рд▓ рддрд░реАрдХреЗ рдмрдирд╛рдП рдЧрдП рд╣реИрдВ)ред <br>  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Generated_Int32.SetSpan(Span&lt;Int32&gt; span) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Span = span;</code> </pre> <br><p>  рд╡рд┐рдзрд┐ рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╣рдо рдПрдХ рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдкреНрд░рдХрд╛рд░ (рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдХреЛрдб рдореЗрдВ) рдХреА рдШреЛрд╖рдгрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SpanSetterDelegate&lt;T&gt;(Span&lt;T&gt; span) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged;</code> </pre> <br><p>  рд╣рдореЗрдВ рдРрд╕рд╛ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдорд╛рдирдХ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХреЗ рд▓рд┐рдП рдПрдХ <code>Action&lt;Span&lt;T&gt;&gt;</code> рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рд▓реЗрдХрд┐рди рд╕реНрдкреИрди рдХреЛ рдЬреЗрдиреЗрд░рд┐рдХ рддрд░реНрдХреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  <code>SpanSetterDelegate</code> , рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдмрд┐рд▓реНрдХреБрд▓ рд╡реИрдз рдкреНрд░рддрд┐рдирд┐рдзрд┐ рд╣реИред <br>  рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рддрд┐рдирд┐рдзрд┐рдпреЛрдВ рдХреЛ рдмрдирд╛рдПрдБред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдорд╛рдирдХ рдЬреЛрдбрд╝рддреЛрдбрд╝ рдХрд░реЗрдВ: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mi = type.GetMethod(<span class="hljs-string"><span class="hljs-string">"Method_Name"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ,    public &amp; instance var spanSetter = (SpanSetterDelegate&lt;T&gt;) mi.CreateDelegate(typeof(SpanSetterDelegate&lt;T&gt;), @this);</span></span></code> </pre> <br><p>  рдЕрдм <code>spanSetter</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <code>spanSetter(Span&lt;T&gt;.Empty);</code>  ред  <code>@this</code> <sup>2 рдХреЗ рд░реВрдк рдореЗрдВ</sup> , рдпрд╣ рд╣рдорд╛рд░реЗ рдЧрддрд┐рд╢реАрд▓ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, <code>Activator.CreateInstance(type)</code> рдорд╛рдзреНрдпрдо рд╕реЗ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред <code>@this</code> <code>Activator.CreateInstance(type)</code> , рдХреНрдпреЛрдВрдХрд┐ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рдХреЛрдИ рддрд░реНрдХ рдХреЗ рд╕рд╛рде рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд┐рд░реНрдорд╛рддрд╛ рд╣реИред </p><br><p>  рддреЛ, рдЕрдВрддрд┐рдо рд╕реАрдорд╛ - рд╣рдореЗрдВ рд╡рд┐рдзрд┐рдкреВрд░реНрд╡рдХ рд╡рд┐рдзрд┐рдпрд╛рдБ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p>  <sup>2</sup> рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣рд╛рдВ рдХреБрдЫ рдЧрд▓рдд рд╣реЛ рд░рд╣рд╛ рд╣реИ - <code>Activator.CreateInstance()</code> рдПрдХ <code>ref struct</code> рдЙрджрд╛рд╣рд░рдг <code>Activator.CreateInstance()</code> рдкреИрдХ рдХрд░ рд░рд╣рд╛ рд╣реИред  рдЕрдЧрд▓реЗ рднрд╛рдЧ рдХрд╛ рдЕрдВрдд рджреЗрдЦреЗрдВ </p><br><h2 id="znakomtes-reflectionemit">  <code>Reflection.Emit</code> рдорд┐рд▓реЛ </h2><br><p>  рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ <code>Expression</code> рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд┐рдзрд┐рдпреЛрдВ рдХрд╛ рдЙрддреНрдкрд╛рджрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐  рд╣рдорд╛рд░реЗ рддреБрдЪреНрдЫ рдкрд╛рдиреЗ рд╡рд╛рд▓реЛрдВ рдХреЗ рд╢рд░реАрд░ / рд╡рд╛рд╕рд┐рдпреЛрдВ рдХрд╛ рд╢рд╛рдмреНрджрд┐рдХ рд░реВрдк рд╕реЗ рдПрдХ-рджреЛ рднрд╛рд╡ рд╣реИрдВред  рдореИрдВрдиреЗ рдПрдХ рдЕрд▓рдЧ, рдЕрдзрд┐рдХ рдкреНрд░рддреНрдпрдХреНрд╖ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдЪреБрдирд╛ред </p><br><p>  рдпрджрд┐ рдЖрдк рдПрдХ рддреБрдЪреНрдЫ рдкрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреЗ <strong>IL-</strong> рдХреЛрдб рдХреЛ рджреЗрдЦрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдХреБрдЫ рдРрд╕рд╛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ ( <code>Debug</code> , <code>X86</code> , <code>netframework4.8</code> ) </p><br><pre> <code class="plaintext hljs">nop ldarg.0 ldfld /* - */ stloc.0 br.s /*  */ ldloc.0 ret</code> </pre> <br><p>  рд░реЛрдХрдиреЗ рдФрд░ рдбреАрдмрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╕реНрдерд╛рди рд╣реИрдВред <br>  рд░рд┐рд▓реАрдЬрд╝ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ, рдХреЗрд╡рд▓ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЕрд╡рд╢реЗрд╖: </p><br><pre> <code class="plaintext hljs">ldarg.0 ldfld /* - */ ret</code> </pre> <br><p>  рдЙрджрд╛рд╣рд░рдг рд╡рд┐рдзрд┐ рдХрд╛ рдЕрд╢рдХреНрдд рддрд░реНрдХ рд╣реИ ... <code>this</code> ред  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд <strong>IL</strong> рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ: <br>  1) рдЗрд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб <code>this</code> <br>  2) рдлрд╝реАрд▓реНрдб рдорд╛рди рд▓реЛрдб рдХрд░реЗрдВ <br>  3) рдЗрд╕реЗ рд╡рд╛рдкрд╕ рд▓рд╛рдУ </p><br><p>  рдмрд╕ рд╣реБрд╣?  <code>Reflection.Emit</code> рдореЗрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдЕрдзрд┐рднрд╛рд░ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ op рдХреЛрдб рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдПрдХ рдлреАрд▓реНрдб рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдкреИрд░рд╛рдореАрдЯрд░ рднреА рд╣реЛрддрд╛ рд╣реИред  рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рдкрд╣рд▓реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдерд╛, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП <code>spanField</code> ред </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getSpan = type.DefineMethod(<span class="hljs-string"><span class="hljs-string">"GetSpan"</span></span>, MethodAttributes.Public | MethodAttributes.HideBySig, CallingConventions.Standard, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Span&lt;T&gt;), Array.Empty&lt;Type&gt;()); gen = getSpan.GetILGenerator(); gen.Emit(OpCodes.Ldarg_0); gen.Emit(OpCodes.Ldfld, spanField); gen.Emit(OpCodes.Ret);</code> </pre> <br><p>  рд╕реЗрдЯрд░ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдереЛрдбрд╝рд╛ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИ, рдЖрдкрдХреЛ рдЗрд╕реЗ рд╕реНрдЯреИрдХ рдкрд░ рд▓реЛрдб рдХрд░рдиреЗ, рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдлрд┐рд░ рдлрд╝реАрд▓реНрдб рдореЗрдВ рд▓реЗрдЦрди рдирд┐рд░реНрджреЗрд╢ рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВ рдФрд░ рдХреБрдЫ рднреА рд╡рд╛рдкрд╕ рди рдХрд░реЗрдВ: </p><br><pre> <code class="cs hljs">ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> stfld <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ret</code> </pre> <br><p>  <code>Raw</code> рдХреНрд╖реЗрддреНрд░ рдХреЗ рд▓рд┐рдП рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рддрд┐рдирд┐рдзрд┐рдпреЛрдВ (рдпрд╛ рдорд╛рдирдХ рд▓реЛрдЧреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ) рдХреА рдШреЛрд╖рдгрд╛ рдХрд░рддреЗ рд╣реБрдП, рд╣рдореЗрдВ рдПрдХ рдЧрддрд┐рд╢реАрд▓ рдкреНрд░рдХрд╛рд░ рдФрд░ рдЪрд╛рд░ рдПрдХреНрд╕реЗрд╕рд░ рд╡рд┐рдзрд┐рдпрд╛рдВ рдорд┐рд▓рддреА рд╣реИрдВ, рдЬрд┐рдирд╕реЗ рд╕рд╣реА рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдЙрддреНрдкрдиреНрди рд╣реЛрддреЗ рд╣реИрдВред </p><br><p>  рд╣рдо рдПрдХ рд░реИрдкрд░ рдХреНрд▓рд╛рд╕ рд▓рд┐рдЦрддреЗ рд╣реИрдВ рдЬреЛ рджреЛ рдЬреЗрдиреЗрд░рд┐рдХ рдорд╛рдкрджрдВрдбреЛрдВ ( <code>TIn</code> , <code>TOut</code> ) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП <code>Type</code> рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╕рдВрдмрдВрдзрд┐рдд (рдХреИрд╢реНрдб) рдбрд╛рдпрдирд╛рдорд┐рдХ рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рдпрд╣ рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХрд╛рд░ рдХреА рдПрдХ рд╡рд╕реНрддреБ рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рдЪрд╛рд░ рдЬреЗрдиреЗрд░рд┐рдХ рдкреНрд░рддрд┐рдирд┐рдзрд┐рдпреЛрдВ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ, рдЕрд░реНрдерд╛рддреН </p><br><ol><li>  <code>void SetSpan(Span&lt;TIn&gt; span)</code> рд╕рдВрд░рдЪрдирд╛ рдХреЛ рд╕реНрд░реЛрдд рд╕реНрдкреИрди рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП </li><li>  <code>Raw GetRaw()</code> рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рд╕реНрдкреИрди рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП <code>Raw GetRaw()</code> </li><li>  <code>void SetRaw(Raw raw)</code> рд╕рдВрд╢реЛрдзрд┐рдд <code>Raw</code> рд╕рдВрд░рдЪрдирд╛ рдХреЛ рджреВрд╕рд░реА рд╡рд╕реНрддреБ рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП </li><li>  <code>Span&lt;TOut&gt; GetSpan()</code> рд╡рд╛рдВрдЫрд┐рдд рдкреНрд░рдХрд╛рд░ рдХреЗ рд╕реНрдкреИрди рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рд╕реЗрдЯ рдФрд░ рдкреБрдирд░реНрдЧрдард┐рдд рдлрд╝реАрд▓реНрдб рдХреЗ рд╕рд╛рде рд╡рд╛рдкрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред </li></ol><br><p>  рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ, рдЧрддрд┐рд╢реАрд▓ рдкреНрд░рдХрд╛рд░ рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЛ рдПрдХ рдмрд╛рд░ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред  рдПрдХ рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдмрдирд╛рддреЗ рд╕рдордп, рдЗрди рд╡рд╕реНрддреБрдУрдВ рдХрд╛ рдПрдХ рд╕рдВрджрд░реНрдн <code>@this</code> рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  <strong>рдпрд╣рд╛рдВ рдирд┐рдпрдореЛрдВ рдХрд╛ рдЙрд▓реНрд▓рдВрдШрди рд╣реИред</strong>  <strong><code>Activator.CreateInstance</code> рд░рд┐рдЯрд░реНрди <code>object</code> ред</strong>  <strong>рдЬрд╛рд╣рд┐рд░рд╛ рддреМрд░ рдкрд░ рдпрд╣ рдЗрд╕ рддрдереНрдп рдХреЗ рдХрд╛рд░рдг рд╣реИ рдХрд┐ рдЧрддрд┐рд╢реАрд▓ рдкреНрд░рдХрд╛рд░ рдиреЗ рдЦреБрдж рдХреЛ</strong> <code>type.IsByRef</code> <s>рдЬреИрд╕рд╛</s> <strong>рдирд╣реАрдВ рдХрд┐рдпрд╛ рдерд╛ (</strong> <code>type.IsByRef</code> <s>Like</s> <code>== false</code> <strong>), рд▓реЗрдХрд┐рди рдпрд╣ <code>ref</code> -рд╕рдорд╛рди рдлрд╝реАрд▓реНрдб рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╡ рдерд╛ред</strong>  <strong>рдЬрд╛рд╣рд┐рд░ рд╣реИ, рдЗрд╕ рддрд░рд╣ рдХрд╛ рдкреНрд░рддрд┐рдмрдВрдз рднрд╛рд╖рд╛ рдореЗрдВ рдореМрдЬреВрдж рд╣реИ, рд▓реЗрдХрд┐рди <code>CLR</code> рдЗрд╕реЗ рдкрдЪрд╛рддрд╛ рд╣реИред</strong>  <strong>рд╢рд╛рдпрдж рдпрд╣ рдпрд╣рд╛рдВ рд╣реИ рдХрд┐ рдЧреИрд░-рдорд╛рдирдХ рдЙрдкрдпреЛрдЧ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдШреБрдЯрдиреЛрдВ рдХреЛ рдЧреЛрд▓реА рдорд╛рд░ рджреА рдЬрд╛рдПрдЧреАред</strong>  <sup>3</sup> </p><br><p>  рддреЛ, рд╣рдореЗрдВ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рдХрд╛рд░ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдорд┐рд▓рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЪрд╛рд░ рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдФрд░ рдЧрддрд┐рд╢реАрд▓ рд╡рд░реНрдЧреЛрдВ рдХреЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЗ рджреЛ рдирд┐рд╣рд┐рдд рд╕рдВрджрд░реНрдн рд╣реЛрддреЗ рд╣реИрдВред  рдПрдХ рд╣реА рдЬрд╛рддрд┐ рдХреЛ рдПрдХ рдкрдВрдХреНрддрд┐ рдореЗрдВ рд░рдЦрддреЗ рд╕рдордп рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдФрд░ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХрд╛ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдлрд┐рд░ рд╕реЗ рдПрдХ рдЬреЛрдбрд╝реА <code>(TIn, TOut) -&gt; Generator&lt;TIn, TOut&gt;</code> рд▓рд┐рдП рдХреИрд╢ (рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдХрдирд╡рд░реНрдЯрд░ <code>(TIn, TOut) -&gt; Generator&lt;TIn, TOut&gt;</code> ред </p><br><h2 id="shtrih-posledniy-privodim-tipy-spantin---spantout">  рд╕реНрдЯреНрд░реЛрдХ рдЕрдВрддрд┐рдо рд╣реИ: рд╣рдо рдкреНрд░рдХрд╛рд░ рджреЗрддреЗ рд╣реИрдВ, <code>Span&lt;TIn&gt; -&gt; Span&lt;TOut&gt;</code> </h2><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Span&lt;TOut&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Cast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;TIn&gt; span</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      if (span.IsEmpty) return Span&lt;TOut&gt;.Empty; // Caller   ,       if (span.Length * Unsafe.SizeOf&lt;TIn&gt;() % Unsafe.SizeOf&lt;TOut&gt;() != 0) throw new InvalidOperationException(); //      // Span&lt;TIn&gt; _input.Span = span; _spanSetter(span); //  Raw // Raw raw = _input.Raw; var raw = _rawGetter(); var newRaw = new Raw() { Pinnable = raw.Pinnable, //    Pinnable Pointer = raw.Pointer, //   Length = raw.Length * Unsafe.SizeOf&lt;TIn&gt;() / Unsafe.SizeOf&lt;TOut&gt;() //   }; //   Raw    // Raw _output.Raw = newRaw; _rawSetter(newRaw); //     // Span&lt;TOut&gt; _output.Span return _spanGetter(); }</span></span></code> </pre> <br><h1 id="vyvod">  рдирд┐рд╖реНрдХрд░реНрд╖ </h1><br><p>  рдХрднреА-рдХрднреА рдЦреЗрд▓ рдХреЗ рд╣рд┐рдд рдХреЗ рд▓рд┐рдП - рдЖрдк рднрд╛рд╖рд╛ рдХреА рдХреБрдЫ рд╕реАрдорд╛рдУрдВ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЧреИрд░-рдорд╛рдирдХ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдмреЗрд╢рдХ, рдЕрдкрдиреЗ рдЬреЛрдЦрд┐рдо рдФрд░ рдЬреЛрдЦрд┐рдо рдкрд░ред  рдпрд╣ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рдЧрддрд┐рд╢реАрд▓ рд╡рд┐рдзрд┐ рдЖрдкрдХреЛ рдкреЙрдЗрдВрдЯрд░реНрд╕ рдФрд░ <code>unsafe / fixed</code> рд╕рдВрджрд░реНрднреЛрдВ рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рддреНрдпрд╛рдЧрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдЬреЛ рдПрдХ рдмреЛрдирд╕ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред  рд╕реНрдкрд╖реНрдЯ рдирдХрд╛рд░рд╛рддреНрдордХ рдкрдХреНрд╖ рдкреНрд░рддрд┐рдмрд┐рдВрдм рдФрд░ рдкреНрд░рдХрд╛рд░ рдХреА рдкреАрдврд╝реА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><h1 id="dlya-teh-kto-dochital-do-konca">  рдЙрди рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдЬреЛ рдЕрдВрдд рддрдХ рдкрдврд╝реЗ рд╣реИрдВред </h1><br><div class="spoiler">  <b class="spoiler_title">Naive рдмреЗрдВрдЪрдорд╛рд░реНрдХ рдкрд░рд┐рдгрд╛рдо</b> <div class="spoiler_text"><p>  рдФрд░ рдпрд╣ рд╕рдм рдХрд┐рддрдиреА рдЬрд▓реНрджреА рд╣реИ? <br>  рдореИрдВрдиреЗ рдПрдХ рдмреЗрд╡рдХреВрдл рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ рдЬрд╛рддрд┐рдпреЛрдВ рдХреА рдЧрддрд┐ рдХреА рддреБрд▓рдирд╛ рдХреА, рдЬреЛ рдРрд╕реА рдЬрд╛рддрд┐рдпреЛрдВ рдФрд░ рдлреИрд▓рд╛рд╡реЛрдВ рдХреЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ / рд╕рдВрднрд╛рд╡рд┐рдд рдЙрдкрдпреЛрдЧ рдХреЛ рдирд╣реАрдВ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХрдо рд╕реЗ рдХрдо рдЧрддрд┐ рдХрд╛ рдПрдХ рд╡рд┐рдЪрд╛рд░ рджреЗрддрд╛ рд╣реИред </p><br><ol><li> <code>Cast_Explicit</code><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд┐рдзрд┐ 2 рдХреЗ рдЕрдиреБрд╕рд╛рд░</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдШреЛрд╖рд┐рдд рдкреНрд░рдХрд╛рд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд░реВрдкрд╛рдВрддрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдкреНрд░рддреНрдпреЗрдХ рдЬрд╛рддрд┐ рдХреЛ рджреЛ рдЫреЛрдЯреА рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рдЖрд╡рдВрдЯрди рдФрд░ рдЦреЗрддреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ;</font></font></li><li> <code>Cast_IL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рддрд░реАрдХрд╛ 3</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , рд▓реЗрдХрд┐рди рд╣рд░ рдмрд╛рд░ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдХреЛ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рддрд╛ рд╣реИ </font></font><code>Generator&lt;TIn, TOut&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдЬреЛ рд╢рдмреНрджрдХреЛрд╢реЛрдВ рдореЗрдВ рдирд┐рд░рдВрддрд░ рдЦреЛрдЬреЛрдВ рдХреА рдУрд░ рдЬрд╛рддрд╛ рд╣реИ, рдкрд╣рд▓реА рдкрд╛рд╕ рдХреЗ рдмрд╛рдж рд╕рднреА рдкреНрд░рдХрд╛рд░ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ;</font></font></li><li> <code>Cast_IL_Cached</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реАрдзреЗ рдХрдирд╡рд░реНрдЯрд░ рдЙрджрд╛рд╣рд░рдг рдХреЛ рдХреИрд╢ рдХрд░рддрд╛ рд╣реИ </font></font><code>Generator&lt;TIn, TOut&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдпрд╣реА рдХрд╛рд░рдг рд╣реИ рдХрд┐ рдпрд╣ рдФрд╕рдд рдкрд░ рддреЗрдЬреА рд╕реЗ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ </font><font style="vertical-align: inherit;">рдкреВрд░реА рдЬрд╛рддрд┐ рдЪрд╛рд░ рдкреНрд░рддрд┐рдирд┐рдзрд┐рдпреЛрдВ рдХреА рдХреЙрд▓ рдХреЗ рд▓рд┐рдП рдЙрдмрд▓рддреА рд╣реИ;</font></font></li><li> <code>Buffer</code>   ,       ,     .     . </li></ol><br><p>    тАФ         <code>int[N]</code>   <code>N/2</code>   . </p><br><p>   ,        ,    .              ,             .    ,          ,            .  ,  <em></em> <em></em> <em>   </em>     <code>unmanaged</code>   <em>  </em> . </p><br><pre> <code class="plaintext hljs">BenchmarkDotNet=v0.11.5, OS=Windows 10.0.18362 Intel Core i7-2700K CPU 3.50GHz (Sandy Bridge), 1 CPU, 8 logical and 4 physical cores [Host] : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.8.3815.0 Clr : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.8.3815.0 Job=Clr Runtime=Clr InvocationCount=1 UnrollFactor=1</code> </pre><br><div class="scrollable-table"><table><thead><tr><th> Method </th><th> N </th><th> Mean </th><th> Error </th><th> StdDev </th><th> Median </th><th> Ratio </th><th> RatioSD </th></tr></thead><tbody><tr><td> <strong>Cast_Explicit</strong> </td><td> <strong>100</strong> </td><td> <strong>362.2 ns</strong> </td><td> <strong>18.0967 ns</strong> </td><td> <strong>52.7888 ns</strong> </td><td> <strong>400.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td> 100 </td><td> 1,237.9 ns </td><td> 28.5954 ns </td><td> 67.4027 ns </td><td> 1,200.0 ns </td><td> 3.47 </td><td> 0.51 </td></tr><tr><td> Cast_IL_Cached </td><td> 100 </td><td> 522.8 ns </td><td> 25.2640 ns </td><td> 71.2576 ns </td><td> 500.0 ns </td><td> 1.46 </td><td> 0.27 </td></tr><tr><td> Buffer </td><td> 100 </td><td> 300.0 ns </td><td> 0.0000 ns </td><td> 0.0000 ns </td><td> 300.0 ns </td><td> 0.78 </td><td> 0.11 </td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td> <strong>Cast_Explicit</strong> </td><td>  <strong>1000</strong> </td><td> <strong>2,628.6 ns</strong> </td><td> <strong>54.0688 ns</strong> </td><td> <strong>64.3650 ns</strong> </td><td> <strong>2,600.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td> 1000 </td><td> 3,216.7 ns </td><td> 49.8568 ns </td><td> 38.9249 ns </td><td> 3,200.0 ns </td><td> 1.21 </td><td> 0.03 </td></tr><tr><td> Cast_IL_Cached </td><td> 1000 </td><td> 2,484.6 ns </td><td> 44.9717 ns </td><td> 37.5534 ns </td><td> 2,500.0 ns </td><td> 0.94 </td><td> 0.02 </td></tr><tr><td> Buffer </td><td> 1000 </td><td> 2,055.6 ns </td><td> 43.9695 ns </td><td> 73.4631 ns </td><td> 2,000.0 ns </td><td> 0.78 </td><td> 0.03 </td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td> <strong>Cast_Explicit</strong> </td><td> <strong>1000000</strong> </td><td> <strong>2,515,157.1 ns</strong> </td><td> <strong>11,809.8538 ns</strong> </td><td> <strong>10,469.1278 ns</strong> </td><td> <strong>2,516,050.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td>  1000000 </td><td> 2,263,826.7 ns </td><td> 23,724.4930 ns </td><td> 22,191.9054 ns </td><td> 2,262,000.0 ns </td><td> 0.90 </td><td> 0.01 </td></tr><tr><td> Cast_IL_Cached </td><td>  1000000 </td><td> 2,265,186.7 ns </td><td> 19,505.5913 ns </td><td> 18,245.5422 ns </td><td> 2,266,300.0 ns </td><td> 0.90 </td><td> 0.01 </td></tr><tr><td> Buffer </td><td>  1000000 </td><td> 1,959,547.8 ns </td><td> 39,175.7435 ns </td><td> 49,544.7719 ns </td><td> 1,959,200.0 ns </td><td> 0.78 </td><td> 0.02 </td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td> <strong>Cast_Explicit</strong> </td><td> <strong>100000000</strong> </td><td> <strong>255,751,392.9 ns</strong> </td><td> <strong>2,595,107.7066 ns</strong> </td><td> <strong>2,300,495.3873 ns</strong> </td><td> <strong>255,298,950.0 ns</strong> </td><td> <strong>1.00</strong> </td><td> <strong>0.00</strong> </td></tr><tr><td> Cast_IL </td><td> 100000000 </td><td> 228,709,457.1 ns </td><td> 527,430.9293 ns </td><td> 467,553.7809 ns </td><td> 228,864,100.0 ns </td><td> 0.89 </td><td> 0.01 </td></tr><tr><td> Cast_IL_Cached </td><td> 100000000 </td><td> 227,966,553.8 ns </td><td> 355,027.3545 ns </td><td> 296,463.9203 ns </td><td> 227,903,600.0 ns </td><td> 0.89 </td><td> 0.01 </td></tr><tr><td> Buffer </td><td> 100000000 </td><td> 213,216,776.9 ns </td><td> 1,198,565.1142 ns </td><td> 1,000,856.1536 ns </td><td> 213,517,800.0 ns </td><td> 0.83 </td><td> 0.01 </td></tr></tbody></table></div></div></div><br><div class="spoiler"> <b class="spoiler_title">Acknowledgements</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><strong>JetBrains</strong></a> (      :-))   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><strong>R#</strong></a>    <strong>VS</strong>  standalone- <strong>dotPeek</strong> ,     .  <code>BenchmarkDotNet</code>  BenchmarkDotNet, youtube- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><strong>NDC Conferences</strong></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><strong>DotNext</strong></a>    ,  ,         . </p></div></div><br><h1 id="ps">  рдкреБрдирд╢реНрдЪ </h1><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p> <sup>3</sup>         ,      <code>ref</code> ,      ,   .  <s></s>   (   )   .    <code>ref</code> structs,        </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Raw Generated_Int32.GetRaw(Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; span) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inst = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Generated_Int32() { Span = span }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> inst.Raw; }</code> </pre> <br><p>     ,     <code>Reflection.Emit</code> .      ,   <em></em>  <code>ILGenerator.DeclareLocal</code> .     </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; Generated_Int32.GetSpan(Raw raw);</code> </pre> <br><p>    </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> Raw GetRaw&lt;T&gt;(Span&lt;T&gt; span) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged; <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> Span&lt;T&gt; GetSpan&lt;T&gt;(Raw raw) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : unmanaged;</code> </pre> <br><p> , <em> </em> ,       <code>ref</code> тАФ .  рдХреНрдпреЛрдВрдХрд┐     ,      </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getter = type.GetMethod(<span class="hljs-string"><span class="hljs-string">@"GetRaw"</span></span>, BindingFlags.Static | BindingFlags.Public).CreateDelegate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(GetRaw&lt;T&gt;), <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GetRaw&lt;T&gt;;</code> </pre> <br><p>   тАФ  </p><br><pre> <code class="cs hljs">Raw raw = getter(Span&lt;TIn&gt;.Empty); Raw newRaw = convert(raw); Span&lt;TOut&gt; = setter(newRaw);</code> </pre> </div></div><br><p> <em>UPD01:   </em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi465077/">https://habr.com/ru/post/hi465077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi465063/index.html">рд╕реНрдкреНрд░рд┐рдВрдЧ рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп 10 рд╕рдмрд╕реЗ рдЖрдо рддреНрд░реБрдЯрд┐рдпрд╛рдВред рднрд╛рдЧ реи</a></li>
<li><a href="../hi465069/index.html">Hadoop рдореЗрдВ рдирдпрд╛: Hadoop рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди рдлрд╝рд╛рдЗрд▓ рд╕реНрд╡рд░реВрдкреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдиреЗрдВ</a></li>
<li><a href="../hi465071/index.html">TechTrain 2019 IT рддреНрдпреЛрд╣рд╛рд░: JUG.ru, JUGNsk рдФрд░ JUG.MSK рдиреЗ рдЗрд╕рдореЗрдВ рдХреИрд╕реЗ рднрд╛рдЧ рд▓рд┐рдпрд╛</a></li>
<li><a href="../hi465073/index.html">рдкреЙрдк рдордд рдХрд░реЛ! рдЖрдИрдУрдПрд╕ рдореЗрдВ рдЗрдВрдЯрд░рдкреНрдЯреЗрдмрд▓ рдЯреНрд░рд╛рдВрдЬрд┐рд╢рди</a></li>
<li><a href="../hi465075/index.html">рдЯреНрд░реЗрди рдбреНрд░рд╛рдЗрд╡рд░ рдХреИрдм рдореЗрдВ</a></li>
<li><a href="../hi465081/index.html">CLRium # 6: рд╕рдорд░реВрдкрддрд╛ рдФрд░ рд╕рдорд╛рдирд╛рдВрддрд░рд╡рд╛рджред рдХрд╛рд░реНрдп рд╕рдорд╛рдВрддрд░рд┐рдХрд░рдг рдХрд╛ рдЬрд╛рджреВ рд╕реАрдЦрдирд╛</a></li>
<li><a href="../hi465083/index.html">рд╕рдЬрдЧ рджреНрд╡рд╛рд░ рдирд┐рдЧрд░рд╛рдиреА</a></li>
<li><a href="../hi465085/index.html">рдПрдВрдЯреА рдлрд╝рд┐рд╢рд┐рдВрдЧ рдЪреЗрдХрд▓рд┐рд╕реНрдЯ</a></li>
<li><a href="../hi465087/index.html">рдирд╛рд╕рд╛ рдиреЗ рд╕реНрдиреЛрдкреА рдХреЛ рдХреИрд╕реЗ рдХрд╛рдо рдкрд░ рд░рдЦрд╛ рдФрд░ рдмрд╛рд░реНрдмреА рдХрдкрдбрд╝реЗ рдЙрдард╛рдП</a></li>
<li><a href="../hi465089/index.html">рдореМрдХрд╛ рдЧрдгрд┐рддрдЬреНрдЮреЛрдВ рдХреА рдорджрдж рдХреИрд╕реЗ рдХрд░ рд╕рдХрддрд╛ рд╣реИ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>