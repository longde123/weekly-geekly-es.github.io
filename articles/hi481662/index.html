<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯСйтАНЁЯСйтАНЁЯСж ЁЯСиЁЯП┐тАНЁЯМ╛ ЁЯУЦ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рддреИрдирд╛рддреА рдФрд░ рдирд┐рд░реНрдорд╛рдг рдХреЗ рд▓рд┐рдП рдирдП рдЙрдкрдХрд░рдгреЛрдВ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛ ЁЯХ╖я╕П ЁЯзЩЁЯП╛ тмЕя╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдирдорд╕реНрддреЗ! рд╣рд╛рд▓ рд╣реА рдореЗрдВ, рдХрдИ рд╢рд╛рдВрдд рд╕реНрд╡рдЪрд╛рд▓рди рдЙрдкрдХрд░рдг рдбреЛрдХрд░ рдЫрд╡рд┐рдпреЛрдВ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдФрд░ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреА рддреИрдирд╛рддреА рдХреЗ рд▓рд┐рдП рджреЛрдиреЛрдВ рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рд╣реИрдВред рдЗрд╕ рд╕рдВрдмрдВрдз рдореЗрдВ, рдореИрдВрдиреЗ рдЧрд┐рдЯрд▓реИрдм рдХреЗ рд╕...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рддреИрдирд╛рддреА рдФрд░ рдирд┐рд░реНрдорд╛рдг рдХреЗ рд▓рд┐рдП рдирдП рдЙрдкрдХрд░рдгреЛрдВ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481662/"><p><img src="https://habrastorage.org/webt/fu/wy/ia/fuwyia7huxrflvry8lzz2dbl2tw.png"></p><br><p>  рдирдорд╕реНрддреЗ!  рд╣рд╛рд▓ рд╣реА рдореЗрдВ, рдХрдИ рд╢рд╛рдВрдд рд╕реНрд╡рдЪрд╛рд▓рди рдЙрдкрдХрд░рдг рдбреЛрдХрд░ рдЫрд╡рд┐рдпреЛрдВ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдФрд░ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреА рддреИрдирд╛рддреА рдХреЗ рд▓рд┐рдП рджреЛрдиреЛрдВ рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рд╣реИрдВред  рдЗрд╕ рд╕рдВрдмрдВрдз рдореЗрдВ, рдореИрдВрдиреЗ рдЧрд┐рдЯрд▓реИрдм рдХреЗ рд╕рд╛рде рдЦреЗрд▓рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛, рдЗрд╕рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХрд╛ рдЕрдзреНрдпрдпрди рдХреИрд╕реЗ рдХрд░реЗрдВ рдФрд░ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВред </p><br><p>  рдЗрд╕ рдХрд╛рдо рдХреЗ рд▓рд┐рдП рдкреНрд░реЗрд░рдгрд╛ рд╕рд╛рдЗрдЯ <a href="https://kubernetes.io/" rel="nofollow">kubernetes.io рдереА</a> , рдЬреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ <a href="http://github.com/kubernetes/website" rel="nofollow">рд╕реНрд░реЛрдд рдХреЛрдб</a> рд╕реЗ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИ, рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рднреЗрдЬреЗ рдЧрдП рдкреВрд▓ рдХреЗ рд▓рд┐рдП, рд░реЛрдмреЛрдЯ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЖрдкрдХреЗ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЗ рд╕рд╛рде рд╕рд╛рдЗрдЯ рдХрд╛ рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрди рд╕рдВрд╕реНрдХрд░рдг рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд▓рд┐рдВрдХ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдореИрдВрдиреЗ рд╕реНрдХреНрд░реИрдЪ рд╕реЗ рдПрдХ рд╕рдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдмрдирд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХреА, рд▓реЗрдХрд┐рди рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЧрд┐рдЯрд▓реИрдм рд╕реАрдЖрдИ рдФрд░ рдореБрдлреНрдд рдЯреВрд▓ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдореИрдВ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рдерд╛ред  рдЖрдЬ рдореИрдВ рдЕрдВрдд рдореЗрдВ рдЖрдкрдХреЛ рдЙрдирдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдмрддрд╛рдКрдВрдЧрд╛ред </p><br><p>  рд▓реЗрдЦ рдЗрд╕ рддрд░рд╣ рдХреЗ рдЙрдкрдХрд░рдгреЛрдВ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдЧрд╛: <br>  <strong>рд╣реНрдпреВрдЧреЛ</strong> , <strong>рдХреНрдпреВрдмреЗрдХ</strong> , <strong>рдХрд╛рдирд┐рдХреЛ</strong> , <strong>рдЧрд┐рдЯ-рдХреНрд░рд┐рдкреНрдЯ</strong> рдФрд░ <strong>рдЧрд┐рддрд▓рд╛рдм рд╕реАрдЖрдИ</strong> рдЧрддрд┐рд╢реАрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХреЗ рд╕рд╛рдеред </p><a name="habracut"></a><br><hr><br><h1 id="coderzhanie">  рдЕрдВрддрд░реНрд╡рд╕реНрддреБ </h1><br><ol><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдкреЗрд╢ рд╣реИ рд╣реНрдпреВрдЧреЛ</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдбреЙрдХрд░рдлрд╛рдЗрд▓ рддреИрдпрд╛рд░ рдХрд░рдирд╛</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдХрд╛рдирд┐рдХреЛ рдХреЗ рд╕рд╛рде рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдирд╛</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдкреЗрд╢ рд╣реИ рдХреНрдпреВрдмреЗрдХ</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдХреБрдмреЗрд░рдиреЗрддреНрд╕-рдирд┐рд╖реНрдкрд╛рджрдХ рдХреЗ рд╕рд╛рде рдЧрд┐рдЯрд▓рдм-рд░рдирд░ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдХреНрдпреВрдмреЗрдХ рдХреЗ рд╕рд╛рде рд╣реЗрд▓реНрдо рдЪрд╛рд░реНрдЯ рдХреА рддреИрдирд╛рддреА</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдкреЗрд╢ рд╣реИ рдЧрд┐рдЯ-рдХреНрд░рд┐рдкреНрдЯ</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдЯреВрд▓рдмреЙрдХреНрд╕ рдЫрд╡рд┐ рдмрдирд╛рдПрдВ</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдЯреИрдЧ рджреНрд╡рд╛рд░рд╛ рд╣рдорд╛рд░реА рдкрд╣рд▓реА рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдФрд░ рдЫрд╡рд┐рдпреЛрдВ рдХреА рд╡рд┐рдзрд╛рдирд╕рднрд╛</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдкрд░рд┐рдирд┐рдпреЛрдЬрди рд╕реНрд╡рдЪрд╛рд▓рди</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдХрд▓рд╛рдХреГрддрд┐рдпреЛрдВ рдФрд░ рдзрдХреНрдХрд╛ рдорд╛рд╕реНрдЯрд░ рдореЗрдВ рдирд┐рд░реНрдорд╛рдг</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдЧрддрд┐рд╢реАрд▓ рд╡рд╛рддрд╛рд╡рд░рдг</strong></a> </li><li>  <a href="https://habr.com/ru/post/481662/"><strong>рдРрдкреНрд╕ рдХреА рд╕рдореАрдХреНрд╖рд╛ рдХрд░реЗрдВ</strong></a> </li></ol><br><hr><br><h1 id="1-znakomstvo-s-hugoanchorhugoanchor">  1. рд╣реНрдпреВрдЧреЛ рдХрд╛ рдкрд░рд┐рдЪрдп <a name="hugo"></a></h1><br><p>  рд╣рдорд╛рд░реА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ, рд╣рдо рд╣реНрдпреВрдЧреЛ рдкрд░ рдирд┐рд░реНрдорд┐рдд рдкреНрд░рд▓реЗрдЦрди рдкреНрд░рдХрд╛рд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдмрдирд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВрдЧреЗред  рд╣реНрдпреВрдЧреЛ рдПрдХ рд╕реНрдерд┐рд░ рд╕рд╛рдордЧреНрд░реА рдЬрдирд░реЗрдЯрд░ рд╣реИред </p><br><p>  рдЬреЛ рд▓реЛрдЧ рд╕реНрдереИрддрд┐рдХ рдЬрдирд░реЗрдЯрд░ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рдирд╣реАрдВ рд╣реИрдВ, рдореИрдВ рдЖрдкрдХреЛ рдЙрдирдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдереЛрдбрд╝рд╛ рдФрд░ рдмрддрд╛рдКрдВрдЧрд╛ред  рдирд┐рдпрдорд┐рдд рдбреЗрдЯрд╛рдмреЗрд╕ рд╕рд╛рдЗрдЯ рдЗрдВрдЬрдиреЛрдВ рдФрд░ рдХреБрдЫ php рдЗрдВрдЬрдиреЛрдВ рдХреЗ рд╡рд┐рдкрд░реАрдд, рдЬреЛ рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░реЗрд░рд┐рдд рдХрд┐рдП рдЬрд╛рдиреЗ рдкрд░, рдордХреНрдЦреА рдкрд░ рдкреГрд╖реНрда рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реИрдВ, рд╕реНрдереИрддрд┐рдХ рдЬрдирд░реЗрдЯрд░ рдХреЛ рдереЛрдбрд╝рд╛ рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╕реЗ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рд╡реЗ рдЖрдкрдХреЛ рд╕реНрд░реЛрдд рд▓реЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рдПрдХ рдирд┐рдпрдо рдХреЗ рд░реВрдк рдореЗрдВ рдпрд╣ рдорд╛рд░реНрдХрдбрд╛рдЙрди рдорд╛рд░реНрдХрдЕрдк рдФрд░ рдереАрдо рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдореЗрдВ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╣реИ, рдлрд┐рд░ рдЙрдиреНрд╣реЗрдВ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рддреИрдпрд╛рд░ рд╕рд╛рдЗрдЯ рдореЗрдВ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВред </p><br><p>  рдпрд╣реА рд╣реИ, рдЖрдЙрдЯрдкреБрдЯ рдкрд░ рдЖрдкрдХреЛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕рдВрд░рдЪрдирд╛ рдФрд░ рдЬреЗрдирд░реЗрдЯ рдХреА рдЧрдИ html-files рдХрд╛ рдПрдХ рд╕реЗрдЯ рдорд┐рд▓реЗрдЧрд╛, рдЬрд┐рд╕реЗ рдмрд╕ рдХрд┐рд╕реА рднреА рд╕рд╕реНрддреЗ рд╣реЛрд╕реНрдЯрд┐рдВрдЧ рдкрд░ рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ рд╡рд░реНрдХрд┐рдВрдЧ рд╕рд╛рдЗрдЯ рдорд┐рд▓ рд╕рдХрддреА рд╣реИред </p><br><p>  рд╣реНрдпреВрдЧреЛ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдЖрдЬрд╝рдорд╛ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><p>  рд╣рдо рдирдИ рд╕рд╛рдЗрдЯ рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ: </p><br><pre><code class="bash hljs">hugo new site docs.example.org</code> </pre> <br><p>  рдФрд░ рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рдЧрд┐рдЯ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docs.example.org git init</code> </pre> <br><p>  рдЕрдм рддрдХ, рд╣рдорд╛рд░реА рд╕рд╛рдЗрдЯ рдкреНрд░рд╛рдЪреАрди рд╣реИ рдФрд░ рдЗрд╕ рдкрд░ рдХреБрдЫ рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рд╣рдореЗрдВ рдПрдХ рдереАрдо, рдПрдХ рдереАрдо рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ - рдпрд╣ рд╕рд┐рд░реНрдл рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдХрд╛ рдПрдХ рд╕реЗрдЯ рдФрд░ рдкреНрд░реАрд╕реЗрдЯ рдирд┐рдпрдо рд╣реИ рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╣рдорд╛рд░реА рд╕рд╛рдЗрдЯ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИред </p><br><p>  рдПрдХ рд╡рд┐рд╖рдп рдХреЗ рд░реВрдк рдореЗрдВ, рд╣рдо <a href="https://themes.gohugo.io/hugo-theme-learn/" rel="nofollow"><strong>Learn</strong></a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ, рдЬреЛ, рдореЗрд░реА рд░рд╛рдп рдореЗрдВ, рдкреНрд░рд▓реЗрдЦрди рд╡рд╛рд▓реА рд╕рд╛рдЗрдЯ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЙрдкрдпреБрдХреНрдд рд╣реИред </p><br><p>  рдореИрдВ рдЗрд╕ рддрдереНрдп рдкрд░ рд╡рд┐рд╢реЗрд╖ рдзреНрдпрд╛рди рджреЗрдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛ рдХрд┐ рд╣рдореЗрдВ рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рднрдВрдбрд╛рд░ рдореЗрдВ рдереАрдо рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╕рд╣реЗрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рд╣рдо рдЗрд╕реЗ <strong>рдЧрд┐рдЯ рд╕рдмрдореЙрдбреНрдпреВрд▓</strong> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдиреЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">git submodule add https://github.com/matcornic/hugo-theme-learn themes/learn</code> </pre> <br><p>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдХреЗрд╡рд▓ рд╣рдорд╛рд░реА рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдлрд╛рдЗрд▓реЗрдВ рд╣реА рд╣рдорд╛рд░реЗ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ рд╣реЛрдВрдЧреА, рдФрд░ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╡рд┐рд╖рдп рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЗ рд▓рд┐рдВрдХ рдХреЗ рд░реВрдк рдореЗрдВ рд░рд╣реЗрдЧрд╛ рдФрд░ рдЗрд╕рдореЗрдВ рдкреНрд░рддрд┐рдмрджреНрдз рд╣реЛрдЧрд╛, рдЕрд░реНрдерд╛рдд рдпрд╣ рд╣рдореЗрд╢рд╛ рдореВрд▓ рд╕реНрд░реЛрдд рд╕реЗ рдЦреАрдВрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЕрд╕рдВрдЧрдд рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рд╕реЗ рдбрд░рдирд╛ рдирд╣реАрдВ рдЪрд╛рд╣рд┐рдПред </p><br><p>  <strong>Config.toml</strong> config рдХреЛ рдареАрдХ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">baseURL = "http://docs.example.org/" languageCode = "en-us" title = "My Docs Site" theme = "learn"</code> </pre> <br><p>  рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЗрд╕ рд╕реНрддрд░ рдкрд░, рдЖрдк рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">hugo server</code> </pre> <br><p>  рдФрд░ <a href="http://localhost:1313/" rel="nofollow">http: // localhost: 1313 рдкрд░ /</a> рд╣рдорд╛рд░реА рдирдИ рдмрдирд╛рдИ рдЧрдИ рд╕рд╛рдЗрдЯ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ, рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдХрд┐рдП рдЧрдП рд╕рднреА рдкрд░рд┐рд╡рд░реНрддрди рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЕрдкрдбреЗрдЯ рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рдЦреБрд▓рд╛ рдкреГрд╖реНрда рдмрд╣реБрдд рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИ! </p><br><p>  рдЪрд▓рд┐рдП <strong>рдХрдВрдЯреЗрдВрдЯ / _index.md</strong> рдореЗрдВ рдПрдХ рдХрд╡рд░ рдкреЗрдЬ рдмрдирд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ: </p><br><pre> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># My docs site ## Welcome to the docs! You will be very smart :-)</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">рдирдП рдмрдирд╛рдП рдЧрдП рдкреЗрдЬ рдХрд╛ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/gb/yx/nv/gbyxnvagfs6bks4iqbwcrrovumu.png"></p></div></div><br><p>  рд╕рд╛рдЗрдЯ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ рдЪрд▓рд╛рдПрдВ: </p><br><pre> <code class="bash hljs">hugo</code> </pre> <br><p>  <strong>рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ /</strong> рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рд╕рд╛рдордЧреНрд░реА рдЖрдкрдХреА рд╕рд╛рдЗрдЯ рд╣реЛрдЧреАред <br>  рд╣рд╛рдБ, рд╡реИрд╕реЗ, рддреБрд░рдВрдд рдЗрд╕реЗ <strong>.gitignore рдореЗрдВ</strong> рдЬреЛрдбрд╝реЗрдВ: </p><br><pre> <code class="plaintext hljs">echo /public &gt; .gitignore</code> </pre> <br><p>  рд╣рдорд╛рд░реЗ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордд рднреВрд▓рдирд╛: </p><br><pre> <code class="plaintext hljs">git add . git commit -m "New site created"</code> </pre> <br><hr><br><h1 id="2-podgotovka-dockerfileanchordockerfileanchor">  2. рдбреЙрдХрд░рдлрд╛рдЗрд▓ рддреИрдпрд╛рд░ рдХрд░рдирд╛ <a name="dockerfile"></a></h1><br><p>  рдпрд╣ рд╣рдорд╛рд░реЗ рднрдВрдбрд╛рд░ рдХреА рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИред  рдЖрдорддреМрд░ рдкрд░ рдореИрдВ рдХреБрдЫ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ рдЬреИрд╕реЗ: </p><br><pre> <code class="plaintext hljs">. тФЬтФАтФА deploy тФВ тФЬтФАтФА app1 тФВ тФФтФАтФА app2 тФФтФАтФА dockerfiles тФЬтФАтФА image1 тФФтФАтФА image2</code> </pre> <br><ul><li>  <strong>dockerfiles /</strong> - Dockerfiles рдХреЗ рд╕рд╛рде рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдФрд░ рдЖрдкрдХреЛ рд╣рдорд╛рд░реЗ docker рдЫрд╡рд┐рдпреЛрдВ рдХреЛ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </li><li>  <strong>рддреИрдирд╛рдд /</strong> - рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ </li></ul><br><p>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╣рдо рдкрде <strong>dockerfiles / рд╡реЗрдмрд╕рд╛рдЗрдЯ / Dockerfile рдХреЗ</strong> рд╕рд╛рде рдЕрдкрдирд╛ рдкрд╣рд▓рд╛ Dockerfile <strong>рдмрдирд╛рдПрдВрдЧреЗ</strong> </p><br><pre> <code class="bash hljs">FROM alpine:3.11 as builder ARG HUGO_VERSION=0.62.0 RUN wget -O- https://github.com/gohugoio/hugo/releases/download/v<span class="hljs-variable"><span class="hljs-variable">${HUGO_VERSION}</span></span>/hugo_<span class="hljs-variable"><span class="hljs-variable">${HUGO_VERSION}</span></span>_linux-64bit.tar.gz | tar -xz -C /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin ADD . /src RUN hugo -s /src FROM alpine:3.11 RUN apk add --no-cache darkhttpd COPY --from=builder /src/public /var/www ENTRYPOINT [ <span class="hljs-string"><span class="hljs-string">"/usr/bin/darkhttpd"</span></span> ] CMD [ <span class="hljs-string"><span class="hljs-string">"/var/www"</span></span> ]</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдбреЙрдХрд░реАрдлрд╛рдЗрд▓ рдореЗрдВ рджреЛ FROM рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЛ <a href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="nofollow"><strong>рдорд▓реНрдЯреА-рд╕реНрдЯреЗрдЬ рдмрд┐рд▓реНрдб</strong></a> рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЕрдВрддрд┐рдо docker рдЫрд╡рд┐ рд╕реЗ рдЕрдирд╛рд╡рд╢реНрдпрдХ рд╕рдм рдХреБрдЫ рдмрд╛рд╣рд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред <br>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдЕрдВрддрд┐рдо рдЫрд╡рд┐ рдореЗрдВ рдХреЗрд╡рд▓ <strong>darkhttpd</strong> (рдПрдХ рд╣рд▓реНрдХрд╛ HTTP рд╕рд░реНрд╡рд░) рдФрд░ <strong>рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ /</strong> - рд╣рдорд╛рд░реА рд╕рд╛рдВрдЦреНрдпрд┐рдХреАрдп рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди рд╕рд╛рдЗрдЯ рдХреА рд╕рд╛рдордЧреНрд░реА рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧреАред </p><br><p>  рд╣рдорд╛рд░реЗ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордд рднреВрд▓рдирд╛: </p><br><pre> <code class="plaintext hljs">git add dockerfiles/website git commit -m "Add Dockerfile for website"</code> </pre> <br><hr><br><h1 id="3-znakomstvo-s-kanikoanchorkanikoanchor">  3. рдХрд╛рдирд┐рдХреЛ рдХреЗ рд╕рд╛рде рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдирд╛ <a name="kaniko"></a></h1><br><p>  <strong><a href="https://github.com/GoogleContainerTools/kaniko" rel="nofollow">Docker рдХреА</a></strong> рдЫрд╡рд┐рдпреЛрдВ рдХреЗ рд╕рдВрдЧреНрд░рд╣рдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ, рдореИрдВрдиреЗ <strong><a href="https://github.com/GoogleContainerTools/kaniko" rel="nofollow">kaniko</a></strong> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <strong><a href="https://github.com/GoogleContainerTools/kaniko" rel="nofollow">docker</a></strong> рдбреЗрдореЙрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдФрд░ рдЕрд╕реЗрдВрдмрд▓реА рдХреЛ рдХрд┐рд╕реА рднреА рдорд╢реАрди рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдХреИрд╢ рдХреЛ рд╕реАрдзреЗ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдПрдХ рдкреВрд░реНрдг рднрдВрдбрд╛рд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ ред </p><br><p>  рдЫрд╡рд┐ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ <strong>рдХрдирд┐рдХреЛ рдПрдХреНрдЬрд╝реАрдХреНрдпреВрдЯрд░ рдХреЗ</strong> рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ рд╡рд░реНрддрдорд╛рди рдирд┐рд░реНрдорд╛рдг рдХреЗ рд╕рдВрджрд░реНрдн рдХреЛ рдкрд╛рд╕ рдХрд░реЗрдВ, рдЖрдк рдЗрд╕реЗ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ, <strong>docker рджреНрд╡рд╛рд░рд╛</strong> рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">docker run -ti --rm \ -v <span class="hljs-variable"><span class="hljs-variable">$PWD</span></span>:/workspace \ -v ~/.docker/config.json:/kaniko/.docker/config.json:ro \ gcr.io/kaniko-project/executor:v0.15.0 \ --cache \ --dockerfile=dockerfiles/website/Dockerfile \ --destination=registry.gitlab.com/kvaps/docs.example.org/website:v0.0.1</code> </pre> <br><p>  рдЬрд╣рд╛рдБ <strong>рд░рдЬрд┐рд╕реНрдЯреНрд░реА</strong> .itlab.com/kvaps/docs.example.org/website рдЖрдкрдХреА рдбреЙрдХрдЯрд░ рдЫрд╡рд┐ рдХрд╛ рдирд╛рдо рд╣реИ, рдЕрд╕реЗрдВрдмрд▓реА рдХреЗ рдмрд╛рдж рдпрд╣ рд╕реНрд╡рддрдГ рдбреЙрдХрдЯрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рдзрдХреЗрд▓ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред </p><br><p>  <strong>Thecache</strong> рдкреИрд░рд╛рдореАрдЯрд░ рдЖрдкрдХреЛ <strong>docker</strong> рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рдкрд░рддреЛрдВ рдХреЛ рдХреИрд╢ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЙрдиреНрд╣реЗрдВ <strong>рд░рдЬрд┐рд╕реНрдЯреНрд░реА</strong> рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛ <strong>редgitlab.com/kvaps/docs.example.org/website/cache</strong> , рд▓реЗрдХрд┐рди рдЖрдк <strong>.cache-</strong> рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдФрд░ рдкрде рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ <strong>рд░реЗрдкреЛ</strong> ред </p><br><div class="spoiler">  <b class="spoiler_title">рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдбреЙрдХ-рд░рдЬрд┐рд╕реНрдЯреНрд░реА</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/0-/31/qx/0-31qxfta2gk7-colutf2l_qtmm.png"></p></div></div><br><hr><br><h1 id="4-znakomstvo-s-qbecanchorqbecanchor">  4. рдХреНрдпреВрдмреЗрдХ рдХреЗ рд╕рд╛рде рдкрд░рд┐рдЪрд┐рдд <a name="qbec"></a></h1><br><p>  <a href="https://qbec.io/" rel="nofollow">рдХреНрдпреВрдмреЗрдХ</a> рдПрдХ рддреИрдирд╛рддреА рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдЖрд╡реЗрджрди рдХреА рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдФрд░ рдЗрд╕реЗ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдкрд░ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рдореБрдЦреНрдп рд╡рд╛рдХреНрдпрд╡рд┐рдиреНрдпрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ Jsonnet рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЖрдкрдХреЛ рдХрдИ рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рдорддрднреЗрджреЛрдВ рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдФрд░ рдХреЛрдб рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рдХреЛ рднреА рд▓рдЧрднрдЧ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕рдорд╛рдкреНрдд рдХрд░ рджреЗрддрд╛ рд╣реИред </p><br><p>  рдпрд╣ рдЙрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕рдЪ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ рд╡рд┐рднрд┐рдиреНрди рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд╕рд╛рде рдХрдИ рд╕рдореВрд╣реЛрдВ рдореЗрдВ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдФрд░ рдЖрдк рдЙрдиреНрд╣реЗрдВ рдЬреАрдЖрдИрдЯреА рдореЗрдВ рдШреЛрд╖рд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред </p><br><p>  рдХреНрдпреВрдмреЗрдХ рдЖрдкрдХреЛ рдЖрд╡рд╢реНрдпрдХ рдорд╛рдкрджрдВрдбреЛрдВ рдХреЛ рдкрд╛рд░ рдХрд░рдХреЗ рдФрд░ рдмрд╛рдж рдореЗрдВ рдЙрдиреНрд╣реЗрдВ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдШреЛрд╖рдгрд╛рдкрддреНрд░ рдХреЗ рд╕рд╛рде-рд╕рд╛рде рдЙрди рд╡рд┐рднрд┐рдиреНрди рдореНрдпреВрдЯреЗрд╢рдиреЛрдВ рд╕рд╣рд┐рдд рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рд╣реЗрд▓реНрдо рдЪрд╛рд░реНрдЯ рдХреЛ рдкреНрд░рд╕реНрддреБрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рдмрджрд▓реЗ рдореЗрдВ, рдЪрд╛рд░реНрдЯрдореНрдпреВрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред  рдпрд╣реА рд╣реИ, рдЖрдк рдЪрд╛рд░реНрдЯ рдХреЛ рд╕реАрдзреЗ рдЧрд┐рдЯ рд╕реЗ рд╕реНрдЯреЛрд░ рдФрд░ рд░реЗрдВрдбрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд╣рд╛рдВ рдЙрдирдХреЗ рдкрд╛рд╕ рдЬрдЧрд╣ рд╣реИред </p><br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рдХрд╣рд╛ рдерд╛, рд╣рдо рд╕рднреА рддреИрдирд╛рддреА рдХреЛ <strong>рддреИрдирд╛рддреА /</strong> рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВрдЧреЗ: </p><br><pre> <code class="bash hljs">mkdir deploy <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy</code> </pre> <br><p>  рдЪрд▓реЛ рд╣рдорд╛рд░реЗ рдкрд╣рд▓реЗ рдЖрд╡реЗрджрди рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">qbec init website <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> website</code> </pre> <br><p>  рдЕрдм рд╣рдорд╛рд░реЗ рдЖрд╡реЗрджрди рдХреА рд╕рдВрд░рдЪрдирд╛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ: </p><br><pre> <code class="plaintext hljs">. тФЬтФАтФА components тФЬтФАтФА environments тФВ  тФЬтФАтФА base.libsonnet тФВ  тФФтФАтФА default.libsonnet тФЬтФАтФА params.libsonnet тФФтФАтФА qbec.yaml</code> </pre> <br><p>  <strong>qbec.yaml</strong> рдлрд╝рд╛рдЗрд▓ рджреЗрдЦреЗрдВ: </p><br><pre> <code class="plaintext hljs">apiVersion: qbec.io/v1alpha1 kind: App metadata: name: website spec: environments: default: defaultNamespace: docs server: https://kubernetes.example.org:8443 vars: {}</code> </pre> <br><p>  рдпрд╣рд╛рдВ рд╣рдо рдореБрдЦреНрдп рд░реВрдк рд╕реЗ <strong>рдХрд▓реНрдкрдирд╛ рдХреЗ</strong> рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рд░реБрдЪрд┐ рд░рдЦрддреЗ рд╣реИрдВред <strong>рдХреНрдпреВрдмреЗрдХ</strong> рдиреЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдПрдХ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╡рд╛рддрд╛рд╡рд░рдг рдмрдирд╛рдпрд╛ рдФрд░ рд╕рд░реНрд╡рд░ рдПрдбреНрд░реЗрд╕, рд╕рд╛рде рд╣реА рд╣рдорд╛рд░реЗ рд╡рд░реНрддрдорд╛рди kubeconfig рд╕реЗ рдирд╛рдо рд╕реНрдерд╛рди рд▓рд┐рдпрд╛ред <br>  рдЕрдм, рдЬрдм <strong>рдбрд┐рдлрд╝реЙрд▓реНрдЯ</strong> рд╡рд╛рддрд╛рд╡рд░рдг рдкрд░рд┐рдирд┐рдпреЛрдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рддреЛ рдХреНрдпреВрдмреЗрдХ рд╣рдореЗрд╢рд╛ рдХреЗрд╡рд▓ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХреБрдмреЗрд░рдиреЗрдЯ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдФрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╛рдорд╕реНрдерд╛рди рдкрд░ рддреИрдирд╛рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЕрд░реНрдерд╛рдд, рдЖрдкрдХреЛ рдкрд░рд┐рдирд┐рдпреЛрдЬрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрджрд░реНрднреЛрдВ рдФрд░ рдирд╛рдорд╕реНрдерд╛рдиреЛрдВ рдХреЗ рдмреАрдЪ рд╕реНрд╡рд┐рдЪ рдирд╣реАрдВ рдХрд░рдирд╛ рдкрдбрд╝реЗрдЧрд╛ред <br>  рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ, рддреЛ рдЖрдк рд╣рдореЗрд╢рд╛ рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  рдЖрдкрдХреЗ рд╕рднреА рд╡рд╛рддрд╛рд╡рд░рдг <strong>qbec.yaml</strong> рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИрдВ, рдФрд░ <strong>params.libsonnet</strong> рдлрд╝рд╛рдЗрд▓ рдореЗрдВ, рдЬрд╣рд╛рдВ рдпрд╣ рдХрд╣рддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХреЛ рдЙрдирдХреЗ рд▓рд┐рдП рдкреИрд░рд╛рдореАрдЯрд░ рд▓реЗрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p>  рдЖрдЧреЗ рд╣рдо рджреЛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ рджреЗрдЦрддреЗ рд╣реИрдВ: </p><br><ul><li>  <strong>рдШрдЯрдХ /</strong> - рд╣рдорд╛рд░реЗ рдЖрд╡реЗрджрди рдХреЗ рд▓рд┐рдП рд╕рднреА рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐рдпрд╛рдБ рдпрд╣рд╛рдБ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рдПрдВрдЧреА, рдЙрдиреНрд╣реЗрдВ рдЬреЛрдВрд╕рдиреЗрдЯ рдФрд░ рд╕рд╛рдзрд╛рд░рдг рдпрд╛рдореНрд▓-рдлрд╝рд╛рдЗрд▓реЛрдВ рджреЛрдиреЛрдВ рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ </li><li>  <strong>рд╡рд╛рддрд╛рд╡рд░рдг /</strong> - рдпрд╣рд╛рдБ рд╣рдо рдЕрдкрдиреЗ рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рд▓рд┐рдП рд╕рднреА рдЪрд░ (рдорд╛рдкрджрдВрдбреЛрдВ) рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВрдЧреЗред </li></ul><br><p>  рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рджреЛ рдлрд╛рдЗрд▓реЗрдВ рд╣реИрдВ: </p><br><ul><li>  <strong>рд╡рд╛рддрд╛рд╡рд░рдг / base.libsonnet</strong> - рдЗрд╕рдореЗрдВ рд╕рднреА рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рдкреИрд░рд╛рдореАрдЯрд░ рд╣реЛрдВрдЧреЗ </li><li>  <strong>рд╡рд╛рддрд╛рд╡рд░рдг / default.libsonnet</strong> - рдореЗрдВ <strong>рдбрд┐рдлрд╝реЙрд▓реНрдЯ</strong> рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдУрд╡рд░рд░рд╛рдЗрдб рдкреИрд░рд╛рдореАрдЯрд░ рд╣реИрдВ </li></ul><br><p>  рдЪрд▓реЛ <strong>рд╡рд╛рддрд╛рд╡рд░рдг</strong> рдЦреЛрд▓реЗрдВ <strong>/ base.libsonnet</strong> рдФрд░ рд╣рдорд╛рд░реЗ рдкрд╣рд▓реЗ рдШрдЯрдХ рдХреЗ рд▓рд┐рдП рдкреИрд░рд╛рдореАрдЯрд░ рдЬреЛрдбрд╝реЗрдВ: </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">website</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'example-docs'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/website:v0.0.1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">ingressClass</span></span>: <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'docs.example.org'</span></span>, }, }, }</code> </pre> <br><p>  рд╣рдо рдЕрдкрдиреЗ рдкрд╣рд▓реЗ рдХрдВрдкреЛрдиреЗрдВрдЯ <strong>рдХрдВрдкреЛрдиреЗрдВрдЯреНрд╕ / рд╡реЗрдмрд╕рд╛рдЗрдЯ.jsonnet</strong> рднреА рдмрдирд╛рдПрдВрдЧреЗ: </p><br><pre> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.website; [ { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'apps/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Deployment'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: params.replicas, <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: { <span class="hljs-attr"><span class="hljs-attr">matchLabels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, }, <span class="hljs-attr"><span class="hljs-attr">template</span></span>: { <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">containers</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'darkhttpd'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: params.image, <span class="hljs-attr"><span class="hljs-attr">ports</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: params.containerPort, }, ], }, ], <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: params.nodeSelector, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: params.tolerations, <span class="hljs-attr"><span class="hljs-attr">imagePullSecrets</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'regsecret'</span></span> }], }, }, }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Service'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">ports</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">port</span></span>: params.servicePort, <span class="hljs-attr"><span class="hljs-attr">targetPort</span></span>: params.containerPort, }, ], }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'extensions/v1beta1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Ingress'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">annotations</span></span>: { <span class="hljs-string"><span class="hljs-string">'kubernetes.io/ingress.class'</span></span>: params.ingressClass, }, <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: params.domain, <span class="hljs-attr"><span class="hljs-attr">http</span></span>: { <span class="hljs-attr"><span class="hljs-attr">paths</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">backend</span></span>: { <span class="hljs-attr"><span class="hljs-attr">serviceName</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: params.servicePort, }, }, ], }, }, ], }, }, ]</code> </pre> <br><p>  рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╣рдордиреЗ рддреБрд░рдВрдд рддреАрди рдХреБрдмреЗрд░рдиреЗрдЯ рд╕рдВрд╕реНрдерд╛рдУрдВ рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛, рдпреЗ рд╣реИрдВ: <strong>рддреИрдирд╛рддреА</strong> , <strong>рд╕реЗрд╡рд╛</strong> рдФрд░ <strong>рдкреНрд░рдЧрддрд┐</strong> ред  рдпрджрд┐ рд╡рд╛рдВрдЫрд┐рдд рд╣реИ, рддреЛ рд╣рдо рдЙрдиреНрд╣реЗрдВ рд╡рд┐рднрд┐рдиреНрди рдШрдЯрдХреЛрдВ рдореЗрдВ рд▓реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЗрд╕ рд╕реНрддрд░ рдкрд░, рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред </p><br><p>  <strong>Jsonnet</strong> рд╕рд┐рдВрдЯреИрдХреНрд╕ рдирд┐рдпрдорд┐рдд json рдХреЗ рд╕рдорд╛рди рд╣реЛрддрд╛ рд╣реИ, рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ json рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдорд╛рдиреНрдп jsonnet рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рдЖрдкрдХреЗ рд╕рд╛рдорд╛рдиреНрдп yaml рдХреЛ json рдореЗрдВ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП <strong>yaml2json</strong> рдЬреИрд╕реА рдСрдирд▓рд╛рдЗрди рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ рдпрджрд┐ рдЖрдкрдХреЗ рдШрдЯрдХреЛрдВ рдореЗрдВ рдХреЛрдИ рдЪрд░ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЙрдиреНрд╣реЗрдВ рд╕рд╛рдзрд╛рд░рдг рдпрдо рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </p><br><blockquote>  <strong>Jsonnet рдХреЗ</strong> рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ <strong>рд╕рдордп, рдореИрдВ</strong> рдЖрдкрдХреЗ рд╕рдВрдкрд╛рджрдХ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд▓рдЧрдЗрди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрддреНрдпрдзрд┐рдХ рд╕рд▓рд╛рд╣ рджреЗрддрд╛ <strong>рд╣реВрдВ</strong> <br><br>  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, vim рдХреЗ рд▓рд┐рдП рдПрдХ <strong>vim-jsonnet рдкреНрд▓рдЧрдЗрди рд╣реИ</strong> рдЬреЛ рд╕рд┐рдВрдЯреИрдХреНрд╕ рд╣рд╛рдЗрд▓рд╛рдЗрдЯрд┐рдВрдЧ рдХреЛ рдЪрд╛рд▓реВ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рд╣реЗрдЬреЗ рдЬрд╛рдиреЗ рдкрд░ рдкреНрд░рддреНрдпреЗрдХ рдмрд╛рд░ <strong>jsonnet fmt рдХреЛ</strong> рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдХрд░рддрд╛ рд╣реИ (рдЗрд╕реЗ jsonnet рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ)ред </blockquote><p>  рд╕рдм рдХреБрдЫ рддреИрдпрд╛рд░ рд╣реИ, рдЕрдм рд╣рдо рддреИрдирд╛рддреА рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><p>  рдХреНрдпрд╛ рд╣реБрдЖ, рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдо рдХрд░реЗрдВрдЧреЗ: </p><br><pre> <code class="bash hljs">qbec show default</code> </pre> <br><p>  рдЖрдЙрдЯрдкреБрдЯ рдкрд░, рдЖрдк рд░реЗрдВрдбрд░ рдХрд┐рдП рдЧрдП рдпрдо рдореИрдирд┐рдлрд╝реЗрд╕реНрдЯ рджреЗрдЦреЗрдВрдЧреЗ рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХреНрд▓рд╕реНрдЯрд░ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрдЧрд╛ред </p><br><p>  рдареАрдХ рд╣реИ, рдЕрдм рдЖрд╡реЗрджрди рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs">qbec apply default</code> </pre> <br><p>  рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдкрд░, рдЖрдк рд╣рдореЗрд╢рд╛ рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рдЖрдкрдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдХреНрдпрд╛ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдХреНрдпреВрдмреЗрдХ рдЖрдкрдХреЛ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣реЗрдЧрд╛, <strong>рд╡рд╛рдИ</strong> рдЯрд╛рдЗрдк рдХрд░рдХреЗ рдЖрдк рдЕрдкрдиреЗ рдЗрд░рд╛рджреЛрдВ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  рд╣реЛ рдЧрдпрд╛, рдЕрдм рд╣рдорд╛рд░рд╛ рдЖрд╡реЗрджрди рдбреЙрдХ рд╣реЛ рдЧрдпрд╛ рд╣реИ! </p><br><p>  рдпрджрд┐ рдЖрдк рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рд╣рдореЗрд╢рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">qbec diff default</code> </pre> <br><p>  рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдпреЗ рдкрд░рд┐рд╡рд░реНрддрди рд╡рд░реНрддрдорд╛рди рддреИрдирд╛рддреА рдХреЛ рдХреИрд╕реЗ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░реЗрдВрдЧреЗ </p><br><p>  рд╣рдорд╛рд░реЗ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордд рднреВрд▓рдирд╛: </p><br><pre> <code class="plaintext hljs">cd ../.. git add deploy/website git commit -m "Add deploy for website"</code> </pre> <br><hr><br><h1 id="5-probuem-gitlab-runner-s-kubernetes-executoranchorgitlab-runneranchor">  5. рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕-рдирд┐рд╖реНрдкрд╛рджрдХ рдХреЗ рд╕рд╛рде рдЧрд┐рдЯрд▓рдм-рд░рдирд░ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛ <a name="gitlab-runner"></a></h1><br><p>  рдХреБрдЫ рд╕рдордп рдкрд╣рд▓реЗ рддрдХ, рдореИрдВ рдПрдХ рдкреВрд░реНрд╡-рддреИрдпрд╛рд░ рдорд╢реАрди (рдПрд▓рдПрдХреНрд╕рд╕реА рдХрдВрдЯреЗрдирд░) рдкрд░ рд╢реЗрд▓ рдпрд╛ <strong>рдбреЙрдХ-рдПрдЧреНрдЬрд╝рд┐рдХреНрдпреВрдЯрд░ рдХреЗ рд╕рд╛рде</strong> рдХреЗрд╡рд▓ рд╕рд╛рдорд╛рдиреНрдп <strong>рдЧрд┐рдЯрд▓реИрдм-рд░рдирд░ рдХрд╛ рдЙрдкрдпреЛрдЧ</strong> рдХрд░рддрд╛ рдерд╛ред  рдкреНрд░рд╛рд░рдВрдн рдореЗрдВ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдХрдИ рдРрд╕реЗ рдзрд╛рд╡рдХ рдереЗ рдЬреЛ рд╡рд┐рд╢реНрд╡ рд╕реНрддрд░ рдкрд░ рд╣рдорд╛рд░реЗ рд╣рд┐рдЯрд▓реИрдм рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдереЗред  рдЙрдиреНрд╣реЛрдВрдиреЗ рд╕рднреА рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдбреЙрдХрдЯрд░ рдЪрд┐рддреНрд░ рдПрдХрддреНрд░ рдХрд┐рдПред </p><br><p>  рд▓реЗрдХрд┐рди рдЬреИрд╕рд╛ рдХрд┐ рдЕрднреНрдпрд╛рд╕ рд╕реЗ рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ, рдпрд╣ рд╡рд┐рдХрд▓реНрдк рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХрддрд╛ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ, рд╕рдмрд╕реЗ рдЖрджрд░реНрд╢ рдирд╣реАрдВ рд╣реИред  рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдФрд░ рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдЕрд▓рдЧ-рдЕрд▓рдЧ рдзрд╛рд╡рдХреЛрдВ рдХреЛ рддреИрдирд╛рдд рдХрд░рдирд╛ рдмреЗрд╣рддрд░ рдФрд░ рд╡реИрдЪрд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ рдЕрдзрд┐рдХ рд╕рд╣реА рд╣реИред </p><br><p>  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рдпрд╣ рдмрд┐рд▓реНрдХреБрд▓ рднреА рд╕рдорд╕реНрдпрд╛ рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЕрдм рд╣рдо рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд░реВрдк рдореЗрдВ <strong>рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреЛ</strong> рд╕реАрдзреЗ <strong>рдЧреАрддрд╛рд▓рд╛рдм-рдзрд╛рд╡рдХ</strong> рддреИрдирд╛рдд рдХрд░реЗрдВрдЧреЗред </p><br><p>  Gitlab рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ gitlab-runner рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реЗрд▓рдо рдЪрд╛рд░реНрдЯ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдЖрдкрдХреЛ рдмрд╕ рдЗрддрдирд╛ рдХрд░рдирд╛ рд╣реИ рдХрд┐ <strong>рд╕реЗрдЯрд┐рдВрдЧ</strong> рдореЗрдВ рд╣рдорд╛рд░реЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП <strong>рдкрдВрдЬреАрдХрд░рдг рдЯреЛрдХрди</strong> рдкрддрд╛ рдХрд░реЗрдВ <strong>-&gt; CI / CD -&gt; рдзрд╛рд╡рдХ</strong> рдФрд░ рдЗрд╕реЗ рдкрд╛рд╕ рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs">helm repo add gitlab https://charts.gitlab.io helm install gitlab-runner \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gitlabUrl=https://gitlab.com \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> runnerRegistrationToken=yga8y-jdCusVDn_t4Wxc \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rbac.create=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ gitlab/gitlab-runner</code> </pre> <br><p>  рдЬрд╣рд╛рдВ: </p><br><ul><li>  <strong><a href="https://gitlab.com/" rel="nofollow">https://gitlab.com</a></strong> рдЖрдкрдХреЗ Gitlab рд╕рд░реНрд╡рд░ рдХрд╛ рдкрддрд╛ рд╣реИред </li><li>  <strong>yga8y-jdCusVDn_t4Wxc</strong> - рдЖрдкрдХреЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдкрдВрдЬреАрдХрд░рдг рдЯреЛрдХрдиред </li><li>  <strong>rbac.create = true</strong> - рдзрд╛рд╡рдХ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕-рдирд┐рд╖реНрдкрд╛рджрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдорд╛рд░реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреЙрдбреНрд╕ рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреА рд╕рдВрдЦреНрдпрд╛ рджреЗрддрд╛ рд╣реИред </li></ul><br><p>  рдпрджрд┐ рд╕рдм рдХреБрдЫ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреА рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдореЗрдВ, <strong>рдзрд╛рд╡рдХ</strong> рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рдзрд╛рд╡рдХ рдХреЛ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><div class="spoiler">  <b class="spoiler_title">рдЬреЛрдбрд╝рд╛ рдзрд╛рд╡рдХ рдХрд╛ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/at/lx/g_/atlxg_u6rjn4n0pkcpn8--2gare.png"></p></div></div><br><p>  рдХреНрдпрд╛ рдпрд╣ рдЗрддрдирд╛ рдЖрд╕рд╛рди рд╣реИ?  - рд╣рд╛рдБ, рдЗрддрдирд╛ рдЖрд╕рд╛рди!  рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдкрдВрдЬреАрдХреГрдд рдзрд╛рд╡рдХреЛрдВ рдХреЗ рд╕рд╛рде рдХреЛрдИ рдФрд░ рдкрд░реЗрд╢рд╛рдиреА рдирд╣реАрдВ рд╣реИ, рдЕрдм рд╕реЗ рдзрд╛рд╡рдХреЛрдВ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдмрдирд╛рдпрд╛ рдФрд░ рдирд╖реНрдЯ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред </p><br><hr><br><h1 id="6-deploy-helm-chartov-s-qbecanchorqbec-helmanchor">  6. QBEC рдХреЗ рд╕рд╛рде рд╣реЗрд▓рдо рдЪрд╛рд░реНрдЯ рдХреА рддреИрдирд╛рддреА <a name="qbec-helm"></a></h1><br><p>  рдЪреВрдВрдХрд┐ рд╣рдордиреЗ рдЕрдкрдиреЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЗ <strong>рдЧрд┐рдЯрд▓реИрдм-рд░рдирд░</strong> рднрд╛рдЧ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдЧрд┐рдЯ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ рдЗрд╕рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИред </p><br><p>  рд╣рдо рдЗрд╕реЗ <strong>рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ</strong> рдПрдХ рдЕрд▓рдЧ рдШрдЯрдХ рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рднрд╡рд┐рд╖реНрдп рдореЗрдВ рд╣рдо <strong>рд╡реЗрдмрд╕рд╛рдЗрдЯ</strong> рдХреА рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкреНрд░рддрд┐рдпреЛрдВ рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреА рдпреЛрдЬрдирд╛ рдмрдирд╛ рд░рд╣реЗ рд╣реИрдВ, рдЕрдХреНрд╕рд░ <strong>рдЧрд┐рдЯрд▓рдм-рд░рдирд░ рдХреЗ</strong> рд╡рд┐рдкрд░реАрдд, рдЬрд┐рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдХреБрдмреЗрд░рдиреЗрдЯ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдПрдХ рдмрд╛рд░ рддреИрдирд╛рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рддреЛ рдЪрд▓рд┐рдП рдЗрд╕рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy qbec init gitlab-runner <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> gitlab-runner</code> </pre> <br><p>  рдЗрд╕ рдмрд╛рд░ рд╣рдо рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рд╕рдВрд╕реНрдерд╛рдУрдВ рдХрд╛ рд╡рд░реНрдгрди рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рддреИрдпрд╛рд░ рд╣реЗрд▓рдо рдЪрд╛рд░реНрдЯ рд▓реЗрдВред  рдХреНрдпреВрдмреЗрдХ рдХреЗ рдлрд╛рдпрджреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реЗрд▓рд┐рдд рдЪрд╛рд░реНрдЯ рдХреЛ рд╕реАрдзреЗ рдЧрд┐рдЯ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рд╕реЗ рд░реЗрдВрдбрд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИред </p><br><p>  рдЖрдЗрдП рдЗрд╕реЗ рдЧрд┐рдЯ рд╕рдмрдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд▓рдЧ рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs">git submodule add https://gitlab.com/gitlab-org/charts/gitlab-runner vendor/gitlab-runner</code> </pre> <br><p>  рдЕрдм <strong>рд╡реЗрдВрдбрд░ / рдЧрд┐рдЯреНрд▓рд╛рдм-рд░рдирд░</strong> рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдЧрд┐рдЯрд▓реИрдм-рд░рдирд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдЪрд╛рд░реНрдЯ рдХреЗ рд╕рд╛рде рд╣рдорд╛рд░реА рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рд╣реИред </p><br><blockquote>  рдЗрд╕реА рддрд░рд╣, рдЖрдк рдЕрдиреНрдп рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЛ рдХрдиреЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдЪрд╛рд░реНрдЯ рдХреЗ рд╕рд╛рде рд╕рдВрдкреВрд░реНрдг рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА <strong><a href="https://github.com/helm/charts" rel="nofollow">https://github.com/helm/charts</a></strong> </blockquote><p>  рдЖрдЗрдП <strong>рдШрдЯрдХреЛрдВ</strong> рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ <strong>/ gitlab-runner.jsonnet рдШрдЯрдХ</strong> : </p><br><pre> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.gitlabRunner; std.native(<span class="hljs-string"><span class="hljs-string">'expandHelmTemplate'</span></span>)( <span class="hljs-string"><span class="hljs-string">'../vendor/gitlab-runner'</span></span>, params.values, { <span class="hljs-attr"><span class="hljs-attr">nameTemplate</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: env.namespace, <span class="hljs-attr"><span class="hljs-attr">thisFile</span></span>: std.thisFile, <span class="hljs-attr"><span class="hljs-attr">verbose</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, } )</code> </pre> <br><p>  рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓рд╛ <strong>рддрд░реНрдХрд╣реЗрд▓реНрдореЗрдЯрдкреНрд▓реЗрдЯ</strong> рд╣рдо рдЪрд╛рд░реНрдЯ рдХреЗ рд▓рд┐рдП рд░рд╛рд╕реНрддрд╛ рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рдлрд┐рд░ <strong>params.values</strong> , рдЬрд┐рд╕реЗ рд╣рдо рдкрд░реНрдпрд╛рд╡рд░рдг рдорд╛рдкрджрдВрдбреЛрдВ рд╕реЗ рд▓реЗрддреЗ рд╣реИрдВ, рдлрд┐рд░ рдПрдХ рд╡рд╕реНрддреБ рдХреЗ рд╕рд╛рде </p><br><ul><li>  <strong>nameTemplate</strong> - рд░рд┐рд▓реАрдЬрд╝ рдирд╛рдо </li><li>  <strong>namespace</strong> - namespace рдиреЗ helm рдХреЛ рдкрд╛рд╕ рдХрд┐рдпрд╛ </li><li>  <strong>рдпрд╣ рдлрд╝рд╛рдЗрд▓</strong> - рдЖрд╡рд╢реНрдпрдХ рдкреИрд░рд╛рдореАрдЯрд░ рд╡рд░реНрддрдорд╛рди рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдкрде рдЧреБрдЬрд░ рд░рд╣рд╛ рд╣реИ </li><li>  <strong>рд╡рд░реНрдмреЛрдЬрд╝</strong> - рдЪрд╛рд░реНрдЯ рдХреЛ рдкреНрд░рд╕реНрддреБрдд рдХрд░рддреЗ рд╕рдордп рд╕рднреА рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде <strong>рдкрддрд╡рд╛рд░ рдЯреЗрдореНрдкрд▓реЗрдЯ</strong> рдХрдорд╛рдВрдб рджрд┐рдЦрд╛рддрд╛ рд╣реИ </li></ul><br><p>  рдЕрдм рд╣рдо <strong>рд╡рд╛рддрд╛рд╡рд░рдг / рдмреЗрд╕</strong> рдореЗрдВ рд╣рдорд╛рд░реЗ рдШрдЯрдХ рдХреЗ рдорд╛рдкрджрдВрдбреЛрдВ рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВрдЧреЗред </p><br><pre> <code class="javascript hljs">local secrets = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../secrets/base.libsonnet'</span></span>; { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabRunner</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner'</span></span>, <span class="hljs-attr"><span class="hljs-attr">values</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'https://gitlab.com/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: secrets.runnerRegistrationToken, }, }, }, }</code> </pre> <br><p>  <strong>RunnerRegistrationToken рдкрд░</strong> рдзреНрдпрд╛рди <strong>рджреЗрдВ,</strong> рд╣рдо рдмрд╛рд╣рд░реА <strong>рд░рд╣рд╕реНрдпреЛрдВ / рдЖрдзрд╛рд░.рд▓рд┐рдмреНрд╕рдирдиреЗрдЯ рдлрд╝рд╛рдЗрд▓ рд╕реЗ рд▓реЗрддреЗ рд╣реИрдВ</strong> , рдЖрдЗрдП рдЗрд╕реЗ рдмрдирд╛рдПрдБ: </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: <span class="hljs-string"><span class="hljs-string">'yga8y-jdCusVDn_t4Wxc'</span></span>, }</code> </pre> <br><p>  рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рд╕рдм рдХреБрдЫ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="bash hljs">qbec show default</code> </pre> <br><p>  рдпрджрд┐ рд╕рдм рдХреБрдЫ рдХреНрд░рдо рдореЗрдВ рд╣реИ, рддреЛ рд╣рдо рдЕрдкрдиреЗ рдкрд╣рд▓реЗ рд░рд┐рд▓реАрдЬ рдХреЛ рд╣реЗрд▓реНрдо рд░рд┐рд▓реАрдЬ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">helm uninstall gitlab-runner</code> </pre> <br><p>  рдФрд░ рдЗрд╕реЗ рддреИрдирд╛рдд рдХрд░реЗрдВ, рд▓реЗрдХрд┐рди рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХреНрдпреВрдмреЗрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ: </p><br><pre> <code class="bash hljs">qbec apply default</code> </pre> <br><hr><br><h1 id="7-znakomstvo-s-git-cryptanchorgit-cryptanchor">  7. рдЧрд┐рдЯ-рдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдкрд░рд┐рдЪрдп <a name="git-crypt"></a></h1><br><p>  <strong><a href="https://github.com/AGWA/git-crypt" rel="nofollow">рдЧрд┐рдЯ-рдХреНрд░рд┐рдкреНрдЯ</a></strong> рдПрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЗ рд▓рд┐рдП рдкрд╛рд░рджрд░реНрд╢реА рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рд╕реЗрдЯ рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИред </p><br><p>  рдлрд┐рд▓рд╣рд╛рд▓, рдЧрд┐рдЯрд▓реИрдм-рд░рдирд░ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рд╕рдВрд░рдЪрдирд╛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ: </p><br><pre> <code class="plaintext hljs">. тФЬтФАтФА components тФВ  тФЬтФАтФА gitlab-runner.jsonnet тФЬтФАтФА environments тФВ  тФЬтФАтФА base.libsonnet тФВ  тФФтФАтФА default.libsonnet тФЬтФАтФА params.libsonnet тФЬтФАтФА qbec.yaml тФЬтФАтФА secrets тФВ  тФФтФАтФА base.libsonnet тФФтФАтФА vendor тФФтФАтФА gitlab-runner (submodule)</code> </pre> <br><p>  рд▓реЗрдХрд┐рди Git рдореЗрдВ рд░рд╣рд╕реНрдп рд░рдЦрдирд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИ, рд╣реИ рдирд╛?  рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдЙрдиреНрд╣реЗрдВ рдареАрдХ рд╕реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><blockquote>  рдЖрдорддреМрд░ рдкрд░ рдПрдХрд▓ рдЪрд░ рдХреЗ рд▓рд┐рдП рдпрд╣ рд╣рдореЗрд╢рд╛ рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖрддрд╛ рд╣реИред  рдЖрдк <strong>рдХреНрдпреВрдмреЗрдХ</strong> рдФрд░ рдЕрдкрдиреЗ рд╕реАрдЖрдИ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд░рд╣рд╕реНрдпреЛрдВ рдХреЛ рдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br>  рд▓реЗрдХрд┐рди рдпрд╣ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рдкрд░рд┐рдпреЛрдЬрдирд╛рдПрдВ рд╣реИрдВ рдЬрд┐рдирдореЗрдВ рдмрд╣реБрдд рдЕрдзрд┐рдХ рд░рд╣рд╕реНрдп рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрди рд╕рднреА рдХреЛ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдирд╛ рдмреЗрд╣рдж рдореБрд╢реНрдХрд┐рд▓ рд╣реЛрдЧрд╛ред <br><br>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдореИрдВ рдЖрдкрдХреЛ <strong>рдЧрд┐рдЯ-рдХреНрд░рд┐рдкреНрдЯ</strong> рдЬреИрд╕реЗ рдЕрджреНрднреБрдд рдЙрдкрдХрд░рдг рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдирд╣реАрдВ рдмрддрд╛ рдкрд╛рдКрдВрдЧрд╛ред <br><br>  <strong>рдЧрд┐рдЯ-рдХреНрд░рд┐рдкреНрдЯ</strong> рднреА рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдкрдХреЛ рд░рд╣рд╕реНрдпреЛрдВ рдХреЗ рдкреВрд░реЗ рдЗрддрд┐рд╣рд╛рд╕ рдХреЛ рд╕рд╣реЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рд╛рде рд╣реА рд╕рд╛рде рдЯрдХрд░рд╛рд╡ рдХреА рддреБрд▓рдирд╛, рд╡рд┐рд▓рдп рдФрд░ рд╕рдорд╛рдзрд╛рди рдЙрд╕реА рддрд░рд╣ рд╕реЗ рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ рд╣рдо рдЧрд┐рдЯ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдХрд░рддреЗ рдереЗред </blockquote><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, <strong>рдЧрд┐рдЯ-рдХреНрд░рд┐рдкреНрдЯ</strong> рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж <strong>,</strong> рд╣рдореЗрдВ рдЕрдкрдиреА рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЗ рд▓рд┐рдП рдХреБрдВрдЬреА рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: </p><br><pre> <code class="plaintext hljs">git crypt init</code> </pre> <br><p>  рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ PGP рдХреБрдВрдЬреА рд╣реИ, рддреЛ рдЖрдк рддреБрд░рдВрдд рдЗрд╕ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд▓рд┐рдП рд╕рд╣рдпреЛрдЧреА рдХреЗ рд░реВрдк рдореЗрдВ рдЦреБрдж рдХреЛ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="plaintext hljs">git-crypt add-gpg-user kvapss@gmail.com</code> </pre> <br><p>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдЖрдк рд╣рдореЗрд╢рд╛ рдЕрдкрдиреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рднрдВрдбрд╛рд░ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ PGP рдХреБрдВрдЬреА рдирд╣реАрдВ рд╣реИ рдФрд░ рдЖрдк рдЕрдкреЗрдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИрдВ, рддреЛ рдЖрдк рджреВрд╕рд░реЗ рддрд░реАрдХреЗ рд╕реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреА рдХреБрдВрдЬреА рдирд┐рд░реНрдпрд╛рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="plaintext hljs">git crypt export-key /path/to/keyfile</code> </pre> <br><p>  рдЗрд╕ рддрд░рд╣, рдПрдХ рдирд┐рд░реНрдпрд╛рдд <strong>рдХреБрдВрдЬреА рдХреЗ</strong> рд╕рд╛рде рдХреЛрдИ рднреА рдЖрдкрдХреЗ рднрдВрдбрд╛рд░ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХреЗрдЧрд╛ред </p><br><p>  рдпрд╣ рд╣рдорд╛рд░реЗ рдкрд╣рд▓реЗ рд░рд╣рд╕реНрдп рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИред <br>  рдореИрдВ рдЖрдкрдХреЛ рдпрд╛рдж рджрд┐рд▓рд╛рддрд╛ рд╣реВрдВ рдХрд┐ рд╣рдо рдЕрднреА рднреА <strong>рддреИрдирд╛рдд / gitlab-runner /</strong> рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╣реИрдВ, рдЬрд╣рд╛рдВ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ <strong>рд░рд╣рд╕реНрдп /</strong> рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╣реИрдВ, рдЪрд▓реЛ рдЗрд╕рдореЗрдВ рд╕рднреА рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рдХреЗ рд▓рд┐рдП рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде <strong>рд░рд╣рд╕реНрдп / .itattributes рдлрд╝рд╛рдЗрд▓</strong> рдмрдирд╛рддреЗ рд╣реИрдВ: </p><br><pre> <code class="plaintext hljs">* filter=git-crypt diff=git-crypt .gitattributes !filter !diff</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рд╕рд╛рдордЧреНрд░реА рд╕реЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдирдХрд╛рдм <strong>*</strong> рджреНрд╡рд╛рд░рд╛ рд╕рднреА рдлрд╛рдЗрд▓реЗрдВ <strong>рдЧреАрддрд╛</strong> <strong>-рдХреНрд░рд┐рдкреНрдЯ рдХреЗ</strong> рдорд╛рдзреНрдпрдо рд╕реЗ <strong>рдЪрд▓реЗрдВрдЧреАред</strong> </p><br><p>  рд╣рдо рдЗрд╕реЗ рдЪрд▓рд╛рдХрд░ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">git crypt status -e</code> </pre> <br><p>  рдЖрдЙрдЯрдкреБрдЯ рдкрд░, рд╣рдореЗрдВ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ рд╕рднреА рдлрд╛рдЗрд▓реЛрдВ рдХреА рдПрдХ рд╕реВрдЪреА рдорд┐рд▓рддреА рд╣реИ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рд╕рдХреНрд╖рдо рд╣реИ </p><br><p>  рдмрд╕, рдЕрдм рд╣рдо рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЕрдкрдиреЗ рдмрджрд▓рд╛рд╡ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../.. git add . git commit -m <span class="hljs-string"><span class="hljs-string">"Add deploy for gitlab-runner"</span></span></code> </pre> <br><p>  рднрдВрдбрд╛рд░ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs">git crypt lock</code> </pre> <br><p>  рдФрд░ рдлрд┐рд░ рд╕рднреА рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╛рдЗрд▓реЗрдВ рдПрдХ рдмрд╛рдЗрдирд░реА рдореЗрдВ рдмрджрд▓ рдЬрд╛рддреА рд╣реИрдВ, рдЙрдиреНрд╣реЗрдВ рдкрдврд╝рдирд╛ рдЕрд╕рдВрднрд╡ рд╣реЛрдЧрд╛ред <br>  рдПрдХ рднрдВрдбрд╛рд░ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs">git crypt unlock</code> </pre> <br><hr><br><h1 id="8-sozdayom-toolbox-obrazanchortoolboxanchor">  8. рдПрдХ рдЯреВрд▓рдмреЙрдХреНрд╕ рдЫрд╡рд┐ рдмрдирд╛рдПрдВ <a name="toolbox"></a></h1><br><p>  рдПрдХ рдЯреВрд▓рдмреЙрдХреНрд╕ рдЫрд╡рд┐ рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдРрд╕реА рдЫрд╡рд┐ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдо рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░реЗрдВрдЧреЗред  рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ gitlab рдзрд╛рд╡рдХ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкрд░рд┐рдирд┐рдпреЛрдЬрди рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред </p><br><p>  рдпрд╣рд╛рдВ рд╕рдм рдХреБрдЫ рд╕рд░рд▓ рд╣реИ, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде рдПрдХ рдирдпрд╛ <strong>рдбреЙрдХрдлрд╛рдЗрд▓реНрд╕ / рдЯреВрд▓рдмреЙрдХреНрд╕ / рдбреЙрдХрдлреЗрд░рд╛рдЗрд▓ рдмрдирд╛рддреЗ рд╣реИрдВ</strong> : </p><br><pre> <code class="bash hljs">FROM alpine:3.11 RUN apk add --no-cache git git-crypt RUN QBEC_VER=0.10.3 \ &amp;&amp; wget -O- https://github.com/splunk/qbec/releases/download/v<span class="hljs-variable"><span class="hljs-variable">${QBEC_VER}</span></span>/qbec-linux-amd64.tar.gz \ | tar -C /tmp -xzf - \ &amp;&amp; mv /tmp/qbec /tmp/jsonnet-qbec /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/ RUN KUBECTL_VER=1.17.0 \ &amp;&amp; wget -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/kubectl \ https://storage.googleapis.com/kubernetes-release/release/v<span class="hljs-variable"><span class="hljs-variable">${KUBECTL_VER}</span></span>/bin/linux/amd64/kubectl \ &amp;&amp; chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/kubectl RUN HELM_VER=3.0.2 \ &amp;&amp; wget -O- https://get.helm.sh/helm-v<span class="hljs-variable"><span class="hljs-variable">${HELM_VER}</span></span>-linux-amd64.tar.gz \ | tar -C /tmp -zxf - \ &amp;&amp; mv /tmp/linux-amd64/helm /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/helm</code> </pre> <br><p>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕ рдЫрд╡рд┐ рдореЗрдВ рд╣рдо рдЙрди рд╕рднреА рдЙрдкрдпреЛрдЧрд┐рддрд╛рдУрдВ рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рд╣рдо рдЕрдкрдиреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рдереЗред  рд╣рдореЗрдВ <strong>рдпрд╣рд╛рдВ рдХреБрдмреНрдЬрддрд╛ рдХреА</strong> рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ <strong>рд╣реИ</strong> , рд▓реЗрдХрд┐рди рдЖрдк рдЗрд╕реЗ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рд╕реЗрдЯрдЕрдк рдЪрд░рдг рдореЗрдВ рдЦреЗрд▓рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред </p><br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдФрд░ рдЗрд╕рдореЗрдВ рдПрдХ рдкреНрд░рджрд░реНрд╢рди рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдЧрд┐рдЯрд▓реИрдм-рд░рдирд░ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдлрд▓реА рдХреЗ рд▓рд┐рдП рднреВрдорд┐рдХрд╛ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><p>  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, gitlab-runner рдХреЗ рд╕рд╛рде рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдкрд░ рдЬрд╛рдПрдВ: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy/gitlab-runner</code> </pre> <br><p>  рдФрд░ рдПрдХ рдирдпрд╛ рдШрдЯрдХ <strong>рдШрдЯрдХ</strong> рдЬреЛрдбрд╝реЗрдВ <strong>/ rbac.jsonnet</strong> : </p><br><pre> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.rbac; [ { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'ServiceAccount'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Role'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">apiGroups</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], <span class="hljs-attr"><span class="hljs-attr">resources</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], <span class="hljs-attr"><span class="hljs-attr">verbs</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], }, ], }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'RoleBinding'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">roleRef</span></span>: { <span class="hljs-attr"><span class="hljs-attr">apiGroup</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Role'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">subjects</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'ServiceAccount'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: env.namespace, }, ], }, ]</code> </pre> <br><p>  рд╣рдо <strong>рд╡рд╛рддрд╛рд╡рд░рдг / base.libsonnet</strong> рдореЗрдВ рдирдП рдорд╛рдкрджрдВрдбреЛрдВ рдХрд╛ рднреА рд╡рд░реНрдгрди рдХрд░реЗрдВрдЧреЗ, рдЬреЛ рдЕрдм рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="javascript hljs">local secrets = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../secrets/base.libsonnet'</span></span>; { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabRunner</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner'</span></span>, <span class="hljs-attr"><span class="hljs-attr">values</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'https://gitlab.com/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: secrets.runnerRegistrationToken, <span class="hljs-attr"><span class="hljs-attr">runners</span></span>: { <span class="hljs-attr"><span class="hljs-attr">serviceAccountName</span></span>: $.components.rbac.name, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/toolbox:v0.0.1'</span></span>, }, }, }, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner-deploy'</span></span>, }, }, }</code> </pre> <br><p>  рдиреЛрдЯ <strong>$</strong> <strong>.compitters.rbac.name rbac</strong> рдШрдЯрдХ рдХрд╛ <strong>рдирд╛рдо</strong> <strong>рдмрддрд╛рддрд╛</strong> рд╣реИ </p><br><p>  рдЖрдЗрдП рджреЗрдЦреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдмрджрд▓ рдЧрдпрд╛ рд╣реИ: </p><br><pre> <code class="bash hljs">qbec diff default</code> </pre> <br><p>  рдФрд░ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рд╣рдорд╛рд░реЗ рдкрд░рд┐рд╡рд░реНрддрди рд▓рд╛рдЧреВ рдХрд░реЗрдВ: </p><br><pre> <code class="bash hljs">qbec apply default</code> </pre> <br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ рд╣рдорд╛рд░реЗ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдмрджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордд рднреВрд▓рдирд╛: </p><br><pre> <code class="plaintext hljs">cd ../.. git add dockerfiles/toolbox git commit -m "Add Dockerfile for toolbox" git add deploy/gitlab-runner git commit -m "Configure gitlab-runner to use toolbox"</code> </pre> <br><hr><br><h1 id="9-nash-pervyy-payplayn-i-sborka-obrazov-po-tegamanchorpipeline-buildanchor">  9. рдЯреИрдЧреНрд╕ рджреНрд╡рд╛рд░рд╛ рд╣рдорд╛рд░реА рдкрд╣рд▓реА рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдФрд░ рдЫрд╡рд┐рдпреЛрдВ рдХреА рд╡рд┐рдзрд╛рдирд╕рднрд╛ <a name="pipeline-build"></a></h1><br><p>  рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреА рдЬрдбрд╝ рдореЗрдВ рд╣рдо рдирд┐рдореНрди рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде <strong>.itlab-ci.yml рдмрдирд╛рдПрдВрдЧреЗ</strong> : </p><br><pre> <code class="plaintext hljs">.build_docker_image: stage: build image: name: gcr.io/kaniko-project/executor:debug-v0.15.0 entrypoint: [""] before_script: - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" &gt; /kaniko/.docker/config.json build_toolbox: extends: .build_docker_image script: - /kaniko/executor --cache --context $CI_PROJECT_DIR/dockerfiles/toolbox --dockerfile $CI_PROJECT_DIR/dockerfiles/toolbox/Dockerfile --destination $CI_REGISTRY_IMAGE/toolbox:$CI_COMMIT_TAG only: refs: - tags build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_TAG only: refs: - tags</code> </pre> <br><p>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдо <strong>GIT_SUBMODULE_STRATEGY рдХрд╛</strong> рдЙрдкрдпреЛрдЧ <strong>рдХрд░рддреЗ рд╣реИрдВ:</strong> рдЙрди рдиреМрдХрд░рд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП <strong>рд╕рд╛рдорд╛рдиреНрдп</strong> рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ рдирд┐рд╖реНрдкрд╛рджрди рд╕реЗ рдкрд╣рд▓реЗ <strong>рд╕рдмрдореЙрдбреНрдпреВрд▓</strong> рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред </p><br><p>  рд╣рдорд╛рд░реЗ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордд рднреВрд▓рдирд╛: </p><br><pre> <code class="plaintext hljs">git add .gitlab-ci.yml git commit -m "Automate docker build"</code> </pre> <br><p>  рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдЖрдк рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЗрд╕реЗ рд╕рдВрд╕реНрдХрд░рдг <strong>v0.0.1</strong> рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдЯреИрдЧ рд▓рдЯрдХрд╛ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="bash hljs">git tag v0.0.1</code> </pre> <br><p>  рдЬрдм рднреА рд╣рдореЗрдВ рдирдпрд╛ рд╕рдВрд╕реНрдХрд░рдг рдЬрд╛рд░реА рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА, рд╣рдо рдЯреИрдЧ рд▓рдЯрдХрд╛ рджреЗрдВрдЧреЗред  Docker рдЫрд╡рд┐рдпреЛрдВ рдореЗрдВ рдЯреИрдЧ Git рдЯреИрдЧ рд╕реЗ рдмрдВрдзрд╛ рд╣реЛрдЧрд╛ред  рдирдП рдЯреИрдЧ рдХреЗ рд╕рд╛рде рдкреНрд░рддреНрдпреЗрдХ рдкреБрд╢ рдЗрд╕ рдЯреИрдЧ рдХреЗ рд╕рд╛рде рдЫрд╡рд┐рдпреЛрдВ рдХреА рдЕрд╕реЗрдВрдмрд▓реА рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░реЗрдЧрд╛ред </p><br><p>  <strong>Git push --tags рдЪрд▓рд╛рдПрдВ</strong> , рдФрд░ рд╣рдорд╛рд░реА рдкрд╣рд▓реА рдкрд╛рдЗрдкрд▓рд╛рдЗрди рджреЗрдЦреЗрдВ: </p><br><div class="spoiler">  <b class="spoiler_title">рдкрд╣рд▓реА рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХрд╛ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/5u/ce/fg/5ucefgejcfjz7jpwvou206mwufy.png"></p></div></div><br><blockquote>  рдпрд╣ рдЗрд╕ рддрдереНрдп рдкрд░ рдЖрдкрдХрд╛ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рдЯреИрдЧ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рдзрд╛рдирд╕рднрд╛ рдбреЙрдХ рдЫрд╡рд┐рдпреЛрдВ рдХреЛ рдЗрдХрдЯреНрдард╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рд╣реИ, рд▓реЗрдХрд┐рди рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдирд╣реАрдВ рд╣реИред  рдЪреВрдВрдХрд┐ рдирдП рдЯреИрдЧ рдХреЛ рдкреБрд░рд╛рдиреЗ рдХрдорд┐рдЯреНрд╕ рдХреЛ рднреА рд╕реМрдВрдкрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдРрд╕реЗ рдореЗрдВ рдЙрдирдХреЗ рд▓рд┐рдП рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХрд╛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди рдкреБрд░рд╛рдиреЗ рд╡рд░реНрдЬрди рдХреА рддреИрдирд╛рддреА рдХреЛ рдмрдврд╝рд╛рд╡рд╛ рджреЗрдЧрд╛ред <br><br>  рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдорддреМрд░ рдкрд░ рдбреЙрдХрдЯрд░-рдЫрд╡рд┐рдпреЛрдВ рдХреА рдЕрд╕реЗрдВрдмрд▓реА рдЯреИрдЧ рд╕реЗ рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИ, рдФрд░ <strong>рдорд╛рд╕реНрдЯрд░</strong> рд╢рд╛рдЦрд╛ рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреА рддреИрдирд╛рддреА рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдПрдХрддреНрд░рд┐рдд рдЫрд╡рд┐рдпреЛрдВ рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рд╣рд╛рд░реНрдбрдХреЛрдб рд╣реЛрддреЗ рд╣реИрдВред  рдпрд╣ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╣реИ рдХрд┐ рдЖрдк рдПрдХ рд╕рд╛рдзрд╛рд░рдг рд░рд┐рд╡рд░реНрдЯ <strong>рдорд╛рд╕реНрдЯрд░</strong> рдЯреИрдЧ рдХреЗ рд╕рд╛рде рд░реЛрд▓рдмреИрдХ рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </blockquote><br><hr><br><h1 id="10-avtomatizaciya-deployaanchorpipeline-deployanchor">  10. рддреИрдирд╛рддреА рд╕реНрд╡рдЪрд╛рд▓рди <a name="pipeline-deploy"></a></h1><br><p>  рдЕрдкрдиреЗ рд░рд╣рд╕реНрдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧрд┐рдЯрд▓реИрдм-рд░рдирд░ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреА рдХреЛ рдПрдХреНрд╕рдкреЛрд░реНрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдЗрд╕реЗ рд╣рдорд╛рд░реЗ CI рдХреЗ рдкрд░реНрдпрд╛рд╡рд░рдг рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдореЗрдВ рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛: </p><br><pre> <code class="plaintext hljs">git crypt export-key /tmp/docs-repo.key base64 -w0 /tmp/docs-repo.key; echo</code> </pre> <br><p>  Gitlab рдореЗрдВ рдкрд░рд┐рдгрд╛рдореА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рд╕рд╣реЗрдЬреЗрдВ, рдЗрд╕рдХреЗ рд▓рд┐рдП рд╣рдо рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреА рд╕реЗрдЯрд┐рдВрдЧ рдореЗрдВ рдЬрд╛рдПрдВрдЧреЗ: <br>  <strong>рд╕реЗрдЯрд┐рдВрдЧреНрд╕ -&gt; рд╕реАрдЖрдИ / рд╕реАрдбреА -&gt; рдЪрд░</strong> </p><br><p>    : </p><br><div class="scrollable-table"><table><thead><tr><th> Type </th><th> Key </th><th> Value </th><th> Protected </th><th> Masked </th><th> Scope </th></tr></thead><tbody><tr><td> <code>File</code> </td> <td> <code>GITCRYPT_KEY</code> </td> <td> <code>&lt;your string&gt;</code> </td> <td> <code>true</code> <em>(     <code>false</code> )</em> </td><td> <code>true</code> </td> <td> <code>All environments</code> </td> </tr></tbody></table></div><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/vj/li/ea/vjliealfwwsmiy4-nvjfvcf89ig.png"></p></div></div><br><p>    <strong>.gitlab-ci.yml</strong>   : </p><br><pre> <code class="plaintext hljs">.deploy_qbec_app: stage: deploy only: refs: - master deploy_gitlab_runner: extends: .deploy_qbec_app variables: GIT_SUBMODULE_STRATEGY: normal before_script: - base64 -d "$GITCRYPT_KEY" | git-crypt unlock - script: - qbec apply default --root deploy/gitlab-runner --force:k8s-context __incluster__ --wait --yes deploy_website: extends: .deploy_qbec_app script: - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes</code> </pre> <br><p>        qbec: </p><br><ul><li> <strong>--root some/app</strong> тАФ      </li><li> <strong>--force:k8s-context __incluster__</strong> тАФ   ,             gtilab-runner.   ,      qbec     Kubernetes-   kubeconfig </li><li> <strong>--wait</strong> тАФ  qbec ,        Ready       exit-code. </li><li> <strong>--yes</strong> тАФ     <strong>Are you sure?</strong>  . </li></ul><br><p>     : </p><br><pre> <code class="plaintext hljs">git add .gitlab-ci.yml git commit -m "Automate deploy"</code> </pre> <br><p>   <strong>git push</strong>       : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/0p/aj/vs/0pajvs-a-lrxvfuw8zylnj6lleg.png"></p></div></div><br><hr><br><h1 id="11-artefakty-i-sborka-pri-push-v-masteranchorartifactsanchor"> 11.     push  master <a name="artifacts"></a></h1><br><p>            ,             .           digest  master-. </p><br><p>  :    <strong>website</strong>      push  <strong>master</strong> ,       Kubernetes. </p><br><p>        <strong>.gitlab-ci.yml</strong> : </p><br><pre> <code class="plaintext hljs">build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - mkdir -p $CI_PROJECT_DIR/artifacts - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_REF_NAME --digest-file $CI_PROJECT_DIR/artifacts/website.digest artifacts: paths: - artifacts/ only: refs: - master - tags deploy_website: extends: .deploy_qbec_app script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST"</code> </pre> <br><p>  ,    <strong>master</strong>  <strong>refs</strong>   <strong>build_website</strong>     <strong>$CI_COMMIT_REF_NAME</strong>  <strong>$CI_COMMIT_TAG</strong> ,        Git           .  ,        ,           docker-registry. </p><br><p>   docker-       ,        Kubernetes,           ,         . </p><br><p>  <strong>--vm:ext-str digest="$DIGEST"</strong>  qbec тАФ      jsonnet.            .   ,     ,     ,               . </p><br><p>     Kaniko  digest    ( <strong>--digest-file</strong> ) <br>          . </p><br><p>     <strong>deploy/website/environments/base.libsonnet</strong>     : </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">website</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'example-docs'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/website@'</span></span> + std.extVar(<span class="hljs-string"><span class="hljs-string">'digest'</span></span>), <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">ingressClass</span></span>: <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'docs.example.org'</span></span>, }, }, }</code> </pre> <br><p> ,     <strong>master</strong>   docker-  <strong>website</strong> ,      Kubernetes. </p><br><p>     : </p><br><pre> <code class="bash hljs">git add . git commit -m <span class="hljs-string"><span class="hljs-string">"Configure dynamic build"</span></span></code> </pre> <br><p> ,  <strong>git push</strong>    - : </p><br><div class="spoiler"> <b class="spoiler_title">   master</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7_/ry/nh/7_rynh5lgu_8hqnnl_gasx73zwq.png"></p></div></div><br><p>       gitlab-runner   push, , ,      ,     <strong>.gitlab-ci.yml</strong> : </p><br><pre> <code class="plaintext hljs">deploy_gitlab_runner: extends: .deploy_qbec_app variables: GIT_SUBMODULE_STRATEGY: normal before_script: - base64 -d "$GITCRYPT_KEY" | git-crypt unlock - script: - qbec apply default --root deploy/gitlab-runner --force:k8s-context __incluster__ --wait --yes only: changes: - deploy/gitlab-runner/**/*</code> </pre> <br><p> <strong>changes</strong>      <strong>deploy/gitlab-runner/</strong>          </p><br><p>     : </p><br><pre> <code class="bash hljs">git add .gitlab-ci.yml git commit -m <span class="hljs-string"><span class="hljs-string">"Reduce gitlab-runner deploy"</span></span></code> </pre> <br><p> <strong>git push</strong> , - : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-t/9b/3m/-t9b3mtofbunu7xfogpmb0pacsm.png"></p></div></div><br><hr><br><h1 id="12-dynamic-environmentsanchordynamic-environmentsanchor"> 12. Dynamic environments <a name="dynamic-environments"></a></h1><br><p>       . </p><br><p>     <strong>build_website</strong>   <strong>.gitlab-ci.yml</strong> ,     <strong>only</strong> ,   Gitlab        : </p><br><pre> <code class="plaintext hljs">build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - mkdir -p $CI_PROJECT_DIR/artifacts - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_REF_NAME --digest-file $CI_PROJECT_DIR/artifacts/website.digest artifacts: paths: - artifacts/</code> </pre> <br><p>    <strong>deploy_website</strong> ,    <strong>environment</strong> : </p><br><pre> <code class="plaintext hljs">deploy_website: extends: .deploy_qbec_app environment: name: prod url: https://docs.example.org script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST"</code> </pre> <br><p>   Gitlab    <strong>prod</strong>       . </p><br><p>     : </p><br><pre> <code class="plaintext hljs">deploy_website: extends: .deploy_qbec_app environment: name: prod url: https://docs.example.org script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST" deploy_review: extends: .deploy_qbec_app environment: name: review/$CI_COMMIT_REF_NAME url: http://$CI_ENVIRONMENT_SLUG.docs.example.org on_stop: stop_review script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply review --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST" --vm:ext-str subdomain="$CI_ENVIRONMENT_SLUG" --app-tag "$CI_ENVIRONMENT_SLUG" only: refs: - branches except: refs: - master stop_review: extends: .deploy_qbec_app environment: name: review/$CI_COMMIT_REF_NAME action: stop stage: deploy before_script: - git clone "$CI_REPOSITORY_URL" master - cd master script: - qbec delete review --root deploy/website --force:k8s-context __incluster__ --yes --vm:ext-str digest="$DIGEST" --vm:ext-str subdomain="$CI_ENVIRONMENT_SLUG" --app-tag "$CI_ENVIRONMENT_SLUG" variables: GIT_STRATEGY: none only: refs: - branches except: refs: - master when: manual</code> </pre> <br><p>     push     master    preview  . </p><br><p>      qbec: <strong>--app-tag</strong> тАФ             ,       Kubernetes qbec    . <br>           review,       . </p><br><p>      <strong>qbec apply review</strong> ,  <strong>qbec apply default</strong> тАФ               (review  default): </p><br><p>  <strong>review</strong>   <strong>deploy/website/qbec.yaml</strong> </p><br><pre> <code class="plaintext hljs">spec: environments: review: defaultNamespace: docs server: https://kubernetes.example.org:8443</code> </pre> <br><p>     <strong>deploy/website/params.libsonnet</strong> : </p><br><pre> <code class="javascript hljs">local env = std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>); local paramsMap = { <span class="hljs-attr"><span class="hljs-attr">_</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/base.libsonnet'</span></span>, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/default.libsonnet'</span></span>, <span class="hljs-attr"><span class="hljs-attr">review</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/review.libsonnet'</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> std.objectHas(paramsMap, env) then paramsMap[env] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> error <span class="hljs-string"><span class="hljs-string">'environment '</span></span> + env + <span class="hljs-string"><span class="hljs-string">' not defined in '</span></span> + std.thisFile</code> </pre> <br><p>        <strong>deploy/website/environments/review.libsonnet</strong> : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// this file has the param overrides for the default environment local base = import './base.libsonnet'; local slug = std.extVar('qbec.io/tag'); local subdomain = std.extVar('subdomain'); base { components+: { website+: { name: 'example-docs-' + slug, domain: subdomain + '.docs.example.org', }, }, }</span></span></code> </pre> <br><p>       <strong>stop_review</strong> ,         gitlab    checkout    <strong>GIT_STRATEGY: none</strong> ,    <strong>master</strong> -   review  . <br>  ,        . <br>       review   ,     . </p><br><p>     : </p><br><pre> <code class="plaintext hljs">git add . git commit -m "Enable automatic review"</code> </pre> <br><p> <strong>git push</strong> , <strong>git checkout -b test</strong> , <strong>git push origin test</strong> , : </p><br><div class="spoiler"> <b class="spoiler_title">  environments  Gitlab</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/wc/pz/ce/wcpzcedcwgfqvr0h_thgcw4ylqk.png"></p></div></div><br><p>  ? тАФ ,    : <strong>git checkout master</strong> , <strong>git push origin :test</strong> ,      environment   . </p><br><blockquote>    ,        ,     <strong>.gitlab-ci.yml</strong>       . <br>          protected-,   <strong>master</strong> ,        . </blockquote><br><hr><br><h1 id="13-review-appsanchorreview-appsanchor"> 13. Review Apps <a name="review-apps"></a></h1><br><p> <strong><a href="https://docs.gitlab.com/ee/ci/review_apps/" rel="nofollow">Review Apps</a></strong>    ,                . </p><br><p>      ,    <strong>.gitlab/route-map.yml</strong>       ,       : </p><br><pre> <code class="plaintext hljs"># Indices - source: /content\/(.+?)_index\.(md|html)/ public: '\1' # Pages - source: /content\/(.+?)\.(md|html)/ public: '\1/'</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">git add .gitlab/ git commit -m "Enable review apps"</code> </pre> <br><p> <strong>git push</strong> ,  : </p><br><div class="spoiler"> <b class="spoiler_title">  Review App</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ns/wi/za/nswizajvjjozyoluazo21pzq7t8.png"></p></div></div><br><h1 id="job-is-done"> Job is done! </h1><br><p> <strong> :</strong> </p><br><ul><li>  Gitlab: <a href="" rel="nofollow">https://gitlab.com/kvaps/docs.example.org</a> </li><li>  GitHub: <a href="" rel="nofollow">https://github.com/kvaps/docs.example.org</a> </li></ul><br><p>   ,    <img src="https://habrastorage.org/getpro/habr/post_images/cd7/2c7/9c3/cd72c79c3eeb7355e20bba58e9088654.gif" alt="рдЫрд╡рд┐"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi481662/">https://habr.com/ru/post/hi481662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi481644/index.html">21 рд╡реАрдВ рд╕рджреА рдореЗрдВ рдПрдХ рдПрд╕рдХреНрдпреВрдПрд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреИрд╕реЗ рдмрдЪреЗрдЧрд╛: рдмрд╛рджрд▓, рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдФрд░ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдХреНрдпреВрдПрд▓ рдорд▓реНрдЯреАрдорд╛рд╕реНрдЯрд░</a></li>
<li><a href="../hi481648/index.html">рдореБрдлреНрдд рдЖрдИрдкреАрд╡реА 4 рд╕рдмрдиреЗрдЯ рдЦреЛрдЬрдиреЗ рдХреЗ рдХрд╛рд░реНрдп рдХреЗ рдЙрджрд╛рд╣рд░рдг рдкрд░ рдЬреВрдиреЛ рдкрд╛рдпрдЬ</a></li>
<li><a href="../hi481652/index.html">рдмреНрд▓реИрдХрдмреЗрд░реА рдПрдВрдбреНрд░реЙрдЗрдб рд╕реНрдорд╛рд░реНрдЯрдлреЛрди рдкрд░ рдкрд┐рдЫрд▓реЗ рджрд░рд╡рд╛рдЬреЗ (?)</a></li>
<li><a href="../hi481654/index.html">рдмреЙрдЯ рдлреНрд░реЗрдорд╡рд░реНрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдХреНрдпреВрдП рдЗрдВрдЬреАрдирд┐рдпрд░ рдиреЗ рдЯреЗрд╕реНрдЯ рдЖрдИрдЯреА рдХреА рдорджрдж рд╕реЗ рдЖрдкрдХреЗ рд▓рд┐рдП рдЬреАрд╡рди рдХреЛ рдХреИрд╕реЗ рдЖрд╕рд╛рди рдмрдирд╛рдпрд╛</a></li>
<li><a href="../hi481656/index.html">PagerDuty, рдпрд╛ рдСрдкрд░реЗрд╢рди рд╡рд┐рднрд╛рдЧ рдХреНрдпреЛрдВ рд░рд╛рдд рдореЗрдВ рд╕реЛ рдирд╣реАрдВ рд╕рдХрддрд╛</a></li>
<li><a href="../hi481664/index.html">рд╕рд░реНрд╡рд░ рд░рд╣рд┐рдд рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг рдФрд░ рд▓рд╛рдЧрдд: AWS рд▓рд╛рдореНрдмрд╛</a></li>
<li><a href="../hi481666/index.html">рдХрд╕реНрдЯрдо рд╕реНрд╡рд┐рдлреНрдЯрд▓рд┐рдВрдЯ рдирд┐рдпрдо</a></li>
<li><a href="../hi481668/index.html">рдкрд╣рд▓реЗ рджрд░реНрд╢рдХ рд╕рдорд╕реНрдпрд╛, рдпрд╛ WebRTC рд╡реАрдбрд┐рдпреЛ рд╕реНрдЯреНрд░реАрдо рдХреЛ HLS рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреА рдХрдард┐рдирд╛рдЗрдпрд╛рдБ</a></li>
<li><a href="../hi481670/index.html">AWS рдХреНрд▓рд╛рдЙрдб рдПрдбреЙрдкреНрд╢рди рдлреНрд░реЗрдорд╡рд░реНрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдХрд╛рд░реНрдп рдпреЛрдЬрдирд╛ рдмрдирд╛рдПрдВ</a></li>
<li><a href="../hi481672/index.html">рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рд╕реЗрд▓реБрд▓рд░ рдСрдЯреЛрдореЗрдЯрд╛</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>