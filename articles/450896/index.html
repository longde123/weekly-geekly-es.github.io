<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüè≠ üëáüèΩ ‚ÜïÔ∏è Laboratorio: configuraci√≥n de lvm, raid en linux ü§òüèª üàπ üöã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una peque√±a digresi√≥n: este l \ r es sint√©tico. 


 Algunas de las tareas descritas aqu√≠ se pueden hacer mucho m√°s f√°cil, pero como la tarea de l / r ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Laboratorio: configuraci√≥n de lvm, raid en linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450896/"><p>  Una peque√±a digresi√≥n: este l \ r es sint√©tico. </p><br><p>  Algunas de las tareas descritas aqu√≠ se pueden hacer mucho m√°s f√°cil, pero como la tarea de l / r es familiarizarse con la incursi√≥n, la funcionalidad lvm, algunas operaciones son artificialmente complicadas. </p><br><h2 id="trebovaniya-k-instrumentam-dlya-vypolneniya-lr">  Requisitos para herramientas para realizar l \ r: </h2><br><ul><li>  Herramientas de virtualizaci√≥n como Virtualbox </li><li>  Imagen de instalaci√≥n de Linux como <a href="">Debian9</a> </li><li>  Disponibilidad de internet para descargar varios paquetes </li><li>  Conexi√≥n v√≠a ssh a la VM instalada (opcional) </li></ul><br><h2 id="vnimanie">  ATENCION </h2><br><p>  Este trabajo de laboratorio est√° asociado con asuntos tan delicados como la seguridad de los datos; esta es un √°rea que le permite perder todos sus datos debido al error m√°s peque√±o: una letra o n√∫mero adicional. </p><br><p>  Como est√° haciendo trabajo de laboratorio, no est√° en peligro, a menos que tenga que comenzar a hacerlo nuevamente. </p><br><p>  En la vida real, todo es mucho m√°s serio, por lo que debe ingresar con mucho cuidado los nombres de los discos, entendiendo exactamente qu√© est√° ejecutando con el comando actual y con qu√© discos trabaja. </p><a name="habracut"></a><br><p>  El segundo punto importante es la denominaci√≥n de discos y particiones: dependiendo de la situaci√≥n, los n√∫meros de disco pueden diferir de los valores que se presentan en los comandos en el laboratorio. <br>  Entonces, por ejemplo, si elimina la unidad sda de la matriz y luego agrega una nueva unidad, la nueva unidad se mostrar√° en el sistema con el nombre sda.  Si reinicia antes de agregar un nuevo disco, el nuevo disco se llamar√° sdb y el antiguo se llamar√° sda </p><br><p>  El trabajo de laboratorio debe realizarse bajo superusuario (root) ya que la mayor√≠a de los comandos requieren privilegios elevados y no tiene sentido elevar constantemente los privilegios a trav√©s de sudo. </p><br><h2 id="materialy-dlya-izucheniya">  Materiales de estudio </h2><br><ul><li>  RAID </li><li>  LVM </li><li>  Nombre de disco de Linux </li><li>  ¬øQu√© es una secci√≥n? </li><li>  ¬øQu√© es una tabla de partici√≥n y d√≥nde se almacena? </li><li>  ¬øQu√© es la comida? </li></ul><br><h2 id="ispolzuemye-utility">  Utilidades Utilizadas </h2><br><ol><li>  Ver informaci√≥n del disco: <br><ul><li>  lsblk -o NOMBRE, TAMA√ëO, FSTYPE, TIPO, PUNTA DE MONTAJE </li><li>  fdisk -l </li></ul></li><li>  Ver informaci√≥n y trabajar con LVM <br><ul><li>  pvs </li><li>  pvextend </li><li>  pvcreate </li><li>  pvresize </li><li>  vgs </li><li>  vgreduce </li><li>  lvs </li><li>  lvextend </li></ul></li><li>  Ver informaci√≥n y trabajar con RAID: <br><ul><li>  cat / proc / mdstat </li><li>  mdadm </li></ul></li><li>  Puntos de montaje: <br><ul><li>  montar </li><li>  desmontar </li><li>  gato / etc / fstab </li><li>  gato / etc / mtab </li></ul></li><li>  Reparticionando el disco: <br><ul><li>  fdisk / dev / XXX </li></ul></li><li>  Copiar secciones: <br><ul><li>  dd if = / dev / xxx of = / dev / aaa </li></ul></li><li>  Trabajar con la tabla de particiones: <br><ul><li>  partx </li><li>  sfdisk </li><li>  mkfs.ext4 </li></ul></li><li>  Trabajar con el gestor de arranque: <br><ul><li>  instalaci√≥n-grub / dev / XXX </li><li>  actualizaci√≥n-grub </li></ul></li><li>  miscel√°neo <br><ul><li>  lsof </li><li>  apto </li><li>  rsync </li></ul></li></ol><br><h2 id="laboratornaya-rabota-sostoit-iz-3-h-chastey">  El trabajo de laboratorio consta de 3 partes: </h2><br><ul><li>  Configuraci√≥n de un sistema saludable usando lvm, raid. </li><li>  Emulaci√≥n de falla de una de las unidades. </li><li>  Reemplazo de discos sobre la marcha, con la adici√≥n de nuevos discos y transferencia de particiones. </li></ul><br><h2 id="zadanie-1-ustanovka-os-i-nastroyka-lvm-raid">  Tarea 1 (Instalaci√≥n del sistema operativo y configuraci√≥n de LVM, RAID) </h2><br><ol><li><p>  Cree una nueva m√°quina virtual con las siguientes caracter√≠sticas: </p><br><ul><li>  1 gb de ram </li><li>  1 cpu </li><li>  2 discos duros (n√≥mbrelos ssd1, ssd2 y asigne el mismo tama√±o, marque las casillas de intercambio en caliente y ssd) </li><li>  Controlador SATA configurado en 4 puertos: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/18f/6f5/be6/18f6f5be6afbc13138abc3dfe960813b.png" alt="seleccione discos ssd"></li></ul><br></li><li><p>  Comience a instalar Linux y vaya a la elecci√≥n de discos duros, haga lo siguiente: </p><br><ul><li>  M√©todo de partici√≥n: manual, despu√©s del cual deber√≠a ver la siguiente imagen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/77a/eb5/3a1/77aeb53a1de2bc7b91d1396dc9b4148e.png" alt="discos de partici√≥n"></li><li>  Configuraci√≥n de una partici√≥n separada en / boot: seleccione el primer disco y cree una nueva tabla de partici√≥n en √©l: <br><ul><li>  Tama√±o de partici√≥n: 512 m </li><li>  Punto de montaje: / boot </li></ul></li><li>  Repita la configuraci√≥n para el segundo disco, pero como no puede montar / arrancar 2 veces al mismo tiempo, seleccione el punto de montaje: ninguno y finalmente obtenga lo siguiente (imagen con marco, rehacer pereza): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3db/2f0/e48/3db2f0e48423f182016bde06c39dfb8d.png" alt="discos de partici√≥n"></li><li>  Configuraci√≥n RAID: </li><li>  Seleccione el espacio libre en el primer disco y configure el volumen f√≠sico para RAID como el tipo de partici√≥n. </li><li>  Seleccione "Listo para configurar la partici√≥n" </li><li>  Repita exactamente la misma configuraci√≥n para el segundo disco, resultando en lo siguiente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/93f/37c/ec3/93f37cec319d628a3267f94d138145e7.png" alt="discos de partici√≥n"></li><li>  Seleccione "Configurar RAID de software" <br><ul><li>  Crear dispositivo MD </li><li>  Tipo de dispositivo RAID de software: seleccione una matriz reflejada </li><li>  Dispositivos activos para la matriz RAID XXXX: seleccione ambas unidades </li><li>  Dispositivos de repuesto: deje 0 como predeterminado </li><li>  Dispositivos activos para la matriz RAID XX: seleccione las particiones que cre√≥ bajo raid </li><li>  Terminar </li></ul></li><li>  Al final, deber√≠as obtener esta imagen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a7/9b0/3f5/7a79b03f556925d1fd53ccc4ca77b494.png" alt="discos de partici√≥n"></li><li>  Configuraci√≥n de LVM: seleccione Configurar el administrador de volumen l√≥gico </li><li>  Mantenga el dise√±o actual de la partici√≥n y configure LVM: S√≠ </li><li>  Crear grupo de vol√∫menes </li><li>  Nombre del grupo de vol√∫menes: sistema </li><li>  Dispositivos para el nuevo grupo de vol√∫menes: elija su RAID creado </li><li>  Crear volumen l√≥gico <br><ul><li>  nombre de volumen l√≥gico: ra√≠z </li><li>  tama√±o de volumen l√≥gico: 2 \ 5 del tama√±o de su disco </li></ul></li><li>  Crear volumen l√≥gico <br><ul><li>  nombre de volumen l√≥gico: var </li><li>  tama√±o de volumen l√≥gico: 2 \ 5 del tama√±o de su disco </li></ul></li><li>  Crear volumen l√≥gico <br><ul><li>  nombre de volumen l√≥gico: log </li><li>  tama√±o de volumen l√≥gico: 1 \ 5 del tama√±o de su disco </li></ul></li><li>  Al elegir Mostrar detalles de configuraci√≥n, deber√≠a obtener la siguiente imagen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b8/8dd/11f/0b88dd11f9372dbf8e53a6727fc69b27.png" alt="discos de partici√≥n"></li><li>  Despu√©s de completar la configuraci√≥n de LVM, deber√≠a ver lo siguiente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/72b/9d4/00d/72b9d400d9b83392c759b7aeb3e9d573.png" alt="discos de partici√≥n"></li><li>  Particionamiento: a su vez, seleccione cada volumen creado en LVM y particione, por ejemplo, para ra√≠z como esta: <br><ul><li>  Usar como: ext4 </li><li>  punto de montaje: / </li></ul></li><li>  El resultado de marcar la partici√≥n ra√≠z debe ser el siguiente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/225/61e/0be/22561e0be2cd905e0948a63ae3460461.png" alt="discos de partici√≥n"></li><li>  Repita la operaci√≥n de marcado para var y log seleccionando los puntos de montaje apropiados (ingrese manualmente / var y / var / log), obteniendo el siguiente resultado: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5da/58c/756/5da58c756fd8d205a93ebfd49acc396f.png" alt="discos de partici√≥n"></li><li>  Elija Finalizar Particionamiento </li><li>  Se le har√°n algunas preguntas sobre el hecho de que todav√≠a tiene una partici√≥n desmontada y el intercambio no est√° configurado.  Ambas preguntas deben responderse negativamente. </li><li>  El resultado final deber√≠a verse as√≠: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/117/381/a61/117381a61b766df3c89d2646baa2b33d.png" alt="discos de partici√≥n"></li></ul><br></li><li><p>  Finalice la instalaci√≥n del sistema operativo instalando grub en el primer dispositivo (sda) e inicie el sistema. </p><br></li><li><p>  Copie el contenido de la partici√≥n / boot de la unidad sda (ssd1) a la unidad sdb (ssd2) </p><br><pre><code class="plaintext hljs">dd if=/dev/sda1 of=/dev/sdb1</code> </pre> <br></li><li><p>  Instale grub en el segundo dispositivo: </p><br><ul><li><p>  Ver unidades en el sistema: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li>  Enumere todos los discos que le emiti√≥ el comando anterior y describa qu√© tipo de disco es. </li><li><p>  Localice la unidad en la que no se instal√≥ grub y complete esta instalaci√≥n: </p><br><pre> <code class="plaintext hljs">grub-install /dev/sdb</code> </pre> <br></li><li>  Vea la incursi√≥n actual con cat / proc / mdstat y escriba lo que vio. </li><li>  Mire la salida de los comandos: pvs, vgs, lvs, mount y anote exactamente lo que vio. </li></ul><br></li></ol><br><p>  Describa en sus propias palabras lo que hizo y qu√© resultado obtuvo como resultado de la tarea completada. </p><br><p>  Despu√©s de completar esta tarea, se recomienda hacer una copia de seguridad de la carpeta con la m√°quina virtual o hacer un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cuadro vagabundo</a> . </p><br><p>  Resultado: una m√°quina virtual con discos ssd1, ssd2. </p><br><h2 id="zadanie-2-emulyaciya-otkaza-odnogo-iz-diskov">  Tarea 2 (Emulaci√≥n de la falla de una de las unidades) </h2><br><ol><li>  Si marc√≥ la casilla de verificaci√≥n de intercambio en caliente, puede eliminar discos sobre la marcha: <br><ul><li>  Elimine la unidad ssd1 en las propiedades de la m√°quina. </li><li>  Encuentre el directorio donde se almacenan los archivos de su m√°quina virtual y elimine ssd1.vmdk. </li></ul></li><li>  Aseg√∫rese de que su m√°quina virtual todav√≠a se est√© ejecutando. </li><li>  Reinicie la m√°quina virtual y aseg√∫rese de que todav√≠a funciona. </li><li>  Verifique el estado de la matriz RAID: <code>cat /proc/mdstat</code> </li><li>  Agregue un nuevo disco del mismo tama√±o en la interfaz de VM y as√≠gnele el nombre ssd3. </li><li>  Realizar operaciones: <br><ul><li>  Mire el nuevo disco que llega al sistema con el <code>fdisk -l</code> </li><li>  Copie la tabla de particiones del disco anterior al nuevo: <code>sfdisk -d /dev/XXXX | sfdisk /dev/YYY</code> <code>sfdisk -d /dev/XXXX | sfdisk /dev/YYY</code> </li><li>  Ver el resultado con <code>fdisk -l</code> </li><li>  Agregue un nuevo disco a la matriz <code>mdadm --manage /dev/md0 --add /dev/YYY</code> : <code>mdadm --manage /dev/md0 --add /dev/YYY</code> </li><li>  Vea el resultado: <code>cat /proc/mdstat</code> .  Deber√≠a ver que la sincronizaci√≥n ha comenzado. </li></ul></li><li><p>  Ahora necesita sincronizar manualmente las particiones que no son parte del RAID.  Para hacer esto, utilizaremos la utilidad dd, copiando del disco "en vivo" al nuevo que instal√≥ recientemente: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li>  Una vez completada la sincronizaci√≥n, instale grub en el nuevo disco. </li><li>  Reinicie la VM para asegurarse de que todo est√© funcionando. </li></ol><br><p>  Describa en sus propias palabras lo que hizo y qu√© resultado obtuvo como resultado de la tarea completada. </p><br><p>  <strong>Resultado:</strong> elimin√≥ la unidad ssd1, guard√≥ la unidad ssd2 y agreg√≥ la unidad ssd3. </p><br><h2 id="zadanie-3-dobavlenie-novyh-diskov-i-perenos-razdela">  Tarea 3 (Agregar nuevos discos y particionar) </h2><br><p>  Esta es la tarea m√°s dif√≠cil y voluminosa de todas las presentadas.  Verifique cuidadosamente lo que est√° haciendo y con qu√© discos y particiones.  Se recomienda que tome una copia antes de ejecutarla.  Esta tarea, independientemente de la tarea n√∫mero 2, se puede realizar despu√©s de la tarea n√∫mero 1, ajustada para los nombres de disco. </p><br><p>  La segunda parte de la asignaci√≥n de este laboratorio deber√≠a conducir exactamente al mismo estado que ten√≠a despu√©s de completar la primera parte. </p><br><p>  Para facilitarle el trabajo, le recomiendo no eliminar f√≠sicamente los discos de la m√°quina host, sino desconectarlos solo en las propiedades de la m√°quina.  Desde el punto de vista del sistema operativo en la m√°quina virtual, esto se ver√° exactamente igual, pero en cuyo caso puede conectar la unidad de nuevo y continuar trabajando retrocediendo un par de puntos en caso de que tenga alg√∫n problema.  Por ejemplo, es posible que haya realizado incorrectamente u olvidado copiar la partici√≥n / boot en un nuevo disco.  Solo puedo aconsejarle que verifique dos veces con qu√© discos y particiones est√° trabajando, y a√∫n mejor, escriba la correspondencia de discos, particiones y el n√∫mero de disco "f√≠sico" en una hoja de papel.  El comando <code>lsblk</code> dibuja un √°rbol hermoso y comprensible, <code>lsblk</code> mayor frecuencia posible para analizar lo que ha hecho y lo que debe hacerse. </p><br><p>  A la historia ... </p><br><p>  Imagine que su servidor funcion√≥ durante mucho tiempo en 2 discos ssd, cuando de repente ... </p><br><ol><li><p>  Simule una falla de disco ssd2 quitando el disco de las propiedades de VM y reiniciando. </p><br></li><li><p>  Ver el estado actual de los discos y RAID: </p><br><pre> <code class="plaintext hljs">cat /proc/mdstat fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Tienes suerte: las autoridades permitieron comprar varios discos nuevos: </p><br><p>  2 grandes vol√∫menes SATA para la tarea de mucho tiempo de mover la secci√≥n de registro a un disco separado.  2 SSD para reemplazar al fallecido, as√≠ como para reemplazar el que a√∫n funciona. </p><br><p>  Tenga en cuenta que la cesta del servidor admite la instalaci√≥n de solo 4 unidades.  al mismo tiempo, por lo que no puede agregar todos los discos a la vez. </p><br><p>  El volumen del HDD para elegir 2 veces m√°s que el SSD. <br>  El volumen de SSD elige 1.25 veces el tama√±o del SSD anterior. </p><br></li><li><p>  Agregue una nueva unidad ssd, as√≠gnele el nombre ssd4 y, despu√©s de agregar, verifique qu√© sucedi√≥: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  En primer lugar, debe cuidar la seguridad de los datos del disco antiguo.  Esta vez transferiremos datos usando LVM: </p><br><ul><li><p>  En primer lugar, debe copiar la tabla de archivos del disco antiguo al nuevo: </p><br><pre> <code class="plaintext hljs">sfdisk -d /dev/XXX | sfdisk /dev/YYY</code> </pre> <br><p>  Sustituya los discos correctos en lugar de x, y y descubra qu√© hace este comando. </p><br></li><li>  Ejecute lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT y compare su salida con la llamada anterior.  ¬øQu√© ha cambiado? </li><li><p>  Use el comando dd para copiar los datos / boot al nuevo disco: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li><p>  Si / boot permanece montado en la unidad anterior, debe montarse en una unidad activa: </p><br><pre> <code class="bash hljs">mount | grep boot <span class="hljs-comment"><span class="hljs-comment">#     lsblk #           ,     umount /boot #  /boot mount -a #      /etc/fstab. #      /dev/sda,        </span></span></code> </pre> <br></li><li><p>  Instale el gestor de arranque en la nueva unidad ssd: </p><br><pre> <code class="plaintext hljs">grub-install /dev/YYY</code> </pre> <br><p>  ¬øPor qu√© estamos haciendo esta operaci√≥n? </p><br></li><li><p>  Cree una nueva matriz de incursiones con solo una nueva unidad ssd incluida: </p><br><pre> <code class="plaintext hljs">mdadm --create --verbose /dev/md63 --level=1 --raid-devices=1 /dev/YYY</code> </pre> <br><p>  El comando anterior no funcionar√° sin especificar una clave especial. Lea la ayuda y agregue esta clave al comando. </p><br></li><li>  Use el comando cat / proc / mdstat para verificar el resultado de su operaci√≥n.  ¬øQu√© ha cambiado? </li><li>  Ejecute lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT y compare su salida con la llamada anterior.  ¬øQu√© ha cambiado? </li></ul><br></li><li><p>  El siguiente paso es configurar LVM </p><br><ul><li>  Ejecute el comando pvs para ver informaci√≥n sobre los vol√∫menes f√≠sicos actuales. </li><li><p>  Cree un nuevo volumen f√≠sico al incluir en √©l la matriz RAID creada anteriormente: </p><br><pre> <code class="plaintext hljs">pvcreate /dev/md63</code> </pre> <br></li><li>  Ejecute lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT y compare su salida con la llamada anterior.  ¬øQu√© ha cambiado? </li><li>  Ejecute el comando pvs nuevamente.  ¬øQu√© ha cambiado? </li><li><p>  Aumente el tama√±o del sistema de grupos de vol√∫menes con el siguiente comando: </p><br><pre> <code class="plaintext hljs">vgextend system /dev/md63</code> </pre> <br></li><li><p>  Ejecute los comandos y escriba lo que vio y lo que cambi√≥. </p><br><pre> <code class="plaintext hljs">vgdisplay system -v pvs vgs lvs -a -o+devices</code> </pre> <br><p>  ¬øEn qu√© disco f√≠sico est√°n ahora LV var, log, root? </p><br></li><li><p>  Mueva los datos de la unidad anterior a la nueva sustituyendo los nombres de dispositivo correctos. </p><br><pre> <code class="plaintext hljs">pvmove -i 10 -n /dev/system/root /dev/md0 /dev/md63</code> </pre> <br><p>  Repita la operaci√≥n para todo el volumen l√≥gico. </p><br></li><li><p>  Ejecute los comandos y escriba lo que vio y lo que cambi√≥. </p><br><pre> <code class="plaintext hljs">vgdisplay system -v pvs vgs lvs -a -o+devices lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Cambia nuestro VG eliminando la vieja incursi√≥n.  Sustituya el nombre de banda correcto. </p><br><pre> <code class="plaintext hljs">vgreduce system /dev/md0</code> </pre> <br></li><li><p>  Ejecute los comandos y escriba lo que vio y lo que cambi√≥. </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT pvs vgs</code> </pre> <br></li><li>  Para la belleza de la imagen, vuelva a montar / iniciar en la segunda unidad ssd (ssd4) y ejecute lsblk.  Como resultado, no se debe montar nada en el disco ssd3.  ¬°Compruebe con cuidado que la partici√≥n / boot no est√© vac√≠a!  <code>ls /boot</code> deber√≠a mostrar varios archivos y carpetas.  Examine lo que est√° almacenado en esta secci√≥n y escriba qu√© archivo / directorio es responsable de qu√©. </li></ul><br></li><li><p>  Retire el disco ssd3 y agregue ssd5, hdd1, hdd2 de acuerdo con el TK anterior, y finalmente obtenga: </p><br><ul><li>  ssd4 - primer nuevo ssd </li><li>  ssd5 - segundo nuevo ssd </li><li>  hdd1: el primer disco duro nuevo </li><li>  hdd2 - segundo disco duro nuevo </li></ul><br></li><li><p>  Verifique lo que sucedi√≥ despu√©s de agregar discos: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Vamos a restaurar la matriz de incursiones principal: </p><br><ul><li><p>  Copie la tabla de partici√≥n, sustituyendo los discos correctos: </p><br><pre> <code class="plaintext hljs">sfdisk -d /dev/XXX | sfdisk /dev/YYY</code> </pre> <br></li><li><p>  Tenga en cuenta que cuando copiamos la tabla de particiones del disco anterior, result√≥ que el nuevo tama√±o no utiliza todo el espacio del disco duro.  Por lo tanto, pronto tendremos que redimensionar esta secci√≥n y expandir la incursi√≥n.  Compru√©belo usted mismo ingresando el comando: </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li></ul><br></li><li><p>  Copie la partici√≥n de arranque / boot de ssd4 a ssd5: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li><p>  Instale grub en el nuevo disco (ssd5). </p><br></li><li><p>  Cambie el tama√±o de la segunda partici√≥n de la unidad ssd5. </p><br><ul><li><p>  Ejecute la utilidad para trabajar con el dise√±o del disco: </p><br><pre> <code class="plaintext hljs">fdisk /dev/XXX</code> </pre> <br></li><li>  Ingrese la tecla d para eliminar la partici√≥n existente (seleccione 2). </li><li>  Ingrese la tecla n para crear una nueva partici√≥n. </li><li>  Ingrese la clave p para indicar el tipo de partici√≥n primaria. </li><li>  Ingrese la clave 2 para que la nueva partici√≥n tenga un segundo n√∫mero. </li><li>  Primer sector: presione Intro para aceptar el tama√±o de inicio de secci√≥n calculado autom√°ticamente. </li><li>  √öltimo sector: presione Intro para aceptar el tama√±o de secci√≥n final calculado autom√°ticamente. </li><li>  Ingrese la tecla l para ver una lista de todos los tipos de particiones posibles y encuentre Linux raid auto en ella. </li><li>  Ingrese la clave t para cambiar el tipo de la partici√≥n creada (2) e ingrese el n√∫mero encontrado en el paso anterior. </li><li>  Ingrese la tecla w para escribir el cambio en el disco. </li></ul><br></li><li><p>  Vuelva a leer la tabla de particiones y verifique el resultado: </p><br><pre> <code class="plaintext hljs">partx -u /dev/XXX lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br><ul><li><p>  Agregue un nuevo disco a la matriz de incursiones actual (no olvide sustituir los discos correctos): </p><br><pre> <code class="plaintext hljs">mdadm --manage /dev/md63 --add /dev/sda2</code> </pre> <br></li><li><p>  Expandimos el n√∫mero de discos en nuestra matriz a 2 piezas: </p><br><pre> <code class="plaintext hljs">mdadm --grow /dev/md63 --raid-devices=2</code> </pre> <br></li><li><p>  Mira el resultado: tenemos 2 matrices marcadas, pero ambas secciones incluidas en esta matriz tienen diferentes tama√±os: </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li></ul><br></li><li><p>  Aumente el tama√±o de la partici√≥n en el disco ssd4 </p><br><ul><li><p>  Ejecute la utilidad para trabajar con el dise√±o del disco: </p><br><pre> <code class="plaintext hljs">fdisk /dev/XXX</code> </pre> <br></li><li>  Ingrese la tecla d para eliminar la partici√≥n existente (seleccione 2). </li><li>  Ingrese la tecla n para crear una nueva partici√≥n. </li><li>  Ingrese la clave p para indicar el tipo de partici√≥n primaria. </li><li>  Ingrese la clave 2 para que la nueva partici√≥n tenga un segundo n√∫mero. </li><li>  Primer sector: presione Intro para aceptar el tama√±o de inicio de secci√≥n calculado autom√°ticamente. </li><li>  √öltimo sector: presione Intro para aceptar el tama√±o de secci√≥n final calculado autom√°ticamente. </li><li>  Al final del marcado, seleccione No para dejar la firma de que la secci√≥n pertenece a la matriz. </li><li>  Ingrese la tecla w para escribir el cambio en el disco. </li></ul><br></li><li><p>  Volvemos a leer la tabla de particiones y verificamos el resultado. </p><br><pre> <code class="plaintext hljs">partx -u /dev/XXX lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br><p>  Tenga en cuenta que ahora las particiones sda2, sdc2 son m√°s grandes que el tama√±o del dispositivo raid. </p><br></li><li><p>  En este punto, el tama√±o de la incursi√≥n ahora se puede expandir: </p><br><pre> <code class="bash hljs">mdadm --grow /dev/md63 --size=max lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT <span class="hljs-comment"><span class="hljs-comment"># check result</span></span></code> </pre> <br><p>  Explore lsblk y escriba lo que ha cambiado. </p><br></li><li><p>  Sin embargo, a pesar de que cambiamos el tama√±o de la incursi√≥n, los tama√±os de vg root, var, log no cambiaron. </p><br><ul><li><p>  Mira cu√°l es el tama√±o de PV: </p><br><pre> <code class="bash hljs">pvs</code> </pre> <br></li><li><p>  Extienda el tama√±o de nuestro PV: </p><br><pre> <code class="bash hljs">pvresize /dev/md63</code> </pre> <br></li><li><p>  Mira cu√°l es el tama√±o de PV: </p><br><pre> <code class="bash hljs">pvs</code> </pre> <br></li></ul><br></li><li><p>  Agregue el lugar recientemente aparecido VG var, root: </p><br><pre> <code class="bash hljs">lvs <span class="hljs-comment"><span class="hljs-comment">#     lvextend -l +50%FREE /dev/system/root lvextend -l +100%FREE /dev/system/var lvs #   </span></span></code> </pre> <br><p>  En este punto, ha completado la migraci√≥n de la matriz principal a nuevos discos.  trabajar con ssd1, ssd2 est√° terminado. </p><br></li><li><p>  Nuestra siguiente tarea es mover / var / log a nuevas unidades, para esto crearemos una nueva matriz y lvm en unidades de disco duro. </p><br><ul><li><p>  Veamos qu√© nombres tienen las nuevas unidades de disco duro: </p><br><pre> <code class="bash hljs">fdisk -l</code> </pre> <br></li><li><p>  Crear una matriz de incursiones: </p><br><pre> <code class="bash hljs">mdadm --create /dev/md127 --level=1 --raid-devices=2 /dev/sdc /dev/sdd</code> </pre> <br></li><li><p>  Crea un nuevo PV en la incursi√≥n desde discos grandes: </p><br><pre> <code class="bash hljs">pvcreate data /dev/md127</code> </pre> <br></li><li><p>  En este PV, cree un grupo llamado datos: </p><br><pre> <code class="bash hljs">vgcreate data /dev/md127</code> </pre> <br></li><li><p>  Cree un volumen l√≥gico con el tama√±o de todo el espacio libre y ll√°melo val_log: </p><br><pre> <code class="bash hljs">lvcreate -l 100%FREE -n var_log data <span class="hljs-comment"><span class="hljs-comment"># lvs #  </span></span></code> </pre> <br></li><li><p>  Formatee la partici√≥n creada en ext4: </p><br><pre> <code class="bash hljs">mkfs.ext4 /dev/mapper/data-var_log</code> </pre> <br></li><li><p>  Veamos el resultado: </p><br><pre> <code class="bash hljs">lsblk</code> </pre> <br></li></ul><br></li><li><p>  Transfiera datos de registro de la secci√≥n anterior a la nueva </p><br><ul><li><p>  Montaremos un nuevo almacenamiento de registro temporal: </p><br><pre> <code class="plaintext hljs">mount /dev/mapper/data-var_log /mnt</code> </pre> <br></li><li><p>  Sincronicemos las secciones: </p><br><pre> <code class="bash hljs">apt install rsync rsync -avzr /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ /mnt/</code> </pre> <br></li><li><p>  Averig√ºe qu√© procesos se est√°n ejecutando con / var / log ahora: </p><br><pre> <code class="bash hljs">apt install lsof lsof | grep <span class="hljs-string"><span class="hljs-string">'/var/log'</span></span></code> </pre> <br></li><li><p>  Paramos estos procesos: </p><br><pre> <code class="bash hljs">systemctl stop rsyslog.service syslog.socket</code> </pre> <br></li><li><p>  Realizaremos la sincronizaci√≥n final de las particiones (de los datos que podr√≠an haber cambiado desde la √∫ltima sincronizaci√≥n): </p><br><pre> <code class="bash hljs">rsync -avzr /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ /mnt/</code> </pre> <br></li><li><p>  Intercambia las secciones: </p><br><pre> <code class="bash hljs">umount /mnt umount /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> mount /dev/mapper/data-var_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br></li><li><p>  Mira lo que pas√≥: </p><br><pre> <code class="bash hljs">lsblk</code> </pre> <br></li></ul><br></li><li><p>  Editar / etc / fstab </p><br><p>  fstab: un archivo en el que las reglas se escriben de acuerdo con las particiones que se montar√°n en el arranque.  Nuestra tarea es encontrar la l√≠nea en la que se monta / var / log y fijar el dispositivo de <code>system-log</code> sistema a <code>data-var_log</code> . </p><br></li><li><p>  Lo m√°s importante en esta etapa es recordar cambiar la tabla de particiones (ext4, por ejemplo).  Dado que no importa c√≥mo cambiemos todos los tipos de incursiones, lvm, hasta que se notifique al sistema de archivos de la partici√≥n que el tama√±o de la partici√≥n ahora ha cambiado, no podremos usar el nuevo espacio.  Use el comando <code>resize2fs</code> para cambiar el FS. </p><br></li><li><p>  Acorde final </p><br><ul><li>  Vamos a reiniciar  Si hizo todo correctamente, volver√° a encontrarse en su sistema operativo (esto es necesario para asegurarse de que todo funcione. Este paso no tiene sentido excepto para la autocomprobaci√≥n) </li><li><p>  Comprueba que todo lo que quer√≠amos hacer estaba realmente hecho: </p><br><pre> <code class="bash hljs">pvs lvs vgs lsblk cat /proc/mdstat</code> </pre> <br></li></ul><br></li><li><p>  [OPCIONAL] Sigue los pasos </p><br><ul><li>  Reinicie presionando F12 para indicar diferentes discos al arrancar, para asegurarse de que puede arrancar desde cualquiera de los discos ssd, para que no tengamos miedo de que uno de ellos falle. </li><li><p>  Ahora tiene el registro LV innecesario en el sistema VG.  Distribuya este espacio entre root o var, pero en lugar de usar la construcci√≥n 100% GRATUITA, especifique el tama√±o con sus manos usando el interruptor -L: </p><br><pre> <code class="bash hljs">-L 500M</code> </pre> <br></li><li>  Solucione el problema con el hecho de que / boot est√° en dos particiones sin sincronizaci√≥n, no necesita hacer esto de la manera correcta, aqu√≠ se agrega como ejemplo.  No olvides copiar el contenido de / boot en alguna parte. </li><li>  Crea una nueva incursi√≥n e incluye sda1, sda2 en ella. </li><li>  Incluya estas particiones en su incursi√≥n existente y restablezca / inicie b√°sicamente la incursi√≥n, pero sin montarla nunca m√°s. </li></ul><br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450896/">https://habr.com/ru/post/450896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450886/index.html">Antecedentes: c√≥mo funcionan los autom√≥viles de hidr√≥geno y cu√°ndo aparecen en las carreteras</a></li>
<li><a href="../450888/index.html">Swift: Tamiz de Erat√≥stenes</a></li>
<li><a href="../450890/index.html">Google I / O News 2019: Pixel 3a, Android Q, Kotlin y m√°s</a></li>
<li><a href="../450892/index.html">¬øLa velocidad de almacenamiento es adecuada para etcd? Preg√∫ntale a fio</a></li>
<li><a href="../450894/index.html">Sobre antenas para los m√°s peque√±os</a></li>
<li><a href="../450898/index.html">Desarrollo de interfaz en m√∫ltiples pantallas. Paso a usar AI</a></li>
<li><a href="../450902/index.html">Desea empleados leales: comience con usted mismo</a></li>
<li><a href="../450904/index.html">Aspectos pr√°cticos de la implementaci√≥n de la aplicaci√≥n Dockerized ASP.NET Core en Heroku</a></li>
<li><a href="../450906/index.html">C√≥mo comenzar a vivir y cultivar lechuga</a></li>
<li><a href="../450908/index.html">Redes de listas negras para Asterisk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>