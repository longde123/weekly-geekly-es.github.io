<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèº üÜé üëÅ‚Äçüó® √â poss√≠vel em 1C n√£o observar a tecnologia de componentes externos? Ou como parabenizar os colegas usando o 1C? üôÄ ü§∏üèª üèØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Havia uma ideia aqui para parabenizar nossa contadora-chefe de uma maneira mais ou menos original, por exemplo, com a ajuda de seu programa 1C favorit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√â poss√≠vel em 1C n√£o observar a tecnologia de componentes externos? Ou como parabenizar os colegas usando o 1C?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466713/">  Havia uma ideia aqui para parabenizar nossa contadora-chefe de uma maneira mais ou menos original, por exemplo, com a ajuda de seu programa 1C favorito?  Mas como <br><br>  Depois de pensar um pouco, a id√©ia veio para usar como parab√©ns em segundo plano a imagem de segundo plano na √°rea do cliente de formul√°rios convencionais para configura√ß√µes em 1C77-1C82 ou em uma janela externa para os formul√°rios gerenciados 1C82 e em todos os casos para 1C83.  Nele, exiba a mensagem desejada e forne√ßa links para o v√≠deo de felicita√ß√µes, conforme mostrado na figura. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a77/0bd/055/a770bd055ca43fdb5ad8d6f1f124253b.jpg" alt="Parab√©ns em 1C"><br><a name="habracut"></a><br><h2>  Parte Um - Resultante </h2><br>  Obviamente, essa ideia n√£o √© nova.  Portanto, em 2011, uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">solu√ß√£o semelhante</a> foi proposta com base no <b>FormEx.dll, por <i>Aleksey Fedorov, tamb√©m conhecido como ALF</i></b> .  E perguntas sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como conseguir isso</a> foram feitas em 2008. <br><br>  Ao mesmo tempo, tamb√©m usamos esse componente para carregar a imagem de plano de fundo no 1C77.  Mas o carregamento de arquivos bmp grandes (e outros n√£o podiam ser usados) era lento (por causa disso, pequenas imagens colocadas com ladrilhos foram usadas); portanto, havia um desejo de escrever seu pr√≥prio componente externo (VK), que s√≥ baixaria as imagens necess√°rias e nada mais, a menos que o que mais pode ser um campo de testes para experimentos. <br><br>  Esse componente foi gravado (tamb√©m, apenas para arquivos bmp, usando, se necess√°rio, lado a lado).  A fun√ß√£o <b>WinAPI LoadImage ()</b> foi usada l√°.  Esta DLL n√£o entrou em conflito com FormEx.dll, era simples, r√°pido o suficiente e serviu por um longo tempo. <br><br>  Tudo isso foi maravilhoso, mas estava na hora de expandir suas capacidades, e aqui era necess√°ria uma abordagem diferente. <br><br>  Neste artigo, n√£o abordamos os problemas de cria√ß√£o de arquivos multim√≠dia.  Esta n√£o √© a nossa especialidade.  N√≥s nos restringimos apenas a algumas nuances da programa√ß√£o de componentes externos para 1C. <br><br><h3>  1C77 </h3><br>  Como as vers√µes da plataforma 1C podem ser diferentes, pode haver v√°rias solu√ß√µes.  No nosso caso, essas eram configura√ß√µes em 1C77 (Fig. 1). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b4/611/4ad/8b46114ad1ae83e57667cc4bb84aae7e.jpg" alt="Fig. 1. Imagem de congratula√ß√µes na configura√ß√£o de teste em 1C77"><br>  Fig.  1. Imagem de felicita√ß√µes na configura√ß√£o de teste em 1C77. <br><br>  O v√≠deo aqui, embora seja seu, mas a id√©ia de sua cria√ß√£o √© <b><i>colhida em Anna Shiyanova, sob o apelido de "Caso especial"</i></b> .  Essa garota tem talento, pode ser imitada, mas dificilmente √© poss√≠vel repetir completamente o estilo.  Nesse caso, eu s√≥ queria pelo menos algum elemento de criatividade. <br><br>  Se um dos colegas j√° estiver cansado de olhar para os parab√©ns de outras pessoas, poder√° sobrecarregar a imagem <b>pressionando</b> ‚Äú <b>Alt + I</b> ‚Äù (Fig. 2-3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01a/8c1/200/01a8c120008b72dd648b7c8697298d65.jpg" alt="Fig. 2. Selecionando outra imagem de plano de fundo no menu ‚ÄúArquivo / Selecionar plano de fundo‚Äù ou por ‚ÄúAlt + I‚Äù"><br>  Fig.  2. Selecionando uma imagem de plano de fundo diferente no menu "Arquivo / Selecionar plano de fundo" ou em "Alt + I". <br><br>  E, ao mesmo tempo, veja as informa√ß√µes sobre o m√≥dulo usado por " <b>Alt + L</b> " (Fig. 3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/499/499/f23/499499f23ec33734bd6a5068f5d493b8.jpg" alt="Fig. 3. Uma imagem de plano de fundo sobrecarregada, juntamente com informa√ß√µes sobre o programa (&quot;Ajuda / Sobre o m√≥dulo LionExt32.dll&quot; ou &quot;Alt + L&quot;)"><br>  Fig.  3. Imagem de plano de fundo sobrecarregada, juntamente com informa√ß√µes sobre o programa ("Ajuda / Sobre o m√≥dulo LionExt32.dll" ou "Alt + L"). <br><br><h3>  Formas convencionais 1C82 </h3><br>  Naturalmente, a maioria agora est√° voltada para o G8 (1C8x).  No entanto, trabalhar com a imagem de plano de fundo em 1C √© poss√≠vel apenas em formul√°rios comuns na vers√£o 8.2 e menos, e se voc√™ n√£o usar nenhum processamento iniciado no modo "√°rea de trabalho", que simplesmente se sobrep√µe completamente ao plano de fundo (Fig. 4). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/390/123/bfd/390123bfd2ef88bfbc108dbe44c70835.jpg" alt="Fig. 4. Imagem de congratula√ß√µes na configura√ß√£o de teste nos formul√°rios comuns 1C82"><br>  Fig.  4. Imagem de congratula√ß√µes na configura√ß√£o de teste nos formul√°rios usuais 1C82. <br><br>  Observe que os links para a Fig.  4 n√£o indicam nosso v√≠deo.  Eles s√£o mostrados apenas para o teste. <br><br>  Em formas comuns, o 1C82 n√£o fornece mais a maneira padr√£o de acessar o menu, pois n√£o √© sist√™mico l√°, como nos "sete", mas "pr√≥prio" (embora o sistema possa ser criado, mas por que precisamos de dois menus principais?).  No entanto, teclas de atalho podem ser usadas.  Da mesma forma, ‚ÄúAlt + I‚Äù, em nosso componente, chamamos uma caixa de di√°logo, como na Fig. 2, e carregamos outro fundo (Fig. 5). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3f/535/deb/c3f535deb522e2ae7ad8937ce31b1188.jpg" alt="Fig. 5. Imagem de fundo sobrecarregada em formul√°rios 1C82 ‚Äúespessos‚Äù"><br>  Fig.  5. Imagem de fundo sobrecarregada em formul√°rios 1C82 "espessos". <br><br>  Da mesma forma, voc√™ pode obter informa√ß√µes sobre o m√≥dulo pressionando a tecla "Alt + L", como na fig.  3) <br><br><h3>  Formul√°rios gerenciados 1C82 </h3><br>  Para formul√°rios gerenciados em 1C82, voc√™ ainda pode encontrar a janela que precisamos no s√©timo n√≠vel de aninhamento, como " <b>V8FormElement</b> ", e desenhar nela, mas de alguma forma n√£o √© interessante. <br><br>  Para n√≥s, a partir dessas considera√ß√µes, conclui-se que √© mais f√°cil criar uma janela externa com uma mensagem de felicita√ß√µes (Fig. 6) do que lidar com cada caso individual.  A janela em si pode ser fechada, mais precisamente, minimizada por " <b>Esc</b> ", " <b>Ctrl + F4</b> ", " <b>Alt + F4</b> " ou clicando na " <b>cruz</b> ". <br><br><img src="https://habrastorage.org/getpro/habr/post_images/790/cd9/79d/790cd979df8a4d97ff5488c50fa4bd6c.jpg" alt="Fig. 6. Imagem de congratula√ß√µes em uma configura√ß√£o de teste nos formul√°rios gerenciados 1C82"><br>  Fig.  6. Imagem de congratula√ß√µes em uma configura√ß√£o de teste nos formul√°rios gerenciados 1C82. <br><br>  Al√©m disso, a janela minimizada (Fig. 7) pode ser expandida novamente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66c/1a7/c7f/66c1a7c7f725404604318cdcde3a9915.jpg" alt="Fig.  7. Uma imagem minimizada da janela externa nos formul√°rios gerenciados 1C82"><br>  Fig.  7. Uma imagem minimizada da janela externa nos formul√°rios gerenciados 1C82. <br><br>  As dimens√µes e a posi√ß√£o relativa da janela externa podem ser alteradas, tudo √© como de costume aqui (veja imagens ampliadas das janelas externas nas Fig. 6 e Fig. 10).  Observe que as teclas de atalho funcionam apenas se a janela externa estiver ativa. <br><br><h3>  Formas convencionais 1C83 </h3><br>  No 1C83, n√£o h√° mais janelas filho, o que pode servir como crit√©rio para a vers√£o 1C em nossa DLL.  Al√©m disso, as formas ‚Äúgrossas‚Äù s√£o uma janela de quadro (Fig. 8), e as formas gerenciadas s√£o sem moldura (Fig. 9).  Ou seja, tudo o que n√£o √© um quadro pode ser redesenhado.  Um quadro tamb√©m pode ser redesenhado, mas apenas como um elemento do sistema. <br><div class="scrollable-table"><table><tbody><tr><th><img src="https://habrastorage.org/getpro/habr/post_images/f9c/35e/0da/f9c35e0da01025306525d14f700d22a4.jpg" alt="Fig.  8. Janela da moldura em formas &quot;grossas&quot; 1C83"></th><th><img src="https://habrastorage.org/getpro/habr/post_images/962/5f9/e7c/9625f9e7c28fed4c9226ee73d8126ed8.jpg" alt="Fig.  9. Janela sem moldura nos formul√°rios gerenciados 1C83"></th></tr><tr><th>  Fig.  8. Janela da estrutura em formas "grossas" 1C83. </th><th>  Fig.  9. Janela sem moldura em formul√°rios controlados 1C83. </th></tr></tbody></table></div>  Aqui, criamos uma janela de teste usando uma biblioteca din√¢mica e a subordinamos √† janela 1C principal.  A diferen√ßa de comportamento √© vista nas figuras. <br><br><h3>  Formul√°rios gerenciados 1C83 </h3><br>  No caso de 1C83, como nos formul√°rios gerenciados 1C82, chamaremos nossos parab√©ns n√£o contra o pano de fundo, mas em uma janela separada, cujo prot√≥tipo √© mostrado na Fig.  8-9.  Como resultado, o componente desejado ( <b>LionExt32.dll</b> ou <b>LionExt64.dll</b> ) fornecer√° o seguinte resultado (Fig. 10-12). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/104/cf1/f10/104cf1f10c6ae652d24edea7082c7e6c.jpg" alt="Fig.  10. Uma imagem de fundo na janela externa para formul√°rios abertos 1C83"><br>  Fig.  10. A imagem de fundo na janela externa para os formul√°rios convencionais 1C83. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56a/03f/fc7/56a03ffc7fe1f2bfee6358ecb81af9fa.jpg" alt="Fig.  11. Imagem do plano de fundo na janela externa dos formul√°rios gerenciados 1C83, vers√£o 14, vers√£o de 64 bits"><br>  Fig.  11. A imagem de plano de fundo na janela externa dos formul√°rios gerenciados 1C83, vers√£o 14, vers√£o de 64 bits. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/05e/12f/71c/05e12f71ccfb9212b96bc3db92630869.jpg" alt="Fig.  12. Imagem do plano de fundo na janela externa dos formul√°rios gerenciados 1C83, vers√£o 15, vers√£o de 64 bits"><br>  Fig.  12. A imagem de plano de fundo na janela externa dos formul√°rios gerenciados 1C83, vers√£o 15, vers√£o de 64 bits. <br><br><h3>  Conclus√µes preliminares </h3><br>  Esse componente foi realmente usado na pr√°tica (fig. 1), o contador-chefe ficou satisfeito, tudo correu maravilhosamente bem.  Ao longo do caminho, descobriu-se que os usu√°rios gostam de escolher suas pr√≥prias imagens de fundo, neste caso, para trabalhar nos "sete".  Para o G8, nosso componente √© adaptado com uma reserva para o futuro, embora deva ser considerado como uma vers√£o demo. <br><br>  O interesse aqui foi que <b><i>esse componente n√£o exigisse conformidade com a tecnologia de cria√ß√£o de componentes externos a partir de 1C</i></b> .  Talvez surjam id√©ias adicionais para expandir suas capacidades.  Por exemplo, para configura√ß√µes totalmente suportadas, voc√™ n√£o deseja fazer altera√ß√µes no c√≥digo 1C sem necessidade especial.  Nesse caso, pode-se oferecer a op√ß√£o de carregar externamente uma dll arbitr√°ria no espa√ßo de endere√ßo 1C.  Mas este √© o t√≥pico de outro artigo. <br><br>  Das inova√ß√µes t√©cnicas, um bloqueio foi usado para descarregar nosso componente com a plataforma 1C (uma vez que n√£o est√° em conformidade com o formato VK).  Al√©m disso, outro truque tornou poss√≠vel atribuir um <b>menu local</b> √† janela filho, pois o sistema operacional Windows bloqueia a cria√ß√£o desse menu para janelas subordinadas.  Portanto, voc√™ n√£o ver√° menus locais no mesmo <b>MDI</b> (Multi Document Interface) em nenhum lugar.  Ele √© substitu√≠do por pain√©is de comando, barras de ferramentas e um menu de contexto.  Ainda h√° um momento para atualizar o Windows.  √Äs vezes, acontece que nem <b>UpdateWindow ()</b> nem <b>InvalidateRect ()</b> funcionam corretamente.  Mas algumas fun√ß√µes neste caso s√£o bem-sucedidas: <br><br><pre><code class="cpp hljs">ShowWindow(hWnd, SW_HIDE); ShowWindow(hWnd, SW_SHOW);</code> </pre> <br>  Observe tamb√©m que nosso componente pode entrar em conflito com outras pessoas, por exemplo, com o FormEx.dll para 1C77.  Nesse caso, ele precisa ser carregado por √∫ltimo. <br><br>  A prop√≥sito, note-se que, se voc√™ criar uma configura√ß√£o na vers√£o 1C-8.3.14 e superior, o componente n√£o ser√° carregado de maneira regular.  Mas se o banco de dados foi criado em uma vers√£o anterior do 1C e aberto nas vers√µes mais recentes, n√£o h√° problemas ao carregar nosso VK.  Isso mais uma vez sugere a necessidade de criar um carregador de inicializa√ß√£o externo. <br><br>  Este projeto usa o subsistema <b>WinAPI GDI +</b> .  Com ele, voc√™ pode exibir imagens de v√°rios formatos: <b>bmp, jpg, gif, png, tif</b> e outros.  Na mesma ordem, o componente tenta carregar o primeiro arquivo <b>Main. *</b> Dispon√≠vel no diret√≥rio local do <b>Pics</b> na configura√ß√£o atual.  Se nenhum desses arquivos for encontrado, uma imagem de plano de fundo simples dos recursos do componente ser√° usada.  Na fig.  A Figura 13 mostra essa imagem de plano de fundo para as formas usuais do 1C83 de 64 bits, vers√£o 15. Para uma mudan√ßa, a janela externa da g√≠ria foi ampliada e outra imagem do arquivo <b>Main1.png</b> , que foi ‚Äúlado a lado‚Äù, foi adicionada ao plano de fundo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/71c/80a/48a/71c80a48a18236e495a1d62b0f316e11.jpg" alt="Fig.  13. O papel de parede padr√£o para formul√°rios regulares 1C83 de 64 bits, vers√£o 15"><br>  Fig.  13. A imagem de plano de fundo padr√£o para as formas usuais do 1C83 de 64 bits, vers√£o 15. Al√©m disso, foi adicionada outra imagem do arquivo Main1.png, colocada em mosaico. <br><br>  N√£o h√° diferen√ßa na opera√ß√£o do componente em diferentes modos de bits. <br><br>  Tamb√©m √© poss√≠vel observar que nosso componente subclasse a janela principal 1C e seu cliente MDI, se houver.  Aparentemente, isso serve como fonte de conflito com o FormEx.dll quando ele √© carregado pela √∫ltima vez (em 1C77). <br><br><h2>  Parte Dois - T√©cnico </h2><br>  O projeto em si pode ser encontrado nos seguintes links: <br><br><ul><li>  <a href="">Configura√ß√£o de teste em 1C77</a> </li><li>  <a href="">Configura√ß√£o de teste em 1C82</a> </li><li>  <a href="">Configura√ß√£o de teste em 1C83</a> </li><li>  <a href="">Projeto no MS VS C ++, v.</a>  <a href="">13</a> </li></ul><br>  Um projeto <b>C ++</b> pode ser facilmente adaptado para a vers√£o <b>10</b> se a string " <b>v120</b> " for substitu√≠da por " <b>v100</b> " e " <b>ToolsVersion =" 12.0 "</b> " por " <b>ToolsVersion =" 4.0 "</b> nos arquivos de configura√ß√£o. <br><br>  O c√≥digo para as vers√µes de <b>32</b> bits e <b>64</b> bits do <b>1C √©</b> o mesmo e pode ser compilado ao mesmo tempo. <br><br>  A vers√£o 1C77 √© determinada no componente externo pelo <b>identificador da</b> fun√ß√£o GetMenu <b>()</b> diferente de zero e a vers√£o 1C83, pela aus√™ncia de janelas filho na janela principal, cujo identificador √© determinado pela fun√ß√£o <b>GetForegroundWindow ()</b> . <br><br><h3>  Sobre a tecnologia de cria√ß√£o de componentes externos para 1C </h3><br>  Nos discos ITS da empresa 1C e na Internet, √© poss√≠vel encontrar facilmente informa√ß√µes sobre a cria√ß√£o do VC e os modelos correspondentes em diferentes linguagens de programa√ß√£o.  No entanto, nos tempos de 1C77, esses padr√µes satisfaziam "n√£o apenas todos". <br><br>  Se voc√™ observar alguns componentes amplamente utilizados, especialmente para 1C77, ver√° que seus autores costumavam usar m√©todos de programa√ß√£o especiais para expandir os recursos de seus projetos. <br><br>  Talvez um dos primeiros componentes externos tenha sido <b><i>"RAINBOW ADDIN 2000 for 1C: Enterprise 7.7"</i></b> .  Talvez o mais importante aqui tenha sido uma penetra√ß√£o mais profunda nas entranhas dos "sete" do que a tecnologia oficial da VK permitia, embora seguisse o formato da VK.  Isso foi alcan√ßado devido aos m√©todos recebidos, possivelmente n√£o padronizados, dos cabe√ßalhos (arquivos * .h) dos arquivos de biblioteca 1C77 usados ‚Äã‚Äãem outros projetos amplamente conhecidos. <br><br>  De fato, se fun√ß√µes 1C como <b>LoadExternalComponent ()</b> e <b>ConnectExternalComponent ()</b> permitem incorporar <b>DLLs externas</b> em seu pr√≥prio espa√ßo de endere√ßo (antes de tudo, que satisfa√ßam o formato da tecnologia VK), por que os programas do usu√°rio n√£o sucumbem √† tenta√ß√£o e tentam acessar outros ocultos? procedimentos, e outros objetos da plataforma de destino?  Essa abordagem foi demonstrada com √™xito pelo componente <b>Rainbow.dll</b> . <br><br>  Posteriormente, um mecanismo semelhante foi adotado por outros autores do componente 1C vers√£o 7.7.  De nota particular √© o componente para o "seven" <b>1C ++. Dll</b> e, por assim dizer, um caso especial de <b>FormEx.dll</b> . <br><br>  Mas a abordagem n√£o trivial ao design de componentes externos para 1C77 n√£o terminou a√≠.  Aparentemente, algu√©m deveria ter dito: ‚ÄúPor que precisamos de um ferreiro?  N√≥s n√£o precisamos de um ferreiro! "  Aqui, por "ferreiro", entendemos a tecnologia COM da MicroSoft, que, em certo sentido, foi seguida pela tecnologia VK para os "sete".  N√£o, bem, s√©rio, por que precisamos de um registro se baixarmos nosso VK diretamente?  Isso pode fazer sentido para navegadores da Web que funcionam com a Internet, mas para opera√ß√µes locais, o uso do registro √© claramente redundante.  No m√≠nimo, isso n√£o deve ser um pr√©-requisito.  Al√©m disso, para editar o registro, voc√™ precisa de direitos administrativos. <br><br>  Observe que 1C gostava muito dessa tecnologia (pelo menos at√© portar 1C para Linux).  N√≥s a tratamos bem legal.  O COM √© conveniente para o uso do componente ActiveX, e isso √© natural, pois os √∫ltimos foram originalmente desenvolvidos para a Internet. <br><br>  No entanto, nas vers√µes mais recentes, o 1C adicionou a capacidade de usar a tecnologia <b>API nativa</b> , o que elimina a necessidade de um registro.  Em princ√≠pio, √© disso que precisamos, exceto que essa tecnologia n√£o √© aplic√°vel nos "sete" e, para alguns, ainda √© relevante. <br><br>  √Äs vezes, por√©m, tarefas relativamente simples surgem quando voc√™ n√£o deseja usar um monte de c√≥digo padr√£o para o VK e √© aconselh√°vel trabalhar com 1C apenas do lado do componente externo.  Como, digamos, no nosso caso, a demonstra√ß√£o de uma imagem de congratula√ß√µes na √°rea do cliente ou, se necess√°rio, em uma janela separada, a configura√ß√£o 1C. <br><br>  Em outras palavras, se n√£o vamos trocar dados diretamente entre 1C e VK, ficaremos muito felizes com uma vers√£o mais simples e universal do componente externo para 1C.  A simplicidade aqui ser√° alcan√ßada devido √† falta de c√≥digo padr√£o. <br><br><h3>  Tecnologia alternativa para a cria√ß√£o de VK para 1C </h3><br>  Como o VK for 1C √© um caso especial de <b>servidor COM</b> (antes da tecnologia <b>Native API</b> ), houve desenvolvedores de VK que disseram: "COM - n√£o!".  A atividade nessa dire√ß√£o de <b><i>Alexander Orefkov</i></b> √© especialmente not√°vel.  Seus componentes " <b>1sqlite.dll</b> ", " <b>TurboMD.dll</b> " e possivelmente outros n√£o usam COM da palavra "completamente".  O componente <b>Yoksel</b> (" <b>SpreadSheet.dll</b> ") tamb√©m se desenvolve nesse caminho. <br><br>  Mas como ent√£o o carregador VK de 1C77 carrega esses componentes?  Afinal, eles nem tentam imitar algum tipo de COM l√°.  De fato, se tentarmos colocar uma dll padr√£o gerada pelo assistente do <b>MS VC ++</b> sem rodeios, digamos, na fun√ß√£o <b>LoadExternalComponent ()</b> , teremos uma chatice. <br><br>  Nos "sete", recebemos uma mensagem como: <blockquote>  Ocorreu um erro ao criar um objeto do componente .dll &lt;Caminho completo \ Nome do componente&gt;. (Falta o CLSID) </blockquote><br>  No "grosso" cliente de 32 bits da mensagem "oito" ser√° semelhante.  A mesma DLL causar√° um palavr√£o semelhante (Fig. 15): <blockquote>  Erro ao chamar o m√©todo de contexto (Carregar componente externo): Erro ao carregar o componente externo </blockquote><br>  Ainda assim, como as bibliotecas mencionadas resolvem esse problema?  Estudando os textos dos programas Orefkov e Yoksel, finalmente conclu√≠mos que as seguintes " <b>linhas m√°gicas</b> " no arquivo de recursos (* .rc ou * .rc2) s√£o "respons√°veis": <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0sd" // 1sqlite.dll 100 "\0tmd" // TurboMD.dll 100 "\0f" // SpreadSheet.dll END</code> </pre> <br>  I.e.  sem falha, nos recursos do programa h√° uma linha com o identificador <b>100</b> e algum valor de sequ√™ncia, cujo primeiro caractere √© zero.  Voc√™ pode experimentar varia√ß√µes dessas cadeias, mas a cadeia " <b>\ 0L</b> " est√° bem comigo.  Assim, criamos um arquivo de recurso e escrevemos linhas como esta: <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0L" //    1     ! END</code> </pre> <br>  Conectamos esse arquivo ao nosso projeto dll mais simples gerado pelo assistente do MS C ++, adicione o c√≥digo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: MessageBox(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">",  DllMain()!"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, MB_OK); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_ATTACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  e observe (Fig. 14). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/715/a71/7f7/715a717f7ee778dd219e79e5fbd43e97.jpg" alt="Fig.  14. Uso do &quot;VK&quot; mais simples em 1C82"><br>  Fig.  14. Uso do "VK" mais simples em 1C82. <br><br>  Sem "linhas m√°gicas" no arquivo de recursos, nossa DLL, ap√≥s mostrar o MessageBox, descarrega imediatamente com uma maldi√ß√£o de 1C (Fig. 15). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/cec/432/a98cec4326033180917940aa248dbc96.jpg" alt="Fig.  15. Erro ao carregar uma dll regular em 1C82"><br>  Fig.  15. Erro ao carregar a dll regular em 1C82. <br><br>  Ou seja, essas linhas realmente t√™m um efeito m√°gico no carregador de componentes externos 1C. <br><br>  A primeira, ao que parece, ‚Äúlinhas m√°gicas‚Äù foi descrita em seu antigo artigo por <b><i>Alexei Fedorov (ALF)</i></b> , mas o link para ele n√£o est√° mais dispon√≠vel e o autor n√£o v√™ o ponto em sua republica√ß√£o.  Al√©m disso, <b><i>Alexander Orefkov os</i></b> usou com mais intensidade e, aparentemente, a partir de sua submiss√£o, o autor era <b><i>Yoksel</i></b> .  Portanto, falaremos sobre as <b><i>linhas "m√°gicas" de Fedorov-Orefkov</i></b> .  Seu significado √© bloquear o descarregamento de arquivos dll n√£o padr√£o (do ponto de vista de 1C) pela fun√ß√£o <b>LoadExternalComponent ()</b> .  Al√©m disso, como vemos, essa t√©cnica funciona n√£o apenas em 1C77, mas tamb√©m em formas 1C82 "grossas". <br><br>  No entanto, nos formul√°rios gerenciados 1C82 e em todas as vers√µes do 1C83, esse recurso j√° foi completamente quebrado (outro carregador tamb√©m apareceu - <b>ConnectExternalComponent ()</b> ). <br><br>  Assim, nas vers√µes modernas de 1C, voc√™ precisa procurar outras alternativas simples para as linhas "m√°gicas" de Fedorov-Orefkov. <br><br>  E essa alternativa √© f√°cil de oferecer.  O ponto √© simples.  O carregador 1C descarrega o componente ‚Äúerrado‚Äù se lan√ßar uma exce√ß√£o ao tentar acess√°-lo usando o protocolo especificado, por exemplo, ao solicitar a vers√£o do componente.  Naturalmente, n√£o temos nada desse tipo, que serve como base para descarregar uma dll n√£o padr√£o.  Mas o requisito de 1C para o sistema operacional descarregar essa biblioteca din√¢mica pode ser ignorado pelo sistema se esse VK ainda for usado em algum lugar.  Em vez da exclus√£o, o sistema simplesmente reduz o contador de uso do m√≥dulo desejado.  E exclua fisicamente n√£o antes que esse contador seja redefinido.  Portanto, nossa tarefa √© aumentar artificialmente esse contador. <br><br>  Para fazer isso, voc√™ pode chamar nossa fun√ß√£o DLL WinAPI <b>LoadLibrary ()</b> novamente na se√ß√£o <b>DLL_THREAD_ATTACH</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: { WCHAR szDllName[_MAX_PATH] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-comment"><span class="hljs-comment">//     dll GetModuleFileName(hModule, szDllName, _MAX_PATH); //MessageBox(NULL, szDllName, L"Info", MB_OK); //    dll (     183), //      DLL_PROCESS_ATTACH HMODULE hDll = LoadLibrary(szDllName); break; } // case DLL_PROCESS_ATTACH case DLL_THREAD_ATTACH: break; case DLL_THREAD_DETACH: break; case DLL_PROCESS_DETACH: break; } // switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  Isso √© tudo!  O problema est√° resolvido.  A recupera√ß√£o da mesma biblioteca din√¢mica aumentar√° seu contador de uso em um e o descarregamento (com acesso preliminar √† se√ß√£o <b>DLL_THREAD_DETACH</b> ) diminuir√° em um.  No total, temos <b>2 - 1 = 1&gt; 0</b> , portanto, o sistema operacional n√£o descarregar√° nossa DLL.  Al√©m disso, o que √© importante, a reinicializa√ß√£o da se√ß√£o <b>DLL_PROCESS_ATTACH</b> n√£o ocorrer√°. <br><br>  A partir disso, a prop√≥sito, pode-se ver como o 1C pode lidar com um truque semelhante em suas vers√µes mais recentes (e, aparentemente, ele j√° faz isso nas configura√ß√µes criadas em 1C-8.3.14 e superior).  Ele pode usar a fun√ß√£o <b>LoadLibraryEx ()</b> com um par√¢metro que bloqueia a execu√ß√£o da se√ß√£o de inicializa√ß√£o <b>DLL_PROCESS_ATTACH</b> , ap√≥s o qual chamar√° imediatamente as fun√ß√µes exportadas necess√°rias.  E, de fato, se voc√™ olhar o c√≥digo do exemplo da VK para a API nativa, poder√° ver que n√£o h√° necessidade de chamar o c√≥digo de inicializa√ß√£o, pois ele deve estar vazio pelo formato VK. <br><br>  Em rela√ß√£o aos exemplos de uso da tecnologia COM, √© √≥bvio que a execu√ß√£o da se√ß√£o de inicializa√ß√£o <b>DLL_PROCESS_ATTACH</b> √© necess√°ria l√°, portanto, em vers√µes n√£o muito novas de 1C, mais precisamente, nas configura√ß√µes feitas em 1C-8.3.13 e abaixo, o carregador 1C √© adequado para n√≥s: <br><br><pre> <code class="plaintext hljs">(, , .COM);</code> </pre> <br>  Aqui o √∫ltimo par√¢metro pode ser removido, pois est√° impl√≠cito por padr√£o.  Ao mesmo tempo, eles podem abrir normalmente em qualquer vers√£o superior.  Nas vers√µes 1C83, o carregador de inicializa√ß√£o anterior <b>LoadExternalComponent (Endere√ßo do componente)</b> n√£o √© mais adequado para n√≥s (respectivamente, as ‚Äúlinhas m√°gicas‚Äù de Fedorov-Orefkov n√£o funcionam l√°). <br><br>  No caso geral, como j√° mencionado, o problema pode ser resolvido usando um carregador de inicializa√ß√£o externo.  Ou, o que √© bastante natural, observar, de uma maneira ou de outra, a tecnologia dos componentes externos de 1C. <br><br>  Deve-se notar tamb√©m que os experimentos que realizamos nas vers√µes de arquivo de 1C com diferentes profundidades de bits.  Para baixar nosso componente, pode ser necess√°rio definir a propriedade " <b>Modo de uso de chamada s√≠ncrona</b> " como " <b>Usar</b> " na configura√ß√£o. <br><br>  Tamb√©m deve ser entendido que voc√™ realiza o uso de tal t√©cnica por seu pr√≥prio risco, experimenta previamente configura√ß√µes de teste ou c√≥pias de trabalhadores para evitar poss√≠veis problemas nos programas principais. <br><br><h3>  Atualiza√ß√£o de 11/09/2019 </h3><br>  Acontece que fiquei em v√£o preocupado que: ‚Äúnas vers√µes 1C-8.3.14 e superior, a se√ß√£o de inicializa√ß√£o no componente externo n√£o √© mais executada a partir da palavra‚Äú completamente ‚Äù.‚Äù <br><br>  Acontece que apenas a mensagem de retorno na fun√ß√£o <b>ConnectExternalComponent ()</b> n√£o precisa ser processada.  Al√©m disso, independentemente do tipo de componente especificado: <b>COM</b> ou <b>API nativa</b> . <br><br>  Assim, voc√™ pode criar uma configura√ß√£o em todas as vers√µes atualmente dispon√≠veis do 1C, nosso componente deve funcionar bem em qualquer lugar e a cria√ß√£o de um gerenciador de inicializa√ß√£o externo ser√° relevante, a menos que voc√™ n√£o queira alterar a configura√ß√£o, que √© totalmente suportada. <br><br>  Nesse sentido, o c√≥digo nas configura√ß√µes de teste para 1C82 e 1C83 √© ligeiramente alterado, embora as diferen√ßas entre eles n√£o sejam mais fundamentais. <br><br>  Ao mesmo tempo, nossa observa√ß√£o de que a empresa 1C pode bloquear facilmente a execu√ß√£o do c√≥digo de inicializa√ß√£o em qualquer VK, pelo menos para componentes externos como a <b>API nativa</b> , obviamente permanece v√°lida, porque, a julgar pelo modelo, isso n√£o √© necess√°rio.  Para um <b>COM do</b> tipo VK <b>, existe</b> uma necessidade at√© agora, mas o que impede que ele se livre?  Ao mesmo tempo, vamos ver se eles levar√£o essas informa√ß√µes em considera√ß√£o? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt466713/">https://habr.com/ru/post/pt466713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt466699/index.html">Domesticar protocolos de confian√ßa - autentica√ß√£o OAuth com o InterSystems IRIS</a></li>
<li><a href="../pt466701/index.html">Let's Encrypt serve quase 30% dos dom√≠nios</a></li>
<li><a href="../pt466705/index.html">Vivaldi Beta para Android - Navegador Real</a></li>
<li><a href="../pt466709/index.html">Desenvolvendo um sistema operacional monol√≠tico semelhante a Unix - C Library (2)</a></li>
<li><a href="../pt466711/index.html">Vulnerabilidade O DaOffice permitiu remover qualquer usu√°rio da rede social</a></li>
<li><a href="../pt466719/index.html">Perfil de velocidade superluz: teoria e pr√°tica. Parte 1</a></li>
<li><a href="../pt466721/index.html">[Yekaterinburg, an√∫ncio] java.ural.Meetup @ 3 - an√∫ncio do terceiro relat√≥rio de v√≠deo mitap + Java de java.ural.Meetup @ 2</a></li>
<li><a href="../pt466723/index.html">Transmiss√£o de texto da Apple - 10 de setembro de 2019</a></li>
<li><a href="../pt466725/index.html">O punhal 2 √© elementar (parte 1)</a></li>
<li><a href="../pt466727/index.html">Atualiza√ß√£o pregui√ßosa: como o PostgreSQL 12 melhora o desempenho</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>