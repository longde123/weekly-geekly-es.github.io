<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè§ üí™üèø üë®üèæ‚Äçüîß Comment √©valuer la capacit√© du service et ne pas tomber sous la charge üí≤ üèáüèæ üë®‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="T√¥t ou tard, tout service en pleine croissance doit √©valuer ses capacit√©s techniques. Combien de visiteurs pouvons-nous servir? Quelle est la capacit√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment √©valuer la capacit√© du service et ne pas tomber sous la charge</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/481134/"><img src="https://habrastorage.org/webt/-s/kl/8y/-skl8ysedkaeho-x6lw7-laelwi.png"><br><br>  T√¥t ou tard, tout service en pleine croissance doit √©valuer ses capacit√©s techniques.  Combien de visiteurs pouvons-nous servir?  Quelle est la capacit√© du syst√®me?  Avons-nous atteint la limite et ne tomberons pas si nous attirons plusieurs milliers d'utilisateurs suppl√©mentaires?  Combien de ressources informatiques suppl√©mentaires sont budg√©tis√©es pour l'ann√©e prochaine pour r√©pondre aux plans de croissance? <br><br>  Les r√©ponses peuvent √™tre obtenues de mani√®re analytique en adressant des questions √† un d√©veloppeur / DevOps / SRE / admin exp√©riment√©.  La fiabilit√© de l'√©valuation d√©pend d'un grand nombre de facteurs: √† partir du rythme de remplissage du syst√®me avec des fonctionnalit√©s et du graphique des relations entre les composants et se terminant par le temps que l'expert a pass√© la matin√©e dans la circulation.  Plus le syst√®me est complexe, plus il y a de doute sur l'ad√©quation de l'√©valuation analytique. <br><br>  Je m'appelle Maxim Kupriyanov, depuis cinq ans maintenant je travaille chez Yandex.Market.  Aujourd'hui, je vais dire aux lecteurs de Habr comment nous avons appris √† √©valuer la capacit√© de nos services et ce qui en est ressorti. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/dj/-4/ho/dj-4hoqd3ddi5lpwrokluke77ok.png"><br><br><h2>  Nous allons √† la position </h2><br>  La structure des composants du march√© est plut√¥t compliqu√©e, nous avons donc d√©cid√© d'√©valuer la capacit√© des services les plus importants et les plus chers en mati√®re de mise √† l'√©chelle.  De plus, le nombre quotidien de demandes en la mati√®re devrait clairement d√©pendre de la taille de l'audience quotidienne du March√© (utilisateurs actifs quotidiens, DAU).  Pourquoi exactement de DAU?  Parce que les analystes, faisant des pr√©visions pour les mois et les ann√©es √† venir, calculent toujours la taille future de l'audience, et nous profiterons de cette circonstance agr√©able. <br><br>  Parlons maintenant sans lequel il est impossible de construire des √©valuations objectives: sur les m√©triques du service.  Si le nombre de demandes de service d√©pend de la DAU, alors nous avons certainement besoin de la m√©trique "demandes par seconde" (demandes par seconde, RPS).  De plus, pour √©valuer la qualit√© du service, vous devez conna√Ætre le pourcentage d'erreurs et les temps de r√©ponse (d√©lais de demande).  L'erreur sera consid√©r√©e comme une r√©ponse avec un code HTTP de 500 ou sup√©rieur.  Les erreurs de la gamme 4xx sont c√¥t√© client et, dans un syst√®me fonctionnant normalement, ne disent g√©n√©ralement rien des probl√®mes de service.  En ce qui concerne les d√©lais, il est habituel pour nous de calculer et de stocker les 80e, 95e, 99e et 99,9e centiles de temps de r√©ponse, mais un ensemble sp√©cifique peut diff√©rer l√©g√®rement d'un service √† l'autre. <br><br>  Nous avons donc des mesures de la fr√©quence des demandes, du pourcentage d'erreurs et d'un ensemble de centiles de temps de r√©ponse.  Et nous connaissons √©galement le service DAU pour chaque jour et pour les p√©riodes futures (sous forme de pr√©visions).  √âtant donn√© que les mod√®les moyens de comportement des utilisateurs ne changent pas trop d'un jour √† l'autre, disons ce qui suit: connaissant le RPS dans la p√©riode la plus active de la journ√©e de travail (pic RPS), nous pouvons pr√©dire le pic RPS pour les p√©riodes futures, √† condition que nous ayons une pr√©vision DAU.  Et vice versa: si nous savons combien de demandes par seconde le syst√®me peut supporter sans violer l'accord sur le temps de r√©ponse et le pourcentage d'erreurs, alors nous pouvons estimer le public que nous pouvons servir, c'est-√†-dire que nous connaissons la capacit√© du syst√®me. <br><br>  Eh bien, nous avons d√©cid√© de la t√¢che: fixer les d√©lais de r√©ponse et le pourcentage d'erreurs sous forme d'accords et trouver le RPS maximum que le syst√®me peut supporter dans ces conditions.  Comment allons-nous d√©cider? <br><br><img src="https://habrastorage.org/webt/wf/zk/ea/wfzkeajjy8urgrmv0xib56c9nj8.png"><br><br><h2>  Nous tirons sur la cible </h2><br>  Voici une approche classique pour r√©soudre le probl√®me: nous collectons un site de test, prenons les journaux syst√®me de l'environnement de production, en faisons des cartouches et d√©clenchons le syst√®me, augmentant la fr√©quence des demandes, jusqu'√† ce que le site montre une d√©gradation significative des d√©lais de r√©ponse et / ou des erreurs.  √Ä ce stade, nous nous arr√™tons et fixons la fr√©quence des demandes (le m√™me RPS).  Victoire  Peu importe comment.  Et voici pourquoi: <br><br><ul><li>  le site de test, en r√®gle g√©n√©rale, n'est pas identique √† la plate-forme sous le service dans l'environnement de production; </li><li>  le code service change tous les jours, voire plus souvent; </li><li>  les exp√©riences peuvent influencer la charge; </li><li>  la gravit√© des demandes des utilisateurs d√©pend de l'heure de la journ√©e et d'autres conditions; </li><li>  les services modernes fonctionnent rarement de mani√®re isol√©e, le plus souvent ils font des sous-requ√™tes √† d'autres services, et cela devra √™tre pris en compte d'une mani√®re ou d'une autre. </li></ul><br>  Am√©lioration: nous lancerons le service automatiquement tous les jours, en collectant les cartouches dans les magazines aux heures de pointe.  Et afin de ne pas gaspiller les ressources sur un site de test, nous allons commencer √† d√©cortiquer √† tour de r√¥le les composants qui nous int√©ressent sur le m√™me stand.  Cela semble compliqu√© et ne r√©sout pas tous les probl√®mes.  Mais quelles sont les autres options? <br><br><img src="https://habrastorage.org/webt/sb/ub/zp/sbubzp0dbuxhrpqtdxt6fichhqk.png"><br><br><h2>  Simuler la r√©alit√© </h2><br>  L'id√©e g√©n√©rale est la suivante: nous copions une partie du trafic des √©quilibreurs sur le site, o√π nous collectons l'analogue complet de l'environnement de production en miniature et, en ajustant le volume du trafic copi√©, nous recherchons le point de d√©gradation.  L'id√©e est belle, et nous sur le march√© faisons cela pour tester de nouvelles fonctionnalit√©s et comparer le comportement des nouvelles versions avec les anciennes.  Mon coll√®gue Eugene en a <a href="https://habr.com/ru/company/yandex/blog/475848/">parl√©</a> en d√©tail - voir la section sur le cluster fant√¥me.  Mais il y a aussi des difficult√©s √©videntes: <br><br><ul><li>  le probl√®me de l'interaction avec les composants externes n'est pas r√©solu, car il est tr√®s co√ªteux de faire une copie de tout l'environnement de production; </li><li>  les journaux de demande du syst√®me miroir peuvent accidentellement se m√©langer avec les journaux de l'environnement de production, ce qui signifie qu'il est n√©cessaire de construire un syst√®me avec marquage du trafic miroir afin qu'il puisse ensuite √™tre trouv√© et nettoy√©; </li><li>  les demandes sont g√©n√©ralement refl√©t√©es en totalit√© ou en pourcentage du total, et une telle pr√©cision ne nous convient pas (mais cela peut √™tre r√©solu, nous travaillons dans ce sens). </li></ul><br>  En g√©n√©ral, l'imitation de la production est une approche tr√®s bonne et prometteuse, mais tr√®s co√ªteuse et avec des limitations importantes. <br><br><img src="https://habrastorage.org/webt/bh/pd/-8/bhpd-89lwirxbq9ywgv73803qqo.png"><br><br><h2>  Test directement en production </h2><br>  Et puis nous sommes enfin arriv√©s au d√©licieux.  Pour chaque composant test√©, nous cr√©ons une instance distincte en production, dont la fr√©quence des demandes est r√©gul√©e √† partir de l'√©quilibreur avec une grande pr√©cision.  La derni√®re fois, les <a href="https://habr.com/ru/company/yandex/blog/475848/">lecteurs nous ont demand√©</a> : ¬´HAProxy est-il suffisant pour vous?  Avait-on besoin d'√©crire quelque chose de ton c√¥t√©? ¬ª  C'est donc le cas tr√®s rare o√π ce n'√©tait pas suffisant et j'ai d√ª √©crire. <br><br>  Dans le m√™me temps, il existe un service distinct qui surveille √©troitement les m√©triques de l'instance charg√©e et, lorsque les indicateurs approchent des valeurs critiques, il ferme la vanne sur l'√©quilibreur, r√©duisant la fr√©quence des demandes.  Si le service fonctionne dans des limites acceptables, la vanne s'ouvre au contraire.  Bien s√ªr, les seuils de synchronisation et d'erreurs lors du chargement d'un service en direct sont sensiblement plus conservateurs (g√©n√©ralement de 5 √† 10%) que sur le terrain d'entra√Ænement, car nous ne voulons pas aggraver l'interaction avec les utilisateurs.  Ainsi, l'instance charg√©e fonctionne toujours √† la limite.  Nous fixons ces indicateurs.  Et puis nous avons l'arithm√©tique: nous connaissons le nombre de c≈ìurs de service sous charge √† chaque instant, nous connaissons la DAU hier.  √Ä partir de l√†, nous consid√©rons le recyclage, les r√©serves de capacit√© et les options de comportement du syst√®me lors de la d√©sactivation de l'un ou l'autre emplacement.  Tout cela se trouve dans la base √† partir de laquelle de beaux graphismes sont construits.  Sur la base de ces donn√©es, lorsque la capacit√© tombe en dessous du seuil, des alertes sont d√©clench√©es. <br><br><h2>  Regardons les graphiques </h2><br><img src="https://habrastorage.org/webt/lt/nb/pa/ltnbpanor5tjwa-ljrej4darzcm.png"><br><br>  C'est ainsi que nous contr√¥lons le flux de trafic vers l'instance test√©e.  L'√©tape peut √™tre un multiple de 1 RPS.  Sur le graphique, √† titre d'illustration, nous avons mod√©lis√© une mont√©e avec un intervalle de trois minutes: d'abord, de 650 √† 1K RPS par incr√©ments de 50, puis de 200 √† 1K RPS par incr√©ments de 100. Permettez-moi de vous rappeler qu'il s'agit d'un trafic utilisateur r√©el auquel les clients ont re√ßu des r√©ponses. <br><br><img src="https://habrastorage.org/webt/yl/hp/ma/ylhpma60p6keqxgzmsshgvqs1dm.png"><br><br>  Cela montre RPS pour trois instances: une sous charge et deux sous contr√¥le.  Le sujet a √©t√© artificiellement fix√© une limite sup√©rieure de 600 RPS.  Le service est peut-√™tre plus, mais il devient trop instable et d√©pend des influences ext√©rieures.  On voit bien que dans la premi√®re moiti√© de la journ√©e, les demandes de service sont en moyenne plus lourdes et l'instance ne peut atteindre sa capacit√© de pointe dans des conditions acceptables, mais vers le soir, tout revient √† la normale.  Les rafales et les omissions sur le graphique sont des red√©marrages d'instance pour la pr√©sentation des versions et d'autres mises √† jour (elles sont toutes en cours d'√©quilibrage, personne n'a √©t√© bless√©).  Et les ajustements RPS √©tape par √©tape sur le sujet du test ne sont que le travail d'un algorithme qui cherche la limite des possibilit√©s. <br><br><img src="https://habrastorage.org/webt/3y/du/mw/3ydumwukuqrnergvj0li5mqxary.png"><br><br>  La fr√©quence des demandes de service et la charge qu'une instance peut supporter sont clairement visibles. <br><br><img src="https://habrastorage.org/webt/hy/jj/mt/hyjjmtgnuwgdrkla6_k42za5x_c.png"><br><br>  Et ici, nous recalculons tout en pourcentage d'utilisation.  Le graphique montre que le service √©tait assez lourdement charg√© et lorsque l'un des emplacements √©tait d√©sactiv√©, il y avait des risques de partir pour SLA.  Mais maintenant tout va bien: des ressources ont √©t√© ajout√©es au service, le recyclage est revenu √† des limites acceptables. <br><br>  Ainsi, les tests de charge en production vous permettent d'√©valuer rapidement la capacit√© du syst√®me et de pr√©dire la consommation des ressources pour les p√©riodes futures.  Dans le m√™me temps, le syst√®me n'ajoute en fait pas de d√©penses appr√©ciables et vous pouvez travailler en toute s√©curit√© avec des services avec √©tat, car nous ne g√©n√©rons pas de nouveau trafic, mais redistribuons avec pr√©cision celui qui l'est.  Et enfin: pour fonctionner, en r√®gle g√©n√©rale, il n'est pas n√©cessaire de modifier le code du syst√®me exp√©rimental lui-m√™me, ce qui permet de tester m√™me les applications h√©rit√©es. <br><br><img src="https://habrastorage.org/webt/bn/fe/bd/bnfebdjggyt-wbi914qf_z9dcnu.png"><br><br><h2>  R√©fl√©chir </h2><br>  Cette m√©thodologie n'a pas fonctionn√© sur le march√© depuis plus d'un an, et nous pouvons partager des observations et des recommandations: <br><br><ul><li>  √Ä c√¥t√© de l'instance charg√©e, il doit y avoir un contr√¥le ordinaire, et de pr√©f√©rence de la vapeur, car la d√©gradation se produit souvent non pas parce que l'instance est surcharg√©e, mais √† cause de probl√®mes g√©n√©raux avec le service dans son ensemble. </li><li>  La technique ne fonctionne bien qu'avec les composants dont la charge est sup√©rieure √† des centaines de requ√™tes par seconde pour un emplacement.  La raison est assez simple: nous devons charger √† la fois l'instance test√©e et une ou deux commandes.  S'il n'y a pas assez de trafic, nous n'atteindrons pas la saturation ou nous ne pourrons pas comparer honn√™tement.  Et si le RPS limite par instance est tr√®s petit, alors l'√©tape minimale de changement de la fr√©quence de demande √† 1 RPS peut √™tre trop difficile. </li><li>  Il est pr√©f√©rable de tester les fronts et les backends √† diff√©rents emplacements, afin que les artefacts des backends de test de charge n'affectent pas l'estimation de la capacit√© des fronts. </li><li>  Lorsque nous analysons les d√©lais de r√©ponse et recherchons des signes de d√©gradation, nous prenons g√©n√©ralement des agr√©gats de cinq minutes et comptons la m√©diane afin de ne pas r√©agir aux rafales al√©atoires. </li><li>  La principale raison pour laquelle l'instance charg√©e du service se bloque est l'espace disque pour les fichiers journaux (journaux).  Ils l'oublient toujours. </li><li>  La journalisation sur le disque charg√© des E / S des serveurs Web est une raison tr√®s courante d'aggravation des d√©lais, m√™me sur les SSD.  Activez toujours la mise en m√©moire tampon, l'enregistrement asynchrone et toute autre chose, juste pour ne pas attendre la fin de l'enregistrement. </li><li>  La charge de nuit n'est pas indicative, car les demandes sont en moyenne plus lourdes en raison de la part plus importante de robots.  Par cons√©quent, pour estimer la capacit√©, il est pr√©f√©rable de fixer la plage √† partir de l'heure conventionnelle de la journ√©e, et la nuit uniquement pour r√©duire le flux de demandes si des signes de d√©gradation apparaissent. </li><li>  Le 99,9e centile des d√©lais de r√©ponse est inutile pour l'estimation de la capacit√©, car les garanties de disponibilit√© du r√©seau d√©passent rarement 99%. </li><li>  D√©marrez une chronologie et enregistrez les versions de service et autres √©v√©nements importants.  Il aide √† trouver ce qui a conduit √† une diminution de la capacit√©. </li><li>  Dans une analyse d√©taill√©e des causes de la d√©gradation, le tra√ßage est √©galement utile: un en-t√™te de marqueur est ajout√© √† chaque demande de service, qui va de l'avant au dernier backend et entre tous les journaux.  De cette fa√ßon, vous pouvez suivre l'int√©gralit√© du chemin de demande et comprendre les causes des retards. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481134/">https://habr.com/ru/post/fr481134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481120/index.html">O√π et comment les serveurs Edge sont-ils appliqu√©s?</a></li>
<li><a href="../fr481122/index.html">PostgreSQL Antipatterns: passage d'ensembles et de s√©lections √† SQL</a></li>
<li><a href="../fr481124/index.html">Conseils pour √©crire du code auto-document√©</a></li>
<li><a href="../fr481126/index.html">Union des programmeurs? Ne le dis pas √† mes pantoufles</a></li>
<li><a href="../fr481130/index.html">TOP12 d√©couvertes scientifiques interdisciplinaires 2019</a></li>
<li><a href="../fr481138/index.html">Ces personnes cr√©ent l'intelligence artificielle - 4 histoires de sp√©cialistes de l'IA et du ML</a></li>
<li><a href="../fr481140/index.html">Aide-m√©moire au format de fichier de donn√©es Python</a></li>
<li><a href="../fr481142/index.html">Qt QJSEngine Bonjour tout le monde</a></li>
<li><a href="../fr481146/index.html">Un autre registraire a donn√© le dernier bloc d'adresses IPv4</a></li>
<li><a href="../fr481148/index.html">Probl√®mes de physique inhabituels d√©veloppant la pens√©e scientifique (pour les √©coliers)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>