<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐭 👩‍👩‍👦‍👦 🎍 Dukungan untuk token jwt anonim di IdentityServer4 menggunakan AnonymousIdentity 🧝🏼 🛰️ 🧚🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Baru-baru ini, saya perlu menerapkan dukungan untuk otentikasi pengguna anonim berdasarkan OpenId Connect dan OAuth 2.0 pada platform ASP.NET Core. Sp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dukungan untuk token jwt anonim di IdentityServer4 menggunakan AnonymousIdentity</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466467/"><p><img src="https://habrastorage.org/webt/vd/vv/q_/vdvvq_xuyawe8apt2pdn4flentk.png"><br>  Baru-baru ini, saya perlu menerapkan dukungan untuk otentikasi pengguna anonim berdasarkan OpenId Connect dan OAuth 2.0 pada platform ASP.NET Core.  Spesifikasi protokol ini tidak akan dijelaskan di sini, untuk ini ada artikel lengkap tentang Habr.  Mari kita langsung ke intinya. </p><a name="habracut"></a><br><p>  Mengapa kita membutuhkan token anonim?  Untuk memberi otorisasi kepada pengguna anonim pada sumber daya API, terutama dalam arsitektur layanan mikro, di samping itu, ia dapat mengubah keadaan aplikasi kami, misalnya, Vasya menyukai kaus dengan kucing, ia menambahkannya ke keranjang toko online dan, mungkin, memesan sebagai tamu.  Untuk memahami bahwa itu Mudah, token anonim berisi pengidentifikasi pengguna anonim dan pengidentifikasi sesi.  Ketika dengan mudah masuk, parameter ini akan dimasukkan dalam token yang diautentikasi. </p><br><p>  Selain itu, token akses anonim dapat berisi pernyataan (atau klaim) tambahan. </p><br><h2 id="instrumenty">  Alat-alatnya </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">IdentityServer4</a> untuk mendukung OpenId Connect dan OAuth 2.0 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">AnonymousIdentity</a> untuk mendukung token anonim di <strong>IdentityServer4</strong> </li></ul><br><h2 id="implementaciya">  Implementasi </h2><br><p>  <strong>IdentityServer4</strong> memiliki banyak <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">contoh</a> di GitHub. </p><br><p>  Menambahkan dukungan untuk token anonim cukup sederhana: </p><br><ul><li>  Instal <strong>AnonymousIdentity</strong> dalam sebuah proyek dengan <strong>IdneitityServer4</strong> <br><pre><code class="plaintext hljs">Install-Package AnonymousIdentity</code> </pre> </li><li>  Daftarkan <strong>AnonymousIdentity</strong> di Startup.cs <br><pre> <code class="cs hljs">services.AddIdentityServer() <span class="hljs-comment"><span class="hljs-comment">//   .AddAnonymousAuthentication();</span></span></code> </pre> </li></ul><br><h2 id="scenariy-vzaimodeystviya">  Skenario interaksi </h2><br><p>  Pertimbangkan untuk mendapatkan token anonim untuk <strong>Aliran Implisit</strong> dan <strong>Alur Kode Otorisasi</strong> . </p><br><h3 id="zapros-k-tochke-avtorizacii">  Permintaan Poin Otorisasi </h3><br><p>  Untuk mengikuti spesifikasi, permintaan untuk titik otorisasi untuk <strong>Aliran Implisit adalah</strong> sebagai berikut. </p><br><pre> <code class="plaintext hljs">GET /connect/authorize? client_id=client1&amp; scope=openid email api1&amp; response_type=id_token token&amp; redirect_uri=https://myapp/callback&amp; state=abc&amp; nonce=xyz&amp; acr_values=0&amp; response_mode=json</code> </pre> <br><p>  Untuk <strong>Aliran Kode Otorisasi,</strong> permintaan serupa dengan <em>response_type = kode</em> (PKCE adalah opsional). </p><br><p>  Perbedaan antara permintaan reguler dan anonim dalam dua parameter: </p><br><ul><li>  <em>Acr_values ​​= 0</em> parameter menandakan login anonim.  Jika tertarik, Anda dapat membaca spesifikasi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">OpenId Connect</a> . </li><li>  <em>Response_mode =</em> parameter <em>json</em> digunakan untuk merespons dalam bentuk Json tanpa pengalihan yang tidak perlu. </li></ul><br><h3 id="poluchenie-tokena">  Menerima token </h3><br><p>  Bergantung pada status otentikasi, token anonim atau dikonfirmasi dikembalikan. </p><br><h4 id="implicit-flow">  Aliran tersirat </h4><br><p>  Dalam hal ini, titik otorisasi merespons dalam bentuk Json, termasuk token akses. </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"id_token"</span></span>: &lt;id_token&gt;, <span class="hljs-attr"><span class="hljs-attr">"access_token"</span></span>: &lt;access_token&gt;, <span class="hljs-attr"><span class="hljs-attr">"token_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bearer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"expires_in"</span></span>: <span class="hljs-string"><span class="hljs-string">"2592000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"openid email api1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"state"</span></span>: <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"session_state"</span></span>: &lt;optional&gt; }</code> </pre> <br><h4 id="authorization-code-flow">  Alur Kode Otorisasi </h4><br><p>  Dengan pendekatan ini, titik otorisasi merespons dalam bentuk Json, termasuk kode otorisasi. </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: &lt;authorization_code&gt;, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"openid email api1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"state"</span></span>: <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"session_state"</span></span>: &lt;optional&gt; }</code> </pre> <br><p>  Kemudian, Anda perlu menukar kode untuk token menggunakan metode standar. </p><br><p>  Kami membentuk permintaan ke titik akhir token. </p><br><pre> <code class="plaintext hljs">POST /connect/token client_id=client2&amp; client_secret=secret&amp; grant_type=authorization_code&amp; code=`&amp; redirect_uri=https://myapp/callback</code> </pre> <br><p>  Akibatnya, titik akhir token merespons dalam bentuk Json, termasuk token akses. </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"id_token"</span></span>: &lt;id_token&gt;, <span class="hljs-attr"><span class="hljs-attr">"access_token"</span></span>: &lt;access_token&gt;, <span class="hljs-attr"><span class="hljs-attr">"token_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bearer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"expires_in"</span></span>: <span class="hljs-string"><span class="hljs-string">"2592000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"openid email api1"</span></span> }</code> </pre> <br><h2 id="sravnenie-anonimnogo-i-autentificirovannogo-tokena">  Membandingkan token anonim dan dikonfirmasi </h2><br><p>  Jika server otorisasi tidak berisi data otentikasi, kami mendapatkan token anonim. </p><br><pre> <code class="plaintext hljs">{ "nbf": 1566849147, "exp": 1569441147, "iss": "https://server", "aud": [ "https://server/resources", "api" ], "client_id": "client1", "sub": "abda9006-5991-4c90-a88c-c96764027347", "auth_time": 1566849147, "idp": "local", "ssid": "9e6453dbaf5ffdb03f08812f759d3cdf", "scope": [ "openid", "email", "api1" ], "amr": [ "anon" ] }</code> </pre> <br><p>  Anda dapat menentukan bahwa pengguna anonim menggunakan metode otentikasi (amr). <br>  Pengidentifikasi sesi "umum" (ssid) dan pengidentifikasi subjek (sub) akan dimasukkan dalam token yang diautentikasi, pada login pengguna berikutnya. </p><br><p>  Jika pengguna masuk, kami mendapatkan token yang diautentikasi. </p><br><pre> <code class="plaintext hljs">{ "nbf": 1566850295, "exp": 1566853895, "iss": "https://server", "aud": [ "https://server/resources", "api" ], "client_id": "client1", "sub": "bob", "auth_time": 1566850295, "idp": "local", "aid": "abda9006-5991-4c90-a88c-c96764027347", "ssid": "9e6453dbaf5ffdb03f08812f759d3cdf", "scope": [ "openid", "email", "api1" ], "amr": [ "pwd" ] }</code> </pre> <br><p>  Seperti yang Anda lihat, pengidentifikasi pengguna anonim (bantuan) cocok dengan sub token anonim, seperti halnya ssid.  Jika klien tidak melakukan login anonim, maka token yang diautentikasi hanya akan berisi ssid. </p><br><p>  Dengan demikian, kami dapat mengotorisasi pengguna anonim dan mengidentifikasi tindakannya setelah memasuki sistem. </p><br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><p>  Dalam artikel ini, kami memeriksa skenario untuk memperoleh token anonim / dikonfirmasi menggunakan <strong>IdentityServer4</strong> dengan ekstensi <strong>AnonymousIdentity</strong> . </p><br><p>  Jika Anda memiliki pertanyaan, saya akan dengan senang hati menjawabnya di komentar. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id466467/">https://habr.com/ru/post/id466467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id466457/index.html">Pertanian dan panel surya - strategi win-win untuk insinyur listrik dan petani</a></li>
<li><a href="../id466459/index.html">Tes Integrasi Paralel Postgresql di Aplikasi GO</a></li>
<li><a href="../id466461/index.html">Zabbix Summit 2019: apa yang diharapkan tahun ini</a></li>
<li><a href="../id466463/index.html">Bagaimana kami membuat aplikasi perbaikan prototipe berhenti</a></li>
<li><a href="../id466465/index.html">Summ3r 0f h4ck 2019: hasil penelitian</a></li>
<li><a href="../id466473/index.html">Bagaimana kami menciptakan sistem IoT untuk mengelola penggunaan energi matahari</a></li>
<li><a href="../id466475/index.html">Cara mengubah lalu lintas menjadi penjualan menggunakan data pengguna situs</a></li>
<li><a href="../id466477/index.html">Penggunaan PVS-Studio saat Memeriksa Proyek Mesin Tidak Nyata pada OS Windows</a></li>
<li><a href="../id466479/index.html">Menggunakan PVS-Studio ketika memeriksa proyek-proyek Unreal Engine pada sistem operasi Windows</a></li>
<li><a href="../id466485/index.html">Mobil listrik dari tahun 90an. Bagian 1. Brothers Citroen dan Peugeot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>