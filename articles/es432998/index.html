<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòí üì∂ ‚òÆÔ∏è Cuento de navidad üßôüèº üïó üéóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Queremos compartir la historia que sucedi√≥ en uno de nuestros proyectos para el A√±o Nuevo. La esencia del proyecto es que automatiza el trabajo de los...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cuento de navidad</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/432998/">  Queremos compartir la historia que sucedi√≥ en uno de nuestros proyectos para el A√±o Nuevo.  La esencia del proyecto es que automatiza el trabajo de los m√©dicos en instituciones m√©dicas.  Durante la visita del paciente, el m√©dico escribe informaci√≥n en la grabadora, luego se transcribe el audio.  Despu√©s del proceso de transcripci√≥n, es decir  Convertir la grabaci√≥n de audio en texto: se forma un documento m√©dico de acuerdo con los est√°ndares relevantes y se env√≠a de vuelta a la cl√≠nica, de donde proviene la grabaci√≥n de audio, donde el m√©dico remitente la recibe, la verifica y aprueba.  Despu√©s de pasar los controles obligatorios, el documento se env√≠a a los pacientes finales. <br><a name="habracut"></a><br>  Todas las instituciones m√©dicas que usan el producto pueden dividirse condicionalmente en dos grandes grupos: <br><br><ul><li>  Hospedaje en el centro de datos de nuestro cliente, que es totalmente responsable de la funcionalidad de la aplicaci√≥n, tanto de software como de hardware.  Por ejemplo, si se agota el espacio en disco o no hay suficiente rendimiento del servidor en la CPU; </li><li>  Autohospedado: colocan todo el equipo directamente en casa y son responsables de su propio desempe√±o.  Nuestro cliente les proporciona la aplicaci√≥n y su soporte. </li></ul><br>  As√≠ es como nuestro equipo interact√∫a con los servidores finales que est√°n alojados directamente en la nube de nuestro cliente. <br><br><img src="https://habrastorage.org/webt/fu/dh/qb/fudhqbrny8p_r3wcs4swokhglqw.png"><br><br>  Tenemos acceso a estos servidores para llevar a cabo todo el trabajo programado y el mantenimiento que se requiere. <br><br>  El segundo grupo, los clientes autohospedados, para ellos, la nube del cliente act√∫a como una puerta de enlace a trav√©s de la cual nos conectamos a estos servidores.  En este caso, tenemos derechos limitados, a menudo no podemos realizar ninguna operaci√≥n debido a la configuraci√≥n de seguridad.  Nos conectamos a los servidores a trav√©s de RDP, el Protocolo de escritorio remoto en el sistema operativo Windows.  Naturalmente, todo esto funciona a trav√©s de una VPN. <br><br>  Debe tenerse en cuenta que cada servidor representado en el diagrama es en realidad una combinaci√≥n de un servidor de aplicaciones y un servidor de bases de datos.  En el servidor de la base de datos, respectivamente, se instalan el DBMS de MS SQL Server y el servicio de informes SSRS.  Adem√°s, la versi√≥n del servidor MSSQL es diferente en todas las cl√≠nicas: 2008, 2012, 2014. Adem√°s de las versiones en s√≠, se instalan diferentes Service Packs y parches en todas partes.  En general, un zool√≥gico completo. <br><br>  En el servidor de aplicaciones hemos instalado el servidor web IIS y ElasticSearch.  ElasticSearch es un motor de b√∫squeda que tambi√©n implementa la b√∫squeda de texto completo. <br>  La esencia principal en t√©rminos de nuestro producto es el "trabajo".  El trabajo es una entidad abstracta que vincula toda la informaci√≥n relacionada con la recepci√≥n de un paciente en particular.  Esta informaci√≥n incluye: <br><br><ul><li>  datos sobre el m√©dico; </li><li>  datos del paciente; </li><li>  datos sobre la visita; </li><li>  archivo de audio (discurso del m√©dico); </li><li>  documentos (varias versiones); </li><li>  historial de procesamiento del trabajo; </li><li>  informaci√≥n de sucursal, etc. </li></ul><br>  Este diagrama muestra un esquema de base de datos simplificado desde el cual puede ver las relaciones entre las tablas principales.  Esta es solo la parte b√°sica, de hecho, la base de datos tiene m√°s de 200 tablas. <br><br><img src="https://habrastorage.org/webt/sc/ke/hl/sckehlss-czi3bz2kagmfecrroy.png"><br><br>  Un poco sobre la cl√≠nica donde ocurri√≥ el incidente: <br><br><ul><li>  1500-2000 trabajos por d√≠a; </li><li>  M√°s de 1000 usuarios activos (m√©dicos + secretarios); </li><li>  Autohospedado. </li></ul><br>  DB: <br><br><ul><li>  Tama√±o: 800+ Gb (750K + obras, 2M + documentos); </li><li>  DBMS: MS SQL Server 2008 R2; </li><li>  Modelo de recuperaci√≥n: simple. </li></ul><br>  Aqu√≠ quiero hacer una peque√±a explicaci√≥n.  Hay 3 modelos de recuperaci√≥n en SQL Server: simple, de registro masivo y completo.  No hablar√© sobre el tercero ahora, explicar√© sobre el primero y el segundo.  La principal diferencia es que en el modelo simple no almacenamos el historial de transacciones en el registro: tan pronto como se haya confirmado la transacci√≥n, se eliminar√° el registro del registro de transacciones.  Cuando se utiliza el modo de recuperaci√≥n completa, todo el historial de cambios de datos se almacena en un registro de transacciones.  ¬øQu√© nos da esto?  En el caso de una situaci√≥n imprevista, cuando necesitamos revertir la base de datos de las copias de seguridad, podemos volver no solo a una copia de seguridad espec√≠fica, sino que podemos regresar a cualquier punto en el tiempo, hasta una determinada transacci√≥n, es decir, tenemos en las copias de seguridad, no solo un cierto estado de la base de datos en el momento de la copia de seguridad, sino que tambi√©n hay un historial completo de cambios de datos. <br><br>  Creo que no vale la pena explicar que el modo simple solo se usa en desarrollo, en servidores de prueba y su uso en producci√≥n es inaceptable.  De ninguna manera. <br><br>  Pero la cl√≠nica, aparentemente, ten√≠a sus propios pensamientos sobre este tema;) <br><br><h3>  Inicio </h3><br>  Unos d√≠as despu√©s, el A√±o Nuevo, todos se preparan para las vacaciones, compran regalos, decoran √°rboles de Navidad, pasan fiestas corporativas y esperan un largo fin de semana. <br><br><h6>  22 de diciembre (viernes) 1 d√≠a </h6><br>  <strong>14:31</strong> El cliente dijo que no recibi√≥ el siguiente informe diario.  El informe llega por correo dos veces al d√≠a en un horario; es necesario para controlar el env√≠o de datos a un sistema de integraci√≥n externo, lo cual no es demasiado cr√≠tico. <br><br>  Podr√≠a haber varias razones: <br><br><ol><li>  Problemas con SMTP, las cartas simplemente no fueron entregadas (cambiaron la contrase√±a, por ejemplo, y no se lo dijeron a nadie); </li><li>  Problemas en el lado del servidor de los informes; </li><li>  Algo le sucedi√≥ a la base de datos. </li></ol><br>  <strong>16:03 La</strong> cl√≠nica a veces cambia la contrase√±a a SMTP, sin avisar a nadie al respecto, por lo tanto, despu√©s de completar las tareas actuales, verificamos el informe manualmente con calma al iniciarlo a trav√©s de la interfaz web; obtenemos un error que indica problemas en la base de datos. <br><br>  Un ejemplo del error que recibimos al iniciar el informe. <br><br><pre><code class="plaintext hljs">SQL Server detected a logical consistency-based I/O error: incorrect checksum (expected: 0x9876641f; actual: 0xa3255fbf). It occurred during a read of page (1:876) in database ID 7 at offset 0x000000006d8000 in file 'D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\ServerLive.mdf'.</code> </pre> <br>  Esto indica que la base de datos tiene p√°ginas corruptas.  Ten√≠amos una ligera sensaci√≥n de ansiedad. <br><br>  <strong>20:53</strong> Para evaluar la extensi√≥n del da√±o, ejecutamos una verificaci√≥n de la base de datos utilizando el comando especial <strong><em>DBCC CHECKDB</em></strong> .  Dependiendo del tama√±o del da√±o, el comando de prueba puede tomar bastante tiempo, por lo que ejecutamos el comando por la noche.  Aqu√≠ tenemos la suerte de que esto sucedi√≥ el viernes por la tarde, es decir, tuvimos al menos todos los d√≠as libres para resolver este problema. <br><br>  En ese momento, la situaci√≥n era la siguiente: <br><br><img src="https://habrastorage.org/webt/dp/nq/jm/dpnqjm7rvkmtjtxoc534js439zq.png"><br><br><h6>  23 de diciembre (s√°bado) 2do d√≠a </h6><br>  <strong>10:02</strong> En la ma√±ana, encontramos que verificar la base de datos con CHECKDB es flexible, esto se debi√≥ a la falta de espacio libre en el disco, porque  durante el proceso de verificaci√≥n, la base de datos temporal tempdb se usa activamente, y en alg√∫n momento el espacio libre en el disco simplemente se agot√≥. <br><br>  Por lo tanto, decidimos, en lugar de verificar toda la base de datos, iniciar inmediatamente un escaneo de tabla.  Para hacer esto, use el <strong><em>comando DBCC CHECKTABLE</em></strong> . <br><br>  <strong>10:46</strong> Decidimos comenzar con la tabla JobHistory, que probablemente est√° da√±ada, ya que fue la que se utiliz√≥ para generar el informe.  Esta tabla, como su nombre lo indica, conserva la historia de todas las obras, es decir, las transiciones de trabajo entre etapas. <br><br>  Ejecute <strong><em>DBCC CHECKTABLE ('dbo.JobHistory')</em></strong> . <br><br>  La comprobaci√≥n de esta tabla revela tablas da√±adas en la base de datos, lo que se esperaba en principio. <br><br>  <strong>12:00</strong> En este momento, si la base de datos usara el modelo de recuperaci√≥n completa, podr√≠amos restaurar las p√°ginas da√±adas de la copia de seguridad, y eso estar√≠a terminado, pero nuestra base de datos estaba en modo simple.  Por lo tanto, la √∫nica opci√≥n para reparar da√±os sigue siendo el lanzamiento del mismo comando con el par√°metro especial <strong><em>REPAIR_ALLOW_DATA_LOSS</em></strong> .  Esto puede provocar la p√©rdida de datos. <br><br>  Empezamos  La verificaci√≥n nuevamente finaliza con un error: obtenemos el error de que la restauraci√≥n de esta tabla es imposible hasta que se restauran las tablas relacionadas.  La tabla de historial se refiere a la tabla de trabajo (Jobs) por la clave externa, por lo tanto, concluimos que tambi√©n hay da√±os en la tabla de trabajo principal (Jobs). <br><br>  <strong>13:30</strong> El siguiente paso es verificar la tabla de trabajos, al mismo tiempo, esperamos que el da√±o est√© en el √≠ndice y no en los datos.  En este caso, ser√° suficiente para nosotros simplemente reconstruir el √≠ndice para la recuperaci√≥n de datos. <br><br>  <strong>17:33</strong> Despu√©s de un tiempo, descubrimos que nuestro servidor no est√° disponible a trav√©s de RDP.  Probablemente se apag√≥, la verificaci√≥n no se complet√≥, el trabajo se suspendi√≥.  Informamos a la cl√≠nica que el servidor no est√° disponible, lev√°ntelo. <br><br>  La ansiedad leve adquiere formas muy espec√≠ficas. <br><br><h6>  24 de diciembre (domingo) 3er d√≠a </h6><br>  <strong>14:31</strong> M√°s cerca de la cena, el servidor est√° elevado, volvemos a ejecutar la verificaci√≥n de la tabla de trabajos. <br>  <strong><em>DBCC CHECKTABLE ('dbo.Jobs')</em></strong> <br><br>  <strong>16:05 La</strong> verificaci√≥n no se complet√≥, el servidor no est√° disponible.  De nuevo <br><br>  Despu√©s de un tiempo, el servidor ya no est√° disponible, antes de que pudi√©ramos terminar de verificar la tabla.  En este punto, el servicio de TI de la cl√≠nica realiza una serie de verificaciones del servidor.  Estamos esperando la finalizaci√≥n del trabajo. <br><br>  Debido a las vacaciones, la comunicaci√≥n entre nosotros y el cliente fue lenta: esper√°bamos respuestas a las preguntas durante varias horas. <br><br><h6>  25 de diciembre (lunes - Navidad) 4to d√≠a </h6><br>  <strong>16:00</strong> Al d√≠a siguiente se levant√≥ el servidor, el cliente tiene Navidad, y nuevamente comenzamos a verificar la tabla, pero esta vez excluimos los √≠ndices del escaneo, y dejamos solo la verificaci√≥n de datos.  Y despu√©s de un tiempo, el servidor no estar√° disponible nuevamente. <br><br>  Que esta pasando <br><br>  En este momento, los pensamientos comienzan a aparecer, que esto no es solo una coincidencia, y existe la sospecha de que podr√≠a ser un da√±o a nivel de hierro (se cay√≥ un disco duro).  Suponemos que hay sectores defectuosos en el disco y cuando el escaneo intenta leer datos de estos sectores, el sistema se bloquea.  Informamos a nuestro cliente sobre nuestra suposici√≥n. <br><br>  El cliente ejecuta una comprobaci√≥n de disco en la m√°quina host. <br><br>  <strong>17:19 El</strong> servicio de TI de la cl√≠nica inform√≥ que el archivo de la m√°quina virtual est√° da√±ado, ¬°esto es malo! <br>  Todav√≠a no podemos trabajar, y estamos esperando una se√±al cuando solucionen el problema y podamos continuar nuestro trabajo. <br><br><h6>  26 de diciembre (martes) D√≠a 5 </h6><br>  <strong>14:05 El</strong> servicio de cl√≠nica de TI lanza otro proceso de recuperaci√≥n de disco.  Nos dijeron que podemos ejecutar CHECKTABLE en paralelo para verificar la tabla.  Comenzamos la prueba nuevamente: la m√°quina virtual falla nuevamente, informamos al cliente que el archivo de la m√°quina virtual todav√≠a est√° da√±ado. <br><br>  En estos d√≠as, todas las comunicaciones con el cliente son muy lentas con un gran retraso debido a las vacaciones. <br><br><h6>  27 de diciembre (mi√©rcoles) D√≠a 6 </h6><br>  <strong>14:00</strong> Comenzamos la verificaci√≥n del disco usando Windows - <strong>checkdisk</strong> dentro de la m√°quina virtual - no se detectaron problemas. <br>  La base de datos est√° en modo Simple, por lo que las posibilidades de arreglar la base de datos actual con las herramientas DBMS tienden a cero, porque  No podemos recuperar p√°ginas da√±adas individuales. <br>  Estamos comenzando a considerar la opci√≥n de retroceder y restaurar la base de datos desde la copia de seguridad. <br>  Verificamos las copias de seguridad de la base de datos y descubrimos que las copias de seguridad no se hicieron utilizando los medios DBMS, la √∫ltima copia de seguridad fue en 2014, es decir.  No hay copias de seguridad de la base de datos.  Por qu√© no lo hicieron es un tema aparte, es responsabilidad de la cl√≠nica garantizar la eficiencia y la seguridad de la base de datos. <br><br>  Existe una alta probabilidad de que no funcione para restaurar la base de datos actual, comenzamos a considerar otras opciones para la reversi√≥n. <br><br>  Analicemos con m√°s detalle la situaci√≥n con las copias de seguridad en la cl√≠nica. <br><br>  La situaci√≥n con las copias de seguridad: <br><br><ul><li>  No hay copias de seguridad de la base de datos (!!!) </li><li>  No hay instant√°neas de la m√°quina virtual (!?) </li><li>  Pero hay copias de seguridad de disco (full + inc) </li></ul><br>  La base de datos est√° en el disco D, respectivamente, hicieron copias de seguridad completas semanales y copias de seguridad incrementales diarias. <br><br><ul><li>  todos los viernes a las 20:00 respaldo completo </li><li>  copia de seguridad incremental todos los d√≠as </li><li>  hay una copia de seguridad completa de los d√≠as 15 y 22 </li><li>  hay copias de seguridad diarias hasta el 21 </li></ul><br>  Es decir  en principio, podemos regresar al estado antes de que ocurra el problema. <br>  Estamos esperando una actualizaci√≥n de la cl√≠nica para iniciar la reversi√≥n de la base de datos desde la copia de seguridad. <br><br>  Al mismo tiempo, la cl√≠nica envi√≥ una solicitud al proveedor de hierro (HP) marcada como "urgente". <br><br><h6>  28 de diciembre (jueves) D√≠a 7 </h6><br>  <strong>13:13 El</strong> servicio de TI de la cl√≠nica comienza a configurar una nueva m√°quina virtual, como  No es posible reparar el da√±o en el archivo de la vieja m√°quina virtual. <br><br>  <strong>19:09</strong> Una nueva <strong>m√°quina</strong> virtual <strong>est√°</strong> disponible con SQL Server instalado. <br>  El siguiente paso es restaurar la base de datos desde la copia de seguridad del disco.  Para comenzar, decidimos retroceder al d√≠a 22, si el problema a√∫n est√° presente, luego retrocedemos al 21, 20 y as√≠ sucesivamente, hasta que lleguemos a un estado de trabajo. <br><br>  Era el d√≠a 28 en el patio, est√°bamos en la fiesta corporativa, y aqu√≠ nos dicen que la cl√≠nica tiene problemas para restaurar las copias de seguridad, ¬°porque los BACKUPS est√°n VAC√çOS! <br><br>  Aqu√≠ est√° la noticia! <br><br>  Al restaurar una copia de seguridad de la unidad D desde el 21, resulta que est√° vac√≠a, como todos los dem√°s.  Se obtienen copias de seguridad directas de la destructora, parecen estar all√≠, pero al mismo tiempo no lo est√°n.  No est√° completamente claro c√≥mo sucedi√≥ esto, pero, por lo que pudimos entender, el punto es que no hay suficiente espacio en el disco para almacenar las copias de seguridad del disco.  Asignaron 500 Gb de copias de seguridad para el almacenamiento, pero en el momento del incidente, la base de datos ya pesaba 800 Gb, por lo tanto, en principio, la copia de seguridad no podr√≠a tener √©xito.  Es decir  las copias de seguridad se realizaron regularmente de acuerdo con el cronograma, pero debido a la falta de espacio, terminaron con un error y, en consecuencia, estaban vac√≠as, y el servicio de TI de la cl√≠nica ni siquiera tuvo la idea de verificar que todo estuviera bien con ellas.  No hagas eso. <br><br><h6>  29 de diciembre (viernes) D√≠a 8 </h6><br>  <strong>13:11</strong> Discusi√≥n de otras acciones.  Posibles opciones: <br><br><ul><li>  Intentar copiar archivos de base de datos (archivos .ldf + .two): las posibilidades de √©xito son muy bajas; </li><li>  Intentar hacer una copia de seguridad de la base de datos vuelve a tener muy pocas posibilidades; </li><li>  Configurar la replicaci√≥n: puede funcionar. </li></ul><br>  Se asign√≥ una unidad de 1 Tb en el nuevo servidor, lo que obviamente no es suficiente si intentamos hacer una copia de seguridad y restaurar desde √©l, porque  en el peor de los casos, sin compresi√≥n, las copias de seguridad ocupar√°n tanto espacio como la base de datos original, es decir  800 Gb. <br>  Agregue lugares en el nuevo servidor y proceda a copiar los archivos de la base de datos. <br>  Se cre√≥ una base de datos en el nuevo servidor y se restaur√≥ el esquema de la base de datos; esto permitir√° al menos procesar nuevos trabajos.  La cl√≠nica al menos podr√° aceptar nuevos pacientes que utilicen dicho sistema. <br><br>  <strong>14:36</strong> Por lo tanto, procedemos a la opci√≥n n√∫mero uno, aunque no esperamos mucho √©xito. <br>  Detenga SQL Server, comience a copiar el archivo de datos (mdf) y el registro (ldf). <br><br>  <strong>16:13</strong> Despu√©s de la mitad del archivo de registro, se copi√≥ con √©xito (48 Gb) y ya se copiaron 50 GB del archivo de datos (quedan 795 de 846 GB).  A esta velocidad, tomar√° aproximadamente 12 horas completar la copia. <br><br>  <strong>16:30 El</strong> antiguo servidor de la base de datos se apag√≥ al copiar el archivo, lo cual es bastante esperado. <br><br>  <strong>17:09</strong> Por lo tanto, pasamos a la siguiente opci√≥n: configurar la replicaci√≥n, mientras que podemos especificar qu√© datos se replicar√°n, es decir, primero podemos excluir las tablas da√±adas deliberadamente y primero copiar los datos no da√±ados y luego transferir las tablas problem√°ticas en partes.  Pero esta opci√≥n, desafortunadamente, tampoco funciona, porque ni siquiera podemos crear una publicaci√≥n con ciertas tablas debido a la corrupci√≥n de la base de datos. <br>  Tambi√©n estamos considerando opciones de transferencia de datos. <br><br>  <strong>20:01</strong> Como resultado, comenzamos simplemente a transferir datos del servidor antiguo al nuevo mediante la importaci√≥n y exportaci√≥n en orden de prioridad. <br><br>  <strong>21:35</strong> Primero, los datos m√°s cr√≠ticos, luego archivados y menos cr√≠ticos (~ 300 GB).  En la primera ola de exportaci√≥n, quedaban menos de 300 GB de datos.  La tabla Documentos (300 GB) tambi√©n est√° excluida.  Comenzamos el proceso de copia por la noche. <br><br><h6>  30 de diciembre (s√°bado) D√≠a 9 </h6><br>  <strong>15:00 Seguimos</strong> transfiriendo datos.  La tabla de trabajos no est√° disponible en absoluto.  La mayor√≠a de las tablas fueron copiadas por este tiempo. <br>  Pero sin <strong>Jobs,</strong> todo es in√∫til, porque es el enlace principal entre todos los datos y les da significado y valor desde el punto de vista comercial.  Sin √©l, solo tenemos un conjunto de datos dispares que simplemente no podemos usar. <br><br>  Adem√°s, en este punto, la recuperaci√≥n del esquema de la base de datos se ha completado. <br><br>  <strong>Las consecuencias del incidente:</strong> <br><br>  En este punto, tenemos una gran p√©rdida de datos en vivo. <br>  Es decir  formalmente, tenemos algunos datos en la base de datos, pero, de hecho, no hay forma de usarlos o conectarlos, por lo que podemos hablar sobre la p√©rdida completa de datos. <br>  Datos perdidos en m√°s de 750,000 ingresos de pacientes. <br><br>  Esto es realmente triste! <br><br><ul><li>  Este es un gran golpe para la reputaci√≥n de nuestro cliente, que puede resultar ser un gran problema para ellos en los negocios al concluir nuevos contratos y encontrar nuevos clientes. </li><li>  La p√©rdida de tantos datos para la cl√≠nica puede generar serios problemas y multas, porque  Estos son datos confidenciales que contienen confidencialidad m√©dica y, en sentido literal, dependen de la vida de las personas. </li></ul><br>  Comenzamos a pensar qu√© podemos hacer en esta situaci√≥n.  Comenzaron a clasificar el sistema por huesos para encontrar pistas. <br><br>  <strong>15:16</strong> Analizando todos los aspectos del sistema, entendemos que podemos intentar extraer los datos que faltan del √≠ndice ElasticSearch.  La cuesti√≥n es que, debido a la configuraci√≥n incorrecta de los √≠ndices de ElasticSearch, almacena no solo los campos por los que se realiza la b√∫squeda de texto completo, sino en general todo, es decir, de hecho hay una copia completa de los datos y te√≥ricamente podemos extraer datos de all√≠ sobre trabajos y volver a ponerlos en nuestra base de datos.  Se espera que los datos a√∫n puedan recuperarse. <br><br>  ¬°Un error al que puedes poner un monumento! <br><br><img src="https://habrastorage.org/webt/oy/62/nt/oy62ntr-iiercftfvwmd_gzoide.png"><br><br>  <strong>18:00</strong> Se escribi√≥ r√°pidamente una utilidad para extraer los datos, y despu√©s de unas horas nos aseguramos de que el enfoque funcione y que los datos puedan restaurarse. <br><br>  <strong>20:00</strong> Ha comenzado la restauraci√≥n del trabajo de ElasticSearch con la ayuda de una utilidad escrita.  El enfoque funcion√≥, podemos restaurar los datos en el trabajo.  Paralelamente, comenzamos a extraer las √∫ltimas versiones del documento para cada trabajo. <br><br><h6>  31 de diciembre (domingo - A√±o nuevo) D√≠a 10 </h6><br>  <strong>14:09</strong> Durante la noche, se restauraron 188 811 obras. <br><br>  <strong>20:13</strong> Al ver nuestro √©xito, la cl√≠nica decide posponer la transferencia del servidor al servicio de HP para darnos tiempo para extraer los datos m√°ximos del servidor anterior. <br>  Con tales noticias, celebramos el A√±o Nuevo)) <br><br><h6>  01 de enero (lunes) d√≠a 11 </h6><br>  <strong>11:23</strong> Preparaci√≥n para iniciar el sistema despu√©s del incidente: <br><br><ul><li>  IIS reconfigurado en el servidor de aplicaciones; </li><li>  reconfigur√≥ todos los servicios necesarios para trabajar con el nuevo servidor de base de datos; </li><li>  disparadores, procedimientos almacenados, funciones restauradas. </li></ul><br>  <strong>14:28</strong> Luego comenzaron a copiar la tabla de documentos, que se omiti√≥ debido al gran tama√±o durante la transferencia inicial. <br>  - El viejo servidor DB se apaga nuevamente.  Obviamente, la tabla Documentos tambi√©n est√° da√±ada, es con ella que se almacena toda la informaci√≥n del paciente.  Afortunadamente, no est√° completamente da√±ado, podemos hacerle solicitudes, y cuando una solicitud nos devuelve un registro da√±ado, en ese momento el servidor se bloquea y se apaga.  Podemos extraer algunos de los datos. <br><br>  En consecuencia, le enviamos una se√±al al cliente, ellos levantan el servidor y, en paralelo, continuamos preparando la nueva base de datos para el lanzamiento del sistema. <br><br>  <strong>18:01</strong> Recuperaci√≥n de todas las restricciones de integridad despu√©s de la transferencia de la parte principal de los datos. <br><br>  <strong>22:02</strong> Restauraci√≥n de restricciones completada.  Simplemente transferimos los datos sin procesar al m√°ximo.  La presencia de restricciones de integridad complicar√≠a enormemente nuestra tarea. <br><br><h6>  02 de enero (martes) D√≠a 12 </h6><br>  <strong>05:52 El</strong> antiguo servidor de base de datos se apag√≥ nuevamente al copiar el documento.  √âl es criado r√°pidamente para que podamos continuar trabajando. <br><br>  <strong>09:00</strong> Fue posible recuperar por lotes aproximadamente 200,000 documentos (aproximadamente 20%) <br>  Comenzamos a usar diferentes m√©todos de recuperaci√≥n: ordenando por diferentes columnas para obtener datos desde el final o el comienzo de la tabla, hasta que nos topamos con alguna parte da√±ada de la tabla. <br><br>  <strong>13:42</strong> Comenz√≥ a copiar trabajos de archivo en la tabla; afortunadamente, no est√° da√±ado. <br><br>  <strong>17:08</strong> Restaurado todo el trabajo de archivo (491 380 piezas). <br><br>  El sistema est√° listo para iniciarse: los usuarios pueden crear y procesar nuevos trabajos. <br><br>  Desafortunadamente, debido a un da√±o parcial en la tabla de documentos, no puede simplemente transferir todos los datos de ella, como con otras tablas, porque  La mesa est√° parcialmente da√±ada.  Por lo tanto, al intentar recuperar todos los datos, la solicitud se bloquea al intentar leer p√°ginas corruptas.  Por lo tanto, extraemos los datos puntuales utilizando diferentes tipos y tama√±os de muestra: <br><br><ul><li>  Ordenar por diferentes campos (ID, DateTime); </li><li>  Ordenar ascendente, descendente; </li><li>  Trabajar con peque√±os grupos de l√≠neas (1000, 100); </li><li>  Obteniendo trabajos por ID. </li></ul><br><br><h6>  03 de enero (mi√©rcoles) D√≠a 13 </h6><br>  <strong>08:58</strong> Contin√∫a el proceso de restauraci√≥n de documentos.  Los documentos se restauraron solo para trabajo activo e incompleto.  En este punto, 1000 trabajos (activos) sin documentos. <br><br>  <strong>11:38</strong> Migr√≥ todos los trabajos de SQL <br><br>  <strong>13:17</strong> 5 funciona sin documentos, 231 no funciona, pero hay un archivo de audio, debe volver a sincronizarlo. <br><br><h6>  04 de enero (jueves) D√≠a 14 </h6><br>  La recuperaci√≥n manual y la verificaci√≥n del trabajo restante ha comenzado. <br>  El sistema funciona, monitoreando y reparando errores en l√≠nea. <br><br><h6>  05 de enero (viernes) D√≠a 15 </h6><br>  Informe la migraci√≥n a SSRS planificada. <br>  La transferencia a un nuevo servidor no es posible porque  la cl√≠nica instal√≥ una versi√≥n anterior de SQL Server y no funcionar√° para transferir la base de datos del servidor anterior. <br><br>  Opciones: <br><br><ul><li>  Actualice SQL Server de 2008 a 2008 R2; </li><li>  Configura todo desde cero. </li></ul><br>  Se decidi√≥ esperar la actualizaci√≥n de SQL Server. <br><br>  <strong>09:21</strong> Ha comenzado la restauraci√≥n de antecedentes de documentos para el trabajo completado: el proceso es largo y tomar√° varios d√≠as. <br><br>  <strong>13:28</strong> Cambio de prioridad de restauraci√≥n de documentos por departamentos. <br><br>  <strong>18:18 La</strong> cl√≠nica dio acceso a SMTP, configuraci√≥n de correo <br><br><h3>  Resultado: </h3><br><ul><li>  Se restauraron casi todos los datos (solo se perdieron 5 trabajos); </li><li>  Se emitieron recomendaciones sobre el mantenimiento de la base de datos para prevenir tales situaciones; </li><li>  Las copias de seguridad de la base de datos se configuran utilizando SQL Server; </li><li>  Monitoreo adicional de respaldos de nuestra parte, alertas en caso de falla. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es432998/">https://habr.com/ru/post/es432998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es432988/index.html">Octavo webmaster. Vive en Habr√©</a></li>
<li><a href="../es432990/index.html">Edison L√°mpara de madera activada por voz. Precio de emisi√≥n $ 5</a></li>
<li><a href="../es432992/index.html">Se puso los auriculares y muri√≥: lidiamos con la extra√±a muerte de un ni√±o en Rimbau.</a></li>
<li><a href="../es432994/index.html">Vivaldi 2.2 - Conversi√≥n de cantidad a calidad</a></li>
<li><a href="../es432996/index.html">Un poco de diccionarios internos en CPython (y PyPy)</a></li>
<li><a href="../es433000/index.html">Compilando Kotlin: JetBrains VS ANTLR VS JavaCC</a></li>
<li><a href="../es433002/index.html">Vamos t√∫ mismo ... o las reglas de comunicaci√≥n en un equipo</a></li>
<li><a href="../es433004/index.html">Una estrategia s√≥lida de migraci√≥n a la nube para 2019: 7 consejos</a></li>
<li><a href="../es433008/index.html">Los dispositivos USB son una amenaza "repentina"</a></li>
<li><a href="../es433010/index.html">Tener una idea: sistema de permisos para paquetes npm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>