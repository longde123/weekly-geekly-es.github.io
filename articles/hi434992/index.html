<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯТж ЁЯСиЁЯП╝тАНтЪЦя╕П ЁЯСйтАНЁЯСз рдЕрдкрдЧреНрд░реЗрдбрд┐рдВрдЧ рдЖрдИрдбреАрдП рдкреНрд░реЛред рд╕реЗрдЧрд╛ рдореЗрдЧрд╛ рдбреНрд░рд╛рдЗрд╡ рдХреЗ рд▓рд┐рдП рдбрд┐рдмрдЧрд░ (рднрд╛рдЧ 1) ЁЯСйЁЯП╛тАНЁЯПл ЁЯСйЁЯП╜тАНЁЯМ╛ ЁЯзЭЁЯП╝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдирдорд╕реНрддреЗ! 


 рдХреЙрдорд░реЗрдбреНрд╕ рд░рд┐рд╡рд░реНрд╕рд▓рд░реНрд╕, рд░реЛрдорд╣реИрдХрд░реНрд╕: рдореВрд▓ рд░реВрдк рд╕реЗ рдпрд╣ рд▓реЗрдЦ рдЖрдкрдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдкрд┐рдд рд╣реЛрдЧрд╛ред рдЗрд╕рдореЗрдВ, рдореИрдВ рдЖрдкрдХреЛ IDA Pro рд▓рд┐рдП рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рдбрд┐рдмрдЧрд░ рдкреНрд▓рдЧрдЗрди рд▓рд┐рдЦрдиреЗ рдХрд╛ рддрд░реА...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдЕрдкрдЧреНрд░реЗрдбрд┐рдВрдЧ рдЖрдИрдбреАрдП рдкреНрд░реЛред рд╕реЗрдЧрд╛ рдореЗрдЧрд╛ рдбреНрд░рд╛рдЗрд╡ рдХреЗ рд▓рд┐рдП рдбрд┐рдмрдЧрд░ (рднрд╛рдЧ 1)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434992/"><p><img src="https://habrastorage.org/webt/mj/6l/rl/mj6lrl7zl2pq7itjpw3cr3s15fw.png"></p><br><p>  рдирдорд╕реНрддреЗ! </p><br><p> рдХреЙрдорд░реЗрдбреНрд╕ рд░рд┐рд╡рд░реНрд╕рд▓рд░реНрд╕, рд░реЛрдорд╣реИрдХрд░реНрд╕: рдореВрд▓ рд░реВрдк рд╕реЗ рдпрд╣ рд▓реЗрдЦ рдЖрдкрдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдкрд┐рдд рд╣реЛрдЧрд╛ред  рдЗрд╕рдореЗрдВ, рдореИрдВ рдЖрдкрдХреЛ <code>IDA Pro</code> рд▓рд┐рдП рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рдбрд┐рдмрдЧрд░ рдкреНрд▓рдЧрдЗрди рд▓рд┐рдЦрдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдмрддрд╛рдКрдВрдЧрд╛ред  рд╣рд╛рдВ, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХрд╣рд╛рдиреА рд╢реБрд░реВ рдХрд░рдиреЗ рдХрд╛ рдкрд╣рд▓рд╛ рдкреНрд░рдпрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ</a> рд╣реА рдерд╛, рд▓реЗрдХрд┐рди рддрдм рд╕реЗ рдмрд╣реБрдд рдкрд╛рдиреА рдмрд╣ рдЪреБрдХрд╛ рд╣реИ, рдХрдИ рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рд╡реЗ рдЪрд▓реЗ рдЧрдП! <a name="habracut"></a></p><br><h4 id="liricheskoe-vstuplenie">  рдЧреЗрдп рдкрд░рд┐рдЪрдп </h4><br><p>  рджрд░рдЕрд╕рд▓, рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦреЛрдВ ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрдХ</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рджреЛ</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рддреАрди</a> ) рд╕реЗ, рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдПрдХ рд░рд╣рд╕реНрдп рдирд╣реАрдВ рд╣реЛрдЧрд╛ рдХрд┐ рдореЗрд░рд╛ рдкрд╕рдВрджреАрджрд╛ рдкреНрд░реЛрд╕реЗрд╕рд░ <code>Motorola 68000</code> ред  рд╡реИрд╕реЗ, рдореЗрд░реА рдкрд╕рдВрджреАрджрд╛ рдкреБрд░рд╛рдиреА рдорд╣рд┐рд▓рд╛ <code>Sega Mega Drive</code> / <code>Genesis</code> рдкрд░ рдХрд╛рдо рдХрд░ рд░рд╣реА рд╣реИред  рдФрд░, рдЬрдм рд╕реЗ рдореБрдЭреЗ рд╣рдореЗрд╢рд╛ рдЗрд╕ рдмрд╛рдд рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдкреА рдереА рдХрд┐ рд╕реАрдЬреАрдУ рдХреЗ рдЦреЗрд▓ рдХреА рд╡реНрдпрд╡рд╕реНрдерд╛ рдХреИрд╕реЗ рдХреА рдЬрд╛рддреА рд╣реИ, рдЕрдкрдиреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдЙрдкрдпреЛрдЧ рдХреЗ рдкрд╣рд▓реЗ рдорд╣реАрдиреЛрдВ рд╕реЗ рдореИрдВрдиреЗ рдбрд┐рд╕рд╕реИрдореНрдм рдХреЗ рдЬрдВрдЧрд▓ рдореЗрдВ рдЧрд╣рд░рд╛рдИ рддрдХ рдЬрд╛рдиреЗ рдФрд░ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рд░рд┐рд╡рд░реНрд╕ рдХрд░рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ред </p><br><p>  рдЗрд╕ рддрд░рд╣ рд╕реЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Smd IDA Tools</a> рдХреЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдмрд╛рд░реЗ рдореЗрдВ</a> рдЖрдпрд╛ред <br>  рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди рд╕рд╣рд╛рдпрдХ рдЪреАрдЬреЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдЬреЛ рд╕реЗрдЧрд╛ рдкрд░ рд░реЛрдорд╛рдВрд╕ рдХрд╛ рдЕрдзреНрдпрдпрди рдХрд░рдиреЗ рдХреЗ рдХрд╛рдо рдХреЛ рдмрд╣реБрдд рдЖрд╕рд╛рди рдмрдирд╛рддреА рд╣реИрдВ: рдПрдХ рд▓реЛрдбрд░, рдПрдХ рдбрд┐рдмрдЧрд░, <code>VDP</code> рдХрдорд╛рдВрдб рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╣рд╛рдпрдХред  рд╕рдм рдХреБрдЫ <code>IDA 6.8</code> рд▓рд┐рдП рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛ред  рд▓реЗрдХрд┐рди, рдЬрдм рдореИрдВрдиреЗ рджреБрдирд┐рдпрд╛ рдХреЛ рдпрд╣ рдмрддрд╛рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдХрд┐ рдореИрдВрдиреЗ рдпрд╣ рд╕рдм рдХреИрд╕реЗ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реЛ рдЧрдпрд╛ рдХрд┐ рд▓реЛрдЧреЛрдВ рдХреЛ рдЗрд╕ рддрд░рд╣ рдХреЗ рдХреЛрдб рдХреЛ рджрд┐рдЦрд╛рдирд╛ рдмрд╣реБрдд рдореБрд╢реНрдХрд┐рд▓ рд╣реЛрдЧрд╛, рдФрд░ рдЗрд╕рд╕реЗ рднреА рдЬреНрдпрд╛рджрд╛ рдЗрд╕рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рдЗрд╕рд▓рд┐рдП, рдореИрдВ рдРрд╕рд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрд╛ред </p><br><p>  рдФрд░ рдлрд┐рд░ <code>IDA 7.0</code> рд╕рд╛рдордиреЗ рдЖрдпрд╛ред  рдореЗрд░реА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рдкреЛрд░реНрдЯ рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рддреБрд░рдВрдд рджрд┐рдЦрд╛рдИ рджреА, рд▓реЗрдХрд┐рди <code>Gens</code> рдПрдореНрдпреВрд▓реЗрдЯрд░ рдХреА рд╡рд╛рд╕реНрддреБрдХрд▓рд╛, рдЬрд┐рд╕рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдореИрдВрдиреЗ рдбрд┐рдмрдЧрд░ рд▓рд┐рдЦрд╛, рдкреЛрд░реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдкрдпреБрдХреНрдд рд╣реЛ рдЧрдпрд╛: <code>x86</code> рдЕрд╕реЗрдВрдмрд▓реА рдЖрд╡реЗрд╖рдг, рдмреИрд╕рд╛рдЦреА, рдХреЛрдб рдЬреЛ рд╕рдордЭрдирд╛ рдореБрд╢реНрдХрд┐рд▓ рдерд╛, рдФрд░ рдмрд╣реБрдд рдХреБрдЫред  рдФрд░ рдЦреЗрд▓ <code>Pier Solar and the Great Architects</code> , рдЬреЛ 2010 рдореЗрдВ рдХрд╛рд░рддреВрд╕ рдкрд░ рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдЬреЛ рдореИрдВ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рддрд▓рд╛рд╢ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рдерд╛ (рдФрд░ рд╡рд╣рд╛рдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╡рд┐рд░реЛрдзреА рдЕрдиреБрдХрд░рдг рдЪрд╛рд▓реЗрдВ рд╣реИрдВ), <code>Gens</code> рдореЗрдВ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реБрдЖред </p><br><p><img src="https://habrastorage.org/webt/5f/in/pg/5finpgxicxyqorxx1qa50ka7zne.jpeg"></p><br><p>  рдПрдХ рдЙрдкрдпреБрдХреНрдд рдПрдореБрд▓реЗрдЯрд░ рд╕реНрд░реЛрдд рдХреА рддрд▓рд╛рд╢ рдореЗрдВ рдЬрд┐рд╕реЗ рдбрд┐рдмрдЧрд░ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдореИрдВ рдЕрдВрддрддрдГ <code>EkeEke</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреЗрдиреЗрд╕рд┐рд╕ рдкреНрд▓рд╕ рдЬреАрдПрдХреНрд╕</a> рдкрд░ рдареЛрдХрд░ рдЦрд╛рдИред  рддреЛ рдпрд╣ рд▓реЗрдЦ рджрд┐рдЦрд╛рдИ рджрд┐рдпрд╛ред </p><br><h2 id="chast-pervaya-yadro-otladchika">  рднрд╛рдЧ рдПрдХ: рдбреАрдмрдЧрд░ рдХреЛрд░ </h2><br><p>  рдореБрд╢реАрд╢реА рдиреЗ <code>Genesis Plus GX</code> рдореЗрдВ рдореЛрдЯреЛрд░реЛрд▓рд╛ рдкреНрд░реЛрд╕реЗрд╕рд░ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд┐рдпрд╛ред  рдЗрд╕рдХреЗ рдореВрд▓ рд╕реНрд░реЛрдд рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдмреБрдирд┐рдпрд╛рджреА рдбрд┐рдмрдЧрд┐рдВрдЧ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ (рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣реБрдХ) рд╣реИ, рд▓реЗрдХрд┐рди <code>EkeEke</code> рдиреЗ рдЗрд╕реЗ рдЕрдирд╛рд╡рд╢реНрдпрдХ рд░реВрдк рд╕реЗ рд╣рдЯрд╛рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ред  рд╣рдо рд▓реМрдЯрддреЗ рд╣реИрдВред </p><br><p><img src="https://habrastorage.org/webt/qp/1v/ls/qp1vls4m3ghzf3aqmknj-23xulu.png"></p><br><p><img src="https://habrastorage.org/webt/tr/wp/rw/trwprwbfno8tkajpbfaftwyqyu8.png"></p><br><p>  рдЕрдм рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд╛рдд: рдЖрдкрдХреЛ рдбрд┐рдмрдЧрд░ рдХреА рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИрдВ: </p><br><ul><li>  рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рдмреНрд░реЗрдХ (рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ), рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА </li><li>  рдХрд╛рд░реНрдпрд╢реАрд▓рддрд╛ <code>Step Into</code> , <code>Step Over</code> </li><li>  рд░реЛрдХреЗрдВ, рдЕрдиреБрдХрд░рдг <code>Resume</code> </li><li>  рд░рдЬрд┐рд╕реНрдЯрд░ рдкрдврд╝реЗрдВ / рд╕реЗрдЯ рдХрд░реЗрдВ, рдореЗрдореЛрд░реА рдкрдврд╝реЗрдВ / рд▓рд┐рдЦреЗрдВ </li></ul><br><p>  рдпрджрд┐ рдпреЗ рдЪрд╛рд░ рдмрд┐рдВрджреБ рдЕрдВрджрд░ рд╕реЗ рдбреАрдмрдЧрд░ рдХрд╛ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдЕрднреА рднреА рдмрд╛рд╣рд░ рд╕реЗ рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдХреЛрдИ рдЕрдиреНрдп рдЖрдЗрдЯрдо рдЬреЛрдбрд╝реЗрдВ: </p><br><ul><li>  рдбрд┐рдмрдЧрд░-рдХреНрд▓рд╛рдЗрдВрдЯ (GUI, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛) рдХреЗ рд╕рд╛рде рдбреАрдмрдЧрд░-рд╕рд░реНрд╡рд░ (рдХрд░реНрдиреЗрд▓) рдХрд╛ рд╕рдВрдЪрд╛рд░ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ </li></ul><br><h3 id="yadro-otladchika-spisok-bryakov">  рдбрд┐рдмрдЧрд░ рдХреЛрд░: рдмреНрд░реЗрдХ рд▓рд┐рд╕реНрдЯ </h3><br><p>  рд╕реВрдЪреА рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрд░рдЪрдирд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">breakpoint_s</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">breakpoint_s</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> enabled; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width; <span class="hljs-keyword"><span class="hljs-keyword">bpt_type_t</span></span> type; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> address; } <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span>;</code> </pre> <br><p>  <code>next</code> рдФрд░ <code>prev</code> рдлрд╝реАрд▓реНрдб рдХреНрд░рдорд╢рдГ рдЕрдЧрд▓реЗ рдФрд░ рдкрд┐рдЫрд▓реЗ рддрддреНрд╡ рдХреА рдУрд░ рд╕рдВрдХреЗрдд рдХрд░реЗрдВрдЧреЗред <br>  рдпрджрд┐ рдЗрд╕ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреЛ рдСрдкрд░реЗрд╢рди рдкрд░реАрдХреНрд╖рдгреЛрдВ рдореЗрдВ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рдирд╛ рд╣реИ рддреЛ <code>enabled</code> рдлрд╝реАрд▓реНрдб <code>0</code> рд╕реНрдЯреЛрд░ рдХрд░реЗрдЧрд╛ред <br>  <code>width</code> - <code>address</code> рдлрд╝реАрд▓реНрдб рдореЗрдВ рдкрддреЗ рд╕реЗ рд╢реБрд░реВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдмрд╛рдЗрдЯреНрд╕ рдХреА рд╕рдВрдЦреНрдпрд╛ рдЬреЛ рдмреНрд░реЗрдХрд░ рдХреЛ рдХрд╡рд░ рдХрд░рддреА рд╣реИред <br>  рдЦреИрд░, <code>type</code> рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рд╣рдо рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдкреНрд░рдХрд╛рд░ (рдирд┐рд╖реНрдкрд╛рджрди, рдкрдврд╝рдирд╛, рд▓рд┐рдЦрдирд╛) рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВрдЧреЗред  рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдиреАрдЪреЗред </p><br><p>  рдмреНрд░реЗрдХрдкреНрд╡рд╛рдЗрдВрдЯ рдХреА рд╕реВрдЪреА рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдп рдЬреЛрдбрд╝реЗ: </p><br><div class="spoiler">  <b class="spoiler_title">рд╡рд┐рд░рд╛рдо рдмрд┐рдВрджреБ рдХрд╛рд░реНрдп</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *first_bp = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> breakpoint_t *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_bpt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bpt_type_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> address, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *bp = (<span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *)<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span>)); bp-&gt;type = type; bp-&gt;address = address; bp-&gt;width = width; bp-&gt;enabled = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first_bp) { bp-&gt;next = first_bp; bp-&gt;prev = first_bp-&gt;prev; first_bp-&gt;prev = bp; bp-&gt;prev-&gt;next = bp; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { first_bp = bp; bp-&gt;next = bp; bp-&gt;prev = bp; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bp; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete_breakpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">breakpoint_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * bp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bp == first_bp) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bp-&gt;next == bp) { first_bp = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { first_bp = bp-&gt;next; } } bp-&gt;next-&gt;prev = bp-&gt;prev; bp-&gt;prev-&gt;next = bp-&gt;next; <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(bp); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> breakpoint_t *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_breakpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">breakpoint_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bp-&gt;next != first_bp ? bp-&gt;next : <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> breakpoint_t *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_breakpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> address, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bpt_type_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *p; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p = first_bp; p; p = next_breakpoint(p)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((p-&gt;address == address) &amp;&amp; ((p-&gt;type == BPT_ANY) || (p-&gt;type &amp; type))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove_bpt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> address, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bpt_type_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *bpt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((bpt = find_breakpoint(address, type))) delete_breakpoint(bpt); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count_bpt_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *p; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p = first_bp; p; p = next_breakpoint(p)) { ++i; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_bpt_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bpt_data_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *p; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p = first_bp; p; p = next_breakpoint(p)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == index) { data-&gt;address = p-&gt;address; data-&gt;width = p-&gt;width; data-&gt;type = p-&gt;type; data-&gt;enabled = p-&gt;enabled; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } ++i; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear_bpt_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (first_bp != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) delete_breakpoint(first_bp); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_bpt_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first_bp) clear_bpt_list(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_breakpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bpt_type_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> address, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!dbg_req || !dbg_req-&gt;dbg_active || dbg_dont_check_bp) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">breakpoint_t</span></span> *bp; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (bp = first_bp; bp; bp = next_breakpoint(bp)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(bp-&gt;type &amp; type) || !bp-&gt;enabled) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((address &lt;= (bp-&gt;address + bp-&gt;width)) &amp;&amp; ((address + width) &gt;= bp-&gt;address)) { dbg_req-&gt;dbg_paused = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre> </div></div><br><h3 id="yadro-otladchika-osnovnye-peremennye">  рдбреАрдмрдЧрд░ рдХреЛрд░: рдореБрдЦреНрдп рдЪрд░ </h3><br><p>  рджрд░рдЕрд╕рд▓, рдореИрдВрдиреЗ рдЗрд╕ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЛ рдПрдХ рдФрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">PCSXR</a> рдбрд┐рдмрдЧрд░ рдореЗрдВ рдЬрд╛рд╕реВрд╕реА рдХреАред </p><br><p>  рдЙрди рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЛ рдЬреЛрдбрд╝реЗрдВ рдЬреЛ рдЗрдореНрдпреВрд▓реЗрд╢рди рд╕реНрдЯреЗрдЯ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░реЗрдВрдЧреЗ: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dbg_first_paused, dbg_trace, dbg_dont_check_bp; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dbg_step_over; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dbg_last_pc; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dbg_step_over_addr; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dbg_active, dbg_paused;</code> </pre> <br><p>  <code>dbg_first_paused</code> рдЪрд░ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдЕрдиреБрдХрд░рдг рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрдЧрд╛ред  рдпрджрд┐ <code>0</code> - рддреЛ рдЖрдкрдХреЛ рдПрдореБрд▓реЗрд╢рди рдХреЛ рд░реЛрдХрдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдПрдореБрд▓реЗрд╢рди рд╢реБрд░реВ рд╣реЛ рдЧрдпрд╛ рд╣реИред  рдкрд╣рд▓реЗ рдард╣рд░рд╛рд╡ рдХреЗ рдмрд╛рдж, <code>1</code> рд╕реЗрдЯ рдХрд░реЗрдВред </p><br><p>  рд╣рдореЗрдВ рдПрдХ рдирд┐рд░реНрджреЗрд╢ ( <code>Step Into</code> рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП <code>dbg_trace</code> рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдпрджрд┐ <code>1</code> рдмрд░рд╛рдмрд░ рд╣реИ, рддреЛ рд╣рдо рдПрдХ рдирд┐рд░реНрджреЗрд╢ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд░реЛрдХрддреЗ рд╣реИрдВ, рдФрд░ рдорд╛рди рдХреЛ <code>0</code> рд░реАрд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВред </p><br><p>  рдореИрдВрдиреЗ <code>dbg_dont_check_bp</code> рд╡реИрд░рд┐рдПрдмрд▓ рд╕реЗрдЯ рдХрд┐рдпрд╛ рддрд╛рдХрд┐ <code>dbg_dont_check_bp</code> рдХрд░рдиреЗ рдкрд░ рд░реАрдб / рд░рд╛рдЗрдЯ рдореЗрдореЛрд░реА рдмреНрд░реЗрдХ рдХрд╛рдо рди рдХрд░реЗред </p><br><p>  <code>dbg_step_over</code> рд╣рдорд╛рд░реЗ рд╕рд╛рде <code>1</code> рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдпрджрд┐ рд╣рдо рдореМрдЬреВрджрд╛ <code>PC</code> ( <em>рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд╛рдЙрдВрдЯрд░</em> , рдЙрд░реНрдл <em>рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рдкреЙрдЗрдВрдЯрд░</em> ) <code>dbg_step_over_addr</code> рдореЗрдВ рдкрддреЗ рдХреЗ рдмрд░рд╛рдмрд░ рд╣реЛрдиреЗ рддрдХ <code>Step Over</code> рдореЛрдб рдореЗрдВ рд╣реИрдВред  рдЙрд╕рдХреЗ рдмрд╛рдж, рджреЛрдиреЛрдВ рдЪрд░ рд░реАрд╕реЗрдЯ рдХрд░ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред  рдореИрдВ рдмрд╛рдж рдореЗрдВ <code>dbg_step_over_addr</code> рдХреЗ рдорд╛рди рдХреА рдЧрдгрдирд╛ <code>dbg_step_over_addr</code> ред </p><br><p>  рдореИрдВрдиреЗ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдорд╛рдорд▓реЗ рдХреЗ рд▓рд┐рдП <code>dbg_last_pc</code> рд╡реИрд░рд┐рдПрдмрд▓ рд╕реЗрдЯ рдХрд┐рдпрд╛: рдЬрдм рд╣рдо рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдмреНрд░реЗрдХ рдкрд░ рдЦрдбрд╝реЗ рд╣реИрдВ, рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ <code>dbg_last_pc</code> рдкреВрдЫрддрд╛ рд╣реИред  рддрд╛рдХрд┐ рдмреНрд░реЗрдХрд░ рдлрд┐рд░ рд╕реЗ рдХрд╛рдо рди рдХрд░реЗрдВ, рдореИрдВ рдЗрд╕ рдЪрд░ рдореЗрдВ рдЕрдВрддрд┐рдо <code>PC</code> рдХреЗ рдкрддреЗ рдХреА рддреБрд▓рдирд╛ рдирдП рдХреЗ рд╕рд╛рде рдХрд░рддрд╛ рд╣реВрдВ, рдФрд░ рдпрджрд┐ рдорд╛рди рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╣реИрдВ, рддреЛ рдЖрдк рд╡рд░реНрддрдорд╛рди <code>PC</code> рдкрд░ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  <code>dbg_active</code> - рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрд╣ рдбреАрдмрдЧрд┐рдВрдЧ рд╕рдХреНрд░рд┐рдп рд╣реЛрдиреЗ рдкрд░ <code>1</code> рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рдмреНрд░реЗрдХ, рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред </p><br><p>  <code>dbg_paused</code> рд╡реИрд░рд┐рдПрдмрд▓ рдХреЗ рд╕рд╛рде, рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рд╕рдм рдХреБрдЫ рд╕реНрдкрд╖реНрдЯ рд╣реИ: <code>1</code> - рд╣рдореЗрдВ рд░реЛрдХ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдмреНрд░реЗрдХ рдХреЗ рдмрд╛рдж рдЯреНрд░рд┐рдЧрд░ рд╣реЛрддрд╛ рд╣реИ) рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рдХрдорд╛рдВрдб рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддреЗ рд╣реИрдВ, <code>0</code> - рд╣рдо рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреЗ рд╣реИрдВред </p><br><p>  рд╣рдо рдЗрди рдЪрд░реЛрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдп рд▓рд┐рдЦрддреЗ рд╣реИрдВ: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pause_debugger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dbg_trace = <span class="hljs-number"><span class="hljs-number">1</span></span>; dbg_paused = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resume_debugger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dbg_trace = <span class="hljs-number"><span class="hljs-number">0</span></span>; dbg_paused = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">detach_debugger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ clear_bpt_list(); resume_debugger(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">activate_debugger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dbg_active = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deactivate_debugger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dbg_active = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ <code>detach_debugger()</code> рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдореЗрдВ рдореИрдВ рдмреНрд░реЗрдХ рдХреА рд╕реВрдЪреА рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рддрд╛ рдерд╛ред  рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рддрд╛рдХрд┐ рдЧреНрд░рд╛рд╣рдХ рдХреЛ рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдкреБрд░рд╛рдиреЗ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХрд╛рдо рдХрд░рдирд╛ рдЬрд╛рд░реА рди рд░рдЦреЗрдВред </p><br><h3 id="yadro-otladchika-realizuem-huk-na-instrukcii">  рдбрд┐рдмрдЧрд░ рдХреЛрд░: рд╣рдо рдирд┐рд░реНрджреЗрд╢реЛрдВ рдкрд░ рдПрдХ рд╣реБрдХ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ </h3><br><p>  рдЕрд╕рд▓ рдореЗрдВ, рдпрд╣рд╛рдВ рдореБрдЦреНрдп рдХрд╛рдо рдПрдХ рдард╣рд░рд╛рд╡, рдирд┐рд░рдВрддрд░ рдЕрдиреБрдХрд░рдг, <code>Step Into</code> , <code>Step Over</code> ред </p><br><p>  рдпрд╣рд╛рдБ <code>process_breakpoints()</code> рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдХреЛрдб рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_breakpoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> handled_event = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> is_step_over = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> is_step_in = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!dbg_active) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pc = m68k_get_reg(M68K_REG_PC); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dbg_paused &amp;&amp; dbg_first_paused &amp;&amp; !dbg_trace) longjmp(jmp_env, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!dbg_first_paused) { dbg_first_paused = <span class="hljs-number"><span class="hljs-number">1</span></span>; dbg_paused = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Send emulation started event } if (dbg_trace) { is_step_in = 1; dbg_trace = 0; dbg_paused = 1; // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Send event that Step Into has been triggered handled_event = 1; } if (!dbg_paused) { if (dbg_step_over &amp;&amp; pc == dbg_step_over_addr) { is_step_over = 1; dbg_step_over = 0; dbg_step_over_addr = 0; dbg_paused = 1; } if (dbg_last_pc != pc) check_breakpoint(BPT_M68K_E, 1, pc, pc); if (dbg_paused) { // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Send event about Step Over or breakpoint has been triggered handled_event = 1; } } if (dbg_first_paused &amp;&amp; (!handled_event) &amp;&amp; dbg_paused) { // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Send paused event } dbg_last_pc = pc; if (dbg_paused &amp;&amp; (!is_step_in || is_step_over)) { longjmp(jmp_env, 1); } }</span></span></code> </pre> <br><p>  рдЖрдЗрдП рд╕рдордЭрддреЗ рд╣реИрдВ: </p><br><ol><li>  рдпрджрд┐ рдбрд┐рдмрдЧрд┐рдВрдЧ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИ, рддреЛ рдмрд╕ рд╣реБрдХ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓реЗрдВ </li><li>  <code>longjmp</code> / <code>longjmp</code> рд╕рд╛рде рдЯреНрд░рд┐рдХ <code>longjmp</code> рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА рдХреНрдпреЛрдВрдХрд┐ <code>RetroArch</code> рд╢реЗрд▓ <code>RetroArch</code> , рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рд╣рдордиреЗ <code>Genesis Plus GX</code> рдХрд╛ рдЕрдкрдирд╛ рд╕рдВрд╕реНрдХрд░рдг рд▓рд┐рдЦрд╛ рдерд╛, рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╣рдо рдПрдореБрд▓реЗрд╢рди рдЪрд▓рд╛рддреЗ рд╣реИрдВ, рдлреНрд░реЗрдо рд░реЗрдВрдбрд░рд┐рдВрдЧ рдлрдВрдХреНрд╢рди рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдореБрд▓реЗрдЯрд░ рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░рддреЗ рд╣реИрдВред  рдореИрдВ рдмрд╛рдж рдореЗрдВ рдЯреНрд░рд┐рдХ рдХрд╛ рджреВрд╕рд░рд╛ рднрд╛рдЧ рджрд┐рдЦрд╛рдКрдВрдЧрд╛ред  рдпрд╣ рдХреЛрд░ рдХреЗ рдмрдЬрд╛рдп рдПрдореБрд▓реЗрдЯрд░ рдкрд░ рд╢реЗрд▓ рдХреЛ рдЫреВрддрд╛ рд╣реИред </li><li>  рдпрджрд┐ рдпрд╣ рд╣реБрдХ рдХрд╛ рд╣рдорд╛рд░рд╛ рдкрд╣рд▓рд╛ рдСрдкрд░реЗрд╢рди рд╣реИ, рдФрд░, рддрджрдиреБрд╕рд╛рд░, рдЕрдиреБрдХрд░рдг рдХреА рд╢реБрд░реБрдЖрдд, рд╣рдо рдЧреНрд░рд╛рд╣рдХ рдХреЛ рдЕрдиреБрдХрд░рдг рдХреА рд╢реБрд░реБрдЖрдд рдХреА рдШрдЯрдирд╛ рдХреЛ рд╡рд┐рд░рд╛рдо рджреЗрддреЗ рд╣реИрдВ рдФрд░ рднреЗрдЬрддреЗ рд╣реИрдВред </li><li>  рдпрджрд┐ рдХреНрд▓рд╛рдЗрдВрдЯ рдиреЗ рдкрд╣рд▓реЗ <code>Step Into</code> <code>dbg_trace</code> рднреЗрдЬрд╛ рдерд╛, рддреЛ рд╣рдо <code>dbg_trace</code> рдЪрд░ рдХрд╛ рдорд╛рди <code>dbg_trace</code> рдФрд░ рдЕрдиреБрдХрд░рдг рдХреЛ рд╡рд┐рд░рд╛рдо рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВред  рд╣рдо рдЧреНрд░рд╛рд╣рдХ рдХреЛ рд╕рдВрдмрдВрдзрд┐рдд рдШрдЯрдирд╛ рднреЗрдЬрддреЗ рд╣реИрдВред </li><li>  рдпрджрд┐ рд╣рдо рдард╣рд░рд╛рд╡ рдкрд░ рдирд╣реАрдВ рд╣реИрдВ, рддреЛ <code>Step Over</code> рдореЛрдб рдЪрд╛рд▓реВ рд╣реИ, рдФрд░ рд╡рд░реНрддрдорд╛рди <code>PC</code> рдЧрдВрддрд╡реНрдп рдкрддреЗ <code>dbg_step_over_addr</code> рдмрд░рд╛рдмрд░ рд╣реИ, рдЖрд╡рд╢реНрдпрдХ рдЪрд░ <code>dbg_step_over_addr</code> рдФрд░ рдард╣рд░рд╛рд╡ рдкрд░ рд░рдЦреЗрдВред </li><li>  рд╣рдо рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рд╣рдо рдЕрднреА рдЙрд╕ рдкрд░ рдирд╣реАрдВ рд╣реИрдВ, рдФрд░ рдЕрдЧрд░ рдмреНрд░реЗрдХ рдиреЗ рдХрд╛рдо рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рд╣рдо рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ <code>Step Over</code> рдпрд╛ рдмреНрд░реЗрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рдШрдЯрдирд╛ рднреЗрдЬрддреЗ рд╣реИрдВред </li><li>  рдпрджрд┐ рдпрд╣ рдмреНрд░реЗрдХрдбрд╛рдЙрди рдирд╣реАрдВ рд╣реИ, рддреЛ <code>Step Into</code> рдирд╣реАрдВ, рдФрд░ <code>Step Over</code> рдирд╣реАрдВ рд╣реИ, рддреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рдиреЗ рдмреНрд░реЗрдХ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ред  рд╣рдо рдЯреНрд░рд┐рдЧрд░ рдард╣рд░рд╛рд╡ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рдШрдЯрдирд╛ рднреЗрдЬрддреЗ рд╣реИрдВред </li><li>  рд╣рдо рдПрдХ рдард╣рд░рд╛рд╡ рдХреЗ рджреМрд░рд╛рди рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЕрдирдВрдд рд▓реВрдк рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рд░реВрдк рдореЗрдВ <code>longjump</code> рд╕рд╛рде рдЪрд╛рд▓ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВред </li></ol><br><p>  <code>Step Over</code> рд▓рд┐рдП рдкрддреЗ рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХрд╛ рдХреЛрдб рдЗрддрдирд╛ рд╕рд░рд▓ рдирд╣реАрдВ рдерд╛ рдЬрд┐рддрдирд╛ рдХрд┐ рдЖрдк рдкрд╣рд▓реЗ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВред  рдореЛрдЯреЛрд░реЛрд▓рд╛ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреА рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЕрдиреБрджреЗрд╢ рд▓рдВрдмрд╛рдИ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдУрдкрдХреЛрдб рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдЕрдЧрд▓реЗ рдкрддреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдкрдХреЛ <code>bra</code> , <code>jmp</code> , рд╕рд╢рд░реНрдд рдЫрд▓рд╛рдВрдЧ рдХреЗ <code>jmp</code> рдЬреИрд╕реЗ рдирд┐рд░реНрджреЗрд╢реЛрдВ рд╕реЗ рдмрдЪрдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ, рдФрд░ рдЙрдиреНрд╣реЗрдВ <code>Step Into</code> <code>jmp</code> рд░реВрдк <code>Step Into</code> рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред  рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ: </p><br><div class="spoiler">  <b class="spoiler_title">Calc_step_over () рдлрд╝рдВрдХреНрд╢рди рдХреЛрдб</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc_step_over</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pc = m68k_get_reg(M68K_REG_PC); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sp = m68k_get_reg(M68K_REG_SP); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> opc = m68ki_read_imm_16(); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dest_pc = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// jsr if ((opc &amp; 0xFFF8) == 0x4E90) { m68k_op_jsr_32_ai(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFF8) == 0x4EA8) { m68k_op_jsr_32_di(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFF8) == 0x4EB0) { m68k_op_jsr_32_ix(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EB8) { m68k_op_jsr_32_aw(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EB9) { m68k_op_jsr_32_al(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EBA) { m68k_op_jsr_32_pcdi(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EBB) { m68k_op_jsr_32_pcix(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } // bsr else if ((opc &amp; 0xFFFF) == 0x6100) { m68k_op_bsr_16(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x61FF) { m68k_op_bsr_32(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFF00) == 0x6100) { m68k_op_bsr_8(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } // dbf else if ((opc &amp; 0xfff8) == 0x51C8) { dest_pc = m68k_get_reg(M68K_REG_PC) + 2; } m68k_set_reg(M68K_REG_PC, pc); m68k_set_reg(M68K_REG_SP, sp); return dest_pc;</span></span></code> </pre> </div></div><br><h3 id="yadro-otladchika-inicializaciya-i-ostanovka-otladki">  рдбреАрдмрдЧрд░ рдХрд░реНрдиреЗрд▓: рдЖрд░рдВрдн рдХрд░рдирд╛ рдФрд░ рдбреАрдмрдЧ рдХрд░рдирд╛ рд░реЛрдХрдирд╛ </h3><br><p>  рдпрд╣рд╛рдБ рд╕рдм рдХреБрдЫ рд╕рд░рд▓ рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop_debugging</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Send Stopped event to client detach_debugger(); deactivate_debugger(); dbg_first_paused = dbg_paused = dbg_trace = dbg_dont_check_bp = dbg_step_over = dbg_step_over_addr = dbg_last_pc = 0; } void start_debugging() { if (dbg_active) return; activate_debugger(); init_bpt_list(); dbg_first_paused = dbg_paused = dbg_trace = dbg_dont_check_bp = dbg_step_over = dbg_step_over_addr = dbg_last_pc = 0; }</span></span></code> </pre> <br><h3 id="yadro-otladchika-realizaciya-protokola">  рдбреАрдмрдЧрд░ рдХрд░реНрдиреЗрд▓: рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди </h3><br><p>  рдбрд┐рдмрдЧ рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдбреАрдмрдЧрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рджреВрд╕рд░рд╛ рджрд┐рд▓ рдХрд╣рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐  рдпрд╣ рдЧреНрд░рд╛рд╣рдХ рд╕реЗ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЙрди рдкрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛ рд╣реИред <br>  рдЗрд╕реЗ <em>рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА</em> рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдХреНрдпреЛрдВрдХрд┐ <em>рдореЗрдореЛрд░реА рдХреЗ</em> рдмрдбрд╝реЗ рдмреНрд▓реЙрдХреЛрдВ рдХреЛ рднреЗрдЬрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ: <code>VRAM</code> , <code>RAM</code> , <code>ROM</code> , рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдпрд╣ рдФрд░ рднреА рдордЬреЗрджрд╛рд░ рд╣реЛрдЧрд╛ред </p><br><p>  рд╕рд╛рд░ рдпрд╣ рд╣реИ: рдХрд░реНрдиреЗрд▓ рдПрдХ рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд╕рд╛рде рдПрдХ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдмрдирд╛рддрд╛ рд╣реИ, рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИред  рдЕрдиреБрд░реЛрдз рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЙрддреНрддрд░ рдХреЛ рдЙрд╕реА рдореЗрдореЛрд░реА рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдЙрд╕реА рдореЗрдореЛрд░реА рдореЗрдВ рдбреАрдмрдЧрд░ рдШрдЯрдирд╛рдУрдВ рдХреА рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИред </p><br><p>  рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдЪреБрдирд╛ рдЧрдпрд╛ рдерд╛: </p><br><div class="spoiler">  <b class="spoiler_title">рд╕реНрд░реЛрдд рдкреИрдХреЗрдЬ debug_wrap.h рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _DEBUG_WRAP_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _DEBUG_WRAP_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Windows.h&gt; #define SHARED_MEM_NAME "GX_PLUS_SHARED_MEM" #define MAX_BREAKPOINTS 1000 #define MAX_DBG_EVENTS 20 #ifndef MAXROMSIZE #define MAXROMSIZE ((unsigned int)0xA00000) #endif #pragma pack(push, 4) typedef enum { BPT_ANY = (0 &lt;&lt; 0), // M68K BPT_M68K_E = (1 &lt;&lt; 0), BPT_M68K_R = (1 &lt;&lt; 1), BPT_M68K_W = (1 &lt;&lt; 2), BPT_M68K_RW = BPT_M68K_R | BPT_M68K_W, // VDP BPT_VRAM_R = (1 &lt;&lt; 3), BPT_VRAM_W = (1 &lt;&lt; 4), BPT_VRAM_RW = BPT_VRAM_R | BPT_VRAM_W, BPT_CRAM_R = (1 &lt;&lt; 5), BPT_CRAM_W = (1 &lt;&lt; 6), BPT_CRAM_RW = BPT_CRAM_R | BPT_CRAM_W, BPT_VSRAM_R = (1 &lt;&lt; 7), BPT_VSRAM_W = (1 &lt;&lt; 8), BPT_VSRAM_RW = BPT_VSRAM_R | BPT_VSRAM_W, // Z80 BPT_Z80_E = (1 &lt;&lt; 11), BPT_Z80_R = (1 &lt;&lt; 12), BPT_Z80_W = (1 &lt;&lt; 13), BPT_Z80_RW = BPT_Z80_R | BPT_Z80_W, // REGS BPT_VDP_REG = (1 &lt;&lt; 9), BPT_M68K_REG = (1 &lt;&lt; 10), } bpt_type_t; typedef enum { REQ_NO_REQUEST, REQ_GET_REGS, REQ_SET_REGS, REQ_GET_REG, REQ_SET_REG, REQ_READ_68K_ROM, REQ_READ_68K_RAM, REQ_WRITE_68K_ROM, REQ_WRITE_68K_RAM, REQ_READ_Z80, REQ_WRITE_Z80, REQ_ADD_BREAK, REQ_TOGGLE_BREAK, REQ_DEL_BREAK, REQ_CLEAR_BREAKS, REQ_LIST_BREAKS, REQ_ATTACH, REQ_PAUSE, REQ_RESUME, REQ_STOP, REQ_STEP_INTO, REQ_STEP_OVER, } request_type_t; typedef enum { REG_TYPE_M68K = (1 &lt;&lt; 0), REG_TYPE_S80 = (1 &lt;&lt; 1), REG_TYPE_Z80 = (1 &lt;&lt; 2), REG_TYPE_VDP = (1 &lt;&lt; 3), } register_type_t; typedef enum { DBG_EVT_NO_EVENT, DBG_EVT_STARTED, DBG_EVT_PAUSED, DBG_EVT_BREAK, DBG_EVT_STEP, DBG_EVT_STOPPED, } dbg_event_type_t; typedef struct { dbg_event_type_t type; unsigned int pc; char msg[256]; } debugger_event_t; typedef struct { int index; unsigned int val; } reg_val_t; typedef struct { unsigned int d0, d1, d2, d3, d4, d5, d6, d7; unsigned int a0, a1, a2, a3, a4, a5, a6, a7; unsigned int pc, sr, sp, usp, isp, ppc, ir; } regs_68k_data_t; typedef enum { REG_68K_D0, REG_68K_D1, REG_68K_D2, REG_68K_D3, REG_68K_D4, REG_68K_D5, REG_68K_D6, REG_68K_D7, REG_68K_A0, REG_68K_A1, REG_68K_A2, REG_68K_A3, REG_68K_A4, REG_68K_A5, REG_68K_A6, REG_68K_A7, REG_68K_PC, REG_68K_SR, REG_68K_SP, REG_68K_USP, REG_68K_ISP, REG_68K_PPC, REG_68K_IR, REG_VDP_00, REG_VDP_01, REG_VDP_02, REG_VDP_03, REG_VDP_04, REG_VDP_05, REG_VDP_06, REG_VDP_07, REG_VDP_08, REG_VDP_09, REG_VDP_0A, REG_VDP_0B, REG_VDP_0C, REG_VDP_0D, REG_VDP_0E, REG_VDP_0F, REG_VDP_10, REG_VDP_11, REG_VDP_12, REG_VDP_13, REG_VDP_14, REG_VDP_15, REG_VDP_16, REG_VDP_17, REG_VDP_18, REG_VDP_19, REG_VDP_1A, REG_VDP_1B, REG_VDP_1C, REG_VDP_1D, REG_VDP_1E, REG_VDP_1F, REG_VDP_DMA_LEN, REG_VDP_DMA_SRC, REG_VDP_DMA_DST, REG_Z80_PC, REG_Z80_SP, REG_Z80_AF, REG_Z80_BC, REG_Z80_DE, REG_Z80_HL, REG_Z80_IX, REG_Z80_IY, REG_Z80_WZ, REG_Z80_AF2, REG_Z80_BC2, REG_Z80_DE2, REG_Z80_HL2, REG_Z80_R, REG_Z80_R2, REG_Z80_IFFI1, REG_Z80_IFFI2, REG_Z80_HALT, REG_Z80_IM, REG_Z80_I, } regs_all_t; typedef struct { unsigned int pc, sp, af, bc, de, hl, ix, iy, wz; unsigned int af2,bc2,de2,hl2; unsigned char r, r2, iff1, iff2, halt, im, i; } regs_z80_data_t; typedef struct { unsigned char regs_vdp[0x20]; unsigned short dma_len; unsigned int dma_src, dma_dst; } vdp_regs_t; typedef struct { int type; // register_type_t regs_68k_data_t regs_68k; reg_val_t any_reg; vdp_regs_t vdp_regs; regs_z80_data_t regs_z80; } register_data_t; typedef struct { int size; unsigned int address; unsigned char m68k_rom[MAXROMSIZE]; unsigned char m68k_ram[0x10000]; unsigned char z80_ram[0x2000]; } memory_data_t; typedef struct { bpt_type_t type; unsigned int address; int width; int enabled; } bpt_data_t; typedef struct { int count; bpt_data_t breaks[MAX_BREAKPOINTS]; } bpt_list_t; typedef struct { request_type_t req_type; register_data_t regs_data; memory_data_t mem_data; bpt_data_t bpt_data; int dbg_events_count; debugger_event_t dbg_events[MAX_DBG_EVENTS]; bpt_list_t bpt_list; int dbg_active, dbg_paused; int is_ida; } dbg_request_t; #pragma pack(pop) dbg_request_t *open_shared_mem(); void close_shared_mem(dbg_request_t **request); int recv_dbg_event(dbg_request_t *request, int wait); void send_dbg_request(dbg_request_t *request, request_type_t type); #ifdef __cplusplus } #endif #endif</span></span></span></span></code> </pre> </div></div><br><p>  рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдкрд╣рд▓рд╛ рдХреНрд╖реЗрддреНрд░ рдЕрдиреБрд░реЛрдз рдХрд╛ рдкреНрд░рдХрд╛рд░ рд╣реЛрдЧрд╛: </p><br><ul><li>  рд░реАрдб / рд╕реЗрдЯ рд░рдЬрд┐рд╕реНрдЯрд░ </li><li>  рдореЗрдореЛрд░реА рдкрдврд╝реЗрдВ / рд▓рд┐рдЦреЗрдВ </li><li>  рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░реЗрдВ </li><li>  рдбрд┐рдмрдЧрд░ рдХреЛ рд░реЛрдХрдирд╛ / рдЬрд╛рд░реА рд░рдЦрдирд╛, рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ / рдмрдВрдж рдХрд░рдирд╛ </li><li>  <code>Step Into</code> / <code>Step Over</code> </li></ul><br><p>  рдЗрд╕рдХреЗ рдмрд╛рдж рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реИрдВ <code>M68K</code> , <code>Z80</code> , <code>VDP</code> ред  рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдореЛрд░реА рдмреНрд▓реЙрдХ <code>ROM</code> , <code>RAM</code> , <code>VRAM</code> , <code>Z80</code> ред </p><br><p>  рдПрдХ рджрд░рд╛рд░ рдХреЛ рдЬреЛрдбрд╝рдиреЗ / рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рд╕рдВрдЧрдд рд╕рдВрд░рдЪрдирд╛ рднреА рдмрдирд╛рдИред  рдЦреИрд░, рдЙрдирдХреА рд╕реВрдЪреА рднреА рдпрд╣рд╛рдВ рд╣реИ (рдЕрдзрд┐рдХрд╛рдВрд╢ рднрд╛рдЧ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдХреЗрд╡рд▓ рдЬреАрдпреВрдЖрдИ рдореЗрдВ рдкреНрд░рджрд░реНрд╢рди рдХреЗ рд▓рд┐рдП рд╣реИ, рд╕рднреА рд╕реНрдерд╛рдкрд┐рдд рдмреНрд░реЗрдХ рдХреЛ рдпрд╛рдж рд░рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рдмрд┐рдирд╛, рдЬреИрд╕рд╛ рдХрд┐ <code>IDA</code> рдХрд░рддрд╛ рд╣реИ)ред </p><br><p>  рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдбрд┐рдмрдЧрд┐рдВрдЧ рдШрдЯрдирд╛рдУрдВ рдХреА рдПрдХ рд╕реВрдЪреА рд╣реИ: </p><br><ul><li>  рдбрд┐рдмрдЧрд┐рдВрдЧ рд╢реБрд░реВ ( <code>IDA Pro</code> рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ) </li><li>  рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреЛ рд░реЛрдХ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдЬрд┐рд╕ рдкрд░ рдПрдореБрд▓реЗрд╢рди рд╡рд░реНрддрдорд╛рди рдореЗрдВ рд░реЛрдХрд╛ рдЧрдпрд╛ рд╣реИ рд╡рд╣ <code>PC</code> рдШрдЯрдирд╛ рдореЗрдВ рдмрдЪ рдЧрдпрд╛ рд╣реИ) </li><li>  рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдиреЗ рдХрд╛рдо рдХрд┐рдпрд╛ ( <code>PC</code> рдХрд╛ рдореВрд▓реНрдп рднреА, рдЬрд┐рд╕ рдкрд░ рдСрдкрд░реЗрд╢рди рд╣реБрдЖ) </li><li>  <code>Step Into</code> рдпрд╛ <code>Step Over</code> рдкреНрд░рджрд░реНрд╢рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдХреЗрд╡рд▓ <code>IDA</code> рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЖрдк рдХреЗрд╡рд▓ рдПрдХ рдард╣рд░рд╛рд╡ рдШрдЯрдирд╛ рдХреЗ рд╕рд╛рде рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ) </li><li>  рдЕрдиреБрдХрд░рдг рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд░реЛрдХ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдЗрд╕ рдШрдЯрдирд╛ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдмрд┐рдирд╛ <code>IDA</code> рдореЗрдВ <code>Stop</code> рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдпрд╣ рдПрдХ рд╕реНрдЯреЙрдк рдХреЗ рд▓рд┐рдП рдЕрдВрддрд╣реАрди рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдЧрд╛ </li></ul><br><p>  рдПрдХ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рд╡рд┐рдЪрд╛рд░ рдХреЗ рд╕рд╛рде рд╕рд╢рд╕реНрддреНрд░, рд╣рдо рдЧреНрд░рд╛рд╣рдХ рдЕрдиреБрд░реЛрдз рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдбреАрдмрдЧрд░ рдХрд░реНрдиреЗрд▓ рдХреЛрдб рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ: </p><br><div class="spoiler">  <b class="spoiler_title">рд╕реНрд░реЛрдд рдкреИрдХреЗрдЬ debug.c рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"debug.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"shared.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> m68ki_cpu m68k #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MUL (7) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> BUILD_TABLES #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m68ki_cycles.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m68kconf.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m68kcpu.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m68kops.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"vdp_ctrl.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Z80.h"</span></span></span><span class="hljs-meta"> static int dbg_first_paused, dbg_trace, dbg_dont_check_bp; static int dbg_step_over; static int dbg_last_pc; static unsigned int dbg_step_over_addr; static dbg_request_t *dbg_req = NULL; static HANDLE hMapFile = 0; typedef struct breakpoint_s { struct breakpoint_s *next, *prev; int enabled; int width; bpt_type_t type; unsigned int address; } breakpoint_t; static breakpoint_t *first_bp = NULL; static breakpoint_t *add_bpt(bpt_type_t type, unsigned int address, int width) { breakpoint_t *bp = (breakpoint_t *)malloc(sizeof(breakpoint_t)); bp-&gt;type = type; bp-&gt;address = address; bp-&gt;width = width; bp-&gt;enabled = 1; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (first_bp) { bp-&gt;next = first_bp; bp-&gt;prev = first_bp-&gt;prev; first_bp-&gt;prev = bp; bp-&gt;prev-&gt;next = bp; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { first_bp = bp; bp-&gt;next = bp; bp-&gt;prev = bp; } return bp; } static void delete_breakpoint(breakpoint_t * bp) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (bp == first_bp) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (bp-&gt;next == bp) { first_bp = NULL; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { first_bp = bp-&gt;next; } } bp-&gt;next-&gt;prev = bp-&gt;prev; bp-&gt;prev-&gt;next = bp-&gt;next; free(bp); } static breakpoint_t *next_breakpoint(breakpoint_t *bp) { return bp-&gt;next != first_bp ? bp-&gt;next : 0; } static breakpoint_t *find_breakpoint(unsigned int address, bpt_type_t type) { breakpoint_t *p; for (p = first_bp; p; p = next_breakpoint(p)) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((p-&gt;address == address) &amp;&amp; ((p-&gt;type == BPT_ANY) || (p-&gt;type &amp; type))) return p; } return 0; } static void remove_bpt(unsigned int address, bpt_type_t type) { breakpoint_t *bpt; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((bpt = find_breakpoint(address, type))) delete_breakpoint(bpt); } static int count_bpt_list() { breakpoint_t *p; int i = 0; for (p = first_bp; p; p = next_breakpoint(p)) { ++i; } return i; } static void get_bpt_data(int index, bpt_data_t *data) { breakpoint_t *p; int i = 0; for (p = first_bp; p; p = next_breakpoint(p)) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (i == index) { data-&gt;address = p-&gt;address; data-&gt;width = p-&gt;width; data-&gt;type = p-&gt;type; data-&gt;enabled = p-&gt;enabled; break; } ++i; } } static void clear_bpt_list() { while (first_bp != NULL) delete_breakpoint(first_bp); } static void init_bpt_list() { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (first_bp) clear_bpt_list(); } void check_breakpoint(bpt_type_t type, int width, unsigned int address, unsigned int value) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!dbg_req || !dbg_req-&gt;dbg_active || dbg_dont_check_bp) return; breakpoint_t *bp; for (bp = first_bp; bp; bp = next_breakpoint(bp)) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!(bp-&gt;type &amp; type) || !bp-&gt;enabled) continue; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((address </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;= (bp-&gt;address + bp-&gt;width)) &amp;&amp; ((address + width) &gt;= bp-&gt;address)) { dbg_req-&gt;dbg_paused = 1; break; } } } static void pause_debugger() { dbg_trace = 1; dbg_req-&gt;dbg_paused = 1; } static void resume_debugger() { dbg_trace = 0; dbg_req-&gt;dbg_paused = 0; } static void detach_debugger() { clear_bpt_list(); resume_debugger(); } static void activate_debugger() { dbg_req-&gt;dbg_active = 1; } static void deactivate_debugger() { dbg_req-&gt;dbg_active = 0; } int activate_shared_mem() { hMapFile = CreateFileMapping(INVALID_HANDLE_VALUE, NULL, PAGE_READWRITE, 0, sizeof(dbg_request_t), SHARED_MEM_NAME); if (hMapFile == 0) { return -1; } dbg_req = (dbg_request_t*)MapViewOfFile(hMapFile, FILE_MAP_ALL_ACCESS, 0, 0, sizeof(dbg_request_t)); if (dbg_req == 0) { CloseHandle(hMapFile); return -1; } memset(dbg_req, 0, sizeof(dbg_request_t)); return 0; } void deactivate_shared_mem() { UnmapViewOfFile(dbg_req); CloseHandle(hMapFile); hMapFile = NULL; dbg_req = NULL; } static unsigned int calc_step_over() { unsigned int pc = m68k_get_reg(M68K_REG_PC); unsigned int sp = m68k_get_reg(M68K_REG_SP); unsigned int opc = m68ki_read_imm_16(); unsigned int dest_pc = (unsigned int)(-1); // jsr if ((opc &amp; 0xFFF8) == 0x4E90) { m68k_op_jsr_32_ai(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFF8) == 0x4EA8) { m68k_op_jsr_32_di(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFF8) == 0x4EB0) { m68k_op_jsr_32_ix(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EB8) { m68k_op_jsr_32_aw(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EB9) { m68k_op_jsr_32_al(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EBA) { m68k_op_jsr_32_pcdi(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x4EBB) { m68k_op_jsr_32_pcix(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } // bsr else if ((opc &amp; 0xFFFF) == 0x6100) { m68k_op_bsr_16(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFFFF) == 0x61FF) { m68k_op_bsr_32(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } else if ((opc &amp; 0xFF00) == 0x6100) { m68k_op_bsr_8(); m68k_op_rts_32(); dest_pc = m68k_get_reg(M68K_REG_PC); } // dbf else if ((opc &amp; 0xfff8) == 0x51C8) { dest_pc = m68k_get_reg(M68K_REG_PC) + 2; } m68k_set_reg(M68K_REG_PC, pc); m68k_set_reg(M68K_REG_SP, sp); return dest_pc; } void process_request() { if (!dbg_req || !dbg_req-&gt;dbg_active) return; if (dbg_req-&gt;req_type == REQ_NO_REQUEST) return; switch (dbg_req-&gt;req_type) { case REQ_GET_REG: { register_data_t *regs_data = &amp;dbg_req-&gt;regs_data; if (regs_data-&gt;type &amp; REG_TYPE_M68K) regs_data-&gt;any_reg.val = m68k_get_reg(regs_data-&gt;any_reg.index); if (regs_data-&gt;type &amp; REG_TYPE_VDP) regs_data-&gt;any_reg.val = reg[regs_data-&gt;any_reg.index]; if (regs_data-&gt;type &amp; REG_TYPE_Z80) { if (regs_data-&gt;any_reg.index &gt;= 0 &amp;&amp; regs_data-&gt;any_reg.index &lt;= 12) // PC &lt;-&gt; HL2 { regs_data-&gt;any_reg.val = ((unsigned int *)&amp;Z80.pc)[regs_data-&gt;any_reg.index]; } else if (regs_data-&gt;any_reg.index &gt;= 13 &amp;&amp; regs_data-&gt;any_reg.index &lt;= 19) // R &lt;-&gt; I { regs_data-&gt;any_reg.val = ((unsigned char *)&amp;Z80.r)[regs_data-&gt;any_reg.index - 13]; } } } break; case REQ_SET_REG: { register_data_t *regs_data = &amp;dbg_req-&gt;regs_data; if (regs_data-&gt;type &amp; REG_TYPE_M68K) m68k_set_reg(regs_data-&gt;any_reg.index, regs_data-&gt;any_reg.val); if (regs_data-&gt;type &amp; REG_TYPE_VDP) reg[regs_data-&gt;any_reg.index] = regs_data-&gt;any_reg.val; if (regs_data-&gt;type &amp; REG_TYPE_Z80) { if (regs_data-&gt;any_reg.index &gt;= 0 &amp;&amp; regs_data-&gt;any_reg.index &lt;= 12) // PC &lt;-&gt; HL2 { ((unsigned int *)&amp;Z80.pc)[regs_data-&gt;any_reg.index] = regs_data-&gt;any_reg.val; } else if (regs_data-&gt;any_reg.index &gt;= 13 &amp;&amp; regs_data-&gt;any_reg.index &lt;= 19) // R &lt;-&gt; I { ((unsigned char *)&amp;Z80.r)[regs_data-&gt;any_reg.index - 13] = regs_data-&gt;any_reg.val &amp; 0xFF; } } } break; case REQ_GET_REGS: case REQ_SET_REGS: { register_data_t *regs_data = &amp;dbg_req-&gt;regs_data; if (regs_data-&gt;type &amp; REG_TYPE_M68K) { regs_68k_data_t *m68kr = &amp;regs_data-&gt;regs_68k; if (dbg_req-&gt;req_type == REQ_GET_REGS) { m68kr-&gt;d0 = m68k_get_reg(M68K_REG_D0); m68kr-&gt;d1 = m68k_get_reg(M68K_REG_D1); m68kr-&gt;d2 = m68k_get_reg(M68K_REG_D2); m68kr-&gt;d3 = m68k_get_reg(M68K_REG_D3); m68kr-&gt;d4 = m68k_get_reg(M68K_REG_D4); m68kr-&gt;d5 = m68k_get_reg(M68K_REG_D5); m68kr-&gt;d6 = m68k_get_reg(M68K_REG_D6); m68kr-&gt;d7 = m68k_get_reg(M68K_REG_D7); m68kr-&gt;a0 = m68k_get_reg(M68K_REG_A0); m68kr-&gt;a1 = m68k_get_reg(M68K_REG_A1); m68kr-&gt;a2 = m68k_get_reg(M68K_REG_A2); m68kr-&gt;a3 = m68k_get_reg(M68K_REG_A3); m68kr-&gt;a4 = m68k_get_reg(M68K_REG_A4); m68kr-&gt;a5 = m68k_get_reg(M68K_REG_A5); m68kr-&gt;a6 = m68k_get_reg(M68K_REG_A6); m68kr-&gt;a7 = m68k_get_reg(M68K_REG_A7); m68kr-&gt;pc = m68k_get_reg(M68K_REG_PC); m68kr-&gt;sr = m68k_get_reg(M68K_REG_SR); m68kr-&gt;sp = m68k_get_reg(M68K_REG_SP); m68kr-&gt;usp = m68k_get_reg(M68K_REG_USP); m68kr-&gt;isp = m68k_get_reg(M68K_REG_ISP); m68kr-&gt;ppc = m68k_get_reg(M68K_REG_PPC); m68kr-&gt;ir = m68k_get_reg(M68K_REG_IR); } else { m68k_set_reg(M68K_REG_D0, m68kr-&gt;d0); m68k_set_reg(M68K_REG_D1, m68kr-&gt;d1); m68k_set_reg(M68K_REG_D2, m68kr-&gt;d2); m68k_set_reg(M68K_REG_D3, m68kr-&gt;d3); m68k_set_reg(M68K_REG_D4, m68kr-&gt;d4); m68k_set_reg(M68K_REG_D5, m68kr-&gt;d5); m68k_set_reg(M68K_REG_D6, m68kr-&gt;d6); m68k_set_reg(M68K_REG_D7, m68kr-&gt;d7); m68k_set_reg(M68K_REG_A0, m68kr-&gt;a0); m68k_set_reg(M68K_REG_A1, m68kr-&gt;a1); m68k_set_reg(M68K_REG_A2, m68kr-&gt;a2); m68k_set_reg(M68K_REG_A3, m68kr-&gt;a3); m68k_set_reg(M68K_REG_A4, m68kr-&gt;a4); m68k_set_reg(M68K_REG_A5, m68kr-&gt;a5); m68k_set_reg(M68K_REG_A6, m68kr-&gt;a6); m68k_set_reg(M68K_REG_A7, m68kr-&gt;a7); m68k_set_reg(M68K_REG_PC, m68kr-&gt;pc); m68k_set_reg(M68K_REG_SR, m68kr-&gt;sr); m68k_set_reg(M68K_REG_SP, m68kr-&gt;sp); m68k_set_reg(M68K_REG_USP, m68kr-&gt;usp); m68k_set_reg(M68K_REG_ISP, m68kr-&gt;isp); } } if (regs_data-&gt;type &amp; REG_TYPE_VDP) { vdp_regs_t *vdp_regs = &amp;regs_data-&gt;vdp_regs; for (int i = 0; i &lt; (sizeof(vdp_regs) / sizeof(vdp_regs-&gt;regs_vdp[0])); ++i) { if (dbg_req-&gt;req_type == REQ_GET_REGS) vdp_regs-&gt;regs_vdp[i] = reg[i]; else reg[i] = vdp_regs-&gt;regs_vdp[i]; } if (dbg_req-&gt;req_type == REQ_GET_REGS) { vdp_regs-&gt;dma_len = (reg[20] &lt;&lt; 8) | reg[19]; if (!vdp_regs-&gt;dma_len) vdp_regs-&gt;dma_len = 0x10000; vdp_regs-&gt;dma_src = vdp_dma_calc_src(); vdp_regs-&gt;dma_dst = vdp_dma_get_dst(); } } if (regs_data-&gt;type &amp; REG_TYPE_Z80) { regs_z80_data_t *z80r = &amp;regs_data-&gt;regs_z80; if (dbg_req-&gt;req_type == REQ_GET_REGS) { z80r-&gt;pc = Z80.pc.d; z80r-&gt;sp = Z80.sp.d; z80r-&gt;af = Z80.af.d; z80r-&gt;bc = Z80.bc.d; z80r-&gt;de = Z80.de.d; z80r-&gt;hl = Z80.hl.d; z80r-&gt;ix = Z80.ix.d; z80r-&gt;iy = Z80.iy.d; z80r-&gt;wz = Z80.wz.d; z80r-&gt;af2 = Z80.af2.d; z80r-&gt;bc2 = Z80.bc2.d; z80r-&gt;de2 = Z80.de2.d; z80r-&gt;hl2 = Z80.hl2.d; z80r-&gt;r = Z80.r; z80r-&gt;r2 = Z80.r2; z80r-&gt;iff1 = Z80.iff1; z80r-&gt;iff2 = Z80.iff2; z80r-&gt;halt = Z80.halt; z80r-&gt;im = Z80.im; z80r-&gt;i = Z80.i; } else { Z80.pc.d = z80r-&gt;pc; Z80.sp.d = z80r-&gt;sp; Z80.af.d = z80r-&gt;af; Z80.bc.d = z80r-&gt;bc; Z80.de.d = z80r-&gt;de; Z80.hl.d = z80r-&gt;hl; Z80.ix.d = z80r-&gt;ix; Z80.iy.d = z80r-&gt;iy; Z80.wz.d = z80r-&gt;wz; Z80.af2.d = z80r-&gt;af2; Z80.bc2.d = z80r-&gt;bc2; Z80.de2.d = z80r-&gt;de2; Z80.hl2.d = z80r-&gt;hl2; Z80.r = z80r-&gt;r; Z80.r2 = z80r-&gt;r2; Z80.iff1 = z80r-&gt;iff1; Z80.iff2 = z80r-&gt;iff2; Z80.halt = z80r-&gt;halt; Z80.im = z80r-&gt;im; Z80.i = z80r-&gt;i; } } } break; case REQ_READ_68K_ROM: case REQ_READ_68K_RAM: case REQ_READ_Z80: { dbg_dont_check_bp = 1; memory_data_t *mem_data = &amp;dbg_req-&gt;mem_data; for (int i = 0; i &lt; mem_data-&gt;size; ++i) { switch (dbg_req-&gt;req_type) { case REQ_READ_68K_ROM: mem_data-&gt;m68k_rom[mem_data-&gt;address + i] = m68ki_read_8(mem_data-&gt;address + i); break; case REQ_READ_68K_RAM: mem_data-&gt;m68k_ram[(mem_data-&gt;address + i) &amp; 0xFFFF] = m68ki_read_8(mem_data-&gt;address + i); break; case REQ_READ_Z80: mem_data-&gt;z80_ram[(mem_data-&gt;address + i) &amp; 0x1FFF] = z80_readmem(mem_data-&gt;address + i); break; default: break; } } dbg_dont_check_bp = 0; } break; case REQ_WRITE_68K_ROM: case REQ_WRITE_68K_RAM: case REQ_WRITE_Z80: { dbg_dont_check_bp = 1; memory_data_t *mem_data = &amp;dbg_req-&gt;mem_data; for (int i = 0; i &lt; mem_data-&gt;size; ++i) { switch (dbg_req-&gt;req_type) { case REQ_WRITE_68K_ROM: m68ki_write_8(mem_data-&gt;address + i, mem_data-&gt;m68k_rom[mem_data-&gt;address + i]); break; case REQ_WRITE_68K_RAM: m68ki_write_8(0xFF0000 | ((mem_data-&gt;address + i) &amp; 0xFFFF), mem_data-&gt;m68k_ram[(mem_data-&gt;address + i) &amp; 0xFFFF]); break; case REQ_WRITE_Z80: z80_writemem(mem_data-&gt;address + i, mem_data-&gt;z80_ram[(mem_data-&gt;address + i) &amp; 0x1FFF]); break; default: break; } } dbg_dont_check_bp = 0; } break; case REQ_ADD_BREAK: { bpt_data_t *bpt_data = &amp;dbg_req-&gt;bpt_data; if (!find_breakpoint(bpt_data-&gt;address, bpt_data-&gt;type)) add_bpt(bpt_data-&gt;type, bpt_data-&gt;address, bpt_data-&gt;width); } break; case REQ_TOGGLE_BREAK: { bpt_data_t *bpt_data = &amp;dbg_req-&gt;bpt_data; breakpoint_t *bp = find_breakpoint(bpt_data-&gt;address, bpt_data-&gt;type); if (bp != NULL) bp-&gt;enabled = !bp-&gt;enabled; } break; case REQ_DEL_BREAK: { bpt_data_t *bpt_data = &amp;dbg_req-&gt;bpt_data; remove_bpt(bpt_data-&gt;address, bpt_data-&gt;type); } break; case REQ_CLEAR_BREAKS: clear_bpt_list(); case REQ_LIST_BREAKS: { bpt_list_t *bpt_list = &amp;dbg_req-&gt;bpt_list; bpt_list-&gt;count = count_bpt_list(); for (int i = 0; i &lt; bpt_list-&gt;count; ++i) get_bpt_data(i, &amp;bpt_list-&gt;breaks[i]); } break; case REQ_ATTACH: activate_debugger(); dbg_first_paused = 0; break; case REQ_PAUSE: pause_debugger(); break; case REQ_RESUME: resume_debugger(); break; case REQ_STOP: stop_debugging(); break; case REQ_STEP_INTO: { if (dbg_req-&gt;dbg_paused) { dbg_trace = 1; dbg_req-&gt;dbg_paused = 0; } } break; case REQ_STEP_OVER: { if (dbg_req-&gt;dbg_paused) { unsigned int dest_pc = calc_step_over(); if (dest_pc != (unsigned int)(-1)) { dbg_step_over = 1; dbg_step_over_addr = dest_pc; } else { dbg_step_over = 0; dbg_step_over_addr = 0; dbg_trace = 1; } dbg_req-&gt;dbg_paused = 0; } } break; default: break; } dbg_req-&gt;req_type = REQ_NO_REQUEST; } void send_dbg_event(dbg_event_type_t type) { dbg_req-&gt;dbg_events[dbg_req-&gt;dbg_events_count].type = type; dbg_req-&gt;dbg_events_count += 1; } void stop_debugging() { send_dbg_event(DBG_EVT_STOPPED); detach_debugger(); deactivate_debugger(); dbg_first_paused = dbg_req-&gt;dbg_paused = dbg_trace = dbg_dont_check_bp = dbg_step_over = dbg_step_over_addr = dbg_last_pc = 0; } void start_debugging() { if (dbg_req != NULL &amp;&amp; dbg_req-&gt;dbg_active) return; activate_debugger(); init_bpt_list(); dbg_first_paused = dbg_req-&gt;dbg_paused = dbg_trace = dbg_dont_check_bp = dbg_step_over = dbg_step_over_addr = dbg_last_pc = 0; } int is_debugger_accessible() { return (dbg_req != NULL); } void process_breakpoints() { int handled_event = 0; int is_step_over = 0; int is_step_in = 0; unsigned int pc = m68k_get_reg(M68K_REG_PC); if (!dbg_req || !dbg_req-&gt;dbg_active) return; if (dbg_req-&gt;dbg_paused &amp;&amp; dbg_first_paused &amp;&amp; !dbg_trace) longjmp(jmp_env, 1); if (!dbg_first_paused) { dbg_first_paused = 1; dbg_req-&gt;dbg_paused = 1; dbg_req-&gt;dbg_events[dbg_req-&gt;dbg_events_count].pc = pc; strncpy(dbg_req-&gt;dbg_events[dbg_req-&gt;dbg_events_count].msg, "gpgx", sizeof(dbg_req-&gt;dbg_events[dbg_req-&gt;dbg_events_count].msg)); send_dbg_event(DBG_EVT_STARTED); } if (dbg_trace) { is_step_in = 1; dbg_trace = 0; dbg_req-&gt;dbg_paused = 1; dbg_req-&gt;dbg_events[dbg_req-&gt;dbg_events_count].pc = pc; send_dbg_event(DBG_EVT_STEP); handled_event = 1; } if (!dbg_req-&gt;dbg_paused) { if (dbg_step_over &amp;&amp; pc == dbg_step_over_addr) { is_step_over = 1; dbg_step_over = 0; dbg_step_over_addr = 0; dbg_req-&gt;dbg_paused = 1; } if (dbg_last_pc != pc) check_breakpoint(BPT_M68K_E, 1, pc, pc); if (dbg_req-&gt;dbg_paused) { dbg_req-&gt;dbg_events[dbg_req-&gt;dbg_events_count].pc = pc; send_dbg_event(is_step_over ? DBG_EVT_STEP : DBG_EVT_BREAK); handled_event = 1; } } if (dbg_first_paused &amp;&amp; (!handled_event) &amp;&amp; dbg_req-&gt;dbg_paused) { dbg_req-&gt;dbg_events[dbg_req-&gt;dbg_events_count].pc = pc; send_dbg_event(DBG_EVT_PAUSED); } dbg_last_pc = pc; if (dbg_req-&gt;dbg_paused &amp;&amp; (!is_step_in || is_step_over)) { longjmp(jmp_env, 1); } } int is_debugger_paused() { return is_debugger_accessible() &amp;&amp; dbg_req-&gt;dbg_paused &amp;&amp; dbg_first_paused &amp;&amp; !dbg_trace; }</span></span></span></span></code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">  debug.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _DEBUG_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _DEBUG_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;setjmp.h&gt; #include "debug_wrap.h" extern void start_debugging(); extern void stop_debugging(); extern int is_debugger_accessible(); extern void process_request(); extern int is_debugger_paused(); extern int activate_shared_mem(); extern void deactivate_shared_mem(); void check_breakpoint(bpt_type_t type, int width, unsigned int address, unsigned int value); extern jmp_buf jmp_env; #ifdef __cplusplus } #endif #endif</span></span></span></span></code> </pre> </div></div><br><p>              . <br> ,    <code>check_breakpoint</code>  <code>VDP</code>       <code>#ifdef LOGVDP</code> .       <code>vdp_ctrl.c</code> : </p><br><pre> <code class="cpp hljs">check_breakpoint(BPT_VRAM_W, <span class="hljs-number"><span class="hljs-number">2</span></span>, addr, data); ... check_breakpoint(BPT_CRAM_W, <span class="hljs-number"><span class="hljs-number">2</span></span>, addr, data); ... check_breakpoint(BPT_VSRAM_W, <span class="hljs-number"><span class="hljs-number">2</span></span>, addr, data); ... check_breakpoint(BPT_VRAM_R, <span class="hljs-number"><span class="hljs-number">2</span></span>, addr, data); ... check_breakpoint(BPT_CRAM_R, <span class="hljs-number"><span class="hljs-number">2</span></span>, addr, data); ... check_breakpoint(BPT_VSRAM_R, <span class="hljs-number"><span class="hljs-number">2</span></span>, addr, data);</code> </pre> <br><p>  <code>RAM</code>     ( <code>m68kcpu.h</code> ): </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// m68ki_read_8 check_breakpoint(BPT_M68K_R, 1, address, val); // m68ki_read_16 check_breakpoint(BPT_M68K_R, 2, address, val); // m68ki_read_32 check_breakpoint(BPT_M68K_R, 4, address, val); // m68ki_write_8 check_breakpoint(BPT_M68K_W, 1, address, val); // m68ki_write_16 check_breakpoint(BPT_M68K_W, 2, address, val); // m68ki_write_32 check_breakpoint(BPT_M68K_W, 4, address, val);</span></span></code> </pre> <br><p>      ,      ,      . </p><br><div class="spoiler"> <b class="spoiler_title">  debug_wrap.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Windows.h&gt; #include &lt;process.h&gt; #include "debug_wrap.h" static HANDLE hMapFile = NULL, hStartFunc = NULL; dbg_request_t *open_shared_mem() { hMapFile = OpenFileMapping(FILE_MAP_ALL_ACCESS, FALSE, SHARED_MEM_NAME); if (hMapFile == NULL) { return NULL; } dbg_request_t *request = (dbg_request_t *)MapViewOfFile(hMapFile, FILE_MAP_ALL_ACCESS, 0, 0, sizeof(dbg_request_t)); if (request == NULL) { CloseHandle(hMapFile); return NULL; } return request; } void close_shared_mem(dbg_request_t **request) { UnmapViewOfFile(*request); CloseHandle(hMapFile); hMapFile = NULL; *request = NULL; } int recv_dbg_event(dbg_request_t *request, int wait) { while (request-&gt;dbg_active || request-&gt;dbg_events_count) { for (int i = 0; i &lt; MAX_DBG_EVENTS; ++i) { if (request-&gt;dbg_events[i].type != DBG_EVT_NO_EVENT) { request-&gt;dbg_events_count -= 1; return i; } } if (!wait) return -1; Sleep(10); } return -1; } void send_dbg_request(dbg_request_t *request, request_type_t type) { if (!request) return; request-&gt;req_type = type; while (request-&gt;dbg_active &amp;&amp; request-&gt;req_type != REQ_NO_REQUEST) { Sleep(10); } }</span></span></span></span></code> </pre> </div></div><br><p>       .   ,  . ,         , ,      . </p><br><h3 id="yadro-otladchika-zapusk">  :  </h3><br><p>          <code>Genesis Plus GX</code> : </p><br><pre> <code class="cpp hljs"> var.key = <span class="hljs-string"><span class="hljs-string">"genesis_plus_gx_debugger"</span></span>; environ_cb(RETRO_ENVIRONMENT_GET_VARIABLE, &amp;var); { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var.value || !<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(var.value, <span class="hljs-string"><span class="hljs-string">"disabled"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_debugger_accessible()) { stop_debugging(); stop_gui(); deactivate_shared_mem(); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { activate_shared_mem(); start_debugging(); run_gui(); } } ... { <span class="hljs-string"><span class="hljs-string">"genesis_plus_gx_debugger"</span></span>, <span class="hljs-string"><span class="hljs-string">"Debugger; disabled|enabled"</span></span> },</code> </pre> <br><p>    <code>RetroArch</code> : <br>   ,      <code>retro_run()</code> .      (      ),    . ,      <code>retro_run()</code> ,  <code>RetroArch</code>  .      <code>setjmp()</code> / <code>longjmp()</code> .  ,        <code>retro_run()</code> : </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_debugger_paused()) { longjmp(jmp_env, <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> is_paused = setjmp(jmp_env); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_paused) { process_request(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br><p>      <code>retro_run()</code>      <code>process_request()</code> ,      ,    . </p><br><h3 id="ps-zatravka-dlya-vtoroy-chasti"> PS     </h3><br><p><img src="https://habrastorage.org/webt/uc/ln/ec/uclnecmakoun2veml3ooxfvaete.png"></p><br><p> <strong>Update</strong> : <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">  </a>      -  <code>IDA Pro</code> ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi434992/">https://habr.com/ru/post/hi434992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi434976/index.html">рдЖрдИрдЯреАрдПрдордУ рдпреВрдирд┐рд╡рд░реНрд╕рд┐рдЯреА рдлреИрдмрд▓реИрдм: рд░рдЪрдирд╛рддреНрдордХ рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП DIY-рд╕рд╣рдХрд░реНрдорд┐рдпреЛрдВ - рд╢реЛ рдХреЗ рдЕрдВрджрд░ рдХреНрдпрд╛ рд╣реИ</a></li>
<li><a href="../hi434978/index.html">рдкреЗрд╢ рд╣реИ HealthKit</a></li>
<li><a href="../hi434982/index.html">рдкрд░рд┐рдкреНрд░реЗрдХреНрд╖реНрдп: рдорд▓реНрдЯреАрдХреЗрд▓реЗрдЯ рдПрд╕ 1</a></li>
<li><a href="../hi434984/index.html">рдореБрдЭреЗ рдПрд▓реЛрдХреНрд╡реЗрдВрдЯ рдУрдЖрд░рдПрдо рд╕реЗ рдирдлрд░рдд рдХреНрдпреЛрдВ рд╣реИ</a></li>
<li><a href="../hi434986/index.html">рдорд╛рдирдХ C ++ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреА рдореВрд▓ рдЕрд╡рдзрд╛рд░рдгрд╛рдПрдВ</a></li>
<li><a href="../hi434994/index.html">рдПрдВрдбреНрд░реЙрдЗрдб: рдбрд╛рдпрдирд╛рдорд┐рдХ рдкреНрд░реЛрдбрдХреНрдЯ рдлреНрд▓реЗрд╡рд░ рдФрд░ рд╕рд╛рдЗрдирд┐рдВрдЧ рдХрдиреНрдлрд┐рдЧреНрд╕</a></li>
<li><a href="../hi434996/index.html">рдореИрдВрдиреЗ рд╡реАрдХреЗ рдПрдкреАрдЖрдИ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реНрдерд╛рди рдХреИрд╕реЗ рд╕рд╛рдЭрд╛ рдХрд┐рдпрд╛</a></li>
<li><a href="../hi434998/index.html">рд╕реНрдорд╛рд░реНрдЯрдлреЛрди рдЪреБрдирдиреЗ рдХреЗ рддрд░реАрдХреЗ рдкрд░ рдПрдХ рдФрд░ рд▓реЗрдЦ</a></li>
<li><a href="../hi435000/index.html">рд╡рд┐рдЬреНрдЮрд╛рдкрди рдЪреИрдирд▓реЛрдВ рдХреА рдмрд╛рддрдЪреАрдд рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛ рдФрд░ рдЗрд╕рдХреЗ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ</a></li>
<li><a href="../hi435002/index.html">рдЕрдкрдЧреНрд░реЗрдбрд┐рдВрдЧ рдЖрдИрдбреАрдП рдкреНрд░реЛред рд╕реЗрдЧрд╛ рдореЗрдЧрд╛ рдбреНрд░рд╛рдЗрд╡ рдХреЗ рд▓рд┐рдП рдбрд┐рдмрдЧрд░ (рднрд╛рдЧ 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>