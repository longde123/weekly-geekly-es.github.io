<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèª üëêüèº üêß Bot por honorarios. Ir al f√∫tbol con nuevas tecnolog√≠as. üõ•Ô∏è üèº üöµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 


 Hola a todos En este art√≠culo describir√© mi chatbot para el servicio de mensajer√≠a de telegramas y la red social VK usando NodeJS. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot por honorarios. Ir al f√∫tbol con nuevas tecnolog√≠as.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483194/"><h2 id="vvedenie">  Introduccion </h2><br><p>  Hola a todos  En este art√≠culo describir√© mi chatbot para el servicio de mensajer√≠a de telegramas y la red social VK usando NodeJS. </p><br><p>  En este punto, muchos lectores deber√≠an decir algo como: "¬°Cu√°nto tiempo!"  o "¬øQu√© otra vez?" <br>  S√≠, publicaciones similares ya estaban en un habr incluido.  Pero, sin embargo, creo que el art√≠culo ser√° √∫til.  Brevemente sobre lo que representa la implementaci√≥n t√©cnica del bot: </p><br><ol><li>  Como marco para la aplicaci√≥n, el marco <a href="https://nestjs.com/">NestJS</a> est√° ganando popularidad. </li><li>  La biblioteca de <a href="https://www.npmjs.com/package/telegraf">telegraf</a> para interactuar con la API de Telegram. </li><li>  La biblioteca <a href="https://www.npmjs.com/package/node-vk-bot-api">node-vk-bot-api</a> para interactuar con la API de VK. </li><li>  Biblioteca <a href="https://www.npmjs.com/package/typeorm">Typeorm</a> para organizar la capa de almacenamiento de datos. </li><li>  Pruebas con <a href="https://www.npmjs.com/package/mocha">mocha</a> y la biblioteca de afirmaci√≥n chai. </li><li>  CI utilizando Travis CI para pruebas y acciones de GitHub para desplegar im√°genes acoplables. </li></ol><br><p>  Como trabajo adicional, tratemos de hacer que nuestros bots sean amigos de Viber, haci√©ndolo tan universal para su uso en varios servicios de mensajer√≠a. </p><br><p>  Para aquellos que quieran saber de qu√© se trata, bienvenidos a cat. </p><a name="habracut"></a><br><h2 id="postanovka-zadachi">  Declaraci√≥n del problema. </h2><br><p>  Como actividad f√≠sica √∫til, prefiero el f√∫tbol.  En un nivel aficionado, por supuesto.  Como miembro de varios canales y chats en vk, viber y telegram, a menudo tiene que ver la siguiente imagen: </p><br><p><img src="https://habrastorage.org/webt/jt/c7/h8/jtc7h8oxebenbzwymug3y2oi0oo.png" alt="imagen"></p><br><p>  Lo que vemos aqu√≠: </p><br><ol><li>  "P" se agreg√≥ a s√≠ mismo. </li><li>  Despu√©s de √©l, se agregaron 3 personas m√°s, entre las cuales hab√≠a una cierta "C". </li><li>  "P" agreg√≥ su compa√±ero llamado "Dimon". </li><li>  Despu√©s de eso, "P" no fue demasiado vago y calcul√≥ que en este momento ya hay hasta 5 personas. </li><li>  Sin embargo, esta informaci√≥n no fue relevante por mucho tiempo, ya que tambi√©n decid√≠ correr y agregarme. </li></ol><br><p>  En casos especialmente descuidados, las personas pueden poner un "+" y luego cancelar su participaci√≥n, invitar a amigos que no participan en el chat o suscribirse a otros participantes del chat y realizar otras actividades.  Al final, esto lleva al hecho de que cuando todos finalmente vienen a jugar, resulta que: </p><br><ol><li>  Vasya estableci√≥ +1 significando no solo a s√≠ mismo, sino tambi√©n a su amigo Gosh. </li><li>  Kolya escribi√≥ que vendr√≠a, pero el organizador Spiridon consider√≥ con sus ojos solo las ventajas. </li></ol><br><p>  Como resultado, posiblemente tengamos una cantidad desigual de equipos, "Gosh extra" y inesperadamente apareci√≥ Kolya. </p><br><p>  Para evitar tales colisiones, escrib√≠ un bot simple que ayuda a mostrar visualmente la composici√≥n de los participantes del pr√≥ximo juego y es conveniente agregarlo (s) / eliminarlo (s). </p><br><p>  Entonces, en mi implementaci√≥n b√°sica, en mi opini√≥n, el bot deber√≠a poder: </p><br><ol><li>  Estar incrustado en cualquier n√∫mero de chats.  Almacene su estado para cada chat por separado. </li><li>  <em>Usando el</em> comando <em>/ event_add,</em> cree un nuevo evento activo con cierta informaci√≥n y una lista vac√≠a de jugadores.  El evento activo anterior deber√≠a quedar inactivo. </li><li>  El <em>comando / event_remove</em> deber√≠a cancelar el evento actualmente activo. </li><li>  El comando <em>/ add</em> deber√≠a agregar un nuevo miembro al evento actualmente activo.  Adem√°s, si se llama al comando sin ning√∫n texto adicional, se debe agregar el que escribi√≥ el comando.  De lo contrario, se agrega una persona cuyo nombre se especifica cuando se llama al comando. </li><li>  El comando <em>/ remove</em> elimina a una persona de la lista de participantes de acuerdo con las reglas descritas para el comando <em>/ add</em> . </li><li>  El comando <em>/ info</em> te permite ver qui√©n ya se ha registrado en el juego. </li><li>  Es altamente deseable que el bot responda en el mismo idioma que el jugador configurado (o en ingl√©s de forma predeterminada). </li></ol><br><p>  Para ver r√°pidamente lo que sucedi√≥ al final, puede ir inmediatamente a la √∫ltima secci√≥n "Resultado y conclusiones".  Bueno, si est√° interesado en los detalles de implementaci√≥n, esta informaci√≥n se describe con suficiente detalle a continuaci√≥n. </p><br><h2 id="proektirovanie-i-razrabotka">  Dise√±o y desarrollo </h2><br><p>  Al dise√±ar la aplicaci√≥n, el siguiente esquema apareci√≥ en mi cabeza: </p><br><p><img src="https://habrastorage.org/webt/v7/j4/gz/v7j4gzjufgbeuayina59yy8blia.jpeg" alt="imagen"></p><br><p>  Aqu√≠, la idea principal era incorporar todos los detalles espec√≠ficos de trabajar con varios sistemas de mensajer√≠a en los adaptadores apropiados y encapsular la l√≥gica de interacci√≥n con las bibliotecas que implementan las API correspondientes, procesando y llevando los datos a una sola forma. </p><br><h3 id="interfeys-i-modeli-soobscheniy">  Modelos de interfaz y mensaje </h3><br><p>  Para los mensajes, fue posible dise√±ar la siguiente interfaz de <em>IMessage</em> , que satisface las clases que almacenan datos de mensajes entrantes para varios sistemas y m√©todos para trabajar con estos datos: </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { <span class="hljs-attr"><span class="hljs-attr">chatId</span></span>: number; lang: string; text: string; fullText: string; command: string; name: string; getReplyStatus: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> string; getReplyData: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> any; setStatus: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status: string</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; withData: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; answer: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>; }</code> </pre> <br><p>  La clase base <em>BaseMessage</em> que implementa esta interfaz tiene la siguiente forma: </p><br><div class="spoiler">  <b class="spoiler_title">Mensaje base</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ public chatId: number; public lang: string; public text: string; public fullText: string; public command: string; protected firstName: string; protected lastName: string; protected replyStatus: string; protected replyData: any; get name(): string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> firstName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lastName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${firstName}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lastName}</span></span></span><span class="hljs-string">`</span></span>.trim(); } public getReplyStatus(): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus; } public getReplyData(): any { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData; } public setStatus(status: string): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus = status; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public withData(data: any): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData = data; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } } }</code> </pre> </div></div><br><p>  Clase de mensaje para Telegram: </p><br><div class="spoiler">  <b class="spoiler_title">TelegramMessage</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.update; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = message.chat.id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = message.from.language_code; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.replyWithHTML(args); } }</code> </pre> </div></div><br><p>  y para VK: </p><br><div class="spoiler">  <b class="spoiler_title">VKMessage</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getChatId(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = <span class="hljs-string"><span class="hljs-string">'ru'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> answer: string = <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${args}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/&lt;\/?(strong|i)&gt;/gm</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.reply(answer); } private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; } }</code> </pre> </div></div><br><p>  A qu√© debe prestar atenci√≥n: </p><br><ol><li><p>  <em>chatId</em> es el identificador √∫nico para el chat.  Para Telegram, viene expl√≠citamente en la estructura de cada mensaje.  Sin embargo, en el caso de VK no existe dicho identificador expl√≠citamente.  Como ser  Para responder a esta pregunta, debe comprender c√≥mo funciona el bot dentro de VK.  En este sistema, un bot en correspondencia grupal act√∫a en nombre de la comunidad para la que comienza.  Es decir  cada mensaje bot contiene un identificador de comunidad <em>group_id</em> .  Adem√°s, <em>peer_id</em> viene en el mensaje (m√°s detalles se pueden leer <a href="">aqu√≠</a> ) como el identificador de la conversaci√≥n grupal en nuestro caso.  En base a estos dos identificadores, puede crear su identificador de chat, por ejemplo, de la siguiente manera: </p><br><pre> <code class="javascript hljs">private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; }</code> </pre> <br><p>  Este m√©todo ciertamente no es perfecto, pero es aplicable a la tarea actual. </p><br></li><li><p>  <em>texto</em> <em>completo</em> y <em>texto</em> .  Como lo indica el nombre de las variables, <em>fullText</em> contiene el texto completo del mensaje, mientras que el <em>texto</em> contiene solo la parte que viene despu√©s del nombre del comando. </p><br></li></ol><br><p>  Esto es conveniente porque le permite usar el campo de <em>texto</em> listo para analizar la informaci√≥n auxiliar contenida en √©l, como la fecha del evento o el nombre del jugador. </p><br><ol><li>  A diferencia de Telegram, los mensajes VK no admiten un conjunto de etiquetas para resaltar texto como <code>&lt;b&gt;</code> o <code>&lt;i&gt;</code> , por lo tanto, al responder, estas etiquetas deben eliminarse utilizando expresiones regulares. </li></ol><br><h3 id="adaptery-dlya-priema-i-otpravki-soobscheniy">  Adaptadores para recibir y enviar mensajes. </h3><br><p>  Despu√©s de crear la interfaz y las estructuras de datos para los mensajes de Telegram y VK, ha llegado el momento de implementar servicios para procesar eventos entrantes. </p><br><p><img src="https://habrastorage.org/webt/gz/-z/2y/gz-z2y0x-x9_78hjdhg2mul9byu.jpeg" alt="imagen"></p><br><p>  Estos servicios deben inicializar m√≥dulos de terceros para interactuar con las API de Telegram y VK y lanzar mecanismos de sondeo largos, as√≠ como tener una conexi√≥n entre los comandos entrantes y los eventos internos que ocurren en el sistema cuando se reciben datos de los servicios de mensajer√≠a. </p><br><div class="spoiler">  <b class="spoiler_title">TelegramService</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telegraf <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'telegraf'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SocksAgent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socks5-https-client/lib/Agent'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TelegramMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./telegram.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramService</span></span></span><span class="hljs-class"> </span></span>{ private bot: Telegraf&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_BOT_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_USE_PROXY'</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken, { <span class="hljs-attr"><span class="hljs-attr">telegram</span></span>: {<span class="hljs-attr"><span class="hljs-attr">agent</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getProxy(config)}, }) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(command, ctx =&gt; { ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.launch(); } private getProxy(config: ConfigService): SocksAgent { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SocksAgent({ <span class="hljs-attr"><span class="hljs-attr">socksHost</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_HOST'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPort</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PORT'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksUsername</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_LOGIN'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPassword</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PASSWORD'</span></span>), }); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">VKService</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VkBot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'node-vk-bot-api'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {VKMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./vk.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKService</span></span></span><span class="hljs-class"> </span></span>{ private bot: VkBot&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'VK_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VkBot(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, }); ctx.message.from = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>; ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VKMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.startPolling(); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><p>  A qu√© debe prestar atenci√≥n: </p><br><ol><li>  Debido a ciertos problemas con el acceso al servicio de Telegram (hola Roskomnadzor), fue necesario utilizar opcionalmente un proxy que proporciona el <a href="https-client">paquete socks5-https-client</a> . </li><li>  Al procesar un evento, se agrega un campo al contexto con el valor del comando con el texto del cual se recibi√≥ el mensaje. </li><li>  Para VK, debe descargar por separado los datos del usuario que envi√≥ el mensaje mediante una llamada API separada: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, });</code> </pre> </li></ol><br><h3 id="model-dannyh">  Modelo de datos </h3><br><p>  Para implementar la funcionalidad declarada del bot, tres modelos fueron suficientes: </p><br><ol><li>  <code>Chat</code> : chat o conversaci√≥n. </li><li>  <code>Event</code> : un evento para un chat programado para una fecha y hora espec√≠ficas. </li><li>  <code>Player</code> : participante o jugador que participa en el evento. </li></ol><br><p><img src="https://habrastorage.org/webt/yj/dc/rw/yjdcrwzw4bsie2im9fuelyb590k.jpeg" alt="Esquema de datos"></p><br><p>  Las implementaciones de modelos que usan la biblioteca <a href="https://www.npmjs.com/package/typeorm">typeorm</a> son: </p><br><div class="spoiler">  <b class="spoiler_title">Chatear</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, JoinColumn, Index, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chat</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Index({<span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) @Column() chatId: number; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.chat) @JoinColumn() events: Event[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">El evento</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() date: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>; @Column() active: boolean; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Chat, chat =&gt; chat.events) chat: Chat; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Player, player =&gt; player.event) @JoinColumn() players: Player[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Jugador</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() name: string; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.players) @JoinColumn() event: Event; }</code> </pre> </div></div><br><p>  Aqu√≠ es necesario discutir una vez m√°s el mecanismo del bot para varios equipos en t√©rminos de manipulaci√≥n de modelos de <em>Chat</em> , <em>Evento</em> y <em>Jugador</em> . </p><br><ol><li>  Al recibir cualquier comando, se verifica la existencia de un chat en el DB con <code>chatId</code> .  Si no hay un registro correspondiente, se crea. </li><li>  Para simplificar la l√≥gica, cada chat solo puede tener un evento activo ( <em>Evento</em> ).  Es decir  Al recibir el <code>/event_add</code> , se crea un nuevo evento activo en el sistema con la fecha especificada. <br>  El evento activo actual (si existe) se vuelve inactivo. </li><li>  <code>/event_remove</code> encuentra el evento activo en el chat actual y lo desactiva. </li><li>  <code>/info</code> encuentra un evento activo en el chat actual, muestra informaci√≥n sobre este evento y una lista de jugadores ( <em>Player</em> ). </li><li>  <code>/add</code> and <code>/remove</code> funciona con el evento activo agregando y eliminando jugadores. </li></ol><br><p>  El servicio correspondiente para trabajar con datos es el siguiente: </p><br><div class="spoiler">  <b class="spoiler_title">Servicio de almacenamiento</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {InjectConnection} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Connection, Repository, UpdateResult} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/player'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StorageService</span></span></span><span class="hljs-class"> </span></span>{ private chatRepository: Repository&lt;Chat&gt;; private eventRepository: Repository&lt;Event&gt;; private playerRepository: Repository&lt;Player&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(@InjectConnection() private readonly dbConnection: Connection) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Chat); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Event); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Player); } public get connection() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ensureChat(chatId: number): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Chat&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.findOne({chatId}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chat) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chat; } chat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Chat(); chat.chatId = chatId; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.save(chat); } public markChatEventsInactive(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;UpdateResult&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection .createQueryBuilder() .update(Event) .set({<span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) .where({chat}) .execute(); } public appendChatActiveEvent(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">date</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(); event.chat = chat; event.active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; event.date = date; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.save(event); } public findChatActiveEvent(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {chat, <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}}); } public getPlayers(event: Event): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player[]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.find({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event}}); } public findPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event, name}}); } public addPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> player: Player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Player(); player.event = event; player.name = name; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.save(player); } public removePlayer(player: Player): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.remove(player); } }</code> </pre> </div></div><br><h3 id="shablonizaciya-otvetov">  Respuesta de plantilla </h3><br><p>  Adem√°s del servicio <em>StorageService</em> descrito para trabajar con datos, tambi√©n era necesario implementar un servicio <em>TemplateService</em> dedicado cuyas tareas en este momento son: </p><br><ol><li>  Descargue y compile plantillas de <a href="https://handlebarsjs.com/">manillar</a> para opciones de respuesta para varios comandos en diferentes idiomas. </li><li>  Seleccionar una plantilla adecuada seg√∫n el evento actual, el estado de respuesta y el idioma del usuario. </li><li>  Llenar la plantilla con datos obtenidos como resultado del comando. </li></ol><br><div class="spoiler">  <b class="spoiler_title">TemplateService</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'fs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> handlebars <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'handlebars'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {readDirDeepSync} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'read-dir-deep'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IParams { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string; status: string; lang?: string; } @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemplateService</span></span></span><span class="hljs-class"> </span></span>{ private readonly DEFAULT_LANG: string = <span class="hljs-string"><span class="hljs-string">'en'</span></span>; private readonly TEMPLATE_PATH: string = <span class="hljs-string"><span class="hljs-string">'templates'</span></span>; private logger: Logger; private templatesMap: <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;string, (d: any) =&gt; string&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(logger: Logger) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load(); } public apply(params: IParams, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: any): string { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log( <span class="hljs-string"><span class="hljs-string">`apply template: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.action}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.status}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.lang}</span></span></span><span class="hljs-string">`</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { params.lang = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DEFAULT_LANG; template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'template-not-found'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template(data); } private getTemplate(params: IParams): <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {lang, action, status} = params; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status)); } private load() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templatesDir: string = path.join( process.cwd(), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TEMPLATE_PATH, ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templateFileNames: string[] = readDirDeepSync(templatesDir); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap = templateFileNames.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">acc, fileName</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> template = fs.readFileSync(fileName, {<span class="hljs-attr"><span class="hljs-attr">encoding</span></span>: <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, lang, action, status] = fileName .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\.hbs$/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) .split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.set( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status), handlebars.compile(template), ); }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); } private getTemplateKey( lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string, ): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; } }</code> </pre> </div></div><br><p>  A qu√© debe prestar atenci√≥n: </p><br><ol><li><p>  Los archivos de plantilla est√°n en un directorio <code>./templates</code> separado en la ra√≠z del proyecto y est√°n estructurados por lenguaje, acci√≥n (comando) y estado de respuesta. </p><br><pre> <code class="plaintext hljs">- templates - en - event_add - invalid_date.hbs - success.hbs - event_info - ru</code> </pre> <br><p>  Cuando se inicializa la aplicaci√≥n, todas las plantillas de respuesta se cargan en la memoria y pueblan un mapa con claves que identifican de forma √∫nica la plantilla: </p><br><pre> <code class="javascript hljs">private getTemplateKey(lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; }</code> </pre> <br></li><li><p>  Actualmente, el sistema tiene 2 conjuntos de plantillas: para ruso e ingl√©s. <br>  El respaldo se proporciona en el idioma predeterminado (ingl√©s) en ausencia de la plantilla necesaria para el idioma del evento actual. </p><br></li><li><p>  Plantillas de <a href="https://handlebarsjs.com/">manillar en</a> s√≠, por ejemplo: </p><br><pre> <code class="plaintext hljs">Player &lt;strong&gt;{{name}}&lt;/strong&gt; will take part in the game List of players: {{#each players}} {{index}}: &lt;i&gt;{{name}}&lt;/i&gt; {{/each}} Total: &lt;strong&gt;{{total}}&lt;/strong&gt;</code> </pre> <br><p>  contienen marcadores de posici√≥n tradicionales y un <a href="https://tlgrm.ru/docs/bots/api">conjunto de etiquetas v√°lidas</a> para formatear respuestas en Telegram. </p><br></li></ol><br><h3 id="servisy-obrabotki-komand-actions">  Servicios de procesamiento de comandos (acciones) </h3><br><p>  Ahora que se describen los servicios de soporte b√°sicos, es hora de pasar a implementar la l√≥gica comercial del bot.  Esquem√°ticamente, la conexi√≥n entre los m√≥dulos se presenta aqu√≠: </p><br><p><img src="https://habrastorage.org/webt/b3/xl/vl/b3xlvlw5qc93vkc3n-nylnjwpqa.jpeg" alt="acciones"></p><br><p>  Las tareas de la clase base <em>BaseAction</em> incluyen: </p><br><ol><li>  Suscr√≠base a un evento espec√≠fico de <em>AppEmitter</em> . </li><li>  La funcionalidad general del procesamiento de eventos, a saber: <br><ul><li>  buscando uno existente o creando un nuevo chat en el contexto del cual se procesar√° el equipo. </li><li>  Una llamada al m√©todo de plantilla <code>doAction</code> implementaci√≥n es individual para cada clase de <em>BaseAction</em> heredado. </li><li>  Aplicando plantillas a la respuesta de <code>doAction</code> resultante usando <em>TemplateService</em> . </li></ul></li></ol><br><div class="spoiler">  <b class="spoiler_title">Acci√≥n base</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected appEmitter: AppEmitter; protected config: ConfigService; protected logger: Logger; protected templateService: TemplateService; protected storageService: StorageService; protected event: string; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.config = config; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter = appEmitter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService = templateService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setEvent(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`subscribe on "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.on(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleEvent.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } private <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handleEvent(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event received`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chatId: number = message.chatId; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.ensureChat(chatId); message = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doAction(chat, message); message.answer( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService.apply( { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: message.getReplyStatus(), <span class="hljs-attr"><span class="hljs-attr">lang</span></span>: message.lang, }, message.getReplyData(), ), ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.error(error); message.answer(error.message); } } }</code> </pre> </div></div><br><p>  La tarea de las clases secundarias <em>BaseAction</em> es ejecutar el m√©todo <code>doAction</code> de la entrada: </p><br><ol><li>  <em>Chat</em> creado o definido en la clase base </li><li>  Un objeto que cumple con el protocolo <em>IMessage</em> . </li></ol><br><p>  Como resultado de ejecutar este m√©todo, tambi√©n se devuelve <em>IMessage</em> , pero con el estado establecido para elegir la plantilla correcta y los datos que participar√°n en la plantilla de respuesta. </p><br><div class="spoiler">  <b class="spoiler_title">EventAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {parseEventDate, formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eventDate: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> = parseEventDate(message.text.trim()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!eventDate) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_INVALID_DATE); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.appendChatActiveEvent( chat, eventDate, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(event.date), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventInfoAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventInfoAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_INFO; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers( activeEvent, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_ALREADY_ADDED) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.addPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: newPlayer.name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_NO_PLAYER) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.removePlayer(existedPlayer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><p>  A qu√© debe prestar atenci√≥n: </p><br><ol><li>  Los comandos <code>/add</code> y <code>/remove</code> agregan / eliminan el jugador cuyo nombre viene despu√©s del comando.  Si no se especifica el nombre, el jugador que llam√≥ al equipo es agregado / eliminado. </li><li>  En respuesta a los comandos <code>/add</code> , <code>/remove</code> y <code>/info</code> , se muestra una lista actualizada de jugadores para el evento activo. </li></ol><br><p>  La funcionalidad requerida para implementar (1) y (2) se movi√≥ a una clase auxiliar especial: </p><br><div class="spoiler">  <b class="spoiler_title">PlayerHelper</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerHelper</span></span></span><span class="hljs-class"> </span></span>{ protected storageService: StorageService; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(storageService: StorageService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; } public getPlayerName(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name = message.text.trim(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? name : message.name; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> getPlayersList(event: Event) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers(event); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">total</span></span>: players.length, <span class="hljs-attr"><span class="hljs-attr">players</span></span>: players.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">player, index</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">index</span></span>: index + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: player.name, })), }; } }</code> </pre></div></div><br><h3 id="sobiraem-vse-vmeste">  Poniendo todo junto </h3><br><p>  Como se mencion√≥ al principio del art√≠culo, el marco <a href="https://nestjs.com/">NestJS</a> se usa como marco de la aplicaci√≥n.  En un momento, tuve la suerte de asistir personalmente al <a href="https://www.youtube.com/watch%3Fv%3Djo-1EUxMmxc">informe</a> del creador de esta maravillosa biblioteca. </p><br><p>  Muchas repeticiones, manuales y bibliotecas de NodeJS a menudo pecan al no ofrecer estrategias de inicializaci√≥n sensatas y conexiones entre m√≥dulos.  Con el crecimiento de la aplicaci√≥n, en ausencia de la atenci√≥n adecuada, la base del c√≥digo se convierte en una mezcla de requisitos entre los m√≥dulos, lo que a menudo conduce a dependencias o relaciones c√≠clicas donde, en principio, no deber√≠an existir.        Dependency Injection   <a href="https://www.npmjs.com/package/awilix">awilix</a> ,  <a href="https://nestjs.com/">NestJS</a>  . </p><br><p>   DI      ,    NodeJS ,            ,        . </p><br><p><img src="https://habrastorage.org/webt/l2/gq/lc/l2gqlc0vig_zsywifjjopmt_4wc.jpeg" alt="  "></p><br><h2 id="konfiguraciya">  Configuracion </h2><br><p>            . </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code> ‚Äî    Telegram . </li><li> <code>TELEGRAM_USE_PROXY</code> ‚Äî          TelegramAPI. </li><li> <code>TELEGRAM_PROXY_HOST</code> ‚Äî       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PORT</code> ‚Äî       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_LOGIN</code> ‚Äî       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PASSWORD</code> ‚Äî       TelegramAPI. </li><li> <code>VK_TOKEN</code> ‚Äî    VK . </li><li> <code>DATABASE_URL</code> ‚Äî    .   production . </li></ol><br><p>      : </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code>       <a href="https://tlgrm.ru/docs/bots"> </a>      Telegram. </li><li> <code>VK_TOKEN</code> ‚Äî    ,  VK    .  Es decir    ,             .       <a href="https://vk.com/dev/bots_docs">  </a>  . </li><li> <code>DATABASE_URL</code> ‚Äî  production      PostgreSQL.          DBaaS   <a href="https://www.elephantsql.com/">elephantsql</a>   . </li></ol><br><h2 id="ci"> CI </h2><br><p> " -   ‚Äî   ".    ,       <a href="https://travis-ci.org/">TravisCI</a>       : </p><br><pre> <code class="plaintext hljs">language: node_js node_js: - '8' - '10' - '12' script: - npm run lint - npm run build - npm run test:cov after_script: - npm install -g codecov - codecov</code> </pre> <br><p>                      <a href="https://codecov.io/">codecov</a> . </p><br><p>    <a href="https://www.docker.com/">Docker</a>      <a href="https://hub.docker.com/">Docker Hub</a>        <a href="https://habr.com/ru/users/Gonf/">Gonf</a>    <a href="https://habr.com/ru/post/476368/">  CI/CD   GitHub Actions  Python</a> .         Continuous Deployment,       Github: </p><br><pre> <code class="plaintext hljs">name: Release on: release: types: [published] jobs: build: runs-on: ubuntu-latest env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - uses: actions/checkout@v1 - name: Install Node.js uses: actions/setup-node@v1 - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - name: npm install and build run: npm ci &amp;&amp; npm run build - name: Build the Docker image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:10} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:10}</code> </pre> <br><h2 id="rezultat-i-vyvody">    </h2><br><p>     .  Telegram     : <br>        . </p><br><p><img src="https://habrastorage.org/webt/mi/tr/nb/mitrnbq3hcwu33lizpvmbxuirl0.png" alt="demo1"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/4v/y-/lk/4vy-lkg-dungqdpmbou0gop2w4e.png" alt="demo2"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/w8/i2/oo/w8i2oog_swdu2sjvqsqihwu8ww4.png" alt="demo3"></p><br><p>     VK      <code>&lt;b&gt;</code>  <code>&lt;i&gt;</code> . <br>        . </p><br><p><img src="https://habrastorage.org/webt/ak/cu/fo/akcufo-5cwygqzcdfysm-uytzdi.png" alt="demo4"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/pg/ye/c7/pgyec7wg7kgltgjk7ton5wc7w64.png" alt="demo6"></p><br><p>   <a href="https://www.viber.com/">Viber</a> ,              .         ,    <a href="https://www.viber.com/">Viber</a>   webhooks  long-polling.    ,    Viber         .       <a href="https://github.com/Viber/sample-bot-isitup/issues/2"></a> .          (?) . </p><br><p>  Telegram            <code>@Tormozz48bot</code> . </p><br><p>     <a href="https://github.com/tormozz48/football-chat-bot-2"> Github</a> .   ,   . </p><br><p> PS    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/483194/">https://habr.com/ru/post/483194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483178/index.html">Aqu√≠ hay una actualizaci√≥n sobre la versi√≥n Flutter 1.9 junto con la programaci√≥n Dart 2.5</a></li>
<li><a href="../483182/index.html">Cinco formas interesantes de usar Array.reduce () (y una forma aburrida)</a></li>
<li><a href="../483184/index.html">Actualizaci√≥n autom√°tica de c√≥digo a TensorFlow 2</a></li>
<li><a href="../483186/index.html">Presentamos Java 13: vamos a sumergirnos en las nuevas caracter√≠sticas de JDK</a></li>
<li><a href="../483190/index.html">Respuestas de soporte t√©cnico de 3CX: Actualice a 3CX v16 desde versiones anteriores</a></li>
<li><a href="../483198/index.html">C√≥mo Alibaba Cloud gestiona decenas de miles de grupos de Kubernetes con ... Kubernetes</a></li>
<li><a href="../483202/index.html">Introducci√≥n a la API REST - Servicios web RESTful</a></li>
<li><a href="../483204/index.html">Diferencias entre REST y SOAP</a></li>
<li><a href="../483206/index.html">Desarrollo de API REST: ¬øqu√© es el contrato primero?</a></li>
<li><a href="../483208/index.html">Revisi√≥n de Kaggle ML & DS Survey 2019. O cu√°nto ganan los especialistas en ML</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>