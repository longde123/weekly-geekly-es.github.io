<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>โ๏ธ ๐ช๏ธ ๐ฉ๐ฝโ๐คโ๐จ๐ผ EHCI ุฅูุณุงููุง ุจุงููุบุฉ ุงูุฑูุณูุฉ ๐ง๐ฝ ๐ค๐พ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ููุฏูุฉ 
 ุฃุฑุญุจ ุจุงูุฌููุน. ุงูููู ุฃุฑูุฏ ุฃู ุฃุดุงุฑู ุชุฌุฑุจุชู ููุง ุฒูุช ุ ูู ุฑุฃูู ุ ุฃุดุฑุญ ุจูุถูุญ ุนู ูุฐุง ุ ูููููุฉ ุงูุฃููู ุ ูุนูุงุฑูุง ุจุณูุทูุง ููุญุฏุฉ ุชุญูู ูุถูู USB 2.0. 

 ูู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>EHCI ุฅูุณุงููุง ุจุงููุบุฉ ุงูุฑูุณูุฉ</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426421/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/kk/0o/he/kk0ohepnkx9kfrbmht7mtec5pr4.jpeg" alt="ุงูุตูุฑุฉ"><br><br><h3 style=";text-align:right;direction:rtl">  <b>ููุฏูุฉ</b> </h3><br>  ุฃุฑุญุจ ุจุงูุฌููุน.  ุงูููู ุฃุฑูุฏ ุฃู ุฃุดุงุฑู ุชุฌุฑุจุชู ููุง ุฒูุช ุ ูู ุฑุฃูู ุ ุฃุดุฑุญ ุจูุถูุญ ุนู ูุฐุง ุ ูููููุฉ ุงูุฃููู ุ ูุนูุงุฑูุง ุจุณูุทูุง ููุญุฏุฉ ุชุญูู ูุถูู USB 2.0. <br><br>  ูู ุงูุจุฏุงูุฉ ุ ููููู ุฃู ุชุชุฎูู ุฃู ูููุฐ USB 2.0 ูู 4 ุฏุจุงุจูุณ ููุท ุ ุงุซูุงู ูููุง ููููุงู ุงูุจูุงูุงุช ุจุจุณุงุทุฉ (ูุซู ุ ุนูู ุณุจูู ุงููุซุงู ุ ูููุฐ COM) ุ ูููู ูู ุงููุงูุน ุ ูู ุดูุก ููุณ ูุฐูู ุ ูุญุชู ุงูุนูุณ ุชูุงููุง.  ูุง ุชุณูุญ ููุง ูุญุฏุฉ ุชุญูู USB ุ ูู ุญูุซ ุงููุจุฏุฃ ุ ุจููู ุงูุจูุงูุงุช ุนู ุทุฑูู ูููุฐ COM ุงูุนุงุฏู.  EHCI ูู ูุนูุงุฑ ูุนูุฏ ุฅูู ุญุฏ ูุง ูุณูุญ ุจููู ุจูุงูุงุช ููุซูู ูุณุฑูุน ูู ุงูุจุฑูุงูุฌ ุฅูู ุงูุฌูุงุฒ ููุณู ุ ููู ุงูุงุชุฌุงู ุงููุนุงูุณ. <br><br>  ูุฏ ุชุฌุฏ ูุฐู ุงูููุงูุฉ ูููุฏุฉ ุฅุฐุง ูู ุชูู ูุฏูู ุ ุนูู ุณุจูู ุงููุซุงู ุ ููุงุฑุงุช ูุชุงุจุฉ ูุงููุฉ ูุจุฑุงูุฌ ุงูุชุดุบูู ููุฑุงุกุฉ ูุซุงุฆู ุฃุญุฏ ุงูุฃุฌูุฒุฉ.  ูุซุงู ุจุณูุท: ุฃูุช ุชุฑูุฏ ูุชุงุจุฉ ูุธุงู ุงูุชุดุบูู ูุฌูุงุฒ ููุจููุชุฑ ุตุบูุฑ ุ ุจุญูุซ ูุง ุชููู ุจุนุถ ุฃูุธูุฉ ุชุดุบูู Windows ุฃู ุชูุฒูุนุงุช Linux ุงูุฃุฎุฑู ุจุชูุฒูู ุงูุญุฏูุฏ ุ ูุชุณุชุฎุฏู ูู ุทุงูุชูุง ุญุตุฑููุง ูุฃุบุฑุงุถู ุงูุฎุงุตุฉ. <br><a name="habracut"></a><br><h3 style=";text-align:right;direction:rtl">  <b>ูุง ูู EHCIุ</b> </h3><br>  ุญุณููุง ุ ููุจุฏุฃ.  EHCI - ูุงุฌูุฉ ุชุญูู ุงููุถูู ุงููุญุณูุฉ ุ ุชู ุชุตููููุง ูููู ุงูุจูุงูุงุช ูุงูุชุญูู ูู ุงูุทูุจุงุช ุฅูู ุฃุฌูุฒุฉ USB ุ ููู ุงูุงุชุฌุงู ุงูุขุฎุฑ ุ ููู 99ูช ูู ุงูุญุงูุงุช ุ ููุซู ุฑุงุจุทูุง ุจูู ุฃู ุจุฑูุงูุฌ ูุฌูุงุฒ ูุงุฏู.  ุชุนูู EHCI ูุฌูุงุฒ PCI ุ ูุจุงูุชุงูู ุชุณุชุฎุฏู MMIO (Memory-Mapped-IO) ููุชุญูู ูู ูุญุฏุฉ ุงูุชุญูู (ูุนู ุ ุฃุนุฑู ุฃู ุจุนุถ ุฃุฌูุฒุฉ PCI ุชุณุชุฎุฏู ุงูููุงูุฐ ุ ูููู ููุง ููุช ุจุชุนููู ูู ุดูุก).  ุชุตู ูุซุงุฆู ุฅูุชู ููุท ูุจุฏุฃ ุงูุชุดุบูู ุ ููุง ุชูุฌุฏ ุชูููุญุงุช ุนูู ุงูุฅุทูุงู ูู ุงูุฎูุงุฑุฒููุงุช ุงูููุชูุจุฉ ุนูู ุงูุฃูู ูู ุงูุฑูุฒ ุงูุฒุงุฆู.  ูุฏู EHCI ููุนุงู ูู ุณุฌูุงุช MMIO: ุงููุฏุฑุฉ ูุงูุชุดุบูู.  ูุนูู ุงูุฃูู ุนูู ุงูุญุตูู ุนูู ุฎุตุงุฆุต ุฌูุงุฒ ุงูุชุญูู ุ ุจูููุง ูุนูู ุงูุขุฎุฑ ุนูู ุงูุชุญูู ููู.  ูู ุงููุงูุน ุ ุณุฃุนูู ุฌููุฑ ุงูุงุชุตุงู ุจูู ุงูุจุฑูุงูุฌ ููุญุฏุฉ ุชุญูู EHCI: <br><br><img src="https://habrastorage.org/webt/rh/px/zr/rhpxzre1s167jv51xhcz_shffsu.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  ุชุญุชูู ูู ูุญุฏุฉ ุชุญูู EHCI ุนูู ุนุฏุฉ ููุงูุฐ ุ ูููู ุชูุตูู ูู ูููุง ุจุฃู ุฌูุงุฒ USB.  ููุฑุฌู ุฃูุถูุง ููุงุญุธุฉ ุฃู EHCI ูู ูุณุฎุฉ ูุญุณูุฉ ูู UHCI ุ ูุงูุชู ุชู ุชุทููุฑูุง ุฃูุถูุง ุจูุงุณุทุฉ Intel ูุจู ุจุถุน ุณููุงุช.  ููุชูุงูู ูุน ุงูุฅุตุฏุงุฑุงุช ุงูุณุงุจูุฉ ุ ุณุชููู ุฃู ูุญุฏุฉ ุชุญูู UHCI / OHCI ุชุญุชูู ุนูู ุฅุตุฏุงุฑ ุฃูู ูู EHCI ูุตุงุญุจุฉ ูู EHCI.  ุนูู ุณุจูู ุงููุซุงู ุ ูุฏูู ููุญุฉ ููุงุชูุญ USB (ููุนุธู ููุญุงุช ุงูููุงุชูุญ ููุฐุง ุงูุนุงู ุญุชู ุงูุขู ูุงูุช ูุฐูู) ุชุนูู ุนูู USB 1.1 (ูุงุญุธ ุฃู ุงูุณุฑุนุฉ ุงููุตูู ูู USB 1.1 ูู 12 ููุบุงุจุช ูู ุงูุซุงููุฉ ุ ู FullSpeed โโUSB 2.0 ูุฒูุฏ ุจูุทุงู ุชุฑุฏุฏู ุชุตู ุฅูู 480 ููุฌุง ุจุช ูู ุงูุซุงููุฉ) ุ ููุฏูู ุฌูุงุฒ ููุจููุชุฑ ูุฒูุฏ ุจูููุฐ USB 2.0 ุ ุนูุฏ ุชูุตูู ููุญุฉ ุงูููุงุชูุญ ุจุงูููุจููุชุฑ ุ ุณุชุนูู ูุญุฏุฉ ุชุญูู ูุถูู EHCI ุจุฃู ุดูู ูู ุงูุฃุดูุงู ูุน USB 1.1.  ูุธูุฑ ูุฐุง ุงููููุฐุฌ ูู ุงูุฑุณู ุงูุจูุงูู ุงูุชุงูู: <br><br><img src="https://habrastorage.org/webt/61/mg/lf/61mglfeajk5ivpcqmwjkazxniwy.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  ุฃูุถูุง ุ ูููุณุชูุจู ุ ุฃุฑูุฏ ุฃู ุฃุญุฐุฑู ุนูู ุงูููุฑ ูู ุฃู ุจุฑูุงูุฌ ุงูุชุดุบูู ุงูุฎุงุต ุจู ูุฏ ูุง ูุนูู ุจุดูู ุตุญูุญ ุจุณุจุจ ูุซู ูุฐุง ุงููููู ุงูุณุฎูู: ููุช ุจุชููุฆุฉ UHCI ุ ุซู EHCI ุ ุฃุซูุงุก ุฅุถุงูุฉ ุฌูุงุฒูู ูุชุทุงุจููู ุ ูู ุจุชุนููู ุจุช ุงูุชุญูู ูู ูุงูู ุงููููุฐ ุฅูู ุณุฌู ุงููููุฐ ุ ุซู ุชููู UHCI ุนู ุงูุนูู ุ ุจุณุจุจ ุญูููุฉ ุฃู EHCI ูุณุญุจ ุงููููุฐ ุชููุงุฆููุง ุฅูู ููุณู ุ ููุชููู ุงููููุฐ ุนูู UHCI ุนู ุงูุงุณุชุฌุงุจุฉ ุ ููุฌุจ ูุฑุงูุจุฉ ูุฐุง ุงููููู. <br><br>  ุฃูุถูุง ุ ุฏุนูุง ูููู ูุธุฑุฉ ุนูู ุฑุณู ุชุฎุทูุทู ููุถุญ ุจููุฉ EHCI ููุณูุง: <br><br><img src="https://habrastorage.org/webt/vq/t-/nt/vqt-ntbqnrcrz4k8he1uzngwyyo.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  ุนูู ุงููููู ููุชูุจ ุนู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ - ุนููู ุจุนุฏ ุฐูู ุจูููู. <br><br><h2 style=";text-align:right;direction:rtl">  ูุณุฌู ุฌูุงุฒ ุชุญูู EHCI </h2><br>  ุจุงุฏุฆ ุฐู ุจุฏุก ุ ุฃูุฏ ุฃู ุฃูุถุญ ูุฑุฉ ุฃุฎุฑู ุฃูู ูู ุฎูุงู ูุฐู ุงูุณุฌูุงุช ุณุชุชุญูู ูู ุฌูุงุฒู ุ ูุจุงูุชุงูู ููู ูููุฉ ุฌุฏูุง - ูุจุฏูููุง ุ ูุง ูููู ุจุฑูุฌุฉ EHCI. <br><br>  ุชุญุชุงุฌ ุฃููุงู ุฅูู ุงูุญุตูู ุนูู ุนููุงู MMIO ุงููุนุทู ููุญุฏุฉ ุงูุชุญูู ูุฐู ุ ุนูุฏ ุงูุฅุฒุงุญุฉ + 0x10 ุณูููู ุนููุงู ุณุฌูุงุชูุง ุงูุชู ุทุงู ุงูุชุธุงุฑูุง.  ููุงู ุดูุก ูุงุญุฏ: ุฃููุงู ุ ุชุฐูุจ ุณุฌูุงุช ุงููุฏุฑุฉ ุ ูุจุนุฏูุง ููุท - ุงูุชุดุบูู ุ ูุจุงูุชุงูู ุ ุนูุฏ ุงูุฅุฒุงุญุฉ 0 (ูู ุงูุนููุงู ุงูุณุงุจู ุงูุฐู ุชููููุงู ุนูุฏ ุงูุฅุฒุงุญุฉ 0x10 ุจุงููุณุจุฉ ุฅูู ุจุฏุงูุฉ MMIO ุงูุฎุงุต ุจู EHCI) ููุงู ุจุงูุช ูุงุญุฏ - ุทูู ุชุณุฌููุงุช ุงููุฏุฑุฉ. <br><br><h3 style=";text-align:right;direction:rtl">  <b>ุณุฌูุงุช ุงููุฏุฑุฉ</b> </h3><br>  ุนูุฏ ุงูุฅุฒุงุญุฉ 2 ุ <b>ููุฌุฏ</b> ุณุฌู <b>HCIVERSION</b> - ุฑูู ุงููุฑุงุฌุนุฉ ุงูุฎุงุต ุจู HC ูุฐุง ุ ูุงูุฐู ูุฃุฎุฐ 2 ุจุงูุช ููุญุชูู ุนูู ูุณุฎุฉ BCD ูู ุงููุฑุงุฌุนุฉ (ูุง ูููู ุงูุนุซูุฑ ุนููู BCD ุนูู ููููุจูุฏูุง). <br>  ุนูุฏ ุงูุฅุฒุงุญุฉ +4 ุ <b>ููุฌุฏ</b> ุณุฌู <b>HCSPARAMS</b> ุ ุญุฌูู ูู ูููุชุงู ุ ููุญุชูู ุนูู ุงููุนููุงุช ุงููููููุฉ ููุฌูุงุฒ <b>ูุชูุถุญ ุจุชุงุชู</b> ูุง ููู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Bit 16 - ูุคุดุฑุงุช ุงููููุฐ - ูุตุงุจูุญ LED ุงููุชููุฑุฉ ูุฃุฌูุฒุฉ USB ุงููุชุตูุฉ. </li><li style=";text-align:right;direction:rtl">  Bits 15:12 - ุฑูู ูุญุฏุฉ ุงูุชุญูู ุงููุตุงุญุจุฉ ุงููุนููุฉ ููุญุฏุฉ ุงูุชุญูู ูุฐู </li><li style=";text-align:right;direction:rtl">  Bits 11: 8 - ุนุฏุฏ ุงูููุงูุฐ ุนูู ูุญุฏุฉ ุงูุชุญูู ุงููุตุงุญุจุฉ </li><li style=";text-align:right;direction:rtl">  Bit 7 - ููุงุนุฏ ุชูุฌูู ุงููููุฐ - ููุถุญ ููููุฉ ุชุนููู ูุฐู ุงูููุงูุฐ ุฅูู ุงูููุงูุฐ ุงููุตุงุญุจุฉ </li><li style=";text-align:right;direction:rtl">  Bit 4 - ุงูุชุญูู ูู ุทุงูุฉ ุงููููุฐ - ูุดูุฑ ุฅูู ูุง ุฅุฐุง ูุงู ูู ุงูุถุฑูุฑู ุชุดุบูู ุงูุทุงูุฉ ููู ูููุฐ ุ 0 - ูุชู ุชูููุฑ ุงูุทุงูุฉ ุชููุงุฆููุง </li><li style=";text-align:right;direction:rtl">  Bits 3: 0 - ุนุฏุฏ ุงูููุงูุฐ ููุญุฏุฉ ุงูุชุญูู ูุฐู. </li><li style=";text-align:right;direction:rtl">  ุนูุฏ ุงูุฅุฒุงุญุฉ +8 ูููู ุณุฌู HCCPARAMS - ุฅูู ูุนุฑุถ ูุนููุงุช ุงูุชูุงูู ุ ุจุชุงุชู ุชุนูู ูุง ููู: </li><li style=";text-align:right;direction:rtl">  ุจุช 2 - ุชููุฑ ุทุงุจูุฑ ุบูุฑ ูุชุฒุงูู ุ </li><li style=";text-align:right;direction:rtl">  ุจุช 1 - ุชููุฑ ุทุงุจูุฑ ุฏูุฑู (ุชุณูุณูู) </li><li style=";text-align:right;direction:rtl">  ุจุช 0 - 64 ุจุช ุงูุชูุงูู </li></ul><br><h3 style=";text-align:right;direction:rtl">  <b>ุณุฌูุงุช ุงูุนูููุฉ</b> </h3><br>  ุนูุฏ ุงูุฅุฒุงุญุฉ 0 ุ ูููู ุณุฌู <b>USBCMD</b> ูู ุณุฌู ุฃูุงูุฑ ูุญุฏุฉ ุงูุชุญูู ุ ูุชุนูู <b>ุจุชุงุชู</b> ูุง ููู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Bits 23:16 - ุงูุชุญูู ูู ุนุชุจุฉ ุงูููุงุทุนุฉ - ููุถุญ ุนุฏุฏ ุงูุฅุทุงุฑุงุช ุงูุตุบูุฑุฉ ุงูุชู ุณูุชู ุงุณุชุฎุฏุงููุง ูุฅุทุงุฑ ุนุงุฏู ูุงุญุฏ.  ูููุง ูุงูุช ุฃูุจุฑ ุ ูุฃุณุฑุน ุ ูููู ุฅุฐุง ูุงู ุฃูุซุฑ ูู 8 ุ ูุณุชุชู ูุนุงูุฌุฉ ุงูุฅุทุงุฑุงุช ุงูุตุบูุฑุฉ ุจููุณ ุณุฑุนุฉ 8. </li><li style=";text-align:right;direction:rtl">  ุจุช 6 - ุงูููุงุทุนุฉ ุจุนุฏ ูู ูุนุงููุฉ ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุบูุฑ ุงููุชุฒุงููุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุจุช 5 - ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุบูุฑ ุงููุชุฒุงููุฉ ุงููุณุชุฎุฏูุฉ </li><li style=";text-align:right;direction:rtl">  Bit 4 - ุงุณุชุฎุฏุงู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุงูุชุณูุณููุฉ ุ </li><li style=";text-align:right;direction:rtl">  Bits 3: 2 - ุญุฌู FrameList'a (ุงููุฒูุฏ ุนู ุฐูู ูุงุญููุง).  0 ูุนูู 1024 ุนูุตุฑูุง ุ 1 - 512 ุ 2 - 256 ุ 3 - ูุญุฌูุฒ </li><li style=";text-align:right;direction:rtl">  Bit 1 - ุชุนููู ูุฅุนุงุฏุฉ ุชุนููู ูุญุฏุฉ ุชุญูู ุงููุถูู. </li><li style=";text-align:right;direction:rtl">  ุจุช 0 - ุชุดุบูู / ุฅููุงู </li></ul>  . <br>  ุจุนุฏ ุฐูู ุ ุนูุฏ ุงูุฅุฒุงุญุฉ +4 ุ ููุฌุฏ ุณุฌู <b>USBSTS</b> - ุญุงูุฉ ูุญุฏุฉ ุชุญูู ุงููุถูู ุ <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุดูุฑ ุงูุจุช 15 ุฅูู ูุง ุฅุฐุง ูุงู ูุชู ุงุณุชุฎุฏุงู ูุงุฆูุฉ ุงูุชุธุงุฑ ุบูุฑ ูุชุฒุงููุฉ. </li><li style=";text-align:right;direction:rtl">  ูุดูุฑ ุงูุจุช 14 ุฅูู ูุง ุฅุฐุง ูุงู ูุชู ุงุณุชุฎุฏุงู ูุงุฆูุฉ ุงูุชุธุงุฑ ุชุณูุณููุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุจุช 13 - ูุดูุฑ ุฅูู ุฃูู ุชู ุงููุดู ุนู ูุงุฆูุฉ ุงูุชุธุงุฑ ูุงุฑุบุฉ ุบูุฑ ูุชุฒุงููุฉ ุ </li><li style=";text-align:right;direction:rtl">  ูุชู ุชุนููู ุงูุจุช 12 ุฅูู 1 ุ ุฅุฐุง ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงููุนุงููุฉ ุ ูุณุชููู ูุญุฏุฉ ุงูุชุญูู ุงููุถููุฉ ุจุฅููุงู ุฌููุน ููุงุฆู ุงูุงูุชุธุงุฑ. </li><li style=";text-align:right;direction:rtl">  ูุชู ุชุนููู ุจุช 4 ุฅูู 1 ุ ุฅุฐุง ุญุฏุซ ุฎุทุฃ ูุงุฏุญ ุ ุชููู ูุญุฏุฉ ุชุญูู ุงููุถูู ุฌููุน ููุงุฆู ุงูุงูุชุธุงุฑ. </li><li style=";text-align:right;direction:rtl">  Bit 3 FrameList (Register) Rollover - ูุชู ุถุจุทู ุนูู 1 ุนูุฏูุง ุชููู ูุญุฏุฉ ุชุญูู ุงููุถูู ุจูุนุงูุฌุฉ ูุงุฆูุฉ ุงูุฅุทุงุฑุงุช ุจุฃููููุง. </li><li style=";text-align:right;direction:rtl">  ุจุช 1 - ููุงุทุนุฉ ุฎุทุฃ USB - ูู ุฃููู ุจุฅูุดุงุก ููุงุทุนุฉ ุฎุทุฃุ </li><li style=";text-align:right;direction:rtl">  ุจุช 0 - ููุงุทุนุฉ USB - ูุชู ุชุนูููู ุจุนุฏ ูุนุงูุฌุฉ ุงููุนุงููุงุช ุงููุงุฌุญุฉ ุ ุฅุฐุง ุชู ุชุซุจูุช ุจุทุงูุฉ IOC ูู TD </li></ul><br>  ูุง ุชุนุจุ  ููููู ุตุจ ุทููุฑ ุงูููุฑุณ ุงููููุฉ ูุฅุญุถุงุฑ ุงููุจุฏ ุ ูุญู ูู ุงูุจุฏุงูุฉ! <br><br>  ุนูุฏ ุงูุฅุฒุงุญุฉ +8 ุ ููุฌุฏ ุชุณุฌูู <b>USBINTR</b> - ุณุฌู ุชูููู ุงูููุงุทุนุฉ <br>  ููู ูุง ุชูุชุจ ููุชุฑุฉ ุทูููุฉ ุ ูุงูุฃูุซุฑ ูู ุฐูู ุ ุญุชู ูุง ุชูุฑุฃ ููุชุฑุฉ ุทูููุฉ ุ ูููู ุงูุนุซูุฑ ุนูู ููู ุจุชุงุช ูุฐุง ุงูุณุฌู ูู ุงูููุงุตูุงุช ุ ูุณูุชู ุชุฑู ุฑุงุจุท ููุง ุฃุฏูุงู.  ููุง ููุท ุฃูุชุจ 0 ุ ูุฃู  ููุณ ูุฏู ุฃู ุฑุบุจุฉ ุนูู ุงูุฅุทูุงู ูู ูุชุงุจุฉ ูุนุงูุฌุงุช ุ ูููุงุทุนุงุช ุงูุฎุฑูุทุฉ ุ ููุง ุฅูู ุฐูู ุ ูุฐูู ุฃุนุชูุฏ ุฃู ูุฐุง ูุง ูุนูู ูู ุนูู ุงูุฅุทูุงู. <br><br>  ุนูุฏ ุงูุฅุฒุงุญุฉ +12 (0x0C) ุ <b>ููุฌุฏ</b> ุณุฌู <b>FRINDEX</b> ุ ุญูุซ ูููู ุฑูู ุงูุฅุทุงุฑ ุงูุญุงูู ุจุจุณุงุทุฉ ุ ูุฃุฑูุฏ ุฃู ุฃุดูุฑ ุฅูู ุฃู ุงูุจุชุงุช ุงูุฃุฑุจุนุฉ ุงูุฃุฎูุฑุฉ ุชุธูุฑ ุฑูู ุงูุฅุทุงุฑ ุงูุตุบูุฑ ุ ูู 28 ุจุช ุงูุนููู ุฑูู ุงูุฅุทุงุฑ (ุงููููุฉ ููุณุช ุจุงูุถุฑูุฑุฉ ุฃุตุบุฑ ูู ุญุฌู frameList ูููู ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ููุฑุณ ุ ููู ุงูุฃูุถู ุฃู ุชุฃุฎุฐู ุจููุงุน 0x3FF (ุฃู 0x1FF ุ ููุง ุฅูู ุฐูู). <br><br>  ูููู ุณุฌู <b>CTRLDSSEGMENT</b> ูู ุงูุฅุฒุงุญุฉ + 0x10 ุ ููุธูุฑ ุนูู ูุญุฏุฉ ุชุญูู ุงููุถูู ุฃูู 32 ุจุชูุง ูู ุนููุงู ูุฑูุฉ ุงูุฅุทุงุฑ. <br><br>  ูุญุชูู ุณุฌู <b>PERIODICLISTBASE</b> ุนูู ุฅุฒุงุญุฉ ูุฏุฑูุง + 0x14 ุ ููููู ูุถุน 32 ุจุชูุง ุฃูู ูู ูุฑูุฉ ุงูุฅุทุงุฑ ููู ุ ูุงุญุธ ุฃูู ูุฌุจ ูุญุงุฐุงุฉ ุงูุนููุงู ูุน ุญุฌู ุตูุญุฉ ุงูุฐุงูุฑุฉ (4096). <br><br>  ูุญุชูู ุณุฌู <b>ASYNCLISTADDR</b> ุนูู ุฅุฒุงุญุฉ ูุฏุฑูุง + 0x18 ุ ููููู ูุถุน ุนููุงู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุบูุฑ ุงููุชุฒุงููุฉ ููู ุ ูุงุญุธ ุฃูู ูุฌุจ ูุญุงุฐุงุฉ ุนูุฏ ุญุฏ 32 ุจุงูุช ุ ุจูููุง ูุฌุจ ุฃู ูููู ูู ุฃูู ุฃุฑุจุนุฉ ุบูุบุงุจุงูุช ูู ุงูุฐุงูุฑุฉ ุงููุนููุฉ. <br><br>  ูุดูุฑ ุชุณุฌูู <b>CONFIGFLAG</b> ุฅูู ูุง ุฅุฐุง ุชู ุชูููู ุงูุฌูุงุฒ.  ูุฌุจ ุชุนููู ุจุช 0 ุจุนุฏ ุงูุงูุชูุงุก ูู ุฅุนุฏุงุฏ ุงูุฌูุงุฒ ุ ูุน ุฅุฒุงุญุฉ + 0x40. <br><br>  ุฏุนูุง ููุชูู ุฅูู ุชุณุฌููุงุช ุงููููุฐ.  ูุญุชูู ูู ูููุฐ ุนูู ุณุฌู ุญุงูุฉ ุงูุฃูุฑ ุงูุฎุงุต ุจู ุ ููุชู ุฅุฒุงุญุฉ ูู ุณุฌู ูููุฐ <b>+ 0x44 + (ุฑูู PortNumber - 1) * 4</b> ุ ุจุชุงุชู ุชุนูู ูุง ููู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Bit 12 - ุทุงูุฉ ุงููููุฐ ุ 1 - ูุชู ุชูููุฑ ุงูุทุงูุฉ ุ 0 - ูุง. </li><li style=";text-align:right;direction:rtl">  ุชู ุชุนููู Bit 8 - Port Rest - ูุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุงุฒ. </li><li style=";text-align:right;direction:rtl">  Bit 3 - ุชูููู / ุชุนุทูู ุงููููุฐ - ูุชู ุชุนูููู ุนูุฏ ุชุบููุฑ ุญุงูุฉ "ุชุถููู" ุงููููุฐ. </li><li style=";text-align:right;direction:rtl">  ุจุช 2 - ุชุดุบูู / ุฅููุงู ุงููููุฐ. </li><li style=";text-align:right;direction:rtl">  Bit 1 - ุชุบููุฑ ุญุงูุฉ ุงูุงุชุตุงู ุ ูุชู ุชุนูููู ุนูู 1 ุ ุนูู ุณุจูู ุงููุซุงู ุ ุฅุฐุง ููุช ุจุชูุตูู ุฌูุงุฒ USB ุฃู ูุตูู. </li><li style=";text-align:right;direction:rtl">  ุจุช 0 - ุญุงูุฉ ุงูุงุชุตุงู ุ 1 - ูุชุตู ุ 0 - ูุง. </li></ul><br>  ุงูุขู ุฏุนูุง ููุชูู ุฅูู ุงูุนุตูุฑ ููุณู. <br><br><h2 style=";text-align:right;direction:rtl">  ููู ุงูุจูุงูุงุช ูููุงูู ุงูุงุณุชุนูุงู </h2><br>  ูุชุถูู ุชูุธูู ุจููุฉ ูุนุงูุฌุฉ ุงูุทูุจุงุช ููุงุฆู ุงูุงูุชุธุงุฑ ูุงุตูุงุช ุงูููู (TDs). <br><br>  ูู ุงูููุช ุงูุญุงูู ุ ุณููุธุฑ ููุท ูู 3 ููุงูู. <br><br><h3 style=";text-align:right;direction:rtl">  ูุงุฆูุฉ ูุชุณูุณูุฉ </h3><br>  ูุชู ุชูุธูู ุงููุงุฆูุฉ ุงูุชุณูุณููุฉ (ุงูุฏูุฑูุฉ ุ Pereodic) ุนูู ุงููุญู ุงูุชุงูู: <br><br><img src="https://habrastorage.org/webt/hv/2h/23/hv2h23mnmv5uks1ffugte6ycpcu.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  ููุง ุชุฑู ูู ุงูุฑุณู ุงูุจูุงูู ุ ุชุจุฏุฃ ุงููุนุงูุฌุฉ ุจุงูุญุตูู ุนูู ุงูุฅุทุงุฑ ุงููุทููุจ ูู ุฅุทุงุฑ ุงููุฑูุฉ ุ ุญูุซ ูุดุบู ูู ุนูุตุฑ ูู ุนูุงุตุฑู 4 ุจุงูุช ููู ุงูุจููุฉ ุงูุชุงููุฉ: <br><br><img src="https://habrastorage.org/webt/o_/m7/ic/o_m7icnqm0ifgvnfpfycwahilwy.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  ููุง ุชุฑู ูู ุงูุตูุฑุฉ ุ ูุชู ูุญุงุฐุงุฉ ููู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ / ุงููุงุตู ุนูุฏ ุญุฏ 32 ุจุงูุช ุ ูุนูู ุงูุจุช 0 ุฃู ูุญุฏุฉ ุชุญูู ุงููุถูู ูู ุชุนุงูุฌ ูุฐุง ุงูุนูุตุฑ ุ ูุชุดูุฑ ุงูุจุชุงุช 3: 1 ุฅูู ููุน ูุง ุณุชุชุนุงูู ูุนู ูุญุฏุฉ ุงูุชุญูู ุงููุถููุฉ: 0 - TD ูุชุฒุงูู (iTD) ุ 1 - ุจุฏูุฑู ุ 2 ู 3 ูู ูุฐู ุงูููุงูุฉ ูู ุฃููุฑ. <br><br><h3 style=";text-align:right;direction:rtl">  ูุงุฆูุฉ ุงูุชุธุงุฑ ุบูุฑ ูุชุฒุงููุฉ </h3><br>  ุชููู ูุญุฏุฉ ุชุญูู ุงููุถูู ุจูุนุงูุฌุฉ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูุฐู ููุท ุนูุฏูุง ูููู ุงูุฅุทุงุฑ ุงููุชุณูุณู ูุงุฑุบูุง ุฃู ุนูุฏูุง ุชููู ูุญุฏุฉ ุชุญูู ุงููุถูู ุจูุนุงูุฌุฉ ุงููุงุฆูุฉ ุงูุชุณูุณููุฉ ุจุงููุงูู. <br><br>  ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุบูุฑ ุงููุชุฒุงููุฉ ูู ูุคุดุฑ ููุงุฆูุฉ ุงูุชุธุงุฑ ุชุญุชูู ุนูู ููุงุฆู ุงูุชุธุงุฑ ุฃุฎุฑู ุชุญุชุงุฌ ุฅูู ูุนุงูุฌุฉ.  ูุฎุทุท: <br><br><img src="https://habrastorage.org/webt/rz/sv/4s/rzsv4sqoyqegzwqoij9vl7qpt14.jpeg" alt="ุงูุตูุฑุฉ"><br><br><h3 style=";text-align:right;direction:rtl">  qTD (ูุงุตู ููู ุนูุตุฑ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ) </h3><br>  ูุฐุง TD ูุฏูู ุงููููู ุงูุชุงูู: <br><br><img src="https://habrastorage.org/webt/hf/gq/g5/hfgqg5fvujkx2bv8piy6i3gijyu.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  <b>ูุคุดุฑ qTD ุงูุชุงูู</b> - ูุคุดุฑ ุงุณุชูุฑุงุฑ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูููุนุงูุฌุฉ (ููุชูููุฐ ุงูุฃููู) ุ ุจุช 0 ูุดูุฑ ูุคุดุฑ qTD ุงูุชุงูู ุฅูู ุนุฏู ูุฌูุฏ ูุงุฆูุฉ ุงูุชุธุงุฑ ุฃุฎุฑู. <br>  <b>ุฑูุฒ qTD</b> - ุงูุฑูุฒ ุงููููุฒ ูู TD ุ ูุนุฑุถ ูุนููุงุช ููู ุงูุจูุงูุงุช: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Bit 31 - ุชุจุฏูู ุงูุจูุงูุงุช (ุงููุฒูุฏ ุนู ุฐูู ูุงุญููุง) </li><li style=";text-align:right;direction:rtl">  ุจุช 30:16 - ูููุฉ ุงูุจูุงูุงุช ุงููุฑุงุฏ ููููุง ุ ุจุนุฏ ุฅุชูุงู ุงููุนุงููุฉ ุ ุชูุฎูุถ ูููุชูุง ุจููุฏุงุฑ ุงูุจูุงูุงุช ุงููููููุฉ. </li><li style=";text-align:right;direction:rtl">  ุจุช 15 - IOC - ุงูููุงุทุนุฉ ุนูุฏ ุงูุชูุงููุง - ุชุณุจุจ ุงูููุงุทุนุฉ ุจุนุฏ ุงูุชูุงู ูุนุงูุฌุฉ ุงููุงุตู. </li><li style=";text-align:right;direction:rtl">  ุชูุถุญ ุงูุจุชุงุช 14:12 ุนุฏุฏ ุงููุฎุฒู ุงููุคูุช ุงูุญุงูู ุฅูู / ุงูุฐู ูุชู ุชุจุงุฏู ุงูุจูุงูุงุช ููู ุ ุงููุฒูุฏ ุนู ุฐูู ูุงุญููุง. </li><li style=";text-align:right;direction:rtl">  Bits 11:10 - ุนุฏุฏ ุงูุฃุฎุทุงุก ุงููุณููุญ ุจูุง.  ููุถุญ ูุฐุง ุงูุฌุฏูู ุนูุฏูุง ููุฎูุถ โโุนุฏุฏ ุงูุฃุฎุทุงุก: <br><br><img src="https://habrastorage.org/webt/ko/hz/ia/kohzia9y2vxtrd1tepp-h5qokgm.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  ุงูุญุงุดูุฉ ุงูุณูููุฉ 1 - ูุคุฏู ุงููุดู ุนู Babble ุฃู Stall ุชููุงุฆููุง ุฅูู ุฅููุงู ุชูููุฐ ุฑุฃุณ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ.  ุงูุญุงุดูุฉ ุงูุณูููุฉ 3 - ุฃุฎุทุงุก ุงููุฎุฒู ุงููุคูุช ููุจูุงูุงุช ูู ูุดุงูู ูุน ุงููุถูู.  ูุง ุชุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุนูููุงุช ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุฌูุงุฒ. </li><li style=";text-align:right;direction:rtl">  9: 8 - ุฑูุฒ PID - ููุน ุงูุฑูุฒ ุงููููุฒ: 0 - ุงูุฑูุฒ ุงููููุฒ ููุฅุฏุฎุงู (ูู ุงููุถูู ุฅูู ุงูุฌูุงุฒ) ุ 1 - ุงูุฑูุฒ ุงููููุฒ ููุฅุฎุฑุงุฌ (ูู ุงูุฌูุงุฒ ุฅูู ุงููุถูู) ุ 2 - ุงูุฑูุฒ "SETUP" </li><li style=";text-align:right;direction:rtl">  ุงูุจุชุงุช 7: 0 ุชุดูุฑ ุฅูู ุญุงูุฉ TD: <br>  ุชุดูุฑ ุงูุจุชุฉ 7 ุฅูู ุฃู TD ูู ุญุงูุฉ ูุดุทุฉ (ุจูุนูู ุฃู ูุญุฏุฉ ุชุญูู ุงููุถูู ุชุนุงูุฌ TD) <br>  ุจุช 6 - ุชู ุงูุฅููุงู - ูุดูุฑ ุฅูู ุญุฏูุซ ุฎุทุฃ ูุชููู ุชูููุฐ TD. <br>  Bit 4 - Babble Detected - ูููุฉ ุงูุจูุงูุงุช ุงูุชู ุฃุฑุณููุงูุง ุฅูู ุงูุฌูุงุฒ ุ ุฃู ููู ุซูุฑุฉ ุ ุฃูู ููุง ูุฑุณูู ุ ุนูู ุณุจูู ุงููุซุงู ุ ุฃุฑุณู ููุง ุงูุฌูุงุฒ 100 ุจุงูุช ูู ุงูุจูุงูุงุช ุ ูููุฑุฃ 50 ุจุงูุช ููุท ุ ุซู 50 ุจุงูุช ุฃุฎุฑู ุณูุชู ุฃูุถูุง ุชุนููู ุงูุจุช ุงููููููู ุฅุฐุง ุชู ุชุนููู ูุฐุง ุงูุจุช ุฅูู 1. <br>  ุจุช 3 - ุฎุทุฃ ูู ุงููุนุงููุฉ - ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงููุฉ. </li></ul><br>  <b>ูุงุฆูุฉ ูุคุดุฑ ุตูุญุฉ ุงููุฎุฒู ุงููุคูุช qTD</b> - ุฃู ูู 5 ูุฎุงุฒู.  ูุญุชูู ุนูู ุฑุงุจุท ุฅูู ุงูููุงู ุงูุฐู ูุฌุจ ุฃู ุชุชู ููู ุงููุนุงููุฉ ูู ุงูุฐุงูุฑุฉ (ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุฌูุงุฒ / ุงุณุชูุจุงู ุงูุจูุงูุงุช ูู ุงูุฌูุงุฒ) ุ ูุฌุจ ูุญุงุฐุงุฉ ุฌููุน ุงูุนูุงููู ูู ุงููุฎุงุฒู ุงููุคูุชุฉ ุ ุจุงุณุชุซูุงุก ุงูุนููุงู ุงูุฃูู ุ ูุน ุญุฌู ุงูุตูุญุฉ (4096 ุจุงูุช). <br><br><h3 style=";text-align:right;direction:rtl">  ุฑุฃุณ ุงูุฎุท </h3><br>  ูุญุชูู ุฑุฃุณ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุนูู ุงููููู ุงูุชุงูู: <br><br><img src="https://habrastorage.org/webt/9m/ob/l7/9mobl76mr1drsddxbgndgbgoneo.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  <b>ูุคุดุฑ ุงูุงุฑุชุจุงุท ุงูุฃููู ูุฑุฃุณ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ</b> - ุงููุคุดุฑ ุฅูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุงูุชุงููุฉ ุ ุชุญุชูู ุงูุจุชุงุช 2: 1 ุนูู ุงูููู ุงูุชุงููุฉ ุงุนุชูุงุฏูุง ุนูู ููุน ูุงุฆูุฉ ุงูุงูุชุธุงุฑ: <br><br><img src="https://habrastorage.org/webt/bu/gw/sa/bugwsap9snr11blm5ifggvhei60.jpeg" alt="ุงูุตูุฑุฉ"><br><br>  <b>ูุฏุฑุงุช / ุฎุตุงุฆุต ููุทุฉ ุงูููุงูุฉ</b> - <b>ุฎุตุงุฆุต</b> ูุงุฆูุฉ ุงูุงูุชุธุงุฑ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุญุชูู ุงูุจุชุงุช 26:16 ุนูู ุงูุญุฏ ุงูุฃูุตู ูุญุฌู ุงูุญุฒูุฉ ููุฅุฑุณุงู </li><li style=";text-align:right;direction:rtl">  Bit 14: ุงูุชุญูู ูู ุชุจุฏูู ุงูุจูุงูุงุช - ููุถุญ ุงูููุงู ุงูุฐู ูุฌุจ ุฃู ุชุฃุฎุฐ ููู ูุญุฏุฉ ุชุญูู ุงููุถูู ูููุฉ ุชุจุฏูู ุงูุจูุงูุงุช ุงูุฃูููุฉ ุ 0 - ูุชุฌุงูู ุจุช DT ูู qTD ุ ููุญูุธ ุจุช DT ูุฑุฃุณ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ. </li><li style=";text-align:right;direction:rtl">  Bit 13:12 - ุฎุตุงุฆุต ูุนุฏู ุงูุฅุฑุณุงู: <img src="https://habrastorage.org/webt/gk/tb/sd/gktbsdm7kys5kcgk6e3uewkgf1q.jpeg" alt="ุงูุตูุฑุฉ"></li><li style=";text-align:right;direction:rtl">  Bits 11: 8 - ุฑูู ููุทุฉ ุงูููุงูุฉ ุงูุชู ุชู ุชูุฏูู ุงูุทูุจ ุฅูููุง </li><li style=";text-align:right;direction:rtl">  ุจุช 6: 0 - ุนููุงู ุงูุฌูุงุฒ </li></ul><br>  <b>ุฅููุงูุงุช ููุทุฉ ุงูููุงูุฉ: Head Queue Head DWord 2</b> - ุงุณุชูุฑุงุฑ ุงููููุฉ ุงููุฒุฏูุฌุฉ ุงูุณุงุจูุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุช 29:23 - ุฑูู ุงููุญูุฑ </li><li style=";text-align:right;direction:rtl">  ุจุช 22:16 - ุนููุงู ุงููุญูุฑ </li></ul><br>  <b>ูุคุดุฑ ุงุฑุชุจุงุท qTD ุงูุญุงูู</b> - ุงููุคุดุฑ ุฅูู qTD ุงูุญุงูู. <br><br>  ููุชูู ุฅูู ุงูุฃูุซุฑ ุฅุซุงุฑุฉ ููุงูุชูุงู. <br><br><h2 style=";text-align:right;direction:rtl">  ุณุงุฆู EHCI </h2><br>  ููุจุฏุฃ ุจุงูุงุณุชูุณุงุฑุงุช ุงูุชู ูููู ูู EHCI ุงูุฅุฌุงุจุฉ ุนูููุง.  ููุงู ููุนุงู ูู ุงูุทูุจุงุช: Control - a la command ู Bulk - ุฅูู ููุงุท ุงูููุงูุฉ ุ ูุชุจุงุฏู ุงูุจูุงูุงุช ุ ุนูู ุณุจูู ุงููุซุงู ุ ุชุณุชุฎุฏู ุงูุบุงูุจูุฉ ุงูุนุธูู ูู ูุญุฑูุงุช ุฃูุฑุงุต USB ุงููุญูููุฉ (USB MassStorage) ููุน ููู ุงูุจูุงูุงุช Bulk / Bulk / Bulk.  ูุณุชุฎุฏู ุงููุงูุณ ูููุญุฉ ุงูููุงุชูุญ ุฃูุถูุง ุงูุทูุจุงุช ุงููุฌูุนุฉ ูููู ุงูุจูุงูุงุช. <br><br>  ุชููุฆุฉ EHCI ูุชูููู ููุงุฆู ุงูุชุธุงุฑ ุบูุฑ ูุชุฒุงููุฉ ููุชุณูุณูุฉ: <br><br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Base I/O Address PciBar bar; PciGetBar(&amp;bar, id, 0); EhciController *hc = VMAlloc(sizeof(EhciController)); hc-&gt;capRegs = (EhciCapRegs *)(uintptr_t)bar.u.address; hc-&gt;opRegs = (EhciOpRegs *)(uintptr_t)(bar.u.address + hc-&gt;capRegs-&gt;capLength); // Read the Command register //    uint cmd = ROR(usbCmdO); // Write it back, setting bit 2 (the Reset bit) //   ,   2(Reset) // and making sure the two schedule Enable bits are clear. //  ,  2   WOR(usbCmdO, 2 | cmd &amp; ~(CMD_ASE | CMD_PSE)); // A small delay here would be good. You don't want to read //     ,     // the register before it has a chance to actually set the bit //   ,         ROR(usbCmdO); // Now wait for the controller to clear the reset bit. //      Reset while (ROR(usbCmdO) &amp; 2); // Again, a small delay here would be good to allow the // reset to actually become complete. //   ROR(usbCmdO); // wait for the halted bit to become set //    Halted    while (!(ROR(usbStsO) &amp; STS_HCHALTED)); //     ,        // ,           128  hc-&gt;frameList = (u32 *)VMAlloc(1024 * sizeof(u32) + 8192 * 4); hc-&gt;frameList = (((uint)hc-&gt;frameList) / 16384) * 16384 + 16384; hc-&gt;qhPool = (EhciQH *)VMAlloc(sizeof(EhciQH) * MAX_QH + 8192 * 4); hc-&gt;tdPool = (EhciTD *)VMAlloc(sizeof(EhciTD) * MAX_TD + 8192 * 4); hc-&gt;qhPool = (((uint)hc-&gt;qhPool) / 16384) * 16384 + 16384; hc-&gt;tdPool = (((uint)hc-&gt;tdPool) / 16384) * 16384 + 16384; // Asynchronous queue setup //    EhciQH *qh = EhciAllocQH(hc); //     ,      // ,    qh-&gt;qhlp = (u32)(uintptr_t)qh | PTR_QH; //  ,  ,     qh-&gt;ch = QH_CH_H; qh-&gt;caps = 0; qh-&gt;curLink = 0; qh-&gt;nextLink = PTR_TERMINATE; qh-&gt;altLink = 0; qh-&gt;token = 0; //    for (uint i = 0; i &lt; 5; ++i) { qh-&gt;buffer[i] = 0; qh-&gt;extBuffer[i] = 0; } hc-&gt;asyncQH = qh; // Periodic list queue setup //    qh = EhciAllocQH(hc); //     qh-&gt;qhlp = PTR_TERMINATE; qh-&gt;ch = 0; qh-&gt;caps = 0; qh-&gt;curLink = 0; qh-&gt;nextLink = PTR_TERMINATE; qh-&gt;altLink = 0; qh-&gt;token = 0; //   for (uint i = 0; i &lt; 5; ++i) { qh-&gt;buffer[i] = 0; qh-&gt;extBuffer[i] = 0; } qh-&gt;transfer = 0; qh-&gt;qhLink.prev = &amp;qh-&gt;qhLink; qh-&gt;qhLink.next = &amp;qh-&gt;qhLink; hc-&gt;periodicQH = qh; //        for (uint i = 0; i &lt; 1024; ++i) hc-&gt;frameList[i] = PTR_QH | (u32)(uintptr_t)qh; kprintf("FrameList filled. Turning off Legacy BIOS support..."); // Check extended capabilities //  BIOS Legacy support uint eecp = (RCR(hccParamsO) &amp; HCCPARAMS_EECP_MASK) &gt;&gt; HCCPARAMS_EECP_SHIFT; if (eecp &gt;= 0x40) { // Disable BIOS legacy support uint legsup = PciRead32(id, eecp + USBLEGSUP); kprintf("."); if (legsup &amp; USBLEGSUP_HC_BIOS) { PciWrite32(id, eecp + USBLEGSUP, legsup | USBLEGSUP_HC_OS); kprintf("."); for (;;) { legsup = PciRead32(id, eecp + USBLEGSUP); kprintf("."); if (~legsup &amp; USBLEGSUP_HC_BIOS &amp;&amp; legsup &amp; USBLEGSUP_HC_OS) { break; } } } } kprintf("Done\n"); // Disable interrupts //   //hc-&gt;opRegs-&gt;usbIntr = 0; MWIR(ehcibase, usbIntrO, 0); // Setup frame list //     //hc-&gt;opRegs-&gt;frameIndex = 0; WOR(frameIndexO, 0); //hc-&gt;opRegs-&gt;periodicListBase = (u32)(uintptr_t)hc-&gt;frameList; WOR(periodicListBaseO, (u32)(uintptr_t)hc-&gt;frameList); //       //hc-&gt;opRegs-&gt;asyncListAddr = (u32)(uintptr_t)hc-&gt;asyncQH; WOR(asyncListAddrO, (u32)(uintptr_t)hc-&gt;asyncQH); //    0 //hc-&gt;opRegs-&gt;ctrlDsSegment = 0; WOR(ctrlDsSegmentO, 0); // Clear status //   //hc-&gt;opRegs-&gt;usbSts = ~0; WOR(usbStsO, ~0); // Enable controller //  , 8 -,  //     //hc-&gt;opRegs-&gt;usbCmd = (8 &lt;&lt; CMD_ITC_SHIFT) | CMD_PSE | CMD_ASE | CMD_RS; WOR(usbCmdO, (8 &lt;&lt; CMD_ITC_SHIFT) | CMD_PSE | CMD_ASE | CMD_RS); while (ROR(usbStsO)&amp;STS_HCHALTED); // Configure all devices to be managed by the EHCI // ,   //hc-&gt;opRegs-&gt;configFlag = 1; WOR(configFlagO, 1);\ // Probe devices //   EhciProbe(hc);</span></span></code> </pre> <br>  ูู ุงููุงูุน ุ ุฑูุฒ ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐ ุฅูู ุญุงูุชู ุงูุฃุตููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> u32 *reg = &amp;hc-&gt;opRegs-&gt;ports[port]; <span class="hljs-comment"><span class="hljs-comment">//    ,  100 *reg|=(1&lt;&lt;12)|(1&lt;&lt;20); Wait(100); //  ,  50  EhciPortSet(reg, PORT_RESET | (1&lt;&lt;12) | (1&lt;&lt;20) | (1&lt;&lt;6)); Wait(50); EhciPortClr(reg, PORT_RESET); // Wait 100ms for port to enable (TODO - what is appropriate length of time?) //  100    ,   , //  100    uint status = 0; for (uint i = 0; i &lt; 10; ++i) { // Delay Wait(10); // Get current status //    status = *reg; // Check if device is attached to port //      if (~status &amp; PORT_CONNECTION) break; // Acknowledge change in status //    -    if (status &amp; (PORT_ENABLE_CHANGE | PORT_CONNECTION_CHANGE)) { EhciPortClr(reg, PORT_ENABLE_CHANGE | PORT_CONNECTION_CHANGE); continue; } // Check if device is enabled //    ,    if (status &amp; PORT_ENABLE) break; } return status;</span></span></code> </pre><br>  ุทูุจ ุงูุชุญูู ุจุงูุฌูุงุฒ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EhciDevControl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UsbDevice *dev, UsbTransfer *t)</span></span></span><span class="hljs-function"> </span></span>{ EhciController *hc = (EhciController *)dev-&gt;hc; UsbDevReq *req = t-&gt;req; <span class="hljs-comment"><span class="hljs-comment">// Determine transfer properties //    uint speed = dev-&gt;speed; uint addr = dev-&gt;addr; uint maxSize = dev-&gt;maxPacketSize; uint type = req-&gt;type; uint len = req-&gt;len; // Create queue of transfer descriptors //   TDs EhciTD *td = EhciAllocTD(hc); if (!td) return; EhciTD *head = td; EhciTD *prev = 0; // Setup packet //   uint toggle = 0; uint packetType = USB_PACKET_SETUP; uint packetSize = sizeof(UsbDevReq); EhciInitTD(td, prev, toggle, packetType, packetSize, req); prev = td; // Data in/out packets packetType = type &amp; RT_DEV_TO_HOST ? USB_PACKET_IN : USB_PACKET_OUT; u8 *it = (u8 *)t-&gt;data; u8 *end = it + len; //EhciPrintTD(td); while (it &lt; end) { td = EhciAllocTD(hc); if (!td) return; toggle ^= 1; packetSize = end - it; if (packetSize &gt; maxSize) packetSize = maxSize; EhciInitTD(td, prev, toggle, packetType, packetSize, it); it += packetSize; prev = td; } // Status packet //   td = EhciAllocTD(hc); if (!td) return; toggle = 1; packetType = type &amp; RT_DEV_TO_HOST ? USB_PACKET_OUT : USB_PACKET_IN; EhciInitTD(td, prev, toggle, packetType, 0, 0); // Initialize queue head //   : EhciQH *qh = EhciAllocQH(hc); EhciInitQH(qh, t, head, dev-&gt;parent, false, speed, addr, 0, maxSize); // Wait until queue has been processed //       EhciInsertAsyncQH(hc-&gt;asyncQH, qh); EhciWaitForQH(hc, qh); }</span></span></code> </pre><br>  ุฑูุฒ ูุนุงูุฌุฉ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qh-&gt;token &amp; TD_TOK_HALTED) { t-&gt;success = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; t-&gt;complete = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qh-&gt;nextLink &amp; PTR_TERMINATE) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (~qh-&gt;token &amp; TD_TOK_ACTIVE) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qh-&gt;token &amp; TD_TOK_DATABUFFER) kprintf(<span class="hljs-string"><span class="hljs-string">" Data Buffer Error\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qh-&gt;token &amp; TD_TOK_BABBLE) kprintf(<span class="hljs-string"><span class="hljs-string">" Babble Detected\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qh-&gt;token &amp; TD_TOK_XACT) kprintf(<span class="hljs-string"><span class="hljs-string">" Transaction Error\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qh-&gt;token &amp; TD_TOK_MMF) kprintf(<span class="hljs-string"><span class="hljs-string">" Missed Micro-Frame\n"</span></span>); t-&gt;success = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; t-&gt;complete = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t-&gt;complete) ....</code> </pre><br>  ูุงูุขู ุทูุจ ููุทุฉ ุงูููุงูุฉ (ุทูุจ ูุฌูุน) <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EhciDevIntr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UsbDevice *dev, UsbTransfer *t)</span></span></span><span class="hljs-function"> </span></span>{ EhciController *hc = (EhciController *)dev-&gt;hc; <span class="hljs-comment"><span class="hljs-comment">// Determine transfer properties //    uint speed = dev-&gt;speed; uint addr = dev-&gt;addr; uint maxSize = t-&gt;endp-&gt;desc-&gt;maxPacketSize; uint endp = t-&gt;endp-&gt;desc-&gt;addr &amp; 0xf; EhciTD *td = EhciAllocTD(hc); if (!td) { t-&gt;success = false; t-&gt;complete = true; return; } EhciTD *head = td; EhciTD *prev = 0; // Data in/out packets uint toggle = t-&gt;endp-&gt;toggle; uint packetType = t-&gt;endp-&gt;desc-&gt;addr &amp; 0x80 ? USB_PACKET_IN : USB_PACKET_OUT; uint packetSize = t-&gt;len; EhciInitTD(td, prev, toggle, packetType, packetSize, t-&gt;data); // Initialize queue head //    EhciQH *qh = EhciAllocQH(hc); EhciInitQH(qh, t, head, dev-&gt;parent, true, speed, addr, endp, maxSize); //printQh(qh); // Schedule queue //    EhciInsertPeriodicQH(hc-&gt;periodicQH, qh); }</span></span></code> </pre><br>  ุฃุนุชูุฏ ุฃู ุงูููุถูุน ูุซูุฑ ููุงูุชูุงู ููุบุงูุฉ ุ ุนูู ุงูุฅูุชุฑูุช ุจุงููุบุฉ ุงูุฑูุณูุฉ ูุง ููุฌุฏ ุชูุฑูุจูุง ุฃู ุชูุซูู ูุฃูุตุงู ูููุงูุงุช ุญูู ูุฐุง ุงูููุถูุน ุ ูุฅุฐุง ูุงู ููุงู ุ ููู ุถุจุงุจู ููุบุงูุฉ.  ุฅุฐุง ูุงู ููุถูุน ุงูุนูู ูุน ุงูุฃุฌูุฒุฉ ูุชุทููุฑ ูุธุงู ุงูุชุดุบูู ูุซูุฑูุง ููุงูุชูุงู ุ ูููุงู ุงููุซูุฑ ูุชูููู. <br><br>  ุฃุฑุตูุฉ: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุงุตูุงุช</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar426421/">https://habr.com/ru/post/ar426421/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar426411/index.html">ุชุทููุฑ ูุฆุงุช ูุงุตูุงุช C ++ / CLI</a></li>
<li><a href="../ar426413/index.html">ูุจุงุฏุฆ ุตูุจุฉ ูุฌุจ ุนูู ูู ูุทูุฑ ูุนุฑูุชูุง</a></li>
<li><a href="../ar426415/index.html">Fintech-digest: ุงูุชุญูู ูู ุฑูููุฉ ุงูุจูู ุงููุฑูุฒู ุ ุฑุงุชุจ ุงูุนููุฉ ุงููุดูุฑุฉ ุ ุจุทุงูุฉ Mir ุนูู ุดูู ุฃุณุงูุฑ ูุญููุงุช ููุงุชูุญ</a></li>
<li><a href="../ar426417/index.html">Pavel 2.0: ุงุณุชุดุงุฑู ุฒุงุฆู ุนูู JS ุ node.js ูุน ูุขุฎุฐ ููุงุชู</a></li>
<li><a href="../ar426419/index.html">ููููุน ุทุฑู ุงูุชุญููู ุงูุฒุงุฆุฏ ุฃู ุงูุฌุณุฑ ูู ุฌุงูุง</a></li>
<li><a href="../ar426423/index.html">mmWave ุนูู ุงูููุงุชู ุงูุฐููุฉ: ููู ุฌุนูุช Qualcomm ุงููุณุชุญูู ูููููุง</a></li>
<li><a href="../ar426425/index.html">ุงูุญูููุฉ ุงููุงููุฉ ุนู RTOS. ุงููุงุฏุฉ ุฑูู 14. ุฃูุณุงู ุงูุฐุงูุฑุฉ: ุงูููุฏูุฉ ูุงูุฎุฏูุงุช ุงูุฃุณุงุณูุฉ</a></li>
<li><a href="../ar426427/index.html">ุฃุดูุงุก ูููุฏุฉ ูู "ุงูุงุดูุงุก": ูุฌููุนุฉ ุตุบูุฑุฉ ูุจุฃุณุนุงุฑ ููุฎูุถุฉ</a></li>
<li><a href="../ar426429/index.html">ุชุซุจูุช FreeSWITCH 1.8 ุนูู ุฏุจูุงู 9 (ุงูุชุฏุงุฏ Raspbian ุ ุงูุตูุฑุฉ ุงูุฃุณุงุณูุฉ ููุธุงู ุงูููุฒู ุงูุฐูู MajorDoMo ุนูู Rasbperri Pi)</a></li>
<li><a href="../ar426431/index.html">ุชูููู ูุญุฑู ุงูุฑูุงูุฉ ุงููุฑุฆูุฉ Qlie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>