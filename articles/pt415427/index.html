<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèº üëºüèª üê¨ Toda a verdade sobre o RTOS de Colin Walls. Artigo 4. Tarefas, altern√¢ncia de contexto e interrup√ß√µes üöæ üÖæÔ∏è üñïüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Identificadores de tarefas 
 Voc√™ deve poder identificar cada tarefa no sistema. Esse requisito √© importante para outros objetos do kernel, mas existe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Toda a verdade sobre o RTOS de Colin Walls. Artigo 4. Tarefas, altern√¢ncia de contexto e interrup√ß√µes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415427/"><h3>  Identificadores de tarefas </h3><br>  Voc√™ deve poder identificar cada tarefa no sistema.  Esse requisito √© importante para outros objetos do kernel, mas existem algumas nuances nas tarefas que correspondem ao t√≥pico deste artigo. <br><br><img src="https://habrastorage.org/webt/6z/dy/vz/6zdyvzfbp4usza-socgerc4y5se.jpeg"><br><br>  Os desenvolvedores do RTOS usam abordagens diferentes para identificar tarefas, mas quatro estrat√©gias gerais podem ser distinguidas: <br><br><ul><li> A tarefa √© identificada usando um ponteiro para seu "bloco de controle".  Os ponteiros s√£o sempre exclusivos e tamb√©m convenientes de usar, pois o acesso √† unidade de controle √© necess√°rio para muitas chamadas de API.  Isso implica que todos os dados da tarefa s√£o armazenados na mem√≥ria de acesso aleat√≥rio (RAM), que pode ser ineficiente.  Um ponteiro normalmente ocupa cerca de 32 bits de mem√≥ria. </li><li>  Uma tarefa pode ser definida usando um "n√∫mero de √≠ndice" arbitr√°rio.  Esse valor pode ser √∫til ao conceder acesso a registros em determinadas tabelas.  Esse identificador pode ocupar oito ou menos bits de mem√≥ria, dependendo das limita√ß√µes no n√∫mero de tarefas que o RTOS suporta. </li><li>  Alguns RTOSs permitem apenas uma tarefa por n√≠vel de prioridade e, portanto, usam a prioridade para identificar exclusivamente uma tarefa.  Isso significa que a prioridade da tarefa n√£o pode ser alterada.  Essa abordagem √© uma varia√ß√£o da abordagem anterior. </li><li>  As tarefas podem ter nomes que s√£o cadeias de caracteres.  Isso pode ser √∫til para depura√ß√£o, mas √© improv√°vel que seja um meio eficaz de identificar exclusivamente uma tarefa.  Os RTOSs que oferecem suporte √† nomea√ß√£o de tarefas geralmente t√™m um identificador adicional (como um ponteiro) usado pelas chamadas da API etc. Para a maioria dos sistemas incorporados, os nomes de texto est√£o sobrecarregados;  um bom depurador permite cham√°-los localmente no host. </li></ul><a name="habracut"></a><br>  Artigos anteriores da s√©rie: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo # 3</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tarefas e planejamento</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo 2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RTOS: estrutura e modo em tempo real</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><br></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo 1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RTOS: introdu√ß√£o.</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><br></a> <br><h3>  <b>Mudan√ßa de contexto</b> </h3><br>  A altern√¢ncia de contexto √© o processo de transfer√™ncia de controle de uma tarefa para outra.  Vale a pena explorar esse t√≥pico mais de perto, pois o funcionamento da altern√¢ncia de contexto √© um princ√≠pio fundamental do RTOS. <br><br><h3>  <b>O que √© uma tarefa?</b> </h3><br>  Sabemos que uma tarefa √© um programa quase independente que compartilha o tempo do processador com v√°rias outras tarefas sob o controle do RTOS.  Mas voc√™ precisa pensar sobre o que realmente caracteriza a tarefa. <br><br><h3>  <b>Conjunto de registros</b> </h3><br>  Uma tarefa √©, em √∫ltima an√°lise, um conjunto exclusivo de valores de registro do processador.  Eles s√£o carregados nos registros do processador (ou seja, a tarefa √© atual) ou armazenados em algum lugar at√© o tempo de execu√ß√£o agendado.  Em um mundo ideal, um processador central teria v√°rios conjuntos de registros e cada um poderia ser atribu√≠do a uma tarefa separada.  Isso foi implementado para ocasi√µes especiais.  Muitos anos atr√°s, a s√©rie Texas Instruments TI 9900 possu√≠a muitos conjuntos de registros para cada tarefa, mas eles foram implementados na mem√≥ria principal, o que limitava o desempenho.  A arquitetura SPARC (anteriormente usada em sistemas desktop Unix) suporta muitos conjuntos de registros na "estrutura em anel", mas o n√∫mero de conjuntos ainda √© limitado. <br><br><h3>  <b>Dados internos</b> </h3><br>  A tarefa provavelmente ter√° sua pr√≥pria pilha, cujo tamanho pode ser definido separadamente para cada tarefa ou pode ser um par√¢metro global para todas as tarefas no sistema.  Isso, juntamente com os registros, fornece armazenamento de dados para tarefas espec√≠ficas.  Pode haver outras √°reas da mem√≥ria para armazenar dados para uma tarefa espec√≠fica. <br><br><h3>  <b>Recursos compartilhados</b> </h3><br>  Praticamente qualquer recurso pode ser compartilhado entre tarefas.  O c√≥digo pode ser geral: certas fun√ß√µes ou todo o c√≥digo da tarefa.  √â necess√°rio garantir que o c√≥digo seja reentrante, antes de tudo, vari√°veis ‚Äã‚Äãest√°ticas n√£o devem ser usadas (especificadas como est√°ticas ou apenas fora da fun√ß√£o).  Tenha cuidado com os m√≥dulos de biblioteca padr√£o que n√£o se destinam ao uso interno;  eles geralmente t√™m muitas fun√ß√µes n√£o confi√°veis. <br><br>  O compartilhamento de dados tamb√©m √© poss√≠vel, mas √© necess√°rio um controle de acesso cuidadoso.  Idealmente, apenas uma tarefa √© o "propriet√°rio" dos dados a qualquer momento. <br><br><h3>  <b>Como manter o contexto</b> </h3><br>  Quando uma tarefa √© reprogramada (ou seja, deixa de ser atual), seu conjunto de registros precisa ser salvo em algum lugar.  Existem pelo menos duas possibilidades: <br><br><ul><li>  Os registros podem ser armazenados em uma tabela especial para tarefas.  Pode fazer parte de um bloco de controle de tarefas (TCB).  Tamanho √© um valor previs√≠vel e constante (para uma arquitetura espec√≠fica da CPU). </li><li>  Os registros podem ser enviados para a pilha de tarefas.  Isso requer a aloca√ß√£o de espa√ßo de pilha adicional suficiente e armazenamento do ponteiro (possivelmente no TCB). </li></ul><br>  A escolha do mecanismo depende dos recursos de um RTOS espec√≠fico e do processador de destino.  Alguns dispositivos (geralmente 32 bits) podem acessar a pilha com efici√™ncia;  o restante (por exemplo, 8 bits) pode ser mais ideal ao trabalhar com tabelas. <br><br><h3>  <b>Cria√ß√£o din√¢mica de tarefas</b> </h3><br>  O principal aspecto da arquitetura RTOS √© que o RTOS √© "est√°tico" ou "din√¢mico". <br><br>  Ao usar um RTOS est√°tico, tudo √© determinado durante a cria√ß√£o do aplicativo, em particular, o n√∫mero de tarefas no sistema.  Esta √© uma solu√ß√£o l√≥gica para aplicativos incorporados, que geralmente t√™m funcionalidade limitada. <br><br>  O RTOS din√¢mico inicia uma tarefa (que pode ser uma tarefa "principal" especializada)) e tamb√©m cria e exclui outras tarefas, conforme necess√°rio.  Isso permite que o sistema se adapte √†s mudan√ßas de requisitos e √© um an√°logo mais pr√≥ximo do sistema de desktop, que se comporta dessa maneira.  A exibi√ß√£o est√°tica / din√¢mica tamb√©m se aplica a outros objetos do kernel. <br><br><h3>  <b>Requisito de cria√ß√£o de tarefas din√¢micas</b> </h3><br>  Esse recurso est√° inclu√≠do na maioria dos RTOS comerciais.  No entanto, apenas uma pequena parte dos aplicativos realmente precisa de um modo din√¢mico de opera√ß√£o.  Muitas vezes, o sistema √© iniciado, cria todas as tarefas necess√°rias (e outros objetos) e nunca mais cria e destr√≥i o c√≥digo do aplicativo.  A capacidade de criar tarefas din√¢micas tornou-se uma formalidade.  Um fornecedor apresentou, todos os outros seguiram o exemplo. <br><br>  Vale ressaltar que o padr√£o OSEK / VDX requer uma arquitetura est√°tica, mesmo que isso possa se aplicar a aplicativos bastante complexos.  O resultado desses requisitos √© a incapacidade de implementar o OSEK / VDX com um inv√≥lucro, uma camada intermedi√°ria sobre um RTOS regular (din√¢mico). <br><br><h3>  <b>Armadilhas da cria√ß√£o din√¢mica de tarefas</b> </h3><br>  H√° v√°rios problemas no modo din√¢mico de opera√ß√£o que podem ser preocupantes. <br><br>  Primeiro, o sistema se torna mais complexo, o que significa que, para estruturas de dados que descrevem tarefas (TCBs), s√£o necess√°rias informa√ß√µes adicionais.  Como regra, eles s√£o implementados na forma de listas bidirecionais, o que leva a custos associados √† quantidade de mem√≥ria. <br>  Todos os dados que descrevem a tarefa devem ser armazenados na RAM.  Isso √© ineficiente, pois a maioria deles pode ser simplesmente dados persistentes copiados da ROM.  Al√©m disso, em processadores de n√≠vel inferior (microcontroladores), pode n√£o haver mem√≥ria RAM. <br><br>  Provavelmente o mais preocupante √© a possibilidade de uma falta imprevis√≠vel de recursos, o que pode levar √† incapacidade de criar novos objetos.  Como a ess√™ncia de um sistema em tempo real √© sua previsibilidade, isso √© inaceit√°vel.  Portanto, deve-se tomar cuidado ao usar a cria√ß√£o de tarefas din√¢micas (e outros objetos). <br><br><h3>  <b>Interrup√ß√µes</b> </h3><br>  √â poss√≠vel que um sistema incorporado em tempo real possa ser implementado sem o uso de interrup√ß√µes, mas isso n√£o √© t√≠pico. <br><br><h3>  <b>Interrup√ß√µes e Kernel</b> </h3><br>  Ao usar o RTOS, um manipulador de interrup√ß√£o (ISR) √© o mais f√°cil poss√≠vel para "roubar" a quantidade m√≠nima de tempo do processador das tarefas agendadas.  Muitas vezes, um dispositivo pode simplesmente ser reparado e qualquer tarefa necess√°ria ser√° colocada na fila para processamento.  Al√©m disso, √© dif√≠cil falar em geral sobre interrup√ß√µes e sua intera√ß√£o com os kernels, simplesmente porque eles variam muito.  Por um lado, o desenvolvedor do RTOS pode garantir que as interrup√ß√µes n√£o estejam relacionadas ao kernel, e o programador ter√° que garantir que o agendador de tarefas n√£o esteja sobrecarregado, usando muito tempo do processador no ISR.  Por outro lado, o RTOS pode controlar completamente todo o subsistema de interrup√ß√£o.  Nenhuma das abordagens descritas est√° certa ou errada, elas s√£o apenas diferentes. <br><br><h3>  <b>Salvando Contexto</b> </h3><br>  Os ISRs sempre precisam manter um "contexto" para que o c√≥digo interrupt√≠vel n√£o seja afetado pelos c√°lculos do ISR.  Em um sistema implementado sem um RTOS, √© simplesmente uma quest√£o de salvar todos os registros usados ‚Äã‚Äãpelo ISR (geralmente na pilha) e restaur√°-los antes de retornar.  Alguns processadores possuem uma pilha ISR dedicada, enquanto outros simplesmente usam a mesma pilha que o c√≥digo do aplicativo. <br><br>  Ao usar o RTOS, a abordagem pode ser exatamente a mesma.  Da mesma forma, a pilha usada pelo ISR pode ser "emprestada" da tarefa atual ou pode ser outra pilha alocada para interrup√ß√µes.  Alguns n√∫cleos implementam esse recurso, mesmo que o pr√≥prio processador n√£o suporte a pilha de interrup√ß√µes.  A situa√ß√£o √© complicada se o ISR fizer uma chamada de API que afeta o agendador de tarefas.  Isso pode fazer com que a interrup√ß√£o retorne a outra tarefa daquela iniciada quando a interrup√ß√£o ocorreu. <br><br><h3>  <b>Interrup√ß√µes e agendador</b> </h3><br>  H√° v√°rias circunst√¢ncias nas quais o c√≥digo de execu√ß√£o ISR pode retornar para outra tarefa: <br><br><ul><li>  O ISR pode atribuir uma prioridade mais alta a uma tarefa j√° conclu√≠da, em vez da atual, se o agendador de tarefas priorit√°rias for usado. </li><li>  O ISR pode pausar a tarefa atual. </li><li>  Usando o Agendador de fatias de tempo (TS), o manipulador de interrup√ß√£o do timer do sistema controlar√° os intervalos de tempo e poder√° chamar o agendador, se necess√°rio. </li></ul><br><h3>  <b>Temporizador (Tick Clock)</b> </h3><br>  Em sistemas embarcados, o uso de um "rel√≥gio temporizador" peri√≥dico (intervalo de tempo) √© frequentemente encontrado.  Em alguns RTOS, √© um componente necess√°rio.  Normalmente, a presen√ßa de um timer de rel√≥gio √© opcional e sua aus√™ncia simplesmente exclui a disponibilidade de determinados servi√ßos.  O manipulador de interrup√ß√£o do timer geralmente fornece quatro funcionalidades: <br><br><ul><li>  Se um agendador de intervalo de tempo for usado, o manipulador de interrup√ß√£o do timer controlar√° o contador de tempo e agendar√° uma nova tarefa cada vez que o tempo acabar. </li><li>  Fornece suporte de hor√°rio do sistema.  Essa √© principalmente uma vari√°vel de 32 bits que √© incrementada por um timer e pode ser predefinida ou solicitada por tarefas. </li><li>  Se o RTOS fornecer aos cron√¥metros os aplicativos, ele ser√° suportado por um manipulador de interrup√ß√£o do cron√¥metro que ser√° respons√°vel pela expira√ß√£o e reagendamento. </li><li>  Se o RTOS suportar tempos limite no bloqueio de chamadas da API ou as tarefas estiverem no estado de suspens√£o, esses intervalos de tempo ser√£o suportados pelo manipulador de interrup√ß√£o do timer. </li></ul><br>  <i>Quando trabalhamos em nosso pr√≥prio sistema operacional OSRV MAX em tempo real (artigos publicados anteriormente sobre ele), nossa equipe encontrou o blog de Colin Walls, especialista em microeletr√¥nica e firmware da Mentor Graphics.</i>  <i>Os artigos pareciam interessantes, os traduziam por si mesmos, mas, para n√£o "escrever para a mesa", eles decidiram publicar.</i>  <i>Espero que eles tamb√©m sejam √∫teis para voc√™.</i>  <i>Nesse caso, planejamos publicar todos os artigos traduzidos da s√©rie.</i> <i><br><br></i>  <i>Sobre o autor: Colin Walls trabalha na ind√∫stria eletr√¥nica h√° mais de trinta anos, dedicando a maior parte de seu tempo ao firmware.</i>  <i>Ele agora √© engenheiro de firmware na Mentor Embedded (uma divis√£o da Mentor Graphics).</i>  <i>Colin Walls frequentemente fala em confer√™ncias e semin√°rios, autor de v√°rios artigos t√©cnicos e dois livros sobre firmware.</i>  <i>Vive no Reino Unido.</i>  <i>Blog profissional de Colin: blogs.mentor.com/colinwalls, e-mail: colin_walls@mentor.com</i> <i><br></i> <br>  Leia o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeiro, o segundo</a> e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">terceiro</a> artigos da s√©rie publicada anteriormente. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415427/">https://habr.com/ru/post/pt415427/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt415413/index.html">Funcionalidade cruzada, gerenciador de depend√™ncias, monitoramento nos testes iOS e UI. Como foi o Avito iOS Summer Edition</a></li>
<li><a href="../pt415415/index.html">An√∫ncio de uma confer√™ncia hackathon sobre desenvolvimento de jogos no blockchain GameNode</a></li>
<li><a href="../pt415417/index.html">Avalia√ß√£o do smartphone ASUS ZenFone Max Pro (M1) ZB602KL</a></li>
<li><a href="../pt415421/index.html">Convidamos voc√™ para o espa√ßo de trabalho colaborativo Gravity para o √∫ltimo torneio de contrata√ß√£o da temporada</a></li>
<li><a href="../pt415423/index.html">Infraestrutura de chave p√∫blica: autoridade de certifica√ß√£o baseada no utilit√°rio OpenSSL e SQLite3 (Postcryptum)</a></li>
<li><a href="../pt415429/index.html">Toda a verdade sobre o RTOS de Colin Walls. Artigo 5. Intera√ß√£o e sincroniza√ß√£o de tarefas</a></li>
<li><a href="../pt415431/index.html">An√∫ncio Hackathon SmartMail Hack 2: Chamada de Dados</a></li>
<li><a href="../pt415433/index.html">Gerenciamento de lan√ßamentos em servi√ßos de alojamento e servi√ßos comunit√°rios - compartilhamos experi√™ncia e lutamos com a intui√ß√£o</a></li>
<li><a href="../pt415435/index.html">Desenvolvimento de placas de interface no solo Xilinx Zynq 7000 para grava√ß√£o de voz em formato anal√≥gico e digital</a></li>
<li><a href="../pt415437/index.html">Como rolar ML em prod: seis rakes em que pisamos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>