<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏽 💜 🤞🏿 Perakitan dan penyebaran layanan microser yang sama dengan werf dan GitLab CI 😟 🎬 👨🏾‍🤝‍👨🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dua tahun lalu kami menerbitkan artikel " Membangun proyek dengan GitLab CI: satu .gitlab-ci.yml untuk ratusan aplikasi ", dan sekarang kita akan berb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Perakitan dan penyebaran layanan microser yang sama dengan werf dan GitLab CI</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/469541/"><img src="https://habrastorage.org/webt/m-/6b/h3/m-6bh3ggyovi2pibiz4iwnfraw0.png"><br><br>  Dua tahun lalu kami menerbitkan artikel " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Membangun proyek dengan GitLab CI: satu .gitlab-ci.yml untuk ratusan aplikasi</a> ", dan sekarang kita akan berbicara tentang memecahkan masalah yang sama hari ini.  Materi baru adalah tentang bagaimana Anda dapat membangun proses CI / CD untuk sejumlah besar aplikasi serupa dengan munculnya <code>include</code> di <code>.gitlab-ci.yml</code> dan munculnya werf untuk menggantikan dapp. <a name="habracut"></a><br><br><h2>  Pendahuluan </h2><br>  Dalam instruksi lebih lanjut yang diberikan dalam artikel, situasi berikut dipertimbangkan: <br><br><ul><li>  Ada aplikasi klien besar, yang terbagi dalam banyak repositori. </li><li>  Setiap repositori adalah aplikasi terpisah yang harus dijalankan di cluster Kubernetes. </li><li>  Sebagai sistem CI, GitLab CI digunakan. </li><li>  Deployment (infrastruktur di mana kode ini digunakan) dijelaskan oleh grafik Helm. </li><li>  Buat gambar dan gunakan di Kubernet menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">werf</a> . </li></ul><br>  Untuk kesederhanaan dan kenyamanan (dan sebagai penghargaan untuk fashion), kami akan terus menyebut aplikasi ini sebagai layanan microser.  <b>Semua layanan Microsoft ini dirakit, digunakan, dan diluncurkan dengan cara yang sama</b> , dan pengaturan khusus dikonfigurasikan menggunakan variabel lingkungan. <br><br>  Jelas, menyalin <code>.gitlab-ci.yml</code> , <code>werf.yaml</code> dan <code>.helm</code> membawa banyak masalah.  Bagaimanapun, setiap pengeditan dalam CI, proses perakitan atau deskripsi dari Helm-chart harus ditambahkan ke repositori lain ... <br><br><h2>  Menghubungkan template di .gitlab-ci.yml </h2><br>  Dengan munculnya <code>include:file</code> directive <code>include:file</code> di GitLab CE ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sejak versi 11.7</a> ), menjadi mungkin untuk membuat CI umum.  <code>include</code> sendiri muncul sedikit lebih awal (pada 11.4), tetapi itu memungkinkan menghubungkan templat hanya dari URL <i>publik</i> , yang agak membatasi fungsinya.  Dokumentasi GitLab dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sempurna menggambarkan</a> semua fitur dan contoh penggunaan. <br><br>  Dengan demikian, adalah mungkin untuk menolak menyalin <code>.gitlab-ci.yml</code> antara repositori dan mendukung relevansinya.  Berikut adalah contoh <code>.gitlab-ci.yml</code> dengan <code>include</code> : <br><br><pre> <code class="plaintext hljs">include: - project: 'infra/gitlab-ci' ref: 1.0.0 file: base-gitlab-ci.yaml - project: 'infra/gitlab-ci' ref: 1.0.0 file: cleanup.yaml</code> </pre> <br>  Kami sangat menyarankan Anda menggunakan nama cabang dalam <code>ref</code> <b>dengan hati-hati</b> .  Penyertaan dihitung pada saat pipa dibuat, sehingga perubahan CI Anda dapat secara otomatis jatuh ke dalam pipa produksi pada saat yang paling tidak tepat.  Tetapi <b>penggunaan tag dalam <code>ref</code></b> memudahkan untuk versi deskripsi proses CI / CD.  Saat memperbarui, semuanya tampak setransparan mungkin dan Anda dapat dengan mudah melacak riwayat perubahan dalam versi pipa jika Anda menggunakan versi semantik untuk tag. <br><br><h2>  Hubungkan .helm dari repositori terpisah </h2><br>  Karena layanan microser ini digunakan dan dijalankan dengan cara yang sama, set templat Helm yang sama diperlukan.  Untuk menghindari penyalinan direktori <code>.helm</code> antara repositori, kami biasa mengkloning repositori tempat templat Helm disimpan dan diperiksa pada tag yang diinginkan.  Itu terlihat seperti ini: <br><br><pre> <code class="bash hljs"> - git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://gitlab-ci-token:<span class="hljs-variable"><span class="hljs-variable">${CI_JOB_TOKEN}</span></span>@gitlab.example.com/infra/helm.git .helm - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .helm &amp;&amp; git checkout tags/1.0.0 - <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> multiwerf &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> &lt;(multiwerf use 1.0 beta) - <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> werf &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> &lt;(werf ci-env gitlab --tagging-strategy tag-or-branch --verbose) - werf deploy --stages-storage :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span></code> </pre> <br>  Ada juga variasi menggunakan submitules git, tetapi semuanya tampak lebih seperti solusi ... <br><br>  Dan sekarang dengan rilis werf baru-baru ini, ia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">memiliki kesempatan untuk</a> menghubungkan grafik dari repositori eksternal.  Dukungan penuh untuk fungsi-fungsi manajer paket, pada gilirannya, memungkinkan untuk menjelaskan dependensi untuk penyebaran aplikasi secara <i>transparan</i> . <br><br><h2>  Urutan tindakan </h2><br>  Mari kita kembali menyelesaikan masalah kita dengan layanan microser.  Mari tingkatkan repositori kami untuk menyimpan grafik Helm - misalnya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ChartMuseum</a> .  Itu mudah menyebar ke cluster Kubernetes: <br><br><pre> <code class="bash hljs">helm repo add stable https://kubernetes-charts.storage.googleapis.com helm install stable/chartmuseum --name flant-chartmuseum</code> </pre> <br>  Tambahkan masuk: <br><br><pre> <code class="plaintext hljs">apiVersion: extensions/v1beta1 kind: Ingress metadata: annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/force-ssl-redirect: "false" nginx.ingress.kubernetes.io/proxy-body-size: 10m nginx.ingress.kubernetes.io/ssl-redirect: "false" name: chart-museum spec: rules: - host: flant-chartmuseum.example.net http: paths: - backend: serviceName: flant-chartmuseum servicePort: 8080 path: / status: loadBalancer: {}</code> </pre> <br>  Penempatan <code>flant-chartmuseum</code> perlu mengubah variabel lingkungan <code>DISABLE_API</code> menjadi <code>false</code> .  Jika tidak (secara default), permintaan API ChartMuseum tidak akan berfungsi dan tidak mungkin membuat bagan baru. <br><br>  Sekarang kami menjelaskan repositori di mana grafik Helm bersama akan disimpan.  Struktur direktori-nya adalah sebagai berikut: <br><br><pre> <code class="plaintext hljs">. ├── charts │ └── yii2-microservice │ ├── Chart.yaml │ └── templates │ ├── app.yaml └── README.md</code> </pre> <br>  <code>Chart.yaml</code> mungkin terlihat seperti ini: <br><br><pre> <code class="plaintext hljs">name: yii2-microservice version: 1.0.4</code> </pre> <br>  Direktori <code>templates</code> harus berisi semua primitif Kubernetes yang diperlukan yang akan diperlukan untuk menyebarkan aplikasi ke cluster.  Seperti yang mungkin sudah Anda tebak, dalam hal ini, microservice adalah aplikasi PHP berdasarkan kerangka kerja yii2.  Mari kita jelaskan Penempatan minimalnya dengan dua kontainer nginx dan php-fpm yang dibangun menggunakan werf: <br><br><pre> <code class="plaintext hljs">--- apiVersion: apps/v1 kind: Deployment metadata: name: {{ .Values.global.werf.name }} spec: replicas: 1 revisionHistoryLimit: 3 template: metadata: labels: service: {{ .Values.global.werf.name }} spec: imagePullSecrets: - name: registrysecret containers: - name: backend {{ tuple "backend" . | include "werf_container_image" | indent 8 }} command: [ '/usr/sbin/php-fpm7', "-F" ] ports: - containerPort: 9000 protocol: TCP name: http env: {{ tuple "backend" . | include "werf_container_env" | indent 8 }} - name: frontend command: ['/usr/sbin/nginx'] {{ tuple "frontend" . | include "werf_container_image" | indent 8 }} ports: - containerPort: 80 name: http lifecycle: preStop: exec: command: ["/usr/sbin/nginx", "-s", "quit"] env: {{ tuple "frontend" . | include "werf_container_env" | indent 8 }} --- apiVersion: v1 kind: Service metadata: name: {{ .Values.global.werf.name }} spec: selector: service: {{ .Values.global.werf.name }} ports: - name: http port: 80 protocol: TCP</code> </pre> <br>  Variabel <code>.Values.global.werf.name</code> berisi nama proyek dari file <code>werf.yaml</code> , yang memungkinkan Anda mendapatkan nama layanan dan Penyebaran yang diperlukan. <br><br>  Mari kita buat otomatisasi paling sederhana untuk mendorong ChartMuseum dari grafik kita ketika berkomitmen ke cabang utama.  Untuk melakukan ini, kami jelaskan <code>.gitlab-ci.yml</code> : <br><br><pre> <code class="plaintext hljs">Build and push to chartmuseum: script: - for i in $(ls charts); do helm package "charts/$i"; done; - for i in $(find . -type f -name "*.tgz" -printf "%f\n"); do curl --data-binary "@$i" http://flant-chartmuseum.example.net/api/charts; done; stage: build environment: name: infra only: - master tags: - my-shell-runner-tag</code> </pre> <br>  Bagan diversi dengan mengubah <code>version</code> di <code>Chart.yaml</code> .  Semua grafik baru akan ditambahkan secara otomatis ke ChartMuseum. <br><br>  Kami pergi ke garis finish!  Dalam repositori proyek di <code>.helm/requirements.yaml</code> menulis dependensi untuk bagan: <br><br><pre> <code class="plaintext hljs">dependencies: - name: yii2-microservice version: "1.0.4" repository: "@flant"</code> </pre> <br>  ... dan jalankan di direktori dengan repositori: <br><br><pre> <code class="bash hljs">werf helm repo init werf helm repo add flant http://flant-chartmuseum.example.net werf helm dependency update</code> </pre> <br>  Kami <code>.helm/requirements.lock</code> di dalamnya. <code>.helm/requirements.lock</code> . Buka.  Sekarang, untuk menyebarkan aplikasi ke cluster, itu sudah cukup untuk menjalankan <code>werf helm dependency build</code> sebelum menjalankan <code>werf deploy</code> . <br><br>  Untuk memperbarui deskripsi penyebaran aplikasi, Anda sekarang harus melalui repositori dengan layanan microser dan menerapkan tambalan kecil dengan perubahan pada hash dan tag di <code>requirements.yaml</code> dan <code>requirements.lock</code> .  Jika diinginkan, operasi ini juga dapat diotomatisasi melalui CI: kami telah menjelaskan cara melakukan ini di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel yang disebutkan</a> . <br><br><h2>  Kesimpulan </h2><br>  Saya harap urutan tindakan yang dijelaskan untuk melayani aplikasi serupa akan bermanfaat bagi insinyur yang menghadapi masalah serupa.  Dan kami akan dengan senang hati membagikan resep praktis lainnya untuk menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">werf</a> .  Karena itu, jika Anda memiliki kesulitan yang tampaknya tidak dapat diatasi atau hanya tidak dapat diimplementasikan, jangan ragu untuk menghubungi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Telegram</a> atau meninggalkan permintaan untuk materi mendatang di sini di komentar. <br><br><h2>  PS </h2><br>  Baca juga di blog kami: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bangun proyek dengan GitLab CI: satu .gitlab-ci.yml untuk ratusan aplikasi</a> "; </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GitLab CI untuk integrasi dan pengiriman berkelanjutan dalam produksi.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 1: saluran pipa kami</a> ”; </li><li>  Serangkaian catatan tentang inovasi di werf: <br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Menggunakan werf untuk meluncurkan grafik Helm yang kompleks</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dukungan untuk monorepo dan multirepo di werf dan apa hubungannya dengan Docker Registry dengan itu</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sekarang kamu bisa membuat gambar Docker di werf menggunakan Dockerfile yang biasa</a> ." </li></ul></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id469541/">https://habr.com/ru/post/id469541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id469527/index.html">Apakah interkom itu mata-mata?</a></li>
<li><a href="../id469529/index.html">Render teks membenci Anda</a></li>
<li><a href="../id469531/index.html">“Membandingkan bahasa pemrograman dengan basis yang lebih baik-lebih buruk adalah pekerjaan yang benar-benar bodoh.”</a></li>
<li><a href="../id469533/index.html">Masalah dan ancaman identifikasi biometrik</a></li>
<li><a href="../id469537/index.html">Mengenal Swift dengan Snake</a></li>
<li><a href="../id469543/index.html">Redis Scaling dan Failover untuk Layanan DirectumRX</a></li>
<li><a href="../id469545/index.html">Apa yang Baru di Linux kernel 5.3 - Driver Grafik, Virtualisasi, dan Modifikasi di Subsistem Jaringan</a></li>
<li><a href="../id469549/index.html">Bagaimana kami melakukan tarif untuk Windows VPS untuk 99 rubel</a></li>
<li><a href="../id469551/index.html">VDS dengan kartu video - kami tahu banyak tentang penyimpangan</a></li>
<li><a href="../id469555/index.html">Siaran: Pertemuan Kubernet Moskow # 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>