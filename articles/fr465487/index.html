<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíô üë∑üèª ü§µüèø Cr√©ez une plateforme kubernetes sur Pinterest üòê üíè üßû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Au cours des ann√©es d'existence de Pinterest, 300 millions d'utilisateurs du service ont cr√©√© plus de 200 milliards de broches sur plus de 4 milliards...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ez une plateforme kubernetes sur Pinterest</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/465487/">  <i>Au cours des ann√©es d'existence de Pinterest, 300 millions d'utilisateurs du service ont cr√©√© plus de 200 milliards de broches sur plus de 4 milliards de cartes.</i>  <i>Pour servir cette arm√©e d'utilisateurs et une base de contenu √©tendue, le portail a d√©velopp√© des milliers de services, allant des microservices que plusieurs processeurs peuvent g√©rer, et se terminant par des monolithes g√©ants qui tournent sur toute une flotte de machines virtuelles.</i>  <i>Et puis le moment est venu o√π les yeux de la soci√©t√© sont tomb√©s sur les k8.</i>  <i>√Ä quoi ressemblait le "cube" en "Int√©r√™t"?</i>  <i>Vous en saurez plus √† ce sujet gr√¢ce √† notre traduction du dernier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article de blog sur l'ing√©nierie Pinterest</a> .</i> <br><br><img src="https://habrastorage.org/webt/ns/nd/tz/nsndtzsnqp6b0zn8ir1zrlzok28.png"><br><br>  Ainsi, des centaines de millions d'utilisateurs et des centaines de milliards de broches.  Pour servir cette arm√©e d'utilisateurs et une base de contenu √©tendue, nous avons d√©velopp√© des milliers de services, allant des microservices pouvant √™tre g√©r√©s par plusieurs CPU aux monolithes g√©ants qui tournent sur toute une flotte de machines virtuelles.  De plus, nous avons une vari√©t√© de frameworks qui peuvent √©galement n√©cessiter des ressources CPU, de la m√©moire ou un acc√®s aux E / S. <br><br>  √Ä l'appui de ce zoo d'outils, l'√©quipe de d√©veloppement fait face √† un certain nombre de d√©fis: <br><a name="habracut"></a><br><ul><li>  Les ing√©nieurs ne disposent pas d'un moyen unifi√© pour ex√©cuter un environnement de travail.  Les services apatrides, les services avec √©tat et les projets en d√©veloppement actif sont bas√©s sur des piles technologiques compl√®tement diff√©rentes.  Cela a conduit √† la cr√©ation d'une formation compl√®te pour les ing√©nieurs, et complique √©galement s√©rieusement le travail de notre √©quipe d'infrastructure. </li><li>  Les d√©veloppeurs disposant de leur propre parc de machines virtuelles cr√©ent une charge √©norme sur les administrateurs internes.  En cons√©quence, des op√©rations aussi simples que la mise √† jour du syst√®me d'exploitation ou de l'AMI durent des semaines et des mois.  Cela entra√Æne une augmentation de la charge de travail dans des situations apparemment absolument quotidiennes. </li><li>  Difficult√©s √† cr√©er des outils de gestion d'infrastructure globale en plus des solutions existantes.  La situation est compliqu√©e par le fait qu'il n'est pas facile de trouver les propri√©taires de machines virtuelles.  Autrement dit, nous ne savons pas s'il est s√ªr d'extraire ces capacit√©s pour travailler dans d'autres parties de notre infrastructure. </li></ul><br>  Les syst√®mes d'orchestration de conteneurs sont un moyen d'unifier la gestion de la charge de travail.  Ils vous permettent d'augmenter la vitesse de d√©veloppement et de simplifier la gestion de l'infrastructure, car toutes les ressources impliqu√©es dans le projet sont g√©r√©es par un syst√®me centralis√©. <br><br><img src="https://habrastorage.org/webt/6l/eq/7l/6leq7lajojjwmt1mg2hlobt4uce.png"><br><br>  <i>Figure 1: Priorit√©s de l'infrastructure (fiabilit√©, productivit√© des d√©veloppeurs et efficacit√©).</i> <br><br>  L'√©quipe de Cloud Management Platform sur Pinterest a rencontr√© K8 en 2017.  Au premier semestre 2017, nous avons document√© la plupart de nos installations de production, y compris l'API et tous nos serveurs Web.  Apr√®s cela, nous avons soigneusement √©valu√© les diff√©rents syst√®mes d'orchestration de solutions de conteneurs, en cr√©ant des clusters et en travaillant avec eux.  Fin 2017, nous avons d√©cid√© d'utiliser Kubernetes.  Il √©tait suffisamment flexible et largement pris en charge dans la communaut√© des d√©veloppeurs. <br><br>  Jusqu'√† pr√©sent, nous avons cr√©√© nos propres outils d'amor√ßage de cluster bas√©s sur Kops et migr√© vers les composants d'infrastructure existants de Kubernetes tels que le r√©seau, la s√©curit√©, les m√©triques, la journalisation, la gestion des identit√©s et le trafic.  Nous avons √©galement impl√©ment√© un syst√®me de mod√©lisation de la charge de travail pour notre ressource, dont la complexit√© est cach√©e aux d√©veloppeurs.  D√©sormais, nous nous concentrons sur la stabilit√© du cluster, son √©volutivit√© et la connexion de nouveaux clients. <br><br><h4>  Kubernetes: la mani√®re de Pinterest </h4><br>  D√©buter avec Kubernetes √† l'√©chelle Pinterest en tant que plate-forme que nos ing√©nieurs vont adorer est √©crasant. <br><br>  En tant que grande entreprise, nous avons investi massivement dans les outils d'infrastructure.  Les exemples incluent les outils de s√©curit√© qui traitent les certificats et distribuent les cl√©s, les composants de contr√¥le du trafic, les syst√®mes de d√©couverte de service, la visibilit√© et l'envoi de journaux et de m√©triques.  Tout cela a √©t√© collect√© pour une raison: nous avons suivi la voie normale des essais et erreurs, et nous avons donc voulu int√©grer toute cette √©conomie dans la nouvelle infrastructure de Kubernetes au lieu de r√©inventer l'ancien v√©lo sur une nouvelle plate-forme.  Cette approche a g√©n√©ralement simplifi√© la migration, car toute la prise en charge des applications existe d√©j√†, elle n'a pas besoin d'√™tre cr√©√©e √† partir de z√©ro. <br><br>  D'un autre c√¥t√©, les mod√®les de pr√©vision de charge dans Kubernetes lui-m√™me (par exemple, les d√©ploiements, les travaux et les kits Daemon) ne sont pas suffisants pour notre projet.  Ces probl√®mes d'utilisabilit√© sont d'√©normes obstacles au passage √† Kubernetes.  Par exemple, nous avons entendu des d√©veloppeurs de services se plaindre d'un param√®tre de connexion manquant ou incorrect.  Nous avons √©galement rencontr√© une mauvaise utilisation des moteurs de mod√®le lorsque des centaines de copies ont √©t√© cr√©√©es avec les m√™mes sp√©cifications et t√¢ches, ce qui a entra√Æn√© des probl√®mes de cauchemar avec le d√©bogage. <br><br>  Il √©tait √©galement tr√®s difficile de prendre en charge diff√©rentes versions dans le m√™me cluster.  Imaginez la complexit√© du support client si vous avez besoin de travailler imm√©diatement dans de nombreuses versions du m√™me runtime, avec tous leurs probl√®mes, bugs et mises √† jour. <br><br><h4>  Ressources et contr√¥leurs personnalis√©s Pinterest </h4><br>  Pour faciliter la mise en ≈ìuvre de Kubernetes pour nos ing√©nieurs, ainsi que pour simplifier et acc√©l√©rer l'infrastructure, nous avons d√©velopp√© nos propres d√©finitions de ressources personnalis√©es (CRD). <br><br>  Les CRD offrent les fonctionnalit√©s suivantes: <br><br><ol><li>  Combiner diverses ressources natives de Kubernetes pour les faire fonctionner en une seule charge.  Par exemple, la ressource PinterestService comprend un d√©ploiement, un service de connexion et une carte de configuration.  Cela permet aux d√©veloppeurs de ne pas se soucier de la configuration du DNS. </li><li>  Impl√©mentez le support d'application n√©cessaire.  L'utilisateur doit se concentrer uniquement sur la sp√©cification du conteneur en fonction de sa logique m√©tier, tandis que le contr√¥leur CRD impl√©mente tous les conteneurs d'initialisation, les variables d'environnement et les sp√©cifications de pod n√©cessaires.  Cela offre aux d√©veloppeurs un niveau de confort fondamentalement diff√©rent. </li><li>  Les contr√¥leurs CRD g√®rent √©galement le cycle de vie de leurs propres ressources et augmentent la disponibilit√© du d√©bogage.  Cela comprend l'accord sur les sp√©cifications souhait√©es et r√©elles, la mise √† jour de l'√©tat du CRD et la maintenance des journaux d'√©v√©nements et plus encore.  Sans CRD, les d√©veloppeurs seraient oblig√©s de g√©rer un large ensemble de ressources, ce qui ne ferait qu'augmenter la probabilit√© d'une erreur. </li></ol><br>  Voici un exemple de PinterestService et de la ressource interne contr√¥l√©e par notre contr√¥leur: <br><br><img src="https://habrastorage.org/webt/o8/nh/oh/o8nhohmr-jzi5lzoqpapflkbwdi.png"><br><br>  Comme vous pouvez le voir ci-dessus, pour prendre en charge un conteneur personnalis√©, nous devons int√©grer un conteneur d'initialisation et plusieurs modules compl√©mentaires pour garantir la s√©curit√©, la visibilit√© et travailler avec le trafic r√©seau.  De plus, nous avons cr√©√© des mod√®les de mappage de configuration et impl√©ment√© la prise en charge des mod√®les PVC pour les travaux par lots, ainsi que le suivi de diverses variables d'environnement pour suivre l'identification, la consommation des ressources et la collecte des ordures. <br><br>  Il est difficile d'imaginer que les d√©veloppeurs voudraient √©crire ces fichiers de configuration manuellement sans prise en charge de CRD, sans parler de la prise en charge et du d√©bogage suppl√©mentaires des configurations. <br><br><h4>  D√©ploiement d'applications de workflow </h4><br><img src="https://habrastorage.org/webt/ia/s1/ak/ias1akn3t5xtlubqimuo5apiaci.png"><br><br>  La figure ci-dessus montre comment d√©ployer une ressource personnalis√©e Pinterest dans un cluster Kubernetes: <br><br><ol><li>  Les d√©veloppeurs interagissent avec notre cluster Kubernetes via la CLI et l'interface utilisateur. </li><li>  Les outils CLI / UI extraient les fichiers YAML de configuration du workflow et d'autres propri√©t√©s d'assembly (m√™me identifiant de version) √† partir d'Artifactory, puis les envoient au Job Submission Service.  Cette √©tape garantit que seules les versions de production sont livr√©es au cluster. </li><li>  JSS est la passerelle vers diverses plates-formes, dont Kubernetes.  C'est l√† que l'authentification des utilisateurs, l'√©mission des quotas et la v√©rification partielle de notre configuration CRD ont lieu. </li><li>  Apr√®s avoir v√©rifi√© le CRD du c√¥t√© JSS, les informations sont envoy√©es √† l'API de la plate-forme k8s. </li><li>  Notre contr√¥leur CRD surveille les √©v√©nements sur toutes les ressources utilisateur.  Il convertit CR en ressources natives k8s, ajoute les modules n√©cessaires, d√©finit les variables d'environnement appropri√©es et effectue d'autres travaux auxiliaires, ce qui garantit aux applications utilisateur des conteneurs un support d'infrastructure suffisant. </li><li>  Ensuite, le contr√¥leur CRD transf√®re les donn√©es re√ßues √† l'API Kubernetes afin qu'elles soient trait√©es par l'ordonnanceur et mises en service. </li></ol><br>  <b>Remarque</b> : ce d√©ploiement de workflow pr√©-version a √©t√© cr√©√© pour les premiers utilisateurs de la nouvelle plate-forme k8s.  Nous sommes maintenant en train de finaliser ce processus afin de nous int√©grer pleinement √† notre nouveau CI / CD.  Cela signifie que nous ne pouvons pas tout dire sur Kubernetes.  Nous avons h√¢te de partager notre exp√©rience et de parler √† l'√©quipe de ces progr√®s dans notre prochain article de blog ¬´Construire une plateforme CI / CD pour Pinterest¬ª. <br><br><h4>  Types de ressources sp√©ciales </h4><br>  Sur la base des besoins sp√©cifiques de Pinterest, nous avons d√©velopp√© les CRD suivants qui conviennent √† une vari√©t√© de flux de travail: <br><br><ul><li>  PinterestService est un service sans √©tat de longue dur√©e.  Beaucoup de nos principaux syst√®mes sont bas√©s sur un ensemble de ces services. </li><li>  PinterestJobSet mod√©lise les travaux par lots √† cycle complet.  Pinterest a un sc√©nario commun, selon lequel plusieurs t√¢ches ex√©cutent les m√™mes conteneurs en parall√®le, et ind√©pendamment d'autres processus similaires. </li><li>  PinterestCronJob est largement utilis√© en conjonction avec de petites charges p√©riodiques.  Il s'agit d'un shell natif cron avec des m√©canismes de support Pinterest qui sont responsables de la s√©curit√©, du trafic, des journaux et des m√©triques. </li><li>  PinterestDaemon comprend l'infrastructure de Daemon.  Cette famille continue de cro√Ætre √† mesure que nous ajoutons davantage de soutien √† nos grappes. </li><li>  PinterestTrainingJob s'√©tend aux processus Tensorflow et Pytorch, offrant le m√™me niveau de support en ligne que tous les autres CRD.  Puisque Pinterest utilise activement Tensorflow et d'autres syst√®mes d'apprentissage automatique, nous avions une raison de construire un CRD distinct autour d'eux. </li></ul><br>  Nous travaillons √©galement sur PinterestStatefulSet, qui sera bient√¥t adapt√© pour les entrep√¥ts de donn√©es et autres syst√®mes avec √©tat. <br><br><h4>  Prise en charge du runtime </h4><br>  Lorsque le module d'application s'ex√©cute dans Kubernetes, il re√ßoit automatiquement un certificat pour s'identifier.  Ce certificat est utilis√© pour acc√©der au magasin secret ou pour communiquer avec d'autres services via mTLS.  Pendant ce temps, le configurateur d'initialisation de conteneur et Daemon t√©l√©chargeront toutes les d√©pendances n√©cessaires avant de lancer l'application conteneur.  Lorsque tout est pr√™t, le trafic sidecar et Daemon enregistrent l'adresse IP du module dans notre Zookeeper afin que les clients puissent la trouver.  Tout cela fonctionnera, car le module r√©seau a √©t√© configur√© avant le lancement de l'application. <br><br>  Voici des exemples typiques de prise en charge de la charge de travail au moment de l'ex√©cution.  Pour d'autres types de charges de travail, une prise en charge l√©g√®rement diff√©rente peut √™tre requise, mais elles sont toutes pr√©sent√©es comme des machines virtuelles de niveau pod sidecar, nodal ou Daemon.  Nous veillons √† ce que tout cela soit d√©ploy√© dans le cadre de l'infrastructure de gestion et coordonn√© entre les applications, ce qui en fin de compte r√©duit consid√©rablement la charge en termes de travail technique et de support client. <br><br><h4>  Tests et assurance qualit√© </h4><br>  Nous avons mis en place un pipeline de test de bout en bout au-dessus de l'infrastructure de test Kubernetes existante.  Ces tests s'appliquent √† tous nos clusters.  Notre pipeline a subi de nombreux changements avant de faire partie du cluster de produits. <br><br>  En plus de tester les syst√®mes, nous avons des syst√®mes de surveillance et d'alerte qui surveillent en permanence l'√©tat des composants du syst√®me, la consommation des ressources et d'autres indicateurs importants, nous informant uniquement lorsque l'intervention humaine est n√©cessaire. <br><br><h4>  Alternatives </h4><br>  Nous avons examin√© quelques alternatives aux ressources personnalis√©es, telles que les contr√¥leurs d'acc√®s mutationnels et les syst√®mes de mod√®les.  Cependant, tous sont confront√©s √† de graves difficult√©s de travail, nous avons donc choisi la voie de la CRD. <br><br>  Un contr√¥leur de tol√©rance aux mutations a √©t√© utilis√© pour saisir des side-cars, une variable d'environnement et d'autres supports d'ex√©cution.  N√©anmoins, il a √©t√© confront√© √† divers probl√®mes, par exemple avec la liaison des ressources et la gestion de leur cycle de vie, lorsque ces probl√®mes ne se posent pas dans CRD. <br><br>  <b>Remarque:</b> Les syst√®mes de mod√®les tels que les diagrammes de Helm sont √©galement largement utilis√©s pour ex√©cuter des applications avec des configurations similaires.  Cependant, nos applications de production sont trop diverses pour les g√©rer avec des mod√®les.  De plus, lors d'un d√©ploiement continu, l'utilisation de mod√®les g√©n√©rera trop d'erreurs. <br><br><h4>  Travaux futurs </h4><br>  Nous avons maintenant affaire √† une charge mixte sur tous nos clusters.  Pour prendre en charge des processus similaires de diff√©rents types et tailles, nous travaillons dans les domaines suivants: <br><br><ul><li>  Un cluster de clusters distribue des applications volumineuses sur plusieurs clusters pour offrir √©volutivit√© et stabilit√©. </li><li>  Assurer la stabilit√©, l'√©volutivit√© et la visibilit√© du cluster pour cr√©er la connexion de l'application et de son SLA. </li><li>  Gestion des ressources et des quotas afin que les applications n'entrent pas en conflit et que l'√©chelle du cluster soit contr√¥l√©e par nous. </li><li>  Nouvelle plateforme CI / CD pour la prise en charge et le d√©ploiement d'applications dans Kubernetes. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465487/">https://habr.com/ru/post/fr465487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465475/index.html">Mini-interview avec Oleg Anastasiev: tol√©rance aux fautes dans Apache Cassandra</a></li>
<li><a href="../fr465477/index.html">Comment j'ai appris √† un serpent √† se jouer avec Q-Network</a></li>
<li><a href="../fr465479/index.html">Pixel Lo-fi dans Unity</a></li>
<li><a href="../fr465483/index.html">Antiquit√©s: Windows 3.1 et la vie sans bouton de d√©marrage</a></li>
<li><a href="../fr465485/index.html">Imprimez la tapisserie Game of Thrones sur une imprimante fiscale √† l'aide de Python</a></li>
<li><a href="../fr465489/index.html">Liste de contr√¥le de la pr√©paration √† la production</a></li>
<li><a href="../fr465491/index.html">Zabbix + Voximplant: surveillance avec appels, ou comment arr√™ter de s'inqui√©ter et le configurer rapidement</a></li>
<li><a href="../fr465493/index.html">Langage de programmation rapide sur Raspberry Pi</a></li>
<li><a href="../fr465495/index.html">Comment ne pas perdre de trafic lors du passage √† un nouveau domaine: cas "Vse10"</a></li>
<li><a href="../fr465497/index.html">Messagerie secr√®te via les journaux du serveur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>