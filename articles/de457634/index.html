<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤦🏾 👩🏾‍🎤 🤦 DDS-Synthesizer auf Verilog ✈️ 👨‍🏭 ⏲️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Beitrag werde ich erzählen, wie ich das Schreiben eines DDS-Synthesizers auf Verilog verstanden habe. Es wird verwendet, um eine sinusförmig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DDS-Synthesizer auf Verilog</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457634/"><p><img src="https://habrastorage.org/webt/9a/zg/qs/9azgqsahwpzig90y6b8xbulgz9s.png"></p><br><p>  In diesem Beitrag werde ich erzählen, wie ich das Schreiben eines DDS-Synthesizers auf Verilog verstanden habe.  Es wird verwendet, um eine sinusförmige Schwingung zu erzeugen, deren Frequenz und Anfangsphase für die Verwendung mit einem unipolaren 8-Bit-DAC eingestellt und berechnet werden können.  Wie der Synthesizer funktioniert, ist in einem Artikel in der Zeitschrift <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Components and Technologies gut beschrieben</a> .  Um die Menge des verwendeten Speichers der Sinustabelle zu reduzieren, wird Symmetrie verwendet. </p><a name="habracut"></a><br><p> Für die Kompilierung unter Linux habe ich Iverilog und für die Anzeige von GTKWave verwendet.  Der Einfachheit halber wurde ein einfaches Makefile geschrieben, vielleicht ist es für jemanden nützlich.  Mit dem iverilog-Compiler erhalten wir zunächst die Datei tb.out und senden sie dann an den vvp-Simulator, der mit iverilog installiert ist.  Infolgedessen generiert vvp out.vcd, das alle im Projekt verwendeten Variablen (Signale) enthält.  Das Anzeigeziel startet zusätzlich zu den oben genannten GTKWave mit einer variablen Datei und Sie können die Wellenformen der Signale sehen. </p><br><pre><code class="plaintext hljs">SRC = nco.v TB = nco_tb.v all: iverilog -o tb.out $(TB) vvp -lxt tb.out check: iverilog -v $(TB) display: iverilog -o tb.out $(TB) vvp -lxt tb.out gtkwave out.vcd &amp; clean: rm -rf *.out *.vcd *.vvp</code> </pre> <br><p>  Zunächst müssen Sie eine Tabelle des zukünftigen Sinus im Speicher ablegen, da ich ein einfaches Python-Skript geschrieben habe, das ein Viertel der Sinusperiode in 64 Punkte aufteilt und in einem Format generiert, das dann in den Quellcode kopiert werden kann.  Da ich die Implementierung von DDS für einen externen unipolaren DAC mit einer Bitkapazität von nicht mehr als 8 Bit konzipiert habe, sollte die Sinusamplitude im Bereich von 0 bis 256 liegen, wobei die negative Halbperiode im Bereich von 0 ... 127 und die positive Hälfte in 128 ... 255 liegt .  In dieser Hinsicht werden die erhaltenen Sinuswerte (von 0 bis pi / 4) mit 127 multipliziert und dann mit 127 addiert. Als Ergebnis werden die Werte des ersten Viertels der Periode erhalten, deren Amplitude 128 ... 256 beträgt. </p><br><p>  Ich mache darauf aufmerksam, dass bei dieser Formation der Sinus am Ausgang des DAC eine konstante Komponente hat.  Um es zu entfernen, muss es durch einen Kondensator geführt werden. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np x=np.linspace(<span class="hljs-number"><span class="hljs-number">0</span></span>,np.pi/<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">64</span></span>) print(np.sin(x)) y=<span class="hljs-number"><span class="hljs-number">127</span></span>*np.sin(x) print(len(y)) print(y) z=[] i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> elem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> y: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> int(elem)&lt;=<span class="hljs-number"><span class="hljs-number">16</span></span>: print(<span class="hljs-string"><span class="hljs-string">"lut[%d] = 7'h0%X;"</span></span> % (i, int(elem))) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(<span class="hljs-string"><span class="hljs-string">"lut[%d] = 7'h%X;"</span></span> % (i, int(elem))) z.append(hex(int(elem))) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Da die Sinusfunktion symmetrisch (ungerade) ist, können Sie die erste Symmetrie sin (x) = - sin (pi + x) finden.  Die zweite Symmetrie ist durch die Tatsache gekennzeichnet, dass mit einer Tabelle für ein Viertel des Zeitraums das zweite Viertel erhalten werden kann, indem die Tabelle in umgekehrter Reihenfolge durchlaufen wird (da der Sinus in der Halbperiode zuerst zunimmt und dann abnimmt). </p><br><h4 id="formiruem-sinus">  Wir bilden einen Sinus </h4><br><p>  Der Großteil des DDS-Synthesizers ist eine Phasenbatterie.  Im Wesentlichen ist dies der Index eines Elements aus der Nachschlagetabelle (LUT).  Für jede Periode des Taktsignals erhöht sich der Wert darin um einen bestimmten Wert, wodurch ein Sinus am Ausgang erhalten wird.  Die Frequenz des Ausgangssignals hängt vom Wert des Inkrements des Phasenakkumulators ab - je größer es ist, desto höher ist die Frequenz.  Gemäß dem Kotelnikov-Kriterium sollte die Abtastfrequenz jedoch mindestens das Zweifache der Signalfrequenz betragen (um den Effekt der Überlagerung des Spektrums zu vermeiden), daher beträgt die Begrenzung des maximalen Inkrements die Hälfte des Phasenspeichers.  Im Allgemeinen ist das technische Kriterium die Abtastfrequenz = 2,2 der Signalfrequenz. Nachdem ich mich entschlossen hatte, sie nicht auf das Äußerste zu bringen, entfernte ich ein weiteres Bit und ließ 6 Bit mit einer 8-Bit-Phasenbatterie inkrementiert (obwohl der Sinus-Jackalit bereits vorhanden ist). </p><br><p>  Aufgrund der verwendeten Symmetrie werden nur die unteren 6 Bits von 2 ^ 6 = 64 direkt für die Indexabtastung verwendet.  Die hohen 2 Bits werden verwendet, um eine Viertelperiode der Sinuserzeugung zu identifizieren und dementsprechend die Richtung der Tabellenüberquerung zu ändern.  Sie sollten etwas Ähnliches bekommen wie: </p><br><pre> <code class="plaintext hljs">module nco(clk, rst, out ); input clk, rst; output reg [7:0] out; reg [5:0] phase_inc = 6'h1; reg [7:0] phase_acc = 0; parameter LUT_SIZE = 64; reg [6:0] lut [0:LUT_SIZE-1]; always @(posedge clk) begin if (rst) begin phase_inc = 6'h1; phase_acc = 0; out = 0; lut[0] = 7'h00; //     lut[63] = 7'h7F; end else begin //      1    if (phase_acc[7:6] == 2'b00) begin //        LUT out &lt;= {1'b1,lut[phase_acc[5:0]]}; end if (phase_acc[7:6] == 2'b01) begin out &lt;= {1'b1,lut[~phase_acc[5:0]]}; end if (phase_acc[7:6] == 2'b10) begin out &lt;= {1'b0,~lut[phase_acc[5:0]]}; end if (phase_acc[7:6] == 2'b11) begin out &lt;= {1'b0,~lut[~phase_acc[5:0]]}; end phase_acc &lt;= phase_acc + {2'b0,phase_inc}; end end endmodule</code> </pre> <br><p>  Beim Zurücksetzen initialisieren wir alles mit Nullen, bis auf den Phaseninkrementwert setzen wir ihn auf Eins.  Um die Synthetisierbarkeit des Codes zu erhalten, wird die Tabelle während des Zurücksetzens auch mit Werten gefüllt.  In einem realen Projekt ist es ratsam, den im FPGA integrierten Blockspeicher für solche Zwecke zu verwenden, eine separate Konfigurationsdatei dafür zu erstellen und den IP-Core im Projekt selbst zu verwenden. </p><br><p>  Eine kleine Erklärung, wie Symmetrie funktioniert.  Bei jedem Zyklus wird geprüft (auf den 2 höchstwertigen Bits), in welchem ​​Viertel sich der Phasenspeicher gerade befindet.  Wenn der höchste Wert = 00 ist, ist der Ausgang in der höchsten Ziffer 1 (verantwortlich für die positive Halbwelle), in den unteren Ziffern der Wert aus der LUT gemäß dem Index.  Nachdem der Wert des Phasenakkumulators 63 überschreitet (das erste Quartal vergeht), erscheint 01 in den hohen Bits und die unteren werden wieder mit Nullen gefüllt. </p><br><p>  Um die LUT in umgekehrter Reihenfolge zu übergeben, reicht es aus, die niedrigstwertigen Bits des Phasenakkumulators zu invertieren (sie steigt mit jedem Taktzyklus weiter an und ihr invertierter Wert nimmt ab). </p><br><p>  Um eine negative Halbwelle zu bilden, schreiben wir 0. Im oberen Bit der Ausgabe müssen wir nun den Wert selbst aus der Sinustabelle invertieren.  Der Punkt hier ist, dass Sie eine Spiegelkopie des Sinusviertels benötigen. Wenn dies nicht erfolgt, erhalten Sie das gleiche Bild wie im ersten Quartal, jedoch um 127 nach unten abgesenkt.  Sie können dies überprüfen, indem Sie die Umkehrung im Code entfernen. </p><br><h4 id="menyaem-chastotu-i-nachalnuyu-fazu">  Wir ändern die Frequenz und die Anfangsphase </h4><br><p>  Wie bereits oben beschrieben, ist es zum Ändern der Frequenz erforderlich, den Wert des Phaseninkrements zu ändern.  Neue Eingaben werden angezeigt: </p><br><pre> <code class="plaintext hljs">input [5:0] freq_res; input [7:0] phase;</code> </pre> <br><p>  Um den Wert des Phaseninkrements zu ändern, fangen wir ihn einfach bei jedem Zyklus ein: </p><br><pre> <code class="plaintext hljs">always @(posedge clk) begin if (rst) begin //... end else begin //... phase_inc &lt;= freq_res; end end</code> </pre> <br><p>  In der Anfangsphase ist nicht alles so einfach.  Sie müssen es zuerst in das Zwischenregister schreiben und den Phasenakkumulator nur dann mit diesem Wert füllen, wenn der Wert der Anfangsphase am Eingang nicht mit dem zuvor gespeicherten übereinstimmt.  Dies wirft einen weiteren wichtigen Punkt in Bezug auf den Stand der Rennen auf.  Wir haben bereits eine Stelle, an der wir <code>phase_acc</code> in das Register schreiben.  Sie können nicht gleichzeitig an mehreren Stellen aufnehmen, da die zuerst eingehenden Daten aufgezeichnet werden.  Daher sieht das Design folgendermaßen aus: </p><br><pre> <code class="plaintext hljs">reg change_phase = 0; //     //     (  ) //     : prev_phase &lt;= phase; if (phase != prev_phase) begin //       change_phase &lt;= 1'b1; end if (change_phase) begin //        phase_acc &lt;= prev_phase; change_phase &lt;= 1'b0; end else begin //           phase_acc &lt;= phase_acc + {2'b0,phase_inc}; end</code> </pre> <br><h4 id="testbench">  Testbench </h4><br><p>  Der Testbench-Code für Iverilog und GTKWave enthält einige Designs (mit einem Dollarzeichen), die in der üblichen ISE Design Suite oder Quartus nicht verwendet werden.  Ihre Bedeutung besteht darin, überwachte Signale auszuwählen und in eine Datei zu laden, damit sie dann in den Simulator übertragen werden können.  Die Arbeit des Prüfstands selbst ist trivial - wir führen einen Reset durch, stellen die Frequenz / Anfangsphase ein und warten eine Weile. </p><br><pre> <code class="plaintext hljs">`include "nco.v" `timescale 1ns / 1ps module nco_tb; reg clk = 0, rst = 0; reg [7:0] phase = 0; reg [5:0] freq_res; wire [7:0] out; nco nco_inst ( .clk(clk), .rst(rst), .phase(phase), .freq_res(freq_res), .out(out) ); always #2 clk &lt;= ~clk; initial begin $dumpfile("out.vcd"); $dumpvars(0, nco_tb); //$monitor("time =%4d out=%h",$time,out); rst = 1'b1; freq_res = 1; #8 rst = 1'b0; #300 phase = 8'b00100011; #300 phase = 8'b00001111; #1200 freq_res = 6'b111101; #1200 freq_res = 6'b001111; #1200 freq_res = 6'b011111; #400 phase = 8'b00010011; #1200 $finish; end endmodule</code> </pre> <br><h4 id="vremennye-diagrammy">  Zeitdiagramme </h4><br><p>  Am Ausgang erhalten wir etwas Ähnliches wie einen Sinus mit einer sich ändernden Frequenz und Anfangsphase zu den in der Testbench festgelegten Zeitpunkten.  Es ist anzumerken, dass mit zunehmender Frequenz die Auflösung entlang (die Anzahl der Abtastwerte pro Periode) abnimmt, die Synthesizer-Taktfrequenz und ihre LUT-Größe eine entscheidende Rolle bei der Reproduktion des reinen Sinus spielen (je mehr sich seine Form dem Ideal nähert, desto weniger Nebenkomponenten im Spektrum des Ergebnisses Signal und die Spitze wird bereits auf der erzeugten Frequenz sein). </p><br><p><img src="https://habrastorage.org/webt/zk/ws/zg/zkwszgjj7dw89xqygjhcc8uhzoc.png"></p><br><p>  Es ist zu erkennen, dass ein Signal mit einer zweiten Frequenz bereits keinen so glatten Sinus aufweist wie die anderen.  Schauen wir uns das genauer an. </p><br><p><img src="https://habrastorage.org/webt/ni/ja/cd/nijacdynrfxbcbq-xjxbmbjtqbe.png"></p><br><p>  Es ist zu sehen, dass dies dem Sinus immer noch ein bisschen ähnlich ist. Das Ergebnis wird sogar noch besser, wenn ein solches Signal durch ein Anti-Aliasing-Filter (Tiefpassfilter) geleitet wird. </p><br><p>  Projektquellen finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </p><br><h4 id="istochniki">  Quellen </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Funktionsweise des DDS-Synthesizers</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Icarus Verilog Website</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de457634/">https://habr.com/ru/post/de457634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de457624/index.html">Wie wir die alte Hütte zerbrochen und an ihrer Stelle einen Wolkenkratzer gebaut haben</a></li>
<li><a href="../de457626/index.html">Überarbeitung der Benutzerzugriffsebenen mithilfe von Power BI am Beispiel von Bitrix CMS (BUS)</a></li>
<li><a href="../de457628/index.html">Effektives P2M-Programm- und Projektmanagement</a></li>
<li><a href="../de457630/index.html">Erfahrung in der Entwicklung von Anforderungen an professionelle Datenwissenschaftler</a></li>
<li><a href="../de457632/index.html">Was kosten Unit-Tests?</a></li>
<li><a href="../de457638/index.html">Fang mich, wenn du kannst. Prophetenversion</a></li>
<li><a href="../de457640/index.html">Worauf verlassen sich Datenschutzfachleute? Bericht vom Internationalen Kongress für Cybersicherheit</a></li>
<li><a href="../de457646/index.html">Über die Antilope in einer Gasmaske und rosa Salzseen</a></li>
<li><a href="../de457652/index.html">So organisieren Sie 120.000 Fotos, damit das Team keine Tryndets mit unterschiedlichen Zugriffsebenen erhält</a></li>
<li><a href="../de457658/index.html">Union MS-11: Ein Unfall, den es nicht gab?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>