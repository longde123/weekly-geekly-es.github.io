<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🤝‍👩🏼 🤲🏻 🧘🏽 在unRAID上配置家用路由器+ NAS（第2部分） 👆🏿 👨🏻‍🏭 🧚🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在第一部分中，我简要介绍了程序集本身，它使您可以制造一台可以在其上运行unRAID的计算机，以在KVM虚拟机中创建NAS和MikroTik RouterOS，以代替常规路由器。 


 这些评论原来是非常有用的讨论，其结果需要纠正初始汇编中的错误并编写第三部分！ 我会尝试一些关于自己的建议，希望，我...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在unRAID上配置家用路由器+ NAS（第2部分）</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478924/"><p> 在<a href="https://habr.com/ru/post/477810/">第一部分中，</a>我简要介绍了程序集本身，它使您可以制造一台可以在其上运行unRAID的计算机，以在KVM虚拟机中创建NAS和MikroTik RouterOS，以代替常规路由器。 </p><br><p> 这些评论原来是非常有用的讨论，其结果需要纠正初始汇编中的错误并编写第三部分！ 我会尝试一些关于自己的建议，希望，我会写第三部分。 <a name="habracut"></a></p><br><p> 对于初始安装，您将必须将监视器，键盘和鼠标连接到服务器。 </p><br><h1 id="ustanovka-unraid"> 安装unRAID </h1><br><p> 我们去<a href="https://unraid.net/download">站点</a>并在USB记忆棒上安装了unRAID（我忘了添加到表中）。 闪存驱动器的建议是标准的：正常品牌和更大的物理尺寸（以便更好地冷却）。  UnRAID将从该闪存驱动器启动，因此您的SSD将完全没有缓存。 更多官方信息<a href="https://unraid.net/blog/unraid-new-users-blog-series">在这里</a> 。 </p><br><p> 不要忘记在BIOS中包含VT-d和VT-x支持！ </p><br><p> 我们将USB闪存驱动器连接到服务器并以GUI模式运行它。 </p><br><p> 默认用户名和密码：root，无密码。 </p><br><p> 撰写本文时的版本：6.7.2 </p><br><p> 启动操作系统后，请确保检测到所有已连接的硬件。 系统应该可以看到所有磁盘（磁盘显示在“主”选项卡上），两个以太网控制器和一个Wi-Fi卡（在“工具”-&gt;“系统设备”中可以很方便地看到）。 </p><br><h2 id="problema-s-sata-kontrollerami-marvell">  Marvell SATA控制器出现问题 </h2><br><p> 由于Marvell控制器驱动程序中的某种错误， <a href="https://forums.unraid.net/topic/39003-marvell-disk-controller-chipsets-and-virtualization/">在unRAID版本6.7.x中启用VT-d后</a> ，它们<a href="https://forums.unraid.net/topic/39003-marvell-disk-controller-chipsets-and-virtualization/">将无法工作。</a> </p><br><p>我选择了最简单的解决方案：在引导时将<code>iommu=pt</code>添加到传递给Linux内核的参数字符串中。 这是在“主要”选项卡上完成的（然后单击“ Flash”设备）。 另外，您最初可以更改USB闪存驱动器上的配置： <code>boot/syslinux/syslinux.cfg</code> </p><br><p><img src="https://habrastorage.org/webt/xb/nn/_5/xbnn_5pwv-hu_sk7vz2attdinby.png"><br></p><br><h2 id="pro-intel-vpro"> 关于英特尔博锐 </h2><br><p> 我不建议您寻找支持vPro / AMT的硬件。 </p><br><p> 首先，为使远程桌面正常工作，您需要连接HDMI虚拟或DP虚拟插头，否则，如果没有连接显示器，集成视频卡将不会初始化。 </p><br><p> 其次，英特尔客户端软件的质量非常低。 </p><br><p> 第三，通过无线或有线HDMI / DP扩展电缆，您将获得与家庭使用相同的功能，同时，您在选择熨斗方面也不会受到任何限制。 </p><br><h1 id="nastroyka-seti"> 网络设置 </h1><br><p> 转到设置-&gt;网络设置。 您可能已经猜到了，其中一个接口将查看本地网络，第二个接口将查看Internet。 首先，请确定将哪个连接到您的本地网络。 连接器的主板上有带有MAC地址的贴纸，这就是我了解谁的身份。 </p><br><p> 简而言之，您需要做的是：将每个接口分配为两个单独的L2桥接器的成员，并在连接到本地网络的那个上设置一个静态IP地址。 看起来像Internet的界面上不需要IP地址； RouterOS会处理它。 </p><br><p> 这是您应该得到的： </p><br><p><img src="https://habrastorage.org/webt/nq/pk/w8/nqpkw81agb_xrso5bl2mt0gqemm.png"><br></p><br><ul><li>  192.168.1.2-可以使用unRAID的地址 </li><li>  192.168.0.1-RouterOS地址 </li><li>  192.168.1.3-pi.hole DNS服务器的地址 </li></ul><br><p> 您可以通过DHCP为eth0保留地址分配，但是对于RouterOS中的任何问题，我们将无法访问unRAID，并且需要将显示器和键盘连接到服务器。 </p><br><p> 设置网络后，可以通过手动设置LAN客户端的IP地址进行远程配置。 </p><br><h1 id="nastroyka-hranilischa"> 存储设置 </h1><br><p> 要启动虚拟机，您需要存储，因此是时候对其进行配置了。 我将不做详细描述，因为它很简单：您需要为硬盘驱动器分配角色-一个磁盘1，另一个-奇偶校验。 </p><br><p> 在第一部分中，我写道，一个SSD足够了，但实际上并非如此：最好取两个相同的SSD并从它们中创建一个缓存池，这样，如果一个SSD出现故障，它们将受到保护。 此外，在unRAID中，没有机制可以从缓存中备份数据。  <a href="https://wiki.unraid.net/UnRAID_6/Storage_Management">此处</a>将详细介绍所有内容。 </p><br><p> 结果应该是这样的（抱歉，我还没有购买第二个SSD）： </p><br><p><img src="https://habrastorage.org/webt/qo/i7/mj/qoi7mjp4ca7nzeapkk7nq8c2_ka.png"><br></p><br><p> 另外，您可以立即配置用于从缓存中进行奇偶校验和数据传输的计划。 这是在“设置”-&gt;“调度程序”页面上完成的。 </p><br><p> 每两个月检查一次奇偶校验，并每天晚上从缓存中传输数据就足够了。 </p><br><p> 您可以在“共享”选项卡中立即配置网络上可用的资源： </p><br><p><img src="https://habrastorage.org/webt/zp/bc/bs/zpbcbsvdcwhkzixxvamdo2fuk-c.png"><br></p><br><p> 由于我只有一个磁盘用于缓存，因此域不受保护。 一切对您来说都是绿色的。 </p><br><h1 id="ustanavlivaem-routeros"> 安装RouterOS </h1><br><p> 首先，您需要<a href="https://mikrotik.com/download">从此处</a>下载安装iso映像（选择x86稳定CD映像）并将其放在<code>\\Tower\isos</code> 。 </p><br><p> 现在是时候创建一个虚拟机了。 </p><br><p> 在设置-&gt; VM Manager中启用支持。 之后，将出现一个新选项卡-VMs，转到它。 </p><br><p> 单击添加虚拟机，然后单击Linux。 </p><br><ul><li> 仅选择一个核心 </li><li> 分配128或256 MB的内存就足够了 </li><li> 机器<code>i440fx-3.1</code> </li><li>  BIOS- <code>SeaBIOS</code> </li><li> 在OS Install ISO中，选择下载的映像（ <code>/mnt/user/isos/mikrotik-6.46.iso</code> ） </li><li> 主虚拟磁盘大小-256M </li><li> 主虚拟磁盘总线<code>SATA</code> </li><li> 网桥-br0 </li><li> 添加第二个网络接口并选择br1 </li><li> 如果您的Wi-Fi卡未在“其他PCI设备”中显示，则可以-如果配置中有句柄，我们将在其中进行写操作，请选中该框 </li><li> 现在，取消选中创建后启动虚拟机，然后单击创建。 </li></ul><br><p> 记住哪些接口将接收哪些MAC地址，以便在RouterOS中进一步匹配它们。 </p><br><p> 由于某些原因，为不同的VM进行自动端口分配对我而言并不总是可以正常工作，因此请打开生成的XML配置，并使用VNC设置更正以下内容： </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphics</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'vnc'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'5900'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autoport</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'no'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">websocket</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'5700'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">listen</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0.0.0.0'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keymap</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'en-us'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">listen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'address'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0.0.0.0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphics</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> 如果您像我一样，在其他PCI设备中没有Wi-Fi适配器，请手动输入。 为此，请在PCI总线上找到其地址。 最简单的方法是在“工具”-&gt;“系统设备”中，出现以下一行： </p><br><pre> <code class="plaintext hljs">IOMMU group 23: [168c:003c] 0b:00.0 Network controller: Qualcomm Atheros QCA986x/988x 802.11ac Wireless Network Adapter</code> </pre> <br><p> 在我的情况下变成： </p><br><p><img src="https://habrastorage.org/webt/pz/qq/yr/pzqqyrvq5k98ile1g9piyh7hkqm.png"><br>  <em>（对不起，huber的MD解析器在这段代码中有点不正确，我不得不插入一张图片）</em> </p><br><p> 您可以启动VM并通过VNC连接到它。 安装RouterOS非常容易！ 邀请选择软件包之后，最简单的方法是使用<code>a</code>键选择所有内容，然后使用<code>i</code>键结束安装，这是拒绝保存旧配置并同意磁盘格式化的。 </p><br><p><img src="https://habrastorage.org/webt/vh/yj/fc/vhyjfcub_t55sxrktpbxikod4jg.png"><br></p><br><p> 重新启动后，输入admin作为登录名，密码为空。 </p><br><p> 键入<code>/interface print</code> ，并确保系统可以看到您的所有三个网络接口（我从一个已配置的系统中截取了屏幕快照，该系统的名称与默认名称不同）： </p><br><p><img src="https://habrastorage.org/webt/2_/7b/0r/2_7b0rs7cntf2nj4es3mkllo94u.png"><br></p><br><p> 在此阶段，您可以下载<a href="https://mikrotik.com/download">winbox</a> ，通过MAC地址连接到RouterOS并通过GUI执行进一步的配置。 </p><br><p> 我认为，RouterOS的详细配置超出了本文的范围，尤其是Internet上有很多手册，因此，我建议您从标准的快速安装开始： </p><br><p><img src="https://habrastorage.org/webt/ei/hh/am/eihhamb8bae39pjaiaymasusi8i.png"><br></p><br><p> 您可以使用Internet将电缆连接到空闲端口，并切换LAN客户端以自动获取IP地址，还可以检查Wi-Fi功能。 确保一切正常后，您可以购买并输入RouterOS许可证密钥。 </p><br><h1 id="dobavlenie-vm-s-linux"> 使用Linux添加虚拟机 </h1><br><p> 要在更熟悉的环境中工作，请创建另一个虚拟机，我们将在该虚拟机上运行您喜欢的％distro_name％ </p><br><p> 仍然下载ISO映像并将其放入<code>isos</code> </p><br><p> 转到已经熟悉的标签VM，然后单击Add VM，现在可以将绝大多数设置保留为默认设置。 </p><br><ul><li>  BIOS- <code>SeaBIOS</code> </li><li> 在OS Install ISO中，选择下载的映像 </li><li> 主虚拟磁盘大小-大约10-20 GB </li><li>  Unraid Share-要用于VM的目录的路径，在我的情况下为<code>/mnt/user/shared/</code> </li><li>  Unraid Mount标签已<code>shared</code> </li><li> 网桥-br0 </li><li> 现在，取消选中创建后启动虚拟机，然后单击创建。 </li></ul><br><p> 都一样，在配置中，我们配置VNC服务器： </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphics</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'vnc'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'5901'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autoport</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'no'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">websocket</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'5701'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">listen</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0.0.0.0'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keymap</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'en-us'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">listen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'address'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0.0.0.0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphics</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> 安装系统后，它将通过DHCP获得IP并可以访问Internet。 </p><br><p> 要使FS目录在主机上可用，请在<code>/etc/fstab</code>添加以下行： </p><br><pre> <code class="plaintext hljs">shared /mnt/shared 9p trans=virtio,version=9p2000.L 0 0</code> </pre> <br><p> 现在，您可以在熟悉的Linux机器上使用常规服务，这些机器可以轻松移植到其他硬件上！ </p><br><p> 如果一切正常，并且可以正确打开和关闭，那么您可以购买并输入用于unRAID的密钥。 不要忘记它绑定到闪存驱动器的GUID（尽管可以移植）。 另外，没有许可证，VM的自动启动将无法进行。 </p><br><h1 id="final"> 决赛 </h1><br><p> 感谢您阅读到底！ </p><br><p> 我没有写太多，但我认为仍然很长。 我认为，unRAID的其他功能很容易配置，特别是因为所有功能都使用鼠标配置。 </p><br><p> 可以在VM上安装的好主意在<a href="https://www.reddit.com/r/HomeServer/comments/e4jvyl/whats_your_bestmost_used_nas_features/">这里</a> 。 我认为每个人都有自己的需求，因此不可能列出一些通用清单。 虽然pi.hole当然可以为每个人提供绝对的建议:) </p><br><p> 希望我有足够的继续！ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN478924/">https://habr.com/ru/post/zh-CN478924/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN478904/index.html">视频处理器的历史，第3部分：市场整合，英伟达与ATI之间竞争时代的开始</a></li>
<li><a href="../zh-CN478906/index.html">精确的道路定位</a></li>
<li><a href="../zh-CN478908/index.html">Positive Hack Days 10的门票公开发售</a></li>
<li><a href="../zh-CN478910/index.html">吃米饭，祈祷阿米托佛，爱猫</a></li>
<li><a href="../zh-CN478912/index.html">本月学习Azure-我们的新免费电子书</a></li>
<li><a href="../zh-CN478926/index.html">.NET Core 3.1发布</a></li>
<li><a href="../zh-CN478928/index.html">Python还是Python</a></li>
<li><a href="../zh-CN478930/index.html">如何在没有密码的情况下使用MySQL（以及安全风险）</a></li>
<li><a href="../zh-CN478932/index.html">前端的Docker。 第1部分。为什么？</a></li>
<li><a href="../zh-CN478934/index.html">每个人都经常忘记的最有用的Python标准库模块</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>