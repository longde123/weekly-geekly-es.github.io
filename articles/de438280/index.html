<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🍳 😟 👨🏿‍🍳 Objekte in Django "löschen" 📔 🤹🏾 💎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Früher oder später stehen die Entwickler vor der Aufgabe, unnötige Daten zu entfernen. Und je komplizierter der Service, desto mehr Nuancen müssen Sie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Objekte in Django "löschen"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/438280/"><img src="https://habrastorage.org/webt/6h/-4/-w/6h-4-wzp5wlydal3wkp2df8aq5a.jpeg"><br><br>  Früher oder später stehen die Entwickler vor der Aufgabe, unnötige Daten zu entfernen.  Und je komplizierter der Service, desto mehr Nuancen müssen Sie berücksichtigen.  In diesem Artikel werde ich beschreiben, wie wir das "Löschen" in einer Datenbank mit Hunderten von Links implementiert haben. <br><a name="habracut"></a><br><h2>  Hintergrund </h2><br>  Um die Funktionsfähigkeit der meisten Projekte zu überwachen, verwenden <b>Mail.ru Group</b> und <b>VKontakte</b> einen eigenen Entwicklungsdienst - <b>Monitoring</b> .  Das Projekt begann seine Geschichte ab Ende 2012 und hat sich über 6 Jahre zu einem riesigen System entwickelt, das viele Funktionen erhalten hat.  Die Überwachung überprüft regelmäßig die Verfügbarkeit von Servern und die Richtigkeit der Antworten auf Anforderungen, sammelt Statistiken über den verwendeten Speicher, die CPU-Auslastung usw.  Wenn die Parameter des überwachten Servers die zulässigen Werte überschreiten, erhalten die für den Server Verantwortlichen Benachrichtigungen im System und per SMS. <br><br>  Alle Überprüfungen und Vorfälle werden protokolliert, um die Dynamik der Serverleistung zu verfolgen, sodass die Datenbank die Größenordnung von Hunderten von Millionen Datensätzen erreicht hat.  In regelmäßigen Abständen werden neue Server angezeigt, und alte werden nicht mehr verwendet.  Informationen über nicht verwendete Server müssen aus dem Überwachungssystem gelöscht werden, um: <i>a) die Schnittstelle nicht mit unnötigen Informationen zu überlasten</i> und <i>b) eindeutige Kennungen freizugeben</i> . <br><br><h2>  Löschen </h2><br>  Ich habe wissentlich in der Überschrift des Artikels das Wort "Löschen" in Anführungszeichen geschrieben.  Es gibt verschiedene Möglichkeiten, ein Objekt aus dem System zu entfernen: <br><br><ul><li>  vollständig aus der Datenbank gelöscht; </li><li>  Objekte als gelöscht markieren und vor der Benutzeroberfläche verstecken.  Als Markierung können Sie Boolean oder DateTime für eine genauere Protokollierung verwenden. </li></ul><br><h4>  Iteration # 1 </h4><br>  Anfangs wurde der erste Ansatz verwendet, als wir einfach <code>object.delete()</code> ausführten und das Objekt mit allen Abhängigkeiten gelöscht wurde.  Im Laufe der Zeit mussten wir diesen Ansatz jedoch aufgeben, da ein Objekt Abhängigkeiten von Millionen anderer Objekte aufweisen und das Löschen von Tabellen durch kaskadierende Löschvorgänge starr blockiert werden konnte.  Und da der Dienst Tausende von Überprüfungen pro Sekunde durchführt und protokolliert, führte das Blockieren der Tabellen zu einer ernsthaften Verlangsamung des Dienstes, die für uns nicht akzeptabel war. <br><br><h4>  Iteration # 2 </h4><br>  Um lange Sperren zu vermeiden, haben wir uns entschlossen, Daten stapelweise zu löschen.  Dies würde es ermöglichen, tatsächliche Überwachungsdaten in den Intervallen zwischen dem Löschen von Objekten aufzuzeichnen.  Eine Liste aller Objekte, die in der Kaskade gelöscht werden, kann mit der Methode abgerufen werden, die im Admin-Bereich beim Löschen eines Objekts (beim Bestätigen des Löschvorgangs) verwendet wird: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.admin.util <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> NestedObjects <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DEFAULT_DB_ALIAS collector = NestedObjects(using=DEFAULT_DB_ALIAS) collector.collect([obj]) objects_to_delete = collector.nested() <span class="hljs-comment"><span class="hljs-comment"># Recursive delete objects</span></span></code> </pre> <br>  Die Situation verbesserte sich: Die Last wurde über die Zeit verteilt, neue Daten wurden schneller aufgezeichnet.  Aber wir sind sofort in die nächste Falle geraten.  Tatsache ist, dass die Liste der zu löschenden Objekte ganz am Anfang des Löschvorgangs erstellt wird. Wenn beim abhängigen Löschen neue abhängige Objekte hinzugefügt werden, kann das übergeordnete Element nicht gelöscht werden. <br><br>  Wir haben die Idee eines Fehlers beim rekursiven Löschen sofort aufgegeben, um erneut Daten über neue Abhängigkeiten zu sammeln oder das Hinzufügen abhängiger Datensätze beim Löschen zu verbieten, da <i>a) Sie in eine Endlosschleife gehen können</i> oder <i>b) Sie alle abhängigen Objekte im gesamten Code finden müssen</i> . <br><br><h4>  Iteration # 3 </h4><br>  Wir haben über die zweite Art des Löschens nachgedacht, wenn Daten markiert und vor der Schnittstelle verborgen werden.  Anfänglich wurde dieser Ansatz abgelehnt, da es mindestens eine Woche lang als Aufgabe erschien, alle Abfragen zu finden und einen Filter für das Fehlen eines gelöschten übergeordneten Elements hinzuzufügen.  Darüber hinaus bestand eine hohe Wahrscheinlichkeit, dass der erforderliche Code fehlte, was zu unvorhersehbaren Konsequenzen führen würde. <br><br>  Dann haben wir uns entschieden, Dekoratoren zu verwenden, um den Abfrage-Manager zu überschreiben.  Außerdem ist es besser, den Code zu sehen, als hundert Wörter zu schreiben. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exclude_objects_for_deleted_hosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*fields)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Decorator that adds .exclude({field__}is_deleted=True) for model_class.objects.get_queryset :param fields: fields for exclude condition """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model_class)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply_filters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(qs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filter_fields: qs = qs.exclude(**{ <span class="hljs-string"><span class="hljs-string">'{}is_deleted'</span></span>.format(<span class="hljs-string"><span class="hljs-string">'{}__'</span></span>.format(field) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> qs model_class.all_objects = copy.deepcopy(model_class.objects) filter_fields = set(fields) get_queryset = model_class.objects.get_queryset model_class.objects.get_queryset = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: apply_filters(get_queryset()) <span class="hljs-comment"><span class="hljs-comment"># save info about model decorator setattr(model_class, DECORATOR_DEL_HOST_ATTRIBUTE, filter_fields) return model_class return wrapper</span></span></code> </pre><br>  Der <code>exclude_objects_for_deleted_hosts(fields)</code> für die angegebenen Felder des <code>exclude_objects_for_deleted_hosts(fields)</code> fügt automatisch für jede Anforderung einen <code>exclude</code> hinzu, der nur Einträge entfernt, die nicht in der Benutzeroberfläche angezeigt werden sollen. <br><br>  Jetzt reicht es für alle Modelle, die in irgendeiner Weise von der Löschung betroffen sind, aus, einen Dekorateur hinzuzufügen: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@exclude_objects_for_deleted_hosts('host') class Alias(models.Model): host = models.ForeignKey(to=Host, verbose_name='Host', related_name='alias')</span></span></code> </pre><br>  Um das <code>Host</code> Objekt zu entfernen, ändern Sie <code>is_deleted</code> Attribut <code>is_deleted</code> : <br><br><pre> <code class="python hljs">host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-comment"><span class="hljs-comment"># after this save the host and all related objects will be inaccessible host.save()</span></span></code> </pre> <br>  Bei allen Abfragen werden automatisch Datensätze ausgeschlossen, die auf entfernte Objekte verweisen: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># model decorator @exclude_objects_for_deleted_hosts('checker__monhost', 'alias__host') CheckerToAlias.objects.filter( alias__hostname__in=['cloud.spb.s', 'cloud.msk.s'] ).values('id')</span></span></code> </pre><br>  Es stellt sich die folgende SQL-Abfrage heraus: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> monitoring_checkertoalias.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> monitoring_checkertoalias <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> monitoring_checker <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`checker_id`</span></span> = monitoring_checker.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checker`</span></span>.<span class="hljs-string"><span class="hljs-string">`monhost_id`</span></span> = Hosts.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dcmap_alias <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`alias_id`</span></span> = dcmap_alias.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> T5 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`dcmap_alias`</span></span>.<span class="hljs-string"><span class="hljs-string">`host_id`</span></span> = T5.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (<span class="hljs-string"><span class="hljs-string">`Hosts`</span></span>.<span class="hljs-string"><span class="hljs-string">`is_deleted`</span></span> = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- ,   monitoring_checker AND NOT (T5.`is_deleted` = TRUE) -- ,   dcmap_alias AND dcmap_alias.name IN ('dir1.server.p', 'dir2.server.p') );</span></span></code> </pre> <br>  Wie Sie sehen können, <code>`is_deleted` = TRUE</code> der Anforderung zusätzliche <code>`is_deleted` = TRUE</code> für die im Dekorator angegebenen Felder und Überprüfungen auf <code>`is_deleted` = TRUE</code> hinzugefügt. <br><br><h2>  Ein bisschen über Zahlen </h2><br>  Es ist logisch, dass zusätzliche Verknüpfungen und Bedingungen die Ausführungszeit der Abfrage verlängern.  Die Studie zu diesem Thema hat gezeigt, dass der Grad der „Komplikation“ von der Struktur der Datenbank, der Anzahl der Datensätze und dem Vorhandensein von Indizes abhängt. <br><br>  In unserem Fall wird für jede Abhängigkeitsstufe eine Geldstrafe von etwa 30% verhängt.  Dies ist die maximale Strafe, die wir am größten Tisch mit Millionen von Datensätzen erhalten, bei kleineren Tischen wird die Strafe auf einige Prozent reduziert.  Glücklicherweise haben wir die erforderlichen Indizes konfiguriert, und für die meisten kritischen Abfragen waren die erforderlichen Verknüpfungen bereits vorhanden, sodass wir keinen großen Unterschied in der Leistung verspürten. <br><br><h2>  Eindeutige Kennungen </h2><br>  Vor dem Löschen von Daten müssen möglicherweise Bezeichner freigegeben werden, deren Verwendung in Zukunft geplant ist, da dies beim Erstellen eines neuen Objekts zu einem nicht eindeutigen Fehler führen kann.  Trotz der Tatsache, dass in der Django-Anwendung keine Objekte sichtbar sind, befinden sie sich weiterhin in der Datenbank.  Daher hängen wir für gelöschte Objekte die UUID an den Bezeichner an. <br><br><pre> <code class="python hljs">host.hostname = <span class="hljs-string"><span class="hljs-string">'{}_{}'</span></span>.format(host.hostname, uuid.uuid4()) host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> host.save()</code> </pre><br><h2>  Bedienung </h2><br>  Für jedes neue Modell oder jede neue Abhängigkeit muss der Dekorateur bei Bedarf aktualisiert werden.  Um die Suche nach abhängigen Modellen zu vereinfachen, haben wir einen „intelligenten“ Test geschrieben: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_deleted_host_decorator_for_models</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recursive_host_finder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model, cache, path, filters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># cache for skipping looked models cache.add(model) # process all related models for field in (f for f in model._meta.fields if isinstance(f, ForeignKey)): if field.related_model == Host: filters.add(path + field.name) elif field.related_model not in cache: recursive_host_finder(field.related_model, cache.copy(), path + field.name + '__', filters) # check all models for current_model in apps.get_models(): model_filters = getattr(current_model, DECORATOR_DEL_HOST_ATTRIBUTE, set()) found_filters = set() if current_model == Host: found_filters.add('') else: recursive_host_finder(current_model, set(), '', found_filters) if found_filters or model_filters: try: self.assertSetEqual(model_filters, found_filters) except AssertionError as err: err.args = ( '{}\n !!! Fix decorator "exclude_objects_for_deleted_hosts" ' 'for model {}'.format(err.args[0], current_model), ) raise err</span></span></code> </pre><br>  Der Test überprüft rekursiv alle Modelle auf das Vorhandensein einer Abhängigkeit von dem zu löschenden Modell. Anschließend wird geprüft, ob der Dekorator für die erforderlichen Felder für dieses Modell festgelegt wurde.  Wenn etwas fehlt, sagt Ihnen der Test genau, wo Sie den Dekorateur hinzufügen müssen. <br><br><h2>  Nachwort </h2><br>  So war es mit Hilfe eines Dekorateurs möglich, ein „kleines Löschen“ von Daten mit einer großen Anzahl von Abhängigkeiten zu implementieren.  Alle Anfragen erhalten automatisch den erforderlichen <code>exclude</code> .  Das Auferlegen zusätzlicher Bedingungen verlangsamt den Prozess der Datenerfassung. Der Grad der „Komplikation“ hängt von der Struktur der Datenbank, der Anzahl der Datensätze und der Verfügbarkeit von Indizes ab.  Der vorgeschlagene Test zeigt Ihnen, für welche Modelle Sie Dekorateure hinzufügen müssen, und überwacht in Zukunft deren Konsistenz. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de438280/">https://habr.com/ru/post/de438280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de438266/index.html">Warum ist Pentesting für Ihr Unternehmen wichtig?</a></li>
<li><a href="../de438270/index.html">Liebe Kubernetes bei Mail.ru Gruppe: 14. Februar</a></li>
<li><a href="../de438272/index.html">Wie wir SMS aus der Höhle geschickt haben</a></li>
<li><a href="../de438274/index.html">Definition von „toxischer Persönlichkeit“ in der IT</a></li>
<li><a href="../de438278/index.html">Kindern das Programmieren beibringen</a></li>
<li><a href="../de438286/index.html">Arbeiten mit Zeitzonen in JavaScript</a></li>
<li><a href="../de438288/index.html">Furchtloser Schutz. Speichersicherheit in Rust</a></li>
<li><a href="../de438290/index.html">Post-mortem mit GGJ-2019: wie man Unebenheiten bekommt, aber trotzdem das Spiel macht</a></li>
<li><a href="../de438292/index.html">Apartment Automation mit HomePod, Raspberry Pi und Node.js.</a></li>
<li><a href="../de438294/index.html">Zuckende Streamer in einem PUBG-Match finden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>