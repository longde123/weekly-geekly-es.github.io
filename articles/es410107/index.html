<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ó üë®üèª‚Äçüé§ üï≥Ô∏è Gesti√≥n de rel√©s de Internet desde RouterOS Mikrotik a trav√©s de API üòµ üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üôèüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una herramienta √∫til para administrar PDU en enrutadores MikroTik 
 MikroTik es conocido como un fabricante de equipos de red con alta confiabilidad a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gesti√≥n de rel√©s de Internet desde RouterOS Mikrotik a trav√©s de API</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/410107/"><img src="https://habrastorage.org/webt/ip/ds/cs/ipdscs4kq9sanmqsyphzumdxvck.png" alt="MikroTik RODOS-8/9/10" align="left"><br><br><h2>  Una herramienta √∫til para administrar PDU en enrutadores MikroTik </h2><br>  <b>MikroTik es</b> conocido como un fabricante de equipos de red con alta confiabilidad a un bajo precio y una rica funcionalidad.  La base del software para los productos MikroTik es <b>RouterOS</b> , un sistema operativo de red basado en Linux.  Se ejecuta en <b>RouterBOARD</b> , una gran l√≠nea de soluciones de hardware que incluye equipos de operador puro y plataformas para uso dom√©stico.  RouterOS ofrece al administrador / usuario excelentes opciones para configurar y administrar el enrutador, lo que le permite operar no solo con la funcionalidad incorporada del sistema, sino tambi√©n crear sus propias opciones para casi cualquier soluci√≥n a trav√©s de la programaci√≥n de scripts. <br><br>  En este art√≠culo, analizar√© c√≥mo puede utilizar la funcionalidad avanzada de los enrutadores MikroTik para emitir comandos de administraci√≥n de energ√≠a utilizando <b>PDU (rel√©s de Internet)</b> directamente desde el enrutador a trav√©s de funciones de script. <a name="habracut"></a>  Como PDU, utilic√© el rel√© Ethernet RODOS-8/9/10 de la compa√±√≠a OLIMP (los dispositivos son absolutamente id√©nticos en t√©rminos de control), que permanecieron despu√©s de varios proyectos y estaban "a la mano". <br><br><h2>  Funciones de RouterOS para la gesti√≥n de PDU </h2><br>  La funcionalidad avanzada de RouterOS puede permitir: <br><br><ul><li>  Encender / apagar de forma remota la alimentaci√≥n de los dispositivos conectados a la PDU </li><li>  Controle de forma remota la PDU ante la ocurrencia de varios eventos en la red (por ejemplo, si no hay respuesta de alg√∫n dispositivo para hacer ping, cuando un cliente VPN espec√≠fico, un cliente de red wifi, etc., est√° conectado al enrutador), dependiendo del tiempo (programado) </li><li>  Notifique al administrador o usuarios sobre el cambio en el estado del rel√© en la PDU por correo electr√≥nico o n√∫mero de tel√©fono (a trav√©s de SMS) </li></ul><br>  Por lo tanto, es posible organizar, por ejemplo, el control del equipo del servidor, encender / apagar / reiniciar el equipo de red "colgado", encender el enfriamiento o la calefacci√≥n, la iluminaci√≥n, administrar cualquier carga aceptable para la potencia nominal como parte del Smart Home y mucho m√°s que pueda permitir Tu imaginaci√≥n <br><br>  La capacidad de controlar un rel√© de Internet desde RouterOS es proporcionada por el comando <b>fetch</b> router, cuya sintaxis se describe en detalle en el enlace al final del art√≠culo. <br><br><h2>  Gesti√≥n de PDU a trav√©s del comando de enrutador "fetch" </h2><br>  Las PDU RODOS-8/9/10 admiten el siguiente formato de URL: <br><br><div class="spoiler">  <b class="spoiler_title">http: // [inicio de sesi√≥n]: [Contrase√±a] @ [direcci√≥n IP] [/ proteger] / rb [X-1] [acci√≥n] .cgi</b> <div class="spoiler_text"><ul><li>  Inicio de sesi√≥n y contrase√±a: datos relevantes para acceder al dispositivo en "modo protegido" (proteger) </li><li>  Direcci√≥n IP: direcci√≥n IP del dispositivo en la red </li><li>  / protect - la clave de acceso en "modo protegido".  Si el acceso "abierto" est√° instalado en el dispositivo, no se especifica / protect, tampoco se especifican el inicio de sesi√≥n y la contrase√±a </li><li>  [acci√≥n] - la acci√≥n tomada en el rel√©: n-encendido, f-apagado, s-dar un pulso que dura 1 segundo </li><li>  X es el n√∫mero del rel√© al que se accede; los valores posibles dependen del modelo del dispositivo: <br><ol><li>  RODOS-8 - no indicado, como  el dispositivo tiene un solo rel√© </li><li>  RODOS-9 - X = 1 o X = 2 </li><li>  RODOS-10 - X = [1-4] </li></ol></li></ul><br>  Todos los par√°metros especificados se pasan sin corchetes []. </div></div><br>  Por lo tanto, para resolver nuestro problema en RouterOS, para habilitar el primer rel√© de nuestra PDU, la siguiente entrada es suficiente: <br><br><pre><code class="hljs pgsql">/tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> url="http://[:]@192.168.1.20/protect/rb0n"</code> </pre> <br>  Si queremos una respuesta del dispositivo, debemos usar: <br><br><pre> <code class="hljs powershell">/tool fetch url=<span class="hljs-string"><span class="hljs-string">"http://[:]@192.168.1.20/protect/rb0n"</span></span> mode=http dst<span class="hljs-literal"><span class="hljs-literal">-path</span></span>=<span class="hljs-string"><span class="hljs-string">"Rodosanswer.txt"</span></span>; :local Rodosanswer [/<span class="hljs-type"><span class="hljs-type">file</span></span> <span class="hljs-type"><span class="hljs-type">get</span></span> <span class="hljs-type"><span class="hljs-type">Rodosanswer.txt</span></span> <span class="hljs-type"><span class="hljs-type">contents</span></span>];</code> </pre> <br>  La respuesta PDU en nuestro caso se devuelve utilizando el mecanismo <b>json</b> a la variable <b>Rodosanswer</b> en la siguiente forma: <br><br><ul><li>  ‚Äú¬°√âxito!  "- en caso de ejecuci√≥n exitosa del comando </li><li>  "Fallo": si el comando no se ejecuta (como regla, al acceder sin indicar el inicio de sesi√≥n y la contrase√±a de la PDU en la l√≠nea URL, si la PDU est√° en modo "protegido") </li></ul><br><h2>  Creamos la funci√≥n de gesti√≥n de PDU Rodos en el repositorio del enrutador Mikrotik </h2><br>  Entonces comencemos.  Creemos una funci√≥n de control de rel√© utilizando el ejemplo de control RODOS-10 en el repositorio de scripts del enrutador MikroTik con el nombre "Func_RODOS10rele": <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo "Func_RODOS10rele"</b> <div class="spoiler_text"><pre> <code class="hljs mel">################ FuncRODOS10rele ###################### #     PDU RODOS<span class="hljs-number"><span class="hljs-number">-10</span></span> # by Sergej Serkov <span class="hljs-number"><span class="hljs-number">23.12</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span> ####################################################### #  ,   :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncRODOS10rele <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local Sport <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:len $Rport]=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Sport <span class="hljs-string"><span class="hljs-string">"80"</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={:set Sport $Rport;} :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncPing; :local PingAnswer [$FuncPing PingAdr=$Radr]; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingAnswer=<span class="hljs-string"><span class="hljs-string">"OK"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local Rprotect; :local Wprotect; :local Rmode <span class="hljs-string"><span class="hljs-string">"0"</span></span>; :local Nrele <span class="hljs-number"><span class="hljs-number">0</span></span>; :local Act; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (([:len $Rlogin]=<span class="hljs-number"><span class="hljs-number">0</span></span>) and ([:len $Rpass]=<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rprotect <span class="hljs-string"><span class="hljs-string">""</span></span>; set Wprotect <span class="hljs-string"><span class="hljs-string">""</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={:set Rprotect (<span class="hljs-string"><span class="hljs-string">"$Rlogin"</span></span>.<span class="hljs-string"><span class="hljs-string">":"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rpass"</span></span>.<span class="hljs-string"><span class="hljs-string">"@"</span></span>); set Wprotect <span class="hljs-string"><span class="hljs-string">"/protect"</span></span>;} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"on"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"n"</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"off"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"f"</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"inv"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"s"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rmode=<span class="hljs-string"><span class="hljs-string">"1"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set Nrele ([:tonum $Rrele] - <span class="hljs-number"><span class="hljs-number">1</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($Nrele &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> and ($Nrele &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local StrFetchRodos; :set StrFetchRodos (<span class="hljs-string"><span class="hljs-string">"http://"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rprotect"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Radr"</span></span>.<span class="hljs-string"><span class="hljs-string">":"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Sport"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect"</span></span>.<span class="hljs-string"><span class="hljs-string">"/rb"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Nrele"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Act"</span></span>.<span class="hljs-string"><span class="hljs-string">".cgi"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { [/tool fetch url=$StrFetchRodos mode=http dst-path=<span class="hljs-string"><span class="hljs-string">"Rodosanswer.txt"</span></span>;]; } on-<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>={: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"Call ERROR function &lt;RODOS10rele&gt; ERROR fetch command"</span></span>); :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: command ROS &lt;fetch&gt;"</span></span>; : <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer} :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">warning</span></span> (<span class="hljs-string"><span class="hljs-string">"all "</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele #"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele "</span></span>.<span class="hljs-string"><span class="hljs-string">"is ["</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rstatus"</span></span>.<span class="hljs-string"><span class="hljs-string">"]"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :delay <span class="hljs-number"><span class="hljs-number">2</span></span>s; :local Rodosanswer [/<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> get Rodosanswer.txt contents]; /<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> remove Rodosanswer.txt; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele#"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele"</span></span>.<span class="hljs-string"><span class="hljs-string">" but NUMBER RELE MISMATCH"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: rele range mismath"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele#"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele"</span></span>.<span class="hljs-string"><span class="hljs-string">" but RELE REGIME SET MISMATCH"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: rele regime set mismatch"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; but DEVICE NOT RESPONDED"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: device not responded"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} }</code> </pre></div></div><br>  La funci√≥n FuncRODOS10rele tambi√©n utiliza en su trabajo otra peque√±a funci√≥n de verificar el ping de la direcci√≥n de red: <b>FuncPing</b> , que debe estar presente en el entorno de las variables del repositorio del enrutador durante el funcionamiento de la funci√≥n principal. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo "Func_Ping"</b> <div class="spoiler_text"><pre> <code class="hljs mel">:<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncPing <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local PingCount <span class="hljs-number"><span class="hljs-number">3</span></span>; #  ; :local Result [/ping $PingAdr count=$PingCount]; :delay <span class="hljs-number"><span class="hljs-number">2</span></span>s; :local PingAnswer <span class="hljs-string"><span class="hljs-string">""</span></span>; :local MainIfInetOk false; :set MainIfInetOk ((<span class="hljs-number"><span class="hljs-number">3</span></span>*$Result) &gt;= (<span class="hljs-number"><span class="hljs-number">2</span></span> * $PingCount)) :put <span class="hljs-string"><span class="hljs-string">"MainIfInetOk=$MainIfInetOk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$MainIfInetOk) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set PingAnswer <span class="hljs-string"><span class="hljs-string">"ERROR"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($MainIfInetOk) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set PingAnswer <span class="hljs-string"><span class="hljs-string">"OK"</span></span> } :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $PingAnswer;}</code> </pre></div></div><br><h2>  Aplicaci√≥n de la funci√≥n de control de rel√© </h2><br>  Lo siguiente debe pasarse como par√°metros a la funci√≥n FuncRODOS10rele: <br><br><ul><li>  Radr - direcci√≥n IP del dispositivo </li><li>  Rport - puerto http.  Si el puerto est√°ndar para http (80) est√° configurado, este par√°metro puede omitirse </li><li>  Rrele: el n√∫mero del rel√© sobre el que realizamos una acci√≥n (para RODOS-10 [1-4]), <br>  para RODOS-9 [1-2], para RODOS-8 no se transmite) </li><li>  Rstatus - acci√≥n que se est√° tomando ("off" - deshabilitar; "on" - habilitar; "inv" - dar un impulso) </li><li>  Rlogin - inicio de sesi√≥n, Rpass - contrase√±a de acceso al dispositivo <br>  (si no est√°n configurados, la llamada de comando se usa sin "/ protect") <br></li></ul><br><div class="spoiler">  <b class="spoiler_title">Ejemplo 1: llamar a una funci√≥n con acceso a la PDU a trav√©s del puerto http est√°ndar cuando el "modo protegido" est√° desactivado en el m√≥dulo, activando el rel√© N. ¬∞ 2:</b> <div class="spoiler_text"><pre> <code class="hljs powershell">[<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"on"</span></span>]</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Ejemplo 2: llamar a una funci√≥n con acceso a la PDU a trav√©s del puerto http 8021 configurado con el "modo protegido" configurado, apagando el rel√© No. 2</b> <div class="spoiler_text"><pre> <code class="hljs powershell">[<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rport</span></span>=<span class="hljs-string"><span class="hljs-string">"8021"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"off"</span></span> <span class="hljs-type"><span class="hljs-type">Rlogin</span></span>=<span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-type"><span class="hljs-type">Rpass</span></span>=<span class="hljs-string"><span class="hljs-string">"password"</span></span>]</code> </pre> </div></div><br>  La respuesta de la funci√≥n se puede devolver a la variable de cadena <b>Rodosanswer</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Rodosanswer puede contener el siguiente texto:</b> <div class="spoiler_text"><pre>  ‚Ä¢ "¬°√âxito!" - en caso de una llamada exitosa y la ejecuci√≥n de un equipo

  ‚Ä¢ "Fallo": en caso de manejo err√≥neo y no ejecuci√≥n de un comando

  ‚Ä¢ "ERROR: desajuste de rango de liberaci√≥n": si se especifica un n√∫mero de rel√© no v√°lido 
	 en el par√°metro de la funci√≥n Rrele para esta versi√≥n del dispositivo

  ‚Ä¢ "ERROR: el r√©gimen de relevo no coincide" - en caso de no especificado o incorrecto 
     El par√°metro especificado de la funci√≥n Rstatus ("on", "off", "inv")

  ‚Ä¢ "ERROR: el dispositivo no respondi√≥" - si no hay respuesta del dispositivo 
     hacer ping

  ‚Ä¢ "ERROR: comando ROS &lt;fetch&gt;" - en caso de error directamente
     al ejecutar el comando URL de b√∫squeda de RouterOS (generalmente si no
     el n√∫mero de puerto especificado en Rport, par√°metros de Rlogine especificados incorrectamente
     y / o Rpass)
</pre></div></div><br>  Puede llamar a la funci√≥n de control de retransmisi√≥n en la PDU desde cualquiera de sus otros scripts de la siguiente manera: <br><br><ol><li>  Primero debe ejecutar scripts que coloquen las funciones necesarias en el entorno de las variables del repositorio del enrutador.  Esto se puede hacer una vez, por ejemplo, al iniciar el enrutador desde el Planificador de RouterOS ( <b>/ planificador del sistema</b> ) <br><br><pre> <code class="hljs pgsql">#          /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> script run Func_RODOS10rele; #      ¬´FuncPing¬ª # (  FuncRODOS10rele) /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> script run Func_Ping;</code> </pre> </li><li>  Despu√©s de definir las funciones, puede usarlas (en particular, llamar a FuncRODOS10rele) <br><br>  Como ejemplo, llamamos a nuestra funci√≥n aplicando un pulso al rel√© No. 4 de la PDU RODOS-10: <br><br><pre> <code class="hljs powershell">:global FuncRODOS10rele; :local Rodosanswer [<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rport</span></span>=<span class="hljs-string"><span class="hljs-string">"8021"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"4"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"inv"</span></span> <span class="hljs-type"><span class="hljs-type">Rlogin</span></span>=<span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-type"><span class="hljs-type">Rpass</span></span>=<span class="hljs-string"><span class="hljs-string">"password"</span></span>]; :log info <span class="hljs-variable"><span class="hljs-variable">$Rodosanswer</span></span>;</code> </pre><br>  La respuesta se devolver√° a la variable <b>Rodosanswer</b> y, en este caso, se mostrar√° en el registro del enrutador. <br><br><h2>  Biblioteca de funciones lista para usar para trabajar con PDU </h2><br>  Para facilitar su uso, cre√© una biblioteca de funciones para las PDU Rodos de los modelos 8, 9, 10 y 10 de ejecuci√≥n DIN (versi√≥n de biblioteca 1.0 del 25 de diciembre de 2017).  Los scripts de la biblioteca se combinan en el archivo Func_RODOS.rsc, que puede importarse a RouterOS mediante el siguiente comando del terminal de utilidad WINBOX: <br><br><pre> <code class="hljs swift">/<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> file= Func_RODOS.rsc</code> </pre> <br>  El proceso de importaci√≥n puede tomar de 20 segundos a 1 minuto, dependiendo del modelo del enrutador Mikrotik (su velocidad). <br>  En este caso, todos los scripts que estaban disponibles anteriormente en el enrutador no se ven afectados, las funciones y scripts de la biblioteca Func_RODOS se agregan a los scripts de repositorio existentes. <br><br><div class="spoiler">  <b class="spoiler_title">La versi√≥n 1.0 de la biblioteca Rodos.rsc contiene los siguientes scripts:</b> <div class="spoiler_text"><ul><li>  start_RODOS: ejecutar este script establece todas las funciones en variables de entorno </li><li>  Func_Ping - la funci√≥n de verificar la direcci√≥n para "ping" </li><li>  Func_Mail - funci√≥n para enviar un mensaje arbitrario al correo del administrador </li><li>  Func_RODOS8rele - Funci√≥n de control de rel√© PDU RODOS-8 </li><li>  Func_RODOS8reset - funci√≥n de reinicio ("reinicio") del rel√© PDU RODOS-8 </li><li>  Func_RODOS9rele - ... de manera similar para los modelos indicados ... </li><li>  Func_RODOS9reset </li><li>  Func_RODOS10rele </li><li>  Func_RODOS10reset </li><li>  call_example [...] - ejemplos de llamadas a funciones de biblioteca </li><li>  Func_RODOS_lib: todas las funciones de PDU (excepto Ping y Mail) en un archivo de script </li></ul></div></div><br>  Despu√©s de importar la biblioteca, puede eliminar funciones y scripts innecesarios del repositorio, dejando solo las funciones de su modelo de PDU y scripts con las funciones FuncMail y FuncPing. <br><br>  En la biblioteca, para cada uno de los modelos de PDU compatibles, tambi√©n hay pr√°cticas funciones de reinicio ("reinicio") (marcadas en los nombres como "~ reinicio").  Los par√°metros de las funciones de reinicio son similares a los par√°metros de las funciones de instalaci√≥n del rel√©, con la excepci√≥n del par√°metro "Rstatus", que no se utiliza durante el "reinicio" y el par√°metro opcional opcional Rtime, que define el tiempo en segundos entre el apagado y encendido del rel√© (si Rtime no se pasa a la funci√≥n, se usa por defecto tiempo 5 segundos). <br><br>  Las funciones de reinicio funcionan de la siguiente manera: <br><ol><li>  El rel√© especificado recibe un comando de apagado. </li><li>  Luego espera segundos Rtime con el siguiente comando de inclusi√≥n.  En este caso, las funciones de reinicio se refieren a las funciones de instalaci√≥n del rel√© correspondientes, que deben determinarse antes del primer </li></ol><br>  Por lo tanto, si, antes de la llamada a la funci√≥n de reinicio, se activ√≥ un cierto rel√©, se apagar√° y despu√©s de un tiempo especificado se volver√° a encender (y la carga conectada se "reiniciar√°").  Se realiza una operaci√≥n similar en un rel√© apagado, y despu√©s de que se ha activado la funci√≥n, el rel√© se enciende (es decir, en este caso, la funci√≥n se cumple como una funci√≥n de conmutaci√≥n de rel√©).  Es conveniente utilizar las funciones de reinicio para reiniciar el equipo de red "colgado" conectado a las PDU de Rodos (puntos de acceso, enrutadores, conmutadores, varios servidores, etc.). <br><br>  Los c√≥digos fuente de la biblioteca Rodos.rsc (funciones y scripts, ejemplos de acceso a ellos) est√°n "comentados" con suficiente detalle, lo que puede ser √∫til para aquellos que desean comprender la biblioteca en detalle (o tal vez modificarlos usted mismo o escribir su propia versi√≥n). <br><br>  En los ejemplos de llamadas a las funciones de reinicio, despu√©s de que la funci√≥n se haya resuelto, es posible enviar mensajes a la direcci√≥n de correo electr√≥nico del administrador del enrutador (en la configuraci√≥n de la variable de script, puede especificar su direcci√≥n de correo).  En este caso, los scripts usan el servicio de correo RouterOS desde <b>/ tool e-mail</b> , cuyos par√°metros debe configurar previamente de manera correcta. <br><br><h2>  Planes futuros </h2><br>  En el futuro, se ampliar√° la biblioteca de scripts para las PDU de Rodos: est√° previsto crear funciones para la estaci√≥n meteorol√≥gica de Internet RODOS-16, que tiene "a bordo", adem√°s de rel√©s, l√≠neas de entrada / salida y sensores de temperatura / humedad / presi√≥n atmosf√©rica.  Tambi√©n se planea implementar el registro de las funciones no solo en el registro y el correo del enrutador, sino tambi√©n en el n√∫mero de tel√©fono especificado que elija el usuario (enviando mensajes SMS a trav√©s del m√≥dem del enrutador). <br><br>  Quiz√°s, en el proceso de uso de la biblioteca por parte de los usuarios (incluidos los lectores de este material), se revelar√°n algunos errores que, como regla, son inevitables durante cualquier desarrollo.  Inf√≥rmeme de cualquier error, comentario y sugerencia para su correcci√≥n. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace a la descripci√≥n del comando Fetch para enrutadores MikroTik</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace a la documentaci√≥n de las PDU usadas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enlace a la biblioteca de funciones de script para la PDU de Rodos</a> <br><br>  Serkov Sergey Vladimirovich, 26 de diciembre de 2017 </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es410107/">https://habr.com/ru/post/es410107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es410093/index.html">Quadrocopter canadiense obedece las muecas del operador</a></li>
<li><a href="../es410095/index.html">Entusiasta de la inform√°tica ensambl√≥ un procesador de 8 bits a partir de los materiales disponibles</a></li>
<li><a href="../es410099/index.html">MIT explic√≥ c√≥mo se forman los h√°bitos</a></li>
<li><a href="../es410103/index.html">ADN a trav√©s de los ojos de un programador</a></li>
<li><a href="../es410105/index.html">Interfaz DALI y Arduino. Surrealismo real</a></li>
<li><a href="../es410109/index.html">La botnet Smominru ayuda a los atacantes a ganar m√°s de $ 3.6 millones</a></li>
<li><a href="../es410111/index.html">Un candidato para membranas celulares encontrado en Tit√°n</a></li>
<li><a href="../es410113/index.html">El veh√≠culo de lanzamiento m√°s peque√±o lanz√≥ con √©xito un sat√©lite en √≥rbita</a></li>
<li><a href="../es410115/index.html">Sexto DIY Mitap en Mail.Ru Group (18/02/2018)</a></li>
<li><a href="../es410117/index.html">Los investigadores han sugerido c√≥mo rastrear un tel√©fono inteligente con GPS apagado.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>