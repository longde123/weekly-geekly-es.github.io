<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèáüèæ üë®‚Äçüë®‚Äçüëß ‚ôÄÔ∏è Herramientas de respaldo de PostgreSQL. Andrey Salnikov (Garceta de datos) üöô ‚ôÇÔ∏è üí°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le sugiero que lea el descifrado del informe por Andrey Salnikov de Data Egret "Herramientas de creaci√≥n de copias de seguridad PostgreSQL" . Al final...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Herramientas de respaldo de PostgreSQL. Andrey Salnikov (Garceta de datos)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485622/"><p>  <strong>Le sugiero que lea el descifrado del informe por Andrey Salnikov de Data Egret "Herramientas de creaci√≥n de copias de seguridad PostgreSQL"</strong> <strong>.</strong>  <strong>Al final, una tabla resumida actualizada de herramientas</strong> </p><br><p>  Esta charla trata sobre las herramientas de copia de seguridad PostgreSQL disponibles.  Copias de seguridad l√≥gicas, copias de seguridad binarias, herramientas de copia de seguridad integradas y herramientas de terceros.  ¬øSe necesitan copias de seguridad incrementales cuando realmente pueden ayudar?  Veamos cu√°ndo y qu√© herramienta es m√°s apropiada para usar.  ¬øCu√°l es la mejor manera de automatizar el proceso de respaldo y verificar la integridad de un respaldo?  Eche un vistazo <a href="https://www.postgresql.org/docs/10/app-pgbasebackup.html" rel="nofollow">m√°s de cerca</a> a herramientas como <a href="https://www.postgresql.org/docs/10/app-pgdump.html" rel="nofollow">pg_dump</a> , <a href="https://www.postgresql.org/docs/10/app-pgbasebackup.html" rel="nofollow">pg_basebackup</a> , <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">barman</a> , <a href="https://github.com/wal-e/wal-e" rel="nofollow">wal-e</a> , <a href="https://github.com/wal-g/wal-g" rel="nofollow">wal-g</a> , <a href="https://pgbackrest.org/" rel="nofollow">pgbackrest</a> , <a href="https://www.enterprisedb.com/enterprise-postgres/edb-postgres-backup-and-recovery-tool" rel="nofollow">BART</a> y <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">pg_probackup</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Us6cHVNA4vk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Mi nombre es Andrey Salnikov, soy un empleado de Data Egret y este informe estar√° dedicado a las herramientas para crear copias de seguridad en PostgreSQL. </p><br><p><img src="https://habrastorage.org/webt/qr/pa/mu/qrpamu1psbed1aonvt1shrrpedk.png"></p><br><p>  Primero acerca de qui√©nes somos, mi compa√±√≠a.  Nuestra actividad principal: trabajamos como administradores remotos y tenemos un n√∫mero bastante grande de clientes.  Hay bases enormes, hay un mont√≥n de bases peque√±as, hay todo tipo de mezclas cuando una base grande o un mont√≥n de bases peque√±as.  Tambi√©n proporcionamos servicios de consultor√≠a y auditor√≠a: este es el caso si las personas no necesitan un apoyo constante, pero se necesita alg√∫n tipo de experiencia. <br>  Dado que PostgreSQL es un producto de c√≥digo abierto, naturalmente participaremos en todo tipo de conferencias en t√©rminos de compartir nuestra experiencia y ayudar a PostgreSQL a hacer lo mejor.  Porque la base de datos PostgreSQL es realmente buena.  Y resulta que vimos muchos perfiles de carga: cargas DWH y cargas WEB, y mezclas de carga.  Y las bases estaban cayendo de diferentes maneras.  Mucha experiencia </p><br><p><img src="https://habrastorage.org/webt/a0/vc/b_/a0vcb_l47qx4vvzh1hxnjcqesz4.png"></p><br><p>  Esta es la parte m√°s interesante del informe.  ¬øPor qu√© se necesitan copias de seguridad?  De hecho, son necesarios para que podamos descansar en paz, para que podamos dormir en paz, para poder pasar el rato en los conciertos con calma.  Ahora, este es el objetivo principal desde el punto de vista de la base por la que se necesitan copias de seguridad.  Para que todo est√© tranquilo en nuestras vidas.  Porque si hay copias de seguridad verificadas, entonces podemos hacer todo esto.  Pero lo que est√° sucediendo con la base es la d√©cima cosa. </p><br><p><img src="https://habrastorage.org/webt/dj/_9/aj/dj_9ajbympb3eslx0bl1phlp6te.png"></p><br><p>  ¬øCu√°l es el rango de herramientas para crear copias de seguridad en el mundo de PostgreSQL?  Esta es la herramienta de recuperaci√≥n integrada pg_dump, pg_dumpall o pg_restore.  Esta es la √∫nica herramienta que le permite hacer copias de seguridad l√≥gicas.  Es decir, puede pg_dump, tanto en SQL para volcar, como en un peque√±o formato binario para volcar datos.  Y sale de la caja con PostgreSQL. <br>  La siguiente herramienta (pg_basebackup) para crear copias de seguridad, que tambi√©n sale de la caja y comienza con esta herramienta, y todas ser√°n herramientas para crear copias de seguridad de bases de datos binarias.  Pg_basebackup tambi√©n es una herramienta que viene de f√°brica, que nos permite cargar repositorios postgreSQL y tomar una copia binaria de la base de datos, disparar una base de datos persistente y, si queremos poder archivar a tiempo, podemos configurar PostgreSQL para volcarlo a alg√∫n tipo de disco.  Estas son las herramientas b√°sicas.  Son buenos, lo hacen, realizan su funcionalidad a las 5, pero son inconvenientes en t√©rminos de gesti√≥n y alg√∫n tipo de masa.  Cuando tenga 20 bases de datos, deber√° hacerlo usted mismo mediante secuencias de comandos. <br>  Las siguientes dos herramientas son herramientas espec√≠ficas de la nube pura: wal-e y wal-g.  Los mismos chicos los est√°n desarrollando, pero el desarrollo de wal-e termin√≥ y cambiaron a wal-g.  Estas herramientas est√°n orientadas principalmente para AWS y para el almacenamiento en S3.  Wal-e todav√≠a puede trabajar con Google Cloud, con Azure y con el sistema de disco, solo puede especificar alg√∫n tipo de unidad remota.  Wal-g solo funciona con AWS, solo con S3.  Bueno, o cualquier otra interfaz similar con S3.  Los usamos, cosas buenas.  Desarmar√© a√∫n m√°s cada herramienta en detalle. </p><br><p><img src="https://habrastorage.org/webt/h_/cs/my/h_csmywtln65xfdmoryutenb6-g.png"></p><br><p>  Y en el pr√≥ximo paquete de herramientas, estas son herramientas que dependen de pg_basebackup o que lo usan directamente, o que de alguna manera implementan su funcionalidad.  Todos est√°n escritos por desarrolladores que se comprometen con el principal PostgreSQL y tienen su propio comercial de fork, que promueven en su c√≠rculo de influencia. <br>  La herramienta de barman m√°s popular, que utilizamos ampliamente en el pa√≠s.  Esto es esencialmente un contenedor de Python alrededor de pg_basebackup.  Tambi√©n puede funcionar en protocolos ssh.  Una herramienta pgbackrest muy interesante y muy prometedora.  PostgreSQL participa en el desarrollo y se compromete activamente con √©l.  Originalmente fue escrito en Python.  Ahora, la versi√≥n que se utiliza: est√° escrita en C para acelerar y la posibilidad de eliminar paralelamente las copias de seguridad. <br>  Pg_probackup es una utilidad de nuestros colegas rusos en PostgreSQL Professional que le permite realizar copias de seguridad incrementales, que son bastante peque√±as. <br>  Y la √∫ltima utilidad es la herramienta de copia de seguridad y recuperaci√≥n (BART) de EnterpriseDB.  Ella no es muy popular con nosotros.  Es principalmente para CentOS y Red Hat.  Para Ubuntu, con ella, en mi opini√≥n, dif√≠cil.  Y debido a la baja popularidad de BART entre nosotros, casi no se encuentra en ninguna parte de las instalaciones. </p><br><p><img src="https://habrastorage.org/webt/ow/si/t8/owsit8h0n3welzlugm95_glqdds.png"></p><br><p>  Intentar√≠a dividir estas herramientas en algunas cosas que son importantes. </p><br><ul><li><p>  Primero, es importante para nosotros c√≥mo lo almacenaremos, en qu√© unidades y en qu√© servicios.  Y hay una lista de caracter√≠sticas que veremos. </p><br></li><li><p>  La siguiente separaci√≥n de datos, aqu√≠ subdivido que, al eliminar la copia de seguridad o restaurar la copia de seguridad, podemos cortar parte de todo el servidor de base de datos (servidor) y trabajar con ella como una base de datos integral e integral. </p><br></li><li><p>  Cu√°nto admiten diferentes versiones de la base de datos. </p><br></li><li><p>  ¬øQu√© modos de funcionamiento tienen en t√©rminos de paralelismo, en t√©rminos de alg√∫n tipo de automatizaci√≥n y similares? </p><br></li><li><p>  Y la facilidad de servicio es cu√°nto podemos separarlos en un servicio separado, que a su vez pasar√° por las bases de datos y eliminar√° las copias de seguridad de acuerdo con alg√∫n cronograma. </p><br></li><li><p>  Validaci√≥n: quer√≠a que se verificara la copia de seguridad para garantizar que luego podamos recuperarnos de ella y que tengamos una base normal e ininterrumpida. </p><br><p>  Y ahora, veamos estos seis grandes puntos con m√°s detalle.  Y marcar√© all√≠ qu√© instrumento nos dar√°. </p><br></li></ul><br><p><img src="https://habrastorage.org/webt/s5/v0/h0/s5v0h0p62rsqz1r86v2upwibj5c.png"></p><br><p>  Por almacenamiento, pueden almacenar todo en el sistema de archivos, es decir, podemos volver a montar nuestro disco en el sistema operativo y copiar copias de seguridad all√≠.  Todas las herramientas te permiten hacer esto.  Una unidad de red montada es b√°sicamente la misma, ya que se obtiene en nuestro sistema de archivos local. <br>  En AWS (S3), tres herramientas pueden funcionar para nosotros: wal-g, wal-e, pgbackrest.  Porque entre tales utilidades: barman, etc., es la √∫nica que puede funcionar con AWS (S3). <br>  Con Azure, solo wal-e.  Google Cloud es solo wal-e. </p><br><p><img src="https://habrastorage.org/webt/gw/sc/qd/gwscqdmvmqlbe1r1e545ipkemzs.png"></p><br><ul><li>  Pg_dump, pg_dumpall nos proporciona una copia l√≥gica de los datos.  La diferencia entre ellos es que pg_dumpall procesa toda la instancia de la base de datos (servidor), en pg_dump puede especificar una base de datos espec√≠fica en la instancia y trabajar con ella. </li><li>  Las copias binarias son todo lo dem√°s. </li><li>  Un factor importante durante el almacenamiento es que si estamos limitados de alguna manera por los recursos del disco, a menudo surgen situaciones cuando dividimos la base de datos en diferentes espacios de tabla.  Esto tambi√©n es cierto para los servidores de hierro, ya que no desea sufrir RAID.  Esto es cierto para las nubes, porque debido a que hay una cierta limitaci√≥n, especialmente cuando toma un autom√≥vil con discos NVME y cu√°ntos est√°n conectados, muchos est√°n conectados.  Las instancias de AWS se expanden, pero con unidades EBS.  Y al restaurar los datos, ser√° importante para nosotros que podamos redistribuir estos espacios de tablas, asignarlos a lo largo de nuevas rutas y a nuevos discos.  Y ahora esta buena propiedad est√° presente en wal-e.  En wal-g todav√≠a no saben c√≥mo trabajar con √©l.  Pg_probackup puede funcionar con √©l.  Barman, basebackup, pgbackrest.  Esto suele ser importante, especialmente cuando tiene una base de datos de 8-10 TB.  Entre nuestros clientes de producci√≥n, casi todas estas bases de datos est√°n colapsadas en espacios de tablas. </li></ul><br><p><img src="https://habrastorage.org/webt/qd/-v/sk/qd-vskcocq-r2tv0duopeyxtvke.png"></p><br><p>  Ahora sobre qu√© tama√±o podemos tener copia de seguridad.  Todo esto ir√° en el contexto de las copias de seguridad binarias.  Est√° claro que la copia de seguridad binaria es cu√°nto pesa la base de datos con nosotros, tanto copiamos.  Pesa 8 TB, copiamos 8 TB.  1 MB pesa 1 MB, copiado.  ¬øC√≥mo ahorrar espacio cuando queremos una larga cadena de copias de seguridad?  Para hacer esto, se me ocurrieron algunas herramientas.  Es decir, la base de datos almacena datos en sus archivos.  Si tenemos una base de datos de archivo larga, generalmente cambiamos all√≠ un peque√±o porcentaje de estos archivos.  Y para esto, se les ocurri√≥ una copia de seguridad diferencial. </p><br><p>  Copia de seguridad diferencial, ¬øqu√© es?  Observamos qu√© archivos han cambiado y solo copiamos al almacenamiento, d√≥nde almacenar la copia de seguridad.  Y vincularemos todos los dem√°s archivos con un enlace duro a esta base de datos.  Resulta que as√≠ ahorramos espacio.  Y al mismo tiempo, podemos eliminar de forma segura las copias de seguridad de bases de datos antiguas sin estropear las m√°s recientes. </p><br><p>  Esto es bueno, pero decidimos seguir adelante y se nos ocurri√≥ una copia de seguridad incremental.  Las copias de seguridad incrementales son de dos tipos. </p><br><p>  El primero es a nivel de archivo.  Difiere de la copia de seguridad diferencial solo en que la copia de seguridad diferencial se centra en una copia de seguridad completa de su base de datos y, en relaci√≥n con una copia de seguridad completa, copia archivos y copias de diferencias.  La copia de seguridad incremental puede centrarse en copias de seguridad diferenciales, copia solo aquellos archivos modificados que han cambiado en comparaci√≥n con la copia de seguridad diferencial.  Para incremental, necesitar√° toda la cadena de copias de seguridad.  Es decir, la copia de seguridad principal -&gt; 1¬™ copia de seguridad incremental (siempre ser√° diferencial) -&gt; luego todas las copias de seguridad incrementales.  La copia de seguridad diferencial siempre se centra en una base de datos de copia de seguridad completa.  Incremental puede enfocarse en otros tipos de respaldo. <br>  Pg_probackup y BART fueron la forma de crear copias de seguridad incrementales por bloque.  Porque no podemos cambiar todo el archivo, sino el bloque de datos.  Y estas utilidades se ejecutan a trav√©s de archivos wal y seleccionan exactamente los bloques que han cambiado.  Estos bloques de copia de seguridad se copian en la copia de seguridad.  Para recuperarse con una copia de seguridad incremental de este tipo, tambi√©n necesitar√° una copia completa de la base de datos y adem√°s deber√° guardar estas piezas incrementales que se escriben desde wal.  Esto impone algunas limitaciones de la utilidad, ya que deben ejecutarse a trav√©s de archivos wal.  PostgreSQL Professional tambi√©n tiene una capa sobre la estructura de archivos de la base de datos.  Por lo tanto, est√°n buscando r√°pidamente estos bloques.  Tales copias de seguridad incrementales son muy peque√±as.  Si tiene un peque√±o% de cambio en la base de datos y debido al hecho de que se escribe una gran cantidad de informaci√≥n t√©cnica en el archivo wal, estas utilidades respaldan decenas de kilobytes de datos por 1 wal. </p><br><p><img src="https://habrastorage.org/webt/s3/d9/ca/s3d9ca1otjtkwql3_qakv67am7c.png"></p><br><p>  Mayor intercambio de datos.  Esto implica que si necesitamos hacer una copia de seguridad, no todo.  O restaurar no todo.  Esto solo es posible con copias de seguridad l√≥gicas, y esto nos permite hacer solo pg_dump.  Las utilidades proporcionan una funcionalidad bastante amplia.  Pg_dump puede permitirle volcar la estructura de la base de datos si es necesario.  Puede volcar espec√≠ficamente una tabla o puede excluir una tabla del volcado o volcar la lista de tablas, excluir la lista.  La funcionalidad es bastante amplia a este respecto.  La desventaja de esto es que cuando se recupera de un volcado de este tipo, si tiene una base de datos grande, tendr√° que pasar mucho tiempo para recuperarse de ella, porque todo esto debe reproducirse en una instancia pura de PostgreSQL. <br>  Estas utilidades son muy convenientes para usar el caso cuando sobreestimamos nuestras fortalezas y no creamos un mont√≥n de peque√±as bases de datos.  Podemos fusionarlos en una instancia.  Podemos verlo de esta manera si nuevamente evaluamos nuestra fortaleza, nuestra base de datos est√° hinchada o si estamos cambiando la arquitectura de un monolito a uno de servicio y aserrando los datos.  Pg_dump en este caso es lo √∫nico que le permite hacer esto sin dolor. </p><br><p>  Tambi√©n puede restaurar una base de datos y pgbackrest se enumera aqu√≠.  √âl tiene tal chip, que podemos indicar que solo necesitamos una base de datos de respaldo binario.  Que esta haciendo el  Restaura la base de datos predeterminada de la copia de seguridad, esto es plantilla y postgres y la base de datos que especificamos.  Todas las dem√°s bases de datos, restablece los archivos y los hace de longitud cero.  Es decir, PostgreSQL tiene una estructura transparente para almacenar bases de datos en archivos, all√≠ puede, por as√≠ decirlo, reducir la base de datos restaurada.  Supongamos que necesitamos encontrar qu√© datos urgentes de un binario, no queremos aumentar la base de 10 TB, tenemos dos bases all√≠ y aumentamos una, lo que permite un total de 5 TB.  En este caso, por supuesto, se viola la consistencia, pero para algunas soluciones r√°pidas, cuando necesita extraer urgentemente sangre de la nariz de una gran base de datos, de la cual hay varias, estas son caracter√≠sticas muy buenas.  Pero como una base de datos de respaldo completa no debe considerarse durante la recuperaci√≥n.  Es decir, es para trabajos de emergencia. </p><br><p><img src="https://habrastorage.org/webt/bq/pf/aj/bqpfaj0wvrtn1atsq0yj1j4x7de.png"></p><br><p>  ¬øC√≥mo es el trabajo con muchas versiones de la base de datos?  Aqu√≠, tambi√©n, todo es bastante interesante.  Pg_dump es muy bueno porque no estamos vinculados a qu√© versi√≥n de la base de datos para restaurar.  Hay un modo de texto sin formato, y es solo SQL puro, que describe la estructura completa de la base de datos, todos los datos.  En principio, puede recuperarse de donde quiera, en MySQL, en MSSQL, en Oracle con algunas ediciones en este volcado.  Entre las versiones principales de PostgreSQL, estos volcados tambi√©n son bastante f√°ciles de usar. <br>  Versiones m√∫ltiples, ¬øqu√© quiero decir con esto?  Esto es hasta qu√© punto la utilidad puede procesar diferentes versiones de bases de datos y trabajar simult√°neamente con PostgreSQL 9.6, 10, 11. Todo, excepto los integrados de pg_dump y pg_basebackup, porque est√°n vinculados a la versi√≥n espec√≠fica con la que vienen.  El resto se centra en estas utilidades.  Se pueden indicar donde se encuentran pg_basebackup, pg_dump de diferentes versiones.  Ellos, respectivamente, con la versi√≥n de PostgreSQL, eligen la √∫ltima utilidad para eliminar la copia de seguridad. <br>  Todas las utilidades, excepto pg_dump, son adecuadas para crear r√©plicas y servidores en espera, ya que son copias de seguridad l√≥gicas.  Con cualquiera de estas utilidades, puede restaurar los servidores y conectarse al asistente para que funcione como una r√©plica de este servidor. </p><br><p><img src="https://habrastorage.org/webt/rk/mr/jp/rkmrjpvyme8ifuybv7jvpkqd0r4.png"></p><br><p>  C√≥mo se pueden eliminar las copias de seguridad en general, qu√© modos existen para eliminar las copias de seguridad.  Simplemente puede copiar archivos utilizando herramientas est√°ndar del sistema operativo: a trav√©s del protocolo ssh (rsync, scp) y posiblemente algunas otras utilidades que son.  Por qu√© existe esa oportunidad, porque le permiten paralelizar la copia.  Pgbackrest solo funciona de esta manera, barman puede funcionar de esa manera, y puede funcionar usando el protocolo PostgreSQL. <br>  Protocolo PostgreSQL: cuando la utilidad de copia de seguridad se conecta a PostgreSQL y extrae todos los archivos y los registros de archivo que surgen durante el proceso de copia de seguridad utilizando el protocolo de replicaci√≥n.  Todos los dem√°s y el barman pueden hacerlo. <br>  B√°sicamente, todo puede hacer una copia de seguridad desde una r√©plica, depende de la versi√≥n de PostgreSQL.  Con PostgreSQL 10 y 11, podemos eliminar las copias de seguridad de una r√©plica.  Pero no recomiendo esto, en general, nadie de nuestra compa√±√≠a lo recomendar√°.  Debido a que hay situaciones en las que se perdi√≥ el monitoreo, tomaron una copia de seguridad de la r√©plica durante un mes, que se cay√≥ del servidor maestro y no es relevante.  Es decir, las copias de seguridad en cualquier caso siempre deben eliminarse del servidor maestro.  Solo en este caso, estar√° seguro de tener una base de datos de respaldo realmente actualizada. <br>  Copias de seguridad de subprocesos m√∫ltiples: todos pueden hacer esto, porque todo es por diferentes razones, alguien a trav√©s del protocolo ssh, alguien implementado en el nivel de copia de la base de datos.  Excepto pg_basebackup y BART, porque la operaci√≥n BART solo est√° en pg_basebackup cuando se elimina la copia de seguridad y, desafortunadamente, es de un solo subproceso y no tendr√° subprocesos m√∫ltiples. </p><br><p><img src="https://habrastorage.org/webt/72/4x/j0/724xj0dcehoennfciyo2uzucisq.png"></p><br><p>  Un ejemplo de multihilo.  Estaba restaurando una base de datos de 8 TB.  Cuando se concentra en elegir un sistema para eliminar las copias de seguridad, sepa que wal-e est√° escrito en Python, wal-g est√° escrito en Golang.  Tuve que restaurar la base de 8 TB.  Wal-e se top√≥ con la limitaci√≥n de Python y me arrastr√≥ con AWS a una velocidad de 600 Mbps.  Cuando cambi√© a wal-g, ten√≠a una situaci√≥n en la que no pod√≠a trabajar con copias de seguridad de wal-e, pero pod√≠a extraer archivos wal.  Por lo tanto, esta imagen del medio aqu√≠ es la restauraci√≥n de la base de datos.  Luego rod√≥ wal, que yac√≠a all√≠ en S3 y fue restaurado a un cierto punto en el tiempo.  Wal-e se top√≥ con la limitaci√≥n de Python y la concurrencia en Python, es muy condicional.  Un wal-g se top√≥ con la interfaz S3, es decir, qu√© tan r√°pido podr√≠a dar S3 en cada momento, tan r√°pido que tom√≥.  En promedio, fue de 2 Gb / s, que es lo suficientemente bueno.  Es decir, con wal-e, se recibi√≥ una hora de cambios en la base de datos en 45 minutos de copia de seguridad continua.  Con wal-g, result√≥ que rodaron una hora en alg√∫n lugar de la base de datos durante aproximadamente 5 minutos. </p><br><p><img src="https://habrastorage.org/webt/rj/nk/fa/rjnkfaa9ld-am4dazwrasjqwfbk.png"></p><br><p>  Modos de funcionamiento, lo que es interesante aqu√≠ en el sistema de respaldo. </p><br><ul><li>  Recuperaci√≥n en el tiempo a un punto espec√≠fico.  Si hemos archivado registros y los copiamos, podemos restaurarlos.  Le permite hacer un sistema de respaldo, es como un factor est√°ndar.  Lo principal es que almacenamos archivos wal en alg√∫n lugar.  Los vertederos, por supuesto, no saben c√≥mo, porque son un poco acerca de otra cosa. </li><li>  Ajustar la carga en la red es algo muy importante, porque como dije, es deseable eliminar el volcado del servidor maestro, luego se garantiza que realmente obtendr√° la copia de seguridad real.  Bueno, a veces sucede que los servidores est√°n tan cargados que es bastante dif√≠cil entrar all√≠.  Tenemos algunos clientes pegan una interfaz de red separada.  A veces se realiza un tiempo de carga m√≠nimo.  Tambi√©n es bueno cuando podemos especificar la carga en la red al crear una copia de seguridad.  Esto le permite hacer pg_basebackup, barman y BART, wal-e, wal-g. </li><li>  Compresi√≥n sobre la marcha.  Esta es una cuesti√≥n de cu√°nto transmitiremos a trav√©s de la red.  Si podemos comprimir el archivo antes de enviarlo al repositorio, entonces esto es bueno sobre la marcha.  Y casi todos pueden hacerlo, aqu√≠.  Lo principal es indicar el nivel de compresi√≥n all√≠. </li></ul><br><p><img src="https://habrastorage.org/webt/lv/pe/vd/lvpevdlrpqrg-9hypasdcs9-dse.png"></p><br><p>  Capacidad de servicio, ¬øqu√© es lo interesante aqu√≠ para los sistemas de respaldo? </p><br><ul><li>   CLI ‚Äî    ,               ,     ,        ,      .    ,       CLI,     ,     ,     .       ,       ,      . </li><li>         barman, pgbackrest  BART,        .   ,        20-30  ,    ,    ,          ,           backup-           . ,  ,     . </li><li>    ‚Äì          ,     ,       backup-,   ,    backup-.           ,     -   .         .       . </li><li>   ‚Äì                 backup-,   ,  -   .     ,    ,     .  ,   , ,      ,       wal ,   ,        .   wal-e, wal-g,      ,    backup      - .  7 backup    . </li></ul><br><p><img src="https://habrastorage.org/webt/zj/r0/es/zjr0esauswimuw1itkqosshmyla.png"></p><br><p>   backup.  ,       backup,    backup  ,    ,        .  ,       .     ,   .   .    stage   .   ,       ,    backup .   CLI  ,           backup    . </p><br><p>     ,      ,  .         ,    backup .   ,     .  ,    .  ,    .   .   checksum  PostgreSQL.      ,      checksum  PostgreSQL.       checksum,   . </p><br><p>  pgbackrest  pg_probackup    backup  ,     checksum.          checksum. </p><br><p>  ,    backup,      checksum , ,   checksum   .     . </p><br><p><img src="https://habrastorage.org/webt/mj/_e/di/mj_edibaxks4v2_4-t5kanbxghe.png"></p><br><p>  : </p><br><ul><li> <a href="https://www.postgresql.org/docs/10/static/app-pgdump.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgdump.html</a> </li><li> <a href="https://www.postgresql.org/docs/10/static/app-pgbasebackup.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgbasebackup.html</a> </li><li> <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">https://www.2ndquadrant.com/en/resources/barman/</a> </li><li> <a href="https://github.com/wal-e/wal-e" rel="nofollow">https://github.com/wal-e/wal-e</a> </li><li> <a href="https://github.com/wal-g/wal-g" rel="nofollow">https://github.com/wal-g/wal-g</a> </li><li> <a href="https://pgbackrest.org/" rel="nofollow">https://pgbackrest.org/</a> </li><li> <a href="https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool" rel="nofollow">https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool</a> </li><li> <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">https://postgrespro.ru/products/extensions/pg_probackup</a> </li></ul><br><p>      .   ,     .       ,     . </p><br><p><img src="https://habrastorage.org/webt/tt/qn/i7/ttqni7mc49sw-n6bww9bpi1gese.png"></p><br><p> :  ,  backup      ,     ,   ,   .       ,      ,       backup.    ,  ,  -    , ,   ,  ,    ,     ,   .    -    ? </p><br><p> :       ,        ,       .     .   .  -   , , backup   ,   ,       ,      .          ,         .    ,  , , ,  ,   ,     /     .  ,       ,       .      ,     .   ,      .       ,        . </p><br><p> :    , ,    ?       . </p><br><p> :        .         4 .       .     .      backup.       .    ,     . </p><br><p> :         ? </p><br><p> :    .       .   wal-e, wal-g, pgbackrest.    borman, pg_dump,   basebackup.    ,      ,       .   . </p><br><p> :  ,    -     PostgreSQL,   , , postgis  - -? </p><br><p> :    ,      backup   ,      .  checksum  ,  PostgreSQL   checksum,   ,       .   postgis,     -      . Pg_dump      ,    ,   , SQL .        SQL .     . , ,         .    dump,       . </p><br><p> :  ,     .   ,          -  ? </p><br><p> :     .    dump  ,         .    ,    ‚Äì    ,  ,  - ,  ,     .      ,    . ,   -  ,      . </p><br><p> :   ,     ,   ,  bloat   ? </p><br><p> : . </p><br><p> :    ‚Äî  ,     -    . , Symantec, Veritas Backup Exec  .      PostgreSQL? </p><br><p> : ,      ,      . PostgreSQL     ,    pg_start_backup.  ,  .     . </p><br><p> :  ,  -  Symantec, Veritas Backup Exec      . </p><br><p> :   . </p><br><p> : , ,      .   checksum    - ,   , - ? </p><br><p> :    ‚Äî            .        stage ,    .    stage    .       .             .    ,      -,        .     .      . </p><br><p> :   ,      WAL ,   S3.        wal-e, wal-g    - awscli  .      ? </p><br><p>  (  ):   wal-g.     wal-g.      40     wal-g .      .  ,   .   , prefetch,   wal  ,    . ,      ‚Äî  ,       wal.    wal   ,   page cache   ,  ,      wal,       ,        .     ,   . </p><br><p>  :     .   ,     PostgreSQL ‚Äî   -&gt; /dev/null,  ,      .        ,          .       smoke .   <a href="https://postgrespro.ru/docs/postgresql/10/amcheck" rel="nofollow">amcheck</a> ,      .        ,        ,     ,       . </p><br><p> :       10  .       .            .    .       wal  ‚Äî      .      ? </p><br><p> :        .      .      .         ,        . </p><br><p> :          ,       pg_dump,        . ? </p><br><p> : -     . ,   . </p><br><p> :   ,      ,    - ? </p><br><p> : pg_dump   ,    . </p><br><p> :     pg_dump,    ,   ,   ,         ,    . </p><br><p> :         ,       -,    . </p><br><p> :   ,   . </p><br><p> :        ,       -  . </p><br><p> :    .     .      .      . ,     ,    .   . Pg_dump  ,  - ,  exit_code  .   ,       , .   ,      . </p><br><p> PS ‚Ññ1        pg_dump, pg_basebackup. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th> barman </th><th> wal-e </th><th> wal-g </th><th> pg_probackup </th><th> pgbackrest </th><th> BART </th></tr></thead><tbody><tr><td> ssh (rsync, scp) </td><td> + </td><td></td><td></td><td></td><td> + </td><td></td></tr><tr><td>     </td><td> + </td><td> + </td><td> + </td><td> + </td><td> + </td><td> + </td></tr><tr><td> S3 </td><td></td><td> + </td><td> + </td><td></td><td> + </td><td></td></tr><tr><td> Azure </td><td></td><td> + </td><td> + </td><td></td><td></td><td></td></tr><tr><td> Google Cloud </td><td></td><td> + </td><td> + </td><td></td><td></td><td></td></tr><tr><td>    </td><td> + </td><td> + </td><td> + </td><td> + </td><td> + </td><td></td></tr><tr><td>   </td><td></td><td></td><td> + </td><td></td><td> + </td><td></td></tr><tr><td>   </td><td></td><td></td><td> + </td><td></td><td> + </td><td></td></tr><tr><td></td><td> barman </td><td> wal-e </td><td> wal-g </td><td> pg_probackup </td><td> pgbackrest </td><td> BART </td></tr><tr><td>    </td><td></td><td></td><td> + </td><td> + </td><td></td><td></td></tr><tr><td>    </td><td></td><td></td><td></td><td></td><td> + </td><td></td></tr><tr><td> - </td><td> + </td><td> + </td><td> + </td><td> + </td><td> + </td><td> + </td></tr><tr><td>   </td><td> + </td><td> + </td><td> + </td><td> + </td><td> + </td><td></td></tr><tr><td> Recuperaci√≥n de un punto en el tiempo </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Ajuste de carga de red </td><td>  + </td><td></td><td>  + </td><td></td><td></td><td>  + </td></tr><tr><td>  Compresi√≥n sobre la marcha </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td>  CLI </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Servidor dedicado </td><td>  + </td><td></td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td></td><td>  barman </td><td>  wal-e </td><td>  wal-g </td><td>  pg_probackup </td><td>  pgbackrest </td><td>  Bart </td></tr><tr><td>  Almacenamiento estructurado de respaldo </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Pol√≠ticas de retenci√≥n </td><td>  + </td><td>  cron </td><td>  cron </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  CLI para monitoreo </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Validez de finalizaci√≥n de copia de seguridad </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Suma de comprobaci√≥n postgresql </td><td></td><td></td><td></td><td>  + </td><td>  + </td><td></td></tr></tbody></table></div><br><p>  PS No. 2 Errores, correcciones seg√∫n el art√≠culo, las adiciones a la tabla din√°mica se pueden hacer a trav√©s de la <a href="" rel="nofollow">solicitud Pull</a> </p><br><p>  PS # 3 Wal-g da la bienvenida a voluntarios para ayudar con la documentaci√≥n. </p><br><p>  PS No. 4 Para instalar wal-g usando rpm, puede usar mi repositorio: <a href="https://github.com/patsevanton/wal-g-rpm" rel="nofollow">Github</a> , <a href="https://copr.fedorainfracloud.org/coprs/antonpatsev/wal-g/" rel="nofollow">Fedora COPR</a> . </p><br><p>  PS No. 5 ¬øC√≥mo hacer una copia de seguridad completa y una copia de seguridad incremental al crear y almacenar en S3 y guardar solo la copia de seguridad completa en cinta?  Si tienes ideas, d√≠melo en los comentarios o en PM. </p><br><p><img src="https://habrastorage.org/webt/r8/hh/ks/r8hhkssl2kpkvvqvat1xgwe8eie.png"></p><br><p>  Encuesta: ¬øQu√© herramientas de respaldo usa? </p><br><p>  PS No. 6 Canal de Telegram PostgreSQL: <a href="https://t.me/pgsql" rel="nofollow">https://t.me/pgsql</a> </p></div></div><p>Source: <a href="https://habr.com/ru/post/485622/">https://habr.com/ru/post/485622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485610/index.html">Cree una aplicaci√≥n Qt en WebAssembly en Windows</a></li>
<li><a href="../485612/index.html">¬øQu√© me ense√±√≥ un accidente espacial como desarrollador?</a></li>
<li><a href="../485614/index.html">La cultura corporativa roja es el principal problema de los negocios rusos (Parte 3)</a></li>
<li><a href="../485618/index.html">Automatizaci√≥n para los m√°s peque√±os. Notas API RESTful</a></li>
<li><a href="../485620/index.html">¬øYoshkar-Ola, en general, una ciudad de TI?</a></li>
<li><a href="../485624/index.html">Servidor Minecraft: Windows vs Linux</a></li>
<li><a href="../485630/index.html">Cosmon√°utica de √Åfrica: de la basura a la realidad</a></li>
<li><a href="../485632/index.html">Monitoreo de la calificaci√≥n crediticia en Power BI</a></li>
<li><a href="../485634/index.html">El tablero de Dungeons and Dragons me ayud√≥ a aprender ingl√©s</a></li>
<li><a href="../485636/index.html">Los virus resistentes a CRISPR construyen refugios para proteger los genomas de las enzimas que penetran el ADN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>