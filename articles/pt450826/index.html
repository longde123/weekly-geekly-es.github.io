<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçä ü§¶üèª üêõ Como falar com o microcontrolador da JS ü§© ü§Æ üßñüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Por que √© necess√°rio um microcontrolador? Por exemplo, para configurar uma cervejaria em casa. Se a sua cervejaria n√£o for suficiente, voc√™ poder√° faz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como falar com o microcontrolador da JS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/450826/">  Por que √© necess√°rio um microcontrolador?  Por exemplo, para configurar uma cervejaria em casa.  Se a sua cervejaria n√£o for suficiente, voc√™ poder√° fazer algo maior: criar uma sala de miss√µes, organizar uma apresenta√ß√£o, uma fonte interativa que pinte uma imagem com gotas ou um estande para uma grande empresa.  Voc√™ pode fazer qualquer coisa com um microcontrolador - tudo depende da sua imagina√ß√£o. <br><br>  Existe um equ√≠voco de que, para criar suas pr√≥prias gl√¢ndulas, voc√™ precisa conhecer o montador, C / C ++, ser capaz de gerenciar mem√≥ria e entender profundamente a eletricidade.  No passado, mas a tecnologia est√° se desenvolvendo e, agora, para a implementa√ß√£o completa de seu projeto, apenas o JS √© suficiente! <br><br><img src="https://habrastorage.org/webt/cc/wc/ou/ccwcoucl5o2c-9xayxy04jc8fsq.jpeg"><br><br>  Ok, sabemos JavaScript, mas como conect√°-lo ao hardware?  Que tipo de ferro existe e o que ele pode fazer?  Como configurar todo o sistema?  Na decodifica√ß√£o do relat√≥rio, Victor Nakoryakova no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FrontendConf</a> aprender√°: como, usando apenas JS, para controlar servos, como combinar fisicamente o sistema com um PC e sobre as op√ß√µes de comunica√ß√£o para o aplicativo em JS.  Discutiremos os pacotes serialport e Firmata, serialport com firmware auto-escrito em C ++, Espruino e a programa√ß√£o do controlador diretamente em JS, Raspberry Pi, HTTP na rede local e HTTP e MQTT na nuvem. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/yqeTaf44vNk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <strong>Victor Nakoryakov</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">nailxx</a> ) - diretor t√©cnico, co-fundador da Amperka.  Ele gosta de tecnologias avan√ßadas de desenvolvimento, programa√ß√£o funcional e computa√ß√£o f√≠sica.  A Amperka fabrica e vende m√≥dulos eletr√¥nicos para que os n√£o profissionais criem dispositivos inteligentes com as pr√≥prias m√£os, kits de treinamento e componentes individuais que podem ser adicionados ao dispositivo - motores, GPS, SMS. <br><br><h2>  Onde escrever JavaScript </h2><br>  <strong>O Espruino possui um microcontrolador independente com JavaScript.</strong>  A plataforma Espruino permite escrever JS diretamente no microcontrolador.  Isso √© algo aut√¥nomo em si: conectado a um computador, piscou e, em seguida, funciona de forma independente. <br><br>  <strong>O Raspberry Pi</strong> √© um pequeno computador com GPIO. <br><br>  <strong>Em um aplicativo Web</strong> , para o front-end ou back-end. <br><br>  Vou mostrar a opera√ß√£o do sistema usando um exemplo de sapo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√°</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">toad.amperka.ru a</a> partir do seu telefone - uma interface web simples ser√° exibida. <br><br><img src="https://habrastorage.org/webt/pd/ya/be/pdyabe5bjmklkee0jjco7nontue.jpeg"><br><br>  A coluna esquerda controla o olho esquerdo, o direito - o direito.  O princ√≠pio √© simples - apertei o bot√£o, o servomotor vira o olho. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oc/z5/re/ocz5rert1d774i6ic7dzkaahjpa.gif" width="350"></div><br><br>  Demonstra√ß√£o em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo</a> de uma posi√ß√£o com um sapo durante o relat√≥rio. <br><br><h2>  Como o sapo funciona </h2><br>  Ao abrir o toad.amperka.ru, voc√™ obt√©m uma p√°gina da Web est√°tica com JS est√°tico, que usa a biblioteca <a href="">MQTT.js.</a>  Esta biblioteca entra em contato com o broker MQTT na nuvem. <br><br><img src="https://habrastorage.org/webt/5r/7h/it/5r7hit4db5ds9369m2fgmsua8t4.jpeg"><br><br>  Se voc√™ conhece Redis, Publish / Subscribe, RabbitMQ ou outras filas de mensagens, entendeu imediatamente do que se tratava.  <strong>O MQTT √© um intermedi√°rio de mensagens Machine-to-Machine</strong> .  Leve e simples, para que at√© as gl√¢ndulas fracas possam us√°-lo. <br><br>  O MQTT requer um broker no servidor.  Mas voc√™ nem precisa levant√°-lo - alugue.  Por alguns d√≥lares por m√™s, voc√™ ter√° seu pr√≥prio broker MQTT.  N√£o √© necess√°rio back-end. <br><br>  Por outro lado, h√° um controlador do broker MQTT.  Existem muitos dispositivos diferentes com essa fun√ß√£o, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">slot Wi-Fi</a> .  Este √© um controlador que pode se conectar √† Internet. <br><br><img src="https://habrastorage.org/webt/th/dz/jc/thdzjcdluwlertps_bl5lbkdjui.jpeg"><br><br>  Funciona com base no popular chip ESP8266.  Foi adicionada a capacidade de alimentar via micro-USB e conectar perif√©ricos externos via contatos triplos para conectar-se a outros dispositivos. <br><br><h2>  Como programar hardware em JS </h2><br>  Nada fora do comum, JS regular - ES6 quase completo.  Algumas fun√ß√µes e objetos para trabalhar em um n√≠vel baixo com sinais el√©tricos foram adicionados √† biblioteca padr√£o.  Por exemplo, fun√ß√µes para leitura e escrita digital simples. <br><br>  <strong>digitalRead - leitura digital</strong> .  Esta √© uma pergunta para o controlador: "Existem tr√™s volts no pino n√∫mero 4?"  Se houver tens√£o, retornar√° VERDADEIRO; se n√£o, FALSO.  Isso implementa a leitura de sensores bin√°rios simples: bot√µes, interruptores, fechaduras de palheta e sensores de movimento infravermelho. <br><br>  <strong>digitalWrite √© uma simples grava√ß√£o digital</strong> .  Dizemos digitalWrite TRUE - 3V com pino.  Dizemos digitalWrite FALSE - 0V.  Usando esse princ√≠pio simples, voc√™ pode acender / apagar uma faixa de LED ou lan√ßar um m√≠ssil nuclear.  Enviamos um sinal fraco ao rel√©, ele comuta uma grande carga e o foguete voou. <br><br>  Tamb√©m existem fun√ß√µes para trabalhar com valores intermedi√°rios entre 0 e 3V: <br><br><ul><li>  analogRead; </li><li>  analogWrite; </li><li>  setWatch; </li><li>  digitalPulse. </li></ul><br>  Os comandos permitem que voc√™ interrogue todos os tipos de tor√ß√µes e forne√ßa fun√ß√µes para grava√ß√£o difusa. <br><br>  Em seguida, v√™m os objetos para trabalhar com interfaces que s√£o aceitas no mundo dos microcontroladores.  Se na web entendemos e estamos familiarizados com HTTP, WebSocket, TCP, ent√£o para um microcontrolador √©: <br><br><ul><li>  Porta serial - serial; </li><li>  Barramento I2C </li><li>  Barramento SPI </li><li>  √înibus OneWire. </li></ul><br><h2>  Como chutar um servomotor </h2><br>  Por exemplo, eu vou lhe dizer como controlar um motor que fica em uma posi√ß√£o hipod√©rmica.  O protocolo do motor √© simples.  0V √© aplicado ao pino de controle - o limite inferior.  Uma vez a cada 20 Œºs, ele precisa ser chutado, fornecendo uma unidade est√°vel de 3V e depois de um tempo - redefinir para 0. <br><br><img src="https://habrastorage.org/webt/io/1t/aj/io1tajdpojik7cxsab0mrddw0bi.jpeg"><br><br>  Ent√£o tudo se repete novamente.  Dependendo do comprimento da unidade, obtemos diferentes velocidades de rota√ß√£o.  Com um comprimento de pulso de 1.500 Œºs, o motor fica parado.  Quando desviado em uma dire√ß√£o ou outra, gira no sentido hor√°rio ou anti-hor√°rio.  A magnitude do desvio afeta a velocidade de rota√ß√£o. <br><br><h2>  Como programar </h2><br>  A programa√ß√£o da plataforma Espruino √© feita no IDE Espruino com o mesmo nome.  A placa do microcontrolador est√° conectada ao computador com um cabo micro-USB.  A √∫nica coisa √© que voc√™ precisa instalar o driver, o que leva 1,5 minutos.  O driver est√° instalado para MAC e Windows, e no Linux tudo funciona imediatamente. <br><br>  Aqui est√° um exemplo de um programa que √© carregado no ambiente com um clique.  Ele pisca um LED uma vez por segundo: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ on = !on; LED1.write(on); },<span class="hljs-number"><span class="hljs-number">500</span></span>);</code> </pre> <br>  √Ä esquerda no ambiente est√° o int√©rprete REPL.  Digite "1 + 1".  O programa fornece a resposta "2".  Milagre! <br><br>  O milagre √© que, quando voc√™ pressiona os bot√µes, o n√∫mero ‚Äú1‚Äù, o sinal ‚Äú+‚Äù e a pr√≥xima unidade passam pelo cabo do controlador.  Quando voc√™ pressiona ENTER, a express√£o √© executada dentro do microcontrolador, n√£o no computador.  O microcontrolador obteve o resultado ‚Äú2‚Äù e o retornou de volta ao computador atrav√©s de um cabo.  ‚Äú2‚Äù foi exibido no monitor. <br><br><blockquote>  JavaScript √© executado dentro do hardware. </blockquote><br>  Al√©m do entretenimento com aritm√©tica, voc√™ pode girar os motores.  Voc√™ precisar√° da fun√ß√£o analogWrite, que envia uma onda quadrada.  Falamos sobre o alfinete para emitir uma onda.  Por exemplo, no meu quadro, ele √© assinado como A7.  Em seguida, indicamos a dura√ß√£o - por exemplo, 1300 Œºs de 20 000 Œºs, serviremos um.  Tamb√©m √© necess√°ria uma op√ß√£o que define a frequ√™ncia desse chute - 50 vezes por segundo, ou seja, 20.000 Œºs. <br><br><pre> <code class="javascript hljs">&gt;analogWrite(A7, <span class="hljs-number"><span class="hljs-number">1300</span></span> / <span class="hljs-number"><span class="hljs-number">2000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">freq</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>}} =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  Passaremos por 1500 - for√ßaremos a girar na outra dire√ß√£o com maior velocidade. <br><br><pre> <code class="javascript hljs">&gt;analogWrite(A7, <span class="hljs-number"><span class="hljs-number">2300</span></span> / <span class="hljs-number"><span class="hljs-number">2000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">freq</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>}} =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  Ou diga para. <br><br><pre> <code class="javascript hljs">&gt;digitalWrite(A7, <span class="hljs-number"><span class="hljs-number">0</span></span>) =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  Usando as mesmas fun√ß√µes, voc√™ pode escrever um programa inteiro que, dependendo de fatores externos - pressionando bot√µes, leituras do sensor - far√° o que voc√™ deseja. <br><br><h3>  Bibliotecas </h3><br>  Nem sempre √© conveniente recuperar os detalhes da implementa√ß√£o do protocolo.  Portanto, para todos os tipos de ferro, muitas bibliotecas foram criadas, de pequenas a gigantes.  Eles cont√™m todos os recursos t√©cnicos.  As bibliotecas usam m√©todos compreens√≠veis: ler dados de uma etiqueta nfc, ler a concentra√ß√£o de di√≥xido de carbono em ppm ou enviar uma mensagem ao Telegram. <br><ul><li>  servo.write; </li><li>  barometer.init; </li><li>  barometer.read; </li><li>  barometer.temperature; </li><li>  nfc.listen; </li><li>  nfc.on ('tag', ...); </li><li>  nfc.readPage; </li><li>  nfc.writePage; </li><li>  relay.turnOn; </li><li>  relay.turnOff; </li><li>  gas.calibrate; </li><li>  gas.read ('CO2'); </li><li>  telegram.sendMessage. </li></ul><br>  √â √∫til entender os comandos de baixo n√≠vel, mas para come√ßar a criar, n√£o √© necess√°rio saber. <br><br><h2>  C√≥digo do Cliente </h2><br>  Portanto, quando clicamos em um dos bot√µes da coluna esquerda ou direita em nosso sapo, o valor que queremos definir no servo correspondente √© enviado ao t√≥pico sapo / olho / esquerda ou direita. <br><br><img src="https://habrastorage.org/webt/y1/3e/mt/y13emt_fcb-qdw2j_tihccn8ukm.jpeg"><br><br><pre> <code class="javascript hljs">&lt;button <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"toad__eye__control"</span></span> data-queue=<span class="hljs-string"><span class="hljs-string">"left"</span></span> data-payload=<span class="hljs-string"><span class="hljs-string">"1300"</span></span>&gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/button&gt;</span></span></code> </pre> <br>  1300 √© a dura√ß√£o do pulso.  De onde v√™m a esquerda e 1300?  Acabei de adicion√°-los ao HTML como atributos de dados. <br><br>  Em JS, escrevemos c√≥digo simples. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mqtt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mqtt'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = mqtt.connect(<span class="hljs-string"><span class="hljs-string">`ws://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${location.hostname}</span></span></span><span class="hljs-string">:9001`</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEyeControlClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { queue, payload } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataset; client.publish(<span class="hljs-string"><span class="hljs-string">`toad/eye/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${queue}</span></span></span><span class="hljs-string">`</span></span>, payload); } <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelectorAll(<span class="hljs-string"><span class="hljs-string">".toad__eye__control"</span></span>) .forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, onEyeControlClick));</code> </pre> <br>  Vamos analisar o c√≥digo em partes.  No in√≠cio, nos conectamos ao broker, que por padr√£o funciona na porta 9001: <code>const client = mqtt.connect(`ws://${location.hostname}:9001`);</code>  . <br><br>  Ao clicar em qualquer um dos bot√µes, publicamos uma nova mensagem com carga √∫til, que recebemos do atributo de dados: <code>client.publish(`toad/eye/${queue}`, payload);</code>  . <br><br>  Em seguida, publicamos sobre o t√≥pico, que tamb√©m √© formado com base no atributo de dados.  Esse √© todo o nosso c√≥digo JS no navegador. <br><br><h2>  C√≥digo do Conselho </h2><br>  Quando o slot Wi-fi √© iniciado, ele se inscreve nos t√≥picos de interesse e recebe os dados.  Quando eles chegam, o slot responde e faz os motores funcionarem. <br><br><img src="https://habrastorage.org/webt/5r/7h/it/5r7hit4db5ds9369m2fgmsua8t4.jpeg"><br><br>  O c√≥digo no quadro √© convencionalmente dividido em v√°rias partes.  Para come√ßar, estamos conectando bibliotecas.  Em particular, esta √© apenas a <strong>biblioteca que executa o Servo</strong> para n√£o recuperar detalhes.  Eles est√£o no escopo de amperka. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ssid = <span class="hljs-string"><span class="hljs-string">"Droidxx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> password = <span class="hljs-string"><span class="hljs-string">"****"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> brokerHostname = <span class="hljs-string"><span class="hljs-string">"toad.amperka.ru"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> leftEye = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"@amperka/servo"</span></span>).connect(A5); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rightEye = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"@amperka/servo"</span></span>).connect(A7).</code> </pre> <br>  Todos podem criar e publicar suas pr√≥prias bibliotecas.  Fizemos v√°rias dezenas para nossos pr√≥prios e outros m√≥dulos populares.  All Open Source - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">entre, use-o</a> . <br><br>  Ent√£o, precisamos de <strong>bibliotecas para trabalhar com os corretores Wi-Fi e MQTT</strong> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wifi = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"Wifi"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mqtt = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"tinyMQTT"</span></span>).create(brokerHostname);</code> </pre> <br>  N√£o h√° sistema operacional, portanto, mesmo a conex√£o ao Wi-Fi √© uma opera√ß√£o manual.  O cuidado de conex√£o √© seu, mas n√£o √© t√£o dif√≠cil.  Para conectar-se √† rede, simplesmente chamamos o m√©todo "connect", que, se for bem-sucedido ou n√£o, chamar√° "callback" e relatar√° os resultados da opera√ß√£o. <br><br><pre> <code class="javascript hljs">wifi.connect(ssid, { <span class="hljs-attr"><span class="hljs-attr">password</span></span>: password }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error connecting:"</span></span>, e); wifi.disconnect(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Wi-Fi OK, connecting to broker ..."</span></span>); mqtt.connect(); } });</code> </pre> <br>  Se tudo estiver bem, conecte-se ao broker MQTT. <br><br>  Ap√≥s uma conex√£o bem-sucedida, subscrevemos t√≥picos interessantes, ou seja, tudo o que come√ßa com sapo / olho. <br><br><pre> <code class="javascript hljs">mqtt.on(<span class="hljs-string"><span class="hljs-string">"connected"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ mqtt.subscribe(<span class="hljs-string"><span class="hljs-string">"toad/eye/*"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Connected to broker"</span></span>, brokerHostname); });</code> </pre> <br>  Quando recebemos uma mensagem, descobrimos de onde ela veio.  Isso √© muito semelhante a uma simples an√°lise de URL.  Dependendo do t√≥pico, decidimos qual olho influenciaremos.  Se voc√™ tem algo consciente, ent√£o, nesse olho, escrevemos o que veio em "carga √∫til" em microssegundos. <br><br><pre> <code class="javascript hljs">mqtt.on(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eye = (msg.topic === <span class="hljs-string"><span class="hljs-string">"toad/eye/left"</span></span>) ? leftEye : (msg.topic === <span class="hljs-string"><span class="hljs-string">"toad/eye/right"</span></span>) ? rightEye : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eye) { eye.write(<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(msg.message), <span class="hljs-string"><span class="hljs-string">"us"</span></span>); } });</code> </pre> <br>  Essa √© toda a magia de um sapo. <br><br><h2>  Limita√ß√µes de Espruino JS </h2><br>  Passamos pela plataforma Espruino.  Torcer os sapos n√£o √© sua √∫nica op√ß√£o.  Mas a plataforma tem seus pr√≥prios cardumes, o que nos leva a considerar outras op√ß√µes. <br><br>  <strong>‚ÄúTotal‚Äù 1‚Äì4 Mb de RAM</strong> .  H√° uma limita√ß√£o na RAM.  No c√≥digo e nos dados ao mesmo tempo, apenas alguns megabytes s√£o fornecidos.  Pode parecer que em uma √©poca em que a RAM √© medida por shows, isso n√£o √© suficiente.  Mas para um grupo de pequenos dispositivos isso √© suficiente.  Com 2 Mb, voc√™ pode fazer coisas maravilhosas - o suficiente para a fonte. <br><br>  <strong>N√£o √© t√£o simples com o NPM</strong> .  Esse problema se aplica ao IDE do Espruino.  Se escrevermos ‚Äúexigir‚Äù, o Espruino procurar√° em um lugar, em outro e, se n√£o, produzir√° um fallback no NPM.  Neste ponto, pode diminuir a velocidade.  O Espruino nem sempre √© capaz de lidar com pacotes complexos.  Seu poder, nesse sentido, √© muito menor que o do mesmo Webpack ou Parcel.  Isso √© uma dor, mas se voc√™ mesmo configurar a cadeia de ferramentas, com uma compreens√£o do que est√° acontecendo dentro do ferro, n√£o haver√° problema. <br><br>  <strong>Variedade de ferro.</strong>  Nem todo hardware chamado plataforma de desenvolvimento puxa o Espruino.  Pelos padr√µes do mundo dos microcontroladores, o Espruino √© voraz - ele precisa de 500 Kb de RAM.  Essa mem√≥ria n√£o dar√° nenhum peda√ßo de ferro.  O canh√£o Arduino Uno ou Arduino Nano possui apenas 2 Kb de RAM - portanto, √© imposs√≠vel por l√°.  √â poss√≠vel trabalhar com o Espruino no hardware, o que fazemos no hardware oficial do Espruino. <br><br><img src="https://habrastorage.org/webt/gb/fx/9-/gbfx9-t4nskmti1hepnxlkz-lx0.png"><br><br>  A Espruino √© uma empresa de uma pessoa que frequentemente usa o Kickstarter com novos produtos e sempre coleciona com sucesso.  Se voc√™ deseja apoiar a plataforma - compre oficialmente. <br><br>  Existe uma terceira op√ß√£o - escolha uma devboard poderosa o suficiente, mas de terceiros.  Por exemplo, a empresa ST, que produz "Nuclear" e "Discovery".  √â prov√°vel que o ferro rotulado com STM32 puxe o Espruino. <br><br>  Vamos examinar duas op√ß√µes alternativas.  O primeiro √© o Raspberry Pi. <br><br><h2>  Raspberry pi </h2><br><blockquote>  Este √© um computador Linux completo do tamanho de um cart√£o de visita. </blockquote><br><br><img src="https://habrastorage.org/webt/y_/af/ws/y_afwsgmlr9e7fvkesyrwlvobak.jpeg"><br><br>  Al√©m disso, existem pinos de entrada / sa√≠da.  Se voc√™ tiver o Raspberry Pi √† sua disposi√ß√£o, use a seguinte topologia de dispositivo. <br><br><img src="https://habrastorage.org/webt/if/1a/jf/if1ajfsmxsvwwcap7ac_cpu8i2k.jpeg"><br><br>  Aqui a nuvem √© opcional - um dispositivo m√≥vel pode se conectar diretamente ao dispositivo via nome do host, API ou sistema para detectar automaticamente um dispositivo na rede.  Eu tenho uma TV inteligente e um disco r√≠gido de backup em casa.  Eles s√£o acess√≠veis a partir de todos os outros dispositivos, simplesmente porque est√£o na mesma LAN. <br><br>  O princ√≠pio √© o mesmo.  Coloque o dispositivo no Raspberry Pi na rede e construa o cliente para que ele se conecte diretamente a ele atrav√©s de HTTP ou WebSocket, ignorando os intermedi√°rios.  A nuvem usa o aplicativo no Raspberry Pi para seus prop√≥sitos: registra sensores ou transmite previs√µes meteorol√≥gicas. <br><br>  A pr√≥xima topologia poss√≠vel com um back-end completo. <br><br><img src="https://habrastorage.org/webt/if/1a/jf/if1ajfsmxsvwwcap7ac_cpu8i2k.jpeg"><br><br>  O servidor sobe na nuvem.  Seu cliente √© o mesmo aplicativo m√≥vel que mant√©m uma conex√£o via HTTP ou WebSocket.  Por outro lado, a conex√£o j√° √© realizada atrav√©s do Raspberry Pi, usando HTTP ou o mesmo MQTT. <br><br>  Nesta abordagem, a vantagem √© o controle total: valida√ß√£o, autoriza√ß√£o, nega√ß√£o para os clientes.  Ao mesmo tempo, a disponibilidade mundial √© um dispositivo em Moscou e a comunica√ß√£o com ele est√° dispon√≠vel em Vladivostok. <br><br><h3>  Limita√ß√µes do Raspberry Pi </h3><br>  <strong>Carregamento longo.</strong>  Raspberry Pi √© um computador completo e leva tempo para come√ßar.  Como disco r√≠gido, √© usado um cart√£o SD.  At√© o cart√£o mais r√°pido ainda perde um HDD comum, sem mencionar o SSD.  Com o tempo, a carga est√° se aproximando de um minuto. <br><br>  <strong>A pr√≥xima desvantagem √© o consumo de energia</strong> .  Em termos de efici√™ncia energ√©tica, fale sobre o Raspberry Pi como um dispositivo m√≥vel.  N√£o vai durar muito da bateria - a conta vai para o rel√≥gio.  Para que o dispositivo funcione por seis meses ou um ano, √© necess√°rio um programa competente para o microcontrolador e um conjunto de baterias. <br><br>  <strong>O GPIO ruim √© de entrada / sa√≠da de uso geral</strong> .  Os recursos de alimenta√ß√£o de onda, leitura de onda, trabalho com sinais anal√≥gicos no Raspberry Pi s√£o muito mais fracos que os dos microcontroladores, para os quais essa √© a principal tarefa.  Por exemplo, pronto para uso em um Raspberry Pi, n√£o ser√° poss√≠vel controlar o servo no modo hardware. <br><br><img src="https://habrastorage.org/webt/0r/sz/oj/0rszojmbxar2o-zhp26divehxj4.jpeg"><br><br>  A restri√ß√£o √© condicional, porque pode ser contornada pela extens√£o.  Por exemplo, o ferro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Troyka Cap</a> , que assume todo o controle de baixo n√≠vel de trabalho com os sinais em si.  O Raspberry Pi se comunica com ela atrav√©s de um pacote de alto n√≠vel.  D√° comandos para torcer o servo e ele funciona.  Usando esses cart√µes de expans√£o, voc√™ pode conectar o que quiser. <br><br><h2>  Arduino </h2><br>  Voc√™ pode usar o <strong>Arduino</strong> habitual, do qual todos est√£o cansados.  Mas o JavaScript precisar√° ser movido para algum lugar que possa transformar o Node JS - um computador antigo ou o mesmo Raspberry Pi. <br><br><img src="https://habrastorage.org/webt/fc/z2/gx/fcz2gxhtqtz7gsoqbopfki6tlqm.jpeg"><br><br>  Conectamos um computador desnecess√°rio antigo ao Arduino atrav√©s de um cabo USB.  No Arduino, preencha o firmware <a href="">Firmata</a> padr√£o <a href="">uma vez</a> .  Ela transforma o Arduino em um zumbi que segue as instru√ß√µes de um mestre - um computador antigo.  O mestre diz para transmitir tal e tal sinal a tal e tal pino, e o Arduino transmite. <br><br>  Para comunica√ß√£o, s√£o usadas bibliotecas com NPM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SerialPort</a> e Firmata com uma API clara.  Ent√£o, voc√™ est√° novamente no mundo JS, escrevendo um programa de alto n√≠vel que envia ao seu servidor.  Voc√™ confia no Arduino para trabalhar com sinais, e ela o executa. <br><br>  Nem sempre o Firmata conseguir√° gerenciar tudo.  √â capaz de fornecer intera√ß√£o com o hardware a que se destina: servos, faixas de LED, controladores de m√≠dia.  Mas se a capacidade de ler um girosc√≥pio ou aceler√¥metro muito espec√≠fico n√£o for incorporada - ele n√£o funcionar√°.  Ent√£o voc√™ tem que escrever um programa em C em um Arduino regular. <br><br>  Mas isso n√£o √© tudo - se voc√™ n√£o quiser escrever em C, use a ferramenta Open Source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XOD.io.</a> <br><br><img src="https://habrastorage.org/webt/-p/-9/j0/-p-9j0ex1ngdm7pfdq-lv5dej9u.jpeg"><br><br>  Este √© um ambiente de programa√ß√£o visual em que o gr√°fico que voc√™ est√° criando se transforma em c√≥digo, e voc√™ j√° pode compil√°-lo e preench√™-lo.  O XOD.io permite que pessoas que n√£o est√£o familiarizadas com as complexidades e nuances da programa√ß√£o de microcontroladores criem rapidamente programas simples.  Se voc√™ cresceu no Firmata, mas ainda n√£o sente for√ßas para escrever em um n√≠vel baixo - use o XOD.io. <br><br><blockquote>  A pr√≥xima confer√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FrontendConf</a> ser√° realizada em outubro.  Voc√™ sabe sobre JavaScript que a maioria dos desenvolvedores de front-end n√£o conhece, desenvolve interfaces que s√£o convenientes de usar ou encontram o graal de desempenho e est√£o prontas para dizer onde est√°, estamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aguardando aplicativos</a> para relat√≥rios. <br><br>  Coletamos relat√≥rios interessantes no programa, not√≠cias da confer√™ncia, v√≠deos e artigos no boletim regular - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inscreva-se</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450826/">https://habr.com/ru/post/pt450826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450816/index.html">Cabe√ßalhos HTTP para o desenvolvedor respons√°vel</a></li>
<li><a href="../pt450818/index.html">Da alta lat√™ncia do Ceph ao patch do kernel com o eBPF / BCC</a></li>
<li><a href="../pt450820/index.html">Comit√™ do programa FrontendConf: estruturas, horizontes, experi√™ncia mundial e miss√£o da confer√™ncia</a></li>
<li><a href="../pt450822/index.html">Estruturas desaparecendo</a></li>
<li><a href="../pt450824/index.html">O estado do css</a></li>
<li><a href="../pt450828/index.html">Quando a cidade adormece ...</a></li>
<li><a href="../pt450830/index.html">Nikita Dubko sobre confer√™ncias, s√≠ndrome de impostor e relat√≥rios</a></li>
<li><a href="../pt450832/index.html">A hist√≥ria de uma anima√ß√£o</a></li>
<li><a href="../pt450834/index.html">An√°lise de sites - e isso geralmente √© legal na R√∫ssia?</a></li>
<li><a href="../pt450836/index.html">Nos trilhos atr√°s das nuvens: como lavar o vidro em um arranha-c√©u</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>