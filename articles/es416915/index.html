<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéØ üÜò üêà Centrifugo v2: el futuro del servidor de mensajes en tiempo real y la biblioteca para Go ü§æüèæ ‚õ±Ô∏è ü§∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Algunos lectores pueden haber o√≠do hablar de Centrifugo antes. Este art√≠culo se centrar√° en el desarrollo de la segunda versi√≥n del servidor y la nuev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Centrifugo v2: el futuro del servidor de mensajes en tiempo real y la biblioteca para Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/416915/"><p>  Algunos lectores pueden haber o√≠do hablar de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Centrifugo</a> antes.  Este art√≠culo se centrar√° en el desarrollo de la segunda versi√≥n del servidor y la nueva biblioteca en tiempo real para el lenguaje Go que subyace. </p><br><p>  Me llamo Alexander Emelin.  El verano pasado, me un√≠ al equipo de Avito, donde ahora estoy ayudando a desarrollar el backend de mensajer√≠a Avito.  El nuevo trabajo, directamente relacionado con la entrega r√°pida de mensajes a los usuarios, y los nuevos colegas me inspiraron a seguir trabajando en el proyecto de c√≥digo abierto Centrifugo. </p><br><p><img src="https://habrastorage.org/webt/cl/mo/yt/clmoytonrzc4exvj6eeky8j-zw4.jpeg"></p><a name="habracut"></a><br><p>  En pocas palabras: este es un servidor que asume la tarea de mantener conexiones constantes de los usuarios de su aplicaci√≥n.  El <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">polyfill de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Websocket</a> o SockJS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se</a> usa como transporte; puede, si no es posible establecer una conexi√≥n Websocket, trabajar a trav√©s de Eventsource, XHR-streaming, sondeo largo y otros transportes basados ‚Äã‚Äãen HTTP.  Los clientes se suscriben a canales en los que el backend a trav√©s de la API Centrifuge publica nuevos mensajes a medida que surgen, despu√©s de lo cual los mensajes se entregan a los usuarios suscritos al canal.  En otras palabras, es un servidor PUB / SUB. </p><br><p><img src="https://habrastorage.org/webt/-c/ws/k-/-cwsk-n9eulxk4cd7v9berdltzy.png"></p><br><p> Actualmente, el servidor se utiliza en una cantidad bastante grande de proyectos.  Entre ellos, por ejemplo, se encuentran algunos proyectos de Mail.Ru (intranet, plataformas de capacitaci√≥n Technopark / Technosphere, Centro de Certificaci√≥n, etc.), con Centrifugo, un hermoso tablero de instrumentos funciona en la recepci√≥n en la oficina de Badoo Mosc√∫, y 350 mil usuarios est√°n conectados simult√°neamente al servicio spot.im a la centr√≠fuga </p><br><p>  Algunos enlaces a art√≠culos anteriores sobre el servidor y su aplicaci√≥n para quienes escuchan por primera vez sobre el proyecto: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sum√©rgete en Centrifugo</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Centrifugo - 3.5 millones de rpm</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Adem√°s de un art√≠culo en ingl√©s que cuenta la historia del proyecto y la motivaci√≥n para su aparici√≥n</a> . </li></ul><br><p>  Comenc√© a trabajar en la segunda versi√≥n en diciembre del a√±o pasado y contin√∫o hasta el d√≠a de hoy.  Veamos que pasa.  Estoy escribiendo este art√≠culo no solo para popularizar de alguna manera el proyecto, sino tambi√©n para obtener un poco m√°s de informaci√≥n constructiva antes del lanzamiento de Centrifugo v2: ahora hay espacio para maniobras y cambios incompatibles con versiones anteriores. </p><br><h1 id="real-time-biblioteka-dlya-go">  Biblioteca en tiempo real para Go </h1><br><p>  En la comunidad Go, la pregunta surge de vez en cuando: ¬øhay alguna alternativa a socket.io en Go?  A veces not√© c√≥mo se aconseja a los desarrolladores en respuesta a esto que miren hacia Centrifugo.  Sin embargo, Centrifugo es un servidor autohospedado, no una biblioteca; la comparaci√≥n no es justa.  Tambi√©n me han preguntado varias veces si el c√≥digo Centrifugo se puede reutilizar para escribir aplicaciones en tiempo real en Go.  Y la respuesta fue: te√≥ricamente posible, pero no pod√≠a garantizar la compatibilidad con versiones anteriores de la API de los paquetes internos bajo mi propio riesgo.  Est√° claro que no hay raz√≥n para que nadie se arriesgue, y bifurcar tambi√©n es una opci√≥n regular.  Adem√°s, no dir√≠a que la API para paquetes internos generalmente se prepar√≥ para tal uso. </p><br><p>  Por lo tanto, una de las tareas ambiciosas que quer√≠a resolver en el proceso de trabajar en la segunda versi√≥n del servidor era tratar de separar el n√∫cleo del servidor en una biblioteca separada en Go.  Creo que esto tiene sentido, considerando cu√°ntas caracter√≠sticas tiene la Centrifuge para adaptarse a la producci√≥n.  Hay muchas funciones disponibles de f√°brica para ayudar a crear aplicaciones escalables en tiempo real, eliminando la necesidad de que los desarrolladores escriban sus propias soluciones.  Escrib√≠ sobre estas caracter√≠sticas anteriormente y tambi√©n describir√© algunas de ellas a continuaci√≥n. </p><br><p>  Tratar√© de justificar una ventaja m√°s de la existencia de dicha biblioteca.  La mayor√≠a de los usuarios de Centrifugo son desarrolladores que escriben backends en idiomas / frameworks con escaso soporte de concurrencia (por ejemplo, Django / Flask / Laravel / ...): trabajen con muchas conexiones persistentes si es posible, de una manera no evidente o ineficiente.  En consecuencia, no todos los usuarios pueden ayudar con el desarrollo de un servidor escrito en Go (cursi debido a la falta de conocimiento del idioma).  Por lo tanto, incluso una comunidad muy peque√±a de desarrolladores de Go en la biblioteca podr√° ayudar a desarrollar el servidor Centrifugo que lo utiliza. </p><br><p>  El resultado es una biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Centrifuge</a> .  Esto sigue siendo WIP, pero absolutamente todas las caracter√≠sticas indicadas en la descripci√≥n de Github est√°n implementadas y funcionan.  Dado que la biblioteca proporciona una API bastante rica, antes de garantizar la compatibilidad con versiones anteriores, me gustar√≠a escuchar sobre varios ejemplos exitosos de uso en proyectos reales en Go.  No hay ninguno todav√≠a.  Adem√°s de fracasado :).  No hay ninguno </p><br><p>  Entiendo que al nombrar la biblioteca de la misma manera que el servidor, siempre enfrentar√© la confusi√≥n.  Pero creo que esta es la opci√≥n correcta, ya que los clientes (como centrifuge-js, centrifuge-go) trabajan tanto con la biblioteca Centrifuge como con el servidor Centrifugo.  Adem√°s, el nombre ya est√° firmemente arraigado en la mente de los usuarios, y no quiero perder estas asociaciones.  Y sin embargo, para un poco m√°s de claridad, aclarar√© nuevamente: </p><br><ul><li>  Centrifuge - una biblioteca para el idioma Go, </li><li>  Centrifugo es una soluci√≥n llave en mano, un servicio separado, que en la versi√≥n 2 se construir√° en la biblioteca Centrifuge. </li></ul><br><p>  Debido a su dise√±o, Centrifugo (un servicio independiente que no sabe nada sobre su backend) asume que el flujo de mensajes a trav√©s del transporte en tiempo real ir√° del servidor al cliente.  A que te refieres  Si, por ejemplo, el usuario escribe un mensaje en el chat, este mensaje primero debe enviarse al backend de la aplicaci√≥n (por ejemplo, AJAX en el navegador), validado en el lado del backend, guardado en la base de datos si es necesario y luego enviado a la API Centrifuge.  La biblioteca elimina esta restricci√≥n, lo que le permite organizar el intercambio bidireccional de mensajes asincr√≥nicos entre el servidor y el cliente, as√≠ como las llamadas RPC. </p><br><p><img src="https://habrastorage.org/webt/jf/_d/er/jf_dervpzmkl2fuprcse34ayoke.png"></p><br><p>  Veamos un ejemplo simple: implementamos un peque√±o servidor en Go usando la biblioteca Centrifuge.  El servidor recibir√° mensajes de los clientes del navegador a trav√©s de Websocket, el cliente tendr√° un campo de texto en el que puede enviar un mensaje, presione Entrar y el mensaje se enviar√° a todos los usuarios suscritos al canal.  Es decir, la versi√≥n m√°s simplificada del chat.  Me pareci√≥ que ser√≠a m√°s conveniente colocar esto en forma de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esencia</a> . </p><br><p>  Puedes correr como siempre: </p><br><pre><code class="go hljs">git clone https:<span class="hljs-comment"><span class="hljs-comment">//gist.github.com/2f1a38ae2dcb21e2c5937328253c29bf.git cd 2f1a38ae2dcb21e2c5937328253c29bf go get -u github.com/centrifugal/centrifuge go run main.go</span></span></code> </pre> <br><p>  Y luego vaya a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // localhost: 8000</a> , abra varias pesta√±as del navegador. </p><br><p>  Como puede ver, el punto de entrada a la l√≥gica de negocios de la aplicaci√≥n ocurre cuando se cuelga <code>On().Connect()</code> Funciones de devoluci√≥n de llamada <code>On().Connect()</code> : </p><br><pre> <code class="go hljs">node.On().Connect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, client *centrifuge.Client, e centrifuge.ConnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectReply</span></span></span></span> { client.On().Disconnect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e centrifuge.DisconnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DisconnectReply</span></span></span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"client disconnected"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.DisconnectReply{} }) log.Printf(<span class="hljs-string"><span class="hljs-string">"client connected via %s"</span></span>, client.Transport().Name()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.ConnectReply{} })</code> </pre> <br><p>  El enfoque basado en la devoluci√≥n de llamada me pareci√≥ el m√°s conveniente para interactuar con la biblioteca.  Adem√°s, se utiliza un enfoque similar, de tipo d√©bil, en la implementaci√≥n del <a href="">servidor socket-io en Go</a> .  Si de repente tiene pensamientos sobre c√≥mo se podr√≠a hacer la API de manera m√°s idiom√°tica, me alegrar√° saberlo. </p><br><p>  Este es un ejemplo muy simple que no muestra todas las caracter√≠sticas de la biblioteca.  Alguien puede notar que para tales prop√≥sitos es m√°s f√°cil tomar una biblioteca para trabajar con Websocket.  Por ejemplo, Gorilla Websocket.  Esto es realmente as√≠.  Sin embargo, incluso en este caso, tendr√° que copiar una pieza decente de c√≥digo de servidor del ejemplo en el repositorio Gorilla Websocket.  ¬øQu√© pasa si: </p><br><ul><li>  necesita escalar la aplicaci√≥n a varias m√°quinas, </li><li>  o no necesita un canal com√∫n, sino varios, y los usuarios pueden suscribirse y darse de baja din√°micamente a medida que navega por su aplicaci√≥n, </li><li>  o necesita trabajar cuando no se pudo establecer la conexi√≥n Websocket (no hay soporte en el navegador del cliente, hay una extensi√≥n del navegador, alg√∫n proxy en el camino entre el cliente y el servidor corta la conexi√≥n), </li><li>  o necesita restaurar mensajes perdidos por el cliente durante breves interrupciones en la conexi√≥n a Internet sin cargar la base de datos principal, </li><li>  o necesita control de la autorizaci√≥n del usuario en el canal, </li><li>  o necesita desconectar la conexi√≥n permanente de los usuarios que est√°n desactivados en la aplicaci√≥n, </li><li>  o necesita informaci√≥n sobre qui√©n est√° actualmente en el canal o los eventos que alguien ha suscrito / anulado del canal, </li><li>  ¬øo necesita m√©tricas y monitoreo? </li></ul><br><p>  La biblioteca Centrifuge puede ayudarlo con esto; de hecho, hered√≥ todas las caracter√≠sticas b√°sicas que anteriormente estaban disponibles en Centrifugo.  Se pueden encontrar m√°s ejemplos que muestran los puntos indicados anteriormente en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Github</a> . </p><br><p>  El fuerte legado de Centrifugo puede ser un inconveniente, ya que la biblioteca ha adoptado todas las mec√°nicas del servidor, que son bastante originales y, tal vez, pueden parecer obvias o sobrecargadas con caracter√≠sticas innecesarias para alguien.  Trat√© de organizar el c√≥digo de tal manera que las caracter√≠sticas no utilizadas no afectaran el rendimiento general. </p><br><p>  Hay algunas optimizaciones en la biblioteca que permiten un uso m√°s eficiente de los recursos.  Esto est√° combinando varios mensajes en un marco Websocket para guardar en las llamadas del sistema Write o, por ejemplo, usando Gogoprotobuf para serializar mensajes Protobuf y otros.  Hablando de Protobuf. </p><br><h1 id="binarnyy-protobuf-protokol">  Protocolo binario Protobuf </h1><br><p>  Realmente quer√≠a que Centrifugo trabajara con datos binarios ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">y no solo yo</a> ), por lo que en la nueva versi√≥n quer√≠a agregar un protocolo binario adem√°s del existente basado en JSON.  Ahora todo el protocolo se describe como un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esquema Protobuf</a> .  Esto nos permiti√≥ hacerlo m√°s estructurado, repensar algunas decisiones no obvias en el protocolo de la primera versi√≥n. </p><br><p>  Creo que no necesita decir durante mucho tiempo cu√°les son las ventajas de Protobuf sobre JSON: compacidad, velocidad de serializaci√≥n, esquema estricto.  Existe un inconveniente en forma de ilegibilidad, pero ahora los usuarios tienen la oportunidad de decidir qu√© es m√°s importante para ellos en una situaci√≥n particular. </p><br><p>  En general, el tr√°fico generado por el protocolo Centrifugo cuando se usa Protobuf en lugar de JSON deber√≠a disminuir en ~ 2 veces (excluyendo los datos de la aplicaci√≥n).  El consumo de CPU en mis pruebas de carga sint√©tica disminuy√≥ por lo mismo ~ 2 veces en comparaci√≥n con JSON.  Estos n√∫meros en realidad hablan poco de lo que, en la pr√°ctica, todo depender√° del perfil de carga de una aplicaci√≥n en particular. </p><br><p>  En aras del inter√©s, lanc√© en una m√°quina con Debian 9.4 y 32 CPU Intel¬Æ Xeon¬Æ Platinum 8168 @ 2.70GHz vCPU benchmark, lo que nos permiti√≥ comparar el ancho de banda de la interacci√≥n cliente-servidor en caso de usar el protocolo JSON y el protocolo Protobuf.  Hab√≠a 1000 suscriptores a 1 canal.  En este canal, los mensajes se publicaron en 4 transmisiones y se entregaron a todos los suscriptores.  El tama√±o de cada mensaje era de 128 bytes. </p><br><p>  Resultados para JSON: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket -n 1000 -ns 1000 -np 4 channel Starting benchmark [msgs=1000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 265,900 msgs/sec ~ 32.46 MB/sec Pub stats: 278 msgs/sec ~ 34.85 KB/sec [1] 73 msgs/sec ~ 9.22 KB/sec (250 msgs) [2] 71 msgs/sec ~ 9.00 KB/sec (250 msgs) [3] 71 msgs/sec ~ 8.90 KB/sec (250 msgs) [4] 69 msgs/sec ~ 8.71 KB/sec (250 msgs) min 69 | avg 71 | max 73 | stddev 1 msgs Sub stats: 265,635 msgs/sec ~ 32.43 MB/sec [1] 273 msgs/sec ~ 34.16 KB/sec (1000 msgs) ... [1000] 277 msgs/sec ~ 34.67 KB/sec (1000 msgs) min 265 | avg 275 | max 278 | stddev 2 msgs</span></span></code> </pre> <br><p>  Resultados para el caso Protobuf: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket?format=protobuf -n 100000 -ns 1000 -np 4 channel Starting benchmark [msgs=100000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 681,212 msgs/sec ~ 83.16 MB/sec Pub stats: 685 msgs/sec ~ 85.69 KB/sec [1] 172 msgs/sec ~ 21.57 KB/sec (25000 msgs) [2] 171 msgs/sec ~ 21.47 KB/sec (25000 msgs) [3] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) [4] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) min 171 | avg 171 | max 172 | stddev 0 msgs Sub stats: 680,531 msgs/sec ~ 83.07 MB/sec [1] 681 msgs/sec ~ 85.14 KB/sec (100000 msgs) ... [1000] 681 msgs/sec ~ 85.13 KB/sec (100000 msgs) min 680 | avg 680 | max 685 | stddev 1 msgs</span></span></code> </pre><br><p>  Puede notar que el rendimiento de dicha instalaci√≥n es m√°s de 2 veces mayor en el caso de Protobuf.  El script del cliente se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> : este es el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script de referencia de Nats adaptado a las realidades de Centrifuge</a> . </p><br><p>  Tambi√©n vale la pena se√±alar que el rendimiento de la serializaci√≥n JSON en el servidor se puede "aumentar" usando el mismo enfoque que en gogoprotobuf - agrupaci√≥n de almacenamiento intermedio y generaci√≥n de c√≥digo - actualmente JSON es serializado por un paquete de la biblioteca est√°ndar Go incorporada en reflect.  Por ejemplo, en Centrifugo, la primera versi√≥n de JSON se serializa manualmente utilizando una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">biblioteca</a> que proporciona <a href="">un grupo de b√∫feres</a> .  Algo similar se puede hacer en el futuro como parte de la segunda versi√≥n. </p><br><p>  Vale la pena enfatizar que protobuf tambi√©n se puede usar cuando se comunica con el servidor desde un navegador.  El cliente javascript utiliza la biblioteca protobuf.js para esto.  Dado que la biblioteca protobufjs es bastante grande y la cantidad de usuarios en formato binario ser√° peque√±a, usando webpack y su algoritmo de sacudida de √°rbol, generamos dos versiones del cliente, una con solo soporte de protocolo JSON y la otra con soporte de JSON y protobuf.  Para otros entornos donde el tama√±o de los recursos no juega un papel tan cr√≠tico, los clientes no pueden preocuparse por esta separaci√≥n. </p><br><h1 id="json-web-token-jwt">  Token web JSON (JWT) </h1><br><p>  Uno de los problemas con el uso de un servidor independiente como Centrifugo es que no sabe nada acerca de sus usuarios y su m√©todo de autenticaci√≥n, y qu√© tipo de mecanismo de sesi√≥n utiliza su back-end.  Y necesita autenticar la conexi√≥n de alguna manera. </p><br><p>  Para hacer esto, en la primera versi√≥n de Centrifuge, al conectarse, se utiliz√≥ la firma SHA-256 HMAC, basada en una clave secreta conocida solo por el backend y la Centrifuge.  Esto asegur√≥ que la ID de usuario transmitida por el cliente realmente le pertenece. </p><br><p>  Quiz√°s la transferencia correcta de los par√°metros de conexi√≥n y la generaci√≥n de un token fueron una de las principales dificultades para integrar Centrifugo en el proyecto. </p><br><p>  Cuando apareci√≥ la Centr√≠fuga, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el est√°ndar JWT</a> a√∫n no era tan popular.  Ahora, unos a√±os m√°s tarde, las bibliotecas para la generaci√≥n JWT est√°n disponibles para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">los idiomas m√°s populares</a> .  La idea principal de JWT es exactamente lo que necesita la Centr√≠fuga: confirmaci√≥n de la autenticidad de los datos transmitidos.  En la segunda versi√≥n de HMAC, una firma generada manualmente dio paso al uso de JWT.  Esto permiti√≥ eliminar la necesidad de soporte para funciones auxiliares para la generaci√≥n correcta de tokens en bibliotecas para diferentes idiomas. </p><br><p>  Por ejemplo, en Python, un token para conectarse a Centrifugo se puede generar de la siguiente manera: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jwt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time token = jwt.encode({<span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"42"</span></span>, <span class="hljs-string"><span class="hljs-string">"exp"</span></span>: int(time.time()) + <span class="hljs-number"><span class="hljs-number">10</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>}, <span class="hljs-string"><span class="hljs-string">"secret"</span></span>).decode() print(token)</code> </pre> <br><p>  Es importante tener en cuenta que si usa la biblioteca Centrifuge, puede autenticar al usuario usando el m√©todo nativo Go, dentro del middleware.  Los ejemplos est√°n en el repositorio. </p><br><h1 id="grpc">  GRPC </h1><br><p>  Durante el desarrollo, prob√© la transmisi√≥n bidireccional GRPC como transporte para la comunicaci√≥n entre el cliente y el servidor (adem√°s de los fallos de SockJS basados ‚Äã‚Äãen Websocket y HTTP).  Que puedo decir  El trabajo.  Sin embargo, no encontr√© un solo escenario en el que la transmisi√≥n bidireccional de GRPC ser√≠a mejor que Websocket.  Observ√© principalmente las m√©tricas del servidor: tr√°fico generado a trav√©s de la interfaz de red, consumo de CPU por parte del servidor con una gran cantidad de conexiones entrantes, consumo de memoria por conexi√≥n. </p><br><p>  GRPC perdi√≥ ante Websocket en todos los aspectos: </p><br><ul><li>  GRPC genera un 20% m√°s de tr√°fico en escenarios similares, </li><li>  GRPC consume 2-3 veces m√°s CPU (dependiendo de la configuraci√≥n de las conexiones; todas est√°n suscritas a diferentes canales o todas est√°n suscritas a un canal), </li><li>  GRPC consume 4 veces m√°s RAM por conexi√≥n.  Por ejemplo, en conexiones de 10k, el servidor Websocket consumi√≥ 500Mb de memoria y GRPC - 2Gb. </li></ul><br><p>  Los resultados fueron bastante ... esperados.  En general, en GRPC, como cliente de transporte, no ten√≠a mucho sentido, y borr√© el c√≥digo con la conciencia tranquila hasta, quiz√°s, mejores momentos. </p><br><p>  Sin embargo, GRPC es bueno para lo que fue creado principalmente: para generar c√≥digo que le permite realizar llamadas RPC entre servicios utilizando un esquema predeterminado.  Por lo tanto, adem√°s de la API HTTP, Centrifuge ahora tambi√©n tendr√° soporte API basado en GRPC, por ejemplo, para publicar nuevos mensajes en el canal y otros m√©todos API de servidor disponibles. </p><br><h1 id="slozhnosti-s-klientami">  Dificultades con los clientes. </h1><br><p>  Con los cambios realizados en la segunda versi√≥n, elimin√© el soporte obligatorio de las bibliotecas para la API del servidor; se hizo m√°s f√°cil la integraci√≥n en el lado del servidor, sin embargo, el protocolo del cliente en el proyecto se modific√≥ y tiene una cantidad suficiente de caracter√≠sticas.  Esto hace que la implementaci√≥n de los clientes sea bastante dif√≠cil.  Para la segunda versi√≥n, ahora tenemos un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cliente para Javascript</a> que funciona en los navegadores, deber√≠a funcionar con NodeJS y React-Native.  Hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cliente en Go</a> y se construy√≥ sobre la base <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de las carpetas de proyectos de Gomobile</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">para iOS y Android</a> . </p><br><p>  Para una felicidad completa, no hay suficientes bibliotecas nativas para iOS y Android.  Para la primera versi√≥n de Centrifugo, fueron comprados por chicos de la comunidad de c√≥digo abierto.  Quiero creer que algo as√≠ suceder√° ahora. </p><br><p>  Recientemente prob√© suerte enviando una solicitud para una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">subvenci√≥n MOSS de Mozilla</a> , con la intenci√≥n de invertir en el desarrollo del cliente, pero me rechazaron.  La raz√≥n es la comunidad insuficientemente activa en Github.  Desafortunadamente, esto es cierto, pero como puede ver, estoy tomando algunas medidas para mejorar la situaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/y4/3q/kc/y43qkcl_yp7fjdgalrqvuzw5hl0.jpeg"></p><br><h1 id="zaklyuchenie">  Conclusi√≥n </h1><br><p>  No anunci√© todas las caracter√≠sticas que aparecer√°n en Centrifugo v2; hay un poco m√°s de informaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en Github</a> .  La versi√≥n del servidor a√∫n no se ha llevado a cabo, pero suceder√° pronto.  Todav√≠a hay momentos sin terminar, incluida la necesidad de completar la documentaci√≥n.  El prototipo de la documentaci√≥n se puede ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Si es usuario de Centrifugo, ahora es el momento adecuado para influir en la segunda versi√≥n del servidor.  Un momento en que no es tan aterrador romper algo, para luego hacerlo mejor.  Para aquellos interesados: el desarrollo se concentra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en la rama c2</a> . </p><br><p>  Es dif√≠cil para m√≠ juzgar cu√°nta demanda tendr√° la biblioteca Centrifuge que subyace a Centrifugo v2.  Por el momento, me complace haber podido llevarlo a su estado actual.  El indicador m√°s importante para m√≠ ahora es la respuesta a la pregunta "¬øYo mismo usar√≠a esta biblioteca en mi proyecto personal?"  Mi respuesta es si.  En el trabajo  Si  Por lo tanto, creo que otros desarrolladores lo apreciar√°n. </p><br><p>  PD: Me gustar√≠a agradecer a los chicos que ayudaron con el trabajo y los consejos: Dmitry Korolkov, Artemy Ryabinkov, Oleg Kuzmin.  Ser√≠a dif√≠cil sin ti. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es416915/">https://habr.com/ru/post/es416915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es416905/index.html">Presentaci√≥n de Boston Dynamics SpotMini</a></li>
<li><a href="../es416907/index.html">Teor√≠a de la felicidad. La ley de la cebra y la cola alien√≠gena</a></li>
<li><a href="../es416909/index.html">Historial de sesiones activas de PostgreSQL: nueva extensi√≥n de pgsentinel</a></li>
<li><a href="../es416911/index.html">Se supon√≠a que los chatbots ser√≠an el pr√≥ximo avance: ¬øqu√© sali√≥ mal?</a></li>
<li><a href="../es416913/index.html">¬øQu√© debe olvidar el administrador al cambiar a la nube? Y qu√© aprender</a></li>
<li><a href="../es416917/index.html">S√©ptima tristeza</a></li>
<li><a href="../es416919/index.html">Burger King y grabaci√≥n de pantalla encubierta de su tel√©fono</a></li>
<li><a href="../es416921/index.html">C√≥mo cientos de miles de antenas se unen en un telescopio</a></li>
<li><a href="../es416925/index.html">Lo que sabemos sobre Ant Design</a></li>
<li><a href="../es416927/index.html">Nuevas empresas de calzado, y por qu√© Silicon Valley los ama tanto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>