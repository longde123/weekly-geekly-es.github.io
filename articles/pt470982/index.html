<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåã ü•û üõ∞Ô∏è An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio ü§ΩüèΩ üí≠ üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A partir da vers√£o 7.04, o analisador PVS-Studio para idiomas C e C ++ no Linux e macOS fornece o recurso de teste para verificar a lista de arquivos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/470982/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac4/d08/0e7/ac4d080e7661626569ef514abe190662.png" alt="Quadro 11"></div><br>  A partir da vers√£o 7.04, o analisador PVS-Studio para idiomas C e C ++ no Linux e macOS fornece o recurso de teste para verificar a lista de arquivos especificados.  Usando o novo modo, voc√™ pode configurar o analisador para verificar confirma√ß√µes e solicita√ß√µes.  Este artigo aborda a configura√ß√£o da verifica√ß√£o de certos arquivos modificados de um projeto GitHub em sistemas populares de CI (integra√ß√£o cont√≠nua), como Travis CI, Buddy e AppVeyor. <br><a name="habracut"></a><br><h2>  Modo de verificar a lista de arquivos </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O PVS-Studio</a> √© uma ferramenta projetada para detectar erros e poss√≠veis vulnerabilidades no c√≥digo fonte dos programas, escritos em C, C ++, C # e Java.  Funciona em sistemas de 64 bits no Windows, Linux e macOS. <br><br>  Na vers√£o PVS-Studio 7.04 para Linux e macOS, agora existe o modo de verificar a lista de arquivos.  Ele funciona para projetos, cujo sistema de constru√ß√£o permite gerar o arquivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compile_commands.json</a> .  √â necess√°rio que o analisador obtenha informa√ß√µes sobre a compila√ß√£o de determinados arquivos.  Se o seu sistema de constru√ß√£o n√£o suportar a gera√ß√£o do arquivo compile_commands.json, voc√™ poder√° tentar gerar esse arquivo usando o utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bear</a> . <br><br>  Esse modo de verificar a lista de arquivos tamb√©m pode ser usado com o log de rastreamento de execu√ß√£o do compilador gerado pelo strace (rastreamento do pvs-studio-analyzer).  Para fazer isso, primeiro voc√™ precisa concluir uma constru√ß√£o completa do projeto e rastre√°-la para que o analisador colete informa√ß√µes completas sobre os par√¢metros de compila√ß√£o de todos os arquivos verificados. <br><br>  No entanto, essa op√ß√£o tem uma desvantagem significativa - voc√™ precisar√° executar o rastreamento completo da constru√ß√£o de todo o projeto a cada execu√ß√£o, o que contraria a id√©ia de uma verifica√ß√£o r√°pida de confirma√ß√£o.  Ou, se voc√™ armazenar em cache o resultado do rastreamento, as execu√ß√µes subseq√ºentes do analisador poder√£o ficar incompletas, caso, ap√≥s o rastreamento da estrutura das depend√™ncias dos arquivos de origem, mude (por exemplo, um novo #include seja adicionado a um dos arquivos de origem). <br><br>  Portanto, n√£o recomendamos o uso do modo de verificar a lista de arquivos com um log de rastreamento para verificar confirma√ß√µes ou solicita√ß√µes de recebimento.  Se voc√™ pode executar uma constru√ß√£o incremental ao verificar uma confirma√ß√£o, considere usar o modo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">an√°lise incremental</a> . <br><br>  A lista de arquivos de origem para a an√°lise √© salva no arquivo de texto e passada para o analisador usando o par√¢metro <i>-S</i> : <br><br><pre><code class="bash hljs">pvs-studio-analyzer analyze ... -f build/compile_commands.json -S check-list.txt</code> </pre> <br>  Este arquivo cont√©m caminhos relativos e absolutos para arquivos em que cada novo arquivo vem em uma nova linha.  Voc√™ pode especificar os nomes dos arquivos para a an√°lise e o texto diferente.  Quanto ao texto, o analisador notar√° que n√£o √© um nome de arquivo e ignorar√° a linha.  Pode ser √∫til comentar se os arquivos forem especificados manualmente.  No entanto, frequentemente a lista de arquivos ser√° gerada durante a an√°lise do IC, por exemplo, pode ser arquivos de uma solicita√ß√£o de confirma√ß√£o ou de recebimento. <br><br>  Agora, usando esse modo, voc√™ pode verificar rapidamente o novo c√≥digo antes que ele entre no ramo de desenvolvimento principal.  O sinalizador <i>--indicate</i> <i>-warnings</i> foi adicionado no utilit√°rio <i>plog-converter</i> para que o sistema de verifica√ß√£o respondesse √† presen√ßa de avisos do analisador. <br><br><pre> <code class="bash hljs">plog-converter ... --indicate-warnings ... -o /path/to/report.tasks ...</code> </pre> <br>  Com esse sinalizador, o conversor retornar√° um c√≥digo diferente de zero se houver avisos no relat√≥rio do analisador.  Voc√™ pode bloquear o pedido de confirma√ß√£o pr√©via, confirma√ß√£o ou solicita√ß√£o e exibir o relat√≥rio do analisador gerado, compartilhar ou envi√°-lo por correio. <br><br>  <i>Nota</i>  <i>Durante a primeira an√°lise da lista de arquivos, todo o projeto ser√° verificado, pois o analisador precisar√° gerar o arquivo com depend√™ncias dos arquivos de origem do projeto a partir dos arquivos de cabe√ßalho.</i>  <i>Essa √© uma peculiaridade da an√°lise de arquivos C e C ++.</i>  <i>No futuro, esse arquivo de depend√™ncia poder√° ser armazenado em cache e ser√° atualizado automaticamente pelo analisador.</i>  <i>A vantagem de verificar confirma√ß√µes usando o modo de verificar a lista de arquivos no modo de an√°lise incremental √© o fato de que voc√™ precisa armazenar em cache apenas esse arquivo, n√£o os arquivos de objeto.</i> <br><br><h2>  Princ√≠pios gerais da an√°lise de solicita√ß√£o pull </h2><br>  Toda a an√°lise do projeto leva muito tempo, portanto, faz sentido verificar apenas uma parte dela.  O problema √© que voc√™ precisa separar novos arquivos do restante dos arquivos do projeto. <br><br>  Vejamos o exemplo de uma √°rvore de confirma√ß√£o de dois ramos: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Quadro 5"></div><br><br>  Imagine que o commit <i>A1</i> cont√©m uma quantidade bastante grande de c√≥digo que j√° foi verificado.  Anteriormente, fizemos uma ramifica√ß√£o da confirma√ß√£o do <i>A1</i> e alteramos alguns arquivos. <br><br>  Obviamente, voc√™ notou que ap√≥s <i>A1</i> outros dois commits ocorreram e dois outros branches foram mesclados, pois n√£o confirmamos no <i>master</i> .  A√≠ chega o momento em que o <i>hotfix</i> est√° pronto.  √â por isso que recebemos uma solicita√ß√£o de <i>recebimento</i> para mesclagem <i>B3</i> e <i>A3</i> . <br><br>  Poder√≠amos verificar o resultado da fus√£o, mas seria muito longo e irracional, pois apenas alguns arquivos foram modificados.  Portanto, √© mais eficiente analisar apenas os alterados. <br><br>  Para isso, receberemos a diferen√ßa entre as ramifica√ß√µes, estando em HEAD da ramifica√ß√£o, da qual queremos mesclar no mestre: <br><br><pre> <code class="bash hljs">git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Consideraremos <i>$ MERGE_BASE</i> em detalhes posteriormente.  O fato √© que nem todo servi√ßo de IC fornece as informa√ß√µes necess√°rias na base de mesclagem; portanto, toda vez que precisamos pensar em novas maneiras de obter esses dados.  Isso ser√° considerado nos detalhes abaixo para cada um dos servi√ßos da web descritos. <br><br>  Portanto, temos diferen√ßa entre os ramos, que √© a lista de nomes de arquivos modificados.  Agora precisamos alimentar esse arquivo <i>.pvs-pr.list</i> no analisador.  Redirecionamos a sa√≠da para ela anteriormente. <br><br><pre> <code class="bash hljs">pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list</code> </pre> <br>  Ap√≥s a an√°lise, precisamos converter o arquivo de log (PVS-Studio.log) em um formato amig√°vel: <br><br><pre> <code class="bash hljs">plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Este comando produzir√° a lista de erros no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">stderr</a> (fluxo de erros padr√£o). <br><br>  O problema √© que precisamos n√£o apenas gerar os erros, mas tamb√©m reportar nosso servi√ßo de compila√ß√£o e teste sobre os problemas.  Para fazer isso, o sinalizador <i>-W</i> ( <i>--indicate-warnings</i> ) foi adicionado no conversor.  Se houver pelo menos um aviso do analisador, o c√≥digo de retorno do utilit√°rio <i>plog-converter</i> ser√° alterado para 2, que, por sua vez, informar√° o servi√ßo de IC sobre poss√≠veis erros nos arquivos da solicita√ß√£o pull. <br><br><h2>  Travis ci </h2><br>  A configura√ß√£o √© feita no formato do arquivo <i>.travis.yml</i> .  Por conveni√™ncia, aconselho a isolar todos os comandos relacionados ao PVS-Studio em um script bash separado com fun√ß√µes que ser√£o chamadas a partir do arquivo <i>.travis.yml</i> ( <i>bash</i> <i>script_name.sh nome_da_fun√ß√£o</i> ). <br><br>  Ao expandir o script, voc√™ obter√° mais funcionalidades.  Na se√ß√£o de <i>instala√ß√£o</i> , escreva o seguinte: <br><br><pre> <code class="xml hljs">install: - bash .travis.sh travis_install</code> </pre> <br>  Se voc√™ recebeu algumas instru√ß√µes, pode mov√™-las no script, removendo os h√≠fens. <br><br>  Abra o arquivo <i>.travis.sh</i> e adicione a instala√ß√£o do analisador na fun√ß√£o <i>travis_install ()</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_install</span></span></span></span>() { wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update -qq sudo apt-get install -qq pvs-studio }</code> </pre> <br>  Agora vamos adicionar o analisador executado na se√ß√£o de <i>script</i> : <br><br><pre> <code class="xml hljs">script: - bash .travis.sh travis_script</code> </pre> <br>  E no script bash: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  √â necess√°rio executar esse c√≥digo ap√≥s a cria√ß√£o do projeto, por exemplo, se voc√™ construiu o CMake: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 }</code> </pre> <br>  Voc√™ obter√° o seguinte: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Provavelmente, voc√™ j√° percebeu as vari√°veis ‚Äã‚Äãde ambiente <i>$ TRAVIS_PULL_REQUEST</i> e <i>$ TRAVIS_BRANCH</i> .  O Travis CI os declara: <br><br><ul><li>  <i>$ TRAVIS_PULL_REQUEST</i> armazena o n√∫mero da solicita√ß√£o de <i>recebimento</i> ou <i>false</i> se for uma ramifica√ß√£o regular; </li><li>  <i>$ TRAVIS_REPO_SLUG</i> armazena o nome do reposit√≥rio do projeto. </li></ul><br>  Aqui est√° o algoritmo operacional desta fun√ß√£o: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebe/643/58b/ebe64358b6f4cc73db5d4b0094919faa.png" alt="Quadro 13"></div><br>  O Travis CI responde aos c√≥digos de retorno; portanto, a presen√ßa de avisos informar√° o servi√ßo para marcar a confirma√ß√£o como contendo erros. <br><br>  Agora vamos dar uma olhada mais de perto nesta linha de c√≥digo: <br><pre> <code class="bash hljs">git diff --name-only origin/HEAD &gt; .pvs-pr.list</code> </pre> <br>  O fato √© que o Travis CI mescla ramifica√ß√µes automaticamente ao analisar uma solicita√ß√£o pull: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/443/986/1f4/4439861f46637d41119e83f83e2e440b.png" alt="Quadro 8"></div><br>  √â por isso que analisamos <i>A4</i> , n√£o <i>B3-&gt; A3</i> .  Devido a essa peculiaridade, precisamos avaliar a diferen√ßa com <i>A3</i> , que √© o chefe do ramo de <i>origem</i> . <br><br>  Um detalhe importante permanece: armazenar em cache as depend√™ncias dos arquivos de cabe√ßalho das unidades de convers√£o compiladas (* .c, * .cc, * .cpp e outras).  O analisador avalia essas depend√™ncias durante a primeira execu√ß√£o no modo de verificar a lista de arquivos e as armazena no diret√≥rio .PVS-Studio.  O Travis CI permite armazenar reposit√≥rios em cache, portanto, salvaremos os dados no <i>diret√≥rio .PVS-Studio /</i> : <br><br><pre> <code class="xml hljs">cache: directories: - .PVS-Studio/</code> </pre> <br>  Este c√≥digo deve ser adicionado ao arquivo <i>.travis.yml</i> : Este diret√≥rio armazena v√°rios dados, coletados ap√≥s a an√°lise.  Esses dados aceleram significativamente as execu√ß√µes subseq√ºentes da an√°lise da lista de arquivos ou an√°lise incremental.  Caso contr√°rio, o analisador analisar√° todos os arquivos sempre. <br><br><h2>  Amigo </h2><br>  Assim como o Travis CI, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Buddy</a> permite que voc√™ crie e teste projetos automaticamente no GitHub.  Ao contr√°rio do Travis CI, ele √© configurado na interface da Web (o suporte ao bash est√° dispon√≠vel), portanto, n√£o h√° necessidade de armazenar arquivos de configura√ß√£o no projeto. <br><br>  Primeiro, precisamos adicionar uma nova etapa ao pipeline: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/2fd/36e/75e2fd36e9a4420ff74256429ff73e0c.gif" alt="Quadro 1"></div><br>  Vamos especificar o compilador usado para construir o projeto.  Preste aten√ß√£o ao cont√™iner do docker, instalado durante esta etapa.  Por exemplo, h√° um cont√™iner especial para o GCC: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95b/837/7ad/95b8377adbac7e50e55d97c5b318f56c.png" alt="Quadro 6"></div><br>  Agora vamos instalar o PVS-Studio e os utilit√°rios necess√°rios: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88e/fba/02b/88efba02b5a4c34f55c4344744812cc7.gif" alt="Quadro 2"></div><br>  Adicione as seguintes linhas ao editor: <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y install wget gnupg jq wget -q -O - https://files.viva64.com/etc/pubkey.txt | apt-key add - wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list apt-get update &amp;&amp; apt-get -y install pvs-studio</code> </pre> <br>  Vamos para a guia Executar (primeiro √≠cone) e adicione o seguinte c√≥digo ao campo apropriado do editor: <br><pre> <code class="bash hljs">pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Se voc√™ ler a se√ß√£o sobre o Travs-CI, esse c√≥digo √© familiar para voc√™.  Mas aqui h√° um novo passo: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7a/c65/3e3/a7ac653e3e89c4fc2a2b425b1ccefec8.png" alt="Quadro 14"></div><br>  O fato √© que agora analisamos n√£o o resultado da mesclagem, mas o HEAD da ramifica√ß√£o com a solicita√ß√£o pull verificada: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Quadro 10"></div><br>  Portanto, estamos em um commit <i>B3</i> e precisamos obter a diferen√ßa com <i>A3</i> : <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Para definir <i>A3,</i> vamos usar a API do GitHub: <br><br><pre> <code class="bash hljs">https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${USERNAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${REPO}</span></span>/pulls/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span></code> </pre> <br>  Usamos as seguintes vari√°veis, fornecidas pelo Buddy: <br><br><ul><li>  <i>$ BUDDY_EXECUTION_PULL_REQEUST_NO</i> - n√∫mero de uma solicita√ß√£o pull; </li><li>  <i>$ BUDDY_REPO_SLUG</i> - combina√ß√£o de um nome de usu√°rio e um reposit√≥rio (por exemplo, max / test). </li></ul><br>  Agora vamos salvar as altera√ß√µes, usando o bot√£o abaixo e ativar a an√°lise de solicita√ß√£o de recebimento: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74c/5d6/876/74c5d6876c07c0b2e0c10cdabb8b0f78.gif" alt="Quadro 3"></div><br>  Ao contr√°rio do Travis CI, n√£o precisamos especificar <i>.pvs-studio</i> para armazenamento em cache, pois o Buddy armazena em cache automaticamente todos os arquivos para execu√ß√µes subseq√ºentes.  Portanto, a √∫ltima coisa que resta √© salvar o login e a senha do PVS-Studio no Buddy.  Ap√≥s salvar as altera√ß√µes, voltaremos ao Pipeline.  Precisamos seguir em frente para configurar as vari√°veis ‚Äã‚Äãe inserir o login e a chave do PVS-Studio: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb1/816/e3e/eb1816e3e4aff72ad55b187ec1ebf0a2.gif" alt="Quadro 4"></div><br>  Ap√≥s isso, uma verifica√ß√£o come√ßar√° com cada nova solicita√ß√£o ou confirma√ß√£o de recebimento.  Se um commit contiver erros, o Buddy o indicar√° na p√°gina de solicita√ß√£o de recebimento. <br><br><h2>  Appveyor </h2><br>  A configura√ß√£o do AppVeyor √© semelhante ao Buddy, pois tudo acontece na interface da web e n√£o √© necess√°rio adicionar o arquivo * .yml no reposit√≥rio do projeto. <br><br>  Vamos para a guia Configura√ß√µes na revis√£o do projeto: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f11/2fc/576/f112fc576fc1f8bf7552625578093292.png" alt="Quadro 12"></div><br>  Role esta p√°gina para baixo e ative o salvamento em cache para a cria√ß√£o de solicita√ß√£o pull: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/8f3/f34/be88f3f34708075a49bdd13c65f5bc26.png" alt="Quadro 18"></div><br><br>  Agora vamos para a guia Ambiente, onde especificaremos a imagem para a compila√ß√£o e as vari√°veis ‚Äã‚Äãde ambiente necess√°rias: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/26a/80c/45326a80c62211c6b29bd16fad1ef0d1.png" alt="Quadro 19"></div><br>  Se voc√™ leu as se√ß√µes anteriores, j√° est√° familiarizado com essas duas vari√°veis ‚Äã‚Äã- <i>PVS_KEY</i> e <i>PVS_USERNAME</i> .  Caso contr√°rio, lembre-se de que eles s√£o necess√°rios para verificar a licen√ßa do analisador PVS-Studio.  No futuro, n√≥s os encontraremos novamente nos scripts do Bash. <br><br>  Na mesma p√°gina na parte inferior, vamos especificar a pasta de cache: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e2/967/dbf/4e2967dbfb796e2d0104d5b6539be65a.png" alt="Quadro 15"></div><br>  Se n√£o o fizermos, analisaremos o projeto inteiro em vez de alguns arquivos, mas receberemos a sa√≠da dos arquivos especificados.  Portanto, √© importante inserir o nome correto do reposit√≥rio. <br><br>  Agora chegou a hora do script de verifica√ß√£o.  Abra a guia Testes e escolha Script: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/dbd/0d6/b5fdbd0d6d448174bc05222fe1965c1c.png" alt="Quadro 20"></div><br>  O seguinte c√≥digo deve ser inserido neste formul√°rio: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get -y install jq wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update &amp;&amp; sudo apt-get -y install pvs-studio pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Vamos prestar aten√ß√£o √† seguinte parte do c√≥digo: <br><br><pre> <code class="bash hljs">PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  √â uma atribui√ß√£o bastante espec√≠fica do valor de sa√≠da do comando pwd para a vari√°vel, que deve armazenar esse valor por padr√£o.  No come√ßo parece estranho, mas deixe-me explicar tudo. <br><br>  Ao configurar o analisador no AppVeyor, me deparei com um comportamento muito estranho do analisador.  Por um lado, tudo funcionou corretamente, mas a an√°lise n√£o foi iniciada.  Demorou muito tempo para perceber que est√°vamos no diret√≥rio / home / appveyor / projects / testcalc /, enquanto o analisador tinha certeza de que est√°vamos em / opt / appveyor / build-agent /.  Naquele momento, percebi que a vari√°vel $ PWD √© enganosa.  Por esse motivo, renovei manualmente seu valor antes de executar a an√°lise. <br><br>  A ordem das a√ß√µes foi a mesma que anteriormente: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a99/1be/5b1/a991be5b13dd4e17ccb9cb47e4f48cf2.png" alt="Quadro 16"></div><br>  Agora d√™ uma olhada neste fragmento: <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>`</code> </pre> <br>  Nele, obtemos a diferen√ßa entre as ramifica√ß√µes, relacionada √† solicita√ß√£o de extra√ß√£o verificada.  Para fazer isso, precisamos das seguintes vari√°veis ‚Äã‚Äãde ambiente: <br><br><ul><li>  $ APPVEYOR_PULL_REQUEST_NUMBER - n√∫mero da solicita√ß√£o de recebimento; </li><li>  $ APPVEYOR_REPO_NAME - nome de usu√°rio e reposit√≥rio do projeto. </li></ul><br><h2>  Conclus√£o </h2><br>  Bem, n√£o consideramos todos os poss√≠veis servi√ßos de integra√ß√£o cont√≠nua, no entanto, todos eles t√™m especifica√ß√µes operacionais semelhantes.  Mas, como no cache, cada servi√ßo reinventa sua pr√≥pria roda, portanto √© sempre diferente. <br><br>  Em alguns casos (como no Travis-CI), s√£o necess√°rias algumas linhas de c√≥digo - e o cache funciona perfeitamente.  Em outros casos (como no AppVeyor), voc√™ apenas precisa especificar o diret√≥rio nas configura√ß√µes.  Mas existem alguns servi√ßos em que voc√™ precisa criar chaves especiais e tentar convencer o sistema a dar a oportunidade de reescrever um fragmento em cache.  Portanto, se voc√™ deseja configurar a an√°lise de solicita√ß√£o de recebimento em um servi√ßo de integra√ß√£o cont√≠nua, que n√£o foi considerado acima, primeiro, verifique se voc√™ n√£o ter√° problemas com o cache. <br><br>  Obrigado pela aten√ß√£o.  Se algo n√£o der certo, voc√™ pode escrever com seguran√ßa para o nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">suporte</a> .  Vamos dar uma dica e ajuda. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt470982/">https://habr.com/ru/post/pt470982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt470966/index.html">Senha Unix de Ken Thompson</a></li>
<li><a href="../pt470974/index.html">DNS passivo nas m√£os do analista</a></li>
<li><a href="../pt470976/index.html">Song of Ice (Empresa Sangrenta) e Chamas (DevOps e IaC)</a></li>
<li><a href="../pt470978/index.html">Pesquisa de mercado de analistas: onde eles estudam, quais ferramentas eles usam e quanto ganham</a></li>
<li><a href="../pt470980/index.html">As tarefas que os rob√¥s de software (RPAs) resolvem no setor banc√°rio</a></li>
<li><a href="../pt470984/index.html">An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio</a></li>
<li><a href="../pt470988/index.html">As inscri√ß√µes est√£o abertas para o Slerm DevOps em Moscou</a></li>
<li><a href="../pt470990/index.html">Kit de ferramentas de marketing on-line: 3 aplicativos para aumentar a comunica√ß√£o visual</a></li>
<li><a href="../pt470994/index.html">Heran√ßa JavaScript do ponto de vista de um nerd entediado: f√°brica de construtores</a></li>
<li><a href="../pt470996/index.html">Como uma simples tag <img> se torna um alto risco para uma empresa?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>