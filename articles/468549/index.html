<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí™ üñ≤Ô∏è ‚¨õÔ∏è GPU enlazado. C√≥mo transferir todo a la tarjeta de video y un poco m√°s. Animaciones üç© üë®‚Äçüéì üêøÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√ârase una vez, fue un gran evento cuando una unidad de texturizaci√≥n m√∫ltiple o transformaci√≥n e iluminaci√≥n de hardware (T&L) apareci√≥ en la GPU. Est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GPU enlazado. C√≥mo transferir todo a la tarjeta de video y un poco m√°s. Animaciones</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468549/">  √ârase una vez, fue un gran evento cuando una unidad de texturizaci√≥n m√∫ltiple o transformaci√≥n e iluminaci√≥n de hardware (T&amp;L) apareci√≥ en la GPU.  Establecer una tuber√≠a de funci√≥n fija fue un chamanismo m√°gico.  Y aquellos que sab√≠an c√≥mo habilitar y usar las funciones avanzadas de chips espec√≠ficos a trav√©s de los hacks API D3D9, se consideraban que hab√≠an aprendido Zen.  Pero el tiempo pas√≥, aparecieron sombreadores.  Al principio, muy limitado tanto en funcionalidad como en longitud.  Adem√°s, m√°s y m√°s funciones, m√°s instrucciones, m√°s velocidad.  Apareci√≥ Compute (CUDA, OpenCL, DirectCompute), y el alcance de las capacidades de las tarjetas de video comenz√≥ a expandirse r√°pidamente. <br><br>  En esta serie de (con suerte) art√≠culos, intentar√© explicar y mostrar c√≥mo "inusualmente" puede aplicar las capacidades de la GPU moderna al desarrollar juegos, adem√°s de los efectos gr√°ficos.  La primera parte estar√° dedicada al sistema de animaci√≥n.  Todo lo que se describe se basa en la experiencia pr√°ctica, implementado y funciona en proyectos de juegos reales. <br><a name="habracut"></a><br>  Oooo, de nuevo la animaci√≥n.  Sobre esto cien veces ya escrito y descrito.  ¬øQu√© es tan complicado?  Empacamos la matriz de huesos en el b√∫fer / textura, y la usamos para desollar en el sombreador de v√©rtices.  Esto se describi√≥ en las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GPU Gems 3 (Cap√≠tulo 2. Representaci√≥n animada de multitudes)</a> .  E implementado en la reciente presentaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Unite Tech</a> .  ¬øEs posible de otra manera? <br><br><h4>  Technodemka de Unity </h4><br>  Mucha publicidad, pero ¬øes realmente genial?  Hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo</a> en el centro que describe en detalle c√≥mo se realiza y funciona la animaci√≥n esquel√©tica en esta tecnodemo.  El trabajo paralelo es todo bueno, no los consideramos.  Pero necesitamos averiguar qu√© y c√≥mo hay, en t√©rminos de representaci√≥n. <br><br>  En una batalla a gran escala, dos ej√©rcitos luchan, cada uno compuesto por un tipo de unidad.  Esqueletos a la izquierda, caballeros a la derecha.  La variedad es regular.  Cada unidad consta de 3 LOD (~ 300, ~ 1000, ~ 4000 v√©rtices cada uno), y solo 2 huesos afectan el v√©rtice.  El sistema de animaci√≥n consta de solo 7 animaciones para cada tipo de unidad (recuerdo que ya hay 2 de ellas).  Las animaciones no se mezclan, pero cambian discretamente del c√≥digo simple que se ejecuta en job'ax, que se enfatiza en la presentaci√≥n.  No hay m√°quina de estados.  Cuando tenemos dos tipos de malla, puede atraer a toda la multitud en dos llamadas de sorteo instantaneas.  La animaci√≥n esquel√©tica, como ya escrib√≠, se basa en la tecnolog√≠a descrita en 2009. <br>  Innovador?  Hmm ... un gran avance?  Um ... ¬øAdecuado para juegos modernos?  Bueno, tal vez, la relaci√≥n de FPS a la cantidad de unidades se jacta. <br><br>  Las principales desventajas de este enfoque (matriz previa en texturas): <br><br><ol><li>  Velocidad de fotogramas dependiente.  Quer√≠a el doble de cuadros de animaci√≥n: da el doble de memoria. </li><li>  Falta de animaciones combinadas.  Puede hacerlos, por supuesto, pero en el sombreador de la piel se formar√° un desorden complejo a partir de la l√≥gica de fusi√≥n. </li><li>  Falta de enlace a la m√°quina de estado de Unity Animator.  Una herramienta conveniente para personalizar el comportamiento del personaje, que se puede conectar a cualquier sistema de dise√±o, pero en nuestro caso, debido al punto 2, todo se vuelve muy dif√≠cil (imagine c√≥mo mezclar el BlendTree anidado). </li></ol><br><h4>  GPAS </h4><br>  Sistema de animaci√≥n con GPU.  El nombre acaba de aparecer. <br>  El nuevo sistema de animaci√≥n ten√≠a varios requisitos: <br><br><ol><li>  Trabaja r√°pido (bueno, comprensible).  Necesitas animar decenas de miles de unidades diferentes. </li><li>  Sea un an√°logo completo (o casi) del sistema de animaci√≥n Unity.  Si la animaci√≥n se ve as√≠, en el nuevo sistema deber√≠a verse exactamente igual.  Posibilidad de cambiar entre sistemas integrados de CPU y GPU.  Esto a menudo es necesario para la depuraci√≥n.  Cuando las animaciones son "defectuosas", al cambiar al animador cl√°sico, puede comprender: estos son los problemas t√©cnicos del nuevo sistema, o la m√°quina de estado / animaci√≥n en s√≠. </li><li>  Todas las animaciones son personalizables en Unity Animator.  Una herramienta conveniente, probada y, lo m√°s importante, lista para usar.  Construiremos bicicletas en otros lugares. </li></ol><br>  Replanteemos la preparaci√≥n y elaboraci√≥n de animaciones.  No usaremos matrices.  Las tarjetas de video modernas funcionan bien con bucles, admiten de forma nativa int adem√°s de flotante, por lo que trabajaremos con fotogramas clave como en una CPU. <br><br>  Veamos un ejemplo de animaci√≥n en el Visor de animaci√≥n: <br><br><img src="https://habrastorage.org/webt/_4/yw/bg/_4ywbgkzw8frqb3pjng98db5zwm.jpeg"><br><br>  Se puede ver que los fotogramas clave se configuran por separado para posici√≥n, escala y rotaci√≥n.  Para algunos huesos, necesita muchos de ellos, para algunos solo unos pocos, y para aquellos huesos que no est√°n animados por separado, solo se configuran los fotogramas clave iniciales y finales. <br><br>  Posici√≥n - Vector3, quaternion - Vector4, escala - Vector3.  La estructura de fotogramas clave tendr√° una cosa en com√∫n (para simplificar), por lo que necesitamos 4 flotantes para adaptarse a cualquiera de los tipos anteriores.  Tambi√©n necesitamos InTangent y OutTangent para la interpolaci√≥n correcta entre fotogramas clave de acuerdo con la curvatura.  Ah s√≠, y el tiempo normalizado no olvida: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KeyFrame</span></span></span><span class="hljs-class"> {</span></span> float4 v; float4 inTan, outTan; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> time; };</code> </pre> <br>  Para obtener todos los fotogramas clave, use AnimationUtility.GetEditorCurve (). <br>  Adem√°s, debemos recordar los nombres de los huesos, ya que ser√° necesario reasignar los huesos de la animaci√≥n en los huesos del esqueleto (y pueden no coincidir) en la etapa de preparaci√≥n de los datos de la GPU. <br><br>  Al llenar los buffers lineales con matrices de fotogramas clave, recordaremos los desplazamientos en ellos para encontrar aquellos que se relacionen con la animaci√≥n que necesitamos. <br><br>  Ahora interesante  Animaci√≥n esqueleto de GPU. <br><br>  Preparamos un gran b√∫fer ("n√∫mero de esqueletos animados" X "n√∫mero de huesos en el esqueleto" X "coeficiente emp√≠rico del n√∫mero m√°ximo de mezclas de animaci√≥n").  En √©l almacenaremos la posici√≥n, rotaci√≥n y escala del hueso en el momento de la animaci√≥n.  Y para todos los huesos animados planificados en este marco, ejecute el sombreador de c√≥mputo.  Cada hilo anima su hueso. <br><br>  Cada fotograma clave, independientemente del tama√±o al que pertenece (Traducir, Rotaci√≥n, Escala), se interpola exactamente de la misma manera (b√∫squeda por b√∫squeda lineal, perd√≥name Knuth): <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InterpolateKeyFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(inout float4 rv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startIdx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> endIdx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = startIdx; i &lt; endIdx; ++i) { KeyFrame k0 = keyFrames[i + <span class="hljs-number"><span class="hljs-number">0</span></span>]; KeyFrame k1 = keyFrames[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> lerpFactor = (t - k0.time) / (k1.time - k0.time); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lerpFactor &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || lerpFactor &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rv = CurveInterpoate(k0, k1, lerpFactor); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  La curva es una curva de Bezier c√∫bica, por lo que la funci√≥n de interpolaci√≥n ser√° la siguiente: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">float4 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CurveInterpoate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KeyFrame v0, KeyFrame v1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dt = v1.time - v0.time; float4 m0 = v0.outTan * dt; float4 m1 = v1.inTan * dt; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> t2 = t * t; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> t3 = t2 * t; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a = <span class="hljs-number"><span class="hljs-number">2</span></span> * t3 - <span class="hljs-number"><span class="hljs-number">3</span></span> * t2 + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> b = t3 - <span class="hljs-number"><span class="hljs-number">2</span></span> * t2 + t; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> c = t3 - t2; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> d = <span class="hljs-number"><span class="hljs-number">-2</span></span> * t3 + <span class="hljs-number"><span class="hljs-number">3</span></span> * t2; float4 rv = a * v0.v + b * m0 + c * m1 + d * v1.v; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rv; }</code> </pre><br>  Se calcul√≥ la postura local (TRS) del hueso.  Luego, con un sombreador de c√≥mputo separado, combinamos todas las animaciones necesarias para este hueso.  Para hacer esto, tenemos un b√∫fer con √≠ndices de animaci√≥n y pesos de cada animaci√≥n en la mezcla final.  Obtenemos esta informaci√≥n de la m√°quina de estado.  La situaci√≥n de BlendTree dentro de BlendTree se resuelve de la siguiente manera.  Por ejemplo, hay un √°rbol: <br><br><img src="https://habrastorage.org/webt/yg/n6/_4/ygn6_4arygdkgbnigucbv0tz0fe.jpeg"><br><br>  BlendTree Walk tendr√° un peso de 0.35, Run - 0.65.  En consecuencia, la posici√≥n final de los huesos debe estar determinada por 4 animaciones: Walk1, Walk2, Run1 y Run2.  Sus pesos tendr√°n valores (0.35 * 0.92, 0.35 * 0.08, 0.65 * 0.92, 0.65 * 0.08) = (0.322, 0.028, 0.598, 0.052), respectivamente.  Cabe se√±alar que la suma de los pesos siempre debe ser igual a uno, o se proporcionan errores m√°gicos. <br><br>  El "coraz√≥n" de la funci√≥n de fusi√≥n: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> bw = animDef.blendWeight; BoneXForm boneToBlend = animatedBones[srcBoneIndex]; float4 q = boneToBlend.quat; float3 t = boneToBlend.translate; float3 s = boneToBlend.scale; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dot(resultBone.quat, q) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) q = -q; resultBone.translate += t * bw; resultBone.quat += q * bw; resultBone.scale += s * bw;</code> </pre><br>  Ahora puedes traducir a una matriz de transformaci√≥n.  Para  Sobre la jerarqu√≠a de los huesos completamente olvidados. <br>  En base a los datos del esqueleto, construimos una matriz de √≠ndices, donde la c√©lula con el √≠ndice √≥seo contiene el √≠ndice de su padre.  En la ra√≠z, escribe -1. <br><br>  Un ejemplo: <br><br><img src="https://habrastorage.org/webt/c0/8v/tl/c08vtlrw1w80dsczyczusebox34.jpeg"><br><br><pre> <code class="cpp hljs">float4x4 animMat = IdentityMatrix(); float4x4 mat = initialPoses[boneId]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (boneId &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { BoneXForm b = blendedBones[boneId]; float4x4 xform = MakeTransformMatrix(b.translate, b.quat, b.scale); animMat = mul(animMat, xform); boneId = bonesHierarchyIndices[boneId]; } mat = mul(mat, animMat); resultSkeletons[id] = mat;</code> </pre><br>  Aqu√≠, en principio, todos los puntos principales de renderizar y mezclar animaciones. <br><br><h4>  GPSM </h4><br>  GPU Powered State Machine (lo has adivinado bien).  El sistema de animaci√≥n descrito anteriormente funcionar√≠a perfectamente con la Unidad de estado de animaci√≥n de Unity, pero entonces todos los esfuerzos ser√≠an in√∫tiles.  Con la posibilidad de calcular decenas (si no cientos) de miles de animaciones por fotograma, UnityAnimator no extraer√° miles de m√°quinas de estado que funcionen simult√°neamente.  Hmm ... <br>  ¬øQu√© es una m√°quina de estado en Unity?  Este es un sistema cerrado de estados y transiciones, que se controla mediante propiedades num√©ricas simples.  Cada m√°quina de estado funciona de manera independiente y para el mismo conjunto de datos de entrada.  Espera un minuto  ¬°Esta es una tarea ideal para la GPU y los sombreadores de c√≥mputo! <br><br>  <u>Fase de horneado</u> <br><br>  Primero, necesitamos recopilar y colocar todos los datos de la m√°quina de estado en una estructura amigable para GPU.  Y esto: estados (estados), transiciones (transiciones) y par√°metros (par√°metros). <br>  Todos estos datos se colocan en buffers lineales y se abordan por √≠ndices. <br>  Cada hilo de c√°lculo considera su m√°quina de estados.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AnimatorController</a> proporciona una interfaz para todas las estructuras de m√°quinas de estado internas necesarias. <br><br>  Las principales estructuras de la m√°quina de estado: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> speed; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> firstTransition; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numTransitions; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> animDefId; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Transition</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> exitTime; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> duration; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sourceStateId; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> targetStateId; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> firstCondition; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> endCondition; uint properties; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> timeInState; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> animationLoop; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TransitionData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> timeInTransition; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentState</span></span></span><span class="hljs-class"> {</span></span> StateData srcState, dstState; TransitionData transition; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnimationDef</span></span></span><span class="hljs-class"> {</span></span> uint animId; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextAnimInTree; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> parameterIdx; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> lengthInSec; uint numBones; uint loop; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParameterDef</span></span></span><span class="hljs-class"> {</span></span> float2 line0ab, line1ab; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> runtimeParamId; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextParameterId; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Condition</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> checkMode; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> runtimeParamIndex; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> referenceValue; };</code> </pre><br><ul><li>  El estado contiene la velocidad a la que se juega el estado y los √≠ndices de las condiciones para la transici√≥n a otros seg√∫n la m√°quina de estados. </li><li>  La transici√≥n contiene √≠ndices de estado "de" y "a".  Tiempo de transici√≥n, tiempo de salida y un enlace a una serie de condiciones para entrar en este estado. </li><li>  CurrentState es un bloque de datos de tiempo de ejecuci√≥n con datos sobre el estado actual de la m√°quina de estados. </li><li>  AnimationDef contiene una descripci√≥n de la animaci√≥n con enlaces a otros relacionados con ella por BlendTree. </li><li>  ParameterDef es una descripci√≥n del par√°metro que controla el comportamiento de las m√°quinas de estado.  Line0ab y Line1ab son los coeficientes de la ecuaci√≥n de l√≠neas para determinar el peso de la animaci√≥n por el valor del par√°metro.  Desde aqu√≠: <br><br><img src="https://habrastorage.org/webt/ge/dl/wd/gedlwdz-u4iiyqciuy-lewx8xnm.jpeg"><br></li><li>  Condici√≥n: especificaci√≥n de la condici√≥n para comparar el valor de tiempo de ejecuci√≥n del par√°metro y el valor de referencia. </li></ul><br>  <u>Fase de tiempo de ejecuci√≥n</u> <br><br>  El ciclo principal de cada m√°quina de estado se puede mostrar utilizando el siguiente algoritmo: <br><br><img src="https://habrastorage.org/webt/q_/cu/gc/q_cugcb1tr2krdkztmuxbr1yds8.jpeg"><br><br>  Hay 4 tipos de par√°metros en Unity animator: float, int, bool y trigger (que es bool).  Los presentaremos a todos como flotantes.  Al configurar las condiciones, es posible elegir uno de los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">seis</a> tipos de comparaci√≥n.  Si == es igual.  IfNot == NotEqual.  Por lo tanto, utilizaremos solo 4. El √≠ndice del operador se pasa al campo checkMode de la estructura Condici√≥n. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = t.firstCondition; i &lt; t.endCondition; ++i) { Condition c = allConditions[i]; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> paramValue = runtimeParameters[c.runtimeParamIndex]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (c.checkMode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramValue &lt; c.referenceValue) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramValue &gt; c.referenceValue) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(paramValue - c.referenceValue) &gt; <span class="hljs-number"><span class="hljs-number">0.001f</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(paramValue - c.referenceValue) &lt; <span class="hljs-number"><span class="hljs-number">0.001f</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre><br>  Para comenzar la transici√≥n, todas las condiciones deben ser verdaderas.  Las etiquetas de casos extra√±os son solo (int) AnimatorConditionMode.  La l√≥gica de interrupci√≥n es una l√≥gica enga√±osa para interrumpir y revertir las transiciones. <br><br>  Despu√©s de actualizar el estado de la m√°quina de estados y desplazar las marcas de tiempo en el marco delta t, es hora de preparar datos sobre qu√© animaciones deben leerse en este marco y los pesos correspondientes.  Este paso se omite si el modelo de la unidad no est√° en el marco (Frustum descartado).  ¬øPor qu√© deber√≠amos considerar animaciones de lo que no es visible?  Repasamos el estado de origen del √°rbol de mezclas, el estado de destino del √°rbol de mezclas, agregamos todas las animaciones de ellos y calculamos los pesos por el tiempo normalizado de transici√≥n de origen a destino (tiempo dedicado a la transici√≥n).  Con los datos preparados, GPAS entra en juego y cuenta animaciones para cada entidad animada en el juego. <br><br>  Los par√°metros de control de la unidad provienen de la l√≥gica de control de la unidad.  Por ejemplo, debe habilitar la ejecuci√≥n, establecer el par√°metro CharSpeed ‚Äã‚Äãy una m√°quina de estado configurada correctamente combina sin problemas las animaciones de transici√≥n de "caminar" a "correr". <br><br>  Naturalmente, la analog√≠a completa con Unity Animator no funcion√≥.  Los principios internos del trabajo, si no se describen en la documentaci√≥n, tuvieron que revertirse y hacerse un an√°logo.  Algunas funcionalidades a√∫n no se han completado (puede que no sea as√≠).  Por ejemplo, BlendType en BlendTree solo admite 1D.  Hacer otros tipos, en principio, no es dif√≠cil, ahora mismo no es necesario.  No hay eventos de animaci√≥n, ya que es necesario volver a leer con la GPU, y la lectura "correcta" tendr√° varios fotogramas atr√°s, lo que no siempre es aceptable.  Pero tambi√©n es posible. <br><br><h4>  Renderizar </h4><br>  La representaci√≥n de la unidad se realiza a trav√©s de instancias.  De acuerdo con SV_InstanceID, en el sombreador de v√©rtices, obtenemos la matriz de todos los huesos que afectan el v√©rtice y lo transformamos.  Absolutamente nada inusual: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">float4 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplySkin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(float3 v, uint vertexID, uint instanceID)</span></span></span><span class="hljs-function"> </span></span>{ BoneInfoPacked bip = boneInfos[vertexID]; BoneInfo bi = UnpackBoneInfo(bip); SkeletonInstance skelInst = skeletonInstances[instanceID]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bonesOffset = skelInst.boneOffset; float4x4 animMat = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> bw = bi.boneWeights[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bw &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { uint boneId = bi.boneIDs[i]; float4x4 boneMat = boneMatrices[boneId + bonesOffset]; animMat += boneMat * bw; } } float4 rv = float4(v, <span class="hljs-number"><span class="hljs-number">1</span></span>); rv = mul(rv, animMat); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rv; }</code> </pre><br><h4>  Resumen </h4><br>  ¬øEsta granja funciona r√°pido?  Obviamente m√°s lento que muestrear la textura con matrices, pero a√∫n as√≠, puedo mostrar algunos n√∫meros (GTX 970). <br><br>  Aqu√≠ hay 50,000 m√°quinas de estado: <br><br><img src="https://habrastorage.org/webt/cw/bv/4o/cwbv4oww0dles0lwgt-xlsqxg5m.jpeg"><br><br>  Aqu√≠ hay 280,000 huesos animados: <br><br><img src="https://habrastorage.org/webt/pe/lt/pv/peltpvbyztjsutrkxmhxyjbimbs.jpeg"><br><br>  Dise√±ar y depurar todo esto es un verdadero dolor.  Un mont√≥n de amortiguadores y compensaciones.  Un mont√≥n de componentes y sus interacciones.  Hubo momentos en que las manos cayeron cuando te golpeaste la cabeza por un problema durante varios d√≠as, pero no puedes encontrar cu√°l es el problema.  Es especialmente "agradable" cuando todo funciona como deber√≠a en los datos de prueba, pero en una situaci√≥n real de "combate" no hay ning√∫n tipo de falla de animaci√≥n.  Las discrepancias entre el funcionamiento de las m√°quinas de estado de Unity y las suyas tampoco son visibles de inmediato.  En general, si decides hacer un an√°logo para ti, no te envidio.  En realidad, todo el desarrollo bajo la GPU es motivo de queja. <br><br>  <b>PD</b> : Quiero tirar una piedra al jard√≠n de los desarrolladores de Unite TechDemo.  Tienen una gran cantidad de modelos id√©nticos de ruinas y puentes en el escenario, y no optimizaron su representaci√≥n de ninguna manera.  Por el contrario, lo intentaron marcando "est√°tico".  Pero ahora, en los √≠ndices de 16 bits no se puede acumular mucha geometr√≠a (tres veces jaja, 2017) y nada se ha unido, ya que los modelos son altamente poligonales.  Puse "Activar Instancing" para todos los sombreadores y desmarqu√© "Est√°tico".  No hubo un impulso tangible, pero, maldita sea, est√°s haciendo una demo demo, luchando por cada FPS.  No puedes cagar as√≠. <br><br><div class="spoiler">  <b class="spoiler_title">Era</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">*** Summary *** Draw calls: 2553 Dispatch calls: 0 API calls: 8378 Index/vertex bind calls: 2992 Constant bind calls: 648 Sampler bind calls: 395 Resource bind calls: 805 Shader set calls: 682 Blend set calls: 230 Depth/stencil set calls: 92 Rasterization set calls: 238 Resource update calls: 1017 Output set calls: 74 API:Draw/Dispatch call ratio: 3.28163 298 Textures - 1041.01 MB (1039.95 MB over 32x32), 42 RTs - 306.94 MB. Avg. tex dimension: 1811.77x1810.21 (2016.63x2038.98 over 32x32) 216 Buffers - 180.11 MB total 17.54 MB IBs 159.81 MB VBs. 1528.06 MB - Grand total GPU buffer + texture load. *** Draw Statistics *** Total calls: 2553, instanced: 2, indirect: 2 Instance counts: 1: 2: 3: 4: 5: 6: 7: 8: 9: 10: 11: 12: 13: 14: &gt;=15: ******************************************************************************************************************************** (2)</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Se ha convertido</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">*** Summary *** Draw calls: 1474 Dispatch calls: 0 API calls: 11106 Index/vertex bind calls: 3647 Constant bind calls: 1039 Sampler bind calls: 348 Resource bind calls: 718 Shader set calls: 686 Blend set calls: 230 Depth/stencil set calls: 110 Rasterization set calls: 258 Resource update calls: 1904 Output set calls: 74 API:Draw/Dispatch call ratio: 7.5346 298 Textures - 1041.01 MB (1039.95 MB over 32x32), 42 RTs - 306.94 MB. Avg. tex dimension: 1811.77x1810.21 (2016.63x2038.98 over 32x32) 427 Buffers - 93.30 MB total 9.81 MB IBs 80.51 MB VBs. 1441.25 MB - Grand total GPU buffer + texture load. *** Draw Statistics *** Total calls: 1474, instanced: 391, indirect: 2 Instance counts: 1: 2: ******************************************************************************************************************************** (104) 3: ************************************************* (40) 4: ********************** (18) 5: ****************************** (25) 6: ********************************************************************************************* (76) 7: *********************************** (29) 8: ************************************************** (41) 9: ********* (8) 10: ************** (12) 11: 12: ****** (5) 13: ******* (6) 14: ** (2) &gt;=15: ****************************** (25)</code> </pre><br></div></div><br>  <b>PPS</b> En todo momento, los juegos estaban principalmente vinculados a la CPU, es decir  La CPU no sigui√≥ el ritmo de la GPU.  Demasiada l√≥gica y f√≠sica.  Al transferir parte de la l√≥gica del juego de la CPU a la GPU, descargamos el primero y cargamos el segundo, es decir  hacer que la situaci√≥n de GPU sea m√°s probable.  De ah√≠ el t√≠tulo del art√≠culo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468549/">https://habr.com/ru/post/468549/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468535/index.html">¬øNo necesitas registros?</a></li>
<li><a href="../468537/index.html">Conceptos b√°sicos de DevOps. Ingreso al proyecto desde cero</a></li>
<li><a href="../468541/index.html">¬øArrastrar y soltar componentes para usuarios ciegos? Estas bromeando</a></li>
<li><a href="../468543/index.html">Entre semana Comit√© del Programa FrontendConf. Entrevista con Sergey Popov</a></li>
<li><a href="../468547/index.html">Habla ingl√©s, CSS, Grid y accesibilidad en FrontendConf</a></li>
<li><a href="../468553/index.html">Gesti√≥n de par√°metros en aplicaciones empresariales similares a un sistema de control de versiones.</a></li>
<li><a href="../468555/index.html">Introducci√≥n a los ensambles deterministas en C / C ++. Parte 2</a></li>
<li><a href="../468557/index.html">WEB 3.0: el segundo enfoque del proyectil</a></li>
<li><a href="../468559/index.html">Copia de seguridad de la nube, amigos</a></li>
<li><a href="../468561/index.html">Semana de la seguridad 39: errores de seguridad y comunes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>