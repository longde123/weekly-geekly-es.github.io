<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëú üé≠ üè¶ Gestion de la m√©moire ou moins souvent vous tirer une balle dans le pied ü§≥üèΩ üëΩ ü§õüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Dans cet article, je vais essayer de dire ce qu'est la gestion de la m√©moire dans les programmes / applications du point de vue d'un pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gestion de la m√©moire ou moins souvent vous tirer une balle dans le pied</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473294/"><p>  Bonjour, Habr!  Dans cet article, je vais essayer de dire ce qu'est la gestion de la m√©moire dans les programmes / applications du point de vue d'un programmeur d'application.  Ce n'est pas un guide ou un manuel exhaustif, mais simplement un aper√ßu des probl√®mes existants et quelques approches pour les r√©soudre. </p><br><p>  Pourquoi est-ce n√©cessaire?  Un programme est une s√©quence d'instructions de traitement de donn√©es (dans le cas le plus g√©n√©ral).  Ces donn√©es doivent <strong>√™tre stock√©es</strong> , <strong>charg√©es</strong> , <strong>transf√©r√©es</strong> , etc. d'une mani√®re ou d'une autre.  Toutes ces op√©rations ne se produisent pas instantan√©ment, par cons√©quent, elles affectent directement la vitesse de votre application finale.  La capacit√© de g√©rer de mani√®re optimale les donn√©es au cours du travail vous permettra de cr√©er des programmes tr√®s simples et tr√®s gourmands en ressources. </p><br><p>  Remarque: la majeure partie du mat√©riel est pr√©sent√©e avec des exemples de jeux / moteurs de jeu (car ce sujet est plus int√©ressant pour moi personnellement), cependant, la plupart du mat√©riel peut √™tre appliqu√© aux serveurs d'√©criture, aux applications utilisateur, aux packages graphiques, etc. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f13/ef3/482/f13ef3482dfe066b41b53e44179a0242.jpg"></p><br><p>  <em>Il est impossible de tout garder √† l'esprit.</em>  <em>Mais si vous n'avez pas r√©ussi √† le charger, vous aurez du savon</em> </p><a name="habracut"></a><br><h1 id="s-mesta-v-karer">  D√®s le d√©part </h1><br><p>  Il est arriv√© dans l'industrie que les grands projets de jeux AAA soient d√©velopp√©s principalement sur des moteurs √©crits en C ++.  L'une des caract√©ristiques de ce langage est la n√©cessit√© d'une gestion manuelle de la m√©moire.  Java / C # etc.  Ils se vantent de la collecte des ordures (GarbageCollection / GC) - la possibilit√© de cr√©er des objets et de ne pas lib√©rer la m√©moire utilis√©e √† la main.  Ce processus simplifie et acc√©l√®re le d√©veloppement, mais il peut √©galement causer des probl√®mes: un ramasse-miettes d√©clench√© p√©riodiquement peut tuer tout le temps r√©el doux et ajouter des gels d√©sagr√©ables au jeu. </p><br><p>  Oui, dans des projets comme "Minecraft", le GC peut ne pas √™tre visible, car  ils n'exigent g√©n√©ralement pas les ressources de l'ordinateur, mais des jeux tels que "Red Dead Redemption 2", "God of War", "Last of Us" fonctionnent "presque" au sommet des performances du syst√®me et ont donc besoin non seulement de grandes le montant des ressources, mais aussi dans leur r√©partition comp√©tente. </p><br><p>  De plus, en travaillant dans un environnement avec allocation automatique de m√©moire et r√©cup√©ration de place, vous pouvez rencontrer un manque de flexibilit√© dans la gestion des ressources.  Ce n'est un secret pour personne que Java cache tous les d√©tails de mise en ≈ìuvre et les aspects de son travail sous le capot, donc √† la sortie, vous n'avez que l'interface install√©e pour interagir avec les ressources du syst√®me, mais cela peut ne pas √™tre suffisant pour r√©soudre certains probl√®mes.  Par exemple, le d√©marrage d'un algorithme avec un nombre non constant d'allocations de m√©moire dans chaque image (cela peut √™tre une recherche de chemins pour l'IA, la v√©rification de la visibilit√©, l'animation, etc.) conduit in√©vitablement √† une baisse catastrophique des performances. </p><br><h1 id="kak-vyglyadyat-allokacii-v-kode">  A quoi ressemblent les allocations dans le code </h1><br><p>  Avant de poursuivre la discussion, je voudrais montrer comment le travail avec la m√©moire en C / C ++ se produit directement avec quelques exemples.  En g√©n√©ral, l'interface standard et la plus simple pour l'allocation de m√©moire de processus est repr√©sent√©e par les op√©rations suivantes: </p><br><pre><code class="plaintext hljs">//        size  void* malloc(size_t size); //      p void free(void* p);</code> </pre> <br><p>  Ici, vous pouvez ajouter des fonctions suppl√©mentaires qui vous permettent d'allouer un morceau de m√©moire align√©: </p><br><pre> <code class="plaintext hljs">// C11  -     , * alignment void* aligned_alloc(size_t size, size_t alignment); // Posix  -       //        address (*address = allocated_mem_p) int posix_memalign(void** address, size_t alignment, size_t size);</code> </pre> <br><p>  Veuillez noter que diff√©rentes plates-formes peuvent prendre en charge diff√©rentes normes de fonction, disponibles par exemple sur macOS et non disponibles sur win. </p><br><p>  √Ä l'avenir, <strong>des</strong> zones de m√©moire <strong>sp√©cialement</strong> align√©es peuvent √™tre n√©cessaires √† la fois pour atteindre la ligne de cache du processeur et pour les calculs √† l'aide d'un ensemble √©tendu de registres ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SSE</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MMX</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AVX</a> , etc.). </p><br><p>  Un exemple de programme jouet qui alloue de la m√©moire et imprime des valeurs de tampon, les interpr√©tant comme des entiers sign√©s: </p><br><pre> <code class="plaintext hljs">/* main.cpp */ #include &lt;cstdio&gt; #include &lt;cstdlib&gt; int main(int argc, char** argv) { const int N = 10; int* buffer = (int*) malloc(sizeof(int) * N); for(int i = 0; i &lt; N; i++) { printf("%i ", buffer[i]); } free(buffer); return 0; }</code> </pre> <br><p>  Sur macOS 10.14, ce programme peut √™tre cr√©√© et ex√©cut√© avec l'ensemble de commandes suivant: </p><br><pre> <code class="plaintext hljs">$ clang++ main.cpp -o main $ ./main</code> </pre> <br><p>  Remarque: ci-apr√®s, je ne veux pas vraiment couvrir les op√©rations C ++ telles que new / delete, car elles sont plus susceptibles d'√™tre utilis√©es pour construire / d√©truire des objets directement, mais elles utilisent les op√©rations habituelles avec de la m√©moire comme malloc / free. </p><br><h1 id="problemy-s-pamyatyu">  Probl√®mes de m√©moire </h1><br><p>  Plusieurs probl√®mes surviennent lors de l'utilisation de la m√©moire RAM de l'ordinateur.  Tous, d'une mani√®re ou d'une autre, sont caus√©s non seulement par les fonctionnalit√©s de l'OS et du logiciel, mais √©galement par l'architecture du fer sur lequel tout cela fonctionne. </p><br><h3 id="1-kolichestvo-pamyati">  1. Quantit√© de m√©moire </h3><br><p>  Malheureusement, la m√©moire est physiquement limit√©e.  Sur PlayStation 4, il s'agit de 8 Gio GDDR5, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3,5 Gio dont le syst√®me d'exploitation r√©serve √† ses besoins</a> .  La m√©moire virtuelle et l'√©change de pages n'aideront pas beaucoup, car l'√©change de pages sur le disque est une op√©ration tr√®s lente (dans un nombre fixe de N images par seconde, si nous parlons de jeux). </p><br><p>  Il convient √©galement de noter le " <em>budget</em> " limit√© - une limitation artificielle de la quantit√© de m√©moire utilis√©e, cr√©√©e pour ex√©cuter l'application sur plusieurs plates-formes.  Si vous cr√©ez un jeu pour une plate-forme mobile et que vous souhaitez prendre en charge non pas un, mais toute une gamme d'appareils, vous devrez limiter votre app√©tit afin d'offrir un march√© plus large.  Cela peut √™tre r√©alis√© √† la fois en limitant simplement la consommation de RAM et en configurant cette restriction en fonction du gadget sur lequel le jeu d√©marre r√©ellement. </p><br><h3 id="2-fragmentaciya">  2. Fragmentation </h3><br><p>  Un effet d√©sagr√©able qui appara√Æt au cours du processus d'allocations multiples de morceaux de m√©moire de diff√©rentes tailles.  Par cons√©quent, vous obtenez un espace d'adressage fragment√© en plusieurs parties distinctes.  La combinaison de ces parties en blocs simples de plus grande taille ne fonctionnera pas, car une partie de la m√©moire est occup√©e et nous ne pouvons pas la d√©placer librement. </p><br><p><img src="https://habrastorage.org/webt/8f/un/ie/8funiekbmroqz6xqhdpsyrpovcs.png"><br>  Fragmentation par l'exemple d'allocations s√©quentielles et de lib√©rations de blocs de m√©moire </p><br><p>  R√©sultat: nous pouvons avoir suffisamment de m√©moire libre quantitativement, mais pas qualitativement.  Et la demande suivante, par exemple, "allouer de l'espace pour la piste audio", l'allocateur ne sera pas en mesure de satisfaire, car il n'y a tout simplement pas un seul morceau de m√©moire de cette taille. </p><br><h3 id="3-kesh-processora">  3. Cache CPU </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e9d/592/5e5/e9d5925e5a0fc9629656ead20ce91b36.png"><br>  Hi√©rarchie de la m√©moire informatique </p><br><p>  Le cache d'un processeur moderne est un lien interm√©diaire qui relie la m√©moire principale (RAM) et le processeur s'inscrit directement.  Il se trouve que l'acc√®s en lecture / √©criture √† la m√©moire est une op√©ration tr√®s lente (si l'on parle du nombre de cycles d'horloge CPU requis pour s'ex√©cuter).  Par cons√©quent, il existe une certaine hi√©rarchie de cache (L1, L2, L3, etc.), qui permet, pour ainsi dire, "selon certaines pr√©visions" de charger des donn√©es √† partir de la RAM, ou de les pousser lentement dans une m√©moire plus lente. </p><br><p>  Le fait de placer des objets du m√™me type dans une rang√©e en m√©moire vous permet d'acc√©l√©rer "de mani√®re significative" le processus de leur traitement (si le traitement se fait s√©quentiellement), car dans ce cas, il est plus facile de pr√©dire quelles donn√©es seront ensuite n√©cessaires.  Et par ¬´significatif¬ª, on entend parfois des gains de productivit√©.  Les d√©veloppeurs du moteur Unity en ont parl√© √† plusieurs reprises dans leurs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapports au GDC</a> . </p><br><h3 id="4-multi-threading">  4. Multi-threading </h3><br><p>  <strong>Assurer un acc√®s s√©curis√© √† la m√©moire partag√©e dans un environnement multi-thread</strong> est l'un des principaux probl√®mes que vous devrez r√©soudre lors de la cr√©ation de votre propre moteur de jeu / jeu / toute autre application qui utilise plusieurs threads pour obtenir de meilleures performances.  Les ordinateurs modernes sont dispos√©s de mani√®re tr√®s simple.  Nous avons √† la fois une structure de cache complexe et plusieurs c≈ìurs de calculatrice.  Tout cela, s'il n'est pas utilis√© correctement, peut conduire √† des situations o√π les donn√©es partag√©es de votre processus seront endommag√©es √† la suite de plusieurs threads (s'ils essaient simultan√©ment de travailler avec ces donn√©es sans contr√¥le d'acc√®s).  Dans le cas le plus simple, cela ressemblera √† ceci: <br><img src="https://habrastorage.org/webt/sl/dm/2y/sldm2ybotnk9ncozwf5rkgozifw.png"><br>  Je ne veux pas m'attarder sur le sujet de la programmation multithread, car nombre de ses aspects d√©passent largement le cadre de l'article ou m√™me de l'ensemble du livre. </p><br><h3 id="5-mallocfree">  5. Malloc / gratuit </h3><br><p>  Les op√©rations d'allocation / lib√©ration ne se produisent pas instantan√©ment.  Sur les syst√®mes d'exploitation modernes, si nous parlons de Windows / Linux / MacOS, ils sont bien mis en ≈ìuvre et fonctionnent <em>rapidement dans la plupart des situations</em> .  Mais cela peut potentiellement prendre beaucoup de temps.  Non seulement c'est un appel syst√®me, mais selon l'impl√©mentation, cela peut prendre un certain temps pour trouver une m√©moire appropri√©e (First Fit, Best fit, etc.) ou pour trouver un endroit pour ins√©rer et / ou fusionner la zone lib√©r√©e. </p><br><p>  En outre, la m√©moire fra√Æchement allou√©e peut ne pas r√©ellement √™tre mapp√©e sur de vraies pages physiques, ce qui peut √©galement prendre un certain temps lors du premier acc√®s. </p><br><p>  Ce sont des d√©tails d'impl√©mentation, mais qu'en est-il de l'applicabilit√©?  Malloc / new n'a aucune id√©e d'o√π, comment ou pourquoi vous les avez appel√©s.  Ils allouent de la m√©moire (dans le pire des cas) de 1 Kio et 100 Mio tout aussi ... tout aussi mauvais.  Directement, la strat√©gie d'utilisation est laiss√©e au programmeur ou √† celui qui a impl√©ment√© le runtime de votre programme. </p><br><h3 id="6-memory-corruption">  6. Corruption de m√©moire </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comme le dit le wiki</a> , c'est l'une des erreurs les plus impr√©visibles qui n'appara√Æt qu'au cours du programme, et est le plus souvent caus√©e directement par des erreurs dans l'√©criture de ce programme.  Mais quel est ce probl√®me?  Heureusement (ou malheureusement), cela n'est pas li√© √† la corruption de votre ordinateur.  Au contraire, il affiche une situation dans laquelle vous essayez de travailler avec une m√©moire qui <em>ne vous appartient pas</em> .  J'expliquerai maintenant: </p><br><ol><li>  Cela peut √™tre une tentative de lecture / √©criture sur une partie de la m√©moire non allou√©e. </li><li>  Aller au-del√† des limites du bloc de m√©moire qui vous est fourni.  Ce probl√®me est une sorte de cas particulier de probl√®me (1), mais il est pire car le syst√®me vous dira que vous avez d√©pass√© les limites uniquement lorsque vous quittez la page affich√©e pour vous.  Autrement dit, ce probl√®me est potentiellement tr√®s difficile √† d√©tecter, car le syst√®me d'exploitation ne peut r√©pondre que si vous laissez les limites des pages virtuelles affich√©es.  Vous pouvez g√¢cher la m√©moire du processus et obtenir une erreur tr√®s √©trange de l'endroit d'o√π elle n'√©tait pas attendue du tout. </li><li>  Lib√©ration d'une m√©moire d√©j√† lib√©r√©e (cela semble √©trange) ou pas encore allou√©e </li><li>  etc. </li></ol><br><p>  En C / C ++, o√π il y a de l'arithm√©tique des pointeurs, vous rencontrerez cela une ou deux fois.  Cependant, dans Java Runtime, vous devez transpirer assez fort pour obtenir ce genre d'erreur (je ne l'ai pas essay√© moi-m√™me, mais je pense que c'est possible, sinon la vie serait trop simple). </p><br><h3 id="7-utechki-pamyati">  7. Fuites de m√©moire </h3><br><p>  Il s'agit d'un cas particulier d'un probl√®me plus g√©n√©ral qui se produit dans de nombreux langages de programmation.  La biblioth√®que C / C ++ standard permet d'acc√©der aux ressources du syst√®me d'exploitation.  Il peut s'agir de fichiers, de sockets, de m√©moire, etc.  Apr√®s utilisation, la ressource doit √™tre correctement ferm√©e et <br>  la m√©moire occup√©e par lui doit √™tre lib√©r√©e.  Et si nous parlons sp√©cifiquement de lib√©rer de la m√©moire - les fuites accumul√©es √† la suite du programme peuvent conduire √† une erreur de ¬´m√©moire insuffisante¬ª lorsque le syst√®me d'exploitation ne pourra pas satisfaire la prochaine demande d'allocation.  Souvent, le d√©veloppeur oublie simplement de lib√©rer la m√©moire utilis√©e pour une raison ou une autre. </p><br><p>  Ici, il vaut la peine d'ajouter des informations sur la fermeture et la lib√©ration correctes des ressources sur le GPU, car les premiers pilotes ne permettaient pas de reprendre le travail avec la carte vid√©o si la session pr√©c√©dente ne s'√©tait pas termin√©e correctement.  Seul le red√©marrage du syst√®me pourrait r√©soudre ce probl√®me, ce qui est tr√®s douteux - pour forcer l'utilisateur √† red√©marrer le syst√®me apr√®s avoir ex√©cut√© votre application. </p><br><h3 id="8-dangling-pointer">  8. Pointeur suspendu </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Un pointeur pendant</strong></a> est un jargon qui d√©crit une situation o√π un pointeur fait r√©f√©rence √† une valeur non valide.  Une situation similaire peut facilement se produire lors de l'utilisation de pointeurs de style C classiques dans un programme C / C ++.  Supposons que vous ayez allou√© de la m√©moire, enregistr√© l'adresse dans le pointeur p, puis lib√©r√© la m√©moire (voir l'exemple de code): </p><br><pre> <code class="plaintext hljs">//   void* p = malloc(size); // ...  -    //   free(p); //    p? // *p == ?</code> </pre> <br><p>  Le pointeur stocke une valeur, que nous pouvons interpr√©ter comme l'adresse du bloc de m√©moire.  Il se trouve que nous ne pouvons pas dire si ce bloc de m√©moire est valide ou non.  Seul un programmeur, bas√© sur certains accords, peut fonctionner avec un pointeur.  √Ä partir de C ++ 11, un certain nombre de pointeurs ¬´pointeurs intelligents¬ª suppl√©mentaires ont √©t√© introduits dans la biblioth√®que standard, ce qui permet en quelque sorte d'affaiblir le contr√¥le des ressources par le programmeur en utilisant des m√©ta-informations suppl√©mentaires en lui-m√™me (plus de d√©tails plus loin). </p><br><p>  Comme solution partielle, vous pouvez utiliser la <em>valeur sp√©ciale du</em> pointeur, qui nous signalera qu'il n'y a rien √† cette adresse.  En C, la macro NULL est utilis√©e comme valeur de cette valeur et en C ++, le mot cl√© de langage nullptr est utilis√©.  La solution est partielle, car: </p><br><ol><li>  La valeur du pointeur doit √™tre d√©finie manuellement, afin que le programmeur puisse simplement oublier de le faire. </li><li>  nullptr ou juste 0x0 est inclus dans l'ensemble des valeurs accept√©es par le pointeur, ce qui n'est pas bon lorsque l'√©tat sp√©cial d'un objet est exprim√© par son √©tat habituel.  Il s'agit d'une sorte d'h√©ritage, et par accord, le syst√®me d'exploitation ne vous allouera pas un morceau de m√©moire dont l'adresse commence par 0x0. </li></ol><br><p>  Exemple de code avec null: </p><br><pre> <code class="plaintext hljs">//  -  p free(p); p = nullptr; //   p == nullptr   ,       </code> </pre> <br><p>  Vous pouvez automatiser ce processus dans une certaine mesure: </p><br><pre> <code class="plaintext hljs">void _free(void* &amp;p) { free(p); p = nullptr; } //  -  p _free(p); //   p == nullptr,     //   </code> </pre> <br><h3 id="9-tip-pamyati">  9. Type de m√©moire </h3><br><p>  <strong>La RAM</strong> est une <strong>m√©moire</strong> ordinaire √† acc√®s al√©atoire √† usage g√©n√©ral, √† laquelle l'acc√®s via le bus central poss√®de tous les c≈ìurs de votre processeur et de vos p√©riph√©riques.  Son volume varie, mais le plus souvent nous parlons de N gigaoctets, o√π N est 1,2,4,8,16 et ainsi de suite.  Les appels malloc / free cherchent √† placer le bloc de m√©moire que vous voulez directement dans la RAM de l'ordinateur. </p><br><p>  <strong>VRAM</strong> (m√©moire vid√©o) - m√©moire vid√©o, fournie avec la carte vid√©o / l'acc√©l√©rateur vid√©o de votre PC.  En r√®gle g√©n√©rale, il est plus petit que la RAM (environ 1,2,4 Gio), mais il a une vitesse √©lev√©e.  La distribution de ce type de m√©moire est g√©r√©e par le pilote de la carte vid√©o, et le plus souvent vous n'y avez pas directement acc√®s. </p><br><p>  Il n'y a pas une telle s√©paration sur la PlayStation 4, et toute la RAM est repr√©sent√©e par un seul 8 gigaoctets sur GDDR5.  Par cons√©quent, toutes les donn√©es du processeur et de l'acc√©l√©rateur vid√©o sont √† proximit√©. </p><br><p>  Une bonne gestion des ressources dans le moteur de jeu comprend une allocation de m√©moire comp√©tente √† la fois dans la RAM principale et du c√¥t√© VRAM.  Ici, vous pouvez rencontrer une <strong>duplication</strong> lorsque les m√™mes donn√©es sont l√† et l√†, ou avec <strong>un transfert excessif de</strong> donn√©es de la RAM vers la VRAM et vice versa. </p><br><p>  <strong>Pour illustrer tous les probl√®mes √©voqu√©s</strong> : vous pouvez regarder les aspects des ordinateurs de l'appareil sur l'exemple de l'architecture PlayStation 4 (Fig.).  Voici le processeur central, 8 c≈ìurs, les caches de niveau L1 et L2, les bus de donn√©es, la RAM, l'acc√©l√©rateur graphique, etc.  Pour une description compl√®te et d√©taill√©e, voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Game Engine Architecture¬ª de</a> Jason Gregory. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c50/7ba/756/c507ba75624a3c9be702f85ddfa50e11.png"><br>  Architecture PlayStation 4 </p><br><h1 id="obschie-podhody-k-resheniyu">  Approches g√©n√©rales </h1><br><p>  Il n'y a pas de solution universelle.  Mais il existe un ensemble de points sur lesquels vous devez vous concentrer si vous envisagez d'impl√©menter manuellement l'allocation et la gestion de la m√©moire dans votre application.  Cela inclut les conteneurs et les allocateurs sp√©cialis√©s, les strat√©gies d'allocation de m√©moire, la conception de syst√®mes / jeux, les gestionnaires de ressources, etc. </p><br><h2 id="tipy-allokatorov">  Types d'allocateurs </h2><br><p>  L'utilisation d'allocateurs de m√©moire sp√©ciaux est bas√©e sur l'id√©e suivante: vous savez quelle taille, √† quels moments de travail et √† quel endroit vous aurez besoin de morceaux de m√©moire.  Par cons√©quent, vous pouvez allouer la m√©moire n√©cessaire, la structurer d'une mani√®re ou d'une autre et l'utiliser / la r√©utiliser.  C'est l'id√©e / le concept g√©n√©ral de l'utilisation d'allocateurs sp√©ciaux.  Ce qu'ils sont (bien s√ªr, pas tous) peut √™tre vu plus loin: </p><br><ol><li><p>  <strong>Allocateur lin√©aire</strong> <br>  Repr√©sente un tampon d'espace d'adressage contigu.  Au cours du travail, il vous permet d'allouer des sections de m√©moire de taille arbitraire (telles qu'elles tiennent dans un tampon).  Mais vous ne pouvez lib√©rer toute la m√©moire allou√©e qu'une seule fois.  Autrement dit, un morceau de m√©moire arbitraire ne peut pas √™tre lib√©r√© - il restera comme s'il √©tait <em>occup√©</em> jusqu'√† ce que la totalit√© du tampon soit marqu√©e comme propre.  Cette conception permet l'allocation et la lib√©ration d'O (1), ce qui donne une garantie de vitesse dans toutes les conditions. <br><img src="https://habrastorage.org/webt/eb/tp/vm/ebtpvmrs616uwpgdfpd1nujw69s.png"><br>  Cas d'utilisation typique: dans le processus de mise √† jour de l'√©tat du processus (chaque image du jeu), vous pouvez utiliser LinearAllocator pour allouer des tampons tmp pour tous les besoins techniques: traitement d'entr√©e, travail avec des cha√Ænes, analyse des commandes ConsoleManager en mode d√©bogage, etc. </p><br></li><li><p>  <strong>Allocateur de pile</strong> <br>  Modification d'un allocateur lin√©aire.  Vous permet de lib√©rer de la m√©moire dans l'ordre inverse de l'allocation, en d'autres termes, se comporte comme une pile r√©guli√®re selon le principe LIFO.  Il peut √™tre tr√®s utile pour effectuer des calculs math√©matiques charg√©s (hi√©rarchie des transformations), pour impl√©menter le travail du sous-syst√®me de script, pour tout calcul o√π la proc√©dure indiqu√©e pour lib√©rer de la m√©moire est connue √† l'avance. <br><img src="https://habrastorage.org/webt/hu/7j/fm/hu7jfm6iqhxz0uk5xwo_ayzwyfo.png"><br>  La simplicit√© de la conception fournit l'allocation de m√©moire O (1) et la vitesse de lib√©ration. </p><br></li><li><p>  <strong>Allocateur de pool</strong> <br>  Vous permet d'allouer des blocs de m√©moire de la m√™me taille.  Il peut √™tre impl√©ment√© comme un tampon d'espace d'adressage continu, divis√© en blocs d'une taille pr√©d√©termin√©e.  Ces blocs peuvent former une liste cha√Æn√©e.  Et nous savons toujours quel bloc donner dans la prochaine allocation.  Ces m√©ta-informations peuvent √™tre stock√©es dans les blocs eux-m√™mes, ce qui impose une restriction sur la taille minimale des blocs (sizeof (void *)).  En r√©alit√©, ce n'est pas critique. <br><img src="https://habrastorage.org/webt/cv/sl/qz/cvslqzmqj1nsp-gtqccoyx6hwy4.png"><br>  √âtant donn√© que tous les blocs sont de la m√™me taille, peu importe le bloc √† renvoyer, et par cons√©quent, toutes les op√©rations d'allocation / d√©sallocation peuvent √™tre effectu√©es dans O (1). </p><br></li><li><p>  <strong>Allocateur de trames</strong> <br>  Allocateur lin√©aire mais uniquement en r√©f√©rence √† la trame actuelle - vous permet de faire l'allocation de m√©moire tmp puis de tout lib√©rer automatiquement lors du changement de trame.  Il convient de le distinguer s√©par√©ment, car il s'agit d'une entit√© globale et unique dans le cadre du jeu d'ex√©cution, et donc il peut √™tre de taille tr√®s impressionnante, disons quelques dizaines de MiB, ce qui sera tr√®s utile lors du chargement des ressources et de leur traitement. </p><br></li><li><p>  <strong>Allocateur de trames doubles</strong> <br>  Il s'agit d'un allocateur de double trame, mais avec certaines fonctionnalit√©s.  Il vous permet d'allouer de la m√©moire dans l'image actuelle et de l'utiliser √† la fois dans l'image actuelle et dans l'image suivante.  Autrement dit, la m√©moire que vous avez allou√©e dans la trame N ne sera lib√©r√©e qu'apr√®s N + 1 trame.  Ceci est r√©alis√© en commutant la trame active pour la mettre en surbrillance √† la fin de chaque trame. <br><img src="https://habrastorage.org/webt/ug/cc/zh/ugcczhvv6ibzbarvb0plwhvgbuu.png"><br>  Mais ce type d'allocateur, comme le pr√©c√©dent, impose un certain nombre de restrictions sur la dur√©e de vie des objets cr√©√©s dans la m√©moire qui lui est allou√©e.  Par cons√©quent, vous devez savoir qu'√† la fin de la trame, les donn√©es deviennent tout simplement invalides et qu'un acc√®s r√©p√©t√© √† celles-ci peut provoquer de graves probl√®mes. </p><br></li><li><p>  <strong>Allocateur statique</strong> <br>  Ce type d'allocateur alloue de la m√©moire √† partir d'un tampon obtenu, par exemple, au stade du lancement du programme, ou captur√© sur la pile dans un cadre de fonction.  Par type, il peut s'agir de n'importe quel allocateur: lin√©aire, pool, stack.  Pourquoi est-il appel√© <em>statique</em> ?  La taille de la m√©moire tampon captur√©e doit √™tre connue <strong>au stade de la compilation du</strong> programme.  Cela impose une limitation importante: la quantit√© de m√©moire disponible pour cet allocateur ne peut pas √™tre modifi√©e pendant le fonctionnement.  Mais quels en sont les avantages?  Le tampon utilis√© sera automatiquement captur√© puis lib√©r√© (soit √† la fin du travail, soit √† la sortie de la fonction).  Cela ne charge pas le tas, vous √©vite la fragmentation, vous permet d'allouer rapidement la m√©moire en place. <br>  Vous pouvez regarder l'exemple de code utilisant cet allocateur, si vous avez besoin de diviser la cha√Æne en sous-cha√Ænes et de faire quelque chose avec elles: <br><img src="https://habrastorage.org/webt/3s/xk/t5/3sxkt5_00ztji1gesnh0cd1edno.png"><br>  On peut √©galement noter que l'utilisation de la m√©moire de la pile en th√©orie est beaucoup plus efficace, car  empiler la trame de la fonction actuelle avec une forte probabilit√© sera d√©j√† dans le cache du processeur. </p><br></li></ol><br><p>  Tous ces allocateurs r√©solvent en quelque sorte les probl√®mes de fragmentation, de manque de m√©moire, de vitesse de r√©ception et de lib√©ration de blocs de la taille requise, de dur√©e de vie des objets et de la m√©moire qu'ils occupent. </p><br><p>  Il convient √©galement de noter que la bonne approche de la conception d'interface vous permettra de cr√©er une sorte de <em>hi√©rarchie d'</em> allocateurs lorsque, par exemple: le pool alloue de la m√©moire √† partir de l'allocation de trames, et l'allocation de trames alloue √† son tour la m√©moire √† partir de l'allocation lin√©aire.  Une structure similaire peut √™tre poursuivie, s'adaptant √† vos t√¢ches et besoins. </p><br><p><img src="https://habrastorage.org/webt/rf/l8/4a/rfl84aakccaw2qfdw6hxlqiygos.png"></p><br><p>  Je vois une interface similaire pour cr√©er des hi√©rarchies comme suit: </p><br><pre> <code class="plaintext hljs">class IAllocator { public: virtual void* alloc(size_t size) = 0; virtual void* alloc(size_t size, size_t alignment) = 0; virtual void free (void* &amp;p) = 0; }</code> </pre> <br><p>          malloc/free ,     .  ,        ,            .           /    ,       . </p><br><h2 id="umnye-ukazateli">   </h2><br><p> Smart pointer ‚Äî        C++   ++11 (   boost,    ).   -,     ,        -  ,        .                . </p><br><p>       ?     : </p><br><ol><li>       </li><li>   (/) </li><li>    </li></ol><br><p>         : </p><br><ol><li><p> <strong>Unique pointer</strong> <br>      1    ( ). <br>   unique pointer ,          .        , ..    1   / . <br>        uniquePtr1  uniquePtr2,    uniquePtr1 , .   1  . <br><img src="https://habrastorage.org/webt/xl/qd/x2/xlqdx2thnzcg7rvvv0va70zpzl4.png"></p><br></li><li><p> <strong>Shared pointer</strong> <br>        (reference counting).       ,    ,      .    , ,      ,    . <br><img src="https://habrastorage.org/webt/jb/y6/wi/jby6wipfn5sv2ghabpuzzresgsk.png"><br>       . -,       ,      .        . -,  -                . </p><br></li><li><p> <strong>Weak pointer</strong> <br>    .       ,    .  Qu'est-ce que cela signifie?           shared pointer.   ,   shared pointer  ,     . ,     shared pointer weak pointer.  ,   (shared)    ,   weak pointer    shared pointer.    ‚Äî  weak pointer ,     ,  ,       . <br><img src="https://habrastorage.org/webt/nr/bt/bq/nrbtbqg6rukrcdgmij-v08bpim4.png"><br>   shared,   weak pointer     meta-data   .    -   ,     ..   ,  O(N) overhead  ,  N ‚Äî -  .      , .               ,        .         . </p><br></li></ol><br><p>     :         . ,  shared pointer,     ,    (      )  <em>- - -</em> .           .            meta-info   ,  ,           .  Un exemple: </p><br><pre> <code class="plaintext hljs">/*     */ /*   ,  shared pointer */ Array&lt;TSharedPtr&lt;Object&gt;&gt; objects; objects.add(newShared&lt;Object&gt;(...)); ... objects.add(newShared&lt;Object&gt;(...));</code> </pre> <br><pre> <code class="plaintext hljs">/*      (   meta-info    ) */ Array&lt;Object&gt; objects; objects.emplace(...); ... objects.emplace(...);</code> </pre> <br><p>   .            .  √Ä ce sujet plus loin. </p><br><h2 id="unique-id"> Unique id </h2><br><p>      ,    .     (id/identificator),   , ,   -.    : </p><br><ol><li> <strong> </strong> <br>     ,   id.    ,   <strong>  </strong> ,  ,          id. </li><li> <strong>  </strong> <br>      ,          (  ,     ) </li><li> <strong>    </strong> <br>    id  ,      ,        id. </li><li> <strong>    </strong> <br>                 . ,   id,     . </li></ol><br><p>     :    id,   ,      id,         . </p><br><p>  id     ,  (Vulkan, OpenGL),   (Godot, CryEngine).  EntityID   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">     CryEngine</a> . </p><br><p>   ,  id   :   .     ,     (   ),     ,      . </p><br><pre> <code class="plaintext hljs">/*    */ class ID { uint32 index; uint32 generation; }</code> </pre> <br><pre> <code class="plaintext hljs">/*  - /  */ class ObjectManager { public: ID create(...); void destroy(ID); void update(ID id, ...); private: Array&lt;uint32&gt; generations; Array&lt;Objects&gt; objects; }</code> </pre> <br><p>   ID        ,     ID .     : </p><br><pre> <code class="plaintext hljs">generation = generations[id.index]; if (generation == id.generation) then /*    */ else /*  ,     */</code> </pre> <br><p>      id      generation  1   id   ids. </p><br><h2 id="konteynery">  </h2><br><p>     C++   ,         .      std,     <strong></strong>   ,   <strong></strong>    .        : </p><br><ul><li> Linked list ‚Äî   </li><li> Array ‚Äî /  </li><li> Queue ‚Äî  </li><li> Stack ‚Äî  </li><li> Map ‚Äî   </li><li> Set ‚Äî  </li></ul><br><p>         ?             memory corruption.        / ,    ,   ,    ,     . </p><br><h1 id="obschie-idei">   </h1><br><p>           ,     ,       .  , ,    /         . </p><br><h2 id="pod-konkretnye-zadachi">    </h2><br><p>   ,      ,       .              ,   (  )   .    ,   malloc/free  ,       ,            . </p><br><p>     ?   ,     (/ ),     ,     ,   .    ,     ,    ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/554/778/95b/55477895bb7e2fcf71d44ad06ceb8ce3.jpg"><br> ryEngine Sandbox:       </p><br><p>   ,   Unreal, Unity, CryEngine  .,     ,    . ,       , ,     ‚Äî       ,                 . </p><br><h2 id="pre-allocating"> Pre-allocating </h2><br><p>        ,      /          . </p><br><p>    :   malloc/free      .     ,      "run out of memory", .        .         ,       (,   ,     .). </p><br><p>       .          .  ,         -  .           ,           malloc/free,    : ,  ,  . </p><br><h2 id="ne-nado-boyatsya-dinamicheskoy-pamyati">      </h2><br><p>            .   :     ,       , ,   ..             . </p><br><p>    :   ,      ,       ,    .  open-source ,      ,     .   ,  ,   ‚Äî     malloc/free. </p><br><h2 id="dizayn-iz-ogranicheniy">    </h2><br><p>  GDC  CD Project Red <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> ,     ,       "The Witcher: Blood and Wine"    ()        .     ,     ,    ,         ,         . <br><img src="https://habrastorage.org/getpro/habr/post_images/80b/c6c/fb0/80bc6cfb08009ba02caee322cb092110.png"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a>    Naughty Dog  ,      "Uncharted 4: A Thief's End"     ,         (,    )       . <br><img src="https://habrastorage.org/getpro/habr/post_images/7c4/2c8/469/7c42c84690c9374423bba12dea6126ff.jpg"></p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>     ,    ,     ,          .       ,         .     / ,     ,   -   ..       ,        (,    ). </p><br><h1 id="literatura-i-poleznye-ssylki">     </h1><br><ul><li>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Game Engine Architecture"</a> .           ,  , , ,   ..  ,    ,      . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Custom memory allocators</a> ‚Äî        ,     C++  .     ,         . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Smart pointers</a> ‚Äî     ,      . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Start Pre-allocating And Stop Worrying</a> ‚Äî        </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473294/">https://habr.com/ru/post/fr473294/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473284/index.html">Senior, TechLead, Architecte - quelle est la prochaine √©tape? Comment g√©rer une routine de travail et o√π aller?</a></li>
<li><a href="../fr473286/index.html">Nous √©crivons une protection contre les attaques DDoS sur XDP. Partie nucl√©aire</a></li>
<li><a href="../fr473288/index.html">Construisez votre code √† partir de z√©ro, il pompera votre niveau</a></li>
<li><a href="../fr473290/index.html">Julia. Par o√π commencer le projet? ...</a></li>
<li><a href="../fr473292/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 319 (du 21 au 27 octobre)</a></li>
<li><a href="../fr473296/index.html">D√©marrage sans argent. Exp√©rience personnelle</a></li>
<li><a href="../fr473298/index.html">Comment construire des processus et arr√™ter de se moquer d'une √©quipe</a></li>
<li><a href="../fr473300/index.html">PR √† l'√®re num√©rique, programmes de fid√©lisation modernes et marketing de festival</a></li>
<li><a href="../fr473302/index.html">Au revoir HTML, salut QML</a></li>
<li><a href="../fr473306/index.html">Concept de lunettes de r√©alit√© augment√©e. Mon casque AR parfait, ce qui est possible</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>