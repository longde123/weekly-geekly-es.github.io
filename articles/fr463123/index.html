<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåÄ üòö üåâ Biblioth√®que de g√©n√©rateur de code assembleur pour microcontr√¥leurs AVR. 3e partie üßëüèº ü§Ω üßî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üê Partie 2. Pour commencer 
 Partie 4. Programmation des p√©riph√©riques et gestion des interruptions ‚Üí 
 Biblioth√®que de g√©n√©rateur de code d'assembleu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Biblioth√®que de g√©n√©rateur de code assembleur pour microcontr√¥leurs AVR. 3e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463123/"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üê Partie 2. Pour commencer</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 4. Programmation des p√©riph√©riques et gestion des interruptions ‚Üí</a> </p><br><h2 id="biblioteka-generatora-assemblernogo-koda-dlya-mikrokontrollerov-avr">  Biblioth√®que de g√©n√©rateur de code d'assembleur pour microcontr√¥leurs AVR </h2><br><h3 id="chast-3-kosvennaya-adresaciya-i-upravlenie-potokom-ispolneniya">  Partie 3. Adressage indirect et contr√¥le de flux </h3><br><p>  Dans la partie pr√©c√©dente, nous avons insist√© de mani√®re suffisamment d√©taill√©e sur le travail avec des variables de registre √† 8 bits.  Si vous avez manqu√© le post pr√©c√©dent, je vous conseille de le lire.  Vous y trouverez un lien vers la biblioth√®que pour essayer vous-m√™me les exemples de l'article.  Pour ceux qui ont t√©l√©charg√© la biblioth√®que plus t√¥t, je recommande de t√©l√©charger la derni√®re version, car la biblioth√®que est constamment mise √† jour et certains exemples peuvent ne pas fonctionner dans l'ancienne version de la biblioth√®que. </p><a name="habracut"></a><br><p>  Malheureusement, les profondeurs de bits des variables de registre pr√©c√©demment consid√©r√©es ne sont clairement pas suffisantes pour √™tre utilis√©es comme pointeurs de m√©moire.  Par cons√©quent, avant de passer directement √† la discussion des pointeurs, nous consid√©rons une autre classe de description des donn√©es.  La plupart des commandes de l'architecture AVR Mega sont con√ßues pour fonctionner uniquement avec des op√©randes de registre, c'est-√†-dire que les deux op√©randes et le r√©sultat ont une taille de 8 bits.  Cependant, il existe un certain nombre d'op√©rations o√π deux registres RON situ√©s cons√©cutivement sont consid√©r√©s comme un seul registre 16 bits.  Il existe peu d'op√©rations de ce type et elles sont principalement ax√©es sur l'utilisation de pointeurs. </p><br><p>  Du point de vue de la syntaxe de la biblioth√®que, travailler avec une paire de registres est presque le m√™me que travailler avec une variable de registre.  Prenons un petit exemple o√π nous essayons de travailler avec une paire de registres.  Afin d'√©conomiser de l'espace ici et ci-dessous, nous ne donnerons le r√©sultat de l'ex√©cution que l√† o√π il est n√©cessaire d'expliquer certaines fonctionnalit√©s de la g√©n√©ration de code. </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dr1 = m.DREG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dr2 = m.DREG(); dr1.Load(<span class="hljs-number"><span class="hljs-number">0xAA55</span></span>); dr2.Load(<span class="hljs-number"><span class="hljs-number">0x55AA</span></span>); dr1++; dr1--; dr1 += <span class="hljs-number"><span class="hljs-number">0x100</span></span>; dr1 += dr2; dr2 *= dr1; dr2 /= dr1; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Dans cet exemple, nous avons d√©clar√© deux variables de 2 octets situ√©es dans des paires de registres √† l'aide de la commande DREG ().  Avec les commandes suivantes, nous leur avons attribu√© la valeur initiale et effectu√© une s√©rie d'op√©rations arithm√©tiques.  Comme vous pouvez le voir dans l'exemple, la syntaxe pour travailler avec une paire de registres est largement la m√™me que pour travailler avec un registre normal.  Une paire de registres peut √©galement √™tre consid√©r√©e comme une variable compos√©e de deux registres ind√©pendants.  Le registre est accessible sous la forme d'un ensemble de deux registres 8 bits via la propri√©t√© <em>High</em> pour acc√©der aux 8 bits sup√©rieurs en tant que registre 8 bits, et la propri√©t√© <em>Low</em> pour acc√©der aux 8 bits inf√©rieurs.  Le code ressemblera √† ceci </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dr1 = m.DREG(); dr1.Load(<span class="hljs-number"><span class="hljs-number">0xAA55</span></span>); dr1.Low--; dr1.High += dr1.Low; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Comme vous pouvez le voir dans l'exemple, nous pouvons travailler avec <em>High</em> et <em>Low en</em> tant que variables de registre ind√©pendantes, y compris effectuer diverses op√©rations arithm√©tiques et logiques entre elles. </p><br><p>  Maintenant que nous avons trouv√© des variables √† double longueur, nous pouvons commencer √† d√©crire comment travailler avec des variables en m√©moire.  La biblioth√®que vous permet de travailler avec des variables de 8, 16 bits et des tableaux d'octets de longueur arbitraire.  Prenons un exemple d'allocation d'espace pour des variables en RAM. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt = m.BYTE(); <span class="hljs-comment"><span class="hljs-comment">//8-    var wd = m.WORD(); //16-    var arr = m.ARRAY(16); //  16  var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Voyons ce qui s'est pass√©. </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">RESET: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">high</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPH</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">low</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPL</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DSEG</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 16 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0001</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0000</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 1</span></span></code> </pre> <br><p>  Dans la section de d√©finition des donn√©es, nous avons une allocation de m√©moire.  Notez que l'ordre d'allocation est diff√©rent de la d√©claration de variables.  Ce n'est pas un hasard.  L'allocation de m√©moire pour les variables se produit apr√®s un tri d√©croissant selon les crit√®res suivants (par ordre d√©croissant d'importance) Le multiple diviseur maximum de degr√© 2 ‚Üí La taille de la m√©moire allou√©e.  Cela signifie que si nous voulons allouer 4 tableaux de 64, 48, 40 et 16 octets, l'ordre d'allocation, quel que soit l'ordre de d√©claration, ressemblera √† ceci: </p><br><p>  Longueur 64 - Multiples diviseurs maximum de degr√© 2 = 64 <br>  Longueur 48 - Multiples diviseurs maximum de degr√© 2 = 16 <br>  Longueur 16 - Multiple diviseur maximal de degr√© 2 = 16 <br>  Longueur 40 - Multiples diviseurs maximum de degr√© 2 = 8 <br>  Ceci est fait afin de simplifier le contr√¥le des limites du tableau. <br>  et r√©duire la taille du code dans les op√©rations avec des pointeurs.  Nous ne pouvons effectuer directement aucune op√©ration avec des variables en m√©moire, donc tout ce qui nous est disponible est de lire / √©crire pour enregistrer des variables.  L'adressage direct est le moyen le plus simple de travailler avec des variables en m√©moire. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt = m.BYTE(); <span class="hljs-comment"><span class="hljs-comment">// 8-    var rr = m.REG(); //    rr.Load(0xAA); //  rr   0xAA rr.Mstore(bt); //     rr.Clear(); //  rr.Mload(bt); //    var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Dans cet exemple, nous avons d√©clar√© une variable en m√©moire et une variable de registre.  Apr√®s cela, nous avons attribu√© √† la variable la valeur 0x55 et l'avons √©crite dans la variable en m√©moire.  Puis effac√© et restaur√© en arri√®re. </p><br><p>  Pour travailler avec des √©l√©ments de tableau, nous utilisons la syntaxe suivante </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = m.ARRAY(<span class="hljs-number"><span class="hljs-number">10</span></span>); rr.MLoad(arr[<span class="hljs-number"><span class="hljs-number">5</span></span>]);</code> </pre> <br><p>  La num√©rotation des √©l√©ments du tableau commence par 0. Ainsi, dans l'exemple ci-dessus, la valeur 6 de l'√©l√©ment du tableau est √©crite dans la cellule rr. </p><br><p>  Vous pouvez maintenant passer √† l'adressage indirect.  La biblioth√®que a son propre type de donn√©es pour un pointeur vers l'espace m√©moire RAM - <em>MEMPtr</em> .  Voyons comment nous pouvons l'utiliser.  Nous modifions notre exemple pr√©c√©dent pour que le travail avec la variable en m√©moire s'effectue via le pointeur. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt1 = m.BYTE(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt2 = m.BYTE(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.MEMPTR(); <span class="hljs-comment"><span class="hljs-comment">//  ptr ptr.Load(bt1); //ptr   bt1 rr.Load(0xAA); // rr - 0xAA ptr.MStore(rr); //  bt1 0xAA rr.Load(0x55); // rr - 0x55 ptr.Load(bt2); //ptr   bt2 ptr.MStore(rr); //  bt2 0x55 ptr.Load(bt1); //ptr   bt1 ptr.MLoad(rr); //  rr  0xAA var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Il peut √™tre vu √† partir du texte que nous avons d'abord d√©clar√© le <em>pointeur ptr</em> , puis effectu√© des op√©rations d'√©criture et de lecture avec lui.  Outre la possibilit√© de modifier l'adresse de lecture / √©criture dans la commande lors de l'ex√©cution, l'utilisation du pointeur simplifie le travail avec les tableaux, combinant l'op√©ration de lecture / √©criture avec l'incr√©mentation / d√©cr√©mentation du pointeur.  Regardons un programme qui peut remplir un tableau avec une valeur sp√©cifique. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt1 = m.ARRAY(<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   4  var rr = m.REG(); var ptr = m.MEMPTR(); ptr.Load(bt1.Label); //ptr   bt1 rr.Load(0xAA); // rr - 0xAA ptr.MStoreInc(rr); //  bt1 0xAA ptr.MStoreInc(rr); //  bt1+1 0xAA ptr.MStoreInc(rr); //  bt1+2 0xAA ptr.MStoreInc(rr); //  bt1+3 0xAA rr.Clear(); rr.MLoad(bt1[2]); //  rr 3-   var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Dans cet exemple, nous avons profit√© de la possibilit√© d'incr√©menter un pointeur lors de l'√©criture dans la m√©moire. <br>  Ensuite, nous passons √† la capacit√© de la biblioth√®que √† contr√¥ler le flux de commandes.  Si c'est plus facile, comment programmer des sauts et des boucles conditionnels et inconditionnels √† l'aide de la biblioth√®que.  La fa√ßon la plus simple de g√©rer cela est d'utiliser les commandes de navigation des √©tiquettes.  Les √©tiquettes d'un programme sont d√©clar√©es de deux mani√®res diff√©rentes.  La premi√®re est qu'avec l'√©quipe <em>AVRASM.Label</em> , nous cr√©ons une √©tiquette pour une utilisation future, mais ne l'ins√©rons pas dans le code du programme.  Cette m√©thode est utilis√©e pour cr√©er des sauts en avant, c'est-√†-dire dans les cas o√π la commande de saut doit pr√©c√©der l'√©tiquette.  Pour d√©finir l'√©tiquette √† l'emplacement requis du code assembleur, vous devez ex√©cuter la commande <em>AVRASM.newLabel ([variable de l'√©tiquette pr√©c√©demment cr√©√©e])</em> .  Pour revenir en arri√®re, vous pouvez utiliser une syntaxe plus simple en d√©finissant une √©tiquette et en affectant sa valeur √† une variable avec une seule commande <em>AVRASM.newLabel ()</em> sans param√®tres. </p><br><p>  Le type de transition le plus simple est une transition inconditionnelle.  Pour l'appeler, nous utilisons la commande <em>GO ([jump_mark]]</em> .  Voyons √† quoi cela ressemble avec un exemple. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = m.REG(); <span class="hljs-comment"><span class="hljs-comment">//  var lbl1 = AVRASM.Label;//        m.GO(lbl1); r++; //    r++; AVRASM.NewLabel(lbl1);//  //  var lbl2 = AVRASM.NewLabel();//    r--; //    r--; m.GO(lbl2); var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Les transitions conditionnelles ont plus de contr√¥le sur le flux d'ex√©cution.  Leur comportement d√©pend de l'√©tat des drapeaux d'op√©ration et cela permet de contr√¥ler le flux des op√©rations en fonction du r√©sultat de leur ex√©cution.  La biblioth√®que utilise la fonction <em>IF</em> pour d√©crire un bloc de commandes qui ne doit √™tre ex√©cut√© que sous certaines conditions.  Regardons un exemple. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr2 = m.REG(); rr1.Load(<span class="hljs-number"><span class="hljs-number">0x22</span></span>); rr2.Load(<span class="hljs-number"><span class="hljs-number">0x33</span></span>); m.IF(rr1 == rr2, () =&gt; { AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" - ,  "</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  √âtant donn√© que la syntaxe de la commande <em>IF</em> n'est pas tr√®s famili√®re, examinez-la plus en d√©tail.  Le premier argument ici est la condition de transition.  Voici la m√©thode dans laquelle le bloc de code est plac√©, qui doit √™tre ex√©cut√©e si la condition est remplie.  Une variante de la fonction est la possibilit√© de d√©crire une branche alternative, c'est-√†-dire un bloc de code qui doit √™tre ex√©cut√© si la condition n'est pas remplie.  De plus, vous pouvez faire attention √† la fonction <em>AVRASM.Comment ()</em> , avec laquelle nous pouvons ajouter des commentaires √† l'assembleur de sortie. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr2 = m.REG(); rr1.Load(<span class="hljs-number"><span class="hljs-number">0x22</span></span>); rr2.Load(<span class="hljs-number"><span class="hljs-number">0x33</span></span>); m.IF(rr1 == rr2, () =&gt; { AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" - ,  "</span></span>); },()=&gt; { AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" - ,   "</span></span>); }); AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Le r√©sultat dans ce cas se pr√©sente comme suit </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">RESET: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">high</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPH</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">low</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPL</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r20</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r21</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function">,34 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function">,51 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cp</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">brne</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function"> ;---  - ,   --- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xjmp</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0004</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">: ;---  - ,    --- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0004</span></span></span><span class="hljs-function">: ;---   --- .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DSEG</span></span></span></span></code> </pre> <br><p>  Les exemples pr√©c√©dents pr√©sentent une option de branchement conditionnel dans laquelle une commande de comparaison est utilis√©e pour d√©terminer les conditions de branchement.  Dans certains cas, cela n'est pas n√©cessaire, car les conditions de transition doivent √™tre d√©termin√©es par l'√©tat des fanions apr√®s la derni√®re op√©ration effectu√©e.  La syntaxe suivante est fournie pour de tels cas. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); rr1.Load(<span class="hljs-number"><span class="hljs-number">0x22</span></span>); rr1--; m.IFEMPTY(() =&gt;AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">",    0"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Dans cet exemple, la fonction <em>IFEMPTY</em> v√©rifie l'√©tat de l'indicateur Z apr√®s un incr√©ment et ex√©cute le code du bloc conditionnel lorsqu'il atteint 0. <br>  La plus flexible en termes d'utilisation peut √™tre consid√©r√©e comme la fonction <em>LOOP</em> .  Il est destin√© √† une description pratique des cycles de programme.  Consid√©rez sa signature </p><br><pre> <code class="cs hljs">LOOP(Register iter, Action&lt;Register, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Condition, Action&lt;Register, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; body)</code> </pre> <br><p>  Le param√®tre <em>iter</em> attribue une variable de registre qui peut √™tre utilis√©e comme it√©rateur dans une boucle.  Le deuxi√®me param√®tre contient un bloc de code qui d√©crit les conditions de sortie de la boucle.  L'it√©rateur affect√© et l'√©tiquette de d√©but de la boucle √† renvoyer sont pass√©s √† ce bloc de code.  Le dernier param√®tre est utilis√© pour d√©crire le bloc de code du corps principal de la boucle.  L'exemple le plus simple d'utilisation de la fonction <em>LOOP</em> est une boucle de stub, c'est-√†-dire une boucle infinie pour passer √† la m√™me ligne.  La syntaxe dans ce cas sera la suivante </p><br><pre> <code class="cs hljs">m.LOOP(m.TempL, (r, l) =&gt; m.GO(l), (r,l) =&gt; { });</code> </pre> <br><p>  Le r√©sultat de la compilation est donn√© ci-dessous. </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">L0002: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xjmp</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span></span></code> </pre> <br><p>  Revenons √† notre exemple de remplissage d'un tableau avec une certaine valeur et changez-le pour que le remplissage soit effectu√© en boucle </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr2 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = m.ARRAY(<span class="hljs-number"><span class="hljs-number">16</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.MEMPTR(); ptr.Load(arr[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-comment"><span class="hljs-comment">//     rr2.Load(16); //    rr1.Load(0xAA); //   m.LOOP(rr2, (r, l) =&gt; //rr2     . { r--; //   m.IFNOTEMPTY(l); // ,   }, (r,l) =&gt; ptr.MStoreInc(rr1)); //   var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Dans ce cas, le code de sortie se pr√©sente comme suit </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">RESET: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">high</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPH</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">low</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPL</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r20</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r21</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YL</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LOW</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">+0) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YH</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HIGH</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">+0) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function">,16 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function">,170 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0003</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">st</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Y</span></span></span><span class="hljs-function">+,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dec</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">brne</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0003</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0004</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DSEG</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 16</span></span></code> </pre> <br><p>  Une autre fa√ßon d'organiser les transitions est de passer par des transitions adress√©es indirectement.  L'analogue le plus proche dans les langues de haut niveau pour eux est un pointeur vers une fonction.  Dans ce cas, le pointeur ne pointe pas vers l'espace RAM, mais vers le code du programme.  Comme AVR a une architecture Harvard et utilise son propre ensemble d'instructions sp√©cifiques pour acc√©der √† la m√©moire du programme, ROMPtr est utilis√© comme pointeur plut√¥t que MEMPtr d√©crit ci-dessus.  Le cas d'utilisation des transitions adress√©es indirectement peut √™tre illustr√© par l'exemple suivant. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block1 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block2 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block3 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.ROMPTR(); ptr.Load(block1); <span class="hljs-comment"><span class="hljs-comment">//     var loop = AVRASM.NewLabel(); AVRASM.Comment("   "); m.GOIndirect(ptr); //   ,     AVRASM.NewLabel(block1); AVRASM.Comment("  1"); ptr.Load(block2); m.GO(loop); AVRASM.NewLabel(block2); AVRASM.Comment("  2"); ptr.Load(block3); m.GO(loop); AVRASM.NewLabel(block3); AVRASM.Comment("  3"); ptr.Load(block1); m.GO(loop); var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Dans cet exemple, nous avons 3 blocs de commandes.  √Ä la fin de chaque bloc, le contr√¥le est retransf√©r√© √† la commande de branchement adress√©e indirectement.  √âtant donn√© qu'√† la fin du bloc de commande, nous d√©finissons le vecteur de transition sur un nouveau bloc √† chaque fois, l'ex√©cution ressemblera √† Block1 ‚Üí Block2 ‚Üí Block3 ‚Üí Block1 ... et ainsi de suite dans un cercle.  Cette commande, associ√©e aux commandes de branchement conditionnel, permet √† un langage simple et pratique de d√©crire des algorithmes assez complexes comme une machine √† √©tats. </p><br><p>  Une version plus sophistiqu√©e d'une branche adress√©e indirectement est la commande <em>SWITCH</em> .  Il n'utilise pas de pointeur sur une √©tiquette de transition pour la transition, mais un pointeur sur une variable dans la m√©moire dans laquelle l'adresse de l'√©tiquette de transition est stock√©e. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block1 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block2 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block3 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = m.ARRAY(<span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.MEMPTR(); <span class="hljs-comment"><span class="hljs-comment">//    m.Temp.Load(block1); m.Temp.Store(arr[0]); m.Temp.Load(block2); m.Temp.Store(arr[2]); m.Temp.Load(block3); m.Temp.Store(arr[4]); ptr.Load(arr[0]); //     var loop = AVRASM.NewLabel(); m.SWITCH(ptr); //   ,     AVRASM.NewLabel(block1); AVRASM.Comment("  1"); ptr.Load(arr[2]); //       m.GO(loop); AVRASM.NewLabel(block2); AVRASM.Comment("  2"); m.Temp.Load(block3); ptr.MStore(m.Temp); //       m.GO(loop); AVRASM.NewLabel(block3); AVRASM.Comment("  3"); ptr.Load(arr[0]); //       m.GO(loop);</span></span></code> </pre> <br><p>  Dans cet exemple, la s√©quence de transition sera la suivante: Block1 ‚Üí Block2 ‚Üí Block3 ‚Üí Block1 ‚Üí Block3 ‚Üí Block1 ‚Üí Block3 ‚Üí Block1 ... Nous avons pu impl√©menter un algorithme dans lequel les commandes Block2 ne sont ex√©cut√©es qu'au premier cycle. </p><br><p>  Dans la prochaine partie de l'article, nous envisagerons de travailler avec des p√©riph√©riques, de mettre en ≈ìuvre des interruptions, des routines et bien plus encore. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr463123/">https://habr.com/ru/post/fr463123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr463107/index.html">ShIoTiny: petite automatisation, Internet des objets, ou ¬´six mois avant les vacances¬ª</a></li>
<li><a href="../fr463113/index.html">Contr√¥le de version des donn√©es et des mod√®les dans la rencontre Computer Vision</a></li>
<li><a href="../fr463115/index.html">Le probl√®me des portes dans la conception des tireurs</a></li>
<li><a href="../fr463117/index.html">Pr√©chargement en PHP 7.4</a></li>
<li><a href="../fr463121/index.html">Nous mangeons l'√©l√©phant par parties. Exemple de strat√©gie de surveillance de l'int√©grit√© des applications</a></li>
<li><a href="../fr463125/index.html">OOP en images</a></li>
<li><a href="../fr463127/index.html">Surveillance UPS. Deuxi√®me partie - Automatiser l'analyse</a></li>
<li><a href="../fr463135/index.html">Dans quels pays est-il rentable d'enregistrer des soci√©t√©s informatiques en 2019?</a></li>
<li><a href="../fr463137/index.html">M√™me si vous voulez √™tre un game designer, personne ne vous apprendra comment</a></li>
<li><a href="../fr463141/index.html">Habr Weekly # 13 / Sous la menace de 1,5 million d'utilisateurs d'un service de rencontres, enqu√™te Medusa, deanon des Russes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>