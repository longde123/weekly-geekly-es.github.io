<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕸️ 💆🏽 😇 Erweiterte mehrstufige Build-Vorlagen 🛢️ 🔦 🧛🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mit der mehrstufigen Erstellungsfunktion in Dockerfiles können Sie kleine Container-Images mit einem höheren Caching-Level und weniger Schutz erstelle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erweiterte mehrstufige Build-Vorlagen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/433790/"><p><img src="https://habrastorage.org/getpro/habr/post_images/ae4/9db/b18/ae49dbb18f8454823b9e133b737cacf0.png" alt="Bild"></p><br><p>  Mit der mehrstufigen Erstellungsfunktion in Dockerfiles können Sie kleine Container-Images mit einem höheren Caching-Level und weniger Schutz erstellen.  In diesem Artikel zeige ich Ihnen einige erweiterte Vorlagen - etwas mehr als das Kopieren von Dateien zwischen Erstellen und Ausführen.  Sie ermöglichen es Ihnen, Funktionen mit maximaler Effizienz zu erreichen.  Wenn Sie jedoch ein Anfänger auf dem Gebiet der mehrstufigen Montage sind, ist es wahrscheinlich nicht verkehrt, zuerst das Benutzerhandbuch zu lesen. </p><a name="habracut"></a><br><h3 id="sovmestimost-versiy">  Versionskompatibilität </h3><br><p>  Docker wurde in Version 17.05 um mehrstufige Build-Unterstützung erweitert.  Alle Vorlagen funktionieren mit jeder nachfolgenden Version, aber einige sind dank der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Linker</a> , die die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">BuildKit-</a> Serverseite verwenden, viel effizienter.  Angenommen, BuildKit überspringt effektiv nicht verwendete Phasen und erstellt, wenn möglich, gleichzeitig Phasen (ich habe diese Beispiele separat hervorgehoben).  BuildKit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wird</a> derzeit als experimentelles Backend <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">für den</a> Build <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zu Moby hinzugefügt</a> und sollte in Docker CE v18.06 verfügbar sein.  Es kann auch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">autonom</a> oder als Teil des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">img-</a> Projekts verwendet werden. </p><br><hr><br><h4 id="nasledovanie-ot-etapa">  Bühnenvererbung </h4><br><p> Der mehrstufige Build fügt mehrere neue Syntaxkonzepte hinzu.  Zunächst können Sie der Stufe, die mit dem <code>FROM</code> Befehl <code>AS stagename</code> den Namen <code>AS stagename</code> und die <code>--from=stagename</code> im <code>COPY</code> um Dateien aus dieser Stufe zu kopieren.  Tatsächlich haben der <code>FROM</code> Befehl und das Label <code>--from</code> viel mehr gemeinsam, nicht umsonst, dass sie denselben Namen haben.  Beide verwenden dasselbe Argument, erkennen es und starten entweder ab diesem Punkt eine neue Phase oder verwenden es als Quelle zum Kopieren der Datei.  Das heißt, um die vorherige Stufe in der ursprünglichen Bildqualität für die aktuelle Stufe zu verwenden, können Sie nicht nur <code>--from=stagename</code> , sondern auch den <code>FROM stagename</code> .  Es ist nützlich, wenn Sie dieselben gemeinsamen Teile in mehreren Befehlen in der Docker-Datei verwenden: Es reduziert den allgemeinen Code und vereinfacht die Wartung, wobei die untergeordneten Schritte getrennt bleiben.  Das Wiederherstellen einer Stufe wirkt sich daher nicht auf den Assemblycache für andere aus.  Dementsprechend kann jede Stufe beim Aufrufen von <code>docker build</code> einzeln mit dem Label <code>--target</code> . </p><br><pre> <code class="plaintext hljs">FROM ubuntu AS base RUN apt-get update &amp;&amp; apt-get install git FROM base AS src1 RUN git clone … FROM base as src2 RUN git clone …</code> </pre> <br><p>  In diesem Beispiel werden die zweite und dritte Phase in BuildKit gleichzeitig erstellt. </p><br><h3 id="neposredstvennoe-ispolzovanie-obrazov">  Direkte Verwendung von Bildern </h3><br><p>  Anstatt Baugruppennamen in <code>FROM</code> Befehlen zu verwenden, die bisher nur <code>--from</code> unterstützten, können Sie Bilder direkt mit der Bezeichnung <code>--from</code> .  Es stellt sich heraus, dass Dateien direkt von diesen Bildern kopiert werden.  Beispielsweise <code>linuxkit/ca-certificatesimage</code> im folgenden Code die TLS-CA-Roots direkt in die aktuelle Phase. </p><br><pre> <code class="plaintext hljs">FROM alpine COPY --from=linuxkit/ca-certificates / /</code> </pre> <br><h3 id="psevdonim-obschego-obraza">  Allgemeiner Bildalias </h3><br><p>  Die Erstellungsphase enthält nicht unbedingt Befehle.  Es kann aus einer einzelnen <code>FROM</code> Zeile bestehen.  Wenn Sie das Bild an mehreren Stellen verwenden, vereinfacht dies das Lesen und macht es so, dass Sie nur eine Zeile ändern müssen, wenn Sie das Gesamtbild aktualisieren müssen. </p><br><pre> <code class="plaintext hljs">FROM alpine:3.6 AS alpine FROM alpine RUN … FROM alpine RUN …</code> </pre> <br><p>  In diesem Beispiel ist jeder Ort, der das alpine Bild verwendet, tatsächlich <code>alpine:3.6</code> , nicht <code>alpine:latest</code> .  Wenn die Zeit für ein Upgrade auf <code>alpine:3.7</code> , müssen Sie eine einzelne Zeile ändern, und es besteht kein Zweifel: Jetzt verwenden alle Elemente der Baugruppe eine aktualisierte Version. </p><br><p>  Dies ist umso wichtiger, wenn das Build-Argument im Alias ​​verwendet wird.  Das folgende Beispiel ähnelt dem vorherigen, ermöglicht dem Benutzer jedoch die Neudefinition aller Instanzen der Assembly, an denen das <code>--build-arg ALPINE_VERSION=value</code> beteiligt ist, indem die Option <code>--build-arg ALPINE_VERSION=value</code> .  Denken Sie daran: Alle in <code>FROM</code> Befehlen verwendeten Argumente müssen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vor der ersten Erstellungsphase ermittelt werden</a> . </p><br><pre> <code class="plaintext hljs">ARG ALPINE_VERSION=3.6 FROM alpine:${ALPINE_VERSION} AS alpine FROM alpine RUN …</code> </pre> <br><h3 id="ispolzovanie-argumentov-sborki-v-from">  Verwenden von Build-Argumenten in "- from" </h3><br><p>  Der in der Bezeichnung <code>--from</code> des <code>COPY</code> angegebene Wert darf keine Assembly-Argumente enthalten.  Das folgende Beispiel ist beispielsweise ungültig. </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine AS build-stage0 RUN … FROM alpine ARG src=stage0 COPY --from=build-${src} . .</code> </pre> <br><p>  Dies liegt daran, dass die Abhängigkeiten zwischen den Stufen vor Beginn der Montage ermittelt werden müssen.  Dann ist eine ständige Bewertung aller Teams nicht erforderlich.  Beispielsweise kann eine in einem <code>--from</code> definierte Umgebungsvariable die Auswertung des Werts <code>--from</code> .  Der Grund, warum wir die Argumente des <code>FROM</code> Befehls auswerten können, liegt darin, dass diese Argumente global definiert werden, bevor eine Phase beginnt.  Wie wir bereits herausgefunden haben, reicht es glücklicherweise aus, die Stufe des Alias ​​mit einem <code>FROM</code> Befehl zu definieren und darauf zu verweisen. </p><br><pre> <code class="plaintext hljs">ARG src=stage0 FROM alpine AS build-stage0 RUN … FROM build-${src} AS copy-src FROM alpine COPY --from=copy-src . .</code> </pre> <br><p>  Wenn Sie nun das Assembly-Argument <code>src</code> überschreiben, wechselt der erste Schritt für das letzte <code>COPY</code> Element.  Bitte beachten Sie: Wenn einige Schritte nicht mehr verwendet werden, können sie nur von BuildKit-basierten Linkern effektiv übersprungen werden. </p><br><h3 id="usloviya-ispolzuyuschie-argumenty-sborki">  Bedingungen mit Build-Argumenten </h3><br><p>  Wir wurden gebeten, der Docker-Datei Unterstützung für <code>IF/ELSE</code> Bedingungen hinzuzufügen.  Wir wissen noch nicht, ob wir etwas Ähnliches hinzufügen werden, aber in Zukunft werden wir versuchen, den Client-Support in BuildKit zu verwenden.  Um ein ähnliches Verhalten zu erzielen, können Sie in der Zwischenzeit die aktuellen mehrstufigen Konzepte verwenden (mit etwas Planung). </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine RUN … ARG BUILD_VERSION=1 IF $BUILD_VERSION==1 RUN touch version1 ELSE IF $BUILD_VERSION==2 RUN touch version2 DONE RUN …</code> </pre> <br><p>  Das vorherige Beispiel zeigt Pseudocode zum Aufzeichnen von Bedingungen unter Verwendung von <code>IF/ELSE</code> .  Um ein ähnliches Verhalten mit den aktuellen mehrstufigen Builds zu erzielen, müssen Sie möglicherweise verschiedene Verzweigungsbedingungen als separate Schritte definieren und ein Argument verwenden, um den richtigen Abhängigkeitspfad auszuwählen. </p><br><pre> <code class="plaintext hljs">ARG BUILD_VERSION=1 FROM alpine AS base RUN … FROM base AS branch-version-1 RUN touch version1 FROM base AS branch-version-2 RUN touch version2 FROM branch-version-${BUILD_VERSION} AS after-condition FROM after-condition RUN …</code> </pre> <br><p>  Der letzte Schritt in der Docker-Datei basiert auf dem Schritt <code>after-condition</code> , bei dem es sich um den <code>BUILD_VERSION</code> (der anhand des Build- <code>BUILD_VERSION</code> erkannt wird).  Abhängig vom Wert von <code>BUILD_VERSION</code> wird diese oder jene Stufe des Mittelteils ausgewählt. </p><br><p>  Bitte beachten Sie: Nur BuildKit-basierte Linker können nicht verwendete Zweige überspringen.  In den vorherigen Versionen der Linker wurden alle Phasen erstellt, aber bevor das endgültige Image erstellt wurde, wurden ihre Ergebnisse verworfen. </p><br><h3 id="pomoschnik-po-razrabotketestirovaniyu-dlya-minimalnogo-proizvodstvennogo-etapa">  Entwicklungs- / Testassistent für die Mindestproduktionsphase </h3><br><p>  Lassen Sie uns abschließend ein Beispiel für das Kombinieren früherer Vorlagen betrachten, um zu demonstrieren, wie eine Docker-Datei erstellt wird, die ein minimales Produktionsabbild erstellt und dann deren Inhalt zum Testen und Erstellen eines Entwicklungsabbilds verwenden kann.  Beginnen wir mit dem grundlegenden Dockerfile-Beispiel: </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 … FROM golang:alpine AS stage1 … FROM scratch COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin</code> </pre> <br><p>  Wenn ein minimales Produktionsabbild erstellt wird, ist dies eine recht häufige Option.  Was aber, wenn Sie im Endstadium auch ein alternatives Entwickler-Image benötigen oder Tests mit diesen Binärdateien ausführen müssen?  Das erste, was mir in den Sinn kommt, ist einfach, ähnliche Binärdateien in den Phasen des Testens und der Entwicklung zu kopieren.  Das Problem ist folgendes: Es gibt keine Garantie dafür, dass Sie alle Produktions-Binärdateien in derselben Kombination testen.  In der letzten Phase kann sich etwas ändern, aber Sie werden vergessen, ähnliche Änderungen in anderen Phasen vorzunehmen oder einen Fehler beim Kopieren von Binärdateien zu machen.  Am Ende testen wir nicht eine separate Binärdatei, sondern das endgültige Bild. </p><br><p>  Eine Alternative besteht darin, die Entwicklungs- und Testphase nach der Produktionsphase zu bestimmen und den gesamten Inhalt der Produktionsphase zu kopieren.  Verwenden Sie dann einen <code>FROM</code> Befehl für den Produktionsschritt, um den Standardproduktionsschritt erneut zum letzten Schritt zu machen. </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 … FROM scratch AS release COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin FROM golang:alpine AS dev-env COPY --from=release / / ENTRYPOINT ["ash"] FROM golang:alpine AS test COPY --from=release / / RUN go test … FROM release</code> </pre> <br><p>  Standardmäßig erstellt diese Docker-Datei weiterhin das minimale Standard-Image, während beispielsweise eine Assembly mit der Option <code>--target=dev-env</code> ein Image mit einer Shell erstellt, die alle Binärdateien der endgültigen Version enthält. </p><br><hr><br><p>  Ich hoffe, dies war hilfreich und schlug vor, wie effizientere mehrstufige Docker-Dateien erstellt werden können.  Wenn Sie an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DockerCon2018 teilnehmen</a> und mehr über mehrstufige Builds, Dockerfiles, BuildKit oder verwandte Themen erfahren möchten, melden Sie sich für den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hallway-Track-</a> Linker an oder folgen Sie den internen Meetings der Docker-Plattform zu <a href="">Contribute and Collaborate-</a> oder <a href="">Black Belt-</a> Tracks. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de433790/">https://habr.com/ru/post/de433790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de433776/index.html">MongoDB Go Treiber Tutorial</a></li>
<li><a href="../de433780/index.html">Übergang vom UI-Kit zum Design-System in QIWI</a></li>
<li><a href="../de433782/index.html">Ein praktisches Beispiel für die Erstellung einer eigenen View-Komponente</a></li>
<li><a href="../de433786/index.html">Fintech Digest: Kryptowährung ist Eigentum, eine Rekordzahl von Kreditkarten wurde in der Russischen Föderation ausgestellt</a></li>
<li><a href="../de433788/index.html">Secure Deal und neue freiberufliche Bewertungen</a></li>
<li><a href="../de433792/index.html">Shell-Skripte in Ansible</a></li>
<li><a href="../de433796/index.html">Wie Homo Sapiens die Welt eroberte. Kommunikations- und Verhandlungsfähigkeiten</a></li>
<li><a href="../de433798/index.html">HomeKit und ioBroker Lass uns zu Hause Freunde finden</a></li>
<li><a href="../de433800/index.html">Verwenden der UDB-PSoC-Controller von Cypress, um Unterbrechungen in einem 3D-Drucker zu reduzieren</a></li>
<li><a href="../de433802/index.html">Wie und warum wir den Big Data Track beim Urban Tech Challenge Hackathon gewonnen haben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>