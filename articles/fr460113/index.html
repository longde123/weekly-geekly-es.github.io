<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕵🏾 👩🏿‍🚀 📥 Quelques histoires de la vie de JSOC CERT, ou Unbanal forensics 🐉 🤪 👩🏻‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chez JSOC CERT, nous enquêtons sur des incidents. En général, les 170 personnes du JSOC enquêtent, mais les cas les plus difficiles sur le plan techno...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Quelques histoires de la vie de JSOC CERT, ou Unbanal forensics</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/460113/"><img src="https://habrastorage.org/webt/fw/po/fk/fwpofkq5njstadcz-dktv-oeokq.jpeg"><br><br>  Chez JSOC CERT, nous enquêtons sur des incidents.  En général, les 170 personnes du JSOC enquêtent, mais les cas les plus difficiles sur le plan technologique relèvent des experts du CERT.  Comment, par exemple, détecter les traces d'un malware si un attaquant nettoyait?  Comment trouver un «assistant» qui a supprimé des documents commerciaux importants d'un serveur de fichiers sur lequel la journalisation n'est pas correctement configurée?  Eh bien, pour le dessert: comment un attaquant peut-il obtenir des mots de passe de dizaines de comptes de domaine non liés sans pénétrer le réseau?  Détails, comme toujours, sous la coupe. <br><a name="habracut"></a><br><h3>  En semaine JSOC CERT </h3><br>  Souvent, nous devons évaluer le compromis réel du réseau client, pour cela nous effectuons: <br><br><ul><li>  analyse rétrospective des disques durs et des images mémoires, </li><li>  reverse engineering de logiciels malveillants </li><li>  si nécessaire, déploiement d'urgence de la surveillance et de l'analyse des hôtes pour des indicateurs de compromis et des traces de piratage. </li></ul><br>  Pendant notre temps libre, nous rédigeons des résumés détaillés, des techniques et des playbooks - essentiellement des instructions qui aident à mettre à l'échelle des enquêtes même complexes, comme  vous pouvez agir sur eux semi-automatiquement. <br><br>  Parfois, lors de la réponse à l'incident - en plein milieu de l'extinction d'un «incendie» - vous devez également agir comme un «service de soutien psychologique».  Une fois, nous avons été invités à aider à lutter contre l’infection du sous-réseau d’une grande organisation.  Le réseau était entretenu par deux sous-traitants qui, dans cette situation, <s>se sont jetés de façon</s> désintéressée <s>sur un ventilateur et se</s> sont engagés dans autre chose l'un <s>contre l'autre</s> , mais sans rechercher un ver malveillant.  Afin de réduire le degré d'hystérie, j'ai dû asseoir tout le monde à la table <s>pour obtenir une serviette et une bouteille de bourbon</s> et expliquer clairement que ce n'est pas le moment de rechercher les coupables.  Ils ont déterminé la procédure de distribution, lancé un audit supplémentaire et commencé à nettoyer systématiquement et ensemble l'infection. <br><br>  Au cours de l'enquête, nous devons souvent choisir des images de disque et de mémoire pour y trouver des logiciels malveillants actifs.  Pour rendre le processus prévisible et objectif, nous avons formalisé et automatisé plusieurs méthodes d'analyse rétrospective des disques, et avons pris la méthode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SANS</a> déjà classique comme base - dans la version originale, elle est assez élevée, mais si elle est utilisée correctement, elle permet la détection d'une infection active avec une très grande précision. <br><br><img src="https://habrastorage.org/webt/5f/vc/fv/5fvcfvwxumpiwrynuvlo1s48f2a.jpeg"><br><br>  Il est clair que pour effectuer des vérifications générales, il faut du temps et une connaissance approfondie des fonctionnalités des divers composants des systèmes d'exploitation (et un grand nombre de logiciels spécialisés sont nécessaires). <br><br>  <b>Comment simplifier la vérification d'une infection active sur un disque?</b>  Nous partageons le hack de vie - il peut être vérifié dynamiquement (comme dans le bac à sable), pour cela: <br><br><ul><li>  copiez le disque dur de l'hôte suspect peu à peu; </li><li>  convertir l'image dd résultante au format VMDK à l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet</a> utilitaire; </li><li>  exécutez l'image VMDK dans Virtual Box / VMware; </li><li>  et analyser comme un système vivant, en se concentrant sur le trafic. </li></ul><br>  <b><i>Mais il y aura toujours des incidents pour lesquels des instructions détaillées ne sont pas écrites et les techniques ne sont pas automatisées.</i></b> <br><br><h3>  Cas 1. Le comptable n'a rien à voir avec cela, ou comment nous avons recherché des logiciels malveillants </h3><br>  Le client nous a demandé de vérifier l'ordinateur du comptable pour détecter les logiciels malveillants: quelqu'un a effectué plusieurs ordres de paiement à une adresse inconnue.  Le comptable a affirmé qu'il n'était pas impliqué dans cela et que l'ordinateur s'était comporté étrangement auparavant: la souris se déplaçait parfois littéralement autour de l'écran lui-même - en fait, on nous a demandé de vérifier ces indications.  Le hic, c'est que le cheval de Troie visant 1C a fait ses sales actes et s'est effacé, et près d'un mois s'est écoulé après l'infection - pendant ce temps, l'enikeyschik diligent a mis un tas de logiciels, frottant l'espace disque non alloué et minimisant ainsi les chances de succès de l'enquête. <br><br>  Dans de tels cas, seul un analyste expérimenté et méticuleux et une base de données Threat Intelligence étendue et mise à jour automatiquement peuvent vous aider.  Ainsi, lors de l'analyse du dossier de démarrage, l'attention a été attirée par une balise suspecte indiquant un utilitaire de mise à jour prétendument anti-virus: <br><br><img src="https://habrastorage.org/webt/au/ud/av/auudav_v3jtb0vqdga1r0nlca38.png"><br><br>  Malheureusement, la carcasse du cheval de Troie à partir du disque n'a pas pu être restaurée, mais les faits de lancement de l'utilitaire d'administration à distance à partir du même dossier «étalé» dans le cache <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Superfetch</a> : <br><br><img src="https://habrastorage.org/webt/a_/6s/x4/a_6sx4vlbqcgc2n51htfy_hracq.png"><br><br>  En les comparant avec le moment de l'incident, nous avons prouvé que ce n'était pas le comptable qui était coupable d'avoir volé l'argent, mais un attaquant externe. <br><br><h3>  Cas 2. Qui a supprimé mes fichiers? </h3><br>  La plupart de nos enquêtes et réponses aux incidents sont en quelque sorte liées à la détection de logiciels malveillants, aux attaques ciblées utilisant des utilitaires multi-modules et à des histoires similaires où il y a un attaquant externe.  Cependant, il y a parfois des enquêtes beaucoup plus banales, mais non moins intéressantes. <br><br>  Le client possédait l'ancien serveur de fichiers le plus ordinaire, dont les dossiers publics étaient accessibles à plusieurs services.  Sur le serveur, il y avait beaucoup de documents commerciaux très importants que quelqu'un avait pris et supprimés.  Nous l'avons réalisé tard - après la surcharge de la sauvegarde.  Ils ont commencé à rechercher les coupables. <br><br>  Si vous avez déjà essayé de google pour déterminer quel utilisateur a supprimé le fichier, vous avez probablement rencontré des conseils qui viennent tous dans les journaux Windows, si vous les configurez correctement à l'avance (en passant, nous avons déjà donné <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">quelques conseils</a> sur la façon de configurer les journaux): <br><br><img src="https://habrastorage.org/webt/xt/jl/yv/xtjlyvwma5smm-3v3wuoxcm1kkc.png"><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>Source</i></a> <br><br>  Mais en réalité, peu de gens effectuent des audits de système de fichiers, ringard car il y a beaucoup d'opérations sur les fichiers et les journaux seront rapidement effilochés, et un serveur séparé est nécessaire pour stocker les journaux ... <br><br>  Nous avons décidé de diviser la tâche en deux: premièrement, déterminez QUAND les fichiers ont été supprimés;  deuxièmement, - l'OMS se connectait au serveur au moment de la suppression.  Si vous avez une idée des fonctionnalités de NTFS, vous savez que dans la plupart des implémentations de ce système de fichiers, lorsque vous supprimez un fichier, l'espace qu'il occupait est marqué comme libre et ses horodatages ne changent pas.  Par conséquent, à première vue, le temps de suppression ne peut pas être défini. <br><br>  Cependant, le système de fichiers contient non seulement des fichiers, mais également des dossiers.  De plus, les dossiers ont un attribut spécial $ INDEX_ROOT, qui décrit le contenu du dossier comme une arborescence B.  Naturellement, la suppression d'un fichier modifie l'attribut $ INDEX_ROOT du dossier et modifie ainsi ses horodatages, en particulier, dans la structure de $ STD_INFO.  Ainsi, il est possible de déterminer le temps approximatif de suppression d'un grand nombre de fichiers et dossiers par anomalie dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MFT (table de fichiers principale)</a> : <br><br><img src="https://habrastorage.org/webt/rr/op/uy/rropuy-nl7np57uum_rxa2zrgxw.png"><br><br>  Après avoir découvert quand les fichiers ont été supprimés, vous pouvez essayer de découvrir qui travaillait dans le nord à ce moment-là afin de restreindre le cercle des suspects.  Les méthodes suivantes me viennent à l'esprit: <br><br><ul><li>  Par les journaux du serveur lui-même - par les événements avec EventID 4624/4625, il est visible lorsque l'utilisateur s'est connecté et déconnecté; </li><li>  par les journaux du contrôleur de domaine - EventID 4768 vous permet de déterminer qu'un utilisateur spécifique a demandé l'accès au serveur; </li><li>  par trafic - journaux netflow / routeur interne - vous pouvez déterminer qui a activement communiqué sur le réseau avec ce serveur via smb. </li></ul><br>  Dans notre cas, ces données n'étaient plus là: trop de temps s'était écoulé, les journaux étaient tournés.  Dans ce cas, il existe une autre méthode peu fiable, mais toujours une méthode, ou plutôt la clé de registre - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://web.archive.org/web/20180427090821/">Shellbags</a> .  Il stocke des informations, notamment sur le type de dossier lors de la dernière visite de l'utilisateur: tableau, liste, grandes icônes, petites icônes, contenu, etc.  Et la même clé contient des horodatages, qui peuvent être interprétés avec une grande confiance comme l'heure de la dernière visite dans le dossier. <br><br>  Une méthode a été trouvée, il ne restait plus qu'à collecter les registres des hôtes nécessaires et à les analyser.  Pour ce faire, vous avez besoin de: <br><br><ul><li>  déterminer par groupe de domaine qui avait accès au dossier (dans notre cas, il y avait environ 300 utilisateurs); </li><li>  collecter les registres de tous les hôtes sur lesquels ces utilisateurs ont travaillé (vous ne pouvez pas le faire, vous avez besoin d'un utilitaire spécial pour travailler directement avec le lecteur, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/jschicht/RawCopy</a> ); </li><li>  «Alimentez» tous les registres dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Autopsy</a> et utilisez le plugin Shellbags; </li><li>  Profit! </li></ul><br><img src="https://habrastorage.org/webt/aq/cb/wj/aqcbwj76a6htvj4qj4cnyddngiw.png"><br><br>  Plus précisément, dans cet incident, le temps de suppression des fichiers a coïncidé avec le moment où un utilisateur a visité la racine du dossier supprimé, ce qui nous a permis de réduire le cercle des suspects de 300 à 1. <br><br>  Que s'est-il passé ensuite avec cet employé - l'histoire est silencieuse.  Nous savons seulement que la jeune fille a avoué l'avoir fait par accident et continue de travailler dans l'entreprise. <br><br><h3>  Cas 3. Maître des mots de passe: «voler» en quelques secondes (et encore plus rapidement) </h3><br>  Un attaquant est entré dans le réseau d'un client qui nous a demandé de l'aide via un VPN et a été immédiatement détecté.  Ce qui n'est pas surprenant, car juste après être entré, il a commencé à scanner le sous-réseau avec un scanner de vulnérabilité - le chanipot cligna des yeux comme un arbre de Noël. <br><br>  Une fois le compte verrouillé, le personnel de sécurité du client a commencé à analyser les journaux VPN et a vu que l'attaquant avait utilisé plus de 20 comptes de domaine différents pour la pénétration (avec la plupart, il s'est connecté avec succès, mais pour certains, l'authentification a échoué).  Et la question logique s'est posée: comment a-t-il trouvé les mots de passe de ces comptes?  Nos gars de JSOC CERT ont été invités à chercher la réponse. <br><br>  Dans l'un des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">articles précédents,</a> nous avons déjà dit que dans les enquêtes, des hypothèses devraient être formées et vérifiées à mesure que leur probabilité diminue.  Nous avons donc fait cette fois-ci, en commençant à décrire des vecteurs de vol de compte typiques: <br><br><ul><li>  fuite de données de service externe </li><li>  Bruteforce </li><li>  Mimikatz ou similaire </li><li>  Enregistreur de frappe </li><li>  Phishing </li><li>  Récolte de hachage NTLM (par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/CylanceSPEAR/SMBTrap</a> ) ou des attaques de réseau similaires. </li></ul><br>  Nous avons vérifié un tas de versions, mais nulle part il n'y avait même un soupçon d'attaque.  Non pas que l'enquête était dans une impasse, mais la voix intérieure et le bon sens suggéraient que quelque chose n'allait pas - vous devez prendre du recul et regarder la photo plus large. <br><br>  En effet, à première vue, tous ces comptes ne sont en aucun cas liés.  Leurs propriétaires sont issus de départements différents et géographiquement séparés.  Ils utilisent généralement un ensemble de services d'entreprise qui ne se chevauchent pas.  Même le niveau de culture informatique est différent.  Oui, un pas en arrière ne suffisait pas - un autre était nécessaire. <br><br>  À ce moment, nous avons réussi à collecter un grand nombre de journaux de différents systèmes de l'entreprise et à identifier les traces laissées par l'attaquant.  Ils ont commencé à analyser où il est apparu (je me souviens: il a activement analysé le réseau interne de l'entreprise).  Nous avons remarqué que dans le contexte d'un bruit de réseau uniformément distribué provenant d'exploits en vol, il y a un nombre anormalement élevé de demandes au service de récupération de mot de passe.  Un service accessible depuis Internet.  Hmm ... <br><br><img src="https://habrastorage.org/webt/nx/b1/xk/nxb1xks2lrp7ff6p9edajqkp8fq.png"><br><br>  Si vous surveillez des événements de sécurité, vous savez probablement qu'analyser les tentatives d'attaque d'un serveur accessible en externe n'a souvent aucun sens en raison du bruit Internet: il est généralement difficile de distinguer les attaques vraiment graves de nombreuses tentatives de script kiddie.  Mais pas toujours. <br><br><img src="https://habrastorage.org/webt/dj/mm/or/djmmoreaqbaebd0ecccqifgnvl4.png"><br><br><img src="https://habrastorage.org/webt/sm/eq/sn/smeqsnqlx6yodg5hytj-wr2vmts.png"><br><br>  Après avoir passé un peu de temps sur les journaux du service Web, nous avons pu distinguer les attaques suivantes contre le service: <br><br><ul><li>  Numériser avec Acunetix </li><li>  Analyse SQLmap </li><li>  un grand nombre de demandes sur une seule page. </li></ul><br>  La troisième attaque, à première vue, est similaire aux connexions utilisateur brutales.  Mais ce n'est pas le cas, car le service en est protégé, du moins par le fait que les mots de passe sont stockés sous forme hachée avec du sel - ou non?  Il fallait le vérifier rapidement. <br><br>  L'image ci-dessous montre un schéma typique du service de réinitialisation de mot de passe: <br><br><img src="https://habrastorage.org/webt/ng/ja/pu/ngjapuquafi2dcvswqwk1knp3xi.jpeg"><br><br>  Il est intéressant de noter que les mots de passe ne sont pas toujours stockés sous une forme sécurisée - il y a un moment où ils sont dans le domaine public - immédiatement après l'ouverture de l'application et avant son exécution!  Un grand nombre de requêtes sur une page se sont avérées non pas de force brute et non de scan, mais de requêtes à haute fréquence avec injection SQL, dont le but était d'extraire des mots de passe au moment de leur modification. <br><br>  Ainsi, après avoir modélisé l'attaque sur le service, comparé les informations des journaux du serveur Web, des journaux de changement de mot de passe et de plusieurs périphériques réseau, nous avons toujours trouvé le point de pénétration de l'attaquant dans l'entreprise. <br><br>  Alors, collègues, plongez dans les données brutes et que la force soit avec vous! <br><br><img src="https://habrastorage.org/webt/jv/vp/zn/jvvpznkwwdnlfljvwthatwb0ee0.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460113/">https://habr.com/ru/post/fr460113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460099/index.html">Application de l'apprentissage automatique aux réseaux de neurones avec une architecture de transformateur</a></li>
<li><a href="../fr460101/index.html">Fonctionnement XSS basé sur les cookies | Histoire de Bug Bounty à 2300 $</a></li>
<li><a href="../fr460107/index.html">ISPsystem, pardonne et au revoir! Pourquoi et comment nous avons écrit notre panneau de contrôle du serveur</a></li>
<li><a href="../fr460109/index.html">Angulaire: lorsque vous avez besoin de voir l'application, mais que le backend n'est pas encore prêt</a></li>
<li><a href="../fr460111/index.html">Version mise à jour de SAP Business One 9.3: ce qui a changé</a></li>
<li><a href="../fr460115/index.html">Dix ans de programmation à Erlang</a></li>
<li><a href="../fr460117/index.html">Les plus gros clients en Russie sont-ils un gros jackpot ou un mal de tête? Expérience AGIMA</a></li>
<li><a href="../fr460119/index.html">Erreurs que l'analyse de code statique ne trouve pas car il n'est pas utilisé</a></li>
<li><a href="../fr460121/index.html">Erreurs que l'analyse de code statique ne trouve pas car il n'est pas utilisé</a></li>
<li><a href="../fr460123/index.html">Un pipeline informatique déclaratif au-dessus des acteurs? Pourquoi pas?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>