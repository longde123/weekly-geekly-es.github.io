<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèæ ‚úÖ üßû Buildroot: creaci√≥n de firmware multiplataforma con zabbix-server üëêüèø üõ¨ üí°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Historial de tareas 


 Las peque√±as empresas, por un lado, necesitan un monitoreo de alta calidad de su infraestructura (especialmente a la luz de la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Buildroot: creaci√≥n de firmware multiplataforma con zabbix-server</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477008/"><p><img src="https://habrastorage.org/webt/zw/xx/fo/zwxxfo_u8w_l057x6clcqrn9h4k.png"></p><br><h2 id="istoriya-zadachi">  Historial de tareas </h2><br><p>  Las peque√±as empresas, por un lado, necesitan un monitoreo de alta calidad de su infraestructura (especialmente a la luz de la virtualizaci√≥n generalizada), por otro lado, es financieramente dif√≠cil para ellos comprar nuevos equipos.  Adem√°s, a menudo hay problemas con el servidor / hardware: a menudo hay 1-3 servidores en torre junto a las estaciones de trabajo de los usuarios o en un peque√±o nicho / armario. </p><br><p> Es m√°s f√°cil usar un ensamblaje listo para usar (distribuci√≥n), que es suficiente para cargarlo en una tarjeta microSD e insertarlo en una computadora com√∫n de una sola placa (beaglebone, raspberry pi y orange pi, familias de placas asus tinker).  Adem√°s, dicho equipo es econ√≥mico y se puede instalar en cualquier lugar. </p><a name="habracut"></a><br><h2 id="postanovka-zadachi">  Declaraci√≥n del problema. </h2><br><p>  En muchos sentidos, el proyecto se desarroll√≥ como una especie de trabajo de laboratorio con la posibilidad de aplicar los resultados. </p><br><p>  Se eligi√≥ a Zabbix como sistema de monitoreo, ya que es un sistema potente, gratuito y bien documentado. </p><br><p>  La pregunta surgi√≥ bruscamente con la plataforma de hardware. Poner una m√°quina separada bajo supervisi√≥n tampoco es una buena soluci√≥n: o es costoso comprar un nuevo equipo o buscar uno viejo + en peque√±as empresas, hay problemas frecuentes con el servidor / hardware. </p><br><p>  El uso del sistema de construcci√≥n buildroot le permite crear soluciones especializadas que pueden ser operadas por personal con un conocimiento m√≠nimo de la familia de sistemas operativos Linux  Este sistema es amigable para principiantes, pero al mismo tiempo brinda amplias oportunidades de personalizaci√≥n en manos de un desarrollador experimentado.  Es perfecto para resolver la tarea de monitoreo no costoso, pero con todas las funciones de la infraestructura de TI, que es m√≠nimamente exigente en la capacitaci√≥n de su personal operativo. </p><br><h2 id="shagi-resheniya">  Pasos de la soluci√≥n </h2><br><p>  Se decidi√≥ inicialmente crear firmware para x86_64 para ejecutar en qemu, ya que esta es una soluci√≥n conveniente y r√°pida para la depuraci√≥n.  Luego conecte a un brazo de computadora de una sola placa (me gust√≥ la placa asus tinker). </p><br><p>  El buildroot fue elegido como el sistema de construcci√≥n.  Inicialmente, carec√≠a del paquete zabbix, as√≠ que tuve que portarlo. Hubo problemas con la configuraci√≥n regional rusa que se resolvieron aplicando los parches apropiados (nota: en las versiones m√°s nuevas de buildroot, estos parches ya no son necesarios). </p><br><p>  La portaci√≥n del paquete zabbix se describir√° en un art√≠culo separado. </p><br><p>  Como todo deber√≠a funcionar como firmware (imagen del sistema sin cambios + archivos de configuraci√≥n / base de datos recuperables), era necesario escribir los objetivos, servicios y temporizadores del sistema (objetivo, servicio, temporizador). </p><br><p>  Se decidi√≥ dividir los medios en 2 secciones: una secci√≥n con archivos de sistema y una secci√≥n con configuraciones mutables y archivos de base de datos zabbix. </p><br><p>  Result√≥ ser un poco m√°s dif√≠cil de resolver los problemas asociados con la base de datos.  No quer√≠a colocarlo directamente en los medios.  Al mismo tiempo, el tama√±o de la base puede alcanzar un tama√±o que excede el tama√±o de un posible ramdisk.  Por lo tanto, se eligi√≥ una soluci√≥n de compromiso: la base de datos se encuentra en la segunda secci√≥n de la tarjeta SD (las tarjetas SLC modernas tienen hasta 30,000 ciclos de escritura), pero hay una configuraci√≥n que le permite usar medios externos (por ejemplo, usb-hdd). </p><br><p>  El monitoreo de temperatura se implement√≥ a trav√©s del dispositivo RODOS-5.  Por supuesto, puede usar el dallas 1820 directamente, pero fue m√°s r√°pido y f√°cil conectar un USB. </p><br><p>  Grub2 fue elegido como el gestor de arranque para x86_64.  Me llev√≥ escribir una configuraci√≥n m√≠nima para ejecutar. </p><br><p>  Despu√©s de la depuraci√≥n en qemu, se realiz√≥ la transferencia a la placa asus tinker.  En la estructura de mi superposici√≥n, inicialmente se dise√±aron plataformas cruzadas: la selecci√≥n de configuraciones espec√≠ficas para cada placa (defconfigboards, bootloader, generaci√≥n de im√°genes con una partici√≥n del sistema) y la m√°xima uniformidad en el ajuste del sistema de archivos / creaci√≥n de una imagen con datos.  Debido a tal preparaci√≥n, la transferencia fue r√°pida. </p><br><p>  Se recomienda encarecidamente que lea los art√≠culos introductorios: <br>  <a href="https://habr.com/ru/post/448638/">https://habr.com/en/post/448638/</a> <br>  <a href="https://habr.com/ru/post/449348/">https://habr.com/en/post/449348/</a> </p><br><h2 id="kak-sobrat">  C√≥mo montar </h2><br><p>  <a href="https://github.com/skif-web/monitor">El proyecto se almacena en github</a> <br>  Despu√©s de clonar el repositorio, se obtiene la siguiente estructura de archivos: </p><br><pre><code class="bash hljs">[alexey@comp monitor]$ ls -1 buildroot-2019.05.tar.gz overlay README.md run_me.sh</code> </pre> <br><p>  buildroot-2019.05.tar.gz - archivo de buildroot limpio <br>  superposici√≥n es mi directorio con √°rbol externo.  Contiene todo lo que necesita para construir firmware usando buildroot <br>  README.md - descripci√≥n del proyecto y orientaci√≥n en ingl√©s. <br>  run_me.sh es un script que prepara el sistema de compilaci√≥n.  Expande la ra√≠z de compilaci√≥n del archivo, le agrega superposici√≥n (a trav√©s del mecanismo de √°rbol externo) y le permite seleccionar la placa de destino para el ensamblaje </p><br><pre> <code class="bash hljs">[0] my_asus_tinker_defconfig [1] my_beaglebone_defconfig [2] x86_64_defconfig Select defconfig, press A <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> abort. Default [0]</code> </pre> <br><p>  Despu√©s de eso, solo vaya al directorio buildroot-2019.05 y ejecute el comando make. <br>  Despu√©s de completar el ensamblaje, todos los resultados del ensamblaje estar√°n en el directorio de salida / im√°genes: </p><br><pre> <code class="bash hljs">[alexey@comp buildroot-2019.05]$ ls -1 output/images/ boot.img boot.vfat bzImage data data.img external.img external.qcow2 grub-eltorito.img grub.img intel-ucode monitor-0.9-beta.tar.gz qemu.qcow2 rootfs.cpio sdcard.img sys update</code> </pre> <br><p>  Archivos necesarios: </p><br><ul><li>  sdcard.img: la imagen del medio para escribir en la tarjeta SD (a trav√©s de dd o rufus bajo wibdows). </li><li>  qemu.qcow2: imagen de medios para ejecutar en qemu. </li><li>  external.qcow2: imagen de medios externos para la base de datos </li><li>  monitor-0.9-beta.tar.gz: archivo para actualizar a trav√©s de la interfaz web </li></ul><br><h3 id="generaciya-rukovodstv">  Generaci√≥n manual </h3><br><p>  No vale la pena escribir las mismas instrucciones varias veces.  Y es m√°s l√≥gico escribir una vez en Markdown, y luego convertirlo a PDF para descargar y html para la interfaz web.  Esto es posible gracias al paquete pandoc. </p><br><p>  Al mismo tiempo, debe generar todos estos archivos antes de ensamblar la imagen del sistema, esos scripts posteriores a la compilaci√≥n ya son in√∫tiles.  Por lo tanto, la generaci√≥n se realiza en forma de paquete de manuales.  Puede verlo en superposici√≥n / paquete / manuales. </p><br><p>  El archivo manuals.mk (que hace todo el trabajo) </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">################################################################################ # # manuals # ################################################################################ MANUALS_VERSION:= 1.0.0 MANUALS_SITE:= ${BR2_EXTERNAL_monitorOverlay_PATH}/package/manuals MANUALS_SITE_METHOD:=local define MANUALS_BUILD_CMDS pandoc -s -o ${TARGET_DIR}/var/www/manual_en.pdf ${BR2_EXTERNAL_monitorOverlay_PATH}/../README.md pandoc -f markdown -t html -o ${TARGET_DIR}/var/www/manual_en.html ${BR2_EXTERNAL_monitorOverlay_PATH}/../README.md endef $(eval $(generic-package))</span></span></code> </pre> <br><h3 id="systemd">  systemd </h3><br><p>  El mundo de Linux se est√° moviendo activamente a systemd, y yo tambi√©n tuve que hacerlo. <br>  De las bonitas innovaciones: la presencia de temporizadores.  En general, se escribe un art√≠culo separado sobre ellos (y no solo sobre ellos), pero le contar√© brevemente. </p><br><p>  Hay acciones que deben realizarse peri√≥dicamente.  Necesitaba ejecutar logrotate para borrar los registros lighttpd y php-fpm.  Ser√≠a m√°s com√∫n escribir comandos en cron, pero decid√≠ usar el mon√≥tono temporizador systemd.  Por lo tanto, logrotate comienza en un intervalo de tiempo estricto. </p><br><p>  Por supuesto, existe la posibilidad de crear temporizadores que funcionen en ciertas fechas, pero no lo necesitaba. <br>  Temporizador de ejemplo: </p><br><ul><li>  Archivo de temporizador <br><pre> <code class="bash hljs">[Unit] Description=RODOS temp daemon timer</code> </pre> </li></ul><br><p>  [Temporizador] <br>  OnBootSec = 1min <br>  OnUnitActiveSec = 1min </p><br><p>  [Instalar] <br>  WantedBy = timers.target </p><br><pre> <code class="plaintext hljs">-  ,  : ```bash [Unit] Description=RODOS temp daemon [Service] ExecStart=/usr/bin/rodos.sh</code> </pre> <br><h2 id="podderzhivaemye-platy">  Juntas Soportadas </h2><br><p>  Asus tinker board: la placa principal en la que todo deber√≠a funcionar.  Seleccionado como econ√≥mico y muy poderoso. </p><br><p>  Beaglebone black es la primera placa en la que se prob√≥ el trabajo (durante la selecci√≥n de una placa m√°s potente). </p><br><p>  Qemu x86_64: se utiliza para desarrollar la depuraci√≥n. </p><br><h2 id="kak-rabotaet">  Como funciona </h2><br><p>  Al inicio, se produce una recuperaci√≥n de la configuraci√≥n en dos etapas: </p><br><ul><li>  ejecutando el script settings_restore (a trav√©s del servicio).  Restaura la configuraci√≥n b√°sica del sistema: zona horaria, configuraci√≥n regional, configuraci√≥n de red, etc. </li><li>  ejecutar el script de preparaci√≥n (a trav√©s del servicio): aqu√≠ se prepara zabbix, la base de datos, la IP se muestra en la consola. </li></ul><br><p>  En el primer inicio, se determina el tama√±o de la segunda secci√≥n de la tarjeta SD.  Si todav√≠a hay espacio sin asignar: los medios se reparticionan, la secci√≥n de datos ocupa todo el espacio libre.  Esto se hace para reducir el tama√±o de la imagen de instalaci√≥n (sdcard.img).  Adem√°s, el directorio de trabajo postgresql se crea en este punto.  Es por eso que el primer lanzamiento con un nuevo medio ser√° m√°s largo que los posteriores. </p><br><p>  Cuando conecta una unidad externa, en el momento del inicio, busca una unidad libre y la formatea en ext4 con la etiqueta externa. </p><br><p>  Atencion  ¬°Al conectar una unidad externa (adem√°s de desconectarla o reemplazarla), debe hacer una copia de seguridad y restaurar la configuraci√≥n! </p><br><p>  Para controlar la temperatura, se utiliza el dispositivo RODOS 5. El fabricante proporciona las fuentes de su utilidad para trabajar con el dispositivo.  Cuando se enciende el sistema, se inicia el temporizador rodos, que inicia esta utilidad una vez por minuto.  La temperatura actual se escribe en el archivo / tmp / rodos_current_temp, despu√©s de lo cual zabbix puede monitorear este archivo como un sensor. </p><br><p>  El medio de almacenamiento para la configuraci√≥n est√° montado en el directorio / data. </p><br><p>  Cuando inicia el sistema y lo prepara para el trabajo, aparece un mensaje en la consola: </p><br><pre> <code class="bash hljs">System starting, please <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span></code> </pre> <br><p>  Despu√©s de completar el trabajo preparatorio, cambiar√° para mostrar la direcci√≥n IP: </p><br><pre> <code class="bash hljs">current ip 192.168.1.32 Ready to work</code> </pre> <br><h2 id="nastroyka-zabbix-dlya-monitoringa-temperatury">  Configurar zabbix para monitoreo de temperatura </h2><br><p>  Para controlar la temperatura, solo realice 2 pasos: </p><br><ul><li>  conecte el dispositivo RODOS al puerto usb </li><li>  crear elemento de datos en zabbix </li></ul><br><p>  Abra la interfaz web de zabbix: </p><br><ul><li>  Abra la secci√≥n Configuraci√≥n ‚Üí Hosts </li><li>  Haga clic en Elementos en la l√≠nea de nuestro servidor zabbix </li><li>  Haga clic en Crear elemento </li></ul><br><p><img src="https://habrastorage.org/webt/wg/7r/5r/wg7r5rphxeb8pf-p04j9n89h_w4.png"></p><br><p>  Ingrese los siguientes datos: </p><br><ul><li>  nombre - a su discreci√≥n (por ejemplo, serverRoomTemp) </li><li>  Tipo - agente zabbix </li><li>  Clave - rodos </li><li>  Tipo- num√©rico </li><li>  Unidades - C </li><li>  Per√≠odo de almacenamiento del historial: el t√©rmino del historial.  quedan 10 d√≠as </li><li>  Periodo de almacenamiento de tendencias: per√≠odo de almacenamiento de la din√°mica de los cambios.  Quedan 30 d√≠as </li><li>  Nueva aplicaci√≥n - servidor Room Temp </li></ul><br><p>  Y presione el bot√≥n AGREGAR. <br><img src="https://habrastorage.org/webt/to/ym/bt/toymbti2klzkuwdkn6whrar2veu.png"></p><br><h2 id="upravlenie-nastroykami-cherez-veb-interfeys">  Gesti√≥n basada en web </h2><br><p>  La interfaz web est√° escrita en php.  Hay funciones principales: </p><br><ul><li>  ver el estado del dispositivo </li><li>  cambiar la configuraci√≥n de red <br><img src="https://habrastorage.org/webt/jq/g_/mh/jqg_mh6ujouewhlfkbcfr9vzfwq.png"></li><li>  cambiar contrase√±a de usuario </li><li>  selecci√≥n de zona horaria </li><li>  copia de seguridad / restaurar / restablecer a la configuraci√≥n de f√°brica </li><li>  la capacidad de conectar un disco externo </li><li>  Actualizaci√≥n del sistema <br><img src="https://habrastorage.org/webt/zr/4k/sj/zr4ksjhttcoapjntsivihrofwue.png"></li></ul><br><p>  Iniciar sesi√≥n en la interfaz web est√° protegido por contrase√±a.  P√°gina de inicio - manual. </p><br><p>  Direcci√≥n de la interfaz de Zabbix: \ $ {ip / dns} / zabbix <br>  Direcci√≥n de la interfaz de administraci√≥n: \ $ {ip / dns} / manage <br><img src="https://habrastorage.org/webt/os/cz/f7/osczf71wkg4jgzhmhmcfzceyyw0.png"></p><br><h2 id="zapusk-v-qemu">  Corre en qemu </h2><br><p>  qemu-system-x86_64 -smp 4 -m 4026M -enable-kvm -machine q35, accel = kvm-service intel-iommu -cpu host -net nic -net bridge, br = bridge0 -device virtio-scsi-pci, id = scsi0 -drive file = output / images / qemu.qcow2, format = qcow2, aio = threads -device virtio-scsi-pci, id = scsi0 -drive file = output / images / external.qcow2, format = qcow2, aio = threads </p><br><p>  Este comando iniciar√° el sistema con 4 n√∫cleos, 2048 RAM activados por KVM, una tarjeta de red en bridge0 y dos discos: para el sistema y externo para postgresql. </p><br><p>  Las im√°genes se pueden convertir y ejecutar en Virtualbox: </p><br><pre> <code class="bash hljs">qemu-img convert -f qcow2 qemu.qcow2 -O vdi qcow2.vdi qemu-img convert -f qcow2 external.qcow2 -O vdi external.vdi</code> </pre> <br><p>  Luego imp√≥rtelos a virtualbox y con√©ctese v√≠a sata. </p><br><p>  Conclusi√≥n </p><br><p>  En el proceso, me interes√© en preparar un producto para el trabajo, con una interfaz no muy agradable (no me gusta escribirlos), pero funciona y es f√°cil de configurar. </p><br><p>  El √∫ltimo intento de instalar el dispositivo zabbix en KVM mostr√≥ la correcci√≥n de este paso (el sistema no se inicia despu√©s de que se completa la instalaci√≥n).  Tal vez estoy haciendo algo mal;) </p><br><hr><br><p>  <a href="https://www.zabbix.com/documentation/4.2/ru/manual">Materiales</a> </p><br><p>  <a href="https://buildroot.org/">https://buildroot.org/</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/477008/">https://habr.com/ru/post/477008/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../476998/index.html">Kubernetes 1.17: Resumen de las innovaciones clave</a></li>
<li><a href="../477000/index.html">C√≥mo aumentar la precisi√≥n de los sensores</a></li>
<li><a href="../477002/index.html">C√≥mo alojamos el escandaloso 8chan imageboard</a></li>
<li><a href="../477004/index.html">Energ√≠a solar salada</a></li>
<li><a href="../477006/index.html">¬øEs Java el mejor lenguaje de programaci√≥n para principiantes?</a></li>
<li><a href="../477010/index.html">Slurm Mega. Instalaci√≥n de un cl√∫ster listo para producci√≥n, 3 consejos √∫tiles para altavoces y Slurm con Luke Skyoker y R2D2</a></li>
<li><a href="../477014/index.html">Ni√±os en Internet: c√≥mo garantizar la ciberseguridad de los usuarios m√°s vulnerables</a></li>
<li><a href="../477016/index.html">¬øPor qu√© vamos a conferencias cient√≠ficas?</a></li>
<li><a href="../477018/index.html">Hackear el mecanismo de privacidad de Mimblewimble</a></li>
<li><a href="../477020/index.html">Juzgue a cualquiera con solo tocar un bot√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>