<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•™ üçá üë©üèΩ‚Äçü§ù‚Äçüë©üèª An√°lise da linguagem VKScript: JavaScript, e voc√™? üè† üêµ üé∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR 



 VKScript n√£o √© JavaScript. A sem√¢ntica dessa linguagem √© fundamentalmente diferente da sem√¢ntica do JavaScript. Veja a conclus√£o . 
 O que...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise da linguagem VKScript: JavaScript, e voc√™?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464099/"><h1>  TL; DR </h1><br><hr><br><p>  VKScript <b>n√£o</b> √© JavaScript.  A sem√¢ntica dessa linguagem √© fundamentalmente diferente da sem√¢ntica do JavaScript.  Veja a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conclus√£o</a> . </p><br><a name="habracut"></a><h1>  O que √© o VKScript? </h1><br><hr><br><p> <b>O VKScript</b> √© uma linguagem de programa√ß√£o de script semelhante a JavaScript usada no m√©todo de API de <code>execute</code> do VKontakte, que permite que os clientes <b>baixem</b> exatamente as informa√ß√µes necess√°rias.  Em ess√™ncia, o VKScript √© um an√°logo do GraphQL usado pelo Facebook para o mesmo objetivo. </p><br><p>  Compare GraphQL e VKScript: </p><br><div class="scrollable-table"><table><tbody><tr><th></th><th>  GraphQL </th><th>  VKScript </th></tr><tr><td>  Implementa√ß√µes </td><td>  Muitas implementa√ß√µes de c√≥digo aberto em diferentes linguagens de programa√ß√£o </td><td>  A √∫nica implementa√ß√£o na API VK </td></tr><tr><td>  Baseado em </td><td>  Novo idioma </td><td>  Javascript </td></tr><tr><td>  As possibilidades </td><td>  Solicita√ß√£o de dados, filtragem limitada;  argumentos de consulta n√£o podem usar os resultados de consultas anteriores </td><td>  Qualquer p√≥s-processamento de dados, a crit√©rio do cliente;  As solicita√ß√µes de API s√£o apresentadas na forma de m√©todos e podem usar qualquer dado de solicita√ß√µes anteriores </td></tr></tbody></table></div><br><p>  Descri√ß√£o do VKScript na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">p√°gina</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√©todo na documenta√ß√£o da API do VK</a> (a √∫nica documenta√ß√£o oficial do idioma): </p><br><blockquote><div class="scrollable-table"><table><tbody><tr><th>  c√≥digo </th><td>  c√≥digo do algoritmo no <b>VKScript</b> - um formato semelhante ao <b>JavaScript</b> ou <b>ActionScript</b> <i>(a compatibilidade com <b>ECMAScript √©</b> assumida)</i> .  O algoritmo deve terminar com o comando <b>return% expression%</b> .  Os operadores devem ser separados por ponto e v√≠rgula. <br>  corda </td></tr></tbody></table></div><br><p>  Os seguintes s√£o suportados: </p><br><ul><li>  opera√ß√µes aritm√©ticas </li><li>  opera√ß√µes l√≥gicas </li><li>  cria√ß√£o de matrizes e listas ([X, Y]) </li><li>  <b>parseInt</b> e <b>parseDouble</b> </li><li>  concatena√ß√£o (+) </li><li>  <b>se</b> construir </li><li>  filtro de matriz por par√¢metro (@.) </li><li>  Chamadas do m√©todo <b>API</b> , par√¢metro <b>length</b> </li><li>  loops usando a instru√ß√£o <b>while</b> </li><li>  M√©todos Javascript: <b>fatia</b> , <b>push</b> , <b>pop</b> , <b>shift</b> , <b>unshift</b> , <b>emenda</b> , <b>substr</b> , <b>divis√£o</b> </li><li>  operador de <b>exclus√£o</b> </li><li>  atribui√ß√£o a elementos da matriz, por exemplo: row.user.action = "test"; </li><li>  a pesquisa na matriz ou cadeia de caracteres √© <b>indexOf</b> , por exemplo: ‚Äú123‚Äù .indexOf (2) = 1, [1, 2, 3] .indexOf (3) = 2. Retorna -1 se o elemento n√£o for encontrado. </li></ul><br><p>  Atualmente, a cria√ß√£o de fun√ß√µes n√£o √© suportada. </p><br></blockquote><br><p>  A documenta√ß√£o citada afirma que "a compatibilidade do ECMAScript est√° planejada".  Mas √© assim?  Vamos tentar descobrir como essa linguagem funciona por dentro. </p><br><br><h1>  Conte√∫do </h1><br><hr><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">M√°quina virtual VKScript</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sem√¢ntica de objetos VKScript</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√£o</a> </li></ol><br><a name="vm"></a><h1>  M√°quina virtual VKScript </h1><br><hr><br><p>  Como um programa pode ser analisado na aus√™ncia de uma c√≥pia local?  √â isso mesmo - envie solicita√ß√µes para o endpoint p√∫blico e analise as respostas.  Vamos tentar, por exemplo, executar o seguinte c√≥digo: </p><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><p>  <code>Runtime error occurred during code invocation: Too many operations</code> um <code>Runtime error occurred during code invocation: Too many operations</code> .  Isso sugere que na implementa√ß√£o da linguagem h√° um limite no n√∫mero de a√ß√µes executadas.  Vamos tentar definir o valor limite exato: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><ul><li>  <code>Runtime error occurred during code invocation: Too many operations</code> . </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">999</span></span>) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><ul><li>  <code>{"response": null}</code> - O c√≥digo executado com sucesso. </li></ul><br><p>  Assim, o limite no n√∫mero de opera√ß√µes √© de cerca de 1000 ciclos "inativos".  Mas, ao mesmo tempo, fica claro que esse ciclo provavelmente n√£o √© uma opera√ß√£o "unit√°ria".  Vamos tentar encontrar uma opera√ß√£o que n√£o seja dividida pelo compilador em v√°rias menores. </p><br><p>  O candidato mais √≥bvio para o papel de tal opera√ß√£o √© a chamada declara√ß√£o vazia ( <code>;</code> ).  No entanto, ap√≥s adicionar ao c√≥digo com <code>i &lt; 999</code> 50 caracteres <code>;</code>  , o limite n√£o √© excedido.  Isso significa que a instru√ß√£o vazia √© lan√ßada pelo compilador e n√£o desperdi√ßa opera√ß√µes, ou uma itera√ß√£o do loop leva mais de 50 opera√ß√µes (o que, provavelmente, n√£o √© assim). </p><br><p>  A pr√≥xima coisa que vem √† mente depois <code>;</code>  - c√°lculo de alguma express√£o simples (por exemplo, assim: <code>1;</code> ).  Vamos tentar adicionar algumas dessas express√µes ao nosso c√≥digo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">999</span></span>) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    1; //       "Too many operations"</span></span></code> </pre> <br><p>  Assim, 2 opera√ß√µes <code>1;</code>  gaste mais opera√ß√µes do que 50 opera√ß√µes <code>;</code>  .  Isso confirma a hip√≥tese de que a declara√ß√£o vazia n√£o desperdi√ßa instru√ß√µes. </p><br><p>  Vamos tentar reduzir o n√∫mero de itera√ß√µes do ciclo e adicionar um <code>1;</code> adicional <code>1;</code>  .  √â f√°cil perceber que, para cada itera√ß√£o, existem 5 <code>1;</code> adicionais <code>1;</code>  portanto, uma itera√ß√£o do ciclo passa 5 vezes mais opera√ß√µes que uma opera√ß√£o <code>1;</code>  . </p><br><p>  Mas existe uma opera√ß√£o ainda mais simples?  Por exemplo, adicionar o operador un√°rio <code>~</code> n√£o requer o c√°lculo de express√µes adicionais e a pr√≥pria opera√ß√£o √© executada no processador.  √â l√≥gico supor que adicionar essa opera√ß√£o √† express√£o aumente o n√∫mero total de opera√ß√µes em 1. </p><br><p>  Adicione este operador ao nosso c√≥digo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">999</span></span>) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; ~<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  E sim, podemos adicionar um desses operadores e mais uma express√£o <code>1;</code>  - n√£o mais.  Portanto, <code>1;</code>  realmente n√£o √© um operador unit√°rio. </p><br><p>  Semelhante ao operador <code>1;</code>  , reduziremos o n√∫mero de itera√ß√µes do loop e adicionaremos os operadores <code>~</code> .  Uma itera√ß√£o acabou sendo equivalente a 10 opera√ß√µes unit√°rias <code>~</code> , portanto, a express√£o <code>1;</code>  passa 2 opera√ß√µes. </p><br><p>  Observe que o limite √© de aproximadamente 1000 itera√ß√µes, ou seja, aproximadamente 10.000 opera√ß√µes √∫nicas.  Assumimos que o limite √© exatamente 10.000 opera√ß√µes. </p><br><br><h2>  Medindo o n√∫mero de opera√ß√µes no c√≥digo </h2><br><hr><br><p>  Observe que agora podemos medir o n√∫mero de opera√ß√µes em qualquer c√≥digo.  Para fazer isso, adicione esse c√≥digo ap√≥s o loop e adicione / remova itera√ß√µes, <code>~</code> operadores ou toda a √∫ltima linha, at√© que o erro <code>Too many operations</code> desapare√ßa. </p><br><p>  Alguns resultados de medi√ß√£o: </p><br><div class="scrollable-table"><table><tbody><tr><th>  C√≥digo </th><th>  N√∫mero de opera√ß√µes </th></tr><tr><td> <code>1;</code> </td> <td>  2 </td></tr><tr><td> <code>~1;</code> </td> <td>  3 </td></tr><tr><td> <code>1+1;</code> </td> <td>  4 </td></tr><tr><td> <code>1+1+1;</code> </td> <td>  6 </td></tr><tr><td> <code>(true?1:1);</code> </td> <td>  5 </td></tr><tr><td> <code>(false?1:1);</code> </td> <td>  4 </td></tr><tr><td> <code>if(0)1;</code> </td> <td>  2 </td></tr><tr><td> <code>if(1)1;</code> </td> <td>  4 </td></tr><tr><td> <code>if(0)1;else 1;</code> </td> <td>  4 </td></tr><tr><td> <code>if(1)1;else 1;</code> </td> <td>  5 </td></tr><tr><td> <code>while(0);</code> </td> <td>  2 </td></tr><tr><td> <code>i=1;</code> </td> <td>  3 </td></tr><tr><td> <code>i=i+1;</code> </td> <td>  5 </td></tr><tr><td> <code>var j = 1;</code> </td> <td>  1 </td></tr><tr><td> <code>var j = 0;while(j &lt; 1)j=j+1;</code> </td> <td>  15 </td></tr></tbody></table></div><br><br><h2>  Determinando o tipo de m√°quina virtual </h2><br><hr><br><p>  Primeiro, voc√™ precisa entender como o int√©rprete VKScript funciona.  Existem duas op√ß√µes mais ou menos plaus√≠veis: </p><br><ul><li>  O int√©rprete percorre recursivamente a √°rvore de sintaxe e executa uma opera√ß√£o em cada n√≥. </li><li>  O compilador converte a √°rvore de sintaxe em uma sequ√™ncia de instru√ß√µes que o int√©rprete executa. </li></ul><br><p>  √â f√°cil entender que o VKScript usa a segunda op√ß√£o.  Considere a express√£o <code>(true?1:1);</code>  (5 opera√ß√µes) e <code>(false?1:1);</code>  (4 opera√ß√µes).  No caso de execu√ß√£o seq√ºencial de instru√ß√µes, uma opera√ß√£o adicional √© explicada por uma transi√ß√£o que "ignora" a op√ß√£o errada e, no caso de um desvio AST recursivo, ambas as op√ß√µes s√£o equivalentes para o int√©rprete.  Um efeito semelhante √© observado em if / else com uma condi√ß√£o diferente. </p><br><p>  Tamb√©m vale a pena prestar aten√ß√£o no par <code>i = 1;</code>  (3 opera√ß√µes) e <code>var j = 1;</code>  (1 opera√ß√£o).  Criar uma nova vari√°vel custa apenas 1 opera√ß√£o e atribuir a uma existente custa 3?  O fato de criar uma vari√°vel custa 1 opera√ß√£o (e, provavelmente, √© uma opera√ß√£o de carregamento constante), diz duas coisas: </p><br><ul><li>  Ao criar uma nova vari√°vel, n√£o h√° aloca√ß√£o de mem√≥ria expl√≠cita para a vari√°vel. </li><li>  Ao criar uma nova vari√°vel, o valor n√£o √© carregado na c√©lula de mem√≥ria.  Isso significa que o espa√ßo para a nova vari√°vel √© alocado onde o valor da express√£o foi calculado e, depois disso, essa mem√≥ria √© considerada alocada.  Isso sugere o uso de uma m√°quina de empilhar. </li></ul><br><p>  O uso da pilha tamb√©m explica que a express√£o <code>var j = 1;</code>  corre mais r√°pido que a express√£o <code>1;</code>  : a √∫ltima express√£o passa instru√ß√µes adicionais sobre como remover o valor calculado da pilha. </p><br><br><h2>  Determinando o valor limite exato </h2><br><p>  Observe que o ciclo <code>var j=0;while(j &lt; 1)j=j+1;</code>  (15 opera√ß√µes) √© uma c√≥pia pequena do ciclo que foi usado para medi√ß√µes: </p><br><div class="scrollable-table"><table><tbody><tr><th>  C√≥digo </th><th>  N√∫mero de opera√ß√µes </th></tr><tr><td><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </td><td>  15 </td></tr><tr><td><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">999</span></span>) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </td><td>  15 + 998 * 10 = 9995 </td></tr><tr><td><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">999</span></span>) i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; ~<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  (limite) </td><td>  9998 </td></tr></tbody></table></div><br><p>  Parar o que?  Existe um limite de 9998 instru√ß√µes?  Estamos claramente perdendo algo ... </p><br><p>  Observe que o c√≥digo de <code>return 1;</code> √© <code>return 1;</code>  realizada de acordo com as medi√ß√µes para 0 instru√ß√µes.  Isso √© facilmente explicado: o compilador adiciona um <code>return null;</code> impl√≠cito <code>return null;</code> no final do c√≥digo <code>return null;</code>  e, ao adicionar seu retorno, ele falha.  Supondo que o limite seja 10000, conclu√≠mos que a opera√ß√£o <code>return null;</code>  leva 2 instru√ß√µes (provavelmente isso √© algo como <code>push null; return;</code> ). </p><br><br><h2>  Blocos de c√≥digo aninhados </h2><br><hr><br><p>  Vamos fazer mais algumas medi√ß√µes: </p><br><div class="scrollable-table"><table><tbody><tr><th>  C√≥digo </th><th>  N√∫mero de opera√ß√µes </th></tr><tr><td> <code>{};</code> </td> <td>  0 0 </td></tr><tr><td> <code>{var j = 1;};</code> </td> <td>  2 </td></tr><tr><td> <code>{var j = 1, k = 2;};</code> </td> <td>  3 </td></tr><tr><td> <code>{var j = 1; var k = 2;};</code> </td> <td>  3 </td></tr><tr><td> <code>var j = 1; var j = 1;</code> </td> <td>  4 </td></tr><tr><td> <code>{var j = 1;}; var j = 1;</code> </td> <td>  3 </td></tr></tbody></table></div><br><p>  Vamos prestar aten√ß√£o aos seguintes fatos: </p><br><ul><li>  Adicionar uma vari√°vel a um bloco requer uma opera√ß√£o extra. </li><li>  Ao "declarar uma vari√°vel novamente", a segunda declara√ß√£o √© cumprida como uma atribui√ß√£o normal. </li><li>  Mas, ao mesmo tempo, a vari√°vel dentro do bloco n√£o √© vis√≠vel do lado de fora (veja o √∫ltimo exemplo). </li></ul><br><p>  √â f√°cil entender que uma opera√ß√£o extra √© gasta na remo√ß√£o de vari√°veis ‚Äã‚Äãlocais declaradas no bloco da pilha.  Portanto, quando n√£o h√° vari√°veis ‚Äã‚Äãlocais, nada precisa ser exclu√≠do. </p><br><br><h1>  Objetos, m√©todos, chamadas de API </h1><br><hr><br><div class="scrollable-table"><table><tbody><tr><th>  C√≥digo </th><th>  N√∫mero de opera√ß√µes </th></tr><tr><td> <code>"";</code> </td> <td>  2 </td></tr><tr><td> <code>"abcdef";</code> </td> <td>  2 </td></tr><tr><td> <code>{};</code> </td> <td>  2 </td></tr><tr><td> <code>[];</code> </td> <td>  2 </td></tr><tr><td> <code>[1, 2, 3];</code> </td> <td>  5 </td></tr><tr><td> <code>{a: 1, b: 2, c: 3};</code> </td> <td>  5 </td></tr><tr><td> <code>API.users.isAppUser(1);</code> </td> <td>  3 </td></tr><tr><td> <code>"".substr(0, 0);</code> </td> <td>  6 </td></tr><tr><td> <code>var j={};jx=1;</code> </td> <td>  6 </td></tr><tr><td> <code>var j={x:1};delete jx;</code> </td> <td>  6 </td></tr></tbody></table></div><br><p>  Vamos analisar os resultados.  Voc√™ pode perceber que a cria√ß√£o de uma sequ√™ncia de caracteres e de uma matriz / objeto vazio leva duas opera√ß√µes, assim como o carregamento de um n√∫mero.  Ao criar uma matriz ou objeto n√£o vazio, s√£o adicionadas as opera√ß√µes gastas no carregamento de elementos da matriz / objeto.  Isso sugere que a cria√ß√£o direta de um objeto ocorre em uma opera√ß√£o.  Ao mesmo tempo, n√£o se perde tempo baixando nomes de propriedades; portanto, fazer o download deles faz parte da opera√ß√£o de cria√ß√£o do objeto. </p><br><p>  Com a chamada do m√©todo API, tudo tamb√©m √© bastante comum - carregar uma unidade, na verdade chamando o m√©todo, <code>pop</code> resultado (voc√™ pode perceber que o nome do m√©todo √© processado como um todo, e n√£o como propriedades).  Mas os √∫ltimos tr√™s exemplos parecem interessantes. </p><br><ul><li> <code>"".substr(0, 0);</code>  - carregando uma string, carregando zero, carregando zero, resultado <code>pop</code> .  Por um motivo, existem 2 instru√ß√µes para chamar um m√©todo (por algum motivo, veja abaixo). </li><li> <code>var j={};jx=1;</code>  - criando um objeto, carregando um objeto, carregando uma unidade, <code>pop</code> unidade ap√≥s a atribui√ß√£o.  Novamente, existem 2 instru√ß√µes para atribui√ß√£o. </li><li> <code>var j={x:1};delete jx;</code>  - carregando uma unidade, criando um objeto, carregando um objeto, excluindo.  Existem 3 instru√ß√µes por opera√ß√£o de exclus√£o. </li></ul><br><br><a name="semantics"></a><br><h1>  Sem√¢ntica de objetos VKScript </h1><br><h2>  Os n√∫meros </h2><br><hr><br><p>  Voltando √† pergunta original: o VKScript √© um subconjunto de JavaScript ou outro idioma?  Vamos fazer um teste simples: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1000000000</span></span> + <span class="hljs-number"><span class="hljs-number">2000000000</span></span>;</code> </pre> <br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"response"</span></span>: <span class="hljs-number"><span class="hljs-number">-1294967296</span></span>};</code> </pre> <br><p>  Como podemos ver, a adi√ß√£o de n√∫meros inteiros leva ao estouro, apesar do JavaScript n√£o possuir n√∫meros inteiros.  Tamb√©m √© f√°cil verificar se a divis√£o por 0 gera um erro e n√£o retorna o <code>Infinity</code> . </p><br><br><h2>  Os objetos </h2><br><hr><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {};</code> </pre> <br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"response"</span></span>: []}</code> </pre> <br><p>  Parar o que?  Retornamos <i>um objeto</i> e obtemos uma <i>matriz</i> ?  √â sim.  No VKScript, matrizes e objetos s√£o representados pelo mesmo tipo, em particular, um objeto vazio e uma matriz vazia s√£o a mesma coisa.  Nesse caso, a propriedade <code>length</code> do objeto funciona e retorna o n√∫mero de propriedades. </p><br><p>  √â interessante ver como os m√©todos de lista se comportam se voc√™ os chama em um objeto? </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-attr"><span class="hljs-attr">a</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">b</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">c</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>}.pop();</code> </pre> <br><pre> <code class="json hljs"><span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  O m√©todo <code>pop</code> retorna a √∫ltima propriedade declarada, que, no entanto, √© l√≥gica.  Altere a ordem das propriedades: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-attr"><span class="hljs-attr">b</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">c</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">a</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>}.pop();</code> </pre> <br><pre> <code class="json hljs"><span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  Aparentemente, os objetos no VKScript lembram a ordem em que as propriedades s√£o atribu√≠das.  Vamos tentar usar propriedades num√©ricas: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'2'</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'1'</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">'0'</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>}.pop();</code> </pre> <br><pre> <code class="json hljs"><span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  Agora vamos ver como o push funciona: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = {<span class="hljs-string"><span class="hljs-string">'2'</span></span>:<span class="hljs-string"><span class="hljs-string">'a'</span></span>,<span class="hljs-string"><span class="hljs-string">'1'</span></span>:<span class="hljs-string"><span class="hljs-string">'b'</span></span>,<span class="hljs-string"><span class="hljs-string">'x'</span></span>:<span class="hljs-string"><span class="hljs-string">'c'</span></span>}; a.push(<span class="hljs-string"><span class="hljs-string">'d'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a;</code> </pre> <br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"1"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"3"</span></span>: <span class="hljs-string"><span class="hljs-string">"d"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x"</span></span>: <span class="hljs-string"><span class="hljs-string">"c"</span></span>};</code> </pre> <br><p>  Como voc√™ pode ver, o m√©todo push classifica as teclas num√©ricas e adiciona um novo valor ap√≥s a √∫ltima tecla num√©rica.  "Buracos" n√£o s√£o preenchidos neste caso. </p><br><p>  Agora tente combinar estes dois m√©todos: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = {<span class="hljs-string"><span class="hljs-string">'2'</span></span>:<span class="hljs-string"><span class="hljs-string">'a'</span></span>,<span class="hljs-string"><span class="hljs-string">'1'</span></span>:<span class="hljs-string"><span class="hljs-string">'b'</span></span>,<span class="hljs-string"><span class="hljs-string">'x'</span></span>:<span class="hljs-string"><span class="hljs-string">'c'</span></span>}; a.push(a.pop()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a;</code> </pre> <br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"1"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"3"</span></span>: <span class="hljs-string"><span class="hljs-string">"c"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x"</span></span>: <span class="hljs-string"><span class="hljs-string">"c"</span></span>};</code> </pre> <br><p>  Como vemos, o elemento n√£o foi exclu√≠do da matriz.  No entanto, se colocarmos <code>push</code> e <code>pop</code> em linhas diferentes, o bug desaparecer√°.  Precisamos ir mais fundo! </p><br><br><h2>  Armazenamento de Objetos </h2><br><hr><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = {}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = x; xy = <span class="hljs-string"><span class="hljs-string">'z'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y;</code> </pre> <br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"response"</span></span>: []}</code> </pre> <br><p>  Como se viu, os objetos no VKScript s√£o armazenados por valor, diferentemente do JavaScript.  Agora vemos o estranho comportamento da string <code>a.push(a.pop());</code>  - aparentemente, o valor antigo da matriz foi salvo na pilha, de onde foi retirado posteriormente. </p><br><p>  No entanto, como ent√£o os dados s√£o armazenados no objeto se o m√©todo o modifica?  Aparentemente, a instru√ß√£o "extra" ao chamar o m√©todo foi projetada especificamente para gravar altera√ß√µes no objeto. </p><br><br><h2>  M√©todos de matriz </h2><br><hr><br><div class="scrollable-table"><table><tbody><tr><th>  M√©todo </th><th>  Ac√ß√£o </th></tr><tr><td> <code>push</code> </td> <td><ul><li>  classificar chaves num√©ricas por valor </li><li>  pegue a tecla num√©rica m√°xima, adicione uma </li><li>  escrever argumento na matriz </li><li>  adicione chaves n√£o num√©ricas ao final da matriz </li></ul></td></tr><tr><td> <code>pop</code> </td> <td>  Remova o √∫ltimo elemento da matriz (n√£o necessariamente com uma tecla num√©rica) e retorne. </td></tr><tr><td>  o resto </td><td><ul><li>  classifique as teclas num√©ricas por valor, remova os ‚Äúburacos‚Äù na matriz </li><li>  executar opera√ß√£o javascript apropriada </li><li>  adicione chaves n√£o num√©ricas ao final da matriz </li></ul><br><p>  Ao usar o m√©todo de fatia, as altera√ß√µes n√£o s√£o salvas </p><br></td></tr></tbody></table></div><br><a name="summary"></a><h1>  Conclus√£o </h1><br><hr><br><p>  VKScript n√£o √© JavaScript.  Ao contr√°rio do JavaScript, os objetos nele s√£o armazenados por valor, n√£o por refer√™ncia e possuem sem√¢nticas completamente diferentes.  No entanto, ao usar o VKScript para a finalidade a que se destina, a diferen√ßa n√£o √© percept√≠vel. </p><br><br><h1>  PS Sem√¢ntica de operadores </h1><br><hr><br><p>  Os coment√°rios mencionados combinando objetos via <code>+</code> .  A esse respeito, decidi acrescentar informa√ß√µes sobre o trabalho dos operadores. </p><br><div class="scrollable-table"><table><tbody><tr><th>  Operador </th><th>  Ac√ß√µes </th></tr><tr><td>  + </td><td><ul><li>  Se os dois argumentos forem objetos, crie uma c√≥pia do primeiro objeto e adicione as chaves do segundo (com substitui√ß√£o) a ele. </li><li>  Se os dois argumentos forem n√∫meros, adicione como n√∫meros. </li><li>  Caso contr√°rio, os dois operandos s√£o convertidos em uma sequ√™ncia e adicionados como sequ√™ncias. </li></ul></td></tr><tr><td>  Outros operadores aritm√©ticos </td><td>  Ambos os operandos s√£o convertidos em um n√∫mero e a opera√ß√£o correspondente √© executada.  Para opera√ß√µes de bit, os operandos tamb√©m s√£o convertidos para <code>int</code> . </td></tr><tr><td>  Operadores de compara√ß√£o </td><td>  Se duas cadeias ou dois n√∫meros s√£o comparados, eles s√£o comparados diretamente.  Se uma sequ√™ncia e um n√∫mero forem comparados, e a sequ√™ncia for uma nota√ß√£o correta para o n√∫mero, a sequ√™ncia ser√° convertida em um n√∫mero.  Caso contr√°rio, um erro <code>Comparing values of different or unsupported types</code> ser√° retornado. </td></tr><tr><td>  Transmitir para sequ√™ncia </td><td>  N√∫meros e seq√º√™ncias de caracteres s√£o fornecidos como no JavaScript.  Os objetos s√£o listados como uma lista de valores separados por v√≠rgula na ordem das chaves.  <code>false</code> e <code>null</code> s√£o convertidos como <code>""</code> , <code>true</code> convertido como <code>"1"</code> . </td></tr><tr><td>  Transmitir para </td><td>  Se o argumento for uma sequ√™ncia que √© uma nota√ß√£o de n√∫mero v√°lida, o n√∫mero ser√° retornado.  Caso contr√°rio, um erro <code>Numeric arguments expected</code> ser√° retornado. </td></tr></tbody></table></div><br><p>  Para opera√ß√µes com n√∫meros (exceto bit), se os operandos s√£o <code>int</code> e <code>double</code> , <code>int</code> √© <code>double</code> em <code>double</code> .  Se os dois operandos forem <code>int</code> , uma opera√ß√£o ser√° executada em n√∫meros inteiros de 32 bits assinados (com estouro). </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt464099/">https://habr.com/ru/post/pt464099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt464089/index.html">Automatizando solicita√ß√µes HTTP no contexto do Spring</a></li>
<li><a href="../pt464091/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel 311 (de 12 a 18 de agosto)</a></li>
<li><a href="../pt464093/index.html">Bens digitais: o que fazer se um cliente vier buscar uma compra em um ano?</a></li>
<li><a href="../pt464095/index.html">Getters e Setters em Dart and Flutter</a></li>
<li><a href="../pt464097/index.html">A evolu√ß√£o da intelig√™ncia: por que os rob√¥s precisam de emo√ß√µes</a></li>
<li><a href="../pt464103/index.html">Rascunho do padr√£o nacional de IoT do OpenUNB: revis√£o cr√≠tica</a></li>
<li><a href="../pt464105/index.html">Servidor Commento nativo com Docker Compose</a></li>
<li><a href="../pt464107/index.html">Eventos digitais em Moscou, de 19 a 25 de agosto</a></li>
<li><a href="../pt464109/index.html">P√°ra-quedas supers√¥nicos do espa√ßo</a></li>
<li><a href="../pt464111/index.html">Natas Web. Passagem da plataforma CTF destinada a explorar vulnerabilidades da Web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>