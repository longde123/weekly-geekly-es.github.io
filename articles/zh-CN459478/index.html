<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ€ ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦ ğŸš´ğŸ¿ æˆ‘åœ¨åˆ›å»ºç”¨äºå¤‡ä»½çš„å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºæ–¹é¢çš„ç»éªŒ ğŸšµ ğŸ‘¨â€ğŸ‘¦ ğŸ”‹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç›®å‰ï¼Œä½¿ç”¨å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ä¸ä¼šæ„Ÿåˆ°æƒŠè®¶ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºåœ¨æœ¬æ–‡ä¸­æ‚¨å¯ä»¥æ‰¾åˆ°ä¸€äº›æœ‰è¶£çš„æƒ³æ³•ã€‚ æˆ‘å¯¹Javaçš„ç ”ç©¶æ˜¯ä»è¿™ä¸ªé¡¹ç›®å¼€å§‹çš„ï¼Œæ‰€ä»¥ä¹Ÿè®¸åœ¨æŸäº›åœ°æ–¹æˆ‘ä¼šçŠ¯é”™æˆ–åˆ¶é€ ä¸€è¾†å¤§å‹è‡ªè¡Œè½¦ï¼Œä½†æ˜¯æˆ‘å¸Œæœ›æœ‰äººä¼šå¯¹Javaåˆå­¦è€…çš„ç»éªŒæ„Ÿå…´è¶£ã€‚ æˆ‘å°†ç»™å‡ºè¯¥åº”ç”¨ç¨‹åºçš„å‡ ä¸ªåŠŸèƒ½ï¼š 


- æ— è®ºå¤‡ä»½çš„å¤§å°å¦‚ä½•ï¼Œå®ƒéƒ½å¯ä¸“é—¨ç”¨äº...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘åœ¨åˆ›å»ºç”¨äºå¤‡ä»½çš„å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºæ–¹é¢çš„ç»éªŒ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459478/"><p> ç›®å‰ï¼Œä½¿ç”¨å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ä¸ä¼šæ„Ÿåˆ°æƒŠè®¶ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºåœ¨æœ¬æ–‡ä¸­æ‚¨å¯ä»¥æ‰¾åˆ°ä¸€äº›æœ‰è¶£çš„æƒ³æ³•ã€‚ æˆ‘å¯¹Javaçš„ç ”ç©¶æ˜¯ä»è¿™ä¸ªé¡¹ç›®å¼€å§‹çš„ï¼Œæ‰€ä»¥ä¹Ÿè®¸åœ¨æŸäº›åœ°æ–¹æˆ‘ä¼šçŠ¯é”™æˆ–åˆ¶é€ ä¸€è¾†å¤§å‹è‡ªè¡Œè½¦ï¼Œä½†æ˜¯æˆ‘å¸Œæœ›æœ‰äººä¼šå¯¹Javaåˆå­¦è€…çš„ç»éªŒæ„Ÿå…´è¶£ã€‚ æˆ‘å°†ç»™å‡ºè¯¥åº”ç”¨ç¨‹åºçš„å‡ ä¸ªåŠŸèƒ½ï¼š </p><br><ul><li> æ— è®ºå¤‡ä»½çš„å¤§å°å¦‚ä½•ï¼Œå®ƒéƒ½å¯ä¸“é—¨ç”¨äºå†…å­˜ä¸­çš„å¤‡ä»½ </li><li> ä¸ä¼šå°†æ•´ä¸ªå¤‡ä»½åŠ è½½åˆ°å†…å­˜ä¸­ </li><li> å¤‡ä»½/è¿˜åŸæ“ä½œå¯ä»¥å–æ¶ˆ </li></ul><br><p> åˆ‡å…¥ç‚¹å°†è€ƒè™‘åº”ç”¨ç¨‹åºçš„ä½“ç³»ç»“æ„ï¼Œä»¥åŠé‡åˆ°çš„ä¸»è¦é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆã€‚ </p><a name="habracut"></a><br><h2 id="obzor-prilozheniya"> åº”ç”¨æ¦‚è¿° </h2><br><p> ä¸åº”ç”¨ç¨‹åºçš„é€šä¿¡æ˜¯é€šè¿‡Web UIè¿›è¡Œçš„ï¼Œä½†æ˜¯åœ¨å°†æ¥ï¼Œå¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥æ·»åŠ REST APIã€‚ </p><br><p> è¯¥åº”ç”¨ç¨‹åºå¯ä»¥ï¼š </p><br><ol><li> åˆ›å»ºå¤‡ä»½å¹¶å°†å…¶ä¸Šä¼ åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå­˜å‚¨ </li><li> é€šè¿‡ä»å­˜å‚¨åŠ è½½å¤‡ä»½æ¥è¿˜åŸå¤‡ä»½ </li><li> ä»æ‰€æœ‰å­˜å‚¨ä¸­åˆ é™¤å¤‡ä»½ </li><li> å®šæœŸåˆ›å»ºå¤‡ä»½ </li></ol><br><p> å½“å‰æ”¯æŒçš„å­˜å‚¨åº“ï¼š </p><br><ul><li> æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆDockerä¸æ”¯æŒï¼‰ </li><li> æŠ•å¯„ç®± </li></ul><br><p> å½“å‰æ”¯æŒçš„æ•°æ®åº“ï¼š </p><br><ul><li>  PostgreSQLçš„ </li></ul><br><p> ä»ä¸€ä¸ªç‰¹æ®Šçš„åº”ç”¨ç¨‹åºï¼Œæˆ‘å¯ä»¥æ³¨æ„åˆ°ï¼š </p><br><ol><li> çº æ­£é›†ç¾¤é…ç½®ä¸­çš„å·¥ä½œ </li><li> æ— è®ºå¤‡ä»½çš„å¤§å°å¦‚ä½•ï¼Œå¤‡ä»½éƒ½ä¸ä¼šå®Œå…¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ è¿˜ä¸æ¶‰åŠç”¨äºä¸´æ—¶å¤‡ä»½å­˜å‚¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚ å¤‡ä»½çš„åˆ›å»ºå’Œè¿˜åŸä»¥åŠå¤‡ä»½çš„åŠ è½½/å¸è½½éƒ½ä¸“é—¨åœ¨å†…å­˜ä¸­è¿›è¡Œã€‚ </li><li> è·¨å¹³å°-åœ¨Windowså’ŒLinuxä¸Šå‡å¯ä½¿ç”¨ã€‚ </li><li> æˆ‘ä»¬å¯ä»¥ç›‘è§†æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶åœ¨å¿…è¦æ—¶å–æ¶ˆå®ƒä»¬ã€‚ </li></ol><br><p> ä¸‹é¢æ˜¯Web UIçš„å±å¹•æˆªå›¾ï¼Œæ¸…æ¥šåœ°æè¿°äº†åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ä»“å‚¨ç®¡ç†</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/vl/qg/n5/vlqgn5f58ub5jhxixeeg2uq-oa8.png" title="æ·»åŠ å­˜å‚¨"></a> <br> <a href=""><img src="https://habrastorage.org/webt/oj/o5/uj/ojo5uj_raxkwd1btsjrktiowifo.png" title="å‚¨å­˜æ¸…å•"></a> </p></div></div><br><div class="spoiler">  <b class="spoiler_title">æ•°æ®åº“ç®¡ç†</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/wn/6p/bk/wn6pbkcqg4qu_9btgrvnqm3l7x0.png" title="æ·»åŠ æ•°æ®åº“"></a> <br> <a href=""><img src="https://habrastorage.org/webt/wu/9a/4k/wu9a4ky7icuiyqdxeiii9xbu5d8.png" title="æ•°æ®åº“æ¸…å•"></a> </p></div></div><br><div class="spoiler">  <b class="spoiler_title">å¤‡ä»½åˆ›å»º</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/1d/zb/6s/1dzb6scvtua5v3m_3l11lch4rgm.png" title="å¤‡ä»½åˆ›å»º"></a> </p></div></div><br><div class="spoiler">  <b class="spoiler_title">å¤‡ä»½æ¢å¤</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/gj/9f/w0/gj9fw0onqw7f0lf7ycw05aphinc.png" title="å¤‡ä»½æ¢å¤"></a> </p></div></div><br><div class="spoiler">  <b class="spoiler_title">ç®¡ç†åˆ›å»ºçš„å¤‡ä»½</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/sy/jz/y6/syjzy68wqxgi8smgq74giqstgu0.png" title="åˆ›å»ºçš„å¤‡ä»½åˆ—è¡¨"></a> </p></div></div><br><div class="spoiler">  <b class="spoiler_title">å®šæœŸå¤‡ä»½</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/hk/pw/tg/hkpwtg3kf7c5ho3f7ae7_uos7v0.png" title="åˆ›å»ºå®šæœŸä»»åŠ¡"></a> </p></div></div><br><div class="spoiler">  <b class="spoiler_title">è·Ÿè¸ªè¿è¡Œä»»åŠ¡</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/al/dt/su/aldtsuel4amtjlvbbbusccxddh0.png" title="æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ¸…å•"></a> </p></div></div><br><hr><br><h2 id="arhitektura"> å»ºç­‘å­¦ </h2><br><p> ä¸»è¦å·¥ä½œå°†åœ¨3ä¸ªæœåŠ¡ä¸­è¿›è¡Œï¼š <em>DatabaseBackup</em> ï¼Œ <em>Processor</em> ï¼Œ <em>Storage</em> ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<em>ä»»åŠ¡æ¦‚å¿µ</em>å°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ã€‚ å…³äºæ‰€æœ‰è¿™ä¸€åˆ‡ã€‚ </p><br><h3 id="databasebackup"> æ•°æ®åº“å¤‡ä»½ </h3><br><p> è¯¥æœåŠ¡è´Ÿè´£åˆ›å»ºå’Œè¿˜åŸçº¯æ–‡æœ¬å¤‡ä»½ã€‚ </p><br><p> æœåŠ¡æ¥å£ï¼š </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DatabaseBackup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBackup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DatabaseSettings databaseSettings, Integer id)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restoreBackup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream in, DatabaseSettings databaseSettings, Integer id)</span></span></span></span>; }</code> </pre> <br><p> ä¸¤ç§æ¥å£æ–¹æ³•éƒ½åœ¨<strong>InputStream</strong>å®ä¾‹ä¸Šè¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä¸å°†æ•´ä¸ªå¤‡ä»½åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¿™æ„å‘³ç€å¿…é¡»ä»¥æµæ¨¡å¼è¯»å–/å†™å…¥å¤‡ä»½ã€‚  <em>DatabaseSettings</em>å®ä½“æ˜¯ä»Web UIé¢„å…ˆåˆ›å»ºçš„ï¼Œå¹¶å­˜å‚¨è®¿é—®æ•°æ®åº“æ‰€éœ€çš„å„ç§è®¾ç½®ã€‚ å‚æ•°<code>id</code>æ˜¯ä»€ä¹ˆï¼Œå°†è¿›ä¸€æ­¥è§£é‡Šã€‚ </p><br><p> æœåŠ¡è¦æ±‚å¦‚ä¸‹ï¼š </p><br><ol><li> ä¸¤ç§æ–¹æ³•éƒ½ä¸åº”å°†æ•´ä¸ªå¤‡ä»½è¯»å…¥å†…å­˜ã€‚ </li><li>  <code>restoreBackup()</code>æ–¹æ³•åº”åœ¨å•ä¸ªäº‹åŠ¡ä¸­è¿˜åŸå¤‡ä»½ï¼Œä»¥ä¾¿åœ¨å‘ç”Ÿé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œä¸è¦ä½¿æ•°æ®åº“å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚ </li></ol><br><div class="spoiler">  <b class="spoiler_title">PostgreSQLçš„å®ç°ï¼ˆæ–‡æœ¬æè¿°ï¼‰</b> <div class="spoiler_text"><p> å…·ä½“æ¥è¯´ï¼Œåœ¨PostgreSQLçš„å®ç°ä¸­ï¼Œè¯¥æœåŠ¡çš„å®ç°å¦‚ä¸‹ï¼š </p><br><ol><li>  <code>createBackup()</code> ï¼šåˆ›å»ºä¸€ä¸ª<em>pg_dump</em>è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹å°†åˆ›å»ºä¸€ä¸ªå¤‡ä»½å¹¶å°†å…¶å†™å…¥æ ‡å‡†è¾“å‡ºæµã€‚ ä»è¯¥æ–¹æ³•è¿”å›æ ‡å‡†æµç¨‹è¾“å‡ºæµï¼ˆè¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html#getInputStream--</a> ï¼‰ã€‚ ç³»ç»Ÿä¸­çš„I / OæµåŸºäºç‰¹å®šå¤§å°çš„ç¼“å†²åŒºï¼Œå¹¶ä¸”å½“è¿›ç¨‹å†™å…¥è¾“å‡ºæµæ—¶ï¼Œå®ƒå®é™…ä¸Šä¼šå†™å…¥å†…å­˜ä¸­çš„ç¼“å†²åŒºã€‚ è¿™é‡Œæœ€é‡è¦çš„æ˜¯ï¼Œè¿›ç¨‹çº¿ç¨‹å°†ä¸ä¼šå†™å…¥å·²<em>å¡«å……çš„</em>ç¼“å†²åŒºï¼Œç›´åˆ°å¦ä¸€ç«¯å·²è¯»å–è¯¥ç¼“å†²åŒºä¸ºæ­¢ï¼Œè¿™æ„å‘³ç€è¯¥çº¿ç¨‹å°†å¤„äºé”å®šçŠ¶æ€ï¼Œå¹¶ä¸”å¤‡ä»½å°†ä¸ä¼šå®Œå…¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ æ‚¨å¯èƒ½ä¼šé‡åˆ°è¿™æ ·çš„æƒ…å†µï¼Œå³æ‚¨çš„Javaç¨‹åºåœ¨å¤„ç†è¿›ç¨‹æ—¶é‡åˆ°æ­»é”ï¼ŒåŸå› æ˜¯æ‚¨æ²¡æœ‰è¯»å–è¿›ç¨‹çš„stdoutæˆ–stderrã€‚ ç›‘è§†è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå› ä¸ºå¦‚æœåœ¨å†™å…¥ä¸€ä¸ªå®Œæ•´çš„ç¼“å†²åŒºæ—¶åœ¨I / Oé˜»å¡è°ƒç”¨ä¸­é˜»å¡äº†è¯¥è¿›ç¨‹ï¼Œå¹¶ä¸”æ²¡æœ‰äººè¯»å–è¯¥ç¼“å†²åŒºï¼Œåˆ™è¯¥è¿›ç¨‹å°†æ— æ³•ç»§ç»­ã€‚ </li><li>  <code>restoreBackup()</code> ï¼šåˆ›å»ºä¸€ä¸ª<em>psql</em>è¿›ç¨‹ï¼Œä»ä¼ é€’åˆ°è¯¥æ–¹æ³•çš„InputStreamä¸­è¯»å–å¤‡ä»½ï¼Œå¹¶å°†å…¶åŒæ—¶å†™å…¥psqlæ ‡å‡†è¾“å…¥æµï¼ˆè¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://docs.oracle.com/javase/8/docs/api/java/lang/Processã€‚ htmlï¼ƒgetOutputStream--</a> ï¼‰ã€‚ ä¹‹æ‰€ä»¥å¯è¡Œï¼Œæ˜¯å› ä¸ºçº¯æ–‡æœ¬PostgreSQLå¤‡ä»½åªæ˜¯DDLå’ŒDMLå‘½ä»¤çš„é›†åˆï¼Œè¿™äº›å‘½ä»¤å¾ˆå®¹æ˜“ç†è§£psqlã€‚ </li></ol><br><p> æœ‰å¾ˆå¤šä»£ç ï¼Œå› æ­¤åœ¨è¿™é‡Œæˆ‘ä¸ä¼šç»™å‡ºï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨æœ¬æ–‡ç»“å°¾çš„é“¾æ¥åœ¨GitHubä¸Šçœ‹åˆ°å®ƒã€‚ </p></div></div><br><h3 id="processor"> å¤„ç†å™¨ </h3><br><p> è¯¥æœåŠ¡è´Ÿè´£ä½¿ç”¨å¤„ç†å™¨å’Œåå‘å¤‡ä»½é‡æ–°å¤„ç†ã€‚ åœ¨ä¸‹è½½åˆ°å­˜å‚¨ä¹‹å‰æˆ–ä»å­˜å‚¨ä¸­å¸è½½ä¹‹åï¼Œå°†ä½¿ç”¨å¤„ç†å™¨ã€‚ å¤„ç†å™¨ç¤ºä¾‹ï¼šå‹ç¼©å™¨ï¼ŒåŠ å¯†ã€‚ </p><br><p> æœåŠ¡æ¥å£ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Processor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream in)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deprocess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream in)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProcessorType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// ProcessorType -  Enum,     int getPrecedence(); //   }</span></span></code> </pre> <br><p> æ¯ä¸ªå¤„ç†å™¨éƒ½æœ‰ä¼˜å…ˆçº§-å¦‚æœæŒ‡å®šäº†å¤šä¸ªå¤„ç†å™¨ï¼Œåˆ™å°†æŒ‰ç…§ä¼˜å…ˆçº§ä»é«˜åˆ°ä½çš„é¡ºåºåº”ç”¨å®ƒä»¬ã€‚ ä»¥åº”ç”¨å¤„ç†å™¨çš„ç›¸åŒé¡ºåºåº”ç”¨é€†å‡½æ•°ï¼Œæˆ‘ä»¬å¾—åˆ°äº†åŸå§‹å¤‡ä»½ã€‚ </p><br><h3 id="storage"> è´®è— </h3><br><p> è¯¥æœåŠ¡è´Ÿè´£åŠ è½½å’Œå¸è½½å¤‡ä»½ï¼Œä»¥åŠä»å­˜å‚¨ä¸­åˆ é™¤å¤‡ä»½ã€‚ å­˜å‚¨ç¤ºä¾‹ï¼šDropboxï¼Œæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚ </p><br><p> æœåŠ¡æ¥å£ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Storage</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uploadBackup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream in, StorageSettings storageSettings, String backupName, Integer id)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadBackup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StorageSettings storageSettings, String backupName, Integer id)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteBackup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StorageSettings storageSettings, String backupName, Integer id)</span></span></span></span>; }</code> </pre> <br><p> æ¯ä¸ªåˆ›å»ºçš„å¤‡ä»½éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°-å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å°†å…¶ä¸‹è½½åˆ°çš„ä»»ä½•å­˜å‚¨ä¸Šæ‰¾åˆ°å®ƒã€‚ å°†å¤‡ä»½å‘ˆç°åˆ°å­˜å‚¨çš„æ–¹å¼å®Œå…¨å–å†³äºæœåŠ¡çš„å®ç°ï¼Œä½†æ˜¯å°†å¤‡ä»½åç§°è½¬ç§»åˆ°å…¶ä¸­ä¸€ä¸ªåŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æœŸæœ›æ­£ç¡®çš„è¡Œä¸ºã€‚  <em>StorageSettings</em>å®ä½“æ˜¯ä»Web UIé¢„å…ˆåˆ›å»ºçš„ï¼Œå¹¶å­˜å‚¨ç”¨äºè®¿é—®å­˜å‚¨å™¨çš„å¿…è¦è®¾ç½®ã€‚ </p><br><hr><br><h3 id="koncepciya-taskov"> ä»»åŠ¡æ¦‚å¿µ </h3><br><p> æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè·Ÿè¸ªä»»åŠ¡çš„çŠ¶æ€ï¼Œæ ¹æ®ä»»åŠ¡çš„è¿›åº¦å¤„ç†å¯èƒ½çš„é”™è¯¯ï¼Œä»¥åŠå–æ¶ˆä»»åŠ¡ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä»…å¤„ç†ä»»åŠ¡ã€‚ æ¯ä¸ªä»»åŠ¡å°†åœ¨æ•°æ®åº“ä¸­ç”±è¡¨ä¸­çš„è®°å½•è¡¨ç¤ºï¼Œå¹¶ä»¥ç¼–ç¨‹æ–¹å¼ç”±<strong>Future</strong>å®ä¾‹è¡¨ç¤ºï¼ˆè¯·å‚è§Java <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Future</a> ï¼‰ã€‚ è¯¥è¡¨ä¸­çš„æ¯ä¸ªè®°å½•éƒ½ä¸å…¶è‡ªå·±çš„Futureå…³è”ï¼ˆæ­¤å¤–ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œå¤šä¸ªæœåŠ¡å™¨ï¼Œåˆ™Futureå®ä¾‹å¯ä»¥ä½äºä¸åŒæœåŠ¡å™¨çš„å†…å­˜ä¸­ï¼‰ã€‚ </p><br><p> è®©æˆ‘ä»¬æŒ‰é¡ºåºå»ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€é¡¹ç”¨äºå¯åŠ¨ä»»åŠ¡çš„æœåŠ¡-åˆ›å»ºï¼Œè¿˜åŸå’Œåˆ é™¤å¤‡ä»½ã€‚ </p><br><h4 id="zapusk-zadach"> ä»»åŠ¡å¯åŠ¨ </h4><br><p>  <strong>åˆ›å»ºå¤‡ä»½ï¼š</strong> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startBackupTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull Task.RunType runType, @NotNull List&lt;String&gt; storageSettingsNameList, @Nullable List&lt;ProcessorType&gt; processors, @NotNull DatabaseSettings databaseSettings)</span></span></span><span class="hljs-function"> </span></span>{ Objects.requireNonNull(runType); Objects.requireNonNull(storageSettingsNameList); Objects.requireNonNull(processors); Objects.requireNonNull(databaseSettings); BackupProperties backupProperties = backupPropertiesManager.initNewBackupProperties(storageSettingsNameList, processors, databaseSettings.getName()); Task task = tasksManager.initNewTask(Task.Type.CREATE_BACKUP, runType, backupProperties.getId()); Integer taskId = task.getId(); Future future = tasksStarterExecutorService.submit(() -&gt; { tasksManager.updateTaskState(taskId, Task.State.CREATING); logger.info(<span class="hljs-string"><span class="hljs-string">"Creating backup..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream backupStream = databaseBackupManager.createBackup(databaseSettings, taskId)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); } tasksManager.updateTaskState(taskId, Task.State.APPLYING_PROCESSORS); logger.info(<span class="hljs-string"><span class="hljs-string">"Applying processors on created backup. Processors: {}"</span></span>, processors); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream processedBackupStream = backupProcessorManager.process(backupStream, processors)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); } tasksManager.updateTaskState(taskId, Task.State.UPLOADING); logger.info(<span class="hljs-string"><span class="hljs-string">"Uploading backup..."</span></span>); backupLoadManager.uploadBackup(processedBackupStream, backupProperties, taskId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); } tasksManager.updateTaskState(taskId, Task.State.COMPLETED); logger.info(<span class="hljs-string"><span class="hljs-string">"Creating backup completed. Backup properties: {}"</span></span>, backupProperties); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException ex) { logger.error(<span class="hljs-string"><span class="hljs-string">"Error occurred while closing input stream of created backup"</span></span>, ex); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException ex) { logger.error(<span class="hljs-string"><span class="hljs-string">"Error occurred while creating backup. Backup properties: {}"</span></span>, backupProperties, ex); errorTasksManager.addErrorTask(taskId); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ex) { tasksManager.setInterrupted(taskId); logger.error(<span class="hljs-string"><span class="hljs-string">"Backup creating task was interrupted. Task ID: {}"</span></span>, taskId); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { futures.remove(taskId); } }); futures.put(taskId, future); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> task; }</code> </pre> <br><p> åˆ›å»ºå¤‡ä»½æŒ‰ä»¥ä¸‹é¡ºåºç»å†äº†3ä¸ªä¸»è¦æ­¥éª¤ï¼šåˆ›å»ºå¤‡ä»½-&gt;å¤„ç†å™¨åº”ç”¨ç¨‹åº-&gt;ä¸Šè½½åˆ°å­˜å‚¨ã€‚ åœ¨å‡ ä¹æ‰€æœ‰æœåŠ¡æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éƒ½è½¬å‘å½“å‰ä»»åŠ¡çš„IDï¼Œä»¥ä¾¿è¯¥æœåŠ¡å¯ä»¥æŠ¥å‘Šæ¥è‡ªåå°å·¥ä½œçº¿ç¨‹çš„é”™è¯¯ã€‚ å…³äºé”™è¯¯å¤„ç†ï¼Œä¸ºä»€ä¹ˆåœ¨è¿™é‡Œå‡ºç°<em>InterruptedException</em> ï¼Œä»¥åŠåœ¨æ”¶åˆ°<em>RuntimeException</em>ä¹‹åå‡ºç°é”™è¯¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå°†åœ¨åé¢è®¨è®ºã€‚ </p><br><p> è¿™æ˜¯æˆ‘ä»¬å°†å¦‚ä½•è¿è¡Œåˆ›å»ºå¤‡ä»½çš„ä»»åŠ¡ï¼š </p><br><pre> <code class="java hljs">tasksStarterService.startBackupTask(Task.RunType.USER, storageSettingsNameList, processors, databaseSettings);</code> </pre> <br><p> æˆ‘ä»¬ä¼ é€’ç»™ä»»åŠ¡å‘èµ·è€…çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼šç”¨æˆ·æˆ–å†…éƒ¨æœåŠ¡å™¨ä»»åŠ¡ï¼ˆå†…éƒ¨ä»»åŠ¡çš„ä¸€ä¸ªç¤ºä¾‹æ˜¯å®šæœŸå¤‡ä»½ï¼‰ã€‚ ä»»åŠ¡å‘èµ·è€…çš„çŸ¥è¯†ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨Web UIä¸­ä»…æ˜¾ç¤ºç”±ç”¨æˆ·å¯åŠ¨çš„é‚£äº›ä»»åŠ¡ã€‚ å…¶ä½™å‚æ•°å¯¹äºç›´æ¥åˆ›å»ºå¤‡ä»½æ˜¯å¿…éœ€çš„-å­˜å‚¨åˆ—è¡¨ï¼Œè¦ä½¿ç”¨çš„å¤„ç†å™¨ä»¥åŠéœ€è¦åˆ›å»ºå…¶è½¬å‚¨çš„æ•°æ®åº“ã€‚ </p><br><p> åˆ›å»ºå¤‡ä»½æ—¶ï¼Œè¿˜å°†åœ¨åä¸º<strong>BackupProperties</strong>çš„æ•°æ®åº“ä¸­åˆ›å»ºä¸€æ¡è®°å½•ã€‚ è¯¥å®ä½“å°†å­˜å‚¨å¤‡ä»½å±æ€§ï¼Œä¾‹å¦‚åç§°ï¼Œä½¿ç”¨çš„å¤„ç†å™¨ä»¥åŠå°†å¤‡ä»½ä¸‹è½½åˆ°çš„å­˜å‚¨åº“åˆ—è¡¨ã€‚ æ­¤å¤–ï¼Œè¦è¿˜åŸæˆ–åˆ é™¤å¤‡ä»½ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ­¤ç‰¹å®šå®ä½“ã€‚ </p><br><p> æ•°æ®åº“ä¸­çš„ä»»åŠ¡ä»¥ä»¥ä¸‹å½¢å¼å­˜å‚¨ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"backup_tasks"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Task</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Identifier of each backup task. Identifier is generated by PostgreSQL database after saving of entity. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(insertable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, updatable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(strategy = GenerationType.IDENTITY) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-comment"><span class="hljs-comment">/** * Backup task type. * &lt;p&gt; * Type is set at the very start of any task and can't be changed. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> Type */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Enumerated</span></span>(EnumType.STRING) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(updatable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Type type; <span class="hljs-comment"><span class="hljs-comment">/** * Who initiated a task: user or server. * &lt;p&gt; * We need to know it to show on front only these tasks that was started by user. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> RunType */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Enumerated</span></span>(EnumType.STRING) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(updatable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RunType runType; <span class="hljs-comment"><span class="hljs-comment">/** * Backup task state. * &lt;p&gt; * State is updated with every new step in task being executed. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> Task.State */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Enumerated</span></span>(EnumType.STRING) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> State state; <span class="hljs-comment"><span class="hljs-comment">/** * Whether task has been interrupted or not. * &lt;p&gt; * Default is {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> false}. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(insertable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> interrupted; <span class="hljs-comment"><span class="hljs-comment">/** * Identifier of {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> BackupProperties}. * &lt;p&gt; * We need to know backup ID to be able to handle occurred errors. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(updatable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer backupPropertiesId; <span class="hljs-comment"><span class="hljs-comment">/** * Start time of the task. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(updatable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocalDateTime date; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> RunType { USER, INTERNAL } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> State { PLANNED, CREATING, RESTORING, DELETING, APPLYING_PROCESSORS, APPLYING_DEPROCESSORS, DOWNLOADING, UPLOADING, COMPLETED, } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Type { CREATE_BACKUP { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"CREATE BACKUP"</span></span>; } }, RESTORE_BACKUP { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"RESTORE BACKUP"</span></span>; } }, DELETE_BACKUP { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DELETE BACKUP"</span></span>; } } } <span class="hljs-comment"><span class="hljs-comment">// getters &amp; setters... }</span></span></code> </pre> <br><p> å› æ­¤ï¼Œæ‚¨å¯ä»¥ä»¥å›¾è¡¨çš„å½¢å¼æè¿°åˆ›å»ºå¤‡ä»½çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <br><img src="https://habrastorage.org/webt/bm/um/cy/bmumcyhyapjg4ono73qo8kiquom.png" alt="å¤‡ä»½ç¨‹åº" title="å¤‡ä»½ç¨‹åº"></p><br><hr><br><p> ç±»æ¨å¯åŠ¨å…¶ä»–ç±»å‹çš„ä»»åŠ¡ã€‚ ä¸ºäº†é¿å…ç”¨å¤§é‡ä»£ç å¼„ä¹±æ–‡ç« ï¼Œå‡ºäºå¥½å¥‡ï¼Œæˆ‘å°†æä¾›ä»£ç æ¥å¯åŠ¨ä»»åŠ¡ï¼Œä»¥åœ¨å‰§é€å™¨ä¸­åˆ†åˆ«è¿˜åŸå’Œåˆ é™¤å¤‡ä»½ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å¤‡ä»½æ¢å¤</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startRestoreTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull Task.RunType runType, @NotNull BackupProperties backupProperties, @NotNull String storageSettingsName, @NotNull DatabaseSettings databaseSettings)</span></span></span><span class="hljs-function"> </span></span>{ Objects.requireNonNull(runType); Objects.requireNonNull(backupProperties); Objects.requireNonNull(storageSettingsName); Objects.requireNonNull(databaseSettings); Task task = tasksManager.initNewTask(Task.Type.RESTORE_BACKUP, runType, backupProperties.getId()); Integer taskId = task.getId(); Future future = tasksStarterExecutorService.submit(() -&gt; { tasksManager.updateTaskState(taskId, Task.State.DOWNLOADING); logger.info(<span class="hljs-string"><span class="hljs-string">"Downloading backup..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream downloadedBackup = backupLoadManager.downloadBackup(backupProperties.getBackupName(), storageSettingsName, taskId)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted() || downloadedBackup == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); } tasksManager.updateTaskState(taskId, Task.State.APPLYING_DEPROCESSORS); logger.info(<span class="hljs-string"><span class="hljs-string">"Deprocessing backup..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream deprocessedBackup = backupProcessorManager.deprocess(downloadedBackup, backupProperties.getProcessors())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); } tasksManager.updateTaskState(taskId, Task.State.RESTORING); logger.info(<span class="hljs-string"><span class="hljs-string">"Restoring backup..."</span></span>); databaseBackupManager.restoreBackup(deprocessedBackup, databaseSettings, taskId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); } tasksManager.updateTaskState(taskId, Task.State.COMPLETED); logger.info(<span class="hljs-string"><span class="hljs-string">"Restoring backup completed. Backup properties: {}"</span></span>, backupProperties); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException ex) { logger.error(<span class="hljs-string"><span class="hljs-string">"Error occurred while closing input stream of downloaded backup"</span></span>, ex); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException ex) { logger.info(<span class="hljs-string"><span class="hljs-string">"Error occurred while restoring backup. Backup properties: {}"</span></span>, backupProperties, ex); errorTasksManager.addErrorTask(taskId); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ex) { tasksManager.setInterrupted(taskId); logger.error(<span class="hljs-string"><span class="hljs-string">"Task was interrupted. Task ID: {}"</span></span>, taskId); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { futures.remove(taskId); } }); futures.put(taskId, future); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> task; }</code> </pre> <br><p> è¿˜åŸå¤‡ä»½æŒ‰ä»¥ä¸‹é¡ºåºç»å†äº†3ä¸ªä¸»è¦æ­¥éª¤ï¼šä»å­˜å‚¨ä¸­å¸è½½å¤‡ä»½-&gt;ä½¿ç”¨è§£å¤„ç†å™¨è·å¾—åŸå§‹çš„çº¯æ–‡æœ¬å¤‡ä»½-&gt;è¿˜åŸå¤‡ä»½ã€‚ </p><br><p> å¼€å§‹æ¢å¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="java hljs">tasksStarterService.startRestoreTask(Task.RunType.USER, backupProperties, storageSettingsName, databaseSettings);</code> </pre> <br><p> ä»¥å›¾è¡¨å½¢å¼è¿˜åŸå¤‡ä»½çš„è¿‡ç¨‹ï¼š <br><img src="https://habrastorage.org/webt/hr/_m/bk/hr_mbkvfkszhyhj6ebi1q_wa1nc.png" alt="  " title="å¤‡ä»½æ¢å¤è¿‡ç¨‹"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">åˆ é™¤å¤‡ä»½</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startDeleteTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull Task.RunType runType, @NotNull BackupProperties backupProperties)</span></span></span><span class="hljs-function"> </span></span>{ Objects.requireNonNull(runType); Objects.requireNonNull(backupProperties); Task task = tasksManager.initNewTask(Task.Type.DELETE_BACKUP, runType, backupProperties.getId()); Integer taskId = task.getId(); Future future = tasksStarterExecutorService.submit(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { logger.info(<span class="hljs-string"><span class="hljs-string">"Deleting backup started. Backup properties: {}"</span></span>, backupProperties); tasksManager.updateTaskState(taskId, Task.State.DELETING); backupLoadManager.deleteBackup(backupProperties, taskId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); } tasksManager.updateTaskState(taskId, Task.State.COMPLETED); logger.info(<span class="hljs-string"><span class="hljs-string">"Deleting backup completed. Backup properties: {}"</span></span>, backupProperties); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException ex) { logger.error(<span class="hljs-string"><span class="hljs-string">"Error occurred while deleting backup. Backup properties: {}"</span></span>, backupProperties, ex); errorTasksManager.addErrorTask(taskId); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ex) { tasksManager.setInterrupted(taskId); logger.error(<span class="hljs-string"><span class="hljs-string">"Task was interrupted. Task ID: {}"</span></span>, taskId); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { futures.remove(taskId); } }); futures.put(taskId, future); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> task; }</code> </pre> <br><p> åˆ é™¤å¤‡ä»½çš„è¿‡ç¨‹éå¸¸ç®€å•ï¼šåªéœ€å°†å¤‡ä»½ä»å…¶ä¸‹è½½åˆ°çš„æ‰€æœ‰å­˜å‚¨ä¸­åˆ é™¤ã€‚ </p><br><p> è¿è¡Œå¸è½½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="java hljs">tasksStarterService.startDeleteTask(Task.RunType.USER, backupProperties);</code> </pre> <br><p> ä»¥å›¾è¡¨å½¢å¼åˆ é™¤å¤‡ä»½çš„è¿‡ç¨‹ï¼š <br><img src="https://habrastorage.org/webt/y4/ca/yp/y4cayp76w4v0tx8umvzcp6flzd4.png" alt="  " title="å¤‡ä»½åˆ é™¤è¿‡ç¨‹"></p></div></div><br><hr><br><h3 id="otmena-taskov"> å–æ¶ˆä»»åŠ¡ </h3><br><p> ä»€ä¹ˆæ˜¯ä»»åŠ¡å–æ¶ˆï¼Ÿ å½“ç„¶ï¼Œè¿™æ— éæ˜¯çº¿ç¨‹ç»ˆæ­¢ã€‚ æ‚¨ä¼šçœ‹åˆ°ï¼Œåœ¨Futureä¸­è¿è¡Œçš„æ‰€æœ‰ä¸»è¦ä»£ç éƒ½åŒ…è£…åœ¨ä»¥ä¸‹try-catchæ„é€ ä¸­ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ex) { ... tasksManager.setInterrupted(taskId); }</code> </pre> <br><p> å¹¶ä¸”åœ¨æ¯ç§é‡è¦æ–¹æ³•ï¼ˆæˆ‘ä»¬æ§åˆ¶å…¶æ‰§è¡Œæµç¨‹ï¼‰ä¹‹åï¼Œéƒ½å®‰è£…äº†ä»¥ä¸‹ç»“æ„ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InterruptedException(); }</code> </pre> <br><p> åœ¨ç»§ç»­ä¹‹å‰ï¼Œåº”è¯¥ç»™å‡ºJVMçº¿ç¨‹çš„ä¸­æ–­å’ŒçŠ¶æ€çš„ç®€è¦ç†è®ºã€‚ </p><br><p>  JVMä¸­çš„çº¿ç¨‹å¯ä»¥å…·æœ‰ä»¥ä¸‹çŠ¶æ€ï¼š </p><br><ol><li> æ–°å“ </li><li> å¯è¿è¡Œ </li><li> å®šæ—¶ç­‰å¾… </li><li> ç­‰å¾…ä¸­ </li><li> å—é˜» </li><li> å·²ç»ˆæ­¢ </li></ol><br><p> æˆ‘ä»¬ä»…å¯¹ç­‰å¾…å’Œå®šæ—¶ç­‰å¾…çŠ¶æ€æ„Ÿå…´è¶£ã€‚ é€šè¿‡<code>Object.wait()</code> ï¼Œ <code>Thread.join()</code>ç­‰æ–¹æ³•å°†<code>Object.wait()</code> <em>Waiting</em>çŠ¶æ€ã€‚ ä½¿ç”¨<code>Object.wait(timeout)</code> ï¼Œ <code>Thread.join(timeout)</code> ï¼Œ <code>Thread.sleep(sleeping)</code>å’Œå…¶ä»–æ–¹æ³•å°†çº¿ç¨‹ç½®äº<em>Timedç­‰å¾…</em>çŠ¶æ€ï¼ˆå³ï¼ŒæŒç»­ä¸€å®šæ—¶é—´çš„ç­‰å¾…<code>Thread.sleep(sleeping)</code> ã€‚ </p><br><p> è¿™é‡Œæœ€é‡è¦çš„æ˜¯ï¼Œå¦‚æœ<em>åœ¨è¿›å…¥</em> Waitingæˆ–Timedç­‰å¾…<em>çŠ¶æ€</em> <em>ä¹‹å‰</em>ä¸­æ–­çº¿ç¨‹ï¼Œæˆ–è€…å½“çº¿ç¨‹<em>å¤„äºæ­¤çŠ¶æ€æ—¶</em> ï¼Œçº¿ç¨‹å°†å”¤é†’ï¼Œå¹¶æŠ›å‡º<strong>InterruptedException</strong> ã€‚ </p><br><p> ä½†è¿™è¿˜ä¸æ˜¯å…¨éƒ¨ã€‚ é€šè¿‡åˆ›å»ºï¼Œè¿˜åŸæˆ–åˆ é™¤å¤‡ä»½ï¼Œçº¿ç¨‹æ ¹æœ¬ä¸ä¼šè¿›å…¥çŠ¶æ€æ•°æ®ã€‚ ç„¶åå¦‚ä½•é€šçŸ¥çº¿ç¨‹å®ƒè¢«ä¸­æ–­äº†ï¼Ÿ </p><br><p> ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨Thread.interrupted <code>Thread.interrupted()</code>æˆ–<code>Thread.currentThread.isInterrupted()</code>æ–¹æ³•ç‹¬ç«‹æ£€æŸ¥çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ã€‚ ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œç¬¬ä¸€ä¸ªè°ƒç”¨ç§æœ‰æœ¬æœºæ–¹æ³•<code>currentThread.isInterrupted(boolean ClearInterrupted)</code> ï¼Œ <code>currentThread.isInterrupted(boolean ClearInterrupted)</code>ä¼ é€’<code>true</code> ï¼Œè¡¨ç¤ºå°†æ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œè€Œç¬¬äºŒä¸ªä¼ é€’<code>false</code> ï¼Œä½¿ä¸­æ–­æ ‡å¿—ä¿æŒä¸å˜ã€‚ è¿™ä¸¤ç§æ–¹æ³•ä¹‹é—´çš„é€‰æ‹©å®Œå…¨å–å†³äºæƒ…å†µã€‚ å½“æŠ›å‡ºInterruptedExceptionæ—¶ï¼Œä¸­æ–­æ ‡å¿—ä¹Ÿä¼šè¢«æ¸…é™¤-è¿™å€¼å¾—è®°ä½ã€‚ </p><br><p> ä½†æ˜¯å¿…é¡»æœ‰ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•-ç¡®å®å¦‚æ­¤ã€‚ åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œä½¿ç”¨I / Oæµä»¥åŠä½¿ç”¨I / Oæ–¹æ³•çš„å·¥ä½œé‡å¾ˆå¤§ã€‚ æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯ç¡®ä¿åœ¨I / Oæµä¸Šè°ƒç”¨<code>read()</code>æˆ–<code>write(int b)</code>æ–¹æ³•æ—¶ï¼Œåœ¨ä¸­æ–­è¿‡ç¨‹ä¸­å¼•å‘é”™è¯¯ï¼Œé€šçŸ¥é˜»å¡çš„I / Oè°ƒç”¨å·²ä¸­æ–­ã€‚ å¹¸è¿çš„æ˜¯ï¼ŒJavaæœ‰ä¸€ä¸ªå¼‚å¸¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-InterruptedIOException</a> ã€‚ ä½†æ˜¯ï¼Œå¹¶éæ‰€æœ‰è¯»/å†™æµæ–¹æ³•éƒ½ç›‘è§†çº¿ç¨‹ä¸­æ–­ï¼Œç‰¹åˆ«æ˜¯ä»…<em>PipedInputStream</em>ç›‘è§†å®ƒã€‚ å› æ­¤ï¼Œåœ¨ä¸æ¶‰åŠè¯¥æµçš„é‚£äº›åœ°æ–¹ï¼Œæˆ‘ä»¬å¿…é¡»æ‰©å±•è¯»/å†™æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨å‘ç”Ÿä¸­æ–­æ—¶å¼•å‘InterruptedIOExceptionã€‚ å®é™…ä¸Šï¼Œåœ¨æˆ‘çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä»…åœ¨ä¸€ä¸ªåœ°æ–¹å¯¹æˆ‘æ¥è¯´ï¼Œreadï¼ˆï¼‰æ–¹æ³•çš„æ‰©å±•å°±è¶³å¤Ÿäº†-å½“InputStreamä»å¤‡ä»½ä¸Šä¼ æ–¹æ³•è¿”å›æ—¶ã€‚ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥äº†è§£ä¸­æ–­çš„èµ·æºï¼Œè€Œä¸å¿…åœ¨ä»»ä½•åœ°æ–¹å¯¹æ ‡å¿—è¿›è¡Œæ¨¡æ¿æ£€æŸ¥ã€‚ ä½†æ˜¯ï¼Œå°†æ­¤å¼‚å¸¸ä¸IOExceptionåˆ†å¼€æ•è·å¹¶åˆ†åˆ«å¤„ç†æ˜¯å¾ˆé‡è¦çš„ã€‚ å½“ç„¶ï¼Œåœ¨æŸäº›åœ°æ–¹ï¼Œå¦‚æœä¸èƒ½å€ŸåŠ©æ ‡å¿—çš„æ¨¡æ¿æ£€æŸ¥å°±æ— æ³•åšï¼Œä½†æ˜¯å®ƒå·²ç»å˜å¾—æ›´å¥½ã€‚ </p><br><p> åŒæ ·é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œå¦‚æœåœ¨ä¸­æ–­å¤„ç†æœŸé—´æ¸…é™¤äº†è¯¥æ ‡å¿—ï¼Œåˆ™å§‹ç»ˆæœ‰å¿…è¦å†æ¬¡è®¾ç½®è¯¥ä¸­æ–­æ ‡å¿—ï¼Œä»¥ä¾¿ä»è¯¥æ–¹æ³•è¿”å›åï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾å‡ºå‘ç”Ÿçš„ä¸­æ–­ã€‚ </p><br><p> è®©æˆ‘ä¸¾ä¾‹è¯´æ˜ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ã€‚ å‡è®¾æˆ‘ä»¬ä½¿ç”¨uploadï¼ˆï¼‰æ–¹æ³•å°†å¤‡ä»½ä¸Šä¼ åˆ°å­˜å‚¨ä¸­ï¼Œå¹¶ä¸”å‘ç”Ÿäº†ä¸­æ–­ã€‚ å¤„ç†ä¸­æ–­ï¼Œå·¥ä½œåœæ­¢ï¼Œæ–¹æ³•è¿”å›ã€‚ ä¸­æ–­ä¸ä¼šéšéšä¾¿ä¾¿å‘ç”Ÿ-è¿™æ„å‘³ç€é”™è¯¯å‘ç”Ÿåœ¨æŸä¸ªåœ°æ–¹ï¼Œæˆ–è€…ç”¨æˆ·å–æ¶ˆäº†ä»»åŠ¡ã€‚ æ— è®ºå‡ºäºä½•ç§åŸå› ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»åœ¨æ­¤æœªæ¥ä¸­åœæ­¢æ‰€æœ‰å·¥ä½œã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨åœ¨ä»å¼•å¯¼æ–¹æ³•è¿”å›ä¹‹å‰æ²¡æœ‰å†æ¬¡è®¾ç½®ä¸­æ–­æ ‡å¿—ï¼Œåˆ™åœ¨Futureä¸»å—ä¸­æˆ‘ä»¬å°†æ°¸è¿œä¸ä¼šçŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆä¸­æ–­ã€‚ <br> ç›¸åŒçš„ä»£ç ç¤ºä¾‹ï¼š </p><br><pre> <code class="java hljs">backupLoadManager.uploadBackup(processedBackupStream, backupProperties, taskId); &lt;-   ,       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.interrupted()) { <span class="hljs-comment"><span class="hljs-comment">//      ,      - ,    throw new InterruptedException(); }</span></span></code> </pre> <br><p> å› æ­¤ï¼Œä¼˜è‰¯ä½œæ³•æ˜¯æŒ‰ä»¥ä¸‹æ–¹å¼å¤„ç†<strong>InterruptedException</strong>æˆ–<strong>InterruptedIOException</strong> ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { <span class="hljs-comment"><span class="hljs-comment">//  InterruptedIOException ... // re-interrupt the thread Thread.currentThread().interrupt(); }</span></span></code> </pre> <br><p> å¥½å§ï¼Œæˆ‘ä»¬å¯ä»¥å¤„ç†ä¸­æ–­ï¼Œä½†æ˜¯è°ä¼šçœŸæ­£ä¸­æ–­çº¿ç¨‹ï¼Ÿ <br> ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå¦ä¸€ä¸ªåä¸º<em>CancelTaskâ€‹â€‹çš„</em>å®ä½“ï¼Œè¯¥å®ä½“å°†å­˜å‚¨è¦å–æ¶ˆçš„ä»»åŠ¡çš„IDï¼Œå¹¶ç¼–å†™ä¸€ä¸ªæ‰‹è¡¨æ¥å°è¯•ä¸­æ–­ä»»åŠ¡ã€‚ ä¸ºä»€ä¹ˆè¦å°è¯•ï¼Ÿ å› ä¸ºï¼š </p><br><ol><li> æ— æ³•ç»ˆæ­¢å¦ä¸€å°æœåŠ¡å™¨çš„å†…å­˜ä¸­çš„çº¿ç¨‹ã€‚ å‡ ä¸ªæœåŠ¡å™¨å¯ä»¥ä¸ºæˆ‘ä»¬å·¥ä½œï¼Œè¿™æ„å‘³ç€Futureåˆ†æ•£åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚ å› æ­¤ï¼Œå½“å–æ¶ˆä»»åŠ¡çš„è¯·æ±‚åˆ°è¾¾å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨æ—¶ï¼Œæ‰€éœ€çš„Futureå¯èƒ½åœ¨å¦ä¸€å°æœåŠ¡å™¨çš„å†…å­˜ä¸­ã€‚ </li><li> ç”±äºç”±äºæœåŠ¡å™¨å´©æºƒè€Œä¸¢å¤±äº†Futureï¼Œå› æ­¤æ— æ³•å–æ¶ˆä»»åŠ¡ã€‚ </li></ol><br><p> ç®€è¦ä»‹ç»ä¸€ä¸‹æ™šä¸Šçš„å–æ¶ˆç®—æ³•ï¼š <br>  Watercherä»<em>cancel_tasks</em>è¡¨ä¸­å–å‡ºæ‰€æœ‰è®°å½•ï¼ˆåŒæ—¶æœªè®¾ç½®é”ï¼‰ï¼Œé€ä¸€æ£€æŸ¥å¹¶å°è¯•ä»å…¶å†…å­˜ä¸­è·å–ç›¸åº”çš„Futureã€‚ å¦‚æœæˆåŠŸæ¥æ”¶åˆ°Futureï¼Œåˆ™å°†ä¸­æ–­ç›¸åº”çš„çº¿ç¨‹ï¼Œè¿˜åŸä»»åŠ¡å¹¶å°†è¯·æ±‚ä»è¡¨ä¸­åˆ é™¤ã€‚ å¦‚æœè¶…è¿‡äº†å–æ¶ˆä»»åŠ¡çš„è¶…æ—¶è¯·æ±‚ï¼ˆè¿™æ„å‘³ç€æœåŠ¡å™¨å´©æºƒäº†ï¼Œå¹¶ä¸”Futureä¸¢å¤±äº†ï¼‰ï¼Œåˆ™åªéœ€ä»è¡¨ä¸­åˆ é™¤è¯¥è¯·æ±‚å³å¯ã€‚ å¦‚æœå¤šä¸ªæœåŠ¡å™¨æ³¨æ„åˆ°è¶…æ—¶å¹¶ä»è¡¨ä¸­åˆ é™¤è®°å½•ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿä»»ä½•ä¸è‰¯æƒ…å†µï¼Œå› ä¸ºPostgreSQLä¸­çš„åˆ é™¤æ˜¯å¹‚ç­‰çš„ã€‚ </p><br><p>  <strong>CancelTaskâ€‹â€‹sWatcherä»£ç ï¼š</strong> </p><br><div class="spoiler">  <b class="spoiler_title">éšè—æ–‡å­—</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * This class scans for tasks to cancel and tries to cancel them. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CancelTasksWatcher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger logger = LoggerFactory.getLogger(CancelTasksWatcher.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Duration cancelTimeout = Duration.ofMinutes(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CancelTasksManager cancelTasksManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TasksStarterService tasksStarterService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TasksManager tasksManager; <span class="hljs-comment"><span class="hljs-comment">// spring setters... /** * This watcher wakes up every time 10 seconds passed from the last completion, checks if there are any tasks to cancel and tries to * cancel each task. * &lt;p&gt; * Since there are can be working more that one instance of the program, {@literal Future} instance of task can belong to different * servers. We can't get access to {@literal Future} if it's not in memory of the server where task cancellation request was accepted. * So the purpose of this watcher is to be able cancel tasks that works in the other instance of program. Each server has this watcher * checking for available cancellation requests and if any, the watcher tries to cancel corresponding {@literal Future}. * If cancellation is successful task will be also reverted. * &lt;p&gt; * If task cancellation request timeout exceeded, then it means a server that had requested {@literal Future} instances has been * shutdown, so all {@literal Future} instances lost and task can't be canceled. In such case task cancellation request will be ignored. * * @see TasksStarterService#getFuture(Integer) * @see TasksManager#revertTask(Task) */ @Scheduled(fixedDelay = 10 * 1000) @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRES_NEW) public void watchTasksToCancel() { Iterable&lt;CancelTask&gt; cancelTasks = cancelTasksManager.findAll(); Iterable&lt;Task&gt; tasks = tasksManager.findAllById(StreamSupport.stream(cancelTasks.spliterator(), false) .map(CancelTask::getTaskId).collect(Collectors.toList())); Map&lt;Integer, Task&gt; tasksAsMap = StreamSupport.stream(tasks.spliterator(), false) .collect(Collectors.toMap(Task::getId, Function.identity())); List&lt;Integer&gt; taskIdsForDeleting = new ArrayList&lt;&gt;(); for (CancelTask cancelTask : cancelTasks) { Integer taskId = cancelTask.getTaskId(); Task task = tasksAsMap.get(taskId); if (task == null) { logger.error("Can't cancel task: no such entity with ID {}", taskId); taskIdsForDeleting.add(taskId); continue; } // timeout exceeded, that is server shutdown and lost all Future instances, so task can't be canceled if (LocalDateTime.now(ZoneOffset.UTC).isAfter(cancelTask.getPutTime().plus(cancelTimeout))) { logger.error("Can't cancel task: timeout exceed. Task ID: {}", taskId); taskIdsForDeleting.add(taskId); continue; } tasksStarterService.getFuture(taskId).ifPresent(future -&gt; { logger.info("Canceling task with ID {}", taskId); boolean canceled = future.cancel(true); if (canceled) { try { // give time to properly handle interrupt Thread.sleep(10000); } catch (InterruptedException e) { // should not happen } tasksManager.revertTask(task); } taskIdsForDeleting.add(taskId); logger.info("Task canceled: {}. Task ID: {}", canceled, taskId); }); } cancelTasksManager.deleteByTaskIdIn(taskIdsForDeleting); } }</span></span></code> </pre> </div></div><br><hr><br><h4 id="obrabotka-oshibok"> é”™è¯¯å¤„ç† </h4><br><p>    ,    ,   Future,    try-catch : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException e) { ... errorTasksManager.addErrorTask(taskId); }</code> </pre> <br><p>     <em>RuntimeException</em>   ,     Future  ,         . </p><br><p>  <code>addErrorTask(taskId)</code>        ,   ID ,    . <br>      ?       ,    ,        ,   . </p><br><p>      : <br>                  ,        ,       .  â€”  PostgreSQL <code>select for update</code> ,   select   <code>skip locked</code>      . ,  ,    <code>revertTask()</code> ,               . </p><br><p> <strong> ErrorTasksWatcher</strong> : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * This class scans for erroneous tasks and handles them depending on their state. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ErrorTasksWatcher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger logger = LoggerFactory.getLogger(ErrorTasksWatcher.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Integer nRows = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TasksManager tasksManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ErrorTasksManager errorTasksManager; <span class="hljs-comment"><span class="hljs-comment">// spring setters... /** * This watcher wakes up every time 1 minute passed from the last completion, checks backup states periodically and handles erroneous * tasks if any. * &lt;p&gt; * The watcher handles at most N tasks as described by {@link #nRows} constant and skips already locked tasks. * When retrieving error tasks from database pessimistic lock is set. It allows safely run more than one copy of program, as no other * watcher can pick up already being handled error tasks. * &lt;p&gt; * If the server shutdowns while rows was locked, transaction will be rolled back and lock released, so these entities can be picked * up by the other running server. */ @Scheduled(fixedDelay = 60 * 1000) @Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRES_NEW) public void watchErrorTasks() { for (ErrorTask errorTask : errorTasksManager.findFirstNAndLock(nRows)) { if (!errorTask.isErrorHandled()) { Integer backupTaskId = errorTask.getTaskId(); Optional&lt;Task&gt; optionalTask = tasksManager.findById(backupTaskId); if (!optionalTask.isPresent()) { logger.info("Can't handle erroneous task: no corresponding backup task entity. Backup task ID: {}", backupTaskId); continue; } tasksManager.revertTask(optionalTask.get()); errorTask.setErrorHandled(true); } } } }</span></span></code> </pre> </div></div><br><p> <strong> <code>revertTask(Task)</code> :</strong> </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * This function reverts erroneous task by its entity. * &lt;p&gt; * Use this function only after canceling related {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@literal</span></span></span><span class="hljs-comment"> Future}. * &lt;p&gt; * If the task was of the type {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> Task.Type#CREATE_BACKUP} then related {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> BackupProperties} will be deleted. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> task the entity */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">revertTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull Task task)</span></span></span><span class="hljs-function"> </span></span>{ Objects.requireNonNull(task); Task.State state = task.getState(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DOWNLOADING: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> APPLYING_DEPROCESSORS: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> RESTORING: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DELETING: { logger.info(<span class="hljs-string"><span class="hljs-string">"Handling broken operation. Operation: {}. No extra actions required"</span></span>, state.toString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CREATING: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> APPLYING_PROCESSORS: { logger.info(<span class="hljs-string"><span class="hljs-string">"Handling broken operation. Operation: {}. Delete backup properties..."</span></span>, state.toString()); Integer backupPropertiesID = task.getBackupPropertiesId(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!backupPropertiesManager.existsById(backupPropertiesID)) { logger.error(<span class="hljs-string"><span class="hljs-string">"Can't revert task: no related backup properties. Task info: {}"</span></span>, task); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } backupPropertiesManager.deleteById(backupPropertiesID); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> UPLOADING: { logger.info(<span class="hljs-string"><span class="hljs-string">"Handling broken operation. Operation: {}. Deleting backup from storage..."</span></span>, state); Integer backupPropertiesId = task.getBackupPropertiesId(); Optional&lt;BackupProperties&gt; optionalBackupProperties = backupPropertiesManager.findById(backupPropertiesId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!optionalBackupProperties.isPresent()) { logger.error(<span class="hljs-string"><span class="hljs-string">"Can't revert task: no related backup properties. Task info: {}"</span></span>, task); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } tasksStarterService.startDeleteTask(Task.RunType.INTERNAL, optionalBackupProperties.get()); backupPropertiesManager.deleteById(backupPropertiesId); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { logger.error(<span class="hljs-string"><span class="hljs-string">"Can't revert task: unknown state. Task info: {}"</span></span>, task); } } }</code> </pre> <br><p>   : </p><br><ol><li>     <em>DOWNLOADING</em> , <em>APPLYING_DEPROCESSORS</em> , <em>RESTORING</em> , <em>DELETING</em> â€”    .      ,       . </li><li>     <em>CREATING</em> , <em>APPLYING_PROCESSORS</em> â€”  ,       .      BackupProperties  ,       ( BackupProperties   Web UI    ). </li><li>     <em>UPLOADING</em> â€”       .        BackupProperties   ,       .       . </li></ol></div></div><br><p> ,    .         ,    ? ,   ,    Future (  1),     ,          InputStream (  2). ,      2,   1            2    ? </p><br><p>  ,     ,    ,       .      Future (    1)     : </p><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull Throwable t, @NotNull Integer taskId)</span></span></span><span class="hljs-function"> </span></span>{ logger.error(<span class="hljs-string"><span class="hljs-string">"Exception caught. Task ID: {}"</span></span>, taskId, t); Optional&lt;Future&gt; optionalFuture = tasksStarterService.getFuture(taskId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!optionalFuture.isPresent()) { logger.error(<span class="hljs-string"><span class="hljs-string">"Can't cancel the Future of task with ID {}: no such Future instance"</span></span>, taskId); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> canceled = optionalFuture.get().cancel(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!canceled) { logger.error(<span class="hljs-string"><span class="hljs-string">"Error canceling the Future of task with ID {}"</span></span>, taskId); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { logger.info(<span class="hljs-string"><span class="hljs-string">"Task canceled. Task ID: {}"</span></span>, taskId); errorTasksManager.setError(taskId); } } }</code> </pre> <br><p>   ,     ,      ID  ,   ,    Future   -  ,  ID     . </p><br><p>    ,          ,     ,     ,         ,          . </p><br><p> <strong>  ,   :</strong> </p><br><p> ,   ,        ,    .       â€”       Future. </p><br><p>   ,      ,    ,      I/O ,          â€”     /   .     ,      .       : </p><br><ol><li>  ,  .     ,      â€”     . </li><li>     â€”     Future   ,   .  , /   ,  ,     (  ,     â€”    IOException  ,        ,   ). </li></ol><br><p>  ,   â€”            (   ID       ,  ,    ),        . </p><br><hr><br><p>  ,    ,        .      ,    ,             . </p><br><h3 id="plany-na-buduschee">    </h3><br><ol><li>  Web UI:   ,   .     ,      </li><li>     </li><li>      </li><li>     </li><li>     </li></ol><br><h3 id="zaklyuchenie"> ç»“è®º </h3><br><p>   : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>GitHub</strong></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>Docker Hub</strong></a> </li></ul><br><p>   ,   !           ,       GitHub! <br></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN459478/">https://habr.com/ru/post/zh-CN459478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN459464/index.html">Luaåœ¨è«æ–¯ç§‘2019ï¼šé‡‡è®¿ç½—ä¼¯æ‰˜Â·è€¶è·¯æ’’å†·</a></li>
<li><a href="../zh-CN459466/index.html">Luaåœ¨è«æ–¯ç§‘2019ï¼šé‡‡è®¿Roberto Ierusalimschy</a></li>
<li><a href="../zh-CN459470/index.html">ç¬¬4éƒ¨åˆ†ï¼šä»åœ¨RISC-Vä¸Šè¿è¡ŒLinux RISC-V</a></li>
<li><a href="../zh-CN459472/index.html">Heroku + Docker +æ˜¥å­£å¯åŠ¨</a></li>
<li><a href="../zh-CN459474/index.html">å¦‚ä½•åœ¨ä¸€ç§’é’Ÿå†…å®Œæˆå®Œç¾é”®å…¥çš„æ–‡æœ¬ï¼šWordä¸­çš„å®ï¼Œé€‚åˆé‚£äº›å†™å¾ˆå¤šä¸œè¥¿çš„äºº</a></li>
<li><a href="../zh-CN459480/index.html">Vivaldiï¼šæµè§ˆå™¨å¦‚ä½•èµšé’±ï¼Ÿ</a></li>
<li><a href="../zh-CN459482/index.html">æˆ‘ä»¬å¦‚ä½•å‡»è´¥ç±»åˆ«æ ‘</a></li>
<li><a href="../zh-CN459484/index.html">ä¸€ä»£Arduinoã€‚ ç°ä»£å­¦ç”Ÿå‘æ˜äº†ä»€ä¹ˆ</a></li>
<li><a href="../zh-CN459488/index.html">RoguelikeèƒŒæ™¯ä¸‹çš„ç‰¹æ®Šæ¸¸æˆæ¨¡å¼</a></li>
<li><a href="../zh-CN459490/index.html">CRMä¾›åº”å•†çš„è‚®è„æŠ€å·§ï¼šæ‚¨ä¼šè´­ä¹°æ²¡æœ‰è½¦è½®çš„æ±½è½¦å—ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>