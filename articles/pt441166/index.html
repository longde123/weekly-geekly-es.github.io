<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê± üéì üå± Obtemos a senha mestra do gerenciador de senhas bloqueadas 1Password 4 ü§òüèæ üö≥ üçù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Novas ferramentas, m√©todos antigos. Fazemos engenharia reversa e descobrimos a falha fatal do 1Password. 

 Todo mundo adora gerenciadores de senhas. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Obtemos a senha mestra do gerenciador de senhas bloqueadas 1Password 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441166/">  <b>Novas ferramentas, m√©todos antigos.</b>  <b>Fazemos engenharia reversa e descobrimos a falha fatal do 1Password.</b> <br><br>  Todo mundo adora gerenciadores de senhas.  Eles s√£o √≥timos por muitas raz√µes.  Pessoalmente, tenho mais de 200 entradas no gerente.  Com tantos dados confidenciais em um s√≥ lugar, √© importante entender a extens√£o do dano se o seu registro estiver comprometido, seja malware, explora√ß√£o ou apenas um computador sem vigil√¢ncia por v√°rios minutos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Washington Post</a> publicou recentemente um artigo baseado em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estudo</a> .  Este artigo ajuda a conscientizar as pessoas de que nem todos os gerenciadores de senhas s√£o iguais. <br><br>  Eu acreditava firmemente que um gerenciador de senhas bloqueadas estava bem protegido.  Se algu√©m obtiver acesso ao meu computador, o m√°ximo poder√° contar com um monte de bytes aleat√≥rios, pois as informa√ß√µes s√£o apagadas da mem√≥ria de forma confi√°vel. <br><a name="habracut"></a><br>  Isso √© verdade para o 1Password 4 (observe que a vers√£o mais recente √© a s√©tima hoje).  Antes de mudar para ele h√° alguns anos, verifiquei se realmente n√£o havia senhas quando o gerente estava bloqueado.  Portanto, em caso de comprometimento, o invasor precisar√° lidar com o armazenamento criptografado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/527/994/2ed/5279942edfcbb8687d113731500b6953.png"></div><br>  <i><font color="gray">O cofre est√° trancado!</font></i> <br><br>  Nesse estado, n√£o h√° entradas de senha ou senha mestre.  Muito razo√°vel e correto, e o 1Password 4 passou neste teste.  Ou n√£o? <br><br>  Para me livrar dos detalhes chatos, direi imediatamente: conseguimos restaurar a senha mestra de uma inst√¢ncia bloqueada no 1Password 4, como mostrado abaixo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ad/2c0/d81/0ad2c0d817dd2dc75a942e5b2bd5b974.gif"><br>  <i><font color="gray">Desbloqueie o 1Password 4 e recupere sua senha mestra</font></i> <br><br>  A anima√ß√£o mostra que 1Password 4 √© primeiro desbloqueado da maneira normal e depois bloqueado.  Depois disso, executamos nosso utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">multipass</a> , que recupera a senha com √™xito.  O utilit√°rio explora o processamento incorreto do campo de entrada da senha no 1Password 4 para restaurar o buffer de senha mestre ofuscado, desofusc√°-lo, desbloquear automaticamente o 1Password 4 e, finalmente, exibir a senha mestre no console. <br><br><h1>  Detalhes chatos </h1><br>  A primeira etapa na avalia√ß√£o de um gerenciador de senhas √© verificar uma senha mestra limpa na mem√≥ria.  Isso √© poss√≠vel em qualquer editor hexadecimal capaz de interagir com o espa√ßo na mem√≥ria do processo.  Por exemplo, o editor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HxD</a> gratuito.  Use-o para abrir o espa√ßo de mem√≥ria 1Password 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/38d/87b/b48/38d87bb48b7c4b87f39e44a990cd3f74.png"></div><br><br>  Ca√≠mos imediatamente na primeira √°rea leg√≠vel do espa√ßo de mem√≥ria 1Password 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ef4/e95/f2d/ef4e95f2d092a6f236ba53fdfd090787.png"></div><br>  <i><font color="gray">Exemplo de representa√ß√£o de mem√≥ria HxD</font></i> <br><br>  Nada de especial ainda.  Mas voc√™ pode fazer uma pesquisa.  Por exemplo, como √© a situa√ß√£o se voc√™ digitar a senha na janela de desbloqueio 1Password 4, mas n√£o clicar no bot√£o "Desbloquear": <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e6c/d9c/08b/e6cd9c08bee8130e7775a51bd7a91ad0.png"></div><br>  <i><font color="gray">Cofre bloqueado 1Password 4 com a senha mestra inserida no campo</font></i> <br><br>  Certamente a senha est√° em algum lugar na mem√≥ria? <br><br>  Abrimos o HxD, mas procurar uma linha com nossa senha mestre (‚ÄúZ3Superpass #‚Äù) n√£o produz resultados. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b41/066/2c0/b410662c04b7e3d642f05ef94eacc7da.png"></div><br><br>  Parece que o 1Password de alguma forma criptografa ou ofusca o formul√°rio quando ele √© digitado.  Se o procedimento funcionar corretamente, est√° tudo bem. <br><br><h1>  Mergulhando mais fundo </h1><br>  Para descobrir por que a senha mestra n√£o pode ser encontrada na mem√≥ria quando est√° claramente presente na caixa de di√°logo de desbloqueio, voc√™ deve encontrar o c√≥digo que interage com ela.  Existem v√°rias maneiras.  Voc√™ pode acompanhar o processamento de eventos de teclado e mouse localizando 'GetMessage', 'PeekMessage', 'GetWindowText' ou outras APIs do Windows que normalmente lidam com a entrada do usu√°rio.  Ent√£o, encontramos o buffer no qual as teclas s√£o gravadas e, atrav√©s delas, passamos √† rotina de criptografia / ofusca√ß√£o.  Mas esse √© um processo longo e propenso a erros, especialmente com estruturas grandes que √†s vezes gerenciam a mem√≥ria de maneira muito estranha; portanto, √© necess√°rio fazer muitas c√≥pias e convers√µes para controlar o buffer. <br><br>  Em vez disso, usamos nossa pr√≥pria ferramenta Thread Imager, projetada para fazer engenharia reversa de protocolos propriet√°rios ‚Äúestranhos‚Äù no n√≠vel do aplicativo.  Isso ajudar√° voc√™ a determinar onde a mem√≥ria 1Password 4 interage com nossa senha mestra.  A ferramenta "automaticamente" identifica √°reas de c√≥digo no 1Password 4 que interagem com uma senha ofuscada (ela simplesmente destaca as instru√ß√µes que interagem com os dados de interesse para an√°lise posterior).  O resultado √© algo como isto: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6b/c11/157/b6bc1115787869abc9ba25719b7c060a.gif"><br>  <i><font color="gray">O Thread Imager localiza o c√≥digo 1Password 4 que interage com uma senha mestre sem foco</font></i> <br><br>  Como a senha mestre √© armazenada na mem√≥ria de forma ofuscada, a ferramenta deve mostrar primeiro onde ocorre a ofusca√ß√£o. <br><br>  Um fragmento do primeiro resultado mostra que a primeira apar√™ncia da senha mestre √© acompanhada por uma transi√ß√£o de c√≥digo do endere√ßo 0x7707A75D para 0x701CFA10. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/49b/f32/d7a/49bf32d7a1f5b0bf01f12f7d47685dea.png"></div><br>  <i><font color="gray">Uma entrada detalhada no Thread Imager destaca a transi√ß√£o de c√≥digo de 0x7707A75D para 0x701CFA10, enquanto os registros EAX e ECX se referem ao buffer com a senha mestre</font></i> <br><br>  Examinar este local 0x7707A75D no depurador (x64dbg) confirma nossa teoria.  De fato, pela primeira vez, a sequ√™ncia 'Z3superpass #' ocorre quando a fun√ß√£o de decodifica√ß√£o 'RtlRunDecodeUnicodeString' da biblioteca ntdll.dll termina. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/173/cd8/1bb/173cd81bba5c294f9e21c139610ee290.png"><br><br>  Ap√≥s algumas an√°lises, fica claro que essas duas fun√ß√µes s√£o usadas para ofuscar a senha: 'RtlRunEncodeUnicodeString' e 'RtlRunDecodeUnicodeString'.  Portanto, a senha mestra est√° oculta da c√≥pia primitiva da mem√≥ria, e √© por isso que anteriormente n√£o conseguimos encontr√°-la no editor hexadecimal. <br><br>  Se voc√™ estudar o buffer codificado no final da fun√ß√£o RtlRunEncodeUnicodeString, a linha criptografada com a senha mestra ficar√° assim: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d47/547/aec/d47547aecf337b3c33206ddbe3bbad97.png"></div><br>  <i><font color="gray">Senha Mestra Criptografada</font></i> <br><br>  Ap√≥s RtlRunDecodeUnicodeString ', √© decodificado: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/204/85b/b2b/20485bb2b8b6f40b6509db04bcedf5b1.png"></div><br>  <i><font color="gray">Senha mestra descriptografada</font></i> <br><br>  Curiosamente, essa √°rea √© salva no mesmo endere√ßo 0x00DFA790 e podemos literalmente observar sua altera√ß√£o ao inserir uma senha na janela de desbloqueio do 1Password 4: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3cf/d32/83f/3cfd3283fef38c3e5ef0a62630b4372b.gif"></div><br><br><h1>  Vulnerabilidade </h1><br>  'RtlRunEncodeUnicodeString' e 'RtlRunDecodeUnicodeString' s√£o fun√ß√µes simples que modificam uma sequ√™ncia com uma opera√ß√£o XOR simples.  Isso n√£o √© t√£o ruim: parece ser o m√©todo padr√£o para mascarar todos os controles de edi√ß√£o nativos do Windows com o conjunto de sinalizadores 'ES_PASSWORD'. <br><br>  O problema √© que, depois de desbloquear o 1Password 4, a senha mestre criptografada n√£o √© apagada da mem√≥ria. <br><br>  Pior, ele permanece na mem√≥ria mesmo ap√≥s o bloqueio da 1Password 4. Ou seja, temos um armazenamento de senhas bloqueadas, mas com uma senha mestre criptografada na mem√≥ria. <br><br>  E pior ainda, como interagimos com a caixa de di√°logo de entrada de senha mestra, a mesma √°rea de mem√≥ria √© reutilizada com o mesmo valor XOR, o que nos d√° acesso f√°cil ao buffer codificado para criar uma explora√ß√£o. <br><br><h1>  Desafio </h1><br>  Para criar uma explora√ß√£o confi√°vel para o 1Password 4, √© necess√°rio obter uma imagem mais clara de como a senha mestra √© processada pelos fluxos de trabalho do programa.  Usando as ferramentas mencionadas acima, constru√≠mos um diagrama de dados de sa√≠da (veja a figura abaixo). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/453/5e4/763/4535e476369c9114c5fd62f1ec7480c6.png"><br><br>  Este diagrama facilita a compreens√£o de onde e quais bibliotecas est√£o envolvidas, a fim de identificar com seguran√ßa √°reas da mem√≥ria nas quais voc√™ pode recuperar a senha mestra. <br><br><h1>  Explorar </h1><br>  O que temos no momento?  Temos um armazenamento bloqueado e, em algum lugar da mem√≥ria, uma senha ofuscada √© armazenada, porque o programa n√£o limpou a mem√≥ria corretamente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a77/ac0/8f1/a77ac08f195de46d8e546b1f43ab1415.png"></div><br><br>  Para recuper√°-lo, voc√™ precisa chamar o procedimento no 1Password 4, que inicia o 'RtlRunEncodeUnicodeString' e 'RtlRunDecodeUnicodeString'.  Assim, mostrar√° a localiza√ß√£o do buffer de mem√≥ria com a senha mestre codificada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d47/547/aec/d47547aecf337b3c33206ddbe3bbad97.png"></div><br>  <i><font color="gray">√Årea de mem√≥ria com uma senha mestra ofuscada</font></i> <br><br>  Sem esse buffer, seria necess√°rio mergulhar no abismo de procedimentos internos, controles do Windows e mecanismos de gerenciamento de mem√≥ria relacionados.  Talvez essa an√°lise facilite a localiza√ß√£o de um buffer, mas n√£o fomos por esse caminho. <br><br>  Parece que a √∫nica maneira de chamar 'RtlRunEncodeUnicodeString' e 'RtlRunDecodeUnicodeString' √© inserir a senha mestra no caractere na caixa de di√°logo.  Ent√£o, obtemos o buffer desejado.  Mas n√£o sabemos o tamanho da senha. <br><br>  Resolvemos esse problema interceptando o c√≥digo que acessa o primeiro caractere do nosso buffer, bloqueando uma tentativa de altera√ß√£o.  Essa rotina est√° no loop de mensagens de controle em comctl32, que lida com o controle de buffer dos elementos correspondentes.  Chamar 'memmove' com deslocamento 0x70191731 substitui o buffer pelo caractere inserido: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/676/8a9/351/6768a9351ed39fe85a98ca9d01368586.png"></div><br>  <i><font color="gray">(Efeito colateral: a linha destacada (amarela) atualiza toda a linha da senha)</font></i> <br><br>  Agora finalmente conseguimos tudo o que precisamos para criar uma explora√ß√£o.  As etapas a seguir nos permitem extrair a senha mestra: <br><br><ol><li>  Ligue 'memmove' para evitar a substitui√ß√£o do primeiro byte da senha principal. <br></li><li>  Ligue 'RtlRunEncodeUnicodeString' para obter a localiza√ß√£o do buffer da senha principal ofuscada. <br></li><li>  Gancho 'RtlRunDecodeUnicodeString' para acessar o buffer ofuscado obtido na etapa anterior. <br></li><li>  Digitando um caractere no campo de entrada da senha e recusando a etapa 1 (salvando toda a senha mestre), redirecionando as etapas 2 para a etapa 3 para decodificar a senha mestre ofuscada. </li></ol><br>  Para executar todas essas a√ß√µes, crie uma DLL com o c√≥digo do manipulador para todos esses ganchos.  A biblioteca √© incorporada no processo 1Password 4, envia um caractere para a caixa de di√°logo de senha mestre, iniciando as etapas memmove, RtlRunEncodeUnicodeString e RtlRunDecodeUnicodeString que podemos interceptar - e fazendo nossa m√°gica para recuperar a senha mestre ofuscada.  A maior parte da m√°gica acontece no DetourRtlRunEncodeUnicodeString, este √© o gancho da fun√ß√£o 'RtlRunEncodeUnicodeString', mostrada abaixo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c5/652/36e/2c565236ec1efb158e586bd603d0a908.png"></div><br><br>  O que nos leva ao resultado final: desbloquear o reposit√≥rio bloqueado 1Password 4 de qualquer vers√£o usando o procedimento de buggy usado pela API do Windows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ad/2c0/d81/0ad2c0d817dd2dc75a942e5b2bd5b974.gif"><br><br><h1>  Sum√°rio </h1><br>  Quando nos aprofundamos no interior do 1Password 4, esper√°vamos encontrar algum tipo de sistema de seguran√ßa complexo e esper√°vamos que todas as informa√ß√µes confidenciais fossem apagadas da mem√≥ria, como acontece nos procedimentos do PBKDF2 e em outras √°reas em que a senha mestra √© usada.  Entradas correspondentes tamb√©m s√£o limpas.  No entanto, devido √† supervis√£o, o campo de entrada da senha √© considerado como um controle padr√£o da API do Windows com uma senha oculta, o que prejudica a seguran√ßa do 1Password 4. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt441166/">https://habr.com/ru/post/pt441166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt441150/index.html">Primeira introdu√ß√£o ao protocolo HTTP, escrevendo o servidor Java Web mais simples</a></li>
<li><a href="../pt441152/index.html">Como minimizar erros ao integrar com servi√ßos externos: a experi√™ncia de um corretor online</a></li>
<li><a href="../pt441154/index.html">Onze p√©rolas ocultas de Java 11</a></li>
<li><a href="../pt441158/index.html">Como a √©tica se tornou a quest√£o mais cara do Vale do Sil√≠cio e a filosofia se tornou sua solu√ß√£o mais pr√°tica</a></li>
<li><a href="../pt441160/index.html">Como aprender a determinar quando dizer n√£o</a></li>
<li><a href="../pt441168/index.html">DataChannels QUIC: Primeiros Passos</a></li>
<li><a href="../pt441172/index.html">Como o mercado de impress√£o 3D cresceu em 2018 e o que isso significa para os neg√≥cios</a></li>
<li><a href="../pt441174/index.html">OOP est√° morto, viva OOP</a></li>
<li><a href="../pt441180/index.html">Nublado com possibilidade de publicidade n√£o desativ√°vel no c√©u estrelado</a></li>
<li><a href="../pt441182/index.html">Abordagem m√°quina-sinest√©sica para detectar ataques DDoS na rede. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>