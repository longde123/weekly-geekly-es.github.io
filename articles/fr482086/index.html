<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÇüèº üå≠ üéõÔ∏è Analyse de Bootkit üë®‚Äçüë©‚Äçüë¶ üë®üèø‚Äçüè´ üó®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! Dans le cadre du lancement du cours ¬´Reverse Engineering¬ª, nous avons organis√© une le√ßon ouverte pr√©vue. Il a d√©mont√© l'algorithme d'o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse de Bootkit</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/482086/"> <i>Bonjour √† tous!</i>  <i>Dans le cadre du lancement du cours <a href="https://otus.pw/1uOJ/">¬´Reverse Engineering¬ª,</a> nous avons organis√© une le√ßon ouverte pr√©vue.</i>  <i>Il a d√©mont√© <b>l'algorithme d'op√©ration de d√©marrage</b> √† diff√©rentes √©tapes de son chargement.</i> <br><br><img src="https://habrastorage.org/webt/do/x7/rb/dox7rbq794sk5rkgvwrpq42lq6g.jpeg"><br><br>  Conf√©rencier - <a href="https://otus.pw/G9ih/">Arthur Pakulov</a> , analyste de virus chez Kaspersky Lab. <br><br>  <b><i>L'article suivant est une introduction et est une version texte d'une partie seulement de la le√ßon, qui est consacr√©e au programme d'installation de bootkit.</i></b>  <b><i>Une analyse d√©taill√©e du bootkit lui-m√™me, voir la vid√©o.</i></b> <a name="habracut"></a><br><br>  Un bootkit est un programme malveillant qui modifie le Master Boot Record, le premier secteur du premier disque physique ou secteur de d√©marrage, VBR.  Les programmes de ce type ont fondamentalement une fonctionnalit√© de cheval de Troie et sont utilis√©s pour effectuer toutes les actions cach√©es dans le syst√®me.  Dans notre exemple, le bootkit effectue une √©l√©vation de privil√®ges au niveau du processus, dont le nom commence par une s√©quence de lettres: ¬´inte¬ª.  En fait, un bootkit est un rootkit qui commence √† fonctionner dans l'anneau de protection 0, qui d√©marre m√™me avant le chargement du syst√®me d'exploitation.  C'est pour cette raison qu'il pr√©sente un grand int√©r√™t pour la recherche. <br><br>  Pour d√©velopper un tel programme, les comp√©tences habituelles en reverse engineering ne suffisent pas.  Il ne suffit pas simplement de pouvoir lire la liste, vous devez √©galement comprendre des √©l√©ments tels que l'architecture du processeur, l'adressage de la m√©moire, etc. Nous avons examin√© les endroits cl√©s du kit de d√©marrage dans une le√ßon ouverte. <br><br>  Pour le travail, un exemple sp√©cial bootkit-xp.exe a √©t√© pr√©par√©, fonctionnant sous Windows XP.  Par cons√©quent, en plus d'√©tudier le bootkit, nous √©tions un peu nostalgiques de ce syst√®me d'exploitation.  Mais en g√©n√©ral, l'OS XP a √©t√© choisi afin de faciliter la marche arri√®re, car XP est une bonne visualisation et l'absence de complications inutiles.  Eh bien, l'exemple a √©t√© √©crit sp√©cifiquement pour cet OS, √† en juger par son code. <br><br>  Voici √† <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D425">quoi ressemble le programme d'installation du bootkit</a> : <br><br><img src="https://habrastorage.org/webt/f4/-4/lr/f4-4lrdezgkdeeokbuyk9w0-4jy.png"><br><br>  En le regardant, vous pouvez tirer certaines conclusions.  Par exemple, il est imm√©diatement √©vident que ce fichier a un petit poids.  Si vous regardez le point d'entr√©e, vous pouvez voir que le code re√ßoit un descripteur de fichier avec le nom d'un lien symbolique vers le premier disque physique - "PhysicalDrive0": <br><br><img src="https://habrastorage.org/webt/qy/3k/ug/qy3kugjvk78hnhogjugvfcf2ggc.png"><br><br>  De plus, pour faciliter la perception du code, nous sommes <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D612">pass√©s √† l'IDA</a> .  Il devient clair que pour un cheval de Troie typique, la fonctionnalit√© disponible est assez petite.  M√™me la table d'importation est √©trangement petite: <br><br><img src="https://habrastorage.org/webt/fa/jw/pm/fajwpmunsgdiuiicltttrjuum-q.png"><br><br>  Une telle image √©merge g√©n√©ralement lors de l'analyse d'√©chantillons emball√©s.  Mais, dans notre cas, le fichier ne semble pas emball√©.  Il s'av√®re que l'√©chantillon est soit couvert par un protecteur / crypteur et, au cours de son travail, re√ßoit les adresses des fonctions de mani√®re dynamique, apr√®s quoi il appelle la fonction souhait√©e, ou tout va bien, et l'√©chantillon est tel qu'il est. <br><br>  Nous continuons √† explorer le code. <br><br><img src="https://habrastorage.org/webt/dd/ap/6r/ddap6rpjjwbfz3zzamn_0folqro.png"><br><br>  Comme nous l'avons vu dans HIEW, la fonction <b>CreateFileA</b> est appel√©e avec un argument int√©ressant comme premier param√®tre. Que fait-on exactement ici?  Ici, il convient de rappeler une chose telle que <b>les objets du noyau</b> .  Ils ne peuvent pas √™tre manipul√©s directement depuis le mode utilisateur, ils sont contr√¥l√©s par le noyau du syst√®me d'exploitation.  Depuis le mode utilisateur, un programme ne peut faire qu'une demande pour recevoir / changer l'√©tat de n'importe quel objet noyau.  Pour indiquer au syst√®me avec quel objet noyau particulier le programme fonctionnera, il est n√©cessaire d'obtenir le descripteur de l'objet noyau requis.  Sur demande de r√©ception, si tous les contr√¥les sont r√©ussis, le syst√®me d'exploitation nous renverra la <b>poign√©e de l'</b> OA demand√©.  Et d√©j√† en utilisant handle, nous pouvons travailler avec l'OA associ√©. <br><br>  Ainsi, dans l'image ci-dessus, √† l'aide de CreateFile, un lien symbolique est acc√©d√© au premier disque dur physique connect√©.  Si l'acc√®s est accord√©, vous pouvez travailler avec un tel ¬´fichier¬ª comme avec tout autre fichier simple.  Autrement dit, l'int√©gralit√© du disque dur sera pr√©sent√© comme un seul gros fichier. <br><br>  Alors continuons.  La poign√©e est de retour, et on se retrouve ici: <br><br><img src="https://habrastorage.org/webt/zr/1e/1x/zr1e1xk7dhetlxfyumiqyrfnvn4.png"><br><br>  Que se passe-t-il ensuite?  Et puis la fonction <b>ReadFile</b> lit les premiers octets 0x200.  Et nous avons l√† le tout premier secteur du premier disque physique. <br><br><img src="https://habrastorage.org/webt/ev/p8/sc/evp8sct8igaytj9d3ardoecem3u.png"><br><br>  Comme vous l'avez peut-√™tre devin√©, il s'agit du <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25B3%25D1%2580%25D1%2583%25D0%25B7%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">Master Boot Record</a> (MBR).  MBR se compose de 3 parties: partie de code, table de partition et signature.  Dans une situation normale, le BIOS lit le MBR en m√©moire √† l'adresse 0: 0x7c00h, en lui passant le contr√¥le.  Ainsi, la partie code du MBR commence √† s'ex√©cuter.  Pendant l'ex√©cution, il analyse la table de partition, trouve le secteur de d√©marrage et le charge.  Dans le cas d'un bootkit, si le MBR est √©cras√©, son code recevra d√©sormais le contr√¥le. <br><br>  Ok, MBR est lu, et <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D1832">quelle est la prochaine √©tape</a> ?  Et puis le bootkit ouvre √† nouveau PhysicalDrive0, mais avec le mode d'acc√®s en √©criture. <br><br><img src="https://habrastorage.org/webt/dx/ca/sd/dxcasdk2lmaimniy-ghxtmpwfmc.png"><br><br>  Ensuite, un pointeur est plac√© au 600√®me d√©calage.  Autrement dit, le <b>secteur d'origine est lu et copi√© dans le troisi√®me secteur</b> . <br><br>  Pourquoi sauvegarder un secteur?  De toute √©vidence, cela est n√©cessaire car il sera n√©cessaire √† l'avenir. <br><br>  Ensuite, le cycle commence.  Naturellement, en regardant le code, on ne peut que faire attention aux constantes comme var_1C, <b>1BEh</b> et autres.  Et, en m√™me temps, la structure MBR situ√©e ci-dessus doit √™tre actualis√©e en m√©moire.  En particulier, nous nous int√©ressons √† la colonne ¬´Offset¬ª. <br><br><img src="https://habrastorage.org/webt/rq/jl/ac/rqjlacxma7m_0m_ldqqbomiqhfa.png"><br><br>  Voir, le tampon de lecture du premier secteur est dans <b>lpBuffer</b> .  Ensuite, <b>1BEh lui est</b> ajout√©. En fait, le pointeur va au d√©but de la table de partition.  Toutes les donn√©es de la table jusqu'√† la fin du secteur sont ins√©r√©es dans <b>_marked_bytes</b> , √† partir du m√™me d√©calage - 1BE. <br><br><img src="https://habrastorage.org/webt/yj/en/ot/yjenotuk4hp061oe0qldeeu0j98.png"><br><br>  Autrement dit, les deuxi√®me et troisi√®me parties du MBR d'origine sont ins√©r√©es dans <b>_marked_bytes</b> . <br><br>  Que se passe-t-il ensuite?  Et <b>puis SetFilePointer</b> place le pointeur sur le tout d√©but de notre ¬´fichier¬ª, c'est-√†-dire sur le MBR. <br><br><img src="https://habrastorage.org/webt/eb/7z/vb/eb7zvba8zitins67gn2vtiiu8gs.png"><br><br>  Ensuite, il y a une √©criture (WriteFile) form√©e de <i>_marked_bytes</i> et lib√©rant de la m√©moire.  Sur ce, la fonctionnalit√© du programme d'installation de bootkit se termine. <br><br>  Mais ce serait bien de <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2429">voir ce qui se</a> trouve <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2429">exactement</a> dans la premi√®re partie de <b>_marked_bytes</b> .  Pour ce faire, videz-le sur le disque et analysez-le.  La premi√®re chose qui attire votre attention est une diminution de 2 du contenu de la variable √† l'adresse 0x413. <br><br><img src="https://habrastorage.org/webt/pq/_w/3k/pq_w3kqifhqcrnmjtebzseacgpu.png"><br><br>  Si vous consultez la documentation technique, vous pouvez constater que la variable √† 0X413 contient la quantit√© de m√©moire physique install√©e en kilo-octets.  En cons√©quence, le code de bootkit "coupe" deux kilo-octets de m√©moire: <br><br><img src="https://habrastorage.org/webt/gc/ks/kb/gckskbwy16b2m0k8sgwv6lg__zk.png"><br><br>  Maintenant, pour ne pas aller plus loin, on consid√©rera qu'il y a 2 kilo-octets de m√©moire en moins.  Pourquoi - n'est pas encore clair. <br><br>  <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2734">Ensuite, l'</a> adresse physique <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2734">est</a> calcul√©e sur la pi√®ce de m√©moire ¬´bit off¬ª en utilisant un d√©calage √† gauche de 6 bits: <br><br><img src="https://habrastorage.org/webt/9i/ve/qb/9iveqb9zzdser14szx1vnercz20.png"><br><br>  Un d√©calage de 6 effectue deux actions √† la fois - convertit les kilo-octets en octets (multipliant la valeur de la variable par 2 ^ 10), obtenant ainsi l'adresse physique de la m√©moire mordue et en extrayant le num√©ro de segment, en divisant le r√©sultat par 0x10 (2 ^ 4). <br><br>  Apr√®s cela, votre corps sera copi√© sur ce morceau de m√©moire, et, puisque le code du bootkit est dans le morceau "bit off", <b>personne ne le d√©rangera plus</b> .  De plus, aucune interruption ne changera ce qui est √©crit dans cette zone m√©moire.  On peut dire que le <b>code devient pratiquement invisible pour le syst√®me</b> , comme s'il n'y avait pas de m√©moire l√†-bas. <br><br>  Ce n'est que le d√©but du bootkit.  Ensuite, il y aura l'interception d'interruption, le suivi des signatures ntldr, la modification du module du noyau du syst√®me d'exploitation, etc. <br><br>  Par cons√©quent, nous ne le g√¢cherons pas, il vaut mieux <a href="https://otus.pw/1uOJ/">regarder le webinaire</a> jusqu'au bout pour ne rien manquer. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482086/">https://habr.com/ru/post/fr482086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482070/index.html">Cinq habitudes qui aident √† maintenir les performances c√©r√©brales</a></li>
<li><a href="../fr482076/index.html">Clients, faites confiance √† asoshnikov</a></li>
<li><a href="../fr482078/index.html">Risques des projets informatiques et des √©quipes informatiques</a></li>
<li><a href="../fr482080/index.html">Passerelle pour UDP entre Wi-Fi et LoRa</a></li>
<li><a href="../fr482084/index.html">Que lire en vacances</a></li>
<li><a href="../fr482088/index.html">Hugge pour les d√©veloppeurs, ou comment je suis all√© √† KotlinConf</a></li>
<li><a href="../fr482092/index.html">De quoi les aveugles ont-ils besoin? Revue de l'expert sourd-aveugle Sergei Fleitin</a></li>
<li><a href="../fr482094/index.html">Architecte logiciel: pourquoi est-il n√©cessaire et quelle est sa mal√©diction</a></li>
<li><a href="../fr482096/index.html">VR et cr√©ativit√©: comment les stations de travail Dell Precision aident les √©tudiants de la British Graduate School of Design</a></li>
<li><a href="../fr482100/index.html">Technologie AMP dans les e-mails: avantages, inconv√©nients et utilisations possibles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>