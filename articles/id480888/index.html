<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛒 👨🏽‍🏫 ☃️ DIY Coroutine. Bagian 1. Generator Malas 🤵🏾 🤽🏻 👩🏿‍🤝‍👨🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di dunia JVM, coroutine terkenal berkat bahasa Kotlin dan Project Loom . Saya belum melihat deskripsi yang baik tentang prinsip coroutine Kotlinovsky,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY Coroutine. Bagian 1. Generator Malas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/480888/"><p>  Di dunia JVM, coroutine terkenal berkat bahasa Kotlin dan <a href="https://habr.com/ru/company/jugru/blog/422519/">Project Loom</a> .  Saya belum melihat deskripsi yang baik tentang prinsip coroutine Kotlinovsky, dan kode perpustakaan kotlin-coroutine sama sekali tidak bisa dipahami oleh orang yang tidak siap.  Dalam pengalaman saya, kebanyakan orang hanya tahu tentang coroutine bahwa ini adalah "aliran ringan" dan bahwa di kotlin mereka bekerja melalui generasi bytecode yang cerdas.  Jadi saya sampai baru-baru ini.  Dan muncul ide kepada saya bahwa karena coroutine dapat diimplementasikan dalam bytecode, mengapa tidak mengimplementasikannya di java.  Dari ide ini, selanjutnya, sebuah perpustakaan kecil dan cukup sederhana muncul, perangkat yang, saya harap, dapat dipahami oleh hampir semua pengembang.  Detail di bawah potongan. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2_/7f/s4/2_7fs4po74_uoaqwmucjmnyjcuw.jpeg"></div><a name="habracut"></a><br><h3 id="ishodnyy-kod">  Kode sumber </h3><br><p>  Saya menyebut proyek Microutines, yang berasal dari kata Micro and Coroutines. </p><br><p>  Semua kode tersedia di <a href="https://github.com/alexander-shustanov/microutines">github</a> .  Awalnya, saya ingin membangun narasi sesuai dengan perkembangan pemahaman saya sendiri tentang topik, untuk berbicara tentang keputusan dan ide saya yang salah, tentang pengembangan api, tetapi kemudian kode dalam artikel akan sangat berbeda dari kode dengan github (yang tidak dapat dihindari dalam hal apapun, saya menulis satu artikel kali, dan pada komedi github dari waktu ke waktu).  Oleh karena itu, saya sebagian besar akan menggambarkan versi final dari perpustakaan, dan jika beberapa bagian dari api tidak begitu jelas pada pandangan pertama, maka kemungkinan besar mereka diperlukan untuk menyelesaikan masalah yang akan kita bahas dalam artikel berikut. </p><br><h3 id="disclaimer">  Penafian </h3><br><p>  Ini adalah semacam proyek pelatihan.  Saya akan senang jika salah satu pembaca cenderung untuk bermain atau bahkan mengajukan permintaan.  Tetapi menggunakannya dalam produksi tidak sepadan.  Cara terbaik untuk memahami teknologi adalah dengan mengimplementasikannya sendiri, yang merupakan satu-satunya tujuan proyek ini. </p><br><p>  Dan saya tidak menjamin keakuratan istilah yang digunakan.  Mungkin beberapa dari mereka saya dengar di suatu tempat, salah hafal, dan beberapa dari mereka bahkan muncul dengan diri saya sendiri dan lupa. </p><br><h3 id="chto-takoe-korutiny">  Apa itu coroutine? </h3><br><p> Seperti yang telah saya perhatikan, sering dikatakan tentang coroutine bahwa ini adalah “aliran yang difasilitasi”.  Ini bukan definisi yang benar.  Saya juga tidak akan memberikan definisi yang benar, tetapi saya akan mencoba menjelaskan apa itu coroutine.  Memanggil coroutine flow tidak akan sepenuhnya benar.  Coroutine adalah unit perencanaan yang lebih kecil dari stream, dan stream, pada gilirannya, lebih kecil dari unit penjadwalan.  Perencanaan proses dan utas ditangani oleh sistem operasi.  Corutin terlibat dalam perencanaan ... kita sendiri akan terlibat dalam perencanaan mereka.  Coroutine bekerja di atas utas reguler, dan fitur utama mereka adalah mereka tidak memblokir utas saat mereka menunggu beberapa tugas lainnya selesai, tetapi melepaskannya untuk coroutine lain.  Pendekatan ini disebut multitasking kooperatif.  Corutin dapat bekerja pertama di satu utas, lalu di yang lain.  Sebuah utas untuk coroutine bertindak sebagai sumber daya, dan sejuta coroutine dapat bekerja pada satu utas.  Anda bisa melihat gambar ini: </p><br><p><img src="https://habrastorage.org/webt/41/xu/3j/41xu3j8m3cgly0vdiixkaomex2o.png"></p><br><p>  Tugas kontrib 1 dan contrib 2 memenuhi beberapa jenis permintaan dan tidak menghalangi alur sambil menunggu tanggapan, tetapi menunda pekerjaan mereka dan melanjutkannya setelah menerima jawaban.  Kita bisa menulis kode seperti itu menggunakan callback, katamu.  Itu benar, tetapi inti dari coroutine adalah bahwa kita menulis kode tanpa panggilan balik, kita menulis kode berurutan biasa yang berjalan secara tidak sinkron. </p><br><h3 id="generatory">  Generator </h3><br><p>  Kami akan memulai pengembangan dari yang sederhana hingga yang kompleks.  Hal pertama yang akan kita lakukan adalah generasi pengumpulan malas, diimplementasikan dalam beberapa bahasa menggunakan kata kunci hasil.  Generator tidak disengaja di sini, seperti yang akan kita lihat nanti, dan generator dan coroutine dapat diimplementasikan menggunakan mekanisme yang sama. </p><br><p>  Pertimbangkan contoh python, hanya karena generator ada di luar kotak. </p><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> k = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> k k += <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> k k += <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> generator(): print(i)</code> </pre> <br><p>  Siklus terungkap menjadi sesuatu seperti ini (mungkin tidak seperti itu, tetapi prinsipnya penting bagi kami): </p><br><pre> <code class="python hljs">gen = generator() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: i = next(gen) print(i) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> StopIteration: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br><p>  Panggilan ke <code>generator()</code> akan membuat iterator khusus yang disebut generator.  Panggilan pertama ke <code>next(gen)</code> mengeksekusi kode dari awal fungsi <code>generator</code> ke <code>yield</code> pertama, dan nilai variabel lokal <code>k</code> dari <code>genertator()</code> ditulis ke variabel <code>i</code> .  Setiap panggilan berikutnya ke <code>next</code> akan terus menjalankan fungsi dengan instruksi segera setelah <code>yield</code> sebelumnya <code>yield</code> dan seterusnya.  Dalam hal ini, di antara panggilan <code>next</code> , nilai semua variabel lokal di dalam <code>generator</code> disimpan. </p><br><p>  Itu hampir sama, tetapi dalam bahasa Kotlin. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> seq = sequence { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span> yield(i) i += <span class="hljs-number"><span class="hljs-number">10</span></span> yield(i) i += <span class="hljs-number"><span class="hljs-number">10</span></span> yield(i) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> seq) { println(i) }</code> </pre> <br><p>  Di Jawa, kita bisa melakukan generasi malas seperti ini: </p><br><pre> <code class="java hljs">Iterable&lt;Integer&gt; seq = DummySequence.first(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(i, () -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i1 = i + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(i1, () -&gt; DummySequence.end(i1 + <span class="hljs-number"><span class="hljs-number">10</span></span>)); }); }); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i: seq) { System.out.println(i); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Implementasi DummySequence</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.Assert; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Iterator; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.function.Supplier; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.StreamSupport; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DummySequenceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dummySequenceTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ DummySequence&lt;Integer&gt; sequence = DummySequence.first(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(<span class="hljs-number"><span class="hljs-number">10</span></span>, () -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i1 = i + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(i1, () -&gt; DummySequence.end(i1 + <span class="hljs-number"><span class="hljs-number">10</span></span>)); }); }); List&lt;Integer&gt; list = StreamSupport.stream(sequence.spliterator(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .collect(Collectors.toList()); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">10</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>))); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">20</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">1</span></span>))); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">30</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">2</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DummySequence</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Step&lt;T&gt; step; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DummySequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Step&lt;T&gt; step)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.step = step; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Iterator&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (step <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> EndStep) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; step = step.nextStep(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> step.getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">DummySequence&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Supplier&lt;Step&lt;T&gt;&gt; next)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DummySequence&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FirstStep&lt;T&gt;(next)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value, Supplier&lt;Step&lt;T&gt;&gt; next)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntermediateStep&lt;&gt;(value, next); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EndStep&lt;&gt;(value); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirstStep</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ Supplier&lt;Step&lt;T&gt;&gt; nextStep; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FirstStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Supplier&lt;Step&lt;T&gt;&gt; next)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextStep = next; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nextStep.get(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntermediateStep</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ T value; Supplier&lt;Step&lt;T&gt;&gt; nextStep; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntermediateStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value, Supplier&lt;Step&lt;T&gt;&gt; nextStep)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value = value; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextStep = nextStep; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nextStep.get(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EndStep</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ T value; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value = value; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); } } }</code> </pre> </div></div><br><p>  Setiap lambda bersarang berikutnya menangkap semua variabel dari semua lambda sebelumnya dan dieksekusi hanya ketika elemen berikutnya diminta.  Hasil dari setiap lambda akan menjadi elemen yang dihasilkan dan blok kode berikutnya.  Terlihat sangat aneh, dan saya ragu ada orang yang mau menulis seperti itu.  Kami menunjukkan ideal yang akan kami perjuangkan (dan kami akan mencapainya, kecuali bahwa kami akan menggunakan kelas anonim, bukan lambda). </p><br><pre> <code class="java hljs">Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;Integer&gt;(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; yield(i); i += <span class="hljs-number"><span class="hljs-number">10</span></span>; yield(i); i += <span class="hljs-number"><span class="hljs-number">10</span></span>; yield(i); });</code> </pre> <br><p>  Fungsi yang diteruskan ke konstruktor Sequence harus beralih dari <code>yield</code> ke <code>yield</code> hanya jika perlu, nilai-nilai variabel lokal harus disimpan di antara panggilan ke <code>sequence.next()</code> .  Penghematan tumpukan ini dan jumlah instruksi yang terakhir dieksekusi disebut <em>preemption</em> (hasil diterjemahkan ke dalam bahasa Rusia) atau <em>suspensi</em> . </p><br><h3 id="kontinuacii">  Lanjutan </h3><br><p>  Sepotong yang bisa diperas disebut Lanjutan.  Kelanjutan diterjemahkan ke dalam bahasa Rusia sebagai 'kelanjutan', tetapi saya akan menyebutnya kelanjutan.  Wikipedia menulis tentang kelanjutan: </p><br><blockquote>  Continuation (Eng. Continuation) mewakili keadaan program pada saat tertentu, yang dapat disimpan dan digunakan untuk transisi ke keadaan ini.  Lanjutan berisi semua informasi untuk melanjutkan menjalankan program dari titik tertentu. </blockquote><p>  Misalkan kita sudah memiliki semacam cara ajaib yang menerapkan mekanisme kelanjutan, yang diwakili oleh antarmuka berikut.  Metode <code>run</code> dapat menghentikan eksekusi.  Setiap panggilan selanjutnya melanjutkan eksekusi dari <code>yield</code> terakhir.  Kita dapat menganggap kelanjutan sebagai <code>Runnable</code> yang dapat dieksekusi di bagian-bagian. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;T&gt; scope)</span></span></span></span>; }</code> </pre> <br><p>  Kami akan menggunakan kelanjutan seperti ini: </p><br><pre> <code class="java hljs">Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Continuation&lt;&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation start"</span></span>); scope.yield(i++); System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation end"</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Integer i: sequence) { System.out.println(<span class="hljs-string"><span class="hljs-string">"Next element :"</span></span> + i); }</code> </pre> <br><p>  Dan kami berharap untuk mendapatkan kesimpulan ini: </p><br><div class="spoiler">  <b class="spoiler_title">Keluaran</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Continuation start Next element: 1 Continuation resume Next element: 2 Continuation resume Next element: 3 Continuation end</code> </pre> </div></div><br><p>  <code>Sequence</code> atas permintaan elemen berikutnya akan memanggil <code>Continuation.run(scope)</code> , yang akan mengeksekusi blok kode sampai hasil berikutnya dan akan ramai keluar.  Panggilan selanjutnya ke <code>Continuation.run(scope)</code> akan mulai bekerja dari tempat crowding out terakhir dan mengeksekusi kode sampai <code>yield</code> berikutnya.  Kode <code>Sequence</code> bisa seperti ini: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sequence</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceScope</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object STOP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object next = STOP; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Continuation&lt;T&gt; nextStep; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Continuation&lt;T&gt; nextStep)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextStep = nextStep; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next == STOP) { nextStep.run(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next != STOP; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next == STOP) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NoSuchElementException(); } } T result = (T) next; next = STOP; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span><span class="hljs-function"> </span></span>{ next = t; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Iterator&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,       return this; } } interface SequenceScope&lt;T&gt; { void yield(T t); }</span></span></code> </pre> <br><p>  Semuanya baik-baik saja, kecuali bahwa java tidak dapat menghentikan eksekusi metode di tempat yang sewenang-wenang, sehingga kemudian dapat melanjutkan eksekusi dari tempat pemberhentian terakhir.  Karena itu, kita harus melakukan ini secara manual.  Masukkan bidang label tempat kami akan menyimpan jumlah hasil yang disebut terakhir. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntegerSequenceContinuation</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> label = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (label) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation start"</span></span>); scope.yield(i++); label = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); label = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); label = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation end"</span></span>); label = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(); } } }</code> </pre> <br><p>  Kami memiliki mesin negara (mesin negara terbatas), dan pada umumnya inilah yang dilakukan Kotlin di coroutine-nya (Anda dapat mendekompilasi dan melihat apakah, tentu saja, Anda memahami sesuatu).  Kami memiliki 4 negara bagian, setiap panggilan yang dijalankan mengeksekusi sepotong kode dan melakukan transisi ke keadaan berikutnya.  Kita harus menyimpan variabel lokal i di bidang kelas.  Selain kompleksitas yang tidak dapat dibenarkan, kode ini memiliki masalah lain: kita dapat memberikan nilai yang berbeda sebagai parameter lingkup untuk setiap panggilan yang dijalankan.  Oleh karena itu, alangkah baiknya untuk menyimpan parameter lingkup di bidang kelas pada panggilan pertama, dan terus bekerja dengannya. </p><br><p>  Kelanjutan pada java diimplementasikan pada kita, tetapi dengan cara yang agak aneh dan hanya dalam satu contoh.  Setiap kali tidak ada yang akan menulis sesuatu yang serupa, mengedit kode seperti itu sulit, membaca kode seperti itu sulit.  Oleh karena itu, kami akan membangun mesin negara setelah dikompilasi. </p><br><h3 id="suspendable--continuation">  Dapat Ditangguhkan &amp; Berlanjut </h3><br><p>  Bagaimana kita memahami jika kelanjutan telah menyelesaikan pekerjaan atau telah ditangguhkan?  Biarkan metode <code>run</code> mengembalikan objek <code>SUSPEND</code> khusus jika terjadi penangguhan. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ Object SUSPEND = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"[SUSPEND]"</span></span>; } }; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  Perhatikan bahwa saya menghapus parameter input dari kelanjutan.  Kita harus memastikan bahwa parameter tidak berubah dari panggilan ke panggilan, cara terbaik untuk melakukan ini adalah menghapusnya.  Pengguna, sebaliknya, membutuhkan parameter <code>scope</code> (akan digunakan untuk banyak hal, tapi sekarang <code>SequenceScope</code> dilewatkan ke tempatnya, dari mana <code>yield</code> kami dipanggil).  Selain itu, pengguna tidak ingin tahu tentang <code>SUSPEND</code> dan tidak ingin mengembalikan apa pun.  Memperkenalkan antarmuka <code>Suspendable</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Suspendable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scope</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(C scope)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scope</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Mengapa kelas abstrak, bukan antarmuka?</b> <div class="spoiler_text"><p>  Menggunakan kelas sebagai ganti antarmuka tidak memungkinkan menulis lambdas dan memaksa menulis kelas anonim.  Akan sangat nyaman bagi kita untuk bekerja dalam bytecode dengan kelanjutan seperti pada kelas, karena bidang lokal dapat disimpan di bidangnya.  Tapi lambdas dalam bytecode tidak terlihat seperti kelas.  Untuk detailnya, buka di <a href="https://habr.com/ru/company/haulmont/blog/432418/">sini</a> . </p></div></div><br><p>  <code>Suspendable</code> adalah <code>Continuation</code> dalam waktu desain, sedangkan <code>Continuation</code> adalah <code>Suspendable</code> dalam <code>Suspendable</code> .  Pengguna menulis kode di tingkat <code>Suspendable</code> , dan kode tingkat rendah dari perpustakaan berfungsi dengan <code>Continuation</code> .  Itu berubah menjadi satu setelah modifikasi bytecode. </p><br><p>  Sebelum kita berbicara tentang preempting setelah memanggil <code>yield</code> , tetapi di masa depan kita perlu melakukan preempt setelah beberapa metode lain.  Kami akan menandai metode tersebut dengan penjelasan <code>@Suspend</code> .  Ini berlaku untuk <code>yield</code> sendiri: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceScope</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scope</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span><span class="hljs-function"> </span></span>{...} }</code> </pre> <br><p>  Ingatlah bahwa kelanjutan kami akan dibangun di atas automata terbatas.  Marilah kita tinggal di sini lebih terinci.  Ini disebut mesin negara terbatas karena memiliki sejumlah negara terbatas.  Untuk menyimpan status saat ini, kami akan menggunakan bidang label khusus.  Awalnya, <code></code> label adalah 0 - kondisi nol (awal).  Setiap panggilan ke <code>Continuation.run</code> akan menjalankan beberapa jenis kode dan masuk ke beberapa kondisi (selain dari yang awal).  Setelah setiap transisi, kelanjutan harus menyimpan semua variabel lokal, nomor negara saat ini, dan jalankan <code>return SUSPEND</code> .  Transisi ke keadaan akhir akan dilambangkan dengan <code>return null</code> (dalam artikel berikut kami akan kembali tidak hanya <code>null</code> ).  Panggilan ke <code>Continuation.run</code> dari keadaan akhir harus diakhiri dengan pengecualian <code>ContinuationEndException</code> . </p><br><p>  Jadi, pengguna menulis kode di <code>Suspendable</code> , setelah kompilasi berubah menjadi <code>Continuation</code> , dengan mana perpustakaan bekerja, dan, khususnya, generator kami.  Membuat generator baru untuk pengguna terlihat seperti ini: </p><br><pre> <code class="java hljs">Sequence&lt;Integer&gt; seq = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Suspendable() {...});</code> </pre> <br><p>  Tetapi generator itu sendiri membutuhkan kelanjutan, karena ia perlu menginisialisasi bidang <code>Continuation&lt;T&gt; nextStep;</code>  .  Untuk mendapatkan <code>Continuation</code> dari <code>Suspendable</code> in code, saya menulis kelas <code>Magic</code> khusus. </p><br><p><img src="https://habrastorage.org/webt/le/hn/sk/lehnsk5dh-wi0l_awsdjm9ykz8m.jpeg"></p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> microutine.core; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> microutine.coroutine.CoroutineScopeImpl; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.Field; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Magic</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SCOPE = <span class="hljs-string"><span class="hljs-string">"scope$S"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;C extends Scope, R&gt; <span class="hljs-function"><span class="hljs-function">Continuation&lt;R&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createContinuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Suspendable&lt;C&gt; suspendable, C scope)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Field contextField = suspendable.getClass().getDeclaredField(SCOPE); contextField.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (contextField.get(suspendable) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Continuation already created"</span></span>); contextField.set(suspendable, scope); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getContinuation(suspendable); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;R, C extends Scope&gt; <span class="hljs-function"><span class="hljs-function">Continuation&lt;R&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContinuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Suspendable suspendable)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getScope(suspendable) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"No continuation created for provided suspendable"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//noinspection unchecked return ((Continuation&lt;R&gt;) suspendable); } private static Scope getScope(Suspendable suspendable) { try { Field contextField = suspendable.getClass().getDeclaredField(SCOPE); contextField.setAccessible(true); return (Scope) contextField.get(suspendable); } catch (Exception e) { throw new RuntimeException(e); } } }</span></span></code> </pre> <br><p>  Bagaimana cara kerja sihir ini?  Dengan parameter <code>scope</code> , bidang <code>scope$S</code> diinisialisasi melalui refleksi (bidang sintetis yang akan kita buat dalam bytecode).  Kelanjutan diinisialisasi hanya sekali di <code>createContinuation</code> , dan upaya inisialisasi kedua akan menghasilkan eksekusi.  Berikutnya adalah tipe pemain biasa untuk <code>Continuation</code> .  Secara umum, saya menipu Anda, semua keajaiban tidak ada di sini.  Karena konversi jenis ini dimungkinkan, <code>Suspendable</code> spesifik yang diteruskan sudah menerapkan <code>Continuation</code> .  Dan ini terjadi selama kompilasi. </p><br><h3 id="struktura-proekta">  Struktur proyek </h3><br><p>  Proyek ini akan terdiri dari tiga bagian: </p><br><ul><li>  Kode Perpustakaan (API Tingkat Rendah dan Tingkat Tinggi) </li><li>  Tes (Bahkan, hanya di dalamnya sekarang Anda dapat menggunakan perpustakaan ini) </li><li>  Konverter yang Dapat Ditangguhkan -&gt; Lanjutan (Diimplementasikan sebagai tugas gradle dalam gradle buildSrc) </li></ul><br><p>  Karena konverter saat ini dalam buildSrc, tidak mungkin menggunakannya di luar perpustakaan itu sendiri.  Tetapi untuk saat ini, kami tidak membutuhkannya.  Di masa depan, kita akan memiliki dua opsi: menaruhnya di plugin terpisah, atau membuat agen java kita sendiri (seperti yang dilakukan <a href="https://github.com/puniverse/quasar">Quasar</a> ) dan melakukan transformasi dalam runtime. </p><br><div class="spoiler">  <b class="spoiler_title">build.gradle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">plugins { id "java" } group 'microutines' version '1.0-SNAPSHOT' sourceCompatibility = 1.8 task processYield(type: microutine.ProcessSuspendableTask) { classPath = compileJava.outputs.files + compileJava.classpath inputs.files(compileJava.outputs.files) } task processTestYield(type: microutine.ProcessSuspendableTask) { classPath = compileJava.outputs.files + compileTestJava.classpath inputs.files(compileTestJava.outputs.files) } compileJava.finalizedBy(processYield) //      compileTestJava.finalizedBy(processTestYield) repositories { mavenCentral() } dependencies { testCompile group: 'junit', name: 'junit', version: '4.12' compile group: 'junit', name: 'junit', version: '4.12' }</code> </pre> </div></div><br><p>  <code>Suspendable</code> hingga <code>Continuation</code> akan ditangani oleh tugas TaskSuspendableTask.  Tidak ada yang menarik di kelas tugas hujan es, hanya memilih kelas yang diperlukan dan mengirimkannya untuk konversi ke kelas <code>SuspendableConverter</code> .  Dialah yang sekarang menarik minat kita. </p><br><h3 id="generaciya-baytkoda">  Generasi Bytecode </h3><br><p>  Untuk bekerja dengan bytecode, kita akan menggunakan pustaka OW2 ASM.  Perpustakaan bekerja berdasarkan prinsip SAX parser.  Kami membuat ClassReader baru, memberinya kelas yang dikompilasi sebagai array byte, dan memanggil metode <code>accept(ClassVisitor visitor)</code> .  ClassReader akan mem-parse bytecode dan memanggil metode yang sesuai pada pengunjung yang berlalu ( <code>visitMethod</code> , <code>visitClass</code> , <code>visitInsn</code> ).  Pengunjung dapat bekerja dalam mode adaptor dan mendelegasikan panggilan ke pengunjung berikutnya.  Biasanya, pengunjung terakhir adalah <code>ClassWriter</code> , di mana bytecode terakhir dihasilkan.  Jika tugasnya non-linear (kami hanya punya satu), mungkin diperlukan beberapa kali lewati kelas.  Pendekatan lain yang disediakan oleh asm adalah menulis kelas ke <code>ClassNode</code> khusus, dan melakukan transformasi yang sudah ada di sana.  Pendekatan pertama lebih cepat, tetapi mungkin tidak cocok untuk memecahkan masalah nonlinier, jadi saya menggunakan kedua pendekatan tersebut. </p><br><p>  <code>Suspendable</code> 3 kelas yang <code>Suspendable</code> dalam konversi <code>Suspendable</code> ke <code>Continuation</code> : </p><br><ul><li>  <code>SuspendInfoCollector</code> - menganalisis metode <code>Suspendable.run</code> , mengumpulkan informasi tentang semua panggilan ke metode <code>@Suspend</code> dan tentang variabel lokal yang digunakan. </li><li>  <code>SuspendableConverter</code> - membuat bidang yang diperlukan, mengubah tanda tangan dan pegangan metode <code>Suspendable.run</code> untuk mendapatkan <code>Continuation.run</code> . </li><li>  <code>SuspendableMethodConverter</code> - Mengkonversi kode metode <code>Suspendable.run</code> .  Menambahkan kode untuk menyimpan dan memulihkan variabel lokal, menyimpan keadaan saat ini di bidang <code>label</code> dan pindah ke instruksi yang diinginkan. </li></ul><br><p>  Mari kita jelaskan beberapa poin secara lebih rinci. </p><br><p>  Pencarian untuk metode <code>run</code> terlihat seperti ini: </p><br><pre> <code class="java hljs">MethodNode method = classNode.methods.stream() .filter(methodNode -&gt; methodNode.name.equals(<span class="hljs-string"><span class="hljs-string">"run"</span></span>) &amp;&amp; (methodNode.access &amp; Opcodes.ACC_BRIDGE) == <span class="hljs-number"><span class="hljs-number">0</span></span>) .findFirst() .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Unable to find method to convert"</span></span>));</code> </pre> <br><p>  Diharapkan di kelas convertible akan ada dua metode yang <code>run</code> , dan salah satunya dengan pengubah jembatan (apa ini dibaca di <a href="https://habr.com/ru/company/haulmont/blog/426419/">sini</a> ).  Kami tertarik pada metode tanpa pengubah. </p><br><p>  Dalam bytecode JVM, transisi bersyarat (dan tanpa syarat) dapat dilakukan di mana saja.  ASM memiliki abstraksi <code>Label</code> khusus (label), yang merupakan posisi dalam bytecode.  Sepanjang kode, setelah setiap panggilan ke metode <code>@Suspend</code> , kami akan menempatkan label yang akan kami buat lompatan bersyarat di awal metode <code>run</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    super.visitCode(); Label startLabel = new Label(); super.visitVarInsn(Opcodes.ALOAD, THIS_VAR_INDEX); //    this super.visitFieldInsn(Opcodes.GETFIELD, myClassJvmName, "label$S$S", "I"); //  label$S$S super.visitVarInsn(Opcodes.ISTORE, labelVarIndex); //      super.visitVarInsn(Opcodes.ILOAD, labelVarIndex); //   label   super.visitIntInsn(Opcodes.BIPUSH, 0); //  0   super.visitJumpInsn(Opcodes.IF_ICMPEQ, startLabel); //      startLabel        (label == 0) for (int i = 0; i &lt; numLabels; i++) { //   ,     super.visitVarInsn(Opcodes.ILOAD, labelVarIndex); super.visitIntInsn(Opcodes.BIPUSH, i + 1); super.visitJumpInsn(Opcodes.IF_ICMPEQ, labels[i]); } super.visitTypeInsn(Opcodes.NEW, "microutine/core/ContinuationEndException"); // run      ,   super.visitInsn(Opcodes.DUP); super.visitMethodInsn(Opcodes.INVOKESPECIAL, "microutine/core/ContinuationEndException", "&lt;init&gt;", "()V", false); super.visitInsn(Opcodes.ATHROW); super.visitLabel(startLabel); // ,      }</span></span></code> </pre> <br><p>  Kami menempatkan label setelah panggilan metode <code>@Suspend</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethodInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, String owner, String name, String descriptor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isInterface)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> suspendPoint = Utils.isSuspendPoint(classLoader, owner, name); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (suspendPoint) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.visitVarInsn(Opcodes.ALOAD, THIS_VAR_INDEX); <span class="hljs-comment"><span class="hljs-comment">//    this super.visitIntInsn(Opcodes.BIPUSH, suspensionNumber); //   ,       super.visitFieldInsn(Opcodes.PUTFIELD, myClassJvmName, "label$S$S", "I"); //     label$S$S saveFrame(); //    suspend(); super.visitLabel(labels[suspensionNumber - 1]); // ,     restoreFrame(); //    suspensionNumber++; } } private void suspend() { super.visitFieldInsn(Opcodes.GETSTATIC, "microutine/core/Continuation", "SUSPEND", "Ljava/lang/Object;"); //    Continuation.SUSPEND super.visitInsn(Opcodes.ARETURN); //   }</span></span></code> </pre> <br><h3 id="testy">  Tes </h3><br><p>  Kami menulis generator yang memberikan tiga angka berturut-turut. </p><br><div class="spoiler">  <b class="spoiler_title">testIntSequence</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testIntSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;Integer&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SequenceSuspendable&lt;Integer&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ scope.yield(<span class="hljs-number"><span class="hljs-number">10</span></span>); scope.yield(<span class="hljs-number"><span class="hljs-number">20</span></span>); scope.yield(<span class="hljs-number"><span class="hljs-number">30</span></span>); } }); List&lt;Integer&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer integer : sequence) { list.add(integer); } assertEquals(<span class="hljs-number"><span class="hljs-number">10</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>)); assertEquals(<span class="hljs-number"><span class="hljs-number">20</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">1</span></span>)); assertEquals(<span class="hljs-number"><span class="hljs-number">30</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">2</span></span>)); } }</code> </pre> </div></div><br><p>  Tes itu sendiri tidak mewakili sesuatu yang menarik, tetapi cukup menarik untuk mendekompilasi file kelas. </p><br><div class="spoiler">  <b class="spoiler_title">testIntSequence didekompilasi</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testIntSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamelessClass_1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceSuspendable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SequenceScope scope$S; NamelessClass_1() { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object var1)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> label = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S; SequenceScope var2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContinuationEndException(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yield(<span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yield(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yield(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } } Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NamelessClass_1()); List&lt;Integer&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(); Iterator var3 = sequence.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(var3.hasNext()) { Integer integer = (Integer)var3.next(); list.add(integer); } Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">10L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(Integer)list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>)); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">20L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(Integer)list.get(<span class="hljs-number"><span class="hljs-number">1</span></span>)); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">30L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(Integer)list.get(<span class="hljs-number"><span class="hljs-number">2</span></span>)); } }</code> </pre> </div></div><br><p>  Kode ini sangat membengkak, sebagian besar instruksi adalah menyimpan dan mengembalikan bingkai tumpukan (variabel lokal).  Namun, itu berhasil.  Contoh yang diberikan akan bekerja dengan sempurna tanpa generasi yang malas.  Mari kita pertimbangkan contoh yang lebih sulit. </p><br><div class="spoiler">  <b class="spoiler_title">fibonacci</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Suspendable&lt;Integer&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ scope.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); scope.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { b += a; scope.yield(b); a += b; scope.yield(a); } } }); <span class="hljs-comment"><span class="hljs-comment">//noinspection OptionalGetWithoutIsPresent Integer tenthFibonacci = StreamSupport.stream(sequence.spliterator(), false) .skip(9).findFirst().get(); assertEquals(55, ((int) tenthFibonacci)); } }</span></span></code> </pre> </div></div><br><p>  Kode di atas menghasilkan urutan Fibonacci yang tak terbatas.  Kami mengkompilasi dan mendekompilasi: </p><br><div class="spoiler">  <b class="spoiler_title">Fibonacci terdekompilasi</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamelessClass_1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceSuspendable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SequenceScope scope$S; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> aa$S; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ba$S; NamelessClass_1() { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object var1)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> label = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S; SequenceScope var2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> var3; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> var4; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label == <span class="hljs-number"><span class="hljs-number">3</span></span>) { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var3 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S; var4 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S; var3 += var4; var2.yield(var3); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S = var3; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S = var4; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContinuationEndException(); } var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var3 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S; var4 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; var4 = <span class="hljs-number"><span class="hljs-number">1</span></span>; } var4 += var3; var2.yield(var4); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S = var3; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S = var4; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var2.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var2.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } } Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NamelessClass_1()); Integer tenthFibonacci = (Integer)StreamSupport.stream(sequence.spliterator(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>).skip(<span class="hljs-number"><span class="hljs-number">9L</span></span>).findFirst().get(); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">55L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)tenthFibonacci); } }</code> </pre> </div></div><br><p>  Memahami apa yang membuat kelas yang didekompilasi cukup sulit.  Seperti terakhir kali, sebagian besar instruksi mengarahkan variabel lokal di sana.  Beberapa penugasan tidak berguna, dan variabel langsung terkoyak oleh nilai-nilai lain.         ,      . </p><br><p>          while,      .     .        .              ,     ''  <code>return SUSPEND</code> . </p><br><h3 id="rezyume">  Ringkasan </h3><br><p> ,   ,   ,   .        yield.           ,   ,      — ,   .      ,    (    )   .  ,   JIT     .  <code>yield</code>   <code>yieldAll</code> — ,       ,        ,             ,    .        ,      ,    . </p><br><p>      —  —   ,     .         ,         .  ,          :       ,   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id480888/">https://habr.com/ru/post/id480888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id480872/index.html">Intel menutup lubang keamanan yang dilaporkan enam bulan lalu</a></li>
<li><a href="../id480874/index.html">Studi tentang neutrino menyebabkan penemuan yang tidak terduga dalam matematika</a></li>
<li><a href="../id480876/index.html">Kami membersihkan Dock dan membuat aplikasi tanpa xCode</a></li>
<li><a href="../id480878/index.html">Android Permukaan</a></li>
<li><a href="../id480884/index.html">GUI Python dalam 5 menit</a></li>
<li><a href="../id480890/index.html">Hasil survei tentang penggunaan panel Express</a></li>
<li><a href="../id480892/index.html">Internet balon</a></li>
<li><a href="../id480900/index.html">Bawa kembali bayiku! (Kisah N.-F)</a></li>
<li><a href="../id480902/index.html">Fitur Pemantauan PostgreSQL Postgres_exporter Baru</a></li>
<li><a href="../id480904/index.html">PHP Microservice Framework: Lingkungan Pengembangan untuk Swoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>